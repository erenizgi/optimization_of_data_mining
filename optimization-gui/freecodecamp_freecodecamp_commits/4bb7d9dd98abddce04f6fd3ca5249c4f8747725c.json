{
    "author": "ojeytonwilliams",
    "message": "feat(api): add logs to protected challenge routes (#59108)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "4bb7d9dd98abddce04f6fd3ca5249c4f8747725c",
    "files": [
        {
            "sha": "8cd440ca4658d1c152d1b06079fcbde8175d5258",
            "filename": "api/src/routes/protected/challenge.ts",
            "status": "modified",
            "additions": 143,
            "deletions": 22,
            "changes": 165,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4bb7d9dd98abddce04f6fd3ca5249c4f8747725c/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4bb7d9dd98abddce04f6fd3ca5249c4f8747725c/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts?ref=4bb7d9dd98abddce04f6fd3ca5249c4f8747725c",
            "patch": "@@ -67,16 +67,24 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/coderoad-challenge-completed',\n     {\n       schema: schemas.coderoadChallengeCompleted,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           return formatCoderoadChallengeCompletedValidation(error.validation);\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(\n+        { userId: req.user?.id },\n+        'User submitted a coderoad challenge'\n+      );\n+\n       const { 'coderoad-user-token': encodedUserToken } = req.headers;\n       const { tutorialId } = req.body;\n \n@@ -85,6 +93,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         const payload = jwt.verify(encodedUserToken, JWT_SECRET) as JwtPayload;\n         userToken = payload.userToken;\n       } catch {\n+        logger.warn('Invalid user token');\n         void reply.code(400);\n         return { type: 'error', msg: `invalid user token` } as const;\n       }\n@@ -93,6 +102,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       const tutorialOrg = tutorialRepo?.split('/')?.[0];\n \n       if (tutorialOrg !== 'freeCodeCamp') {\n+        logger.warn(\n+          { tutorialId },\n+          'Tutorial not hosted on freeCodeCamp GitHub account'\n+        );\n         void reply.code(400);\n         return {\n           type: 'error',\n@@ -111,6 +124,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       });\n \n       if (!challenge) {\n+        logger.warn({ tutorialRepo }, 'Tutorial repo is not valid');\n         void reply.code(400);\n         return { type: 'error', msg: 'Tutorial name is not valid' } as const;\n       }\n@@ -122,6 +136,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         });\n \n         if (!tokenInfo) {\n+          logger.warn('User token not found');\n           void reply.code(400);\n           return { type: 'error', msg: 'User token not found' } as const;\n         }\n@@ -133,6 +148,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         });\n \n         if (!user) {\n+          logger.warn('User not found');\n           void reply.code(400);\n           return {\n             type: 'error',\n@@ -169,8 +185,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n             completedDate\n           });\n         }\n-      } catch {\n+      } catch (error) {\n         // TODO(Post-MVP): don't catch, just let Sentry handle this.\n+        logger.error(error);\n+        fastify.Sentry.captureException(error);\n         void reply.code(400);\n         return {\n           type: 'error',\n@@ -188,16 +206,20 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/project-completed',\n     {\n       schema: schemas.projectCompleted,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           return formatProjectCompletedValidation(error.validation);\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req: req });\n+      logger.info(`User ${req.user?.id} submitted a project`);\n       // TODO: considering validation is determined by `challengeType`, it should not come from the client\n       //       Determine `challengeType` by `id`\n       const { id: projectId, challengeType, solution, githubLink } = req.body;\n@@ -208,12 +230,17 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       // - `githubLink` needs to exist and be valid URL\n       if (challengeType === challengeTypes.backEndProject) {\n         if (!solution || !isURL(githubLink + '')) {\n+          logger.warn(\n+            { solution, githubLink },\n+            'Invalid backEndProject submission'\n+          );\n           return void reply.code(403).send({\n             type: 'error',\n             message: 'That does not appear to be a valid challenge submission.'\n           });\n         }\n       } else if (solution && !isURL(solution + '')) {\n+        logger.warn({ solution }, 'Invalid solution URL');\n         return void reply.code(403).send({\n           type: 'error',\n           message: 'That does not appear to be a valid challenge submission.'\n@@ -229,6 +256,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         challengeType === challengeTypes.codeAllyCert &&\n         !canSubmitCodeRoadCertProject(projectId, user)\n       ) {\n+        logger.warn(\n+          { projectId, user },\n+          'User tried to submit a codeRoad cert project before completing the required challenges'\n+        );\n         void reply.code(403);\n         return {\n           type: 'error',\n@@ -269,7 +300,9 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     {\n       schema: schemas.backendChallengeCompleted,\n       errorHandler(error, request, reply) {\n+        const logger = fastify.log.child({ req: request });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           return formatProjectCompletedValidation(error.validation);\n         } else {\n@@ -278,6 +311,12 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       }\n     },\n     async req => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(\n+        { userId: req.user?.id },\n+        `User submitted a backend challenge`\n+      );\n+\n       const user = await fastify.prisma.user.findUniqueOrThrow({\n         where: { id: req.user?.id },\n \n@@ -312,16 +351,28 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/modern-challenge-completed',\n     {\n       schema: schemas.modernChallengeCompleted,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n         if (error.validation) {\n+          const logger = fastify.log.child({ req });\n+          // This is another highly used route, so debug log level is used to\n+          // avoid excessive logging\n+          logger.debug({ validationError: error.validation });\n           void reply.code(400);\n           return formatProjectCompletedValidation(error.validation);\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async req => {\n+      const logger = fastify.log.child({ req });\n+      // This is another highly used route, so debug log level is used to\n+      // avoid excessive logging\n+      logger.debug(\n+        { userId: req.user?.id },\n+        'User submitted a modern challenge'\n+      );\n+\n       const { id, files, challengeType } = req.body;\n \n       const user = await fastify.prisma.user.findUniqueOrThrow({\n@@ -368,16 +419,21 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/save-challenge',\n     {\n       schema: schemas.saveChallenge,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           return formatProjectCompletedValidation(error.validation);\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info({ userId: req.user?.id }, 'User saved a challenge');\n+\n       const { files, id: challengeId } = req.body;\n       const user = await fastify.prisma.user.findUniqueOrThrow({\n         where: { id: req.user?.id }\n@@ -391,6 +447,12 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         !multifileCertProjectIds.includes(challengeId) &&\n         !multifilePythonCertProjectIds.includes(challengeId)\n       ) {\n+        logger.warn(\n+          {\n+            challengeId\n+          },\n+          'User tried to save a challenge that is not saveable'\n+        );\n         return void reply\n           .code(400)\n           .send('That challenge type is not saveable.');\n@@ -417,16 +479,24 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/exam/:id',\n     {\n       schema: schemas.exam,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           return { error: `Valid 'id' not found in request parameters.` };\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(\n+        { userId: req.user?.id, examId: req.params.id },\n+        'User requested an exam'\n+      );\n+\n       const { id } = req.params;\n \n       const { completedChallenges } =\n@@ -440,6 +510,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       });\n \n       if (!examFromDb) {\n+        logger.warn(\n+          { examId: id },\n+          'User requested an exam that does not exist'\n+        );\n         void reply.code(500);\n         return {\n           error: 'An error occurred trying to get the exam from the database.'\n@@ -449,6 +523,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       const validExamFromDbSchema = validateExamFromDbSchema(examFromDb);\n \n       if ('error' in validExamFromDbSchema) {\n+        logger.warn(\n+          { examId: id, validationError: validExamFromDbSchema.error },\n+          'Error validating exam from database'\n+        );\n         void reply.code(500);\n         return {\n           error:\n@@ -465,6 +543,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       );\n \n       if (completedPrerequisites.length !== prerequisiteIds.length) {\n+        logger.warn(\n+          { examId: id, prerequisites, completedPrerequisites },\n+          'User has not completed all prerequisites for exam'\n+        );\n         void reply.code(403);\n         return {\n           error: `You have not completed the required challenges to start the '${title}'.`\n@@ -478,7 +560,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       );\n \n       if (validGeneratedExamSchema.error) {\n-        fastify.log.error(validGeneratedExamSchema.error);\n+        logger.error(\n+          validGeneratedExamSchema.error,\n+          'Error validating generated exam'\n+        );\n         fastify.Sentry.captureException(validGeneratedExamSchema.error);\n         void reply.code(500);\n         return { error: 'An error occurred trying to randomize the exam.' };\n@@ -494,23 +579,34 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/ms-trophy-challenge-completed',\n     {\n       schema: schemas.msTrophyChallengeCompleted,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           void reply.send({ type: 'error', message: 'flash.ms.trophy.err-2' });\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(\n+        { userId: req.user?.id },\n+        'User submitted a Microsoft trophy challenge'\n+      );\n       try {\n         const challengeId = req.body.id;\n         const challenge = msTrophyChallenges.find(\n           challenge => challenge.id === challengeId\n         );\n \n         if (!challenge) {\n+          logger.warn(\n+            { challengeId },\n+            'User tried to submit a Microsoft trophy challenge that does not exist'\n+          );\n           return reply\n             .code(400)\n             .send({ type: 'error', message: 'flash.ms.trophy.err-2' });\n@@ -521,6 +617,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         });\n \n         if (!msUser || !msUser.msUsername) {\n+          logger.warn(\n+            { hasMsUser: !!msUser },\n+            'User tried to submit a Microsoft trophy challenge without a Microsoft username'\n+          );\n           return reply\n             .code(403)\n             .send({ type: 'error', message: 'flash.ms.trophy.err-1' });\n@@ -537,6 +637,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         });\n \n         if (msTrophyStatus.type === 'error') {\n+          logger.warn('Error verifying trophy with Microsoft');\n           return reply.code(403).send(msTrophyStatus);\n         }\n \n@@ -568,7 +669,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n           completedDate\n         };\n       } catch (error) {\n-        fastify.log.error(error);\n+        logger.error(error);\n         fastify.Sentry.captureException(error);\n         void reply.code(500);\n         return {\n@@ -583,18 +684,24 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/exam-challenge-completed',\n     {\n       schema: schemas.examChallengeCompleted,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           void reply.send({\n             error: 'Valid request body not found in attempt to submit exam.'\n           });\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+\n+      logger.info({ userId: req.user?.id }, 'User submitted an exam challenge');\n+\n       try {\n         const userId = req.user?.id;\n         const { userCompletedExam, id, challengeType } = req.body;\n@@ -614,6 +721,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         });\n \n         if (!examFromDb) {\n+          logger.warn(\n+            { examId: id },\n+            'User tried to submit an exam that does not exist'\n+          );\n           void reply.code(400);\n           return {\n             error: 'An error occurred trying to get the exam from the database.'\n@@ -622,6 +733,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n \n         const validExamFromDbSchema = validateExamFromDbSchema(examFromDb);\n         if ('error' in validExamFromDbSchema) {\n+          logger.warn(\n+            { examId: id, validationError: validExamFromDbSchema.error },\n+            'Error validating exam from database'\n+          );\n           void reply.code(500);\n           return {\n             error:\n@@ -637,6 +752,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         );\n \n         if (completedPrerequisites.length !== prerequisiteIds.length) {\n+          logger.warn(\n+            { examId: id, prerequisites, completedPrerequisites },\n+            'User has not completed all prerequisites for exam'\n+          );\n           void reply.code(403);\n           return {\n             error: `You have not completed the required challenges to start the '${title}'.`\n@@ -648,7 +767,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n           numberOfQuestionsInExam\n         );\n         if ('error' in validUserCompletedExam) {\n-          fastify.log.error(validUserCompletedExam.error);\n+          logger.error(validUserCompletedExam.error);\n           void reply.code(400);\n           return {\n             error: 'An error occurred validating the submitted exam.'\n@@ -659,7 +778,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n \n         const validExamResults = validateExamResultsSchema(examResults);\n         if ('error' in validExamResults) {\n-          fastify.log.error(validExamResults.error);\n+          logger.error(validExamResults.error);\n           void reply.code(500);\n           return {\n             error: 'An error occurred validating the submitted exam.'\n@@ -765,7 +884,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n           examResults\n         };\n       } catch (error) {\n-        fastify.log.error(error);\n+        logger.error(error);\n         fastify.Sentry.captureException(error);\n         void reply.code(500);\n         return {\n@@ -779,16 +898,18 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     '/submit-quiz-attempt',\n     {\n       schema: schemas.submitQuizAttempt,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400);\n           void reply.send({\n             type: 'error',\n             message:\n               'That does not appear to be a valid quiz attempt submission.'\n           });\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },"
        }
    ],
    "stats": {
        "total": 165,
        "additions": 143,
        "deletions": 22
    }
}