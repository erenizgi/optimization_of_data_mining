{
    "author": "ojeytonwilliams",
    "message": "feat(api): update mobile-login to match api-server (#55863)",
    "sha": "838f30e2bee2509fdd946ddcaa2f511be3df1117",
    "files": [
        {
            "sha": "7360704adc19c216ccc638010b463441ddfe34af",
            "filename": "api/src/routes/auth.test.ts",
            "status": "modified",
            "additions": 127,
            "deletions": 1,
            "changes": 128,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/838f30e2bee2509fdd946ddcaa2f511be3df1117/api%2Fsrc%2Froutes%2Fauth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/838f30e2bee2509fdd946ddcaa2f511be3df1117/api%2Fsrc%2Froutes%2Fauth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth.test.ts?ref=838f30e2bee2509fdd946ddcaa2f511be3df1117",
            "patch": "@@ -1,7 +1,30 @@\n /* eslint-disable @typescript-eslint/no-unsafe-member-access */\n-import { setupServer, superRequest } from '../../jest.utils';\n+import {\n+  setupServer,\n+  superRequest,\n+  createSuperRequest\n+} from '../../jest.utils';\n import { AUTH0_DOMAIN } from '../utils/env';\n \n+const mockedFetch = jest.fn();\n+jest.spyOn(globalThis, 'fetch').mockImplementation(mockedFetch);\n+\n+const newUserEmail = 'a.n.random@user.com';\n+\n+const mockAuth0NotOk = () => ({\n+  ok: false\n+});\n+\n+const mockAuth0InvalidEmail = () => ({\n+  ok: true,\n+  json: () => ({ email: 'invalid-email' })\n+});\n+\n+const mockAuth0ValidEmail = () => ({\n+  ok: true,\n+  json: () => ({ email: newUserEmail })\n+});\n+\n jest.mock('../utils/env', () => {\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n   return {\n@@ -23,4 +46,107 @@ describe('auth0 routes', () => {\n       expect(redirectUrl.pathname).toBe('/authorize');\n     });\n   });\n+\n+  describe('GET /mobile-login', () => {\n+    let superGet: ReturnType<typeof createSuperRequest>;\n+\n+    beforeAll(() => {\n+      superGet = createSuperRequest({ method: 'GET' });\n+    });\n+    beforeEach(async () => {\n+      await fastifyTestInstance.prisma.userRateLimit.deleteMany({});\n+      await fastifyTestInstance.prisma.user.deleteMany({\n+        where: { email: newUserEmail }\n+      });\n+    });\n+\n+    it('should be rate-limited', async () => {\n+      await Promise.all(\n+        [...Array(10).keys()].map(() => superGet('/mobile-login'))\n+      );\n+\n+      const res = await superGet('/mobile-login');\n+      expect(res.status).toBe(429);\n+    });\n+\n+    it('should return 401 if the authorization header is invalid', async () => {\n+      mockedFetch.mockResolvedValueOnce(mockAuth0NotOk());\n+      const res = await superGet('/mobile-login').set(\n+        'Authorization',\n+        'Bearer invalid-token'\n+      );\n+\n+      expect(res.body).toStrictEqual({\n+        type: 'danger',\n+        message: 'We could not log you in, please try again in a moment.'\n+      });\n+      expect(res.status).toBe(401);\n+    });\n+\n+    it('should return 400 if the email is not valid', async () => {\n+      mockedFetch.mockResolvedValueOnce(mockAuth0InvalidEmail());\n+      const res = await superGet('/mobile-login').set(\n+        'Authorization',\n+        'Bearer valid-token'\n+      );\n+\n+      expect(res.body).toStrictEqual({\n+        type: 'danger',\n+        message: 'The email is incorrectly formatted'\n+      });\n+      expect(res.status).toBe(400);\n+    });\n+\n+    it('should set the jwt_access_token cookie if the authorization header is valid', async () => {\n+      mockedFetch.mockResolvedValueOnce(mockAuth0ValidEmail());\n+      const res = await superGet('/mobile-login').set(\n+        'Authorization',\n+        'Bearer valid-token'\n+      );\n+\n+      expect(res.status).toBe(200);\n+      expect(res.get('Set-Cookie')).toEqual(\n+        expect.arrayContaining([expect.stringMatching(/jwt_access_token=/)])\n+      );\n+    });\n+\n+    it('should create a user if they do not exist', async () => {\n+      mockedFetch.mockResolvedValueOnce(mockAuth0ValidEmail());\n+      const existingUserCount = await fastifyTestInstance.prisma.user.count();\n+\n+      const res = await superGet('/mobile-login').set(\n+        'Authorization',\n+        'Bearer valid-token'\n+      );\n+\n+      const newUserCount = await fastifyTestInstance.prisma.user.count();\n+\n+      expect(existingUserCount).toBe(0);\n+      expect(newUserCount).toBe(1);\n+      expect(res.status).toBe(200);\n+    });\n+\n+    it('should redirect to returnTo if already logged in', async () => {\n+      mockedFetch.mockResolvedValueOnce(mockAuth0ValidEmail());\n+      const firstRes = await superGet('/mobile-login').set(\n+        'Authorization',\n+        'Bearer valid-token'\n+      );\n+\n+      expect(firstRes.status).toBe(200);\n+\n+      const res = await superRequest('/mobile-login', {\n+        method: 'GET',\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        setCookies: firstRes.get('Set-Cookie')\n+      })\n+        .set('Authorization', 'Bearer does-not-matter')\n+        .set('Referer', 'https://www.freecodecamp.org/back-home');\n+\n+      expect(res.status).toBe(302);\n+      expect(res.headers.location).toBe(\n+        'https://www.freecodecamp.org/back-home'\n+      );\n+    });\n+  });\n });"
        },
        {
            "sha": "316a7af549233dc5af118659081525491b92489c",
            "filename": "api/src/routes/auth.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 9,
            "changes": 36,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/838f30e2bee2509fdd946ddcaa2f511be3df1117/api%2Fsrc%2Froutes%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/838f30e2bee2509fdd946ddcaa2f511be3df1117/api%2Fsrc%2Froutes%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth.ts?ref=838f30e2bee2509fdd946ddcaa2f511be3df1117",
            "patch": "@@ -3,25 +3,28 @@ import { FastifyPluginCallback, FastifyRequest } from 'fastify';\n import rateLimit from 'express-rate-limit';\n // @ts-expect-error - no types\n import MongoStoreRL from 'rate-limit-mongo';\n+import isEmail from 'validator/lib/isEmail';\n \n import { AUTH0_DOMAIN, MONGOHQ_URL } from '../utils/env';\n import { auth0Client } from '../plugins/auth0';\n+import { createAccessToken } from '../utils/tokens';\n import { findOrCreateUser } from './helpers/auth-helpers';\n \n-const getEmailFromAuth0 = async (req: FastifyRequest) => {\n+const getEmailFromAuth0 = async (\n+  req: FastifyRequest\n+): Promise<string | null> => {\n   const auth0Res = await fetch(`https://${AUTH0_DOMAIN}/userinfo`, {\n     headers: {\n       Authorization: req.headers.authorization ?? ''\n     }\n   });\n \n-  if (!auth0Res.ok) {\n-    req.log.error(auth0Res);\n-    throw new Error('Invalid Auth0 Access Token');\n-  }\n+  if (!auth0Res.ok) return null;\n \n-  const { email } = (await auth0Res.json()) as { email: string };\n-  return email;\n+  // For now, we assume the response is a JSON object. If not, we can't proceed\n+  // and the only safe thing to do is to throw.\n+  const { email } = (await auth0Res.json()) as { email?: string };\n+  return typeof email === 'string' ? email : null;\n };\n \n /**\n@@ -60,10 +63,25 @@ export const mobileAuth0Routes: FastifyPluginCallback = (\n   // all auth routes.\n   fastify.addHook('onRequest', fastify.redirectIfSignedIn);\n \n-  fastify.get('/mobile-login', async req => {\n+  fastify.get('/mobile-login', async (req, reply) => {\n     const email = await getEmailFromAuth0(req);\n \n-    await findOrCreateUser(fastify, email);\n+    if (!email) {\n+      return reply.status(401).send({\n+        message: 'We could not log you in, please try again in a moment.',\n+        type: 'danger'\n+      });\n+    }\n+    if (!isEmail(email)) {\n+      return reply.status(400).send({\n+        message: 'The email is incorrectly formatted',\n+        type: 'danger'\n+      });\n+    }\n+\n+    const { id } = await findOrCreateUser(fastify, email);\n+\n+    reply.setAccessTokenCookie(createAccessToken(id));\n   });\n \n   done();"
        }
    ],
    "stats": {
        "total": 164,
        "additions": 154,
        "deletions": 10
    }
}