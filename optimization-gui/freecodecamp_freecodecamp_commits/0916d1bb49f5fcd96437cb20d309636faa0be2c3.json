{
    "author": "ojeytonwilliams",
    "message": "test: check reporting user sends an email (#55166)",
    "sha": "0916d1bb49f5fcd96437cb20d309636faa0be2c3",
    "files": [
        {
            "sha": "58424b0330b8d33c37eca096d1eb98b505e35a62",
            "filename": ".github/workflows/e2e-playwright.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0916d1bb49f5fcd96437cb20d309636faa0be2c3/.github%2Fworkflows%2Fe2e-playwright.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0916d1bb49f5fcd96437cb20d309636faa0be2c3/.github%2Fworkflows%2Fe2e-playwright.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fe2e-playwright.yml?ref=0916d1bb49f5fcd96437cb20d309636faa0be2c3",
            "patch": "@@ -89,7 +89,8 @@ jobs:\n       mailhog:\n         image: mailhog/mailhog\n         ports:\n-          - 1025:1025\n+          - 1025:1025 # SMTP server (listens for emails)\n+          - 8025:8025 # HTTP server (so we can make requests to the api)\n \n     steps:\n       - name: Set Action Environment Variables"
        },
        {
            "sha": "0dc768d9cb244d327747530e539e50f294bad0c5",
            "filename": "api/src/routes/user.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0916d1bb49f5fcd96437cb20d309636faa0be2c3/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0916d1bb49f5fcd96437cb20d309636faa0be2c3/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.test.ts?ref=0916d1bb49f5fcd96437cb20d309636faa0be2c3",
            "patch": "@@ -769,7 +769,7 @@ describe('userRoutes', () => {\n           from: 'team@freecodecamp.org',\n           to: 'support@freecodecamp.org',\n           cc: 'foo@bar.com',\n-          subject: \"Abuse Report: Reporting darth-vader's profile\",\n+          subject: \"Abuse Report : Reporting darth-vader's profile.\",\n           text: `\n Hello Team,\n "
        },
        {
            "sha": "0b1ef61146cd5c3c2e99e7ff3200a665c3f73f07",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0916d1bb49f5fcd96437cb20d309636faa0be2c3/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0916d1bb49f5fcd96437cb20d309636faa0be2c3/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=0916d1bb49f5fcd96437cb20d309636faa0be2c3",
            "patch": "@@ -250,7 +250,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n           from: 'team@freecodecamp.org',\n           to: 'support@freecodecamp.org',\n           cc: user.email,\n-          subject: `Abuse Report: Reporting ${username}'s profile`,\n+          subject: `Abuse Report : Reporting ${username}'s profile.`,\n           text: generateReportEmail(user, username, report)\n         });\n "
        },
        {
            "sha": "12c47f4c5c293b5803b844569c25100cb77e32c9",
            "filename": "e2e/report-user.spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0916d1bb49f5fcd96437cb20d309636faa0be2c3/e2e%2Freport-user.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0916d1bb49f5fcd96437cb20d309636faa0be2c3/e2e%2Freport-user.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Freport-user.spec.ts?ref=0916d1bb49f5fcd96437cb20d309636faa0be2c3",
            "patch": "@@ -1,9 +1,19 @@\n import { test, expect } from '@playwright/test';\n+import {\n+  deleteAllEmails,\n+  getAllEmails,\n+  getFirstEmail,\n+  getSubject\n+} from './utils/mailhog';\n test.use({ storageState: 'playwright/.auth/certified-user.json' });\n \n // To run this test you will need to run the email server.\n // To do this: https://contribute.freecodecamp.org/#/how-to-catch-outgoing-emails-locally?id=using-mailhog\n \n+test.beforeEach(async () => {\n+  await deleteAllEmails();\n+});\n+\n test('should be possible to report a user from their profile page', async ({\n   page\n }) => {\n@@ -28,4 +38,12 @@ test('should be possible to report a user from their profile page', async ({\n   await expect(page.getByTestId('flash-message')).toContainText(\n     'A report was sent to the team with foo@bar.com in copy'\n   );\n+\n+  await expect(async () => {\n+    const emails = await getAllEmails();\n+    expect(emails.items).toHaveLength(1);\n+    expect(getSubject(getFirstEmail(emails))).toBe(\n+      \"Abuse Report : Reporting twaha's profile.\"\n+    );\n+  }).toPass();\n });"
        },
        {
            "sha": "e9365d04c0a24fe40bfbcbadc63a9eb1520fde2e",
            "filename": "e2e/utils/mailhog.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0916d1bb49f5fcd96437cb20d309636faa0be2c3/e2e%2Futils%2Fmailhog.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0916d1bb49f5fcd96437cb20d309636faa0be2c3/e2e%2Futils%2Fmailhog.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Futils%2Fmailhog.ts?ref=0916d1bb49f5fcd96437cb20d309636faa0be2c3",
            "patch": "@@ -0,0 +1,30 @@\n+type Email = {\n+  Content: { Headers: { Subject: string[] } };\n+};\n+\n+type AllEmails = {\n+  items: Email[];\n+};\n+\n+const host = process.env.MAILHOG_HOST || 'localhost';\n+\n+export const getAllEmails = async (): Promise<AllEmails> => {\n+  const res = await fetch(`http://${host}:8025/api/v2/messages`);\n+  return res.json() as Promise<AllEmails>;\n+};\n+\n+export const getFirstEmail = (allEmails: { items: Email[] }) => {\n+  return allEmails.items[0];\n+};\n+\n+export const getSubject = (email: {\n+  Content: { Headers: { Subject: string[] } };\n+}) => {\n+  return email.Content.Headers.Subject[0];\n+};\n+\n+export const deleteAllEmails = async () => {\n+  await fetch(`http://${host}:8025/api/v1/messages`, {\n+    method: 'DELETE'\n+  });\n+};"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 52,
        "deletions": 3
    }
}