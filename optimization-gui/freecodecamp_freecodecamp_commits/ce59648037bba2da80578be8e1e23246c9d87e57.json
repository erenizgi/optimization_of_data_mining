{
    "author": "raisedadead",
    "message": "fix(GHA): wait for existing runs",
    "sha": "ce59648037bba2da80578be8e1e23246c9d87e57",
    "files": [
        {
            "sha": "77de15721c15652bb69de96bc585ed6556c6b357",
            "filename": ".github/workflows/deploy-legacy.yml",
            "status": "modified",
            "additions": 55,
            "deletions": 22,
            "changes": 77,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ce59648037bba2da80578be8e1e23246c9d87e57/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ce59648037bba2da80578be8e1e23246c9d87e57/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-legacy.yml?ref=ce59648037bba2da80578be8e1e23246c9d87e57",
            "patch": "@@ -12,6 +12,23 @@ jobs:\n       tgt_env_short: ${{ steps.setup.outputs.tgt_env_short }} # prd, stg\n       tgt_env_long: ${{ steps.setup.outputs.tgt_env_long }} # production, staging\n     steps:\n+      - name: Setup\n+        id: setup\n+        if: ${{ steps.check.outputs.result == 'true' }}\n+        run: |\n+          case \"${{ github.ref }}\" in\n+            \"refs/heads/prod-current\")\n+              echo \"site_tld=org\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_short=prd\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_long=production\" >> $GITHUB_OUTPUT\n+              ;;\n+            *)\n+              echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_short=stg\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_long=staging\" >> $GITHUB_OUTPUT\n+              ;;\n+          esac\n+\n       - name: Validate\n         id: check\n         uses: actions/github-script@v7\n@@ -22,9 +39,15 @@ jobs:\n             const repo = context.repo.repo;\n             const branch = context.ref.replace('refs/heads/', '');\n             const sha = context.sha;\n+            const MAX_RETRIES = 5;\n+            const WAIT_TIME = 5 * 60 * 1000; // 5 minutes in milliseconds\n \n-            for (const workflow_id of workflows) {\n-              console.log(`\\nChecking workflow ${workflow_id} for branch ${branch} at commit ${sha}`);\n+            async function sleep(ms) {\n+              return new Promise(resolve => setTimeout(resolve, ms));\n+            }\n+\n+            async function checkWorkflow(workflow_id, retryCount = 0) {\n+              console.log(`\\nChecking workflow ${workflow_id} for branch ${branch} at commit ${sha} (attempt ${retryCount + 1}/${MAX_RETRIES})`);\n \n               const response = await github.rest.actions.listWorkflowRuns({\n                 owner,\n@@ -37,7 +60,12 @@ jobs:\n               });\n \n               if (response.data.workflow_runs.length === 0) {\n-                core.setFailed(`No completed workflow runs found for ${workflow_id} on branch ${branch}`);\n+                if (retryCount < MAX_RETRIES) {\n+                  console.log(`No completed workflow runs found. Waiting ${WAIT_TIME/1000} seconds before retry...`);\n+                  await sleep(WAIT_TIME);\n+                  return checkWorkflow(workflow_id, retryCount + 1);\n+                }\n+                core.setFailed(`No completed workflow runs found for ${workflow_id} on branch ${branch} after ${MAX_RETRIES} attempts`);\n                 return false;\n               }\n \n@@ -47,38 +75,43 @@ jobs:\n               console.log(`Conclusion: ${latestRun.conclusion}`);\n \n               if (latestRun.status !== 'completed') {\n-                core.setFailed(`Latest workflow run is not completed. Current status: ${latestRun.status}`);\n+                if (retryCount < MAX_RETRIES) {\n+                  console.log(`Workflow not completed. Waiting ${WAIT_TIME/1000} seconds before retry...`);\n+                  await sleep(WAIT_TIME);\n+                  return checkWorkflow(workflow_id, retryCount + 1);\n+                }\n+                core.setFailed(`Latest workflow run is not completed after ${MAX_RETRIES} attempts. Current status: ${latestRun.status}`);\n                 return false;\n               }\n \n-              if (latestRun.conclusion !== 'success') {\n+              if (latestRun.conclusion === 'cancelled') {\n+                core.setFailed(`Workflow ${workflow_id} was cancelled on branch ${branch} at commit ${sha}`);\n+                return false;\n+              }\n+\n+              if (latestRun.conclusion === 'failure') {\n                 const failureMessage = `Workflow ${workflow_id} failed on branch ${branch} at commit ${sha}. ` +\n                   `Latest run: ${latestRun.html_url}. Conclusion: ${latestRun.conclusion}`;\n                 core.setFailed(failureMessage);\n                 return false;\n               }\n+\n+              if (latestRun.conclusion !== 'success') {\n+                core.setFailed(`Unexpected workflow conclusion: ${latestRun.conclusion}`);\n+                return false;\n+              }\n+\n+              return true;\n+            }\n+\n+            for (const workflow_id of workflows) {\n+              const result = await checkWorkflow(workflow_id);\n+              if (!result) return false;\n             }\n \n             console.log('\\nAll workflow checks passed!');\n             return true;\n \n-      - name: Setup\n-        id: setup\n-        if: ${{ steps.check.outputs.result == 'true' }}\n-        run: |\n-          case \"${{ github.ref }}\" in\n-            \"refs/heads/prod-current\")\n-              echo \"site_tld=org\" >> $GITHUB_OUTPUT\n-              echo \"tgt_env_short=prd\" >> $GITHUB_OUTPUT\n-              echo \"tgt_env_long=production\" >> $GITHUB_OUTPUT\n-              ;;\n-            *)\n-              echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-              echo \"tgt_env_short=stg\" >> $GITHUB_OUTPUT\n-              echo \"tgt_env_long=staging\" >> $GITHUB_OUTPUT\n-              ;;\n-          esac\n-\n   api:\n     name: API (Legacy) - [${{ needs.setup-jobs.outputs.tgt_env_short }}]\n     needs: [setup-jobs]"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 55,
        "deletions": 22
    }
}