{
    "author": "ojeytonwilliams",
    "message": "refactor(api): simplify error handling (#58925)",
    "sha": "fba14f0c28cc640cf0290b7411f1cf387e0dac96",
    "files": [
        {
            "sha": "cd1da88ad19464cf7bb4a8dd3bb8fd05a3f75c89",
            "filename": "api/src/routes/protected/settings.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/fba14f0c28cc640cf0290b7411f1cf387e0dac96/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/fba14f0c28cc640cf0290b7411f1cf387e0dac96/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts?ref=fba14f0c28cc640cf0290b7411f1cf387e0dac96",
            "patch": "@@ -912,6 +912,15 @@ Happy coding!\n         expect(user?.location).toEqual('');\n         expect(user?.picture).toEqual('');\n       });\n+\n+      test('PUT returns 400 status code with invalid about settings', async () => {\n+        const response = await superPut('/update-my-about').send({\n+          about: { no: 'objects' }\n+        });\n+\n+        expect(response.body).toEqual(updateErrorResponse);\n+        expect(response.statusCode).toEqual(400);\n+      });\n     });\n \n     describe('/update-my-honesty', () => {\n@@ -1007,6 +1016,15 @@ Happy coding!\n         expect(response.statusCode).toEqual(200);\n       });\n \n+      test('PUT returns 400 status code with invalid classroom mode', async () => {\n+        const response = await superPut('/update-my-classroom-mode').send({\n+          isClassroomAccount: 'invalid'\n+        });\n+\n+        expect(response.body).toEqual(updateErrorResponse);\n+        expect(response.statusCode).toEqual(400);\n+      });\n+\n       test('After updating the classroom mode, the user should have this property set', async () => {\n         await superPut('/update-my-classroom-mode').send({\n           isClassroomAccount: false"
        },
        {
            "sha": "4ac9474d14361c1307970acbacb194400d3c1542",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 68,
            "changes": 82,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/fba14f0c28cc640cf0290b7411f1cf387e0dac96/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/fba14f0c28cc640cf0290b7411f1cf387e0dac96/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=fba14f0c28cc640cf0290b7411f1cf387e0dac96",
            "patch": "@@ -1,19 +1,5 @@\n-import {\n-  TypeBoxTypeProvider,\n-  type FastifyPluginCallbackTypebox\n-} from '@fastify/type-provider-typebox';\n-import type {\n-  ContextConfigDefault,\n-  FastifyError,\n-  FastifyInstance,\n-  FastifyReply,\n-  FastifyRequest,\n-  RawReplyDefaultExpression,\n-  RawRequestDefaultExpression,\n-  RawServerDefault,\n-  RouteGenericInterface\n-} from 'fastify';\n-import { ResolveFastifyReplyType } from 'fastify/types/type-provider';\n+import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import type { FastifyInstance } from 'fastify';\n import { differenceInMinutes } from 'date-fns';\n import validator from 'validator';\n \n@@ -110,44 +96,19 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  type CommonResponseSchema = {\n-    response: { 400: (typeof schemas.updateMyProfileUI.response)[400] };\n-  };\n-\n-  // TODO: figure out if there's a nicer way to generate this type\n-  type UpdateReplyType = FastifyReply<\n-    RawServerDefault,\n-    RawRequestDefaultExpression<RawServerDefault>,\n-    RawReplyDefaultExpression<RawServerDefault>,\n-    RouteGenericInterface,\n-    ContextConfigDefault,\n-    CommonResponseSchema,\n-    TypeBoxTypeProvider,\n-    ResolveFastifyReplyType<\n-      TypeBoxTypeProvider,\n-      CommonResponseSchema,\n-      RouteGenericInterface\n-    >\n-  >;\n-\n-  function updateErrorHandler(\n-    error: FastifyError,\n-    request: FastifyRequest,\n-    reply: UpdateReplyType\n-  ) {\n+  fastify.setErrorHandler((error, request, reply) => {\n     if (error.validation) {\n       void reply.code(400);\n       void reply.send({ message: 'flash.wrong-updating', type: 'danger' });\n     } else {\n-      fastify.errorHandler(error, request, reply);\n+      throw error;\n     }\n-  }\n+  });\n \n   fastify.put(\n     '/update-my-profileui',\n     {\n-      schema: schemas.updateMyProfileUI,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyProfileUI\n     },\n     async (req, reply) => {\n       try {\n@@ -325,8 +286,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-theme',\n     {\n-      schema: schemas.updateMyTheme,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyTheme\n     },\n     async (req, reply) => {\n       try {\n@@ -353,8 +313,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-socials',\n     {\n-      schema: schemas.updateMySocials,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMySocials\n     },\n     async (req, reply) => {\n       const valid = (['twitter', 'githubProfile', 'linkedin'] as const).every(\n@@ -514,8 +473,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-keyboard-shortcuts',\n     {\n-      schema: schemas.updateMyKeyboardShortcuts,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyKeyboardShortcuts\n     },\n     async (req, reply) => {\n       try {\n@@ -542,8 +500,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-quincy-email',\n     {\n-      schema: schemas.updateMyQuincyEmail,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyQuincyEmail\n     },\n     async (req, reply) => {\n       try {\n@@ -570,8 +527,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-honesty',\n     {\n-      schema: schemas.updateMyHonesty,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyHonesty\n     },\n     async (req, reply) => {\n       try {\n@@ -598,8 +554,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-privacy-terms',\n     {\n-      schema: schemas.updateMyPrivacyTerms,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyPrivacyTerms\n     },\n     async (req, reply) => {\n       try {\n@@ -627,8 +582,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-portfolio',\n     {\n-      schema: schemas.updateMyPortfolio,\n-      errorHandler: updateErrorHandler\n+      schema: schemas.updateMyPortfolio\n     },\n     async (req, reply) => {\n       try {\n@@ -666,15 +620,7 @@ ${isLinkSentWithinLimitTTL}`\n   fastify.put(\n     '/update-my-classroom-mode',\n     {\n-      schema: schemas.updateMyClassroomMode,\n-      errorHandler: (error, request, reply) => {\n-        if (error.validation) {\n-          void reply.code(403);\n-          void reply.send({ message: 'flash.wrong-updating', type: 'danger' });\n-        } else {\n-          fastify.errorHandler(error, request, reply);\n-        }\n-      }\n+      schema: schemas.updateMyClassroomMode\n     },\n     async (req, reply) => {\n       try {"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 32,
        "deletions": 68
    }
}