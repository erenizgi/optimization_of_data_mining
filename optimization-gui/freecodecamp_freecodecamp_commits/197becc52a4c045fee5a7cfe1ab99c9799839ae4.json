{
    "author": "ojeytonwilliams",
    "message": "fix(api): handle concurrent challenge submissions (#55336)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "197becc52a4c045fee5a7cfe1ab99c9799839ae4",
    "files": [
        {
            "sha": "a136298a019ab11d06ff5bc934a3077a48e8fc76",
            "filename": "api/src/utils/common-challenge-functions.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 26,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/197becc52a4c045fee5a7cfe1ab99c9799839ae4/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/197becc52a4c045fee5a7cfe1ab99c9799839ae4/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts?ref=197becc52a4c045fee5a7cfe1ab99c9799839ae4",
            "patch": "@@ -1,4 +1,4 @@\n-import { ExamResults, user } from '@prisma/client';\n+import type { ExamResults, user, Prisma } from '@prisma/client';\n import { FastifyInstance } from 'fastify';\n import { omit, pick } from 'lodash';\n import { challengeTypes } from '../../../shared/config/challenge-types';\n@@ -163,7 +163,7 @@ export async function updateUserChallengeData(\n     partiallyCompletedChallenges = []\n   } = user;\n \n-  let userSavedChallenges = savedChallenges;\n+  let savedChallengesUpdate: Prisma.userUpdateInput['savedChallenges'];\n \n   const oldChallenge = completedChallenges.find(({ id }) => challengeId === id);\n   const alreadyCompleted = !!oldChallenge;\n@@ -175,10 +175,18 @@ export async function updateUserChallengeData(\n       }\n     : completedChallenge;\n \n+  // TODO(Post-MVP): prevent concurrent completions of the same challenge by\n+  // using optimistic concurrency control. i.e. the update should simultaneously\n+  // check and update some property of the user record such that the same update\n+  // can't be applied twice.\n   const userCompletedChallenges = alreadyCompleted\n     ? completedChallenges.map(x => (x.id === challengeId ? finalChallenge : x))\n-    : [...completedChallenges, finalChallenge];\n+    : { push: finalChallenge };\n \n+  // We can't use push, because progressTimestamps is a JSON blob and, until\n+  // we convert it to an array, push is not available. Since this could result\n+  // in the completedChallenges and progressTimestamps arrays being out of sync,\n+  // we should prioritize normalizing the data structure.\n   const userProgressTimestamps =\n     !alreadyCompleted && progressTimestamps && Array.isArray(progressTimestamps)\n       ? [...progressTimestamps, newProgressTimeStamp]\n@@ -196,45 +204,37 @@ export async function updateUserChallengeData(\n       ) as SavedChallengeFile[]\n     };\n \n-    const isSaved = userSavedChallenges.some(({ id }) => challengeId === id);\n+    const isSaved = savedChallenges.some(({ id }) => challengeId === id);\n \n-    userSavedChallenges = isSaved\n-      ? userSavedChallenges.map(x =>\n-          x.id === challengeId ? challengeToSave : x\n-        )\n-      : [...userSavedChallenges, challengeToSave];\n+    savedChallengesUpdate = isSaved\n+      ? savedChallenges.map(x => (x.id === challengeId ? challengeToSave : x))\n+      : { push: challengeToSave };\n   }\n \n   // remove from partiallyCompleted on submit\n   const userPartiallyCompletedChallenges = partiallyCompletedChallenges.filter(\n     challenge => challenge.id !== challengeId\n   );\n \n-  if (needsModeration) {\n+  const { savedChallenges: userSavedChallenges } =\n     await fastify.prisma.user.update({\n       where: { id: user.id },\n       data: {\n-        needsModeration: true\n+        completedChallenges: userCompletedChallenges,\n+        // TODO: `needsModeration` should be handled closer to source, because it exists in 3 states: true, false, undefined/null\n+        //       `undefined` in Prisma is a no-op\n+        needsModeration: needsModeration || undefined,\n+        savedChallenges: savedChallengesUpdate,\n+        progressTimestamps: userProgressTimestamps,\n+        partiallyCompletedChallenges: userPartiallyCompletedChallenges\n+      },\n+      select: {\n+        savedChallenges: true\n       }\n     });\n-  }\n-\n-  await fastify.prisma.user.update({\n-    where: { id: user.id },\n-    data: {\n-      completedChallenges: userCompletedChallenges,\n-      needsModeration,\n-      savedChallenges: userSavedChallenges,\n-      progressTimestamps: userProgressTimestamps,\n-      partiallyCompletedChallenges: userPartiallyCompletedChallenges\n-    }\n-  });\n-\n-  const updateData = {};\n \n   return {\n     alreadyCompleted,\n-    updateData, // Might need to remove this variable as we're updating user object in this function now instead of in the endpoint handler\n     completedDate: finalChallenge.completedDate,\n     userSavedChallenges\n   };"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 26,
        "deletions": 26
    }
}