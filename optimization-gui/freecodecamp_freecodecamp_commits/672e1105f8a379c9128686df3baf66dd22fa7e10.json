{
    "author": "ojeytonwilliams",
    "message": "refactor: use api requests to simplify editor spec (#54911)",
    "sha": "672e1105f8a379c9128686df3baf66dd22fa7e10",
    "files": [
        {
            "sha": "aa30d96626674c6563139e63368f5fa780624233",
            "filename": "e2e/editor.spec.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 96,
            "changes": 145,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/672e1105f8a379c9128686df3baf66dd22fa7e10/e2e%2Feditor.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/672e1105f8a379c9128686df3baf66dd22fa7e10/e2e%2Feditor.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Feditor.spec.ts?ref=672e1105f8a379c9128686df3baf66dd22fa7e10",
            "patch": "@@ -1,16 +1,31 @@\n-import { expect, test } from '@playwright/test';\n+import { APIRequestContext, expect, test } from '@playwright/test';\n \n import { clearEditor, focusEditor } from './utils/editor';\n+import { authedRequest } from './utils/request';\n+\n+const setTheme = async (\n+  request: APIRequestContext,\n+  theme: 'default' | 'night'\n+) =>\n+  authedRequest({\n+    request,\n+    endpoint: '/update-my-theme',\n+    method: 'put',\n+    data: {\n+      theme\n+    }\n+  });\n+\n+const testPage =\n+  '/learn/2022/responsive-web-design/learn-html-by-building-a-cat-photo-app/step-3';\n \n test.describe('Editor Component', () => {\n   test('should allow the user to insert text', async ({\n     page,\n     isMobile,\n     browserName\n   }) => {\n-    await page.goto(\n-      '/learn/2022/responsive-web-design/learn-html-by-building-a-cat-photo-app/step-3'\n-    );\n+    await page.goto(testPage);\n \n     await focusEditor({ page, isMobile, browserName });\n     await page.keyboard.insertText('<h2>FreeCodeCamp</h2>');\n@@ -45,66 +60,20 @@ test.describe('Python Terminal', () => {\n test.describe('Editor theme if the system theme is dark', () => {\n   test.use({ colorScheme: 'dark' });\n \n-  test.beforeEach(async ({ page }) => {\n-    await page.goto(\n-      '/learn/2022/responsive-web-design/learn-html-by-building-a-cat-photo-app/step-3'\n-    );\n-  });\n-\n   test.describe('If the user is signed in', () => {\n     test.use({ storageState: 'playwright/.auth/certified-user.json' });\n \n-    test('should be in dark mode if the user selected theme is dark', async ({\n-      page\n-    }) => {\n-      // Open the nav menu and toggle the theme\n-      await page.getByRole('button', { name: 'Menu' }).click();\n-\n-      const toggle = page.getByRole('button', { name: 'Night Mode' });\n-      await expect(toggle).toBeVisible();\n-      const isDarkMode = await toggle.getAttribute('aria-pressed');\n-\n-      if (isDarkMode === 'false') {\n-        const listItem = page.getByRole('listitem').filter({ has: toggle });\n-\n-        // The button's click event is intercepted by the `li`,\n-        // so we need to click on the `li` to trigger the theme change action.\n-        await listItem.click();\n-\n-        // Ensure that the action is completed before checking the editor.\n-        await expect(\n-          page.getByText('We have updated your theme')\n-        ).toBeVisible();\n-      }\n-\n+    test('should respect the user settings', async ({ page, request }) => {\n       const editor = page.locator(\"div[role='code'].monaco-editor\");\n-      await expect(editor).toHaveClass(/vs-dark/);\n-    });\n-\n-    test('should be in light mode if the user selected theme is light', async ({\n-      page\n-    }) => {\n-      // Open the nav menu and toggle the theme\n-      await page.getByRole('button', { name: 'Menu' }).click();\n-\n-      const toggle = page.getByRole('button', { name: 'Night Mode' });\n-      await expect(toggle).toBeVisible();\n-      const isDarkMode = await toggle.getAttribute('aria-pressed');\n \n-      if (isDarkMode === 'true') {\n-        const listItem = page.getByRole('listitem').filter({ has: toggle });\n+      await setTheme(request, 'night');\n+      await page.goto(testPage);\n \n-        // The button's click event is intercepted by the `li`,\n-        // so we need to click on the `li` to trigger the theme change action.\n-        await listItem.click();\n+      await expect(editor).toHaveClass(/vs-dark/);\n \n-        // Ensure that the action is completed before checking the editor.\n-        await expect(\n-          page.getByText('We have updated your theme')\n-        ).toBeVisible();\n-      }\n+      await setTheme(request, 'default');\n+      await page.reload();\n \n-      const editor = page.locator(\"div[role='code'].monaco-editor\");\n       await expect(editor).toHaveClass(/vs(?!\\w)/);\n     });\n   });\n@@ -113,6 +82,7 @@ test.describe('Editor theme if the system theme is dark', () => {\n     test.use({ storageState: { cookies: [], origins: [] } });\n \n     test('should be in dark mode', async ({ page }) => {\n+      await page.goto(testPage);\n       const editor = page.locator(\"div[role='code'].monaco-editor\");\n       await expect(editor).toHaveClass(/vs-dark/);\n     });\n@@ -122,72 +92,55 @@ test.describe('Editor theme if the system theme is dark', () => {\n test.describe('Editor theme if the system theme is light', () => {\n   test.use({ colorScheme: 'light' });\n \n-  test.beforeEach(async ({ page }) => {\n-    await page.goto(\n-      '/learn/2022/responsive-web-design/learn-html-by-building-a-cat-photo-app/step-3'\n-    );\n-  });\n-\n   test.describe('If the user is signed in', () => {\n     test.use({ storageState: 'playwright/.auth/certified-user.json' });\n \n-    test('should be in dark mode if the user selected theme is dark', async ({\n-      page\n-    }) => {\n-      await page.getByRole('button', { name: 'Menu' }).click();\n-\n-      const toggle = page.getByRole('button', { name: 'Night Mode' });\n-      await expect(toggle).toBeVisible();\n-      const isDarkMode = await toggle.getAttribute('aria-pressed');\n+    test('should respect the user settings', async ({ page, request }) => {\n+      const editor = page.locator(\"div[role='code'].monaco-editor\");\n \n-      if (isDarkMode === 'false') {\n-        const listItem = page.getByRole('listitem').filter({ has: toggle });\n+      await setTheme(request, 'night');\n+      await page.goto(testPage);\n \n-        // The button's click event is intercepted by the `li`,\n-        // so we need to click on the `li` to trigger the theme change action.\n-        await listItem.click();\n+      await expect(editor).toHaveClass(/vs-dark/);\n \n-        // Ensure that the action is completed before checking the editor.\n-        await expect(\n-          page.getByText('We have updated your theme')\n-        ).toBeVisible();\n-      }\n+      await setTheme(request, 'default');\n+      await page.reload();\n \n-      const editor = page.locator(\"div[role='code'].monaco-editor\");\n-      await expect(editor).toHaveClass(/vs-dark/);\n+      await expect(editor).toHaveClass(/vs(?!\\w)/);\n     });\n \n-    test('should be in light mode if the user selected theme is light', async ({\n-      page\n+    // This should be true for both system themes, but we're only testing light mode to save time.\n+    test('should switch the editor theme when the user toggles the theme', async ({\n+      page,\n+      request\n     }) => {\n+      await setTheme(request, 'default');\n+      await page.goto(testPage);\n+      // Open the nav menu and toggle the theme\n       await page.getByRole('button', { name: 'Menu' }).click();\n \n       const toggle = page.getByRole('button', { name: 'Night Mode' });\n       await expect(toggle).toBeVisible();\n-      const isDarkMode = await toggle.getAttribute('aria-pressed');\n \n-      if (isDarkMode === 'true') {\n-        const listItem = page.getByRole('listitem').filter({ has: toggle });\n+      const listItem = page.getByRole('listitem').filter({ has: toggle });\n \n-        // The button's click event is intercepted by the `li`,\n-        // so we need to click on the `li` to trigger the theme change action.\n-        await listItem.click();\n+      // The button's click event is intercepted by the `li`,\n+      // so we need to click on the `li` to trigger the theme change action.\n+      await listItem.click();\n \n-        // Ensure that the action is completed before checking the editor.\n-        await expect(\n-          page.getByText('We have updated your theme')\n-        ).toBeVisible();\n-      }\n+      // Ensure that the action is completed before checking the editor.\n+      await expect(page.getByText('We have updated your theme')).toBeVisible();\n \n       const editor = page.locator(\"div[role='code'].monaco-editor\");\n-      await expect(editor).toHaveClass(/vs(?!\\w)/);\n+      await expect(editor).toHaveClass(/vs-dark/);\n     });\n   });\n \n   test.describe('If the user is signed out', () => {\n     test.use({ storageState: { cookies: [], origins: [] } });\n \n     test('should be in light mode', async ({ page }) => {\n+      await page.goto(testPage);\n       const editor = page.locator(\"div[role='code'].monaco-editor\");\n       await expect(editor).toHaveClass(/vs(?!\\w)/);\n     });"
        }
    ],
    "stats": {
        "total": 145,
        "additions": 49,
        "deletions": 96
    }
}