{
    "author": "ojeytonwilliams",
    "message": "fix: rebuild challenge pages if source is updated (#62056)",
    "sha": "e257c2969e88b4c9c036be593bf1dead288e96c3",
    "files": [
        {
            "sha": "19a51798cc57e1ea6df25d6008325106652819d2",
            "filename": "client/gatsby-config.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e257c2969e88b4c9c036be593bf1dead288e96c3/client%2Fgatsby-config.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e257c2969e88b4c9c036be593bf1dead288e96c3/client%2Fgatsby-config.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fgatsby-config.js?ref=e257c2969e88b4c9c036be593bf1dead288e96c3",
            "patch": "@@ -2,7 +2,7 @@ const path = require('path');\n const envData = require('./config/env.json');\n const {\n   buildChallenges,\n-  replaceChallengeNode,\n+  replaceChallengeNodes,\n   localeChallengesRootDir\n } = require('./utils/build-challenges');\n \n@@ -57,7 +57,7 @@ module.exports = {\n       options: {\n         name: 'challenges',\n         source: buildChallenges,\n-        onSourceChange: replaceChallengeNode(curriculumLocale),\n+        onSourceChange: replaceChallengeNodes(curriculumLocale),\n         curriculumPath: localeChallengesRootDir\n       }\n     },"
        },
        {
            "sha": "04e0d8c86a8f86cdc1c9b256df77fde0f252a8da",
            "filename": "client/utils/build-challenges.js",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e257c2969e88b4c9c036be593bf1dead288e96c3/client%2Futils%2Fbuild-challenges.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e257c2969e88b4c9c036be593bf1dead288e96c3/client%2Futils%2Fbuild-challenges.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Futils%2Fbuild-challenges.js?ref=e257c2969e88b4c9c036be593bf1dead288e96c3",
            "patch": "@@ -10,28 +10,35 @@ const {\n   getBlockCreator\n } = require('../../curriculum/build-curriculum');\n const { getBlockStructure } = require('../../curriculum/file-handler');\n+const { getSuperblocks } = require('../../curriculum/build-curriculum');\n \n const { curriculumLocale } = envData;\n \n exports.localeChallengesRootDir = getContentDir(curriculumLocale);\n \n const blockCreator = getBlockCreator(curriculumLocale);\n \n-exports.replaceChallengeNode = () => {\n-  return async function replaceChallengeNode(filePath) {\n+exports.replaceChallengeNodes = () => {\n+  return async function replaceChallengeNodes(filePath) {\n     const parentDir = path.dirname(filePath);\n     const block = path.basename(parentDir);\n     const filename = path.basename(filePath);\n \n     console.log(`Replacing challenge node for ${filePath}`);\n     const meta = getBlockStructure(block);\n+    const superblocks = getSuperblocks(block);\n \n-    return await blockCreator.createChallenge({\n+    const challenge = await blockCreator.createChallenge({\n       filename,\n       block,\n       meta,\n       isAudited: true\n     });\n+\n+    return superblocks.map(superBlock => ({\n+      ...challenge,\n+      superBlock\n+    }));\n   };\n };\n "
        },
        {
            "sha": "b068bfdd7a5d72789720d5da45bb95f5142bb551",
            "filename": "curriculum/build-curriculum.js",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e257c2969e88b4c9c036be593bf1dead288e96c3/curriculum%2Fbuild-curriculum.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e257c2969e88b4c9c036be593bf1dead288e96c3/curriculum%2Fbuild-curriculum.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/curriculum%2Fbuild-curriculum.js?ref=e257c2969e88b4c9c036be593bf1dead288e96c3",
            "patch": "@@ -244,6 +244,24 @@ function addBlockStructure(\n   }));\n }\n \n+/**\n+ * Returns a list of all the superblocks that contain the given block\n+ * @param {string} block\n+ */\n+function getSuperblocks(\n+  block,\n+  _addSuperblockStructure = addSuperblockStructure\n+) {\n+  const { superblocks } = getCurriculumStructure();\n+  const withStructure = _addSuperblockStructure(superblocks);\n+\n+  return withStructure\n+    .filter(({ blocks }) =>\n+      blocks.some(({ dashedName }) => dashedName === block)\n+    )\n+    .map(({ name }) => name);\n+}\n+\n async function buildCurriculum(lang, filters) {\n   const contentDir = getContentDir(lang);\n   const builder = new SuperblockCreator({\n@@ -289,5 +307,6 @@ module.exports = {\n   getBlockStructure,\n   getSuperblockStructure,\n   createCommentMap,\n-  superBlockToFilename\n+  superBlockToFilename,\n+  getSuperblocks\n };"
        },
        {
            "sha": "29ff9347ae430290b708da5808c43abdbd5cc2e4",
            "filename": "curriculum/build-curriculum.test.js",
            "status": "modified",
            "additions": 65,
            "deletions": 1,
            "changes": 66,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e257c2969e88b4c9c036be593bf1dead288e96c3/curriculum%2Fbuild-curriculum.test.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e257c2969e88b4c9c036be593bf1dead288e96c3/curriculum%2Fbuild-curriculum.test.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/curriculum%2Fbuild-curriculum.test.js?ref=e257c2969e88b4c9c036be593bf1dead288e96c3",
            "patch": "@@ -1,6 +1,15 @@\n+jest.mock('./file-handler');\n+\n const path = require('node:path');\n \n-const { createCommentMap, addBlockStructure } = require('./build-curriculum');\n+const {\n+  createCommentMap,\n+  addBlockStructure,\n+  getSuperblocks\n+} = require('./build-curriculum');\n+const { getCurriculumStructure } = require('./file-handler');\n+\n+const mockGetCurriculumStructure = getCurriculumStructure;\n \n describe('createCommentMap', () => {\n   const dictionaryDir = path.resolve(__dirname, '__fixtures__', 'dictionaries');\n@@ -103,3 +112,58 @@ describe('addBlockStructure', () => {\n     ]);\n   });\n });\n+\n+describe('getSuperblocks', () => {\n+  it('returns an empty array if no superblocks contain the given block', () => {\n+    mockGetCurriculumStructure.mockReturnValue({\n+      superblocks: ['superblock-1'] // doesn't matter what this is, but must be defined\n+    });\n+    const mockAddSuperblockStructure = () => [\n+      {\n+        blocks: [{ dashedName: 'block-1' }],\n+        name: 'superblock-1'\n+      }\n+    ];\n+\n+    expect(\n+      getSuperblocks('nonexistent-block', mockAddSuperblockStructure)\n+    ).toEqual([]);\n+  });\n+\n+  it('returns an array with one superblock if one superblock contains the given block', () => {\n+    mockGetCurriculumStructure.mockReturnValue({\n+      superblocks: ['superblock-1'] // doesn't matter what this is, but must be defined\n+    });\n+    const mockAddSuperblockStructure = () => [\n+      {\n+        blocks: [{ dashedName: 'block-1' }, { dashedName: 'block-2' }],\n+        name: 'superblock-1'\n+      }\n+    ];\n+\n+    expect(getSuperblocks('block-1', mockAddSuperblockStructure)).toEqual([\n+      'superblock-1'\n+    ]);\n+  });\n+\n+  it('returns an array with multiple superblocks if multiple superblocks contain the given block', () => {\n+    mockGetCurriculumStructure.mockReturnValue({\n+      superblocks: ['superblock-1'] // doesn't matter what this is, but must be defined\n+    });\n+    const mockAddSuperblockStructure = () => [\n+      {\n+        blocks: [{ dashedName: 'block-1' }, { dashedName: 'block-2' }],\n+        name: 'superblock-1'\n+      },\n+      {\n+        blocks: [{ dashedName: 'block-3' }, { dashedName: 'block-1' }],\n+        name: 'superblock-2'\n+      }\n+    ];\n+\n+    expect(getSuperblocks('block-1', mockAddSuperblockStructure)).toEqual([\n+      'superblock-1',\n+      'superblock-2'\n+    ]);\n+  });\n+});"
        },
        {
            "sha": "54e2c5248c1ef84e8f5b5faacb6b4a607a057640",
            "filename": "tools/client-plugins/gatsby-source-challenges/gatsby-node.js",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e257c2969e88b4c9c036be593bf1dead288e96c3/tools%2Fclient-plugins%2Fgatsby-source-challenges%2Fgatsby-node.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e257c2969e88b4c9c036be593bf1dead288e96c3/tools%2Fclient-plugins%2Fgatsby-source-challenges%2Fgatsby-node.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fgatsby-source-challenges%2Fgatsby-node.js?ref=e257c2969e88b4c9c036be593bf1dead288e96c3",
            "patch": "@@ -39,13 +39,15 @@ exports.sourceNodes = function sourceChallengesSourceNodes(\n   watcher.on('change', filePath =>\n     /\\.md?$/.test(filePath)\n       ? onSourceChange(filePath)\n-          .then(challenge => {\n+          .then(challenges => {\n             reporter.info(\n               `\n-File changed at ${filePath}, replacing challengeNode id ${challenge.id}\n+File changed at ${filePath}, replacing challengeNodes with ids ${challenges.map(({ id }) => id).join(', ')}\n               `\n             );\n-            createVisibleChallenge(challenge, { isReloading: true });\n+            challenges.forEach(challenge =>\n+              createVisibleChallenge(challenge, { isReloading: true })\n+            );\n           })\n           .catch(e =>\n             reporter.error(`fcc-replace-challenge\n@@ -74,13 +76,15 @@ File changed at ${filePath}, replacing challengeNode id ${challenge.id}\n           const { path: siblingPath } = entry;\n           const relativePath = path.join(blockPath, siblingPath);\n           onSourceChange(relativePath)\n-            .then(challenge => {\n+            .then(challenges => {\n               reporter.info(\n                 `\n-File changed at ${relativePath}, replacing challengeNode id ${challenge.id}\n+File changed at ${relativePath}, replacing challengeNodes with ids ${challenges.map(({ id }) => id).join(', ')}\n             `\n               );\n-              createVisibleChallenge(challenge);\n+              challenges.forEach(challenge =>\n+                createVisibleChallenge(challenge)\n+              );\n             })\n             .catch(e =>\n               reporter.error(`fcc-replace-challenge"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 107,
        "deletions": 13
    }
}