{
    "author": "ojeytonwilliams",
    "message": "refactor(api): more, smaller tests (#54671)",
    "sha": "d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7",
    "files": [
        {
            "sha": "a3b482d53efda285d6a19eb4952ddb24cb64fece",
            "filename": "api/__mocks__/exam.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 18,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2F__mocks__%2Fexam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2F__mocks__%2Fexam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fexam.ts?ref=d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7",
            "patch": "@@ -67,12 +67,25 @@ export const completedTrophyChallenges = [\n   {\n     id: '647f85d407d29547b3bee1bb',\n     solution: 'challenge-solution',\n-    completedDate: 1695064765244\n+    completedDate: 1695064765244,\n+    files: []\n   }\n ];\n \n+export type ExamSubmission = {\n+  userExamQuestions: {\n+    id: string;\n+    question: string;\n+    answer: {\n+      id: string;\n+      answer: string;\n+    };\n+  }[];\n+  examTimeInSeconds: number;\n+};\n+\n // failed: 0 correct\n-export const userExam1 = {\n+export const examWithZeroCorrect: ExamSubmission = {\n   userExamQuestions: [\n     {\n       id: '3bbl2mx2mq',\n@@ -94,7 +107,7 @@ export const userExam1 = {\n };\n \n // passed: 1 correct\n-export const userExam2 = {\n+export const examWithOneCorrect: ExamSubmission = {\n   userExamQuestions: [\n     {\n       id: '3bbl2mx2mq',\n@@ -116,7 +129,7 @@ export const userExam2 = {\n };\n \n // passed: 2 correct\n-export const userExam3 = {\n+export const examWithTwoCorrect: ExamSubmission = {\n   userExamQuestions: [\n     {\n       id: '3bbl2mx2mq',\n@@ -138,7 +151,7 @@ export const userExam3 = {\n };\n \n // passed: 3 correct\n-export const userExam4 = {\n+export const examWithAllCorrect: ExamSubmission = {\n   userExamQuestions: [\n     {\n       id: '3bbl2mx2mq',\n@@ -159,7 +172,7 @@ export const userExam4 = {\n   examTimeInSeconds: 20\n };\n \n-export const mockResults1 = {\n+export const mockResultsZeroCorrect = {\n   numberOfCorrectAnswers: 0,\n   numberOfQuestionsInExam: 3,\n   percentCorrect: 0,\n@@ -168,7 +181,7 @@ export const mockResults1 = {\n   examTimeInSeconds: 20\n };\n \n-export const mockResults2 = {\n+export const mockResultsOneCorrect = {\n   numberOfCorrectAnswers: 1,\n   numberOfQuestionsInExam: 3,\n   percentCorrect: 33.3,\n@@ -177,7 +190,7 @@ export const mockResults2 = {\n   examTimeInSeconds: 20\n };\n \n-export const mockResults3 = {\n+export const mockResultsTwoCorrect = {\n   numberOfCorrectAnswers: 2,\n   numberOfQuestionsInExam: 3,\n   percentCorrect: 66.7,\n@@ -186,7 +199,7 @@ export const mockResults3 = {\n   examTimeInSeconds: 20\n };\n \n-export const mockResults4 = {\n+export const mockResultsAllCorrect = {\n   numberOfCorrectAnswers: 3,\n   numberOfQuestionsInExam: 3,\n   percentCorrect: 100,\n@@ -197,25 +210,27 @@ export const mockResults4 = {\n \n const completedExamChallenge = {\n   id: examChallengeId,\n-  challengeType: 17\n+  challengeType: 17,\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  completedDate: expect.any(Number)\n };\n \n-export const completedExamChallenge1 = {\n+export const completedExamChallengeZeroCorrect = {\n   ...completedExamChallenge,\n-  examResults: mockResults1\n+  examResults: mockResultsZeroCorrect\n };\n \n-export const completedExamChallenge2 = {\n+export const completedExamChallengeOneCorrect = {\n   ...completedExamChallenge,\n-  examResults: mockResults2\n+  examResults: mockResultsOneCorrect\n };\n \n-export const completedExamChallenge3 = {\n+export const completedExamChallengeTwoCorrect = {\n   ...completedExamChallenge,\n-  examResults: mockResults3\n+  examResults: mockResultsTwoCorrect\n };\n \n-export const completedExamChallenge4 = {\n+export const completedExamChallengeAllCorrect = {\n   ...completedExamChallenge,\n-  examResults: mockResults4\n+  examResults: mockResultsAllCorrect\n };"
        },
        {
            "sha": "6f27ee97d65a579caa2948fef4c8eb5ea30f10ee",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7",
            "patch": "@@ -175,6 +175,7 @@ If you are seeing this error, the root cause is likely an error thrown in the be\n \n export const defaultUserId = '64c7810107dd4782d32baee7';\n export const defaultUserEmail = 'foo@bar.com';\n+export const defaultUsername = 'fcc-test-user';\n \n export async function devLogin(): Promise<string[]> {\n   await fastifyTestInstance.prisma.user.deleteMany({\n@@ -184,7 +185,8 @@ export async function devLogin(): Promise<string[]> {\n   await fastifyTestInstance.prisma.user.create({\n     data: {\n       ...createUserInput(defaultUserEmail),\n-      id: defaultUserId\n+      id: defaultUserId,\n+      username: defaultUsername\n     }\n   });\n   const res = await superRequest('/signin', { method: 'GET' });"
        },
        {
            "sha": "d163b4c49eb4ad989d21116d91ce68eecb0f96f7",
            "filename": "api/src/routes/challenge.test.ts",
            "status": "modified",
            "additions": 132,
            "deletions": 118,
            "changes": 250,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2Fsrc%2Froutes%2Fchallenge.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2Fsrc%2Froutes%2Fchallenge.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fchallenge.test.ts?ref=d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7",
            "patch": "@@ -4,6 +4,7 @@ const mockVerifyTrophyWithMicrosoft = jest.fn();\n /* eslint-disable @typescript-eslint/no-unsafe-member-access */\n /* eslint-disable @typescript-eslint/no-unsafe-assignment */\n import { omit } from 'lodash';\n+import { Static } from '@fastify/type-provider-typebox';\n \n import { challengeTypes } from '../../../shared/config/challenge-types';\n import {\n@@ -13,24 +14,26 @@ import {\n   superRequest,\n   seedExam,\n   defaultUserEmail,\n-  createSuperRequest\n+  createSuperRequest,\n+  defaultUsername\n } from '../../jest.utils';\n import {\n-  completedExamChallenge2,\n-  completedExamChallenge3,\n-  completedExamChallenge4,\n+  completedExamChallengeOneCorrect,\n+  completedExamChallengeTwoCorrect,\n+  completedExamChallengeAllCorrect,\n   completedTrophyChallenges,\n   examChallengeId,\n-  mockResults1,\n-  mockResults2,\n-  mockResults3,\n-  mockResults4,\n-  userExam1,\n-  userExam2,\n-  userExam3,\n-  userExam4\n+  mockResultsZeroCorrect,\n+  mockResultsTwoCorrect,\n+  mockResultsAllCorrect,\n+  examWithZeroCorrect,\n+  examWithOneCorrect,\n+  examWithTwoCorrect,\n+  examWithAllCorrect,\n+  type ExamSubmission\n } from '../../__mocks__/exam';\n import { Answer } from '../utils/exam-types';\n+import type { getSessionUser } from '../schemas/user/get-session-user';\n \n jest.mock('./helpers/challenge-helpers', () => {\n   const originalModule = jest.requireActual<\n@@ -1493,173 +1496,184 @@ describe('challengeRoutes', () => {\n           });\n         });\n \n-        test('POST handles submitting a failing exam', async () => {\n-          const now = Date.now();\n-\n-          // Submit exam with 0 correct answers\n-          const response = await superRequest('/exam-challenge-completed', {\n+        const submitExam = async (exam: ExamSubmission) => {\n+          return superRequest('/exam-challenge-completed', {\n             method: 'POST',\n             setCookies\n           }).send({\n             id: examChallengeId,\n             challengeType: 17,\n-            userCompletedExam: userExam1\n+            userCompletedExam: exam\n           });\n+        };\n \n-          const {\n-            completedChallenges = [],\n-            completedExams = [],\n-            progressTimestamps = []\n-          } = (await fastifyTestInstance.prisma.user.findFirst({\n-            where: { email: 'foo@bar.com' }\n-          })) || {};\n+        test('POST handles submitting a failing exam', async () => {\n+          const now = Date.now();\n+\n+          // Submit exam with 0 correct answers\n+          const response = await submitExam(examWithZeroCorrect);\n+\n+          type GetSessionUserResponseBody = Static<\n+            (typeof getSessionUser)['response']['200']\n+          >['user'];\n+\n+          const res = (await superGet('/user/get-session-user')).body as {\n+            user: GetSessionUserResponseBody;\n+          };\n+\n+          const { completedChallenges, completedExams, calendar } =\n+            res.user[defaultUsername]!;\n \n           // should have the 1 prerequisite challenge\n           expect(completedChallenges).toHaveLength(1);\n           expect(completedExams).toHaveLength(1);\n-          expect(progressTimestamps).toHaveLength(0);\n-          expect(completedChallenges).toMatchObject(completedTrophyChallenges);\n-          expect(completedExams[0]).toMatchObject({\n+          expect(calendar).toStrictEqual({});\n+          expect(completedChallenges).toEqual(completedTrophyChallenges);\n+          expect(completedExams[0]).toEqual({\n             id: '647e22d18acb466c97ccbef8',\n             challengeType: 17,\n-            examResults: mockResults1\n+            completedDate: expect.any(Number),\n+            examResults: mockResultsZeroCorrect\n           });\n \n           expect(completedExams[0]?.completedDate).toBeGreaterThan(now);\n           expect(response.body).toMatchObject({\n             points: 0,\n             alreadyCompleted: false,\n-            examResults: mockResults1\n+            examResults: mockResultsZeroCorrect\n           });\n           expect(response.statusCode).toBe(200);\n         });\n \n-        test('POST handles submitting multiple passing exams', async () => {\n+        test(\"POST always adds to the user's completedExams\", async () => {\n+          let now = Date.now();\n+          // The first exam should be stored in the user's completedExams\n+          await submitExam(examWithAllCorrect);\n+\n+          let { completedExams } =\n+            await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+              where: { id: defaultUserId }\n+            });\n+\n+          expect(completedExams).toHaveLength(1);\n+          expect(completedExams[0]).toEqual(completedExamChallengeAllCorrect);\n+          expect(completedExams[0]?.completedDate).toBeGreaterThan(now);\n+          expect(completedExams[0]?.completedDate).toBeLessThan(Date.now());\n+\n+          now = Date.now();\n+          // the second exam should be added to the exams, not replace the first\n+          await submitExam(examWithOneCorrect);\n+\n+          completedExams = (\n+            await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+              where: { id: defaultUserId }\n+            })\n+          ).completedExams;\n+\n+          expect(completedExams).toHaveLength(2);\n+          expect(completedExams).toEqual(\n+            expect.arrayContaining([\n+              completedExamChallengeAllCorrect,\n+              completedExamChallengeOneCorrect\n+            ])\n+          );\n+          expect(completedExams[1]?.completedDate).toBeGreaterThan(now);\n+          expect(completedExams[1]?.completedDate).toBeLessThan(Date.now());\n+        });\n+\n+        test('POST updates user progress if they have not completed the exam before', async () => {\n           // Submit exam with 2/3 correct answers\n-          const nowA = Date.now();\n-          const responseA = await superRequest('/exam-challenge-completed', {\n-            method: 'POST',\n-            setCookies\n-          }).send({\n-            id: examChallengeId,\n-            challengeType: 17,\n-            userCompletedExam: userExam3\n-          });\n+          const now = Date.now();\n+          const res = await submitExam(examWithTwoCorrect);\n \n-          const userA = await fastifyTestInstance.prisma.user.findFirst({\n+          const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n             where: { id: defaultUserId }\n           });\n \n-          const completedChallengesA = userA?.completedChallenges || [];\n-          const completedExamsA = userA?.completedExams || [];\n-          const progressTimestampsA = userA?.progressTimestamps || [];\n-\n           // should add to completedChallenges\n-          expect(completedChallengesA).toHaveLength(2);\n-          expect(completedChallengesA).toMatchObject([\n+          expect(user.completedChallenges).toHaveLength(2);\n+          expect(user.completedChallenges).toMatchObject([\n             ...completedTrophyChallenges,\n-            completedExamChallenge3\n+            completedExamChallengeTwoCorrect\n           ]);\n-          expect(completedChallengesA[1]?.completedDate).toBeGreaterThan(nowA);\n-\n-          // should add to completedExams\n-          expect(completedExamsA).toHaveLength(1);\n-          expect(completedExamsA[0]).toMatchObject(completedExamChallenge3);\n-          expect(completedExamsA[0]?.completedDate).toBeGreaterThan(nowA);\n+          expect(user.completedChallenges[1]?.completedDate).toBeGreaterThan(\n+            now\n+          );\n \n           // should add to progressTimestamps\n-          expect(progressTimestampsA).toHaveLength(1);\n+          expect(user.progressTimestamps).toHaveLength(1);\n \n-          expect(responseA.body).toMatchObject({\n+          expect(res.body).toMatchObject({\n             points: 1,\n             alreadyCompleted: false,\n-            examResults: mockResults3\n+            examResults: mockResultsTwoCorrect\n           });\n-          expect(responseA.statusCode).toBe(200);\n+          expect(res.statusCode).toBe(200);\n+        });\n \n-          // Submit exam with 1/3 correct answers (worse exam than already submitted)\n-          const now2 = Date.now();\n-          const response2 = await superRequest('/exam-challenge-completed', {\n-            method: 'POST',\n-            setCookies\n-          }).send({\n-            id: examChallengeId,\n-            challengeType: 17,\n-            userCompletedExam: userExam2\n-          });\n+        test('POST does not update user progress if new exam is not an improvement', async () => {\n+          // Submit exam with 2/3 correct answers\n+          await submitExam(examWithTwoCorrect);\n \n-          const user2 = await fastifyTestInstance.prisma.user.findFirst({\n+          const user1 = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n             where: { id: defaultUserId }\n           });\n \n-          const completedChallenges2 = user2?.completedChallenges || [];\n-          const completedExams2 = user2?.completedExams || [];\n-          const progressTimestamps2 = user2?.progressTimestamps || [];\n+          // Submit exam with 2/3 correct answers (no improvement)\n+          const res2 = await submitExam(examWithTwoCorrect);\n \n-          // should not add to or update completedChallenges\n-          expect(completedChallenges2).toHaveLength(2);\n-          expect(completedChallenges2).toMatchObject([\n-            ...completedTrophyChallenges,\n-            // should still have old completed challenge (should not update)\n-            completedExamChallenge3\n-          ]);\n-          expect(completedChallenges2[1]?.completedDate).toBeLessThan(now2);\n-\n-          // should add to completedExams\n-          expect(completedExams2).toHaveLength(2);\n-          expect(completedExams2[1]).toMatchObject(completedExamChallenge2);\n-          expect(completedExams2[1]?.completedDate).toBeGreaterThan(nowA);\n+          const user2 = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+            where: { id: defaultUserId }\n+          });\n \n-          // should not add to progressTimestamps\n-          expect(progressTimestamps2).toHaveLength(1);\n+          // should not update user progress\n+          expect(user2.completedChallenges).toEqual(user1.completedChallenges);\n+          expect(user2.progressTimestamps).toEqual(user1.progressTimestamps);\n \n-          expect(response2.body).toMatchObject({\n+          expect(res2.body).toMatchObject({\n             points: 1,\n             alreadyCompleted: true,\n-            examResults: mockResults2\n+            examResults: mockResultsTwoCorrect\n           });\n-          expect(response2.statusCode).toBe(200);\n+          expect(res2.statusCode).toBe(200);\n+        });\n \n-          // Submit exam with 3/3 correct answers (better exam than already submitted)\n-          const now3 = Date.now();\n-          const response3 = await superRequest('/exam-challenge-completed', {\n-            method: 'POST',\n-            setCookies\n-          }).send({\n-            id: examChallengeId,\n-            challengeType: 17,\n-            userCompletedExam: userExam4\n-          });\n+        test('POST updates user progress if exam is an improvement', async () => {\n+          // Submit exam with 2/3 correct answers\n+          await submitExam(examWithTwoCorrect);\n+          const user1 = await fastifyTestInstance.prisma.user.findUniqueOrThrow(\n+            {\n+              where: { id: defaultUserId }\n+            }\n+          );\n+\n+          // Submit improved exam\n+          const res = await submitExam(examWithAllCorrect);\n \n-          const user3 = await fastifyTestInstance.prisma.user.findFirst({\n+          const user2 = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n             where: { email: 'foo@bar.com' }\n           });\n \n-          const completedChallenges3 = user3?.completedChallenges || [];\n-          const completedExams3 = user3?.completedExams || [];\n-          const progressTimestamps3 = user3?.progressTimestamps || [];\n-\n           // should update existing completedChallenge\n-          expect(completedChallenges3).toHaveLength(2);\n-          expect(completedChallenges3).toMatchObject([\n+          expect(user2.completedChallenges).toHaveLength(2);\n+          expect(user2.completedChallenges).toMatchObject([\n             ...completedTrophyChallenges,\n-            completedExamChallenge4\n+            completedExamChallengeAllCorrect\n           ]);\n-          expect(completedChallenges3[1]?.completedDate).toBeLessThan(now3);\n-\n-          // should add to completedExams\n-          expect(completedExams3).toHaveLength(3);\n-          expect(completedExams3[2]).toMatchObject(completedExamChallenge4);\n-          expect(completedExams3[2]?.completedDate).toBeGreaterThan(now3);\n+          expect(user2.completedChallenges[1]?.completedDate).toEqual(\n+            user1.completedChallenges[1]?.completedDate\n+          );\n \n-          expect(progressTimestamps3).toHaveLength(1);\n+          // they have not completed anything new, so progressTimestamps should\n+          // remain the same\n+          expect(user2.progressTimestamps).toEqual(user1.progressTimestamps);\n \n-          expect(response3.body).toMatchObject({\n+          expect(res.body).toMatchObject({\n             points: 1,\n             alreadyCompleted: true,\n-            examResults: mockResults4\n+            examResults: mockResultsAllCorrect\n           });\n-          expect(response3.statusCode).toBe(200);\n+          expect(res.statusCode).toBe(200);\n         });\n       });\n     });"
        },
        {
            "sha": "086ebe710306d39128f99da2e26780c81e4ed3cc",
            "filename": "api/src/utils/exam.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 16,
            "changes": 44,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2Fsrc%2Futils%2Fexam.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7/api%2Fsrc%2Futils%2Fexam.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fexam.test.ts?ref=d06bbab6f8211a6b0bc323bf1acd0a59c546e6e7",
            "patch": "@@ -1,14 +1,14 @@\n import { Exam, Question } from '@prisma/client';\n import {\n   examJson,\n-  userExam1,\n-  userExam2,\n-  userExam3,\n-  userExam4,\n-  mockResults1,\n-  mockResults2,\n-  mockResults3,\n-  mockResults4\n+  examWithZeroCorrect,\n+  examWithOneCorrect,\n+  examWithTwoCorrect,\n+  examWithAllCorrect,\n+  mockResultsZeroCorrect,\n+  mockResultsOneCorrect,\n+  mockResultsTwoCorrect,\n+  mockResultsAllCorrect\n } from '../../__mocks__/exam';\n import { generateRandomExam, createExamResults } from './exam';\n import { GeneratedExam } from './exam-types';\n@@ -45,19 +45,31 @@ describe('Exam helpers', () => {\n   });\n \n   describe('createExamResults()', () => {\n-    const examResults1 = createExamResults(userExam1, examJson as Exam);\n-    const examResults2 = createExamResults(userExam2, examJson as Exam);\n-    const examResults3 = createExamResults(userExam3, examJson as Exam);\n-    const examResults4 = createExamResults(userExam4, examJson as Exam);\n+    const examResults1 = createExamResults(\n+      examWithZeroCorrect,\n+      examJson as Exam\n+    );\n+    const examResults2 = createExamResults(\n+      examWithOneCorrect,\n+      examJson as Exam\n+    );\n+    const examResults3 = createExamResults(\n+      examWithTwoCorrect,\n+      examJson as Exam\n+    );\n+    const examResults4 = createExamResults(\n+      examWithAllCorrect,\n+      examJson as Exam\n+    );\n \n     it('failing exam should return correct results', () => {\n-      expect(examResults1).toEqual(mockResults1);\n+      expect(examResults1).toEqual(mockResultsZeroCorrect);\n     });\n \n     it('passing exam should return correct results', () => {\n-      expect(examResults2).toEqual(mockResults2);\n-      expect(examResults3).toEqual(mockResults3);\n-      expect(examResults4).toEqual(mockResults4);\n+      expect(examResults2).toEqual(mockResultsOneCorrect);\n+      expect(examResults3).toEqual(mockResultsTwoCorrect);\n+      expect(examResults4).toEqual(mockResultsAllCorrect);\n     });\n   });\n });"
        }
    ],
    "stats": {
        "total": 349,
        "additions": 196,
        "deletions": 153
    }
}