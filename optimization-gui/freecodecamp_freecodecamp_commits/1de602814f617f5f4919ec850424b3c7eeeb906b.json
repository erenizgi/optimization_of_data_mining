{
    "author": "ShaunSHamilton",
    "message": "feat(api): add `updateCount` field to user (#55349)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "1de602814f617f5f4919ec850424b3c7eeeb906b",
    "files": [
        {
            "sha": "aedd827ad26bd05cd430b79a1f3583e8bcbfc54c",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/1de602814f617f5f4919ec850424b3c7eeeb906b/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/1de602814f617f5f4919ec850424b3c7eeeb906b/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=1de602814f617f5f4919ec850424b3c7eeeb906b",
            "patch": "@@ -55,11 +55,6 @@ type ProfileUI {\n   showTimeLine  Boolean? // Undefined\n }\n \n-// Currently unused, so commented out.\n-// type ProgressTimestamp {\n-//   timestamp Float\n-// }\n-\n type SavedChallengeFile {\n   contents String\n   ext      String\n@@ -74,11 +69,11 @@ type SavedChallenge {\n   lastSavedDate Float\n }\n \n+/// Corresponds to the `user` collection.\n model user {\n   id                           String                        @id @default(auto()) @map(\"_id\") @db.ObjectId\n   about                        String\n   acceptedPrivacyTerms         Boolean\n-  // badges    Json? // Undefined | { coreTeam [][] } removed, as new API never uses it.\n   completedChallenges          CompletedChallenge[]\n   completedExams               CompletedExam[] // Undefined\n   currentChallengeId           String?\n@@ -88,7 +83,6 @@ model user {\n   emailVerified                Boolean\n   emailVerifyTTL               DateTime? // Null | Undefined\n   externalId                   String\n-  // github    String? Removed, because value was only ever found to be Null\n   githubProfile                String? // Undefined\n   isApisMicroservicesCert      Boolean? // Undefined\n   isBackEndCert                Boolean? // Undefined\n@@ -127,13 +121,20 @@ model user {\n   portfolio                    Portfolio[]\n   profileUI                    ProfileUI? // Undefined\n   progressTimestamps           Json? // ProgressTimestamp[] | Null[] | Int64[] | Double[] - TODO: NORMALIZE\n-  // rand Float? // Undefined removed, as new API never uses it.\n+  /// A random number between 0 and 1.\n+  ///\n+  /// Valuable for selectively performing random logic.\n+  rand                         Float?\n   savedChallenges              SavedChallenge[] // Undefined | SavedChallenge[]\n   sendQuincyEmail              Boolean\n   theme                        String? // Undefined\n   timezone                     String? // Undefined\n   twitter                      String? // Null | Undefined\n   unsubscribeId                String\n+  /// Used to track the number of times the user's record was written to.\n+  ///\n+  /// This has the main benefit of allowing concurrent ops to check for race conditions.\n+  updateCount                  Int?                          @default(0)\n   username                     String // TODO(Post-MVP): make this unique\n   usernameDisplay              String? // Undefined\n   verificationToken            String? // Undefined"
        },
        {
            "sha": "2b094bff9eac9f9f0ecde9f49c701608b6f10d37",
            "filename": "api/src/db/extensions.test.ts",
            "status": "added",
            "additions": 107,
            "deletions": 0,
            "changes": 107,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/1de602814f617f5f4919ec850424b3c7eeeb906b/api%2Fsrc%2Fdb%2Fextensions.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/1de602814f617f5f4919ec850424b3c7eeeb906b/api%2Fsrc%2Fdb%2Fextensions.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fdb%2Fextensions.test.ts?ref=1de602814f617f5f4919ec850424b3c7eeeb906b",
            "patch": "@@ -0,0 +1,107 @@\n+import { defaultUserEmail, setupServer } from '../../jest.utils';\n+import { createUserInput } from '../utils/create-user';\n+\n+describe('prisma client extensions', () => {\n+  setupServer();\n+\n+  beforeEach(async () => {\n+    await fastifyTestInstance.prisma.user.deleteMany({\n+      where: { email: defaultUserEmail }\n+    });\n+  });\n+\n+  afterAll(async () => {\n+    await fastifyTestInstance.prisma.user.deleteMany({\n+      where: { email: defaultUserEmail }\n+    });\n+  });\n+\n+  describe('updateCount', () => {\n+    it('should default to 0', async () => {\n+      const user = await fastifyTestInstance.prisma.user.create({\n+        data: createUserInput(defaultUserEmail)\n+      });\n+\n+      expect(user).toMatchObject({\n+        updateCount: 0\n+      });\n+    });\n+\n+    it('should increment by one for updates and creates', async () => {\n+      const user = await fastifyTestInstance.prisma.user.create({\n+        data: createUserInput(defaultUserEmail)\n+      });\n+\n+      const updateUser = await fastifyTestInstance.prisma.user.update({\n+        where: { id: user.id },\n+        data: { username: 'any-change' }\n+      });\n+\n+      expect(updateUser).toMatchObject({\n+        username: 'any-change',\n+        updateCount: 1\n+      });\n+\n+      await fastifyTestInstance.prisma.user.updateMany({\n+        where: { id: user.id },\n+        // Even no change to values updates the updateCount\n+        data: { username: 'any-change' }\n+      });\n+\n+      const updateManyUser = await fastifyTestInstance.prisma.user.findUnique({\n+        where: { id: user.id }\n+      });\n+\n+      expect(updateManyUser).toMatchObject({\n+        username: 'any-change',\n+        updateCount: 2\n+      });\n+\n+      const upsertUser = await fastifyTestInstance.prisma.user.upsert({\n+        where: { id: user.id },\n+        create: createUserInput(defaultUserEmail),\n+        update: { username: 'upser-user' }\n+      });\n+\n+      expect(upsertUser).toMatchObject({\n+        username: 'upser-user',\n+        updateCount: 3\n+      });\n+    });\n+\n+    it(\"should not increment for 'find' queries\", async () => {\n+      const user = await fastifyTestInstance.prisma.user.create({\n+        data: createUserInput(defaultUserEmail)\n+      });\n+\n+      const findUniqueUser = await fastifyTestInstance.prisma.user.findUnique({\n+        where: { id: user.id }\n+      });\n+\n+      expect(findUniqueUser).toMatchObject({\n+        updateCount: 0\n+      });\n+\n+      const findManyUsers = await fastifyTestInstance.prisma.user.findMany();\n+\n+      expect(findManyUsers).toHaveLength(1);\n+      expect(findManyUsers[0]).toMatchObject({\n+        updateCount: 0\n+      });\n+\n+      const findFirstUser = await fastifyTestInstance.prisma.user.findFirst();\n+\n+      expect(findFirstUser).toMatchObject({\n+        updateCount: 0\n+      });\n+\n+      const findRawUser = await fastifyTestInstance.prisma.user.findRaw({\n+        filter: { email: defaultUserEmail }\n+      });\n+\n+      expect(findRawUser[0]).toMatchObject({\n+        updateCount: 0\n+      });\n+    });\n+  });\n+});"
        },
        {
            "sha": "397df5b78b1aad43213ac7e52f95e8b194bd8279",
            "filename": "api/src/db/prisma.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 7,
            "changes": 44,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/1de602814f617f5f4919ec850424b3c7eeeb906b/api%2Fsrc%2Fdb%2Fprisma.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/1de602814f617f5f4919ec850424b3c7eeeb906b/api%2Fsrc%2Fdb%2Fprisma.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fdb%2Fprisma.ts?ref=1de602814f617f5f4919ec850424b3c7eeeb906b",
            "patch": "@@ -7,18 +7,20 @@ import { MONGOHQ_URL } from '../utils/env';\n \n declare module 'fastify' {\n   interface FastifyInstance {\n-    prisma: PrismaClient;\n+    prisma: ReturnType<typeof extendClient>;\n   }\n }\n \n const prismaPlugin: FastifyPluginAsync = fp(async (server, _options) => {\n-  const prisma = new PrismaClient({\n-    datasources: {\n-      db: {\n-        url: MONGOHQ_URL\n+  const prisma = extendClient(\n+    new PrismaClient({\n+      datasources: {\n+        db: {\n+          url: MONGOHQ_URL\n+        }\n       }\n-    }\n-  });\n+    })\n+  );\n \n   await prisma.$connect();\n \n@@ -29,4 +31,32 @@ const prismaPlugin: FastifyPluginAsync = fp(async (server, _options) => {\n   });\n });\n \n+// TODO: It would be nice to split this up into multiple update functions,\n+//       but the types are a pain.\n+// TODO: Multiple extended clients can be used for different restrictions (e.g. session vs non-session users)\n+// TODO: Could be used to add other _easily forgotten_ fields like `progressTimestamp`\n+function extendClient(prisma: PrismaClient) {\n+  return prisma.$extends({\n+    query: {\n+      user: {\n+        async update({ args, query }) {\n+          args.data.updateCount = { increment: 1 };\n+          return query(args);\n+        },\n+        async updateMany({ args, query }) {\n+          args.data.updateCount = { increment: 1 };\n+          return query(args);\n+        },\n+        async upsert({ args, query }) {\n+          args.update.updateCount = { increment: 1 };\n+          return query(args);\n+        }\n+        // NOTE: raw ops are untouched, as it is meant to be a direct passthrough to mongodb\n+        // async findRaw({ model, operation, args, query }) {}\n+        // async aggregateRaw({ model, operation, args, query }) {}\n+      }\n+    }\n+  });\n+}\n+\n export default prismaPlugin;"
        }
    ],
    "stats": {
        "total": 168,
        "additions": 153,
        "deletions": 15
    }
}