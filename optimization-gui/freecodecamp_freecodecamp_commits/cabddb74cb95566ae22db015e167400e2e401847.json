{
    "author": "huyenltnguyen",
    "message": "feat(challenge-parser,client): display Chinese dialogue with ruby annotations (#64235)",
    "sha": "cabddb74cb95566ae22db015e167400e2e401847",
    "files": [
        {
            "sha": "8db2fe7dce561f513761875eae55989e2606ae77",
            "filename": "client/src/templates/Challenges/components/scene/scene-helpers.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cabddb74cb95566ae22db015e167400e2e401847/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene-helpers.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cabddb74cb95566ae22db015e167400e2e401847/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene-helpers.test.ts?ref=cabddb74cb95566ae22db015e167400e2e401847",
            "patch": "@@ -191,5 +191,22 @@ describe('scene-helpers', () => {\n         '\\n<strong>Naomi</strong>: Use <div> and <span> tags\\n'\n       );\n     });\n+\n+    it('should preserve Chinese dialogue with ruby annotations', () => {\n+      const commands: SceneCommand[] = [\n+        {\n+          character: 'Naomi',\n+          startTime: 1,\n+          dialogue: {\n+            text: '<ruby>你好<rp>(</rp><rt>nǐ hǎo</rt><rp>)</rp></ruby>，<ruby>世界<rp>(</rp><rt>shì jiè</rt><rp>)</rp></ruby>。',\n+            align: 'left'\n+          }\n+        }\n+      ];\n+      const result = buildTranscript(commands);\n+      expect(result).toBe(\n+        '\\n<strong>Naomi</strong>: <ruby>你好<rp>(</rp><rt>nǐ hǎo</rt><rp>)</rp></ruby>，<ruby>世界<rp>(</rp><rt>shì jiè</rt><rp>)</rp></ruby>。\\n'\n+      );\n+    });\n   });\n });"
        },
        {
            "sha": "7db9ef3ce37d913d6f16a7418da4f92e935af657",
            "filename": "client/src/templates/Challenges/components/scene/scene.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cabddb74cb95566ae22db015e167400e2e401847/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cabddb74cb95566ae22db015e167400e2e401847/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx?ref=cabddb74cb95566ae22db015e167400e2e401847",
            "patch": "@@ -393,7 +393,10 @@ export function Scene({\n                 }`}\n               >\n                 <div className='scene-dialogue-label'>{dialogue.label}</div>\n-                <div className='scene-dialogue-text'>{dialogue.text}</div>\n+                <div\n+                  className='scene-dialogue-text'\n+                  dangerouslySetInnerHTML={{ __html: dialogue.text }}\n+                />\n               </div>\n             )}\n           </>"
        },
        {
            "sha": "e2e5087723c41c7ee6b7fc49002d6b6896135735",
            "filename": "tools/challenge-parser/parser/__fixtures__/with-chinese-scene-no-pinyin.md",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-chinese-scene-no-pinyin.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-chinese-scene-no-pinyin.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-chinese-scene-no-pinyin.md?ref=cabddb74cb95566ae22db015e167400e2e401847",
            "patch": "@@ -0,0 +1,35 @@\n+# --description--\n+\n+This challenge has a Chinese scene with plain hanzi (no pinyin).\n+\n+# --scene--\n+\n+```json\n+{\n+  \"setup\": {\n+    \"background\": \"company1-reception.png\",\n+    \"characters\": [\n+      {\n+        \"character\": \"Wang Hua\",\n+        \"position\": { \"x\": 50, \"y\": 15, \"z\": 1.4 },\n+        \"opacity\": 0\n+      }\n+    ],\n+    \"audio\": {\n+      \"filename\": \"test.mp3\",\n+      \"startTime\": 1\n+    }\n+  },\n+  \"commands\": [\n+    {\n+      \"character\": \"Wang Hua\",\n+      \"startTime\": 1,\n+      \"finishTime\": 2,\n+      \"dialogue\": {\n+        \"text\": \"你好，世界。\",\n+        \"align\": \"center\"\n+      }\n+    }\n+  ]\n+}\n+```"
        },
        {
            "sha": "dad5573697efbaa3e5209d26f0bc92f9da0d06a8",
            "filename": "tools/challenge-parser/parser/__fixtures__/with-chinese-scene.md",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-chinese-scene.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-chinese-scene.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-chinese-scene.md?ref=cabddb74cb95566ae22db015e167400e2e401847",
            "patch": "@@ -0,0 +1,37 @@\n+# --description--\n+\n+This challenge has a Chinese scene with hanzi-pinyin pairs.\n+\n+# --scene--\n+\n+```json\n+{\n+  \"setup\": {\n+    \"background\": \"company1-reception.png\",\n+    \"characters\": [\n+      {\n+        \"character\": \"Wang Hua\",\n+        \"position\": { \"x\": 50, \"y\": 15, \"z\": 1.4 },\n+        \"opacity\": 0\n+      }\n+    ],\n+    \"audio\": {\n+      \"filename\": \"ZH_A1_welcome_hello_world.mp3\",\n+      \"startTime\": 1,\n+      \"startTimestamp\": 5.18,\n+      \"finishTimestamp\": 6.71\n+    }\n+  },\n+  \"commands\": [\n+    {\n+      \"character\": \"Wang Hua\",\n+      \"startTime\": 1,\n+      \"finishTime\": 2.53,\n+      \"dialogue\": {\n+        \"text\": \"你好 (nǐ hǎo)，世界 (shì jiè)。\",\n+        \"align\": \"center\"\n+      }\n+    }\n+  ]\n+}\n+```"
        },
        {
            "sha": "2f87f52b74dfd6c209ccf0814fd313b1490bc07b",
            "filename": "tools/challenge-parser/parser/plugins/add-scene.js",
            "status": "modified",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-scene.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-scene.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-scene.js?ref=cabddb74cb95566ae22db015e167400e2e401847",
            "patch": "@@ -1,4 +1,8 @@\n const { getSection } = require('./utils/get-section');\n+const {\n+  createMdastToHtml,\n+  parseHanziPinyinPairs\n+} = require('./utils/i18n-stringify');\n \n function plugin() {\n   return transformer;\n@@ -17,6 +21,47 @@ function plugin() {\n \n       // throws if we can't parse it.\n       const sceneJson = JSON.parse(sceneNodes[0].value);\n+\n+      // Convert hanzi-pinyin pairs to HTML in dialogue text\n+      if (sceneJson.commands) {\n+        const toHtml = createMdastToHtml(file.data.lang);\n+\n+        sceneJson.commands = sceneJson.commands.map(command => {\n+          if (\n+            command.dialogue &&\n+            command.dialogue.text &&\n+            parseHanziPinyinPairs(command.dialogue.text).length > 0\n+          ) {\n+            // Wrap text in inlineCode node so the Chinese handler can process it.\n+            // The paragraph wrapper is required by mdastToHTML's structure.\n+            const nodes = [\n+              {\n+                type: 'paragraph',\n+                children: [\n+                  {\n+                    type: 'inlineCode',\n+                    value: command.dialogue.text\n+                  }\n+                ]\n+              }\n+            ];\n+\n+            const html = toHtml(nodes);\n+            // Remove the <p> wrapper tags, keeping only the inner ruby elements\n+            const innerHtml = html.replace(/^<p>|<\\/p>$/g, '');\n+\n+            return {\n+              ...command,\n+              dialogue: {\n+                ...command.dialogue,\n+                text: innerHtml\n+              }\n+            };\n+          }\n+          return command;\n+        });\n+      }\n+\n       file.data.scene = sceneJson;\n     }\n   }"
        },
        {
            "sha": "c7307bd52b89f42a46e126a4b92c9a153f439188",
            "filename": "tools/challenge-parser/parser/plugins/add-scene.test.js",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-scene.test.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cabddb74cb95566ae22db015e167400e2e401847/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-scene.test.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-scene.test.js?ref=cabddb74cb95566ae22db015e167400e2e401847",
            "patch": "@@ -0,0 +1,67 @@\n+import { describe, beforeAll, beforeEach, it, expect } from 'vitest';\n+import parseFixture from '../__fixtures__/parse-fixture';\n+import addScene from './add-scene';\n+\n+describe('add-scene', () => {\n+  let sceneAST, chineseSceneAST, chineseSceneNoPinyinAST;\n+  let file;\n+\n+  beforeAll(async () => {\n+    sceneAST = await parseFixture('scene.md');\n+    chineseSceneAST = await parseFixture('with-chinese-scene.md');\n+    chineseSceneNoPinyinAST = await parseFixture(\n+      'with-chinese-scene-no-pinyin.md'\n+    );\n+  });\n+\n+  beforeEach(() => {\n+    file = { data: { lang: 'en' } };\n+  });\n+\n+  it('should add scene data to file when scene section exists', () => {\n+    const plugin = addScene();\n+    plugin(sceneAST, file);\n+\n+    expect(file.data.scene).toBeDefined();\n+    expect(file.data.scene.setup.background).toBe('company2-center.png');\n+    expect(file.data.scene.commands).toHaveLength(3);\n+  });\n+\n+  it('should preserve dialogue text for non-Chinese scenes', () => {\n+    const plugin = addScene();\n+    plugin(sceneAST, file);\n+\n+    expect(file.data.scene.commands[1].dialogue.text).toBe(\n+      \"I'm Maria, the team lead.\"\n+    );\n+    expect(file.data.scene.commands[1].dialogue.text).not.toContain('<ruby>');\n+  });\n+\n+  it('should convert Chinese hanzi-pinyin pairs to ruby HTML', () => {\n+    file.data.lang = 'zh-CN';\n+    const plugin = addScene();\n+    plugin(chineseSceneAST, file);\n+\n+    const dialogueText = file.data.scene.commands[0].dialogue.text;\n+    expect(dialogueText).toBe(\n+      '<ruby>你好<rp>(</rp><rt>nǐ hǎo</rt><rp>)</rp></ruby>，<ruby>世界<rp>(</rp><rt>shì jiè</rt><rp>)</rp></ruby>。'\n+    );\n+  });\n+\n+  it('should not convert Hanzi-only to ruby HTML', () => {\n+    file.data.lang = 'zh-CN';\n+    const plugin = addScene();\n+    plugin(chineseSceneNoPinyinAST, file);\n+\n+    expect(file.data.scene.commands[0].dialogue.text).toBe('你好，世界。');\n+    expect(file.data.scene.commands[0].dialogue.text).not.toContain('<ruby>');\n+  });\n+\n+  it('should handle commands without dialogue', () => {\n+    const plugin = addScene();\n+    plugin(sceneAST, file);\n+\n+    expect(file.data.scene.commands[0].dialogue).toBeUndefined();\n+    expect(file.data.scene.commands[2].dialogue).toBeUndefined();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 205,
        "deletions": 1
    }
}