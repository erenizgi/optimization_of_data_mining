{
    "author": "ojeytonwilliams",
    "message": "feat(api): set log level for csrf errors (#59228)",
    "sha": "f6b57883e1e6522bca085a9c581f4ada940eed8a",
    "files": [
        {
            "sha": "3ec8ba2c6b3576dd153a83a0b92204fcf982ebe3",
            "filename": "api/src/plugins/csrf.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f6b57883e1e6522bca085a9c581f4ada940eed8a/api%2Fsrc%2Fplugins%2Fcsrf.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f6b57883e1e6522bca085a9c581f4ada940eed8a/api%2Fsrc%2Fplugins%2Fcsrf.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcsrf.ts?ref=f6b57883e1e6522bca085a9c581f4ada940eed8a",
            "patch": "@@ -22,7 +22,8 @@ const csrf: FastifyPluginCallback = (fastify, _options, done) => {\n     ///Ignore all other possible sources of CSRF\n     // tokens since we know we can provide this one\n     getToken: req => req.headers[CSRF_HEADER] as string,\n-    cookieOpts: { signed: false, sameSite: 'strict' }\n+    cookieOpts: { signed: false, sameSite: 'strict' },\n+    logLevel: 'debug'\n   });\n \n   // All routes except signout should add a CSRF token to the response"
        },
        {
            "sha": "54f332c898539d5d957a426d8e72b90b89ed3d4c",
            "filename": "package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f6b57883e1e6522bca085a9c581f4ada940eed8a/package.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f6b57883e1e6522bca085a9c581f4ada940eed8a/package.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/package.json?ref=f6b57883e1e6522bca085a9c581f4ada940eed8a",
            "patch": "@@ -140,7 +140,8 @@\n   \"packageManager\": \"pnpm@9.10.0+sha512.73a29afa36a0d092ece5271de5177ecbf8318d454ecd701343131b8ebc0c1a91c487da46ab77c8e596d6acf1461e3594ced4becedf8921b074fbd8653ed7051c\",\n   \"pnpm\": {\n     \"patchedDependencies\": {\n-      \"@fastify/oauth2@7.8.1\": \"patches/@fastify__oauth2@7.8.1.patch\"\n+      \"@fastify/oauth2@7.8.1\": \"patches/@fastify__oauth2@7.8.1.patch\",\n+      \"@fastify/csrf-protection@6.4.1\": \"patches/@fastify__csrf-protection@6.4.1.patch\"\n     },\n     \"peerDependencyRules\": {\n       \"allowedVersions\": {"
        },
        {
            "sha": "d42e3e0ecdf2048031c23b499bf72fae29f0339c",
            "filename": "patches/@fastify__csrf-protection@6.4.1.patch",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f6b57883e1e6522bca085a9c581f4ada940eed8a/patches%2F%40fastify__csrf-protection%406.4.1.patch",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f6b57883e1e6522bca085a9c581f4ada940eed8a/patches%2F%40fastify__csrf-protection%406.4.1.patch",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/patches%2F%40fastify__csrf-protection%406.4.1.patch?ref=f6b57883e1e6522bca085a9c581f4ada940eed8a",
            "patch": "@@ -0,0 +1,46 @@\n+diff --git a/index.js b/index.js\n+index a183decaf9ec2403a483c7b80cee3c41122c3c25..e5f6b046e43879b31d2b149d7e0cebf941e1c09e 100644\n+--- a/index.js\n++++ b/index.js\n+@@ -14,7 +14,8 @@ const defaultOptions = {\n+   sessionKey: '_csrf',\n+   getToken: getTokenDefault,\n+   getUserInfo: getUserInfoDefault,\n+-  sessionPlugin: '@fastify/cookie'\n++  sessionPlugin: '@fastify/cookie',\n++  logLevel: 'warn'\n+ }\n+ \n+ async function fastifyCsrfProtection (fastify, opts) {\n+@@ -24,7 +25,8 @@ async function fastifyCsrfProtection (fastify, opts) {\n+     sessionKey,\n+     getToken,\n+     getUserInfo,\n+-    sessionPlugin\n++    sessionPlugin,\n++    logLevel\n+   } = Object.assign({}, defaultOptions, opts)\n+ \n+   const csrfOpts = opts && opts.csrfOpts ? opts.csrfOpts : {}\n+@@ -34,6 +36,7 @@ async function fastifyCsrfProtection (fastify, opts) {\n+   assert(typeof getToken === 'function', 'getToken should be a function')\n+   assert(typeof getUserInfo === 'function', 'getUserInfo should be a function')\n+   assert(typeof cookieOpts === 'object', 'cookieOpts should be a object')\n++  assert(typeof logLevel === 'string', 'logLevel should be a string')\n+   assert(\n+     ['@fastify/cookie', '@fastify/session', '@fastify/secure-session'].includes(sessionPlugin),\n+     \"sessionPlugin should be one of the following: '@fastify/cookie', '@fastify/session', '@fastify/secure-session'\"\n+@@ -113,11 +116,11 @@ async function fastifyCsrfProtection (fastify, opts) {\n+   function csrfProtection (req, reply, next) {\n+     const secret = getSecret(req, reply)\n+     if (!secret) {\n+-      req.log.warn('Missing csrf secret')\n++      req.log[logLevel]('Missing csrf secret')\n+       return reply.send(new MissingCSRFSecretError())\n+     }\n+     if (!tokens.verify(secret, getToken(req), getUserInfo(req))) {\n+-      req.log.warn('Invalid csrf token')\n++      req.log[logLevel]('Invalid csrf token')\n+       return reply.send(new InvalidCSRFTokenError())\n+     }\n+     next()"
        },
        {
            "sha": "678355d009a758f9337cef9f463faad96e97dd06",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f6b57883e1e6522bca085a9c581f4ada940eed8a/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f6b57883e1e6522bca085a9c581f4ada940eed8a/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=f6b57883e1e6522bca085a9c581f4ada940eed8a",
            "patch": "@@ -5,6 +5,9 @@ settings:\n   excludeLinksFromLockfile: false\n \n patchedDependencies:\n+  '@fastify/csrf-protection@6.4.1':\n+    hash: elxrdbqdtcfdnqaccvz7u6zxb4\n+    path: patches/@fastify__csrf-protection@6.4.1.patch\n   '@fastify/oauth2@7.8.1':\n     hash: fjqma2r6xxjavghcsvyjlkhmyy\n     path: patches/@fastify__oauth2@7.8.1.patch\n@@ -166,7 +169,7 @@ importers:\n         version: 9.4.0\n       '@fastify/csrf-protection':\n         specifier: 6.4.1\n-        version: 6.4.1\n+        version: 6.4.1(patch_hash=elxrdbqdtcfdnqaccvz7u6zxb4)\n       '@fastify/multipart':\n         specifier: ^8.3.0\n         version: 8.3.1\n@@ -19096,7 +19099,7 @@ snapshots:\n       cookie-signature: 1.2.1\n       fastify-plugin: 4.5.1\n \n-  '@fastify/csrf-protection@6.4.1':\n+  '@fastify/csrf-protection@6.4.1(patch_hash=elxrdbqdtcfdnqaccvz7u6zxb4)':\n     dependencies:\n       '@fastify/csrf': 6.2.0\n       '@fastify/error': 3.4.1"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 55,
        "deletions": 4
    }
}