{
    "author": "ojeytonwilliams",
    "message": "fix(api): handle string challengeType (#60491)",
    "sha": "8138f086aa8b2e00d272d87b0772621a8391243e",
    "files": [
        {
            "sha": "fb4cf1b96ad5d48071f42b871267863c521443cb",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=8138f086aa8b2e00d272d87b0772621a8391243e",
            "patch": "@@ -19,7 +19,7 @@ type File {\n }\n \n type CompletedChallenge {\n-  challengeType      Int?         @db.Int // Null | Undefined\n+  challengeType      Json? // Null | Undefined | String | Int\n   completedDate      Json // DateTime | Float, but not, as far as we know, Null\n   files              File[]\n   githubLink         String? // Undefined"
        },
        {
            "sha": "0cde3eb3ffa86481de5f48fcd4a9cf04b2989bf7",
            "filename": "api/src/routes/protected/challenge.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts?ref=8138f086aa8b2e00d272d87b0772621a8391243e",
            "patch": "@@ -35,7 +35,7 @@ import {\n   verifyTrophyWithMicrosoft\n } from '../helpers/challenge-helpers';\n import { UpdateReqType } from '../../utils';\n-import { normalizeDate } from '../../utils/normalize';\n+import { normalizeChallengeType, normalizeDate } from '../../utils/normalize';\n \n interface JwtPayload {\n   userToken: string;\n@@ -670,8 +670,13 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n \n         const newCompletedChallenges: CompletedChallenge[] =\n           completedChallenges.map(c => {\n-            const { completedDate, ...rest } = c;\n-            return { completedDate: normalizeDate(completedDate), ...rest };\n+            const { completedDate, challengeType, ...rest } = c;\n+\n+            return {\n+              completedDate: normalizeDate(completedDate),\n+              challengeType: normalizeChallengeType(challengeType),\n+              ...rest\n+            };\n           });\n         const newCompletedExams: CompletedExam[] = completedExams;\n         const newProgressTimeStamps = progressTimestamps as ProgressTimestamp[];"
        },
        {
            "sha": "65c9a8d1ba1e4e132a883981948576526ad3e18d",
            "filename": "api/src/utils/normalize.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fsrc%2Futils%2Fnormalize.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fsrc%2Futils%2Fnormalize.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fnormalize.test.ts?ref=8138f086aa8b2e00d272d87b0772621a8391243e",
            "patch": "@@ -3,7 +3,8 @@ import {\n   normalizeProfileUI,\n   normalizeChallenges,\n   normalizeFlags,\n-  normalizeDate\n+  normalizeDate,\n+  normalizeChallengeType\n } from './normalize';\n \n describe('normalize', () => {\n@@ -158,7 +159,7 @@ describe('normalize', () => {\n     });\n   });\n \n-  describe('validateDate', () => {\n+  describe('normalizeDate', () => {\n     it('should return the date as a number', () => {\n       expect(normalizeDate(1)).toEqual(1);\n       expect(normalizeDate({ $date: '2023-10-01T00:00:00Z' })).toEqual(\n@@ -175,4 +176,21 @@ describe('normalize', () => {\n       );\n     });\n   });\n+\n+  describe('normalizeChallengeType', () => {\n+    it('should return the challenge type as a number or null', () => {\n+      expect(normalizeChallengeType(10)).toEqual(10);\n+      expect(normalizeChallengeType('10')).toEqual(10);\n+      expect(normalizeChallengeType(null)).toEqual(null);\n+    });\n+\n+    it('should throw an error if the challenge type is not in the expected shape', () => {\n+      expect(() => normalizeChallengeType('invalid')).toThrow(\n+        'Unexpected challengeType value: \"invalid\"'\n+      );\n+      expect(() => normalizeChallengeType({ type: '123' })).toThrow(\n+        'Unexpected challengeType value: {\"type\":\"123\"}'\n+      );\n+    });\n+  });\n });"
        },
        {
            "sha": "0c621c4eb090581542f8178942e415ff4c93154c",
            "filename": "api/src/utils/normalize.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 12,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fsrc%2Futils%2Fnormalize.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8138f086aa8b2e00d272d87b0772621a8391243e/api%2Fsrc%2Futils%2Fnormalize.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fnormalize.ts?ref=8138f086aa8b2e00d272d87b0772621a8391243e",
            "patch": "@@ -61,6 +61,34 @@ export const normalizeDate = (date?: Prisma.JsonValue): number => {\n   }\n };\n \n+/**\n+ * Normalizes a challenge type value to a number.\n+ *\n+ * @param challengeType A JSON value that can be a number, string, or null.\n+ * @returns The challenge type as a number or null.\n+ */\n+export const normalizeChallengeType = (\n+  challengeType?: Prisma.JsonValue\n+): number | null => {\n+  if (typeof challengeType === 'number') {\n+    return challengeType;\n+  } else if (typeof challengeType === 'string') {\n+    const parsed = parseInt(challengeType, 10);\n+    if (isNaN(parsed)) {\n+      throw Error(\n+        'Unexpected challengeType value: ' + JSON.stringify(challengeType)\n+      );\n+    }\n+    return parsed;\n+  } else if (challengeType === null) {\n+    return null;\n+  } else {\n+    throw Error(\n+      'Unexpected challengeType value: ' + JSON.stringify(challengeType)\n+    );\n+  }\n+};\n+\n /**\n  * Ensure that the user's profile UI settings are valid.\n  *\n@@ -125,9 +153,16 @@ export type NormalizedChallenge = {\n export const normalizeChallenges = (\n   completedChallenges: CompletedChallenge[]\n ): NormalizedChallenge[] => {\n-  const noNullProps = completedChallenges.map(challenge =>\n-    removeNulls(challenge)\n-  );\n+  const fixedDateAndType = completedChallenges.map(challenge => {\n+    const { completedDate, challengeType, ...rest } = challenge;\n+    return {\n+      ...rest,\n+      completedDate: normalizeDate(completedDate),\n+      challengeType: normalizeChallengeType(challengeType)\n+    };\n+  });\n+\n+  const noNullProps = fixedDateAndType.map(challenge => removeNulls(challenge));\n   // files.path is optional\n   const noNullPath = noNullProps.map(challenge => {\n     const { files, ...rest } = challenge;\n@@ -136,15 +171,7 @@ export const normalizeChallenges = (\n     return { ...rest, files: noNullFiles };\n   });\n \n-  const withNumberDates = noNullPath.map(challenge => {\n-    const { completedDate, ...rest } = challenge;\n-    return {\n-      ...rest,\n-      completedDate: normalizeDate(completedDate)\n-    };\n-  });\n-\n-  return withNumberDates;\n+  return noNullPath;\n };\n \n type NormalizedSurvey = {"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 68,
        "deletions": 18
    }
}