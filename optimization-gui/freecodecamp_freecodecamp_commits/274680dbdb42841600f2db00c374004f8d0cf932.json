{
    "author": "ojeytonwilliams",
    "message": "refactor: separate public and private plugins (#56359)",
    "sha": "274680dbdb42841600f2db00c374004f8d0cf932",
    "files": [
        {
            "sha": "fd1cce2f19da644613b69642a98dfde4bf8fca3a",
            "filename": ".prettierignore",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/.prettierignore",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/.prettierignore",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.prettierignore?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,11 +1,11 @@\n **/.cache\n **/*fixtures*\n-**/public\n api-server/lib\n client/**/trending.json\n client/config/*.json\n client/config/browser-scripts/*.json\n client/static\n+client/public\n curriculum/challenges/_meta/*/*\n curriculum/challenges/**/*\n curriculum/i18n-curriculum"
        },
        {
            "sha": "6ddb7b706ac635b8450c07751ee7b3bbf07f13fc",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -205,9 +205,9 @@ export const defaultUserId = '64c7810107dd4782d32baee7';\n export const defaultUserEmail = 'foo@bar.com';\n export const defaultUsername = 'fcc-test-user';\n \n-export async function devLogin(): Promise<string[]> {\n+export const resetDefaultUser = async (): Promise<void> => {\n   await fastifyTestInstance.prisma.user.deleteMany({\n-    where: { email: 'foo@bar.com' }\n+    where: { email: defaultUserEmail }\n   });\n \n   await fastifyTestInstance.prisma.user.create({\n@@ -217,6 +217,10 @@ export async function devLogin(): Promise<string[]> {\n       username: defaultUsername\n     }\n   });\n+};\n+\n+export async function devLogin(): Promise<string[]> {\n+  await resetDefaultUser();\n   const res = await superRequest('/signin', { method: 'GET' });\n   expect(res.status).toBe(302);\n   return res.get('Set-Cookie');"
        },
        {
            "sha": "665b9effa5bcbd43ad99bf12aecb6c3add946853",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 33,
            "changes": 54,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -26,21 +26,9 @@ import security from './plugins/security';\n import auth from './plugins/auth';\n import bouncer from './plugins/bouncer';\n import notFound from './plugins/not-found';\n-import { authRoutes, mobileAuth0Routes } from './routes/auth';\n-import { devAuthRoutes } from './routes/auth-dev';\n-import {\n-  protectedCertificateRoutes,\n-  unprotectedCertificateRoutes\n-} from './routes/certificate';\n-import { challengeRoutes } from './routes/challenge';\n-import { deprecatedEndpoints } from './routes/deprecated-endpoints';\n-import { unsubscribeDeprecated } from './routes/deprecated-unsubscribe';\n-import { donateRoutes, chargeStripeRoute } from './routes/donate';\n-import { emailSubscribtionRoutes } from './routes/email-subscription';\n-import { settingRoutes, settingRedirectRoutes } from './routes/settings';\n-import { statusRoute } from './routes/status';\n-import { userGetRoutes, userRoutes, userPublicGetRoutes } from './routes/user';\n-import { signoutRoute } from './routes/signout';\n+import * as publicRoutes from './routes/public';\n+import * as protectedRoutes from './routes/protected';\n+\n import {\n   API_LOCATION,\n   EMAIL_PROVIDER,\n@@ -197,48 +185,48 @@ export const build = async (\n       fastify.addHook('onRequest', fastify.csrfProtection);\n       fastify.addHook('onRequest', fastify.send401IfNoUser);\n \n-      await fastify.register(challengeRoutes);\n-      await fastify.register(donateRoutes);\n-      await fastify.register(protectedCertificateRoutes);\n-      await fastify.register(settingRoutes);\n-      await fastify.register(userRoutes);\n+      await fastify.register(protectedRoutes.challengeRoutes);\n+      await fastify.register(protectedRoutes.donateRoutes);\n+      await fastify.register(protectedRoutes.protectedCertificateRoutes);\n+      await fastify.register(protectedRoutes.settingRoutes);\n+      await fastify.register(protectedRoutes.userRoutes);\n     });\n \n     // CSRF protection disabled:\n     await fastify.register(async function (fastify, _opts) {\n       fastify.addHook('onRequest', fastify.send401IfNoUser);\n \n-      await fastify.register(userGetRoutes);\n+      await fastify.register(protectedRoutes.userGetRoutes);\n     });\n \n     // Routes that redirect if access is denied:\n     await fastify.register(async function (fastify, _opts) {\n       fastify.addHook('onRequest', fastify.redirectIfNoUser);\n \n-      await fastify.register(settingRedirectRoutes);\n+      await fastify.register(protectedRoutes.settingRedirectRoutes);\n     });\n   });\n   // Routes for signed out users:\n   void fastify.register(async function (fastify) {\n     fastify.addHook('onRequest', fastify.authorize);\n     // TODO(Post-MVP): add the redirectIfSignedIn hook here, rather than in the\n     // mobileAuth0Routes and authRoutes plugins.\n-    await fastify.register(mobileAuth0Routes);\n+    await fastify.register(publicRoutes.mobileAuth0Routes);\n     // TODO: consolidate with LOCAL_MOCK_AUTH\n     if (FCC_ENABLE_DEV_LOGIN_MODE) {\n-      await fastify.register(devAuthRoutes);\n+      await fastify.register(publicRoutes.devAuthRoutes);\n     } else {\n-      await fastify.register(authRoutes);\n+      await fastify.register(publicRoutes.authRoutes);\n     }\n   });\n-  void fastify.register(chargeStripeRoute);\n-  void fastify.register(signoutRoute);\n-  void fastify.register(emailSubscribtionRoutes);\n-  void fastify.register(userPublicGetRoutes);\n-  void fastify.register(unprotectedCertificateRoutes);\n-  void fastify.register(deprecatedEndpoints);\n-  void fastify.register(statusRoute);\n-  void fastify.register(unsubscribeDeprecated);\n+  void fastify.register(publicRoutes.chargeStripeRoute);\n+  void fastify.register(publicRoutes.signoutRoute);\n+  void fastify.register(publicRoutes.emailSubscribtionRoutes);\n+  void fastify.register(publicRoutes.userPublicGetRoutes);\n+  void fastify.register(publicRoutes.unprotectedCertificateRoutes);\n+  void fastify.register(publicRoutes.deprecatedEndpoints);\n+  void fastify.register(publicRoutes.statusRoute);\n+  void fastify.register(publicRoutes.unsubscribeDeprecated);\n \n   return fastify;\n };"
        },
        {
            "sha": "d4a4e531ccbb7b4f0f4a98fd9dbd85dbe74a01a1",
            "filename": "api/src/routes/helpers/certificate-utils.test.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,48 @@\n+import { getFallbackFullStackDate } from './certificate-utils';\n+\n+const fullStackChallenges = [\n+  {\n+    completedDate: 1585210952511,\n+    id: '5a553ca864b52e1d8bceea14'\n+  },\n+  {\n+    completedDate: 1585210952511,\n+    id: '561add10cb82ac38a17513bc'\n+  },\n+  {\n+    completedDate: 1588665778679,\n+    id: '561acd10cb82ac38a17513bc'\n+  },\n+  {\n+    completedDate: 1685210952511,\n+    id: '561abd10cb81ac38a17513bc'\n+  },\n+  {\n+    completedDate: 1585210952511,\n+    id: '561add10cb82ac38a17523bc'\n+  },\n+  {\n+    completedDate: 1588665778679,\n+    id: '561add10cb82ac38a17213bc'\n+  }\n+];\n+\n+describe('helper functions', () => {\n+  describe('getFallbackFullStackDate', () => {\n+    it('should return the date of the latest completed challenge', () => {\n+      expect(getFallbackFullStackDate(fullStackChallenges, 123)).toBe(\n+        1685210952511\n+      );\n+    });\n+\n+    it('should fall back to completedDate if no certifications are provided', () => {\n+      expect(getFallbackFullStackDate([], 123)).toBe(123);\n+    });\n+\n+    it('should fall back to completedDate if none of the certifications have been completed', () => {\n+      expect(\n+        getFallbackFullStackDate([{ completedDate: 567, id: 'abc' }], 123)\n+      ).toBe(123);\n+    });\n+  });\n+});"
        },
        {
            "sha": "bb4a3c8c378747a10fb301500f5d6bd8033706cc",
            "filename": "api/src/routes/helpers/certificate-utils.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,52 @@\n+import {\n+  certSlugTypeMap,\n+  certIds\n+} from '../../../../shared/config/certification-settings';\n+\n+const {\n+  legacyInfosecQaId,\n+  respWebDesignId,\n+  frontEndDevLibsId,\n+  jsAlgoDataStructId,\n+  dataVis2018Id,\n+  apisMicroservicesId\n+} = certIds;\n+\n+const fullStackCertificateIds = [\n+  respWebDesignId,\n+  jsAlgoDataStructId,\n+  frontEndDevLibsId,\n+  dataVis2018Id,\n+  apisMicroservicesId,\n+  legacyInfosecQaId\n+];\n+\n+/**\n+ * Checks if the given certification slug is known.\n+ *\n+ * @param certSlug - The certification slug to check.\n+ * @returns True if the certification slug is known, otherwise false.\n+ */\n+export function isKnownCertSlug(\n+  certSlug: string\n+): certSlug is keyof typeof certSlugTypeMap {\n+  return certSlug in certSlugTypeMap;\n+}\n+\n+/**\n+ * Retrieves the completion date for the full stack certification, if it exists.\n+ *\n+ * @param completedChallenges - The array of completed challenges.\n+ * @param completedDate - The fallback completed date.\n+ * @returns The latest certification date or the completed date if no certification is found.\n+ */\n+export function getFallbackFullStackDate(\n+  completedChallenges: { id: string; completedDate: number }[],\n+  completedDate: number\n+) {\n+  const latestCertDate = completedChallenges\n+    .filter(chal => fullStackCertificateIds.includes(chal.id))\n+    .sort((a, b) => b.completedDate - a.completedDate)[0]?.completedDate;\n+\n+  return latestCertDate ?? completedDate;\n+}"
        },
        {
            "sha": "29cb6777bee6f1a9c471bbc971a1125a25e5aed7",
            "filename": "api/src/routes/helpers/user-utils.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fhelpers%2Fuser-utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fhelpers%2Fuser-utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fuser-utils.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,49 @@\n+import _ from 'lodash';\n+\n+// user flags that the api-server returns as false if they're missing in the\n+// user document. Since Prisma returns null for missing fields, we need to\n+// normalize them to false.\n+// TODO(Post-MVP): remove this when the database is normalized.\n+const nullableFlags = [\n+  'is2018DataVisCert',\n+  'is2018FullStackCert',\n+  'isApisMicroservicesCert',\n+  'isBackEndCert',\n+  'isCheater',\n+  'isCollegeAlgebraPyCertV8',\n+  'isDataAnalysisPyCertV7',\n+  'isDataVisCert',\n+  // isDonating doesn't need fixing because it's not nullable\n+  'isFoundationalCSharpCertV8',\n+  'isFrontEndCert',\n+  'isFullStackCert',\n+  'isFrontEndLibsCert',\n+  'isHonest',\n+  'isInfosecCertV7',\n+  'isInfosecQaCert',\n+  'isJsAlgoDataStructCert',\n+  'isJsAlgoDataStructCertV8',\n+  'isMachineLearningPyCertV7',\n+  'isQaCertV7',\n+  'isRelationalDatabaseCertV8',\n+  'isRespWebDesignCert',\n+  'isSciCompPyCertV7',\n+  'isDataAnalysisPyCertV7',\n+  // isUpcomingPythonCertV8 exists in the db, but is not returned by the api-server\n+  // TODO(Post-MVP): delete it from the db?\n+  'keyboardShortcuts'\n+] as const;\n+\n+type NullableFlags = (typeof nullableFlags)[number];\n+\n+/**\n+ * Splits a user object into two objects: one with nullable flags and one without.\n+ *\n+ * @param user - The user object to split.\n+ * @returns A tuple where the first element is an object with nullable flags and the second element is an object with the remaining properties.\n+ */\n+export function splitUser<U extends Record<NullableFlags, unknown>>(\n+  user: U\n+): [Pick<U, NullableFlags>, Omit<U, NullableFlags>] {\n+  return [_.pick(user, nullableFlags), _.omit(user, nullableFlags)];\n+}"
        },
        {
            "sha": "9fe1238adcee30564d877a4c0b08fa9c4b617e78",
            "filename": "api/src/routes/protected/certificate.test.ts",
            "status": "renamed",
            "additions": 3,
            "deletions": 264,
            "changes": 267,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,14 +1,13 @@\n import { type PrismaPromise } from '@prisma/client';\n-import { Certification } from '../../../shared/config/certification-settings';\n+import { Certification } from '../../../../shared/config/certification-settings';\n import {\n   defaultUserEmail,\n   defaultUserId,\n   devLogin,\n   setupServer,\n   superRequest\n-} from '../../jest.utils';\n-import { SHOW_UPCOMING_CHANGES } from '../utils/env';\n-import { getFallbackFullStackDate } from './certificate';\n+} from '../../../jest.utils';\n+import { SHOW_UPCOMING_CHANGES } from '../../utils/env';\n \n describe('certificate routes', () => {\n   setupServer();\n@@ -435,264 +434,4 @@ describe('certificate routes', () => {\n       });\n     });\n   });\n-\n-  describe('Unauthenticated user', () => {\n-    describe('GET /certificate/showCert/:username/:certSlug', () => {\n-      beforeEach(async () => {\n-        await fastifyTestInstance.prisma.user.updateMany({\n-          where: { email: defaultUserEmail },\n-          data: {\n-            username: 'foobar',\n-            name: 'foobar',\n-            isHonest: true,\n-            isBanned: false,\n-            isCheater: false,\n-            profileUI: { isLocked: false, showCerts: true, showTimeLine: true }\n-          }\n-        });\n-      });\n-      test('should return user not found if the user cannot be found', async () => {\n-        const response = await superRequest(\n-          '/certificate/showCert/not-a-valid-user-name/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.username-not-found',\n-              variables: { username: 'not-a-valid-user-name' }\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should ask user to add name if there is no name', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: { name: null }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.add-name'\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should return not eligible if user is banned', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: { isBanned: true }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.not-eligible'\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should return not eligible if user is cheater', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: { isCheater: true }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.not-eligible'\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should return not honest if user is not honest', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: { isHonest: false }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.not-honest',\n-              variables: { username: 'foobar' }\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should return profile private if profile is private', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: {\n-            // All properties need to be defined, as this op SETs `profileUI`\n-            profileUI: { isLocked: true, showTimeLine: true, showCerts: true }\n-          }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.profile-private',\n-              variables: { username: 'foobar' }\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should return certs private if certs are private', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: {\n-            profileUI: { showCerts: false, showTimeLine: true, isLocked: false }\n-          }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.certs-private',\n-              variables: { username: 'foobar' }\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-      test('should return timeline private if timeline is private', async () => {\n-        await fastifyTestInstance.prisma.user.update({\n-          where: { id: defaultUserId },\n-          data: {\n-            profileUI: { showTimeLine: false, showCerts: true, isLocked: false }\n-          }\n-        });\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.timeline-private',\n-              variables: { username: 'foobar' }\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(200);\n-      });\n-\n-      test('should return cert-not-found if there is no cert with that slug', async () => {\n-        const response = await superRequest(\n-          '/certificate/showCert/foobar/not-a-valid-cert-slug',\n-          {\n-            method: 'GET'\n-          }\n-        );\n-        expect(response.body).toEqual({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.cert-not-found',\n-              variables: { certSlug: 'not-a-valid-cert-slug' }\n-            }\n-          ]\n-        });\n-        expect(response.status).toBe(404);\n-      });\n-    });\n-  });\n-});\n-\n-const fullStackChallenges = [\n-  {\n-    completedDate: 1585210952511,\n-    id: '5a553ca864b52e1d8bceea14'\n-  },\n-  {\n-    completedDate: 1585210952511,\n-    id: '561add10cb82ac38a17513bc'\n-  },\n-  {\n-    completedDate: 1588665778679,\n-    id: '561acd10cb82ac38a17513bc'\n-  },\n-  {\n-    completedDate: 1685210952511,\n-    id: '561abd10cb81ac38a17513bc'\n-  },\n-  {\n-    completedDate: 1585210952511,\n-    id: '561add10cb82ac38a17523bc'\n-  },\n-  {\n-    completedDate: 1588665778679,\n-    id: '561add10cb82ac38a17213bc'\n-  }\n-];\n-\n-describe('helper functions', () => {\n-  describe('getFallbackFullStackDate', () => {\n-    it('should return the date of the latest completed challenge', () => {\n-      expect(getFallbackFullStackDate(fullStackChallenges, 123)).toBe(\n-        1685210952511\n-      );\n-    });\n-\n-    it('should fall back to completedDate if no certifications are provided', () => {\n-      expect(getFallbackFullStackDate([], 123)).toBe(123);\n-    });\n-\n-    it('should fall back to completedDate if none of the certifications have been completed', () => {\n-      expect(\n-        getFallbackFullStackDate([{ completedDate: 567, id: 'abc' }], 123)\n-      ).toBe(123);\n-    });\n-  });\n });",
            "previous_filename": "api/src/routes/certificate.test.ts"
        },
        {
            "sha": "144dd2464d52cfa479a5b333f9883791c281aaa3",
            "filename": "api/src/routes/protected/certificate.ts",
            "status": "renamed",
            "additions": 203,
            "deletions": 459,
            "changes": 662,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,9 +1,8 @@\n-import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import type { CompletedChallenge } from '@prisma/client';\n import isEmail from 'validator/lib/isEmail';\n-import { find } from 'lodash';\n-import { CompletedChallenge } from '@prisma/client';\n-import * as schemas from '../schemas';\n-import { getChallenges } from '../utils/get-challenges';\n+import type { FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+\n+import { getChallenges } from '../../utils/get-challenges';\n import {\n   certIds,\n   certSlugTypeMap,\n@@ -12,13 +11,14 @@ import {\n   currentCertifications,\n   legacyCertifications,\n   legacyFullStackCertification,\n-  certTypeIdMap,\n-  completionHours,\n-  oldDataVizId,\n   upcomingCertifications\n-} from '../../../shared/config/certification-settings';\n-import { normalizeChallenges, removeNulls } from '../utils/normalize';\n-import { SHOW_UPCOMING_CHANGES } from '../utils/env';\n+} from '../../../../shared/config/certification-settings';\n+\n+import * as schemas from '../../schemas';\n+import { normalizeChallenges, removeNulls } from '../../utils/normalize';\n+\n+import { SHOW_UPCOMING_CHANGES } from '../../utils/env';\n+import { isKnownCertSlug } from '../helpers/certificate-utils';\n \n const {\n   legacyFrontEndChallengeId,\n@@ -43,6 +43,198 @@ const {\n   upcomingPythonV8Id\n } = certIds;\n \n+function isCertAllowed(certSlug: string): boolean {\n+  if (\n+    currentCertifications.includes(certSlug) ||\n+    legacyCertifications.includes(certSlug) ||\n+    legacyFullStackCertification.includes(certSlug)\n+  ) {\n+    return true;\n+  }\n+  if (SHOW_UPCOMING_CHANGES && upcomingCertifications.includes(certSlug)) {\n+    return true;\n+  }\n+  return false;\n+}\n+\n+function renderCertifiedEmail({\n+  username,\n+  name\n+}: {\n+  username: string;\n+  name: string;\n+}) {\n+  const certifiedEmailTemplate = `Hi ${name || username},\n+\n+Congratulations on completing all of the freeCodeCamp certifications!\n+\n+All of your certifications are now live at at: https://www.freecodecamp.org/${username}\n+\n+Please tell me a bit more about you and your near-term goals.\n+\n+Are you interested in contributing to our open source projects used by nonprofits?\n+\n+Also, check out https://contribute.freecodecamp.org/ for some fun and convenient ways you can contribute to the community.\n+\n+Happy coding,\n+\n+- Quincy Larson, teacher at freeCodeCamp\n+`;\n+  return certifiedEmailTemplate;\n+}\n+\n+function hasCompletedTests(\n+  tests: { id: string }[],\n+  completedChallenges: CompletedChallenge[]\n+) {\n+  return tests.every(({ id }) =>\n+    completedChallenges.some(({ id: completedId }) => completedId === id)\n+  );\n+}\n+\n+function assertTestsExist(\n+  tests: ReturnType<typeof getChallenges>[number]['tests']\n+): asserts tests is { id: string }[] {\n+  if (!Array.isArray(tests)) {\n+    throw new Error('Tests is not an array');\n+  }\n+  if (!tests.every(test => typeof test === 'object' && test !== null)) {\n+    throw new Error('Tests contains non-object values');\n+  }\n+  if (!tests.every(test => typeof test.id === 'string')) {\n+    throw new Error('Tests contain non-string ids');\n+  }\n+}\n+\n+function getCertById(\n+  challengeId: string,\n+  challenges: ReturnType<typeof getChallenges>\n+): { id: string; tests: { id: string }[]; challengeType: number } {\n+  const challengeById = challenges.filter(({ id }) => id === challengeId)[0];\n+  if (!challengeById) {\n+    throw new Error(`Challenge with id '${challengeId}' not found`);\n+  }\n+  const { id, tests, challengeType } = challengeById;\n+  assertTestsExist(tests);\n+  return { id, tests, challengeType };\n+}\n+\n+function createCertTypeIds(challenges: ReturnType<typeof getChallenges>) {\n+  return {\n+    // legacy\n+    [certTypes.frontEnd]: getCertById(legacyFrontEndChallengeId, challenges),\n+    [certTypes.jsAlgoDataStruct]: getCertById(jsAlgoDataStructId, challenges),\n+    [certTypes.backEnd]: getCertById(legacyBackEndChallengeId, challenges),\n+    [certTypes.dataVis]: getCertById(legacyDataVisId, challenges),\n+    [certTypes.infosecQa]: getCertById(legacyInfosecQaId, challenges),\n+    [certTypes.fullStack]: getCertById(legacyFullStackId, challenges),\n+\n+    // modern\n+    [certTypes.respWebDesign]: getCertById(respWebDesignId, challenges),\n+    [certTypes.frontEndDevLibs]: getCertById(frontEndDevLibsId, challenges),\n+    [certTypes.dataVis2018]: getCertById(dataVis2018Id, challenges),\n+    [certTypes.jsAlgoDataStructV8]: getCertById(\n+      jsAlgoDataStructV8Id,\n+      challenges\n+    ),\n+    [certTypes.apisMicroservices]: getCertById(apisMicroservicesId, challenges),\n+    [certTypes.qaV7]: getCertById(qaV7Id, challenges),\n+    [certTypes.infosecV7]: getCertById(infosecV7Id, challenges),\n+    [certTypes.sciCompPyV7]: getCertById(sciCompPyV7Id, challenges),\n+    [certTypes.dataAnalysisPyV7]: getCertById(dataAnalysisPyV7Id, challenges),\n+    [certTypes.machineLearningPyV7]: getCertById(\n+      machineLearningPyV7Id,\n+      challenges\n+    ),\n+    [certTypes.relationalDatabaseV8]: getCertById(\n+      relationalDatabaseV8Id,\n+      challenges\n+    ),\n+    [certTypes.collegeAlgebraPyV8]: getCertById(\n+      collegeAlgebraPyV8Id,\n+      challenges\n+    ),\n+    [certTypes.foundationalCSharpV8]: getCertById(\n+      foundationalCSharpV8Id,\n+      challenges\n+    ),\n+\n+    // upcoming\n+    [certTypes.upcomingPythonV8]: getCertById(upcomingPythonV8Id, challenges)\n+  };\n+}\n+\n+interface CertI {\n+  isRespWebDesignCert?: boolean;\n+  isJsAlgoDataStructCert?: boolean;\n+  isJsAlgoDataStructCertV8?: boolean;\n+  isFrontEndLibsCert?: boolean;\n+  is2018DataVisCert?: boolean;\n+  isApisMicroservicesCert?: boolean;\n+  isInfosecQaCert?: boolean;\n+  isQaCertV7?: boolean;\n+  isInfosecCertV7?: boolean;\n+  isFrontEndCert?: boolean;\n+  isBackEndCert?: boolean;\n+  isDataVisCert?: boolean;\n+  isFullStackCert?: boolean;\n+  isSciCompPyCertV7?: boolean;\n+  isDataAnalysisPyCertV7?: boolean;\n+  isMachineLearningPyCertV7?: boolean;\n+  isRelationalDatabaseCertV8?: boolean;\n+  isCollegeAlgebraPyCertV8?: boolean;\n+  isFoundationalCSharpCertV8?: boolean;\n+  isUpcomingPythonCertV8?: boolean;\n+}\n+\n+function getUserIsCertMap(user: CertI) {\n+  const {\n+    isRespWebDesignCert = false,\n+    isJsAlgoDataStructCert = false,\n+    isJsAlgoDataStructCertV8 = false,\n+    isFrontEndLibsCert = false,\n+    is2018DataVisCert = false,\n+    isApisMicroservicesCert = false,\n+    isInfosecQaCert = false,\n+    isQaCertV7 = false,\n+    isInfosecCertV7 = false,\n+    isFrontEndCert = false,\n+    isBackEndCert = false,\n+    isDataVisCert = false,\n+    isFullStackCert = false,\n+    isSciCompPyCertV7 = false,\n+    isDataAnalysisPyCertV7 = false,\n+    isMachineLearningPyCertV7 = false,\n+    isRelationalDatabaseCertV8 = false,\n+    isCollegeAlgebraPyCertV8 = false,\n+    isFoundationalCSharpCertV8 = false,\n+    isUpcomingPythonCertV8 = false\n+  } = user;\n+\n+  return {\n+    isRespWebDesignCert,\n+    isJsAlgoDataStructCert,\n+    isJsAlgoDataStructCertV8,\n+    isFrontEndLibsCert,\n+    is2018DataVisCert,\n+    isApisMicroservicesCert,\n+    isInfosecQaCert,\n+    isQaCertV7,\n+    isInfosecCertV7,\n+    isFrontEndCert,\n+    isBackEndCert,\n+    isDataVisCert,\n+    isFullStackCert,\n+    isSciCompPyCertV7,\n+    isDataAnalysisPyCertV7,\n+    isMachineLearningPyCertV7,\n+    isRelationalDatabaseCertV8,\n+    isCollegeAlgebraPyCertV8,\n+    isFoundationalCSharpCertV8,\n+    isUpcomingPythonCertV8\n+  };\n+}\n+\n /**\n  * Plugin for the protected certificate endpoints.\n  *\n@@ -257,451 +449,3 @@ export const protectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n \n   done();\n };\n-\n-/**\n- * Plugin for the unprotected certificate endpoints.\n- *\n- * @param fastify The Fastify instance.\n- * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n- * @param done The callback to signal that the plugin is ready.\n- */\n-export const unprotectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n-  fastify,\n-  _options,\n-  done\n-) => {\n-  fastify.get(\n-    '/certificate/showCert/:username/:certSlug',\n-    {\n-      schema: schemas.certSlug\n-    },\n-    async (req, reply) => {\n-      const username = req.params.username.toLowerCase();\n-      const certSlug = req.params.certSlug;\n-\n-      fastify.log.info(`certSlug: ${certSlug}`);\n-\n-      if (!isKnownCertSlug(certSlug)) {\n-        void reply.code(404);\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.cert-not-found',\n-              variables: { certSlug }\n-            }\n-          ]\n-        });\n-      }\n-\n-      const certType = certSlugTypeMap[certSlug];\n-      const certId = certTypeIdMap[certType];\n-      const certTitle = certTypeTitleMap[certType];\n-      const completionTime = completionHours[certType] || 300;\n-      const user = await fastify.prisma.user.findFirst({\n-        where: { username },\n-        select: {\n-          isBanned: true,\n-          isCheater: true,\n-          isFrontEndCert: true,\n-          isBackEndCert: true,\n-          isFullStackCert: true,\n-          isRespWebDesignCert: true,\n-          isFrontEndLibsCert: true,\n-          isJsAlgoDataStructCert: true,\n-          isJsAlgoDataStructCertV8: true,\n-          isDataVisCert: true,\n-          is2018DataVisCert: true,\n-          isApisMicroservicesCert: true,\n-          isInfosecQaCert: true,\n-          isQaCertV7: true,\n-          isInfosecCertV7: true,\n-          isSciCompPyCertV7: true,\n-          isDataAnalysisPyCertV7: true,\n-          isMachineLearningPyCertV7: true,\n-          isRelationalDatabaseCertV8: true,\n-          isCollegeAlgebraPyCertV8: true,\n-          isFoundationalCSharpCertV8: true,\n-          isUpcomingPythonCertV8: true,\n-          isHonest: true,\n-          username: true,\n-          name: true,\n-          completedChallenges: true,\n-          profileUI: true\n-        }\n-      });\n-\n-      if (user === null) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.username-not-found',\n-              variables: { username }\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (user.isCheater || user.isBanned) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.not-eligible'\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (!user.isHonest) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.not-honest',\n-              variables: { username }\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (user.profileUI?.isLocked) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.profile-private',\n-              variables: { username }\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (!user.name) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.add-name'\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (!user.profileUI?.showCerts) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.certs-private',\n-              variables: { username }\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (!user.profileUI?.showTimeLine) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.timeline-private',\n-              variables: { username }\n-            }\n-          ]\n-        });\n-      }\n-\n-      if (!user[certType]) {\n-        return reply.send({\n-          messages: [\n-            {\n-              type: 'info',\n-              message: 'flash.user-not-certified',\n-              variables: { username, cert: certTypeTitleMap[certType] }\n-            }\n-          ]\n-        });\n-      }\n-\n-      const { completedChallenges } = user;\n-      const certChallenge = find(\n-        completedChallenges,\n-        ({ id }) => certId === id\n-      );\n-\n-      let { completedDate = Date.now() } = certChallenge || {};\n-\n-      // the challenge id has been rotated for isDataVisCert\n-      if (certType === 'isDataVisCert' && !certChallenge) {\n-        const oldDataVisIdChall = find(\n-          completedChallenges,\n-          ({ id }) => oldDataVizId === id\n-        );\n-\n-        if (oldDataVisIdChall) {\n-          completedDate = oldDataVisIdChall.completedDate || completedDate;\n-        }\n-      }\n-\n-      // if fullcert is not found, return the latest completedDate\n-      if (certType === 'isFullStackCert' && !certChallenge) {\n-        completedDate = getFallbackFullStackDate(\n-          completedChallenges,\n-          completedDate\n-        );\n-      }\n-\n-      const { name } = user;\n-\n-      if (!user.profileUI.showName) {\n-        void reply.code(200);\n-        return reply.send({\n-          certSlug,\n-          certTitle,\n-          username,\n-          date: completedDate,\n-          completionTime\n-        });\n-      }\n-\n-      void reply.code(200);\n-      return reply.send({\n-        certSlug,\n-        certTitle,\n-        username,\n-        name,\n-        date: completedDate,\n-        completionTime\n-      });\n-    }\n-  );\n-\n-  done();\n-};\n-\n-function isCertAllowed(certSlug: string): boolean {\n-  if (\n-    currentCertifications.includes(certSlug) ||\n-    legacyCertifications.includes(certSlug) ||\n-    legacyFullStackCertification.includes(certSlug)\n-  ) {\n-    return true;\n-  }\n-  if (SHOW_UPCOMING_CHANGES && upcomingCertifications.includes(certSlug)) {\n-    return true;\n-  }\n-  return false;\n-}\n-\n-function renderCertifiedEmail({\n-  username,\n-  name\n-}: {\n-  username: string;\n-  name: string;\n-}) {\n-  const certifiedEmailTemplate = `Hi ${name || username},\n-\n-Congratulations on completing all of the freeCodeCamp certifications!\n-\n-All of your certifications are now live at at: https://www.freecodecamp.org/${username}\n-\n-Please tell me a bit more about you and your near-term goals.\n-\n-Are you interested in contributing to our open source projects used by nonprofits?\n-\n-Also, check out https://contribute.freecodecamp.org/ for some fun and convenient ways you can contribute to the community.\n-\n-Happy coding,\n-\n-- Quincy Larson, teacher at freeCodeCamp\n-`;\n-  return certifiedEmailTemplate;\n-}\n-\n-function hasCompletedTests(\n-  tests: { id: string }[],\n-  completedChallenges: CompletedChallenge[]\n-) {\n-  return tests.every(({ id }) =>\n-    completedChallenges.some(({ id: completedId }) => completedId === id)\n-  );\n-}\n-\n-function isKnownCertSlug(\n-  certSlug: string\n-): certSlug is keyof typeof certSlugTypeMap {\n-  return certSlug in certSlugTypeMap;\n-}\n-\n-function createCertTypeIds(challenges: ReturnType<typeof getChallenges>) {\n-  return {\n-    // legacy\n-    [certTypes.frontEnd]: getCertById(legacyFrontEndChallengeId, challenges),\n-    [certTypes.jsAlgoDataStruct]: getCertById(jsAlgoDataStructId, challenges),\n-    [certTypes.backEnd]: getCertById(legacyBackEndChallengeId, challenges),\n-    [certTypes.dataVis]: getCertById(legacyDataVisId, challenges),\n-    [certTypes.infosecQa]: getCertById(legacyInfosecQaId, challenges),\n-    [certTypes.fullStack]: getCertById(legacyFullStackId, challenges),\n-\n-    // modern\n-    [certTypes.respWebDesign]: getCertById(respWebDesignId, challenges),\n-    [certTypes.frontEndDevLibs]: getCertById(frontEndDevLibsId, challenges),\n-    [certTypes.dataVis2018]: getCertById(dataVis2018Id, challenges),\n-    [certTypes.jsAlgoDataStructV8]: getCertById(\n-      jsAlgoDataStructV8Id,\n-      challenges\n-    ),\n-    [certTypes.apisMicroservices]: getCertById(apisMicroservicesId, challenges),\n-    [certTypes.qaV7]: getCertById(qaV7Id, challenges),\n-    [certTypes.infosecV7]: getCertById(infosecV7Id, challenges),\n-    [certTypes.sciCompPyV7]: getCertById(sciCompPyV7Id, challenges),\n-    [certTypes.dataAnalysisPyV7]: getCertById(dataAnalysisPyV7Id, challenges),\n-    [certTypes.machineLearningPyV7]: getCertById(\n-      machineLearningPyV7Id,\n-      challenges\n-    ),\n-    [certTypes.relationalDatabaseV8]: getCertById(\n-      relationalDatabaseV8Id,\n-      challenges\n-    ),\n-    [certTypes.collegeAlgebraPyV8]: getCertById(\n-      collegeAlgebraPyV8Id,\n-      challenges\n-    ),\n-    [certTypes.foundationalCSharpV8]: getCertById(\n-      foundationalCSharpV8Id,\n-      challenges\n-    ),\n-\n-    // upcoming\n-    [certTypes.upcomingPythonV8]: getCertById(upcomingPythonV8Id, challenges)\n-  };\n-}\n-\n-function getCertById(\n-  challengeId: string,\n-  challenges: ReturnType<typeof getChallenges>\n-): { id: string; tests: { id: string }[]; challengeType: number } {\n-  const challengeById = challenges.filter(({ id }) => id === challengeId)[0];\n-  if (!challengeById) {\n-    throw new Error(`Challenge with id '${challengeId}' not found`);\n-  }\n-  const { id, tests, challengeType } = challengeById;\n-  assertTestsExist(tests);\n-  return { id, tests, challengeType };\n-}\n-\n-function assertTestsExist(\n-  tests: ReturnType<typeof getChallenges>[number]['tests']\n-): asserts tests is { id: string }[] {\n-  if (!Array.isArray(tests)) {\n-    throw new Error('Tests is not an array');\n-  }\n-  if (!tests.every(test => typeof test === 'object' && test !== null)) {\n-    throw new Error('Tests contains non-object values');\n-  }\n-  if (!tests.every(test => typeof test.id === 'string')) {\n-    throw new Error('Tests contain non-string ids');\n-  }\n-}\n-\n-interface CertI {\n-  isRespWebDesignCert?: boolean;\n-  isJsAlgoDataStructCert?: boolean;\n-  isJsAlgoDataStructCertV8?: boolean;\n-  isFrontEndLibsCert?: boolean;\n-  is2018DataVisCert?: boolean;\n-  isApisMicroservicesCert?: boolean;\n-  isInfosecQaCert?: boolean;\n-  isQaCertV7?: boolean;\n-  isInfosecCertV7?: boolean;\n-  isFrontEndCert?: boolean;\n-  isBackEndCert?: boolean;\n-  isDataVisCert?: boolean;\n-  isFullStackCert?: boolean;\n-  isSciCompPyCertV7?: boolean;\n-  isDataAnalysisPyCertV7?: boolean;\n-  isMachineLearningPyCertV7?: boolean;\n-  isRelationalDatabaseCertV8?: boolean;\n-  isCollegeAlgebraPyCertV8?: boolean;\n-  isFoundationalCSharpCertV8?: boolean;\n-  isUpcomingPythonCertV8?: boolean;\n-}\n-\n-function getUserIsCertMap(user: CertI) {\n-  const {\n-    isRespWebDesignCert = false,\n-    isJsAlgoDataStructCert = false,\n-    isJsAlgoDataStructCertV8 = false,\n-    isFrontEndLibsCert = false,\n-    is2018DataVisCert = false,\n-    isApisMicroservicesCert = false,\n-    isInfosecQaCert = false,\n-    isQaCertV7 = false,\n-    isInfosecCertV7 = false,\n-    isFrontEndCert = false,\n-    isBackEndCert = false,\n-    isDataVisCert = false,\n-    isFullStackCert = false,\n-    isSciCompPyCertV7 = false,\n-    isDataAnalysisPyCertV7 = false,\n-    isMachineLearningPyCertV7 = false,\n-    isRelationalDatabaseCertV8 = false,\n-    isCollegeAlgebraPyCertV8 = false,\n-    isFoundationalCSharpCertV8 = false,\n-    isUpcomingPythonCertV8 = false\n-  } = user;\n-\n-  return {\n-    isRespWebDesignCert,\n-    isJsAlgoDataStructCert,\n-    isJsAlgoDataStructCertV8,\n-    isFrontEndLibsCert,\n-    is2018DataVisCert,\n-    isApisMicroservicesCert,\n-    isInfosecQaCert,\n-    isQaCertV7,\n-    isInfosecCertV7,\n-    isFrontEndCert,\n-    isBackEndCert,\n-    isDataVisCert,\n-    isFullStackCert,\n-    isSciCompPyCertV7,\n-    isDataAnalysisPyCertV7,\n-    isMachineLearningPyCertV7,\n-    isRelationalDatabaseCertV8,\n-    isCollegeAlgebraPyCertV8,\n-    isFoundationalCSharpCertV8,\n-    isUpcomingPythonCertV8\n-  };\n-}\n-\n-/**\n- * Retrieves the completion date for the full stack certification, if it exists.\n- *\n- * @param completedChallenges - The array of completed challenges.\n- * @param completedDate - The fallback completed date.\n- * @returns The latest certification date or the completed date if no certification is found.\n- */\n-export function getFallbackFullStackDate(\n-  completedChallenges: { id: string; completedDate: number }[],\n-  completedDate: number\n-) {\n-  const chalIds = [\n-    respWebDesignId,\n-    jsAlgoDataStructId,\n-    frontEndDevLibsId,\n-    dataVis2018Id,\n-    apisMicroservicesId,\n-    legacyInfosecQaId\n-  ];\n-\n-  const latestCertDate = completedChallenges\n-    .filter(chal => chalIds.includes(chal.id))\n-    .sort((a, b) => b.completedDate - a.completedDate)[0]?.completedDate;\n-\n-  return latestCertDate ?? completedDate;\n-}",
            "previous_filename": "api/src/routes/certificate.ts"
        },
        {
            "sha": "c9f464a0212f9112d10b9691817be86e49c21edc",
            "filename": "api/src/routes/protected/challenge.test.ts",
            "status": "renamed",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -6,7 +6,7 @@ const mockVerifyTrophyWithMicrosoft = jest.fn();\n import { omit } from 'lodash';\n import { Static } from '@fastify/type-provider-typebox';\n \n-import { challengeTypes } from '../../../shared/config/challenge-types';\n+import { challengeTypes } from '../../../../shared/config/challenge-types';\n import {\n   defaultUserId,\n   devLogin,\n@@ -16,7 +16,7 @@ import {\n   defaultUserEmail,\n   createSuperRequest,\n   defaultUsername\n-} from '../../jest.utils';\n+} from '../../../jest.utils';\n import {\n   completedExamChallengeOneCorrect,\n   completedExamChallengeTwoCorrect,\n@@ -31,14 +31,14 @@ import {\n   examWithTwoCorrect,\n   examWithAllCorrect,\n   type ExamSubmission\n-} from '../../__mocks__/exam';\n-import { Answer } from '../utils/exam-types';\n-import type { getSessionUser } from '../schemas/user/get-session-user';\n+} from '../../../__mocks__/exam';\n+import { Answer } from '../../utils/exam-types';\n+import type { getSessionUser } from '../../schemas/user/get-session-user';\n \n-jest.mock('./helpers/challenge-helpers', () => {\n+jest.mock('../helpers/challenge-helpers', () => {\n   const originalModule = jest.requireActual<\n-    typeof import('./helpers/challenge-helpers')\n-  >('./helpers/challenge-helpers');\n+    typeof import('../helpers/challenge-helpers')\n+  >('../helpers/challenge-helpers');\n \n   return {\n     __esModule: true,",
            "previous_filename": "api/src/routes/challenge.test.ts"
        },
        {
            "sha": "99848b7385cfa650a55ddaba5394f50d5108e998",
            "filename": "api/src/routes/protected/challenge.ts",
            "status": "renamed",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -4,8 +4,8 @@ import { uniqBy } from 'lodash';\n import { CompletedExam, ExamResults } from '@prisma/client';\n import isURL from 'validator/lib/isURL';\n \n-import { challengeTypes } from '../../../shared/config/challenge-types';\n-import * as schemas from '../schemas';\n+import { challengeTypes } from '../../../../shared/config/challenge-types';\n+import * as schemas from '../../schemas';\n import {\n   jsCertProjectIds,\n   multifileCertProjectIds,\n@@ -14,25 +14,25 @@ import {\n   type CompletedChallenge,\n   saveUserChallengeData,\n   msTrophyChallenges\n-} from '../utils/common-challenge-functions';\n-import { JWT_SECRET } from '../utils/env';\n+} from '../../utils/common-challenge-functions';\n+import { JWT_SECRET } from '../../utils/env';\n import {\n   formatCoderoadChallengeCompletedValidation,\n   formatProjectCompletedValidation\n-} from '../utils/error-formatting';\n-import { getChallenges } from '../utils/get-challenges';\n-import { ProgressTimestamp, getPoints } from '../utils/progress';\n+} from '../../utils/error-formatting';\n+import { getChallenges } from '../../utils/get-challenges';\n+import { ProgressTimestamp, getPoints } from '../../utils/progress';\n import {\n   validateExamFromDbSchema,\n   validateGeneratedExamSchema,\n   validateUserCompletedExamSchema,\n   validateExamResultsSchema\n-} from '../utils/exam-schemas';\n-import { generateRandomExam, createExamResults } from '../utils/exam';\n+} from '../../utils/exam-schemas';\n+import { generateRandomExam, createExamResults } from '../../utils/exam';\n import {\n   canSubmitCodeRoadCertProject,\n   verifyTrophyWithMicrosoft\n-} from './helpers/challenge-helpers';\n+} from '../helpers/challenge-helpers';\n \n interface JwtPayload {\n   userToken: string;",
            "previous_filename": "api/src/routes/challenge.ts"
        },
        {
            "sha": "7dafd19c30c77c15c31ff2fc3b7b48a6a0a4cf8e",
            "filename": "api/src/routes/protected/donate.test.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 48,
            "changes": 50,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -3,11 +3,10 @@ import {\n   createSuperRequest,\n   devLogin,\n   setupServer,\n-  superRequest,\n   defaultUserEmail,\n   defaultUserId\n-} from '../../jest.utils';\n-import { createUserInput } from '../utils/create-user';\n+} from '../../../jest.utils';\n+import { createUserInput } from '../../utils/create-user';\n \n const testEWalletEmail = 'baz@bar.com';\n const testSubscriptionId = 'sub_test_id';\n@@ -490,49 +489,4 @@ describe('Donate', () => {\n       });\n     });\n   });\n-\n-  describe('Unauthenticated User', () => {\n-    // Get the CSRF cookies from an unprotected route\n-    beforeAll(async () => {\n-      const res = await superRequest('/status/ping', { method: 'GET' });\n-      setCookies = res.get('Set-Cookie');\n-    });\n-\n-    const endpoints: { path: string; method: 'POST' | 'PUT' }[] = [\n-      { path: '/donate/add-donation', method: 'POST' },\n-      { path: '/donate/charge-stripe-card', method: 'POST' },\n-      { path: '/donate/update-stripe-card', method: 'PUT' }\n-    ];\n-\n-    endpoints.forEach(({ path, method }) => {\n-      test(`${method} ${path} returns 401 status code with error message`, async () => {\n-        const response = await superRequest(path, {\n-          method,\n-          setCookies\n-        });\n-        expect(response.statusCode).toBe(401);\n-      });\n-    });\n-\n-    test('POST /donate/create-stripe-payment-intent should return 200', async () => {\n-      mockSubCreate.mockImplementationOnce(generateMockSubCreate('no-errors'));\n-      const response = await superRequest(\n-        '/donate/create-stripe-payment-intent',\n-        {\n-          method: 'POST',\n-          setCookies\n-        }\n-      ).send(createStripePaymentIntentReqBody);\n-      expect(response.status).toBe(200);\n-    });\n-\n-    test('POST /donate/charge-stripe should return 200', async () => {\n-      mockSubCreate.mockImplementationOnce(generateMockSubCreate('no-errors'));\n-      const response = await superRequest('/donate/charge-stripe', {\n-        method: 'POST',\n-        setCookies\n-      }).send(chargeStripeReqBody);\n-      expect(response.status).toBe(200);\n-    });\n-  });\n });",
            "previous_filename": "api/src/routes/donate.test.ts"
        },
        {
            "sha": "0003124d380d9d3339ffa228af2ac97bbc1b8339",
            "filename": "api/src/routes/protected/donate.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 164,
            "changes": 168,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,13 +1,9 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n import Stripe from 'stripe';\n-import {\n-  donationSubscriptionConfig,\n-  allStripeProductIdsArray\n-} from '../../../shared/config/donation-settings';\n-import * as schemas from '../schemas';\n-import { STRIPE_SECRET_KEY, HOME_LOCATION } from '../utils/env';\n-import { inLastFiveMinutes } from '../utils/validate-donation';\n-import { findOrCreateUser } from './helpers/auth-helpers';\n+\n+import * as schemas from '../../schemas';\n+import { donationSubscriptionConfig } from '../../../../shared/config/donation-settings';\n+import { STRIPE_SECRET_KEY, HOME_LOCATION } from '../../utils/env';\n \n /**\n  * Plugin for the donation endpoints requiring auth.\n@@ -225,159 +221,3 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n \n   done();\n };\n-\n-/**\n- * Plugin for public donation endpoints.\n- *\n- * @param fastify The Fastify instance.\n- * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n- * @param done The callback to signal that the plugin is ready.\n- */\n-export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n-  fastify,\n-  _options,\n-  done\n-) => {\n-  // Stripe plugin\n-  const stripe = new Stripe(STRIPE_SECRET_KEY, {\n-    apiVersion: '2024-06-20',\n-    typescript: true\n-  });\n-\n-  fastify.post(\n-    '/donate/create-stripe-payment-intent',\n-    {\n-      schema: schemas.createStripePaymentIntent\n-    },\n-    async (req, reply) => {\n-      const { email, name, amount, duration } = req.body;\n-\n-      if (!donationSubscriptionConfig.plans[duration].includes(amount)) {\n-        void reply.code(400);\n-        return {\n-          error: 'The donation form had invalid values for this submission.'\n-        } as const;\n-      }\n-\n-      try {\n-        const stripeCustomer = await stripe.customers.create({\n-          email,\n-          name\n-        });\n-\n-        const stripeSubscription = await stripe.subscriptions.create({\n-          customer: stripeCustomer.id,\n-          items: [\n-            {\n-              plan: `${donationSubscriptionConfig.duration[duration]}-donation-${amount}`\n-            }\n-          ],\n-          payment_behavior: 'default_incomplete',\n-          payment_settings: { save_default_payment_method: 'on_subscription' },\n-          expand: ['latest_invoice.payment_intent']\n-        });\n-\n-        if (\n-          stripeSubscription.latest_invoice &&\n-          typeof stripeSubscription.latest_invoice !== 'string' &&\n-          stripeSubscription.latest_invoice.payment_intent &&\n-          typeof stripeSubscription.latest_invoice.payment_intent !==\n-            'string' &&\n-          stripeSubscription.latest_invoice.payment_intent.client_secret !==\n-            null\n-        ) {\n-          const clientSecret =\n-            stripeSubscription.latest_invoice.payment_intent.client_secret;\n-          return reply.send({\n-            subscriptionId: stripeSubscription.id,\n-            clientSecret\n-          });\n-        } else {\n-          throw new Error('Stripe payment intent client secret is missing');\n-        }\n-      } catch (error) {\n-        fastify.log.error(error);\n-        fastify.Sentry.captureException(error);\n-        void reply.code(500);\n-        return reply.send({\n-          error: 'Donation failed due to a server error.'\n-        });\n-      }\n-    }\n-  );\n-\n-  fastify.post(\n-    '/donate/charge-stripe',\n-    {\n-      schema: schemas.chargeStripe\n-    },\n-    async (req, reply) => {\n-      try {\n-        const { email, amount, duration, subscriptionId } = req.body;\n-\n-        const subscription =\n-          await stripe.subscriptions.retrieve(subscriptionId);\n-        const isSubscriptionActive = subscription.status === 'active';\n-        const productId = subscription.items.data[0]?.plan.product?.toString();\n-        const isStartedRecently = inLastFiveMinutes(\n-          subscription.current_period_start\n-        );\n-        const isProductIdValid =\n-          productId && allStripeProductIdsArray.includes(productId);\n-        const isValidCustomer = typeof subscription.customer === 'string';\n-\n-        if (!isSubscriptionActive)\n-          throw new Error(\n-            `Stripe subscription information is invalid: ${subscriptionId}`\n-          );\n-        if (!isProductIdValid)\n-          throw new Error(`Product ID is invalid: ${subscriptionId}`);\n-        if (!isStartedRecently)\n-          throw new Error(`Subscription is not recent: ${subscriptionId}`);\n-        if (!isValidCustomer)\n-          throw new Error(`Customer ID is invalid: ${subscriptionId}`);\n-        else {\n-          // TODO(Post-MVP) new users should not be created if user is not found\n-          const user = await findOrCreateUser(fastify, email);\n-          const donation = {\n-            userId: user.id,\n-            email,\n-            amount,\n-            duration,\n-            provider: 'stripe',\n-            subscriptionId,\n-            customerId: subscription.customer as string,\n-            // TODO(Post-MVP) migrate to startDate: new Date()\n-            startDate: {\n-              date: new Date().toISOString(),\n-              when: new Date().toISOString().replace(/.$/, '+00:00')\n-            }\n-          };\n-\n-          await fastify.prisma.donation.create({\n-            data: donation\n-          });\n-\n-          await fastify.prisma.user.update({\n-            where: { id: user.id },\n-            data: {\n-              isDonating: true\n-            }\n-          });\n-          return reply.send({\n-            isDonating: true\n-          });\n-        }\n-      } catch (error) {\n-        fastify.log.error(error);\n-        fastify.Sentry.captureException(error);\n-        void reply.code(500);\n-        return {\n-          error: 'Donation failed due to a server error.'\n-        } as const;\n-      }\n-    }\n-  );\n-\n-  done();\n-};",
            "previous_filename": "api/src/routes/donate.ts"
        },
        {
            "sha": "a09f3664d7ec14f860c726cccfa8752bab51ac02",
            "filename": "api/src/routes/protected/index.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Findex.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,5 @@\n+export * from './certificate';\n+export * from './challenge';\n+export * from './donate';\n+export * from './settings';\n+export * from './user';"
        },
        {
            "sha": "34952be9623dc0cd2174620d540dc110d279f55b",
            "filename": "api/src/routes/protected/settings.test.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -7,10 +7,10 @@ import {\n   createSuperRequest,\n   defaultUserId,\n   defaultUserEmail\n-} from '../../jest.utils';\n-import { formatMessage } from '../plugins/redirect-with-message';\n-import { createUserInput } from '../utils/create-user';\n-import { API_LOCATION, HOME_LOCATION } from '../utils/env';\n+} from '../../../jest.utils';\n+import { formatMessage } from '../../plugins/redirect-with-message';\n+import { createUserInput } from '../../utils/create-user';\n+import { API_LOCATION, HOME_LOCATION } from '../../utils/env';\n import {\n   isPictureWithProtocol,\n   getWaitMessage,",
            "previous_filename": "api/src/routes/settings.test.ts"
        },
        {
            "sha": "b62ae3dbf4b9222fd201c0fe3bc78b107c5da8ce",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "renamed",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -17,12 +17,12 @@ import { ResolveFastifyReplyType } from 'fastify/types/type-provider';\n import { differenceInMinutes } from 'date-fns';\n import validator from 'validator';\n \n-import { isValidUsername } from '../../../shared/utils/validate';\n-import * as schemas from '../schemas';\n-import { createAuthToken, isExpired } from '../utils/tokens';\n-import { API_LOCATION } from '../utils/env';\n-import { getRedirectParams } from '../utils/redirection';\n-import { isRestricted } from './helpers/is-restricted';\n+import { isValidUsername } from '../../../../shared/utils/validate';\n+import * as schemas from '../../schemas';\n+import { createAuthToken, isExpired } from '../../utils/tokens';\n+import { API_LOCATION } from '../../utils/env';\n+import { getRedirectParams } from '../../utils/redirection';\n+import { isRestricted } from '../helpers/is-restricted';\n \n const { isEmail } = validator;\n ",
            "previous_filename": "api/src/routes/settings.ts"
        },
        {
            "sha": "546d936de58476d490f6a042c2c8308ef4053dd0",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 370,
            "changes": 374,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -6,17 +6,17 @@ import type { Prisma } from '@prisma/client';\n import { ObjectId } from 'mongodb';\n import _ from 'lodash';\n \n-import { createUserInput } from '../utils/create-user';\n+import { createUserInput } from '../../utils/create-user';\n import {\n   defaultUserId,\n   defaultUserEmail,\n   devLogin,\n   setupServer,\n   superRequest,\n   createSuperRequest\n-} from '../../jest.utils';\n-import { JWT_SECRET } from '../utils/env';\n-import { getMsTranscriptApiUrl, replacePrivateData } from './user';\n+} from '../../../jest.utils';\n+import { JWT_SECRET } from '../../utils/env';\n+import { getMsTranscriptApiUrl } from './user';\n \n const mockedFetch = jest.fn();\n jest.spyOn(globalThis, 'fetch').mockImplementation(mockedFetch);\n@@ -1162,228 +1162,6 @@ Thanks and regards,\n       });\n     });\n   });\n-\n-  describe('Public', () => {\n-    let superGet: ReturnType<typeof createSuperRequest>;\n-\n-    beforeEach(() => {\n-      superGet = createSuperRequest({ method: 'GET' });\n-    });\n-\n-    describe('/api/users/get-public-profile', () => {\n-      const profilelessUsername = 'profileless-user';\n-      const lockedUsername = 'locked-user';\n-      const publicUsername = 'public-user';\n-      const lockedUserProfileUI = {\n-        isLocked: true,\n-        showAbout: true,\n-        showPortfolio: false\n-      };\n-      const unlockedUserProfileUI = {\n-        isLocked: false,\n-        showAbout: true,\n-        showCerts: true,\n-        showDonation: true,\n-        showHeatMap: true,\n-        showLocation: true,\n-        showName: true,\n-        showPoints: true,\n-        showPortfolio: true,\n-        showTimeLine: true\n-      };\n-      const users = [profilelessUsername, lockedUsername, publicUsername];\n-      beforeAll(async () => {\n-        await fastifyTestInstance.prisma.user.create({\n-          data: {\n-            ...minimalUserData,\n-            email: profilelessUsername,\n-            username: profilelessUsername\n-          }\n-        });\n-        await fastifyTestInstance.prisma.user.create({\n-          data: {\n-            ...minimalUserData,\n-            email: lockedUsername,\n-            username: lockedUsername,\n-            profileUI: lockedUserProfileUI\n-          }\n-        });\n-        await fastifyTestInstance.prisma.user.create({\n-          data: {\n-            ...testUserData,\n-            email: publicUsername,\n-            username: publicUsername,\n-            profileUI: unlockedUserProfileUI\n-          }\n-        });\n-      });\n-\n-      afterAll(async () => {\n-        await fastifyTestInstance.prisma.user.deleteMany({\n-          where: {\n-            OR: users.map(username => ({ username }))\n-          }\n-        });\n-      });\n-\n-      describe('GET', () => {\n-        test('returns 400 status code if the user agent is blocked', async () => {\n-          const response = await superGet(\n-            '/api/users/get-public-profile?username=public-user'\n-          ).set('User-Agent', 'curl');\n-\n-          expect(response.text).toBe(\n-            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n-          );\n-          expect(response.statusCode).toBe(400);\n-        });\n-\n-        test('returns 400 status code if the username param is missing', async () => {\n-          const res = await superGet('/api/users/get-public-profile');\n-          // TODO(Post-MVP): return something more informative\n-          expect(res.body).toStrictEqual({});\n-          expect(res.statusCode).toBe(400);\n-        });\n-\n-        test('returns 400 status code if the username param is empty', async () => {\n-          const res = await superGet('/api/users/get-public-profile?username=');\n-          // TODO(Post-MVP): return something more informative\n-          expect(res.body).toStrictEqual({});\n-          expect(res.statusCode).toBe(400);\n-        });\n-\n-        test('returns 404 status code for non-existent user', async () => {\n-          const response = await superGet(\n-            '/api/users/get-public-profile?username=non-existent'\n-          );\n-          // TODO(Post-MVP): return something more informative\n-          expect(response.body).toStrictEqual({});\n-          expect(response.statusCode).toBe(404);\n-        });\n-\n-        test('returns 200 status code with a locked profile if the profile is private', async () => {\n-          const response = await superGet(\n-            `/api/users/get-public-profile?username=${lockedUsername}`\n-          );\n-\n-          expect(response.body).toStrictEqual({\n-            entities: {\n-              user: {\n-                [lockedUsername]: {\n-                  isLocked: true,\n-                  profileUI: lockedUserProfileUI,\n-                  username: lockedUsername\n-                }\n-              }\n-            },\n-            result: lockedUsername\n-          });\n-          expect(response.statusCode).toBe(200);\n-        });\n-\n-        test('returns 200 status code locked profile if the profile is missing', async () => {\n-          const response = await superGet(\n-            `/api/users/get-public-profile?username=${profilelessUsername}`\n-          );\n-\n-          expect(response.body).toStrictEqual({\n-            entities: {\n-              user: {\n-                [profilelessUsername]: {\n-                  isLocked: true,\n-                  profileUI: lockedProfileUI,\n-                  username: profilelessUsername\n-                }\n-              }\n-            },\n-            result: profilelessUsername\n-          });\n-          expect(response.statusCode).toBe(200);\n-        });\n-        // TODO: create a list of public properties like the api-server and use that\n-        // to restrict the output of this and get-session-user.\n-        test('returns 200 status code with public user object', async () => {\n-          const testUser =\n-            await fastifyTestInstance.prisma.user.findFirstOrThrow({\n-              where: { email: publicUsername }\n-            });\n-          const response = await superGet(\n-            `/api/users/get-public-profile?username=${publicUsername}`\n-          );\n-\n-          // TODO: create a fixture for this without 'completedSurveys', ideally\n-          // it should contain the entire body.\n-          const publicUser = {\n-            // TODO(Post-MVP, maybe): return completedSurveys?\n-            ..._.omit(publicUserData, 'completedSurveys'),\n-            username: publicUsername,\n-            joinDate: new ObjectId(testUser.id).getTimestamp().toISOString(),\n-            profileUI: unlockedUserProfileUI\n-          };\n-\n-          expect(response.body).toStrictEqual({\n-            entities: {\n-              user: {\n-                [publicUsername]: publicUser\n-              }\n-            },\n-            result: publicUsername\n-          });\n-          expect(response.statusCode).toBe(200);\n-        });\n-      });\n-    });\n-    describe('GET /api/users/exists', () => {\n-      beforeAll(async () => {\n-        await fastifyTestInstance.prisma.user.create({\n-          data: minimalUserData\n-        });\n-      });\n-\n-      it('should return { exists: true } with a 400 status code if the username param is missing or empty', async () => {\n-        const res = await superGet('/api/users/exists');\n-\n-        expect(res.body).toStrictEqual({ exists: true });\n-        expect(res.statusCode).toBe(400);\n-\n-        const res2 = await superGet('/api/users/exists?username=');\n-\n-        expect(res2.body).toStrictEqual({ exists: true });\n-        expect(res2.statusCode).toBe(400);\n-      });\n-\n-      it('should return { exists: true } if the username exists', async () => {\n-        const res = await superGet('/api/users/exists?username=testuser');\n-\n-        expect(res.body).toStrictEqual({ exists: true });\n-        expect(res.statusCode).toBe(200);\n-      });\n-\n-      it('should ignore case when checking for username existence', async () => {\n-        const res = await superGet('/api/users/exists?username=TeStUsEr');\n-\n-        expect(res.body).toStrictEqual({ exists: true });\n-        expect(res.statusCode).toBe(200);\n-      });\n-\n-      it('should return { exists: false } if the username does not exist', async () => {\n-        const res = await superGet('/api/users/exists?username=nonexistent');\n-\n-        expect(res.body).toStrictEqual({ exists: false });\n-        expect(res.statusCode).toBe(200);\n-      });\n-\n-      it('should return { exists: true } if the username is restricted (ignoring case)', async () => {\n-        const res = await superGet('/api/users/exists?username=pRofIle');\n-\n-        expect(res.body).toStrictEqual({ exists: true });\n-\n-        const res2 = await superGet('/api/users/exists?username=flAnge');\n-\n-        expect(res2.body).toStrictEqual({ exists: true });\n-      });\n-    });\n-  });\n });\n \n describe('Microsoft helpers', () => {\n@@ -1413,147 +1191,3 @@ describe('Microsoft helpers', () => {\n     });\n   });\n });\n-\n-describe('get-public-profile helpers', () => {\n-  describe('replacePrivateData', () => {\n-    const user = {\n-      about: 'about',\n-      calendar: { 1: 1, 2: 1 } as const,\n-      completedChallenges: [\n-        { id: '123', completedDate: 123, files: [] },\n-        { id: '456', completedDate: 456, challengeType: 7, files: [] }\n-      ],\n-      id: '5f5b1b3b1c9d440000d9e3b4',\n-      isDonating: false,\n-      location: 'location',\n-      joinDate: 'joinDate',\n-      name: 'name',\n-      points: 2,\n-      portfolio: [\n-        {\n-          id: '789',\n-          title: 'portfolio',\n-          url: 'url',\n-          image: 'image',\n-          description: 'description'\n-        }\n-      ],\n-      profileUI: {\n-        isLocked: false,\n-        showAbout: true,\n-        showCerts: true,\n-        showDonation: true,\n-        showHeatMap: true,\n-        showLocation: true,\n-        showName: true,\n-        showPoints: true,\n-        showPortfolio: true,\n-        showTimeLine: true\n-      }\n-    };\n-\n-    test(`returns \"\" for 'about' if showAbout is not true`, () => {\n-      const userWithoutAbout = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showAbout: false }\n-      };\n-      expect(replacePrivateData(userWithoutAbout)).toMatchObject({\n-        about: ''\n-      });\n-    });\n-\n-    test('returns {} for calendar if showHeatMap is not true', () => {\n-      const userWithoutHeatMap = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showHeatMap: false }\n-      };\n-      expect(replacePrivateData(userWithoutHeatMap).calendar).toEqual({});\n-    });\n-\n-    test(`returns [] for completeChallenges if showTimeLine is not true`, () => {\n-      const userWithoutTimeLine = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showTimeLine: false }\n-      };\n-      expect(replacePrivateData(userWithoutTimeLine)).toMatchObject({\n-        completedChallenges: []\n-      });\n-    });\n-\n-    test('omits certifications from completedChallenges if showCerts is not true', () => {\n-      const userWithoutCerts = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showCerts: false }\n-      };\n-      expect(replacePrivateData(userWithoutCerts)).toMatchObject({\n-        completedChallenges: [{ id: '123', completedDate: 123, files: [] }]\n-      });\n-    });\n-\n-    test('returns null for isDonating if showDonation is not true', () => {\n-      const userWithoutDonation = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showDonation: false }\n-      };\n-      expect(replacePrivateData(userWithoutDonation)).toMatchObject({\n-        isDonating: null\n-      });\n-    });\n-\n-    test('returns \"\" for joinDate if showAbout is not true', () => {\n-      const userWithoutAbout = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showAbout: false }\n-      };\n-      expect(replacePrivateData(userWithoutAbout)).toMatchObject({\n-        joinDate: ''\n-      });\n-    });\n-\n-    test(`returns \"\" for 'location' if showLocation is not true`, () => {\n-      const userWithoutLocation = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showLocation: false }\n-      };\n-      expect(replacePrivateData(userWithoutLocation)).toMatchObject({\n-        location: ''\n-      });\n-    });\n-\n-    test(`returns \"\" for 'name' if showName is not true`, () => {\n-      const userWithoutName = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showName: false }\n-      };\n-      expect(replacePrivateData(userWithoutName)).toMatchObject({\n-        name: ''\n-      });\n-    });\n-\n-    test('returns null for points if showPoints is not true', () => {\n-      const userWithoutPoints = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showPoints: false }\n-      };\n-      expect(replacePrivateData(userWithoutPoints)).toMatchObject({\n-        points: null\n-      });\n-    });\n-\n-    test('returns [] for portfolio if showPortfolio is not true', () => {\n-      const userWithoutPortfolio = {\n-        ...user,\n-        profileUI: { ...user.profileUI, showPortfolio: false }\n-      };\n-      expect(replacePrivateData(userWithoutPortfolio)).toMatchObject({\n-        portfolio: []\n-      });\n-    });\n-\n-    test('returns the expected public user object if all showX flags are true', () => {\n-      expect(replacePrivateData(user)).toEqual(\n-        _.omit(user, ['id', 'profileUI'])\n-      );\n-    });\n-  });\n-});",
            "previous_filename": "api/src/routes/user.test.ts"
        },
        {
            "sha": "2e8d294b71606e9fe8923962746c340b0c7aa4da",
            "filename": "api/src/routes/protected/user.ts",
            "status": "renamed",
            "additions": 14,
            "deletions": 277,
            "changes": 291,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,71 +1,26 @@\n-import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n-import { Portfolio } from '@prisma/client';\n+import type { FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n import { ObjectId } from 'mongodb';\n-import _ from 'lodash';\n \n-import * as schemas from '../schemas';\n-// Loopback creates a 64 character string for the user id, this customizes\n-// nanoid to do the same.  Any unique key _should_ be fine, though.\n-import { customNanoid } from '../utils/ids';\n+import * as schemas from '../../schemas';\n+import { createResetProperties } from '../../utils/create-user';\n+import { customNanoid } from '../../utils/ids';\n+import { encodeUserToken } from '../../utils/tokens';\n+import { trimTags } from '../../utils/validation';\n+import { generateReportEmail } from '../../utils/email-templates';\n+import { splitUser } from '../helpers/user-utils';\n import {\n   normalizeChallenges,\n   normalizeFlags,\n   normalizeProfileUI,\n-  normalizeTwitter,\n-  removeNulls,\n   normalizeSurveys,\n-  NormalizedChallenge\n-} from '../utils/normalize';\n+  normalizeTwitter,\n+  removeNulls\n+} from '../../utils/normalize';\n import {\n-  Calendar,\n   getCalendar,\n   getPoints,\n-  type ProgressTimestamp\n-} from '../utils/progress';\n-import { encodeUserToken } from '../utils/tokens';\n-import { trimTags } from '../utils/validation';\n-import { generateReportEmail } from '../utils/email-templates';\n-import { createResetProperties } from '../utils/create-user';\n-import { challengeTypes } from '../../../shared/config/challenge-types';\n-import { isRestricted } from './helpers/is-restricted';\n-\n-// user flags that the api-server returns as false if they're missing in the\n-// user document. Since Prisma returns null for missing fields, we need to\n-// normalize them to false.\n-// TODO(Post-MVP): remove this when the database is normalized.\n-const nullableFlags = [\n-  'is2018DataVisCert',\n-  'is2018FullStackCert',\n-  'isApisMicroservicesCert',\n-  'isBackEndCert',\n-  'isCheater',\n-  'isCollegeAlgebraPyCertV8',\n-  'isDataAnalysisPyCertV7',\n-  'isDataVisCert',\n-  // isDonating doesn't need fixing because it's not nullable\n-  'isFoundationalCSharpCertV8',\n-  'isFrontEndCert',\n-  'isFullStackCert',\n-  'isFrontEndLibsCert',\n-  'isHonest',\n-  'isInfosecCertV7',\n-  'isInfosecQaCert',\n-  'isJsAlgoDataStructCert',\n-  'isJsAlgoDataStructCertV8',\n-  'isMachineLearningPyCertV7',\n-  'isQaCertV7',\n-  'isRelationalDatabaseCertV8',\n-  'isRespWebDesignCert',\n-  'isSciCompPyCertV7',\n-  'isDataAnalysisPyCertV7',\n-  // isUpcomingPythonCertV8 exists in the db, but is not returned by the api-server\n-  // TODO(Post-MVP): delete it from the db?\n-  'keyboardShortcuts'\n-] as const;\n-\n-const blockedUserAgentParts = ['python', 'google-apps-script', 'curl'];\n-\n-type NullableFlag = (typeof nullableFlags)[number];\n+  ProgressTimestamp\n+} from '../../utils/progress';\n \n /**\n  * Helper function to get the api url from the shared transcript link.\n@@ -510,8 +465,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n           ? encodeUserToken(userToken.id)\n           : undefined;\n \n-        const flags = _.pick<typeof user, NullableFlag>(user, nullableFlags);\n-        const rest = _.omit<typeof user, NullableFlag>(user, nullableFlags);\n+        const [flags, rest] = splitUser(user);\n \n         const {\n           username,\n@@ -570,220 +524,3 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n \n   done();\n };\n-\n-type ProfileUI = Partial<{\n-  isLocked: boolean;\n-  showAbout: boolean;\n-  showCerts: boolean;\n-  showDonation: boolean;\n-  showHeatMap: boolean;\n-  showLocation: boolean;\n-  showName: boolean;\n-  showPoints: boolean;\n-  showPortfolio: boolean;\n-  showTimeLine: boolean;\n-}>;\n-\n-type RawUser = {\n-  about: string;\n-  completedChallenges: NormalizedChallenge[];\n-  calendar: Calendar;\n-  id: string;\n-  isDonating: boolean;\n-  joinDate: string;\n-  location: string;\n-  name: string;\n-  points: number;\n-  portfolio: Portfolio[];\n-  profileUI: ProfileUI;\n-};\n-\n-/**\n- * Creates an object with the properties that are shared with the public.\n- * @param user The raw user object.\n- * @returns The shared user object.\n- */\n-export const replacePrivateData = (user: RawUser) => {\n-  const {\n-    showAbout,\n-    showHeatMap,\n-    showCerts,\n-    showDonation,\n-    showLocation,\n-    showName,\n-    showPoints,\n-    showPortfolio,\n-    showTimeLine\n-  } = user.profileUI;\n-\n-  return {\n-    about: showAbout ? user.about : '',\n-    calendar: showHeatMap ? user.calendar : {},\n-    completedChallenges: showTimeLine\n-      ? showCerts\n-        ? user.completedChallenges\n-        : user.completedChallenges.filter(\n-            c => c.challengeType !== challengeTypes.step\n-          )\n-      : [],\n-    isDonating: showDonation ? user.isDonating : null,\n-    joinDate: showAbout ? user.joinDate : '',\n-    location: showLocation ? user.location : '',\n-    name: showName ? user.name : '',\n-    points: showPoints ? user.points : null,\n-    portfolio: showPortfolio ? user.portfolio : []\n-  };\n-};\n-\n-/**\n- * Plugin containing public GET routes for user account management. They are kept\n- * separate because they do not require CSRF protection or authorization.\n- *\n- * @param fastify The Fastify instance.\n- * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n- * @param done Callback to signal that the logic has completed.\n- */\n-export const userPublicGetRoutes: FastifyPluginCallbackTypebox = (\n-  fastify,\n-  _options,\n-  done\n-) => {\n-  fastify.get(\n-    '/api/users/get-public-profile',\n-    {\n-      schema: schemas.getPublicProfile,\n-      onRequest: (req, reply, done) => {\n-        const userAgent = req.headers['user-agent'];\n-\n-        if (\n-          userAgent &&\n-          blockedUserAgentParts.some(ua => userAgent.toLowerCase().includes(ua))\n-        ) {\n-          void reply.code(400);\n-          void reply.send(\n-            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n-          );\n-        }\n-        done();\n-      }\n-    },\n-    async (req, reply) => {\n-      // TODO(Post-MVP): look for duplicates unless we can make username unique in the db.\n-      const user = await fastify.prisma.user.findFirst({\n-        where: { username: req.query.username }\n-        // TODO: only select desired fields, then stop 'omit'ing the undesired\n-        // ones.\n-      });\n-\n-      if (!user) {\n-        void reply.code(404);\n-        return reply.send({});\n-      }\n-\n-      const flags = _.pick<typeof user, NullableFlag>(user, nullableFlags);\n-      const rest = _.omit<typeof user, NullableFlag>(user, nullableFlags);\n-\n-      const publicUser = _.omit(rest, [\n-        'currentChallengeId',\n-        'email',\n-        'emailVerified',\n-        'sendQuincyEmail',\n-        'theme',\n-        // keyboardShortcuts is included in flags.\n-        // 'keyboardShortcuts',\n-        'acceptedPrivacyTerms',\n-        'progressTimestamps',\n-        'unsubscribeId',\n-        'donationEmails',\n-        'externalId',\n-        'usernameDisplay',\n-        'isBanned'\n-      ]);\n-\n-      const normalizedProfileUI = normalizeProfileUI(user.profileUI);\n-\n-      void reply.code(200);\n-      if (normalizedProfileUI.isLocked) {\n-        // TODO(Post-MVP): just return isLocked: true and either a null user\n-        // or no user at all. (see other TODO in the else branch below)\n-        return reply.send({\n-          entities: {\n-            user: {\n-              [user.username]: {\n-                isLocked: true,\n-                profileUI: normalizedProfileUI,\n-                username: user.username\n-              }\n-            }\n-          },\n-          result: user.username\n-        });\n-      } else {\n-        const progressTimestamps = user.progressTimestamps as\n-          | ProgressTimestamp[]\n-          | null;\n-        const sharedUser = replacePrivateData({\n-          ...user,\n-          calendar: getCalendar(progressTimestamps),\n-          completedChallenges: normalizeChallenges(user.completedChallenges),\n-          location: user.location ?? '',\n-          joinDate: new ObjectId(user.id).getTimestamp().toISOString(),\n-          name: user.name ?? '',\n-          points: getPoints(progressTimestamps),\n-          profileUI: normalizedProfileUI\n-        });\n-\n-        const returnedUser = {\n-          ...removeNulls(publicUser),\n-          ...normalizeFlags(flags),\n-          ...sharedUser,\n-          profileUI: normalizedProfileUI,\n-          // TODO: should this always be returned? Shouldn't some privacy\n-          // setting control it? Same applies to website, githubProfile,\n-          // and linkedin.\n-          twitter: normalizeTwitter(user.twitter),\n-          yearsTopContributor: user.yearsTopContributor\n-        };\n-        return reply.send({\n-          // TODO(Post-MVP): just return a user object (i.e. returnedUser) and\n-          // isLocked: false. The there should be no need for Type.Union in the\n-          // schema. Alternatively, have the user object be nullable and don't\n-          // bother with isLocked.\n-          entities: {\n-            user: { [user.username]: returnedUser }\n-          },\n-          result: user.username\n-        });\n-      }\n-    }\n-  );\n-\n-  fastify.get(\n-    '/api/users/exists',\n-    {\n-      schema: schemas.userExists,\n-      attachValidation: true\n-    },\n-    async (req, reply) => {\n-      if (req.validationError) {\n-        void reply.code(400);\n-        // TODO(Post-MVP): return a message telling the requester that their\n-        // request was malformed.\n-        return await reply.send({ exists: true });\n-      }\n-\n-      const username = req.query.username.toLowerCase();\n-\n-      if (isRestricted(username)) return await reply.send({ exists: true });\n-\n-      const exists =\n-        (await fastify.prisma.user.count({\n-          where: { username }\n-        })) > 0;\n-\n-      await reply.send({ exists });\n-    }\n-  );\n-\n-  done();\n-};",
            "previous_filename": "api/src/routes/user.ts"
        },
        {
            "sha": "47d66a236aacf450d4b23934918b70bd4b024901",
            "filename": "api/src/routes/public/auth-dev.test.ts",
            "status": "renamed",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,8 +1,12 @@\n /* eslint-disable @typescript-eslint/no-unsafe-member-access */\n /* eslint-disable @typescript-eslint/no-unsafe-assignment */\n-import { defaultUserEmail, setupServer, superRequest } from '../../jest.utils';\n-import { HOME_LOCATION } from '../utils/env';\n-import { nanoidCharSet } from '../utils/create-user';\n+import {\n+  defaultUserEmail,\n+  setupServer,\n+  superRequest\n+} from '../../../jest.utils';\n+import { HOME_LOCATION } from '../../utils/env';\n+import { nanoidCharSet } from '../../utils/create-user';\n \n describe('dev login', () => {\n   setupServer();",
            "previous_filename": "api/src/routes/auth-dev.test.ts"
        },
        {
            "sha": "8e4e76c31093f510060a51b045bc41a308e09026",
            "filename": "api/src/routes/public/auth-dev.ts",
            "status": "renamed",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,12 +1,12 @@\n import { FastifyPluginCallback, FastifyReply, FastifyRequest } from 'fastify';\n \n-import { createAccessToken } from '../utils/tokens';\n+import { createAccessToken } from '../../utils/tokens';\n import {\n   getPrefixedLandingPath,\n   getRedirectParams,\n   haveSamePath\n-} from '../utils/redirection';\n-import { findOrCreateUser } from './helpers/auth-helpers';\n+} from '../../utils/redirection';\n+import { findOrCreateUser } from '../helpers/auth-helpers';\n \n const trimTrailingSlash = (str: string) =>\n   str.endsWith('/') ? str.slice(0, -1) : str;",
            "previous_filename": "api/src/routes/auth-dev.ts"
        },
        {
            "sha": "8a0f105a111fb93dbf5ebfaa4b2226f212166352",
            "filename": "api/src/routes/public/auth.test.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -3,8 +3,8 @@ import {\n   setupServer,\n   superRequest,\n   createSuperRequest\n-} from '../../jest.utils';\n-import { AUTH0_DOMAIN } from '../utils/env';\n+} from '../../../jest.utils';\n+import { AUTH0_DOMAIN } from '../../utils/env';\n \n const mockedFetch = jest.fn();\n jest.spyOn(globalThis, 'fetch').mockImplementation(mockedFetch);\n@@ -25,10 +25,10 @@ const mockAuth0ValidEmail = () => ({\n   json: () => ({ email: newUserEmail })\n });\n \n-jest.mock('../utils/env', () => {\n+jest.mock('../../utils/env', () => {\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n   return {\n-    ...jest.requireActual('../utils/env'),\n+    ...jest.requireActual('../../utils/env'),\n     FCC_ENABLE_DEV_LOGIN_MODE: false\n   };\n });",
            "previous_filename": "api/src/routes/auth.test.ts"
        },
        {
            "sha": "6096597ea2691521578187a9dc670fb630302f08",
            "filename": "api/src/routes/public/auth.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -9,10 +9,10 @@ import rateLimit, { type FastifyRateLimitStore } from '@fastify/rate-limit';\n import MongoStoreRL from 'rate-limit-mongo';\n import isEmail from 'validator/lib/isEmail';\n \n-import { AUTH0_DOMAIN, MONGOHQ_URL } from '../utils/env';\n-import { auth0Client } from '../plugins/auth0';\n-import { createAccessToken } from '../utils/tokens';\n-import { findOrCreateUser } from './helpers/auth-helpers';\n+import { AUTH0_DOMAIN, MONGOHQ_URL } from '../../utils/env';\n+import { auth0Client } from '../../plugins/auth0';\n+import { createAccessToken } from '../../utils/tokens';\n+import { findOrCreateUser } from '../helpers/auth-helpers';\n \n const getEmailFromAuth0 = async (\n   req: FastifyRequest",
            "previous_filename": "api/src/routes/auth.ts"
        },
        {
            "sha": "568c6155e96fa4b3cbb0fdacd4f14bea407d68b7",
            "filename": "api/src/routes/public/certificate.test.ts",
            "status": "added",
            "additions": 274,
            "deletions": 0,
            "changes": 274,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,274 @@\n+import {\n+  defaultUserEmail,\n+  defaultUserId,\n+  resetDefaultUser,\n+  setupServer,\n+  superRequest\n+} from '../../../jest.utils';\n+import { getFallbackFullStackDate } from '../helpers/certificate-utils';\n+\n+describe('certificate routes', () => {\n+  setupServer();\n+\n+  describe('Unauthenticated user', () => {\n+    beforeAll(async () => resetDefaultUser());\n+\n+    describe('GET /certificate/showCert/:username/:certSlug', () => {\n+      beforeEach(async () => {\n+        await fastifyTestInstance.prisma.user.updateMany({\n+          where: { email: defaultUserEmail },\n+          data: {\n+            username: 'foobar',\n+            name: 'foobar',\n+            isHonest: true,\n+            isBanned: false,\n+            isCheater: false,\n+            profileUI: { isLocked: false, showCerts: true, showTimeLine: true }\n+          }\n+        });\n+      });\n+      test('should return user not found if the user cannot be found', async () => {\n+        const response = await superRequest(\n+          '/certificate/showCert/not-a-valid-user-name/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.username-not-found',\n+              variables: { username: 'not-a-valid-user-name' }\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should ask user to add name if there is no name', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: { name: null }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.add-name'\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should return not eligible if user is banned', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: { isBanned: true }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.not-eligible'\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should return not eligible if user is cheater', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: { isCheater: true }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.not-eligible'\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should return not honest if user is not honest', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: { isHonest: false }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.not-honest',\n+              variables: { username: 'foobar' }\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should return profile private if profile is private', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            // All properties need to be defined, as this op SETs `profileUI`\n+            profileUI: { isLocked: true, showTimeLine: true, showCerts: true }\n+          }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.profile-private',\n+              variables: { username: 'foobar' }\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should return certs private if certs are private', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            profileUI: { showCerts: false, showTimeLine: true, isLocked: false }\n+          }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.certs-private',\n+              variables: { username: 'foobar' }\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+      test('should return timeline private if timeline is private', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            profileUI: { showTimeLine: false, showCerts: true, isLocked: false }\n+          }\n+        });\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/javascript-algorithms-and-data-structures',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.timeline-private',\n+              variables: { username: 'foobar' }\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+\n+      test('should return cert-not-found if there is no cert with that slug', async () => {\n+        const response = await superRequest(\n+          '/certificate/showCert/foobar/not-a-valid-cert-slug',\n+          {\n+            method: 'GET'\n+          }\n+        );\n+        expect(response.body).toEqual({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.cert-not-found',\n+              variables: { certSlug: 'not-a-valid-cert-slug' }\n+            }\n+          ]\n+        });\n+        expect(response.status).toBe(404);\n+      });\n+    });\n+  });\n+});\n+\n+const fullStackChallenges = [\n+  {\n+    completedDate: 1585210952511,\n+    id: '5a553ca864b52e1d8bceea14'\n+  },\n+  {\n+    completedDate: 1585210952511,\n+    id: '561add10cb82ac38a17513bc'\n+  },\n+  {\n+    completedDate: 1588665778679,\n+    id: '561acd10cb82ac38a17513bc'\n+  },\n+  {\n+    completedDate: 1685210952511,\n+    id: '561abd10cb81ac38a17513bc'\n+  },\n+  {\n+    completedDate: 1585210952511,\n+    id: '561add10cb82ac38a17523bc'\n+  },\n+  {\n+    completedDate: 1588665778679,\n+    id: '561add10cb82ac38a17213bc'\n+  }\n+];\n+\n+describe('helper functions', () => {\n+  describe('getFallbackFullStackDate', () => {\n+    it('should return the date of the latest completed challenge', () => {\n+      expect(getFallbackFullStackDate(fullStackChallenges, 123)).toBe(\n+        1685210952511\n+      );\n+    });\n+\n+    it('should fall back to completedDate if no certifications are provided', () => {\n+      expect(getFallbackFullStackDate([], 123)).toBe(123);\n+    });\n+\n+    it('should fall back to completedDate if none of the certifications have been completed', () => {\n+      expect(\n+        getFallbackFullStackDate([{ completedDate: 567, id: 'abc' }], 123)\n+      ).toBe(123);\n+    });\n+  });\n+});"
        },
        {
            "sha": "df245479ed9fed8f6096f1debaba8321546e2ad1",
            "filename": "api/src/routes/public/certificate.ts",
            "status": "added",
            "additions": 238,
            "deletions": 0,
            "changes": 238,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,238 @@\n+import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+\n+import { find } from 'lodash';\n+import * as schemas from '../../schemas';\n+import {\n+  certSlugTypeMap,\n+  certTypeTitleMap,\n+  certTypeIdMap,\n+  completionHours,\n+  oldDataVizId\n+} from '../../../../shared/config/certification-settings';\n+import {\n+  getFallbackFullStackDate,\n+  isKnownCertSlug\n+} from '../helpers/certificate-utils';\n+\n+/**\n+ * Plugin for the unprotected certificate endpoints.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done The callback to signal that the plugin is ready.\n+ */\n+export const unprotectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  fastify.get(\n+    '/certificate/showCert/:username/:certSlug',\n+    {\n+      schema: schemas.certSlug\n+    },\n+    async (req, reply) => {\n+      const username = req.params.username.toLowerCase();\n+      const certSlug = req.params.certSlug;\n+\n+      fastify.log.info(`certSlug: ${certSlug}`);\n+\n+      if (!isKnownCertSlug(certSlug)) {\n+        void reply.code(404);\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.cert-not-found',\n+              variables: { certSlug }\n+            }\n+          ]\n+        });\n+      }\n+\n+      const certType = certSlugTypeMap[certSlug];\n+      const certId = certTypeIdMap[certType];\n+      const certTitle = certTypeTitleMap[certType];\n+      const completionTime = completionHours[certType] || 300;\n+      const user = await fastify.prisma.user.findFirst({\n+        where: { username },\n+        select: {\n+          isBanned: true,\n+          isCheater: true,\n+          isFrontEndCert: true,\n+          isBackEndCert: true,\n+          isFullStackCert: true,\n+          isRespWebDesignCert: true,\n+          isFrontEndLibsCert: true,\n+          isJsAlgoDataStructCert: true,\n+          isJsAlgoDataStructCertV8: true,\n+          isDataVisCert: true,\n+          is2018DataVisCert: true,\n+          isApisMicroservicesCert: true,\n+          isInfosecQaCert: true,\n+          isQaCertV7: true,\n+          isInfosecCertV7: true,\n+          isSciCompPyCertV7: true,\n+          isDataAnalysisPyCertV7: true,\n+          isMachineLearningPyCertV7: true,\n+          isRelationalDatabaseCertV8: true,\n+          isCollegeAlgebraPyCertV8: true,\n+          isFoundationalCSharpCertV8: true,\n+          isUpcomingPythonCertV8: true,\n+          isHonest: true,\n+          username: true,\n+          name: true,\n+          completedChallenges: true,\n+          profileUI: true\n+        }\n+      });\n+\n+      if (user === null) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.username-not-found',\n+              variables: { username }\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (user.isCheater || user.isBanned) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.not-eligible'\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (!user.isHonest) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.not-honest',\n+              variables: { username }\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (user.profileUI?.isLocked) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.profile-private',\n+              variables: { username }\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (!user.name) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.add-name'\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (!user.profileUI?.showCerts) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.certs-private',\n+              variables: { username }\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (!user.profileUI?.showTimeLine) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.timeline-private',\n+              variables: { username }\n+            }\n+          ]\n+        });\n+      }\n+\n+      if (!user[certType]) {\n+        return reply.send({\n+          messages: [\n+            {\n+              type: 'info',\n+              message: 'flash.user-not-certified',\n+              variables: { username, cert: certTypeTitleMap[certType] }\n+            }\n+          ]\n+        });\n+      }\n+\n+      const { completedChallenges } = user;\n+      const certChallenge = find(\n+        completedChallenges,\n+        ({ id }) => certId === id\n+      );\n+\n+      let { completedDate = Date.now() } = certChallenge || {};\n+\n+      // the challenge id has been rotated for isDataVisCert\n+      if (certType === 'isDataVisCert' && !certChallenge) {\n+        const oldDataVisIdChall = find(\n+          completedChallenges,\n+          ({ id }) => oldDataVizId === id\n+        );\n+\n+        if (oldDataVisIdChall) {\n+          completedDate = oldDataVisIdChall.completedDate || completedDate;\n+        }\n+      }\n+\n+      // if fullcert is not found, return the latest completedDate\n+      if (certType === 'isFullStackCert' && !certChallenge) {\n+        completedDate = getFallbackFullStackDate(\n+          completedChallenges,\n+          completedDate\n+        );\n+      }\n+\n+      const { name } = user;\n+\n+      if (!user.profileUI.showName) {\n+        void reply.code(200);\n+        return reply.send({\n+          certSlug,\n+          certTitle,\n+          username,\n+          date: completedDate,\n+          completionTime\n+        });\n+      }\n+\n+      void reply.code(200);\n+      return reply.send({\n+        certSlug,\n+        certTitle,\n+        username,\n+        name,\n+        date: completedDate,\n+        completionTime\n+      });\n+    }\n+  );\n+\n+  done();\n+};"
        },
        {
            "sha": "2daa8b22da1271085496257bfd5b1baa66994547",
            "filename": "api/src/routes/public/deprecated-endpoints.test.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-endpoints.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-endpoints.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-endpoints.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,6 +1,6 @@\n import request from 'supertest';\n \n-import { setupServer } from '../../jest.utils';\n+import { setupServer } from '../../../jest.utils';\n import { endpoints } from './deprecated-endpoints';\n \n describe('Deprecated endpoints', () => {",
            "previous_filename": "api/src/routes/deprecated-endpoints.test.ts"
        },
        {
            "sha": "757a140eaa2ddf06d1ac508c7004e9deeaee7f9a",
            "filename": "api/src/routes/public/deprecated-endpoints.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-endpoints.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-endpoints.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-endpoints.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,6 +1,6 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n \n-import * as schemas from '../schemas';\n+import * as schemas from '../../schemas';\n \n type Endpoints = [string, 'GET' | 'POST'][];\n ",
            "previous_filename": "api/src/routes/deprecated-endpoints.ts"
        },
        {
            "sha": "e1b421f741b06a6dbb66a0263d1fba2181793b33",
            "filename": "api/src/routes/public/deprecated-unsubscribe.test.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-unsubscribe.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-unsubscribe.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-unsubscribe.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,4 +1,4 @@\n-import { setupServer, superRequest } from '../../jest.utils';\n+import { setupServer, superRequest } from '../../../jest.utils';\n \n import { unsubscribeEndpoints } from './deprecated-unsubscribe';\n ",
            "previous_filename": "api/src/routes/deprecated-unsubscribe.test.ts"
        },
        {
            "sha": "5d8a0a65b958c7dc9bc5e43a9bec30a1725ae8ed",
            "filename": "api/src/routes/public/deprecated-unsubscribe.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-unsubscribe.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-unsubscribe.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdeprecated-unsubscribe.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,6 +1,6 @@\n import { FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n \n-import { getRedirectParams } from '../utils/redirection';\n+import { getRedirectParams } from '../../utils/redirection';\n \n type Endpoint = [string, 'GET' | 'POST'];\n ",
            "previous_filename": "api/src/routes/deprecated-unsubscribe.ts"
        },
        {
            "sha": "a3e6e097e34748b50b30945cdd0b70838ec75474",
            "filename": "api/src/routes/public/donate.test.ts",
            "status": "added",
            "additions": 139,
            "deletions": 0,
            "changes": 139,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,139 @@\n+import { setupServer, superRequest } from '../../../jest.utils';\n+\n+const testEWalletEmail = 'baz@bar.com';\n+const testSubscriptionId = 'sub_test_id';\n+const testCustomerId = 'cust_test_id';\n+\n+const sharedDonationReqBody = {\n+  amount: 500,\n+  duration: 'month'\n+};\n+const chargeStripeReqBody = {\n+  email: testEWalletEmail,\n+  subscriptionId: 'sub_test_id',\n+  ...sharedDonationReqBody\n+};\n+const createStripePaymentIntentReqBody = {\n+  email: testEWalletEmail,\n+  name: 'Baz Bar',\n+  token: { id: 'tok_123' },\n+  ...sharedDonationReqBody\n+};\n+const mockSubCreate = jest.fn();\n+const mockAttachPaymentMethod = jest.fn(() =>\n+  Promise.resolve({\n+    id: 'pm_1MqLiJLkdIwHu7ixUEgbFdYF',\n+    object: 'payment_method'\n+  })\n+);\n+const mockCustomerCreate = jest.fn(() =>\n+  Promise.resolve({\n+    id: testCustomerId,\n+    name: 'Jest_User',\n+    currency: 'sgd',\n+    description: 'Jest User Account created'\n+  })\n+);\n+const mockSubRetrieveObj = {\n+  id: testSubscriptionId,\n+  items: {\n+    data: [\n+      {\n+        plan: {\n+          product: 'prod_GD1GGbJsqQaupl'\n+        }\n+      }\n+    ]\n+  },\n+  // 1 Jan 2040\n+  current_period_start: Math.floor(Date.now() / 1000),\n+  customer: testCustomerId,\n+  status: 'active'\n+};\n+const mockSubRetrieve = jest.fn(() => Promise.resolve(mockSubRetrieveObj));\n+const mockCheckoutSessionCreate = jest.fn(() =>\n+  Promise.resolve({ id: 'checkout_session_id' })\n+);\n+const mockCustomerUpdate = jest.fn();\n+const generateMockSubCreate = (status: string) => () =>\n+  Promise.resolve({\n+    id: testSubscriptionId,\n+    latest_invoice: {\n+      payment_intent: {\n+        client_secret: 'superSecret',\n+        status\n+      }\n+    }\n+  });\n+jest.mock('stripe', () => {\n+  return jest.fn().mockImplementation(() => {\n+    return {\n+      customers: {\n+        create: mockCustomerCreate,\n+        update: mockCustomerUpdate\n+      },\n+      paymentMethods: {\n+        attach: mockAttachPaymentMethod\n+      },\n+      subscriptions: {\n+        create: mockSubCreate,\n+        retrieve: mockSubRetrieve\n+      },\n+      checkout: {\n+        sessions: {\n+          create: mockCheckoutSessionCreate\n+        }\n+      }\n+    };\n+  });\n+});\n+\n+describe('Donate', () => {\n+  let setCookies: string[];\n+  setupServer();\n+\n+  describe('Unauthenticated User', () => {\n+    // Get the CSRF cookies from an unprotected route\n+    beforeAll(async () => {\n+      const res = await superRequest('/status/ping', { method: 'GET' });\n+      setCookies = res.get('Set-Cookie');\n+    });\n+\n+    const endpoints: { path: string; method: 'POST' | 'PUT' }[] = [\n+      { path: '/donate/add-donation', method: 'POST' },\n+      { path: '/donate/charge-stripe-card', method: 'POST' },\n+      { path: '/donate/update-stripe-card', method: 'PUT' }\n+    ];\n+\n+    endpoints.forEach(({ path, method }) => {\n+      test(`${method} ${path} returns 401 status code with error message`, async () => {\n+        const response = await superRequest(path, {\n+          method,\n+          setCookies\n+        });\n+        expect(response.statusCode).toBe(401);\n+      });\n+    });\n+\n+    test('POST /donate/create-stripe-payment-intent should return 200', async () => {\n+      mockSubCreate.mockImplementationOnce(generateMockSubCreate('no-errors'));\n+      const response = await superRequest(\n+        '/donate/create-stripe-payment-intent',\n+        {\n+          method: 'POST',\n+          setCookies\n+        }\n+      ).send(createStripePaymentIntentReqBody);\n+      expect(response.status).toBe(200);\n+    });\n+\n+    test('POST /donate/charge-stripe should return 200', async () => {\n+      mockSubCreate.mockImplementationOnce(generateMockSubCreate('no-errors'));\n+      const response = await superRequest('/donate/charge-stripe', {\n+        method: 'POST',\n+        setCookies\n+      }).send(chargeStripeReqBody);\n+      expect(response.status).toBe(200);\n+    });\n+  });\n+});"
        },
        {
            "sha": "4187674be4df642a2bcd63bc5ff9cc73e92ef808",
            "filename": "api/src/routes/public/donate.ts",
            "status": "added",
            "additions": 167,
            "deletions": 0,
            "changes": 167,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,167 @@\n+import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import Stripe from 'stripe';\n+\n+import { STRIPE_SECRET_KEY } from '../../utils/env';\n+import {\n+  donationSubscriptionConfig,\n+  allStripeProductIdsArray\n+} from '../../../../shared/config/donation-settings';\n+import * as schemas from '../../schemas';\n+import { inLastFiveMinutes } from '../../utils/validate-donation';\n+import { findOrCreateUser } from '../helpers/auth-helpers';\n+\n+/**\n+ * Plugin for public donation endpoints.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done The callback to signal that the plugin is ready.\n+ */\n+export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  // Stripe plugin\n+  const stripe = new Stripe(STRIPE_SECRET_KEY, {\n+    apiVersion: '2024-06-20',\n+    typescript: true\n+  });\n+\n+  fastify.post(\n+    '/donate/create-stripe-payment-intent',\n+    {\n+      schema: schemas.createStripePaymentIntent\n+    },\n+    async (req, reply) => {\n+      const { email, name, amount, duration } = req.body;\n+\n+      if (!donationSubscriptionConfig.plans[duration].includes(amount)) {\n+        void reply.code(400);\n+        return {\n+          error: 'The donation form had invalid values for this submission.'\n+        } as const;\n+      }\n+\n+      try {\n+        const stripeCustomer = await stripe.customers.create({\n+          email,\n+          name\n+        });\n+\n+        const stripeSubscription = await stripe.subscriptions.create({\n+          customer: stripeCustomer.id,\n+          items: [\n+            {\n+              plan: `${donationSubscriptionConfig.duration[duration]}-donation-${amount}`\n+            }\n+          ],\n+          payment_behavior: 'default_incomplete',\n+          payment_settings: { save_default_payment_method: 'on_subscription' },\n+          expand: ['latest_invoice.payment_intent']\n+        });\n+\n+        if (\n+          stripeSubscription.latest_invoice &&\n+          typeof stripeSubscription.latest_invoice !== 'string' &&\n+          stripeSubscription.latest_invoice.payment_intent &&\n+          typeof stripeSubscription.latest_invoice.payment_intent !==\n+            'string' &&\n+          stripeSubscription.latest_invoice.payment_intent.client_secret !==\n+            null\n+        ) {\n+          const clientSecret =\n+            stripeSubscription.latest_invoice.payment_intent.client_secret;\n+          return reply.send({\n+            subscriptionId: stripeSubscription.id,\n+            clientSecret\n+          });\n+        } else {\n+          throw new Error('Stripe payment intent client secret is missing');\n+        }\n+      } catch (error) {\n+        fastify.log.error(error);\n+        fastify.Sentry.captureException(error);\n+        void reply.code(500);\n+        return reply.send({\n+          error: 'Donation failed due to a server error.'\n+        });\n+      }\n+    }\n+  );\n+\n+  fastify.post(\n+    '/donate/charge-stripe',\n+    {\n+      schema: schemas.chargeStripe\n+    },\n+    async (req, reply) => {\n+      try {\n+        const { email, amount, duration, subscriptionId } = req.body;\n+\n+        const subscription =\n+          await stripe.subscriptions.retrieve(subscriptionId);\n+        const isSubscriptionActive = subscription.status === 'active';\n+        const productId = subscription.items.data[0]?.plan.product?.toString();\n+        const isStartedRecently = inLastFiveMinutes(\n+          subscription.current_period_start\n+        );\n+        const isProductIdValid =\n+          productId && allStripeProductIdsArray.includes(productId);\n+        const isValidCustomer = typeof subscription.customer === 'string';\n+\n+        if (!isSubscriptionActive)\n+          throw new Error(\n+            `Stripe subscription information is invalid: ${subscriptionId}`\n+          );\n+        if (!isProductIdValid)\n+          throw new Error(`Product ID is invalid: ${subscriptionId}`);\n+        if (!isStartedRecently)\n+          throw new Error(`Subscription is not recent: ${subscriptionId}`);\n+        if (!isValidCustomer)\n+          throw new Error(`Customer ID is invalid: ${subscriptionId}`);\n+        else {\n+          // TODO(Post-MVP) new users should not be created if user is not found\n+          const user = await findOrCreateUser(fastify, email);\n+          const donation = {\n+            userId: user.id,\n+            email,\n+            amount,\n+            duration,\n+            provider: 'stripe',\n+            subscriptionId,\n+            customerId: subscription.customer as string,\n+            // TODO(Post-MVP) migrate to startDate: new Date()\n+            startDate: {\n+              date: new Date().toISOString(),\n+              when: new Date().toISOString().replace(/.$/, '+00:00')\n+            }\n+          };\n+\n+          await fastify.prisma.donation.create({\n+            data: donation\n+          });\n+\n+          await fastify.prisma.user.update({\n+            where: { id: user.id },\n+            data: {\n+              isDonating: true\n+            }\n+          });\n+          return reply.send({\n+            isDonating: true\n+          });\n+        }\n+      } catch (error) {\n+        fastify.log.error(error);\n+        fastify.Sentry.captureException(error);\n+        void reply.code(500);\n+        return {\n+          error: 'Donation failed due to a server error.'\n+        } as const;\n+      }\n+    }\n+  );\n+\n+  done();\n+};"
        },
        {
            "sha": "cd833befc3b11762c7d41d8603adfe398bf77f7c",
            "filename": "api/src/routes/public/email-subscription.test.ts",
            "status": "renamed",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,8 +1,8 @@\n /* eslint-disable @typescript-eslint/no-unsafe-member-access */\n import type { Prisma } from '@prisma/client';\n-import { setupServer, superRequest } from '../../jest.utils';\n-import { HOME_LOCATION } from '../utils/env';\n-import { createUserInput } from '../utils/create-user';\n+import { setupServer, superRequest } from '../../../jest.utils';\n+import { HOME_LOCATION } from '../../utils/env';\n+import { createUserInput } from '../../utils/create-user';\n \n const urlEncodedInfoMessage1 =\n   '?messages=info%5B0%5D%3DWe%2520could%2520not%2520find%2520an%2520account%2520to%2520unsubscribe.';",
            "previous_filename": "api/src/routes/email-subscription.test.ts"
        },
        {
            "sha": "2b37e72af8bbe9fb2eb43735d25802d6e48fb62b",
            "filename": "api/src/routes/public/email-subscription.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,7 +1,7 @@\n /* eslint-disable @typescript-eslint/naming-convention */\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n-import * as schemas from '../schemas';\n-import { getRedirectParams } from '../utils/redirection';\n+import * as schemas from '../../schemas';\n+import { getRedirectParams } from '../../utils/redirection';\n \n /**\n  * Endpoints to set 'sendQuincyEmail' to true or false using 'unsubscribeId'.",
            "previous_filename": "api/src/routes/email-subscription.ts"
        },
        {
            "sha": "95ad20bb34338df2c2060cefa5c38a7fd5960d2f",
            "filename": "api/src/routes/public/index.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Findex.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,10 @@\n+export * from './auth-dev';\n+export * from './auth';\n+export * from './certificate';\n+export * from './deprecated-endpoints';\n+export * from './deprecated-unsubscribe';\n+export * from './donate';\n+export * from './email-subscription';\n+export * from './signout';\n+export * from './status';\n+export * from './user';"
        },
        {
            "sha": "6d601c187ee35f5e154c5216565e9ee4c7c3ded2",
            "filename": "api/src/routes/public/signout.test.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,5 +1,5 @@\n-import { devLogin, setupServer, superRequest } from '../../jest.utils';\n-import { HOME_LOCATION } from '../utils/env';\n+import { devLogin, setupServer, superRequest } from '../../../jest.utils';\n+import { HOME_LOCATION } from '../../utils/env';\n \n describe('GET /signout', () => {\n   setupServer();",
            "previous_filename": "api/src/routes/signout.test.ts"
        },
        {
            "sha": "6a96d436ebaafabb15041371b31da4c370c63585",
            "filename": "api/src/routes/public/signout.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,6 +1,6 @@\n import type { FastifyPluginCallback } from 'fastify';\n \n-import { getRedirectParams } from '../utils/redirection';\n+import { getRedirectParams } from '../../utils/redirection';\n \n /**\n  * Route handler for signing out.",
            "previous_filename": "api/src/routes/signout.ts"
        },
        {
            "sha": "e6852a695e4019a4c85c5121b00b3449bd180d7e",
            "filename": "api/src/routes/public/status.test.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -1,4 +1,4 @@\n-import { setupServer, superRequest } from '../../jest.utils';\n+import { setupServer, superRequest } from '../../../jest.utils';\n \n describe('/status', () => {\n   setupServer();",
            "previous_filename": "api/src/routes/status.test.ts"
        },
        {
            "sha": "d42c42762f935e1d85403b7b132c320d886421b8",
            "filename": "api/src/routes/public/status.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "previous_filename": "api/src/routes/status.ts"
        },
        {
            "sha": "5f957fe8eb44451e1b90e8dae35ee474779bee7f",
            "filename": "api/src/routes/public/user.test.ts",
            "status": "added",
            "additions": 614,
            "deletions": 0,
            "changes": 614,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,614 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n+/* eslint-disable @typescript-eslint/no-unsafe-argument */\n+/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n+import type { Prisma } from '@prisma/client';\n+import { ObjectId } from 'mongodb';\n+import _ from 'lodash';\n+\n+import { createUserInput } from '../../utils/create-user';\n+import {\n+  defaultUserEmail,\n+  setupServer,\n+  createSuperRequest\n+} from '../../../jest.utils';\n+import { getMsTranscriptApiUrl } from '../protected/user';\n+import { replacePrivateData } from './user';\n+\n+const mockedFetch = jest.fn();\n+jest.spyOn(globalThis, 'fetch').mockImplementation(mockedFetch);\n+\n+// This is used to build a test user.\n+const testUserData: Prisma.userCreateInput = {\n+  ...createUserInput(defaultUserEmail),\n+  username: 'foobar',\n+  usernameDisplay: 'Foo Bar',\n+  progressTimestamps: [1520002973119, 1520440323273],\n+  completedChallenges: [\n+    {\n+      id: 'a6b0bb188d873cb2c8729495',\n+      completedDate: 1520002973119,\n+      solution: null,\n+      challengeType: 5,\n+      files: [\n+        {\n+          contents: 'test',\n+          ext: 'js',\n+          key: 'indexjs',\n+          name: 'test',\n+          path: 'path-test'\n+        },\n+        {\n+          contents: 'test2',\n+          ext: 'html',\n+          key: 'html-test',\n+          name: 'test2'\n+        }\n+      ]\n+    },\n+    {\n+      id: 'a5229172f011153519423690',\n+      completedDate: 1520440323273,\n+      solution: null,\n+      challengeType: 5,\n+      files: []\n+    },\n+    {\n+      id: 'a5229172f011153519423692',\n+      completedDate: 1520440323274,\n+      githubLink: '',\n+      challengeType: 5,\n+      examResults: {\n+        numberOfCorrectAnswers: 0,\n+        numberOfQuestionsInExam: 0,\n+        percentCorrect: 0,\n+        passingPercent: 0,\n+        passed: false,\n+        examTimeInSeconds: 0\n+      }\n+    }\n+  ],\n+  partiallyCompletedChallenges: [{ id: '123', completedDate: 123 }],\n+  completedExams: [],\n+  githubProfile: 'github.com/foobar',\n+  website: 'https://www.freecodecamp.org',\n+  donationEmails: ['an@add.ress'],\n+  portfolio: [\n+    {\n+      description: 'A portfolio',\n+      id: 'a6b0bb188d873cb2c8729495',\n+      image: 'https://www.freecodecamp.org/cat.png',\n+      title: 'A portfolio',\n+      url: 'https://www.freecodecamp.org'\n+    }\n+  ],\n+  savedChallenges: [\n+    {\n+      id: 'a6b0bb188d873cb2c8729495',\n+      lastSavedDate: 123,\n+      files: [\n+        {\n+          contents: 'test-contents',\n+          ext: 'js',\n+          history: ['indexjs'],\n+          key: 'indexjs',\n+          name: 'test-name'\n+        }\n+      ]\n+    }\n+  ],\n+  yearsTopContributor: ['2018'],\n+  twitter: '@foobar',\n+  linkedin: 'linkedin.com/foobar'\n+};\n+\n+const minimalUserData: Prisma.userCreateInput = {\n+  about: 'I am a test user',\n+  acceptedPrivacyTerms: true,\n+  email: testUserData.email,\n+  emailVerified: true,\n+  externalId: '1234567890',\n+  isDonating: false,\n+  picture: 'https://www.freecodecamp.org/cat.png',\n+  sendQuincyEmail: true,\n+  username: 'testuser',\n+  unsubscribeId: '1234567890'\n+};\n+\n+const lockedProfileUI = {\n+  isLocked: true,\n+  showAbout: false,\n+  showCerts: false,\n+  showDonation: false,\n+  showHeatMap: false,\n+  showLocation: false,\n+  showName: false,\n+  showPoints: false,\n+  showPortfolio: false,\n+  showTimeLine: false\n+};\n+\n+const publicUserData = {\n+  about: testUserData.about,\n+  calendar: { 1520002973: 1, 1520440323: 1 },\n+  // testUserData.completedChallenges, with nulls removed\n+  completedChallenges: [\n+    {\n+      id: 'a6b0bb188d873cb2c8729495',\n+      completedDate: 1520002973119,\n+      challengeType: 5,\n+      files: [\n+        {\n+          contents: 'test',\n+          ext: 'js',\n+          key: 'indexjs',\n+          name: 'test',\n+          path: 'path-test'\n+        },\n+        {\n+          contents: 'test2',\n+          ext: 'html',\n+          key: 'html-test',\n+          name: 'test2'\n+        }\n+      ]\n+    },\n+    {\n+      id: 'a5229172f011153519423690',\n+      completedDate: 1520440323273,\n+      challengeType: 5,\n+      files: []\n+    },\n+    {\n+      id: 'a5229172f011153519423692',\n+      completedDate: 1520440323274,\n+      githubLink: '',\n+      challengeType: 5,\n+      files: [],\n+      examResults: {\n+        numberOfCorrectAnswers: 0,\n+        numberOfQuestionsInExam: 0,\n+        percentCorrect: 0,\n+        passingPercent: 0,\n+        passed: false,\n+        examTimeInSeconds: 0\n+      }\n+    }\n+  ],\n+  completedExams: testUserData.completedExams,\n+  completedSurveys: [], // TODO: add surveys\n+  githubProfile: testUserData.githubProfile,\n+  is2018DataVisCert: testUserData.is2018DataVisCert,\n+  is2018FullStackCert: testUserData.is2018FullStackCert, // TODO: should this be returned? The client doesn't use it at the moment.\n+  isApisMicroservicesCert: testUserData.isApisMicroservicesCert,\n+  isBackEndCert: testUserData.isBackEndCert,\n+  isCheater: testUserData.isCheater,\n+  isCollegeAlgebraPyCertV8: testUserData.isCollegeAlgebraPyCertV8,\n+  isDataAnalysisPyCertV7: testUserData.isDataAnalysisPyCertV7,\n+  isDataVisCert: testUserData.isDataVisCert,\n+  isDonating: testUserData.isDonating,\n+  isFoundationalCSharpCertV8: testUserData.isFoundationalCSharpCertV8,\n+  isFrontEndCert: testUserData.isFrontEndCert,\n+  isFrontEndLibsCert: testUserData.isFrontEndLibsCert,\n+  isFullStackCert: testUserData.isFullStackCert,\n+  isHonest: testUserData.isHonest,\n+  isInfosecCertV7: testUserData.isInfosecCertV7,\n+  isInfosecQaCert: testUserData.isInfosecQaCert,\n+  isJsAlgoDataStructCert: testUserData.isJsAlgoDataStructCert,\n+  isJsAlgoDataStructCertV8: testUserData.isJsAlgoDataStructCertV8,\n+  isMachineLearningPyCertV7: testUserData.isMachineLearningPyCertV7,\n+  isQaCertV7: testUserData.isQaCertV7,\n+  isRelationalDatabaseCertV8: testUserData.isRelationalDatabaseCertV8,\n+  isRespWebDesignCert: testUserData.isRespWebDesignCert,\n+  isSciCompPyCertV7: testUserData.isSciCompPyCertV7,\n+  linkedin: testUserData.linkedin,\n+  location: testUserData.location,\n+  name: testUserData.name,\n+  partiallyCompletedChallenges: [{ id: '123', completedDate: 123 }],\n+  picture: testUserData.picture,\n+  points: 2,\n+  portfolio: testUserData.portfolio,\n+  profileUI: testUserData.profileUI,\n+  savedChallenges: testUserData.savedChallenges,\n+  twitter: 'https://twitter.com/foobar',\n+  username: testUserData.usernameDisplay, // It defaults to usernameDisplay\n+  website: testUserData.website,\n+  yearsTopContributor: testUserData.yearsTopContributor\n+};\n+\n+describe('userRoutes', () => {\n+  setupServer();\n+\n+  describe('Public', () => {\n+    let superGet: ReturnType<typeof createSuperRequest>;\n+\n+    beforeEach(() => {\n+      superGet = createSuperRequest({ method: 'GET' });\n+    });\n+\n+    describe('/api/users/get-public-profile', () => {\n+      const profilelessUsername = 'profileless-user';\n+      const lockedUsername = 'locked-user';\n+      const publicUsername = 'public-user';\n+      const lockedUserProfileUI = {\n+        isLocked: true,\n+        showAbout: true,\n+        showPortfolio: false\n+      };\n+      const unlockedUserProfileUI = {\n+        isLocked: false,\n+        showAbout: true,\n+        showCerts: true,\n+        showDonation: true,\n+        showHeatMap: true,\n+        showLocation: true,\n+        showName: true,\n+        showPoints: true,\n+        showPortfolio: true,\n+        showTimeLine: true\n+      };\n+      const users = [profilelessUsername, lockedUsername, publicUsername];\n+      beforeAll(async () => {\n+        await fastifyTestInstance.prisma.user.create({\n+          data: {\n+            ...minimalUserData,\n+            email: profilelessUsername,\n+            username: profilelessUsername\n+          }\n+        });\n+        await fastifyTestInstance.prisma.user.create({\n+          data: {\n+            ...minimalUserData,\n+            email: lockedUsername,\n+            username: lockedUsername,\n+            profileUI: lockedUserProfileUI\n+          }\n+        });\n+        await fastifyTestInstance.prisma.user.create({\n+          data: {\n+            ...testUserData,\n+            email: publicUsername,\n+            username: publicUsername,\n+            profileUI: unlockedUserProfileUI\n+          }\n+        });\n+      });\n+\n+      afterAll(async () => {\n+        await fastifyTestInstance.prisma.user.deleteMany({\n+          where: {\n+            OR: users.map(username => ({ username }))\n+          }\n+        });\n+      });\n+\n+      describe('GET', () => {\n+        test('returns 400 status code if the user agent is blocked', async () => {\n+          const response = await superGet(\n+            '/api/users/get-public-profile?username=public-user'\n+          ).set('User-Agent', 'curl');\n+\n+          expect(response.text).toBe(\n+            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n+          );\n+          expect(response.statusCode).toBe(400);\n+        });\n+\n+        test('returns 400 status code if the username param is missing', async () => {\n+          const res = await superGet('/api/users/get-public-profile');\n+          // TODO(Post-MVP): return something more informative\n+          expect(res.body).toStrictEqual({});\n+          expect(res.statusCode).toBe(400);\n+        });\n+\n+        test('returns 400 status code if the username param is empty', async () => {\n+          const res = await superGet('/api/users/get-public-profile?username=');\n+          // TODO(Post-MVP): return something more informative\n+          expect(res.body).toStrictEqual({});\n+          expect(res.statusCode).toBe(400);\n+        });\n+\n+        test('returns 404 status code for non-existent user', async () => {\n+          const response = await superGet(\n+            '/api/users/get-public-profile?username=non-existent'\n+          );\n+          // TODO(Post-MVP): return something more informative\n+          expect(response.body).toStrictEqual({});\n+          expect(response.statusCode).toBe(404);\n+        });\n+\n+        test('returns 200 status code with a locked profile if the profile is private', async () => {\n+          const response = await superGet(\n+            `/api/users/get-public-profile?username=${lockedUsername}`\n+          );\n+\n+          expect(response.body).toStrictEqual({\n+            entities: {\n+              user: {\n+                [lockedUsername]: {\n+                  isLocked: true,\n+                  profileUI: lockedUserProfileUI,\n+                  username: lockedUsername\n+                }\n+              }\n+            },\n+            result: lockedUsername\n+          });\n+          expect(response.statusCode).toBe(200);\n+        });\n+\n+        test('returns 200 status code locked profile if the profile is missing', async () => {\n+          const response = await superGet(\n+            `/api/users/get-public-profile?username=${profilelessUsername}`\n+          );\n+\n+          expect(response.body).toStrictEqual({\n+            entities: {\n+              user: {\n+                [profilelessUsername]: {\n+                  isLocked: true,\n+                  profileUI: lockedProfileUI,\n+                  username: profilelessUsername\n+                }\n+              }\n+            },\n+            result: profilelessUsername\n+          });\n+          expect(response.statusCode).toBe(200);\n+        });\n+        // TODO: create a list of public properties like the api-server and use that\n+        // to restrict the output of this and get-session-user.\n+        test('returns 200 status code with public user object', async () => {\n+          const testUser =\n+            await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+              where: { email: publicUsername }\n+            });\n+          const response = await superGet(\n+            `/api/users/get-public-profile?username=${publicUsername}`\n+          );\n+\n+          // TODO: create a fixture for this without 'completedSurveys', ideally\n+          // it should contain the entire body.\n+          const publicUser = {\n+            // TODO(Post-MVP, maybe): return completedSurveys?\n+            ..._.omit(publicUserData, 'completedSurveys'),\n+            username: publicUsername,\n+            joinDate: new ObjectId(testUser.id).getTimestamp().toISOString(),\n+            profileUI: unlockedUserProfileUI\n+          };\n+\n+          expect(response.body).toStrictEqual({\n+            entities: {\n+              user: {\n+                [publicUsername]: publicUser\n+              }\n+            },\n+            result: publicUsername\n+          });\n+          expect(response.statusCode).toBe(200);\n+        });\n+      });\n+    });\n+    describe('GET /api/users/exists', () => {\n+      beforeAll(async () => {\n+        await fastifyTestInstance.prisma.user.create({\n+          data: minimalUserData\n+        });\n+      });\n+\n+      it('should return { exists: true } with a 400 status code if the username param is missing or empty', async () => {\n+        const res = await superGet('/api/users/exists');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.statusCode).toBe(400);\n+\n+        const res2 = await superGet('/api/users/exists?username=');\n+\n+        expect(res2.body).toStrictEqual({ exists: true });\n+        expect(res2.statusCode).toBe(400);\n+      });\n+\n+      it('should return { exists: true } if the username exists', async () => {\n+        const res = await superGet('/api/users/exists?username=testuser');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.statusCode).toBe(200);\n+      });\n+\n+      it('should ignore case when checking for username existence', async () => {\n+        const res = await superGet('/api/users/exists?username=TeStUsEr');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.statusCode).toBe(200);\n+      });\n+\n+      it('should return { exists: false } if the username does not exist', async () => {\n+        const res = await superGet('/api/users/exists?username=nonexistent');\n+\n+        expect(res.body).toStrictEqual({ exists: false });\n+        expect(res.statusCode).toBe(200);\n+      });\n+\n+      it('should return { exists: true } if the username is restricted (ignoring case)', async () => {\n+        const res = await superGet('/api/users/exists?username=pRofIle');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+\n+        const res2 = await superGet('/api/users/exists?username=flAnge');\n+\n+        expect(res2.body).toStrictEqual({ exists: true });\n+      });\n+    });\n+  });\n+});\n+\n+describe('Microsoft helpers', () => {\n+  describe('getMsTranscriptApiUrl', () => {\n+    const expectedUrl =\n+      'https://learn.microsoft.com/api/profiles/transcript/share/8u6awert43q1plo';\n+\n+    const urlWithoutSlash =\n+      'https://learn.microsoft.com/en-us/users/mot01/transcript/8u6awert43q1plo';\n+    const urlWithSlash = `${urlWithoutSlash}/`;\n+    const urlWithQueryParams = `${urlWithoutSlash}?foo=bar`;\n+    const urlWithQueryParamsAndSlash = `${urlWithSlash}?foo=bar`;\n+\n+    it('should extract the transcript id from the url', () => {\n+      expect(getMsTranscriptApiUrl(urlWithoutSlash)).toBe(expectedUrl);\n+    });\n+\n+    it('should handle trailing slashes', () => {\n+      expect(getMsTranscriptApiUrl(urlWithSlash)).toBe(expectedUrl);\n+    });\n+\n+    it('should ignore query params', () => {\n+      expect(getMsTranscriptApiUrl(urlWithQueryParams)).toBe(expectedUrl);\n+      expect(getMsTranscriptApiUrl(urlWithQueryParamsAndSlash)).toBe(\n+        expectedUrl\n+      );\n+    });\n+  });\n+});\n+\n+describe('get-public-profile helpers', () => {\n+  describe('replacePrivateData', () => {\n+    const user = {\n+      about: 'about',\n+      calendar: { 1: 1, 2: 1 } as const,\n+      completedChallenges: [\n+        { id: '123', completedDate: 123, files: [] },\n+        { id: '456', completedDate: 456, challengeType: 7, files: [] }\n+      ],\n+      id: '5f5b1b3b1c9d440000d9e3b4',\n+      isDonating: false,\n+      location: 'location',\n+      joinDate: 'joinDate',\n+      name: 'name',\n+      points: 2,\n+      portfolio: [\n+        {\n+          id: '789',\n+          title: 'portfolio',\n+          url: 'url',\n+          image: 'image',\n+          description: 'description'\n+        }\n+      ],\n+      profileUI: {\n+        isLocked: false,\n+        showAbout: true,\n+        showCerts: true,\n+        showDonation: true,\n+        showHeatMap: true,\n+        showLocation: true,\n+        showName: true,\n+        showPoints: true,\n+        showPortfolio: true,\n+        showTimeLine: true\n+      }\n+    };\n+\n+    test(`returns \"\" for 'about' if showAbout is not true`, () => {\n+      const userWithoutAbout = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showAbout: false }\n+      };\n+      expect(replacePrivateData(userWithoutAbout)).toMatchObject({\n+        about: ''\n+      });\n+    });\n+\n+    test('returns {} for calendar if showHeatMap is not true', () => {\n+      const userWithoutHeatMap = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showHeatMap: false }\n+      };\n+      expect(replacePrivateData(userWithoutHeatMap).calendar).toEqual({});\n+    });\n+\n+    test(`returns [] for completeChallenges if showTimeLine is not true`, () => {\n+      const userWithoutTimeLine = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showTimeLine: false }\n+      };\n+      expect(replacePrivateData(userWithoutTimeLine)).toMatchObject({\n+        completedChallenges: []\n+      });\n+    });\n+\n+    test('omits certifications from completedChallenges if showCerts is not true', () => {\n+      const userWithoutCerts = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showCerts: false }\n+      };\n+      expect(replacePrivateData(userWithoutCerts)).toMatchObject({\n+        completedChallenges: [{ id: '123', completedDate: 123, files: [] }]\n+      });\n+    });\n+\n+    test('returns null for isDonating if showDonation is not true', () => {\n+      const userWithoutDonation = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showDonation: false }\n+      };\n+      expect(replacePrivateData(userWithoutDonation)).toMatchObject({\n+        isDonating: null\n+      });\n+    });\n+\n+    test('returns \"\" for joinDate if showAbout is not true', () => {\n+      const userWithoutAbout = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showAbout: false }\n+      };\n+      expect(replacePrivateData(userWithoutAbout)).toMatchObject({\n+        joinDate: ''\n+      });\n+    });\n+\n+    test(`returns \"\" for 'location' if showLocation is not true`, () => {\n+      const userWithoutLocation = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showLocation: false }\n+      };\n+      expect(replacePrivateData(userWithoutLocation)).toMatchObject({\n+        location: ''\n+      });\n+    });\n+\n+    test(`returns \"\" for 'name' if showName is not true`, () => {\n+      const userWithoutName = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showName: false }\n+      };\n+      expect(replacePrivateData(userWithoutName)).toMatchObject({\n+        name: ''\n+      });\n+    });\n+\n+    test('returns null for points if showPoints is not true', () => {\n+      const userWithoutPoints = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showPoints: false }\n+      };\n+      expect(replacePrivateData(userWithoutPoints)).toMatchObject({\n+        points: null\n+      });\n+    });\n+\n+    test('returns [] for portfolio if showPortfolio is not true', () => {\n+      const userWithoutPortfolio = {\n+        ...user,\n+        profileUI: { ...user.profileUI, showPortfolio: false }\n+      };\n+      expect(replacePrivateData(userWithoutPortfolio)).toMatchObject({\n+        portfolio: []\n+      });\n+    });\n+\n+    test('returns the expected public user object if all showX flags are true', () => {\n+      expect(replacePrivateData(user)).toEqual(\n+        _.omit(user, ['id', 'profileUI'])\n+      );\n+    });\n+  });\n+});"
        },
        {
            "sha": "883039a0425cb240cf3167ac56861daa1fd837ee",
            "filename": "api/src/routes/public/user.ts",
            "status": "added",
            "additions": 240,
            "deletions": 0,
            "changes": 240,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/274680dbdb42841600f2db00c374004f8d0cf932/api%2Fsrc%2Froutes%2Fpublic%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fuser.ts?ref=274680dbdb42841600f2db00c374004f8d0cf932",
            "patch": "@@ -0,0 +1,240 @@\n+import { Portfolio } from '@prisma/client';\n+import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import { ObjectId } from 'mongodb';\n+import _ from 'lodash';\n+\n+import { isRestricted } from '../helpers/is-restricted';\n+import * as schemas from '../../schemas';\n+import { splitUser } from '../helpers/user-utils';\n+import {\n+  normalizeChallenges,\n+  NormalizedChallenge,\n+  normalizeFlags,\n+  normalizeProfileUI,\n+  normalizeTwitter,\n+  removeNulls\n+} from '../../utils/normalize';\n+import {\n+  Calendar,\n+  getCalendar,\n+  getPoints,\n+  ProgressTimestamp\n+} from '../../utils/progress';\n+import { challengeTypes } from '../../../../shared/config/challenge-types';\n+\n+type ProfileUI = Partial<{\n+  isLocked: boolean;\n+  showAbout: boolean;\n+  showCerts: boolean;\n+  showDonation: boolean;\n+  showHeatMap: boolean;\n+  showLocation: boolean;\n+  showName: boolean;\n+  showPoints: boolean;\n+  showPortfolio: boolean;\n+  showTimeLine: boolean;\n+}>;\n+\n+type RawUser = {\n+  about: string;\n+  completedChallenges: NormalizedChallenge[];\n+  calendar: Calendar;\n+  id: string;\n+  isDonating: boolean;\n+  joinDate: string;\n+  location: string;\n+  name: string;\n+  points: number;\n+  portfolio: Portfolio[];\n+  profileUI: ProfileUI;\n+};\n+\n+/**\n+ * Creates an object with the properties that are shared with the public.\n+ * @param user The raw user object.\n+ * @returns The shared user object.\n+ */\n+export const replacePrivateData = (user: RawUser) => {\n+  const {\n+    showAbout,\n+    showHeatMap,\n+    showCerts,\n+    showDonation,\n+    showLocation,\n+    showName,\n+    showPoints,\n+    showPortfolio,\n+    showTimeLine\n+  } = user.profileUI;\n+\n+  return {\n+    about: showAbout ? user.about : '',\n+    calendar: showHeatMap ? user.calendar : {},\n+    completedChallenges: showTimeLine\n+      ? showCerts\n+        ? user.completedChallenges\n+        : user.completedChallenges.filter(\n+            c => c.challengeType !== challengeTypes.step\n+          )\n+      : [],\n+    isDonating: showDonation ? user.isDonating : null,\n+    joinDate: showAbout ? user.joinDate : '',\n+    location: showLocation ? user.location : '',\n+    name: showName ? user.name : '',\n+    points: showPoints ? user.points : null,\n+    portfolio: showPortfolio ? user.portfolio : []\n+  };\n+};\n+\n+const blockedUserAgentParts = ['python', 'google-apps-script', 'curl'];\n+/**\n+ * Plugin containing public GET routes for user account management. They are kept\n+ * separate because they do not require CSRF protection or authorization.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+export const userPublicGetRoutes: FastifyPluginCallbackTypebox = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  fastify.get(\n+    '/api/users/get-public-profile',\n+    {\n+      schema: schemas.getPublicProfile,\n+      onRequest: (req, reply, done) => {\n+        const userAgent = req.headers['user-agent'];\n+\n+        if (\n+          userAgent &&\n+          blockedUserAgentParts.some(ua => userAgent.toLowerCase().includes(ua))\n+        ) {\n+          void reply.code(400);\n+          void reply.send(\n+            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n+          );\n+        }\n+        done();\n+      }\n+    },\n+    async (req, reply) => {\n+      // TODO(Post-MVP): look for duplicates unless we can make username unique in the db.\n+      const user = await fastify.prisma.user.findFirst({\n+        where: { username: req.query.username }\n+        // TODO: only select desired fields, then stop 'omit'ing the undesired\n+        // ones.\n+      });\n+\n+      if (!user) {\n+        void reply.code(404);\n+        return reply.send({});\n+      }\n+\n+      const [flags, rest] = splitUser(user);\n+\n+      const publicUser = _.omit(rest, [\n+        'currentChallengeId',\n+        'email',\n+        'emailVerified',\n+        'sendQuincyEmail',\n+        'theme',\n+        // keyboardShortcuts is included in flags.\n+        // 'keyboardShortcuts',\n+        'acceptedPrivacyTerms',\n+        'progressTimestamps',\n+        'unsubscribeId',\n+        'donationEmails',\n+        'externalId',\n+        'usernameDisplay',\n+        'isBanned'\n+      ]);\n+\n+      const normalizedProfileUI = normalizeProfileUI(user.profileUI);\n+\n+      void reply.code(200);\n+      if (normalizedProfileUI.isLocked) {\n+        // TODO(Post-MVP): just return isLocked: true and either a null user\n+        // or no user at all. (see other TODO in the else branch below)\n+        return reply.send({\n+          entities: {\n+            user: {\n+              [user.username]: {\n+                isLocked: true,\n+                profileUI: normalizedProfileUI,\n+                username: user.username\n+              }\n+            }\n+          },\n+          result: user.username\n+        });\n+      } else {\n+        const progressTimestamps = user.progressTimestamps as\n+          | ProgressTimestamp[]\n+          | null;\n+        const sharedUser = replacePrivateData({\n+          ...user,\n+          calendar: getCalendar(progressTimestamps),\n+          completedChallenges: normalizeChallenges(user.completedChallenges),\n+          location: user.location ?? '',\n+          joinDate: new ObjectId(user.id).getTimestamp().toISOString(),\n+          name: user.name ?? '',\n+          points: getPoints(progressTimestamps),\n+          profileUI: normalizedProfileUI\n+        });\n+\n+        const returnedUser = {\n+          ...removeNulls(publicUser),\n+          ...normalizeFlags(flags),\n+          ...sharedUser,\n+          profileUI: normalizedProfileUI,\n+          // TODO: should this always be returned? Shouldn't some privacy\n+          // setting control it? Same applies to website, githubProfile,\n+          // and linkedin.\n+          twitter: normalizeTwitter(user.twitter),\n+          yearsTopContributor: user.yearsTopContributor\n+        };\n+        return reply.send({\n+          // TODO(Post-MVP): just return a user object (i.e. returnedUser) and\n+          // isLocked: false. The there should be no need for Type.Union in the\n+          // schema. Alternatively, have the user object be nullable and don't\n+          // bother with isLocked.\n+          entities: {\n+            user: { [user.username]: returnedUser }\n+          },\n+          result: user.username\n+        });\n+      }\n+    }\n+  );\n+\n+  fastify.get(\n+    '/api/users/exists',\n+    {\n+      schema: schemas.userExists,\n+      attachValidation: true\n+    },\n+    async (req, reply) => {\n+      if (req.validationError) {\n+        void reply.code(400);\n+        // TODO(Post-MVP): return a message telling the requester that their\n+        // request was malformed.\n+        return await reply.send({ exists: true });\n+      }\n+\n+      const username = req.query.username.toLowerCase();\n+\n+      if (isRestricted(username)) return await reply.send({ exists: true });\n+\n+      const exists =\n+        (await fastify.prisma.user.count({\n+          where: { username }\n+        })) > 0;\n+\n+      await reply.send({ exists });\n+    }\n+  );\n+\n+  done();\n+};"
        }
    ],
    "stats": {
        "total": 3826,
        "additions": 2153,
        "deletions": 1673
    }
}