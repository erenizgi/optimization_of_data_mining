{
    "author": "ojeytonwilliams",
    "message": "build: add workflow to publish images to DOCR (#54025)",
    "sha": "7bb3381a461cbf02520ef38f025365aebac0e3f1",
    "files": [
        {
            "sha": "ed2e7b45a94844975fbda2b870a361fb3f323fbf",
            "filename": ".dockerignore",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/.dockerignore",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/.dockerignore",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.dockerignore?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -4,8 +4,7 @@ client/public\n .git\n .gitignore\n .dockerignore\n-docker/web/Dockerfile\n-docker/api/Dockerfile\n+docker/**/Dockerfile\n **/*docker-compose*\n **/node_modules\n .eslintcache"
        },
        {
            "sha": "eca923e2767e0580d2f1c80ade0b869f8b310659",
            "filename": ".github/workflows/build-images.yml",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/.github%2Fworkflows%2Fbuild-images.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/.github%2Fworkflows%2Fbuild-images.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fbuild-images.yml?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -0,0 +1,43 @@\n+name: CI - Build Images\n+on:\n+  workflow_dispatch:\n+\n+jobs:\n+  build:\n+    name: Build (Image)\n+    runs-on: ubuntu-22.04\n+    strategy:\n+      matrix:\n+        node-version: [20.x]\n+        apps: [api]\n+        site_tlds: [dev]\n+      fail-fast: false\n+\n+    steps:\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+\n+      - name: Create a tagname\n+        id: tagname\n+        run: |\n+          echo \"tagname=$(git rev-parse --short HEAD)-$(date +%Y%m%d)-$(date +%H%M)\" >> $GITHUB_ENV\n+\n+      - name: Build & Tag Image\n+        run: |\n+          docker build \\\n+            --tag registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:$tagname \\\n+            --tag registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:latest \\\n+            --file docker/${{ matrix.apps }}/Dockerfile .\n+\n+      - name: Install doctl\n+        uses: digitalocean/action-doctl@v2\n+        with:\n+          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}\n+\n+      - name: Log in to DigitalOcean Container Registry with short-lived credentials\n+        run: doctl registry login --expiry-seconds 1200\n+\n+      - name: Push image to DigitalOcean Container Registry\n+        run: |\n+          docker push registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:$tagname\n+          docker push registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:latest"
        },
        {
            "sha": "8522639b03e1dfbda6c2647c59d99210161acc85",
            "filename": ".github/workflows/e2e-with-new-api.yml",
            "status": "modified",
            "additions": 3,
            "deletions": 22,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/.github%2Fworkflows%2Fe2e-with-new-api.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/.github%2Fworkflows%2Fe2e-with-new-api.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fe2e-with-new-api.yml?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -71,25 +71,6 @@ jobs:\n           name: webpack-stats\n           path: client/public/stats.json\n \n-  build-api:\n-    name: Build Api (Container)\n-    runs-on: ubuntu-22.04\n-    strategy:\n-      matrix:\n-        node-version: [20.x]\n-\n-    steps:\n-      - name: Checkout Source Files\n-        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n-        with:\n-          submodules: 'recursive'\n-\n-      - name: Create Image\n-        run: |\n-          docker build \\\n-            -t fcc-api \\\n-            -f docker/api/Dockerfile .\n-\n   build-new-api:\n     name: Build New Api (Container)\n     runs-on: ubuntu-22.04\n@@ -106,11 +87,11 @@ jobs:\n       - name: Create Image\n         run: |\n           docker build \\\n-            -t fcc-new-api \\\n-            -f docker/new-api/Dockerfile .\n+            -t fcc-api \\\n+            -f docker/api/Dockerfile .\n \n       - name: Save Image\n-        run: docker save fcc-new-api > api-artifact.tar\n+        run: docker save fcc-api > api-artifact.tar\n \n       - name: Upload Api Artifact\n         uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1"
        },
        {
            "sha": "68d3d4c994085472935767c1a637b539b8794abf",
            "filename": ".github/workflows/temporary-container-checks.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/.github%2Fworkflows%2Ftemporary-container-checks.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/.github%2Fworkflows%2Ftemporary-container-checks.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Ftemporary-container-checks.yml?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -50,7 +50,6 @@ jobs:\n             --build-arg SHOW_NEW_CURRICULUM=false \\\n             --build-arg GROWTHBOOK_URI=api_URI_from_Growthbook_dashboard \\\n             --build-arg FREECODECAMP_NODE_ENV=development \\\n-            -t fcc-client \\\n             -f docker/web/Dockerfile .\n \n   build-api:\n@@ -69,8 +68,7 @@ jobs:\n       - name: Create Image\n         run: |\n           docker build \\\n-            -t fcc-api \\\n-            -f docker/api/Dockerfile .\n+            -f docker/api-server/Dockerfile .\n \n   build-new-api:\n     name: Build New Api (Container)\n@@ -88,5 +86,4 @@ jobs:\n       - name: Create Image\n         run: |\n           docker build \\\n-            -t fcc-new-api \\\n-            -f docker/new-api/Dockerfile .\n+            -f docker/api/Dockerfile ."
        },
        {
            "sha": "dabaa2839865c438af935e616f1a671c80cef088",
            "filename": "docker-compose.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/docker-compose.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/docker-compose.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker-compose.yml?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -26,7 +26,7 @@ services:\n     depends_on:\n       - mongo\n       - mailhog\n-    image: fcc-new-api\n+    image: fcc-api\n     env_file:\n       - .env\n     environment:\n@@ -35,6 +35,4 @@ services:\n       - MONGOHQ_URL=mongodb://mongo:27017/freecodecamp?directConnection=true\n       - MAILHOG_HOST=mailhog\n     ports:\n-      # PORT is used by the new api, so we use the less generic API_PORT to\n-      # avoid conflicts.\n       - '3000:3000'"
        },
        {
            "sha": "f6cfbeef41cc23b6660927b0a5e698c03e58a3b7",
            "filename": "docker/api-server/Dockerfile",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/docker%2Fapi-server%2FDockerfile",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/docker%2Fapi-server%2FDockerfile",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker%2Fapi-server%2FDockerfile?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -0,0 +1,63 @@\n+FROM node:20-bookworm AS builder\n+# global installs need root permissions, so have to happen before we switch to\n+# the node user\n+RUN npm i -g pnpm@9\n+# node images create a non-root user that we can use\n+USER node\n+WORKDIR /home/node/build\n+\n+COPY --chown=node:node *.* .\n+COPY --chown=node:node api-server/ api-server/\n+COPY --chown=node:node shared/ shared/\n+COPY --chown=node:node tools/ tools/\n+COPY --chown=node:node curriculum/ curriculum/\n+# TODO: AFAIK it's just the intro translations. Those should be folded into the\n+# curriculum and then we can remove this.\n+COPY --chown=node:node client/ client/\n+\n+# We have to prevent pnpm from deduping peer dependencies because otherwise it\n+# will install all of the packages, not just api-server. Also, pnpm deploy is\n+# not useful since we need to install more than one package.\n+\n+RUN pnpm config set dedupe-peer-dependents false\n+RUN pnpm -F=api-server -F=tools/scripts/build -F=challenge-parser -F=curriculum -F=shared \\\n+  install --frozen-lockfile --ignore-scripts\n+\n+# The api needs to source curriculum.json and build:curriculum relies on the\n+# following env vars.\n+ARG SHOW_UPCOMING_CHANGES=false\n+ENV SHOW_UPCOMING_CHANGES=$SHOW_UPCOMING_CHANGES\n+ARG SHOW_NEW_CURRICULUM=false\n+ENV SHOW_NEW_CURRICULUM=$SHOW_NEW_CURRICULUM\n+RUN pnpm build:curriculum\n+\n+RUN pnpm build:server\n+\n+FROM node:20-bookworm AS deps\n+\n+WORKDIR /home/node/build\n+COPY --chown=node:node pnpm*.yaml .\n+COPY --chown=node:node api-server/package.json api-server/package.json\n+COPY --chown=node:node shared/package.json shared/package.json\n+\n+RUN npm i -g pnpm@9\n+# Prevent pnpm installing unnecessary packages (see above)\n+RUN pnpm config set dedupe-peer-dependents false\n+RUN pnpm -F=api-server -F=shared install --prod --ignore-scripts\n+\n+FROM node:20-alpine\n+RUN npm i -g pm2@4\n+USER node\n+WORKDIR /home/node/fcc\n+COPY --from=builder --chown=node:node /home/node/build/api-server/config/ api-server/config/\n+COPY --from=builder --chown=node:node /home/node/build/api-server/lib/ api-server/lib/\n+COPY --from=builder --chown=node:node /home/node/build/api-server/ecosystem.config.js api-server/ecosystem.config.js\n+COPY --from=builder --chown=node:node /home/node/build/api-server/package.json api-server/package.json\n+COPY --from=builder --chown=node:node /home/node/build/shared/ shared/\n+COPY --from=builder --chown=node:node /home/node/build/package.json package.json\n+COPY --from=deps --chown=node:node /home/node/build/node_modules/ node_modules/\n+COPY --from=deps --chown=node:node /home/node/build/api-server/node_modules/ api-server/node_modules/\n+COPY --from=deps --chown=node:node /home/node/build/shared/node_modules/ shared/node_modules/\n+\n+CMD [\"pm2-runtime\", \"start\", \"api-server/ecosystem.config.js\"]\n+"
        },
        {
            "sha": "406fed30829b84428b72b2f75576677f9166a8d4",
            "filename": "docker/api/Dockerfile",
            "status": "modified",
            "additions": 27,
            "deletions": 24,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7bb3381a461cbf02520ef38f025365aebac0e3f1/docker%2Fapi%2FDockerfile",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7bb3381a461cbf02520ef38f025365aebac0e3f1/docker%2Fapi%2FDockerfile",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker%2Fapi%2FDockerfile?ref=7bb3381a461cbf02520ef38f025365aebac0e3f1",
            "patch": "@@ -1,4 +1,5 @@\n FROM node:20-bookworm AS builder\n+RUN apt-get update && apt-get install -y jq\n # global installs need root permissions, so have to happen before we switch to\n # the node user\n RUN npm i -g pnpm@9\n@@ -7,57 +8,59 @@ USER node\n WORKDIR /home/node/build\n \n COPY --chown=node:node *.* .\n-COPY --chown=node:node api-server/ api-server/\n+COPY --chown=node:node api/ api/\n COPY --chown=node:node shared/ shared/\n COPY --chown=node:node tools/ tools/\n COPY --chown=node:node curriculum/ curriculum/\n # TODO: AFAIK it's just the intro translations. Those should be folded into the\n # curriculum and then we can remove this.\n COPY --chown=node:node client/ client/\n \n-# We have to prevent pnpm from deduping peer dependencies because otherwise it\n-# will install all of the packages, not just api-server. Also, pnpm deploy is\n-# not useful since we need to install more than one package.\n-\n RUN pnpm config set dedupe-peer-dependents false\n-RUN pnpm -F=api-server -F=tools/scripts/build -F=challenge-parser -F=curriculum -F=shared \\\n-  install --frozen-lockfile --ignore-scripts\n+# While we want to ignore scripts generally, we do need to generate the prisma\n+# client. Note: npx is the simplest way to generate the client without us having\n+# to have prisma as a prod dependency. The jq tricks are to ensure we're using\n+# the right version of prisma.\n+RUN pnpm install -F=api -F=curriculum -F tools/scripts/build -F challenge-parser \\\n+  --frozen-lockfile --ignore-scripts\n+RUN cd api && npx prisma@$(jq -r '.devDependencies.prisma' < package.json) generate\n \n # The api needs to source curriculum.json and build:curriculum relies on the\n # following env vars.\n ARG SHOW_UPCOMING_CHANGES=false\n ENV SHOW_UPCOMING_CHANGES=$SHOW_UPCOMING_CHANGES\n ARG SHOW_NEW_CURRICULUM=false\n ENV SHOW_NEW_CURRICULUM=$SHOW_NEW_CURRICULUM\n-RUN pnpm build:curriculum\n \n-RUN pnpm build:server\n+RUN pnpm build:curriculum\n+RUN pnpm -F=api build\n \n FROM node:20-bookworm AS deps\n+RUN apt-get update && apt-get install -y jq\n \n WORKDIR /home/node/build\n COPY --chown=node:node pnpm*.yaml .\n-COPY --chown=node:node api-server/package.json api-server/package.json\n-COPY --chown=node:node shared/package.json shared/package.json\n-\n+COPY --chown=node:node api/ api/\n+COPY --chown=node:node shared/ shared/\n RUN npm i -g pnpm@9\n-# Prevent pnpm installing unnecessary packages (see above)\n+\n+# Weirdly this config does not seem necessary for the new api (the same number\n+# of deps are installed in both cases), but I'm including it just for\n+# consistency.\n RUN pnpm config set dedupe-peer-dependents false\n-RUN pnpm -F=api-server -F=shared install --prod --ignore-scripts\n+RUN pnpm install --prod --ignore-scripts -F=shared -F=api --frozen-lockfile\n+RUN cd api && npx prisma@$(jq -r '.devDependencies.prisma' < package.json) generate\n \n-FROM node:20-alpine\n+FROM node:20-bookworm\n RUN npm i -g pm2@4\n USER node\n WORKDIR /home/node/fcc\n-COPY --from=builder --chown=node:node /home/node/build/api-server/config/ api-server/config/\n-COPY --from=builder --chown=node:node /home/node/build/api-server/lib/ api-server/lib/\n-COPY --from=builder --chown=node:node /home/node/build/api-server/ecosystem.config.js api-server/ecosystem.config.js\n-COPY --from=builder --chown=node:node /home/node/build/api-server/package.json api-server/package.json\n-COPY --from=builder --chown=node:node /home/node/build/shared/ shared/\n-COPY --from=builder --chown=node:node /home/node/build/package.json package.json\n+COPY --from=builder --chown=node:node /home/node/build/api/dist/ ./\n+COPY --from=builder --chown=node:node /home/node/build/api/package.json api/\n+COPY --from=builder --chown=node:node /home/node/build/shared/config/curriculum.json shared/config/\n+\n COPY --from=deps --chown=node:node /home/node/build/node_modules/ node_modules/\n-COPY --from=deps --chown=node:node /home/node/build/api-server/node_modules/ api-server/node_modules/\n COPY --from=deps --chown=node:node /home/node/build/shared/node_modules/ shared/node_modules/\n+COPY --from=deps --chown=node:node /home/node/build/api/node_modules/ api/node_modules/\n \n-CMD [\"pm2-runtime\", \"start\", \"api-server/ecosystem.config.js\"]\n-\n+CMD [\"pm2-runtime\", \"start\", \"-i\", \"0\",\"api/src/server.js\"]"
        },
        {
            "sha": "406fed30829b84428b72b2f75576677f9166a8d4",
            "filename": "docker/new-api/Dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 66,
            "changes": 66,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cb4061c2503153d6529725051cfea48084496159/docker%2Fnew-api%2FDockerfile",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cb4061c2503153d6529725051cfea48084496159/docker%2Fnew-api%2FDockerfile",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker%2Fnew-api%2FDockerfile?ref=cb4061c2503153d6529725051cfea48084496159",
            "patch": "@@ -1,66 +0,0 @@\n-FROM node:20-bookworm AS builder\n-RUN apt-get update && apt-get install -y jq\n-# global installs need root permissions, so have to happen before we switch to\n-# the node user\n-RUN npm i -g pnpm@9\n-# node images create a non-root user that we can use\n-USER node\n-WORKDIR /home/node/build\n-\n-COPY --chown=node:node *.* .\n-COPY --chown=node:node api/ api/\n-COPY --chown=node:node shared/ shared/\n-COPY --chown=node:node tools/ tools/\n-COPY --chown=node:node curriculum/ curriculum/\n-# TODO: AFAIK it's just the intro translations. Those should be folded into the\n-# curriculum and then we can remove this.\n-COPY --chown=node:node client/ client/\n-\n-RUN pnpm config set dedupe-peer-dependents false\n-# While we want to ignore scripts generally, we do need to generate the prisma\n-# client. Note: npx is the simplest way to generate the client without us having\n-# to have prisma as a prod dependency. The jq tricks are to ensure we're using\n-# the right version of prisma.\n-RUN pnpm install -F=api -F=curriculum -F tools/scripts/build -F challenge-parser \\\n-  --frozen-lockfile --ignore-scripts\n-RUN cd api && npx prisma@$(jq -r '.devDependencies.prisma' < package.json) generate\n-\n-# The api needs to source curriculum.json and build:curriculum relies on the\n-# following env vars.\n-ARG SHOW_UPCOMING_CHANGES=false\n-ENV SHOW_UPCOMING_CHANGES=$SHOW_UPCOMING_CHANGES\n-ARG SHOW_NEW_CURRICULUM=false\n-ENV SHOW_NEW_CURRICULUM=$SHOW_NEW_CURRICULUM\n-\n-RUN pnpm build:curriculum\n-RUN pnpm -F=api build\n-\n-FROM node:20-bookworm AS deps\n-RUN apt-get update && apt-get install -y jq\n-\n-WORKDIR /home/node/build\n-COPY --chown=node:node pnpm*.yaml .\n-COPY --chown=node:node api/ api/\n-COPY --chown=node:node shared/ shared/\n-RUN npm i -g pnpm@9\n-\n-# Weirdly this config does not seem necessary for the new api (the same number\n-# of deps are installed in both cases), but I'm including it just for\n-# consistency.\n-RUN pnpm config set dedupe-peer-dependents false\n-RUN pnpm install --prod --ignore-scripts -F=shared -F=api --frozen-lockfile\n-RUN cd api && npx prisma@$(jq -r '.devDependencies.prisma' < package.json) generate\n-\n-FROM node:20-bookworm\n-RUN npm i -g pm2@4\n-USER node\n-WORKDIR /home/node/fcc\n-COPY --from=builder --chown=node:node /home/node/build/api/dist/ ./\n-COPY --from=builder --chown=node:node /home/node/build/api/package.json api/\n-COPY --from=builder --chown=node:node /home/node/build/shared/config/curriculum.json shared/config/\n-\n-COPY --from=deps --chown=node:node /home/node/build/node_modules/ node_modules/\n-COPY --from=deps --chown=node:node /home/node/build/shared/node_modules/ shared/node_modules/\n-COPY --from=deps --chown=node:node /home/node/build/api/node_modules/ api/node_modules/\n-\n-CMD [\"pm2-runtime\", \"start\", \"-i\", \"0\",\"api/src/server.js\"]"
        }
    ],
    "stats": {
        "total": 262,
        "additions": 140,
        "deletions": 122
    }
}