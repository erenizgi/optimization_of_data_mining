{
    "author": "ShaunSHamilton",
    "message": "fix(client): fetch non-prod exam links on deploymentEnv (#63978)",
    "sha": "02928e10cb2b0cdcbf43354a3e98b7cb437d2207",
    "files": [
        {
            "sha": "6ae9b4a7302fb80eca726a89dbee166b2cf5cd30",
            "filename": "client/src/templates/Challenges/exam-download/show.tsx",
            "status": "modified",
            "additions": 71,
            "deletions": 12,
            "changes": 83,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/02928e10cb2b0cdcbf43354a3e98b7cb437d2207/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fshow.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/02928e10cb2b0cdcbf43354a3e98b7cb437d2207/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fshow.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fshow.tsx?ref=02928e10cb2b0cdcbf43354a3e98b7cb437d2207",
            "patch": "@@ -32,16 +32,22 @@ import {\n import { examAttempts } from '../../../utils/ajax';\n import MissingPrerequisites from '../exam/components/missing-prerequisites';\n import { isChallengeCompletedSelector } from '../redux/selectors';\n+import envData from '../../../../config/env.json';\n import { Attempts } from './attempts';\n import ExamTokenControls from './exam-token-controls';\n \n import './show.css';\n \n+const { deploymentEnv } = envData;\n+\n interface GitProps {\n   tag_name: string;\n   assets: {\n     browser_download_url: string;\n   }[];\n+  name: string;\n+  draft: boolean;\n+  prerelease: boolean;\n }\n \n const mapStateToProps = createSelector(\n@@ -154,23 +160,53 @@ function ShowExamDownload({\n   useEffect(() => {\n     async function checkLatestVersion() {\n       try {\n-        const response = await fetch(\n-          'https://api.github.com/repos/freeCodeCamp/exam-env/releases/latest'\n-        );\n-        if (response.ok) {\n+        let latest: GitProps;\n+\n+        if (deploymentEnv !== 'production') {\n+          const response = await fetch(\n+            'https://api.github.com/repos/freeCodeCamp/exam-env/releases'\n+          );\n+\n+          if (!response.ok) {\n+            setLatestVersion(null);\n+            return;\n+          }\n+\n+          const data = (await response.json()) as GitProps[];\n+          if (!data || data.length === 0) {\n+            setLatestVersion(null);\n+            return;\n+          }\n+          latest = getLatest(data);\n+        } else {\n+          const response = await fetch(\n+            'https://api.github.com/repos/freeCodeCamp/exam-env/releases/latest'\n+          );\n+          if (!response.ok) {\n+            setLatestVersion(null);\n+            return;\n+          }\n           const data = (await response.json()) as GitProps;\n-          const { tag_name, assets } = data;\n-          setLatestVersion(tag_name);\n-          const urls = assets.map(link => link.browser_download_url);\n-          setDownloadLink(handleDownloadLink(urls));\n-          setDownloadLinks(urls);\n+          if (!data) {\n+            setLatestVersion(null);\n+            return;\n+          }\n+          latest = data;\n         }\n+\n+        const { tag_name, assets } = latest;\n+        setLatestVersion(tag_name);\n+        const urls = assets.map(link => link.browser_download_url);\n+        setDownloadLink(handleDownloadLink(urls));\n+        setDownloadLinks(urls);\n       } catch {\n-        setLatestVersion('...');\n+        setLatestVersion(null);\n       }\n     }\n \n-    void checkLatestVersion();\n+    if (os.os) {\n+      void checkLatestVersion();\n+    }\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [os]);\n \n@@ -235,7 +271,6 @@ function ShowExamDownload({\n                 version: latestVersion || '...'\n               })}\n             </p>\n-            {/* TODO: confirm this works on MacOS */}\n             <Button href={'exam-environment://'}>\n               {t('exam.open-exam-application')}\n             </Button>\n@@ -283,6 +318,30 @@ function ShowExamDownload({\n   );\n }\n \n+function getLatest(releases: GitProps[]): GitProps {\n+  switch (deploymentEnv) {\n+    case 'staging':\n+      return (\n+        releases.find(r => {\n+          return !r.draft && r.name.endsWith('/staging');\n+        }) || releases[0]\n+      );\n+    // Currently, this is never the case\n+    case 'development':\n+      return (\n+        releases.find(r => {\n+          return !r.draft && r.name.endsWith('/development');\n+        }) || releases[0]\n+      );\n+    default:\n+      return (\n+        releases.find(r => {\n+          return !r.prerelease && !r.draft && r.name.endsWith('/production');\n+        }) || releases[0]\n+      );\n+  }\n+}\n+\n export default connect(mapStateToProps)(withTranslation()(ShowExamDownload));\n \n // GraphQL"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 71,
        "deletions": 12
    }
}