{
    "author": "ShaunSHamilton",
    "message": "fix(api): add 401 to non user for exam routes (#64396)",
    "sha": "c8395eb1db5f5a6c0331998f37c815e611d9eabd",
    "files": [
        {
            "sha": "90247d0ff3ca8f279b54d91ce63d6077322e7bef",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=c8395eb1db5f5a6c0331998f37c815e611d9eabd",
            "patch": "@@ -224,6 +224,7 @@ export const build = async (\n \n   void fastify.register(function (fastify, _opts, done) {\n     fastify.addHook('onRequest', fastify.authorizeExamEnvironmentToken);\n+    fastify.addHook('onRequest', fastify.send401IfNoUser);\n \n     void fastify.register(examEnvironmentValidatedTokenRoutes);\n     done();"
        },
        {
            "sha": "498643c1d7e3b30a60c8dccfd0477cf39d2a4db7",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 12,
            "changes": 83,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=c8395eb1db5f5a6c0331998f37c815e611d9eabd",
            "patch": "@@ -24,6 +24,20 @@ import { isObjectID } from '../../utils/validation.js';\n  */\n export const examEnvironmentValidatedTokenRoutes: FastifyPluginCallbackTypebox =\n   (fastify, _options, done) => {\n+    fastify.setErrorHandler((error, req, res) => {\n+      // If the error does not match the format {code: string; message: string}, coerce into:\n+      if (\n+        !Object.hasOwnProperty.call(error, 'code') ||\n+        !Object.hasOwnProperty.call(error, 'message')\n+      ) {\n+        const logger = fastify.log.child({ req, res });\n+        logger.error(error, 'Unhandled error in exam environment routes.');\n+        const str = JSON.stringify(error);\n+        res.code(500);\n+        res.send(ERRORS.FCC_ERR_UNKNOWN_STATE(str));\n+      }\n+    });\n+\n     fastify.get(\n       '/exam-environment/exams',\n       {\n@@ -182,7 +196,16 @@ async function postExamGeneratedExamHandler(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n-  logger.info({ userId: req.user?.id });\n+  const user = req.user;\n+\n+  if (!user) {\n+    logger.error('No user found in request.');\n+    this.Sentry.captureException('No user found in request.');\n+    void reply.code(500);\n+    return reply.send(ERRORS.FCC_ERR_UNKNOWN_STATE('No user found.'));\n+  }\n+\n+  logger.info({ userId: user.id });\n   // Get exam from DB\n   const examId = req.body.examId;\n   const maybeExam = await mapErr(\n@@ -218,7 +241,6 @@ async function postExamGeneratedExamHandler(\n   }\n \n   // Check user has completed prerequisites\n-  const user = req.user!;\n   const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n \n   if (!isExamPrerequisitesMet) {\n@@ -521,10 +543,18 @@ async function postExamAttemptHandler(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n-  logger.info({ userId: req.user?.id });\n-  const { attempt } = req.body;\n+  const user = req.user;\n+\n+  if (!user) {\n+    logger.error('No user found in request.');\n+    this.Sentry.captureException('No user found in request.');\n+    void reply.code(500);\n+    return reply.send(ERRORS.FCC_ERR_UNKNOWN_STATE('No user found.'));\n+  }\n+\n+  logger.info({ userId: user.id });\n \n-  const user = req.user!;\n+  const { attempt } = req.body;\n \n   const maybeAttempts = await mapErr(\n     this.prisma.examEnvironmentExamAttempt.findMany({\n@@ -704,9 +734,17 @@ export async function getExams(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n-  logger.info({ userId: req.user?.id });\n+  const user = req.user;\n+\n+  if (!user) {\n+    logger.error('No user found in request.');\n+    this.Sentry.captureException('No user found in request.');\n+    void reply.code(500);\n+    return reply.send(ERRORS.FCC_ERR_UNKNOWN_STATE('No user found.'));\n+  }\n+\n+  logger.info({ userId: user.id });\n \n-  const user = req.user!;\n   const maybeExams = await mapErr(\n     this.prisma.examEnvironmentExam.findMany({\n       where: {\n@@ -869,9 +907,16 @@ export async function getExamAttemptsHandler(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n-  logger.info({ userId: req.user?.id });\n+  const user = req.user;\n+\n+  if (!user) {\n+    logger.error('No user found in request.');\n+    this.Sentry.captureException('No user found in request.');\n+    void reply.code(500);\n+    return reply.send(ERRORS.FCC_ERR_UNKNOWN_STATE('No user found.'));\n+  }\n \n-  const user = req.user!;\n+  logger.info({ userId: user.id });\n \n   // Send all relevant exam attempts\n   const envExamAttempts = [];\n@@ -929,9 +974,16 @@ export async function getExamAttemptHandler(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n-  logger.info({ userId: req.user?.id });\n+  const user = req.user;\n+\n+  if (!user) {\n+    logger.error('No user found in request.');\n+    this.Sentry.captureException('No user found in request.');\n+    void reply.code(500);\n+    return reply.send(ERRORS.FCC_ERR_UNKNOWN_STATE('No user found.'));\n+  }\n+  logger.info({ userId: user.id });\n \n-  const user = req.user!;\n   const { attemptId } = req.params;\n \n   // If attempt id is given, only return that attempt\n@@ -988,8 +1040,15 @@ export async function getExamAttemptsByExamIdHandler(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n+  const user = req.user;\n+\n+  if (!user) {\n+    logger.error('No user found in request.');\n+    this.Sentry.captureException('No user found in request.');\n+    void reply.code(500);\n+    return reply.send(ERRORS.FCC_ERR_UNKNOWN_STATE('No user found.'));\n+  }\n \n-  const user = req.user!;\n   const { examId } = req.params;\n \n   logger.info({ examId, userId: user.id });"
        },
        {
            "sha": "7ca34379c5cac44fc2d3d2caaf661d6d2a6654c6",
            "filename": "api/src/exam-environment/utils/errors.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fexam-environment%2Futils%2Ferrors.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fexam-environment%2Futils%2Ferrors.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Ferrors.ts?ref=c8395eb1db5f5a6c0331998f37c815e611d9eabd",
            "patch": "@@ -39,7 +39,8 @@ export const ERRORS = {\n     'FCC_ENOENT_EXAM_ENVIRONMENT_GENERATED_EXAM',\n     '%s'\n   ),\n-  FCC_EINVAL_EXAM_ID: createError('FCC_EINVAL_EXAM_ID', '%s')\n+  FCC_EINVAL_EXAM_ID: createError('FCC_EINVAL_EXAM_ID', '%s'),\n+  FCC_ERR_UNKNOWN_STATE: createError('FCC_ERR_UNKNOWN_STATE', '%s')\n };\n \n /**"
        },
        {
            "sha": "0acf105d2c1ef4f9dedb3374b319c700b7e2a8bd",
            "filename": "api/src/plugins/auth.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fplugins%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c8395eb1db5f5a6c0331998f37c815e611d9eabd/api%2Fsrc%2Fplugins%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth.ts?ref=c8395eb1db5f5a6c0331998f37c815e611d9eabd",
            "patch": "@@ -156,9 +156,12 @@ const auth: FastifyPluginCallback = (fastify, _options, done) => {\n       });\n \n     if (!token) {\n-      return {\n-        message: 'Token not found'\n-      };\n+      void reply.code(403);\n+      return reply.send(\n+        ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(\n+          'Provided token is revoked.'\n+        )\n+      );\n     }\n     // We're using token.userId since it's possible for the user record to be\n     // malformed and for prisma to throw while trying to find the user."
        }
    ],
    "stats": {
        "total": 96,
        "additions": 80,
        "deletions": 16
    }
}