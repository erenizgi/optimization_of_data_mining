{
    "author": "raisedadead",
    "message": "fix: update deployment workflows (#58817)",
    "sha": "db5201f5b2eca7c7418e04693d0581da1f824264",
    "files": [
        {
            "sha": "c268d963c76ab7dedb25427660f6c27bb34fcc0f",
            "filename": ".github/workflows/deploy.yml",
            "status": "modified",
            "additions": 58,
            "deletions": 68,
            "changes": 126,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db5201f5b2eca7c7418e04693d0581da1f824264/.github%2Fworkflows%2Fdeploy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db5201f5b2eca7c7418e04693d0581da1f824264/.github%2Fworkflows%2Fdeploy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy.yml?ref=db5201f5b2eca7c7418e04693d0581da1f824264",
            "patch": "@@ -1,49 +1,63 @@\n-name: CD -- Deploy - API (Docker Swarm)\n+name: CD -- Deploy - API\n \n on:\n   workflow_dispatch:\n+    inputs:\n+      fcc_api_log_level:\n+        description: 'Log level for the API'\n+        type: choice\n+        options:\n+          - debug\n+          - info\n+          - warn\n+        default: info\n \n jobs:\n   static:\n+    name: Set Static Data\n     runs-on: ubuntu-24.04\n     outputs:\n       site_tld: ${{ steps.static_data.outputs.site_tld }}\n-      environment_long: ${{ steps.static_data.outputs.environment_long }}\n-      environment_short: ${{ steps.static_data.outputs.environment_short }}\n-\n+      environment: ${{ steps.static_data.outputs.environment }}\n+      fcc_api_log_level: ${{ steps.static_data.outputs.fcc_api_log_level }}\n     steps:\n-      - name: Set site_tld\n+      - name: Set Static Data\n         id: static_data\n         run: |\n           if [ \"${{ github.ref }}\" == \"refs/heads/prod-staging\" ]; then\n             echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-            echo \"environment_long=staging\" >> $GITHUB_OUTPUT\n-            echo \"environment_short=stg\" >> $GITHUB_OUTPUT\n+            echo \"environment=stg\" >> $GITHUB_OUTPUT\n+            echo \"fcc_api_log_level=${{ inputs.fcc_api_log_level || 'info' }}\" >> $GITHUB_OUTPUT\n           elif [ \"${{ github.ref }}\" == \"refs/heads/prod-current\" ]; then\n             echo \"site_tld=org\" >> $GITHUB_OUTPUT\n-            echo \"environment_long=production\" >> $GITHUB_OUTPUT\n-            echo \"environment_short=prd\" >> $GITHUB_OUTPUT\n+            echo \"environment=prd\" >> $GITHUB_OUTPUT\n+            echo \"fcc_api_log_level=${{ inputs.fcc_api_log_level || 'info' }}\" >> $GITHUB_OUTPUT\n           else\n             echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-            echo \"environment_long=staging\" >> $GITHUB_OUTPUT\n-            echo \"environment_short=stg\" >> $GITHUB_OUTPUT\n+            echo \"environment=stg\" >> $GITHUB_OUTPUT\n+            echo \"fcc_api_log_level=${{ inputs.fcc_api_log_level || 'info' }}\" >> $GITHUB_OUTPUT\n           fi\n \n   build:\n-    name: Build & Push Docker Image\n+    name: Build & Push\n     needs: static\n     uses: ./.github/workflows/docker-docr.yml\n     with:\n       site_tld: ${{ needs.static.outputs.site_tld }}\n       app: api\n+    secrets: inherit\n \n   deploy:\n+    name: Deploy to Docker Swarm -- ${{ needs.static.outputs.environment }}\n     runs-on: ubuntu-24.04\n     needs: [static, build]\n+    env:\n+      TS_USERNAME: ${{ secrets.TS_USERNAME }}\n+      TS_MACHINE_NAME: ${{ secrets.TS_MACHINE_NAME }}\n     permissions:\n       deployments: write\n     environment:\n-      name: ${{ needs.static.outputs.environment_long }}\n+      name: ${{ needs.static.outputs.environment }}\n       url: https://api.freecodecamp.${{ needs.static.outputs.site_tld }}/status/ping?version=${{ needs.build.outputs.tagname }}\n \n     steps:\n@@ -66,73 +80,49 @@ jobs:\n \n       - name: Check connection\n         run: |\n-          tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Machine not found\"; exit 1; }\n+          tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Error: Machine not found\"; exit 1; }\n           ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n \n       - name: Deploy with Docker Stack\n         env:\n-          # These are set in the \"Environment\" secrets\n-          API_LOCATION: ${{ secrets.API_LOCATION }}\n-          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}\n-          AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}\n-          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}\n-          COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}\n-          COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}\n-          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}\n-          FCC_API_LOG_LEVEL: ${{ secrets.FCC_API_LOG_LEVEL }}\n-          GROWTHBOOK_FASTIFY_API_HOST: ${{ secrets.GROWTHBOOK_FASTIFY_API_HOST }}\n-          GROWTHBOOK_FASTIFY_CLIENT_KEY: ${{ secrets.GROWTHBOOK_FASTIFY_CLIENT_KEY }}\n-          HOME_LOCATION: ${{ secrets.HOME_LOCATION }}\n-          JWT_SECRET: ${{ secrets.JWT_SECRET }}\n-          MONGOHQ_URL: ${{ secrets.MONGOHQ_URL }}\n-          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}\n-          SES_ID: ${{ secrets.SES_ID }}\n-          SES_SECRET: ${{ secrets.SES_SECRET }}\n-          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}\n+          # These are set in the \"Environment\" specifc secrets\n+          AGE_ENCRYPTED_ASC_SECRETS: ${{ secrets.AGE_ENCRYPTED_ASC_SECRETS }}\n+          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}\n           # These are set in the static job above\n-          DEPLOYMENT_ENV: ${{ needs.static.outputs.site_tld }}\n+          STACK_NAME: ${{ needs.static.outputs.environment }}-api\n           DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n-          SENTRY_ENVIRONMENT: api-${{ needs.static.outputs.site_tld }}\n-          STACK_NAME: ${{ needs.static.outputs.environment_short }}-api\n+          FCC_API_LOG_LEVEL: ${{ needs.static.outputs.fcc_api_log_level }}\n         run: |\n           ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n+            set -e\n+            cd /home/${TS_USERNAME}/docker-swarm-config/stacks/api || { echo \"Error: Failed to change directory\"; exit 1; }\n+            which age > /dev/null || { echo \"Error: age not installed\"; exit 1; }\n \n-            cd /home/${TS_USERNAME}/docker-swarm-config/stacks/api || { echo \"Failed to change directory\"; exit 1; }\n-            echo \"Debug: Current directory: \\$(pwd)\"\n-\n-            echo \"API_LOCATION=${API_LOCATION}\" >> .env.tmp\n-            echo \"AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}\" >> .env.tmp\n-            echo \"AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}\" >> .env.tmp\n-            echo \"AUTH0_DOMAIN=${AUTH0_DOMAIN}\" >> .env.tmp\n-            echo \"COOKIE_DOMAIN=${COOKIE_DOMAIN}\" >> .env.tmp\n-            echo \"COOKIE_SECRET=${COOKIE_SECRET}\" >> .env.tmp\n-            echo \"DOCKER_REGISTRY=${DOCKER_REGISTRY}\" >> .env.tmp\n-            echo \"FCC_API_LOG_LEVEL=${FCC_API_LOG_LEVEL}\" >> .env.tmp\n-            echo \"GROWTHBOOK_FASTIFY_API_HOST=${GROWTHBOOK_FASTIFY_API_HOST}\" >> .env.tmp\n-            echo \"GROWTHBOOK_FASTIFY_CLIENT_KEY=${GROWTHBOOK_FASTIFY_CLIENT_KEY}\" >> .env.tmp\n-            echo \"HOME_LOCATION=${HOME_LOCATION}\" >> .env.tmp\n-            echo \"JWT_SECRET=${JWT_SECRET}\" >> .env.tmp\n-            echo \"MONGOHQ_URL=${MONGOHQ_URL}\" >> .env.tmp\n-            echo \"SENTRY_DSN=${SENTRY_DSN}\" >> .env.tmp\n-            echo \"SES_ID=${SES_ID}\" >> .env.tmp\n-            echo \"SES_SECRET=${SES_SECRET}\" >> .env.tmp\n-            echo \"STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}\" >> .env.tmp\n+            # Decrypt secrets\n+            echo \"${AGE_ENCRYPTED_ASC_SECRETS}\" > secrets.age.asc\n+            echo \"${AGE_SECRET_KEY}\" > age.key && chmod 600 age.key\n+            age --identity age.key --decrypt secrets.age.asc > .env\n+            rm -f age.key secrets.age.asc\n \n-            echo \"DEPLOYMENT_ENV=${DEPLOYMENT_ENV}\" >> .env.tmp\n-            echo \"DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}\" >> .env.tmp\n-            echo \"SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}\" >> .env.tmp\n+            # Add deployment variables\n+            {\n+              echo \"DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}\"\n+              echo \"FCC_API_LOG_LEVEL=${FCC_API_LOG_LEVEL}\"\n+            } >> .env\n \n-            set -a\n-            source .env.tmp || { echo \"Failed to source .env.tmp\"; exit 1; }\n-            set +a\n-            rm -f .env.tmp\n+            # Export environment variables with proper escaping\n+            while IFS='=' read -r key value; do\n+              if [[ -n \\$key && ! \\$key =~ ^# ]]; then\n+                export \"\\${key}=\\${value}\"\n+              fi\n+            done < .env\n+            rm -f .env\n \n-            echo \"Debug: Sanity check variables: \"\n-            env | grep -E '^DEPLOYMENT' || { echo 'Vars not found'; exit 1; }\n-            echo \"Debug: Sanity check config: \"\n-            docker stack config -c stack-api.yml | rg 'DOMAIN' || { echo 'Invalid stack config'; exit 1; }\n+            # Validate environment and config\n+            env | grep -E 'DOMAIN|DEPLOYMENT' || { echo \"Error: Required environment variables not found\"; exit 1; }\n+            docker stack config -c stack-api.yml > /dev/null || { echo \"Error: Invalid stack configuration\"; exit 1; }\n \n-            # Dump the stack config to a file for debugging, this will be replaced with a deploy command\n-            docker stack config -c stack-api.yml > /tmp/stack-api-${DEPLOYMENT_VERSION}.yml\n+            # Deploy\n+            docker stack deploy -c stack-api.yml --prune --with-registry-auth --detach=false ${STACK_NAME}\n           EOF\n         shell: bash"
        },
        {
            "sha": "9681c071304133716b62d46c970b6663c33ac302",
            "filename": ".github/workflows/docker-docr.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db5201f5b2eca7c7418e04693d0581da1f824264/.github%2Fworkflows%2Fdocker-docr.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db5201f5b2eca7c7418e04693d0581da1f824264/.github%2Fworkflows%2Fdocker-docr.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdocker-docr.yml?ref=db5201f5b2eca7c7418e04693d0581da1f824264",
            "patch": "@@ -33,7 +33,7 @@ on:\n \n jobs:\n   build:\n-    name: Build (Image)\n+    name: Build & Push\n     runs-on: ubuntu-24.04\n     permissions:\n       contents: read"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 59,
        "deletions": 69
    }
}