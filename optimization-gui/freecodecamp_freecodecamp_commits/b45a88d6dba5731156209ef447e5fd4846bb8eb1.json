{
    "author": "ojeytonwilliams",
    "message": "refactor(api): use reject user-agents early (#55491)",
    "sha": "b45a88d6dba5731156209ef447e5fd4846bb8eb1",
    "files": [
        {
            "sha": "d0c71e34cf0e900a035f4786fbf12fff0de56572",
            "filename": "api/src/routes/user.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b45a88d6dba5731156209ef447e5fd4846bb8eb1/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b45a88d6dba5731156209ef447e5fd4846bb8eb1/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.test.ts?ref=b45a88d6dba5731156209ef447e5fd4846bb8eb1",
            "patch": "@@ -1227,6 +1227,17 @@ Thanks and regards,\n       });\n \n       describe('GET', () => {\n+        test('returns 400 status code if the user agent is blocked', async () => {\n+          const response = await superGet(\n+            '/api/users/get-public-profile?username=public-user'\n+          ).set('User-Agent', 'curl');\n+\n+          expect(response.text).toBe(\n+            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n+          );\n+          expect(response.statusCode).toBe(400);\n+        });\n+\n         test('returns 400 status code if the username param is missing', async () => {\n           const res = await superGet('/api/users/get-public-profile');\n           // TODO(Post-MVP): return something more informative"
        },
        {
            "sha": "7f94f6e93524316db7986b0e3effacb81cb9be82",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 13,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b45a88d6dba5731156209ef447e5fd4846bb8eb1/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b45a88d6dba5731156209ef447e5fd4846bb8eb1/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=b45a88d6dba5731156209ef447e5fd4846bb8eb1",
            "patch": "@@ -653,21 +653,23 @@ export const userPublicGetRoutes: FastifyPluginCallbackTypebox = (\n   fastify.get(\n     '/api/users/get-public-profile',\n     {\n-      schema: schemas.getPublicProfile\n+      schema: schemas.getPublicProfile,\n+      onRequest: (req, reply, done) => {\n+        const userAgent = req.headers['user-agent'];\n+\n+        if (\n+          userAgent &&\n+          blockedUserAgentParts.some(ua => userAgent.toLowerCase().includes(ua))\n+        ) {\n+          void reply.code(400);\n+          void reply.send(\n+            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n+          );\n+        }\n+        done();\n+      }\n     },\n     async (req, reply) => {\n-      const userAgent = req.headers['user-agent'];\n-\n-      if (\n-        userAgent &&\n-        blockedUserAgentParts.some(ua => userAgent.toLowerCase().includes(ua))\n-      ) {\n-        void reply.code(400);\n-        return reply.send(\n-          'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n-        );\n-      }\n-\n       // TODO(Post-MVP): look for duplicates unless we can make username unique in the db.\n       const user = await fastify.prisma.user.findFirst({\n         where: { username: req.query.username }"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 26,
        "deletions": 13
    }
}