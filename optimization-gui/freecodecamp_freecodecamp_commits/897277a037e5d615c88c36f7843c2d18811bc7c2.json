{
    "author": "raisedadead",
    "message": "refactor(GHA): update workflow to be consistent with legacy",
    "sha": "897277a037e5d615c88c36f7843c2d18811bc7c2",
    "files": [
        {
            "sha": "95e368c7e85966a6fb553a1c35d0addb0bc28420",
            "filename": ".github/workflows/deploy.yml",
            "status": "modified",
            "additions": 128,
            "deletions": 58,
            "changes": 186,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/897277a037e5d615c88c36f7843c2d18811bc7c2/.github%2Fworkflows%2Fdeploy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/897277a037e5d615c88c36f7843c2d18811bc7c2/.github%2Fworkflows%2Fdeploy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy.yml?ref=897277a037e5d615c88c36f7843c2d18811bc7c2",
            "patch": "@@ -3,70 +3,90 @@ name: CD - Deploy - API\n on:\n   workflow_dispatch:\n     inputs:\n-      fcc_api_log_level:\n+      api_log_lvl:\n         description: 'Log level for the API'\n         type: choice\n         options:\n           - debug\n           - info\n           - warn\n         default: info\n+  workflow_run:\n+    workflows: [CI - Node.js]\n+    types:\n+      - completed\n+    branches:\n+      - prod-*\n \n jobs:\n-  static:\n-    name: Set Static Data\n+  setup-jobs:\n+    name: Setup Jobs\n     runs-on: ubuntu-22.04\n     outputs:\n-      site_tld: ${{ steps.static_data.outputs.site_tld }}\n-      environment: ${{ steps.static_data.outputs.environment }}\n-      fcc_api_log_level: ${{ steps.static_data.outputs.fcc_api_log_level }}\n+      site_tld: ${{ steps.setup.outputs.site_tld }}\n+      tgt_env_short: ${{ steps.setup.outputs.tgt_env_short }}\n+      tgt_env_long: ${{ steps.setup.outputs.tgt_env_long }}\n+      api_log_lvl: ${{ steps.setup.outputs.api_log_lvl }}\n     steps:\n-      - name: Set Static Data\n-        id: static_data\n+      - name: Setup\n+        id: setup\n         run: |\n-          if [ \"${{ github.ref }}\" == \"refs/heads/prod-staging\" ]; then\n-            echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-            echo \"environment=stg\" >> $GITHUB_OUTPUT\n-            echo \"fcc_api_log_level=${{ inputs.fcc_api_log_level || 'info' }}\" >> $GITHUB_OUTPUT\n-          elif [ \"${{ github.ref }}\" == \"refs/heads/prod-current\" ]; then\n-            echo \"site_tld=org\" >> $GITHUB_OUTPUT\n-            echo \"environment=prd\" >> $GITHUB_OUTPUT\n-            echo \"fcc_api_log_level=${{ inputs.fcc_api_log_level || 'info' }}\" >> $GITHUB_OUTPUT\n+          if [[ \"${{ github.event_name }}\" == \"workflow_run\" && \"${{ github.event.workflow_run.conclusion }}\" != \"success\" ]]; then\n+            echo \"Node.js tests failed in the triggering workflow run. Check logs in its workflow run. Exiting.\"\n+            exit 1\n+          fi\n+\n+          if [[ \"${{ github.event_name }}\" == \"workflow_run\" ]]; then\n+            BRANCH=\"${{ github.event.workflow_run.head_branch }}\"\n           else\n-            echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-            echo \"environment=stg\" >> $GITHUB_OUTPUT\n-            echo \"fcc_api_log_level=${{ inputs.fcc_api_log_level || 'info' }}\" >> $GITHUB_OUTPUT\n+            BRANCH=\"${{ github.ref_name }}\"\n           fi\n \n+          echo \"Current branch: $BRANCH\"\n+\n+          case \"$BRANCH\" in\n+            \"prod-current\")\n+              echo \"site_tld=org\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_short=prd\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_long=production\" >> $GITHUB_OUTPUT\n+              echo \"api_log_lvl=${{ inputs.api_log_lvl || 'info' }}\" >> $GITHUB_OUTPUT\n+              ;;\n+            *)\n+              echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_short=stg\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_long=staging\" >> $GITHUB_OUTPUT\n+              echo \"api_log_lvl=${{ inputs.api_log_lvl || 'info' }}\" >> $GITHUB_OUTPUT\n+              ;;\n+          esac\n+\n   build:\n     name: Build & Push\n-    needs: static\n+    needs: setup-jobs\n     uses: ./.github/workflows/docker-docr.yml\n     with:\n-      site_tld: ${{ needs.static.outputs.site_tld }}\n+      site_tld: ${{ needs.setup-jobs.outputs.site_tld }}\n       app: api\n     secrets: inherit\n \n   deploy:\n-    name: Deploy to Docker Swarm -- ${{ needs.static.outputs.environment }}\n+    name: Deploy to Docker Swarm -- ${{ needs.setup-jobs.outputs.tgt_env_short }}\n     runs-on: ubuntu-22.04\n-    needs: [static, build]\n+    needs: [setup-jobs, build]\n     env:\n       TS_USERNAME: ${{ secrets.TS_USERNAME }}\n       TS_MACHINE_NAME: ${{ secrets.TS_MACHINE_NAME }}\n     permissions:\n       deployments: write\n     environment:\n-      name: ${{ needs.static.outputs.environment }}\n-      url: https://api.freecodecamp.${{ needs.static.outputs.site_tld }}/status/ping?version=${{ needs.build.outputs.tagname }}\n+      name: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api\n \n     steps:\n       - name: Setup and connect to Tailscale network\n         uses: tailscale/github-action@v3\n         with:\n           oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}\n           oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}\n-          hostname: gha-${{needs.static.outputs.environment}}-api-ci-${{ github.run_id }}\n+          hostname: gha-${{needs.setup-jobs.outputs.tgt_env_short}}-api-ci-${{ github.run_id }}\n           tags: tag:ci\n           version: latest\n \n@@ -86,47 +106,97 @@ jobs:\n \n       - name: Deploy with Docker Stack\n         env:\n-          # These are set in the \"Environment\" specifc secrets\n           AGE_ENCRYPTED_ASC_SECRETS: ${{ secrets.AGE_ENCRYPTED_ASC_SECRETS }}\n           AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}\n+          # These are set in the \"Environment\" specifc secrets\n+          # DOCKER_REGISTRY\n+          # MONGOHQ_URL\n+          # SENTRY_DSN\n+          # SENTRY_ENVIRONMENT\n+          # AUTH0_CLIENT_ID\n+          # AUTH0_CLIENT_SECRET\n+          # AUTH0_DOMAIN\n+          # JWT_SECRET\n+          # COOKIE_SECRET\n+          # COOKIE_DOMAIN\n+          # SES_ID\n+          # SES_SECRET\n+          # GROWTHBOOK_FASTIFY_API_HOST\n+          # GROWTHBOOK_FASTIFY_CLIENT_KEY\n+          # HOME_LOCATION\n+          # API_LOCATION\n+          # STRIPE_SECRET_KEY\n           # These are set in the static job above\n-          STACK_NAME: ${{ needs.static.outputs.environment }}-api\n+          STACK_NAME: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api\n           DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n-          FCC_API_LOG_LEVEL: ${{ needs.static.outputs.fcc_api_log_level }}\n+          DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.site_tld }}\n+          FCC_API_LOG_LEVEL: ${{ needs.setup-jobs.outputs.api_log_lvl }}\n         run: |\n           REMOTE_SCRIPT=\"\n-          set -e\n-          echo -e '\\nLOG:Deploying API to \\$TS_MACHINE_NAME...'\n-          cd /home/\\${TS_USERNAME}/docker-swarm-config/stacks/api || { echo \\\"Error: Failed to change directory\\\"; exit 1; }\n-          which age > /dev/null || { echo \\\"Error: age not installed\\\"; exit 1; }\n-\n-          echo -e '\\nLOG:Decrypting secrets...'\n-          echo \\\"\\${AGE_ENCRYPTED_ASC_SECRETS}\\\" > secrets.age.asc\n-          echo \\\"\\${AGE_SECRET_KEY}\\\" > age.key && chmod 600 age.key\n-          age --identity age.key --decrypt secrets.age.asc > .env\n-          rm -f age.key secrets.age.asc\n-\n-          echo -e '\\nLOG:Adding deployment variables...'\n-          {\n-            echo \\\"DEPLOYMENT_VERSION=\\${DEPLOYMENT_VERSION}\\\"\n-            echo \\\"FCC_API_LOG_LEVEL=\\${FCC_API_LOG_LEVEL}\\\"\n-          } >> .env\n-\n-          echo -e '\\nLOG:Exporting environment variables...'\n-          while IFS='=' read -r key value; do\n-            if [[ -n \\$key && ! \\$key =~ ^# ]]; then\n-              export \\\"\\${key}=\\${value}\\\"\n+            set -e\n+            echo -e '\\nLOG:Deploying API to $TS_MACHINE_NAME...'\n+            cd /home/$TS_USERNAME/docker-swarm-config/stacks/api || { echo \\\"Error: Failed to change directory\\\"; exit 1; }\n+            which age > /dev/null || { echo \\\"Error: age not installed\\\"; exit 1; }\n+\n+            echo -e '\\nLOG:Decrypting secrets...'\n+            echo \\\"$AGE_ENCRYPTED_ASC_SECRETS\\\" > secrets.age.asc\n+            echo \\\"$AGE_SECRET_KEY\\\" > age.key && chmod 600 age.key\n+            age --identity age.key --decrypt secrets.age.asc > .env\n+            rm -f age.key secrets.age.asc\n+\n+            echo -e '\\nLOG:Cleaning up .env file...'\n+            touch .env.tmp\n+            while IFS= read -r line; do\n+              if [[ \\$line =~ ^[A-Za-z0-9_]+=.*$ ]]; then\n+                # Extract the key (part before the first =)\n+                key=\\${line%%=*}\n+                # Remove any previous line with this key\n+                sed -i \\\"/^\\${key}=/d\\\" .env.tmp\n+              fi\n+              # Append the current line\n+              echo \\\"\\$line\\\" >> .env.tmp\n+            done < .env\n+            mv .env.tmp .env\n+\n+            echo -e '\\nLOG:Adding deployment variables...'\n+            {\n+              echo \\\"DEPLOYMENT_VERSION=$DEPLOYMENT_VERSION\\\"\n+              echo \\\"DEPLOYMENT_ENV=$DEPLOYMENT_ENV\\\"\n+              echo \\\"FCC_API_LOG_LEVEL=$FCC_API_LOG_LEVEL\\\"\n+            } >> .env\n+\n+            echo -e '\\nLOG:Sourcing environment...'\n+            while IFS='=' read -r key value; do\n+              if [[ -n \\\"\\$key\\\" && ! \\\"\\$key\\\" =~ ^# ]]; then\n+                export \\\"\\${key}=\\${value}\\\"\n+              fi\n+            done < .env\n+            rm -rf .env\n+\n+            echo -e '\\nLOG:Validating environment...'\n+            if [[ -z \\\"\\$DOCKER_REGISTRY\\\" || -z \\\"\\$DEPLOYMENT_ENV\\\" || -z \\\"\\$DEPLOYMENT_VERSION\\\" || -z \\\"\\$MONGOHQ_URL\\\" || -z \\\"\\$FCC_API_LOG_LEVEL\\\" ]]; then\n+              echo \\\"Error: Missing required environment variables\\\"\n+              exit 1\n+            fi\n+            if [[ \\\"\\$DEPLOYMENT_VERSION\\\" != \\\"$DEPLOYMENT_VERSION\\\" ]]; then\n+              echo \\\"Error: Version mismatch. Expected: $DEPLOYMENT_VERSION, Got: \\$DEPLOYMENT_VERSION\\\"\n+              exit 1\n+            fi\n+            env | grep -E 'DOMAIN|DEPLOYMENT' || { echo \\\"Error: Required environment variables not found\\\"; exit 1; }\n+\n+            echo -e '\\nLOG:Checking stack configuration...'\n+            CONFIG_OUTPUT=\"/dev/null\"\n+            if [[ \\\"\\$FCC_API_LOG_LEVEL\\\" == \\\"debug\\\" ]]; then\n+              CONFIG_FILENAME=\"debug-docker-stack-config-\\${DEPLOYMENT_VERSION}.yml\"\n+              echo -e '\\nLOG:Saving stack configuration to $CONFIG_FILENAME for debugging...'\n+              CONFIG_OUTPUT=\"\\$CONFIG_FILENAME\"\n             fi\n-          done < .env\n-          rm -f .env\n+            docker stack config -c stack-api.yml > \"$CONFIG_OUTPUT\" || { echo \\\"Error: Invalid stack configuration\\\"; exit 1; }\n \n-          echo -e '\\nLOG:Validating environment and config...'\n-          env | grep -E 'DOMAIN|DEPLOYMENT' || { echo \\\"Error: Required environment variables not found\\\"; exit 1; }\n-          docker stack config -c stack-api.yml > /dev/null || { echo \\\"Error: Invalid stack configuration\\\"; exit 1; }\n+            echo -e '\\nLOG:Deploying stack...'\n+            docker stack deploy -c stack-api.yml --prune --with-registry-auth --detach=false $STACK_NAME\n \n-          echo -e '\\nLOG:Deploying stack...'\n-          docker stack deploy -c stack-api.yml --prune --with-registry-auth --detach=false \\${STACK_NAME}\n-          echo -e '\\nLOG:Finished deployment.'\n+            echo -e '\\nLOG:Finished deployment.'\n           \"\n           MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n           ssh $TS_USERNAME@$MACHINE_IP \"$REMOTE_SCRIPT\""
        }
    ],
    "stats": {
        "total": 186,
        "additions": 128,
        "deletions": 58
    }
}