{
    "author": "ojeytonwilliams",
    "message": "Revert \"fix(api): use lowercase email address (#61490)\" (#61608)",
    "sha": "4448bcbd9213e5d8da078e24e4265f220d7c77ec",
    "files": [
        {
            "sha": "7bef32befde54595fa53ff3ffb5c2ece2d5f047c",
            "filename": "api/src/routes/helpers/auth-helpers.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 32,
            "changes": 33,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4448bcbd9213e5d8da078e24e4265f220d7c77ec/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4448bcbd9213e5d8da078e24e4265f220d7c77ec/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts?ref=4448bcbd9213e5d8da078e24e4265f220d7c77ec",
            "patch": "@@ -24,13 +24,7 @@ describe('findOrCreateUser', () => {\n   });\n \n   afterEach(async () => {\n-    await fastify.prisma.user.deleteMany({\n-      where: {\n-        email: {\n-          in: [email, email.toUpperCase()]\n-        }\n-      }\n-    });\n+    await fastify.prisma.user.deleteMany({ where: { email } });\n     await fastify.close();\n     jest.clearAllMocks();\n   });\n@@ -66,29 +60,4 @@ describe('findOrCreateUser', () => {\n \n     expect(captureException).not.toHaveBeenCalled();\n   });\n-\n-  it(\"should NOT create a user if there is already an account with the lowercase version of the user's email\", async () => {\n-    const upperCaseEmail = email.toUpperCase();\n-\n-    // Create a user with lowercase email\n-    const existingUser = await fastify.prisma.user.create({\n-      data: createUserInput(email)\n-    });\n-\n-    // Try to find or create with uppercase email\n-    const result = await findOrCreateUser(fastify, upperCaseEmail);\n-\n-    // Should return the existing user, not create a new one\n-    expect(result.id).toBe(existingUser.id);\n-\n-    // Verify only one user exists in the database\n-    const allUsers = await fastify.prisma.user.findMany({\n-      where: {\n-        email: {\n-          in: [upperCaseEmail, email]\n-        }\n-      }\n-    });\n-    expect(allUsers).toHaveLength(1);\n-  });\n });"
        },
        {
            "sha": "741bcb2998ce37eec7ce4becd8e78f0462c944be",
            "filename": "api/src/routes/helpers/auth-helpers.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4448bcbd9213e5d8da078e24e4265f220d7c77ec/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4448bcbd9213e5d8da078e24e4265f220d7c77ec/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts?ref=4448bcbd9213e5d8da078e24e4265f220d7c77ec",
            "patch": "@@ -11,16 +11,10 @@ export const findOrCreateUser = async (\n   fastify: FastifyInstance,\n   email: string\n ): Promise<{ id: string; acceptedPrivacyTerms: boolean }> => {\n-  const lowerCaseEmail = email.toLowerCase();\n   // TODO: handle the case where there are multiple users with the same email.\n   // e.g. use findMany and throw an error if more than one is found.\n   const existingUser = await fastify.prisma.user.findMany({\n-    where: {\n-      // https://www.mongodb.com/docs/manual/reference/operator/query/or/#-or-versus--in\n-      email: {\n-        in: [email, lowerCaseEmail]\n-      }\n-    },\n+    where: { email },\n     select: { id: true, acceptedPrivacyTerms: true }\n   });\n   if (existingUser.length > 1) {\n@@ -34,7 +28,7 @@ export const findOrCreateUser = async (\n   return (\n     existingUser[0] ??\n     (await fastify.prisma.user.create({\n-      data: createUserInput(lowerCaseEmail),\n+      data: createUserInput(email),\n       select: { id: true, acceptedPrivacyTerms: true }\n     }))\n   );"
        },
        {
            "sha": "ef7c4ac911b8817c41424e06814be583e85daf57",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4448bcbd9213e5d8da078e24e4265f220d7c77ec/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4448bcbd9213e5d8da078e24e4265f220d7c77ec/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=4448bcbd9213e5d8da078e24e4265f220d7c77ec",
            "patch": "@@ -765,9 +765,7 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n     },\n     async (req, reply) => {\n       const logger = fastify.log.child({ req, res: reply });\n-      const email = Buffer.from(req.query.email, 'base64')\n-        .toString()\n-        .toLowerCase();\n+      const email = Buffer.from(req.query.email, 'base64').toString();\n \n       const { origin } = getRedirectParams(req);\n       if (!isEmail(email)) {\n@@ -793,12 +791,9 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n       // TODO(Post-MVP): should this fail if it's not the currently signed in\n       // user?\n       const targetUser = await fastify.prisma.user.findUnique({\n-        where: { id: authToken.userId },\n-        select: { id: true, newEmail: true }\n+        where: { id: authToken.userId }\n       });\n \n-      // TODO: update redirect message to be specific about issue\n-      //       Most likely cause being user tampered callback url\n       if (targetUser?.newEmail !== email) {\n         return reply.redirectWithMessage(origin, redirectMessage);\n       }"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 5,
        "deletions": 47
    }
}