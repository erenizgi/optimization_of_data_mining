{
    "author": "moT01",
    "message": "fix: audio not loading on ios (#55993)",
    "sha": "c00dfa13e17cde845bef54b76c01670c3b6f17e9",
    "files": [
        {
            "sha": "b62148d718e4e301210199081435a6a4418f00c5",
            "filename": "client/src/templates/Challenges/components/scene/scene.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 15,
            "changes": 46,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c00dfa13e17cde845bef54b76c01670c3b6f17e9/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c00dfa13e17cde845bef54b76c01670c3b6f17e9/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx?ref=c00dfa13e17cde845bef54b76c01670c3b6f17e9",
            "patch": "@@ -34,9 +34,7 @@ export function Scene({\n   const hasTimestamps = startTimestamp !== null && finishTimestamp !== null;\n   const audioTimestamp = hasTimestamps ? `#t=${startTimestamp}` : '';\n \n-  const audioRef = useRef<HTMLAudioElement>(\n-    new Audio(`${sounds}/${audio.filename}${audioTimestamp}`)\n-  );\n+  const audioRef = useRef<HTMLAudioElement>(new Audio());\n \n   // if there are timestamps, we use the difference between them as the duration\n   // if not, we assume we're playing the whole audio file.\n@@ -46,7 +44,13 @@ export function Scene({\n \n   // on mount\n   useEffect(() => {\n-    audioRef.current.addEventListener('canplaythrough', audioLoaded);\n+    const { current } = audioRef;\n+\n+    if (current) {\n+      current.addEventListener('canplaythrough', audioLoaded);\n+      current.src = `${sounds}/${audio.filename}${audioTimestamp}`;\n+      current.load();\n+    }\n \n     // preload images\n     loadImage(`${backgrounds}/${setup.background}`);\n@@ -64,13 +68,20 @@ export function Scene({\n \n     // on unmount\n     return () => {\n-      const { current } = audioRef;\n-\n-      current.pause();\n-      current.currentTime = 0;\n-      current.removeEventListener('canplaythrough', audioLoaded);\n+      if (current) {\n+        current.pause();\n+        current.currentTime = 0;\n+        current.removeEventListener('canplaythrough', audioLoaded);\n+      }\n     };\n-  }, [audioRef, setup.background, setup.characters, commands]);\n+  }, [\n+    audioRef,\n+    audio.filename,\n+    audioTimestamp,\n+    setup.background,\n+    setup.characters,\n+    commands\n+  ]);\n \n   const initBackground = setup.background;\n   const initDialogue = { label: '', text: '', align: 'left' };\n@@ -93,7 +104,7 @@ export function Scene({\n     if (isPlaying) {\n       playScene();\n     } else {\n-      finishScene();\n+      resetScene();\n     }\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [isPlaying]);\n@@ -195,10 +206,15 @@ export function Scene({\n     });\n   };\n \n-  const finishScene = () => {\n-    audioRef.current.pause();\n-    audioRef.current.src = `${sounds}/${audio.filename}${audioTimestamp}`;\n-    audioRef.current.currentTime = audio.startTimestamp || 0;\n+  const resetScene = () => {\n+    const { current } = audioRef;\n+    if (current) {\n+      current.pause();\n+      current.src = `${sounds}/${audio.filename}${audioTimestamp}`;\n+      current.load();\n+      current.currentTime = audio.startTimestamp || 0;\n+    }\n+\n     setShowDialogue(false);\n     setDialogue(initDialogue);\n     setCharacters(initCharacters);"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 31,
        "deletions": 15
    }
}