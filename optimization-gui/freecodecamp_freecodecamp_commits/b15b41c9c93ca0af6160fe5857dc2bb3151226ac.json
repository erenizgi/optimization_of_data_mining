{
    "author": "huyenltnguyen",
    "message": "test(e2e): add donation-modal.spec.ts (#55239)",
    "sha": "b15b41c9c93ca0af6160fe5857dc2bb3151226ac",
    "files": [
        {
            "sha": "b006af86aba3628b0d9328acafde4e7c01c72982",
            "filename": "client/src/components/Donation/donation-modal-body.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b15b41c9c93ca0af6160fe5857dc2bb3151226ac/client%2Fsrc%2Fcomponents%2FDonation%2Fdonation-modal-body.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b15b41c9c93ca0af6160fe5857dc2bb3151226ac/client%2Fsrc%2Fcomponents%2FDonation%2Fdonation-modal-body.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2FDonation%2Fdonation-modal-body.tsx?ref=b15b41c9c93ca0af6160fe5857dc2bb3151226ac",
            "patch": "@@ -25,7 +25,6 @@ const Illustration = () => {\n       alt={t('donate.flying-bear')}\n       id={'supporter-bear'}\n       src={supporterBear}\n-      data-playwright-test-label='not-found-image'\n     />\n   );\n };\n@@ -158,7 +157,7 @@ const AnimationContainer = ({\n           alt=''\n           src={donationAnimation}\n           id={'donation-animation'}\n-          data-playwright-test-label='not-found-image'\n+          data-playwright-test-label='donation-animation'\n         />\n       </div>\n     </>"
        },
        {
            "sha": "e04eec56d5431e5cd271ba13483d6e4b4cabd30e",
            "filename": "e2e/donation-block-completion-modal.spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 48,
            "changes": 48,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f0e538d2c954583dd5f89d7dae523a740032310a/e2e%2Fdonation-block-completion-modal.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f0e538d2c954583dd5f89d7dae523a740032310a/e2e%2Fdonation-block-completion-modal.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fdonation-block-completion-modal.spec.ts?ref=f0e538d2c954583dd5f89d7dae523a740032310a",
            "patch": "@@ -1,48 +0,0 @@\n-import { execSync } from 'child_process';\n-import { test, expect, Page } from '@playwright/test';\n-test.use({ storageState: 'playwright/.auth/development-user.json' });\n-\n-test.beforeAll(() => {\n-  execSync('node ./tools/scripts/seed/seed-demo-user');\n-});\n-\n-test.afterAll(() => {\n-  execSync('node ./tools/scripts/seed/seed-demo-user certified-user');\n-});\n-const projects = [\n-  'random-quote-machine',\n-  'markdown-previewer',\n-  'drum-machine',\n-  'javascript-calculator',\n-  '25--5-clock'\n-];\n-\n-test.describe('Donate page', () => {\n-  const submitProject = async (page: Page, str: string) => {\n-    await page.goto(\n-      `/learn/front-end-development-libraries/front-end-development-libraries-projects/build-a-${str}`\n-    );\n-    await page\n-      .getByRole('textbox', { name: 'solution' })\n-      .fill('https://codepen.io/camperbot/full/oNvPqqo');\n-    await page\n-      .getByRole('button', { name: \"I've completed this challenge\" })\n-      .click();\n-    await page\n-      .getByRole('button', { name: 'Submit and go to next challenge' })\n-      .click();\n-  };\n-\n-  test('Should be possible to submit projects, after the donation modal should show', async ({\n-    page\n-  }) => {\n-    for (const project of projects) {\n-      await submitProject(page, project);\n-    }\n-\n-    await expect(page.getByRole('dialog')).toBeVisible();\n-    await expect(\n-      page.locator(\"div[role='dialog'] img#donation-animation\")\n-    ).toBeVisible();\n-  });\n-});"
        },
        {
            "sha": "b4b85405d43d8779d387c3b957e637e5929b4c2e",
            "filename": "e2e/donation-modal.spec.ts",
            "status": "added",
            "additions": 398,
            "deletions": 0,
            "changes": 398,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b15b41c9c93ca0af6160fe5857dc2bb3151226ac/e2e%2Fdonation-modal.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b15b41c9c93ca0af6160fe5857dc2bb3151226ac/e2e%2Fdonation-modal.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fdonation-modal.spec.ts?ref=b15b41c9c93ca0af6160fe5857dc2bb3151226ac",
            "patch": "@@ -0,0 +1,398 @@\n+import { execSync } from 'child_process';\n+import { test, expect, type Page } from '@playwright/test';\n+\n+import { clearEditor, focusEditor } from './utils/editor';\n+\n+const slowExpect = expect.configure({ timeout: 25000 });\n+\n+const completeFrontEndCert = async (page: Page) => {\n+  await page.goto(\n+    `/learn/front-end-development-libraries/front-end-development-libraries-projects/build-a-random-quote-machine`\n+  );\n+\n+  const projects = [\n+    'random-quote-machine',\n+    'markdown-previewer',\n+    'drum-machine',\n+    'javascript-calculator',\n+    '25--5-clock'\n+  ];\n+\n+  for (const project of projects) {\n+    await page.waitForURL(\n+      `/learn/front-end-development-libraries/front-end-development-libraries-projects/build-a-${project}`\n+    );\n+    await page\n+      .getByRole('textbox', { name: 'solution' })\n+      .fill('https://codepen.io/camperbot/full/oNvPqqo');\n+    await page\n+      .getByRole('button', { name: \"I've completed this challenge\" })\n+      .click();\n+    await page\n+      .getByRole('button', { name: 'Submit and go to next challenge' })\n+      .click();\n+  }\n+};\n+\n+const completeThreeChallenges = async ({\n+  page,\n+  browserName,\n+  isMobile\n+}: {\n+  page: Page;\n+  browserName: string;\n+  isMobile: boolean;\n+}) => {\n+  await page.goto(\n+    '/learn/javascript-algorithms-and-data-structures/basic-javascript/comment-your-javascript-code'\n+  );\n+\n+  const challenges = [\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/comment-your-javascript-code',\n+      solution: `// some comment\\n/* some comment */`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/declare-javascript-variables',\n+      solution: 'var myName;'\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/storing-values-with-the-assignment-operator',\n+      solution: `// Setup\\nvar a;\\n\\n// Only change code below this line\\na = 7;`\n+    }\n+  ];\n+\n+  for (const challenge of challenges) {\n+    await page.waitForURL(challenge.url);\n+\n+    await focusEditor({ page, isMobile });\n+    await clearEditor({ page, browserName });\n+\n+    await page.evaluate(\n+      async contents => await navigator.clipboard.writeText(contents),\n+      challenge.solution\n+    );\n+    await page.keyboard.press('ControlOrMeta+V');\n+\n+    await page.getByRole('button', { name: 'Run' }).click();\n+    await expect(page.getByRole('dialog')).toBeVisible(); // completion dialog\n+    await page.getByRole('button', { name: 'Submit' }).click();\n+  }\n+};\n+\n+const completeTenChallenges = async ({\n+  page,\n+  browserName,\n+  isMobile\n+}: {\n+  page: Page;\n+  browserName: string;\n+  isMobile: boolean;\n+}) => {\n+  await page.goto(\n+    '/learn/javascript-algorithms-and-data-structures/basic-javascript/comment-your-javascript-code'\n+  );\n+\n+  const challenges = [\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/comment-your-javascript-code',\n+      solution: `// some comment\\n/* some comment */`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/declare-javascript-variables',\n+      solution: 'var myName;'\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/storing-values-with-the-assignment-operator',\n+      solution: `// Setup\\nvar a;\\n\\n// Only change code below this line\\na = 7;`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/assigning-the-value-of-one-variable-to-another',\n+      solution: `// Setup\\nvar a;\\na = 7;\\nvar b;\\n\\n// Only change code below this line\\nb = a;`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/initializing-variables-with-the-assignment-operator',\n+      solution: 'var a = 9;'\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/declare-string-variables',\n+      solution: `var myFirstName = 'foo';\\nvar myLastName = 'bar';`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/understanding-uninitialized-variables',\n+      solution: `// Only change code below this line\\nvar a = 5;\\nvar b = 10;\\nvar c = 'I am a';\\n// Only change code above this line\\n\\na = a + 1;\\nb = b + 5;\\nc = c + \" String!\";`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/understanding-case-sensitivity-in-variables',\n+      solution: `// Variable declarations\\nvar studlyCapVar;\\nvar properCamelCase;\\nvar titleCaseOver;\\n\\n// Variable assignments\\nstudlyCapVar = 10;\\nproperCamelCase = \"A String\";\\ntitleCaseOver = 9000;`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/explore-differences-between-the-var-and-let-keywords',\n+      solution: `let catName = \"Oliver\";\\nlet catSound = \"Meow!\";`\n+    },\n+    {\n+      url: '/learn/javascript-algorithms-and-data-structures/basic-javascript/declare-a-read-only-variable-with-the-const-keyword',\n+      solution: `const FCC = \"freeCodeCamp\";\\n// Change this line\\nlet fact = \"is cool!\";\\n// Change this line\\nfact = \"is awesome!\";\\nconsole.log(FCC, fact);\\n// Change this line`\n+    }\n+  ];\n+\n+  for (const challenge of challenges) {\n+    await page.waitForURL(challenge.url);\n+\n+    await focusEditor({ page, isMobile });\n+    await clearEditor({ page, browserName });\n+\n+    await page.evaluate(\n+      async contents => await navigator.clipboard.writeText(contents),\n+      challenge.solution\n+    );\n+    await page.keyboard.press('ControlOrMeta+V');\n+\n+    await page.getByRole('button', { name: 'Run' }).click();\n+    await expect(page.getByRole('dialog')).toBeVisible(); // completion dialog\n+    await page.getByRole('button', { name: 'Submit' }).click();\n+  }\n+};\n+\n+test.skip(\n+  ({ browserName }) => browserName !== 'chromium',\n+  'Only chromium allows us to use the clipboard API.'\n+);\n+\n+test.describe('Donation modal display', () => {\n+  test.use({ storageState: 'playwright/.auth/certified-user.json' });\n+\n+  test('should display the content correctly and disable close when the animation is not complete', async ({\n+    page,\n+    browserName,\n+    isMobile,\n+    context\n+  }) => {\n+    await context.grantPermissions(['clipboard-read', 'clipboard-write']);\n+    test.setTimeout(40000);\n+\n+    await completeThreeChallenges({ page, browserName, isMobile });\n+\n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeVisible();\n+\n+    await expect(\n+      donationModal.getByText(\n+        'This is a 20 second animated advertisement to encourage campers to become supporters of freeCodeCamp. The animation starts with a teddy bear who becomes a supporter. As a result, distracting pop-ups disappear and the bear gets to complete all of its goals. Then, it graduates and becomes an education super hero helping people around the world.'\n+      )\n+    ).toBeVisible();\n+    await expect(donationModal.getByTestId('donation-animation')).toBeVisible();\n+    await expect(donationModal.getByText('Become a Supporter')).toBeVisible();\n+    await expect(donationModal.getByText('Remove distractions')).toBeVisible();\n+    await expect(\n+      donationModal.getByText('Reach your goals faster')\n+    ).toBeVisible();\n+    await expect(\n+      donationModal.getByText('Help millions of people learn')\n+    ).toBeVisible();\n+\n+    // Ensure that the modal cannot be closed by pressing the Escape key\n+    await page.keyboard.press('Escape');\n+    await expect(donationModal).toBeVisible();\n+\n+    // Second part of the modal.\n+    // Use `slowExpect` as we need to wait 20s for this part to show up.\n+    await slowExpect(\n+      donationModal.getByRole('img', {\n+        name: 'Illustration of an adorable teddy bear wearing a graduation cap and flying with a Supporter badge.'\n+      })\n+    ).toBeVisible();\n+\n+    await expect(\n+      donationModal.getByRole('heading', {\n+        name: 'Support us'\n+      })\n+    ).toBeVisible();\n+\n+    await expect(\n+      donationModal\n+        .getByRole('listitem')\n+        .filter({ hasText: 'Help us build more certifications' })\n+    ).toBeVisible();\n+\n+    await expect(\n+      donationModal\n+        .getByRole('listitem')\n+        .filter({ hasText: 'Remove donation popups' })\n+    ).toBeVisible();\n+\n+    await expect(\n+      donationModal\n+        .getByRole('listitem')\n+        .filter({ hasText: 'Help millions of people learn' })\n+    ).toBeVisible();\n+\n+    await expect(\n+      donationModal.getByRole('button', { name: 'Become a Supporter' })\n+    ).toBeVisible();\n+\n+    await expect(\n+      donationModal.getByRole('button', { name: 'Ask me later' })\n+    ).toBeVisible();\n+  });\n+});\n+\n+test.describe('Donation modal appearance logic - New user', () => {\n+  test.use({ storageState: 'playwright/.auth/development-user.json' });\n+\n+  test.beforeEach(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user');\n+  });\n+\n+  test.afterAll(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user certified-user');\n+  });\n+\n+  test('should not appear if the user has less than 10 completed challenges in total and has just completed 3 challenges', async ({\n+    page,\n+    browserName,\n+    isMobile,\n+    context\n+  }) => {\n+    await context.grantPermissions(['clipboard-read', 'clipboard-write']);\n+\n+    // Development user doesn't have any completed challenges, we are completing the first 3.\n+    await completeThreeChallenges({ page, browserName, isMobile });\n+\n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeHidden();\n+  });\n+\n+  test('should appear if the user has less than 10 completed challenges in total and has just completed 10 challenges', async ({\n+    page,\n+    isMobile,\n+    browserName,\n+    context\n+  }) => {\n+    await context.grantPermissions(['clipboard-read', 'clipboard-write']);\n+    test.setTimeout(50000);\n+\n+    await completeTenChallenges({ page, isMobile, browserName });\n+\n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeVisible();\n+    await expect(\n+      donationModal.getByText(\n+        'This is a 20 second animated advertisement to encourage campers to become supporters of freeCodeCamp. The animation starts with a teddy bear who becomes a supporter. As a result, distracting pop-ups disappear and the bear gets to complete all of its goals. Then, it graduates and becomes an education super hero helping people around the world.'\n+      )\n+    ).toBeVisible();\n+\n+    // Second part of the modal.\n+    // Use `slowExpect` as we need to wait 20s for this part to show up.\n+    await slowExpect(\n+      donationModal.getByRole('heading', { name: 'Support us' })\n+    ).toBeVisible();\n+    await donationModal.getByRole('button', { name: 'Ask me later' }).click();\n+    // Ensure that the close state has been registered before ending the test.\n+    // The modal will show up on another page/test otherwise.\n+    await expect(donationModal).toBeHidden();\n+  });\n+\n+  test('should appear if the user has just completed a new block, and should not appear if the user re-submits the projects of the block', async ({\n+    page\n+  }) => {\n+    test.setTimeout(40000);\n+\n+    await completeFrontEndCert(page);\n+\n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeVisible();\n+    await expect(\n+      donationModal.getByText(\n+        'This is a 20 second animated advertisement to encourage campers to become supporters of freeCodeCamp. The animation starts with a teddy bear who becomes a supporter. As a result, distracting pop-ups disappear and the bear gets to complete all of its goals. Then, it graduates and becomes an education super hero helping people around the world.'\n+      )\n+    ).toBeVisible();\n+\n+    // Second part of the modal.\n+    // Use `slowExpect` as we need to wait 20s for this part to show up.\n+    await slowExpect(\n+      donationModal.getByText(\n+        'Nicely done. You just completed Front End Development Libraries Projects.'\n+      )\n+    ).toBeVisible();\n+    await donationModal.getByRole('button', { name: 'Ask me later' }).click();\n+    await expect(donationModal).toBeHidden();\n+\n+    await completeFrontEndCert(page);\n+    await expect(donationModal).toBeHidden();\n+  });\n+});\n+\n+test.describe('Donation modal appearance logic - Certified user', () => {\n+  test.use({ storageState: 'playwright/.auth/certified-user.json' });\n+\n+  test('should appear if the user has completed 3 challenges and has more than 10 completed challenges in total', async ({\n+    page,\n+    browserName,\n+    isMobile,\n+    context\n+  }) => {\n+    await context.grantPermissions(['clipboard-read', 'clipboard-write']);\n+    test.setTimeout(40000);\n+\n+    // Certified user already has more than 10 completed challenges, we are just completing 3 more.\n+    await completeThreeChallenges({ page, browserName, isMobile });\n+\n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeVisible();\n+\n+    await expect(\n+      donationModal.getByText(\n+        'This is a 20 second animated advertisement to encourage campers to become supporters of freeCodeCamp. The animation starts with a teddy bear who becomes a supporter. As a result, distracting pop-ups disappear and the bear gets to complete all of its goals. Then, it graduates and becomes an education super hero helping people around the world.'\n+      )\n+    ).toBeVisible();\n+\n+    // Second part of the modal.\n+    // Use `slowExpect` as we need to wait 20s for this part to show up.\n+    await slowExpect(\n+      donationModal.getByRole('heading', { name: 'Support us' })\n+    ).toBeVisible();\n+    await donationModal.getByRole('button', { name: 'Ask me later' }).click();\n+    // Ensure that the close state has been registered before ending the test.\n+    // The modal will show up on another page/test otherwise.\n+    await expect(donationModal).toBeHidden();\n+  });\n+});\n+\n+test.describe('Donation modal appearance logic - Donor user', () => {\n+  test.use({ storageState: 'playwright/.auth/certified-user.json' });\n+\n+  test.beforeAll(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user certified-user --donor');\n+  });\n+\n+  test.afterAll(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user certified-user');\n+  });\n+\n+  test('should not appear', async ({\n+    page,\n+    browserName,\n+    isMobile,\n+    context\n+  }) => {\n+    await context.grantPermissions(['clipboard-read', 'clipboard-write']);\n+\n+    await completeThreeChallenges({ page, browserName, isMobile });\n+\n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeHidden();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 449,
        "additions": 399,
        "deletions": 50
    }
}