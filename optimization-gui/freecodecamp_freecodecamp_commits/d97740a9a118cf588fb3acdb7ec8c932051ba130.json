{
    "author": "raisedadead",
    "message": "feat(CD): deploy with GitHub actions",
    "sha": "d97740a9a118cf588fb3acdb7ec8c932051ba130",
    "files": [
        {
            "sha": "01c3cf002e24c702832d981be0669207ee8c0392",
            "filename": ".github/workflows/deploy-legacy.yml",
            "status": "added",
            "additions": 244,
            "deletions": 0,
            "changes": 244,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d97740a9a118cf588fb3acdb7ec8c932051ba130/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d97740a9a118cf588fb3acdb7ec8c932051ba130/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-legacy.yml?ref=d97740a9a118cf588fb3acdb7ec8c932051ba130",
            "patch": "@@ -0,0 +1,244 @@\n+name: CD -- Deploy API (Legacy) & Clients\n+\n+on:\n+  workflow_dispatch:\n+\n+jobs:\n+  setup-jobs:\n+    name: Setup Jobs\n+    runs-on: ubuntu-24.04\n+    outputs:\n+      site_tld: ${{ steps.setup.outputs.site_tld }} # Used to define URLs like api.freecodecamp.org, forum.freecodecamp.dev, etc.\n+      environment: ${{ steps.setup.outputs.environment }} # Used to define the environment (prd, stg, etc.)\n+      deployment_env: ${{ steps.setup.outputs.deployment_env }} # Used to define the deployment environment (production, staging, etc.)\n+    steps:\n+      - name: Setup\n+        id: setup\n+        run: |\n+          case \"${{ github.ref }}\" in\n+            \"refs/heads/prod-current\")\n+              echo \"site_tld=org\" >> $GITHUB_OUTPUT\n+              echo \"environment=prd\" >> $GITHUB_OUTPUT\n+              echo \"deployment_env=production\" >> $GITHUB_OUTPUT\n+              ;;\n+            *)\n+              echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n+              echo \"environment=stg\" >> $GITHUB_OUTPUT\n+              echo \"deployment_env=staging\" >> $GITHUB_OUTPUT\n+              ;;\n+          esac\n+\n+  api:\n+    name: Build & Deploy API (Legacy)\n+    needs: [setup-jobs]\n+    runs-on: ubuntu-24.04\n+    strategy:\n+      matrix:\n+        node-version: [20.x]\n+    permissions:\n+      deployments: write\n+      contents: read\n+    environment:\n+      name: ${{ needs.setup-jobs.outputs.environment }}-api-legacy\n+    env:\n+      TS_USERNAME: ${{ secrets.TS_USERNAME }}\n+      TS_MACHINE_NAME_PREFIX: ${{ secrets.TS_MACHINE_NAME_PREFIX }}\n+    steps:\n+      - name: Setup and connect to Tailscale network\n+        uses: tailscale/github-action@v3\n+        with:\n+          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}\n+          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}\n+          hostname: gha-${{needs.setup-jobs.outputs.environment}}-api-legacy-ci-${{ github.run_id }}\n+          tags: tag:ci\n+          version: latest\n+\n+      - name: Configure SSH\n+        # This is a workaround to avoid the SSH warning about known hosts & strict host key checking.\n+        # It's not a problem for us, because we're using Tailscale to connect.\n+        run: |\n+          mkdir -p ~/.ssh\n+          echo \"Host *\n+            UserKnownHostsFile=/dev/null\n+            StrictHostKeyChecking no\" > ~/.ssh/config\n+\n+      - name: Check connection\n+        run: |\n+          for i in {1..3}; do\n+            TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-api-${i}\n+            tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Error: Machine not found\"; exit 1; }\n+            ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n+          done\n+\n+      # - name: Deploy API\n+      #   run: |\n+      #     export GIT_SOURCE_BRANCH=prod-${{ needs.setup-jobs.outputs.environment }}\n+      #     ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n+      #       set -e\n+      #       cd /home/${TS_USERNAME}/freeCodeCamp || { echo \"::error::Failed to change directory\"; exit 1; }\n+\n+      #       pm2 stop all\n+\n+      #       git status || { echo \"::error::Failed to check git status\"; exit 1; }\n+      #       git clean -f || { echo \"::error::Failed to clean git\"; exit 1; }\n+      #       git fetch --all --prune || { echo \"::error::Failed to fetch git\"; exit 1; }\n+      #       git checkout -f $GIT_SOURCE_BRANCH || { echo \"::error::Failed to checkout branch\"; exit 1; }\n+\n+      #       git reset --hard origin/${GIT_SOURCE_BRANCH} || { echo \"::error::Failed to reset git\"; exit 1; }\n+      #       git status || { echo \"::error::Failed to check git status\"; exit 1; }\n+\n+      #       npm i -g pnpm@9 || { echo \"::error::Failed to install pnpm\"; exit 1; }\n+\n+      #       pnpm clean:packages || { echo \"::error::Failed to clean packages\"; exit 1; }\n+      #       pnpm clean:server || { echo \"::error::Failed to clean server\"; exit 1; }\n+      #       pnpm install || { echo \"::error::Failed to install dependencies\"; exit 1; }\n+      #       pnpm prebuild || { echo \"::error::Failed prebuild\"; exit 1; }\n+      #       pnpm build:curriculum || { echo \"::error::Failed to build curriculum\"; exit 1; }\n+      #       pnpm build:server || { echo \"::error::Failed to build server\"; exit 1; }\n+\n+      #       pnpm reload:server || { echo \"::error::Failed to reload server\"; exit 1; }\n+      #       pm2 ls || { echo \"::error::Failed to list PM2 processes\"; exit 1; }\n+\n+      #       pm2 save || { echo \"::error::Failed to save PM2 processes\"; exit 1; }\n+      #     EOF\n+\n+  client:\n+    name: Build Client\n+    needs: [setup-jobs, api]\n+    runs-on: ubuntu-24.04\n+    strategy:\n+      matrix:\n+        node-version: [20.x]\n+        lang:\n+          - english\n+          - chinese\n+          - espanol\n+        include:\n+          - lang: english\n+            short-name: eng\n+          - lang: chinese\n+            short-name: chn\n+          - lang: espanol\n+            short-name: esp\n+\n+    permissions:\n+      deployments: write\n+      contents: read\n+    environment:\n+      name: ${{ needs.setup-jobs.outputs.environment }}-clients\n+    env:\n+      API_LOCATION: 'https://api.freecodecamp.${{ needs.setup-jobs.outputs.site_tld }}'\n+      ALGOLIA_APIKEY: ${{ secrets.ALGOLIA_APIKEY }}\n+      ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}\n+      GROWTHBOOK_URI: ${{ secrets.GROWTHBOOK_URI }}\n+      FORUM_LOCATION: 'https://forum.freecodecamp.org'\n+      PATREON_CLIENT_ID: ${{ secrets.PATREON_CLIENT_ID }}\n+      PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}\n+      STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY }}\n+      SHOW_UPCOMING_CHANGES: ${{ vars.SHOW_UPCOMING_CHANGES }}\n+      # The below is used in ecosystem.config.js file for the API -- to be removed later\n+      DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.deployment_env }}\n+      # The above is used in ecosystem.config.js file for the API -- to be removed later\n+      TS_USERNAME: ${{ secrets.TS_USERNAME }}\n+      TS_MACHINE_NAME_PREFIX: ${{ secrets.TS_MACHINE_NAME_PREFIX }}\n+\n+    steps:\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+        with:\n+          submodules: 'recursive'\n+\n+      - name: Setup pnpm\n+        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d #v3.0.0\n+        with:\n+          version: 9\n+\n+      - name: Use Node.js ${{ matrix.node-version }}\n+        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2\n+        with:\n+          node-version: ${{ matrix.node-version }}\n+          cache: pnpm\n+\n+      - name: Prepare language specific ENV\n+        run: |\n+          if [ \"${{ matrix.lang }}\" = \"english\" ]; then\n+            echo \"HOME_LOCATION=https://www.freecodecamp.${{ needs.setup-jobs.outputs.site_tld }}\" >> $GITHUB_ENV\n+            echo \"NEWS_LOCATION=https://www.freecodecamp.${{ needs.setup-jobs.outputs.site_tld }}/news\" >> $GITHUB_ENV\n+          else\n+            echo \"HOME_LOCATION=https://www.freecodecamp.${{ needs.setup-jobs.outputs.site_tld }}/${{ matrix.lang }}\" >> $GITHUB_ENV\n+            echo \"NEWS_LOCATION=https://www.freecodecamp.${{ needs.setup-jobs.outputs.site_tld }}/${{ matrix.lang }}/news\" >> $GITHUB_ENV\n+          fi\n+          echo \"CLIENT_LOCALE=${{ matrix.lang }}\" >> $GITHUB_ENV\n+          echo \"CURRICULUM_LOCALE=${{ matrix.lang }}\" >> $GITHUB_ENV\n+\n+      - name: Install and Build\n+        run: |\n+          # pnpm install\n+          # pnpm run build\n+          mkdir -p client/public\n+          touch client/public/test-${{ matrix.short-name }}.txt\n+\n+      # We tar them for performance reasons - uploading a lot of files is slow.\n+      - name: Tar Files\n+        run: tar -czf client-${{ matrix.short-name }}.tar client/public\n+\n+      - name: Setup and connect to Tailscale network\n+        uses: tailscale/github-action@v3\n+        with:\n+          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}\n+          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}\n+          hostname: gha-${{needs.setup-jobs.outputs.environment}}-clients-ci-${{ github.run_id }}\n+          tags: tag:ci\n+          version: latest\n+\n+      - name: Configure SSH\n+        # This is a workaround to avoid the SSH warning about known hosts & strict host key checking.\n+        # It's not a problem for us, because we're using Tailscale to connect.\n+        run: |\n+          mkdir -p ~/.ssh\n+          echo \"Host *\n+            UserKnownHostsFile=/dev/null\n+            StrictHostKeyChecking no\" > ~/.ssh/config\n+\n+      - name: Check connection\n+        run: |\n+          for i in {0..1}; do\n+            TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.short-name }}-${i}\n+            tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Error: Machine not found\"; exit 1; }\n+            ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n+          done\n+\n+      # - name: Upload and Deploy\n+      #   run: |\n+      #     for i in {0..1}; do\n+\n+      #       TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.short-name }}-${i}\n+      #       scp client-${{ matrix.short-name }}.tar $TS_USERNAME@$TS_MACHINE_NAME:/tmp/${{ github.run_id }}-client-${{ matrix.short-name }}.tar || { echo \"::error::Failed to upload client archive\"; exit 1; }\n+\n+      #       ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n+      #         set -e\n+\n+      #         export CURRENT_DATE=$(date +%Y%m%d)\n+      #         export CLIENT_BINARIES=gha-${{needs.setup-jobs.outputs.environment}}-release-${CURRENT_DATE}-${{ github.run_id }}\n+\n+      #         mkdir -p /home/${TS_USERNAME}/client/releases/${CLIENT_BINARIES} || { echo \"::error::Failed to create client release directory\"; exit 1; }\n+      #         tar -xzf /tmp/${{ github.run_id }}-client-${{ matrix.short-name }}.tar -C /home/${TS_USERNAME}/client/releases/${CLIENT_BINARIES} || { echo \"::error::Failed to extract client archive\"; exit 1; }\n+      #         rm /tmp/${{ github.run_id }}-client-${{ matrix.short-name }}.tar\n+\n+      #         cd /home/${TS_USERNAME}/client || { echo \"::error::Failed to change to client directory\"; exit 1; }\n+      #         npm install -g serve@13 || { echo \"::error::Failed to install serve\"; exit 1; }\n+\n+      #         rm -f client-start-primary.sh\n+      #         echo \"serve -c ../../serve.json releases/${CLIENT_BINARIES} -p 50505\" >> client-start-primary.sh || { echo \"::error::Failed to create primary script\"; exit 1; }\n+      #         chmod +x client-start-primary.sh || { echo \"::error::Failed to make primary script executable\"; exit 1; }\n+      #         pm2 delete client-primary || true\n+      #         pm2 start  ./client-start-primary.sh --name client-primary || { echo \"::error::Failed to start primary client\"; exit 1; }\n+\n+      #         rm -f client-start-secondary.sh\n+      #         echo \"serve -c ../../serve.json releases/${CLIENT_BINARIES} -p 52525\" >> client-start-secondary.sh || { echo \"::error::Failed to create secondary script\"; exit 1; }\n+      #         chmod +x client-start-secondary.sh || { echo \"::error::Failed to make secondary script executable\"; exit 1; }\n+      #         pm2 delete client-secondary || true\n+      #         pm2 start  ./client-start-secondary.sh --name client-secondary || { echo \"::error::Failed to start secondary client\"; exit 1; }\n+      #       EOF\n+\n+      #     done"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 244,
        "deletions": 0
    }
}