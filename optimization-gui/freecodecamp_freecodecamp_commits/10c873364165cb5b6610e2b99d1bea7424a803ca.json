{
    "author": "ShaunSHamilton",
    "message": "fix(api): check attempts and moderations records for available exams (#61302)\n\nCo-authored-by: Tom <20648924+moT01@users.noreply.github.com>\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "10c873364165cb5b6610e2b99d1bea7424a803ca",
    "files": [
        {
            "sha": "637fc72b3877bf388b4d891a0b9ce27165ae511f",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 169,
            "deletions": 17,
            "changes": 186,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/10c873364165cb5b6610e2b99d1bea7424a803ca/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/10c873364165cb5b6610e2b99d1bea7424a803ca/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=10c873364165cb5b6610e2b99d1bea7424a803ca",
            "patch": "@@ -587,27 +587,48 @@ describe('/exam-environment/', () => {\n     });\n \n     describe('GET /exam-environment/exams', () => {\n+      beforeEach(async () => {\n+        // Reset user prerequisites\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            completedChallenges: [\n+              { id: mock.exam.prerequisites.at(0)!, completedDate: Date.now() }\n+            ]\n+          }\n+        });\n+      });\n+\n+      afterEach(async () => {\n+        // Clean up exam attempts and moderation records\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n+\n+        // Reset exam deprecated status\n+        await fastifyTestInstance.prisma.examEnvironmentExam.update({\n+          where: { id: mock.examId },\n+          data: { deprecated: false }\n+        });\n+      });\n+\n       it('should return 200', async () => {\n         const res = await superGet('/exam-environment/exams').set(\n           'exam-environment-authorization-token',\n           examEnvironmentAuthorizationToken\n         );\n \n-        expect(res.body).toStrictEqual({\n-          exams: [\n-            {\n-              canTake: true,\n-              config: {\n-                name: mock.exam.config.name,\n-                note: mock.exam.config.note,\n-                passingPercent: mock.exam.config.passingPercent,\n-                totalTimeInMS: mock.exam.config.totalTimeInMS,\n-                retakeTimeInMS: mock.exam.config.retakeTimeInMS\n-              },\n-              id: mock.examId\n-            }\n-          ]\n-        });\n+        expect(res.body).toStrictEqual([\n+          {\n+            canTake: true,\n+            config: {\n+              name: mock.exam.config.name,\n+              note: mock.exam.config.note,\n+              passingPercent: mock.exam.config.passingPercent,\n+              totalTimeInMS: mock.exam.config.totalTimeInMS,\n+              retakeTimeInMS: mock.exam.config.retakeTimeInMS\n+            },\n+            id: mock.examId\n+          }\n+        ]);\n \n         expect(res.status).toBe(200);\n       });\n@@ -623,10 +644,141 @@ describe('/exam-environment/', () => {\n           examEnvironmentAuthorizationToken\n         );\n \n-        expect(res.body).toStrictEqual({\n-          exams: []\n+        expect(res.body).toStrictEqual([]);\n+\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it(\"should indicate an exam's availability based on prerequisites\", async () => {\n+        // Remove prerequisites from user\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            completedChallenges: []\n+          }\n         });\n \n+        const res = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toMatchObject([{ canTake: false }]);\n+        expect(res.status).toBe(200);\n+\n+        // Add prerequisites back to user\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            completedChallenges: [\n+              { id: mock.exam.prerequisites.at(0)!, completedDate: Date.now() }\n+            ]\n+          }\n+        });\n+\n+        const res2 = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res2.body).toMatchObject([{ canTake: true }]);\n+        expect(res2.status).toBe(200);\n+      });\n+\n+      it('should indicate an exam may be taken if the user has no prior attempts', async () => {\n+        const res = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toStrictEqual([\n+          {\n+            canTake: true,\n+            config: {\n+              name: mock.exam.config.name,\n+              note: mock.exam.config.note,\n+              passingPercent: mock.exam.config.passingPercent,\n+              totalTimeInMS: mock.exam.config.totalTimeInMS,\n+              retakeTimeInMS: mock.exam.config.retakeTimeInMS\n+            },\n+            id: mock.examId\n+          }\n+        ]);\n+        expect(res.body).toMatchObject([{ canTake: true }]);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it(\"should indicate an exam's availability based on the last attempt's start time, and the exam retake time\", async () => {\n+        // Create a recent exam attempt that's within the retake time\n+        const recentExamAttempt = {\n+          ...mock.examAttempt,\n+          userId: defaultUserId,\n+          startTimeInMS: Date.now() - mock.exam.config.totalTimeInMS\n+        };\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+          data: recentExamAttempt\n+        });\n+\n+        const res = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toMatchObject([{ canTake: false }]);\n+        expect(res.status).toBe(200);\n+\n+        // Update the attempt to be outside the retake time\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.update({\n+          where: { id: recentExamAttempt.id },\n+          data: {\n+            startTimeInMS:\n+              Date.now() -\n+              (mock.exam.config.totalTimeInMS +\n+                mock.exam.config.retakeTimeInMS +\n+                1000)\n+          }\n+        });\n+\n+        const res2 = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res2.body).toMatchObject([{ canTake: true }]);\n+\n+        expect(res2.status).toBe(200);\n+      });\n+\n+      it('should indicate an exam is unavailable if there are any pending moderation records for the exam attempts', async () => {\n+        // Create an exam attempt that's outside the retake time\n+        const examAttempt = {\n+          ...mock.examAttempt,\n+          userId: defaultUserId,\n+          startTimeInMS:\n+            Date.now() -\n+            (mock.exam.config.totalTimeInMS +\n+              mock.exam.config.retakeTimeInMS +\n+              1000)\n+        };\n+        const createdAttempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: examAttempt\n+          });\n+\n+        // Create a pending moderation record for the attempt\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: createdAttempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Pending\n+          }\n+        });\n+\n+        const res = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toMatchObject([{ canTake: false }]);\n         expect(res.status).toBe(200);\n       });\n     });"
        },
        {
            "sha": "cf4be5f401cdeb393cccc9f39b1325c1b9210212",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 102,
            "deletions": 9,
            "changes": 111,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/10c873364165cb5b6610e2b99d1bea7424a803ca/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/10c873364165cb5b6610e2b99d1bea7424a803ca/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=10c873364165cb5b6610e2b99d1bea7424a803ca",
            "patch": "@@ -666,7 +666,7 @@ async function getExams(\n   reply: FastifyReply\n ) {\n   const logger = this.log.child({ req });\n-  logger.info({ user: req.user });\n+  logger.info({ userId: req.user?.id });\n \n   const user = req.user!;\n   const maybeExams = await mapErr(\n@@ -693,10 +693,34 @@ async function getExams(\n \n   const exams = maybeExams.data;\n \n-  const availableExams = exams.map(exam => {\n-    const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n+  const maybeAttempts = await mapErr(\n+    this.prisma.examEnvironmentExamAttempt.findMany({\n+      where: {\n+        userId: user.id\n+      },\n+      select: {\n+        id: true,\n+        examId: true,\n+        startTimeInMS: true\n+      }\n+    })\n+  );\n \n-    return {\n+  if (maybeAttempts.hasError) {\n+    logger.error(maybeAttempts.error);\n+    this.Sentry.captureException(maybeAttempts.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempts.error))\n+    );\n+  }\n+\n+  const attempts = maybeAttempts.data;\n+\n+  const availableExams = [];\n+\n+  for (const exam of exams) {\n+    const availableExam = {\n       id: exam.id,\n       config: {\n         name: exam.config.name,\n@@ -705,13 +729,82 @@ async function getExams(\n         retakeTimeInMS: exam.config.retakeTimeInMS,\n         passingPercent: exam.config.passingPercent\n       },\n-      canTake: isExamPrerequisitesMet\n+      canTake: false\n     };\n-  });\n \n-  return reply.send({\n-    exams: availableExams\n-  });\n+    const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n+    logger.info(\n+      `Prerequisites for exam ${exam.id} ${isExamPrerequisitesMet ? 'met' : 'unmet'}.`\n+    );\n+\n+    if (!isExamPrerequisitesMet) {\n+      availableExam.canTake = false;\n+      availableExams.push(availableExam);\n+      continue;\n+    }\n+    // Latest attempt must be:\n+    // a) Moderated\n+    // b) Past exam config retake time\n+    const attemptsForExam = attempts.filter(a => a.examId === exam.id);\n+\n+    const lastAttempt = attemptsForExam.length\n+      ? attemptsForExam.reduce((latest, current) =>\n+          latest.startTimeInMS > current.startTimeInMS ? latest : current\n+        )\n+      : null;\n+\n+    if (!lastAttempt) {\n+      logger.info(`No prior attempts for exam ${exam.id}`);\n+      availableExam.canTake = true;\n+      availableExams.push(availableExam);\n+      continue;\n+    }\n+\n+    const retakeDateInMS =\n+      lastAttempt.startTimeInMS +\n+      exam.config.totalTimeInMS +\n+      exam.config.retakeTimeInMS;\n+    const isRetakeTimePassed = Date.now() > retakeDateInMS;\n+\n+    if (!isRetakeTimePassed) {\n+      logger.info(`Time until retake: ${retakeDateInMS - Date.now()} [ms]`);\n+      availableExam.canTake = false;\n+      availableExams.push(availableExam);\n+      continue;\n+    }\n+\n+    const maybeModerations = await mapErr(\n+      this.prisma.examEnvironmentExamModeration.findMany({\n+        where: {\n+          examAttemptId: { in: attemptsForExam.map(a => a.id) },\n+          status: ExamEnvironmentExamModerationStatus.Pending\n+        }\n+      })\n+    );\n+\n+    if (maybeModerations.hasError) {\n+      logger.error(maybeModerations.error);\n+      this.Sentry.captureException(maybeModerations.error);\n+      void reply.code(500);\n+      return reply.send(\n+        ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeModerations.error))\n+      );\n+    }\n+\n+    const moderations = maybeModerations.data;\n+\n+    if (moderations.length > 0) {\n+      logger.info(`Exam Moderation records found: ${moderations.length}`);\n+      availableExam.canTake = false;\n+      availableExams.push(availableExam);\n+      continue;\n+    }\n+\n+    availableExam.canTake = true;\n+    availableExams.push(availableExam);\n+  }\n+\n+  return reply.send(availableExams);\n }\n \n /**"
        },
        {
            "sha": "7189f49cf1efe92e29dbcd8318232b2b72050a9a",
            "filename": "api/src/exam-environment/schemas/exam-environment-exams.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 15,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/10c873364165cb5b6610e2b99d1bea7424a803ca/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/10c873364165cb5b6610e2b99d1bea7424a803ca/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts?ref=10c873364165cb5b6610e2b99d1bea7424a803ca",
            "patch": "@@ -5,21 +5,19 @@ export const examEnvironmentExams = {\n     'exam-environment-authorization-token': Type.String()\n   }),\n   response: {\n-    200: Type.Object({\n-      exams: Type.Array(\n-        Type.Object({\n-          id: Type.String(),\n-          config: Type.Object({\n-            name: Type.String(),\n-            note: Type.String(),\n-            totalTimeInMS: Type.Number(),\n-            retakeTimeInMS: Type.Number(),\n-            passingPercent: Type.Number()\n-          }),\n-          canTake: Type.Boolean()\n-        })\n-      )\n-    }),\n+    200: Type.Array(\n+      Type.Object({\n+        id: Type.String(),\n+        config: Type.Object({\n+          name: Type.String(),\n+          note: Type.String(),\n+          totalTimeInMS: Type.Number(),\n+          retakeTimeInMS: Type.Number(),\n+          passingPercent: Type.Number()\n+        }),\n+        canTake: Type.Boolean()\n+      })\n+    ),\n     500: STANDARD_ERROR\n   }\n };"
        }
    ],
    "stats": {
        "total": 325,
        "additions": 284,
        "deletions": 41
    }
}