{
    "author": "ojeytonwilliams",
    "message": "fix(api): handle concurrent deletion requests (#60430)",
    "sha": "7003362fef32535c2deb38a93bd2464343c05ebb",
    "files": [
        {
            "sha": "45058569b4d99a5e100db5f38de06e4125ed520e",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7003362fef32535c2deb38a93bd2464343c05ebb/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7003362fef32535c2deb38a93bd2464343c05ebb/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=7003362fef32535c2deb38a93bd2464343c05ebb",
            "patch": "@@ -464,6 +464,55 @@ describe('userRoutes', () => {\n         expect(countAfter).toBe(0);\n         expect(res.status).toBe(200);\n       });\n+\n+      test('handles concurrent requests to delete the same user', async () => {\n+        const deletePromises = Array.from({ length: 2 }, () =>\n+          superPost('/account/delete')\n+        );\n+\n+        const responses = await Promise.all(deletePromises);\n+\n+        const userCount = await fastifyTestInstance.prisma.user.count({\n+          where: { email: testUserData.email }\n+        });\n+        responses.forEach(response => {\n+          expect(response.status).toBe(200);\n+          expect(response.body).toStrictEqual({});\n+        });\n+        expect(userCount).toBe(0);\n+      });\n+\n+      test(\"only deletes the logged in user's data\", async () => {\n+        await fastifyTestInstance.prisma.user.create({\n+          data: {\n+            ...testUserData,\n+            email: 'an.random@user'\n+          }\n+        });\n+        expect(await fastifyTestInstance.prisma.user.count()).toBe(2);\n+\n+        await superPost('/account/delete');\n+\n+        const userCount = await fastifyTestInstance.prisma.user.count();\n+        expect(userCount).toBe(1);\n+      });\n+\n+      test('logs if it is asked to delete a non-existent user', async () => {\n+        const spy = jest.spyOn(fastifyTestInstance.log, 'warn');\n+\n+        const deletePromises = Array.from({ length: 2 }, () =>\n+          superPost('/account/delete')\n+        );\n+\n+        await Promise.all(deletePromises);\n+\n+        expect(spy).toHaveBeenCalledTimes(1);\n+        expect(spy.mock.calls[0]).toEqual(\n+          expect.arrayContaining([\n+            `User with id ${defaultUserId} not found for deletion.`\n+          ])\n+        );\n+      });\n     });\n \n     describe('/account/reset-progress', () => {"
        },
        {
            "sha": "505f1afd7d73bf28f6b79c86c41d9d7522b74bef",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7003362fef32535c2deb38a93bd2464343c05ebb/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7003362fef32535c2deb38a93bd2464343c05ebb/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=7003362fef32535c2deb38a93bd2464343c05ebb",
            "patch": "@@ -3,6 +3,7 @@ import { ObjectId } from 'mongodb';\n import _ from 'lodash';\n import { FastifyInstance, FastifyReply } from 'fastify';\n import jwt from 'jsonwebtoken';\n+import { PrismaClientKnownRequestError } from '@prisma/client/runtime/library';\n \n import * as schemas from '../../schemas';\n import { createResetProperties } from '../../utils/create-user';\n@@ -84,9 +85,24 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       await fastify.prisma.survey.deleteMany({\n         where: { userId: req.user!.id }\n       });\n-      await fastify.prisma.user.delete({\n-        where: { id: req.user!.id }\n-      });\n+      try {\n+        await fastify.prisma.user.delete({\n+          where: { id: req.user!.id }\n+        });\n+      } catch (err) {\n+        if (\n+          err instanceof PrismaClientKnownRequestError &&\n+          err.code === 'P2025'\n+        ) {\n+          logger.warn(\n+            err,\n+            `User with id ${req.user?.id} not found for deletion.`\n+          );\n+        } else {\n+          logger.error(err, 'Error deleting user account');\n+          throw err;\n+        }\n+      }\n       reply.clearOurCookies();\n \n       return {};"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 68,
        "deletions": 3
    }
}