{
    "author": "Sembauke",
    "message": "fix(profile): simplify stats component and allow streaks to exceed 6 months (#58763)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "09499eec1f2eaedaa5f801712fcb0f1783e5ccb1",
    "files": [
        {
            "sha": "9e37d662c87ac23c6173f28c1b626c86b30bd524",
            "filename": "client/src/components/profile/components/stats.test.tsx",
            "status": "modified",
            "additions": 83,
            "deletions": 1,
            "changes": 84,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/09499eec1f2eaedaa5f801712fcb0f1783e5ccb1/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fstats.test.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/09499eec1f2eaedaa5f801712fcb0f1783e5ccb1/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fstats.test.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fstats.test.tsx?ref=09499eec1f2eaedaa5f801712fcb0f1783e5ccb1",
            "patch": "@@ -1,6 +1,6 @@\n import { render, screen } from '@testing-library/react';\n import React from 'react';\n-import Stats from './stats';\n+import Stats, { calculateStreaks } from './stats';\n \n const props: { calendar: { [key: number]: number }; points: number } = {\n   calendar: {},\n@@ -22,3 +22,85 @@ describe('<Stats/>', () => {\n     );\n   });\n });\n+\n+const oldStreakCalendar = {\n+  '1736496000': 1, // 2025-01-10 08:00:00 UTC\n+  '1736582400': 1, // 2025-01-11 08:00:00 UTC\n+  '1736668800': 1, // 2025-01-12 08:00:00 UTC\n+  '1736755200': 1, // 2025-01-13 08:00:00 UTC\n+  '1736841600': 1 // 2025-01-14 08:00:00 UTC\n+};\n+\n+const recentStreakCalendar = {\n+  '1736699400': 1, // 2025-01-12 16:30:00 UTC\n+  '1736763300': 1, // 2025-01-13 10:15:00 UTC\n+  '1736865900': 1 // 2025-01-14 14:45:00 UTC\n+};\n+\n+const twoStreakCalendar = {\n+  '1736503200': 1, // 2025-01-10 10:00:00 UTC\n+  '1736604000': 1, // 2025-01-11 14:00:00 UTC\n+  '1736697600': 1, // 2025-01-12 16:00:00 UTC\n+  // Skipping Jan 13, 2025\n+  '1736845200': 1, // 2025-01-14 09:00:00 UTC\n+  '1736946000': 1 // 2025-01-15 13:00:00 UTC\n+};\n+\n+jest.useFakeTimers();\n+\n+describe('calculateStreaks', () => {\n+  test('Should return a longest streak of 5 days when the user has not completed a challenge in a while', () => {\n+    jest.setSystemTime(new Date(2025, 0, 15));\n+    const { longestStreak, currentStreak } =\n+      calculateStreaks(oldStreakCalendar);\n+\n+    expect(longestStreak).toBe(5);\n+    expect(currentStreak).toBe(0);\n+  });\n+\n+  test('Should calculate longest streak, regardless of how long ago they were', () => {\n+    jest.setSystemTime(new Date(2030, 0, 15));\n+    const { longestStreak, currentStreak } =\n+      calculateStreaks(oldStreakCalendar);\n+\n+    expect(longestStreak).toBe(5);\n+    expect(currentStreak).toBe(0);\n+  });\n+\n+  test('Should return a longest streak of 3 days when the current streak is 3 days', () => {\n+    jest.setSystemTime(new Date(2025, 0, 14));\n+    const { longestStreak, currentStreak } =\n+      calculateStreaks(recentStreakCalendar);\n+\n+    expect(longestStreak).toBe(3);\n+    expect(currentStreak).toBe(3);\n+  });\n+\n+  test('Should return a longest and current streaks of 1 day when the user has recently completed their first challenge', () => {\n+    const now = new Date(2025, 0, 15);\n+    jest.setSystemTime(now);\n+    const calendar = {\n+      [now.valueOf() / 1000]: 1\n+    };\n+\n+    const { longestStreak, currentStreak } = calculateStreaks(calendar);\n+\n+    expect(longestStreak).toBe(1);\n+    expect(currentStreak).toBe(1);\n+  });\n+\n+  test('Should return a current streak of 2 days with a longest streak of 3 days when the longest streak is longer than the current one', () => {\n+    const { longestStreak, currentStreak } =\n+      calculateStreaks(twoStreakCalendar);\n+\n+    expect(longestStreak).toBe(3);\n+    expect(currentStreak).toBe(2);\n+  });\n+\n+  test('Should return a streak of 0 days if no challenges have been completed', () => {\n+    const { longestStreak, currentStreak } = calculateStreaks({});\n+\n+    expect(longestStreak).toBe(0);\n+    expect(currentStreak).toBe(0);\n+  });\n+});"
        },
        {
            "sha": "2a46f86f1755f1369ab3526fb090e4f81fa55c59",
            "filename": "client/src/components/profile/components/stats.tsx",
            "status": "modified",
            "additions": 40,
            "deletions": 102,
            "changes": 142,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/09499eec1f2eaedaa5f801712fcb0f1783e5ccb1/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fstats.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/09499eec1f2eaedaa5f801712fcb0f1783e5ccb1/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fstats.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fstats.tsx?ref=09499eec1f2eaedaa5f801712fcb0f1783e5ccb1",
            "patch": "@@ -1,123 +1,61 @@\n-import React from 'react';\n+import React, { useState, useEffect } from 'react';\n+import { startOfDay, addDays, isEqual } from 'date-fns';\n import { useTranslation } from 'react-i18next';\n-// TODO: Check if we can import { addDays, addMonths ... } from 'date-fns'\n-// without bundling all of the package then we can remove the disable-next-line\n-// comments.\n-\n-// eslint-disable-next-line import/no-duplicates\n-import addDays from 'date-fns/addDays';\n-// eslint-disable-next-line import/no-duplicates\n-import addMonths from 'date-fns/addMonths';\n-// eslint-disable-next-line import/no-duplicates\n-import isEqual from 'date-fns/isEqual';\n import { Spacer } from '@freecodecamp/ui';\n-// eslint-disable-next-line import/no-duplicates\n-import startOfDay from 'date-fns/startOfDay';\n-import { User } from '../../../redux/prop-types';\n+import { last } from 'lodash-es';\n+import { uniq } from 'lodash';\n+\n import { FullWidthRow } from '../../helpers';\n+\n import './stats.css';\n \n interface StatsProps {\n   points: number;\n-  calendar: User['calendar'];\n+  calendar: Record<string, number>;\n }\n \n-function Stats({ points, calendar }: StatsProps): JSX.Element {\n-  const { t } = useTranslation();\n-\n-  /**\n-   *  the following logic calculates streaks from the\n-   *  users calendar\n-   */\n-\n-  interface PageData {\n-    startOfCalendar: Date;\n-    endOfCalendar: Date;\n-  }\n-\n-  interface CalendarData {\n-    date: Date;\n-    count: number;\n-  }\n-\n-  // create array of timestamps and turn into milliseconds\n+export const calculateStreaks = (calendar: Record<string, number>) => {\n+  // calendar keys are timestamps in seconds and we need them in milliseconds\n   const timestamps = Object.keys(calendar).map(\n     stamp => Number.parseInt(stamp, 10) * 1000\n   );\n-  const startOfTimestamps = startOfDay(new Date(timestamps[0]));\n-  let endOfCalendar = startOfDay(Date.now());\n-  let startOfCalendar;\n-\n-  const pages: PageData[] = [];\n-\n-  do {\n-    startOfCalendar = addDays(addMonths(endOfCalendar, -6), 1);\n-\n-    const newPage = {\n-      startOfCalendar: startOfCalendar,\n-      endOfCalendar: endOfCalendar\n-    };\n-\n-    pages.push(newPage);\n-\n-    endOfCalendar = addDays(startOfCalendar, -1);\n-  } while (startOfTimestamps < startOfCalendar);\n-\n-  pages.reverse();\n-\n-  const calendarData: CalendarData[] = [];\n-  let dayCounter = pages[0].startOfCalendar;\n-\n-  // create an object for each day of the calendar period\n-  while (dayCounter <= pages[pages.length - 1].endOfCalendar) {\n-    const newDay = {\n-      date: startOfDay(dayCounter),\n-      count: 0\n-    };\n-\n-    calendarData.push(newDay);\n-    dayCounter = addDays(dayCounter, 1);\n-  }\n-\n-  let longestStreak = 0;\n-  let currentStreak = 0;\n-  let lastIndex = -1;\n+  const days = uniq(timestamps.map(stamp => startOfDay(stamp)));\n+\n+  const { longestStreak, currentStreak } = days.reduce(\n+    (acc, day) => {\n+      const isConsecutive = isEqual(addDays(acc.previousDay, 1), day);\n+      const currentStreak = isConsecutive ? acc.currentStreak + 1 : 1;\n+      const longestStreak = Math.max(acc.longestStreak, currentStreak);\n+\n+      return {\n+        currentStreak,\n+        longestStreak,\n+        previousDay: day\n+      };\n+    },\n+    // the site didn't exist in 1970, so we can be confident no streak started\n+    // then\n+    { currentStreak: 0, longestStreak: 0, previousDay: new Date(0) }\n+  );\n \n-  // add a point to each day with a completed timestamp and calculate streaks\n-  timestamps.forEach(stamp => {\n-    const index = calendarData.findIndex(day =>\n-      isEqual(day.date, startOfDay(stamp))\n-    );\n+  const lastDay = last(days);\n+  const streakExpired = !lastDay || !isEqual(lastDay, startOfDay(Date.now()));\n \n-    if (index >= 0) {\n-      // add one point for today\n-      calendarData[index].count++;\n+  return { longestStreak, currentStreak: streakExpired ? 0 : currentStreak };\n+};\n \n-      // if timestamp is on a new day, deal with streaks\n-      if (index !== lastIndex) {\n-        // if yesterday has points\n-        if (calendarData[index - 1] && calendarData[index - 1].count > 0) {\n-          currentStreak++;\n-        } else {\n-          currentStreak = 1;\n-        }\n+function Stats({ points, calendar }: StatsProps): JSX.Element {\n+  const { t } = useTranslation();\n \n-        if (currentStreak > longestStreak) {\n-          longestStreak = currentStreak;\n-        }\n-      }\n+  const [currentStreak, setCurrentStreak] = useState(0);\n+  const [longestStreak, setLongestStreak] = useState(0);\n \n-      lastIndex = index;\n-    }\n-  });\n+  useEffect(() => {\n+    const { longestStreak, currentStreak } = calculateStreaks(calendar);\n \n-  // if today has no points\n-  if (\n-    calendarData[calendarData.length - 1] &&\n-    calendarData[calendarData.length - 1].count === 0\n-  ) {\n-    currentStreak = 0;\n-  }\n+    setLongestStreak(longestStreak);\n+    setCurrentStreak(currentStreak);\n+  }, [calendar]);\n \n   return (\n     <FullWidthRow>"
        }
    ],
    "stats": {
        "total": 226,
        "additions": 123,
        "deletions": 103
    }
}