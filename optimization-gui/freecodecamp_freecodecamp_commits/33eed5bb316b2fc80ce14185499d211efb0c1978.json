{
    "author": "ojeytonwilliams",
    "message": "refactor(api): encapsulate auth/csrf hooks (#55481)",
    "sha": "33eed5bb316b2fc80ce14185499d211efb0c1978",
    "files": [
        {
            "sha": "dab88d3c1cd5bf0e609f89bb77f4edce15324a2d",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 7,
            "changes": 42,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=33eed5bb316b2fc80ce14185499d211efb0c1978",
            "patch": "@@ -184,20 +184,48 @@ export const build = async (\n   void fastify.register(codeFlowAuth);\n   void fastify.register(notFound);\n   void fastify.register(prismaPlugin);\n+\n+  // Routes requiring authentication and CSRF protection\n+  void fastify.register(function (fastify, _opts, done) {\n+    // The order matters here, since we want to reject invalid cross site requests\n+    // before checking if the user is authenticated.\n+    // @ts-expect-error - @fastify/csrf-protection needs to update their types\n+    // eslint-disable-next-line @typescript-eslint/unbound-method\n+    fastify.addHook('onRequest', fastify.csrfProtection);\n+    fastify.addHook('onRequest', fastify.authorize);\n+\n+    void fastify.register(challengeRoutes);\n+    void fastify.register(donateRoutes);\n+    void fastify.register(protectedCertificateRoutes);\n+    void fastify.register(settingRoutes);\n+    void fastify.register(userRoutes);\n+    done();\n+  });\n+\n+  // Routes requiring authentication and NOT CSRF protection\n+  void fastify.register(function (fastify, _opts, done) {\n+    fastify.addHook('onRequest', fastify.authorize);\n+\n+    void fastify.register(userGetRoutes);\n+    done();\n+  });\n+\n+  // Routes requiring authentication that redirect on failure\n+  void fastify.register(function (fastify, _opts, done) {\n+    fastify.addHook('onRequest', fastify.authorizeOrRedirect);\n+\n+    void fastify.register(settingRedirectRoutes);\n+    done();\n+  });\n+\n+  // Routes not requiring authentication\n   void fastify.register(mobileAuth0Routes);\n   if (FCC_ENABLE_DEV_LOGIN_MODE) {\n     void fastify.register(devAuthRoutes);\n   }\n-  void fastify.register(challengeRoutes);\n-  void fastify.register(settingRoutes);\n-  void fastify.register(settingRedirectRoutes);\n-  void fastify.register(donateRoutes);\n   void fastify.register(emailSubscribtionRoutes);\n-  void fastify.register(userRoutes);\n   void fastify.register(userPublicGetRoutes);\n-  void fastify.register(protectedCertificateRoutes);\n   void fastify.register(unprotectedCertificateRoutes);\n-  void fastify.register(userGetRoutes);\n   void fastify.register(deprecatedEndpoints);\n   void fastify.register(statusRoute);\n   void fastify.register(unsubscribeDeprecated);"
        },
        {
            "sha": "3afb7fd9ab611537a15d994bf94573a5dfdef8c5",
            "filename": "api/src/routes/certificate.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fcertificate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fcertificate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fcertificate.ts?ref=33eed5bb316b2fc80ce14185499d211efb0c1978",
            "patch": "@@ -58,11 +58,6 @@ export const protectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n   const challenges = getChallenges();\n   const certTypeIds = createCertTypeIds(challenges);\n \n-  // @ts-expect-error - @fastify/csrf-protection needs to update their types\n-  // eslint-disable-next-line @typescript-eslint/unbound-method\n-  fastify.addHook('onRequest', fastify.csrfProtection);\n-  fastify.addHook('onRequest', fastify.authorize);\n-\n   // TODO(POST_MVP): Response should not include updated user. If a client wants the updated user, it should make a separate request\n   // OR: Always respond with current user - full user object - not random pieces.\n   fastify.put("
        },
        {
            "sha": "de4ae019f02fd528a02fdb00bb7833199d22fd8b",
            "filename": "api/src/routes/challenge.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fchallenge.ts?ref=33eed5bb316b2fc80ce14185499d211efb0c1978",
            "patch": "@@ -63,11 +63,6 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n ) => {\n   const challenges = getChallenges();\n \n-  // @ts-expect-error - @fastify/csrf-protection needs to update their types\n-  // eslint-disable-next-line @typescript-eslint/unbound-method\n-  fastify.addHook('onRequest', fastify.csrfProtection);\n-  fastify.addHook('onRequest', fastify.authorize);\n-\n   fastify.post(\n     '/coderoad-challenge-completed',\n     {"
        },
        {
            "sha": "72c85c790660921f67a27156e171dbe5f53669dc",
            "filename": "api/src/routes/donate.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fdonate.ts?ref=33eed5bb316b2fc80ce14185499d211efb0c1978",
            "patch": "@@ -26,12 +26,6 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n     typescript: true\n   });\n \n-  // The order matters here, since we want to reject invalid cross site requests\n-  // before checking if the user is authenticated.\n-  // @ts-expect-error - @fastify/csrf-protection needs to update their types\n-  // eslint-disable-next-line @typescript-eslint/unbound-method\n-  fastify.addHook('onRequest', fastify.csrfProtection);\n-  fastify.addHook('onRequest', fastify.authorize);\n   fastify.post(\n     '/donate/add-donation',\n     {"
        },
        {
            "sha": "fd663e434eee561d1380f04066717013c26d1f09",
            "filename": "api/src/routes/settings.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.ts?ref=33eed5bb316b2fc80ce14185499d211efb0c1978",
            "patch": "@@ -81,13 +81,6 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  // The order matters here, since we want to reject invalid cross site requests\n-  // before checking if the user is authenticated.\n-  // @ts-expect-error - @fastify/csrf-protection needs to update their types\n-  // eslint-disable-next-line @typescript-eslint/unbound-method\n-  fastify.addHook('onRequest', fastify.csrfProtection);\n-  fastify.addHook('onRequest', fastify.authorize);\n-\n   type CommonResponseSchema = {\n     response: { 400: (typeof schemas.updateMyProfileUI.response)[400] };\n   };\n@@ -681,8 +674,6 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  fastify.addHook('onRequest', fastify.authorizeOrRedirect);\n-\n   const redirectMessage = {\n     type: 'danger',\n     content:"
        },
        {
            "sha": "3111cc5cb7962fb18d57918522b720fdb4836773",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33eed5bb316b2fc80ce14185499d211efb0c1978/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=33eed5bb316b2fc80ce14185499d211efb0c1978",
            "patch": "@@ -96,11 +96,6 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  // @ts-expect-error - @fastify/csrf-protection needs to update their types\n-  // eslint-disable-next-line @typescript-eslint/unbound-method\n-  fastify.addHook('onRequest', fastify.csrfProtection);\n-  fastify.addHook('onRequest', fastify.authorize);\n-\n   fastify.post(\n     '/account/delete',\n     {\n@@ -422,8 +417,6 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  fastify.addHook('onRequest', fastify.authorize);\n-\n   fastify.get(\n     '/user/get-session-user',\n     {"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 35,
        "deletions": 39
    }
}