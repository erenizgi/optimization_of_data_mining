{
    "author": "ojeytonwilliams",
    "message": "fix(api): use challenge helper to update completed challenges (#55046)",
    "sha": "19b513473260a757b412b6c021dc1d19a680ac28",
    "files": [
        {
            "sha": "b584770b76ce378d86f1ac42d7ca5eb15095aa3d",
            "filename": "api/src/routes/challenge.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Froutes%2Fchallenge.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Froutes%2Fchallenge.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fchallenge.test.ts?ref=19b513473260a757b412b6c021dc1d19a680ac28",
            "patch": "@@ -550,7 +550,7 @@ describe('challengeRoutes', () => {\n \n           // If a challenge has already been completed, it should return the\n           // original completedDate\n-          expect(resUpdate.body.completedDate).not.toBe(\n+          expect(resUpdate.body.completedDate).toBe(\n             resOriginal.body.completedDate\n           );\n           expect(resUpdate.statusCode).toBe(200);\n@@ -1201,7 +1201,6 @@ describe('challengeRoutes', () => {\n               completedDate\n             });\n \n-            // TODO: use a custom matcher for thisu\n             expect(completedDate).toBeGreaterThan(now);\n             expect(completedDate).toBeLessThan(now + 1000);\n             expect(res.statusCode).toBe(200);"
        },
        {
            "sha": "096450d6c439a23e11359c3530c27f9c298ee1fc",
            "filename": "api/src/routes/challenge.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 54,
            "changes": 97,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Froutes%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Froutes%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fchallenge.ts?ref=19b513473260a757b412b6c021dc1d19a680ac28",
            "patch": "@@ -31,15 +31,24 @@ import {\n import { generateRandomExam, createExamResults } from '../utils/exam';\n import {\n   canSubmitCodeRoadCertProject,\n-  createProject,\n-  updateProject,\n   verifyTrophyWithMicrosoft\n } from './helpers/challenge-helpers';\n \n interface JwtPayload {\n   userToken: string;\n }\n \n+// TODO(Post-MVP): This could be narrowed down to only the fields needed by\n+// specific endpoints, but that means complicating the update helper.\n+const userChallengeSelect = {\n+  id: true,\n+  completedChallenges: true,\n+  partiallyCompletedChallenges: true,\n+  progressTimestamps: true,\n+  needsModeration: true,\n+  savedChallenges: true\n+};\n+\n /**\n  * Plugin for the challenge submission endpoints.\n  *\n@@ -218,11 +227,7 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n \n       const user = await fastify.prisma.user.findUniqueOrThrow({\n         where: { id: userId },\n-        select: {\n-          completedChallenges: true,\n-          partiallyCompletedChallenges: true,\n-          progressTimestamps: true\n-        }\n+        select: userChallengeSelect\n       });\n \n       if (\n@@ -237,33 +242,22 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         } as const;\n       }\n \n-      const completedDate = Date.now();\n-      const oldChallenge = user.completedChallenges?.find(\n-        ({ id }) => id === projectId\n-      );\n-\n-      const updatedChallenge = {\n+      const challenge = {\n         challengeType,\n         solution,\n-        githubLink\n-      };\n-      const newChallenge = {\n-        ...updatedChallenge,\n+        githubLink,\n         id: projectId,\n-        completedDate\n+        completedDate: Date.now()\n       };\n-      const alreadyCompleted = !!oldChallenge;\n       const progressTimestamps = user.progressTimestamps as ProgressTimestamp[];\n       const points = getPoints(progressTimestamps);\n \n-      const data = alreadyCompleted\n-        ? updateProject(projectId, updatedChallenge)\n-        : createProject(projectId, newChallenge, progressTimestamps);\n-\n-      await fastify.prisma.user.update({\n-        where: { id: userId },\n-        data\n-      });\n+      const { alreadyCompleted, completedDate } = await updateUserChallengeData(\n+        fastify,\n+        user,\n+        projectId,\n+        challenge\n+      );\n \n       return {\n         alreadyCompleted,\n@@ -290,7 +284,9 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     },\n     async req => {\n       const user = await fastify.prisma.user.findUniqueOrThrow({\n-        where: { id: req.user?.id }\n+        where: { id: req.user?.id },\n+\n+        select: userChallengeSelect\n       });\n       const progressTimestamps = user.progressTimestamps as\n         | ProgressTimestamp[]\n@@ -334,7 +330,8 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       const { id, files, challengeType } = req.body;\n \n       const user = await fastify.prisma.user.findUniqueOrThrow({\n-        where: { id: req.user?.id }\n+        where: { id: req.user?.id },\n+        select: userChallengeSelect\n       });\n       const RawProgressTimestamp = user.progressTimestamps as\n         | ProgressTimestamp[]\n@@ -549,36 +546,25 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n \n         const user = await fastify.prisma.user.findUniqueOrThrow({\n           where: { id: req.user?.id },\n-          select: { completedChallenges: true, progressTimestamps: true }\n+          select: userChallengeSelect\n         });\n \n-        const { completedChallenges } = user;\n         const progressTimestamps =\n           user.progressTimestamps as ProgressTimestamp[];\n-        const oldChallenge = completedChallenges.find(\n-          ({ id }) => id === challengeId\n-        );\n-        const alreadyCompleted = !!oldChallenge;\n-        const completedDate = alreadyCompleted\n-          ? oldChallenge.completedDate\n-          : Date.now();\n \n-        if (!alreadyCompleted) {\n-          const newChallenge = {\n-            id: challengeId,\n-            completedDate,\n-            solution: msTrophyStatus.msUserAchievementsApiUrl\n-          };\n-          await fastify.prisma.user.update({\n-            where: { id: req.user?.id },\n-            data: {\n-              completedChallenges: {\n-                push: newChallenge\n-              },\n-              progressTimestamps: [...progressTimestamps, completedDate]\n-            }\n-          });\n-        }\n+        const completedChallenge = {\n+          id: challengeId,\n+          solution: msTrophyStatus.msUserAchievementsApiUrl,\n+          completedDate: Date.now()\n+        };\n+\n+        const { alreadyCompleted, completedDate } =\n+          await updateUserChallengeData(\n+            fastify,\n+            user,\n+            challengeId,\n+            completedChallenge\n+          );\n \n         return {\n           alreadyCompleted,\n@@ -730,6 +716,9 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n \n               newCompletedChallenges[alreadyCompletedIndex] = updatedChallege;\n \n+              // TODO(Post-MVP): Try to DRY the updates.\n+              // updateUserChallengeData, for all its faults, handles the\n+              // update/insert logic well.\n               await fastify.prisma.user.update({\n                 where: { id: userId },\n                 data: {"
        },
        {
            "sha": "0cb3e459601bca3ef4b52b7644dfbe452cfdbccd",
            "filename": "api/src/routes/helpers/challenge-helpers.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 37,
            "changes": 37,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.ts?ref=19b513473260a757b412b6c021dc1d19a680ac28",
            "patch": "@@ -1,7 +1,3 @@\n-import type { Prisma } from '@prisma/client';\n-\n-import type { ProgressTimestamp } from '../../utils/progress';\n-\n /**\n  * Confirm that a user can submit a CodeRoad project.\n  *\n@@ -26,39 +22,6 @@ export const canSubmitCodeRoadCertProject = (\n   return false;\n };\n \n-/**\n- * Create the Prisma query to update a project.\n- * @param id The id of the project.\n- * @param newChallenge The challenge corresponding to the project.\n- * @returns A Prisma query to update the project.\n- */\n-export const updateProject = (\n-  id: string,\n-  newChallenge: Prisma.CompletedChallengeUpdateInput\n-) => ({\n-  completedChallenges: {\n-    updateMany: { where: { id }, data: newChallenge }\n-  },\n-  partiallyCompletedChallenges: { deleteMany: { where: { id } } }\n-});\n-\n-/**\n- * Create the Prisma query to create a project.\n- * @param id The id of the project.\n- * @param newChallenge The challenge corresponding to the project.\n- * @param progressTimestamps The user's current progress timestamps.\n- * @returns A Prisma query to update the project.\n- */\n-export const createProject = (\n-  id: string,\n-  newChallenge: Prisma.CompletedChallengeCreateInput,\n-  progressTimestamps: ProgressTimestamp[]\n-) => ({\n-  completedChallenges: { push: newChallenge },\n-  partiallyCompletedChallenges: { deleteMany: { where: { id } } },\n-  progressTimestamps: [...progressTimestamps, newChallenge.completedDate]\n-});\n-\n type MSProfileError = {\n   type: 'error';\n   message: 'flash.ms.profile.err';"
        },
        {
            "sha": "5c73d70f605a6cf57b1aee356712c0aafc3b700a",
            "filename": "api/src/utils/common-challenge-functions.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 63,
            "changes": 100,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/19b513473260a757b412b6c021dc1d19a680ac28/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts?ref=19b513473260a757b412b6c021dc1d19a680ac28",
            "patch": "@@ -107,21 +107,26 @@ export function saveUserChallengeData(\n /**\n  * Helper function to update a user's challenge data. Used in challenge\n  * submission endpoints.\n- *\n- * @deprecated Create specific functions for each submission endpoint.\n+ * TODO: Keep refactoring. This function does too much.\n  * @param fastify The Fastify instance.\n  * @param user The existing user record.\n  * @param challengeId The id of the submitted challenge.\n  * @param _completedChallenge The challenge submission.\n- * @param timezone The user's timezone.\n  * @returns Information about the update.\n  */\n export async function updateUserChallengeData(\n   fastify: FastifyInstance,\n-  user: user,\n+  user: Pick<\n+    user,\n+    | 'id'\n+    | 'completedChallenges'\n+    | 'needsModeration'\n+    | 'savedChallenges'\n+    | 'progressTimestamps'\n+    | 'partiallyCompletedChallenges'\n+  >,\n   challengeId: string,\n-  _completedChallenge: CompletedChallenge,\n-  timezone?: string // TODO: is this required as its not given as a arg anywhere\n+  _completedChallenge: CompletedChallenge\n ) {\n   const { files, completedDate: newProgressTimeStamp = Date.now() } =\n     _completedChallenge;\n@@ -149,48 +154,35 @@ export async function updateUserChallengeData(\n   } else {\n     completedChallenge = omit(_completedChallenge, ['files']);\n   }\n-  let finalChallenge = {} as CompletedChallenge;\n \n-  // Since these values are destuctured for easier updating, collectively update before returning\n   const {\n-    timezone: userTimezone,\n     completedChallenges = [],\n     needsModeration = false,\n     savedChallenges = [],\n     progressTimestamps = [],\n     partiallyCompletedChallenges = []\n   } = user;\n \n-  const userCompletedChallenges: CompletedChallenge[] = completedChallenges;\n-  const userSavedChallenges: SavedChallenge[] = savedChallenges;\n-  const userProgressTimestamps = progressTimestamps;\n-  const userPartiallyCompletedChallenges = partiallyCompletedChallenges;\n+  let userSavedChallenges = savedChallenges;\n \n-  const oldIndex = userCompletedChallenges.findIndex(\n-    ({ id }) => challengeId === id\n-  );\n+  const oldChallenge = completedChallenges.find(({ id }) => challengeId === id);\n+  const alreadyCompleted = !!oldChallenge;\n \n-  const alreadyCompleted = oldIndex !== -1;\n-  const oldChallenge = alreadyCompleted\n-    ? userCompletedChallenges[oldIndex]\n-    : null;\n+  const finalChallenge = alreadyCompleted\n+    ? {\n+        ...completedChallenge,\n+        completedDate: oldChallenge.completedDate\n+      }\n+    : completedChallenge;\n \n-  if (alreadyCompleted && oldChallenge) {\n-    finalChallenge = {\n-      ...completedChallenge,\n-      completedDate: oldChallenge.completedDate\n-    };\n+  const userCompletedChallenges = alreadyCompleted\n+    ? completedChallenges.map(x => (x.id === challengeId ? finalChallenge : x))\n+    : [...completedChallenges, finalChallenge];\n \n-    userCompletedChallenges[oldIndex] = finalChallenge;\n-  } else {\n-    finalChallenge = {\n-      ...completedChallenge\n-    };\n-    if (userProgressTimestamps && Array.isArray(userProgressTimestamps)) {\n-      userProgressTimestamps.push(newProgressTimeStamp);\n-    }\n-    userCompletedChallenges.push(finalChallenge);\n-  }\n+  const userProgressTimestamps =\n+    !alreadyCompleted && progressTimestamps && Array.isArray(progressTimestamps)\n+      ? [...progressTimestamps, newProgressTimeStamp]\n+      : progressTimestamps;\n \n   if (\n     multifileCertProjectIds.includes(challengeId) ||\n@@ -204,37 +196,19 @@ export async function updateUserChallengeData(\n       ) as SavedChallengeFile[]\n     };\n \n-    const savedIndex = userSavedChallenges.findIndex(\n-      ({ id }) => challengeId === id\n-    );\n+    const isSaved = userSavedChallenges.some(({ id }) => challengeId === id);\n \n-    if (savedIndex >= 0) {\n-      userSavedChallenges[savedIndex] = challengeToSave;\n-    } else {\n-      userSavedChallenges.push(challengeToSave);\n-    }\n+    userSavedChallenges = isSaved\n+      ? userSavedChallenges.map(x =>\n+          x.id === challengeId ? challengeToSave : x\n+        )\n+      : [...userSavedChallenges, challengeToSave];\n   }\n \n   // remove from partiallyCompleted on submit\n-  const updatedPartiallyCompletedChallenges =\n-    userPartiallyCompletedChallenges.filter(\n-      challenge => challenge.id !== challengeId\n-    );\n-\n-  if (\n-    timezone &&\n-    timezone !== 'UTC' &&\n-    !userTimezone &&\n-    userTimezone === 'UTC'\n-  ) {\n-    timezone = userTimezone;\n-    await fastify.prisma.user.update({\n-      where: { id: user.id },\n-      data: {\n-        timezone\n-      }\n-    });\n-  }\n+  const userPartiallyCompletedChallenges = partiallyCompletedChallenges.filter(\n+    challenge => challenge.id !== challengeId\n+  );\n \n   if (needsModeration) {\n     await fastify.prisma.user.update({\n@@ -252,7 +226,7 @@ export async function updateUserChallengeData(\n       needsModeration,\n       savedChallenges: userSavedChallenges,\n       progressTimestamps: userProgressTimestamps,\n-      partiallyCompletedChallenges: updatedPartiallyCompletedChallenges\n+      partiallyCompletedChallenges: userPartiallyCompletedChallenges\n     }\n   });\n "
        }
    ],
    "stats": {
        "total": 237,
        "additions": 81,
        "deletions": 156
    }
}