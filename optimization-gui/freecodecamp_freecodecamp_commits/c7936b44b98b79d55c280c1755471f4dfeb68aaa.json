{
    "author": "ojeytonwilliams",
    "message": "refactor(client): allow TS worker to initialize itself and have the client check readiness (#57055)",
    "sha": "c7936b44b98b79d55c280c1755471f4dfeb68aaa",
    "files": [
        {
            "sha": "62c7ede15a8852fffc9c2951b66e37b1cb8b2f56",
            "filename": "client/src/templates/Challenges/rechallenge/transformers.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -20,7 +20,7 @@ import {\n import { WorkerExecutor } from '../utils/worker-executor';\n import {\n   compileTypeScriptCode,\n-  initTypeScriptService\n+  checkTSServiceIsReady\n } from '../utils/typescript-worker-handler';\n \n const { filename: sassCompile } = sassData;\n@@ -146,7 +146,7 @@ const babelTransformer = loopProtectOptions => {\n       testTypeScript,\n       async challengeFile => {\n         await loadBabel();\n-        await initTypeScriptService();\n+        await checkTSServiceIsReady();\n         const babelOptions = getBabelOptions(presetsJS, loopProtectOptions);\n         return flow(\n           partial(transformHeadTailAndContents, compileTypeScriptCode),"
        },
        {
            "sha": "3bd3223ea4df08e03d7f24231c88c324fefab3ff",
            "filename": "client/src/templates/Challenges/utils/typescript-worker-handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Ftypescript-worker-handler.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Ftypescript-worker-handler.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Ftypescript-worker-handler.ts?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -30,10 +30,10 @@ export function compileTypeScriptCode(code: string): Promise<string> {\n   });\n }\n \n-export function initTypeScriptService(): Promise<boolean> {\n+export function checkTSServiceIsReady(): Promise<boolean> {\n   return awaitResponse({\n     worker: getTypeScriptWorker(),\n-    message: { type: 'init' },\n+    message: { type: 'check-is-ready' },\n     onMessage: (data, onSuccess) => {\n       if (data.type === 'ready') {\n         onSuccess(true);"
        },
        {
            "sha": "4367d1b3561a27d041b9b7032f903042c6eba78f",
            "filename": "tools/client-plugins/browser-scripts/index.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Findex.d.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Findex.d.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Findex.d.ts?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -1,4 +1,4 @@\n-import { PyodideInterface } from 'pyodide';\n+import type { PyodideInterface } from 'pyodide';\n \n export interface FrameDocument extends Document {\n   __initTestFrame: (e: InitTestFrameArg) => Promise<void>;"
        },
        {
            "sha": "f3bb8a66941ea3139e177c372ae4d75233f5297a",
            "filename": "tools/client-plugins/browser-scripts/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpackage.json?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -20,8 +20,9 @@\n   \"main\": \"index.js\",\n   \"scripts\": {\n     \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\",\n-    \"build\": \"NODE_OPTIONS=\\\"--max-old-space-size=7168\\\" webpack -c webpack.config.js\"\n+    \"build\": \"NODE_OPTIONS=\\\"--max-old-space-size=7168\\\" webpack -c webpack.config.cjs\"\n   },\n+  \"type\": \"module\",\n   \"keywords\": [],\n   \"devDependencies\": {\n     \"@babel/plugin-syntax-dynamic-import\": \"7.8.3\","
        },
        {
            "sha": "69840437f1973889cd9473d22b15cb8fc6f3e87e",
            "filename": "tools/client-plugins/browser-scripts/python-worker.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpython-worker.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpython-worker.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpython-worker.ts?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -1,5 +1,10 @@\n // We have to specify pyodide.js because we need to import that file (not .mjs)\n-// and 'import' defaults to .mjs\n+// and 'import' defaults to .mjs.\n+\n+// This is to do with how webpack handles node fallbacks - it uses the node\n+// resolution algorithm to find the file, but that requires the full file name.\n+// We can't add the extension, because it's in a bundle we're importing. However\n+// we can import the .js file and then the strictness does not apply.\n import { loadPyodide, type PyodideInterface } from 'pyodide/pyodide.js';\n import pkg from 'pyodide/package.json';\n import type { PyProxy, PythonError } from 'pyodide/ffi';"
        },
        {
            "sha": "b0c33770fefdf1bc81c36f02540f877ecafc75c7",
            "filename": "tools/client-plugins/browser-scripts/tsconfig.json",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftsconfig.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftsconfig.json?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -1,13 +1,17 @@\n {\n   \"compilerOptions\": {\n     \"target\": \"es2022\",\n-    \"module\": \"CommonJS\",\n+    \"module\": \"ESNext\",\n+    \"moduleResolution\": \"Bundler\",\n     \"lib\": [\"WebWorker\", \"DOM\"],\n     \"allowJs\": true,\n     \"strict\": true,\n     \"forceConsistentCasingInFileNames\": true,\n     \"esModuleInterop\": true,\n     \"resolveJsonModule\": true,\n-    \"noEmit\": true\n+    \"noEmit\": true,\n+    \"paths\": {\n+      \"pyodide/ffi\": [\"./node_modules/pyodide/ffi.d.ts\"] // Remove after updating pyodide (later versions correctly export ffi)\n+    }\n   }\n }"
        },
        {
            "sha": "ebfb1adc72b7a6d3c2e991e1e3e0c675b5abc093",
            "filename": "tools/client-plugins/browser-scripts/typescript-worker.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 21,
            "changes": 44,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftypescript-worker.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftypescript-worker.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftypescript-worker.ts?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -13,9 +13,6 @@ declare const ts: typeof import('typescript');\n const ctx: Worker & typeof globalThis = self as unknown as Worker &\n   typeof globalThis;\n \n-let tsEnv: VirtualTypeScriptEnvironment | null = null;\n-let compilerHost: CompilerHost | null = null;\n-\n interface TSCompileEvent extends MessageEvent {\n   data: {\n     type: 'compile';\n@@ -29,9 +26,9 @@ interface TSCompiledMessage {\n   error: string;\n }\n \n-interface InitRequestEvent extends MessageEvent {\n+interface CheckIsReadyRequestEvent extends MessageEvent {\n   data: {\n-    type: 'init';\n+    type: 'check-is-ready';\n   };\n }\n \n@@ -42,15 +39,23 @@ interface CancelEvent extends MessageEvent {\n   };\n }\n \n+const TS_VERSION = '5'; // hardcoding for now, in the future this may be dynamic\n+\n+let tsEnv: VirtualTypeScriptEnvironment | null = null;\n+let compilerHost: CompilerHost | null = null;\n let cachedVersion: string | null = null;\n \n-async function setupTypeScript(version: string) {\n-  // TODO: make sure no racing happens if multiple inits arrive at once.\n-  if (cachedVersion == version) return tsEnv;\n+// NOTE: vfs.globals must only be imported once, otherwise it will throw.\n+importScripts('https://unpkg.com/@typescript/vfs@1.6.0/dist/vfs.globals.js');\n \n+function importTS(version: string) {\n+  if (cachedVersion == version) return;\n   importScripts('https://unpkg.com/typescript@' + version);\n-  importScripts('https://unpkg.com/@typescript/vfs@1.6.0/dist/vfs.globals.js');\n+  cachedVersion = version;\n+}\n \n+async function setupTypeScript() {\n+  importTS(TS_VERSION);\n   const compilerOptions: CompilerOptions = {\n     target: ts.ScriptTarget.ES2015,\n     skipLibCheck: true // TODO: look into why this is needed. Are we doing something wrong? Could it be that it's not \"synced\"  with this TS version?\n@@ -87,34 +92,31 @@ async function setupTypeScript(version: string) {\n   // We freeze this to prevent learners from getting the worker into a\n   // weird state.\n   Object.freeze(self);\n-\n-  cachedVersion = version;\n   return env;\n }\n \n-// TODO: figure out how to start setting up TS in the background, but allow the\n-// client to wait for it to be ready. Currently the waiting works, but the setup\n-// is done on demand.\n-// void setupTypeScript('5');\n-\n-ctx.onmessage = (e: TSCompileEvent | InitRequestEvent | CancelEvent) => {\n+ctx.onmessage = (\n+  e: TSCompileEvent | CheckIsReadyRequestEvent | CancelEvent\n+) => {\n   const { data, ports } = e;\n-  if (data.type === 'init') {\n-    void handleInitRequest(ports[0]);\n+  if (data.type === 'check-is-ready') {\n+    void handleCheckIsReadyRequest(ports[0]);\n   } else if (data.type === 'cancel') {\n     handleCancelRequest(data);\n   } else {\n     handleCompileRequest(data, ports[0]);\n   }\n };\n \n+const isTSSetup = setupTypeScript();\n+\n // This lets the client know that there is nothing to cancel.\n function handleCancelRequest({ value }: { value: number }) {\n   postMessage({ type: 'is-alive', text: value });\n }\n \n-async function handleInitRequest(port: MessagePort) {\n-  await setupTypeScript('5');\n+async function handleCheckIsReadyRequest(port: MessagePort) {\n+  await isTSSetup;\n   port.postMessage({ type: 'ready' });\n }\n "
        },
        {
            "sha": "fd73f31d98615ff3a4a525cb388b9e84d75a06f1",
            "filename": "tools/client-plugins/browser-scripts/utils/format.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Futils%2Fformat.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Futils%2Fformat.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Futils%2Fformat.js?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -1,7 +1,7 @@\n // TODO: this is a straight up copy of the format function from the client.\n // Figure out a way to share it.\n \n-import { inspect } from 'util/util';\n+import { inspect } from 'util/util.js';\n \n export function format(x) {\n   // we're trying to mimic console.log, so we avoid wrapping strings in quotes:"
        },
        {
            "sha": "21b6a085446fa05810f27f2ff9d6804bef13fc9b",
            "filename": "tools/client-plugins/browser-scripts/webpack.config.cjs",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Fwebpack.config.cjs",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c7936b44b98b79d55c280c1755471f4dfeb68aaa/tools%2Fclient-plugins%2Fbrowser-scripts%2Fwebpack.config.cjs",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Fwebpack.config.cjs?ref=c7936b44b98b79d55c280c1755471f4dfeb68aaa",
            "patch": "@@ -84,7 +84,7 @@ module.exports = (env = {}) => {\n     resolve: {\n       fallback: {\n         buffer: require.resolve('buffer'),\n-        util: false,\n+        util: require.resolve('util'),\n         stream: false,\n         process: require.resolve('process/browser.js')\n       },",
            "previous_filename": "tools/client-plugins/browser-scripts/webpack.config.js"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 44,
        "deletions": 32
    }
}