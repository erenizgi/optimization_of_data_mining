{
    "author": "ojeytonwilliams",
    "message": "fix(api): delete user's exam attempts with account (#57079)",
    "sha": "88e2ff6eab1df385d6f36c5bae8bc25b81d4537d",
    "files": [
        {
            "sha": "2a863283b1f8af6df1081548f17545c0ba25d214",
            "filename": "api/__mocks__/env-exam.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2F__mocks__%2Fenv-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2F__mocks__%2Fenv-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fenv-exam.ts?ref=88e2ff6eab1df385d6f36c5bae8bc25b81d4537d",
            "patch": "@@ -343,9 +343,7 @@ export const exam: EnvExam = {\n };\n \n export async function seedEnvExam() {\n-  await fastifyTestInstance.prisma.envExamAttempt.deleteMany({});\n-  await fastifyTestInstance.prisma.envGeneratedExam.deleteMany({});\n-  await fastifyTestInstance.prisma.envExam.deleteMany({});\n+  await clearEnvExam();\n \n   await fastifyTestInstance.prisma.envExam.create({\n     data: exam\n@@ -369,3 +367,15 @@ export async function seedEnvExam() {\n   //   }\n   // }\n }\n+\n+export async function clearEnvExam() {\n+  await fastifyTestInstance.prisma.envExamAttempt.deleteMany({});\n+  await fastifyTestInstance.prisma.envGeneratedExam.deleteMany({});\n+  await fastifyTestInstance.prisma.envExam.deleteMany({});\n+}\n+\n+export async function seedEnvExamAttempt() {\n+  await fastifyTestInstance.prisma.envExamAttempt.create({\n+    data: examAttempt\n+  });\n+}"
        },
        {
            "sha": "914d557063cfa050a1d3238c902d3c07698eddc8",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=88e2ff6eab1df385d6f36c5bae8bc25b81d4537d",
            "patch": "@@ -277,7 +277,7 @@ model EnvExamAttempt {\n   needsRetake        Boolean\n \n   // Relations\n-  user          user             @relation(fields: [userId], references: [id])\n+  user          user             @relation(fields: [userId], references: [id], onDelete: Cascade)\n   exam          EnvExam          @relation(fields: [examId], references: [id])\n   generatedExam EnvGeneratedExam @relation(fields: [generatedExamId], references: [id])\n }"
        },
        {
            "sha": "7d88faec3bd13e547c2fe505bf1d345a9267c5f1",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=88e2ff6eab1df385d6f36c5bae8bc25b81d4537d",
            "patch": "@@ -42,6 +42,10 @@ describe('/exam-environment/', () => {\n         res.body.examEnvironmentAuthorizationToken;\n     });\n \n+    afterAll(async () => {\n+      await mock.clearEnvExam();\n+    });\n+\n     describe('POST /exam-environment/exam/attempt', () => {\n       afterEach(async () => {\n         await fastifyTestInstance.prisma.envExamAttempt.deleteMany();"
        },
        {
            "sha": "8299ae7a02dda1b37f844cfd3cb59c7bebd20075",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/88e2ff6eab1df385d6f36c5bae8bc25b81d4537d/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=88e2ff6eab1df385d6f36c5bae8bc25b81d4537d",
            "patch": "@@ -16,6 +16,11 @@ import {\n   createSuperRequest\n } from '../../../jest.utils';\n import { JWT_SECRET } from '../../utils/env';\n+import {\n+  clearEnvExam,\n+  seedEnvExam,\n+  seedEnvExamAttempt\n+} from '../../../__mocks__/env-exam';\n import { getMsTranscriptApiUrl } from './user';\n \n const mockedFetch = jest.fn();\n@@ -336,13 +341,18 @@ describe('userRoutes', () => {\n     });\n \n     describe('/account/delete', () => {\n+      beforeEach(async () => {\n+        await seedEnvExam();\n+        await seedEnvExamAttempt();\n+      });\n       afterEach(async () => {\n         await fastifyTestInstance.prisma.userToken.deleteMany({\n           where: { OR: [{ userId: defaultUserId }, { userId: otherUserId }] }\n         });\n         await fastifyTestInstance.prisma.msUsername.deleteMany({\n           where: { OR: [{ userId: defaultUserId }, { userId: otherUserId }] }\n         });\n+        await clearEnvExam();\n       });\n \n       test('POST returns 200 status code with empty object', async () => {\n@@ -398,6 +408,18 @@ describe('userRoutes', () => {\n         );\n         expect(setCookie).toHaveLength(3);\n       });\n+\n+      test(\"POST deletes all the user's exam attempts\", async () => {\n+        const examAttempts =\n+          await fastifyTestInstance.prisma.envExamAttempt.findMany();\n+        expect(examAttempts).toHaveLength(1);\n+\n+        await superPost('/account/delete');\n+\n+        const examAttemptsAfter =\n+          await fastifyTestInstance.prisma.envExamAttempt.findMany();\n+        expect(examAttemptsAfter).toHaveLength(0);\n+      });\n     });\n \n     describe('/account/reset-progress', () => {"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 40,
        "deletions": 4
    }
}