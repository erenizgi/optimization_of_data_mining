{
    "author": "ShaunSHamilton",
    "message": "chore(api): prevent non-staff exam authz token gen on staging (#61786)\n\nCo-authored-by: Huyen Nguyen <25715018+huyenltnguyen@users.noreply.github.com>",
    "sha": "db9b7d2358989d12998c1795d453de0196315610",
    "files": [
        {
            "sha": "d8f853e090ce0164bf55e0924857b0a884f764e2",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=db9b7d2358989d12998c1795d453de0196315610",
            "patch": "@@ -20,7 +20,8 @@ jest.mock('../../utils/env', () => {\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n   return {\n     ...jest.requireActual('../../utils/env'),\n-    FCC_ENABLE_EXAM_ENVIRONMENT: 'true'\n+    FCC_ENABLE_EXAM_ENVIRONMENT: 'true',\n+    DEPLOYMENT_ENV: 'production'\n   };\n });\n "
        },
        {
            "sha": "0ac38b9ddc4e3b47045f5533007654f515930e4c",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=db9b7d2358989d12998c1795d453de0196315610",
            "patch": "@@ -29,6 +29,19 @@ import { getMsTranscriptApiUrl } from './user';\n const mockedFetch = jest.fn();\n jest.spyOn(globalThis, 'fetch').mockImplementation(mockedFetch);\n \n+let mockDeploymentEnv = 'staging';\n+jest.mock('../../utils/env', () => {\n+  const actualEnv = jest.requireActual('../../utils/env');\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+  return {\n+    ...actualEnv,\n+    get DEPLOYMENT_ENV() {\n+      return mockDeploymentEnv;\n+    },\n+    JWT_SECRET: actualEnv.JWT_SECRET\n+  };\n+});\n+\n // This is used to build a test user.\n const testUserData: Prisma.userCreateInput = {\n   ...createUserInput(defaultUserEmail),\n@@ -1273,6 +1286,14 @@ Thanks and regards,\n     });\n \n     describe('/user/exam-environment/token', () => {\n+      beforeEach(() => {\n+        mockDeploymentEnv = 'production';\n+      });\n+\n+      afterAll(() => {\n+        mockDeploymentEnv = 'staging';\n+      });\n+\n       afterEach(async () => {\n         await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.deleteMany(\n           {\n@@ -1335,6 +1356,44 @@ Thanks and regards,\n           );\n         expect(tokens).toHaveLength(1);\n       });\n+\n+      test('POST does not generate a new token in non-production environments for non-staff', async () => {\n+        // Override deployment environment for this test\n+        mockDeploymentEnv = 'development';\n+        const response = await superPost('/user/exam-environment/token');\n+        expect(response.status).toBe(403);\n+      });\n+\n+      test('POST does generate a new token in non-production environments for staff', async () => {\n+        // Override deployment environment for this test\n+        mockDeploymentEnv = 'staging';\n+        await fastifyTestInstance.prisma.user.update({\n+          where: {\n+            id: defaultUserId\n+          },\n+          data: { email: 'camperbot@freecodecamp.org' }\n+        });\n+\n+        const response = await superPost('/user/exam-environment/token');\n+        const { examEnvironmentAuthorizationToken } = response.body;\n+\n+        const decodedToken = jwt.decode(examEnvironmentAuthorizationToken);\n+\n+        expect(decodedToken).toStrictEqual({\n+          examEnvironmentAuthorizationToken:\n+            expect.stringMatching(/^[a-z0-9]{24}$/),\n+          iat: expect.any(Number)\n+        });\n+\n+        expect(() =>\n+          jwt.verify(examEnvironmentAuthorizationToken, 'wrong-secret')\n+        ).toThrow();\n+        expect(() =>\n+          jwt.verify(examEnvironmentAuthorizationToken, JWT_SECRET)\n+        ).not.toThrow();\n+\n+        expect(response.status).toBe(201);\n+      });\n     });\n   });\n "
        },
        {
            "sha": "a1b80ab50e724ffcf79b88228799b7ab87ee7e84",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=db9b7d2358989d12998c1795d453de0196315610",
            "patch": "@@ -27,11 +27,12 @@ import {\n   getPoints,\n   ProgressTimestamp\n } from '../../utils/progress';\n-import { JWT_SECRET } from '../../utils/env';\n+import { DEPLOYMENT_ENV, JWT_SECRET } from '../../utils/env';\n import {\n   getExamAttemptHandler,\n   getExamAttemptsHandler\n } from '../../exam-environment/routes/exam-environment';\n+import { ERRORS } from '../../exam-environment/utils/errors';\n \n /**\n  * Helper function to get the api url from the shared transcript link.\n@@ -498,7 +499,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n   done();\n };\n \n-// eslint-disable-next-line jsdoc/require-param\n+// eslint-disable-next-line jsdoc/require-param, jsdoc/require-returns\n /**\n  * Generate a new authorization token for the given user, and invalidates any existing tokens.\n  *\n@@ -515,6 +516,24 @@ async function examEnvironmentTokenHandler(\n   if (!userId) {\n     throw new Error('Unreachable. User should be authenticated.');\n   }\n+\n+  // In non-production environments, only staff are allowed to generate a token\n+  if (\n+    DEPLOYMENT_ENV !== 'production' &&\n+    (!req.user?.email?.endsWith('@freecodecamp.org') ||\n+      !req.user?.emailVerified)\n+  ) {\n+    logger.info(\n+      `User not allowed to generate authorization token on ${DEPLOYMENT_ENV}.`\n+    );\n+    void reply.code(403);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(\n+        `User not allowed to generate authorization token in ${DEPLOYMENT_ENV} environment.`\n+      )\n+    );\n+  }\n+\n   // Delete (invalidate) any existing tokens for the user.\n   await this.prisma.examEnvironmentAuthorizationToken.deleteMany({\n     where: {"
        },
        {
            "sha": "907f67f00538e0c17cc9e44c52888be7ae0642d2",
            "filename": "api/src/schemas/user/exam-environment-token.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Fschemas%2Fuser%2Fexam-environment-token.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Fschemas%2Fuser%2Fexam-environment-token.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fuser%2Fexam-environment-token.ts?ref=db9b7d2358989d12998c1795d453de0196315610",
            "patch": "@@ -1,9 +1,12 @@\n import { Type } from '@fastify/type-provider-typebox';\n+import { STANDARD_ERROR } from '../../exam-environment/utils/errors';\n \n export const userExamEnvironmentToken = {\n   response: {\n-    200: Type.Object({\n+    201: Type.Object({\n       examEnvironmentAuthorizationToken: Type.String()\n-    })\n+    }),\n+    403: STANDARD_ERROR\n+    // default: STANDARD_ERROR\n   }\n };"
        },
        {
            "sha": "736e59fd8432abbbaf5d8f574604a4b9257d7dd0",
            "filename": "api/src/utils/env.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Futils%2Fenv.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/db9b7d2358989d12998c1795d453de0196315610/api%2Fsrc%2Futils%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fenv.ts?ref=db9b7d2358989d12998c1795d453de0196315610",
            "patch": "@@ -47,6 +47,7 @@ If so, ensure that the environment variable JEST_WORKER_ID is set.`\n \n assert.ok(process.env.HOME_LOCATION);\n assert.ok(isAllowedEnv(_FREECODECAMP_NODE_ENV));\n+assert.ok(process.env.DEPLOYMENT_ENV);\n assert.ok(isAllowedProvider(_EMAIL_PROVIDER));\n assert.ok(process.env.AUTH0_CLIENT_ID);\n assert.ok(process.env.AUTH0_CLIENT_SECRET);\n@@ -191,6 +192,7 @@ export const FCC_ENABLE_SENTRY_ROUTES = undefinedOrBool(\n   process.env.FCC_ENABLE_SENTRY_ROUTES\n );\n export const FREECODECAMP_NODE_ENV = _FREECODECAMP_NODE_ENV;\n+export const DEPLOYMENT_ENV = process.env.DEPLOYMENT_ENV;\n export const SENTRY_DSN =\n   process.env.SENTRY_DSN === 'dsn_from_sentry_dashboard'\n     ? ''"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 89,
        "deletions": 5
    }
}