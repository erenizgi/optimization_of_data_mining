{
    "author": "ShaunSHamilton",
    "message": "feat(api): reuse exam generations (#62459)",
    "sha": "9abf0c970c725715ae3c34ad4e27a21468c05920",
    "files": [
        {
            "sha": "809342f78271a8dc876410f274ba4c5a43a6c298",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 79,
            "deletions": 25,
            "changes": 104,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9abf0c970c725715ae3c34ad4e27a21468c05920/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9abf0c970c725715ae3c34ad4e27a21468c05920/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=9abf0c970c725715ae3c34ad4e27a21468c05920",
            "patch": "@@ -270,8 +270,7 @@ describe('/exam-environment/', () => {\n     });\n \n     describe('POST /exam-environment/generated-exam', () => {\n-      afterEach(async () => {\n-        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n+      beforeEach(async () => {\n         // Add prerequisite id to user completed challenge\n         await fastifyTestInstance.prisma.user.update({\n           where: { id: defaultUserId },\n@@ -282,6 +281,9 @@ describe('/exam-environment/', () => {\n           }\n         });\n         await mock.seedEnvExam();\n+      });\n+      afterEach(async () => {\n+        await mock.clearEnvExam();\n         const a =\n           await fastifyTestInstance.prisma.examEnvironmentExamModeration.findMany(\n             {}\n@@ -471,27 +473,15 @@ describe('/exam-environment/', () => {\n         });\n       });\n \n-      it('should return an error if the database has insufficient generated exams', async () => {\n-        // Add completed attempt for generated exam\n-        const submittedAttempt = structuredClone(mock.examAttempt);\n-        const examTotalTimeInMS = mock.exam.config.totalTimeInS * 1000;\n-        // Long-enough ago to be considered \"submitted\", and not trigger cooldown\n-        submittedAttempt.startTimeInMS =\n-          Date.now() -\n-          24 * 60 * 60 * 1000 -\n-          examTotalTimeInMS -\n-          1 * 60 * 60 * 1000;\n-        submittedAttempt.startTime = new Date(\n-          Date.now() -\n-            24 * 60 * 60 * 1000 -\n-            examTotalTimeInMS -\n-            1 * 60 * 60 * 1000\n-        );\n-\n-        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n-          data: submittedAttempt\n+      it('should prioritise not-yet-taken generated exams, and reuse completed ones if necessary', async () => {\n+        // Create a second generated exams for the user\n+        const genExam1 = structuredClone(mock.generatedExam);\n+        genExam1.id = mock.oid();\n+        await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.create({\n+          data: genExam1\n         });\n \n+        // Request generated exam, thereby creating an attempt with one of the generated exam ids\n         const body: Static<typeof examEnvironmentPostExamGeneratedExam.body> = {\n           examId: mock.examId\n         };\n@@ -502,12 +492,76 @@ describe('/exam-environment/', () => {\n             examEnvironmentAuthorizationToken\n           );\n \n-        expect(res).toMatchObject({\n-          status: 500,\n-          body: {\n-            code: 'FCC_ERR_EXAM_ENVIRONMENT'\n+        expect(res.status).toBe(200);\n+\n+        // Finish attempt\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.update({\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access\n+          where: { id: res.body.examAttempt.id },\n+          data: {\n+            startTime: new Date(\n+              Date.now() -\n+                mock.exam.config.totalTimeInMS -\n+                mock.exam.config.retakeTimeInMS\n+            )\n+          }\n+        });\n+\n+        // Request generated exam again, which should use the other generated exam\n+        const res2 = await superPost('/exam-environment/exam/generated-exam')\n+          .send(body)\n+          .set(\n+            'exam-environment-authorization-token',\n+            examEnvironmentAuthorizationToken\n+          );\n+\n+        expect(res2.status).toBe(200);\n+\n+        // Expect examEnvironmentExamAttempt to include 2 records\n+        const eas =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.findMany({\n+            where: {\n+              userId: defaultUserId\n+            }\n+          });\n+\n+        expect(eas).toHaveLength(2);\n+        // Expect eas[].generatedExamId to not be the same\n+        const geIds = eas.map(ea => ea.generatedExamId);\n+        expect(geIds[0]).not.toBe(geIds[1]);\n+\n+        // Finish attempt\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.update({\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access\n+          where: { id: res2.body.examAttempt.id },\n+          data: {\n+            startTime: new Date(\n+              Date.now() -\n+                mock.exam.config.totalTimeInMS -\n+                mock.exam.config.retakeTimeInMS\n+            )\n           }\n         });\n+\n+        // Request generated exam again, which should reuse one of the generated exams\n+        const res3 = await superPost('/exam-environment/exam/generated-exam')\n+          .send(body)\n+          .set(\n+            'exam-environment-authorization-token',\n+            examEnvironmentAuthorizationToken\n+          );\n+\n+        expect(res3.status).toBe(200);\n+\n+        // Expect examEnvironmentExamAttempt to include 3 records, with only 2 unique `generatedExamId`s\n+        const eas2 =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.findMany({\n+            where: { userId: defaultUserId }\n+          });\n+\n+        expect(eas2).toHaveLength(3);\n+        const geIds2 = eas2.map(ea => ea.generatedExamId);\n+        expect(new Set(geIds2).size).toBe(2);\n       });\n \n       it('should record the fact the user has started an exam by creating an exam attempt', async () => {"
        },
        {
            "sha": "327c78f8d1e3f7213daf7c2aad8850f042882bde",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9abf0c970c725715ae3c34ad4e27a21468c05920/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9abf0c970c725715ae3c34ad4e27a21468c05920/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=9abf0c970c725715ae3c34ad4e27a21468c05920",
            "patch": "@@ -376,11 +376,7 @@ async function postExamGeneratedExamHandler(\n   const maybeGeneratedExams = await mapErr(\n     this.prisma.examEnvironmentGeneratedExam.findMany({\n       where: {\n-        // Find generated exams user has not already seen\n         examId: exam.id,\n-        id: {\n-          notIn: examAttempts.map(a => a.generatedExamId)\n-        },\n         deprecated: false\n       },\n       select: {\n@@ -403,21 +399,36 @@ async function postExamGeneratedExamHandler(\n   if (generatedExams.length === 0) {\n     const error = {\n       data: { examId: exam.id },\n-      message: `Unable to provide a generated exam. Either all generated exams have been exhausted, or all generated exams are deprecated.`\n+      message: `Unable to provide a generated exam. Either no generations exist, or all generated exams are deprecated.`\n     };\n     logger.error(error.data, error.message);\n     this.Sentry.captureException(error);\n     void reply.code(500);\n     return reply.send(ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message));\n   }\n \n-  const randomGeneratedExam =\n-    generatedExams[Math.floor(Math.random() * generatedExams.length)]!;\n+  // Randomly pick an exam from available generations, prioritising generations not already taken\n+  const untakenGeneratedExams = generatedExams.filter(\n+    ge => !examAttempts.find(ea => ea.generatedExamId === ge.id)\n+  );\n+  let randomGeneratedExamId: string;\n+  if (untakenGeneratedExams.length === 0) {\n+    logger.info(\n+      `User has taken all generated exams. Reusing previously taken generated exams.`\n+    );\n+    randomGeneratedExamId =\n+      generatedExams[Math.floor(Math.random() * generatedExams.length)]!.id;\n+  } else {\n+    randomGeneratedExamId =\n+      untakenGeneratedExams[\n+        Math.floor(Math.random() * untakenGeneratedExams.length)\n+      ]!.id;\n+  }\n \n   const maybeGeneratedExam = await mapErr(\n     this.prisma.examEnvironmentGeneratedExam.findFirst({\n       where: {\n-        id: randomGeneratedExam.id\n+        id: randomGeneratedExamId\n       }\n     })\n   );\n@@ -439,7 +450,7 @@ async function postExamGeneratedExamHandler(\n \n   if (generatedExam === null) {\n     const error = {\n-      data: { generatedExamId: randomGeneratedExam.id },\n+      data: { generatedExamId: randomGeneratedExamId },\n       message: 'Unreachable. Generated exam not found.'\n     };\n     logger.error(error.data, 'Unreachable. Generated exam not found.');"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 99,
        "deletions": 34
    }
}