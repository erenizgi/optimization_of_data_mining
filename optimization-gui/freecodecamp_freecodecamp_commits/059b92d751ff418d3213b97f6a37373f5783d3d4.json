{
    "author": "ojeytonwilliams",
    "message": "refactor(client): use functional component for exams (#57398)",
    "sha": "059b92d751ff418d3213b97f6a37373f5783d3d4",
    "files": [
        {
            "sha": "8e59ab95afd3f1c577070c1ccc1da49d7bb765ce",
            "filename": "client/src/templates/Challenges/exam/show.tsx",
            "status": "modified",
            "additions": 282,
            "deletions": 324,
            "changes": 606,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/059b92d751ff418d3213b97f6a37373f5783d3d4/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam%2Fshow.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/059b92d751ff418d3213b97f6a37373f5783d3d4/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam%2Fshow.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam%2Fshow.tsx?ref=059b92d751ff418d3213b97f6a37373f5783d3d4",
            "patch": "@@ -1,7 +1,7 @@\n // Package Utilities\n import { graphql, navigate } from 'gatsby';\n \n-import React, { Component, RefObject } from 'react';\n+import React, { useEffect, useRef, useState } from 'react';\n import Helmet from 'react-helmet';\n import type { TFunction } from 'i18next';\n import { withTranslation } from 'react-i18next';\n@@ -136,43 +136,54 @@ interface ShowExamProps {\n   updateChallengeMeta: (arg0: ChallengeMeta) => void;\n }\n \n-interface ShowExamState {\n-  currentQuestionIndex: number;\n-  examTimeInSeconds: number;\n-  generatedExamQuestions: GeneratedExamQuestion[];\n-  userExamQuestions: UserExamQuestion[];\n-  showResults: boolean;\n-}\n-\n function convertMd(md: string): string {\n   return micromark(md);\n }\n \n-class ShowExam extends Component<ShowExamProps, ShowExamState> {\n-  static displayName: string;\n-  private container: RefObject<HTMLElement> | undefined = React.createRef();\n-  timerInterval!: NodeJS.Timeout;\n-\n-  constructor(props: ShowExamProps) {\n-    super(props);\n-    this.state = {\n-      currentQuestionIndex: 0,\n-      generatedExamQuestions: [],\n-      examTimeInSeconds: 0,\n-      userExamQuestions: [],\n-      showResults: false\n-    };\n+function ShowExam(props: ShowExamProps) {\n+  const {\n+    data: {\n+      challengeNode: {\n+        challenge: {\n+          block,\n+          dashedName,\n+          description,\n+          fields: { blockName },\n+          instructions,\n+          prerequisites,\n+          superBlock,\n+          title,\n+          translationPending\n+        }\n+      }\n+    },\n+    examInProgress,\n+    examResults,\n+    completedChallenges,\n+    completedSurveys,\n+    isChallengeCompleted,\n+    openExitExamModal,\n+    openFinishExamModal,\n+    pageContext: {\n+      challengeMeta: { nextChallengePath, prevChallengePath }\n+    },\n+    t\n+  } = props;\n \n-    this.runExam = this.runExam.bind(this);\n-    this.goToPreviousQuestion = this.goToPreviousQuestion.bind(this);\n-    this.goToNextQuestion = this.goToNextQuestion.bind(this);\n-    this.selectAnswer = this.selectAnswer.bind(this);\n-    this.finishExam = this.finishExam.bind(this);\n-    this.exitExam = this.exitExam.bind(this);\n-    this.cleanUp = this.cleanUp.bind(this);\n-  }\n+  let timerInterval: NodeJS.Timeout;\n+\n+  const container = useRef<HTMLElement>(null);\n \n-  componentDidMount(): void {\n+  const [examTimeInSeconds, setExamTimeInSeconds] = useState(0);\n+  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n+  const [generatedExamQuestions, setGeneratedExamQuestions] = useState<\n+    GeneratedExamQuestion[]\n+  >([]);\n+  const [userExamQuestions, setUserExamQuestions] = useState<\n+    UserExamQuestion[]\n+  >([]);\n+\n+  useEffect(() => {\n     const {\n       challengeMounted,\n       data: {\n@@ -188,7 +199,7 @@ class ShowExam extends Component<ShowExamProps, ShowExamState> {\n       pageContext: { challengeMeta },\n       initTests,\n       updateChallengeMeta\n-    } = this.props;\n+    } = props;\n     initTests(tests);\n     updateChallengeMeta({\n       ...challengeMeta,\n@@ -198,26 +209,31 @@ class ShowExam extends Component<ShowExamProps, ShowExamState> {\n     });\n     challengeMounted(challengeMeta.id);\n \n-    this.container?.current?.focus();\n-  }\n+    container.current?.focus();\n \n-  componentWillUnmount() {\n-    this.cleanUp();\n-    this.props.stopExam();\n-  }\n+    return () => {\n+      cleanUp();\n+      props.stopExam();\n+    };\n+    // eslint-disable-next-line react-hooks/exhaustive-deps\n+  }, []);\n \n-  stopWindowClose = (event: Event) => {\n+  // Normally you would clear listeners in a useEffect cleanup function, but we\n+  // need to set them in the runExam function (rather than in a useEffect). The\n+  // refs make them stable across renders and thus removable.\n+  const stopWindowCloseRef = useRef((event: Event) => {\n     event.preventDefault();\n-    alert(this.props.t('misc.navigation-warning'));\n-  };\n+    alert(props.t('misc.navigation-warning'));\n+  });\n \n-  stopBrowserBack = (event: Event) => {\n+  const stopBrowserBackRef = useRef((event: Event) => {\n     event.preventDefault();\n     window.history.forward();\n-    alert(this.props.t('misc.navigation-warning'));\n-  };\n+    // TODO: useTranslation\n+    alert(props.t('misc.navigation-warning'));\n+  });\n \n-  runExam = async () => {\n+  const runExam = async () => {\n     // TODO: show loader\n     const {\n       createFlashMessage,\n@@ -226,13 +242,15 @@ class ShowExam extends Component<ShowExamProps, ShowExamState> {\n           challenge: { id: challengeId }\n         }\n       }\n-    } = this.props;\n+    } = props;\n \n     const generateExamResponse = await getGenerateExam(challengeId);\n     const { response, data } = generateExamResponse;\n \n     if (response.status === 200) {\n-      const { generatedExam = [] } = data;\n+      const { generatedExam = [] } = data as {\n+        generatedExam: GeneratedExamQuestion[];\n+      };\n       const emptyUserExamQuestions = generatedExam.map(q => {\n         return {\n           id: q.id,\n@@ -241,24 +259,17 @@ class ShowExam extends Component<ShowExamProps, ShowExamState> {\n         };\n       }) as UserExamQuestion[];\n \n-      this.setState(\n-        {\n-          generatedExamQuestions: generatedExam,\n-          userExamQuestions: emptyUserExamQuestions\n-        },\n-        () => {\n-          this.timerInterval = setInterval(() => {\n-            this.setState({\n-              examTimeInSeconds: this.state.examTimeInSeconds + 1\n-            });\n-          }, 1000);\n-\n-          this.props.startExam();\n-\n-          window.addEventListener('beforeunload', this.stopWindowClose);\n-          window.addEventListener('popstate', this.stopBrowserBack);\n-        }\n-      );\n+      setGeneratedExamQuestions(generatedExam);\n+      setUserExamQuestions(emptyUserExamQuestions);\n+\n+      timerInterval = setInterval(() => {\n+        setExamTimeInSeconds(t => t + 1);\n+      }, 1000);\n+\n+      props.startExam();\n+\n+      window.addEventListener('beforeunload', stopWindowCloseRef.current);\n+      window.addEventListener('popstate', stopBrowserBackRef.current);\n     } else {\n       createFlashMessage({\n         type: 'danger',\n@@ -267,55 +278,47 @@ class ShowExam extends Component<ShowExamProps, ShowExamState> {\n     }\n   };\n \n-  selectAnswer = (index: number, id: string, answer: string): void => {\n-    const newUserExamQuestions = Array.from(this.state.userExamQuestions);\n+  const selectAnswer = (index: number, id: string, answer: string): void => {\n+    const newUserExamQuestions = Array.from(userExamQuestions);\n     newUserExamQuestions[index].answer.id = id;\n     newUserExamQuestions[index].answer.answer = answer;\n-    this.setState({\n-      userExamQuestions: newUserExamQuestions\n-    });\n+    setUserExamQuestions(newUserExamQuestions);\n   };\n \n-  goToPreviousQuestion = () => {\n-    this.setState({\n-      currentQuestionIndex: this.state.currentQuestionIndex - 1\n-    });\n+  const goToPreviousQuestion = () => {\n+    setCurrentQuestionIndex(currentQuestionIndex - 1);\n   };\n \n-  goToNextQuestion = () => {\n-    this.setState({\n-      currentQuestionIndex: this.state.currentQuestionIndex + 1\n-    });\n+  const goToNextQuestion = () => {\n+    setCurrentQuestionIndex(currentQuestionIndex + 1);\n   };\n \n-  cleanUp = () => {\n-    clearInterval(this.timerInterval);\n-    this.setState({\n-      examTimeInSeconds: 0,\n-      currentQuestionIndex: 0\n-    });\n+  const cleanUp = () => {\n+    clearInterval(timerInterval);\n \n-    window.removeEventListener('beforeunload', this.stopWindowClose);\n-    window.removeEventListener('popstate', this.stopBrowserBack);\n+    setExamTimeInSeconds(0);\n+    setCurrentQuestionIndex(0);\n \n-    this.props.clearExamResults();\n-    this.props.closeExitExamModal();\n-    this.props.closeFinishExamModal();\n+    window.removeEventListener('beforeunload', stopWindowCloseRef.current);\n+    window.removeEventListener('popstate', stopBrowserBackRef.current);\n+\n+    props.clearExamResults();\n+    props.closeExitExamModal();\n+    props.closeFinishExamModal();\n   };\n \n-  finishExam = () => {\n+  const finishExam = () => {\n     // TODO: show loader\n-    this.cleanUp();\n+    cleanUp();\n \n-    const { setUserCompletedExam, submitChallenge } = this.props;\n-    const { userExamQuestions, examTimeInSeconds } = this.state;\n+    const { setUserCompletedExam, submitChallenge } = props;\n \n     setUserCompletedExam({ userExamQuestions, examTimeInSeconds });\n     submitChallenge();\n   };\n \n-  exitExam = () => {\n-    this.cleanUp();\n+  const exitExam = () => {\n+    cleanUp();\n \n     const {\n       data: {\n@@ -326,262 +329,217 @@ class ShowExam extends Component<ShowExamProps, ShowExamState> {\n         }\n       },\n       stopExam\n-    } = this.props;\n+    } = props;\n     stopExam();\n     void navigate(blockHashSlug);\n   };\n \n-  render() {\n-    const {\n-      data: {\n-        challengeNode: {\n-          challenge: {\n-            block,\n-            dashedName,\n-            description,\n-            fields: { blockName },\n-            instructions,\n-            prerequisites,\n-            superBlock,\n-            title,\n-            translationPending\n-          }\n-        }\n-      },\n-      examInProgress,\n-      examResults,\n-      completedChallenges,\n-      completedSurveys,\n-      isChallengeCompleted,\n-      openExitExamModal,\n-      openFinishExamModal,\n-      pageContext: {\n-        challengeMeta: { nextChallengePath, prevChallengePath }\n-      },\n-      t\n-    } = this.props;\n-\n-    const {\n-      examTimeInSeconds,\n-      currentQuestionIndex,\n-      generatedExamQuestions,\n-      userExamQuestions\n-    } = this.state;\n-\n-    let missingPrerequisites: PrerequisiteChallenge[] = [];\n-    if (prerequisites) {\n-      missingPrerequisites = prerequisites?.filter(\n-        prerequisite =>\n-          !completedChallenges.find(({ id }) => prerequisite.id === id)\n-      );\n-    }\n-\n-    const surveyCompleted = completedSurveys.some(\n-      s => s.title === 'Foundational C# with Microsoft Survey'\n+  let missingPrerequisites: PrerequisiteChallenge[] = [];\n+  if (prerequisites) {\n+    missingPrerequisites = prerequisites?.filter(\n+      prerequisite =>\n+        !completedChallenges.find(({ id }) => prerequisite.id === id)\n     );\n-    const prerequisitesComplete = missingPrerequisites.length === 0;\n-    const qualifiedForExam = prerequisitesComplete && surveyCompleted;\n-\n-    const blockNameTitle = `${t(\n-      `intro:${superBlock}.blocks.${block}.title`\n-    )}: ${title}`;\n-    const windowTitle = `${blockNameTitle} | freeCodeCamp.org`;\n-\n-    // TODO: If already taken exam, show different messages\n-\n-    return examInProgress ? (\n-      <Container>\n-        <Row>\n-          <Spacer size='m' />\n-          <Col md={10} mdOffset={1} sm={10} smOffset={1} xs={12}>\n-            {examResults ? (\n-              <ExamResults\n-                dashedName={dashedName}\n-                title={title}\n-                examResults={examResults}\n-                exitExam={this.exitExam}\n-              />\n-            ) : (\n-              <div className='exam-wrapper'>\n-                <div className='exam-header'>\n-                  <div data-playwright-test-label='exam-show-title'>\n-                    {title}\n-                  </div>\n-                  <span>|</span>\n-                  <div data-playwright-test-label='exam-show-question-time'>\n-                    {t('learn.exam.time', {\n-                      t: formatSecondsToTime(examTimeInSeconds)\n-                    })}\n-                  </div>\n-                  <span>|</span>\n-                  <div>\n-                    {t('learn.exam.questions', {\n-                      n: currentQuestionIndex + 1,\n-                      t: generatedExamQuestions.length\n-                    })}\n-                  </div>\n+  }\n+\n+  const surveyCompleted = completedSurveys.some(\n+    s => s.title === 'Foundational C# with Microsoft Survey'\n+  );\n+  const prerequisitesComplete = missingPrerequisites.length === 0;\n+  const qualifiedForExam = prerequisitesComplete && surveyCompleted;\n+\n+  const blockNameTitle = `${t(\n+    `intro:${superBlock}.blocks.${block}.title`\n+  )}: ${title}`;\n+  const windowTitle = `${blockNameTitle} | freeCodeCamp.org`;\n+\n+  // TODO: If already taken exam, show different messages\n+\n+  return examInProgress ? (\n+    <Container>\n+      <Row>\n+        <Spacer size='m' />\n+        <Col md={10} mdOffset={1} sm={10} smOffset={1} xs={12}>\n+          {examResults ? (\n+            <ExamResults\n+              dashedName={dashedName}\n+              title={title}\n+              examResults={examResults}\n+              exitExam={exitExam}\n+            />\n+          ) : (\n+            <div className='exam-wrapper'>\n+              <div className='exam-header'>\n+                <div data-playwright-test-label='exam-show-title'>{title}</div>\n+                <span>|</span>\n+                <div data-playwright-test-label='exam-show-question-time'>\n+                  {t('learn.exam.time', {\n+                    t: formatSecondsToTime(examTimeInSeconds)\n+                  })}\n                 </div>\n-                <hr />\n-                <Spacer size='m' />\n-\n-                <div className='exam-questions'>\n-                  <PrismFormatted\n-                    text={convertMd(\n-                      generatedExamQuestions[currentQuestionIndex].question\n-                    )}\n-                  />\n-\n-                  <Spacer size='l' />\n-                  <div className='exam-answers'>\n-                    {generatedExamQuestions[currentQuestionIndex].answers.map(\n-                      ({ answer, id }) => (\n-                        <label className='exam-answer-label' key={id}>\n-                          <input\n-                            checked={\n-                              userExamQuestions[currentQuestionIndex].answer\n-                                .id === id\n-                            }\n-                            className='sr-only'\n-                            name={id}\n-                            onChange={() =>\n-                              this.selectAnswer(\n-                                currentQuestionIndex,\n-                                id,\n-                                answer\n-                              )\n-                            }\n-                            type='radio'\n-                            value={id}\n-                          />{' '}\n-                          <span className='exam-answer-input-visible'>\n-                            {userExamQuestions[currentQuestionIndex].answer\n-                              .id === id ? (\n-                              <span className='exam-answer-input-selected' />\n-                            ) : null}\n-                          </span>\n-                          <PrismFormatted text={convertMd(answer)} />\n-                        </label>\n-                      )\n-                    )}\n-                  </div>\n+                <span>|</span>\n+                <div>\n+                  {t('learn.exam.questions', {\n+                    n: currentQuestionIndex + 1,\n+                    t: generatedExamQuestions.length\n+                  })}\n                 </div>\n+              </div>\n+              <hr />\n+              <Spacer size='m' />\n+\n+              <div className='exam-questions'>\n+                <PrismFormatted\n+                  text={convertMd(\n+                    generatedExamQuestions[currentQuestionIndex].question\n+                  )}\n+                />\n+\n                 <Spacer size='l' />\n+                <div className='exam-answers'>\n+                  {generatedExamQuestions[currentQuestionIndex].answers.map(\n+                    ({ answer, id }) => (\n+                      <label className='exam-answer-label' key={id}>\n+                        <input\n+                          checked={\n+                            userExamQuestions[currentQuestionIndex].answer\n+                              .id === id\n+                          }\n+                          className='sr-only'\n+                          name={id}\n+                          onChange={() =>\n+                            selectAnswer(currentQuestionIndex, id, answer)\n+                          }\n+                          type='radio'\n+                          value={id}\n+                        />{' '}\n+                        <span className='exam-answer-input-visible'>\n+                          {userExamQuestions[currentQuestionIndex].answer.id ===\n+                          id ? (\n+                            <span className='exam-answer-input-selected' />\n+                          ) : null}\n+                        </span>\n+                        <PrismFormatted text={convertMd(answer)} />\n+                      </label>\n+                    )\n+                  )}\n+                </div>\n+              </div>\n+              <Spacer size='l' />\n \n-                <div className='exam-buttons'>\n+              <div className='exam-buttons'>\n+                <Button\n+                  block={true}\n+                  className='exam-button'\n+                  disabled={currentQuestionIndex <= 0}\n+                  variant='primary'\n+                  onClick={goToPreviousQuestion}\n+                >\n+                  {t('buttons.previous-question')}\n+                </Button>\n+\n+                {currentQuestionIndex === generatedExamQuestions.length - 1 ? (\n                   <Button\n                     block={true}\n+                    disabled={\n+                      !userExamQuestions[currentQuestionIndex].answer.id\n+                    }\n                     className='exam-button'\n-                    disabled={currentQuestionIndex <= 0}\n                     variant='primary'\n-                    onClick={this.goToPreviousQuestion}\n+                    onClick={openFinishExamModal}\n                   >\n-                    {t('buttons.previous-question')}\n+                    {t('buttons.finish-exam')}\n                   </Button>\n-\n-                  {currentQuestionIndex ===\n-                  generatedExamQuestions.length - 1 ? (\n-                    <Button\n-                      block={true}\n-                      disabled={\n-                        !userExamQuestions[currentQuestionIndex].answer.id\n-                      }\n-                      className='exam-button'\n-                      variant='primary'\n-                      onClick={openFinishExamModal}\n-                    >\n-                      {t('buttons.finish-exam')}\n-                    </Button>\n-                  ) : (\n-                    <Button\n-                      block={true}\n-                      disabled={\n-                        !userExamQuestions[currentQuestionIndex].answer.id\n-                      }\n-                      className='exam-button'\n-                      variant='primary'\n-                      onClick={this.goToNextQuestion}\n-                    >\n-                      {t('buttons.next-question')}\n-                    </Button>\n-                  )}\n-                </div>\n-\n-                <Spacer size='m' />\n-\n-                <div className='exam-buttons'>\n+                ) : (\n                   <Button\n                     block={true}\n+                    disabled={\n+                      !userExamQuestions[currentQuestionIndex].answer.id\n+                    }\n                     className='exam-button'\n                     variant='primary'\n-                    onClick={openExitExamModal}\n+                    onClick={goToNextQuestion}\n                   >\n-                    {t('buttons.exit-exam')}\n+                    {t('buttons.next-question')}\n                   </Button>\n-                </div>\n-              </div>\n-            )}\n-          </Col>\n-          <ExitExamModal exitExam={this.exitExam} />\n-          <FinishExamModal finishExam={this.finishExam} />\n-        </Row>\n-      </Container>\n-    ) : (\n-      <Hotkeys\n-        containerRef={this.container}\n-        nextChallengePath={nextChallengePath}\n-        prevChallengePath={prevChallengePath}\n-      >\n-        <LearnLayout>\n-          <Helmet title={windowTitle} />\n-          <Container>\n-            <Row>\n-              <Col md={8} mdOffset={2} sm={10} smOffset={1} xs={12}>\n-                <ChallengeTitle\n-                  isCompleted={isChallengeCompleted}\n-                  translationPending={translationPending}\n-                >\n-                  {title}\n-                </ChallengeTitle>\n-                <Spacer size='m' />\n-\n-                {qualifiedForExam ? (\n-                  <Alert variant='info'>\n-                    <p>{t('learn.exam.qualified')}</p>\n-                  </Alert>\n-                ) : (\n-                  <>\n-                    {!prerequisitesComplete ? (\n-                      <MissingPrerequisites\n-                        missingPrerequisites={missingPrerequisites}\n-                      />\n-                    ) : (\n-                      <FoundationalCSharpSurveyAlert />\n-                    )}\n-                  </>\n                 )}\n-                <PrismFormatted text={description} />\n-                <Spacer size='m' />\n-                <PrismFormatted text={instructions} />\n+              </div>\n+\n+              <Spacer size='m' />\n \n+              <div className='exam-buttons'>\n                 <Button\n                   block={true}\n+                  className='exam-button'\n                   variant='primary'\n-                  disabled={!qualifiedForExam}\n-                  // `this.runExam` being an async callback is acceptable\n-                  //eslint-disable-next-line @typescript-eslint/no-misused-promises\n-                  onClick={this.runExam}\n+                  onClick={openExitExamModal}\n                 >\n-                  {t('buttons.click-start-exam')}\n+                  {t('buttons.exit-exam')}\n                 </Button>\n-              </Col>\n-              <CompletionModal />\n-              <HelpModal challengeTitle={title} challengeBlock={blockName} />\n-            </Row>\n-          </Container>\n-        </LearnLayout>\n-      </Hotkeys>\n-    );\n-  }\n+              </div>\n+            </div>\n+          )}\n+        </Col>\n+        <ExitExamModal exitExam={exitExam} />\n+        <FinishExamModal finishExam={finishExam} />\n+      </Row>\n+    </Container>\n+  ) : (\n+    <Hotkeys\n+      containerRef={container}\n+      nextChallengePath={nextChallengePath}\n+      prevChallengePath={prevChallengePath}\n+    >\n+      <LearnLayout>\n+        <Helmet title={windowTitle} />\n+        <Container>\n+          <Row>\n+            <Col md={8} mdOffset={2} sm={10} smOffset={1} xs={12}>\n+              <ChallengeTitle\n+                isCompleted={isChallengeCompleted}\n+                translationPending={translationPending}\n+              >\n+                {title}\n+              </ChallengeTitle>\n+              <Spacer size='m' />\n+\n+              {qualifiedForExam ? (\n+                <Alert variant='info'>\n+                  <p>{t('learn.exam.qualified')}</p>\n+                </Alert>\n+              ) : (\n+                <>\n+                  {!prerequisitesComplete ? (\n+                    <MissingPrerequisites\n+                      missingPrerequisites={missingPrerequisites}\n+                    />\n+                  ) : (\n+                    <FoundationalCSharpSurveyAlert />\n+                  )}\n+                </>\n+              )}\n+              <PrismFormatted text={description} />\n+              <Spacer size='m' />\n+              <PrismFormatted text={instructions} />\n+\n+              <Button\n+                block={true}\n+                variant='primary'\n+                disabled={!qualifiedForExam}\n+                // `runExam` being an async callback is acceptable\n+                //eslint-disable-next-line @typescript-eslint/no-misused-promises\n+                onClick={runExam}\n+              >\n+                {t('buttons.click-start-exam')}\n+              </Button>\n+            </Col>\n+            <CompletionModal />\n+            <HelpModal challengeTitle={title} challengeBlock={blockName} />\n+          </Row>\n+        </Container>\n+      </LearnLayout>\n+    </Hotkeys>\n+  );\n }\n \n ShowExam.displayName = 'ShowExam';"
        }
    ],
    "stats": {
        "total": 606,
        "additions": 282,
        "deletions": 324
    }
}