{
    "author": "ShaunSHamilton",
    "message": "breaking(api): remove submission time from exam env (#57365)",
    "sha": "9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
    "files": [
        {
            "sha": "e56d7b0512284c437d2d71ae342aa6a78f47e158",
            "filename": "api/__mocks__/env-exam.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2F__mocks__%2Fenv-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2F__mocks__%2Fenv-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fenv-exam.ts?ref=9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
            "patch": "@@ -45,7 +45,8 @@ export const config: EnvConfig = {\n       numberOfCorrectAnswers: 1,\n       numberOfIncorrectAnswers: 1\n     }\n-  ]\n+  ],\n+  retakeTimeInMS: 24 * 60 * 60 * 1000\n };\n \n export const questionSets: EnvQuestionSet[] = [\n@@ -292,8 +293,7 @@ export const examAttempt: EnvExamAttempt = {\n     }\n   ],\n   startTimeInMS: Date.now(),\n-  userId: defaultUserId,\n-  submissionTimeInMS: null\n+  userId: defaultUserId\n };\n \n export const examAttemptSansSubmissionTimeInMS: Static<"
        },
        {
            "sha": "99064a35afdaad47c7539a7ef5f77dd98a5cdb98",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 10,
            "deletions": 13,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
            "patch": "@@ -223,15 +223,17 @@ type EnvAnswer {\n /// Configuration for an exam in the Exam Environment App\n type EnvConfig {\n   /// Human-readable exam name\n-  name          String\n+  name           String\n   /// Notes given about exam\n-  note          String\n+  note           String\n   /// Category configuration for question selection\n-  tags          EnvTagConfig[]\n+  tags           EnvTagConfig[]\n   /// Total time allocated for exam in milliseconds\n-  totalTimeInMS Int\n+  totalTimeInMS  Int\n   /// Configuration for sets of questions\n-  questionSets  EnvQuestionSetConfig[]\n+  questionSets   EnvQuestionSetConfig[]\n+  /// Duration after exam completion before a retake is allowed in milliseconds\n+  retakeTimeInMS Int\n }\n \n /// Configuration for a set of questions in the Exam Environment App\n@@ -267,14 +269,10 @@ model EnvExamAttempt {\n   /// Foreign key to generated exam id\n   generatedExamId String @db.ObjectId\n \n-  questionSets       EnvQuestionSetAttempt[]\n+  questionSets  EnvQuestionSetAttempt[]\n   /// Time exam was started as milliseconds since epoch\n-  startTimeInMS      Int\n-  /// Time exam was submitted as milliseconds since epoch\n-  ///\n-  /// As attempt might not be submitted (disconnection or quit), field is optional\n-  submissionTimeInMS Int?\n-  needsRetake        Boolean\n+  startTimeInMS Int\n+  needsRetake   Boolean\n \n   // Relations\n   user          user             @relation(fields: [userId], references: [id], onDelete: Cascade)\n@@ -301,7 +299,6 @@ type EnvMultipleChoiceQuestionAttempt {\n /// A generated exam for the Exam Environment App\n ///\n /// This is the user-facing information for an exam.\n-/// TODO: Add userId?\n model EnvGeneratedExam {\n   id           String                    @id @default(auto()) @map(\"_id\") @db.ObjectId\n   /// Foreign key to exam"
        },
        {
            "sha": "da4a1e02ec460b7091f1a6d91a04d1942e10b018",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
            "patch": "@@ -435,8 +435,6 @@ describe('/exam-environment/', () => {\n           24 * 60 * 60 * 1000 -\n           mock.exam.config.totalTimeInMS -\n           1 * 60 * 60 * 1000;\n-        submittedAttempt.submissionTimeInMS =\n-          Date.now() - mock.exam.config.totalTimeInMS - 24 * 60 * 60 * 1000;\n         await fastifyTestInstance.prisma.envExamAttempt.create({\n           data: submittedAttempt\n         });\n@@ -492,7 +490,6 @@ describe('/exam-environment/', () => {\n           generatedExamId: generatedExam!.id,\n           questionSets: [],\n           needsRetake: false,\n-          submissionTimeInMS: null,\n           // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n           startTimeInMS: expect.any(Number)\n         });\n@@ -579,7 +576,8 @@ describe('/exam-environment/', () => {\n               config: {\n                 name: mock.exam.config.name,\n                 note: mock.exam.config.note,\n-                totalTimeInMS: mock.exam.config.totalTimeInMS\n+                totalTimeInMS: mock.exam.config.totalTimeInMS,\n+                retakeTimeInMS: mock.exam.config.retakeTimeInMS\n               },\n               id: mock.examId\n             }"
        },
        {
            "sha": "ba310a9b749398eb477e2634b2673d93616962b6",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 34,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
            "patch": "@@ -8,7 +8,6 @@ import * as schemas from '../schemas';\n import { mapErr, syncMapErr, UpdateReqType } from '../../utils';\n import { JWT_SECRET } from '../../utils/env';\n import {\n-  checkAttemptAgainstGeneratedExam,\n   checkPrerequisites,\n   constructUserExam,\n   userAttemptToDatabaseAttemptQuestionSets,\n@@ -209,16 +208,13 @@ async function postExamGeneratedExamHandler(\n     : null;\n \n   if (lastAttempt) {\n-    const attemptIsExpired =\n-      lastAttempt.startTimeInMS + exam.config.totalTimeInMS < Date.now();\n-    if (attemptIsExpired) {\n-      // If exam is not submitted, use exam start time + time allocated for exam\n-      const effectiveSubmissionTime =\n-        lastAttempt.submissionTimeInMS ??\n-        lastAttempt.startTimeInMS + exam.config.totalTimeInMS;\n-      const twentyFourHoursAgo = Date.now() - 24 * 60 * 60 * 1000;\n-\n-      if (effectiveSubmissionTime > twentyFourHoursAgo) {\n+    const examExpirationTime =\n+      lastAttempt.startTimeInMS + exam.config.totalTimeInMS;\n+    if (examExpirationTime < Date.now()) {\n+      const retakeAllowed =\n+        examExpirationTime + exam.config.retakeTimeInMS < Date.now();\n+\n+      if (!retakeAllowed) {\n         void reply.code(429);\n         // TODO: Consider sending last completed time\n         return reply.send(\n@@ -429,20 +425,6 @@ async function postExamAttemptHandler(\n     latest.startTimeInMS > current.startTimeInMS ? latest : current\n   );\n \n-  // TODO: Currently, submission time is set when all questions have been answered.\n-  //       This might not necessarily be fully submitted. So, provided there is time\n-  //       left on the clock, the attempt should still be updated, even if the submission\n-  //       time is set.\n-  //       The submission time just needs to be updated.\n-  // if (latestAttempt.submissionTimeInMS !== null) {\n-  //   void reply.code(403);\n-  //   return reply.send(\n-  //     ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT(\n-  //       'Attempt has already been submitted.'\n-  //     )\n-  //   );\n-  // }\n-\n   const maybeExam = await mapErr(\n     this.prisma.envExam.findUnique({\n       where: {\n@@ -515,21 +497,13 @@ async function postExamAttemptHandler(\n     validateAttempt(generatedExam, databaseAttemptQuestionSets)\n   );\n \n-  // If all questions have been answered, add submission time\n-  const allQuestionsAnswered = checkAttemptAgainstGeneratedExam(\n-    databaseAttemptQuestionSets,\n-    generatedExam\n-  );\n-\n   // Update attempt in database\n   const maybeUpdatedAttempt = await mapErr(\n     this.prisma.envExamAttempt.update({\n       where: {\n         id: latestAttempt.id\n       },\n       data: {\n-        // NOTE: submission time is set to null, because it just depends on whether all questions have been answered.\n-        submissionTimeInMS: allQuestionsAnswered ? Date.now() : null,\n         questionSets: databaseAttemptQuestionSets,\n         // If attempt is not valid, immediately flag attempt as needing retake\n         // TODO: If `needsRetake`, prevent further submissions?\n@@ -592,7 +566,8 @@ async function getExams(\n       config: {\n         name: exam.config.name,\n         note: exam.config.note,\n-        totalTimeInMS: exam.config.totalTimeInMS\n+        totalTimeInMS: exam.config.totalTimeInMS,\n+        retakeTimeInMS: exam.config.retakeTimeInMS\n       },\n       canTake: isExamPrerequisitesMet\n     };"
        },
        {
            "sha": "748067b9e558169b1c112ff2068dba4f42e29175",
            "filename": "api/src/exam-environment/schemas/exams.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexams.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexams.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexams.ts?ref=9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
            "patch": "@@ -12,7 +12,8 @@ export const examEnvironmentExams = {\n           config: Type.Object({\n             name: Type.String(),\n             note: Type.String(),\n-            totalTimeInMS: Type.Number()\n+            totalTimeInMS: Type.Number(),\n+            retakeTimeInMS: Type.Number()\n           }),\n           canTake: Type.Boolean()\n         })"
        },
        {
            "sha": "18e4188e5b9012adde5374292a2f0c0641c2f91d",
            "filename": "api/src/exam-environment/utils/exam.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d4f63920b18cddbc179f7dafc7547b3e8d88f3c/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts?ref=9d4f63920b18cddbc179f7dafc7547b3e8d88f3c",
            "patch": "@@ -101,7 +101,8 @@ export function constructUserExam(\n   const config = {\n     totalTimeInMS: exam.config.totalTimeInMS,\n     name: exam.config.name,\n-    note: exam.config.note\n+    note: exam.config.note,\n+    retakeTimeInMS: exam.config.retakeTimeInMS\n   };\n \n   const userExam: UserExam = {"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 28,
        "deletions": 56
    }
}