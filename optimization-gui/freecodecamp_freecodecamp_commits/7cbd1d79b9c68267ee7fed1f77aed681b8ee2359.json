{
    "author": "Sembauke",
    "message": "feat(api): add DELETE \"/account\" endpoint to API (#61745)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "7cbd1d79b9c68267ee7fed1f77aed681b8ee2359",
    "files": [
        {
            "sha": "7f98c0f4bdce0c4a628c624ae89ccf612006df84",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 156,
            "deletions": 11,
            "changes": 167,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=7cbd1d79b9c68267ee7fed1f77aed681b8ee2359",
            "patch": "@@ -416,15 +416,17 @@ describe('userRoutes', () => {\n       });\n \n       test('POST returns 200 status code with empty object', async () => {\n-        expect(await fastifyTestInstance.prisma.user.count()).toBe(1);\n+        const initialCount = await fastifyTestInstance.prisma.user.count();\n         const response = await superPost('/account/delete');\n-        const userCount = await fastifyTestInstance.prisma.user.count({\n+        const finalCount = await fastifyTestInstance.prisma.user.count();\n+        const deletedUser = await fastifyTestInstance.prisma.user.findFirst({\n           where: { email: testUserData.email }\n         });\n \n         expect(response.body).toStrictEqual({});\n         expect(response.status).toBe(200);\n-        expect(userCount).toBe(0);\n+        expect(finalCount).toBe(initialCount - 1);\n+        expect(deletedUser).toBeNull();\n       });\n \n       test('POST deletes Microsoft usernames associated with the user', async () => {\n@@ -516,18 +518,26 @@ describe('userRoutes', () => {\n       });\n \n       test(\"only deletes the logged in user's data\", async () => {\n-        await fastifyTestInstance.prisma.user.create({\n+        const initialCount = await fastifyTestInstance.prisma.user.count();\n+        const otherEmail = 'an.random@user';\n+        const otherUser = await fastifyTestInstance.prisma.user.create({\n           data: {\n             ...testUserData,\n-            email: 'an.random@user'\n+            email: otherEmail\n           }\n         });\n-        expect(await fastifyTestInstance.prisma.user.count()).toBe(2);\n+        expect(otherUser.email).toBe(otherEmail);\n+        const afterAdd = await fastifyTestInstance.prisma.user.count();\n+        expect(afterAdd).toBe(initialCount + 1);\n \n         await superPost('/account/delete');\n \n-        const userCount = await fastifyTestInstance.prisma.user.count();\n-        expect(userCount).toBe(1);\n+        const finalCount = await fastifyTestInstance.prisma.user.count();\n+        expect(finalCount).toBe(initialCount);\n+        const remaining = await fastifyTestInstance.prisma.user.findFirst({\n+          where: { email: otherEmail }\n+        });\n+        expect(remaining).not.toBeNull();\n       });\n \n       test('logs if it is asked to delete a non-existent user', async () => {\n@@ -540,13 +550,147 @@ describe('userRoutes', () => {\n           superPost('/account/delete')\n         );\n         await Promise.all(deletePromises);\n+        const messages: string[] = spy.mock.calls.map(call =>\n+          call.map(part => String(part)).join(' ')\n+        );\n+        const found = messages.some(m =>\n+          m.includes(`User with id ${defaultUserId} not found for deletion.`)\n+        );\n+        expect(found).toBe(true);\n+      });\n+    });\n \n-        expect(spy).toHaveBeenCalledTimes(1);\n-        expect(spy.mock.calls[0]).toEqual(\n+    describe('/users/:userId', () => {\n+      afterEach(async () => {\n+        await fastifyTestInstance.prisma.userToken.deleteMany({\n+          where: { OR: [{ userId: defaultUserId }, { userId: otherUserId }] }\n+        });\n+        await fastifyTestInstance.prisma.msUsername.deleteMany({\n+          where: { OR: [{ userId: defaultUserId }, { userId: otherUserId }] }\n+        });\n+        await clearEnvExam();\n+      });\n+\n+      test('DELETE returns 204 status code with empty object', async () => {\n+        const response = await superDelete(`/users/${defaultUserId}`);\n+        const userCount = await fastifyTestInstance.prisma.user.count({\n+          where: { email: testUserData.email }\n+        });\n+\n+        expect(response.body).toStrictEqual({});\n+        expect(response.status).toBe(204);\n+        expect(userCount).toBe(0);\n+      });\n+\n+      test('DELETE deletes Microsoft usernames associated with the user', async () => {\n+        await fastifyTestInstance.prisma.msUsername.createMany({\n+          data: msUsernameData\n+        });\n+\n+        await superDelete(`/users/${defaultUserId}`);\n+        expect(await fastifyTestInstance.prisma.msUsername.count()).toBe(1);\n+      });\n+\n+      test('DELETE deletes userTokens associated with the user', async () => {\n+        await fastifyTestInstance.prisma.userToken.createMany({\n+          data: tokenData\n+        });\n+\n+        await superDelete(`/users/${defaultUserId}`);\n+\n+        const userTokens =\n+          await fastifyTestInstance.prisma.userToken.findMany();\n+        expect(userTokens).toHaveLength(1);\n+        expect(userTokens[0]?.userId).toBe(otherUserId);\n+      });\n+\n+      test(\"DELETE deletes all the user's cookies\", async () => {\n+        const res = await superDelete(`/users/${defaultUserId}`);\n+\n+        const setCookie = res.headers['set-cookie'] as string[];\n+        expect(setCookie).toEqual(\n           expect.arrayContaining([\n-            `User with id ${defaultUserId} not found for deletion.`\n+            expect.stringMatching(\n+              /^_csrf=; Max-Age=0; Path=\\/:?; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+            ),\n+            expect.stringMatching(\n+              /^csrf_token=; Max-Age=0; Path=\\/:?; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+            ),\n+            expect.stringMatching(\n+              /^jwt_access_token=; Max-Age=0; Path=\\/:?; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+            )\n           ])\n         );\n+        expect(setCookie).toHaveLength(3);\n+      });\n+\n+      test(\"DELETE deletes all the user's exam attempts\", async () => {\n+        await seedEnvExam();\n+        await seedEnvExamAttempt();\n+        const countBefore =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.count();\n+        expect(countBefore).toBe(1);\n+\n+        const res = await superDelete(`/users/${defaultUserId}`);\n+\n+        const countAfter =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.count();\n+        expect(countAfter).toBe(0);\n+        expect(res.status).toBe(204);\n+      });\n+\n+      test(\"DELETE deletes all the user's exam tokens\", async () => {\n+        await seedExamEnvExamAuthToken();\n+        const countBefore =\n+          await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.count();\n+        expect(countBefore).toBe(1);\n+\n+        const res = await superDelete(`/users/${defaultUserId}`);\n+\n+        const countAfter =\n+          await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.count();\n+        expect(countAfter).toBe(0);\n+        expect(res.status).toBe(204);\n+      });\n+\n+      test(\"only deletes the logged in user's data\", async () => {\n+        const initialCount = await fastifyTestInstance.prisma.user.count();\n+        await fastifyTestInstance.prisma.user.create({\n+          data: {\n+            ...testUserData,\n+            email: 'an.random@user'\n+          }\n+        });\n+        expect(await fastifyTestInstance.prisma.user.count()).toBe(\n+          initialCount + 1\n+        );\n+\n+        await superDelete(`/users/${defaultUserId}`);\n+\n+        const userCount = await fastifyTestInstance.prisma.user.count();\n+        expect(userCount).toBe(initialCount);\n+      });\n+\n+      test('logs if it is asked to delete a non-existent user', async () => {\n+        const spy = vi.spyOn(fastifyTestInstance.log, 'warn');\n+\n+        const deletePromises = Array.from({ length: 2 }, () =>\n+          superDelete(`/users/${defaultUserId}`)\n+        );\n+\n+        await Promise.all(deletePromises);\n+\n+        const messages = spy.mock.calls.flat().map(String);\n+        expect(\n+          messages.some(m =>\n+            m.includes(`User with id ${defaultUserId} not found for deletion.`)\n+          )\n+        ).toBe(true);\n+      });\n+\n+      test('returns 403 if attempting to delete a different user', async () => {\n+        const res = await superDelete(`/users/${otherUserId}`);\n+        expect(res.status).toBe(403);\n       });\n     });\n \n@@ -1427,6 +1571,7 @@ Thanks and regards,\n     });\n \n     const endpoints: { path: string; method: 'GET' | 'POST' | 'DELETE' }[] = [\n+      { path: `/users/${otherUserId}`, method: 'DELETE' },\n       { path: '/account/delete', method: 'POST' },\n       { path: '/account/reset-progress', method: 'POST' },\n       { path: '/user/get-session-user', method: 'GET' },"
        },
        {
            "sha": "253980f2268c18e5ef622011864c57cd57293259",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=7cbd1d79b9c68267ee7fed1f77aed681b8ee2359",
            "patch": "@@ -116,6 +116,60 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n     }\n   );\n \n+  fastify.delete(\n+    '/users/:userId',\n+    {\n+      schema: schemas.deleteUser\n+    },\n+    async (req, reply) => {\n+      const logger = fastify.log.child({ req, res: reply });\n+      const { userId } = req.params;\n+\n+      if (userId !== req.user?.id) {\n+        logger.warn(\n+          { requestedUserId: userId, authUserId: req.user?.id },\n+          'User attempted to delete an account they do not have authorization to.'\n+        );\n+        void reply.code(403);\n+        return { type: 'error', message: 'forbidden' } as const;\n+      }\n+\n+      logger.info(`User ${req.user.id} requested account deletion`);\n+      try {\n+        await fastify.prisma.userToken.deleteMany({\n+          where: { userId: req.user.id }\n+        });\n+        await fastify.prisma.msUsername.deleteMany({\n+          where: { userId: req.user.id }\n+        });\n+        await fastify.prisma.survey.deleteMany({\n+          where: { userId: req.user.id }\n+        });\n+        await fastify.prisma.user.delete({\n+          where: { id: req.user.id }\n+        });\n+      } catch (err) {\n+        // Whilst this is behind auth, this should never happen\n+        if (\n+          err instanceof PrismaClientKnownRequestError &&\n+          err.code === 'P2025'\n+        ) {\n+          logger.warn(\n+            err,\n+            `User with id ${req.user?.id} not found for deletion.`\n+          );\n+          return reply.code(404).send({ type: 'error', message: 'not found' });\n+        } else {\n+          logger.error(err, 'Error deleting user account');\n+          throw err;\n+        }\n+      }\n+      reply.clearOurCookies();\n+\n+      return reply.code(204).send();\n+    }\n+  );\n+\n   fastify.post(\n     '/account/reset-progress',\n     {"
        },
        {
            "sha": "df5af894edcf61790ebcee06ff81b3402b7dd740",
            "filename": "api/src/schemas.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Fschemas.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Fschemas.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas.ts?ref=7cbd1d79b9c68267ee7fed1f77aed681b8ee2359",
            "patch": "@@ -34,7 +34,10 @@ export { updateMySocials } from './schemas/settings/update-my-socials.js';\n export { updateMyTheme } from './schemas/settings/update-my-theme.js';\n export { updateMyUsername } from './schemas/settings/update-my-username.js';\n export { deleteMsUsername } from './schemas/user/delete-ms-username.js';\n-export { deleteMyAccount } from './schemas/user/delete-my-account.js';\n+export {\n+  deleteMyAccount,\n+  deleteUser\n+} from './schemas/user/delete-my-account.js';\n export { deleteUserToken } from './schemas/user/delete-user-token.js';\n export { getSessionUser } from './schemas/user/get-session-user.js';\n export { postMsUsername } from './schemas/user/post-ms-username.js';"
        },
        {
            "sha": "0e11760c1175c6647f903a54ce00fed69ca4fe50",
            "filename": "api/src/schemas/user/delete-my-account.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Fschemas%2Fuser%2Fdelete-my-account.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7cbd1d79b9c68267ee7fed1f77aed681b8ee2359/api%2Fsrc%2Fschemas%2Fuser%2Fdelete-my-account.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fuser%2Fdelete-my-account.ts?ref=7cbd1d79b9c68267ee7fed1f77aed681b8ee2359",
            "patch": "@@ -7,3 +7,16 @@ export const deleteMyAccount = {\n     default: genericError\n   }\n };\n+\n+export const deleteUser = {\n+  params: Type.Object({\n+    userId: Type.String({ format: 'objectid', maxLength: 24, minLength: 24 })\n+  }),\n+  response: {\n+    204: Type.Null(),\n+    default: Type.Object({\n+      type: Type.String(),\n+      message: Type.String()\n+    })\n+  }\n+};"
        }
    ],
    "stats": {
        "total": 239,
        "additions": 227,
        "deletions": 12
    }
}