{
    "author": "ojeytonwilliams",
    "message": "fix(api): handle users without email addresses (#60467)",
    "sha": "848ae3aacf11cc2f1e612fbc873501b39110f780",
    "files": [
        {
            "sha": "ffb18c193caf7c8cbd2cd6a2ea2f8ddd7de000ff",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -206,6 +206,10 @@ export const resetDefaultUser = async (): Promise<void> => {\n       where: { userId: defaultUserId }\n     }\n   );\n+  await fastifyTestInstance.prisma.user.deleteMany({\n+    where: { id: defaultUserId }\n+  });\n+\n   await fastifyTestInstance.prisma.user.deleteMany({\n     where: { email: defaultUserEmail }\n   });"
        },
        {
            "sha": "e748beef93cac634b38b8146e81f24201af02da1",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -99,7 +99,7 @@ model user {\n   quizAttempts                   QuizAttempt[] // Undefined\n   currentChallengeId             String?\n   donationEmails                 String[] // Undefined | String[] (only possible for built in Types like String)\n-  email                          String\n+  email                          String?\n   emailAuthLinkTTL               DateTime? // Null | Undefined\n   emailVerified                  Boolean?\n   emailVerifyTTL                 DateTime? // Null | Undefined"
        },
        {
            "sha": "1f81998bdb0ad45665ccf0c6a24955ac7fa91ddb",
            "filename": "api/src/routes/protected/certificate.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fcertificate.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -394,20 +394,20 @@ export const protectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n         }\n       });\n \n+      const email = updatedUser.email;\n       const updatedUserSansNull = removeNulls(updatedUser);\n-\n       const updatedIsCertMap = getUserIsCertMap(updatedUserSansNull);\n \n       // TODO(POST-MVP): Consider sending email based on `user.isEmailVerified` as well\n       const hasCompletedAllCerts = currentCertifications\n         .map(x => certSlugTypeMap[x])\n         .every(certType => updatedIsCertMap[certType]);\n       const shouldSendCertifiedEmailToCamper =\n-        isEmail(updatedUser.email) && hasCompletedAllCerts;\n+        email && isEmail(email) && hasCompletedAllCerts;\n \n       if (shouldSendCertifiedEmailToCamper) {\n         const notifyUser = {\n-          to: updatedUser.email,\n+          to: email,\n           from: 'quincy@freecodecamp.org',\n           subject:\n             'Congratulations on completing all of the freeCodeCamp certifications!',"
        },
        {
            "sha": "d938f561c6c5ecdd950bdced2a244fa11b122961",
            "filename": "api/src/routes/protected/donate.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.test.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -1,4 +1,3 @@\n-import type { Prisma } from '@prisma/client';\n import {\n   createSuperRequest,\n   devLogin,\n@@ -11,9 +10,8 @@ import { createUserInput } from '../../utils/create-user';\n const testEWalletEmail = 'baz@bar.com';\n const testSubscriptionId = 'sub_test_id';\n const testCustomerId = 'cust_test_id';\n-const userWithoutProgress: Prisma.userCreateInput =\n-  createUserInput(defaultUserEmail);\n-const userWithProgress: Prisma.userCreateInput = {\n+const userWithoutProgress = createUserInput(defaultUserEmail);\n+const userWithProgress = {\n   ...createUserInput(defaultUserEmail),\n   completedChallenges: [\n     {\n@@ -271,6 +269,23 @@ describe('Donate', () => {\n         expect(failResponse.status).toBe(400);\n       });\n \n+      it('should return 403 if the user has no email', async () => {\n+        await fastifyTestInstance.prisma.user.updateMany({\n+          where: { email: userWithProgress.email },\n+          data: { email: null }\n+        });\n+        const response = await superPost('/donate/charge-stripe-card').send(\n+          chargeStripeCardReqBody\n+        );\n+        expect(response.body).toEqual({\n+          error: {\n+            type: 'EmailRequiredError',\n+            message: 'User has not provided an email address'\n+          }\n+        });\n+        expect(response.status).toBe(403);\n+      });\n+\n       it('should return 500 if Stripe encountes an error', async () => {\n         mockSubCreate.mockImplementationOnce(defaultError);\n         const response = await superPost('/donate/charge-stripe-card').send("
        },
        {
            "sha": "c64c7aa6fbbdefd750358111fa85a27401bb988e",
            "filename": "api/src/routes/protected/donate.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -117,6 +117,17 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n         });\n \n         const { email, name } = user;\n+\n+        if (!email) {\n+          logger.warn(`User ${id} has no email`);\n+          void reply.code(403);\n+          return reply.send({\n+            error: {\n+              type: 'EmailRequiredError',\n+              message: 'User has not provided an email address'\n+            }\n+          });\n+        }\n         const threeChallengesCompleted = user.completedChallenges.length >= 3;\n \n         if (!threeChallengesCompleted) {"
        },
        {
            "sha": "ef7c4ac911b8817c41424e06814be583e85daf57",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -186,7 +186,7 @@ Happy coding!\n         }\n       });\n       const newEmail = req.body.email.toLowerCase();\n-      const currentEmailFormatted = user.email.toLowerCase();\n+      const currentEmailFormatted = user.email ? user.email.toLowerCase() : '';\n       const isVerifiedEmail = user.emailVerified;\n       const isOwnEmail = newEmail === currentEmailFormatted;\n       if (isOwnEmail && isVerifiedEmail) {"
        },
        {
            "sha": "32807f41bd3903b464e873a53f4f8e16b30db65b",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -14,7 +14,8 @@ import {\n   setupServer,\n   superRequest,\n   createSuperRequest,\n-  defaultUsername\n+  defaultUsername,\n+  resetDefaultUser\n } from '../../../jest.utils';\n import { JWT_SECRET } from '../../utils/env';\n import {\n@@ -864,7 +865,8 @@ describe('userRoutes', () => {\n           .mockImplementation(jest.fn());\n       });\n \n-      afterEach(() => {\n+      afterEach(async () => {\n+        await resetDefaultUser();\n         jest.clearAllMocks();\n       });\n \n@@ -890,6 +892,24 @@ describe('userRoutes', () => {\n         expect(response.statusCode).toBe(400);\n       });\n \n+      test('POST returns 403 for users with no email', async () => {\n+        await fastifyTestInstance.prisma.user.updateMany({\n+          where: { email: testUserData.email },\n+          data: { email: null }\n+        });\n+\n+        const response = await superPost('/user/report-user').send({\n+          username: testUserData.username,\n+          reportDescription: 'Test Report'\n+        });\n+\n+        expect(response.statusCode).toBe(403);\n+        expect(response.body).toStrictEqual({\n+          type: 'danger',\n+          message: 'flash.report-error'\n+        });\n+      });\n+\n       test('POST sanitises report description', async () => {\n         await superPost('/user/report-user').send({\n           username: defaultUsername,"
        },
        {
            "sha": "0d651acea20c078aadf05ef5d1c89b9254818fea",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -199,6 +199,16 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       const user = await fastify.prisma.user.findUniqueOrThrow({\n         where: { id: req.user?.id }\n       });\n+\n+      if (!user.email) {\n+        logger.warn('User has no email');\n+        void reply.code(403);\n+        return reply.send({\n+          type: 'danger',\n+          message: 'flash.report-error'\n+        });\n+      }\n+\n       const { username, reportDescription: report } = req.body;\n \n       // TODO: `findUnique` once db migration forces unique usernames\n@@ -242,11 +252,11 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n         text: generateReportEmail(user, reportedUser, report)\n       });\n \n-      return {\n+      reply.send({\n         type: 'info',\n         message: 'flash.report-sent',\n         variables: { email: user.email }\n-      } as const;\n+      });\n     }\n   );\n \n@@ -628,6 +638,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n         const [flags, rest] = splitUser(user);\n \n         const {\n+          email,\n           emailVerified,\n           username,\n           usernameDisplay,\n@@ -649,6 +660,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n               ...removeNulls(publicUser),\n               ...normalizeFlags(flags),\n               picture: publicUser.picture ?? '',\n+              email: email ?? '',\n               currentChallengeId: currentChallengeId ?? '',\n               completedChallenges: normalizeChallenges(completedChallenges),\n               completedChallengeCount: completedChallenges.length,"
        },
        {
            "sha": "20183d2b04da36e005a8e53cc46f6d72d706b2ee",
            "filename": "api/src/routes/public/email-subscription.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Femail-subscription.test.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -101,7 +101,7 @@ describe('Email Subscription endpoints', () => {\n \n       expect(users).toHaveLength(4);\n       users.forEach(user => {\n-        if (['user1@freecodecamp.org'].includes(user.email)) {\n+        if (['user1@freecodecamp.org'].includes(user.email!)) {\n           expect(user.sendQuincyEmail).toBe(false);\n         } else {\n           expect(user.sendQuincyEmail).toBe(true);\n@@ -148,7 +148,7 @@ describe('Email Subscription endpoints', () => {\n       users.forEach(user => {\n         if (\n           ['user1@freecodecamp.org', 'user2@freecodecamp.org'].includes(\n-            user.email\n+            user.email!\n           )\n         ) {\n           expect(user.sendQuincyEmail).toBe(false);"
        },
        {
            "sha": "ab4f193922ad4744a25f45c259c5334613f33127",
            "filename": "api/src/schemas/donate/charge-stripe-card.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Fschemas%2Fdonate%2Fcharge-stripe-card.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Fschemas%2Fdonate%2Fcharge-stripe-card.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fdonate%2Fcharge-stripe-card.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -30,6 +30,12 @@ export const chargeStripeCard = {\n         client_secret: Type.Optional(Type.String())\n       })\n     }),\n+    403: Type.Object({\n+      error: Type.Object({\n+        message: Type.String(),\n+        type: Type.Literal('EmailRequiredError')\n+      })\n+    }),\n     500: Type.Object({\n       error: Type.Literal('Donation failed due to a server error.')\n     })"
        },
        {
            "sha": "7d25c378a10ea9a1fde17560a3a9e6c82835f603",
            "filename": "api/src/utils/create-user.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Futils%2Fcreate-user.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/848ae3aacf11cc2f1e612fbc873501b39110f780/api%2Fsrc%2Futils%2Fcreate-user.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fcreate-user.ts?ref=848ae3aacf11cc2f1e612fbc873501b39110f780",
            "patch": "@@ -1,6 +1,5 @@\n import crypto from 'node:crypto';\n \n-import { type Prisma } from '@prisma/client';\n import { customAlphabet } from 'nanoid';\n \n export const nanoidCharSet =\n@@ -46,7 +45,7 @@ export const createResetProperties = () => ({\n  * @param email The email address of the new user.\n  * @returns Default data for a new user.\n  */\n-export function createUserInput(email: string): Prisma.userCreateInput {\n+export function createUserInput(email: string) {\n   const username = 'fcc-' + crypto.randomUUID();\n   const externalId = crypto.randomUUID();\n   // This explicitly includes all array fields. This is not strictly necessary -"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 84,
        "deletions": 17
    }
}