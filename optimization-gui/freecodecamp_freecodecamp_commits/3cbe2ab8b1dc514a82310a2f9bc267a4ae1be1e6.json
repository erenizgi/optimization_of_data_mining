{
    "author": "raisedadead",
    "message": "fix(tools): consolidate docker compose setup (#62525)",
    "sha": "3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
    "files": [
        {
            "sha": "9aa1ec36ec145f2cad48c237cd639b7a7e4bb8ad",
            "filename": ".github/workflows/e2e-playwright.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/.github%2Fworkflows%2Fe2e-playwright.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/.github%2Fworkflows%2Fe2e-playwright.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fe2e-playwright.yml?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -160,7 +160,7 @@ jobs:\n \n       - name: Start apps\n         run: |\n-          docker compose up -d\n+          docker compose -f docker/docker-compose.yml -f docker/docker-compose.e2e.yml up -d\n           pnpm run serve:client-ci &\n           sleep 10\n "
        },
        {
            "sha": "97c2bd8401f18f5397580eb0ce06ee8d7427e96f",
            "filename": ".github/workflows/e2e-third-party.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/.github%2Fworkflows%2Fe2e-third-party.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/.github%2Fworkflows%2Fe2e-third-party.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fe2e-third-party.yml?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -152,7 +152,7 @@ jobs:\n \n       - name: Start apps\n         run: |\n-          docker compose up -d\n+          docker compose -f docker/docker-compose.yml -f docker/docker-compose.e2e.yml up -d\n           pnpm run serve:client-ci &\n           sleep 10\n "
        },
        {
            "sha": "bf61e9b5259f826d0135e636d19c6c52cfed9088",
            "filename": ".gitpod.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/.gitpod.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/.gitpod.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.gitpod.yml?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -42,8 +42,7 @@ tasks:\n   - name: db\n     # starting mongod in background, so it doesn't block prebuilds\n     before: >\n-      cd api/tools &&\n-      docker compose up -d\n+      docker compose -f docker/docker-compose.yml up -d\n \n   - name: server\n     before: export COOKIE_DOMAIN=.gitpod.io && export HOME_LOCATION=$(gp url 8000) && export API_LOCATION=$(gp url 3000)"
        },
        {
            "sha": "c0e31d88c901e44ac1f3b53c8fcb5b83cd38ce29",
            "filename": "api/README.md",
            "status": "removed",
            "additions": 0,
            "deletions": 46,
            "changes": 46,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f002f1b83599fb39a06baa8935cdc5791d93bf61/api%2FREADME.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f002f1b83599fb39a06baa8935cdc5791d93bf61/api%2FREADME.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2FREADME.md?ref=f002f1b83599fb39a06baa8935cdc5791d93bf61",
            "patch": "@@ -1,46 +0,0 @@\n-# Working on the new api\n-\n-## Connecting to local database\n-\n-The api uses the ORM Prisma and it needs the MongoDB instance to be a replica set.\n-\n-### Atlas\n-\n-If you use MongoDB Atlas, the set is managed for you.\n-\n-### Local\n-\n-The simplest way to run a replica set locally is to use the docker-compose file\n-in /tools.\n-\n-```bash\n-cd tools\n-docker compose up -d\n-```\n-\n-The new db will be empty, so you can run the seed script to populate it.\n-\n-```bash\n-cd ../.. # back to the root of the repo\n-pnpm seed\n-```\n-\n-### Troubleshooting\n-\n-If you have any issues connecting to the database (e.g. MongoServerError: not primary), try removing the volume and recreating the containers.\n-\n-```bash\n-cd tools\n-docker compose down -v\n-docker compose up -d\n-```\n-\n-## Login in development/testing\n-\n-During development and testing, the api exposes the endpoint GET auth/dev-callback. Calling this will log you in as the user with the email `foo@bar.com` by setting the session cookie for that user.\n-\n-## Generating Exams\n-\n-```bash\n-pnpm run exam-env:generate <ENV_EXAM_ID> <NUMBER_OF_EXAMS_TO_GENERATE>\n-```"
        },
        {
            "sha": "66009bde278e17e2c3b62dcbfb07e9c27d2c790b",
            "filename": "api/src/plugins/mail-providers/nodemailer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/api%2Fsrc%2Fplugins%2Fmail-providers%2Fnodemailer.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/api%2Fsrc%2Fplugins%2Fmail-providers%2Fnodemailer.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fmail-providers%2Fnodemailer.ts?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -1,7 +1,7 @@\n import nodemailer, { Transporter } from 'nodemailer';\n \n import { MailProvider, SendEmailArgs } from '../mailer.js';\n-import { MAILHOG_HOST } from '../../utils/env.js';\n+import { MAILPIT_HOST } from '../../utils/env.js';\n \n /**\n  * NodemailerProvider is a wrapper around nodemailer that provides a clean\n@@ -16,7 +16,7 @@ export class NodemailerProvider implements MailProvider {\n    */\n   constructor() {\n     this.transporter = nodemailer.createTransport({\n-      host: MAILHOG_HOST,\n+      host: MAILPIT_HOST,\n       secure: false,\n       port: 1025,\n       auth: {"
        },
        {
            "sha": "f03ccb46d19bedeed13a05aabb736a8394d05f82",
            "filename": "api/src/utils/env.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/api%2Fsrc%2Futils%2Fenv.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/api%2Fsrc%2Futils%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fenv.ts?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -159,7 +159,12 @@ if (process.env.FREECODECAMP_NODE_ENV !== 'development') {\n export const HOME_LOCATION = process.env.HOME_LOCATION;\n // Mailpit is used in development and test environments, hence the localhost\n // default.\n-export const MAILHOG_HOST = process.env.MAILHOG_HOST ?? 'localhost';\n+// TODO: Remove MAILHOG_HOST in a few months\n+// We renamed MailHog to MailPit, but kept the same port and API\n+// This is to keep backward compatibility with existing setups\n+// that might still use MAILHOG_HOST environment variable\n+export const MAILPIT_HOST =\n+  process.env.MAILPIT_HOST ?? process.env.MAILHOG_HOST ?? 'localhost';\n export const MONGOHQ_URL =\n   process.env.NODE_ENV === 'test'\n     ? createTestConnectionURL("
        },
        {
            "sha": "402f38e46f9812b283948d1801569561cc20f2e8",
            "filename": "docker-compose.yml",
            "status": "removed",
            "additions": 0,
            "deletions": 39,
            "changes": 39,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f002f1b83599fb39a06baa8935cdc5791d93bf61/docker-compose.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f002f1b83599fb39a06baa8935cdc5791d93bf61/docker-compose.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker-compose.yml?ref=f002f1b83599fb39a06baa8935cdc5791d93bf61",
            "patch": "@@ -1,39 +0,0 @@\n-services:\n-  mongo:\n-    image: mongo\n-    ports:\n-      - '27017:27017'\n-    command: mongod --replSet rs0\n-  setup:\n-    image: mongo\n-    depends_on:\n-      - mongo\n-    restart: on-failure\n-    entrypoint: [\n-        'bash',\n-        '-c',\n-        # This will try to initiate the replica set, until it succeeds twice (i.e. until the replica set is already initialized)\n-        'mongosh --host mongo:27017 --eval ''try {rs.initiate();} catch (err) { if(err.codeName !== \"AlreadyInitialized\") throw err };'''\n-      ]\n-  mailpit:\n-    restart: unless-stopped\n-    image: axllent/mailpit\n-    ports:\n-      - '1025:1025'\n-      - '8025:8025'\n-  api:\n-    restart: unless-stopped\n-    depends_on:\n-      - mongo\n-      - mailpit\n-    image: fcc-api\n-    env_file:\n-      - .env\n-    environment:\n-      # The api cannot connect to mongodb or mailpit via localhost from inside the\n-      # container, so we have to override these variables.\n-      - MONGOHQ_URL=mongodb://mongo:27017/freecodecamp?directConnection=true\n-      - MAILHOG_HOST=mailpit\n-      - HOST=0.0.0.0\n-    ports:\n-      - '3000:3000'"
        },
        {
            "sha": "fd4e927a44ad23af2d45d6f46a795f0b98f16494",
            "filename": "docker/api/docker-compose.yml",
            "status": "removed",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f002f1b83599fb39a06baa8935cdc5791d93bf61/docker%2Fapi%2Fdocker-compose.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f002f1b83599fb39a06baa8935cdc5791d93bf61/docker%2Fapi%2Fdocker-compose.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker%2Fapi%2Fdocker-compose.yml?ref=f002f1b83599fb39a06baa8935cdc5791d93bf61",
            "patch": "@@ -1,14 +0,0 @@\n-services:\n-  api:\n-    restart: unless-stopped\n-    image: fcc-api\n-    env_file:\n-      - ../../.env\n-    ports:\n-      - '3000:3000'\n-    logging:\n-      driver: 'local'\n-      options:\n-        max-size: '10m'\n-        max-file: '3'\n-        compress: 'true'"
        },
        {
            "sha": "0da4ecce0b3852e60383e388e57d648fe9cdb5aa",
            "filename": "docker/docker-compose.e2e.yml",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/docker%2Fdocker-compose.e2e.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/docker%2Fdocker-compose.e2e.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker%2Fdocker-compose.e2e.yml?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -0,0 +1,19 @@\n+# Docker Compose override for E2E testing\n+# Usage: docker compose -f docker/docker-compose.yml -f docker/docker-compose.e2e.yml up -d\n+services:\n+  api:\n+    restart: unless-stopped\n+    depends_on:\n+      - db\n+      - mailpit\n+    image: fcc-api\n+    env_file:\n+      - ../.env\n+    environment:\n+      # The api cannot connect to mongodb or mailpit via localhost from inside the\n+      # container, so we have to override these variables.\n+      - MONGOHQ_URL=mongodb://db:27017/freecodecamp?directConnection=true\n+      - MAILHOG_HOST=mailpit\n+      - HOST=0.0.0.0\n+    ports:\n+      - '3000:3000'"
        },
        {
            "sha": "c7b1b73168162b41cbcf8c0e79b27162d9b4db20",
            "filename": "docker/docker-compose.yml",
            "status": "renamed",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/docker%2Fdocker-compose.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/docker%2Fdocker-compose.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker%2Fdocker-compose.yml?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -29,6 +29,13 @@ services:\n         }\n       '\n \n+  mailpit:\n+    restart: unless-stopped\n+    image: axllent/mailpit\n+    ports:\n+      - '1025:1025'\n+      - '8025:8025'\n+\n volumes:\n   db-data:\n     driver: local",
            "previous_filename": "api/tools/docker-compose.yml"
        },
        {
            "sha": "513b21970bc8387ec8047851aab3fa2efad43403",
            "filename": "e2e/utils/mailhog.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/e2e%2Futils%2Fmailhog.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6/e2e%2Futils%2Fmailhog.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Futils%2Fmailhog.ts?ref=3cbe2ab8b1dc514a82310a2f9bc267a4ae1be1e6",
            "patch": "@@ -11,7 +11,12 @@ type AllEmails = {\n   count: number;\n };\n \n-const host = process.env.MAILHOG_HOST || 'localhost';\n+// TODO: Remove MAILHOG_HOST in a few months\n+// We renamed MailHog to MailPit, but kept the same port and API\n+// This is to keep backward compatibility with existing setups\n+// that might still use MAILHOG_HOST environment variable\n+const host =\n+  process.env.MAILPIT_HOST || process.env.MAILHOG_HOST || 'localhost';\n \n export const getAllEmails = async (): Promise<AllEmails> => {\n   const res = await fetch(`http://${host}:8025/api/v1/messages`);"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 43,
        "deletions": 107
    }
}