{
    "author": "gikf",
    "message": "fix(client): python duplicated input (#57023)",
    "sha": "4c176d1ccb7c9d87cb29fbe0bf1e4e2fad23f730",
    "files": [
        {
            "sha": "e91b2804da9701a3e3fcb3ea31b2372d5785a308",
            "filename": "tools/client-plugins/browser-scripts/python-worker.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4c176d1ccb7c9d87cb29fbe0bf1e4e2fad23f730/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpython-worker.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4c176d1ccb7c9d87cb29fbe0bf1e4e2fad23f730/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpython-worker.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Fpython-worker.ts?ref=4c176d1ccb7c9d87cb29fbe0bf1e4e2fad23f730",
            "patch": "@@ -106,6 +106,10 @@ function initRunPython() {\n     };\n   }\n \n+  function __interruptExecution() {\n+    postMessage({ type: 'reset' });\n+  }\n+\n   // I tried setting jsglobals here, to provide 'input' and 'print' to python,\n   // without having to modify the global window object. However, it didn't work\n   // because pyodide needs access to that object. Instead, I used\n@@ -114,7 +118,8 @@ function initRunPython() {\n   // Make print available to python\n   pyodide.registerJsModule('jscustom', {\n     print,\n-    input\n+    input,\n+    __interruptExecution\n   });\n   // Create fresh globals each time user code is run.\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-call\n@@ -123,20 +128,29 @@ function initRunPython() {\n   // have this set by default.\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-call\n   globals.set('__name__', '__main__');\n+\n   // The runPython helper is a shortcut for running python code with our\n   // custom globals.\n   const runPython = (pyCode: string) =>\n     pyodide!.runPython(pyCode, { globals }) as unknown;\n+\n   runPython(`\n+  from pyodide.ffi import JsException\n+\n   import jscustom\n   from jscustom import print\n   from jscustom import input\n+\n   def __wrap(func):\n     def fn(*args):\n-      data = func(*args)\n-      if data.type == 'cancel':\n-        raise KeyboardInterrupt(data.value)\n-      return data.value\n+      try:\n+        data = func(*args)\n+        if data.type == 'cancel':\n+          raise KeyboardInterrupt(data.value)\n+        return data.value\n+      except JsException:\n+        jscustom.__interruptExecution()\n+        raise\n     return fn\n   input = __wrap(input)\n   `);"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 19,
        "deletions": 5
    }
}