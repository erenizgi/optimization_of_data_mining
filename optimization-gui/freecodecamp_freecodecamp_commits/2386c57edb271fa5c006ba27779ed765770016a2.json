{
    "author": "ojeytonwilliams",
    "message": "fix(client): lower jaw test result announcements (#55997)",
    "sha": "2386c57edb271fa5c006ba27779ed765770016a2",
    "files": [
        {
            "sha": "2bb381196c6a48969778a20167c398f94dca35bb",
            "filename": "client/src/templates/Challenges/classic/lower-jaw.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 27,
            "changes": 58,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/2386c57edb271fa5c006ba27779ed765770016a2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Flower-jaw.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/2386c57edb271fa5c006ba27779ed765770016a2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Flower-jaw.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Flower-jaw.tsx?ref=2386c57edb271fa5c006ba27779ed765770016a2",
            "patch": "@@ -79,8 +79,8 @@ const sentenceArray = [\n   'learn.sorry-dont-giveup'\n ];\n \n-const sentencePicker = (currentAttempts: number) => {\n-  return sentenceArray[currentAttempts % sentenceArray.length];\n+const sentencePicker = (shownAttempts: number) => {\n+  return sentenceArray[shownAttempts % sentenceArray.length];\n };\n \n const LowerButtonsPanel = ({\n@@ -193,12 +193,12 @@ const LowerJaw = ({\n   isSignedIn,\n   updateContainer\n }: LowerJawProps): JSX.Element => {\n-  const hintRef = React.useRef('');\n+  const [shownHint, setShownHint] = useState(hint);\n   const [quote, setQuote] = useState(randomCompliment());\n   const [runningTests, setRunningTests] = useState(false);\n   const [testFeedbackHeight, setTestFeedbackHeight] = useState(0);\n-  const [currentAttempts, setCurrentAttempts] = useState(attempts);\n-  const [isFeedbackHidden, setIsFeedbackHidden] = useState(false);\n+  const [shownAttempts, setShownAttempts] = useState(attempts);\n+  const [isFeedbackHidden, setIsFeedbackHidden] = useState(true);\n   const { t } = useTranslation();\n   const testFeedbackRef = React.createRef<HTMLDivElement>();\n \n@@ -219,34 +219,38 @@ const LowerJaw = ({\n   const showShareButton =\n     challengeIsCompleted && completedPercent === isBlockCompleted;\n \n+  // Attempts should only be zero when the step is reset, so we should reset\n+  // the state here.\n+  if (attempts !== shownAttempts && attempts === 0) {\n+    setShownAttempts(0);\n+    setRunningTests(false);\n+    setIsFeedbackHidden(false);\n+    setShownHint('');\n+  }\n   useEffect(() => {\n-    // prevent unnecessary updates:\n-    if (attempts === currentAttempts) return;\n-    // Attempts should only be zero when the step is reset, so we should reset\n-    // the state here.\n-    if (attempts === 0) {\n-      setCurrentAttempts(0);\n-      setRunningTests(false);\n-      setIsFeedbackHidden(false);\n-      hintRef.current = '';\n-    } else if (attempts > 0 && hint) {\n+    if (attempts > shownAttempts) {\n       //hide the feedback from SR until the \"Running tests\" are displayed and removed.\n       setIsFeedbackHidden(true);\n       setRunningTests(true);\n       //to prevent the changing attempts value from immediately triggering a new\n-      //render, the rendered component only depends on currentAttempts. Since\n-      //currentAttempts is updated with when the feedback is hidden, the screen\n-      //reader should only read out the new message.\n-      setCurrentAttempts(attempts);\n-      hintRef.current = hint;\n-\n+      //render, the rendered component only depends on shownAttempts. Since\n+      //shownAttempts is updated with when the feedback is hidden, the screen\n+      //reader should only read out the new message. Note: this starts with the\n+      //second encouragement since attempts starts at 1.\n+      setShownAttempts(attempts);\n       //display the test feedback contents.\n       setTimeout(() => {\n         setRunningTests(false);\n         setIsFeedbackHidden(false);\n       }, 300);\n     }\n-  }, [attempts, hint, currentAttempts]);\n+  }, [attempts, shownAttempts]);\n+\n+  useEffect(() => {\n+    // Since there's no guarantee that hint and attempts update in the same\n+    // render, hints have to be updated separately.\n+    if (hint) setShownHint(hint);\n+  }, [hint]);\n \n   useEffect(() => {\n     if (challengeIsCompleted) {\n@@ -280,9 +284,9 @@ const LowerJaw = ({\n   });\n \n   const isAttemptsLargerThanTest =\n-    currentAttempts &&\n+    shownAttempts &&\n     testsLength &&\n-    (currentAttempts >= testsLength || currentAttempts >= 3);\n+    (shownAttempts >= testsLength || shownAttempts >= 3);\n \n   const isDesktop = window.innerWidth > MAX_MOBILE_WIDTH;\n   const isMacOS = navigator.userAgent.includes('Mac OS');\n@@ -373,13 +377,13 @@ const LowerJaw = ({\n             </span>\n           </>\n         )}\n-        {hintRef.current && !challengeIsCompleted && (\n+        {shownHint && !challengeIsCompleted && (\n           <LowerJawTips\n             data-testid='lowerJaw-tips'\n             showFeedback={isFeedbackHidden}\n             testText={t('learn.test')}\n-            htmlDescription={`${hintRef.current}`}\n-            learnEncouragementText={t(sentencePicker(currentAttempts))}\n+            htmlDescription={shownHint ?? ''}\n+            learnEncouragementText={t(sentencePicker(shownAttempts))}\n           />\n         )}\n       </div>"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 31,
        "deletions": 27
    }
}