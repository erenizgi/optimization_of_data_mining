{
    "author": "raisedadead",
    "message": "refactor(GHA): deployments, logs and simple scripts (#59430)",
    "sha": "4a64be5b29f262c1aef9cc288f584adab5186de3",
    "files": [
        {
            "sha": "f76364cb77ec106b096da6817debae8480cf03ff",
            "filename": ".github/workflows/deploy-legacy.yml",
            "status": "modified",
            "additions": 78,
            "deletions": 67,
            "changes": 145,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4a64be5b29f262c1aef9cc288f584adab5186de3/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4a64be5b29f262c1aef9cc288f584adab5186de3/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-legacy.yml?ref=4a64be5b29f262c1aef9cc288f584adab5186de3",
            "patch": "@@ -55,65 +55,66 @@ jobs:\n \n       - name: Configure SSH & Check Connection\n         run: |\n-          mkdir -p ~/.ssh && \\\n+          mkdir -p ~/.ssh\n           echo \"Host *\n             UserKnownHostsFile=/dev/null\n-            StrictHostKeyChecking no\" > ~/.ssh/config && \\\n+            StrictHostKeyChecking no\" > ~/.ssh/config\n           chmod 644 ~/.ssh/config\n-          if [ $? -ne 0 ]; then echo \"::error::Failed to configure SSH\"; exit 1; fi\n \n           for i in {1..3}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-api-${i}\n-            tailscale status | grep -q \"$TS_MACHINE_NAME\" && \\\n+            tailscale status | grep -q \"$TS_MACHINE_NAME\"\n             ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to check connection\"; exit 1; fi\n           done\n \n       - name: Deploy API\n+        # [NOTE] Use backslashes for expansion on remote machine, example: \\$NVM_DIR, etc.\n         run: |\n-          export GIT_SOURCE_BRANCH=${{ needs.setup-jobs.outputs.tgt_env_branch }}\n+          GIT_SOURCE_BRANCH=${{ needs.setup-jobs.outputs.tgt_env_branch }}\n           for i in {1..3}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-api-${i}\n-            ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n+            REMOTE_SCRIPT=\"\n               set -e\n-              echo \"Deploying API (Legacy) to $TS_MACHINE_NAME\"\n+              echo -e '\\nLOG:Deploying API (Legacy) to $TS_MACHINE_NAME...'\n \n+              echo -e '\\nLOG:Environment setup...'\n               cd /home/$TS_USERNAME/freeCodeCamp\n+              export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\\$NVM_DIR/nvm.sh\"\n+              echo -e '\\nLOG:Checking available Node.js versions...'\n+              nvm ls | grep 'default'\n+              echo -e '\\nLOG:Checking Node.js version...'\n+              node --version\n \n-              # Environment setup\n-              export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\\$NVM_DIR/nvm.sh\" && \\\n-              nvm ls | grep 'default' && \\\n-              echo \"Node.js version:\" && node --version\n-\n-              # Stop all PM2 services\n+              echo -e '\\nLOG:Stopping all PM2 services...'\n               pm2 stop all\n \n-              # Git operations\n-              git status && \\\n-              git clean -f && \\\n-              git fetch --all --prune && \\\n-              git checkout -f $GIT_SOURCE_BRANCH && \\\n-              git reset --hard origin/$GIT_SOURCE_BRANCH && \\\n+              echo -e '\\nLOG:Git operations...'\n+              git status\n+              git clean -f\n+              git fetch --all --prune\n+              git checkout -f $GIT_SOURCE_BRANCH\n+              git reset --hard origin/$GIT_SOURCE_BRANCH\n               git status\n \n-              # Build\n-              npm i -g pnpm@9 && \\\n-              pnpm clean:packages && \\\n-              pnpm clean:server && \\\n-              pnpm install && \\\n-              pnpm prebuild && \\\n-              pnpm build:curriculum && \\\n+              echo -e '\\nLOG:Building...'\n+              npm i -g pnpm@9\n+              pnpm clean:packages\n+              pnpm clean:server\n+              pnpm install\n+              pnpm prebuild\n+              pnpm build:curriculum\n               pnpm build:server\n+              echo -e '\\nLOG:Build completed.'\n+\n+              echo -e '\\nLOG:Starting PM2 reload...'\n+              pm2 reload './api-server/ecosystem.config.js'\n+              echo -e '\\nLOG:PM2 reload completed.'\n \n-              # Server reload\n-              pnpm reload:server && \\\n-              pm2 ls && \\\n+              pm2 ls\n               pm2 save\n-          EOF\n-            if [ $? -ne 0 ]; then\n-              echo \"::error::Deployment to $TS_MACHINE_NAME failed\"\n-              exit 1\n-            fi\n+              echo -e '\\nLOG:Finished deployment.'\n+            \"\n+            ssh $TS_USERNAME@$TS_MACHINE_NAME \"$REMOTE_SCRIPT\"\n           done\n \n   client:\n@@ -225,18 +226,16 @@ jobs:\n \n       - name: Configure SSH & Check Connection\n         run: |\n-          mkdir -p ~/.ssh && \\\n+          mkdir -p ~/.ssh\n           echo \"Host *\n             UserKnownHostsFile=/dev/null\n-            StrictHostKeyChecking no\" > ~/.ssh/config && \\\n+            StrictHostKeyChecking no\" > ~/.ssh/config\n           chmod 644 ~/.ssh/config\n-          if [ $? -ne 0 ]; then echo \"::error::Failed to configure SSH\"; exit 1; fi\n \n           for i in {0..1}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.lang-name-short }}-${i}\n-            tailscale status | grep -q \"$TS_MACHINE_NAME\" && \\\n+            tailscale status | grep -q \"$TS_MACHINE_NAME\"\n             ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to check connection\"; exit 1; fi\n           done\n \n       - name: Upload and Deploy\n@@ -248,44 +247,56 @@ jobs:\n             CLIENT_DST=/tmp/client-${{ matrix.lang-name-short }}-${CURRENT_DATE}-${{ github.run_id }}.tar\n             CLIENT_BINARIES=${{needs.setup-jobs.outputs.tgt_env_short}}-release-$CURRENT_DATE-${{ github.run_id }}\n \n-            # Upload client archive\n+            echo -e \"\\nLOG:Uploading client archive to $TS_MACHINE_NAME...\"\n             scp $CLIENT_SRC $TS_USERNAME@$TS_MACHINE_NAME:$CLIENT_DST\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to upload client archive\"; exit 1; fi\n \n-            ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n+            REMOTE_SCRIPT=\"\n               set -e\n+              echo -e '\\nLOG: Deploying client - $CLIENT_BINARIES to $TS_MACHINE_NAME...'\n+\n+              echo -e '\\nLOG:Extracting client archive...'\n+              mkdir -p /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES\n+              tar -xzf $CLIENT_DST -C /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES --strip-components=2\n+\n+              echo -e '\\nLOG:Cleaning up client archive...'\n+              rm $CLIENT_DST\n \n-              # Extract client archive\n-              mkdir -p /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES && \\\n-              tar -xzf $CLIENT_DST -C /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES --strip-components=2 && \\\n-              rm $CLIENT_DST && \\\n+              echo -e '\\nLOG:Checking client archive size...'\n               du -sh /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES\n \n+              echo -e '\\nLOG:Environment setup...'\n               cd /home/$TS_USERNAME/client\n+              export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\\$NVM_DIR/nvm.sh\"\n+              echo -e '\\nLOG:Checking available Node.js versions...'\n+              nvm ls | grep 'default'\n+              echo -e '\\nLOG:Checking Node.js version...'\n+              node --version\n \n-              # Environment setup\n-              export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\\$NVM_DIR/nvm.sh\" && \\\n-              nvm ls | grep 'default' && \\\n-              echo \"Node.js version:\" && node --version\n-\n+              echo -e '\\nLOG:Installing serve...'\n               npm install -g serve@13\n \n-              # Primary client setup\n-              rm -f client-start-primary.sh && \\\n-              echo \"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 50505\" >> client-start-primary.sh && \\\n-              chmod +x client-start-primary.sh && \\\n-              pm2 delete client-primary || true && \\\n+              echo -e '\\nLOG:Primary client setup...'\n+              rm -f client-start-primary.sh\n+              echo \\\"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 50505\\\" >> client-start-primary.sh\n+              chmod +x client-start-primary.sh\n+              pm2 delete client-primary || true\n               pm2 start ./client-start-primary.sh --name client-primary\n+              echo -e '\\nLOG:Primary client setup completed.'\n+\n+              pm2 ls\n \n-              # Secondary client setup\n-              rm -f client-start-secondary.sh && \\\n-              echo \"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 52525\" >> client-start-secondary.sh && \\\n-              chmod +x client-start-secondary.sh && \\\n-              pm2 delete client-secondary || true && \\\n+              echo -e '\\nLOG:Secondary client setup...'\n+              rm -f client-start-secondary.sh\n+              echo \\\"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 52525\\\" >> client-start-secondary.sh\n+              chmod +x client-start-secondary.sh\n+              pm2 delete client-secondary || true\n               pm2 start ./client-start-secondary.sh --name client-secondary\n-          EOF\n-            if [ $? -ne 0 ]; then\n-              echo \"::error::Deployment to $TS_MACHINE_NAME failed\"\n-              exit 1\n-            fi\n+              echo -e '\\nLOG:Secondary client setup completed.'\n+\n+              pm2 ls\n+              pm2 save\n+\n+              echo -e '\\nLOG:Finished deployment.'\n+            \"\n+            ssh $TS_USERNAME@$TS_MACHINE_NAME \"$REMOTE_SCRIPT\"\n           done"
        },
        {
            "sha": "8b3799130bf9a1ebf5b73048dc96297bca78bb48",
            "filename": "package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/4a64be5b29f262c1aef9cc288f584adab5186de3/package.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/4a64be5b29f262c1aef9cc288f584adab5186de3/package.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/package.json?ref=4a64be5b29f262c1aef9cc288f584adab5186de3",
            "patch": "@@ -57,7 +57,6 @@\n     \"lint:ts\": \"tsc && tsc -p shared && tsc -p api && tsc -p client\",\n     \"lint:prettier\": \"prettier --list-different .\",\n     \"lint:css\": \"stylelint '**/*.css'\",\n-    \"reload:server\": \"pm2 reload api-server/ecosystem.config.js\",\n     \"preseed\": \"npm-run-all create:shared\",\n     \"playwright:install-build-tools\": \"npx playwright install --with-deps\",\n     \"rename-challenges\": \"tsx tools/challenge-helper-scripts/rename-challenge-files.ts\","
        }
    ],
    "stats": {
        "total": 146,
        "additions": 78,
        "deletions": 68
    }
}