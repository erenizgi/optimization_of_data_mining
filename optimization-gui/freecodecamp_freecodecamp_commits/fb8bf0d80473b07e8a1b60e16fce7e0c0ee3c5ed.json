{
    "author": "ojeytonwilliams",
    "message": "feat(api): protected settings logs (#59063)",
    "sha": "fb8bf0d80473b07e8a1b60e16fce7e0c0ee3c5ed",
    "files": [
        {
            "sha": "c6936f4ed40b6e8b99e8edb07a5c6e8f78738b70",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 17,
            "changes": 85,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/fb8bf0d80473b07e8a1b60e16fce7e0c0ee3c5ed/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/fb8bf0d80473b07e8a1b60e16fce7e0c0ee3c5ed/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=fb8bf0d80473b07e8a1b60e16fce7e0c0ee3c5ed",
            "patch": "@@ -97,7 +97,9 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n   done\n ) => {\n   fastify.setErrorHandler((error, request, reply) => {\n+    const logger = fastify.log.child({ req: request });\n     if (error.validation) {\n+      logger.warn({ validationError: error.validation });\n       void reply.code(400);\n       void reply.send({ message: 'flash.wrong-updating', type: 'danger' });\n     } else {\n@@ -111,6 +113,7 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.updateMyProfileUI\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n@@ -135,7 +138,8 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error('Error updating profileUI');\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -163,7 +167,9 @@ Happy coding!\n       attachValidation: true\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       if (req.validationError) {\n+        logger.warn(`Invalid email ${req.body.email}`);\n         void reply.code(400);\n         return { message: 'Email format is invalid', type: 'danger' } as const;\n       }\n@@ -184,6 +190,9 @@ Happy coding!\n       const isVerifiedEmail = user.emailVerified;\n       const isOwnEmail = newEmail === currentEmailFormatted;\n       if (isOwnEmail && isVerifiedEmail) {\n+        logger.warn(\n+          'New email address is already associated with this account'\n+        );\n         void reply.code(400);\n         return reply.send({\n           type: 'info',\n@@ -199,6 +208,9 @@ You can update a new email address instead.`\n       });\n \n       if (isResendUpdateToSameEmail && isLinkSentWithinLimitTTL) {\n+        logger.warn(\n+          'Email confirmation link has been sent within the last 5 minutes'\n+        );\n         void reply.code(429);\n         return reply.send({\n           type: 'info',\n@@ -211,6 +223,9 @@ ${isLinkSentWithinLimitTTL}`\n         (await fastify.prisma.user.count({ where: { email: newEmail } })) > 0;\n \n       if (isEmailAlreadyTaken && !isOwnEmail) {\n+        logger.warn(\n+          'New email address is already associated with another account'\n+        );\n         void reply.code(400);\n         return reply.send({\n           type: 'info',\n@@ -238,6 +253,9 @@ ${isLinkSentWithinLimitTTL}`\n         });\n \n         if (tooManyRequestsMessage) {\n+          logger.warn(\n+            'Email confirmation link has been sent within the last 5 minutes'\n+          );\n           void reply.code(429);\n           return reply.send({\n             type: 'info',\n@@ -275,7 +293,8 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'info'\n         });\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(`Error updating user ${user.id}'s email address`);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         await reply.send({ message: 'flash.wrong-updating', type: 'danger' });\n@@ -289,6 +308,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyTheme\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n@@ -302,7 +322,8 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(`Error updating user ${req.user?.id}'s theme`);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -316,11 +337,21 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMySocials\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+\n+      const socials = {\n+        twitter: req.body.twitter,\n+        githubProfile: req.body.githubProfile,\n+        linkedin: req.body.linkedin,\n+        website: req.body.website\n+      };\n+\n       const valid = (['twitter', 'githubProfile', 'linkedin'] as const).every(\n-        key => validateSocialUrl(req.body[key], key)\n+        key => validateSocialUrl(socials[key], key)\n       );\n \n       if (!valid) {\n+        logger.warn({ socials }, `Invalid social URL`);\n         void reply.code(400);\n         return reply.send({\n           message: 'flash.wrong-updating',\n@@ -332,10 +363,10 @@ ${isLinkSentWithinLimitTTL}`\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n           data: {\n-            website: req.body.website,\n-            twitter: req.body.twitter,\n-            githubProfile: req.body.githubProfile,\n-            linkedin: req.body.linkedin\n+            website: socials.website,\n+            twitter: socials.twitter,\n+            githubProfile: socials.githubProfile,\n+            linkedin: socials.linkedin\n           }\n         });\n \n@@ -344,7 +375,8 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(`Error updating user ${req.user?.id}'s socials`);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -359,6 +391,8 @@ ${isLinkSentWithinLimitTTL}`\n       attachValidation: true\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+\n       try {\n         const user = await fastify.prisma.user.findFirstOrThrow({\n           where: { id: req.user?.id }\n@@ -375,6 +409,7 @@ ${isLinkSentWithinLimitTTL}`\n           newUsernameDisplay === oldUsernameDisplay;\n \n         if (usernameUnchanged) {\n+          logger.warn('Username is unchanged');\n           void reply.code(400);\n           return {\n             message: 'flash.username-used',\n@@ -383,6 +418,7 @@ ${isLinkSentWithinLimitTTL}`\n         }\n \n         if (req.validationError) {\n+          logger.warn(`Bad request. Supplied username: ${req.body.username}`);\n           void reply.code(400);\n           return {\n             message: req.validationError.message,\n@@ -393,6 +429,7 @@ ${isLinkSentWithinLimitTTL}`\n         const validation = isValidUsername(newUsername);\n \n         if (!validation.valid) {\n+          logger.warn(`Invalid username ${newUsername}. ${validation.error}`);\n           void reply.code(400);\n           return reply.send({\n             // TODO(Post-MVP): custom validation errors.\n@@ -409,6 +446,7 @@ ${isLinkSentWithinLimitTTL}`\n               });\n \n         if (usernameTaken || isRestricted(newUsername)) {\n+          logger.warn(`Username ${newUsername} is taken or restricted`);\n           void reply.code(400);\n           return reply.send({\n             message: 'flash.username-taken',\n@@ -430,7 +468,7 @@ ${isLinkSentWithinLimitTTL}`\n           variables: { username: newUsernameDisplay }\n         });\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         await reply.send({ message: 'flash.wrong-updating', type: 'danger' });\n@@ -444,6 +482,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyAbout\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       const hasProtocol = isPictureWithProtocol(req.body.picture);\n \n       try {\n@@ -462,7 +501,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -476,6 +515,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyKeyboardShortcuts\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n@@ -489,7 +529,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -503,6 +543,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyQuincyEmail\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n@@ -516,7 +557,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -530,6 +571,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyHonesty\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n@@ -543,7 +585,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -557,6 +599,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyPrivacyTerms\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },\n@@ -571,7 +614,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -585,6 +628,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyPortfolio\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         // TODO(Post-MVP): make all properties required in the schema and use\n         // req.body.portfolio directly.\n@@ -609,7 +653,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -623,6 +667,7 @@ ${isLinkSentWithinLimitTTL}`\n       schema: schemas.updateMyClassroomMode\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         const classroomMode = req.body.isClassroomAccount;\n \n@@ -638,7 +683,7 @@ ${isLinkSentWithinLimitTTL}`\n           type: 'success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(403);\n         return { message: 'flash.wrong-updating', type: 'danger' } as const;\n@@ -708,7 +753,9 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n     {\n       schema: schemas.confirmEmail,\n       errorHandler(error, request, reply) {\n+        const logger = fastify.log.child({ req: request });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           const { origin } = getRedirectParams(request);\n           void reply.redirectWithMessage(origin, redirectMessage);\n         } else {\n@@ -717,10 +764,12 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       const email = Buffer.from(req.query.email, 'base64').toString();\n \n       const { origin } = getRedirectParams(req);\n       if (!isEmail(email)) {\n+        logger.warn(`Invalid email ${email}`);\n         return reply.redirectWithMessage(origin, redirectMessage);\n       }\n \n@@ -729,11 +778,13 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n       });\n \n       if (!authToken) {\n+        logger.warn('No token found');\n         return reply.redirectWithMessage(origin, redirectMessage);\n       }\n \n       // TODO(Post-MVP): clean up expired auth tokens.\n       if (isExpired(authToken)) {\n+        logger.info('Token expired');\n         return reply.redirectWithMessage(origin, expirationMessage);\n       }\n "
        }
    ],
    "stats": {
        "total": 85,
        "additions": 68,
        "deletions": 17
    }
}