{
    "author": "Sembauke",
    "message": "fix(api): handle invalid picture URLs for '/update-my-about' (#61769)",
    "sha": "c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2",
    "files": [
        {
            "sha": "66df23ca5d70e0110c11298bc05ee0b6ebf1aa5d",
            "filename": "api/src/routes/protected/settings.test.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 2,
            "changes": 63,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts?ref=c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2",
            "patch": "@@ -871,15 +871,74 @@ Happy coding!\n         expect(response.statusCode).toEqual(200);\n       });\n \n-      test('PUT updates the values in about settings without image', async () => {\n+      test('PUT returns 400 if the URL is invalid', async () => {\n         const response = await superPut('/update-my-about').send({\n           about: 'Teacher at freeCodeCamp',\n           name: 'Quincy Larson',\n           location: 'USA',\n-          // `new URL` throws if the image isn't a URL, this checks if it doesn't throw.\n           picture: 'invalid'\n         });\n \n+        expect(response.body).toEqual({\n+          message: 'flash.wrong-updating',\n+          type: 'danger'\n+        });\n+        expect(response.statusCode).toEqual(400);\n+      });\n+\n+      test('PUT returns 400 if the URL has no image extension', async () => {\n+        const response = await superPut('/update-my-about').send({\n+          about: 'Teacher at freeCodeCamp',\n+          name: 'Quincy Larson',\n+          location: 'USA',\n+          picture: 'https://example.com/avatar'\n+        });\n+\n+        expect(response.body).toEqual({\n+          message: 'flash.wrong-updating',\n+          type: 'danger'\n+        });\n+        expect(response.statusCode).toEqual(400);\n+      });\n+\n+      test('PUT returns 400 if the URL has a non-image extension', async () => {\n+        const response = await superPut('/update-my-about').send({\n+          about: 'Teacher at freeCodeCamp',\n+          name: 'Quincy Larson',\n+          location: 'USA',\n+          picture: 'https://example.com/file.txt'\n+        });\n+\n+        expect(response.body).toEqual({\n+          message: 'flash.wrong-updating',\n+          type: 'danger'\n+        });\n+        expect(response.statusCode).toEqual(400);\n+      });\n+\n+      test('PUT accepts an image URL with query string', async () => {\n+        const response = await superPut('/update-my-about').send({\n+          about: 'Teacher at freeCodeCamp',\n+          name: 'Quincy Larson',\n+          location: 'USA',\n+          picture: 'https://example.com/photo.png?size=200&cache=bust'\n+        });\n+\n+        expect(response.body).toEqual({\n+          message: 'flash.updated-about-me',\n+          type: 'success'\n+        });\n+        expect(response.statusCode).toEqual(200);\n+      });\n+\n+      test('PUT accepts an image URL with a different valid extension (.webp)', async () => {\n+        const response = await superPut('/update-my-about').send({\n+          about: 'Teacher at freeCodeCamp',\n+          name: 'Quincy Larson',\n+          location: 'USA',\n+          picture: 'https://example.com/avatar.webp'\n+        });\n+\n         expect(response.body).toEqual({\n           message: 'flash.updated-about-me',\n           type: 'success'"
        },
        {
            "sha": "b94d39c2b85b04923773fad7d9bd9dd5ce417868",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 2,
            "changes": 48,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=c005816748dcd5dd37cdfe6e21f6315a0d6ec2e2",
            "patch": "@@ -53,6 +53,45 @@ export const isPictureWithProtocol = (picture?: string): boolean => {\n   }\n };\n \n+const commonImageExtensions = [\n+  'apng',\n+  'avif',\n+  'gif',\n+  'jpg',\n+  'jpeg',\n+  'jfif',\n+  'pjpeg',\n+  'pjp',\n+  'png',\n+  'svg',\n+  'webp'\n+];\n+\n+/**\n+ * Validate that a picture URL has a common image extension.\n+ *\n+ * @param picture The URL to check.\n+ * @returns Whether the URL has a common image extension.\n+ */\n+\n+const validateImageExtension = (picture?: string): boolean => {\n+  if (!picture) return true;\n+  return commonImageExtensions.some(ext => picture.includes(`.${ext}`));\n+};\n+\n+/**\n+ * Validate that a picture URL is valid. A valid picture URL either:\n+ *  - is empty/undefined (no update), or\n+ *  - has a valid http/https protocol AND has a common image extension.\n+ *\n+ * @param picture The URL to validate.\n+ * @returns Whether the picture URL is considered valid.\n+ */\n+const isValidPictureUrl = (picture?: string): boolean => {\n+  if (!picture) return true;\n+  return isPictureWithProtocol(picture) && validateImageExtension(picture);\n+};\n+\n const ALLOWED_DOMAINS_MAP = {\n   githubProfile: ['github.com'],\n   linkedin: ['linkedin.com'],\n@@ -484,7 +523,12 @@ ${isLinkSentWithinLimitTTL}`\n     },\n     async (req, reply) => {\n       const logger = fastify.log.child({ req, res: reply });\n-      const hasProtocol = isPictureWithProtocol(req.body.picture);\n+      const pictureIsValid = isValidPictureUrl(req.body.picture);\n+      if (!pictureIsValid) {\n+        logger.warn(`Invalid picture URL: ${req.body.picture}`);\n+        void reply.code(400);\n+        return { message: 'flash.wrong-updating', type: 'danger' } as const;\n+      }\n \n       try {\n         await fastify.prisma.user.update({\n@@ -493,7 +537,7 @@ ${isLinkSentWithinLimitTTL}`\n             about: req.body.about,\n             name: req.body.name,\n             location: req.body.location,\n-            picture: hasProtocol ? req.body.picture : ''\n+            picture: req.body.picture\n           }\n         });\n "
        }
    ],
    "stats": {
        "total": 111,
        "additions": 107,
        "deletions": 4
    }
}