{
    "author": "ojeytonwilliams",
    "message": "feat(api): implement authorization code flow in the new api (#55413)",
    "sha": "e94080add599f640c3df34f997528c75b7f5cc9a",
    "files": [
        {
            "sha": "be59b0775c1edd1e1955ff89067ddfeaffb08776",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -9,6 +9,7 @@\n     \"@fastify/cookie\": \"9.4.0\",\n     \"@fastify/csrf-protection\": \"6.4.1\",\n     \"@fastify/express\": \"^2.3.0\",\n+    \"@fastify/oauth2\": \"7.8.1\",\n     \"@fastify/swagger\": \"8.14.0\",\n     \"@fastify/swagger-ui\": \"1.10.2\",\n     \"@fastify/type-provider-typebox\": \"3.6.0\","
        },
        {
            "sha": "7a873d8edf91ea3c65cd357db11ee7aa28a4cbc8",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -26,7 +26,7 @@ import redirectWithMessage from './plugins/redirect-with-message';\n import security from './plugins/security';\n import codeFlowAuth from './plugins/code-flow-auth';\n import notFound from './plugins/not-found';\n-import { mobileAuth0Routes } from './routes/auth';\n+import { authRoutes, mobileAuth0Routes } from './routes/auth';\n import { devAuthRoutes } from './routes/auth-dev';\n import {\n   protectedCertificateRoutes,\n@@ -40,6 +40,7 @@ import { emailSubscribtionRoutes } from './routes/email-subscription';\n import { settingRoutes, settingRedirectRoutes } from './routes/settings';\n import { statusRoute } from './routes/status';\n import { userGetRoutes, userRoutes, userPublicGetRoutes } from './routes/user';\n+import { signoutRoute } from './routes/signout';\n import {\n   API_LOCATION,\n   EMAIL_PROVIDER,\n@@ -220,10 +221,14 @@ export const build = async (\n \n   // Routes not requiring authentication\n   void fastify.register(mobileAuth0Routes);\n+  // TODO: consolidate with LOCAL_MOCK_AUTH\n   if (FCC_ENABLE_DEV_LOGIN_MODE) {\n     void fastify.register(devAuthRoutes);\n+  } else {\n+    void fastify.register(authRoutes);\n   }\n   void fastify.register(chargeStripeRoute);\n+  void fastify.register(signoutRoute);\n   void fastify.register(emailSubscribtionRoutes);\n   void fastify.register(userPublicGetRoutes);\n   void fastify.register(unprotectedCertificateRoutes);"
        },
        {
            "sha": "9e6a67eeb1cec3b31d4848ad0bed6c6f9ee7d770",
            "filename": "api/src/plugins/auth0.test.ts",
            "status": "added",
            "additions": 405,
            "deletions": 0,
            "changes": 405,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.test.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -0,0 +1,405 @@\n+const COOKIE_DOMAIN = 'test.com';\n+import Fastify, { FastifyInstance } from 'fastify';\n+\n+import { createUserInput, nanoidCharSet } from '../utils/create-user';\n+import { AUTH0_DOMAIN, HOME_LOCATION } from '../utils/env';\n+import prismaPlugin from '../db/prisma';\n+import cookies, { sign, unsign } from './cookies';\n+import { auth0Client } from './auth0';\n+import redirectWithMessage, { formatMessage } from './redirect-with-message';\n+import codeFlowAuth from './code-flow-auth';\n+\n+// eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+jest.mock('../utils/env', () => ({\n+  ...jest.requireActual('../utils/env'),\n+  COOKIE_DOMAIN\n+}));\n+\n+describe('auth0 plugin', () => {\n+  let fastify: FastifyInstance;\n+\n+  beforeAll(async () => {\n+    fastify = Fastify();\n+\n+    await fastify.register(cookies);\n+    await fastify.register(redirectWithMessage);\n+    await fastify.register(codeFlowAuth);\n+    await fastify.register(auth0Client);\n+    await fastify.register(prismaPlugin);\n+  });\n+\n+  afterAll(async () => {\n+    await fastify.close();\n+  });\n+\n+  describe('GET /signin', () => {\n+    it('should redirect to the auth0 login page', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin'\n+      });\n+\n+      const redirectUrl = new URL(res.headers.location!);\n+      expect(redirectUrl.host).toMatch(AUTH0_DOMAIN);\n+      expect(redirectUrl.pathname).toBe('/authorize');\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('sets a login-returnto cookie', async () => {\n+      const returnTo = 'http://localhost:3000/learn';\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin',\n+        headers: {\n+          referer: returnTo\n+        }\n+      });\n+\n+      const cookie = res.cookies.find(c => c.name === 'login-returnto');\n+      expect(unsign(cookie!.value).value).toBe(returnTo);\n+      expect(cookie).toMatchObject({\n+        domain: COOKIE_DOMAIN,\n+        httpOnly: true,\n+        secure: true,\n+        sameSite: 'Lax'\n+      });\n+    });\n+  });\n+\n+  describe('GET /auth/auth0/callback', () => {\n+    const email = 'new@user.com';\n+    let getAccessTokenFromAuthorizationCodeFlowSpy: jest.SpyInstance;\n+    let userinfoSpy: jest.SpyInstance;\n+\n+    const mockAuthSuccess = () => {\n+      getAccessTokenFromAuthorizationCodeFlowSpy.mockResolvedValueOnce({\n+        token: 'any token'\n+      });\n+      userinfoSpy.mockResolvedValueOnce(Promise.resolve({ email }));\n+    };\n+\n+    beforeEach(() => {\n+      getAccessTokenFromAuthorizationCodeFlowSpy = jest.spyOn(\n+        fastify.auth0OAuth,\n+        'getAccessTokenFromAuthorizationCodeFlow'\n+      );\n+      userinfoSpy = jest.spyOn(fastify.auth0OAuth, 'userinfo');\n+      // @ts-expect-error - Only mocks part of the Sentry object.\n+      fastify.Sentry = { captureException: () => '' };\n+    });\n+\n+    afterEach(async () => {\n+      jest.restoreAllMocks();\n+      await fastify.prisma.user.deleteMany({ where: { email } });\n+    });\n+\n+    it('should redirect to the client if authentication fails', async () => {\n+      getAccessTokenFromAuthorizationCodeFlowSpy.mockRejectedValueOnce(\n+        'any error'\n+      );\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback'\n+      });\n+\n+      expect(res.headers.location).toMatch(\n+        `${HOME_LOCATION}/learn?${formatMessage({ type: 'danger', content: 'flash.generic-error' })}`\n+      );\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should redirect to the client if the state is invalid', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=invalid'\n+      });\n+\n+      expect(res.headers.location).toMatch(\n+        `${HOME_LOCATION}/learn?${formatMessage({ type: 'danger', content: 'flash.generic-error' })}`\n+      );\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should log an error if the state is invalid', async () => {\n+      jest.spyOn(fastify.log, 'error');\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=invalid'\n+      });\n+\n+      expect(fastify.log.error).toHaveBeenCalledWith(\n+        'Auth failed: invalid state'\n+      );\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should not create a user if the state is invalid', async () => {\n+      await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=invalid'\n+      });\n+\n+      expect(await fastify.prisma.user.count()).toBe(0);\n+    });\n+\n+    it('should block requests with \"access_denied\" error', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?error=access_denied&error_description=Access denied from your location'\n+      });\n+\n+      expect(res.statusCode).toBe(302);\n+      expect(res.headers.location).toMatch(`${HOME_LOCATION}/blocked`);\n+\n+      const resWithoutDescription = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?error=access_denied'\n+      });\n+\n+      expect(resWithoutDescription.statusCode).toBe(302);\n+      expect(resWithoutDescription.headers.location).toMatch(\n+        `${HOME_LOCATION}/learn?messages=`\n+      );\n+    });\n+\n+    it('creates a user if the state is valid', async () => {\n+      mockAuthSuccess();\n+      await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid'\n+      });\n+\n+      expect(await fastify.prisma.user.count()).toBe(1);\n+    });\n+\n+    it('handles userinfo errors', async () => {\n+      getAccessTokenFromAuthorizationCodeFlowSpy.mockResolvedValueOnce({\n+        token: 'any token'\n+      });\n+      userinfoSpy.mockResolvedValueOnce(Promise.reject('any error'));\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid'\n+      });\n+\n+      expect(res.headers.location).toMatch('/signin');\n+      expect(res.statusCode).toBe(302);\n+      expect(await fastify.prisma.user.count()).toBe(0);\n+    });\n+\n+    it('handles invalid userinfo responses', async () => {\n+      getAccessTokenFromAuthorizationCodeFlowSpy.mockResolvedValueOnce({\n+        token: 'any token'\n+      });\n+      userinfoSpy.mockResolvedValueOnce(Promise.resolve({}));\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid'\n+      });\n+\n+      expect(res.headers.location).toMatch('/signin');\n+      expect(res.statusCode).toBe(302);\n+      expect(await fastify.prisma.user.count()).toBe(0);\n+    });\n+\n+    it('redirects with the signin-success message on success', async () => {\n+      mockAuthSuccess();\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid'\n+      });\n+\n+      expect(res.headers.location).toMatch(\n+        `?${formatMessage({ type: 'success', content: 'flash.signin-success' })}`\n+      );\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should set the jwt_access_token cookie', async () => {\n+      mockAuthSuccess();\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid'\n+      });\n+\n+      expect(res.headers['set-cookie']).toEqual(\n+        expect.stringMatching(/jwt_access_token=/)\n+      );\n+    });\n+\n+    it('should use the login-returnto cookie if present and valid', async () => {\n+      mockAuthSuccess();\n+      await fastify.prisma.user.create({\n+        data: { ...createUserInput(email), acceptedPrivacyTerms: true }\n+      });\n+      const returnTo = 'https://www.freecodecamp.org/espanol/learn';\n+      // /signin sets the cookie\n+      const req = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin',\n+        headers: {\n+          referer: returnTo\n+        }\n+      });\n+      const returnToCookie = req.cookies.find(c => c.name === 'login-returnto');\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid',\n+        cookies: { 'login-returnto': returnToCookie!.value }\n+      });\n+\n+      expect(res.headers.location).toBe(\n+        `${returnTo}?${formatMessage({ type: 'success', content: 'flash.signin-success' })}`\n+      );\n+    });\n+\n+    it('should redirect home if the login-returnto cookie is invalid', async () => {\n+      mockAuthSuccess();\n+      const returnTo = 'https://www.evilcodecamp.org/espanol/learn';\n+      // /signin sets the cookie\n+      const req = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin',\n+        headers: {\n+          referer: returnTo\n+        }\n+      });\n+      const returnToCookie = req.cookies.find(c => c.name === 'login-returnto');\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid',\n+        cookies: { 'login-returnto': returnToCookie!.value }\n+      });\n+\n+      expect(res.headers.location).toMatch(HOME_LOCATION);\n+    });\n+\n+    it('should redirect to email-sign-up if the user has not acceptedPrivacyTerms', async () => {\n+      mockAuthSuccess();\n+      // Using an italian path to make sure redirection works.\n+      const italianReturnTo = 'https://www.freecodecamp.org/italian/settings';\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid',\n+        cookies: {\n+          'login-returnto': sign(italianReturnTo)\n+        }\n+      });\n+\n+      expect(res.headers.location).toEqual(\n+        expect.stringContaining(\n+          'https://www.freecodecamp.org/italian/email-sign-up?'\n+        )\n+      );\n+    });\n+\n+    it('should populate the user with the correct data', async () => {\n+      mockAuthSuccess();\n+      const uuidRe = /^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n+      const fccUuidRe = /^fcc-[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n+      const unsubscribeIdRe = new RegExp(`^[${nanoidCharSet}]{21}$`);\n+      const mongodbIdRe = /^[a-f0-9]{24}$/;\n+\n+      await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid'\n+      });\n+\n+      const user = await fastify.prisma.user.findFirstOrThrow({\n+        where: { email }\n+      });\n+\n+      expect(user).toEqual({\n+        about: '',\n+        acceptedPrivacyTerms: false,\n+        completedChallenges: [],\n+        completedExams: [],\n+        currentChallengeId: '',\n+        donationEmails: [],\n+        email,\n+        emailAuthLinkTTL: null,\n+        emailVerified: true,\n+        emailVerifyTTL: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        externalId: expect.stringMatching(uuidRe),\n+        githubProfile: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        id: expect.stringMatching(mongodbIdRe),\n+        is2018DataVisCert: false,\n+        is2018FullStackCert: false,\n+        isApisMicroservicesCert: false,\n+        isBackEndCert: false,\n+        isBanned: false,\n+        isCheater: false,\n+        isClassroomAccount: null,\n+        isDataAnalysisPyCertV7: false,\n+        isDataVisCert: false,\n+        isDonating: false,\n+        isFoundationalCSharpCertV8: false,\n+        isFrontEndCert: false,\n+        isFrontEndLibsCert: false,\n+        isFullStackCert: false,\n+        isHonest: false,\n+        isInfosecCertV7: false,\n+        isInfosecQaCert: false,\n+        isJsAlgoDataStructCert: false,\n+        isJsAlgoDataStructCertV8: false,\n+        isMachineLearningPyCertV7: false,\n+        isQaCertV7: false,\n+        isRelationalDatabaseCertV8: false,\n+        isCollegeAlgebraPyCertV8: false,\n+        isRespWebDesignCert: false,\n+        isSciCompPyCertV7: false,\n+        isUpcomingPythonCertV8: null,\n+        keyboardShortcuts: false,\n+        linkedin: null,\n+        location: '',\n+        name: '',\n+        needsModeration: false,\n+        newEmail: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        unsubscribeId: expect.stringMatching(unsubscribeIdRe),\n+        partiallyCompletedChallenges: [],\n+        password: null,\n+        picture: '',\n+        portfolio: [],\n+        profileUI: {\n+          isLocked: false,\n+          showAbout: false,\n+          showCerts: false,\n+          showDonation: false,\n+          showHeatMap: false,\n+          showLocation: false,\n+          showName: false,\n+          showPoints: false,\n+          showPortfolio: false,\n+          showTimeLine: false\n+        },\n+        progressTimestamps: [expect.any(Number)],\n+        rand: null,\n+        savedChallenges: [],\n+        sendQuincyEmail: false,\n+        theme: 'default',\n+        timezone: null,\n+        twitter: null,\n+        updateCount: 0,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        username: expect.stringMatching(fccUuidRe),\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        usernameDisplay: expect.stringMatching(fccUuidRe),\n+        verificationToken: null,\n+        website: null,\n+        yearsTopContributor: []\n+      });\n+      expect(user.username).toBe(user.usernameDisplay);\n+    });\n+  });\n+});"
        },
        {
            "sha": "916ade7b8a956071e5b3c3af1b482a27b85264e4",
            "filename": "api/src/plugins/auth0.ts",
            "status": "added",
            "additions": 155,
            "deletions": 0,
            "changes": 155,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -0,0 +1,155 @@\n+import fastifyOauth2, { type OAuth2Namespace } from '@fastify/oauth2';\n+import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import fp from 'fastify-plugin';\n+\n+import {\n+  API_LOCATION,\n+  AUTH0_CLIENT_ID,\n+  AUTH0_CLIENT_SECRET,\n+  AUTH0_DOMAIN,\n+  COOKIE_DOMAIN,\n+  HOME_LOCATION\n+} from '../utils/env';\n+import { findOrCreateUser } from '../routes/helpers/auth-helpers';\n+import { createAccessToken } from '../utils/tokens';\n+import {\n+  getLoginRedirectParams,\n+  getPrefixedLandingPath\n+} from '../utils/redirection';\n+\n+declare module 'fastify' {\n+  interface FastifyInstance {\n+    auth0OAuth: OAuth2Namespace;\n+  }\n+}\n+\n+/**\n+ * Fastify plugin for Auth0 authentication. This uses fastify-plugin to expose\n+ * the auth0OAuth decorator (for easier testing), but to maintain encapsulation\n+ * it should be registered in a plugin. That prevents auth0OAuth from being\n+ * available globally.\n+ *\n+ * @param fastify - The Fastify instance.\n+ * @param _options - The plugin options.\n+ * @param done - The callback function.\n+ */\n+export const auth0Client: FastifyPluginCallbackTypebox = fp(\n+  (fastify, _options, done) => {\n+    void fastify.register(fastifyOauth2, {\n+      name: 'auth0OAuth',\n+      scope: ['openid', 'email', 'profile'],\n+      credentials: {\n+        client: {\n+          id: AUTH0_CLIENT_ID,\n+          secret: AUTH0_CLIENT_SECRET\n+        }\n+      },\n+      discovery: { issuer: `https://${AUTH0_DOMAIN}` },\n+      callbackUri: `${API_LOCATION}/auth/auth0/callback`,\n+      cookie: {\n+        // It's important not to sign the cookie, since the OAuth2 plugin will\n+        // not unsign it.\n+        signed: false\n+      }\n+    });\n+\n+    fastify.get('/signin', async function (request, reply) {\n+      const returnTo = request.headers.referer ?? `${HOME_LOCATION}/learn`;\n+      void reply.setCookie('login-returnto', returnTo, {\n+        domain: COOKIE_DOMAIN,\n+        httpOnly: true,\n+        secure: true,\n+        signed: true,\n+        sameSite: 'lax'\n+      });\n+\n+      const redirectUrl = await this.auth0OAuth.generateAuthorizationUri(\n+        request,\n+        reply\n+      );\n+      void reply.redirect(redirectUrl);\n+    });\n+\n+    // TODO: use a schema to validate the query params.\n+    fastify.get('/auth/auth0/callback', async function (request, reply) {\n+      const { error, error_description } = request.query as Record<\n+        string,\n+        string\n+      >;\n+      if (error === 'access_denied') {\n+        const blockedByLaw =\n+          error_description === 'Access denied from your location';\n+\n+        if (blockedByLaw) {\n+          return reply.redirect(`${HOME_LOCATION}/blocked`);\n+        } else {\n+          return reply.redirectWithMessage(`${HOME_LOCATION}/learn`, {\n+            type: 'info',\n+            content: error_description ?? 'Authentication failed'\n+          });\n+        }\n+      }\n+\n+      const { returnTo, pathPrefix, origin } = getLoginRedirectParams(request);\n+      const redirectBase = getPrefixedLandingPath(origin, pathPrefix);\n+\n+      let token;\n+      try {\n+        token = (\n+          await this.auth0OAuth.getAccessTokenFromAuthorizationCodeFlow(request)\n+        ).token;\n+      } catch (error) {\n+        // This is the plugin's error message. If it changes, we will either\n+        // have to update the test or write custom state create/verify\n+        // functions.\n+        if (error instanceof Error && error.message === 'Invalid state') {\n+          fastify.log.error('Auth failed: invalid state');\n+        } else {\n+          fastify.log.error('Auth failed', error);\n+          fastify.Sentry.captureException(error);\n+        }\n+        // It's important _not_ to redirect to /signin here, as that could\n+        // create an infinite loop.\n+        return reply.redirectWithMessage(returnTo, {\n+          type: 'danger',\n+          content: 'flash.generic-error'\n+        });\n+      }\n+\n+      let email;\n+      try {\n+        const userinfo = (await fastify.auth0OAuth.userinfo(token)) as {\n+          email: string;\n+        };\n+        email = userinfo.email;\n+        if (typeof email !== 'string') throw Error('Invalid userinfo response');\n+      } catch (error) {\n+        fastify.log.error('Auth failed', error);\n+        fastify.Sentry.captureException(error);\n+        return reply.redirect('/signin');\n+      }\n+\n+      const { id, acceptedPrivacyTerms } = await findOrCreateUser(\n+        fastify,\n+        email\n+      );\n+\n+      reply.setAccessTokenCookie(createAccessToken(id));\n+\n+      if (acceptedPrivacyTerms) {\n+        void reply.redirectWithMessage(returnTo, {\n+          type: 'success',\n+          content: 'flash.signin-success'\n+        });\n+      } else {\n+        void reply.redirectWithMessage(`${redirectBase}/email-sign-up`, {\n+          type: 'success',\n+          content: 'flash.signin-success'\n+        });\n+      }\n+    });\n+\n+    done();\n+  },\n+  { dependencies: ['redirect-with-message'] }\n+);"
        },
        {
            "sha": "5af6e6293437551ff0ad982320f990766f023c46",
            "filename": "api/src/routes/auth-dev.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 42,
            "changes": 72,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth-dev.test.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -1,11 +1,6 @@\n /* eslint-disable @typescript-eslint/no-unsafe-member-access */\n /* eslint-disable @typescript-eslint/no-unsafe-assignment */\n-import {\n-  defaultUserEmail,\n-  devLogin,\n-  setupServer,\n-  superRequest\n-} from '../../jest.utils';\n+import { defaultUserEmail, setupServer, superRequest } from '../../jest.utils';\n import { HOME_LOCATION } from '../utils/env';\n import { nanoidCharSet } from '../utils/create-user';\n \n@@ -41,6 +36,7 @@ describe('dev login', () => {\n       const uuidRe = /^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n       const fccUuidRe = /^fcc-[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n       const unsubscribeIdRe = new RegExp(`^[${nanoidCharSet}]{21}$`);\n+      const mongodbIdRe = /^[a-f0-9]{24}$/;\n \n       await superRequest('/signin', { method: 'GET' });\n       const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n@@ -51,37 +47,56 @@ describe('dev login', () => {\n         about: '',\n         acceptedPrivacyTerms: false,\n         completedChallenges: [],\n+        completedExams: [],\n         currentChallengeId: '',\n+        donationEmails: [],\n         email: defaultUserEmail,\n+        emailAuthLinkTTL: null,\n         emailVerified: true,\n+        emailVerifyTTL: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n         externalId: expect.stringMatching(uuidRe),\n+        githubProfile: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        id: expect.stringMatching(mongodbIdRe),\n         is2018DataVisCert: false,\n         is2018FullStackCert: false,\n         isApisMicroservicesCert: false,\n         isBackEndCert: false,\n         isBanned: false,\n         isCheater: false,\n+        isClassroomAccount: null,\n         isDataAnalysisPyCertV7: false,\n         isDataVisCert: false,\n         isDonating: false,\n+        isFoundationalCSharpCertV8: false,\n         isFrontEndCert: false,\n         isFrontEndLibsCert: false,\n         isFullStackCert: false,\n         isHonest: false,\n         isInfosecCertV7: false,\n         isInfosecQaCert: false,\n         isJsAlgoDataStructCert: false,\n+        isJsAlgoDataStructCertV8: false,\n         isMachineLearningPyCertV7: false,\n         isQaCertV7: false,\n         isRelationalDatabaseCertV8: false,\n         isCollegeAlgebraPyCertV8: false,\n         isRespWebDesignCert: false,\n         isSciCompPyCertV7: false,\n+        isUpcomingPythonCertV8: null,\n         keyboardShortcuts: false,\n+        linkedin: null,\n         location: '',\n         name: '',\n+        needsModeration: false,\n+        newEmail: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n         unsubscribeId: expect.stringMatching(unsubscribeIdRe),\n+        partiallyCompletedChallenges: [],\n+        password: null,\n         picture: '',\n+        portfolio: [],\n         profileUI: {\n           isLocked: false,\n           showAbout: false,\n@@ -95,10 +110,18 @@ describe('dev login', () => {\n           showTimeLine: false\n         },\n         progressTimestamps: [expect.any(Number)],\n+        savedChallenges: [],\n         sendQuincyEmail: false,\n         theme: 'default',\n+        timezone: null,\n+        twitter: null,\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n         username: expect.stringMatching(fccUuidRe),\n-        usernameDisplay: expect.stringMatching(fccUuidRe)\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+        usernameDisplay: expect.stringMatching(fccUuidRe),\n+        verificationToken: null,\n+        website: null,\n+        yearsTopContributor: []\n       });\n       expect(user.username).toBe(user.usernameDisplay);\n     });\n@@ -169,39 +192,4 @@ describe('dev login', () => {\n       expect(res.headers.location).toBe(`${HOME_LOCATION}/learn`);\n     });\n   });\n-\n-  describe('GET /signout', () => {\n-    beforeEach(async () => {\n-      await devLogin();\n-    });\n-    it('should clear all the cookies', async () => {\n-      const res = await superRequest('/signout', { method: 'GET' });\n-\n-      const setCookie = res.headers['set-cookie'];\n-      expect(setCookie).toEqual(\n-        expect.arrayContaining([\n-          expect.stringMatching(\n-            /^jwt_access_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n-          ),\n-          expect.stringMatching(\n-            /^csrf_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n-          ),\n-          expect.stringMatching(\n-            /^_csrf=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n-          )\n-        ])\n-      );\n-      expect(setCookie).toHaveLength(3);\n-    });\n-\n-    it('should redirect to / on the client by default', async () => {\n-      const res = await superRequest('/signout', { method: 'GET' });\n-\n-      // This happens because localhost:8000 is not an allowed origin and so\n-      // normalizeParams rejects it and sets the returnTo to /learn. TODO:\n-      // separate the validation and normalization logic.\n-      expect(res.headers.location).toBe(`${HOME_LOCATION}/learn`);\n-      expect(res.status).toBe(302);\n-    });\n-  });\n });"
        },
        {
            "sha": "d848f255a6601a19a2d54a5c433edac56b0abf8b",
            "filename": "api/src/routes/auth-dev.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth-dev.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth-dev.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth-dev.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -46,11 +46,5 @@ export const devAuthRoutes: FastifyPluginCallback = (\n     await handleRedirects(req, reply);\n   });\n \n-  fastify.get('/signout', async (req, reply) => {\n-    reply.clearOurCookies();\n-\n-    const { returnTo } = getRedirectParams(req);\n-    await reply.redirect(returnTo);\n-  });\n   done();\n };"
        },
        {
            "sha": "a9587d2ffe727623592f1c3138287f2acdddc99d",
            "filename": "api/src/routes/auth.test.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth.test.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -0,0 +1,32 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n+import { createSuperRequest, devLogin, setupServer } from '../../jest.utils';\n+import { AUTH0_DOMAIN } from '../utils/env';\n+\n+jest.mock('../utils/env', () => {\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+  return {\n+    ...jest.requireActual('../utils/env'),\n+    FCC_ENABLE_DEV_LOGIN_MODE: false\n+  };\n+});\n+\n+describe('auth0 routes', () => {\n+  setupServer();\n+  describe('GET /signin', () => {\n+    let superGet: ReturnType<typeof createSuperRequest>;\n+    beforeAll(async () => {\n+      const setCookies = await devLogin();\n+\n+      superGet = createSuperRequest({ method: 'GET', setCookies });\n+    });\n+    it('should redirect to the auth0 login page', async () => {\n+      const res = await superGet('/signin');\n+\n+      expect(res.status).toBe(302);\n+      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n+      const redirectUrl = new URL(res.headers.location);\n+      expect(redirectUrl.host).toMatch(AUTH0_DOMAIN);\n+      expect(redirectUrl.pathname).toBe('/authorize');\n+    });\n+  });\n+});"
        },
        {
            "sha": "428c97b0aca28c4a0d2c55bd2731cf31cb12fe5d",
            "filename": "api/src/routes/auth.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -1,10 +1,10 @@\n import { FastifyPluginCallback, FastifyRequest } from 'fastify';\n-\n import rateLimit from 'express-rate-limit';\n // @ts-expect-error - no types\n import MongoStoreRL from 'rate-limit-mongo';\n \n import { AUTH0_DOMAIN, MONGOHQ_URL } from '../utils/env';\n+import { auth0Client } from '../plugins/auth0';\n import { findOrCreateUser } from './helpers/auth-helpers';\n \n const getEmailFromAuth0 = async (req: FastifyRequest) => {\n@@ -63,3 +63,18 @@ export const mobileAuth0Routes: FastifyPluginCallback = (\n \n   done();\n };\n+\n+/**\n+ * Route handler for authentication routes.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+export const authRoutes: FastifyPluginCallback = (fastify, _options, done) => {\n+  // All routes are registered by the auth0 plugin, but we need an extra plugin\n+  // (this one) to encapsulate the auth0 decorators. Otherwise auth0OAuth will\n+  // be available globally.\n+  void fastify.register(auth0Client);\n+  done();\n+};"
        },
        {
            "sha": "fead384025599f4bede5f6745e2340322de76046",
            "filename": "api/src/routes/helpers/auth-helpers.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -10,12 +10,12 @@ import { createUserInput } from '../../utils/create-user';\n export const findOrCreateUser = async (\n   fastify: FastifyInstance,\n   email: string\n-): Promise<{ id: string }> => {\n+): Promise<{ id: string; acceptedPrivacyTerms: boolean }> => {\n   // TODO: handle the case where there are multiple users with the same email.\n   // e.g. use findMany and throw an error if more than one is found.\n   const existingUser = await fastify.prisma.user.findMany({\n     where: { email },\n-    select: { id: true }\n+    select: { id: true, acceptedPrivacyTerms: true }\n   });\n   if (existingUser.length > 1) {\n     fastify.Sentry.captureException(\n@@ -27,7 +27,7 @@ export const findOrCreateUser = async (\n     existingUser[0] ??\n     (await fastify.prisma.user.create({\n       data: createUserInput(email),\n-      select: { id: true }\n+      select: { id: true, acceptedPrivacyTerms: true }\n     }))\n   );\n };"
        },
        {
            "sha": "9c13a0f3e4865f1c48d7756ed4fb3d6d741454ee",
            "filename": "api/src/routes/signout.test.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fsignout.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fsignout.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsignout.test.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -0,0 +1,41 @@\n+import { devLogin, setupServer, superRequest } from '../../jest.utils';\n+import { HOME_LOCATION } from '../utils/env';\n+\n+describe('GET /signout', () => {\n+  setupServer();\n+\n+  beforeEach(async () => {\n+    await devLogin();\n+  });\n+  it('should clear all the cookies', async () => {\n+    const res = await superRequest('/signout', { method: 'GET' });\n+\n+    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access\n+    const setCookie = res.headers['set-cookie'];\n+    expect(setCookie).toEqual(\n+      expect.arrayContaining([\n+        expect.stringMatching(\n+          /^jwt_access_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+        ),\n+        expect.stringMatching(\n+          /^csrf_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+        ),\n+        expect.stringMatching(\n+          /^_csrf=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+        )\n+      ])\n+    );\n+    expect(setCookie).toHaveLength(3);\n+  });\n+\n+  it('should redirect to / on the client by default', async () => {\n+    const res = await superRequest('/signout', { method: 'GET' });\n+\n+    // This happens because localhost:8000 is not an allowed origin and so\n+    // normalizeParams rejects it and sets the returnTo to /learn. TODO:\n+    // separate the validation and normalization logic.\n+    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n+    expect(res.headers.location).toBe(`${HOME_LOCATION}/learn`);\n+    expect(res.status).toBe(302);\n+  });\n+});"
        },
        {
            "sha": "5efcdecf0eb67da1b5f8cb28a8be2e63a646358a",
            "filename": "api/src/routes/signout.ts",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fsignout.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Froutes%2Fsignout.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsignout.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -0,0 +1,27 @@\n+import type { FastifyPluginCallback } from 'fastify';\n+\n+import { getRedirectParams } from '../utils/redirection';\n+\n+/**\n+ * Route handler for signing out.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin,\n+ * options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+export const signoutRoute: FastifyPluginCallback = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  fastify.get('/signout', async (req, reply) => {\n+    void reply.clearCookie('jwt_access_token');\n+    void reply.clearCookie('csrf_token');\n+    void reply.clearCookie('_csrf');\n+\n+    const { returnTo } = getRedirectParams(req);\n+    await reply.redirect(returnTo);\n+  });\n+  done();\n+};"
        },
        {
            "sha": "17153511f8ea2e9dbcd812d793c2ba392fe7f91a",
            "filename": "api/src/utils/env.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Futils%2Fenv.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Futils%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fenv.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -45,6 +45,8 @@ assert.ok(process.env.FREECODECAMP_NODE_ENV);\n assert.ok(isAllowedEnv(process.env.FREECODECAMP_NODE_ENV));\n assert.ok(process.env.EMAIL_PROVIDER);\n assert.ok(isAllowedProvider(process.env.EMAIL_PROVIDER));\n+assert.ok(process.env.AUTH0_CLIENT_ID);\n+assert.ok(process.env.AUTH0_CLIENT_SECRET);\n assert.ok(process.env.AUTH0_DOMAIN);\n assert.ok(process.env.AUTH0_AUDIENCE);\n assert.ok(process.env.API_LOCATION);\n@@ -96,6 +98,11 @@ if (process.env.FREECODECAMP_NODE_ENV !== 'development') {\n     'The Stripe secret should be changed from the default value.'\n   );\n   assert.notEqual(process.env.NODE_ENV, 'test');\n+  assert.notEqual(\n+    process.env.AUTH0_CLIENT_SECRET,\n+    'client_secret_from_auth0_dashboard',\n+    'The Auth0 client secret should be changed from the default value.'\n+  );\n }\n \n export const HOME_LOCATION = process.env.HOME_LOCATION;\n@@ -109,8 +116,10 @@ export const MONGOHQ_URL =\n     : process.env.MONGOHQ_URL;\n \n export const FREECODECAMP_NODE_ENV = process.env.FREECODECAMP_NODE_ENV;\n+export const AUTH0_CLIENT_ID = process.env.AUTH0_CLIENT_ID;\n export const AUTH0_DOMAIN = process.env.AUTH0_DOMAIN;\n export const AUTH0_AUDIENCE = process.env.AUTH0_AUDIENCE;\n+export const AUTH0_CLIENT_SECRET = process.env.AUTH0_CLIENT_SECRET;\n export const PORT = process.env.PORT || '3000';\n export const HOST = process.env.HOST || 'localhost';\n export const API_LOCATION = process.env.API_LOCATION;"
        },
        {
            "sha": "272cb4a7ceebdb25a4bdd43be0464436c9db6296",
            "filename": "api/src/utils/redirection.test.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 9,
            "changes": 38,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Futils%2Fredirection.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Futils%2Fredirection.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fredirection.test.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -1,11 +1,11 @@\n-import { FastifyRequest } from 'fastify';\n import jwt from 'jsonwebtoken';\n \n import {\n   getReturnTo,\n   normalizeParams,\n   getRedirectParams,\n-  getPrefixedLandingPath\n+  getPrefixedLandingPath,\n+  getLoginRedirectParams\n } from './redirection';\n import { HOME_LOCATION } from './env';\n \n@@ -148,12 +148,12 @@ describe('redirection', () => {\n   });\n \n   describe('getRedirectParams', () => {\n-    it('should decorate the request object', () => {\n-      const req: FastifyRequest = {\n+    it('should return origin, pathPrefix and returnTo given valid headers', () => {\n+      const req = {\n         headers: {\n           referer: `https://www.freecodecamp.org/espanol/learn/rosetta-code/`\n         }\n-      } as FastifyRequest;\n+      };\n \n       const expectedReturn = {\n         origin: 'https://www.freecodecamp.org',\n@@ -166,9 +166,9 @@ describe('redirection', () => {\n     });\n \n     it('should use HOME_LOCATION with missing referer', () => {\n-      const req: FastifyRequest = {\n+      const req = {\n         headers: {}\n-      } as FastifyRequest;\n+      };\n \n       const expectedReturn = {\n         returnTo: `${HOME_LOCATION}/learn`,\n@@ -181,11 +181,11 @@ describe('redirection', () => {\n     });\n \n     it('should use HOME_LOCATION with invalid referrer', () => {\n-      const req: FastifyRequest = {\n+      const req = {\n         headers: {\n           referer: 'invalid-url'\n         }\n-      } as FastifyRequest;\n+      };\n \n       const expectedReturn = {\n         returnTo: `${HOME_LOCATION}/learn`,\n@@ -198,6 +198,26 @@ describe('redirection', () => {\n     });\n   });\n \n+  describe('getLoginRedirectParams', () => {\n+    it('should use the login-returnto cookie if present', () => {\n+      const mockReq = {\n+        cookies: {\n+          'login-returnto': 'https://www.freecodecamp.org/espanol/learn'\n+        },\n+        unsignCookie: (rawValue: string) => ({ value: rawValue })\n+      };\n+\n+      const expectedReturn = {\n+        origin: 'https://www.freecodecamp.org',\n+        pathPrefix: 'espanol',\n+        returnTo: 'https://www.freecodecamp.org/espanol/learn'\n+      };\n+\n+      const result = getLoginRedirectParams(mockReq);\n+      expect(result).toEqual(expectedReturn);\n+    });\n+  });\n+\n   describe('getPrefixedLandingPath', () => {\n     it('should return the origin when no pathPrefix is provided', () => {\n       const result = getPrefixedLandingPath(defaultOrigin);"
        },
        {
            "sha": "e65d95a8896c70b21a1ff1aa4de5ccb08b42a2a7",
            "filename": "api/src/utils/redirection.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 19,
            "changes": 71,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Futils%2Fredirection.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/api%2Fsrc%2Futils%2Fredirection.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fredirection.ts?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -1,4 +1,3 @@\n-import { FastifyRequest } from 'fastify';\n import jwt from 'jsonwebtoken';\n \n import { availableLangs } from '../../../shared/config/i18n';\n@@ -39,6 +38,12 @@ export function getReturnTo(\n   return normalizeParams(params, _homeLocation);\n }\n \n+type RedirectParams = {\n+  returnTo: string;\n+  origin: string;\n+  pathPrefix: string;\n+};\n+\n /**\n  * Normalize the parameters, making they're valid.\n  *\n@@ -50,18 +55,16 @@ export function getReturnTo(\n  * @returns The normalized parameters.\n  */\n export function normalizeParams(\n-  {\n-    returnTo,\n-    origin,\n-    pathPrefix\n-  }: { returnTo?: string; origin?: string; pathPrefix?: string },\n+  { returnTo, origin, pathPrefix }: Partial<RedirectParams>,\n   _homeLocation = HOME_LOCATION\n-) {\n+): RedirectParams {\n   // coerce to strings, just in case something weird and nefarious is happening\n   // TODO: validate, don't coerce\n   returnTo = '' + returnTo;\n   origin = '' + origin;\n   pathPrefix = '' + pathPrefix;\n+  // TODO(Post-MVP): consider adding HOME_LOCATION in allowedOrigins to allow\n+  // redirection to work in development.\n   // we add the '/' to prevent returns to\n   // www.freecodecamp.org.somewhere.else.com\n   if (\n@@ -93,18 +96,10 @@ export function getPrefixedLandingPath(origin: string, pathPrefix?: string) {\n   return `${origin}${redirectPathSegment}`;\n }\n \n-/**\n- * Get the redirect parameters.\n- *\n- * @param req - A fastify Request.\n- * @param _normalizeParams - The function to normalize the parameters.\n- * @returns The redirect parameters.\n- */\n-export function getRedirectParams(\n-  req: FastifyRequest,\n-  _normalizeParams = normalizeParams\n+function getParamsFromUrl(\n+  url: string | undefined | null,\n+  normalize: typeof normalizeParams\n ) {\n-  const url = req.headers['referer'];\n   // since we do not always redirect the user back to the page they were on\n   // we need client locale and origin to construct the redirect url.\n   let returnUrl;\n@@ -118,7 +113,45 @@ export function getRedirectParams(\n   // if this is not one of the client languages, validation will convert\n   // this to '' before it is used.\n   const pathPrefix = returnUrl.pathname.split('/')[1] ?? '';\n-  return _normalizeParams({ returnTo: returnUrl.href, origin, pathPrefix });\n+  return normalize({ returnTo: returnUrl.href, origin, pathPrefix });\n+}\n+\n+/**\n+ * Get the redirect parameters.\n+ *\n+ * @param req - A fastify Request.\n+ * @param req.headers - The request headers.\n+ * @param req.headers.referer - The referer header.\n+ * @param _normalizeParams - The function to normalize the parameters.\n+ * @returns The redirect parameters.\n+ */\n+export function getRedirectParams(\n+  req: { headers: { referer?: string } },\n+  _normalizeParams = normalizeParams\n+): RedirectParams {\n+  const url = req.headers['referer'];\n+  return getParamsFromUrl(url, _normalizeParams);\n+}\n+\n+/**\n+ * Get the redirect parameters after sign in flow.\n+ *\n+ * @param req - A fastify Request.\n+ * @param req.cookies - The request cookies.\n+ * @param req.unsignCookie - The function to unsign the cookie.\n+ * @param _normalizeParams - The function to normalize the parameters.\n+ * @returns The redirect parameters.\n+ */\n+export function getLoginRedirectParams(\n+  req: {\n+    cookies: Record<string, string | undefined>;\n+    unsignCookie: (rawValue: string) => { value: string | null };\n+  },\n+  _normalizeParams = normalizeParams\n+): RedirectParams {\n+  const signedUrl = req.cookies['login-returnto'];\n+  const url = signedUrl ? req.unsignCookie(signedUrl).value : null;\n+  return getParamsFromUrl(url, _normalizeParams);\n }\n \n /**"
        },
        {
            "sha": "58f72f1a437103d59c24e5d4949ecb636eefdfb0",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e94080add599f640c3df34f997528c75b7f5cc9a/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e94080add599f640c3df34f997528c75b7f5cc9a/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=e94080add599f640c3df34f997528c75b7f5cc9a",
            "patch": "@@ -165,6 +165,9 @@ importers:\n       '@fastify/express':\n         specifier: ^2.3.0\n         version: 2.3.0\n+      '@fastify/oauth2':\n+        specifier: 7.8.1\n+        version: 7.8.1\n       '@fastify/swagger':\n         specifier: 8.14.0\n         version: 8.14.0\n@@ -2992,6 +2995,9 @@ packages:\n   '@fastify/fast-json-stringify-compiler@4.3.0':\n     resolution: {integrity: sha512-aZAXGYo6m22Fk1zZzEUKBvut/CIIQe/BapEORnxiD5Qr0kPHqqI69NtEMCme74h+at72sPhbkb4ZrLd1W3KRLA==}\n \n+  '@fastify/oauth2@7.8.1':\n+    resolution: {integrity: sha512-PBIMizzgEOcUcttyfX1hC6CR9vESoI1lfNucBywgcqrxvknVg+zvBCgH2+oU8NvrpSDMtlY6nyuEYYZtVhDT7Q==}\n+\n   '@fastify/send@2.1.0':\n     resolution: {integrity: sha512-yNYiY6sDkexoJR0D8IDy3aRP3+L4wdqCpvx5WP+VtEU58sn7USmKynBzDQex5X42Zzvw2gNzzYgP90UfWShLFA==}\n \n@@ -3157,10 +3163,19 @@ packages:\n     resolution: {integrity: sha512-QD1PhQk+s31P1ixsX0H0Suoupp3VMXzIVMSwobR3F3MSUO2YCV0B7xqLcUw/Bh8yuvd3LhpyqLQWTNcRmp6IdQ==}\n     deprecated: Moved to 'npm install @sideway/address'\n \n+  '@hapi/boom@10.0.1':\n+    resolution: {integrity: sha512-ERcCZaEjdH3OgSJlyjVk8pHIFeus91CjKP3v+MpgBNp5IvGzP2l/bRiD78nqYcKPaZdbKkK5vDBVPd2ohHBlsA==}\n+\n   '@hapi/bourne@1.3.2':\n     resolution: {integrity: sha512-1dVNHT76Uu5N3eJNTYcvxee+jzX4Z9lfciqRRHCU27ihbUcYi+iSc2iml5Ke1LXe1SyJCLA0+14Jh4tXJgOppA==}\n     deprecated: This version has been deprecated and is no longer supported or maintained\n \n+  '@hapi/bourne@3.0.0':\n+    resolution: {integrity: sha512-Waj1cwPXJDucOib4a3bAISsKJVb15MKi9IvmTI/7ssVEm6sywXGjVJDhl6/umt1pK1ZS7PacXU3A1PmFKHEZ2w==}\n+\n+  '@hapi/hoek@11.0.4':\n+    resolution: {integrity: sha512-PnsP5d4q7289pS2T2EgGz147BFJ2Jpb4yrEdkpz2IhgEUzos1S7HTl7ezWh1yfYzYlj89KzLdCRkqsP6SIryeQ==}\n+\n   '@hapi/hoek@8.5.1':\n     resolution: {integrity: sha512-yN7kbciD87WzLGc5539Tn0sApjyiGHAJgKvG9W8C7O+6c7qmoQMfVs0W4bX17eqz6C78QJqqFrtgdK5EWf6Qow==}\n     deprecated: This version has been deprecated and is no longer supported or maintained\n@@ -3179,6 +3194,9 @@ packages:\n   '@hapi/topo@5.1.0':\n     resolution: {integrity: sha512-foQZKJig7Ob0BMAYBfcJk8d77QtOe7Wo4ox7ff1lQYoNNAb6jwcY1ncdoy2e9wQZzvNy7ODZCYJkK8kzmcAnAg==}\n \n+  '@hapi/wreck@18.1.0':\n+    resolution: {integrity: sha512-0z6ZRCmFEfV/MQqkQomJ7sl/hyxvcZM7LtuVqN3vdAO4vM9eBbowl0kaqQj9EJJQab+3Uuh1GxbGIBFy4NfJ4w==}\n+\n   '@headlessui/react@1.7.19':\n     resolution: {integrity: sha512-Ll+8q3OlMJfJbAKM/+/Y2q6PPYbryqNTXDbryx7SXLIDamkF6iQFbriYHga0dY44PvDhvvBWCx1Xj4U5+G4hOw==}\n     engines: {node: '>=10'}\n@@ -12277,6 +12295,9 @@ packages:\n   simple-get@4.0.1:\n     resolution: {integrity: sha512-brv7p5WgH0jmQJr1ZDDfKDOSeWWg+OVypG99A/5vYGPqJ6pxiaHLy8nxtFjBA7oMa01ebA9gfh1uMCFqOuXxvA==}\n \n+  simple-oauth2@5.1.0:\n+    resolution: {integrity: sha512-gWDa38Ccm4MwlG5U7AlcJxPv3lvr80dU7ARJWrGdgvOKyzSj1gr3GBPN1rABTedAYvC/LsGYoFuFxwDBPtGEbw==}\n+\n   simple-swizzle@0.2.2:\n     resolution: {integrity: sha512-JA//kQgZtbuY83m+xT+tXJkmJncGMTFT+C+g2h2R9uxkYIrE2yy9sgmcLhCnw57/WSD+Eh3J97FPEDFnbXnDUg==}\n \n@@ -17123,6 +17144,14 @@ snapshots:\n     dependencies:\n       fast-json-stringify: 5.8.0\n \n+  '@fastify/oauth2@7.8.1':\n+    dependencies:\n+      '@fastify/cookie': 9.4.0\n+      fastify-plugin: 4.5.1\n+      simple-oauth2: 5.1.0\n+    transitivePeerDependencies:\n+      - supports-color\n+\n   '@fastify/send@2.1.0':\n     dependencies:\n       '@lukeed/ms': 2.0.1\n@@ -17375,8 +17404,16 @@ snapshots:\n \n   '@hapi/address@2.1.4': {}\n \n+  '@hapi/boom@10.0.1':\n+    dependencies:\n+      '@hapi/hoek': 11.0.4\n+\n   '@hapi/bourne@1.3.2': {}\n \n+  '@hapi/bourne@3.0.0': {}\n+\n+  '@hapi/hoek@11.0.4': {}\n+\n   '@hapi/hoek@8.5.1': {}\n \n   '@hapi/hoek@9.3.0': {}\n@@ -17396,6 +17433,12 @@ snapshots:\n     dependencies:\n       '@hapi/hoek': 9.3.0\n \n+  '@hapi/wreck@18.1.0':\n+    dependencies:\n+      '@hapi/boom': 10.0.1\n+      '@hapi/bourne': 3.0.0\n+      '@hapi/hoek': 11.0.4\n+\n   '@headlessui/react@1.7.19(react-dom@16.14.0(react@16.14.0))(react@16.14.0)':\n     dependencies:\n       '@tanstack/react-virtual': 3.0.4(react-dom@16.14.0(react@16.14.0))(react@16.14.0)\n@@ -29617,6 +29660,15 @@ snapshots:\n       once: 1.4.0\n       simple-concat: 1.0.1\n \n+  simple-oauth2@5.1.0:\n+    dependencies:\n+      '@hapi/hoek': 11.0.4\n+      '@hapi/wreck': 18.1.0\n+      debug: 4.3.4(supports-color@8.1.1)\n+      joi: 17.12.2\n+    transitivePeerDependencies:\n+      - supports-color\n+\n   simple-swizzle@0.2.2:\n     dependencies:\n       is-arrayish: 0.3.2"
        }
    ],
    "stats": {
        "total": 939,
        "additions": 858,
        "deletions": 81
    }
}