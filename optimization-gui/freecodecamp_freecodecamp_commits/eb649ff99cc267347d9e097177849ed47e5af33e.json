{
    "author": "ShaunSHamilton",
    "message": "feat: add unmet exam prerequisites (#63131)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "eb649ff99cc267347d9e097177849ed47e5af33e",
    "files": [
        {
            "sha": "aace3af50765573d4c411a997f2d0857b7d58f03",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=eb649ff99cc267347d9e097177849ed47e5af33e",
            "patch": "@@ -712,7 +712,8 @@ describe('/exam-environment/', () => {\n               totalTimeInS: mock.exam.config.totalTimeInS,\n               retakeTimeInS: mock.exam.config.retakeTimeInS\n             },\n-            id: mock.examId\n+            id: mock.examId,\n+            prerequisites: mock.exam.prerequisites\n           }\n         ]);\n \n@@ -787,7 +788,8 @@ describe('/exam-environment/', () => {\n               totalTimeInS: mock.exam.config.totalTimeInS,\n               retakeTimeInS: mock.exam.config.retakeTimeInS\n             },\n-            id: mock.examId\n+            id: mock.examId,\n+            prerequisites: mock.exam.prerequisites\n           }\n         ]);\n         expect(res.body).toMatchObject([{ canTake: true }]);"
        },
        {
            "sha": "8a7bccd62e7a4a30c60b9e08cf0866ad5b71c689",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=eb649ff99cc267347d9e097177849ed47e5af33e",
            "patch": "@@ -694,7 +694,11 @@ async function postExamAttemptHandler(\n   return reply.code(200).send();\n }\n \n-async function getExams(\n+/**\n+ * Get all the public information about all exams.\n+ * @returns Public information about exams + whether Camper may take the exam or not.\n+ */\n+export async function getExams(\n   this: FastifyInstance,\n   req: UpdateReqType<typeof schemas.examEnvironmentExams>,\n   reply: FastifyReply\n@@ -763,7 +767,8 @@ async function getExams(\n         retakeTimeInS: exam.config.retakeTimeInS,\n         passingPercent: exam.config.passingPercent\n       },\n-      canTake: false\n+      canTake: false,\n+      prerequisites: exam.prerequisites\n     };\n \n     const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);"
        },
        {
            "sha": "984059ad371c4163b37dafd1567625a7b786e3ad",
            "filename": "api/src/exam-environment/schemas/exam-environment-exams.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts?ref=eb649ff99cc267347d9e097177849ed47e5af33e",
            "patch": "@@ -2,7 +2,7 @@ import { Type } from '@fastify/type-provider-typebox';\n import { STANDARD_ERROR } from '../utils/errors.js';\n export const examEnvironmentExams = {\n   headers: Type.Object({\n-    'exam-environment-authorization-token': Type.String()\n+    'exam-environment-authorization-token': Type.Optional(Type.String())\n   }),\n   response: {\n     200: Type.Array(\n@@ -15,7 +15,8 @@ export const examEnvironmentExams = {\n           retakeTimeInS: Type.Number(),\n           passingPercent: Type.Number()\n         }),\n-        canTake: Type.Boolean()\n+        canTake: Type.Boolean(),\n+        prerequisites: Type.Array(Type.String())\n       })\n     ),\n     500: STANDARD_ERROR"
        },
        {
            "sha": "6aa141d1bef09c8f232aece4ba0f08e919871fa1",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eb649ff99cc267347d9e097177849ed47e5af33e/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=eb649ff99cc267347d9e097177849ed47e5af33e",
            "patch": "@@ -31,7 +31,8 @@ import { DEPLOYMENT_ENV, JWT_SECRET } from '../../utils/env.js';\n import {\n   getExamAttemptHandler,\n   getExamAttemptsByExamIdHandler,\n-  getExamAttemptsHandler\n+  getExamAttemptsHandler,\n+  getExams\n } from '../../exam-environment/routes/exam-environment.js';\n import { ERRORS } from '../../exam-environment/utils/errors.js';\n \n@@ -565,6 +566,13 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n     },\n     getExamAttemptsByExamIdHandler\n   );\n+  fastify.get(\n+    '/user/exam-environment/exams',\n+    {\n+      schema: examEnvironmentSchemas.examEnvironmentExams\n+    },\n+    getExams\n+  );\n \n   done();\n };"
        },
        {
            "sha": "1ec44f7351481359efc05b9e20a0806824177f8d",
            "filename": "client/src/templates/Challenges/exam-download/show.tsx",
            "status": "modified",
            "additions": 55,
            "deletions": 5,
            "changes": 60,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eb649ff99cc267347d9e097177849ed47e5af33e/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fshow.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eb649ff99cc267347d9e097177849ed47e5af33e/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fshow.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fshow.tsx?ref=eb649ff99cc267347d9e097177849ed47e5af33e",
            "patch": "@@ -16,8 +16,13 @@ import { connect } from 'react-redux';\n import LearnLayout from '../../../components/layouts/learn';\n import ChallengeTitle from '../components/challenge-title';\n import useDetectOS from '../utils/use-detect-os';\n-import { ChallengeNode } from '../../../redux/prop-types';\n-import { isSignedInSelector } from '../../../redux/selectors';\n+import { ChallengeNode, CompletedChallenge } from '../../../redux/prop-types';\n+import {\n+  completedChallengesSelector,\n+  isSignedInSelector\n+} from '../../../redux/selectors';\n+import { examAttempts } from '../../../utils/ajax';\n+import MissingPrerequisites from '../exam/components/missing-prerequisites';\n import { isChallengeCompletedSelector } from '../redux/selectors';\n import { Attempts } from './attempts';\n import ExamTokenControls from './exam-token-controls';\n@@ -30,16 +35,26 @@ interface GitProps {\n }\n \n const mapStateToProps = createSelector(\n+  completedChallengesSelector,\n   isChallengeCompletedSelector,\n   isSignedInSelector,\n-  (isChallengeCompleted: boolean, isSignedIn: boolean) => ({\n+  (\n+    completedChallenges: CompletedChallenge[],\n+    isChallengeCompleted: boolean,\n+    isSignedIn: boolean\n+  ) => ({\n+    completedChallenges,\n     isChallengeCompleted,\n     isSignedIn\n   })\n );\n \n interface ShowExamDownloadProps {\n-  data: { challengeNode: ChallengeNode };\n+  data: {\n+    challengeNode: ChallengeNode;\n+    allChallengeNode: { nodes: ChallengeNode[] };\n+  };\n+  completedChallenges: CompletedChallenge[];\n   isChallengeCompleted: boolean;\n   isSignedIn: boolean;\n }\n@@ -48,8 +63,10 @@ function ShowExamDownload({\n   data: {\n     challengeNode: {\n       challenge: { id, title, translationPending }\n-    }\n+    },\n+    allChallengeNode: { nodes }\n   },\n+  completedChallenges,\n   isChallengeCompleted,\n   isSignedIn\n }: ShowExamDownloadProps): JSX.Element {\n@@ -58,6 +75,9 @@ function ShowExamDownload({\n   const [downloadLink, setDownloadLink] = useState<string | undefined>('');\n   const [downloadLinks, setDownloadLinks] = useState<string[]>([]);\n \n+  const getExamsQuery = examAttempts.useGetExamsQuery();\n+  const examIdsQuery = examAttempts.useGetExamIdsByChallengeIdQuery(id);\n+\n   const os = useDetectOS();\n \n   const { t } = useTranslation();\n@@ -135,6 +155,22 @@ function ShowExamDownload({\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [os]);\n \n+  const examId = examIdsQuery.data?.at(0)?.examId;\n+  const exam = getExamsQuery.data?.find(examItem => examItem.id === examId);\n+  const unmetPrerequisites = exam?.prerequisites?.filter(\n+    prereq => !completedChallenges.some(challenge => challenge.id === prereq)\n+  );\n+  const challenges = nodes.filter(({ challenge }) =>\n+    unmetPrerequisites?.includes(challenge.id)\n+  );\n+  const missingPrerequisites = challenges.map(({ challenge }) => {\n+    return {\n+      id: challenge.id,\n+      title: challenge.title,\n+      slug: challenge.fields?.slug || ''\n+    };\n+  });\n+\n   return (\n     <LearnLayout>\n       <Helmet>\n@@ -151,6 +187,9 @@ function ShowExamDownload({\n           {title}\n         </ChallengeTitle>\n         <Spacer size='l' />\n+        {!!missingPrerequisites.length && (\n+          <MissingPrerequisites missingPrerequisites={missingPrerequisites} />\n+        )}\n         <h2>{t('exam.download-header')}</h2>\n         <p>{t('exam.explanation')}</p>\n         <Spacer size='l' />\n@@ -228,5 +267,16 @@ export const query = graphql`\n         translationPending\n       }\n     }\n+    allChallengeNode {\n+      nodes {\n+        challenge {\n+          id\n+          title\n+          fields {\n+            slug\n+          }\n+        }\n+      }\n+    }\n   }\n `;"
        },
        {
            "sha": "97a8b31da364b19cdba7850086d7eedae73c9b76",
            "filename": "client/src/utils/ajax.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eb649ff99cc267347d9e097177849ed47e5af33e/client%2Fsrc%2Futils%2Fajax.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eb649ff99cc267347d9e097177849ed47e5af33e/client%2Fsrc%2Futils%2Fajax.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fajax.ts?ref=eb649ff99cc267347d9e097177849ed47e5af33e",
            "patch": "@@ -430,6 +430,19 @@ export interface ExamEnvironmentChallenge {\n   challengeId: string;\n }\n \n+export type GetExamsResponse = Array<{\n+  id: string;\n+  config: {\n+    name: string;\n+    note: string;\n+    totalTimeInS: number;\n+    retakeTimeInS: number;\n+    passingPercent: number;\n+  };\n+  canTake: boolean;\n+  prerequisites: string[];\n+}>;\n+\n export const examAttempts = createApi({\n   reducerPath: 'exam-attempts',\n   baseQuery: fetchBaseQuery({\n@@ -446,6 +459,9 @@ export const examAttempts = createApi({\n     getExamIdsByChallengeId: build.query<ExamEnvironmentChallenge[], string>({\n       query: challengeId =>\n         `/exam-environment/exam-challenge?challengeId=${challengeId}`\n+    }),\n+    getExams: build.query<GetExamsResponse, void>({\n+      query: () => '/user/exam-environment/exams'\n     })\n   })\n });"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 94,
        "deletions": 12
    }
}