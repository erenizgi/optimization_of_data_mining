{
    "author": "raisedadead",
    "message": "fix(CI/CD): update deployment workflows",
    "sha": "40958082cee648c994f76e72f8689f86fcb506a3",
    "files": [
        {
            "sha": "a1e04774bde181f4b3a7bc5018126eab490b150f",
            "filename": ".github/workflows/deploy.yml",
            "status": "modified",
            "additions": 60,
            "deletions": 22,
            "changes": 82,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/40958082cee648c994f76e72f8689f86fcb506a3/.github%2Fworkflows%2Fdeploy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/40958082cee648c994f76e72f8689f86fcb506a3/.github%2Fworkflows%2Fdeploy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy.yml?ref=40958082cee648c994f76e72f8689f86fcb506a3",
            "patch": "@@ -8,27 +8,31 @@ jobs:\n     runs-on: ubuntu-24.04\n     outputs:\n       site_tld: ${{ steps.static_data.outputs.site_tld }}\n-      environment: ${{ steps.static_data.outputs.environment }}\n+      environment_long: ${{ steps.static_data.outputs.environment_long }}\n+      environment_short: ${{ steps.static_data.outputs.environment_short }}\n \n     steps:\n       - name: Set site_tld\n         id: static_data\n         run: |\n           if [ \"${{ github.ref }}\" == \"refs/heads/prod-staging\" ]; then\n             echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-            echo \"environment=staging\" >> $GITHUB_OUTPUT\n+            echo \"environment_long=staging\" >> $GITHUB_OUTPUT\n+            echo \"environment_short=stg\" >> $GITHUB_OUTPUT\n           elif [ \"${{ github.ref }}\" == \"refs/heads/prod-current\" ]; then\n             echo \"site_tld=org\" >> $GITHUB_OUTPUT\n-            echo \"environment=production\" >> $GITHUB_OUTPUT\n+            echo \"environment_long=production\" >> $GITHUB_OUTPUT\n+            echo \"environment_short=prd\" >> $GITHUB_OUTPUT\n           else\n             echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n-            echo \"environment=staging\" >> $GITHUB_OUTPUT\n+            echo \"environment_long=staging\" >> $GITHUB_OUTPUT\n+            echo \"environment_short=stg\" >> $GITHUB_OUTPUT\n           fi\n \n   build:\n     name: Build & Push Docker Image\n     needs: static\n-    uses: ./.github/workflows/re--docker-docr.yml\n+    uses: ./.github/workflows/docker-docr.yml\n     with:\n       site_tld: ${{ needs.static.outputs.site_tld }}\n       app: api\n@@ -39,7 +43,7 @@ jobs:\n     permissions:\n       deployments: write\n     environment:\n-      name: ${{ needs.static.outputs.environment }}\n+      name: ${{ needs.static.outputs.environment_long }}\n       url: https://api.freecodecamp.${{ needs.static.outputs.site_tld }}/status/ping?version=${{ needs.build.outputs.tagname }}\n \n     steps:\n@@ -60,41 +64,75 @@ jobs:\n             UserKnownHostsFile=/dev/null\n             StrictHostKeyChecking no\" > ~/.ssh/config\n \n-      - name: Check connection to Deployment Target\n+      - name: Check connection\n         run: |\n           tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Machine not found\"; exit 1; }\n           ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n \n       - name: Deploy with Docker Stack\n         env:\n-          STACK_NAME: stg-api\n-          RUNTIME_ENVS: ${{ secrets.RUNTIME_ENVS }}\n+          # These are set in the \"Environment\" secrets\n+          API_LOCATION: ${{ secrets.API_LOCATION }}\n+          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}\n+          AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}\n+          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}\n+          COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}\n+          COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}\n+          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}\n+          FCC_API_LOG_LEVEL: ${{ secrets.FCC_API_LOG_LEVEL }}\n+          GROWTHBOOK_FASTIFY_API_HOST: ${{ secrets.GROWTHBOOK_FASTIFY_API_HOST }}\n+          GROWTHBOOK_FASTIFY_CLIENT_KEY: ${{ secrets.GROWTHBOOK_FASTIFY_CLIENT_KEY }}\n+          HOME_LOCATION: ${{ secrets.HOME_LOCATION }}\n+          JWT_SECRET: ${{ secrets.JWT_SECRET }}\n+          MONGOHQ_URL: ${{ secrets.MONGOHQ_URL }}\n+          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}\n+          SES_ID: ${{ secrets.SES_ID }}\n+          SES_SECRET: ${{ secrets.SES_SECRET }}\n+          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}\n+          # These are set in the static job above\n+          DEPLOYMENT_ENV: ${{ needs.static.outputs.site_tld }}\n           DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n+          SENTRY_ENVIRONMENT: api-${{ needs.static.outputs.site_tld }}\n+          STACK_NAME: ${{ needs.static.outputs.environment_short }}-api\n         run: |\n-          REMOTE_USER=$TS_USERNAME\n           ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n \n-            # Change to the config directory\n-            cd /home/${REMOTE_USER}/docker-swarm-config/stacks/api || exit 1\n+            cd /home/${TS_USERNAME}/docker-swarm-config/stacks/api || { echo \"Failed to change directory\"; exit 1; }\n             echo \"Debug: Current directory: \\$(pwd)\"\n \n-            # Create temp file for the environment variables\n-            echo \"${RUNTIME_ENVS}\" > .env.tmp\n+            echo \"API_LOCATION=${API_LOCATION}\" >> .env.tmp\n+            echo \"AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}\" >> .env.tmp\n+            echo \"AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}\" >> .env.tmp\n+            echo \"AUTH0_DOMAIN=${AUTH0_DOMAIN}\" >> .env.tmp\n+            echo \"COOKIE_DOMAIN=${COOKIE_DOMAIN}\" >> .env.tmp\n+            echo \"COOKIE_SECRET=${COOKIE_SECRET}\" >> .env.tmp\n+            echo \"DOCKER_REGISTRY=${DOCKER_REGISTRY}\" >> .env.tmp\n+            echo \"FCC_API_LOG_LEVEL=${FCC_API_LOG_LEVEL}\" >> .env.tmp\n+            echo \"GROWTHBOOK_FASTIFY_API_HOST=${GROWTHBOOK_FASTIFY_API_HOST}\" >> .env.tmp\n+            echo \"GROWTHBOOK_FASTIFY_CLIENT_KEY=${GROWTHBOOK_FASTIFY_CLIENT_KEY}\" >> .env.tmp\n+            echo \"HOME_LOCATION=${HOME_LOCATION}\" >> .env.tmp\n+            echo \"JWT_SECRET=${JWT_SECRET}\" >> .env.tmp\n+            echo \"MONGOHQ_URL=${MONGOHQ_URL}\" >> .env.tmp\n+            echo \"SENTRY_DSN=${SENTRY_DSN}\" >> .env.tmp\n+            echo \"SES_ID=${SES_ID}\" >> .env.tmp\n+            echo \"SES_SECRET=${SES_SECRET}\" >> .env.tmp\n+            echo \"STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}\" >> .env.tmp\n+\n+            echo \"DEPLOYMENT_ENV=${DEPLOYMENT_ENV}\" >> .env.tmp\n             echo \"DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}\" >> .env.tmp\n+            echo \"SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}\" >> .env.tmp\n \n-            # Source the environment variables\n-            set -a  # Automatically export all variables\n-            source .env.tmp || exit 1\n+            set -a\n+            source .env.tmp || { echo \"Failed to source .env.tmp\"; exit 1; }\n             set +a\n-\n-            # Clean up the temp file\n             rm -f .env.tmp\n \n-            # Verify the environment variables\n             echo \"Debug: Sanity check variables: \"\n-            env | grep -E '^DEPLOYMENT' || echo 'Vars not found'\n+            env | grep -E '^DEPLOYMENT' || { echo 'Vars not found'; exit 1; }\n             echo \"Debug: Sanity check config: \"\n-            docker stack config -c stack-api.yml | rg 'DOMAIN' || echo 'Config not found'\n+            docker stack config -c stack-api.yml | rg 'DOMAIN' || { echo 'Invalid stack config'; exit 1; }\n \n+            # Dump the stack config to a file for debugging, this will be replaced with a deploy command\n+            docker stack config -c stack-api.yml > /tmp/stack-api-${DEPLOYMENT_VERSION}.yml\n           EOF\n         shell: bash"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 60,
        "deletions": 22
    }
}