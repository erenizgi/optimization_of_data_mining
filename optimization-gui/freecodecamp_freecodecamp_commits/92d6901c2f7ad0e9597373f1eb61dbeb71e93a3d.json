{
    "author": "ShaunSHamilton",
    "message": "feat(api): add exam->challenge map and routes (#61683)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
    "files": [
        {
            "sha": "a91d83e4397a329440e7fca48a97a97643e4211f",
            "filename": "api/__mocks__/exam-environment-exam.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2F__mocks__%2Fexam-environment-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2F__mocks__%2Fexam-environment-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fexam-environment-exam.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -5,15 +5,15 @@ import {\n   ExamEnvironmentExamAttempt,\n   ExamEnvironmentExam,\n   ExamEnvironmentGeneratedExam,\n-  ExamEnvironmentQuestionSet\n+  ExamEnvironmentQuestionSet,\n+  ExamEnvironmentChallenge\n } from '@prisma/client';\n import { ObjectId } from 'mongodb';\n+import { defaultUserId } from '../vitest.utils';\n import { examEnvironmentPostExamAttempt } from '../src/exam-environment/schemas';\n \n export const oid = () => new ObjectId().toString();\n \n-const defaultUserId = '64c7810107dd4782d32baee7';\n-\n export const examId = oid();\n \n export const config: ExamEnvironmentConfig = {\n@@ -344,6 +344,13 @@ export const exam: ExamEnvironmentExam = {\n   version: 1\n };\n \n+export const examEnvironmentChallenge: ExamEnvironmentChallenge = {\n+  id: oid(),\n+  examId,\n+  // Id of the certified full stack developer exam challenge page\n+  challengeId: '645147516c245de4d11eb7ba'\n+};\n+\n export async function seedEnvExam() {\n   await clearEnvExam();\n "
        },
        {
            "sha": "0e765ffdac41f7309dfae05ce1305d495af78949",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -188,8 +188,9 @@ model ExamEnvironmentExam {\n   version       Int                          @default(1)\n \n   // Relations\n-  generatedExams ExamEnvironmentGeneratedExam[]\n-  examAttempts   ExamEnvironmentExamAttempt[]\n+  generatedExams           ExamEnvironmentGeneratedExam[]\n+  examAttempts             ExamEnvironmentExamAttempt[]\n+  ExamEnvironmentChallenge ExamEnvironmentChallenge[]\n }\n \n /// A copy of `ExamEnvironmentExam` used as a staging collection for updates to the curriculum.\n@@ -378,6 +379,17 @@ type ExamEnvironmentGeneratedMultipleChoiceQuestion {\n   answers String[] @db.ObjectId\n }\n \n+/// A map between challenge ids and exam ids\n+///\n+/// This is expected to be used for relating challenge pages AND/OR certifications to exams\n+model ExamEnvironmentChallenge {\n+  id          String @id @default(auto()) @map(\"_id\") @db.ObjectId\n+  examId      String @db.ObjectId\n+  challengeId String @db.ObjectId\n+\n+  exam ExamEnvironmentExam @relation(fields: [examId], references: [id], onDelete: Cascade)\n+}\n+\n // -----------------------------------\n \n model AccessToken {"
        },
        {
            "sha": "9ea214794fee7adbd9d6fced729ecb6b3620327f",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -1070,6 +1070,57 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(200);\n       });\n     });\n+\n+    describe('GET /exam-environment/exams/:examId/attempts', () => {\n+      afterEach(async () => {\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n+      });\n+\n+      it('should return 200 if no attempts exist for the exam and user', async () => {\n+        const res = await superGet(\n+          `/exam-environment/exams/${mock.examId}/attempts`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+        expect(res.body).toEqual([]);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it('should return 200 with attempts for the given examId and user', async () => {\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: {\n+              ...mock.examAttempt,\n+              userId: defaultUserId,\n+              examId: mock.examId\n+            }\n+          });\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Pending\n+          }\n+        });\n+        const res = await superGet(\n+          `/exam-environment/exams/${mock.examId}/attempts`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+        const examEnvironmentExamAttempt = {\n+          id: attempt.id,\n+          examId: mock.exam.id,\n+          result: null,\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets,\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          version: expect.any(Number)\n+        };\n+        expect(res.body).toEqual([examEnvironmentExamAttempt]);\n+        expect(res.status).toBe(200);\n+      });\n+    });\n   });\n \n   describe('Authenticated user without exam environment authorization token', () => {\n@@ -1177,5 +1228,36 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(403);\n       });\n     });\n+\n+    describe('GET /exam-environment/challenges/:challengeId/exam-mappings', () => {\n+      afterAll(async () => {\n+        await fastifyTestInstance.prisma.examEnvironmentChallenge.deleteMany(\n+          {}\n+        );\n+      });\n+      it('should return 200 and an empty array if no exams are mapped to the challenge', async () => {\n+        const challengeId = mock.oid();\n+        const res = await superGet(\n+          `/exam-environment/challenges/${challengeId}/exam-mappings`\n+        );\n+        expect(res.body).toStrictEqual([]);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it('should return 200 and a list of exams mapped to the challenge', async () => {\n+        await fastifyTestInstance.prisma.examEnvironmentChallenge.create({\n+          data: mock.examEnvironmentChallenge\n+        });\n+        const res = await superGet(\n+          `/exam-environment/challenges/${mock.examEnvironmentChallenge.challengeId}/exam-mappings`\n+        );\n+        expect(res.body).toEqual(\n+          expect.arrayContaining([\n+            expect.objectContaining({ examId: mock.examId })\n+          ])\n+        );\n+        expect(res.status).toBe(200);\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "a607523b56a1fbeef3b9205c9ce3a4e9dc68427b",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 108,
            "deletions": 0,
            "changes": 108,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -60,6 +60,13 @@ export const examEnvironmentValidatedTokenRoutes: FastifyPluginCallbackTypebox =\n       },\n       getExamAttemptHandler\n     );\n+    fastify.get(\n+      '/exam-environment/exams/:examId/attempts',\n+      {\n+        schema: schemas.examEnvironmentGetExamAttemptsByExamId\n+      },\n+      getExamAttemptsByExamIdHandler\n+    );\n \n     done();\n   };\n@@ -81,6 +88,13 @@ export const examEnvironmentOpenRoutes: FastifyPluginCallbackTypebox = (\n     },\n     tokenMetaHandler\n   );\n+  fastify.get(\n+    '/exam-environment/challenges/:challengeId/exam-mappings',\n+    {\n+      schema: schemas.examEnvironmentGetExamMappingsByChallengeId\n+    },\n+    getExamMappingsByChallengeId\n+  );\n   done();\n };\n \n@@ -925,3 +939,97 @@ export async function getExamAttemptHandler(\n \n   return reply.send(examEnvironmentExamAttempt);\n }\n+\n+/**\n+ * Gets the requested exam attempt by id owned by authz user.\n+ *\n+ * If the attempt is completed, the result is included.\n+ */\n+export async function getExamAttemptsByExamIdHandler(\n+  this: FastifyInstance,\n+  req: UpdateReqType<typeof schemas.examEnvironmentGetExamAttemptsByExamId>,\n+  reply: FastifyReply\n+) {\n+  const logger = this.log.child({ req });\n+\n+  const user = req.user!;\n+  const { examId } = req.params;\n+\n+  logger.info({ examId, userId: user.id });\n+\n+  // If attempt id is given, only return that attempt\n+  const maybeAttempts = await mapErr(\n+    this.prisma.examEnvironmentExamAttempt.findMany({\n+      where: {\n+        examId: examId,\n+        userId: user.id\n+      }\n+    })\n+  );\n+\n+  if (maybeAttempts.hasError) {\n+    logger.error(maybeAttempts.error);\n+    this.Sentry.captureException(maybeAttempts.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempts.error))\n+    );\n+  }\n+\n+  const attempts = maybeAttempts.data;\n+\n+  const examEnvironmentExamAttempts = [];\n+  for (const attempt of attempts) {\n+    const { error, examEnvironmentExamAttempt } = await constructEnvExamAttempt(\n+      this,\n+      attempt,\n+      logger\n+    );\n+\n+    if (error) {\n+      void reply.code(error.code);\n+      return reply.send(error.data);\n+    }\n+\n+    examEnvironmentExamAttempts.push(examEnvironmentExamAttempt);\n+  }\n+\n+  return reply.send(examEnvironmentExamAttempts);\n+}\n+\n+/**\n+ * Gets all the relations for a given challenge and exam(s).\n+ */\n+export async function getExamMappingsByChallengeId(\n+  this: FastifyInstance,\n+  req: UpdateReqType<\n+    typeof schemas.examEnvironmentGetExamMappingsByChallengeId\n+  >,\n+  reply: FastifyReply\n+) {\n+  const logger = this.log.child({ req });\n+  const { challengeId } = req.params;\n+\n+  logger.info({ challengeId });\n+\n+  const maybeData = await mapErr(\n+    this.prisma.examEnvironmentChallenge.findMany({\n+      where: {\n+        challengeId\n+      }\n+    })\n+  );\n+\n+  if (maybeData.hasError) {\n+    logger.error(maybeData.error);\n+    this.Sentry.captureException(maybeData.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeData.error))\n+    );\n+  }\n+\n+  const data = maybeData.data;\n+\n+  return reply.send(data);\n+}"
        },
        {
            "sha": "1837782442141b598bc25b91061e9fe333667788",
            "filename": "api/src/exam-environment/schemas/challenges.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Fschemas%2Fchallenges.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Fschemas%2Fchallenges.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fchallenges.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -0,0 +1,12 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+// import { STANDARD_ERROR } from '../utils/errors';\n+\n+export const examEnvironmentGetExamMappingsByChallengeId = {\n+  params: Type.Object({\n+    challengeId: Type.String({ format: 'objectid' })\n+  })\n+  // response: {\n+  //   200: examEnvAttempt,\n+  //   default: STANDARD_ERROR\n+  // }\n+};"
        },
        {
            "sha": "b296f234ef7cbc38bc0dd6d0c9a099d7ddc49c5c",
            "filename": "api/src/exam-environment/schemas/exam-environment-exam-attempt.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -77,3 +77,18 @@ export const examEnvironmentGetExamAttempt = {\n     default: STANDARD_ERROR\n   }\n };\n+\n+export const examEnvironmentGetExamAttemptsByExamId = {\n+  params: Type.Object({\n+    examId: Type.String({ format: 'objectid' })\n+  }),\n+  headers: Type.Object({\n+    // Optional, because the handler is used in both the `/user/` base and `/exam-environment/` base.\n+    // If it is missing, auth will catch.\n+    'exam-environment-authorization-token': Type.Optional(Type.String())\n+  })\n+  // response: {\n+  //   200: Type.Array(examEnvAttempt),\n+  //   default: STANDARD_ERROR\n+  // }\n+};"
        },
        {
            "sha": "294fb3846ca5f5f1c0f4a14cac5eaffc7232e415",
            "filename": "api/src/exam-environment/schemas/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -1,8 +1,10 @@\n export {\n   examEnvironmentPostExamAttempt,\n   examEnvironmentGetExamAttempts,\n-  examEnvironmentGetExamAttempt\n+  examEnvironmentGetExamAttempt,\n+  examEnvironmentGetExamAttemptsByExamId\n } from './exam-environment-exam-attempt';\n export { examEnvironmentPostExamGeneratedExam } from './exam-environment-exam-generated-exam';\n export { examEnvironmentTokenMeta } from './token-meta';\n export { examEnvironmentExams } from './exam-environment-exams';\n+export { examEnvironmentGetExamMappingsByChallengeId } from './challenges';"
        },
        {
            "sha": "c35cdc8663da71fe1405547cc8569316e170e277",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -30,6 +30,7 @@ import {\n import { DEPLOYMENT_ENV, JWT_SECRET } from '../../utils/env';\n import {\n   getExamAttemptHandler,\n+  getExamAttemptsByExamIdHandler,\n   getExamAttemptsHandler\n } from '../../exam-environment/routes/exam-environment';\n import { ERRORS } from '../../exam-environment/utils/errors';\n@@ -495,6 +496,13 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n     },\n     getExamAttemptHandler\n   );\n+  fastify.get(\n+    '/user/exam-environment/exams/:examId/attempts',\n+    {\n+      schema: examEnvironmentSchemas.examEnvironmentGetExamAttemptsByExamId\n+    },\n+    getExamAttemptsByExamIdHandler\n+  );\n \n   done();\n };"
        },
        {
            "sha": "adc7a67b04a1035403939788db2967c2156c18a8",
            "filename": "api/tools/exam-environment/seed/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Ftools%2Fexam-environment%2Fseed%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Ftools%2Fexam-environment%2Fseed%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Ftools%2Fexam-environment%2Fseed%2Findex.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -16,11 +16,17 @@ async function main() {\n   await prisma.examEnvironmentExamAttempt.deleteMany({});\n   await prisma.examEnvironmentGeneratedExam.deleteMany({});\n   await prisma.examEnvironmentExam.deleteMany({});\n+  await prisma.examEnvironmentChallenge.deleteMany({});\n \n   await prisma.examEnvironmentExam.create({ data: mocks.exam });\n   await prisma.examEnvironmentGeneratedExam.create({\n     data: mocks.generatedExam\n   });\n+  await prisma.examEnvironmentExamAttempt.create({ data: mocks.examAttempt });\n+\n+  await prisma.examEnvironmentChallenge.create({\n+    data: mocks.examEnvironmentChallenge\n+  });\n }\n \n void main();"
        },
        {
            "sha": "9894bdb771b0b835563cbb7a26033ee0a021bbfe",
            "filename": "api/vitest.utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fvitest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d/api%2Fvitest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fvitest.utils.ts?ref=92d6901c2f7ad0e9597373f1eb61dbeb71e93a3d",
            "patch": "@@ -211,7 +211,8 @@ If you are seeing this error, the root cause is likely an error thrown in the be\n   });\n }\n \n-export const defaultUserId = '64c7810107dd4782d32baee7';\n+// demoUser _id to allow testing with mock data\n+export const defaultUserId = '5bd30e0f1caf6ac3ddddddb5';\n export const defaultUserEmail = 'foo@bar.com';\n export const defaultUsername = 'fcc-test-user';\n "
        }
    ],
    "stats": {
        "total": 267,
        "additions": 260,
        "deletions": 7
    }
}