{
    "author": "ojeytonwilliams",
    "message": "feat(client): handle lessons with syntax errors (#54694)",
    "sha": "202ac958476df31afbbf07af65467211797965e4",
    "files": [
        {
            "sha": "bd51e5ecc3e911dc51ed01505c5dfefcd16ee237",
            "filename": "client/src/redux/prop-types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Fredux%2Fprop-types.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Fredux%2Fprop-types.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Fprop-types.ts?ref=202ac958476df31afbbf07af65467211797965e4",
            "patch": "@@ -423,7 +423,7 @@ export type ChallengeFile = {\n   name: string;\n   editableRegionBoundaries?: number[];\n   usesMultifileEditor?: boolean;\n-  error: null | string;\n+  error?: unknown;\n   head: string;\n   tail: string;\n   seed: string;"
        },
        {
            "sha": "55b4e2356a3f7e0873c71dc33a2908850793dfc9",
            "filename": "client/src/templates/Challenges/rechallenge/transformers.js",
            "status": "modified",
            "additions": 8,
            "deletions": 24,
            "changes": 32,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js?ref=202ac958476df31afbbf07af65467211797965e4",
            "patch": "@@ -1,10 +1,8 @@\n import protect from '@freecodecamp/loop-protect';\n import {\n-  attempt,\n   cond,\n   flow,\n   identity,\n-  isError,\n   matchesProperty,\n   overSome,\n   partial,\n@@ -109,20 +107,6 @@ const replaceNBSP = cond([\n   [stubTrue, identity]\n ]);\n \n-function tryTransform(wrap = identity) {\n-  return function transformWrappedPoly(source) {\n-    const result = attempt(wrap, source);\n-    if (isError(result)) {\n-      // note(Bouncey): Error thrown here to collapse the build pipeline\n-      // At the minute, it will not bubble up\n-      // We collapse the pipeline so the app doesn't fall over trying\n-      // parse bad code (syntax/type errors etc...)\n-      throw result;\n-    }\n-    return result;\n-  };\n-}\n-\n const babelTransformer = loopProtectOptions => {\n   return cond([\n     [\n@@ -131,10 +115,10 @@ const babelTransformer = loopProtectOptions => {\n         await loadBabel();\n         await loadPresetEnv();\n         const babelOptions = getBabelOptions(presetsJS, loopProtectOptions);\n-        return partial(\n-          transformHeadTailAndContents,\n-          tryTransform(babelTransformCode(babelOptions))\n-        )(code);\n+        return transformHeadTailAndContents(\n+          babelTransformCode(babelOptions),\n+          code\n+        );\n       }\n     ],\n     [\n@@ -146,7 +130,7 @@ const babelTransformer = loopProtectOptions => {\n         return flow(\n           partial(\n             transformHeadTailAndContents,\n-            tryTransform(babelTransformCode(babelOptions))\n+            babelTransformCode(babelOptions)\n           ),\n           partial(setExt, 'js')\n         )(code);\n@@ -195,9 +179,9 @@ async function transformScript(documentElement) {\n   await loadPresetEnv();\n   const scriptTags = documentElement.querySelectorAll('script');\n   scriptTags.forEach(script => {\n-    script.innerHTML = tryTransform(\n-      babelTransformCode(getBabelOptions(presetsJS))\n-    )(script.innerHTML);\n+    script.innerHTML = babelTransformCode(getBabelOptions(presetsJS))(\n+      script.innerHTML\n+    );\n   });\n }\n "
        },
        {
            "sha": "1a4ca74e14351981c4876e07a75603b99dfd31ea",
            "filename": "client/src/templates/Challenges/redux/execute-challenge-saga.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fexecute-challenge-saga.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fexecute-challenge-saga.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fexecute-challenge-saga.js?ref=202ac958476df31afbbf07af65467211797965e4",
            "patch": "@@ -117,6 +117,8 @@ export function* executeChallengeSaga({ payload }) {\n \n     const challengeData = yield select(challengeDataSelector);\n     const challengeMeta = yield select(challengeMetaSelector);\n+    // The buildData is used even if there are build errors, so that lessons\n+    // with syntax errors can be tested.\n     const buildData = yield buildChallengeData(challengeData, {\n       preview: false,\n       disableLoopProtectTests: challengeMeta.disableLoopProtectTests,\n@@ -270,6 +272,10 @@ export function* previewChallengeSaga(action) {\n         disableLoopProtectTests: challengeMeta.disableLoopProtectTests,\n         disableLoopProtectPreview: challengeMeta.disableLoopProtectPreview\n       });\n+      // If there's an error building the challenge then throwing it here will\n+      // let the user know there's a problem.\n+      if (buildData.error) throw buildData.error;\n+\n       // evaluate the user code in the preview frame or in the worker\n       if (challengeHasPreview(challengeData)) {\n         const document = yield getContext('document');"
        },
        {
            "sha": "e18b447b32b7bdd639a75ae656174e6347fbe5ed",
            "filename": "client/src/templates/Challenges/utils/build.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 81,
            "changes": 155,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/202ac958476df31afbbf07af65467211797965e4/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts?ref=202ac958476df31afbbf07af65467211797965e4",
            "patch": "@@ -31,11 +31,9 @@ interface ChallengeFile extends PropTypesChallengeFile {\n   editableContents: string;\n }\n \n-type ChallengeFiles = ChallengeFile[];\n-\n interface BuildChallengeData extends Context {\n   challengeType: number;\n-  challengeFiles: ChallengeFiles;\n+  challengeFiles?: ChallengeFile[];\n   required: { src: string }[];\n   template: string;\n   url: string;\n@@ -84,7 +82,7 @@ const composeFunctions = (...fns: ApplyFunctionProps[]) =>\n \n // TODO: split this into at least two functions. One to create 'original' i.e.\n // the source and another to create the contents.\n-function buildSourceMap(challengeFiles: ChallengeFiles): Source | undefined {\n+function buildSourceMap(challengeFiles: ChallengeFile[]): Source | undefined {\n   // TODO: rename sources.index to sources.contents.\n   const source: Source | undefined = challengeFiles?.reduce(\n     (sources, challengeFile) => {\n@@ -103,16 +101,6 @@ function buildSourceMap(challengeFiles: ChallengeFiles): Source | undefined {\n   return source;\n }\n \n-function checkFilesErrors(challengeFiles: ChallengeFiles): ChallengeFiles {\n-  const errors = challengeFiles\n-    .filter(({ error }) => error)\n-    .map(({ error }) => error);\n-  if (errors.length) {\n-    throw errors;\n-  }\n-  return challengeFiles;\n-}\n-\n const buildFunctions = {\n   [challengeTypes.js]: buildJSChallenge,\n   [challengeTypes.jsProject]: buildJSChallenge,\n@@ -235,73 +223,82 @@ type BuildResult = {\n   challengeType: number;\n   build?: string;\n   sources: Source | undefined;\n+  loadEnzyme?: boolean;\n+  error?: unknown;\n };\n \n // TODO: All the buildXChallenge files have a similar structure, so make that\n // abstraction (function, class, whatever) and then create the various functions\n // out of it.\n-export function buildDOMChallenge(\n+export async function buildDOMChallenge(\n   { challengeFiles, required = [], template = '' }: BuildChallengeData,\n   options?: BuildOptions\n-): Promise<BuildResult> | undefined {\n-  const loadEnzyme = challengeFiles?.some(\n+): Promise<BuildResult> {\n+  // TODO: make this required in the schema.\n+  if (!challengeFiles) throw Error('No challenge files provided');\n+  const loadEnzyme = challengeFiles.some(\n     challengeFile => challengeFile.ext === 'jsx'\n   );\n \n   const pipeLine = composeFunctions(...getTransformers(options));\n-  const finalFiles = challengeFiles?.map(pipeLine);\n   const usesTestRunner = options?.usesTestRunner ?? false;\n+  const finalFiles = await Promise.all(challengeFiles.map(pipeLine));\n+  const error = finalFiles.find(({ error }) => error)?.error;\n+  const [embeddedFiles, contents] = (await embedFilesInHtml(finalFiles)) as [\n+    ChallengeFile[],\n+    string\n+  ];\n+\n+  // if there is an error, we just build the test runner so that it can be\n+  // used to run tests against the code without actually running the code.\n+  const toBuild = error\n+    ? { ...(usesTestRunner && { testRunner: frameRunnerSrc }) }\n+    : {\n+        required,\n+        template,\n+        contents,\n+        ...(usesTestRunner && { testRunner: frameRunnerSrc })\n+      };\n \n-  if (finalFiles) {\n-    return Promise.all(finalFiles)\n-      .then(checkFilesErrors)\n-      .then(\n-        embedFilesInHtml as (\n-          x: ChallengeFiles\n-        ) => Promise<[ChallengeFiles, string]>\n-      )\n-      .then(([challengeFiles, contents]) => ({\n-        // TODO: Stop overwriting challengeType with 'html'. Figure out why it's\n-        // necessary at the moment.\n-        challengeType: challengeTypes.html,\n-        build: concatHtml({\n-          required,\n-          template,\n-          contents,\n-          ...(usesTestRunner && { testRunner: frameRunnerSrc })\n-        }),\n-        sources: buildSourceMap(challengeFiles),\n-        loadEnzyme\n-      }));\n-  }\n+  return {\n+    // TODO: Stop overwriting challengeType with 'html'. Figure out why it's\n+    // necessary at the moment.\n+    challengeType: challengeTypes.html,\n+    build: concatHtml(toBuild),\n+    sources: buildSourceMap(embeddedFiles),\n+    loadEnzyme,\n+    error\n+  };\n }\n \n-export function buildJSChallenge(\n-  { challengeFiles }: { challengeFiles: ChallengeFiles },\n+export async function buildJSChallenge(\n+  { challengeFiles }: { challengeFiles?: ChallengeFile[] },\n   options: BuildOptions\n-): Promise<BuildResult> | undefined {\n+): Promise<BuildResult> {\n+  if (!challengeFiles) throw Error('No challenge files provided');\n   const pipeLine = composeFunctions(...getTransformers(options));\n \n-  const finalFiles = challengeFiles?.map(pipeLine);\n-  if (finalFiles) {\n-    return Promise.all(finalFiles)\n-      .then(checkFilesErrors)\n-      .then(challengeFiles => ({\n-        challengeType: challengeTypes.js,\n-        build: challengeFiles\n-          .reduce(\n-            (body, challengeFile) => [\n-              ...body,\n-              challengeFile.head,\n-              challengeFile.contents,\n-              challengeFile.tail\n-            ],\n-            [] as string[]\n-          )\n-          .join('\\n'),\n-        sources: buildSourceMap(challengeFiles)\n-      }));\n-  }\n+  const finalFiles = await Promise.all(challengeFiles?.map(pipeLine));\n+  const error = finalFiles.find(({ error }) => error)?.error;\n+\n+  const toBuild = error ? [] : finalFiles;\n+\n+  return {\n+    challengeType: challengeTypes.js,\n+    build: toBuild\n+      .reduce(\n+        (body, challengeFile) => [\n+          ...body,\n+          challengeFile.head,\n+          challengeFile.contents,\n+          challengeFile.tail\n+        ],\n+        [] as string[]\n+      )\n+      .join('\\n'),\n+    sources: buildSourceMap(finalFiles),\n+    error\n+  };\n }\n \n function buildBackendChallenge({ url }: BuildChallengeData) {\n@@ -312,26 +309,22 @@ function buildBackendChallenge({ url }: BuildChallengeData) {\n   };\n }\n \n-export function buildPythonChallenge({\n+export async function buildPythonChallenge({\n   challengeFiles\n-}: BuildChallengeData): Promise<BuildResult> | undefined {\n+}: BuildChallengeData): Promise<BuildResult> {\n+  if (!challengeFiles) throw new Error('No challenge files provided');\n   const pipeLine = composeFunctions(...getPythonTransformers());\n-  const finalFiles = challengeFiles.map(pipeLine);\n-\n-  if (finalFiles) {\n-    return (\n-      Promise.all(finalFiles)\n-        .then(checkFilesErrors)\n-        // Unlike the DOM challenges, there's no need to embed the files in HTML\n-        .then(challengeFiles => ({\n-          challengeType:\n-            challengeFiles[0].editableRegionBoundaries?.length === 0\n-              ? challengeTypes.multifilePythonCertProject\n-              : challengeTypes.python,\n-          sources: buildSourceMap(challengeFiles)\n-        }))\n-    );\n-  }\n+  const finalFiles = await Promise.all(challengeFiles.map(pipeLine));\n+  const error = finalFiles.find(({ error }) => error)?.error;\n+\n+  return {\n+    challengeType:\n+      challengeFiles[0].editableRegionBoundaries?.length === 0\n+        ? challengeTypes.multifilePythonCertProject\n+        : challengeTypes.python,\n+    sources: buildSourceMap(finalFiles),\n+    error\n+  };\n }\n \n export function updatePreview("
        }
    ],
    "stats": {
        "total": 195,
        "additions": 89,
        "deletions": 106
    }
}