{
    "author": "ojeytonwilliams",
    "message": "feat: base64 encode file contents when making api requests (#62006)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "8cd2efe570a31ef9b9f3e0e779bd066656852003",
    "files": [
        {
            "sha": "65ce015d0cc5a1513f2354d8820897bbd3504c0e",
            "filename": "api/src/routes/helpers/challenge-helpers.test.ts",
            "status": "modified",
            "additions": 83,
            "deletions": 1,
            "changes": 84,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.test.ts?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -7,7 +7,10 @@ import type {\n import { createFetchMock } from '../../../vitest.utils';\n import {\n   canSubmitCodeRoadCertProject,\n-  verifyTrophyWithMicrosoft\n+  verifyTrophyWithMicrosoft,\n+  decodeFiles,\n+  decodeBase64,\n+  encodeBase64\n } from './challenge-helpers';\n \n const id = 'abc';\n@@ -166,4 +169,83 @@ describe('Challenge Helpers', () => {\n       });\n     });\n   });\n+\n+  describe('decodeFiles', () => {\n+    test('decodes base64 encoded file contents', () => {\n+      const encodedFiles = [\n+        {\n+          contents: btoa('console.log(\"Hello, world!\");')\n+        },\n+        {\n+          contents: btoa('<h1>Hello, world!</h1>')\n+        }\n+      ];\n+\n+      const decodedFiles = decodeFiles(encodedFiles);\n+\n+      expect(decodedFiles).toEqual([\n+        {\n+          contents: 'console.log(\"Hello, world!\");'\n+        },\n+        {\n+          contents: '<h1>Hello, world!</h1>'\n+        }\n+      ]);\n+    });\n+\n+    test('leaves all other file properties unchanged', () => {\n+      const encodedFiles = [\n+        {\n+          contents: btoa('console.log(\"Hello, world!\");'),\n+          ext: '.js',\n+          history: [],\n+          key: 'file1',\n+          name: 'hello.js'\n+        }\n+      ];\n+\n+      const decodedFiles = decodeFiles(encodedFiles);\n+\n+      expect(decodedFiles).toEqual([\n+        {\n+          contents: 'console.log(\"Hello, world!\");',\n+          ext: '.js',\n+          history: [],\n+          key: 'file1',\n+          name: 'hello.js'\n+        }\n+      ]);\n+    });\n+\n+    test('can handle unicode characters', () => {\n+      const encodedFiles = [\n+        {\n+          contents: encodeBase64('console.log(\"Hello, âœ…ðŸš€!\");')\n+        }\n+      ];\n+\n+      const decodedFiles = decodeFiles(encodedFiles);\n+\n+      expect(decodedFiles).toEqual([\n+        {\n+          contents: 'console.log(\"Hello, âœ…ðŸš€!\");'\n+        }\n+      ]);\n+    });\n+  });\n+\n+  describe('decodeBase64', () => {\n+    test('decodes a base64 encoded string', () => {\n+      const encoded = encodeBase64('Hello, world!');\n+      const decoded = decodeBase64(encoded);\n+      expect(decoded).toBe('Hello, world!');\n+    });\n+\n+    test('can handle unicode characters', () => {\n+      const original = 'Hello, âœ…ðŸš€!';\n+      const encoded = encodeBase64(original);\n+      const decoded = decodeBase64(encoded);\n+      expect(decoded).toBe(original);\n+    });\n+  });\n });"
        },
        {
            "sha": "b71e81ddd8f1e93fc6ae38a5fb8adf7e42c1f662",
            "filename": "api/src/routes/helpers/challenge-helpers.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fchallenge-helpers.ts?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -140,3 +140,36 @@ export async function verifyTrophyWithMicrosoft({\n     } as NoTrophyError;\n   }\n }\n+\n+/**\n+ * Generic helper to decode an array of base64 encoded file objects.\n+ *\n+ * @param files Array of file-like objects each having a base64 encoded `contents` string.\n+ * @returns The same array shape with `contents` decoded.\n+ */\n+export function decodeFiles<T extends { contents: string }>(files: T[]): T[] {\n+  return files.map(file => ({\n+    ...file,\n+    contents: decodeBase64(file.contents)\n+  }));\n+}\n+\n+/**\n+ * Decodes a base64 encoded string into a UTF-8 string.\n+ *\n+ * @param str The base64 encoded string to decode.\n+ * @returns The decoded UTF-8 string.\n+ */\n+export function decodeBase64(str: string): string {\n+  return Buffer.from(str, 'base64').toString('utf-8');\n+}\n+\n+/**\n+ * Encodes a UTF-8 string into a base64 encoded string.\n+ *\n+ * @param str The UTF-8 string to encode.\n+ * @returns The base64 encoded string.\n+ */\n+export function encodeBase64(str: string): string {\n+  return Buffer.from(str, 'utf8').toString('base64');\n+}"
        },
        {
            "sha": "d3dd44c76040658cb8627d7588829a4b62c08d90",
            "filename": "api/src/routes/protected/challenge.test.ts",
            "status": "modified",
            "additions": 371,
            "deletions": 72,
            "changes": 443,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -105,60 +105,105 @@ const HtmlChallengeBody = {\n   challengeType: challengeTypes.html,\n   id: HtmlChallengeId\n };\n-const JsProjectBody = {\n+\n+const baseJsProjectBody = {\n   challengeType: challengeTypes.jsProject,\n-  id: JsProjectId,\n-  files: [\n-    {\n-      contents: 'console.log(\"Hello There!\")',\n-      key: 'scriptjs',\n-      ext: 'js',\n-      name: 'script',\n-      history: ['script.js']\n-    }\n-  ]\n-};\n-const multiFileCertProjectBody = {\n-  challengeType: challengeTypes.multifileCertProject,\n-  id: multiFileCertProjectId,\n-  files: [\n-    {\n-      contents: '<h1>Multi File Project v1</h1>',\n-      key: 'indexhtml',\n-      ext: 'html',\n-      name: 'index',\n-      history: ['index.html']\n-    },\n-    {\n-      contents: '.hello-there { general: kenobi; }',\n-      key: 'stylescss',\n-      ext: 'css',\n-      name: 'styles',\n-      history: ['styles.css']\n-    }\n-  ]\n+  id: JsProjectId\n };\n-const updatedMultiFileCertProjectBody = {\n+\n+const jsFiles = [\n+  {\n+    contents: 'console.log(\"Hello There!\")',\n+    key: 'scriptjs',\n+    ext: 'js',\n+    name: 'script',\n+    history: ['script.js']\n+  }\n+];\n+\n+const encodedJsFiles = [\n+  {\n+    contents: btoa('console.log(\"Hello There!\")'),\n+    key: 'scriptjs',\n+    ext: 'js',\n+    name: 'script',\n+    history: ['script.js']\n+  }\n+];\n+\n+const baseMultiFileCertProjectBody = {\n   challengeType: challengeTypes.multifileCertProject,\n-  id: multiFileCertProjectId,\n-  files: [\n-    {\n-      contents: '<h1>Multi File Project v2</h1>',\n-      key: 'indexhtml',\n-      ext: 'html',\n-      name: 'index',\n-      history: ['index.html']\n-    },\n-    {\n-      contents: '.wibbly-wobbly { timey: wimey; }',\n-      key: 'stylescss',\n-      ext: 'css',\n-      name: 'styles',\n-      history: ['styles.css']\n-    }\n-  ]\n+  id: multiFileCertProjectId\n };\n \n+const multiFiles = [\n+  {\n+    contents: '<h1>Multi File Project v1</h1>',\n+    key: 'indexhtml',\n+    ext: 'html',\n+    name: 'index',\n+    history: ['index.html']\n+  },\n+  {\n+    contents: '.hello-there { general: kenobi; }',\n+    key: 'stylescss',\n+    ext: 'css',\n+    name: 'styles',\n+    history: ['styles.css']\n+  }\n+];\n+\n+const updatedMultiFiles = [\n+  {\n+    contents: '<h1>Multi File Project v2</h1>',\n+    key: 'indexhtml',\n+    ext: 'html',\n+    name: 'index',\n+    history: ['index.html']\n+  },\n+  {\n+    contents: '.wibbly-wobbly { timey: wimey; }',\n+    key: 'stylescss',\n+    ext: 'css',\n+    name: 'styles',\n+    history: ['styles.css']\n+  }\n+];\n+\n+const encodedMultiFiles = [\n+  {\n+    contents: btoa('<h1>Multi File Project v1</h1>'),\n+    key: 'indexhtml',\n+    ext: 'html',\n+    name: 'index',\n+    history: ['index.html']\n+  },\n+  {\n+    contents: btoa('.hello-there { general: kenobi; }'),\n+    key: 'stylescss',\n+    ext: 'css',\n+    name: 'styles',\n+    history: ['styles.css']\n+  }\n+];\n+\n+const encodedUpdatedMultiFiles = [\n+  {\n+    contents: btoa('<h1>Multi File Project v2</h1>'),\n+    key: 'indexhtml',\n+    ext: 'html',\n+    name: 'index',\n+    history: ['index.html']\n+  },\n+  {\n+    contents: btoa('.wibbly-wobbly { timey: wimey; }'),\n+    key: 'stylescss',\n+    ext: 'css',\n+    name: 'styles',\n+    history: ['styles.css']\n+  }\n+];\n+\n const dailyCodingChallengeId = '5900f36e1000cf542c50fe80';\n const dailyCodingChallengeBody = {\n   id: dailyCodingChallengeId,\n@@ -755,6 +800,16 @@ describe('challengeRoutes', () => {\n       });\n \n       describe('handling', () => {\n+        beforeEach(async () => {\n+          await fastifyTestInstance.prisma.user.updateMany({\n+            where: { email: 'foo@bar.com' },\n+            data: {\n+              completedChallenges: [],\n+              savedChallenges: [],\n+              progressTimestamps: []\n+            }\n+          });\n+        });\n         afterEach(async () => {\n           await fastifyTestInstance.prisma.user.updateMany({\n             where: { email: 'foo@bar.com' },\n@@ -804,21 +859,22 @@ describe('challengeRoutes', () => {\n         test('POST accepts challenges with files present', async () => {\n           const now = Date.now();\n \n-          const response = await superPost('/modern-challenge-completed').send(\n-            JsProjectBody\n-          );\n+          const response = await superPost('/modern-challenge-completed').send({\n+            ...baseJsProjectBody,\n+            files: jsFiles\n+          });\n \n           const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n             where: { email: 'foo@bar.com' }\n           });\n \n-          const file = omit(JsProjectBody.files[0], 'history');\n+          const file = omit(jsFiles[0], 'history');\n \n           expect(user).toMatchObject({\n             completedChallenges: [\n               {\n                 id: JsProjectId,\n-                challengeType: JsProjectBody.challengeType,\n+                challengeType: baseJsProjectBody.challengeType,\n                 files: [file],\n                 completedDate: expect.any(Number)\n               }\n@@ -841,15 +897,16 @@ describe('challengeRoutes', () => {\n         test('POST accepts challenges with saved solutions', async () => {\n           const now = Date.now();\n \n-          const response = await superPost('/modern-challenge-completed').send(\n-            multiFileCertProjectBody\n-          );\n+          const response = await superPost('/modern-challenge-completed').send({\n+            ...baseMultiFileCertProjectBody,\n+            files: multiFiles\n+          });\n \n           const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n             where: { email: 'foo@bar.com' }\n           });\n \n-          const testFiles = multiFileCertProjectBody.files.map(\n+          const testFiles = multiFiles.map(\n             ({ history: _history, ...rest }) => rest\n           );\n \n@@ -858,7 +915,7 @@ describe('challengeRoutes', () => {\n             completedChallenges: [\n               {\n                 id: multiFileCertProjectId,\n-                challengeType: multiFileCertProjectBody.challengeType,\n+                challengeType: baseMultiFileCertProjectBody.challengeType,\n                 files: testFiles,\n                 completedDate: expect.any(Number),\n                 isManuallyApproved: false\n@@ -868,7 +925,7 @@ describe('challengeRoutes', () => {\n               {\n                 id: multiFileCertProjectId,\n                 lastSavedDate: expect.any(Number),\n-                files: multiFileCertProjectBody.files\n+                files: multiFiles\n               }\n             ]\n           });\n@@ -885,7 +942,7 @@ describe('challengeRoutes', () => {\n               {\n                 id: multiFileCertProjectId,\n                 lastSavedDate: completedDate,\n-                files: multiFileCertProjectBody.files\n+                files: multiFiles\n               }\n             ]\n           });\n@@ -895,14 +952,14 @@ describe('challengeRoutes', () => {\n         test('POST correctly handles multiple requests', async () => {\n           const resOriginal = await superPost(\n             '/modern-challenge-completed'\n-          ).send(multiFileCertProjectBody);\n+          ).send({ ...baseMultiFileCertProjectBody, files: multiFiles });\n \n           await superPost('/modern-challenge-completed').send(\n             HtmlChallengeBody\n           );\n \n           const resUpdate = await superPost('/modern-challenge-completed').send(\n-            updatedMultiFileCertProjectBody\n+            { ...baseMultiFileCertProjectBody, files: updatedMultiFiles }\n           );\n \n           const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n@@ -913,7 +970,7 @@ describe('challengeRoutes', () => {\n             challenge => challenge.completedDate\n           );\n \n-          const testFiles = updatedMultiFileCertProjectBody.files.map(file =>\n+          const testFiles = updatedMultiFiles.map(file =>\n             omit(file, 'history')\n           );\n \n@@ -922,7 +979,7 @@ describe('challengeRoutes', () => {\n             completedChallenges: [\n               {\n                 id: multiFileCertProjectId,\n-                challengeType: updatedMultiFileCertProjectBody.challengeType,\n+                challengeType: baseMultiFileCertProjectBody.challengeType,\n                 files: testFiles,\n                 completedDate: expect.any(Number),\n                 isManuallyApproved: false\n@@ -936,7 +993,7 @@ describe('challengeRoutes', () => {\n               {\n                 id: multiFileCertProjectId,\n                 lastSavedDate: expect.any(Number),\n-                files: updatedMultiFileCertProjectBody.files\n+                files: updatedMultiFiles\n               }\n             ],\n             progressTimestamps: expectedProgressTimestamps\n@@ -957,7 +1014,7 @@ describe('challengeRoutes', () => {\n               {\n                 id: multiFileCertProjectId,\n                 lastSavedDate: expect.any(Number),\n-                files: updatedMultiFileCertProjectBody.files\n+                files: updatedMultiFiles\n               }\n             ]\n           });\n@@ -966,6 +1023,197 @@ describe('challengeRoutes', () => {\n       });\n     });\n \n+    describe('/encoded/modern-challenge-completed', () => {\n+      beforeEach(async () => {\n+        await fastifyTestInstance.prisma.user.updateMany({\n+          where: { email: 'foo@bar.com' },\n+          data: {\n+            completedChallenges: [],\n+            savedChallenges: [],\n+            progressTimestamps: []\n+          }\n+        });\n+      });\n+      afterEach(async () => {\n+        await fastifyTestInstance.prisma.user.updateMany({\n+          where: { email: 'foo@bar.com' },\n+          data: {\n+            completedChallenges: [],\n+            savedChallenges: [],\n+            progressTimestamps: []\n+          }\n+        });\n+      });\n+      // JS Project(5), Multi-file Cert Project(14)\n+      test('POST accepts challenges with files present', async () => {\n+        const now = Date.now();\n+\n+        const response = await superPost(\n+          '/encoded/modern-challenge-completed'\n+        ).send({ ...baseJsProjectBody, files: encodedJsFiles });\n+\n+        const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+          where: { email: 'foo@bar.com' }\n+        });\n+\n+        const file = omit(jsFiles[0], 'history');\n+\n+        expect(user).toMatchObject({\n+          completedChallenges: [\n+            {\n+              id: JsProjectId,\n+              challengeType: baseJsProjectBody.challengeType,\n+              files: [file],\n+              completedDate: expect.any(Number)\n+            }\n+          ]\n+        });\n+\n+        const completedDate = user.completedChallenges[0]?.completedDate;\n+        expect(completedDate).toBeGreaterThanOrEqual(now);\n+        expect(completedDate).toBeLessThanOrEqual(now + 1000);\n+\n+        expect(response.body).toStrictEqual({\n+          alreadyCompleted: false,\n+          points: 1,\n+          completedDate,\n+          savedChallenges: []\n+        });\n+        expect(response.statusCode).toBe(200);\n+      });\n+\n+      test('POST accepts challenges with saved solutions', async () => {\n+        const now = Date.now();\n+\n+        const response = await superPost(\n+          '/encoded/modern-challenge-completed'\n+        ).send({\n+          ...baseMultiFileCertProjectBody,\n+          files: encodedUpdatedMultiFiles\n+        });\n+\n+        const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+          where: { email: 'foo@bar.com' }\n+        });\n+\n+        const testFiles = updatedMultiFiles.map(\n+          ({ history: _history, ...rest }) => rest\n+        );\n+\n+        expect(user).toMatchObject({\n+          needsModeration: true,\n+          completedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              challengeType: baseMultiFileCertProjectBody.challengeType,\n+              files: testFiles,\n+              completedDate: expect.any(Number),\n+              isManuallyApproved: false\n+            }\n+          ],\n+          savedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              lastSavedDate: expect.any(Number),\n+              files: updatedMultiFiles\n+            }\n+          ]\n+        });\n+\n+        const completedDate = user.completedChallenges[0]?.completedDate;\n+        expect(completedDate).toBeGreaterThanOrEqual(now);\n+        expect(completedDate).toBeLessThanOrEqual(now + 1000);\n+\n+        expect(response.body).toStrictEqual({\n+          alreadyCompleted: false,\n+          points: 1,\n+          completedDate,\n+          savedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              lastSavedDate: completedDate,\n+              files: updatedMultiFiles\n+            }\n+          ]\n+        });\n+        expect(response.statusCode).toBe(200);\n+      });\n+\n+      test('POST correctly handles multiple requests', async () => {\n+        const resOriginal = await superPost(\n+          '/encoded/modern-challenge-completed'\n+        ).send({\n+          ...baseMultiFileCertProjectBody,\n+          files: encodedMultiFiles\n+        });\n+\n+        await superPost('/encoded/modern-challenge-completed').send(\n+          HtmlChallengeBody\n+        );\n+\n+        const resUpdate = await superPost(\n+          '/encoded/modern-challenge-completed'\n+        ).send({\n+          ...baseMultiFileCertProjectBody,\n+          files: encodedUpdatedMultiFiles\n+        });\n+\n+        const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+          where: { email: 'foo@bar.com' }\n+        });\n+\n+        const expectedProgressTimestamps = user.completedChallenges.map(\n+          challenge => challenge.completedDate\n+        );\n+\n+        const testFiles = updatedMultiFiles.map(file => omit(file, 'history'));\n+\n+        expect(user).toMatchObject({\n+          needsModeration: true,\n+          completedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              challengeType: baseMultiFileCertProjectBody.challengeType,\n+              files: testFiles,\n+              completedDate: expect.any(Number),\n+              isManuallyApproved: false\n+            },\n+            {\n+              id: HtmlChallengeId,\n+              completedDate: expect.any(Number)\n+            }\n+          ],\n+          savedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              lastSavedDate: expect.any(Number),\n+              files: updatedMultiFiles\n+            }\n+          ],\n+          progressTimestamps: expectedProgressTimestamps\n+        });\n+\n+        expect(resUpdate.body.savedChallenges[0].lastSavedDate).toBeGreaterThan(\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n+          resOriginal.body.savedChallenges[0].lastSavedDate\n+        );\n+\n+        expect(resUpdate.body).toStrictEqual({\n+          alreadyCompleted: true,\n+          points: 2,\n+          completedDate: expect.any(Number),\n+          savedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              lastSavedDate: expect.any(Number),\n+              files: updatedMultiFiles\n+            }\n+          ]\n+        });\n+        expect(resUpdate.statusCode).toBe(200);\n+      });\n+    });\n+\n     describe('/daily-coding-challenge-completed', () => {\n       describe('validation', () => {\n         test('POST rejects requests without an id', async () => {\n@@ -1171,7 +1419,7 @@ describe('challengeRoutes', () => {\n             savedChallenges: {\n               // valid mongo id, but not a saveable one\n               id: 'aaaaaaaaaaaaaaaaaaaaaaa',\n-              files: multiFileCertProjectBody.files\n+              files: multiFiles\n             }\n           });\n \n@@ -1196,7 +1444,7 @@ describe('challengeRoutes', () => {\n         test('rejects requests for challenges that cannot be saved', async () => {\n           const response = await superPost('/save-challenge').send({\n             id: '66ebd4ae2812430bb883c786',\n-            files: multiFileCertProjectBody.files\n+            files: multiFiles\n           });\n \n           const { savedChallenges } =\n@@ -1212,7 +1460,7 @@ describe('challengeRoutes', () => {\n         test('update the user savedchallenges and return them', async () => {\n           const response = await superPost('/save-challenge').send({\n             id: multiFileCertProjectId,\n-            files: updatedMultiFileCertProjectBody.files\n+            files: updatedMultiFiles\n           });\n \n           const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n@@ -1226,7 +1474,7 @@ describe('challengeRoutes', () => {\n               {\n                 id: multiFileCertProjectId,\n                 lastSavedDate: savedDate,\n-                files: updatedMultiFileCertProjectBody.files\n+                files: updatedMultiFiles\n               }\n             ]\n           });\n@@ -1235,7 +1483,7 @@ describe('challengeRoutes', () => {\n               {\n                 id: multiFileCertProjectId,\n                 lastSavedDate: savedDate,\n-                files: updatedMultiFileCertProjectBody.files\n+                files: updatedMultiFiles\n               }\n             ]\n           });\n@@ -1244,6 +1492,57 @@ describe('challengeRoutes', () => {\n       });\n     });\n \n+    describe('POST /encoded/save-challenge', () => {\n+      test('rejects requests for challenges that cannot be saved', async () => {\n+        const response = await superPost('/encoded/save-challenge').send({\n+          id: '66ebd4ae2812430bb883c786',\n+          files: encodedUpdatedMultiFiles\n+        });\n+\n+        const { savedChallenges } =\n+          await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+            where: { email: 'foo@bar.com' }\n+          });\n+\n+        expect(response.statusCode).toBe(400);\n+        expect(response.text).toEqual('That challenge type is not saveable.');\n+        expect(savedChallenges).toHaveLength(0);\n+      });\n+\n+      test('update the user savedchallenges and return them', async () => {\n+        const response = await superPost('/encoded/save-challenge').send({\n+          id: multiFileCertProjectId,\n+          files: encodedUpdatedMultiFiles\n+        });\n+\n+        const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+          where: { email: 'foo@bar.com' }\n+        });\n+\n+        const savedDate = user.savedChallenges[0]?.lastSavedDate;\n+\n+        expect(user).toMatchObject({\n+          savedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              lastSavedDate: savedDate,\n+              files: updatedMultiFiles\n+            }\n+          ]\n+        });\n+        expect(response.body).toEqual({\n+          savedChallenges: [\n+            {\n+              id: multiFileCertProjectId,\n+              lastSavedDate: savedDate,\n+              files: updatedMultiFiles\n+            }\n+          ]\n+        });\n+        expect(response.statusCode).toBe(200);\n+      });\n+    });\n+\n     describe('GET /exam/:id', () => {\n       beforeAll(async () => {\n         await seedExam();"
        },
        {
            "sha": "9c553210acd6d71b51efac983515e51990fce159",
            "filename": "api/src/routes/protected/challenge.ts",
            "status": "modified",
            "additions": 177,
            "deletions": 68,
            "changes": 245,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -1,9 +1,9 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n import jwt from 'jsonwebtoken';\n import { uniqBy, matches } from 'lodash';\n-import { CompletedExam, ExamResults } from '@prisma/client';\n+import { CompletedExam, ExamResults, SavedChallengeFile } from '@prisma/client';\n import isURL from 'validator/lib/isURL';\n-import type { FastifyInstance, FastifyReply } from 'fastify';\n+import type { FastifyBaseLogger, FastifyInstance, FastifyReply } from 'fastify';\n \n import { challengeTypes } from '../../../../shared/config/challenge-types';\n import * as schemas from '../../schemas';\n@@ -32,6 +32,7 @@ import {\n import { generateRandomExam, createExamResults } from '../../utils/exam';\n import {\n   canSubmitCodeRoadCertProject,\n+  decodeFiles,\n   verifyTrophyWithMicrosoft\n } from '../helpers/challenge-helpers';\n import { UpdateReqType } from '../../utils';\n@@ -237,44 +238,49 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       );\n \n       const { id, files, challengeType } = req.body;\n-\n-      const user = await fastify.prisma.user.findUniqueOrThrow({\n-        where: { id: req.user?.id },\n-        select: userChallengeSelect\n-      });\n-      const RawProgressTimestamp = user.progressTimestamps as\n-        | ProgressTimestamp[]\n-        | null;\n-      const points = getPoints(RawProgressTimestamp);\n-\n-      const completedChallenge: CompletedChallenge = {\n+      return await postModernChallengeCompleted(fastify, {\n         id,\n         files,\n-        completedDate: Date.now()\n-      };\n-\n-      if (challengeType === challengeTypes.multifileCertProject) {\n-        completedChallenge.isManuallyApproved = false;\n-        user.needsModeration = true;\n-      }\n+        challengeType,\n+        userId: req.user!.id\n+      });\n+    }\n+  );\n \n-      if (\n-        jsCertProjectIds.includes(id) ||\n-        multifileCertProjectIds.includes(id) ||\n-        multifilePythonCertProjectIds.includes(id)\n-      ) {\n-        completedChallenge.challengeType = challengeType;\n+  fastify.post(\n+    '/encoded/modern-challenge-completed',\n+    {\n+      schema: schemas.modernChallengeCompleted,\n+      errorHandler(error, req, reply) {\n+        if (error.validation) {\n+          const logger = fastify.log.child({ req, res: reply });\n+          // This is another highly used route, so debug log level is used to\n+          // avoid excessive logging\n+          logger.debug({ validationError: error.validation });\n+          void reply.code(400);\n+          return formatProjectCompletedValidation(error.validation);\n+        } else {\n+          fastify.errorHandler(error, req, reply);\n+        }\n       }\n+    },\n+    async (req, reply) => {\n+      const logger = fastify.log.child({ req, res: reply });\n+      // This is another highly used route, so debug log level is used to\n+      // avoid excessive logging\n+      logger.debug(\n+        { userId: req.user?.id },\n+        'User submitted a modern challenge'\n+      );\n \n-      const { alreadyCompleted, userSavedChallenges: savedChallenges } =\n-        await updateUserChallengeData(fastify, user, id, completedChallenge);\n-\n-      return {\n-        alreadyCompleted,\n-        points: alreadyCompleted ? points : points + 1,\n-        completedDate: completedChallenge.completedDate,\n-        savedChallenges\n-      };\n+      const { id, files: encodedFiles, challengeType } = req.body;\n+      const files = encodedFiles ? decodeFiles(encodedFiles) : undefined;\n+      return await postModernChallengeCompleted(fastify, {\n+        id,\n+        files,\n+        challengeType,\n+        userId: req.user!.id\n+      });\n     }\n   );\n \n@@ -319,43 +325,42 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n       logger.info({ userId: req.user?.id }, 'User saved a challenge');\n \n       const { files, id: challengeId } = req.body;\n-      const user = await fastify.prisma.user.findUniqueOrThrow({\n-        where: { id: req.user?.id }\n-      });\n-      const challenge = {\n-        id: challengeId,\n-        files\n-      };\n-\n-      if (\n-        !multifileCertProjectIds.includes(challengeId) &&\n-        !multifilePythonCertProjectIds.includes(challengeId)\n-      ) {\n-        logger.warn(\n-          {\n-            challengeId\n-          },\n-          'User tried to save a challenge that is not saveable'\n-        );\n-        return void reply\n-          .code(400)\n-          .send('That challenge type is not saveable.');\n-      }\n-\n-      const userSavedChallenges = saveUserChallengeData(\n-        challengeId,\n-        user.savedChallenges,\n-        challenge\n+      await postSaveChallenge(\n+        fastify,\n+        { challengeId, files, userId: req.user!.id },\n+        logger,\n+        reply\n       );\n+    }\n+  );\n \n-      await fastify.prisma.user.update({\n-        where: { id: user.id },\n-        data: {\n-          savedChallenges: userSavedChallenges\n+  fastify.post(\n+    '/encoded/save-challenge',\n+    {\n+      schema: schemas.saveChallenge,\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req, res: reply });\n+        if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n+          void reply.code(400);\n+          return formatProjectCompletedValidation(error.validation);\n+        } else {\n+          fastify.errorHandler(error, req, reply);\n         }\n-      });\n+      }\n+    },\n+    async (req, reply) => {\n+      const logger = fastify.log.child({ req, res: reply });\n+      logger.info({ userId: req.user?.id }, 'User saved a challenge');\n \n-      void reply.send({ savedChallenges: userSavedChallenges });\n+      const { files: encodedFiles, id: challengeId } = req.body;\n+      const files = decodeFiles(encodedFiles);\n+      await postSaveChallenge(\n+        fastify,\n+        { challengeId, files, userId: req.user!.id },\n+        logger,\n+        reply\n+      );\n     }\n   );\n \n@@ -1098,3 +1103,107 @@ async function postDailyCodingChallengeCompleted(\n     });\n   }\n }\n+\n+async function postSaveChallenge(\n+  fastify: FastifyInstance,\n+  {\n+    challengeId,\n+    userId,\n+    files\n+  }: {\n+    challengeId: string;\n+    userId: string;\n+    files: SavedChallengeFile[];\n+  },\n+  logger: FastifyBaseLogger,\n+  reply: FastifyReply\n+) {\n+  const user = await fastify.prisma.user.findUniqueOrThrow({\n+    where: { id: userId }\n+  });\n+  const challenge = {\n+    id: challengeId,\n+    files\n+  };\n+\n+  if (\n+    !multifileCertProjectIds.includes(challengeId) &&\n+    !multifilePythonCertProjectIds.includes(challengeId)\n+  ) {\n+    logger.warn(\n+      {\n+        challengeId\n+      },\n+      'User tried to save a challenge that is not saveable'\n+    );\n+    return void reply.code(400).send('That challenge type is not saveable.');\n+  }\n+\n+  const userSavedChallenges = saveUserChallengeData(\n+    challengeId,\n+    user.savedChallenges,\n+    challenge\n+  );\n+\n+  await fastify.prisma.user.update({\n+    where: { id: user.id },\n+    data: {\n+      savedChallenges: userSavedChallenges\n+    }\n+  });\n+\n+  void reply.send({ savedChallenges: userSavedChallenges });\n+}\n+\n+async function postModernChallengeCompleted(\n+  fastify: FastifyInstance,\n+  {\n+    id,\n+    userId,\n+    challengeType,\n+    files\n+  }: {\n+    id: string;\n+    userId: string;\n+    challengeType: number;\n+    files: CompletedChallenge['files'];\n+  }\n+) {\n+  const user = await fastify.prisma.user.findUniqueOrThrow({\n+    where: { id: userId },\n+    select: userChallengeSelect\n+  });\n+  const RawProgressTimestamp = user.progressTimestamps as\n+    | ProgressTimestamp[]\n+    | null;\n+  const points = getPoints(RawProgressTimestamp);\n+\n+  const completedChallenge: CompletedChallenge = {\n+    id,\n+    files,\n+    completedDate: Date.now()\n+  };\n+\n+  if (challengeType === challengeTypes.multifileCertProject) {\n+    completedChallenge.isManuallyApproved = false;\n+    user.needsModeration = true;\n+  }\n+\n+  if (\n+    jsCertProjectIds.includes(id) ||\n+    multifileCertProjectIds.includes(id) ||\n+    multifilePythonCertProjectIds.includes(id)\n+  ) {\n+    completedChallenge.challengeType = challengeType;\n+  }\n+\n+  const { alreadyCompleted, userSavedChallenges: savedChallenges } =\n+    await updateUserChallengeData(fastify, user, id, completedChallenge);\n+\n+  return {\n+    alreadyCompleted,\n+    points: alreadyCompleted ? points : points + 1,\n+    completedDate: completedChallenge.completedDate,\n+    savedChallenges\n+  };\n+}"
        },
        {
            "sha": "52f910b0a7a2d19ecba5268d115715a321aaf5f7",
            "filename": "client/src/templates/Challenges/redux/completion-epic.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcompletion-epic.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcompletion-epic.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcompletion-epic.js?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -153,7 +153,7 @@ function submitModern(type, state) {\n         }\n \n         update = {\n-          endpoint: '/modern-challenge-completed',\n+          endpoint: '/encoded/modern-challenge-completed',\n           payload: body\n         };\n       }"
        },
        {
            "sha": "b3d19785cb4a0ba966bcab99061c8f445077a8b3",
            "filename": "client/src/utils/ajax.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/client%2Fsrc%2Futils%2Fajax.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/client%2Fsrc%2Futils%2Fajax.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fajax.ts?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -308,7 +308,7 @@ export function postSaveChallenge(body: {\n   id: string;\n   files: ChallengeFiles;\n }): Promise<ResponseWithData<void>> {\n-  return post('/save-challenge', body);\n+  return post('/encoded/save-challenge', body);\n }\n \n export function postSubmitSurvey(body: {"
        },
        {
            "sha": "012ce87a31b045126cc1514de27382d9fd1279aa",
            "filename": "client/src/utils/challenge-request-helpers.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8cd2efe570a31ef9b9f3e0e779bd066656852003/client%2Fsrc%2Futils%2Fchallenge-request-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8cd2efe570a31ef9b9f3e0e779bd066656852003/client%2Fsrc%2Futils%2Fchallenge-request-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fchallenge-request-helpers.ts?ref=8cd2efe570a31ef9b9f3e0e779bd066656852003",
            "patch": "@@ -27,6 +27,14 @@ interface Body {\n   challengeType: number;\n }\n \n+const encodeBase64 = (str: string) => {\n+  const bytes = new TextEncoder().encode(str);\n+  const binaryString = Array.from(bytes, byte =>\n+    String.fromCodePoint(byte)\n+  ).join('');\n+  return btoa(binaryString);\n+};\n+\n export function standardizeRequestBody({\n   id,\n   challengeFiles = [],\n@@ -36,7 +44,7 @@ export function standardizeRequestBody({\n     id,\n     files: challengeFiles?.map(({ fileKey, contents, ext, name, history }) => {\n       return {\n-        contents,\n+        contents: encodeBase64(contents),\n         ext,\n         history, // TODO(Post-MVP): stop sending history, if possible. The client\n         // already gets it from the curriculum, so it should not be necessary to"
        }
    ],
    "stats": {
        "total": 819,
        "additions": 675,
        "deletions": 144
    }
}