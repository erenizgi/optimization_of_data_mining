{
    "author": "ojeytonwilliams",
    "message": "fix: redirect to api /signin from client /settings (#64398)",
    "sha": "ac3a31e920f26b2e07572c3c583b06c3ead978b5",
    "files": [
        {
            "sha": "7ba0a518ff7e99d1aa30be455f620687da1c32bb",
            "filename": "client/src/client-only-routes/show-settings.test.tsx",
            "status": "modified",
            "additions": 43,
            "deletions": 48,
            "changes": 91,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.test.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.test.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.test.tsx?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -1,60 +1,55 @@\n-/* eslint-disable */\n-// @ts-nocheck Likely need to not use ShallowRenderer\n import React from 'react';\n-import ShallowRenderer from 'react-test-renderer/shallow';\n-import { describe, it, expect, vi } from 'vitest';\n+import { render } from '@testing-library/react';\n+import { describe, it, expect, vi, beforeAll } from 'vitest';\n+import { Provider } from 'react-redux';\n import envData from '../../config/env.json';\n-import { ShowSettings } from './show-settings';\n+import ShowSettings from './show-settings';\n \n-vi.mock('../analytics');\n-vi.mock('@growthbook/growthbook-react', () => ({\n-  useFeatureIsOn: () => false\n-}));\n+import { createStore } from '../redux/create-store';\n+import { initialState } from '../redux';\n \n-const { apiLocation } = envData as Record<string, string>;\n+vi.mock('../utils/get-words');\n+\n+const { apiLocation } = envData;\n \n describe('<ShowSettings />', () => {\n-  it('renders to the DOM when user is logged in', () => {\n-    const shallow = new ShallowRenderer();\n-    shallow.render(<ShowSettings {...loggedInProps} />);\n-    expect(navigate).toHaveBeenCalledTimes(0);\n-    const result = shallow.getRenderOutput();\n-    expect(result.type.toString()).toBe('Symbol(react.fragment)');\n-    // Renders Helmet component rather than Loader\n-    expect(result.props.children[0].props.title).toEqual(\n-      'buttons.settings | freeCodeCamp.org'\n+  beforeAll(() => {\n+    // Location is not writable normally, so we have to delete and recreate\n+    // https://github.com/jestjs/jest/issues/890#issuecomment-682286025\n+    const location = window.location as string & Location;\n+    // @ts-expect-error TS is warning us that this breaks the type of\n+    // window.location, since it is not optional, but we are replacing it with\n+    // an object of the same type, it is safe to ignore.\n+    delete global.window.location;\n+    global.window.location = Object.assign({}, location);\n+  });\n+\n+  it('does not navigate if already signed in', () => {\n+    const store = createStore({\n+      app: { ...initialState, user: { sessionUser: 'anything truthy' } }\n+    });\n+    const spy = vi.spyOn(window.location, 'href', 'set');\n+\n+    render(\n+      <Provider store={store}>\n+        <ShowSettings />\n+      </Provider>\n     );\n+    expect(spy).toHaveBeenCalledTimes(0);\n   });\n \n   it('redirects to sign in page when user is not logged in', () => {\n-    const shallow = new ShallowRenderer();\n-    shallow.render(<ShowSettings {...loggedOutProps} />);\n-    expect(navigate).toHaveBeenCalledTimes(1);\n-    expect(navigate).toHaveBeenCalledWith(`${apiLocation}/signin`);\n-    const result = shallow.getRenderOutput();\n-    // Renders Loader rather than ShowSettings\n-    expect(result.type.displayName).toBe('Loader');\n+    const store = createStore({\n+      app: { ...initialState, user: { sessionUser: null } }\n+    });\n+    const spy = vi.spyOn(window.location, 'href', 'set');\n+\n+    render(\n+      <Provider store={store}>\n+        <ShowSettings />\n+      </Provider>\n+    );\n+    expect(spy).toHaveBeenCalledTimes(1);\n+    expect(spy).toHaveBeenCalledWith(`${apiLocation}/signin`);\n   });\n });\n-\n-const navigate = vi.fn();\n-const loggedInProps = {\n-  createFlashMessage: vi.fn(),\n-  hardGoTo: vi.fn(),\n-  isSignedIn: true,\n-  navigate: navigate,\n-  showLoading: false,\n-  submitNewAbout: vi.fn(),\n-  toggleTheme: vi.fn(),\n-  updateSocials: vi.fn(),\n-  updateIsHonest: vi.fn(),\n-  updatePortfolio: vi.fn(),\n-  updateQuincyEmail: vi.fn(),\n-  user: {\n-    about: '',\n-    completedChallenges: []\n-  },\n-  verifyCert: vi.fn()\n-};\n-const loggedOutProps = { ...loggedInProps };\n-loggedOutProps.isSignedIn = false;"
        },
        {
            "sha": "bdfd4aa0b6f007cd8fa82da7c2bc34d09ecd0749",
            "filename": "client/src/client-only-routes/show-settings.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 19,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.tsx?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -1,4 +1,4 @@\n-import React, { useRef, useEffect } from 'react';\n+import React, { useEffect } from 'react';\n import Helmet from 'react-helmet';\n import { useTranslation } from 'react-i18next';\n import { connect } from 'react-redux';\n@@ -23,7 +23,6 @@ import { hardGoTo as navigate } from '../redux/actions';\n import {\n   signInLoadingSelector,\n   userSelector,\n-  isSignedInSelector,\n   userTokenSelector\n } from '../redux/selectors';\n import type { User } from '../redux/prop-types';\n@@ -44,7 +43,6 @@ const { apiLocation } = envData;\n // TODO: update types for actions\n type ShowSettingsProps = {\n   createFlashMessage: typeof createFlashMessage;\n-  isSignedIn: boolean;\n   navigate: (location: string) => void;\n   showLoading: boolean;\n   toggleSoundMode: (sound: boolean) => void;\n@@ -61,17 +59,10 @@ type ShowSettingsProps = {\n const mapStateToProps = createSelector(\n   signInLoadingSelector,\n   userSelector,\n-  isSignedInSelector,\n   userTokenSelector,\n-  (\n-    showLoading: boolean,\n-    user: User | null,\n-    isSignedIn,\n-    userToken: string | null\n-  ) => ({\n+  (showLoading: boolean, user: User | null, userToken: string | null) => ({\n     showLoading,\n     user,\n-    isSignedIn,\n     userToken\n   })\n );\n@@ -94,7 +85,6 @@ export function ShowSettings(props: ShowSettingsProps): JSX.Element {\n   const { t } = useTranslation();\n   const {\n     createFlashMessage,\n-    isSignedIn,\n     toggleSoundMode,\n     toggleKeyboardShortcuts,\n     resetEditorLayout,\n@@ -107,8 +97,6 @@ export function ShowSettings(props: ShowSettingsProps): JSX.Element {\n     userToken\n   } = props;\n \n-  const isSignedInRef = useRef(isSignedIn);\n-\n   const handleHashChange = () => {\n     const id = window.location.hash.replace('#', '');\n     if (id) {\n@@ -127,12 +115,11 @@ export function ShowSettings(props: ShowSettingsProps): JSX.Element {\n     return () => window.removeEventListener('hashchange', handleHashChange);\n   }, []);\n \n-  if (showLoading || !user) {\n-    return <Loader fullScreen={true} />;\n-  }\n+  useEffect(() => {\n+    if (!user) navigate(`${apiLocation}/signin`);\n+  }, [user, navigate]);\n \n-  if (!isSignedInRef.current) {\n-    navigate(`${apiLocation}/signin`);\n+  if (showLoading || !user) {\n     return <Loader fullScreen={true} />;\n   }\n "
        },
        {
            "sha": "acea425c1e553c67ecb80a9f8fd192b2c1bfe725",
            "filename": "client/src/redux/create-store.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Fcreate-store.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Fcreate-store.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Fcreate-store.ts?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -47,7 +47,6 @@ export const createStore = (preloadedState = {}) => {\n     preloadedState\n   });\n   sagaMiddleware.run(rootSaga);\n-  // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n   epicMiddleware.run(rootEpic);\n \n   if (module.hot) {"
        },
        {
            "sha": "729a4eded56c0c502cf4361aeac831c8a955f2e3",
            "filename": "client/src/redux/hard-go-to-epic.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Fhard-go-to-epic.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Fhard-go-to-epic.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Fhard-go-to-epic.js?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -3,11 +3,12 @@ import { tap, ignoreElements } from 'rxjs/operators';\n \n import { actionTypes } from './action-types';\n \n-export default function hardGoToEpic(action$, _, { location }) {\n+// The third argument contains dependencies, see createEpicMiddleware\n+export default function hardGoToEpic(action$, _, { window }) {\n   return action$.pipe(\n     ofType(actionTypes.hardGoTo),\n     tap(({ payload }) => {\n-      location.href = payload;\n+      window.location.href = payload;\n     }),\n     ignoreElements()\n   );"
        },
        {
            "sha": "428b183ec4097199372dc25c2ec3ab75993f6b2e",
            "filename": "client/src/redux/index.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Findex.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Findex.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Findex.js?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -49,7 +49,8 @@ export const defaultDonationFormState = {\n   }\n };\n \n-const initialState = {\n+// exported for testing purposes.\n+export const initialState = {\n   isRandomCompletionThreshold: false,\n   donatableSectionRecentlyCompleted: null,\n   currentChallengeId: store.get(CURRENT_CHALLENGE_KEY),"
        },
        {
            "sha": "81a0a6d771268e672d38f22a85a77d060f65e64f",
            "filename": "client/src/redux/root-epic.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Froot-epic.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Froot-epic.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Froot-epic.ts?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -3,7 +3,6 @@ import { combineEpics } from 'redux-observable';\n import { epics as challengeEpics } from '../templates/Challenges/redux';\n import { epics as appEpics } from '.';\n \n-// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n const rootEpic = combineEpics(...appEpics, ...challengeEpics);\n \n export default rootEpic;"
        },
        {
            "sha": "f302b1b6f2d2b1c252b14e190a63e7219412e231",
            "filename": "client/src/redux/settings/danger-zone-saga.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Fsettings%2Fdanger-zone-saga.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ac3a31e920f26b2e07572c3c583b06c3ead978b5/client%2Fsrc%2Fredux%2Fsettings%2Fdanger-zone-saga.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Fsettings%2Fdanger-zone-saga.js?ref=ac3a31e920f26b2e07572c3c583b06c3ead978b5",
            "patch": "@@ -1,4 +1,5 @@\n-import { navigate } from 'gatsby';\n+import { withPrefix } from 'gatsby';\n+import { navigate } from '@gatsbyjs/reach-router';\n import { call, put, take, takeEvery } from 'redux-saga/effects';\n \n import { createFlashMessage } from '../../components/Flash/redux';\n@@ -17,9 +18,13 @@ function* deleteAccountSaga() {\n         message: FlashMessages.AccountDeleted\n       })\n     );\n+    // navigate before signing out, since /settings will attempt to sign users\n+    // back in. Using reach-router's navigate because gatsby's resolves after\n+    // the call. This would allow resetUserData to take place while the user is\n+    // still on /settings.\n+    yield call(navigate, withPrefix('/learn'));\n     // remove current user information from application state\n     yield put(resetUserData());\n-    yield call(navigate, '/learn');\n   } catch (e) {\n     yield put(deleteAccountError(e));\n   }"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 61,
        "deletions": 74
    }
}