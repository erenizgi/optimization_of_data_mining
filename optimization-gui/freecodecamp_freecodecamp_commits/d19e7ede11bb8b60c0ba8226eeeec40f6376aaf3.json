{
    "author": "raisedadead",
    "message": "fix(gha): handle connections better (#62104)",
    "sha": "d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3",
    "files": [
        {
            "sha": "580eec21bcaa150f246724cc0766dbb51712517f",
            "filename": ".github/workflows/deploy-api.yml",
            "status": "modified",
            "additions": 59,
            "deletions": 6,
            "changes": 65,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3/.github%2Fworkflows%2Fdeploy-api.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3/.github%2Fworkflows%2Fdeploy-api.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-api.yml?ref=d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3",
            "patch": "@@ -73,19 +73,72 @@ jobs:\n           tags: tag:ci\n           version: latest\n \n+      - name: Wait for Tailscale Network Readiness\n+        run: |\n+          echo \"Waiting for Tailscale network to be ready...\"\n+          max_wait=60\n+          elapsed=0\n+\n+          while [ $elapsed -lt $max_wait ]; do\n+            if tailscale status --json | jq -e '.BackendState == \"Running\"' > /dev/null 2>&1; then\n+              echo \"Tailscale network is ready\"\n+              break\n+            fi\n+            sleep 2\n+            elapsed=$((elapsed + 2))\n+          done\n+\n+          if [ $elapsed -ge $max_wait ]; then\n+            echo \"Tailscale network not ready after ${max_wait}s\"\n+            exit 1\n+          fi\n+\n       - name: Configure SSH & Check Connection\n         run: |\n           mkdir -p ~/.ssh\n           echo \"Host *\n             UserKnownHostsFile=/dev/null\n             StrictHostKeyChecking no\" > ~/.ssh/config\n           chmod 644 ~/.ssh/config\n-          sleep 10\n-          tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Error: Machine not found\"; exit 1; }\n-          sleep 1\n-          MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n-          echo -e \"\\nLOG:Checking connection to $TS_MACHINE_NAME...\"\n-          ssh $TS_USERNAME@$MACHINE_IP \"uptime\"\n+\n+          validate_connection() {\n+            local machine_name=$1\n+            local max_retries=3\n+            local retry_delay=5\n+            \n+            for attempt in $(seq 1 $max_retries); do\n+              echo \"Connection attempt $attempt/$max_retries to $machine_name\"\n+              \n+              if ! tailscale status | grep -q \"$machine_name\"; then\n+                echo \"Machine $machine_name not found in Tailscale network\"\n+                if [ $attempt -eq $max_retries ]; then\n+                  return 1\n+                fi\n+                sleep $retry_delay\n+                continue\n+              fi\n+              \n+              MACHINE_IP=$(tailscale ip -4 $machine_name)\n+              if ssh -o ConnectTimeout=10 -o BatchMode=yes $TS_USERNAME@$MACHINE_IP \"echo 'Connection test'; docker --version\" > /dev/null 2>&1; then\n+                echo \"Successfully validated connection to $machine_name\"\n+                return 0\n+              fi\n+              \n+              echo \"SSH validation failed for $machine_name\"\n+              if [ $attempt -lt $max_retries ]; then\n+                sleep $retry_delay\n+              fi\n+            done\n+            \n+            echo \"Failed to establish connection to $machine_name after $max_retries attempts\"\n+            return 1\n+          }\n+\n+          echo -e \"\\nLOG:Validating connection to $TS_MACHINE_NAME...\"\n+          if ! validate_connection \"$TS_MACHINE_NAME\"; then\n+            echo \"Error: Failed to establish reliable connection to $TS_MACHINE_NAME\"\n+            exit 1\n+          fi\n \n       - name: Deploy with Docker Stack\n         env:"
        },
        {
            "sha": "da09e8571b6ee5bf872c224b874350f58abb15d8",
            "filename": ".github/workflows/deploy-client.yml",
            "status": "modified",
            "additions": 61,
            "deletions": 5,
            "changes": 66,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3/.github%2Fworkflows%2Fdeploy-client.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3/.github%2Fworkflows%2Fdeploy-client.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-client.yml?ref=d19e7ede11bb8b60c0ba8226eeeec40f6376aaf3",
            "patch": "@@ -217,21 +217,77 @@ jobs:\n           tags: tag:ci\n           version: latest\n \n+      - name: Wait for Tailscale Network Readiness\n+        run: |\n+          echo \"Waiting for Tailscale network to be ready...\"\n+          max_wait=60\n+          elapsed=0\n+\n+          while [ $elapsed -lt $max_wait ]; do\n+            if tailscale status --json | jq -e '.BackendState == \"Running\"' > /dev/null 2>&1; then\n+              echo \"Tailscale network is ready\"\n+              break\n+            fi\n+            sleep 2\n+            elapsed=$((elapsed + 2))\n+          done\n+\n+          if [ $elapsed -ge $max_wait ]; then\n+            echo \"Tailscale network not ready after ${max_wait}s\"\n+            exit 1\n+          fi\n+\n       - name: Configure SSH & Check Connection\n         run: |\n           mkdir -p ~/.ssh\n           echo \"Host *\n             UserKnownHostsFile=/dev/null\n             StrictHostKeyChecking no\" > ~/.ssh/config\n           chmod 644 ~/.ssh/config\n-          sleep 10\n+\n+          validate_connection() {\n+            local machine_name=$1\n+            local max_retries=3\n+            local retry_delay=5\n+            \n+            for attempt in $(seq 1 $max_retries); do\n+              echo \"Connection attempt $attempt/$max_retries to $machine_name\"\n+              \n+              if ! tailscale status | grep -q \"$machine_name\"; then\n+                echo \"Machine $machine_name not found in Tailscale network\"\n+                if [ $attempt -eq $max_retries ]; then\n+                  return 1\n+                fi\n+                sleep $retry_delay\n+                continue\n+              fi\n+              \n+              MACHINE_IP=$(tailscale ip -4 $machine_name)\n+              if ssh -o ConnectTimeout=10 -o BatchMode=yes $TS_USERNAME@$MACHINE_IP \"echo 'Connection test'; uptime\" > /dev/null 2>&1; then\n+                echo \"Successfully validated connection to $machine_name\"\n+                return 0\n+              fi\n+              \n+              echo \"SSH validation failed for $machine_name\"\n+              if [ $attempt -lt $max_retries ]; then\n+                sleep $retry_delay\n+              fi\n+            done\n+            \n+            echo \"Failed to establish connection to $machine_name after $max_retries attempts\"\n+            return 1\n+          }\n+\n+          echo -e \"\\nLOG:Validating connections to all machines...\"\n           for i in {0..1}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.lang-name-short }}-${i}\n-            tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Machine not found\"; exit 1; }\n-            sleep 1\n-            MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n-            ssh $TS_USERNAME@$MACHINE_IP \"uptime\"\n+            echo \"Validating connection to $TS_MACHINE_NAME\"\n+            if ! validate_connection \"$TS_MACHINE_NAME\"; then\n+              echo \"Error: Failed to establish reliable connection to $TS_MACHINE_NAME\"\n+              exit 1\n+            fi\n           done\n+          echo \"All machine connections validated successfully\"\n \n       - name: Upload and Deploy\n         run: |"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 120,
        "deletions": 11
    }
}