{
    "author": "Sembauke",
    "message": "feat: convert failed updates test to Playwright (#54761)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "3209fc2024e051dbc89bfbdd1daebc8bc4396457",
    "files": [
        {
            "sha": "a04431ddfd3ff85e696efdbafd61a03a3f66d12c",
            "filename": "cypress/e2e/default/learn/challenges/failed-updates.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 55,
            "changes": 55,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/378d9835967fcb46b7ca06f46d0adc983930083f/cypress%2Fe2e%2Fdefault%2Flearn%2Fchallenges%2Ffailed-updates.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/378d9835967fcb46b7ca06f46d0adc983930083f/cypress%2Fe2e%2Fdefault%2Flearn%2Fchallenges%2Ffailed-updates.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/cypress%2Fe2e%2Fdefault%2Flearn%2Fchallenges%2Ffailed-updates.ts?ref=378d9835967fcb46b7ca06f46d0adc983930083f",
            "patch": "@@ -1,55 +0,0 @@\n-import store from 'store';\n-import { ChallengeData } from '../../../../../tools/challenge-editor/api/interfaces/challenge-data';\n-\n-const failedUpdates = [\n-  {\n-    endpoint: '/modern-challenge-completed',\n-    payload: { id: '5dc1798ff86c76b9248c6eb3', challengeType: 0 },\n-    id: '4bd1d704-cfaa-44f7-92a3-bc0d857dbaa6'\n-  },\n-  {\n-    endpoint: '/modern-challenge-completed',\n-    payload: { id: '5dc17d3bf86c76b9248c6eb4', challengeType: 0 },\n-    id: 'ea289e2f-a5d2-45e0-b795-0f9f4afc5124'\n-  }\n-];\n-const failedUpdatesKey = 'fcc-failed-updates';\n-\n-function getCompletedIds(completedChallenges: ChallengeData[]): string[] {\n-  return completedChallenges.map((challenge: ChallengeData) => challenge.id);\n-}\n-\n-describe('failed update flushing', { browser: 'chrome' }, function () {\n-  before(() => {\n-    cy.task('seed');\n-    cy.login();\n-  });\n-\n-  it('should resubmit failed updates, check they are stored, then flush', () => {\n-    store.set(failedUpdatesKey, failedUpdates);\n-    cy.request('http://localhost:3000/user/get-session-user')\n-      .its('body.user.developmentuser.completedChallenges')\n-      .then(\n-        (completedChallenges: ChallengeData[]) =>\n-          expect(completedChallenges).to.be.empty\n-      );\n-\n-    cy.intercept('http://localhost:3000/modern-challenge-completed').as(\n-      'completed'\n-    );\n-    cy.wrap(store.get(failedUpdatesKey)).should('deep.equal', failedUpdates);\n-    cy.visit('/');\n-    cy.wait('@completed');\n-    // if we don't wait for both requests to complete, we have a race condition\n-    cy.wait('@completed');\n-    cy.request('http://localhost:3000/user/get-session-user')\n-      .its('body.user.developmentuser.completedChallenges')\n-      .then((completedChallenges: ChallengeData[]) => {\n-        const completedIds: string[] = getCompletedIds(completedChallenges);\n-        failedUpdates.forEach(failedUpdate => {\n-          expect(completedIds).to.include(failedUpdate.payload.id);\n-        });\n-        expect(store.get(failedUpdatesKey)).to.be.empty;\n-      });\n-  });\n-});"
        },
        {
            "sha": "15dd87a30d96338f637927e5d8d86811e291d778",
            "filename": "e2e/failed-updates.spec.ts",
            "status": "added",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3209fc2024e051dbc89bfbdd1daebc8bc4396457/e2e%2Ffailed-updates.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3209fc2024e051dbc89bfbdd1daebc8bc4396457/e2e%2Ffailed-updates.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Ffailed-updates.spec.ts?ref=3209fc2024e051dbc89bfbdd1daebc8bc4396457",
            "patch": "@@ -0,0 +1,85 @@\n+import { execSync } from 'child_process';\n+import { test, expect } from '@playwright/test';\n+import { ChallengeData } from '../tools/challenge-editor/api/interfaces/challenge-data';\n+\n+const failedUpdates = [\n+  {\n+    endpoint: '/modern-challenge-completed',\n+    payload: { id: '5dc1798ff86c76b9248c6eb3', challengeType: 0 },\n+    id: '4bd1d704-cfaa-44f7-92a3-bc0d857dbaa6'\n+  },\n+  {\n+    endpoint: '/modern-challenge-completed',\n+    payload: { id: '5dc17d3bf86c76b9248c6eb4', challengeType: 0 },\n+    id: 'ea289e2f-a5d2-45e0-b795-0f9f4afc5124'\n+  }\n+];\n+const storeKey = 'fcc-failed-updates';\n+\n+function getCompletedIds(completedChallenges: ChallengeData[]): string[] {\n+  return completedChallenges.map((challenge: ChallengeData) => challenge.id);\n+}\n+test.use({ storageState: 'playwright/.auth/development-user.json' });\n+\n+test.beforeAll(() => {\n+  execSync('node ./tools/scripts/seed/seed-demo-user');\n+});\n+\n+test.afterAll(() => {\n+  execSync('node ./tools/scripts/seed/seed-demo-user certified-user');\n+});\n+\n+test.describe('failed update flushing', () => {\n+  test('should resubmit failed updates to the api and clear the store', async ({\n+    page,\n+    request\n+  }) => {\n+    // Initially, the user has no completed challenges.\n+    const userRes = await request.get(\n+      'http://localhost:3000/user/get-session-user'\n+    );\n+    const completedChallenges = (await userRes.json()).user.developmentuser\n+      .completedChallenges;\n+    expect(completedChallenges).toEqual([]);\n+\n+    // It's necessary to wait until the page has loaded before setting the\n+    // localStorage. Otherwise, evaluate fails with a permissions error (the\n+    // store doesn't exist yet).\n+    await page.goto('/');\n+    await page.evaluate(\n+      ([failedUpdates, storeKey]) => {\n+        localStorage.setItem(storeKey, JSON.stringify(failedUpdates));\n+      },\n+      [failedUpdates, storeKey] as const\n+    );\n+\n+    // The update epic sends two requests and this lets us wait for both.\n+    const submitRes = page\n+      .waitForResponse('http://localhost:3000/modern-challenge-completed')\n+      .then(() =>\n+        page.waitForResponse('http://localhost:3000/modern-challenge-completed')\n+      );\n+\n+    await page.reload();\n+    await submitRes;\n+\n+    const updatedUserRes = await request.get(\n+      'http://localhost:3000/user/get-session-user'\n+    );\n+\n+    // Now the user should have both completed challenges.\n+    const updatedCompletedChallenges = (await updatedUserRes.json()).user\n+      .developmentuser.completedChallenges;\n+    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n+    const completedIds = getCompletedIds(updatedCompletedChallenges);\n+\n+    for (const { payload } of failedUpdates) {\n+      expect(completedIds).toContain(payload.id);\n+    }\n+    const storedFailedUpdates = await page.evaluate(storeKey => {\n+      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+      return JSON.parse(localStorage.getItem(storeKey) ?? '');\n+    }, storeKey);\n+    expect(storedFailedUpdates).toEqual([]);\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 85,
        "deletions": 55
    }
}