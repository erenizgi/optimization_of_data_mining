{
    "author": "ojeytonwilliams",
    "message": "fix(client): parse learner code with DOMParser (#55763)",
    "sha": "bde209bbbad4f5cc0f15a9688558f076fd070a85",
    "files": [
        {
            "sha": "76a448cff18f76353590f0c939482a19981d45d5",
            "filename": "client/src/templates/Challenges/rechallenge/transformers.js",
            "status": "modified",
            "additions": 9,
            "deletions": 32,
            "changes": 41,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bde209bbbad4f5cc0f15a9688558f076fd070a85/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bde209bbbad4f5cc0f15a9688558f076fd070a85/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js?ref=bde209bbbad4f5cc0f15a9688558f076fd070a85",
            "patch": "@@ -213,13 +213,11 @@ export const embedFilesInHtml = async function (challengeFiles) {\n       script.removeAttribute('src');\n       script.setAttribute('data-src', 'script.js');\n     }\n-    return {\n-      contents: documentElement.innerHTML\n-    };\n+    return documentElement.innerHTML;\n   };\n \n   if (indexHtml) {\n-    const { contents } = await transformWithFrame(\n+    const contents = await parseAndTransform(\n       embedStylesAndScript,\n       indexHtml.contents\n     );\n@@ -243,32 +241,11 @@ function challengeFilesToObject(challengeFiles) {\n   return { indexHtml, indexJsx, stylesCss, scriptJs };\n }\n \n-const transformWithFrame = async function (transform, contents) {\n-  // we use iframe here since file.contents is destined to be be inserted into\n-  // the root of an iframe.\n-  const frame = document.createElement('iframe');\n-  frame.style = 'display: none';\n-  let out = { contents };\n-  try {\n-    // the frame needs to be inserted into the document to create the html\n-    // element\n-    document.body.appendChild(frame);\n-    // replace the root element with user code\n-    frame.contentDocument.documentElement.innerHTML = contents;\n-    // grab the contents now, in case the transformation fails\n-    out = { contents: frame.contentDocument.documentElement.innerHTML };\n-    // it's important to pass around the documentElement and NOT the frame\n-    // itself. It appears that the frame's documentElement can get replaced by a\n-    // blank documentElement without the contents. This seems only to happen on\n-    // Firefox.\n-    out = await transform(\n-      frame.contentDocument.documentElement,\n-      frame.contentDocument\n-    );\n-  } finally {\n-    document.body.removeChild(frame);\n-  }\n-  return out;\n+const parseAndTransform = async function (transform, contents) {\n+  const parser = new DOMParser();\n+  const newDoc = parser.parseFromString(contents, 'text/html');\n+\n+  return await transform(newDoc.documentElement, newDoc);\n };\n \n const transformHtml = async function (file) {\n@@ -277,10 +254,10 @@ const transformHtml = async function (file) {\n       transformSASS(documentElement),\n       transformScript(documentElement)\n     ]);\n-    return { contents: documentElement.innerHTML };\n+    return documentElement.innerHTML;\n   };\n \n-  const { contents } = await transformWithFrame(transform, file.contents);\n+  const contents = await parseAndTransform(transform, file.contents);\n   return transformContents(() => contents, file);\n };\n "
        },
        {
            "sha": "11a0fcef839822fef3012061151cdcff2974df03",
            "filename": "curriculum/test/test-challenges.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bde209bbbad4f5cc0f15a9688558f076fd070a85/curriculum%2Ftest%2Ftest-challenges.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bde209bbbad4f5cc0f15a9688558f076fd070a85/curriculum%2Ftest%2Ftest-challenges.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/curriculum%2Ftest%2Ftest-challenges.js?ref=bde209bbbad4f5cc0f15a9688558f076fd070a85",
            "patch": "@@ -77,6 +77,7 @@ const handleRejection = err => {\n \n const dom = new jsdom.JSDOM('');\n global.document = dom.window.document;\n+global.DOMParser = dom.window.DOMParser;\n \n const oldRunnerFail = Mocha.Runner.prototype.fail;\n Mocha.Runner.prototype.fail = function (test, err) {"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 10,
        "deletions": 32
    }
}