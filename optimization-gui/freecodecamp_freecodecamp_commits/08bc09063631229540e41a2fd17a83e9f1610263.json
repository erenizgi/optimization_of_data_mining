{
    "author": "ShaunSHamilton",
    "message": "feat(api): add prerequisites to env exam (#56731)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "08bc09063631229540e41a2fd17a83e9f1610263",
    "files": [
        {
            "sha": "e27d61445cb1ed0f38f75e43dbdfa4bb156e5189",
            "filename": "api/__mocks__/env-exam.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/api%2F__mocks__%2Fenv-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/api%2F__mocks__%2Fenv-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fenv-exam.ts?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -338,7 +338,8 @@ export const examAttemptSansSubmissionTimeInMS: Static<\n export const exam: EnvExam = {\n   id: examId,\n   config,\n-  questionSets\n+  questionSets,\n+  prerequisites: ['67112fe1c994faa2c26d0b1d']\n };\n \n export async function seedEnvExam() {"
        },
        {
            "sha": "e9022dcd22624ba5b24be4dbe8cf639be6aad225",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -151,11 +151,13 @@ model user {\n /// An exam for the Exam Environment App as designed by the examiners\n model EnvExam {\n   /// Globally unique exam id\n-  id           String           @id @default(auto()) @map(\"_id\") @db.ObjectId\n+  id            String           @id @default(auto()) @map(\"_id\") @db.ObjectId\n   /// All questions for a given exam\n-  questionSets EnvQuestionSet[]\n+  questionSets  EnvQuestionSet[]\n   /// Configuration for exam metadata\n-  config       EnvConfig\n+  config        EnvConfig\n+  /// ObjectIds for required challenges/blocks to take the exam\n+  prerequisites String[]         @db.ObjectId\n \n   // Relations\n   generatedExams EnvGeneratedExam[]"
        },
        {
            "sha": "d235046baf7e22c2faa9dd0e3c573060a9189844",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -240,6 +240,15 @@ describe('/exam-environment/', () => {\n     describe('POST /exam-environment/generated-exam', () => {\n       afterEach(async () => {\n         await fastifyTestInstance.prisma.envExamAttempt.deleteMany();\n+        // Add prerequisite id to user completed challenge\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            completedChallenges: [\n+              { id: mock.exam.prerequisites.at(0)!, completedDate: Date.now() }\n+            ]\n+          }\n+        });\n         await mock.seedEnvExam();\n       });\n \n@@ -262,8 +271,30 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(404);\n       });\n \n-      xit('should return an error if the exam prerequisites are not met', async () => {\n-        // TODO: Waiting on prerequisites\n+      it('should return an error if the exam prerequisites are not met', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            completedChallenges: []\n+          }\n+        });\n+\n+        const body: Static<typeof examEnvironmentPostExamGeneratedExam.body> = {\n+          examId: mock.exam.id\n+        };\n+        const res = await superPost('/exam-environment/exam/generated-exam')\n+          .send(body)\n+          .set(\n+            'exam-environment-authorization-token',\n+            examEnvironmentAuthorizationToken\n+          );\n+\n+        expect(res.body).toStrictEqual({\n+          code: 'FCC_EINVAL_EXAM_ENVIRONMENT_PREREQUISITES',\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          message: expect.any(String)\n+        });\n+        expect(res.status).toBe(403);\n       });\n \n       it('should return an error if the exam has been attempted in the last 24 hours', async () => {"
        },
        {
            "sha": "aa6832b48ab049570bb9dfa431c0932a98a37132",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -170,7 +170,7 @@ async function postExamGeneratedExamHandler(\n \n   // Check user has completed prerequisites\n   const user = req.user!;\n-  const isExamPrerequisitesMet = checkPrerequisites(user, true);\n+  const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n \n   if (!isExamPrerequisitesMet) {\n     void reply.code(403);\n@@ -582,12 +582,13 @@ async function getExams(\n   const exams = await this.prisma.envExam.findMany({\n     select: {\n       id: true,\n-      config: true\n+      config: true,\n+      prerequisites: true\n     }\n   });\n \n   const availableExams = exams.map(exam => {\n-    const isExamPrerequisitesMet = checkPrerequisites(user, true);\n+    const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n \n     return {\n       id: exam.id,"
        },
        {
            "sha": "76b5a63261db14b672be8c3a80ab7691fc760d0c",
            "filename": "api/src/exam-environment/utils/exam.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.test.ts?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -3,6 +3,7 @@ import { exam, examAttempt, generatedExam } from '../../../__mocks__/env-exam';\n import * as schemas from '../schemas';\n import {\n   checkAttemptAgainstGeneratedExam,\n+  checkPrerequisites,\n   constructUserExam,\n   generateExam,\n   userAttemptToDatabaseAttemptQuestionSets,\n@@ -56,9 +57,27 @@ describe('Exam Environment', () => {\n       ).toBe(false);\n     });\n   });\n-  xdescribe('checkPrequisites()', () => {\n-    // TODO: Awaiting implementation\n+\n+  describe('checkPrequisites()', () => {\n+    it(\"should return true if all items in the second argument exist in the first argument's `.completedChallenges[].id`\", () => {\n+      const user = {\n+        completedChallenges: [{ id: '1' }, { id: '2' }]\n+      };\n+      const prerequisites = ['1', '2'];\n+\n+      expect(checkPrerequisites(user, prerequisites)).toBe(true);\n+    });\n+\n+    it(\"should return false if any items in the second argument do not exist in the first argument's `.completedChallenges[].id`\", () => {\n+      const user = {\n+        completedChallenges: [{ id: '2' }]\n+      };\n+      const prerequisites = ['1', '2'];\n+\n+      expect(checkPrerequisites(user, prerequisites)).toBe(false);\n+    });\n   });\n+\n   describe('constructUserExam()', () => {\n     it('should not provide the answers', () => {\n       const userExam = constructUserExam(generatedExam, exam);"
        },
        {
            "sha": "3d207cddb24cf12aa92dce8beb95fd97b4c4e07b",
            "filename": "api/src/exam-environment/utils/exam.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 7,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -7,22 +7,33 @@ import {\n   EnvGeneratedExam,\n   EnvMultipleChoiceQuestion,\n   EnvQuestionSet,\n-  EnvQuestionSetAttempt,\n-  user\n+  EnvQuestionSetAttempt\n } from '@prisma/client';\n import { type Static } from '@fastify/type-provider-typebox';\n import * as schemas from '../schemas';\n \n+interface CompletedChallengeId {\n+  completedChallenges: {\n+    id: string;\n+  }[];\n+}\n+\n /**\n  * Checks if all exam prerequisites have been met by the user.\n- *\n- * TODO: This will be done by getting the challenges required from the curriculum.\n  */\n-export function checkPrerequisites(_user: user, _prerequisites: unknown) {\n-  return true;\n+export function checkPrerequisites(\n+  user: CompletedChallengeId,\n+  prerequisites: EnvExam['prerequisites']\n+) {\n+  return prerequisites.every(p =>\n+    user.completedChallenges.some(c => c.id === p)\n+  );\n }\n \n-export type UserExam = Omit<EnvExam, 'questionSets' | 'config' | 'id'> & {\n+export type UserExam = Omit<\n+  EnvExam,\n+  'questionSets' | 'config' | 'id' | 'prerequisites'\n+> & {\n   config: Omit<EnvExam['config'], 'tags' | 'questionSets'>;\n   questionSets: (Omit<EnvQuestionSet, 'questions'> & {\n     questions: (Omit<"
        },
        {
            "sha": "fffd01666516a1729c226011b6c938d6a92912b6",
            "filename": "curriculum/challenges/english/25-front-end-development/front-end-development-certification-exam/645147516c245de4d11eb7ba.md",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/08bc09063631229540e41a2fd17a83e9f1610263/curriculum%2Fchallenges%2Fenglish%2F25-front-end-development%2Ffront-end-development-certification-exam%2F645147516c245de4d11eb7ba.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/08bc09063631229540e41a2fd17a83e9f1610263/curriculum%2Fchallenges%2Fenglish%2F25-front-end-development%2Ffront-end-development-certification-exam%2F645147516c245de4d11eb7ba.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/curriculum%2Fchallenges%2Fenglish%2F25-front-end-development%2Ffront-end-development-certification-exam%2F645147516c245de4d11eb7ba.md?ref=08bc09063631229540e41a2fd17a83e9f1610263",
            "patch": "@@ -1,15 +1,13 @@\n ---\n id: 645147516c245de4d11eb7ba\n title: Front End Development Certification Exam\n-challengeType: 17\n+challengeType: 24\n dashedName: front-end-development-certification-exam\n ---\n \n # --description--\n \n-Here are some rules:\n-\n-- click start\n+Start your exam in the exam environment app.\n \n # --instructions--\n "
        }
    ],
    "stats": {
        "total": 107,
        "additions": 85,
        "deletions": 22
    }
}