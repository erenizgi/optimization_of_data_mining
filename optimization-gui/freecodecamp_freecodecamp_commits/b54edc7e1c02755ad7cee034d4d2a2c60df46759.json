{
    "author": "ojeytonwilliams",
    "message": "feat(api): send message to Sentry if duplicate accounts (#55171)",
    "sha": "b54edc7e1c02755ad7cee034d4d2a2c60df46759",
    "files": [
        {
            "sha": "a68f6f4d9c14bbb8a01c37582e34ab526aabb13a",
            "filename": "api/src/routes/helpers/auth-helpers.test.ts",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b54edc7e1c02755ad7cee034d4d2a2c60df46759/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b54edc7e1c02755ad7cee034d4d2a2c60df46759/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts?ref=b54edc7e1c02755ad7cee034d4d2a2c60df46759",
            "patch": "@@ -0,0 +1,55 @@\n+import Fastify, { FastifyInstance } from 'fastify';\n+\n+import db from '../../db/prisma';\n+import { createUserInput } from '../../utils/create-user';\n+import { findOrCreateUser } from './auth-helpers';\n+\n+const captureException = jest.fn();\n+\n+async function setupServer() {\n+  const fastify = Fastify();\n+  await fastify.register(db);\n+  // @ts-expect-error we're mocking the Sentry plugin\n+  fastify.Sentry = { captureException };\n+  return fastify;\n+}\n+\n+describe('findOrCreateUser', () => {\n+  let fastify: FastifyInstance;\n+  const email = 'test@user.com';\n+  beforeAll(async () => {\n+    fastify = await setupServer();\n+  });\n+\n+  afterEach(async () => {\n+    await fastify.prisma.user.deleteMany({ where: { email } });\n+    await fastify.close();\n+    jest.clearAllMocks();\n+  });\n+\n+  it('should send a message to Sentry if there are multiple users with the same email', async () => {\n+    await fastify.prisma.user.create({ data: createUserInput(email) });\n+    await fastify.prisma.user.create({ data: createUserInput(email) });\n+\n+    await findOrCreateUser(fastify, email);\n+\n+    expect(captureException).toHaveBeenCalledTimes(1);\n+    expect(captureException).toHaveBeenCalledWith(\n+      new Error('Multiple user records found for: test@user.com')\n+    );\n+  });\n+\n+  it('should NOT send a message if there is only one user with the email', async () => {\n+    await fastify.prisma.user.create({ data: createUserInput(email) });\n+\n+    await findOrCreateUser(fastify, email);\n+\n+    expect(captureException).not.toHaveBeenCalled();\n+  });\n+\n+  it('should NOT send a message if there are no users with the email', async () => {\n+    await findOrCreateUser(fastify, email);\n+\n+    expect(captureException).not.toHaveBeenCalled();\n+  });\n+});"
        },
        {
            "sha": "762c0ece13c88f8b0392d50b2e9a6ba6b1f36108",
            "filename": "api/src/routes/helpers/auth-helpers.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b54edc7e1c02755ad7cee034d4d2a2c60df46759/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b54edc7e1c02755ad7cee034d4d2a2c60df46759/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts?ref=b54edc7e1c02755ad7cee034d4d2a2c60df46759",
            "patch": "@@ -10,15 +10,21 @@ import { createUserInput } from '../../utils/create-user';\n export const findOrCreateUser = async (\n   fastify: FastifyInstance,\n   email: string\n-) => {\n+): Promise<{ id: string }> => {\n   // TODO: handle the case where there are multiple users with the same email.\n   // e.g. use findMany and throw an error if more than one is found.\n-  const existingUser = await fastify.prisma.user.findFirst({\n+  const existingUser = await fastify.prisma.user.findMany({\n     where: { email },\n     select: { id: true }\n   });\n+  if (existingUser.length > 1) {\n+    fastify.Sentry.captureException(\n+      new Error(`Multiple user records found for: ${email}`)\n+    );\n+  }\n+\n   return (\n-    existingUser ??\n+    existingUser[0] ??\n     (await fastify.prisma.user.create({\n       data: createUserInput(email),\n       select: { id: true }"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 64,
        "deletions": 3
    }
}