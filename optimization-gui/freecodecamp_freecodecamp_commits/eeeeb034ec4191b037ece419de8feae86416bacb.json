{
    "author": "raisedadead",
    "message": "fix(api): deduplicating objects in logs (#60319)",
    "sha": "eeeeb034ec4191b037ece419de8feae86416bacb",
    "files": [
        {
            "sha": "8030312ef3b2cd45ffe941bc3fb544df8941524e",
            "filename": "api/src/utils/logger.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 34,
            "changes": 101,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/eeeeb034ec4191b037ece419de8feae86416bacb/api%2Fsrc%2Futils%2Flogger.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/eeeeb034ec4191b037ece419de8feae86416bacb/api%2Fsrc%2Futils%2Flogger.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Flogger.ts?ref=eeeeb034ec4191b037ece419de8feae86416bacb",
            "patch": "@@ -1,40 +1,22 @@\n-import pino, { TransportTargetOptions } from 'pino';\n+import { Transform, TransformCallback, TransformOptions } from 'stream';\n import { FastifyRequest, FastifyReply } from 'fastify';\n import { isEmpty } from 'lodash';\n+import pino, {\n+  TransportTargetOptions,\n+  DestinationStream,\n+  LoggerOptions\n+} from 'pino';\n import { FCC_API_LOG_LEVEL, FCC_API_LOG_TRANSPORT } from './env';\n \n-const transportOptionsPretty: TransportTargetOptions = {\n-  target: 'pino-pretty',\n-  options: {\n-    singleLine: true,\n-    translateTime: 'HH:MM:ss Z',\n-    ignore: 'pid,hostname',\n-    colorize: true\n-  }\n-};\n-\n-const serializersPretty = {\n-  req: (req: FastifyRequest) => {\n-    return {\n-      REQ_METHOD: req.method,\n-      REQ_URL: req.url\n-    };\n-  },\n-  res: (res: FastifyReply) => {\n-    return {\n-      RES_STATUS_CODE: res.statusCode,\n-      RES_ELAPSED_TIME: res.elapsedTime\n-    };\n-  }\n-};\n-\n-const serializersDefault = {\n+const serializers = {\n   req: (req: FastifyRequest) => {\n     const id = req.id || 'ID not found';\n     const method = req.method || 'METHOD not found';\n     const url = req.url || 'URL not found';\n     const xForwardedFor = Array.isArray(req.headers['x-forwarded-for'])\n       ? req.headers['x-forwarded-for'][0]\n+        ? req.headers['x-forwarded-for'][0]\n+        : req.headers['x-forwarded-for']\n       : req.headers['x-forwarded-for'];\n     const ip =\n       req.headers['cf-connecting-ip'] ||\n@@ -64,19 +46,70 @@ const serializersDefault = {\n   }\n };\n \n+const prettyTarget: TransportTargetOptions = {\n+  target: 'pino-pretty',\n+  options: {\n+    singleLine: true,\n+    translateTime: 'HH:MM:ss Z',\n+    ignore: 'pid,hostname',\n+    colorize: true\n+  }\n+};\n+\n+class DeduplicatingTransform extends Transform {\n+  constructor(options?: TransformOptions) {\n+    super({ ...options, objectMode: false });\n+  }\n+\n+  _transform(\n+    chunk: Buffer | string,\n+    encoding: BufferEncoding,\n+    callback: TransformCallback\n+  ): void {\n+    try {\n+      const logString = Buffer.isBuffer(chunk) ? chunk.toString() : chunk;\n+      logString.split('\\n').forEach(line => {\n+        if (line.trim() === '') return;\n+        const logObject = JSON.parse(line);\n+        const processedLog = JSON.parse(JSON.stringify(logObject));\n+        this.push(JSON.stringify(processedLog) + '\\n');\n+      });\n+      callback();\n+    } catch (_err) {\n+      // If parsing or processing fails, pass the original chunk through\n+      // In a production scenario, you might want to log this internal error\n+      // to a different stream or use a fallback mechanism.\n+      this.push(chunk);\n+      callback();\n+    }\n+  }\n+}\n+\n /**\n- * Get a logger instance with the default options.\n+ * Get a logger instance.\n  *\n- * @returns A logger instance with the default options.\n+ * @returns A logger instance.\n  */\n export const getLogger = () => {\n   const isPretty = FCC_API_LOG_TRANSPORT === 'pretty';\n-  const options = {\n+  const options: LoggerOptions = {\n     level: FCC_API_LOG_LEVEL || 'info',\n-    serializers: isPretty ? serializersPretty : serializersDefault\n+    serializers\n   };\n \n-  return isPretty\n-    ? pino({ ...options, transport: transportOptionsPretty })\n-    : pino(options);\n+  if (isPretty) {\n+    const transport = pino.transport({ targets: [prettyTarget] }) as\n+      | DestinationStream\n+      | undefined;\n+    return pino(options, transport);\n+  } else {\n+    // For non-pretty, use the custom de-duplicating transform stream\n+    // This logger will write to a stream that then pipes to our de-duplicator\n+    const deduplicator = new DeduplicatingTransform();\n+    // Pino writes NDJSON, so our transform needs to handle that.\n+    // The pino instance itself doesn't need a complex transport, it writes to the stream.\n+    const logger = pino(options, deduplicator);\n+    deduplicator.pipe(process.stdout);\n+    return logger;\n+  }\n };"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 67,
        "deletions": 34
    }
}