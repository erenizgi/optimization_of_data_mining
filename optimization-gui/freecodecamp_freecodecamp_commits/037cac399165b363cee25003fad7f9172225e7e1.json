{
    "author": "ShaunSHamilton",
    "message": "fix: account for expired attempt without mod record (#63317)",
    "sha": "037cac399165b363cee25003fad7f9172225e7e1",
    "files": [
        {
            "sha": "61b0fd0bc692610730068c0e0ff97115c614e34a",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/037cac399165b363cee25003fad7f9172225e7e1/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/037cac399165b363cee25003fad7f9172225e7e1/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=037cac399165b363cee25003fad7f9172225e7e1",
            "patch": "@@ -24,11 +24,9 @@ import {\n   examEnvironmentPostExamGeneratedExam\n } from '../schemas/index.js';\n import * as mock from '../../../__mocks__/exam-environment-exam.js';\n-import {\n-  constructUserExam,\n-  ExamAttemptStatus\n-} from '../utils/exam-environment.js';\n+import { constructUserExam } from '../utils/exam-environment.js';\n import { JWT_SECRET } from '../../utils/env.js';\n+import { ExamAttemptStatus } from '../schemas/exam-environment-exam-attempt.js';\n \n vi.mock('../../utils/env', async importOriginal => {\n   const actual = await importOriginal<typeof import('../../utils/env.js')>();"
        },
        {
            "sha": "0c4c0eba1052a30b4e48c76731906179513981be",
            "filename": "api/src/exam-environment/schemas/exam-environment-exam-attempt.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/037cac399165b363cee25003fad7f9172225e7e1/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/037cac399165b363cee25003fad7f9172225e7e1/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts?ref=037cac399165b363cee25003fad7f9172225e7e1",
            "patch": "@@ -26,6 +26,19 @@ export const examEnvironmentPostExamAttempt = {\n   }\n };\n \n+export enum ExamAttemptStatus {\n+  // Attempt has not expired yet.\n+  InProgress = 'InProgress',\n+  // Moderation record is not created for practice exam. Also, it might not exist until exam service cron is run.\n+  Expired = 'Expired',\n+  // Attempt has expired && moderation record has been created but not yet moderated\n+  PendingModeration = 'PendingModeration',\n+  // Attempt has been approved\n+  Approved = 'Approved',\n+  // Attempt has been denied\n+  Denied = 'Denied'\n+}\n+\n const examEnvAttempt = Type.Object({\n   id: Type.String(),\n   examId: Type.String(),\n@@ -50,7 +63,7 @@ const examEnvAttempt = Type.Object({\n     })\n   ]),\n   version: Type.Number(),\n-  status: Type.Enum(['InProgress', 'PendingModeration', 'Approved', 'Denied'])\n+  status: Type.Enum(ExamAttemptStatus)\n });\n \n export const examEnvironmentGetExamAttempts = {"
        },
        {
            "sha": "c7c4acfadcdad1046bfa3546e8db5c55d54494e6",
            "filename": "api/src/exam-environment/utils/exam-environment.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 23,
            "changes": 50,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/037cac399165b363cee25003fad7f9172225e7e1/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/037cac399165b363cee25003fad7f9172225e7e1/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts?ref=037cac399165b363cee25003fad7f9172225e7e1",
            "patch": "@@ -19,6 +19,7 @@ import { type Static } from '@fastify/type-provider-typebox';\n import { omit } from 'lodash-es';\n import * as schemas from '../schemas/index.js';\n import { mapErr } from '../../utils/index.js';\n+import { ExamAttemptStatus } from '../schemas/exam-environment-exam-attempt.js';\n import { ERRORS } from './errors.js';\n \n interface CompletedChallengeId {\n@@ -64,21 +65,35 @@ export function constructUserExam(\n   // Map generated exam to user exam (a.k.a. public exam information for user)\n   const userQuestionSets = generatedExam.questionSets.map(gqs => {\n     // Get matching question from `exam`, but remove `is_correct` from `exam.questions[].answers[]`\n-    const examQuestionSet = exam.questionSets.find(eqs => eqs.id === gqs.id)!;\n+    const examQuestionSet = exam.questionSets.find(eqs => eqs.id === gqs.id);\n+    if (!examQuestionSet) {\n+      throw new Error(\n+        `Unreachable. Generated question set id ${gqs.id} not found in exam ${exam.id}.`\n+      );\n+    }\n \n     const { questions } = examQuestionSet;\n \n     const userQuestions = gqs.questions.map(gq => {\n-      const examQuestion = questions.find(eq => eq.id === gq.id)!;\n+      const examQuestion = questions.find(eq => eq.id === gq.id);\n+      if (!examQuestion) {\n+        throw new Error(\n+          `Unreachable. Generated question id ${gq.id} not found in exam question set ${examQuestionSet.id}.`\n+        );\n+      }\n \n       // Remove `isCorrect` from question answers\n       const answers = gq.answers.map(generatedAnswerId => {\n         const examAnswer = examQuestion.answers.find(\n           ea => ea.id === generatedAnswerId\n-        )!;\n+        );\n+        if (!examAnswer) {\n+          throw new Error(\n+            `Unreachable. Generated answer id ${generatedAnswerId} not found in exam question ${examQuestion.id}.`\n+          );\n+        }\n \n-        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n-        const { isCorrect, ...answer } = examAnswer;\n+        const { isCorrect: _, ...answer } = examAnswer;\n         return answer;\n       });\n \n@@ -768,13 +783,6 @@ export function shuffleArray<T>(array: Array<T>) {\n }\n /* eslint-enable jsdoc/require-description-complete-sentence */\n \n-export enum ExamAttemptStatus {\n-  InProgress = 'InProgress',\n-  PendingModeration = 'PendingModeration',\n-  Approved = 'Approved',\n-  Denied = 'Denied'\n-}\n-\n /**\n  * From an exam attempt, construct the attempt with result (if ready).\n  *\n@@ -862,19 +870,15 @@ export async function constructEnvExamAttempt(\n \n   const moderation = maybeMod.data;\n \n+  // Attempt has expired, but moderation record does not exist\n   if (moderation === null) {\n-    const error = {\n-      data: { examAttemptId: attempt.id },\n-      message:\n-        'Unreachable. ExamModeration record should exist for expired attempt'\n-    };\n-    logger.error(error.data, error.message);\n-    fastify.Sentry.captureException(error);\n     return {\n-      error: {\n-        code: 500,\n-        data: ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message)\n-      }\n+      examEnvironmentExamAttempt: {\n+        ...omitAttemptReferenceIds(attempt),\n+        result: null,\n+        status: ExamAttemptStatus.Expired\n+      },\n+      error: null\n     };\n   }\n "
        },
        {
            "sha": "fe6bb3276c725ca554829b6a7074d5688334aa31",
            "filename": "client/src/templates/Challenges/exam-download/attempts.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/037cac399165b363cee25003fad7f9172225e7e1/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fattempts.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/037cac399165b363cee25003fad7f9172225e7e1/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fattempts.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fexam-download%2Fattempts.tsx?ref=037cac399165b363cee25003fad7f9172225e7e1",
            "patch": "@@ -59,6 +59,8 @@ export function Attempts({ examChallengeId }: AttemptsProps) {\n         return t('exam.in-progress');\n       case 'PendingModeration':\n         return t('exam.pending');\n+      case 'Expired':\n+        return t('exam.pending');\n     }\n   }\n \n@@ -72,6 +74,8 @@ export function Attempts({ examChallengeId }: AttemptsProps) {\n         return t('exam.in-progress');\n       case 'PendingModeration':\n         return t('exam.pending');\n+      case 'Expired':\n+        return t('exam.pending');\n     }\n   }\n "
        },
        {
            "sha": "32a1012738199d3a7eb2ce3177c085e82f5450bc",
            "filename": "client/src/utils/ajax.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/037cac399165b363cee25003fad7f9172225e7e1/client%2Fsrc%2Futils%2Fajax.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/037cac399165b363cee25003fad7f9172225e7e1/client%2Fsrc%2Futils%2Fajax.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fajax.ts?ref=037cac399165b363cee25003fad7f9172225e7e1",
            "patch": "@@ -229,7 +229,7 @@ export type Attempt = {\n } & (\n   | {\n       result: null;\n-      status: 'InProgress' | 'PendingModeration' | 'Denied';\n+      status: 'InProgress' | 'Expired' | 'PendingModeration' | 'Denied';\n     }\n   | {\n       status: 'Approved';"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 48,
        "deletions": 29
    }
}