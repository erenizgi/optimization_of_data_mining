{
    "author": "ojeytonwilliams",
    "message": "feat(api): logging protected donation routes (#58934)",
    "sha": "d15820a2cca7a7a28bce416cf5deb921cbc75124",
    "files": [
        {
            "sha": "b1ca1c223d7e74fa98455e9e1b5354c8b9dd1b94",
            "filename": "api/src/routes/protected/donate.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d15820a2cca7a7a28bce416cf5deb921cbc75124/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d15820a2cca7a7a28bce416cf5deb921cbc75124/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fdonate.ts?ref=d15820a2cca7a7a28bce416cf5deb921cbc75124",
            "patch": "@@ -29,11 +29,14 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.updateStripeCard\n     },\n     async req => {\n+      const logger = fastify.log.child({ req });\n       const donation = await fastify.prisma.donation.findFirst({\n         where: { userId: req.user?.id, provider: 'stripe' }\n       });\n-      if (!donation)\n+      if (!donation) {\n+        logger.error(`Stripe donation record not found: ${req.user?.id}`);\n         throw Error(`Stripe donation record not found: ${req.user?.id}`);\n+      }\n       const { customerId, subscriptionId } = donation;\n       const session = await stripe.checkout.sessions.create({\n         payment_method_types: ['card'],\n@@ -48,6 +51,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n         success_url: `${HOME_LOCATION}/update-stripe-card?session_id={CHECKOUT_SESSION_ID}`,\n         cancel_url: `${HOME_LOCATION}/update-stripe-card`\n       });\n+      logger.info(`Stripe session created for user: ${req.user?.id}`);\n       return { sessionId: session.id } as const;\n     }\n   );\n@@ -58,12 +62,14 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.addDonation\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         const user = await fastify.prisma.user.findUnique({\n           where: { id: req.user?.id }\n         });\n \n         if (user?.isDonating) {\n+          logger.info(`User ${req.user?.id} is already donating.`);\n           void reply.code(400);\n           return {\n             type: 'info',\n@@ -78,11 +84,14 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n           }\n         });\n \n+        logger.info(`User ${req.user?.id} is now donating`);\n+\n         return {\n           isDonating: true\n         } as const;\n       } catch (error) {\n-        fastify.log.error(error);\n+        logger.error(`User ${req.user?.id} failed to donate`);\n+        logger.error(error);\n         fastify.Sentry.captureException(error);\n         void reply.code(500);\n         return {\n@@ -99,6 +108,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.chargeStripeCard\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n       try {\n         const { paymentMethodId, amount, duration } = req.body;\n         const id = req.user!.id;\n@@ -111,6 +121,9 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n         const threeChallengesCompleted = user.completedChallenges.length >= 3;\n \n         if (!threeChallengesCompleted) {\n+          logger.warn(\n+            `User ${id} has tried to donate before completing 3 challenges`\n+          );\n           void reply.code(400);\n           return {\n             error: {\n@@ -121,6 +134,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n         }\n \n         if (user.isDonating) {\n+          logger.info(`User ${id} is already donating.`);\n           void reply.code(400);\n           return reply.send({\n             error: {\n@@ -158,6 +172,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n           expand: ['latest_invoice.payment_intent']\n         });\n         if (status === 'requires_source_action') {\n+          logger.info(`User ${id} payment requires user action`);\n           void reply.code(402);\n           return reply.send({\n             error: {\n@@ -168,6 +183,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n             }\n           });\n         } else if (status === 'requires_source') {\n+          logger.info(`User ${id} payment declined`);\n           void reply.code(402);\n           return reply.send({\n             error: {\n@@ -204,12 +220,15 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n           }\n         });\n \n+        logger.info(`User ${id} has successfully donated`);\n+\n         return reply.send({\n           type: 'success',\n           isDonating: true\n         });\n       } catch (error) {\n-        fastify.log.error(error);\n+        logger.error(`User ${req.user?.id} failed to donate`);\n+        logger.error(error);\n         fastify.Sentry.captureException(error);\n         void reply.code(500);\n         return reply.send({"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 22,
        "deletions": 3
    }
}