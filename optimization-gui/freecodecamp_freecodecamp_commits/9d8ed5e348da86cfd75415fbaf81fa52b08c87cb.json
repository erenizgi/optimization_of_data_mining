{
    "author": "gikf",
    "message": "fix(tools): improve video questions validation (#64176)\n\nCo-authored-by: majestic-owl448 <26656284+majestic-owl448@users.noreply.github.com>",
    "sha": "9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
    "files": [
        {
            "sha": "61a11871646238e5d3f1cc463731a182d424eac9",
            "filename": "curriculum/challenges/english/blocks/lecture-working-with-data-fetching-and-memoization-in-react/67d2f4ddb4a4306fdf5bbaee.md",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/curriculum%2Fchallenges%2Fenglish%2Fblocks%2Flecture-working-with-data-fetching-and-memoization-in-react%2F67d2f4ddb4a4306fdf5bbaee.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/curriculum%2Fchallenges%2Fenglish%2Fblocks%2Flecture-working-with-data-fetching-and-memoization-in-react%2F67d2f4ddb4a4306fdf5bbaee.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/curriculum%2Fchallenges%2Fenglish%2Fblocks%2Flecture-working-with-data-fetching-and-memoization-in-react%2F67d2f4ddb4a4306fdf5bbaee.md?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -234,10 +234,6 @@ Memoization tools focus on caching values and functions, while this option handl\n \n `useEffect`\n \n-### --feedback--\n-\n-Memoization tools focus on caching values and functions, while this option handles side effects.\n-\n ## --video-solution--\n \n 4"
        },
        {
            "sha": "e93ad5256b09ac340aac06cd64ce53e7b834df18",
            "filename": "curriculum/schema/challenge-schema.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/curriculum%2Fschema%2Fchallenge-schema.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/curriculum%2Fschema%2Fchallenge-schema.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/curriculum%2Fschema%2Fchallenge-schema.js?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -99,7 +99,7 @@ const questionJoi = Joi.object().keys({\n     )\n     .required()\n     .unique('answer'),\n-  solution: Joi.number().required()\n+  solution: Joi.number().min(1).max(Joi.ref('..answers.length')).required()\n });\n \n const quizJoi = Joi.object().keys({"
        },
        {
            "sha": "2f54f3c8d84e60eb35cb3a7a83cc39c442361b75",
            "filename": "tools/challenge-parser/parser/__fixtures__/with-video-question-correct-answer-with-feedback.md",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-correct-answer-with-feedback.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-correct-answer-with-feedback.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-correct-answer-with-feedback.md?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -0,0 +1,51 @@\n+# --description--\n+\n+Paragraph 1\n+\n+```html\n+code example\n+```\n+\n+# --instructions--\n+\n+Paragraph 0\n+\n+```html\n+code example 0\n+```\n+\n+# --questions--\n+\n+## --text--\n+\n+Question line 1\n+\n+```js\n+  var x = 'y';\n+```\n+\n+## --answers--\n+\n+Some inline `code`\n+\n+### --feedback--\n+\n+That is not correct.\n+\n+---\n+\n+Some *italics*\n+\n+A second answer paragraph.\n+\n+---\n+\n+<code> code in </code> code tags\n+\n+### --feedback--\n+\n+Feedback line\n+\n+## --video-solution--\n+\n+3"
        },
        {
            "sha": "332eb9f648c456836a8e6edaad2c4202e74e4be3",
            "filename": "tools/challenge-parser/parser/__fixtures__/with-video-question-feedback-twice-in-a-row.md",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-feedback-twice-in-a-row.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-feedback-twice-in-a-row.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-feedback-twice-in-a-row.md?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -0,0 +1,51 @@\n+# --description--\n+\n+Paragraph 1\n+\n+```html\n+code example\n+```\n+\n+# --instructions--\n+\n+Paragraph 0\n+\n+```html\n+code example 0\n+```\n+\n+# --questions--\n+\n+## --text--\n+\n+Question line 1\n+\n+```js\n+  var x = 'y';\n+```\n+\n+## --answers--\n+\n+Some inline `code`\n+\n+### --feedback--\n+\n+That is not correct.\n+\n+---\n+\n+Some *italics*\n+\n+### --feedback--\n+\n+A second answer paragraph.\n+\n+Another paragraph.\n+\n+### --feedback--\n+\n+<code> code in </code> code tags\n+\n+## --video-solution--\n+\n+1"
        },
        {
            "sha": "5cabec9239d9252dd527b5d00eb10b736056ed4a",
            "filename": "tools/challenge-parser/parser/__fixtures__/with-video-question-solution-above-number-of-answers.md",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-solution-above-number-of-answers.md",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-solution-above-number-of-answers.md",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2F__fixtures__%2Fwith-video-question-solution-above-number-of-answers.md?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -0,0 +1,47 @@\n+# --description--\n+\n+Paragraph 1\n+\n+```html\n+code example\n+```\n+\n+# --instructions--\n+\n+Paragraph 0\n+\n+```html\n+code example 0\n+```\n+\n+# --questions--\n+\n+## --text--\n+\n+Question line 1\n+\n+```js\n+  var x = 'y';\n+```\n+\n+## --answers--\n+\n+Some inline `code`\n+\n+### --feedback--\n+\n+That is not correct.\n+\n+---\n+\n+Some *italics*\n+\n+A second answer paragraph.\n+\n+---\n+\n+<code> code in </code> code tags\n+\n+## --video-solution--\n+\n+5"
        },
        {
            "sha": "d7822e90b11507698ca56651f190355edf5d3a58",
            "filename": "tools/challenge-parser/parser/plugins/add-video-question.js",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-video-question.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-video-question.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-video-question.js?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -1,6 +1,6 @@\n const { root } = require('mdast-builder');\n const find = require('unist-util-find');\n-const { getSection } = require('./utils/get-section');\n+const { getSection, getAllSections } = require('./utils/get-section');\n const getAllBefore = require('./utils/before-heading');\n const { getParagraphContent } = require('./utils/get-paragraph-content');\n \n@@ -20,18 +20,29 @@ function plugin() {\n       if (!text) throw Error('text is missing from question');\n       if (!answers) throw Error('answers are missing from question');\n       if (!solution) throw Error('solution is missing from question');\n+      if (solution > answers.length)\n+        throw Error(\n+          `solution must be within range of number of answers: 1-${answers.length}`\n+        );\n+      if (answers[solution - 1].feedback)\n+        throw Error('answer selected as solution cannot have feedback section');\n \n       return { text, answers, solution };\n     }\n \n     function getAnswers(answersNodes) {\n       const answerGroups = splitOnThematicBreak(answersNodes);\n \n-      return answerGroups.map(answerGroup => {\n+      return answerGroups.map((answerGroup, index) => {\n         const answerTree = root(answerGroup);\n-        const feedbackNodes = getSection(answerTree, '--feedback--');\n+        const feedbackGroups = getAllSections(answerTree, '--feedback--');\n+\n+        if (feedbackGroups.length > 1)\n+          throw new Error(`answer ${index + 1} has multiple feedback sections`);\n+\n+        const [feedbackNodes] = feedbackGroups;\n         const audioIdNodes = getSection(answerTree, '--audio-id--');\n-        const hasFeedback = feedbackNodes.length > 0;\n+        const hasFeedback = feedbackNodes?.length > 0;\n         const hasAudioId = audioIdNodes.length > 0;\n \n         if (hasFeedback || hasAudioId) {"
        },
        {
            "sha": "9a2ac59800174d23dcfa28cc4d0b1f6d2235cf3c",
            "filename": "tools/challenge-parser/parser/plugins/add-video-question.test.js",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-video-question.test.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9d8ed5e348da86cfd75415fbaf81fa52b08c87cb/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-video-question.test.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fadd-video-question.test.js?ref=9d8ed5e348da86cfd75415fbaf81fa52b08c87cb",
            "patch": "@@ -8,6 +8,9 @@ describe('add-video-question plugin', () => {\n     multipleQuestionAST,\n     videoOutOfOrderAST,\n     videoWithAudioAST,\n+    videoWithSolutionAboveNumberOfAnswersAST,\n+    videoWithFeedbackTwiceInARow,\n+    videoWithCorrectAnswerWithFeedback,\n     chineseVideoAST;\n   const plugin = addVideoQuestion();\n   let file = { data: {} };\n@@ -22,6 +25,15 @@ describe('add-video-question plugin', () => {\n       'with-video-question-out-of-order.md'\n     );\n     videoWithAudioAST = await parseFixture('with-video-question-audio.md');\n+    videoWithSolutionAboveNumberOfAnswersAST = await parseFixture(\n+      'with-video-question-solution-above-number-of-answers.md'\n+    );\n+    videoWithFeedbackTwiceInARow = await parseFixture(\n+      'with-video-question-feedback-twice-in-a-row.md'\n+    );\n+    videoWithCorrectAnswerWithFeedback = await parseFixture(\n+      'with-video-question-correct-answer-with-feedback.md'\n+    );\n     chineseVideoAST = await parseFixture('with-chinese-mcq.md');\n   });\n \n@@ -109,6 +121,27 @@ describe('add-video-question plugin', () => {\n     );\n   });\n \n+  it('should throw if solution is higher than the number of answers', () => {\n+    expect.assertions(1);\n+    expect(() =>\n+      plugin(videoWithSolutionAboveNumberOfAnswersAST, file)\n+    ).toThrow('solution must be within range of number of answers: 1-3');\n+  });\n+\n+  it('should throw if answer has more than one feedback section', () => {\n+    expect.assertions(1);\n+    expect(() => plugin(videoWithFeedbackTwiceInARow, file)).toThrow(\n+      'answer 2 has multiple feedback sections'\n+    );\n+  });\n+\n+  it('should throw if correct answer has feedback section', () => {\n+    expect.assertions(1);\n+    expect(() => plugin(videoWithCorrectAnswerWithFeedback, file)).toThrow(\n+      'answer selected as solution cannot have feedback section'\n+    );\n+  });\n+\n   it('should NOT throw if there is no question', () => {\n     expect.assertions(1);\n     expect(() => plugin(simpleAST, file)).not.toThrow();"
        }
    ],
    "stats": {
        "total": 207,
        "additions": 198,
        "deletions": 9
    }
}