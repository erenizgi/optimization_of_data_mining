{
    "author": "ShaunSHamilton",
    "message": "fix(api): catch invalid ms-username url (#60402)\n\nCo-authored-by: Tom <20648924+moT01@users.noreply.github.com>",
    "sha": "8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6",
    "files": [
        {
            "sha": "be9c5d317664043fa797087d06669b7bb3b96a77",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 20,
            "changes": 63,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6",
            "patch": "@@ -973,21 +973,15 @@ Thanks and regards,\n         });\n \n         it('handles invalid transcript urls', async () => {\n-          mockedFetch.mockImplementationOnce(() =>\n-            Promise.resolve({\n-              ok: false\n-            })\n-          );\n-\n           const response = await superPost('/user/ms-username').send({\n             msTranscriptUrl: 'https://www.example.com'\n           });\n \n           expect(response.body).toStrictEqual({\n             type: 'error',\n-            message: 'flash.ms.transcript.link-err-2'\n+            message: 'flash.ms.transcript.link-err-1'\n           });\n-          expect(response.statusCode).toBe(404);\n+          expect(response.statusCode).toBe(400);\n         });\n \n         it('handles the case that MS does not return a username', async () => {\n@@ -999,7 +993,8 @@ Thanks and regards,\n           );\n \n           const response = await superPost('/user/ms-username').send({\n-            msTranscriptUrl: 'https://www.example.com'\n+            msTranscriptUrl:\n+              'https://learn.microsoft.com/en-us/users/not/transcript/8u6ert43q1p'\n           });\n \n           expect(response.body).toStrictEqual({\n@@ -1029,7 +1024,8 @@ Thanks and regards,\n           });\n \n           const response = await superPost('/user/ms-username').send({\n-            msTranscriptUrl: 'https://www.example.com'\n+            msTranscriptUrl:\n+              'https://learn.microsoft.com/en-us/users/mot01/transcript/8wert4'\n           });\n \n           expect(response.body).toStrictEqual({\n@@ -1052,7 +1048,8 @@ Thanks and regards,\n             })\n           );\n           const response = await superPost('/user/ms-username').send({\n-            msTranscriptUrl: 'https://www.example.com'\n+            msTranscriptUrl:\n+              'https://learn.microsoft.com/en-us/users/mot01/transcript/8ert43q'\n           });\n \n           expect(response.body).toStrictEqual({\n@@ -1074,7 +1071,8 @@ Thanks and regards,\n           );\n \n           await superPost('/user/ms-username').send({\n-            msTranscriptUrl: 'https://www.example.com'\n+            msTranscriptUrl:\n+              'https://learn.microsoft.com/en-us/users/mot01/transcript/12345'\n           });\n \n           const linkedAccount =\n@@ -1122,10 +1120,12 @@ Thanks and regards,\n           });\n \n           await superPost('/user/ms-username').send({\n-            msTranscriptUrl: 'https://www.example.com'\n+            msTranscriptUrl:\n+              'https://learn.microsoft.com/en-us/users/mot01/transcript/8u6awert43q1plo'\n           });\n           await superPost('/user/ms-username').send({\n-            msTranscriptUrl: 'https://www.example.com'\n+            msTranscriptUrl:\n+              'https://learn.microsoft.com/en-us/users/mot01/transcript/8u6awert43q1plo'\n           });\n \n           const linkedAccounts =\n@@ -1311,18 +1311,41 @@ describe('Microsoft helpers', () => {\n     const urlWithQueryParamsAndSlash = `${urlWithSlash}?foo=bar`;\n \n     it('should extract the transcript id from the url', () => {\n-      expect(getMsTranscriptApiUrl(urlWithoutSlash)).toBe(expectedUrl);\n+      expect(getMsTranscriptApiUrl(urlWithoutSlash)).toEqual({\n+        error: null,\n+        data: expectedUrl\n+      });\n     });\n \n     it('should handle trailing slashes', () => {\n-      expect(getMsTranscriptApiUrl(urlWithSlash)).toBe(expectedUrl);\n+      expect(getMsTranscriptApiUrl(urlWithSlash)).toEqual({\n+        error: null,\n+        data: expectedUrl\n+      });\n     });\n \n     it('should ignore query params', () => {\n-      expect(getMsTranscriptApiUrl(urlWithQueryParams)).toBe(expectedUrl);\n-      expect(getMsTranscriptApiUrl(urlWithQueryParamsAndSlash)).toBe(\n-        expectedUrl\n-      );\n+      expect(getMsTranscriptApiUrl(urlWithQueryParams)).toEqual({\n+        error: null,\n+        data: expectedUrl\n+      });\n+      expect(getMsTranscriptApiUrl(urlWithQueryParamsAndSlash)).toEqual({\n+        error: null,\n+        data: expectedUrl\n+      });\n+    });\n+\n+    it('should return an error for invalid URLs', () => {\n+      const validBadUrl = 'https://www.example.com/invalid-url';\n+      expect(getMsTranscriptApiUrl(validBadUrl)).toEqual({\n+        error: expect.any(String),\n+        data: null\n+      });\n+      const invalidUrl = ' ';\n+      expect(getMsTranscriptApiUrl(invalidUrl)).toEqual({\n+        error: expect.any(String),\n+        data: null\n+      });\n     });\n   });\n });"
        },
        {
            "sha": "385e7807a6fbfbd865bafd0c757f5ca78e44ac5c",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 14,
            "changes": 53,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6",
            "patch": "@@ -29,21 +29,30 @@ import { JWT_SECRET } from '../../utils/env';\n \n /**\n  * Helper function to get the api url from the shared transcript link.\n+ * Example msTranscriptUrl: https://learn.microsoft.com/en-us/users/mot01/transcript/8u6awert43q1plo.\n  *\n  * @param msTranscript Shared transcript link.\n  * @returns Microsoft transcript api url.\n  */\n-export const getMsTranscriptApiUrl = (msTranscript: string) => {\n-  // example msTranscriptUrl: https://learn.microsoft.com/en-us/users/mot01/transcript/8u6awert43q1plo\n-  const url = new URL(msTranscript);\n-\n-  // TODO(Post-MVP): throw if it doesn't match?\n-  const transcriptUrlRegex = /\\/transcript\\/([^/]+)\\/?/;\n-  const id = transcriptUrlRegex.exec(url.pathname)?.[1];\n-  return `https://learn.microsoft.com/api/profiles/transcript/share/${\n-    id ?? ''\n-  }`;\n-};\n+export function getMsTranscriptApiUrl(msTranscript: string) {\n+  try {\n+    const url = new URL(msTranscript);\n+    const transcriptUrlRegex = /\\/transcript\\/([^/]+)\\/?/;\n+    const id = transcriptUrlRegex.exec(url.pathname)?.[1];\n+    if (!id) {\n+      return { error: `Invalid transcript URL: ${msTranscript}`, data: null };\n+    }\n+    return {\n+      error: null,\n+      data: `https://learn.microsoft.com/api/profiles/transcript/share/${id}`\n+    };\n+  } catch (e) {\n+    return {\n+      error: `Invalid transcript URL: ${msTranscript}\\n${JSON.stringify(e)}`,\n+      data: null\n+    };\n+  }\n+}\n \n /**\n  * Wrapper for endpoints related to user account management,\n@@ -272,17 +281,33 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n     },\n     async (req, reply) => {\n       const logger = fastify.log.child({ req, res: reply });\n-      logger.info(`User ${req.user?.id} requested linking of msUsername`);\n+      logger.info(\n+        `User ${req.user?.id} requested linking of msUsername \"${req.body.msTranscriptUrl}\"`\n+      );\n \n       try {\n         const user = await fastify.prisma.user.findUniqueOrThrow({\n           where: { id: req.user?.id }\n         });\n \n-        const msApiRes = await fetch(\n-          getMsTranscriptApiUrl(req.body.msTranscriptUrl)\n+        const maybeTranscriptUrl = getMsTranscriptApiUrl(\n+          req.body.msTranscriptUrl\n         );\n \n+        if (maybeTranscriptUrl.error !== null) {\n+          logger.warn(\n+            { error: maybeTranscriptUrl.error },\n+            'Unable to parse Microsoft transcript URL'\n+          );\n+          return reply\n+            .status(400)\n+            .send({ type: 'error', message: 'flash.ms.transcript.link-err-1' });\n+        }\n+\n+        const transcriptUrl = maybeTranscriptUrl.data;\n+\n+        const msApiRes = await fetch(transcriptUrl);\n+\n         if (!msApiRes.ok) {\n           logger.warn(\n             { status: msApiRes.status },"
        },
        {
            "sha": "6487d358dbf77fb30df9f9fd4e48e16ba5ca7205",
            "filename": "api/src/routes/public/user.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts?ref=8558d0b1f1e8425b14b7c9247cecf9ae85ef60e6",
            "patch": "@@ -8,7 +8,6 @@ import {\n   setupServer,\n   createSuperRequest\n } from '../../../jest.utils';\n-import { getMsTranscriptApiUrl } from '../protected/user';\n import { replacePrivateData } from './user';\n \n const mockedFetch = jest.fn();\n@@ -444,34 +443,6 @@ describe('userRoutes', () => {\n   });\n });\n \n-describe('Microsoft helpers', () => {\n-  describe('getMsTranscriptApiUrl', () => {\n-    const expectedUrl =\n-      'https://learn.microsoft.com/api/profiles/transcript/share/8u6awert43q1plo';\n-\n-    const urlWithoutSlash =\n-      'https://learn.microsoft.com/en-us/users/mot01/transcript/8u6awert43q1plo';\n-    const urlWithSlash = `${urlWithoutSlash}/`;\n-    const urlWithQueryParams = `${urlWithoutSlash}?foo=bar`;\n-    const urlWithQueryParamsAndSlash = `${urlWithSlash}?foo=bar`;\n-\n-    it('should extract the transcript id from the url', () => {\n-      expect(getMsTranscriptApiUrl(urlWithoutSlash)).toBe(expectedUrl);\n-    });\n-\n-    it('should handle trailing slashes', () => {\n-      expect(getMsTranscriptApiUrl(urlWithSlash)).toBe(expectedUrl);\n-    });\n-\n-    it('should ignore query params', () => {\n-      expect(getMsTranscriptApiUrl(urlWithQueryParams)).toBe(expectedUrl);\n-      expect(getMsTranscriptApiUrl(urlWithQueryParamsAndSlash)).toBe(\n-        expectedUrl\n-      );\n-    });\n-  });\n-});\n-\n describe('get-public-profile helpers', () => {\n   describe('replacePrivateData', () => {\n     const user = {"
        }
    ],
    "stats": {
        "total": 145,
        "additions": 82,
        "deletions": 63
    }
}