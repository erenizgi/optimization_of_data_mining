{
    "author": "ojeytonwilliams",
    "message": "refactor(client): render lower jaw via React portal (#55785)",
    "sha": "fec2315447f3437ccb5289e74639e071aef2531e",
    "files": [
        {
            "sha": "9984f6b5c8e15bec58449ba679267f245c05d5ce",
            "filename": "client/src/templates/Challenges/classic/editor.tsx",
            "status": "modified",
            "additions": 41,
            "deletions": 61,
            "changes": 102,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/fec2315447f3437ccb5289e74639e071aef2531e/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/fec2315447f3437ccb5289e74639e071aef2531e/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx?ref=fec2315447f3437ccb5289e74639e071aef2531e",
            "patch": "@@ -10,8 +10,8 @@ import type {\n import { OS } from 'monaco-editor/esm/vs/base/common/platform.js';\n import Prism from 'prismjs';\n import React, { useEffect, Suspense, MutableRefObject, useRef } from 'react';\n-import ReactDOM from 'react-dom';\n-import { Provider, connect, useStore } from 'react-redux';\n+import { createPortal } from 'react-dom';\n+import { connect } from 'react-redux';\n import { createSelector } from 'reselect';\n import store from 'store';\n \n@@ -127,7 +127,6 @@ interface EditorProperties {\n   outputZoneTop: number;\n   outputZoneId: string;\n   descriptionNode?: HTMLDivElement;\n-  outputNode?: HTMLDivElement;\n   descriptionWidget?: editor.IContentWidget;\n   outputWidget?: editor.IOverlayWidget;\n }\n@@ -243,7 +242,6 @@ const initialData: EditorProperties = {\n };\n \n const Editor = (props: EditorProps): JSX.Element => {\n-  const reduxStore = useStore();\n   const { t } = useTranslation();\n   const { editorRef, initTests, resetAttempts, isMobileLayout } = props;\n   // These refs are used during initialisation of the editor as well as by\n@@ -255,6 +253,8 @@ const Editor = (props: EditorProps): JSX.Element => {\n   const monacoRef: MutableRefObject<typeof monacoEditor | null> =\n     useRef<typeof monacoEditor>(null);\n   const dataRef = useRef<EditorProperties>({ ...initialData });\n+  const [lowerJawContainer, setLowerJawContainer] =\n+    React.useState<HTMLDivElement | null>(null);\n \n   const submitChallengeDebounceRef = useRef(\n     debounce(props.submitChallenge, 1000, { leading: true, trailing: false })\n@@ -713,56 +713,23 @@ const Editor = (props: EditorProps): JSX.Element => {\n \n   const tryToSubmitChallenge = submitChallengeDebounceRef.current;\n \n-  function createLowerJaw(\n-    outputNode: HTMLDivElement,\n-    editor: editor.IStandaloneCodeEditor\n-  ) {\n-    const { output } = props;\n-    const isChallengeComplete = challengeIsComplete();\n-\n-    ReactDOM.render(\n-      <Provider store={reduxStore}>\n-        <LowerJaw\n-          openHelpModal={props.openHelpModal}\n-          openResetModal={props.openResetModal}\n-          tryToExecuteChallenge={tryToExecuteChallenge}\n-          hint={output[1]}\n-          testsLength={props.tests.length}\n-          attempts={attemptsRef.current}\n-          challengeIsCompleted={isChallengeComplete}\n-          tryToSubmitChallenge={tryToSubmitChallenge}\n-          isSignedIn={props.isSignedIn}\n-          updateContainer={() => updateOutputViewZone(outputNode, editor)}\n-        />\n-      </Provider>,\n-      outputNode\n-    );\n-  }\n-\n-  const updateOutputZone = () => {\n-    const editor = dataRef.current.editor;\n-    if (!editor || !dataRef.current.outputNode) return;\n-\n-    const outputNode = dataRef.current.outputNode;\n-    createLowerJaw(outputNode, editor);\n-  };\n-\n   // TODO: there's a potential performance gain to be had by only updating when\n   // the outputViewZone has actually changed.\n   const updateOutputViewZone = (\n-    outputNode: HTMLDivElement,\n-    editor: editor.IStandaloneCodeEditor\n+    lowerJawContainer: HTMLDivElement,\n+    editor?: editor.IStandaloneCodeEditor\n   ) => {\n+    if (!editor) return;\n     // make sure the overlayWidget has resized before using it to set the height\n-    outputNode.style.width = `${getEditorContentWidth(editor)}px`;\n+    lowerJawContainer.style.width = `${getEditorContentWidth(editor)}px`;\n     // We have to wait for the viewZone to finish rendering before adjusting the\n     // position of the overlayWidget (i.e. trigger it via onComputedHeight). If\n     // not the editor may report the wrong value for position of the lines.\n-    editor?.changeViewZones(changeAccessor => {\n+    editor.changeViewZones(changeAccessor => {\n       changeAccessor.removeZone(dataRef.current.outputZoneId);\n       const viewZone = {\n         afterLineNumber: getLastLineOfEditableRegion(),\n-        heightInPx: outputNode.offsetHeight,\n+        heightInPx: lowerJawContainer.offsetHeight,\n         domNode: document.createElement('div'),\n         onComputedHeight: () =>\n           dataRef.current.outputWidget &&\n@@ -829,16 +796,16 @@ const Editor = (props: EditorProps): JSX.Element => {\n     return editor.getLayoutInfo().contentWidth - getScrollbarWidth();\n   }\n \n-  function createOutputNode(editor: editor.IStandaloneCodeEditor) {\n-    if (dataRef.current.outputNode) return dataRef.current.outputNode;\n-    const outputNode = document.createElement('div');\n-    outputNode.classList.add('editor-lower-jaw');\n-    outputNode.setAttribute('id', 'editor-lower-jaw');\n-    outputNode.style.left = `${editor.getLayoutInfo().contentLeft}px`;\n-    outputNode.style.width = `${getEditorContentWidth(editor)}px`;\n-    outputNode.style.top = getOutputZoneTop();\n-    dataRef.current.outputNode = outputNode;\n-    return outputNode;\n+  function createLowerJawContainer(editor: editor.IStandaloneCodeEditor) {\n+    if (lowerJawContainer) return lowerJawContainer;\n+    const container = document.createElement('div');\n+    container.classList.add('editor-lower-jaw');\n+    container.setAttribute('id', 'editor-lower-jaw');\n+    container.style.left = `${editor.getLayoutInfo().contentLeft}px`;\n+    container.style.width = `${getEditorContentWidth(editor)}px`;\n+    container.style.top = getOutputZoneTop();\n+    setLowerJawContainer(container);\n+    return container;\n   }\n \n   function createScrollGutterNode(\n@@ -1099,7 +1066,7 @@ const Editor = (props: EditorProps): JSX.Element => {\n   function addWidgetsToRegions(editor: editor.IStandaloneCodeEditor) {\n     const descriptionNode = createDescription(editor);\n \n-    const outputNode = createOutputNode(editor);\n+    const lowerJawNode = createLowerJawContainer(editor);\n \n     if (!dataRef.current.descriptionWidget) {\n       dataRef.current.descriptionWidget = createWidget(\n@@ -1125,11 +1092,10 @@ const Editor = (props: EditorProps): JSX.Element => {\n       dataRef.current.outputWidget = createWidget(\n         editor,\n         'output.widget',\n-        outputNode,\n+        lowerJawNode,\n         getOutputZoneTop\n       );\n       editor.addOverlayWidget(dataRef.current.outputWidget);\n-      editor.changeViewZones(updateOutputZone);\n     }\n \n     editor.onDidScrollChange(() => {\n@@ -1157,7 +1123,6 @@ const Editor = (props: EditorProps): JSX.Element => {\n       // ask monaco to update regardless.\n       redecorateEditableRegion();\n       updateDescriptionZone();\n-      updateOutputZone();\n     });\n   }\n \n@@ -1263,7 +1228,6 @@ const Editor = (props: EditorProps): JSX.Element => {\n \n   useEffect(() => {\n     const { model, insideEditDecId } = dataRef.current;\n-    const lowerJawElement = dataRef.current.outputNode;\n     const isChallengeComplete = challengeIsComplete();\n     const range = model?.getDecorationRange(insideEditDecId);\n     if (range && isChallengeComplete) {\n@@ -1275,8 +1239,6 @@ const Editor = (props: EditorProps): JSX.Element => {\n         }\n       );\n     }\n-    dataRef.current.outputNode = lowerJawElement;\n-    updateOutputZone();\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [props.tests]);\n \n@@ -1290,7 +1252,6 @@ const Editor = (props: EditorProps): JSX.Element => {\n     }\n     if (hasEditableRegion()) {\n       updateDescriptionZone();\n-      updateOutputZone();\n     }\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [props.dimensions]);\n@@ -1315,6 +1276,7 @@ const Editor = (props: EditorProps): JSX.Element => {\n       : theme === Themes.Default\n         ? 'vs-custom'\n         : editorSystemTheme;\n+\n   return (\n     <Suspense fallback={<Loader loaderDelay={600} />}>\n       <span className='notranslate'>\n@@ -1326,6 +1288,24 @@ const Editor = (props: EditorProps): JSX.Element => {\n           theme={editorTheme}\n         />\n       </span>\n+      {lowerJawContainer !== null &&\n+        createPortal(\n+          <LowerJaw\n+            openHelpModal={props.openHelpModal}\n+            openResetModal={props.openResetModal}\n+            tryToExecuteChallenge={tryToExecuteChallenge}\n+            hint={props.output[1]}\n+            testsLength={props.tests.length}\n+            attempts={attemptsRef.current}\n+            challengeIsCompleted={challengeIsComplete()}\n+            tryToSubmitChallenge={tryToSubmitChallenge}\n+            isSignedIn={props.isSignedIn}\n+            updateContainer={() =>\n+              updateOutputViewZone(lowerJawContainer, dataRef.current.editor)\n+            }\n+          />,\n+          lowerJawContainer\n+        )}\n     </Suspense>\n   );\n };"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 41,
        "deletions": 61
    }
}