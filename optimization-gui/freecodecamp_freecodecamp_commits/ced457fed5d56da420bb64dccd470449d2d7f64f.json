{
    "author": "ojeytonwilliams",
    "message": "refactor: move CSRF code into plugin (#56447)",
    "sha": "ced457fed5d56da420bb64dccd470449d2d7f64f",
    "files": [
        {
            "sha": "2afbaba011556bdc5299a2931dde4064200284d4",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -3,6 +3,7 @@ import request from 'supertest';\n import { build } from './src/app';\n import { createUserInput } from './src/utils/create-user';\n import { examJson } from './__mocks__/exam';\n+import { CSRF_COOKIE, CSRF_HEADER } from './src/plugins/csrf';\n \n type FastifyTestInstance = Awaited<ReturnType<typeof build>>;\n \n@@ -25,7 +26,7 @@ const requests = {\n };\n \n export const getCsrfToken = (setCookies: string[]): string | undefined => {\n-  const csrfSetCookie = setCookies.find(str => str.includes('csrf_token'));\n+  const csrfSetCookie = setCookies.find(str => str.includes(CSRF_COOKIE));\n   const [csrfCookie] = csrfSetCookie?.split(';') ?? [];\n   const [_key, csrfToken] = csrfCookie?.split('=') ?? [];\n \n@@ -72,7 +73,7 @@ export function superRequest(\n \n   const csrfToken = (setCookies && getCsrfToken(setCookies)) ?? '';\n   if (sendCSRFToken) {\n-    void req.set('CSRF-Token', csrfToken);\n+    void req.set(CSRF_HEADER, csrfToken);\n   }\n   return req;\n }"
        },
        {
            "sha": "0177fbf8814a241d44a14c8a10b326e7bf407946",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 30,
            "changes": 34,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -1,5 +1,4 @@\n import fastifyAccepts from '@fastify/accepts';\n-import fastifyCsrfProtection from '@fastify/csrf-protection';\n import fastifySwagger from '@fastify/swagger';\n import fastifySwaggerUI from '@fastify/swagger-ui';\n import type { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';\n@@ -26,6 +25,7 @@ import security from './plugins/security';\n import auth from './plugins/auth';\n import bouncer from './plugins/bouncer';\n import errorHandling from './plugins/error-handling';\n+import csrf, { CSRF_COOKIE, CSRF_HEADER } from './plugins/csrf';\n import notFound from './plugins/not-found';\n import * as publicRoutes from './routes/public';\n import * as protectedRoutes from './routes/protected';\n@@ -88,33 +88,7 @@ export const build = async (\n \n   await fastify.register(cors);\n   await fastify.register(cookies);\n-\n-  void fastify.register(fastifyCsrfProtection, {\n-    // TODO: consider signing cookies. We don't on the api-server, but we could\n-    // as an extra layer of security.\n-\n-    ///Ignore all other possible sources of CSRF\n-    // tokens since we know we can provide this one\n-    getToken: req => req.headers['csrf-token'] as string,\n-    cookieOpts: { signed: false, sameSite: 'strict' }\n-  });\n-\n-  // All routes except signout should add a CSRF token to the response\n-  fastify.addHook('onRequest', (_req, reply, done) => {\n-    const isSignout = _req.url === '/signout' || _req.url === '/signout/';\n-\n-    if (!isSignout) {\n-      const token = reply.generateCsrf();\n-      void reply.setCookie('csrf_token', token, {\n-        sameSite: 'strict',\n-        signed: false,\n-        // it needs to be read by the client, so that it can be sent in the\n-        // header of the next request:\n-        httpOnly: false\n-      });\n-    }\n-    done();\n-  });\n+  await fastify.register(csrf);\n \n   const provider =\n     EMAIL_PROVIDER === 'ses' ? new SESProvider() : new NodemailerProvider();\n@@ -136,11 +110,11 @@ export const build = async (\n         requestInterceptor: req => {\n           const csrfTokenCookie = document.cookie\n             .split(';')\n-            .find(str => str.includes('csrf_token'));\n+            .find(str => str.includes(CSRF_COOKIE));\n           const [_key, csrfToken] = csrfTokenCookie?.split('=') ?? [];\n \n           // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n-          if (csrfToken) req.headers['csrf-token'] = csrfToken.trim();\n+          if (csrfToken) req.headers[CSRF_HEADER] = csrfToken.trim();\n           return req;\n         }\n       }"
        },
        {
            "sha": "337b48d3a85b74c1f82f6f9a6e6c4575f7b36231",
            "filename": "api/src/plugins/cookies.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookies.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -7,6 +7,7 @@ import {\n   COOKIE_SECRET,\n   FREECODECAMP_NODE_ENV\n } from '../utils/env';\n+import { CSRF_COOKIE, CSRF_SECRET_COOKIE } from './csrf';\n \n export { type CookieSerializeOptions } from '@fastify/cookie';\n \n@@ -68,8 +69,8 @@ const cookies: FastifyPluginCallback = (fastify, _options, done) => {\n \n   void fastify.decorateReply('clearOurCookies', function () {\n     void this.clearCookie('jwt_access_token');\n-    void this.clearCookie('_csrf');\n-    void this.clearCookie('csrf_token');\n+    void this.clearCookie(CSRF_SECRET_COOKIE);\n+    void this.clearCookie(CSRF_COOKIE);\n   });\n \n   done();"
        },
        {
            "sha": "675beba0469f26dfbc829dcb24fbf49fb4255b49",
            "filename": "api/src/plugins/csrf.test.ts",
            "status": "added",
            "additions": 107,
            "deletions": 0,
            "changes": 107,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fplugins%2Fcsrf.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fplugins%2Fcsrf.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcsrf.test.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -0,0 +1,107 @@\n+import Fastify, { type FastifyInstance } from 'fastify';\n+\n+import { COOKIE_DOMAIN } from '../utils/env';\n+import cookies from './cookies';\n+import csrf, { CSRF_COOKIE, CSRF_SECRET_COOKIE } from './csrf';\n+\n+// eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+jest.mock('../utils/env', () => ({\n+  ...jest.requireActual('../utils/env'),\n+  COOKIE_DOMAIN: 'www.example.com',\n+  FREECODECAMP_NODE_ENV: 'production'\n+}));\n+\n+async function setupServer() {\n+  const fastify = Fastify();\n+  await fastify.register(cookies);\n+  await fastify.register(csrf);\n+  // @ts-expect-error - @fastify/csrf-protection needs to update their types\n+  // eslint-disable-next-line @typescript-eslint/unbound-method\n+  fastify.addHook('onRequest', fastify.csrfProtection);\n+\n+  fastify.get('/', (_req, reply) => {\n+    void reply.send({ foo: 'bar' });\n+  });\n+  return fastify;\n+}\n+\n+describe('CSRF protection', () => {\n+  let fastify: FastifyInstance;\n+  beforeEach(async () => {\n+    fastify = await setupServer();\n+  });\n+  it('should receive a new CSRF token with the expected properties', async () => {\n+    const response = await fastify.inject({\n+      method: 'GET',\n+      url: '/'\n+    });\n+    const newCookies = response.cookies;\n+    const csrfTokenCookie = newCookies.find(\n+      cookie => cookie.name === CSRF_COOKIE\n+    );\n+\n+    const { value, ...rest } = csrfTokenCookie!;\n+\n+    // The value is a random string - it's enough to check that it's not empty\n+    expect(value).toHaveLength(52);\n+\n+    expect(rest).toStrictEqual({\n+      name: CSRF_COOKIE,\n+      path: '/',\n+      sameSite: 'Strict',\n+      domain: COOKIE_DOMAIN,\n+      secure: true\n+    });\n+  });\n+\n+  it('should return 403 if the _csrf secret is missing', async () => {\n+    const response = await fastify.inject({\n+      method: 'GET',\n+      url: '/'\n+    });\n+\n+    expect(response.statusCode).toEqual(403);\n+    // The response body is determined by the error-handling plugin, so we don't\n+    // check it here.\n+  });\n+\n+  it('should return 403 if the csrf_token is invalid', async () => {\n+    const response = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      cookies: {\n+        _csrf: 'foo',\n+        csrf_token: 'bar'\n+      }\n+    });\n+    expect(response.statusCode).toEqual(403);\n+  });\n+\n+  it('should allow the request if the csrf_token is valid', async () => {\n+    const csrfResponse = await fastify.inject({\n+      method: 'GET',\n+      url: '/'\n+    });\n+\n+    const csrfTokenCookie = csrfResponse.cookies.find(\n+      cookie => cookie.name === CSRF_COOKIE\n+    );\n+    const csrfSecretCookie = csrfResponse.cookies.find(\n+      cookie => cookie.name === CSRF_SECRET_COOKIE\n+    );\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      cookies: {\n+        _csrf: csrfSecretCookie!.value\n+      },\n+      headers: {\n+        'csrf-token': csrfTokenCookie!.value\n+      }\n+    });\n+\n+    expect(res.json()).toEqual({ foo: 'bar' });\n+    expect(res.statusCode).toEqual(200);\n+  });\n+});"
        },
        {
            "sha": "dd7f97964ad79dc5f0b9491e9473a623748957e3",
            "filename": "api/src/plugins/csrf.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fplugins%2Fcsrf.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fplugins%2Fcsrf.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcsrf.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -0,0 +1,48 @@\n+import type { FastifyPluginCallback } from 'fastify';\n+import fastifyCsrfProtection from '@fastify/csrf-protection';\n+\n+import fp from 'fastify-plugin';\n+\n+export const CSRF_COOKIE = 'csrf_token';\n+export const CSRF_HEADER = 'csrf-token';\n+export const CSRF_SECRET_COOKIE = '_csrf';\n+\n+/**\n+ * Plugin for preventing CSRF attacks.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+const csrf: FastifyPluginCallback = (fastify, _options, done) => {\n+  void fastify.register(fastifyCsrfProtection, {\n+    // TODO: consider signing cookies. We don't on the api-server, but we could\n+    // as an extra layer of security.\n+\n+    ///Ignore all other possible sources of CSRF\n+    // tokens since we know we can provide this one\n+    getToken: req => req.headers[CSRF_HEADER] as string,\n+    cookieOpts: { signed: false, sameSite: 'strict' }\n+  });\n+\n+  // All routes except signout should add a CSRF token to the response\n+  fastify.addHook('onRequest', (_req, reply, done) => {\n+    const isSignout = _req.url === '/signout' || _req.url === '/signout/';\n+\n+    if (!isSignout) {\n+      const token = reply.generateCsrf();\n+      void reply.setCookie(CSRF_COOKIE, token, {\n+        sameSite: 'strict',\n+        signed: false,\n+        // it needs to be read by the client, so that it can be sent in the\n+        // header of the next request:\n+        httpOnly: false\n+      });\n+    }\n+    done();\n+  });\n+\n+  done();\n+};\n+\n+export default fp(csrf, { dependencies: ['cookies'] });"
        },
        {
            "sha": "bbc9b0e93773c40537515b96fd8935e3bd8fb7df",
            "filename": "api/src/routes/protected/settings.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 46,
            "changes": 46,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.test.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -53,52 +53,6 @@ const updateErrorResponse = {\n describe('settingRoutes', () => {\n   setupServer();\n \n-  // TODO: rather than testing every single route, create a single test for the\n-  // rest api plugin that checks that the appropriate hooks are added to all\n-\n-  // This only tests one route, but all of the routes in the settings plugin add\n-  // the same hooks. So if this suite passes, the other routes should be\n-  // protected.\n-  describe('CSRF protection', () => {\n-    it('should return 403 if the _csrf secret is missing', async () => {\n-      const response = await superRequest('/update-my-profileui', {\n-        method: 'PUT'\n-      });\n-\n-      expect(response.body).toEqual({\n-        message: 'flash.generic-error',\n-        type: 'danger'\n-      });\n-      expect(response.statusCode).toEqual(403);\n-    });\n-\n-    it('should return 403 if the csrf_token is invalid', async () => {\n-      const response = await superRequest('/update-my-profileui', {\n-        method: 'PUT'\n-      }).set('Cookie', ['_csrf=foo', 'csrf-token=bar']);\n-\n-      expect(response.body).toEqual({\n-        message: 'flash.generic-error',\n-        type: 'danger'\n-      });\n-      expect(response.statusCode).toEqual(403);\n-    });\n-\n-    it('should receive a new CSRF token + secret in the response', async () => {\n-      const response = await superRequest('/update-my-profileui', {\n-        method: 'PUT'\n-      });\n-\n-      const newCookies = response.get('Set-Cookie');\n-      expect(newCookies).toEqual(\n-        expect.arrayContaining([\n-          expect.stringContaining('_csrf'),\n-          expect.stringContaining('csrf_token')\n-        ])\n-      );\n-    });\n-  });\n-\n   describe('Authenticated user', () => {\n     let superPut: ReturnType<typeof createSuperRequest>;\n     let superGet: ReturnType<typeof createSuperRequest>;"
        },
        {
            "sha": "a73672551445a82bf4c94f4f60cb89762fa639cb",
            "filename": "api/src/routes/public/signout.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fsignout.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -16,9 +16,7 @@ export const signoutRoute: FastifyPluginCallback = (\n   done\n ) => {\n   fastify.get('/signout', async (req, reply) => {\n-    void reply.clearCookie('jwt_access_token');\n-    void reply.clearCookie('csrf_token');\n-    void reply.clearCookie('_csrf');\n+    void reply.clearOurCookies();\n \n     const { returnTo } = getRedirectParams(req);\n     await reply.redirect(returnTo);"
        },
        {
            "sha": "751dae951a84e658a2766e02662b781ce21b3dfb",
            "filename": "api/src/server.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 21,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fserver.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ced457fed5d56da420bb64dccd470449d2d7f64f/api%2Fsrc%2Fserver.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fserver.test.ts?ref=ced457fed5d56da420bb64dccd470449d2d7f64f",
            "patch": "@@ -1,5 +1,5 @@\n import { setupServer, superRequest } from '../jest.utils';\n-import { HOME_LOCATION, COOKIE_DOMAIN } from './utils/env';\n+import { HOME_LOCATION } from './utils/env';\n \n jest.mock('./utils/env', () => {\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n@@ -12,26 +12,6 @@ jest.mock('./utils/env', () => {\n describe('server', () => {\n   setupServer();\n \n-  describe('CSRF protection', () => {\n-    it('should receive a new CSRF token with the expected properties', async () => {\n-      const response = await superRequest('/status/ping', { method: 'GET' });\n-      const newCookies = response.get('Set-Cookie');\n-      const csrfTokenCookie = newCookies.find(cookie =>\n-        cookie.includes('csrf_token')\n-      );\n-\n-      expect(csrfTokenCookie).toEqual(\n-        expect.stringContaining('SameSite=Strict')\n-      );\n-      expect(csrfTokenCookie).toEqual(\n-        expect.stringContaining(`Domain=${COOKIE_DOMAIN}`)\n-      );\n-      expect(csrfTokenCookie).toEqual(expect.stringContaining('Path=/'));\n-      // Since we're not mocking FREECODECAMP_NODE_ENV to production, there's no\n-      // point checking if it is secure (it won't be in testing).\n-    });\n-  });\n-\n   describe('GET /', () => {\n     test('should have OWASP recommended headers', async () => {\n       const res = await superRequest('/', { method: 'GET' });"
        }
    ],
    "stats": {
        "total": 271,
        "additions": 167,
        "deletions": 104
    }
}