{
    "author": "ShaunSHamilton",
    "message": "feat(api): add exam env attempts endpoints and fields (#59634)\n\nCo-authored-by: Tom <20648924+moT01@users.noreply.github.com>\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "92b6ca53430493af338d61adf067d1e9f5131236",
    "files": [
        {
            "sha": "c871a92be0f5fff68fea1463e34fc50d9d0701a2",
            "filename": "api/__mocks__/exam-environment-exam.ts",
            "status": "renamed",
            "additions": 25,
            "deletions": 25,
            "changes": 50,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2F__mocks__%2Fexam-environment-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2F__mocks__%2Fexam-environment-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fexam-environment-exam.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,11 +1,11 @@\n import { Static } from '@fastify/type-provider-typebox';\n import {\n-  EnvConfig,\n-  EnvQuestionType,\n-  EnvExamAttempt,\n-  EnvExam,\n-  EnvGeneratedExam,\n-  EnvQuestionSet\n+  ExamEnvironmentConfig,\n+  ExamEnvironmentQuestionType,\n+  ExamEnvironmentExamAttempt,\n+  ExamEnvironmentExam,\n+  ExamEnvironmentGeneratedExam,\n+  ExamEnvironmentQuestionSet\n } from '@prisma/client';\n import { ObjectId } from 'mongodb';\n // import { defaultUserId } from '../jest.utils';\n@@ -18,28 +18,29 @@ const defaultUserId = '64c7810107dd4782d32baee7';\n \n export const examId = oid();\n \n-export const config: EnvConfig = {\n+export const config: ExamEnvironmentConfig = {\n   totalTimeInMS: 2 * 60 * 60 * 1000,\n   tags: [],\n   name: 'Test Exam',\n   note: 'Some exam note...',\n+  passingPercent: 80,\n   questionSets: [\n     {\n-      type: EnvQuestionType.MultipleChoice,\n+      type: ExamEnvironmentQuestionType.MultipleChoice,\n       numberOfSet: 1,\n       numberOfQuestions: 1,\n       numberOfCorrectAnswers: 1,\n       numberOfIncorrectAnswers: 1\n     },\n     {\n-      type: EnvQuestionType.MultipleChoice,\n+      type: ExamEnvironmentQuestionType.MultipleChoice,\n       numberOfSet: 1,\n       numberOfQuestions: 1,\n       numberOfCorrectAnswers: 2,\n       numberOfIncorrectAnswers: 1\n     },\n     {\n-      type: EnvQuestionType.Dialogue,\n+      type: ExamEnvironmentQuestionType.Dialogue,\n       numberOfSet: 1,\n       numberOfQuestions: 2,\n       numberOfCorrectAnswers: 1,\n@@ -49,10 +50,10 @@ export const config: EnvConfig = {\n   retakeTimeInMS: 24 * 60 * 60 * 1000\n };\n \n-export const questionSets: EnvQuestionSet[] = [\n+export const questionSets: ExamEnvironmentQuestionSet[] = [\n   {\n     id: oid(),\n-    type: EnvQuestionType.MultipleChoice,\n+    type: ExamEnvironmentQuestionType.MultipleChoice,\n     context: null,\n     questions: [\n       {\n@@ -83,7 +84,7 @@ export const questionSets: EnvQuestionSet[] = [\n   },\n   {\n     id: oid(),\n-    type: EnvQuestionType.MultipleChoice,\n+    type: ExamEnvironmentQuestionType.MultipleChoice,\n     context: null,\n     questions: [\n       {\n@@ -114,7 +115,7 @@ export const questionSets: EnvQuestionSet[] = [\n   },\n   {\n     id: oid(),\n-    type: EnvQuestionType.Dialogue,\n+    type: ExamEnvironmentQuestionType.Dialogue,\n     context: 'Dialogue 1 context',\n     questions: [\n       {\n@@ -196,7 +197,7 @@ export const questionSets: EnvQuestionSet[] = [\n   }\n ];\n \n-export const generatedExam: EnvGeneratedExam = {\n+export const generatedExam: ExamEnvironmentGeneratedExam = {\n   examId,\n   id: oid(),\n   deprecated: false,\n@@ -250,11 +251,10 @@ export const generatedExam: EnvGeneratedExam = {\n   ]\n };\n \n-export const examAttempt: EnvExamAttempt = {\n+export const examAttempt: ExamEnvironmentExamAttempt = {\n   examId,\n   generatedExamId: generatedExam.id,\n   id: oid(),\n-  needsRetake: false,\n   questionSets: [\n     {\n       id: generatedExam.questionSets[0]!.id,\n@@ -335,7 +335,7 @@ export const examAttemptSansSubmissionTimeInMS: Static<\n   ]\n };\n \n-export const exam: EnvExam = {\n+export const exam: ExamEnvironmentExam = {\n   id: examId,\n   config,\n   questionSets,\n@@ -346,10 +346,10 @@ export const exam: EnvExam = {\n export async function seedEnvExam() {\n   await clearEnvExam();\n \n-  await fastifyTestInstance.prisma.envExam.create({\n+  await fastifyTestInstance.prisma.examEnvironmentExam.create({\n     data: exam\n   });\n-  await fastifyTestInstance.prisma.envGeneratedExam.create({\n+  await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.create({\n     data: generatedExam\n   });\n \n@@ -359,7 +359,7 @@ export async function seedEnvExam() {\n   // while (numberOfExamsGenerated < 2) {\n   //   try {\n   //     const generatedExam = generateExam(exam);\n-  //     await fastifyTestInstance.prisma.envGeneratedExam.create({\n+  //     await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.create({\n   //       data: generatedExam\n   //     });\n   //     numberOfExamsGenerated++;\n@@ -370,13 +370,13 @@ export async function seedEnvExam() {\n }\n \n export async function clearEnvExam() {\n-  await fastifyTestInstance.prisma.envExamAttempt.deleteMany({});\n-  await fastifyTestInstance.prisma.envGeneratedExam.deleteMany({});\n-  await fastifyTestInstance.prisma.envExam.deleteMany({});\n+  await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany({});\n+  await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.deleteMany({});\n+  await fastifyTestInstance.prisma.examEnvironmentExam.deleteMany({});\n }\n \n export async function seedEnvExamAttempt() {\n-  await fastifyTestInstance.prisma.envExamAttempt.create({\n+  await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n     data: examAttempt\n   });\n }",
            "previous_filename": "api/__mocks__/env-exam.ts"
        },
        {
            "sha": "5c69ba6f203c26f8fea949341488e4233d1223af",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 78,
            "deletions": 45,
            "changes": 123,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -164,58 +164,58 @@ model user {\n   isClassroomAccount             Boolean? // Undefined\n \n   // Relations\n-  examAttempts                      EnvExamAttempt[]\n+  examAttempts                      ExamEnvironmentExamAttempt[]\n   examEnvironmentAuthorizationToken ExamEnvironmentAuthorizationToken?\n }\n \n // -----------------------------------\n \n /// An exam for the Exam Environment App as designed by the examiners\n-model EnvExam {\n+model ExamEnvironmentExam {\n   /// Globally unique exam id\n-  id            String           @id @default(auto()) @map(\"_id\") @db.ObjectId\n+  id            String                       @id @default(auto()) @map(\"_id\") @db.ObjectId\n   /// All questions for a given exam\n-  questionSets  EnvQuestionSet[]\n+  questionSets  ExamEnvironmentQuestionSet[]\n   /// Configuration for exam metadata\n-  config        EnvConfig\n+  config        ExamEnvironmentConfig\n   /// ObjectIds for required challenges/blocks to take the exam\n-  prerequisites String[]         @db.ObjectId\n+  prerequisites String[]                     @db.ObjectId\n   /// If `deprecated`, the exam should no longer be considered for users\n   deprecated    Boolean\n \n   // Relations\n-  generatedExams EnvGeneratedExam[]\n-  examAttempts   EnvExamAttempt[]\n+  generatedExams ExamEnvironmentGeneratedExam[]\n+  examAttempts   ExamEnvironmentExamAttempt[]\n }\n \n /// A grouping of one or more questions of a given type\n-type EnvQuestionSet {\n+type ExamEnvironmentQuestionSet {\n   /// Unique question type id\n-  id        String                      @db.ObjectId\n-  type      EnvQuestionType\n+  id        String                                  @db.ObjectId\n+  type      ExamEnvironmentQuestionType\n   /// Content related to all questions in set\n   context   String?\n-  questions EnvMultipleChoiceQuestion[]\n+  questions ExamEnvironmentMultipleChoiceQuestion[]\n }\n \n /// A multiple choice question for the Exam Environment App\n-type EnvMultipleChoiceQuestion {\n+type ExamEnvironmentMultipleChoiceQuestion {\n   /// Unique question id\n-  id         String      @db.ObjectId\n+  id         String                  @db.ObjectId\n   /// Main question paragraph\n   text       String\n   /// Zero or more tags given to categorize a question\n   tags       String[]\n   /// Optional audio for a question\n-  audio      EnvAudio?\n+  audio      ExamEnvironmentAudio?\n   /// Available possible answers for an exam\n-  answers    EnvAnswer[]\n+  answers    ExamEnvironmentAnswer[]\n   /// TODO Possible \"deprecated_time\" to remove after all exams could possibly have been taken\n   deprecated Boolean\n }\n \n /// Audio for an Exam Environment App multiple choice question\n-type EnvAudio {\n+type ExamEnvironmentAudio {\n   /// Optional text for audio\n   captions String?\n   /// URL to audio file\n@@ -226,15 +226,15 @@ type EnvAudio {\n }\n \n /// Type of question for the Exam Environment App\n-enum EnvQuestionType {\n+enum ExamEnvironmentQuestionType {\n   /// Single question with one or more answers\n   MultipleChoice\n   /// Mass text\n   Dialogue\n }\n \n /// Answer for an Exam Environment App multiple choice question\n-type EnvAnswer {\n+type ExamEnvironmentAnswer {\n   /// Unique answer id\n   id        String  @db.ObjectId\n   /// Whether the answer is correct\n@@ -244,24 +244,26 @@ type EnvAnswer {\n }\n \n /// Configuration for an exam in the Exam Environment App\n-type EnvConfig {\n+type ExamEnvironmentConfig {\n   /// Human-readable exam name\n   name           String\n   /// Notes given about exam\n   note           String\n   /// Category configuration for question selection\n-  tags           EnvTagConfig[]\n+  tags           ExamEnvironmentTagConfig[]\n   /// Total time allocated for exam in milliseconds\n   totalTimeInMS  Int\n   /// Configuration for sets of questions\n-  questionSets   EnvQuestionSetConfig[]\n+  questionSets   ExamEnvironmentQuestionSetConfig[]\n   /// Duration after exam completion before a retake is allowed in milliseconds\n   retakeTimeInMS Int\n+  /// Passing percent for the exam\n+  passingPercent Float\n }\n \n /// Configuration for a set of questions in the Exam Environment App\n-type EnvQuestionSetConfig {\n-  type                     EnvQuestionType\n+type ExamEnvironmentQuestionSetConfig {\n+  type                     ExamEnvironmentQuestionType\n   /// Number of this grouping of questions per exam\n   numberOfSet              Int\n   /// Number of multiple choice questions per grouping matching this set config\n@@ -275,15 +277,15 @@ type EnvQuestionSetConfig {\n /// Configuration for tags in the Exam Environment App\n ///\n /// This configures the number of questions that should resolve to a given tag set criteria.\n-type EnvTagConfig {\n+type ExamEnvironmentTagConfig {\n   /// Group of multiple choice question tags\n   group             String[]\n   /// Number of multiple choice questions per exam that should meet the group criteria\n   numberOfQuestions Int\n }\n \n /// An attempt at an exam in the Exam Environment App\n-model EnvExamAttempt {\n+model ExamEnvironmentExamAttempt {\n   id              String @id @default(auto()) @map(\"_id\") @db.ObjectId\n   /// Foriegn key to user\n   userId          String @db.ObjectId\n@@ -292,23 +294,23 @@ model EnvExamAttempt {\n   /// Foreign key to generated exam id\n   generatedExamId String @db.ObjectId\n \n-  questionSets  EnvQuestionSetAttempt[]\n+  questionSets  ExamEnvironmentQuestionSetAttempt[]\n   /// Time exam was started as milliseconds since epoch\n   startTimeInMS Int\n-  needsRetake   Boolean\n \n   // Relations\n-  user          user             @relation(fields: [userId], references: [id], onDelete: Cascade)\n-  exam          EnvExam          @relation(fields: [examId], references: [id])\n-  generatedExam EnvGeneratedExam @relation(fields: [generatedExamId], references: [id])\n+  user                          user                            @relation(fields: [userId], references: [id], onDelete: Cascade)\n+  exam                          ExamEnvironmentExam             @relation(fields: [examId], references: [id], onDelete: Cascade)\n+  generatedExam                 ExamEnvironmentGeneratedExam    @relation(fields: [generatedExamId], references: [id])\n+  ExamEnvironmentExamModeration ExamEnvironmentExamModeration[]\n }\n \n-type EnvQuestionSetAttempt {\n-  id        String                             @db.ObjectId\n-  questions EnvMultipleChoiceQuestionAttempt[]\n+type ExamEnvironmentQuestionSetAttempt {\n+  id        String                                         @db.ObjectId\n+  questions ExamEnvironmentMultipleChoiceQuestionAttempt[]\n }\n \n-type EnvMultipleChoiceQuestionAttempt {\n+type ExamEnvironmentMultipleChoiceQuestionAttempt {\n   /// Foreign key to question\n   id                 String   @db.ObjectId\n   /// An array of foreign keys to answers\n@@ -322,25 +324,25 @@ type EnvMultipleChoiceQuestionAttempt {\n /// A generated exam for the Exam Environment App\n ///\n /// This is the user-facing information for an exam.\n-model EnvGeneratedExam {\n-  id           String                    @id @default(auto()) @map(\"_id\") @db.ObjectId\n+model ExamEnvironmentGeneratedExam {\n+  id           String                                @id @default(auto()) @map(\"_id\") @db.ObjectId\n   /// Foreign key to exam\n-  examId       String                    @db.ObjectId\n-  questionSets EnvGeneratedQuestionSet[]\n+  examId       String                                @db.ObjectId\n+  questionSets ExamEnvironmentGeneratedQuestionSet[]\n   /// If `deprecated`, the generation should not longer be considered for users\n   deprecated   Boolean\n \n   // Relations\n-  exam           EnvExam          @relation(fields: [examId], references: [id])\n-  EnvExamAttempt EnvExamAttempt[]\n+  exam           ExamEnvironmentExam          @relation(fields: [examId], references: [id], onDelete: Cascade)\n+  EnvExamAttempt ExamEnvironmentExamAttempt[]\n }\n \n-type EnvGeneratedQuestionSet {\n-  id        String                               @db.ObjectId\n-  questions EnvGeneratedMultipleChoiceQuestion[]\n+type ExamEnvironmentGeneratedQuestionSet {\n+  id        String                                           @db.ObjectId\n+  questions ExamEnvironmentGeneratedMultipleChoiceQuestion[]\n }\n \n-type EnvGeneratedMultipleChoiceQuestion {\n+type ExamEnvironmentGeneratedMultipleChoiceQuestion {\n   /// Foreign key to question id\n   id      String   @db.ObjectId\n   /// Each item is a foreign key to an answer\n@@ -486,3 +488,34 @@ type SurveyResponse {\n   question String\n   response String\n }\n+\n+// ----------------------\n+\n+model ExamEnvironmentExamModeration {\n+  id             String                              @id @default(auto()) @map(\"_id\") @db.ObjectId\n+  /// Whether or not the item is approved\n+  status         ExamEnvironmentExamModerationStatus\n+  /// Foreign key to exam attempt\n+  examAttemptId  String                              @unique @db.ObjectId\n+  /// Optional feedback/note about the moderation decision\n+  feedback       String?\n+  /// Date the exam attempt was moderated\n+  moderationDate DateTime?\n+  /// Foreign key to moderator. This is `null` until the item is moderated.\n+  moderatorId    String?                             @db.ObjectId\n+\n+  /// Date the exam attempt was added to the moderation queue\n+  submissionDate DateTime @default(now()) @db.Date\n+\n+  // Relations\n+  examAttempt ExamEnvironmentExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)\n+}\n+\n+enum ExamEnvironmentExamModerationStatus {\n+  /// Attempt is determined to be valid\n+  Approved\n+  /// Attempt is determined to be invalid\n+  Denied\n+  /// Attempt has yet to be moderated\n+  Pending\n+}"
        },
        {
            "sha": "ad2d3861746c85ea6ed237016d4a22d91e9f7654",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 373,
            "deletions": 63,
            "changes": 436,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,3 +1,4 @@\n+import { ExamEnvironmentExamModerationStatus } from '@prisma/client';\n import { Static } from '@fastify/type-provider-typebox';\n import jwt from 'jsonwebtoken';\n \n@@ -12,8 +13,8 @@ import {\n   examEnvironmentPostExamAttempt,\n   examEnvironmentPostExamGeneratedExam\n } from '../schemas';\n-import * as mock from '../../../__mocks__/env-exam';\n-import { constructUserExam } from '../utils/exam';\n+import * as mock from '../../../__mocks__/exam-environment-exam';\n+import { constructUserExam } from '../utils/exam-environment';\n import { JWT_SECRET } from '../../utils/env';\n \n jest.mock('../../utils/env', () => {\n@@ -36,7 +37,6 @@ describe('/exam-environment/', () => {\n       const setCookies = await devLogin();\n       superPost = createSuperRequest({ method: 'POST', setCookies });\n       superGet = createSuperRequest({ method: 'GET', setCookies });\n-      await mock.seedEnvExam();\n       // Add exam environment authorization token\n       const res = await superPost('/user/exam-environment/token');\n       expect(res.status).toBe(201);\n@@ -50,9 +50,13 @@ describe('/exam-environment/', () => {\n       await mock.clearEnvExam();\n     });\n \n+    beforeEach(async () => {\n+      await mock.seedEnvExam();\n+    });\n+\n     describe('POST /exam-environment/exam/attempt', () => {\n       afterEach(async () => {\n-        await fastifyTestInstance.prisma.envExamAttempt.deleteMany();\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n       });\n \n       it('should return an error if there are no current exam attempts matching the given id', async () => {\n@@ -83,11 +87,10 @@ describe('/exam-environment/', () => {\n       it('should return an error if the given exam id does not match an existing exam', async () => {\n         const examId = mock.oid();\n         // Create exam attempt with bad exam id\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: {\n             examId,\n             generatedExamId: mock.oid(),\n-            needsRetake: false,\n             startTimeInMS: Date.now(),\n             userId: defaultUserId\n           }\n@@ -115,11 +118,10 @@ describe('/exam-environment/', () => {\n \n       it('should return an error if the attempt has expired', async () => {\n         // Create exam attempt with expired time\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: {\n             examId: mock.examId,\n             generatedExamId: mock.oid(),\n-            needsRetake: false,\n             startTimeInMS: Date.now() - (1000 * 60 * 60 * 2 + 1000),\n             userId: defaultUserId\n           }\n@@ -147,11 +149,10 @@ describe('/exam-environment/', () => {\n \n       it('should return an error if there is no matching generated exam', async () => {\n         // Create exam attempt with no matching generated exam\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: {\n             examId: mock.examId,\n             generatedExamId: mock.oid(),\n-            needsRetake: false,\n             startTimeInMS: Date.now(),\n             userId: defaultUserId\n           }\n@@ -178,9 +179,10 @@ describe('/exam-environment/', () => {\n       });\n \n       it('should return an error if the attempt does not match the generated exam', async () => {\n-        const attempt = await fastifyTestInstance.prisma.envExamAttempt.create({\n-          data: { ...mock.examAttempt, userId: defaultUserId }\n-        });\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: { ...mock.examAttempt, userId: defaultUserId }\n+          });\n \n         attempt.questionSets[0]!.id = mock.oid();\n \n@@ -202,25 +204,30 @@ describe('/exam-environment/', () => {\n         });\n         expect(res.status).toBe(400);\n \n-        // Database should mark attempt as `needsRetake`\n-        const updatedAttempt =\n-          await fastifyTestInstance.prisma.envExamAttempt.findUnique({\n-            where: { id: attempt.id }\n-          });\n-        expect(updatedAttempt).toHaveProperty('needsRetake', true);\n+        // Database should have moderation record for attempt\n+        const examModeration =\n+          await fastifyTestInstance.prisma.examEnvironmentExamModeration.findUnique(\n+            {\n+              where: {\n+                examAttemptId: attempt.id,\n+                status: ExamEnvironmentExamModerationStatus.Pending\n+              }\n+            }\n+          );\n+        expect(examModeration).not.toBeNull();\n       });\n \n       it('should return 200 if request is valid, and update attempt in database', async () => {\n-        const attempt = await fastifyTestInstance.prisma.envExamAttempt.create({\n-          data: {\n-            userId: defaultUserId,\n-            examId: mock.examId,\n-            generatedExamId: mock.generatedExam.id,\n-            startTimeInMS: Date.now(),\n-            questionSets: [],\n-            needsRetake: false\n-          }\n-        });\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: {\n+              userId: defaultUserId,\n+              examId: mock.examId,\n+              generatedExamId: mock.generatedExam.id,\n+              startTimeInMS: Date.now(),\n+              questionSets: []\n+            }\n+          });\n \n         const body: Static<typeof examEnvironmentPostExamAttempt.body> = {\n           attempt: mock.examAttemptSansSubmissionTimeInMS\n@@ -237,17 +244,19 @@ describe('/exam-environment/', () => {\n \n         // Database should update attempt\n         const updatedAttempt =\n-          await fastifyTestInstance.prisma.envExamAttempt.findUnique({\n-            where: { id: attempt.id }\n-          });\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.findUnique(\n+            {\n+              where: { id: attempt.id }\n+            }\n+          );\n \n         expect(updatedAttempt).toMatchObject(body.attempt);\n       });\n     });\n \n     describe('POST /exam-environment/generated-exam', () => {\n       afterEach(async () => {\n-        await fastifyTestInstance.prisma.envExamAttempt.deleteMany();\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n         // Add prerequisite id to user completed challenge\n         await fastifyTestInstance.prisma.user.update({\n           where: { id: defaultUserId },\n@@ -258,6 +267,11 @@ describe('/exam-environment/', () => {\n           }\n         });\n         await mock.seedEnvExam();\n+        const a =\n+          await fastifyTestInstance.prisma.examEnvironmentExamModeration.findMany(\n+            {}\n+          );\n+        expect(a).toHaveLength(0);\n       });\n \n       it('should return an error if the given exam id is invalid', async () => {\n@@ -305,13 +319,13 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(403);\n       });\n \n-      it('should return an error if the exam has been attempted in the last 24 hours', async () => {\n+      it('should return an error if the exam has been attempted too recently to retake', async () => {\n         const recentExamAttempt = {\n           ...mock.examAttempt,\n           // Set start time such that exam has just expired\n           startTimeInMS: Date.now() - mock.exam.config.totalTimeInMS\n         };\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: recentExamAttempt\n         });\n \n@@ -333,15 +347,16 @@ describe('/exam-environment/', () => {\n           }\n         });\n \n-        await fastifyTestInstance.prisma.envExamAttempt.update({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.update({\n           where: {\n             id: recentExamAttempt.id\n           },\n           data: {\n-            // Set start time such that exam has expired, but 24 hours - 1s has passed\n+            // Set start time such that exam has expired, but retake time -1s has passed\n             startTimeInMS:\n               Date.now() -\n-              (mock.exam.config.totalTimeInMS + (24 * 60 * 60 * 1000 - 1000))\n+              (mock.exam.config.totalTimeInMS +\n+                (mock.exam.config.retakeTimeInMS - 1000))\n           }\n         });\n \n@@ -371,14 +386,14 @@ describe('/exam-environment/', () => {\n         recentExamAttempt.startTimeInMS =\n           Date.now() -\n           (mock.exam.config.totalTimeInMS + (24 * 60 * 60 * 1000 + 1000));\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: recentExamAttempt\n         });\n \n         // Generate new exam for user to be assigned\n         const newGeneratedExam = structuredClone(mock.generatedExam);\n         newGeneratedExam.id = mock.oid();\n-        await fastifyTestInstance.prisma.envGeneratedExam.create({\n+        await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.create({\n           data: newGeneratedExam\n         });\n \n@@ -407,7 +422,7 @@ describe('/exam-environment/', () => {\n \n       it('should return the current attempt if it is still ongoing', async () => {\n         const latestAttempt =\n-          await fastifyTestInstance.prisma.envExamAttempt.create({\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n             data: mock.examAttempt\n           });\n \n@@ -439,7 +454,7 @@ describe('/exam-environment/', () => {\n           24 * 60 * 60 * 1000 -\n           mock.exam.config.totalTimeInMS -\n           1 * 60 * 60 * 1000;\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: submittedAttempt\n         });\n \n@@ -475,16 +490,20 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(200);\n \n         const generatedExam =\n-          await fastifyTestInstance.prisma.envGeneratedExam.findFirst({\n-            where: { examId: mock.examId }\n-          });\n+          await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.findFirst(\n+            {\n+              where: { examId: mock.examId }\n+            }\n+          );\n \n         expect(generatedExam).toBeDefined();\n \n         const examAttempt =\n-          await fastifyTestInstance.prisma.envExamAttempt.findFirst({\n-            where: { generatedExamId: generatedExam!.id }\n-          });\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.findFirst(\n+            {\n+              where: { generatedExamId: generatedExam!.id }\n+            }\n+          );\n \n         expect(examAttempt).toEqual({\n           // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n@@ -493,15 +512,14 @@ describe('/exam-environment/', () => {\n           examId: mock.examId,\n           generatedExamId: generatedExam!.id,\n           questionSets: [],\n-          needsRetake: false,\n           // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n           startTimeInMS: expect.any(Number)\n         });\n       });\n \n       it('should unwind (delete) the exam attempt if the user exam cannot be constructed', async () => {\n         const _mockConstructUserExam = jest\n-          .spyOn(await import('../utils/exam'), 'constructUserExam')\n+          .spyOn(await import('../utils/exam-environment'), 'constructUserExam')\n           .mockImplementationOnce(() => {\n             throw new Error('Test error');\n           });\n@@ -519,9 +537,11 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(500);\n \n         const examAttempt =\n-          await fastifyTestInstance.prisma.envExamAttempt.findFirst({\n-            where: { examId: mock.examId }\n-          });\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.findFirst(\n+            {\n+              where: { examId: mock.examId }\n+            }\n+          );\n \n         expect(examAttempt).toBeNull();\n       });\n@@ -540,16 +560,20 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(200);\n \n         const generatedExam =\n-          await fastifyTestInstance.prisma.envGeneratedExam.findFirst({\n-            where: { examId: mock.examId }\n-          });\n+          await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.findFirst(\n+            {\n+              where: { examId: mock.examId }\n+            }\n+          );\n \n         expect(generatedExam).toBeDefined();\n \n         const examAttempt =\n-          await fastifyTestInstance.prisma.envExamAttempt.findFirst({\n-            where: { generatedExamId: generatedExam!.id }\n-          });\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.findFirst(\n+            {\n+              where: { generatedExamId: generatedExam!.id }\n+            }\n+          );\n \n         const userExam = constructUserExam(generatedExam!, mock.exam);\n \n@@ -565,7 +589,7 @@ describe('/exam-environment/', () => {\n \n     describe('POST /exam-environment/screenshot', () => {\n       afterEach(async () => {\n-        await fastifyTestInstance.prisma.envExamAttempt.deleteMany();\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n       });\n \n       it('should return 400 if request is not multipart form data', async () => {\n@@ -615,7 +639,7 @@ describe('/exam-environment/', () => {\n       });\n \n       it('should return 400 if image is of wrong format', async () => {\n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: mock.examAttempt\n         });\n \n@@ -639,7 +663,7 @@ describe('/exam-environment/', () => {\n         const imageUploadRes = createFetchMock({ ok: true });\n         jest.spyOn(globalThis, 'fetch').mockImplementation(imageUploadRes);\n \n-        await fastifyTestInstance.prisma.envExamAttempt.create({\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n           data: mock.examAttempt\n         });\n \n@@ -670,6 +694,7 @@ describe('/exam-environment/', () => {\n               config: {\n                 name: mock.exam.config.name,\n                 note: mock.exam.config.note,\n+                passingPercent: mock.exam.config.passingPercent,\n                 totalTimeInMS: mock.exam.config.totalTimeInMS,\n                 retakeTimeInMS: mock.exam.config.retakeTimeInMS\n               },\n@@ -682,7 +707,7 @@ describe('/exam-environment/', () => {\n       });\n \n       it('should not return any deprecated exams', async () => {\n-        await fastifyTestInstance.prisma.envExam.update({\n+        await fastifyTestInstance.prisma.examEnvironmentExam.update({\n           where: { id: mock.examId },\n           data: { deprecated: true }\n         });\n@@ -699,6 +724,270 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(200);\n       });\n     });\n+\n+    describe('GET /exam-environment/exam/attempt/:attemptId', () => {\n+      afterEach(async () => {\n+        // If attempt is deleted, moderation record should cascade\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n+        const moderationRecords =\n+          await fastifyTestInstance.prisma.examEnvironmentExamModeration.findMany(\n+            {}\n+          );\n+        expect(moderationRecords).toHaveLength(0);\n+      });\n+\n+      it('should return 404 if the attempt does not exist', async () => {\n+        const attemptId = mock.oid();\n+        const res = await superGet(\n+          `/exam-environment/exam/attempt/${attemptId}`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toStrictEqual({\n+          code: 'FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT',\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          message: expect.any(String)\n+        });\n+        expect(res.status).toBe(404);\n+      });\n+\n+      it('should return 404 if the attempt belongs to another user', async () => {\n+        const otherUserAttempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: { ...mock.examAttempt, userId: mock.oid() }\n+          });\n+        const res = await superGet(\n+          `/exam-environment/exam/attempt/${otherUserAttempt.id}`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toStrictEqual({\n+          code: 'FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT', // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          message: expect.any(String)\n+        });\n+        expect(res.status).toBe(404);\n+      });\n+\n+      it('should return 200 with the examEnvironmentExamAttempt if the attempt exists and belongs to the user', async () => {\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: { ...mock.examAttempt, userId: defaultUserId }\n+          });\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Pending\n+          }\n+        });\n+\n+        const res = await superGet(\n+          `/exam-environment/exam/attempt/${attempt.id}`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        const examEnvironmentExamAttempt = {\n+          result: null,\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets\n+        };\n+\n+        expect(res.body).toEqual(examEnvironmentExamAttempt);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      xit('TODO: (once serialization is serializable) should return 400 if no attempt id is given', async () => {\n+        const res = await superGet('/exam-environment/exam/attempt/').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.status).toBe(400);\n+      });\n+\n+      it('should return the attempt without results, if the attempt has not been moderated', async () => {\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: { ...mock.examAttempt, userId: defaultUserId }\n+          });\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Pending\n+          }\n+        });\n+\n+        const res = await superGet(\n+          `/exam-environment/exam/attempt/${attempt.id}`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        const examEnvironmentExamAttempt = {\n+          result: null,\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets\n+        };\n+\n+        expect(res.body).toEqual(examEnvironmentExamAttempt);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it('should return the attempt with results, if the attempt has been moderated', async () => {\n+        const examAttempt = structuredClone(mock.examAttempt);\n+        examAttempt.startTimeInMS = Date.now() - mock.exam.config.totalTimeInMS;\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: examAttempt\n+          });\n+\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Approved\n+          }\n+        });\n+\n+        const res = await superGet(\n+          `/exam-environment/exam/attempt/${attempt.id}`\n+        ).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        const examEnvironmentExamAttempt = {\n+          result: {\n+            score: 25,\n+            passingPercent: 80\n+          },\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets\n+        };\n+\n+        expect(res.body).toEqual(examEnvironmentExamAttempt);\n+        expect(res.status).toBe(200);\n+      });\n+    });\n+\n+    describe('GET /exam-environment/exam/attempts', () => {\n+      afterEach(async () => {\n+        // If attempt is deleted, moderation record should cascade\n+        await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany();\n+        const moderationRecords =\n+          await fastifyTestInstance.prisma.examEnvironmentExamModeration.findMany(\n+            {}\n+          );\n+        expect(moderationRecords).toHaveLength(0);\n+      });\n+\n+      it('should return 404 if no attempts exist', async () => {\n+        const res = await superGet(`/exam-environment/exam/attempts`).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toStrictEqual({\n+          code: 'FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT',\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          message: expect.any(String)\n+        });\n+        expect(res.status).toBe(404);\n+      });\n+\n+      it('should return 200 with the attempts if they exist and belong to the user', async () => {\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: { ...mock.examAttempt, userId: defaultUserId }\n+          });\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Pending\n+          }\n+        });\n+\n+        const res = await superGet(`/exam-environment/exam/attempts`).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        const examEnvironmentExamAttempt = {\n+          result: null,\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets\n+        };\n+\n+        expect(res.body).toEqual([examEnvironmentExamAttempt]);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it('should return the attempts without results, if they have not been moderated', async () => {\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: { ...mock.examAttempt, userId: defaultUserId }\n+          });\n+\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Pending\n+          }\n+        });\n+\n+        const res = await superGet(`/exam-environment/exam/attempts`).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        const examEnvironmentExamAttempt = {\n+          result: null,\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets\n+        };\n+\n+        expect(res.body).toEqual([examEnvironmentExamAttempt]);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it('should return the attempts with results, if they have been moderated', async () => {\n+        const examAttempt = structuredClone(mock.examAttempt);\n+        examAttempt.startTimeInMS = Date.now() - mock.exam.config.totalTimeInMS;\n+        const attempt =\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+            data: examAttempt\n+          });\n+\n+        await fastifyTestInstance.prisma.examEnvironmentExamModeration.create({\n+          data: {\n+            examAttemptId: attempt.id,\n+            status: ExamEnvironmentExamModerationStatus.Approved\n+          }\n+        });\n+\n+        const res = await superGet(`/exam-environment/exam/attempts`).set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        const examEnvironmentExamAttempt = {\n+          result: {\n+            score: 25,\n+            passingPercent: 80\n+          },\n+          startTimeInMS: attempt.startTimeInMS,\n+          questionSets: attempt.questionSets\n+        };\n+\n+        expect(res.body).toEqual([examEnvironmentExamAttempt]);\n+        expect(res.status).toBe(200);\n+      });\n+    });\n   });\n \n   describe('Authenticated user without exam environment authorization token', () => {\n@@ -796,5 +1085,26 @@ describe('/exam-environment/', () => {\n         expect(res.status).toBe(403);\n       });\n     });\n+\n+    describe('GET /exam-environment/exam/attempt/:attemptId', () => {\n+      it('should return 403', async () => {\n+        const res = await superGet(\n+          `/exam-environment/exam/attempt/${mock.oid()}`\n+        ).set('exam-environment-authorization-token', 'invalid-token');\n+\n+        expect(res.status).toBe(403);\n+      });\n+    });\n+\n+    describe('GET /exam-environment/exam/attempts', () => {\n+      it('should return 403', async () => {\n+        const res = await superGet('/exam-environment/exam/attempts').set(\n+          'exam-environment-authorization-token',\n+          'invalid-token'\n+        );\n+\n+        expect(res.status).toBe(403);\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "e290010b3eda55824438485e5af1aa532e2f4932",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 341,
            "deletions": 90,
            "changes": 431,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -3,17 +3,19 @@ import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebo\n import fastifyMultipart from '@fastify/multipart';\n import { PrismaClientValidationError } from '@prisma/client/runtime/library';\n import { type FastifyInstance, type FastifyReply } from 'fastify';\n+import { ExamEnvironmentExamModerationStatus } from '@prisma/client';\n import jwt from 'jsonwebtoken';\n \n import * as schemas from '../schemas';\n import { mapErr, syncMapErr, UpdateReqType } from '../../utils';\n import { JWT_SECRET, SCREENSHOT_SERVICE_LOCATION } from '../../utils/env';\n import {\n   checkPrerequisites,\n+  constructEnvExamAttempt,\n   constructUserExam,\n   userAttemptToDatabaseAttemptQuestionSets,\n   validateAttempt\n-} from '../utils/exam';\n+} from '../utils/exam-environment';\n import { ERRORS } from '../utils/errors';\n import { isObjectID } from '../../utils/validation';\n \n@@ -45,6 +47,21 @@ export const examEnvironmentValidatedTokenRoutes: FastifyPluginCallbackTypebox =\n       },\n       postExamAttemptHandler\n     );\n+    fastify.get(\n+      '/exam-environment/exam/attempts',\n+      {\n+        schema: schemas.examEnvironmentGetExamAttempts\n+      },\n+      getExamAttemptsHandler\n+    );\n+    fastify.get(\n+      '/exam-environment/exam/attempt/:attemptId',\n+      {\n+        schema: schemas.examEnvironmentGetExamAttempt\n+      },\n+      getExamAttemptHandler\n+    );\n+\n     done();\n   };\n \n@@ -180,20 +197,21 @@ async function postExamGeneratedExamHandler(\n   // Get exam from DB\n   const examId = req.body.examId;\n   const maybeExam = await mapErr(\n-    this.prisma.envExam.findUnique({\n+    this.prisma.examEnvironmentExam.findUnique({\n       where: {\n         id: examId\n       }\n     })\n   );\n   if (maybeExam.hasError) {\n     if (maybeExam.error instanceof PrismaClientValidationError) {\n-      logger.warn({ examError: maybeExam.error }, 'Invalid exam id given.');\n+      logger.warn(maybeExam.error, 'Invalid exam id given.');\n       void reply.code(400);\n       return reply.send(ERRORS.FCC_EINVAL_EXAM_ID(maybeExam.error.message));\n     }\n \n-    logger.error({ examError: maybeExam.error });\n+    logger.error(maybeExam.error);\n+    this.Sentry.captureException(maybeExam.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExam.error))\n@@ -228,9 +246,10 @@ async function postExamGeneratedExamHandler(\n     );\n   }\n \n-  // Check user has not completed exam in last 24 hours\n+  // Check user has not completed exam within cooldown period, and\n+  // user does not have an existing attempt awaiting grading\n   const maybeExamAttempts = await mapErr(\n-    this.prisma.envExamAttempt.findMany({\n+    this.prisma.examEnvironmentExamAttempt.findMany({\n       where: {\n         userId: user.id,\n         examId: exam.id\n@@ -239,10 +258,8 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeExamAttempts.hasError) {\n-    logger.error(\n-      { examAttemptsError: maybeExamAttempts.error },\n-      'Unable to query exam attempts.'\n-    );\n+    logger.error(maybeExamAttempts.error, 'Unable to query exam attempts.');\n+    this.Sentry.captureException(maybeExamAttempts.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExamAttempts.error))\n@@ -258,6 +275,41 @@ async function postExamGeneratedExamHandler(\n     : null;\n \n   if (lastAttempt) {\n+    // Camper may not take the exam again, until the previous attempt is graded.\n+    const maybeMod = await mapErr(\n+      this.prisma.examEnvironmentExamModeration.findFirst({\n+        where: {\n+          examAttemptId: lastAttempt.id,\n+          status: ExamEnvironmentExamModerationStatus.Pending\n+        }\n+      })\n+    );\n+\n+    if (maybeMod.hasError) {\n+      logger.error(maybeMod.error);\n+      this.Sentry.captureException(maybeMod.error);\n+      void reply.code(500);\n+      return reply.send(\n+        ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeMod.error))\n+      );\n+    }\n+\n+    const moderation = maybeMod.data;\n+\n+    if (moderation !== null) {\n+      logger.warn(\n+        { examAttemptId: lastAttempt.id },\n+        'User has an exam attempt awaiting grading.'\n+      );\n+      void reply.code(403);\n+      return reply.send(\n+        // TODO: Better error type\n+        ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT(\n+          'User has an exam attempt awaiting grading.'\n+        )\n+      );\n+    }\n+\n     const examExpirationTime =\n       lastAttempt.startTimeInMS + exam.config.totalTimeInMS;\n     if (examExpirationTime < Date.now()) {\n@@ -282,35 +334,31 @@ async function postExamGeneratedExamHandler(\n       // This is most likely to happen if the Camper's app closes and is reopened.\n       // Send the Camper back to the exam they were working on.\n       const generated = await mapErr(\n-        this.prisma.envGeneratedExam.findFirst({\n+        this.prisma.examEnvironmentGeneratedExam.findFirst({\n           where: {\n             id: lastAttempt.generatedExamId\n           }\n         })\n       );\n \n       if (generated.hasError) {\n-        logger.error(\n-          { generatedError: generated.error },\n-          'Unable to query generated exam.'\n-        );\n+        logger.error(generated.error, 'Unable to query generated exam.');\n+        this.Sentry.captureException(generated.error);\n         void reply.code(500);\n         return reply.send(\n           ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(generated.error))\n         );\n       }\n \n       if (generated.data === null) {\n-        logger.error(\n-          { generatedExamId: lastAttempt.generatedExamId },\n-          'Generated exam not found.'\n-        );\n+        const error = {\n+          data: { generatedExamId: lastAttempt.generatedExamId },\n+          message: 'Unreachable. Generated exam not found.'\n+        };\n+        logger.error(error.data, error.message);\n+        this.Sentry.captureException(error.data);\n         void reply.code(500);\n-        return reply.send(\n-          ERRORS.FCC_ERR_EXAM_ENVIRONMENT(\n-            'Unreachable. Generated exam not found.'\n-          )\n-        );\n+        return reply.send(ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message));\n       }\n \n       const userExam = constructUserExam(generated.data, exam);\n@@ -324,7 +372,7 @@ async function postExamGeneratedExamHandler(\n \n   // Randomly pick a generated exam for user\n   const maybeGeneratedExams = await mapErr(\n-    this.prisma.envGeneratedExam.findMany({\n+    this.prisma.examEnvironmentGeneratedExam.findMany({\n       where: {\n         // Find generated exams user has not already seen\n         examId: exam.id,\n@@ -340,7 +388,8 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeGeneratedExams.hasError) {\n-    logger.error({ generatedExamsError: maybeGeneratedExams.error });\n+    logger.error(maybeGeneratedExams.error);\n+    this.Sentry.captureException(maybeGeneratedExams.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(maybeGeneratedExams.error)\n@@ -350,25 +399,30 @@ async function postExamGeneratedExamHandler(\n   const generatedExams = maybeGeneratedExams.data;\n \n   if (generatedExams.length === 0) {\n-    const errMessage = `Unable to provide a generated exam. Either all generated exams have been exhausted, or all generated exams are deprecated.`;\n-    logger.error({ examId: exam.id }, errMessage);\n+    const error = {\n+      data: { examId: exam.id },\n+      message: `Unable to provide a generated exam. Either all generated exams have been exhausted, or all generated exams are deprecated.`\n+    };\n+    logger.error(error.data, error.message);\n+    this.Sentry.captureException(error);\n     void reply.code(500);\n-    return reply.send(ERRORS.FCC_ERR_EXAM_ENVIRONMENT(errMessage));\n+    return reply.send(ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message));\n   }\n \n   const randomGeneratedExam =\n     generatedExams[Math.floor(Math.random() * generatedExams.length)]!;\n \n   const maybeGeneratedExam = await mapErr(\n-    this.prisma.envGeneratedExam.findFirst({\n+    this.prisma.examEnvironmentGeneratedExam.findFirst({\n       where: {\n         id: randomGeneratedExam.id\n       }\n     })\n   );\n \n   if (maybeGeneratedExam.hasError) {\n-    logger.error({ generatedExamError: maybeGeneratedExam.error });\n+    logger.error(maybeGeneratedExam.error);\n+    this.Sentry.captureException(maybeGeneratedExam.error);\n     void reply.code(500);\n     return reply.send(\n       // TODO: Consider more specific code\n@@ -382,32 +436,32 @@ async function postExamGeneratedExamHandler(\n   const generatedExam = maybeGeneratedExam.data;\n \n   if (generatedExam === null) {\n-    logger.error(\n-      { generatedExamId: randomGeneratedExam.id },\n-      'Generated exam not found.'\n-    );\n+    const error = {\n+      data: { generatedExamId: randomGeneratedExam.id },\n+      message: 'Unreachable. Generated exam not found.'\n+    };\n+    logger.error(error.data, 'Unreachable. Generated exam not found.');\n+    this.Sentry.captureException(error);\n     void reply.code(500);\n-    return reply.send(\n-      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(`Unable to locate generated exam.`)\n-    );\n+    return reply.send(ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message));\n   }\n \n   // Create exam attempt so, even if user disconnects, their attempt is still recorded:\n   const attempt = await mapErr(\n-    this.prisma.envExamAttempt.create({\n+    this.prisma.examEnvironmentExamAttempt.create({\n       data: {\n         userId: user.id,\n         examId: exam.id,\n         generatedExamId: generatedExam.id,\n         startTimeInMS: Date.now(),\n-        questionSets: [],\n-        needsRetake: false\n+        questionSets: []\n       }\n     })\n   );\n \n   if (attempt.hasError) {\n-    logger.error({ attemptError: attempt.error });\n+    logger.error(attempt.error);\n+    this.Sentry.captureException(attempt.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT_CREATE_EXAM_ATTEMPT(\n@@ -422,12 +476,14 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeUserExam.hasError) {\n-    logger.error({ userExamError: maybeUserExam.error });\n-    await this.prisma.envExamAttempt.delete({\n+    logger.error(maybeUserExam.error);\n+    // TODO: Consider handling this failing\n+    await this.prisma.examEnvironmentExamAttempt.delete({\n       where: {\n         id: attempt.data.id\n       }\n     });\n+    this.Sentry.captureException(maybeUserExam.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeUserExam.error))\n@@ -465,7 +521,7 @@ async function postExamAttemptHandler(\n   const user = req.user!;\n \n   const maybeAttempts = await mapErr(\n-    this.prisma.envExamAttempt.findMany({\n+    this.prisma.examEnvironmentExamAttempt.findMany({\n       where: {\n         examId: attempt.examId,\n         userId: user.id\n@@ -474,10 +530,8 @@ async function postExamAttemptHandler(\n   );\n \n   if (maybeAttempts.hasError) {\n-    logger.error(\n-      { error: maybeAttempts.error },\n-      'User attempt cannot be linked to an exam attempt.'\n-    );\n+    logger.error(maybeAttempts.error);\n+    this.Sentry.captureException(maybeAttempts.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempts.error))\n@@ -501,15 +555,18 @@ async function postExamAttemptHandler(\n   );\n \n   const maybeExam = await mapErr(\n-    this.prisma.envExam.findUnique({\n+    this.prisma.examEnvironmentExam.findUnique({\n       where: {\n         id: attempt.examId\n+      },\n+      select: {\n+        config: true\n       }\n     })\n   );\n \n   if (maybeExam.hasError) {\n-    logger.error({ examError: maybeExam.error });\n+    logger.error(maybeExam.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExam.error))\n@@ -544,15 +601,15 @@ async function postExamAttemptHandler(\n \n   // Get generated exam from database\n   const maybeGeneratedExam = await mapErr(\n-    this.prisma.envGeneratedExam.findUnique({\n+    this.prisma.examEnvironmentGeneratedExam.findUnique({\n       where: {\n         id: latestAttempt.generatedExamId\n       }\n     })\n   );\n \n   if (maybeGeneratedExam.hasError) {\n-    logger.error({ generatedExamError: maybeGeneratedExam.error });\n+    logger.error(maybeGeneratedExam.error);\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeGeneratedExam.error))\n@@ -583,26 +640,19 @@ async function postExamAttemptHandler(\n     validateAttempt(generatedExam, databaseAttemptQuestionSets)\n   );\n \n-  // Update attempt in database\n-  const maybeUpdatedAttempt = await mapErr(\n-    this.prisma.envExamAttempt.update({\n-      where: {\n-        id: latestAttempt.id\n-      },\n-      data: {\n-        questionSets: databaseAttemptQuestionSets,\n-        // If attempt is not valid, immediately flag attempt as needing retake\n-        // TODO: If `needsRetake`, prevent further submissions?\n-        needsRetake: maybeValidExamAttempt.hasError ? true : undefined\n-      }\n-    })\n-  );\n-\n   if (maybeValidExamAttempt.hasError) {\n     logger.warn(\n       { validExamAttemptError: maybeValidExamAttempt.error },\n       'Invalid exam attempt.'\n     );\n+    // As attempt is invalid, create moderation record to investigate\n+    await this.prisma.examEnvironmentExamModeration.create({\n+      data: {\n+        examAttemptId: latestAttempt.id,\n+        status: ExamEnvironmentExamModerationStatus.Pending\n+      }\n+    });\n+\n     void reply.code(400);\n     const message =\n       maybeValidExamAttempt.error instanceof Error\n@@ -611,6 +661,18 @@ async function postExamAttemptHandler(\n     return reply.send(ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT(message));\n   }\n \n+  // Update attempt in database\n+  const maybeUpdatedAttempt = await mapErr(\n+    this.prisma.examEnvironmentExamAttempt.update({\n+      where: {\n+        id: latestAttempt.id\n+      },\n+      data: {\n+        questionSets: databaseAttemptQuestionSets\n+      }\n+    })\n+  );\n+\n   if (maybeUpdatedAttempt.hasError) {\n     logger.error({ updatedAttemptError: maybeUpdatedAttempt.error });\n     void reply.code(500);\n@@ -657,28 +719,26 @@ async function postScreenshotHandler(\n     );\n   }\n \n-  const maybeAttempt = await mapErr(\n-    this.prisma.envExamAttempt.findMany({\n+  const maybeAttempts = await mapErr(\n+    this.prisma.examEnvironmentExamAttempt.findMany({\n       where: {\n         userId: user.id\n       }\n     })\n   );\n \n-  if (maybeAttempt.hasError) {\n-    logger.error(\n-      { error: maybeAttempt.error },\n-      'User screenshot cannot be linked to an exam attempt.'\n-    );\n+  if (maybeAttempts.hasError) {\n+    logger.error(maybeAttempts.error);\n+    this.Sentry.captureException(maybeAttempts.error);\n     void reply.code(500);\n     return reply.send(\n-      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempt.error))\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempts.error))\n     );\n   }\n \n-  const attempt = maybeAttempt.data;\n+  const attempts = maybeAttempts.data;\n \n-  if (attempt.length === 0) {\n+  if (attempts.length === 0) {\n     logger.warn('No exam attempts found for user.');\n     void reply.code(404);\n     return reply.send(\n@@ -688,6 +748,64 @@ async function postScreenshotHandler(\n     );\n   }\n \n+  const latestAttempt = attempts.reduce((latest, current) =>\n+    latest.startTimeInMS > current.startTimeInMS ? latest : current\n+  );\n+\n+  const maybeExam = await mapErr(\n+    this.prisma.examEnvironmentExam.findUnique({\n+      where: {\n+        id: latestAttempt.examId\n+      },\n+      select: {\n+        id: true,\n+        config: true\n+      }\n+    })\n+  );\n+\n+  if (maybeExam.hasError) {\n+    logger.error(maybeExam.error);\n+    this.Sentry.captureException(maybeExam.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExam.error))\n+    );\n+  }\n+\n+  const exam = maybeExam.data;\n+\n+  if (exam === null) {\n+    const error = {\n+      data: {\n+        examId: latestAttempt.examId,\n+        attemptId: latestAttempt.id\n+      },\n+      message: 'Unreachable. Attempt could not be related to an exam.'\n+    };\n+    logger.error(error.data, error.message);\n+    this.Sentry.captureException(error.data);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_MISSING_EXAM(error.message)\n+    );\n+  }\n+\n+  const isAttemptExpired =\n+    latestAttempt.startTimeInMS + exam.config.totalTimeInMS < Date.now();\n+  if (isAttemptExpired) {\n+    logger.warn(\n+      { examAttemptId: latestAttempt.id },\n+      'Attempt has exceeded submission time.'\n+    );\n+    void reply.code(403);\n+    return reply.send(\n+      ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT(\n+        'Attempt has exceeded submission time.'\n+      )\n+    );\n+  }\n+\n   const imgBinary = await imgData.toBuffer();\n \n   // Verify image is JPG using magic number\n@@ -703,7 +821,7 @@ async function postScreenshotHandler(\n \n   const uploadData = {\n     image: imgBinary.toString('base64'),\n-    examAttemptId: attempt[0]?.id\n+    examAttemptId: latestAttempt.id\n   };\n \n   await fetch(`${SCREENSHOT_SERVICE_LOCATION}/upload`, {\n@@ -724,16 +842,29 @@ async function getExams(\n   logger.info({ user: req.user });\n \n   const user = req.user!;\n-  const exams = await this.prisma.envExam.findMany({\n-    where: {\n-      deprecated: false\n-    },\n-    select: {\n-      id: true,\n-      config: true,\n-      prerequisites: true\n-    }\n-  });\n+  const maybeExams = await mapErr(\n+    this.prisma.examEnvironmentExam.findMany({\n+      where: {\n+        deprecated: false\n+      },\n+      select: {\n+        id: true,\n+        config: true,\n+        prerequisites: true\n+      }\n+    })\n+  );\n+\n+  if (maybeExams.hasError) {\n+    logger.error(maybeExams.error);\n+    this.Sentry.captureException(maybeExams.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExams.error))\n+    );\n+  }\n+\n+  const exams = maybeExams.data;\n \n   const availableExams = exams.map(exam => {\n     const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n@@ -744,7 +875,8 @@ async function getExams(\n         name: exam.config.name,\n         note: exam.config.note,\n         totalTimeInMS: exam.config.totalTimeInMS,\n-        retakeTimeInMS: exam.config.retakeTimeInMS\n+        retakeTimeInMS: exam.config.retakeTimeInMS,\n+        passingPercent: exam.config.passingPercent\n       },\n       canTake: isExamPrerequisitesMet\n     };\n@@ -754,3 +886,122 @@ async function getExams(\n     exams: availableExams\n   });\n }\n+\n+/**\n+ * Gets all exam attempts owned by authz user.\n+ *\n+ * If an attempt is completed, the result is included.\n+ */\n+async function getExamAttemptsHandler(\n+  this: FastifyInstance,\n+  req: UpdateReqType<typeof schemas.examEnvironmentGetExamAttempts>,\n+  reply: FastifyReply\n+) {\n+  const logger = this.log.child({ req });\n+  logger.info({ userId: req.user?.id });\n+\n+  const user = req.user!;\n+\n+  // Send all relevant exam attempts\n+  const envExamAttempts = [];\n+  const maybeAttempts = await mapErr(\n+    this.prisma.examEnvironmentExamAttempt.findMany({\n+      where: {\n+        userId: user.id\n+      }\n+    })\n+  );\n+\n+  if (maybeAttempts.hasError) {\n+    logger.error(maybeAttempts.error);\n+    this.Sentry.captureException(maybeAttempts.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempts.error))\n+    );\n+  }\n+\n+  const attempts = maybeAttempts.data;\n+\n+  if (!attempts.length) {\n+    logger.warn({ userId: user.id }, 'No exam attempts found.');\n+    void reply.code(404);\n+    return reply.send(\n+      ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT('No exam attempt found.')\n+    );\n+  }\n+\n+  for (const attempt of attempts) {\n+    const { error, examEnvironmentExamAttempt } = await constructEnvExamAttempt(\n+      this,\n+      attempt,\n+      logger\n+    );\n+    if (error) {\n+      void reply.code(error.code);\n+      return reply.send(error.data);\n+    }\n+    envExamAttempts.push(examEnvironmentExamAttempt);\n+  }\n+\n+  return reply.send(envExamAttempts);\n+}\n+\n+/**\n+ * Gets the requested exam attempt by id owned by authz user.\n+ *\n+ * If the attempt is completed, the result is included.\n+ */\n+async function getExamAttemptHandler(\n+  this: FastifyInstance,\n+  req: UpdateReqType<typeof schemas.examEnvironmentGetExamAttempt>,\n+  reply: FastifyReply\n+) {\n+  const logger = this.log.child({ req });\n+  logger.info({ userId: req.user?.id });\n+\n+  const user = req.user!;\n+  const { attemptId } = req.params;\n+\n+  // If attempt id is given, only return that attempt\n+  const maybeAttempt = await mapErr(\n+    this.prisma.examEnvironmentExamAttempt.findUnique({\n+      where: {\n+        id: attemptId,\n+        userId: user.id\n+      }\n+    })\n+  );\n+\n+  if (maybeAttempt.hasError) {\n+    logger.error(maybeAttempt.error);\n+    this.Sentry.captureException(maybeAttempt.error);\n+    void reply.code(500);\n+    return reply.send(\n+      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempt.error))\n+    );\n+  }\n+\n+  const attempt = maybeAttempt.data;\n+\n+  if (!attempt) {\n+    logger.warn({ attemptId }, 'No exam attempt found.');\n+    void reply.code(404);\n+    return reply.send(\n+      ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT('No exam attempt found.')\n+    );\n+  }\n+\n+  const { error, examEnvironmentExamAttempt } = await constructEnvExamAttempt(\n+    this,\n+    attempt,\n+    logger\n+  );\n+\n+  if (error) {\n+    void reply.code(error.code);\n+    return reply.send(error.data);\n+  }\n+\n+  return reply.send(examEnvironmentExamAttempt);\n+}"
        },
        {
            "sha": "e7ceb75c30ecc1c2fc6e6195d17cb3d2a51fe192",
            "filename": "api/src/exam-environment/schemas/exam-attempt.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8eee5ca8bfd79f47f1283c5756ff677c537fe3da/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-attempt.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8eee5ca8bfd79f47f1283c5756ff677c537fe3da/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-attempt.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-attempt.ts?ref=8eee5ca8bfd79f47f1283c5756ff677c537fe3da",
            "patch": "@@ -1,31 +0,0 @@\n-import { Type } from '@fastify/type-provider-typebox';\n-import { STANDARD_ERROR } from '../utils/errors';\n-\n-export const examEnvironmentPostExamAttempt = {\n-  body: Type.Object({\n-    attempt: Type.Object({\n-      examId: Type.String(),\n-      questionSets: Type.Array(\n-        Type.Object({\n-          id: Type.String(),\n-          questions: Type.Array(\n-            Type.Object({\n-              id: Type.String(),\n-              answers: Type.Array(Type.String())\n-            })\n-          )\n-        })\n-      )\n-    })\n-  }),\n-  headers: Type.Object({\n-    'exam-environment-authorization-token': Type.String()\n-  }),\n-  response: {\n-    // An empty 200 response cannot be typed \n-    400: STANDARD_ERROR,\n-    403: STANDARD_ERROR,\n-    404: STANDARD_ERROR,\n-    500: STANDARD_ERROR\n-  }\n-};"
        },
        {
            "sha": "ac036ed066531d8bf16e31cad864f2282b37a5a5",
            "filename": "api/src/exam-environment/schemas/exam-environment-exam-attempt.ts",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-attempt.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -0,0 +1,73 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+import { STANDARD_ERROR } from '../utils/errors';\n+\n+export const examEnvironmentPostExamAttempt = {\n+  body: Type.Object({\n+    attempt: Type.Object({\n+      examId: Type.String({ format: 'objectid' }),\n+      questionSets: Type.Array(\n+        Type.Object({\n+          id: Type.String({ format: 'objectid' }),\n+          questions: Type.Array(\n+            Type.Object({\n+              id: Type.String({ format: 'objectid' }),\n+              answers: Type.Array(Type.String({ format: 'objectid' }))\n+            })\n+          )\n+        })\n+      )\n+    })\n+  }),\n+  headers: Type.Object({\n+    'exam-environment-authorization-token': Type.String()\n+  }),\n+  response: {\n+    default: STANDARD_ERROR\n+  }\n+};\n+\n+const examEnvAttempt = Type.Object({\n+  startTimeInMS: Type.Number(),\n+  questionSets: Type.Array(\n+    Type.Object({\n+      id: Type.String(),\n+      questions: Type.Array(\n+        Type.Object({\n+          id: Type.String(),\n+          answers: Type.Array(Type.String()),\n+          submissionTimeInMS: Type.Number()\n+        })\n+      )\n+    })\n+  ),\n+  result: Type.Union([\n+    Type.Null(),\n+    Type.Object({\n+      score: Type.Number(),\n+      passingPercent: Type.Number()\n+    })\n+  ])\n+});\n+\n+export const examEnvironmentGetExamAttempts = {\n+  headers: Type.Object({\n+    'exam-environment-authorization-token': Type.String()\n+  }),\n+  response: {\n+    200: Type.Array(examEnvAttempt),\n+    default: STANDARD_ERROR\n+  }\n+};\n+\n+export const examEnvironmentGetExamAttempt = {\n+  params: Type.Object({\n+    attemptId: Type.String({ format: 'objectid' })\n+  }),\n+  headers: Type.Object({\n+    'exam-environment-authorization-token': Type.String()\n+  }),\n+  response: {\n+    200: examEnvAttempt,\n+    default: STANDARD_ERROR\n+  }\n+};"
        },
        {
            "sha": "4e3ba3926d598f010875bdbc1dfec1ee60f94f1f",
            "filename": "api/src/exam-environment/schemas/exam-environment-exam-generated-exam.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-generated-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-generated-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exam-generated-exam.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "previous_filename": "api/src/exam-environment/schemas/exam-generated-exam.ts"
        },
        {
            "sha": "ed386b9a3470fccaf5dd2160f78385a65b927f10",
            "filename": "api/src/exam-environment/schemas/exam-environment-exams.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-environment-exams.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -13,7 +13,8 @@ export const examEnvironmentExams = {\n             name: Type.String(),\n             note: Type.String(),\n             totalTimeInMS: Type.Number(),\n-            retakeTimeInMS: Type.Number()\n+            retakeTimeInMS: Type.Number(),\n+            passingPercent: Type.Number()\n           }),\n           canTake: Type.Boolean()\n         })",
            "previous_filename": "api/src/exam-environment/schemas/exams.ts"
        },
        {
            "sha": "743edd6bd7374fbd1f24f2260fbb6db4f287afb4",
            "filename": "api/src/exam-environment/schemas/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,5 +1,9 @@\n-export { examEnvironmentPostExamAttempt } from './exam-attempt';\n-export { examEnvironmentPostExamGeneratedExam } from './exam-generated-exam';\n+export {\n+  examEnvironmentPostExamAttempt,\n+  examEnvironmentGetExamAttempts,\n+  examEnvironmentGetExamAttempt\n+} from './exam-environment-exam-attempt';\n+export { examEnvironmentPostExamGeneratedExam } from './exam-environment-exam-generated-exam';\n export { examEnvironmentPostScreenshot } from './screenshot';\n export { examEnvironmentTokenMeta } from './token-meta';\n-export { examEnvironmentExams } from './exams';\n+export { examEnvironmentExams } from './exam-environment-exams';"
        },
        {
            "sha": "2d0099ffaed9b2e8f52e42c37ea5a22aa815b335",
            "filename": "api/src/exam-environment/utils/errors.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Futils%2Ferrors.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Futils%2Ferrors.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Ferrors.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -27,6 +27,10 @@ export const ERRORS = {\n     'FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT',\n     '%s'\n   ),\n+  FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT: createError(\n+    'FCC_ENOENT_EXAM_ENVIRONMENT_EXAM_ATTEMPT',\n+    '%s'\n+  ),\n   FCC_ERR_EXAM_ENVIRONMENT_EXAM_ATTEMPT: createError(\n     'FCC_ERR_EXAM_ENVIRONMENT_EXAM_ATTEMPT',\n     '%s'"
        },
        {
            "sha": "dd5ba9ec876be8b0e10cd04a1c1d196907111d0f",
            "filename": "api/src/exam-environment/utils/exam-environment.test.ts",
            "status": "renamed",
            "additions": 79,
            "deletions": 3,
            "changes": 82,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,14 +1,20 @@\n+import { ExamEnvironmentAnswer } from '@prisma/client';\n import { type Static } from '@fastify/type-provider-typebox';\n-import { exam, examAttempt, generatedExam } from '../../../__mocks__/env-exam';\n+import {\n+  exam,\n+  examAttempt,\n+  generatedExam\n+} from '../../../__mocks__/exam-environment-exam';\n import * as schemas from '../schemas';\n import {\n   checkAttemptAgainstGeneratedExam,\n   checkPrerequisites,\n   constructUserExam,\n   generateExam,\n   userAttemptToDatabaseAttemptQuestionSets,\n-  validateAttempt\n-} from './exam';\n+  validateAttempt,\n+  compareAnswers\n+} from './exam-environment';\n \n // NOTE: Whilst the tests could be run against a single generation of exam,\n //       it is more useful to run the tests against a new generation each time.\n@@ -308,4 +314,74 @@ describe('Exam Environment', () => {\n       );\n     });\n   });\n+\n+  describe('compareAnswers()', () => {\n+    it('should return true when only all correct answers are attempted', () => {\n+      const examAnswers: ExamEnvironmentAnswer[] = [\n+        {\n+          id: '0',\n+          isCorrect: true,\n+          text: ''\n+        },\n+        {\n+          id: '1',\n+          isCorrect: true,\n+          text: ''\n+        },\n+        {\n+          id: '2',\n+          isCorrect: false,\n+          text: ''\n+        },\n+        {\n+          id: '3',\n+          isCorrect: false,\n+          text: ''\n+        }\n+      ];\n+      const generatedAnswers = ['0', '1', '2', '3'];\n+      const attemptAnswers = ['0', '1'];\n+      const isCorrect = compareAnswers(\n+        examAnswers,\n+        generatedAnswers,\n+        attemptAnswers\n+      );\n+\n+      expect(isCorrect).toBe(true);\n+    });\n+\n+    it('should return false when any incorrect answers are attempted', () => {\n+      const examAnswers: ExamEnvironmentAnswer[] = [\n+        {\n+          id: '0',\n+          isCorrect: true,\n+          text: ''\n+        },\n+        {\n+          id: '1',\n+          isCorrect: true,\n+          text: ''\n+        },\n+        {\n+          id: '2',\n+          isCorrect: false,\n+          text: ''\n+        },\n+        {\n+          id: '3',\n+          isCorrect: false,\n+          text: ''\n+        }\n+      ];\n+      const generatedAnswers = ['0', '1', '2', '3'];\n+      const attemptAnswers = ['0', '2'];\n+      const isCorrect = compareAnswers(\n+        examAnswers,\n+        generatedAnswers,\n+        attemptAnswers\n+      );\n+\n+      expect(isCorrect).toBe(false);\n+    });\n+  });\n });",
            "previous_filename": "api/src/exam-environment/utils/exam.test.ts"
        },
        {
            "sha": "2bc55893c42c8b29e4eb999ac9651188794003c6",
            "filename": "api/src/exam-environment/utils/exam-environment.ts",
            "status": "renamed",
            "additions": 321,
            "deletions": 32,
            "changes": 353,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -2,17 +2,24 @@\n /* eslint-disable @typescript-eslint/only-throw-error */\n /* eslint-disable jsdoc/require-returns, jsdoc/require-param */\n import {\n-  EnvAnswer,\n-  EnvConfig,\n-  EnvExam,\n-  EnvExamAttempt,\n-  EnvGeneratedExam,\n-  EnvMultipleChoiceQuestion,\n-  EnvQuestionSet,\n-  EnvQuestionSetAttempt\n+  ExamEnvironmentAnswer,\n+  ExamEnvironmentConfig,\n+  ExamEnvironmentExam,\n+  ExamEnvironmentExamAttempt,\n+  ExamEnvironmentExamModerationStatus,\n+  ExamEnvironmentGeneratedExam,\n+  ExamEnvironmentGeneratedMultipleChoiceQuestion,\n+  ExamEnvironmentMultipleChoiceQuestion,\n+  ExamEnvironmentMultipleChoiceQuestionAttempt,\n+  ExamEnvironmentQuestionSet,\n+  ExamEnvironmentQuestionSetAttempt\n } from '@prisma/client';\n+import type { FastifyBaseLogger, FastifyInstance } from 'fastify';\n import { type Static } from '@fastify/type-provider-typebox';\n+import { omit } from 'lodash';\n import * as schemas from '../schemas';\n+import { mapErr } from '../../utils';\n+import { ERRORS } from './errors';\n \n interface CompletedChallengeId {\n   completedChallenges: {\n@@ -25,24 +32,24 @@ interface CompletedChallengeId {\n  */\n export function checkPrerequisites(\n   user: CompletedChallengeId,\n-  prerequisites: EnvExam['prerequisites']\n+  prerequisites: ExamEnvironmentExam['prerequisites']\n ) {\n   return prerequisites.every(p =>\n     user.completedChallenges.some(c => c.id === p)\n   );\n }\n \n export type UserExam = Omit<\n-  EnvExam,\n+  ExamEnvironmentExam,\n   'questionSets' | 'config' | 'id' | 'prerequisites' | 'deprecated'\n > & {\n-  config: Omit<EnvExam['config'], 'tags' | 'questionSets'>;\n-  questionSets: (Omit<EnvQuestionSet, 'questions'> & {\n+  config: Omit<ExamEnvironmentExam['config'], 'tags' | 'questionSets'>;\n+  questionSets: (Omit<ExamEnvironmentQuestionSet, 'questions'> & {\n     questions: (Omit<\n-      EnvMultipleChoiceQuestion,\n+      ExamEnvironmentMultipleChoiceQuestion,\n       'answers' | 'tags' | 'deprecated'\n     > & {\n-      answers: Omit<EnvAnswer, 'isCorrect'>[];\n+      answers: Omit<ExamEnvironmentAnswer, 'isCorrect'>[];\n     })[];\n   })[];\n } & { generatedExamId: string; examId: string };\n@@ -51,8 +58,8 @@ export type UserExam = Omit<\n  * Takes the generated exam and the original exam, and creates the user-facing exam.\n  */\n export function constructUserExam(\n-  generatedExam: EnvGeneratedExam,\n-  exam: EnvExam\n+  generatedExam: ExamEnvironmentGeneratedExam,\n+  exam: ExamEnvironmentExam\n ): UserExam {\n   // Map generated exam to user exam (a.k.a. public exam information for user)\n   const userQuestionSets = generatedExam.questionSets.map(gqs => {\n@@ -104,7 +111,8 @@ export function constructUserExam(\n     totalTimeInMS: exam.config.totalTimeInMS,\n     name: exam.config.name,\n     note: exam.config.note,\n-    retakeTimeInMS: exam.config.retakeTimeInMS\n+    retakeTimeInMS: exam.config.retakeTimeInMS,\n+    passingPercent: exam.config.passingPercent\n   };\n \n   const userExam: UserExam = {\n@@ -121,8 +129,8 @@ export function constructUserExam(\n  * Ensures all questions and answers in the attempt are from the generated exam.\n  */\n export function validateAttempt(\n-  generatedExam: EnvGeneratedExam,\n-  questionSets: EnvExamAttempt['questionSets']\n+  generatedExam: ExamEnvironmentGeneratedExam,\n+  questionSets: ExamEnvironmentExamAttempt['questionSets']\n ) {\n   for (const attemptQuestionSet of questionSets) {\n     const generatedQuestionSet = generatedExam.questionSets.find(\n@@ -170,8 +178,8 @@ export function validateAttempt(\n  * @returns Whether or not the attempt can be considered finished.\n  */\n export function checkAttemptAgainstGeneratedExam(\n-  questionSets: EnvQuestionSetAttempt[],\n-  generatedExam: Pick<EnvGeneratedExam, 'questionSets'>\n+  questionSets: ExamEnvironmentQuestionSetAttempt[],\n+  generatedExam: Pick<ExamEnvironmentGeneratedExam, 'questionSets'>\n ): boolean {\n   // Check all question sets and questions are in generated exam\n   for (const generatedQuestionSet of generatedExam.questionSets) {\n@@ -215,9 +223,10 @@ export function userAttemptToDatabaseAttemptQuestionSets(\n   userAttempt: Static<\n     typeof schemas.examEnvironmentPostExamAttempt.body.properties.attempt\n   >,\n-  latestAttempt: EnvExamAttempt\n-): EnvExamAttempt['questionSets'] {\n-  const databaseAttemptQuestionSets: EnvExamAttempt['questionSets'] = [];\n+  latestAttempt: ExamEnvironmentExamAttempt\n+): ExamEnvironmentExamAttempt['questionSets'] {\n+  const databaseAttemptQuestionSets: ExamEnvironmentExamAttempt['questionSets'] =\n+    [];\n \n   for (const questionSet of userAttempt.questionSets) {\n     const latestQuestionSet = latestAttempt.questionSets.find(\n@@ -266,7 +275,9 @@ export function userAttemptToDatabaseAttemptQuestionSets(\n /**\n  * Generates an exam for the user, based on the exam configuration.\n  */\n-export function generateExam(exam: EnvExam): Omit<EnvGeneratedExam, 'id'> {\n+export function generateExam(\n+  exam: ExamEnvironmentExam\n+): Omit<ExamEnvironmentGeneratedExam, 'id'> {\n   const examCopy = structuredClone(exam);\n \n   const TIMEOUT_IN_MS = 5_000;\n@@ -298,7 +309,7 @@ export function generateExam(exam: EnvExam): Omit<EnvGeneratedExam, 'id'> {\n       acc[typeIndex]?.push(curr) ?? acc.push([curr]);\n       return acc;\n     },\n-    [] as unknown as [EnvConfig['questionSets']]\n+    [] as unknown as [ExamEnvironmentConfig['questionSets']]\n   );\n \n   // Heuristic:\n@@ -316,7 +327,7 @@ export function generateExam(exam: EnvExam): Omit<EnvGeneratedExam, 'id'> {\n   const questionSetsConfigWithQuestions = sortedQuestionSetsConfig.map(qsc => {\n     return {\n       ...qsc,\n-      questionSets: [] as EnvQuestionSet[]\n+      questionSets: [] as ExamEnvironmentQuestionSet[]\n     };\n   });\n \n@@ -575,9 +586,107 @@ export function generateExam(exam: EnvExam): Omit<EnvGeneratedExam, 'id'> {\n   };\n }\n \n+/**\n+ * Calculates the number of correct questions over the number of the total questions given for an attempt.\n+ * @returns The score of the exam attempt as a percentage.\n+ */\n+export function calculateScore(\n+  exam: ExamEnvironmentExam,\n+  generatedExam: ExamEnvironmentGeneratedExam,\n+  attempt: ExamEnvironmentExamAttempt\n+) {\n+  const attemptQuestionSets = attempt.questionSets;\n+  const generatedQuestionSets = generatedExam.questionSets;\n+\n+  const totalQuestions = generatedQuestionSets.reduce(\n+    (total, attemptQuestionSet) => total + attemptQuestionSet.questions.length,\n+    0\n+  );\n+  let correctQuestions = 0;\n+  for (const attemptQuestionSet of attemptQuestionSets) {\n+    const examQuestionSet = exam.questionSets.find(\n+      ({ id }) => id === attemptQuestionSet.id\n+    );\n+    if (!examQuestionSet) {\n+      throw new Error(\n+        `Attempt question set ${attemptQuestionSet.id} must exist in exam ${exam.id}`\n+      );\n+    }\n+\n+    const generatedQuestionSet = generatedQuestionSets.find(\n+      ({ id }) => id === attemptQuestionSet.id\n+    );\n+    if (!generatedQuestionSet) {\n+      throw new Error(\n+        `Generated question set ${attemptQuestionSet.id} must exist in generated exam ${generatedExam.id}`\n+      );\n+    }\n+\n+    const attemptQuestions = attemptQuestionSet.questions;\n+    const examQuestions = examQuestionSet.questions;\n+    const generatedQuestions = generatedQuestionSet.questions;\n+    for (const attemptQuestion of attemptQuestions) {\n+      const examQuestion = examQuestions.find(\n+        ({ id }) => id === attemptQuestion.id\n+      );\n+      if (!examQuestion) {\n+        throw new Error(\n+          `Attempt question ${attemptQuestion.id} must exist in exam ${exam.id}`\n+        );\n+      }\n+\n+      const generatedQuestion = generatedQuestions.find(\n+        ({ id }) => id === attemptQuestion.id\n+      );\n+      if (!generatedQuestion) {\n+        throw new Error(\n+          `Generated question ${attemptQuestion.id} must exist in generated exam ${generatedExam.id}`\n+        );\n+      }\n+\n+      const isQuestionCorrect = compareAnswers(\n+        examQuestion.answers,\n+        generatedQuestion.answers,\n+        attemptQuestion.answers\n+      );\n+\n+      if (isQuestionCorrect) {\n+        correctQuestions += 1;\n+      }\n+    }\n+  }\n+\n+  return (correctQuestions / totalQuestions) * 100;\n+}\n+\n+/**\n+ * NOTE: The answers of an attempt is an array for future-proofing when\n+ * checkbox questions are needed.\n+ *\n+ * This calculation takes x / y , x < y as wholey incorrect.\n+ */\n+export function compareAnswers(\n+  examAnswers: ExamEnvironmentAnswer[],\n+  generatedAnswers: ExamEnvironmentGeneratedMultipleChoiceQuestion['answers'],\n+  attemptAnswers: ExamEnvironmentMultipleChoiceQuestionAttempt['answers']\n+): boolean {\n+  const correctGeneratedAnswers = generatedAnswers.filter(generatedAnswer => {\n+    return examAnswers.some(\n+      examAnswer => examAnswer.isCorrect && examAnswer.id === generatedAnswer\n+    );\n+  });\n+  // Check every attempt question answer == every generated question answer\n+  const isQuestionCorrect =\n+    correctGeneratedAnswers.every(correctAnswer =>\n+      attemptAnswers.includes(correctAnswer)\n+    ) && correctGeneratedAnswers.length == attemptAnswers.length;\n+\n+  return isQuestionCorrect;\n+}\n+\n function isQuestionSetConfigFulfilled(\n-  questionSetConfig: EnvConfig['questionSets'][number] & {\n-    questionSets: EnvQuestionSet[];\n+  questionSetConfig: ExamEnvironmentConfig['questionSets'][number] & {\n+    questionSets: ExamEnvironmentQuestionSet[];\n   }\n ) {\n   return (\n@@ -592,9 +701,9 @@ function isQuestionSetConfigFulfilled(\n  * Gets random answers for a question.\n  */\n function getRandomAnswers(\n-  question: EnvMultipleChoiceQuestion,\n-  questionSetConfig: EnvConfig['questionSets'][number]\n-): EnvMultipleChoiceQuestion['answers'] {\n+  question: ExamEnvironmentMultipleChoiceQuestion,\n+  questionSetConfig: ExamEnvironmentConfig['questionSets'][number]\n+): ExamEnvironmentMultipleChoiceQuestion['answers'] {\n   const { numberOfCorrectAnswers, numberOfIncorrectAnswers } =\n     questionSetConfig;\n \n@@ -641,3 +750,183 @@ function shuffleArray<T>(array: Array<T>) {\n   return array;\n }\n /* eslint-enable jsdoc/require-description-complete-sentence */\n+\n+/**\n+ * From an exam attempt, construct the attempt with result (if ready).\n+ *\n+ * @param fastify - Fastify instance.\n+ * @param attempt - The exam attempt.\n+ * @param logger - Logger instance.\n+ * @returns The exam attempt with result or an error.\n+ */\n+export async function constructEnvExamAttempt(\n+  fastify: FastifyInstance,\n+  attempt: ExamEnvironmentExamAttempt,\n+  logger: FastifyBaseLogger\n+) {\n+  const maybeExam = await mapErr(\n+    fastify.prisma.examEnvironmentExam.findUnique({\n+      where: {\n+        id: attempt.examId\n+      }\n+    })\n+  );\n+\n+  if (maybeExam.hasError) {\n+    logger.error(maybeExam.error);\n+    fastify.Sentry.captureException(maybeExam.error);\n+    return {\n+      error: {\n+        code: 500,\n+        data: ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExam.error))\n+      }\n+    };\n+  }\n+\n+  const exam = maybeExam.data;\n+\n+  if (exam === null) {\n+    const error = {\n+      data: { examId: attempt.examId, attemptId: attempt.id },\n+      message: 'Unreachable. Invalid exam id in attempt.'\n+    };\n+    logger.error(error.data, error.message);\n+    fastify.Sentry.captureException(error);\n+\n+    return {\n+      error: {\n+        code: 500,\n+        data: ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_MISSING_EXAM(error.message)\n+      }\n+    };\n+  }\n+\n+  // If attempt is still in progress, return without result\n+  const isAttemptExpired =\n+    attempt.startTimeInMS + exam.config.totalTimeInMS < Date.now();\n+  if (!isAttemptExpired) {\n+    return {\n+      examEnvironmentExamAttempt: {\n+        ...omitAttemptReferenceIds(attempt),\n+        result: null\n+      },\n+      error: null\n+    };\n+  }\n+\n+  const maybeMod = await mapErr(\n+    fastify.prisma.examEnvironmentExamModeration.findFirst({\n+      where: {\n+        examAttemptId: attempt.id\n+      }\n+    })\n+  );\n+\n+  if (maybeMod.hasError) {\n+    logger.error(maybeMod.error);\n+    fastify.Sentry.captureException(maybeMod.error);\n+    return {\n+      error: {\n+        code: 500,\n+        data: ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeMod.error))\n+      }\n+    };\n+  }\n+\n+  const moderation = maybeMod.data;\n+\n+  if (moderation === null) {\n+    const error = {\n+      data: { examAttemptId: attempt.id },\n+      message:\n+        'Unreachable. ExamModeration record should exist for expired attempt'\n+    };\n+    logger.error(error.data, error.message);\n+    fastify.Sentry.captureException(error);\n+    return {\n+      error: {\n+        code: 500,\n+        data: ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message)\n+      }\n+    };\n+  }\n+\n+  // If attempt is completed, but has not been graded, return without result\n+  if (moderation.status === ExamEnvironmentExamModerationStatus.Pending) {\n+    return {\n+      examEnvironmentExamAttempt: {\n+        ...omitAttemptReferenceIds(attempt),\n+        result: null\n+      },\n+      error: null\n+    };\n+  }\n+\n+  // If attempt is completed, but has been determined to need a retake\n+  // TODO: Send moderation.feedback?\n+  if (moderation.status === ExamEnvironmentExamModerationStatus.Denied) {\n+    return {\n+      examEnvironmentExamAttempt: {\n+        ...omitAttemptReferenceIds(attempt),\n+        result: null\n+      },\n+      error: null\n+    };\n+  }\n+\n+  const maybeGeneratedExam = await mapErr(\n+    fastify.prisma.examEnvironmentGeneratedExam.findUnique({\n+      where: {\n+        id: attempt.generatedExamId\n+      }\n+    })\n+  );\n+\n+  if (maybeGeneratedExam.hasError) {\n+    logger.error(maybeGeneratedExam.error);\n+    fastify.Sentry.captureException(maybeGeneratedExam.error);\n+    return {\n+      error: {\n+        code: 500,\n+        data: ERRORS.FCC_ERR_EXAM_ENVIRONMENT(\n+          JSON.stringify(maybeGeneratedExam.error)\n+        )\n+      }\n+    };\n+  }\n+\n+  const generatedExam = maybeGeneratedExam.data;\n+\n+  if (!generatedExam) {\n+    const error = {\n+      data: { attemptId: attempt.id, generatedExamId: attempt.generatedExamId },\n+      message:\n+        'Unreachable. Unable to find generated exam associated with exam attempt'\n+    };\n+    logger.error(error.data, error.message);\n+    fastify.Sentry.captureException(error);\n+    return {\n+      error: {\n+        code: 500,\n+        data: ERRORS.FCC_ERR_EXAM_ENVIRONMENT(error.message)\n+      }\n+    };\n+  }\n+\n+  const score = calculateScore(exam, generatedExam, attempt);\n+\n+  const result = {\n+    score,\n+    passingPercent: exam.config.passingPercent\n+  };\n+\n+  const examEnvironmentExamAttempt = {\n+    ...omitAttemptReferenceIds(attempt),\n+    result\n+  };\n+  return { error: null, examEnvironmentExamAttempt };\n+}\n+\n+function omitAttemptReferenceIds(attempt: ExamEnvironmentExamAttempt) {\n+  return omit(attempt, ['examId', 'id', 'generatedExamId', 'userId']);\n+}",
            "previous_filename": "api/src/exam-environment/utils/exam.ts"
        },
        {
            "sha": "4ae9bbce94ffec9659313f025338e552ac91b74d",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -23,7 +23,7 @@ import {\n   seedEnvExam,\n   seedEnvExamAttempt,\n   seedExamEnvExamAuthToken\n-} from '../../../__mocks__/env-exam';\n+} from '../../../__mocks__/exam-environment-exam';\n import { getMsTranscriptApiUrl } from './user';\n \n const mockedFetch = jest.fn();\n@@ -441,13 +441,13 @@ describe('userRoutes', () => {\n         await seedEnvExam();\n         await seedEnvExamAttempt();\n         const countBefore =\n-          await fastifyTestInstance.prisma.envExamAttempt.count();\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.count();\n         expect(countBefore).toBe(1);\n \n         const res = await superPost('/account/delete');\n \n         const countAfter =\n-          await fastifyTestInstance.prisma.envExamAttempt.count();\n+          await fastifyTestInstance.prisma.examEnvironmentExamAttempt.count();\n         expect(countAfter).toBe(0);\n         expect(res.status).toBe(200);\n       });"
        },
        {
            "sha": "081dad1b53d78a947c56e447cc7ffd52336fd02a",
            "filename": "api/tools/exam-environment/generate/deprecate.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fgenerate%2Fdeprecate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fgenerate%2Fdeprecate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Ftools%2Fexam-environment%2Fgenerate%2Fdeprecate.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -22,7 +22,7 @@ async function main() {\n   console.info('Connected.');\n \n   try {\n-    await prisma.envExam.update({\n+    await prisma.examEnvironmentExam.update({\n       where: {\n         id: ENV_EXAM_ID\n       },\n@@ -31,7 +31,7 @@ async function main() {\n       }\n     });\n     console.info(`Exam \"${ENV_EXAM_ID}\" deprecated...`);\n-    const res = await prisma.envGeneratedExam.updateMany({\n+    const res = await prisma.examEnvironmentGeneratedExam.updateMany({\n       where: {\n         examId: ENV_EXAM_ID\n       },"
        },
        {
            "sha": "1c5fb1f6f91171ba9b911402d77115f974880430",
            "filename": "api/tools/exam-environment/generate/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fgenerate%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fgenerate%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Ftools%2Fexam-environment%2Fgenerate%2Findex.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,5 +1,5 @@\n import { PrismaClient } from '@prisma/client';\n-import { generateExam } from '../../../src/exam-environment/utils/exam';\n+import { generateExam } from '../../../src/exam-environment/utils/exam-environment';\n import { MONGOHQ_URL } from '../../../src/utils/env';\n \n const args = process.argv.slice(2);\n@@ -28,7 +28,7 @@ async function main() {\n   await prisma.$connect();\n   console.info('Connected.');\n \n-  const exam = await prisma.envExam.findUnique({\n+  const exam = await prisma.examEnvironmentExam.findUnique({\n     where: {\n       id: ENV_EXAM_ID\n     }\n@@ -46,7 +46,7 @@ async function main() {\n   while (numberOfExamsGenerated < NUMBER_OF_EXAMS_TO_GENERATE) {\n     try {\n       const generatedExam = generateExam(exam);\n-      await prisma.envGeneratedExam.create({\n+      await prisma.examEnvironmentGeneratedExam.create({\n         data: generatedExam\n       });\n       numberOfExamsGenerated++;"
        },
        {
            "sha": "8ca81391a51dbec19d9c8caf4626252024643d98",
            "filename": "api/tools/exam-environment/generate/insert.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fgenerate%2Finsert.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fgenerate%2Finsert.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Ftools%2Fexam-environment%2Fgenerate%2Finsert.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,5 +1,5 @@\n import { readFile } from 'fs/promises';\n-import { EnvExam, PrismaClient } from '@prisma/client';\n+import { ExamEnvironmentExam, PrismaClient } from '@prisma/client';\n import { MONGOHQ_URL } from '../../../src/utils/env';\n \n const args = process.argv.slice(2);\n@@ -24,10 +24,10 @@ async function main() {\n \n   const exam_str = await readFile(EXAM_JSON_PATH, 'utf-8');\n \n-  const exam = JSON.parse(exam_str) as EnvExam;\n+  const exam = JSON.parse(exam_str) as ExamEnvironmentExam;\n \n   try {\n-    const res = await prisma.envExam.create({\n+    const res = await prisma.examEnvironmentExam.create({\n       data: exam\n     });\n "
        },
        {
            "sha": "5ec864c0f6463446b2f3511aff76ea6e29fa5001",
            "filename": "api/tools/exam-environment/seed/index.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fseed%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Fseed%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Ftools%2Fexam-environment%2Fseed%2Findex.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -1,5 +1,5 @@\n import { PrismaClient } from '@prisma/client';\n-import * as mocks from '../../../__mocks__/env-exam';\n+import * as mocks from '../../../__mocks__/exam-environment-exam';\n import { MONGOHQ_URL } from '../../../src/utils/env';\n \n const prisma = new PrismaClient({\n@@ -13,12 +13,14 @@ const prisma = new PrismaClient({\n async function main() {\n   await prisma.$connect();\n \n-  await prisma.envExamAttempt.deleteMany({});\n-  await prisma.envGeneratedExam.deleteMany({});\n-  await prisma.envExam.deleteMany({});\n+  await prisma.examEnvironmentExamAttempt.deleteMany({});\n+  await prisma.examEnvironmentGeneratedExam.deleteMany({});\n+  await prisma.examEnvironmentExam.deleteMany({});\n \n-  await prisma.envExam.create({ data: mocks.exam });\n-  await prisma.envGeneratedExam.create({ data: mocks.generatedExam });\n+  await prisma.examEnvironmentExam.create({ data: mocks.exam });\n+  await prisma.examEnvironmentGeneratedExam.create({\n+    data: mocks.generatedExam\n+  });\n }\n \n void main();"
        },
        {
            "sha": "85e69ac1f4abfd9c37fc42d4c8767d8ec0ced5d0",
            "filename": "api/tools/exam-environment/test/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Ftest%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/92b6ca53430493af338d61adf067d1e9f5131236/api%2Ftools%2Fexam-environment%2Ftest%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Ftools%2Fexam-environment%2Ftest%2Findex.ts?ref=92b6ca53430493af338d61adf067d1e9f5131236",
            "patch": "@@ -17,13 +17,18 @@ const prisma = new PrismaClient({\n async function main() {\n   await prisma.$connect();\n   try {\n-    const envExam = await prisma.envExam.findMany();\n-    const envGeneratedExam = await prisma.envGeneratedExam.findMany();\n-    const envExamAttempt = await prisma.envExamAttempt.findMany();\n+    const examEnvironmentExam = await prisma.examEnvironmentExam.findMany();\n+    const examEnvironmentGeneratedExam =\n+      await prisma.examEnvironmentGeneratedExam.findMany();\n+    const examEnvironmentExamAttempt =\n+      await prisma.examEnvironmentExamAttempt.findMany();\n \n-    console.log('Number of exams:', envExam.length);\n-    console.log('Number of generated exams:', envGeneratedExam.length);\n-    console.log('Number of exam attempts:', envExamAttempt.length);\n+    console.log('Number of exams:', examEnvironmentExam.length);\n+    console.log(\n+      'Number of generated exams:',\n+      examEnvironmentGeneratedExam.length\n+    );\n+    console.log('Number of exam attempts:', examEnvironmentExamAttempt.length);\n     // NOTE: This is not strictly true. E.g. If a `Boolean` becomes an `Int`, Prisma converts it instead of throwing.\n     console.log('\\nSUCCESS! The database schema matches the Prisma schema.');\n   } catch (error) {"
        }
    ],
    "stats": {
        "total": 1649,
        "additions": 1333,
        "deletions": 316
    }
}