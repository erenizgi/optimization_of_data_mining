{
    "author": "ojeytonwilliams",
    "message": "feat(api): finish update-my-email endpoint (#54921)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "84a41a4da80ed1ce08becdd9256aeb84a0e17203",
    "files": [
        {
            "sha": "c2f0683ba9bc4f857c06f58b2f6cd9c04455b945",
            "filename": "api/src/plugins/code-flow-auth.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Fplugins%2Fcode-flow-auth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Fplugins%2Fcode-flow-auth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcode-flow-auth.test.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -2,7 +2,7 @@ import Fastify, { FastifyInstance } from 'fastify';\n import jwt from 'jsonwebtoken';\n \n import { COOKIE_DOMAIN, JWT_SECRET } from '../utils/env';\n-import { AccessToken, createAccessToken } from '../utils/tokens';\n+import { type Token, createAccessToken } from '../utils/tokens';\n import cookies, { sign as signCookie, unsign as unsignCookie } from './cookies';\n import codeFlowAuth from './code-flow-auth';\n \n@@ -38,7 +38,7 @@ describe('auth', () => {\n       const { value, ...rest } = res.cookies[0]!;\n       const unsignedOnce = unsignCookie(value);\n       const unsignedTwice = jwt.verify(unsignedOnce.value!, JWT_SECRET) as {\n-        accessToken: AccessToken;\n+        accessToken: Token;\n       };\n       expect(unsignedTwice.accessToken).toEqual(token);\n       expect(rest).toEqual({"
        },
        {
            "sha": "6b5c2dc1632b1216cbe23da73aab5aa4831cce0c",
            "filename": "api/src/plugins/code-flow-auth.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 21,
            "changes": 36,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -5,14 +5,11 @@ import { isBefore } from 'date-fns';\n import { type user } from '@prisma/client';\n \n import { COOKIE_DOMAIN, JWT_SECRET } from '../utils/env';\n-import { AccessToken } from '../utils/tokens';\n+import { type Token } from '../utils/tokens';\n \n declare module 'fastify' {\n   interface FastifyReply {\n-    setAccessTokenCookie: (\n-      this: FastifyReply,\n-      accessToken: AccessToken\n-    ) => void;\n+    setAccessTokenCookie: (this: FastifyReply, accessToken: Token) => void;\n   }\n \n   interface FastifyRequest {\n@@ -26,21 +23,18 @@ declare module 'fastify' {\n }\n \n const codeFlowAuth: FastifyPluginCallback = (fastify, _options, done) => {\n-  fastify.decorateReply(\n-    'setAccessTokenCookie',\n-    function (accessToken: AccessToken) {\n-      const signedToken = jwt.sign({ accessToken }, JWT_SECRET);\n-      void this.setCookie('jwt_access_token', signedToken, {\n-        path: '/',\n-        httpOnly: false,\n-        secure: false,\n-        sameSite: 'lax',\n-        domain: COOKIE_DOMAIN,\n-        signed: true,\n-        maxAge: accessToken.ttl\n-      });\n-    }\n-  );\n+  fastify.decorateReply('setAccessTokenCookie', function (accessToken: Token) {\n+    const signedToken = jwt.sign({ accessToken }, JWT_SECRET);\n+    void this.setCookie('jwt_access_token', signedToken, {\n+      path: '/',\n+      httpOnly: false,\n+      secure: false,\n+      sameSite: 'lax',\n+      domain: COOKIE_DOMAIN,\n+      signed: true,\n+      maxAge: accessToken.ttl\n+    });\n+  });\n \n   const TOKEN_REQUIRED = 'Access token is required for this request';\n   const TOKEN_INVALID = 'Your access token is invalid';\n@@ -68,7 +62,7 @@ const codeFlowAuth: FastifyPluginCallback = (fastify, _options, done) => {\n \n       const {\n         accessToken: { created, ttl, userId }\n-      } = jwt.decode(jwtAccessToken!) as { accessToken: AccessToken };\n+      } = jwt.decode(jwtAccessToken!) as { accessToken: Token };\n       const valid = isBefore(Date.now(), Date.parse(created) + ttl);\n       if (!valid) return send401(reply, TOKEN_EXPIRED);\n "
        },
        {
            "sha": "90b49f4ab184f9cca4d7ed08345b0f13429549bc",
            "filename": "api/src/routes/settings.test.ts",
            "status": "modified",
            "additions": 106,
            "deletions": 40,
            "changes": 146,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Froutes%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Froutes%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.test.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -1,11 +1,13 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n import {\n   devLogin,\n   setupServer,\n   superRequest,\n-  createSuperRequest\n+  createSuperRequest,\n+  defaultUserId\n } from '../../jest.utils';\n import { createUserInput } from '../utils/create-user';\n-\n+import { API_LOCATION } from '../utils/env';\n import { isPictureWithProtocol, getWaitMessage } from './settings';\n \n const baseProfileUI = {\n@@ -171,6 +173,7 @@ describe('settingRoutes', () => {\n     });\n \n     describe('/update-my-email', () => {\n+      let sendEmailSpy: jest.SpyInstance;\n       beforeEach(async () => {\n         await fastifyTestInstance.prisma.user.updateMany({\n           where: { email: developerUserEmail },\n@@ -181,47 +184,56 @@ describe('settingRoutes', () => {\n             emailAuthLinkTTL: null\n           }\n         });\n+\n+        sendEmailSpy = jest\n+          .spyOn(fastifyTestInstance, 'sendEmail')\n+          .mockImplementationOnce(jest.fn());\n       });\n-      test('PUT returns 200 status code with \"success\" message', async () => {\n+\n+      afterEach(async () => {\n+        jest.clearAllMocks();\n+        await fastifyTestInstance.prisma.authToken.deleteMany({\n+          where: { userId: defaultUserId }\n+        });\n+      });\n+      test('PUT returns 200 status code with \"info\" message', async () => {\n         const response = await superPut('/update-my-email').send({\n           email: 'foo@foo.com'\n         });\n \n-        expect(response?.body).toEqual({\n-          message: 'flash.email-valid',\n-          type: 'success'\n+        expect(response.body).toEqual({\n+          message:\n+            'Check your email and click the link we sent you to confirm your new email address.',\n+          type: 'info'\n         });\n-        expect(response?.statusCode).toEqual(200);\n+        expect(response.statusCode).toEqual(200);\n       });\n \n       test(\"PUT updates the user's record in preparation for receiving auth email\", async () => {\n+        const timeBefore = Date.now();\n         const response = await superPut('/update-my-email').send({\n           email: unusedEmailOne\n         });\n \n         const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n           where: { email: developerUserEmail },\n-          select: { emailVerifyTTL: true, emailVerified: true, newEmail: true }\n-        });\n-        const emailVerifyTTL = user?.emailVerifyTTL;\n-        expect(emailVerifyTTL).toBeTruthy();\n-        // This throw is to mollify TS (if this is necessary a lot, create a\n-        // helper)\n-        if (!emailVerifyTTL) {\n-          throw new Error('emailVerifyTTL is not defined');\n-        }\n-\n-        expect(response?.statusCode).toEqual(200);\n-\n-        // expect the emailVerifyTTL to be within 10 seconds of the current time\n-        const tenSeconds = 10 * 1000;\n-        expect(emailVerifyTTL.getTime()).toBeGreaterThan(\n-          Date.now() - tenSeconds\n-        );\n-        expect(emailVerifyTTL.getTime()).toBeLessThan(Date.now() + tenSeconds);\n+          select: {\n+            emailAuthLinkTTL: true,\n+            emailVerifyTTL: true,\n+            emailVerified: true,\n+            newEmail: true\n+          }\n+        });\n \n-        expect(user?.emailVerified).toEqual(false);\n-        expect(user?.newEmail).toEqual(unusedEmailOne);\n+        // expect the emailVerifyTTL and emailAuthLinkTTL to be set to the current time\n+        expect(user.emailVerifyTTL!.getTime()).toBeGreaterThan(timeBefore);\n+        expect(user.emailVerifyTTL!.getTime()).toBeLessThan(Date.now());\n+        expect(user.emailAuthLinkTTL!.getTime()).toBeGreaterThan(timeBefore);\n+        expect(user.emailAuthLinkTTL!.getTime()).toBeLessThan(Date.now());\n+\n+        expect(user.emailVerified).toEqual(false);\n+        expect(user.newEmail).toEqual(unusedEmailOne);\n+        expect(response.statusCode).toEqual(200);\n       });\n \n       test('PUT rejects invalid email addresses', async () => {\n@@ -231,11 +243,11 @@ describe('settingRoutes', () => {\n \n         // We cannot use fastify's default validation failure response here\n         // because the client consumes the response and displays it to the user.\n-        expect(response?.body).toEqual({\n+        expect(response.body).toEqual({\n           type: 'danger',\n           message: 'Email format is invalid'\n         });\n-        expect(response?.statusCode).toEqual(400);\n+        expect(response.statusCode).toEqual(400);\n       });\n \n       test('PUT accepts requests to update to the current email address (ignoring case) if it is not verified', async () => {\n@@ -247,10 +259,11 @@ describe('settingRoutes', () => {\n           email: developerUserEmail.toUpperCase()\n         });\n \n-        expect(response?.statusCode).toEqual(200);\n-        expect(response?.body).toEqual({\n-          message: 'flash.email-valid',\n-          type: 'success'\n+        expect(response.statusCode).toEqual(200);\n+        expect(response.body).toEqual({\n+          message:\n+            'Check your email and click the link we sent you to confirm your new email address.',\n+          type: 'info'\n         });\n       });\n \n@@ -259,20 +272,20 @@ describe('settingRoutes', () => {\n           email: developerUserEmail.toUpperCase()\n         });\n \n-        expect(response?.body).toEqual({\n+        expect(response.body).toEqual({\n           type: 'info',\n           message: `${developerUserEmail} is already associated with this account.\n You can update a new email address instead.`\n         });\n-        expect(response?.statusCode).toEqual(400);\n+        expect(response.statusCode).toEqual(400);\n       });\n \n       test('PUT rejects a request to update to the same email (ignoring case) twice', async () => {\n         const successResponse = await superPut('/update-my-email').send({\n           email: unusedEmailOne\n         });\n \n-        expect(successResponse?.statusCode).toEqual(200);\n+        expect(successResponse.statusCode).toEqual(200);\n \n         const failResponse = await superPut('/update-my-email').send({\n           email: unusedEmailOne.toUpperCase()\n@@ -291,19 +304,19 @@ Please wait 5 minutes to resend an authentication link.`\n           email: otherDeveloperUserEmail\n         });\n \n-        expect(response?.body).toEqual({\n+        expect(response.body).toEqual({\n           type: 'info',\n           message: `${otherDeveloperUserEmail} is already associated with another account.`\n         });\n-        expect(response?.statusCode).toEqual(400);\n+        expect(response.statusCode).toEqual(400);\n       });\n \n       test('PUT rejects the second request if is immediately after the first', async () => {\n         const successResponse = await superPut('/update-my-email').send({\n           email: unusedEmailOne\n         });\n \n-        expect(successResponse?.statusCode).toEqual(200);\n+        expect(successResponse.statusCode).toEqual(200);\n \n         const failResponse = await superPut('/update-my-email').send({\n           email: unusedEmailTwo\n@@ -317,7 +330,60 @@ Please wait 5 minutes to resend an authentication link.`\n         });\n       });\n \n-      // TODO: test that the correct email gets sent\n+      test('PUT sends an email to the new email address', async () => {\n+        jest\n+          .spyOn(fastifyTestInstance.prisma.authToken, 'create')\n+          .mockImplementationOnce(() =>\n+            // @ts-expect-error This is a mock implementation, all we're\n+            // interested in is the id.\n+            Promise.resolve({\n+              id: '123'\n+            })\n+          );\n+        await superPut('/update-my-email').send({\n+          email: unusedEmailOne\n+        });\n+\n+        const expectedLink = `${API_LOCATION}/confirm-email?email=${Buffer.from(unusedEmailOne).toString('base64')}&token=123&emailChange=true`;\n+        expect(sendEmailSpy).toHaveBeenCalledWith({\n+          from: 'team@freecodecamp.org',\n+          to: unusedEmailOne,\n+          subject:\n+            'Please confirm your updated email address for freeCodeCamp.org',\n+          text: `Please confirm this email address for freeCodeCamp.org:\n+\n+${expectedLink}\n+\n+Happy coding!\n+\n+- The freeCodeCamp.org Team\n+`\n+        });\n+      });\n+\n+      test('PUT creates an auth token record for the requesting user', async () => {\n+        const noToken = await fastifyTestInstance.prisma.authToken.findFirst({\n+          where: { userId: defaultUserId }\n+        });\n+        expect(noToken).toBeNull();\n+\n+        await superPut('/update-my-email').send({\n+          email: unusedEmailOne\n+        });\n+\n+        const token = await fastifyTestInstance.prisma.authToken.findFirst({\n+          where: { userId: defaultUserId }\n+        });\n+\n+        expect(token).toEqual({\n+          ttl: 15 * 60 * 1000,\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          created: expect.any(Date),\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          id: expect.any(String),\n+          userId: defaultUserId\n+        });\n+      });\n     });\n \n     describe('/update-my-theme', () => {"
        },
        {
            "sha": "1a0290e028559fd4acf95dfc93d8bc0bcd590437",
            "filename": "api/src/routes/settings.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 12,
            "changes": 60,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Froutes%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Froutes%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -19,6 +19,8 @@ import { isProfane } from 'no-profanity';\n import { blocklistedUsernames } from '../../../shared/config/constants';\n import { isValidUsername } from '../../../shared/utils/validate';\n import * as schemas from '../schemas';\n+import { createAuthToken } from '../utils/tokens';\n+import { API_LOCATION } from '../utils/env';\n \n type WaitMesssageArgs = {\n   sentAt: Date | null;\n@@ -154,6 +156,18 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n     }\n   );\n \n+  function createUpdateEmailText({ email, id }: { email: string; id: string }) {\n+    const encodedEmail = Buffer.from(email).toString('base64');\n+    return `Please confirm this email address for freeCodeCamp.org:\n+\n+${API_LOCATION}/confirm-email?email=${encodedEmail}&token=${id}&emailChange=true\n+\n+Happy coding!\n+\n+- The freeCodeCamp.org Team\n+`;\n+  }\n+\n   fastify.put(\n     '/update-my-email',\n     {\n@@ -170,6 +184,7 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n       const user = await fastify.prisma.user.findUniqueOrThrow({\n         where: { id: req.user?.id },\n         select: {\n+          id: true,\n           email: true,\n           emailVerifyTTL: true,\n           newEmail: true,\n@@ -183,11 +198,11 @@ export const settingRoutes: FastifyPluginCallbackTypebox = (\n       const isOwnEmail = newEmail === currentEmailFormatted;\n       if (isOwnEmail && isVerifiedEmail) {\n         void reply.code(400);\n-        return {\n+        return reply.send({\n           type: 'info',\n           message: `${newEmail} is already associated with this account.\n You can update a new email address instead.`\n-        } as const;\n+        });\n       }\n \n       const isResendUpdateToSameEmail =\n@@ -198,28 +213,28 @@ You can update a new email address instead.`\n \n       if (isResendUpdateToSameEmail && isLinkSentWithinLimitTTL) {\n         void reply.code(429);\n-        return {\n+        return reply.send({\n           type: 'info',\n           message: `We have already sent an email confirmation request to ${newEmail}.\n ${isLinkSentWithinLimitTTL}`\n-        } as const;\n+        });\n       }\n \n       const isEmailAlreadyTaken =\n         (await fastify.prisma.user.count({ where: { email: newEmail } })) > 0;\n \n       if (isEmailAlreadyTaken && !isOwnEmail) {\n         void reply.code(400);\n-        return {\n+        return reply.send({\n           type: 'info',\n           message: `${newEmail} is already associated with another account.`\n-        } as const;\n+        });\n       }\n \n       // ToDo(MVP): email the new email and wait user to confirm it, before we update the user schema.\n       try {\n         await fastify.prisma.user.update({\n-          where: { id: req.user?.id },\n+          where: { id: user.id },\n           data: {\n             newEmail,\n             emailVerified: false,\n@@ -237,24 +252,45 @@ ${isLinkSentWithinLimitTTL}`\n \n         if (tooManyRequestsMessage) {\n           void reply.code(429);\n-          return {\n+          return reply.send({\n             type: 'info',\n             message: tooManyRequestsMessage\n-          } as const;\n+          });\n         }\n \n+        // Update the emailAuthLinkTTL to ensure we don't send too many emails.\n         await fastify.prisma.user.update({\n-          where: { id: req.user?.id },\n+          where: { id: user.id },\n           data: {\n             emailAuthLinkTTL: new Date()\n           }\n         });\n \n-        return { message: 'flash.email-valid', type: 'success' } as const;\n+        // The auth token is used to confirm that the user owns the email. If\n+        // the user provides the correct id (by following the link we send\n+        // them), then we can update the email.\n+        const { id } = await fastify.prisma.authToken.create({\n+          data: createAuthToken(user.id),\n+          select: { id: true }\n+        });\n+\n+        await fastify.sendEmail({\n+          from: 'team@freecodecamp.org',\n+          to: newEmail,\n+          subject:\n+            'Please confirm your updated email address for freeCodeCamp.org',\n+          text: createUpdateEmailText({ email: newEmail, id })\n+        });\n+\n+        await reply.send({\n+          message:\n+            'Check your email and click the link we sent you to confirm your new email address.',\n+          type: 'info'\n+        });\n       } catch (err) {\n         fastify.log.error(err);\n         void reply.code(500);\n-        return { message: 'flash.wrong-updating', type: 'danger' } as const;\n+        await reply.send({ message: 'flash.wrong-updating', type: 'danger' });\n       }\n     }\n   );"
        },
        {
            "sha": "ed76cc9e2a84d8b173a5f893b476d08a9895078f",
            "filename": "api/src/schemas/settings/update-my-email.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Fschemas%2Fsettings%2Fupdate-my-email.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Fschemas%2Fsettings%2Fupdate-my-email.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fsettings%2Fupdate-my-email.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -6,8 +6,10 @@ export const updateMyEmail = {\n   }),\n   response: {\n     200: Type.Object({\n-      message: Type.Literal('flash.email-valid'),\n-      type: Type.Literal('success')\n+      message: Type.Literal(\n+        'Check your email and click the link we sent you to confirm your new email address.'\n+      ),\n+      type: Type.Literal('info')\n     }),\n     '4xx': Type.Object({\n       message: Type.String(),"
        },
        {
            "sha": "10576cb178179799968b8cc1dbc4ca728e1ab166",
            "filename": "api/src/utils/tokens.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Futils%2Ftokens.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Futils%2Ftokens.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Ftokens.test.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -1,5 +1,5 @@\n /* eslint-disable @typescript-eslint/no-unsafe-assignment */\n-import { createAccessToken } from './tokens';\n+import { createAccessToken, createAuthToken } from './tokens';\n \n describe('createAccessToken', () => {\n   it('creates an object with id, ttl, created and userId', () => {\n@@ -26,3 +26,29 @@ describe('createAccessToken', () => {\n     expect(createAccessToken(userId).ttl).toBe(77760000000);\n   });\n });\n+\n+describe('createAuthToken', () => {\n+  it('creates an object with id, ttl, created and userId', () => {\n+    const userId = 'abc';\n+\n+    const actual = createAuthToken(userId);\n+\n+    expect(actual).toStrictEqual({\n+      id: expect.stringMatching(/[a-zA-Z0-9]{64}/),\n+      ttl: 900000,\n+      created: expect.stringMatching(\n+        /\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z/\n+      ),\n+      userId\n+    });\n+  });\n+\n+  it('sets the ttl, defaulting to 900000 ms', () => {\n+    const userId = 'abc';\n+    const ttl = 123;\n+    const actual = createAuthToken(userId, ttl);\n+\n+    expect(actual.ttl).toBe(ttl);\n+    expect(createAuthToken(userId).ttl).toBe(900000);\n+  });\n+});"
        },
        {
            "sha": "543a3c612a4bc62c76f91ea40478a37bb3164e8f",
            "filename": "api/src/utils/tokens.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Futils%2Ftokens.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/84a41a4da80ed1ce08becdd9256aeb84a0e17203/api%2Fsrc%2Futils%2Ftokens.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Ftokens.ts?ref=84a41a4da80ed1ce08becdd9256aeb84a0e17203",
            "patch": "@@ -13,7 +13,7 @@ export function encodeUserToken(userToken: string): string {\n   return jwt.sign({ userToken }, JWT_SECRET);\n }\n \n-export type AccessToken = {\n+export type Token = {\n   userId: string;\n   id: string;\n   ttl: number;\n@@ -26,14 +26,26 @@ export type AccessToken = {\n  * @param ttl The time to live for the token in milliseconds (default: 77760000000).\n  * @returns The access token.\n  */\n-export const createAccessToken = (\n-  userId: string,\n-  ttl?: number\n-): AccessToken => {\n+export const createAccessToken = (userId: string, ttl?: number): Token => {\n   return {\n     userId,\n     id: customNanoid(),\n     ttl: ttl ?? 77760000000,\n     created: new Date().toISOString()\n   };\n };\n+\n+/**\n+ * Creates an auth token.\n+ * @param userId The user ID as a string (yes, it's an ObjectID, but it will be serialized to a string anyway).\n+ * @param ttl The time to live for the token in milliseconds (default: 900000 aka 15 minutes).\n+ * @returns The access token.\n+ */\n+export const createAuthToken = (userId: string, ttl?: number): Token => {\n+  return {\n+    userId,\n+    id: customNanoid(),\n+    ttl: ttl ?? 900000,\n+    created: new Date().toISOString()\n+  };\n+};"
        }
    ],
    "stats": {
        "total": 302,
        "additions": 219,
        "deletions": 83
    }
}