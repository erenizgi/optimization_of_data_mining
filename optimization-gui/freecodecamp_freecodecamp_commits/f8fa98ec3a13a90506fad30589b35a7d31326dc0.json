{
    "author": "huyenltnguyen",
    "message": "fix(client): put /update-email behind authentication (#54128)\n\nCo-authored-by: Just-A-Pixel <Raj.Anand0511@gmail.com>\r\nCo-authored-by: sembauke <semboot699@gmail.com>",
    "sha": "f8fa98ec3a13a90506fad30589b35a7d31326dc0",
    "files": [
        {
            "sha": "70334293bbb3840041696d88438c8a57f2cec3d3",
            "filename": "client/src/client-only-routes/show-update-email.css",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fclient-only-routes%2Fshow-update-email.css",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fclient-only-routes%2Fshow-update-email.css",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fclient-only-routes%2Fshow-update-email.css?ref=f8fa98ec3a13a90506fad30589b35a7d31326dc0",
            "previous_filename": "client/src/pages/update-email.css"
        },
        {
            "sha": "e79f5f300b7fb75af5a6b83e998adab00d930bf7",
            "filename": "client/src/client-only-routes/show-update-email.tsx",
            "status": "added",
            "additions": 140,
            "deletions": 0,
            "changes": 140,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fclient-only-routes%2Fshow-update-email.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fclient-only-routes%2Fshow-update-email.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fclient-only-routes%2Fshow-update-email.tsx?ref=f8fa98ec3a13a90506fad30589b35a7d31326dc0",
            "patch": "@@ -0,0 +1,140 @@\n+import { Link } from 'gatsby';\n+import React, {\n+  useState,\n+  useEffect,\n+  type FormEvent,\n+  type ChangeEvent\n+} from 'react';\n+import Helmet from 'react-helmet';\n+import { useTranslation } from 'react-i18next';\n+import { connect } from 'react-redux';\n+import { createSelector } from 'reselect';\n+import isEmail from 'validator/lib/isEmail';\n+import {\n+  Container,\n+  FormGroup,\n+  FormControl,\n+  ControlLabel,\n+  Col,\n+  Row,\n+  Button\n+} from '@freecodecamp/ui';\n+\n+import envData from '../../config/env.json';\n+import { Spacer, Loader } from '../components/helpers';\n+import './show-update-email.css';\n+import { isSignedInSelector, userSelector } from '../redux/selectors';\n+import { hardGoTo as navigate } from '../redux/actions';\n+import { updateMyEmail } from '../redux/settings/actions';\n+import { maybeEmailRE } from '../utils';\n+\n+const { apiLocation } = envData;\n+\n+interface ShowUpdateEmailProps {\n+  isNewEmail: boolean;\n+  updateMyEmail: (e: string) => void;\n+  path?: string;\n+  isSignedIn: boolean;\n+  navigate: (location: string) => void;\n+}\n+\n+const mapStateToProps = createSelector(\n+  userSelector,\n+  isSignedInSelector,\n+  (\n+    { email, emailVerified }: { email: string; emailVerified: boolean },\n+    isSignedIn\n+  ) => ({\n+    isNewEmail: !email || emailVerified,\n+    isSignedIn\n+  })\n+);\n+\n+const mapDispatchToProps = { updateMyEmail, navigate };\n+\n+function ShowUpdateEmail({\n+  isNewEmail,\n+  updateMyEmail,\n+  isSignedIn,\n+  navigate\n+}: ShowUpdateEmailProps) {\n+  const { t } = useTranslation();\n+  const [emailValue, setEmailValue] = useState('');\n+\n+  useEffect(() => {\n+    if (!isSignedIn) navigate(`${apiLocation}/signin`);\n+  }, [isSignedIn, navigate]);\n+  if (!isSignedIn) return <Loader fullScreen={true} />;\n+\n+  function handleSubmit(event: FormEvent) {\n+    event.preventDefault();\n+    updateMyEmail(emailValue);\n+  }\n+\n+  function onChange(event: ChangeEvent<HTMLInputElement>) {\n+    setEmailValue(event.target.value);\n+    return null;\n+  }\n+\n+  const emailValidationState = maybeEmailRE.test(emailValue)\n+    ? isEmail(emailValue)\n+      ? 'success'\n+      : 'error'\n+    : null;\n+\n+  return (\n+    <>\n+      <Helmet>\n+        <title>{t('misc.update-email-1')} | freeCodeCamp.org</title>\n+      </Helmet>\n+      <Container>\n+        <Spacer size='medium' />\n+        <h2 className='text-center'>{t('misc.update-email-2')}</h2>\n+        <Row>\n+          <Col sm={6} smOffset={3}>\n+            <Row>\n+              <form\n+                onSubmit={handleSubmit}\n+                data-playwright-test-label='update-email-form'\n+              >\n+                <FormGroup\n+                  className='update-email-field'\n+                  validationState={emailValidationState}\n+                >\n+                  <ControlLabel htmlFor='emailInput'>\n+                    {t('misc.email')}\n+                  </ControlLabel>\n+                  <FormControl\n+                    id='emailInput'\n+                    onChange={onChange}\n+                    placeholder='camperbot@example.com'\n+                    required={true}\n+                    type='email'\n+                  />\n+                </FormGroup>\n+                <Button\n+                  block={true}\n+                  size='large'\n+                  variant='primary'\n+                  disabled={emailValidationState !== 'success'}\n+                  type='submit'\n+                >\n+                  {isNewEmail\n+                    ? t('buttons.update-email')\n+                    : t('buttons.verify-email')}\n+                </Button>\n+              </form>\n+              <p className='text-center'>\n+                <Link to='/signout'>{t('buttons.sign-out')}</Link>\n+              </p>\n+            </Row>\n+          </Col>\n+        </Row>\n+      </Container>\n+    </>\n+  );\n+}\n+\n+ShowUpdateEmail.displayName = 'ShowUpdateEmail';\n+\n+export default connect(mapStateToProps, mapDispatchToProps)(ShowUpdateEmail);"
        },
        {
            "sha": "5ed95699ba1820204e9f18f510845a97edee7863",
            "filename": "client/src/pages/update-email.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 124,
            "changes": 137,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fpages%2Fupdate-email.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fpages%2Fupdate-email.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fpages%2Fupdate-email.tsx?ref=f8fa98ec3a13a90506fad30589b35a7d31326dc0",
            "patch": "@@ -1,131 +1,20 @@\n-import { Link } from 'gatsby';\n-import { isString } from 'lodash-es';\n-import React, { useState, type FormEvent, type ChangeEvent } from 'react';\n-import Helmet from 'react-helmet';\n-import type { TFunction } from 'i18next';\n-import { withTranslation } from 'react-i18next';\n-import { connect } from 'react-redux';\n-import { bindActionCreators } from 'redux';\n-import type { Dispatch } from 'redux';\n-import { createSelector } from 'reselect';\n-import isEmail from 'validator/lib/isEmail';\n-import {\n-  Container,\n-  FormGroup,\n-  FormControl,\n-  ControlLabel,\n-  Col,\n-  Row,\n-  Button\n-} from '@freecodecamp/ui';\n+import { Router } from '@reach/router';\n+import { withPrefix } from 'gatsby';\n+import React from 'react';\n \n-import { Spacer } from '../components/helpers';\n-import './update-email.css';\n-import { userSelector } from '../redux/selectors';\n-import { updateMyEmail } from '../redux/settings/actions';\n-import { maybeEmailRE } from '../utils';\n-\n-interface UpdateEmailProps {\n-  isNewEmail: boolean;\n-  t: TFunction;\n-  updateMyEmail: (e: string) => void;\n-}\n-\n-const mapStateToProps = createSelector(\n-  userSelector,\n-  ({ email, emailVerified }: { email: string; emailVerified: boolean }) => ({\n-    isNewEmail: !email || emailVerified\n-  })\n-);\n-\n-const mapDispatchToProps = (dispatch: Dispatch) =>\n-  bindActionCreators({ updateMyEmail }, dispatch);\n-\n-function UpdateEmail({ isNewEmail, t, updateMyEmail }: UpdateEmailProps) {\n-  const [emailValue, setEmailValue] = useState('');\n-\n-  function handleSubmit(event: FormEvent) {\n-    event.preventDefault();\n-    updateMyEmail(emailValue);\n-  }\n-\n-  function onChange(event: ChangeEvent<HTMLInputElement>) {\n-    const newEmailValue = event.target.value;\n-    if (!isString(newEmailValue)) {\n-      return null;\n-    }\n-    setEmailValue(newEmailValue);\n-    return null;\n-  }\n-\n-  function getEmailValidationState() {\n-    if (maybeEmailRE.test(emailValue)) {\n-      return isEmail(emailValue) ? 'success' : 'error';\n-    }\n-    return null;\n-  }\n+import ShowUpdateEmail from '../client-only-routes/show-update-email';\n+import RedirectHome from '../components/redirect-home';\n \n+function UpdateEmail(): JSX.Element {\n   return (\n-    <>\n-      <Helmet>\n-        <title>{t('misc.update-email-1')} | freeCodeCamp.org</title>\n-      </Helmet>\n-      <Container>\n-        <Spacer size='medium' />\n-        <h2\n-          className='text-center'\n-          data-playwright-test-label='update-email-heading'\n-        >\n-          {t('misc.update-email-2')}\n-        </h2>\n-        <Row>\n-          <Col sm={6} smOffset={3}>\n-            <Row>\n-              <form\n-                onSubmit={handleSubmit}\n-                data-playwright-test-label='update-email-form'\n-              >\n-                <FormGroup\n-                  className='update-email-field'\n-                  validationState={getEmailValidationState()}\n-                >\n-                  <ControlLabel htmlFor='emailInput'>\n-                    {t('misc.email')}\n-                  </ControlLabel>\n-                  <FormControl\n-                    id='emailInput'\n-                    onChange={onChange}\n-                    placeholder='camperbot@example.com'\n-                    required={true}\n-                    type='email'\n-                  />\n-                </FormGroup>\n-                <Button\n-                  block={true}\n-                  size='large'\n-                  variant='primary'\n-                  disabled={getEmailValidationState() !== 'success'}\n-                  type='submit'\n-                >\n-                  {isNewEmail\n-                    ? t('buttons.update-email')\n-                    : t('buttons.verify-email')}\n-                </Button>\n-              </form>\n-              <p className='text-center'>\n-                <Link to='/signout'>{t('buttons.sign-out')}</Link>\n-              </p>\n-            </Row>\n-          </Col>\n-        </Row>\n-      </Container>\n-    </>\n+    <Router>\n+      <ShowUpdateEmail path={withPrefix('/update-email')} />\n+\n+      <RedirectHome default />\n+    </Router>\n   );\n }\n \n-UpdateEmail.displayName = 'Update-Email';\n+UpdateEmail.displayName = 'UpdateEmail';\n \n-export default connect(\n-  mapStateToProps,\n-  mapDispatchToProps\n-)(withTranslation()(UpdateEmail));\n+export default UpdateEmail;"
        },
        {
            "sha": "8113791507483c7af3b51cb4da805655240c0755",
            "filename": "client/src/pages/update-stripe-card.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fpages%2Fupdate-stripe-card.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f8fa98ec3a13a90506fad30589b35a7d31326dc0/client%2Fsrc%2Fpages%2Fupdate-stripe-card.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fpages%2Fupdate-stripe-card.tsx?ref=f8fa98ec3a13a90506fad30589b35a7d31326dc0",
            "patch": "@@ -9,7 +9,6 @@ import { Container, Row, Col, Button } from '@freecodecamp/ui';\n import BigCallToAction from '../components/landing/components/big-call-to-action';\n \n import { Spacer } from '../components/helpers';\n-import './update-email.css';\n import {\n   isSignedInSelector,\n   isDonatingSelector,"
        },
        {
            "sha": "0ed02e8f9d64b89d0d38e79404ac296e1b04e384",
            "filename": "e2e/update-email.spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 30,
            "changes": 72,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f8fa98ec3a13a90506fad30589b35a7d31326dc0/e2e%2Fupdate-email.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f8fa98ec3a13a90506fad30589b35a7d31326dc0/e2e%2Fupdate-email.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fupdate-email.spec.ts?ref=f8fa98ec3a13a90506fad30589b35a7d31326dc0",
            "patch": "@@ -1,33 +1,24 @@\n-import { test, expect, type Page } from '@playwright/test';\n+import { test, expect } from '@playwright/test';\n import translations from '../client/i18n/locales/english/translations.json';\n \n-let page: Page;\n+test.describe('The update-email page when the user is signed in', () => {\n+  test.use({ storageState: 'playwright/.auth/certified-user.json' });\n \n-test.beforeAll(async ({ browser }) => {\n-  page = await browser.newPage();\n-  await page.goto('/update-email');\n-});\n+  test.beforeEach(async ({ page }) => {\n+    await page.goto('/update-email');\n+  });\n \n-test.describe('The update-email page', () => {\n-  test('The page renders with correct title', async () => {\n+  test('should display the content correctly', async ({ page }) => {\n     await expect(page).toHaveTitle(\n       'Update your email address | freeCodeCamp.org'\n     );\n-  });\n+    await expect(\n+      page.getByRole('heading', { name: 'Update your email address here' })\n+    ).toBeVisible();\n \n-  test('The page has correct header', async () => {\n-    const header = page.getByTestId('update-email-heading');\n-\n-    await expect(header).toBeVisible();\n-    await expect(header).toContainText(translations.misc['update-email-2']);\n-  });\n-\n-  test('The page has update email form', async () => {\n     const form = page.getByTestId('update-email-form');\n-    const emailInput = page.getByLabel(translations.misc.email);\n-    const submitButton = page.getByRole('button', {\n-      name: translations.buttons['update-email']\n-    });\n+    const emailInput = page.getByLabel('Email');\n+    const submitButton = page.getByRole('button', { name: 'Update my Email' });\n \n     await expect(form).toBeVisible();\n     await expect(emailInput).toBeVisible();\n@@ -38,26 +29,47 @@ test.describe('The update-email page', () => {\n     );\n     await expect(submitButton).toBeVisible();\n     await expect(submitButton).toHaveAttribute('type', 'submit');\n-  });\n \n-  test('The page has sign out button', async () => {\n-    const signOutButton = page.getByRole('link', {\n-      name: translations.buttons['sign-out']\n-    });\n+    const signOutButton = page.getByRole('link', { name: 'Sign out' });\n \n     await expect(signOutButton).toBeVisible();\n     await expect(signOutButton).toHaveAttribute('href', '/signout');\n   });\n \n-  test('should enable the submit button if the email input is valid', async () => {\n+  test('should enable the submit button if the email input is valid', async ({\n+    page\n+  }) => {\n     const emailInput = page.getByLabel(translations.misc.email);\n-    const submitButton = page.getByRole('button', {\n-      name: translations.buttons['update-email']\n-    });\n+    const submitButton = page.getByRole('button', { name: 'Update my Email' });\n+\n     await expect(submitButton).toBeDisabled();\n     await emailInput.fill('123');\n     await expect(submitButton).toBeDisabled();\n     await emailInput.fill('123@gmail.com');\n     await expect(submitButton).toBeEnabled();\n   });\n });\n+\n+test.describe('The update-email page when the user is not signed in', () => {\n+  test.use({ storageState: { cookies: [], origins: [] } });\n+\n+  test.beforeEach(async ({ page }) => {\n+    await page.goto('/update-email');\n+  });\n+\n+  test('should sign the user in and redirect them to /learn', async ({\n+    page,\n+    browserName\n+  }) => {\n+    // The signin step involves multiple navigations, which results a network error in Firefox.\n+    // The error is harmless but Playwright doesn't suppress it, causing the test to fail.\n+    // Ref: https://github.com/microsoft/playwright/issues/20749\n+    test.skip(browserName === 'firefox');\n+\n+    await page.waitForURL(/\\/learn\\/?/);\n+\n+    await expect(\n+      page.getByRole('heading', { name: 'Welcome back, Full Stack User' })\n+    ).toBeVisible();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 350,
        "additions": 195,
        "deletions": 155
    }
}