{
    "author": "ojeytonwilliams",
    "message": "feat: prevent dialogs appearing when users run tests (#55150)",
    "sha": "c508259cf284b2048110eedf30ca30a83f544f96",
    "files": [
        {
            "sha": "9628bca95ed09a02c7ff8eaa39a4ed3c3607180b",
            "filename": "client/src/templates/Challenges/utils/frame.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 36,
            "changes": 86,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c508259cf284b2048110eedf30ca30a83f544f96/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fframe.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c508259cf284b2048110eedf30ca30a83f544f96/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fframe.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fframe.ts?ref=c508259cf284b2048110eedf30ca30a83f544f96",
            "patch": "@@ -208,6 +208,20 @@ const mountFrame =\n     };\n   };\n \n+// Tests should not use functions that directly interact with the user, so\n+// they're overridden. If tests need to spy on these functions, they can supply\n+// the spy themselves.\n+const overrideUserInteractions = (frameContext: Context) => {\n+  if (frameContext.window) {\n+    frameContext.window.prompt = () => null;\n+    frameContext.window.alert = () => {};\n+    frameContext.window.confirm = () => false;\n+  }\n+  return frameContext;\n+};\n+\n+const noop = <T>(x: T) => x;\n+\n const actRE = new RegExp(/act\\(\\.\\.\\.\\) is not supported in production builds/);\n \n const updateProxyConsole =\n@@ -259,7 +273,7 @@ const updateProxyConsole =\n     return frameContext;\n   };\n \n-const updateWindowI18next = () => (frameContext: Context) => {\n+const updateWindowI18next = (frameContext: Context) => {\n   // window does not exist if the preview is hidden, so we have to check.\n   if (frameContext?.window) {\n     frameContext.window.i18nContent = i18next;\n@@ -332,21 +346,6 @@ function handleDocumentNotFound(err: string) {\n \n const initPreviewFrame = () => (frameContext: Context) => frameContext;\n \n-// TODO: reimplement when ready to preview python challenges\n-// const initPreviewFrame = () => (frameContext: Context) => {\n-//   waitForFrame(frameContext)\n-//     .then(() => {\n-//       if (\n-//         frameContext.document &&\n-//         '__initPythonFrame' in frameContext.document\n-//       ) {\n-//         void frameContext.document?.__initPythonFrame();\n-//       }\n-//     })\n-//     .catch(handleDocumentNotFound);\n-//   return frameContext;\n-// };\n-\n const waitForFrame = (frameContext: Context) => {\n   return new Promise((resolve, reject) => {\n     if (!frameContext.document) {\n@@ -389,48 +388,63 @@ export const createMainPreviewFramer = (\n   frameTitle: string,\n   frameReady?: () => void\n ): ((args: Context) => void) =>\n-  createFramer(\n+  createFramer({\n     document,\n-    mainPreviewId,\n-    initMainFrame,\n+    id: mainPreviewId,\n+    init: initMainFrame,\n     proxyLogger,\n     frameReady,\n     frameTitle\n-  );\n+  });\n \n export const createProjectPreviewFramer = (\n   document: Document,\n   frameTitle: string\n ): ((args: Context) => void) =>\n-  createFramer(\n+  createFramer({\n     document,\n-    projectPreviewId,\n-    initPreviewFrame,\n-    undefined,\n-    undefined,\n+    id: projectPreviewId,\n+    init: initPreviewFrame,\n     frameTitle\n-  );\n+  });\n \n export const createTestFramer = (\n   document: Document,\n   proxyLogger: ProxyLogger,\n   frameReady: () => void\n ): ((args: Context) => void) =>\n-  createFramer(document, testId, initTestFrame, proxyLogger, frameReady);\n+  createFramer({\n+    document,\n+    id: testId,\n+    init: initTestFrame,\n+    proxyLogger,\n+    frameReady,\n+    updateWindowFunctions: overrideUserInteractions\n+  });\n \n-const createFramer = (\n-  document: Document,\n-  id: string,\n-  init: InitFrame,\n-  proxyLogger?: ProxyLogger,\n-  frameReady?: () => void,\n-  frameTitle?: string\n-) =>\n+const createFramer = ({\n+  document,\n+  id,\n+  init,\n+  proxyLogger,\n+  frameReady,\n+  frameTitle,\n+  updateWindowFunctions\n+}: {\n+  document: Document;\n+  id: string;\n+  init: InitFrame;\n+  proxyLogger?: ProxyLogger;\n+  frameReady?: () => void;\n+  frameTitle?: string;\n+  updateWindowFunctions?: (frameContext: Context) => Context;\n+}) =>\n   flow(\n     createFrame(document, id, frameTitle),\n     mountFrame(document, id),\n+    updateWindowFunctions ?? noop,\n     updateProxyConsole(proxyLogger),\n-    updateWindowI18next(),\n+    updateWindowI18next,\n     writeContentToFrame,\n     init(frameReady, proxyLogger)\n   ) as (args: Context) => void;"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 50,
        "deletions": 36
    }
}