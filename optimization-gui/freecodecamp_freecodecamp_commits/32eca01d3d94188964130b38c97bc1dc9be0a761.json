{
    "author": "raisedadead",
    "message": "fix(api): improve logging",
    "sha": "32eca01d3d94188964130b38c97bc1dc9be0a761",
    "files": [
        {
            "sha": "c31953e6df58dc1663c55d806aa745cdce1ab03b",
            "filename": "api/src/routes/public/status.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/32eca01d3d94188964130b38c97bc1dc9be0a761/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/32eca01d3d94188964130b38c97bc1dc9be0a761/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts?ref=32eca01d3d94188964130b38c97bc1dc9be0a761",
            "patch": "@@ -1,4 +1,5 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import { isEmpty } from 'lodash';\n \n /**\n  * Plugin for the health check endpoint.\n@@ -13,7 +14,26 @@ export const statusRoute: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  fastify.get('/status/ping', async (_req, _reply) => {\n+  fastify.get('/status/ping', async (req, _reply) => {\n+    const url = req.url || 'URL not found';\n+    const reqId = req.id || 'REQ_ID not found';\n+    const headers = isEmpty(req.headers) ? 'HEADERS not found' : req.headers;\n+    const ip =\n+      req.headers['x-forwarded-for'] ||\n+      req.headers['x-real-ip'] ||\n+      req.ip ||\n+      'IP not found';\n+    const params = isEmpty(req.params) ? 'PARAMS not found' : req.params;\n+\n+    fastify.log\n+      .child({\n+        URL: url,\n+        REQ_ID: reqId,\n+        HEADERS: headers,\n+        IP: ip,\n+        PARAMS: params\n+      })\n+      .debug('returning a ping');\n     return { msg: 'pong' };\n   });\n "
        },
        {
            "sha": "6d3b3ecf87f8c790f051244aad812605e0836181",
            "filename": "api/src/server.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 5,
            "changes": 33,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/32eca01d3d94188964130b38c97bc1dc9be0a761/api%2Fsrc%2Fserver.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/32eca01d3d94188964130b38c97bc1dc9be0a761/api%2Fsrc%2Fserver.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fserver.ts?ref=32eca01d3d94188964130b38c97bc1dc9be0a761",
            "patch": "@@ -3,6 +3,8 @@\n // is not included in the build (it's a dev dependency).\n // eslint-disable-next-line @typescript-eslint/triple-slash-reference\n /// <reference path=\"./reset.d.ts\" />\n+import { randomBytes } from 'crypto';\n+import { FastifyRequest } from 'fastify';\n import { build } from './app';\n import {\n   FREECODECAMP_NODE_ENV,\n@@ -11,25 +13,46 @@ import {\n   PORT\n } from './utils/env';\n \n+const requestSerializer = (request: FastifyRequest) => ({\n+  method: request.method,\n+  url: request.url,\n+  ip: request.headers['x-forwarded-for'] || request.ip,\n+  hostname: request.hostname,\n+  remoteAddress: Array.isArray(request.headers['x-forwarded-for'])\n+    ? request.headers['x-forwarded-for'][0]\n+    : request.headers['x-forwarded-for'] || request.ip,\n+  remotePort: request.socket.remotePort\n+});\n+\n const envToLogger = {\n   development: {\n     transport: {\n       target: 'pino-pretty',\n       options: {\n+        singleLine: true,\n         translateTime: 'HH:MM:ss Z',\n         ignore: 'pid,hostname'\n       }\n     },\n-    level: FCC_API_LOG_LEVEL || 'info'\n+    level: FCC_API_LOG_LEVEL || 'info',\n+    serializers: {\n+      req: requestSerializer\n+    }\n   },\n   production: {\n-    level: FCC_API_LOG_LEVEL || 'info'\n-  },\n-  test: undefined\n+    level: FCC_API_LOG_LEVEL || 'info',\n+    serializers: {\n+      req: requestSerializer\n+    }\n+  }\n };\n \n const start = async () => {\n-  const fastify = await build({ logger: envToLogger[FREECODECAMP_NODE_ENV] });\n+  const fastify = await build({\n+    logger: envToLogger[FREECODECAMP_NODE_ENV] ?? true,\n+    genReqId: () => randomBytes(8).toString('hex'),\n+    disableRequestLogging: true\n+  });\n   try {\n     const port = Number(PORT);\n     fastify.log.info(`Starting server on port ${port}`);"
        },
        {
            "sha": "9c6aa02d0d8953b2fa9f8ead7967516bba3c677f",
            "filename": "api/src/utils/env.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/32eca01d3d94188964130b38c97bc1dc9be0a761/api%2Fsrc%2Futils%2Fenv.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/32eca01d3d94188964130b38c97bc1dc9be0a761/api%2Fsrc%2Futils%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fenv.ts?ref=32eca01d3d94188964130b38c97bc1dc9be0a761",
            "patch": "@@ -6,7 +6,7 @@ import { LogLevel } from 'fastify';\n const envPath = path.resolve(__dirname, '../../../.env');\n const { error } = config({ path: envPath });\n \n-if (error) {\n+if (error && process.env.FREECODECAMP_NODE_ENV !== 'production') {\n   console.warn(`\n   ----------------------------------------------------\n   Warning: .env file not found."
        }
    ],
    "stats": {
        "total": 57,
        "additions": 50,
        "deletions": 7
    }
}