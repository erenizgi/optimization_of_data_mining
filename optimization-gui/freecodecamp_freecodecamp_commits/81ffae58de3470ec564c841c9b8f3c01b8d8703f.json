{
    "author": "huyenltnguyen",
    "message": "fix(client): logic to determine auto-expanded block (#57456)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "81ffae58de3470ec564c841c9b8f3c01b8d8703f",
    "files": [
        {
            "sha": "2d3b7901db3843087def85ef7a751ecfdfac904d",
            "filename": "client/src/redux/index.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/81ffae58de3470ec564c841c9b8f3c01b8d8703f/client%2Fsrc%2Fredux%2Findex.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/81ffae58de3470ec564c841c9b8f3c01b8d8703f/client%2Fsrc%2Fredux%2Findex.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Findex.js?ref=81ffae58de3470ec564c841c9b8f3c01b8d8703f",
            "patch": "@@ -211,7 +211,8 @@ export const reducer = handleActions(\n         [username]: { ...user, sessionUser: true }\n       },\n       appUsername: username,\n-      currentChallengeId: user.currentChallengeId,\n+      currentChallengeId:\n+        user.currentChallengeId || store.get(CURRENT_CHALLENGE_KEY),\n       userFetchState: {\n         pending: false,\n         complete: true,"
        },
        {
            "sha": "b2dedf937253e7556a0e9b8e8090b15145a0b9e7",
            "filename": "client/src/templates/Introduction/super-block-intro.tsx",
            "status": "modified",
            "additions": 63,
            "deletions": 49,
            "changes": 112,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/81ffae58de3470ec564c841c9b8f3c01b8d8703f/client%2Fsrc%2Ftemplates%2FIntroduction%2Fsuper-block-intro.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/81ffae58de3470ec564c841c9b8f3c01b8d8703f/client%2Fsrc%2Ftemplates%2FIntroduction%2Fsuper-block-intro.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FIntroduction%2Fsuper-block-intro.tsx?ref=81ffae58de3470ec564c841c9b8f3c01b8d8703f",
            "patch": "@@ -1,7 +1,7 @@\n import { WindowLocation } from '@reach/router';\n import { graphql } from 'gatsby';\n-import { uniq } from 'lodash-es';\n-import React, { Fragment, useEffect, memo, useMemo } from 'react';\n+import { uniq, isEmpty, last } from 'lodash-es';\n+import React, { useEffect, memo, useMemo } from 'react';\n import Helmet from 'react-helmet';\n import { useTranslation, withTranslation } from 'react-i18next';\n import { connect } from 'react-redux';\n@@ -43,7 +43,7 @@ type FetchState = {\n   errored: boolean;\n };\n \n-type SuperBlockProp = {\n+type SuperBlockProps = {\n   currentChallengeId: string;\n   data: {\n     allChallengeNode: { nodes: ChallengeNode[] };\n@@ -101,7 +101,7 @@ const mapDispatchToProps = (dispatch: Dispatch) =>\n     dispatch\n   );\n \n-const SuperBlockIntroductionPage = (props: SuperBlockProp) => {\n+const SuperBlockIntroductionPage = (props: SuperBlockProps) => {\n   const { t } = useTranslation();\n   useEffect(() => {\n     initializeExpandedState();\n@@ -117,16 +117,46 @@ const SuperBlockIntroductionPage = (props: SuperBlockProp) => {\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, []);\n \n-  const getChosenBlock = (): string => {\n-    const {\n-      data: {\n-        allChallengeNode: { nodes }\n-      },\n-      isSignedIn,\n-      currentChallengeId,\n-      location\n-    }: SuperBlockProp = props;\n+  const {\n+    data: {\n+      allChallengeNode: { nodes }\n+    },\n+    isSignedIn,\n+    currentChallengeId,\n+    signInLoading,\n+    user,\n+    pageContext: { superBlock, title, certification },\n+    location,\n+    user: { completedChallenges: allCompletedChallenges }\n+  } = props;\n+\n+  const allChallenges = useMemo(\n+    () => nodes.map(({ challenge }) => challenge),\n+    [nodes]\n+  );\n+  const superBlockChallenges = useMemo(\n+    () => allChallenges.filter(c => c.superBlock === superBlock),\n+    [allChallenges, superBlock]\n+  );\n+  const blocks = uniq(superBlockChallenges.map(({ block }) => block));\n+\n+  const completedChallenges = useMemo(\n+    () =>\n+      allCompletedChallenges.filter(completedChallenge =>\n+        superBlockChallenges.some(c => c.id === completedChallenge.id)\n+      ),\n+    [superBlockChallenges, allCompletedChallenges]\n+  );\n+\n+  const i18nTitle = getSuperBlockTitleForMap(superBlock);\n \n+  const showCertification = liveCerts.some(\n+    cert => superBlockToCertMap[superBlock] === cert.certSlug\n+  );\n+\n+  const superBlockWithAccordionView = [SuperBlocks.FullStackDeveloper];\n+\n+  const getChosenBlock = (): string => {\n     // if coming from breadcrumb click\n     if (\n       location.state &&\n@@ -145,18 +175,29 @@ const SuperBlockIntroductionPage = (props: SuperBlockProp) => {\n       return dashedBlock;\n     }\n \n-    const firstChallenge = nodes[0]?.challenge;\n-\n     if (isSignedIn) {\n       // see if currentChallenge is in this superBlock\n-      const currentChallenge = nodes.find(\n-        node => node.challenge.id === currentChallengeId\n-      )?.challenge;\n+      const currentChallenge = superBlockChallenges.find(\n+        challenge => challenge.id === currentChallengeId\n+      );\n+\n+      if (currentChallenge) return currentChallenge.block;\n+\n+      // If the current challenge isn't in the super block\n+      // Find the most recently completed challenge of the super block,\n+      // which is the last item of the `completedChallenges` array.\n+      if (!isEmpty(completedChallenges)) {\n+        const lastCompletedChallengeId = last(completedChallenges)?.id;\n+\n+        const lastCompletedChallenge = allChallenges.find(\n+          ({ id }) => id === lastCompletedChallengeId\n+        );\n \n-      return currentChallenge ? currentChallenge.block : firstChallenge?.block;\n+        if (lastCompletedChallenge) return lastCompletedChallenge.block;\n+      }\n     }\n \n-    return firstChallenge?.block;\n+    return blocks[0];\n   };\n \n   const initializeExpandedState = () => {\n@@ -166,33 +207,6 @@ const SuperBlockIntroductionPage = (props: SuperBlockProp) => {\n     return toggleBlock(getChosenBlock());\n   };\n \n-  const {\n-    data: {\n-      allChallengeNode: { nodes }\n-    },\n-    isSignedIn,\n-    signInLoading,\n-    user,\n-    pageContext: { superBlock, title, certification }\n-  } = props;\n-\n-  const allChallenges = useMemo(\n-    () => nodes.map(({ challenge }) => challenge),\n-    [nodes]\n-  );\n-  const challenges = useMemo(\n-    () => allChallenges.filter(c => c.superBlock === superBlock),\n-    [allChallenges, superBlock]\n-  );\n-  const blocks = uniq(challenges.map(({ block }) => block));\n-\n-  const i18nTitle = getSuperBlockTitleForMap(superBlock);\n-\n-  const showCertification = liveCerts.some(\n-    cert => superBlockToCertMap[superBlock] === cert.certSlug\n-  );\n-\n-  const superBlockWithAccordionView = [SuperBlocks.FullStackDeveloper];\n   const chosenBlock = getChosenBlock();\n \n   const onCertificationDonationAlertClick = () => {\n@@ -228,14 +242,14 @@ const SuperBlockIntroductionPage = (props: SuperBlockProp) => {\n               <Spacer size='m' />\n               {superBlockWithAccordionView.includes(superBlock) ? (\n                 <SuperBlockAccordion\n-                  challenges={challenges}\n+                  challenges={superBlockChallenges}\n                   superBlock={superBlock}\n                   chosenBlock={chosenBlock}\n                 />\n               ) : (\n                 <div className='block-ui'>\n                   {blocks.map(block => {\n-                    const blockChallenges = challenges.filter(\n+                    const blockChallenges = superBlockChallenges.filter(\n                       c => c.block === block\n                     );\n                     const blockType = blockChallenges[0].blockType;"
        },
        {
            "sha": "115143e2cff7dee9f4d2c2f1a3bc00af07ca5d17",
            "filename": "e2e/super-block-page.spec.ts",
            "status": "added",
            "additions": 305,
            "deletions": 0,
            "changes": 305,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/81ffae58de3470ec564c841c9b8f3c01b8d8703f/e2e%2Fsuper-block-page.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/81ffae58de3470ec564c841c9b8f3c01b8d8703f/e2e%2Fsuper-block-page.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fsuper-block-page.spec.ts?ref=81ffae58de3470ec564c841c9b8f3c01b8d8703f",
            "patch": "@@ -0,0 +1,305 @@\n+import { execSync } from 'child_process';\n+import { expect, test } from '@playwright/test';\n+\n+test.describe('Super Block Page - Authenticated User', () => {\n+  test.use({ storageState: 'playwright/.auth/development-user.json' });\n+\n+  test.beforeEach(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user');\n+  });\n+\n+  test.afterAll(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user --certified-user');\n+  });\n+\n+  test.describe('Super Block in List View', () => {\n+    test('should expand the correct block when user goes to the page from breadcrumb click', async ({\n+      page\n+    }) => {\n+      await page.goto(\n+        '/learn/javascript-algorithms-and-data-structures-v8/learn-basic-javascript-by-building-a-role-playing-game/step-2'\n+      );\n+\n+      await page\n+        .getByRole('link', {\n+          name: 'Learn Basic JavaScript by Building a Role Playing Game'\n+        })\n+        .click();\n+\n+      await page.waitForURL(\n+        '/learn/javascript-algorithms-and-data-structures-v8/#learn-basic-javascript-by-building-a-role-playing-game'\n+      );\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Basic JavaScript by Building a Role Playing Game'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+\n+    test('should expand the block of the current challenge if it is saved in local storage', async ({\n+      page\n+    }) => {\n+      await page.addInitScript(() => {\n+        window.localStorage.setItem(\n+          'currentChallengeId',\n+          '660ee6e3a242da6bd579de69' // JS Pyramid Generator step 2\n+        );\n+      });\n+\n+      await page.goto('/learn/javascript-algorithms-and-data-structures-v8');\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Introductory JavaScript by Building a Pyramid Generator'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+\n+    test('should expand the block of the most recently viewed challenge', async ({\n+      page\n+    }) => {\n+      test.setTimeout(20000);\n+\n+      await page.goto('/learn/javascript-algorithms-and-data-structures-v8');\n+\n+      // The first block is expanded by default\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Introductory JavaScript by Building a Pyramid Generator'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Basic JavaScript by Building a Role Playing Game'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'false');\n+\n+      await page.goto(\n+        '/learn/javascript-algorithms-and-data-structures-v8/learn-basic-javascript-by-building-a-role-playing-game/step-2'\n+      );\n+\n+      // Go back to the super block page\n+      await page.goto('/learn/javascript-algorithms-and-data-structures-v8');\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Introductory JavaScript by Building a Pyramid Generator'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'false');\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Basic JavaScript by Building a Role Playing Game'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+  });\n+\n+  test.describe('Super Block in Accordion View', () => {\n+    test.skip(\n+      () => process.env.SHOW_UPCOMING_CHANGES !== 'true',\n+      'The FSD superblock is not available if SHOW_UPCOMING_CHANGES is false'\n+    );\n+\n+    test('should expand the correct block when user goes to the page from breadcrumb click', async ({\n+      page\n+    }) => {\n+      await page.goto(`/learn/full-stack-developer/workshop-cafe-menu/step-2`);\n+\n+      await page\n+        .getByRole('link', {\n+          name: 'Design a Cafe Menu'\n+        })\n+        .click();\n+\n+      await page.waitForURL('/learn/full-stack-developer/#workshop-cafe-menu');\n+\n+      // Chapter\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'CSS',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // Module\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Basic CSS'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // Block\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Workshop Design a Cafe Menu'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+\n+    test('should expand the block of the current challenge if it is saved in local storage', async ({\n+      page\n+    }) => {\n+      await page.addInitScript(() => {\n+        window.localStorage.setItem(\n+          'currentChallengeId',\n+          '66f6db08d55022680a3cfbc9' // What Is HTML, and What Role Does It Play on the Web?\n+        );\n+      });\n+\n+      await page.goto('/learn/full-stack-developer');\n+\n+      // HTML chapter\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'HTML',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // Basic HTML module\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Basic HTML',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // What is HTML block\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Lecture What is HTML?'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+\n+    test('should expand the block of the most recently viewed challenge', async ({\n+      page\n+    }) => {\n+      test.setTimeout(20000);\n+\n+      await page.goto('/learn/full-stack-developer');\n+\n+      // First chapter\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Welcome',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // First module\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Getting Started with freeCodeCamp'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // First block\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Lecture Welcome to freeCodeCamp'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      await page.goto('/learn/full-stack-developer/workshop-blog-page/step-2');\n+\n+      // Go back to the super block page\n+      await page.goto('/learn/full-stack-developer');\n+\n+      // The entire first chapter is collapsed\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Welcome',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'false');\n+\n+      // HTML chapter\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'HTML',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // Semantic HTML module\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Semantic HTML',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // Cat Blog Page block\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Workshop Build a Cat Blog Page'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+  });\n+});\n+\n+test.describe('Super Block Page - Unauthenticated User', () => {\n+  test.use({ storageState: { cookies: [], origins: [] } });\n+\n+  test.describe('Super Block in List View', () => {\n+    test('should expand the first block of the super block', async ({\n+      page\n+    }) => {\n+      await page.goto('/learn/javascript-algorithms-and-data-structures-v8/');\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Introductory JavaScript by Building a Pyramid Generator'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      await page.goto('/learn/a2-english-for-developers/');\n+\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Learn Greetings in your First Day at the Office'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+  });\n+\n+  test.describe('Super Block in Accordion View', () => {\n+    test.skip(\n+      () => process.env.SHOW_UPCOMING_CHANGES !== 'true',\n+      'The FSD superblock is not available if SHOW_UPCOMING_CHANGES is false'\n+    );\n+\n+    test('should expand the first block of the super block', async ({\n+      page\n+    }) => {\n+      await page.goto('/learn/full-stack-developer');\n+\n+      // First chapter\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Welcome',\n+          exact: true\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // First module\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Getting Started with freeCodeCamp'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+\n+      // First block\n+      await expect(\n+        page.getByRole('button', {\n+          name: 'Lecture Welcome to freeCodeCamp'\n+        })\n+      ).toHaveAttribute('aria-expanded', 'true');\n+    });\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 420,
        "additions": 370,
        "deletions": 50
    }
}