{
    "author": "ojeytonwilliams",
    "message": "test: inform devs when db connection not established (#60539)",
    "sha": "22724d5dda6b28b00780e3b24e790981d96ecbc9",
    "files": [
        {
            "sha": "c45419ff4ca790ad8599befe8d3b0a97c09d8b25",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22724d5dda6b28b00780e3b24e790981d96ecbc9/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22724d5dda6b28b00780e3b24e790981d96ecbc9/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=22724d5dda6b28b00780e3b24e790981d96ecbc9",
            "patch": "@@ -155,6 +155,19 @@ const indexData: IndexData[] = [\n   }\n ];\n \n+export async function checkCanConnectToDb(\n+  prisma: FastifyTestInstance['prisma']\n+): Promise<void> {\n+  const countP = prisma.user.count();\n+  const delayedRejection = new Promise((_resolve, reject) =>\n+    setTimeout(\n+      () => reject(Error('unable to connect to Mongodb (timeout)')),\n+      1000\n+    )\n+  );\n+  await Promise.race([countP, delayedRejection]);\n+}\n+\n export function setupServer(): void {\n   let fastify: FastifyTestInstance;\n   beforeAll(async () => {\n@@ -165,6 +178,8 @@ export function setupServer(): void {\n     fastify = await build(buildOptions);\n     await fastify.ready();\n \n+    await checkCanConnectToDb(fastify.prisma);\n+\n     // Prisma does not support TTL indexes in the schema yet, so, to avoid\n     // conflicts with the TTL index in the sessions collection, we need to\n     // create it manually (before interacting with the db in any way). Also,"
        },
        {
            "sha": "639634001b3762599d75e24f399b5343970d0db1",
            "filename": "api/src/plugins/auth-dev.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22724d5dda6b28b00780e3b24e790981d96ecbc9/api%2Fsrc%2Fplugins%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22724d5dda6b28b00780e3b24e790981d96ecbc9/api%2Fsrc%2Fplugins%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth-dev.test.ts?ref=22724d5dda6b28b00780e3b24e790981d96ecbc9",
            "patch": "@@ -1,6 +1,6 @@\n import Fastify, { FastifyInstance } from 'fastify';\n \n-import { defaultUserEmail } from '../../jest.utils';\n+import { checkCanConnectToDb, defaultUserEmail } from '../../jest.utils';\n import { HOME_LOCATION } from '../utils/env';\n import { devAuth } from '../plugins/auth-dev';\n import prismaPlugin from '../db/prisma';\n@@ -19,6 +19,7 @@ describe('dev login', () => {\n     await fastify.register(auth);\n     await fastify.register(devAuth);\n     await fastify.register(prismaPlugin);\n+    await checkCanConnectToDb(fastify.prisma);\n   });\n \n   beforeEach(async () => {"
        },
        {
            "sha": "7bef32befde54595fa53ff3ffb5c2ece2d5f047c",
            "filename": "api/src/routes/helpers/auth-helpers.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22724d5dda6b28b00780e3b24e790981d96ecbc9/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22724d5dda6b28b00780e3b24e790981d96ecbc9/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts?ref=22724d5dda6b28b00780e3b24e790981d96ecbc9",
            "patch": "@@ -2,13 +2,15 @@ import Fastify, { FastifyInstance } from 'fastify';\n \n import db from '../../db/prisma';\n import { createUserInput } from '../../utils/create-user';\n+import { checkCanConnectToDb } from '../../../jest.utils';\n import { findOrCreateUser } from './auth-helpers';\n \n const captureException = jest.fn();\n \n async function setupServer() {\n   const fastify = Fastify();\n   await fastify.register(db);\n+  await checkCanConnectToDb(fastify.prisma);\n   // @ts-expect-error we're mocking the Sentry plugin\n   fastify.Sentry = { captureException };\n   return fastify;"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 19,
        "deletions": 1
    }
}