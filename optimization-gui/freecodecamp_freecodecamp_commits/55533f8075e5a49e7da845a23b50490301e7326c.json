{
    "author": "ojeytonwilliams",
    "message": "ci: run e2e tests against new and old apis (#54546)",
    "sha": "55533f8075e5a49e7da845a23b50490301e7326c",
    "files": [
        {
            "sha": "f0cbab9e7ee1c1241704a4b15e490c550a346739",
            "filename": ".github/workflows/e2e-with-new-api.yml",
            "status": "added",
            "additions": 191,
            "deletions": 0,
            "changes": 191,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/55533f8075e5a49e7da845a23b50490301e7326c/.github%2Fworkflows%2Fe2e-with-new-api.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/55533f8075e5a49e7da845a23b50490301e7326c/.github%2Fworkflows%2Fe2e-with-new-api.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fe2e-with-new-api.yml?ref=55533f8075e5a49e7da845a23b50490301e7326c",
            "patch": "@@ -0,0 +1,191 @@\n+name: CI - E2E - Containers\n+on:\n+  workflow_dispatch:\n+  workflow_run:\n+    workflows: ['CI - Node.js']\n+    types:\n+      - completed\n+  pull_request:\n+    paths-ignore:\n+      - 'docs/**'\n+    branches:\n+      - 'main'\n+      - 'next-**'\n+      - 'e2e-**'\n+\n+jobs:\n+  build-client:\n+    name: Build Client\n+    runs-on: ubuntu-22.04\n+    strategy:\n+      matrix:\n+        node-version: [20.x]\n+\n+    steps:\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+\n+      - name: Checkout client-config\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+        with:\n+          repository: freeCodeCamp/client-config\n+          path: client-config\n+\n+      - name: Setup pnpm\n+        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d #v3.0.0\n+        with:\n+          version: 9\n+\n+      - name: Use Node.js ${{ matrix.node-version }}\n+        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2\n+        with:\n+          node-version: ${{ matrix.node-version }}\n+          cache: pnpm\n+\n+      - name: Set freeCodeCamp Environment Variables\n+        run: cp sample.env .env\n+\n+      - name: Install and Build\n+        run: |\n+          pnpm install\n+          pnpm run build\n+\n+      - name: Move serve.json to Public Folder\n+        run: cp client-config/serve.json client/public/serve.json\n+\n+      # We tar them for performance reasons - uploading a lot of files is slow.\n+      - name: Tar Files\n+        run: tar -cf client-artifact.tar client/public\n+\n+      - name: Upload Client Artifact\n+        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1\n+        with:\n+          name: client-artifact\n+          path: client-artifact.tar\n+\n+      - name: Upload Webpack Stats\n+        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1\n+        with:\n+          name: webpack-stats\n+          path: client/public/stats.json\n+\n+  build-api:\n+    name: Build Api (Container)\n+    runs-on: ubuntu-22.04\n+    strategy:\n+      matrix:\n+        node-version: [20.x]\n+\n+    steps:\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+\n+      - name: Create Image\n+        run: |\n+          docker build \\\n+            -t fcc-api \\\n+            -f docker/api/Dockerfile .\n+\n+  build-new-api:\n+    name: Build New Api (Container)\n+    runs-on: ubuntu-22.04\n+    strategy:\n+      matrix:\n+        node-version: [20.x]\n+\n+    steps:\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+\n+      - name: Create Image\n+        run: |\n+          docker build \\\n+            -t fcc-new-api \\\n+            -f docker/new-api/Dockerfile .\n+\n+      - name: Save Image\n+        run: docker save fcc-new-api > api-artifact.tar\n+\n+      - name: Upload Api Artifact\n+        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1\n+        with:\n+          name: api-artifact\n+          path: api-artifact.tar\n+\n+  playwright-run:\n+    name: Run Playwright Tests (with new Api)\n+    runs-on: ubuntu-22.04\n+    needs: [build-client, build-new-api]\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        # Extend this to include firefox and webkit once chromium is working.\n+        browsers: [chromium]\n+        node-version: [20.x]\n+\n+    steps:\n+      - name: Set Action Environment Variables\n+        run: |\n+          echo \"GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}\" >> $GITHUB_ENV\n+\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+\n+      - uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4\n+\n+      - name: Unpack Client Artifact\n+        run: |\n+          tar -xf client-artifact/client-artifact.tar\n+          rm client-artifact/client-artifact.tar\n+\n+      - name: Load Api Image\n+        run: |\n+          docker load < api-artifact/api-artifact.tar\n+          rm api-artifact/api-artifact.tar\n+\n+      # Cypress calls some pnpm scripts, so we need to install pnpm.\n+      - name: Setup pnpm\n+        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d #v3.0.0\n+        with:\n+          version: 9\n+\n+      - name: Use Node.js ${{ matrix.node-version }}\n+        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2\n+        with:\n+          node-version: ${{ matrix.node-version }}\n+\n+      - name: Install Dependencies\n+        run: pnpm install\n+\n+      - name: Set freeCodeCamp Environment Variables (needed by api)\n+        run: |\n+          cp sample.env .env\n+          echo 'HOST=0.0.0.0' >> .env\n+\n+      - name: Install playwright dependencies\n+        run: npx playwright install --with-deps\n+\n+      - name: Install and Build\n+        run: |\n+          pnpm install\n+          pnpm run create:shared\n+          pnpm run build:curriculum\n+\n+      - name: Start apps\n+        run: |\n+          docker compose up -d\n+          pnpm run serve:client-ci &\n+          sleep 10\n+\n+      - name: Seed Database with Certified User\n+        run: pnpm run seed:certified-user\n+\n+      - name: Run playwright tests\n+        run: npx playwright test --project=${{ matrix.browsers }} --grep-invert 'third-party-donation.spec.ts'\n+\n+      - uses: actions/upload-artifact@v4\n+        if: ${{ !cancelled() }}\n+        with:\n+          name: playwright-report-${{ matrix.browsers }}\n+          path: playwright/reporter\n+          retention-days: 30"
        },
        {
            "sha": "8f1fea467c77bf23398d70019ce3d2918fb9fae5",
            "filename": "docker-compose.yml",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/55533f8075e5a49e7da845a23b50490301e7326c/docker-compose.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/55533f8075e5a49e7da845a23b50490301e7326c/docker-compose.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/docker-compose.yml?ref=55533f8075e5a49e7da845a23b50490301e7326c",
            "patch": "@@ -3,17 +3,30 @@ services:\n     image: mongo\n     ports:\n       - '27017:27017'\n+    command: mongod --replSet rs0\n+  setup:\n+    image: mongo\n+    depends_on:\n+      - mongo\n+    restart: on-failure\n+    entrypoint: [\n+        'bash',\n+        '-c',\n+        # This will try to initiate the replica set, until it succeeds twice (i.e. until the replica set is already initialized)\n+        'mongosh --host mongo:27017 --eval ''try {rs.initiate();} catch (err) { if(err.codeName !== \"AlreadyInitialized\") throw err };'''\n+      ]\n   mailhog:\n     restart: unless-stopped\n     image: mailhog/mailhog\n     ports:\n       - '1025:1025'\n       - '8025:8025'\n   api:\n+    restart: unless-stopped\n     depends_on:\n       - mongo\n       - mailhog\n-    image: fcc-api\n+    image: fcc-new-api\n     env_file:\n       - .env\n     environment:\n@@ -24,9 +37,4 @@ services:\n     ports:\n       # PORT is used by the new api, so we use the less generic API_PORT to\n       # avoid conflicts.\n-      - '${API_PORT:-3000}:3000'\n-  client:\n-    image: fcc-client\n-    ports:\n-      # Same principle as above (avoiding conflicts)\n-      - '${CLIENT_PORT:-8000}:8000'\n+      - '3000:3000'"
        }
    ],
    "stats": {
        "total": 213,
        "additions": 206,
        "deletions": 7
    }
}