{
    "author": "ojeytonwilliams",
    "message": "fix(api): give expected default if field missing (#54807)",
    "sha": "e877b9208c695c32167f50f553a04a185c46bd67",
    "files": [
        {
            "sha": "0f89ee415b47afbda6631e9314d32295ca04482b",
            "filename": "api/src/routes/user.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.test.ts?ref=e877b9208c695c32167f50f553a04a185c46bd67",
            "patch": "@@ -633,13 +633,40 @@ describe('userRoutes', () => {\n           joinDate: new ObjectId(testUser.id).getTimestamp().toISOString(),\n           // the following properties are defaults provided if the field is\n           // missing in the user document.\n+          currentChallengeId: '',\n           completedChallenges: [],\n           completedExams: [],\n           completedSurveys: [],\n           partiallyCompletedChallenges: [],\n           portfolio: [],\n           savedChallenges: [],\n-          yearsTopContributor: []\n+          yearsTopContributor: [],\n+          is2018DataVisCert: false,\n+          is2018FullStackCert: false,\n+          isApisMicroservicesCert: false,\n+          isBackEndCert: false,\n+          isCheater: false,\n+          isCollegeAlgebraPyCertV8: false,\n+          isDataAnalysisPyCertV7: false,\n+          isDataVisCert: false,\n+          isFoundationalCSharpCertV8: false,\n+          isFrontEndCert: false,\n+          isFrontEndLibsCert: false,\n+          isFullStackCert: false,\n+          isHonest: false,\n+          isInfosecCertV7: false,\n+          isInfosecQaCert: false,\n+          isJsAlgoDataStructCert: false,\n+          isJsAlgoDataStructCertV8: false,\n+          isMachineLearningPyCertV7: false,\n+          isQaCertV7: false,\n+          isRelationalDatabaseCertV8: false,\n+          isRespWebDesignCert: false,\n+          isSciCompPyCertV7: false,\n+          keyboardShortcuts: false,\n+          location: '',\n+          name: '',\n+          theme: 'default'\n         };\n \n         const response = await superRequest('/user/get-session-user', {"
        },
        {
            "sha": "05822684735dcbe69ce27ce306474722cdd313dc",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 3,
            "changes": 56,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=e877b9208c695c32167f50f553a04a185c46bd67",
            "patch": "@@ -1,12 +1,14 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n import { ObjectId } from 'mongodb';\n+import _ from 'lodash';\n \n import * as schemas from '../schemas';\n // Loopback creates a 64 character string for the user id, this customizes\n // nanoid to do the same.  Any unique key _should_ be fine, though.\n import { customNanoid } from '../utils/ids';\n import {\n   normalizeChallenges,\n+  normalizeFlags,\n   normalizeProfileUI,\n   normalizeTwitter,\n   removeNulls,\n@@ -21,6 +23,42 @@ import { encodeUserToken } from '../utils/tokens';\n import { trimTags } from '../utils/validation';\n import { generateReportEmail } from '../utils/email-templates';\n \n+// user flags that the api-server returns as false if they're missing in the\n+// user document. Since Prisma returns null for missing fields, we need to\n+// normalize them to false.\n+// TODO(Post-MVP): remove this when the database is normalized.\n+const nullableFlags = [\n+  'is2018DataVisCert',\n+  'is2018FullStackCert',\n+  'isApisMicroservicesCert',\n+  'isBackEndCert',\n+  'isCheater',\n+  'isCollegeAlgebraPyCertV8',\n+  'isDataAnalysisPyCertV7',\n+  'isDataVisCert',\n+  // isDonating doesn't need fixing because it's not nullable\n+  'isFoundationalCSharpCertV8',\n+  'isFrontEndCert',\n+  'isFullStackCert',\n+  'isFrontEndLibsCert',\n+  'isHonest',\n+  'isInfosecCertV7',\n+  'isInfosecQaCert',\n+  'isJsAlgoDataStructCert',\n+  'isJsAlgoDataStructCertV8',\n+  'isMachineLearningPyCertV7',\n+  'isQaCertV7',\n+  'isRelationalDatabaseCertV8',\n+  'isRespWebDesignCert',\n+  'isSciCompPyCertV7',\n+  'isDataAnalysisPyCertV7',\n+  // isUpcomingPythonCertV8 exists in the db, but is not returned by the api-server\n+  // TODO(Post-MVP): delete it from the db?\n+  'keyboardShortcuts'\n+] as const;\n+\n+type NullableFlag = (typeof nullableFlags)[number];\n+\n /**\n  * Helper function to get the api url from the shared transcript link.\n  *\n@@ -534,20 +572,29 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n           ? encodeUserToken(userToken.id)\n           : undefined;\n \n+        const flags = _.pick<typeof user, NullableFlag>(user, nullableFlags);\n+        const rest = _.omit<typeof user, NullableFlag>(user, nullableFlags);\n+\n         const {\n           username,\n           usernameDisplay,\n           completedChallenges,\n           progressTimestamps,\n           twitter,\n           profileUI,\n+          currentChallengeId,\n+          location,\n+          name,\n+          theme,\n           ...publicUser\n-        } = user;\n+        } = rest;\n \n-        return {\n+        await res.send({\n           user: {\n             [username]: {\n               ...removeNulls(publicUser),\n+              ...normalizeFlags(flags),\n+              currentChallengeId: currentChallengeId ?? '',\n               completedChallenges: normalizeChallenges(completedChallenges),\n               completedChallengeCount: completedChallenges.length,\n               // This assertion is necessary until the database is normalized.\n@@ -562,6 +609,9 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n               // TODO(Post-MVP) remove this and just use emailVerified\n               isEmailVerified: user.emailVerified,\n               joinDate: new ObjectId(user.id).getTimestamp().toISOString(),\n+              location: location ?? '',\n+              name: name ?? '',\n+              theme: theme ?? 'default',\n               twitter: normalizeTwitter(twitter),\n               username: usernameDisplay || username,\n               userToken: encodedToken,\n@@ -570,7 +620,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n             }\n           },\n           result: user.username\n-        };\n+        });\n       } catch (err) {\n         fastify.log.error(err);\n         void res.code(500);"
        },
        {
            "sha": "528cdcda44078b90b12dfbf6690994ff8a98987e",
            "filename": "api/src/schemas/user/get-session-user.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 52,
            "changes": 98,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Fschemas%2Fuser%2Fget-session-user.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Fschemas%2Fuser%2Fget-session-user.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fuser%2Fget-session-user.ts?ref=e877b9208c695c32167f50f553a04a185c46bd67",
            "patch": "@@ -41,42 +41,40 @@ export const getSessionUser = {\n             })\n           ),\n           completedChallengeCount: Type.Number(),\n-          currentChallengeId: Type.Optional(Type.String()),\n+          currentChallengeId: Type.String(),\n           email: Type.String(),\n           emailVerified: Type.Boolean(),\n           githubProfile: Type.Optional(Type.String()),\n           id: Type.String(),\n-          isApisMicroservicesCert: Type.Optional(Type.Boolean()),\n-          isBackEndCert: Type.Optional(Type.Boolean()),\n-          isCheater: Type.Optional(Type.Boolean()),\n+          is2018DataVisCert: Type.Boolean(),\n+          is2018FullStackCert: Type.Boolean(),\n+          isApisMicroservicesCert: Type.Boolean(),\n+          isBackEndCert: Type.Boolean(),\n+          isCheater: Type.Boolean(),\n+          isCollegeAlgebraPyCertV8: Type.Boolean(),\n+          isDataAnalysisPyCertV7: Type.Boolean(),\n+          isDataVisCert: Type.Boolean(),\n           isDonating: Type.Boolean(),\n-          is2018DataVisCert: Type.Optional(Type.Boolean()),\n-          is2018FullStackCert: Type.Optional(Type.Boolean()),\n-          isDataVisCert: Type.Optional(Type.Boolean()),\n-          isFoundationalCSharpCertV8: Type.Optional(Type.Boolean()),\n-          isFrontEndCert: Type.Optional(Type.Boolean()),\n-          isFullStackCert: Type.Optional(Type.Boolean()),\n-          isFrontEndLibsCert: Type.Optional(Type.Boolean()),\n-          isHonest: Type.Optional(Type.Boolean()),\n-          isInfosecCertV7: Type.Optional(Type.Boolean()),\n-          isInfosecQaCert: Type.Optional(Type.Boolean()),\n-          isQaCertV7: Type.Optional(Type.Boolean()),\n-          isJsAlgoDataStructCert: Type.Optional(Type.Boolean()),\n-          isJsAlgoDataStructCertV8: Type.Optional(Type.Boolean()),\n-          isRelationalDatabaseCertV8: Type.Optional(Type.Boolean()),\n-          isRespWebDesignCert: Type.Optional(Type.Boolean()),\n-          isSciCompPyCertV7: Type.Optional(Type.Boolean()),\n-          isDataAnalysisPyCertV7: Type.Optional(Type.Boolean()),\n-          isMachineLearningPyCertV7: Type.Optional(Type.Boolean()),\n-          isCollegeAlgebraPyCertV8: Type.Optional(Type.Boolean()),\n-          keyboardShortcuts: Type.Optional(Type.Boolean()),\n+          isFoundationalCSharpCertV8: Type.Boolean(),\n+          isFrontEndCert: Type.Boolean(),\n+          isFrontEndLibsCert: Type.Boolean(),\n+          isFullStackCert: Type.Boolean(),\n+          isHonest: Type.Boolean(),\n+          isInfosecCertV7: Type.Boolean(),\n+          isInfosecQaCert: Type.Boolean(),\n+          isJsAlgoDataStructCert: Type.Boolean(),\n+          isJsAlgoDataStructCertV8: Type.Boolean(),\n+          isMachineLearningPyCertV7: Type.Boolean(),\n+          isQaCertV7: Type.Boolean(),\n+          isRelationalDatabaseCertV8: Type.Boolean(),\n+          isRespWebDesignCert: Type.Boolean(),\n+          isSciCompPyCertV7: Type.Boolean(),\n+          keyboardShortcuts: Type.Boolean(),\n           linkedin: Type.Optional(Type.String()),\n-          location: Type.Optional(Type.String()),\n-          name: Type.Optional(Type.String()),\n-          partiallyCompletedChallenges: Type.Optional(\n-            Type.Array(\n-              Type.Object({ id: Type.String(), completedDate: Type.Number() })\n-            )\n+          location: Type.String(),\n+          name: Type.String(),\n+          partiallyCompletedChallenges: Type.Array(\n+            Type.Object({ id: Type.String(), completedDate: Type.Number() })\n           ),\n           picture: Type.String(), // TODO(Post-MVP): format as url/uri?\n           points: Type.Number(),\n@@ -89,34 +87,30 @@ export const getSessionUser = {\n               url: Type.String()\n             })\n           ),\n-          profileUI: Type.Optional(\n-            Type.Object({\n-              isLocked: Type.Optional(Type.Boolean()),\n-              showAbout: Type.Optional(Type.Boolean()),\n-              showCerts: Type.Optional(Type.Boolean()),\n-              showDonation: Type.Optional(Type.Boolean()),\n-              showHeatMap: Type.Optional(Type.Boolean()),\n-              showLocation: Type.Optional(Type.Boolean()),\n-              showName: Type.Optional(Type.Boolean()),\n-              showPoints: Type.Optional(Type.Boolean()),\n-              showPortfolio: Type.Optional(Type.Boolean()),\n-              showTimeLine: Type.Optional(Type.Boolean())\n-            })\n-          ),\n+          profileUI: Type.Object({\n+            isLocked: Type.Optional(Type.Boolean()),\n+            showAbout: Type.Optional(Type.Boolean()),\n+            showCerts: Type.Optional(Type.Boolean()),\n+            showDonation: Type.Optional(Type.Boolean()),\n+            showHeatMap: Type.Optional(Type.Boolean()),\n+            showLocation: Type.Optional(Type.Boolean()),\n+            showName: Type.Optional(Type.Boolean()),\n+            showPoints: Type.Optional(Type.Boolean()),\n+            showPortfolio: Type.Optional(Type.Boolean()),\n+            showTimeLine: Type.Optional(Type.Boolean())\n+          }),\n           sendQuincyEmail: Type.Boolean(),\n-          theme: Type.Optional(Type.String()),\n+          theme: Type.String(),\n           twitter: Type.Optional(Type.String()),\n           website: Type.Optional(Type.String()),\n           yearsTopContributor: Type.Array(Type.String()), // TODO(Post-MVP): convert to number?\n           isEmailVerified: Type.Boolean(),\n           joinDate: Type.String(),\n-          savedChallenges: Type.Optional(\n-            Type.Array(\n-              Type.Intersect([\n-                saveChallengeBody,\n-                Type.Object({ lastSavedDate: Type.Number() })\n-              ])\n-            )\n+          savedChallenges: Type.Array(\n+            Type.Intersect([\n+              saveChallengeBody,\n+              Type.Object({ lastSavedDate: Type.Number() })\n+            ])\n           ),\n           username: Type.String(),\n           userToken: Type.Optional(Type.String()),"
        },
        {
            "sha": "144febfa4111f2445af413fc7cacd32b5572f1fb",
            "filename": "api/src/utils/normalize.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Futils%2Fnormalize.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Futils%2Fnormalize.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fnormalize.test.ts?ref=e877b9208c695c32167f50f553a04a185c46bd67",
            "patch": "@@ -1,7 +1,8 @@\n import {\n   normalizeTwitter,\n   normalizeProfileUI,\n-  normalizeChallenges\n+  normalizeChallenges,\n+  normalizeFlags\n } from './normalize';\n \n describe('normalize', () => {\n@@ -138,4 +139,21 @@ describe('normalize', () => {\n       ]);\n     });\n   });\n+\n+  describe('normalizeFlags', () => {\n+    it('should replace nulls with false', () => {\n+      const flags = {\n+        isLocked: null,\n+        showAbout: false,\n+        showCerts: true,\n+        showDonation: null\n+      };\n+      expect(normalizeFlags(flags)).toEqual({\n+        isLocked: false,\n+        showAbout: false,\n+        showCerts: true,\n+        showDonation: false\n+      });\n+    });\n+  });\n });"
        },
        {
            "sha": "a81e8458d76646648e4e9515d2cd37c7d8316763",
            "filename": "api/src/utils/normalize.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Futils%2Fnormalize.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e877b9208c695c32167f50f553a04a185c46bd67/api%2Fsrc%2Futils%2Fnormalize.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fnormalize.ts?ref=e877b9208c695c32167f50f553a04a185c46bd67",
            "patch": "@@ -134,3 +134,19 @@ export const normalizeSurveys = (\n     return { title, responses };\n   });\n };\n+\n+/**\n+ * Replace null flags with false.\n+ * @param flags Object with nullable boolean flags.\n+ * @returns Same object with boolean flags, defaulting to false.\n+ */\n+export const normalizeFlags = <T extends Record<string, boolean | null>>(\n+  flags: T\n+): { [K in keyof T]: boolean } => {\n+  const out = {} as { [K in keyof T]: boolean };\n+  for (const key in flags) {\n+    const v = flags[key];\n+    out[key] = typeof v === 'boolean' ? v : false;\n+  }\n+  return out;\n+};"
        }
    ],
    "stats": {
        "total": 219,
        "additions": 162,
        "deletions": 57
    }
}