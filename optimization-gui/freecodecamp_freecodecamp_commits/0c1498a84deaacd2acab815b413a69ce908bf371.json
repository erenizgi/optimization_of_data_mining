{
    "author": "raisedadead",
    "message": "fix(environment): Use DEPLOYMENT_ENV and DEPLOYMENT_TLD (#61925)",
    "sha": "0c1498a84deaacd2acab815b413a69ce908bf371",
    "files": [
        {
            "sha": "6fb71f7cce89b3c24ab61fee291d95310faa670f",
            "filename": ".github/workflows/deploy-api.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0c1498a84deaacd2acab815b413a69ce908bf371/.github%2Fworkflows%2Fdeploy-api.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0c1498a84deaacd2acab815b413a69ce908bf371/.github%2Fworkflows%2Fdeploy-api.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-api.yml?ref=0c1498a84deaacd2acab815b413a69ce908bf371",
            "patch": "@@ -112,7 +112,8 @@ jobs:\n           # LOKI_URL\n           # Variables set from SetupJob\n           DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n-          DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.site_tld }}\n+          DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.tgt_env_long }}\n+          DEPLOYMENT_TLD: ${{ needs.setup-jobs.outputs.site_tld }}\n           FCC_API_LOG_LEVEL: ${{ needs.setup-jobs.outputs.api_log_lvl }}\n           # Stack name\n           STACK_NAME: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api\n@@ -148,6 +149,7 @@ jobs:\n             echo -e '\\nLOG:Adding deployment variables...'\n             {\n               echo \\\"DEPLOYMENT_VERSION=$DEPLOYMENT_VERSION\\\"\n+              echo \\\"DEPLOYMENT_TLD=$DEPLOYMENT_TLD\\\"\n               echo \\\"DEPLOYMENT_ENV=$DEPLOYMENT_ENV\\\"\n               echo \\\"FCC_API_LOG_LEVEL=$FCC_API_LOG_LEVEL\\\"\n             } >> .env\n@@ -173,6 +175,7 @@ jobs:\n               \\\"STRIPE_SECRET_KEY\\\"\n               \\\"LOKI_URL\\\"\n               \\\"DEPLOYMENT_VERSION\\\"\n+              \\\"DEPLOYMENT_TLD\\\"\n               \\\"DEPLOYMENT_ENV\\\"\n               \\\"FCC_API_LOG_LEVEL\\\"\n             )"
        },
        {
            "sha": "40887abb3492db99c34b309bb288c5c3f36c8bcd",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0c1498a84deaacd2acab815b413a69ce908bf371/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0c1498a84deaacd2acab815b413a69ce908bf371/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=0c1498a84deaacd2acab815b413a69ce908bf371",
            "patch": "@@ -31,7 +31,7 @@ vi.mock('../../utils/env', async importOriginal => {\n   return {\n     ...actual,\n     FCC_ENABLE_EXAM_ENVIRONMENT: 'true',\n-    DEPLOYMENT_ENV: 'org'\n+    DEPLOYMENT_ENV: 'production'\n   };\n });\n "
        },
        {
            "sha": "ff112fffe013cb5be36c3c2adde0672943682500",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0c1498a84deaacd2acab815b413a69ce908bf371/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0c1498a84deaacd2acab815b413a69ce908bf371/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=0c1498a84deaacd2acab815b413a69ce908bf371",
            "patch": "@@ -40,7 +40,7 @@ import { getMsTranscriptApiUrl } from './user';\n const mockedFetch = vi.fn();\n vi.spyOn(globalThis, 'fetch').mockImplementation(mockedFetch);\n \n-let mockDeploymentEnv = 'dev';\n+let mockDeploymentEnv = 'staging';\n vi.mock('../../utils/env', async () => {\n   const actualEnv =\n     await vi.importActual<typeof import('../../utils/env')>('../../utils/env');\n@@ -1300,11 +1300,11 @@ Thanks and regards,\n \n     describe('/user/exam-environment/token', () => {\n       beforeEach(() => {\n-        mockDeploymentEnv = 'org';\n+        mockDeploymentEnv = 'staging';\n       });\n \n       afterAll(() => {\n-        mockDeploymentEnv = 'dev';\n+        mockDeploymentEnv = 'production';\n       });\n \n       afterEach(async () => {\n@@ -1316,6 +1316,7 @@ Thanks and regards,\n       });\n \n       test('POST generates a new token if one does not exist', async () => {\n+        mockDeploymentEnv = 'production';\n         const response = await superPost('/user/exam-environment/token');\n         const { examEnvironmentAuthorizationToken } = response.body;\n \n@@ -1338,6 +1339,7 @@ Thanks and regards,\n       });\n \n       test('POST only allows for one token per user id', async () => {\n+        mockDeploymentEnv = 'production';\n         const token =\n           await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.create(\n             {\n@@ -1372,14 +1374,14 @@ Thanks and regards,\n \n       test('POST does not generate a new token in non-production environments for non-staff', async () => {\n         // Override deployment environment for this test\n-        mockDeploymentEnv = 'dev';\n+        mockDeploymentEnv = 'staging';\n         const response = await superPost('/user/exam-environment/token');\n         expect(response.status).toBe(403);\n       });\n \n       test('POST does generate a new token in non-production environments for staff', async () => {\n         // Override deployment environment for this test\n-        mockDeploymentEnv = 'dev';\n+        mockDeploymentEnv = 'staging';\n         await fastifyTestInstance.prisma.user.update({\n           where: {\n             id: defaultUserId"
        },
        {
            "sha": "a1b80ab50e724ffcf79b88228799b7ab87ee7e84",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/0c1498a84deaacd2acab815b413a69ce908bf371/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/0c1498a84deaacd2acab815b413a69ce908bf371/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=0c1498a84deaacd2acab815b413a69ce908bf371",
            "patch": "@@ -519,7 +519,7 @@ async function examEnvironmentTokenHandler(\n \n   // In non-production environments, only staff are allowed to generate a token\n   if (\n-    DEPLOYMENT_ENV !== 'org' &&\n+    DEPLOYMENT_ENV !== 'production' &&\n     (!req.user?.email?.endsWith('@freecodecamp.org') ||\n       !req.user?.emailVerified)\n   ) {"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 13,
        "deletions": 8
    }
}