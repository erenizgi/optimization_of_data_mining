{
    "author": "ShaunSHamilton",
    "message": "dev(api): add build options to test env (#59957)",
    "sha": "46b910ee408d8c32ff289ba72ee4acc2ad956e77",
    "files": [
        {
            "sha": "1b47b0f04c2cf263adca479233bf43bcc91a7e7e",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=46b910ee408d8c32ff289ba72ee4acc2ad956e77",
            "patch": "@@ -1,6 +1,6 @@\n import request from 'supertest';\n \n-import { build } from './src/app';\n+import { build, buildOptions } from './src/app';\n import { createUserInput } from './src/utils/create-user';\n import { examJson } from './__mocks__/exam';\n import { CSRF_COOKIE, CSRF_HEADER } from './src/plugins/csrf';\n@@ -158,7 +158,11 @@ const indexData: IndexData[] = [\n export function setupServer(): void {\n   let fastify: FastifyTestInstance;\n   beforeAll(async () => {\n-    fastify = await build();\n+    if (process.env.FCC_ENABLE_TEST_LOGGING !== 'true') {\n+      // @ts-expect-error Disable logging by unsetting logger\n+      buildOptions.logger = undefined;\n+    }\n+    fastify = await build(buildOptions);\n     await fastify.ready();\n \n     // Prisma does not support TTL indexes in the schema yet, so, to avoid"
        },
        {
            "sha": "e8c4232e66754b0c930fcf6d25d0a9842aabfc39",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=46b910ee408d8c32ff289ba72ee4acc2ad956e77",
            "patch": "@@ -70,6 +70,7 @@\n     \"develop\": \"tsx watch --clear-screen=false src/server.ts\",\n     \"start\": \"FREECODECAMP_NODE_ENV=production node dist/server.js\",\n     \"test\": \"jest --force-exit\",\n+    \"test-with-logging\": \"FCC_ENABLE_TEST_LOGGING=true pnpm run test\",\n     \"prisma\": \"dotenv -e ../.env prisma\",\n     \"postinstall\": \"prisma generate\",\n     \"generate-exams\": \"tsx tools/exam-environment/generate/index.ts\","
        },
        {
            "sha": "43177afe14a12d96e24a0af74512d84e8bd04725",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 1,
            "changes": 68,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=46b910ee408d8c32ff289ba72ee4acc2ad956e77",
            "patch": "@@ -1,3 +1,5 @@\n+import { randomBytes } from 'crypto';\n+import { isEmpty } from 'lodash';\n import fastifyAccepts from '@fastify/accepts';\n import fastifySwagger from '@fastify/swagger';\n import fastifySwaggerUI from '@fastify/swagger-ui';\n@@ -9,6 +11,7 @@ import Fastify, {\n   FastifyBaseLogger,\n   FastifyHttpOptions,\n   FastifyInstance,\n+  FastifyRequest,\n   RawReplyDefaultExpression,\n   RawRequestDefaultExpression,\n   RawServerDefault\n@@ -42,7 +45,9 @@ import {\n   FCC_ENABLE_EXAM_ENVIRONMENT,\n   FCC_ENABLE_SENTRY_ROUTES,\n   GROWTHBOOK_FASTIFY_API_HOST,\n-  GROWTHBOOK_FASTIFY_CLIENT_KEY\n+  GROWTHBOOK_FASTIFY_CLIENT_KEY,\n+  FREECODECAMP_NODE_ENV,\n+  FCC_API_LOG_LEVEL\n } from './utils/env';\n import { isObjectID } from './utils/validation';\n import {\n@@ -78,6 +83,67 @@ ajv.addFormat('objectid', {\n   validate: (str: string) => isObjectID(str)\n });\n \n+const requestSerializer = (req: FastifyRequest) => {\n+  const method = req.method || 'METHOD not found';\n+  const url = req.url || 'URL not found';\n+  const headers = req.headers || 'HEADERS not found';\n+  const xForwardedFor = Array.isArray(req.headers['x-forwarded-for'])\n+    ? req.headers['x-forwarded-for'][0]\n+    : req.headers['x-forwarded-for'];\n+  const ip =\n+    xForwardedFor || req.headers['x-real-ip'] || req.ip || 'IP not found';\n+  const query = isEmpty(req.query) ? 'QUERY not found' : req.query;\n+  const hostname = req.hostname || 'HOSTNAME not found';\n+  const remotePort = req.socket.remotePort || 'REMOTE_PORT not found';\n+\n+  return {\n+    REQ_ID: req.id,\n+    METHOD: method,\n+    URL: url,\n+    IP: ip,\n+    HOSTNAME: hostname,\n+    REMOTE_PORT: remotePort,\n+    QUERY: query,\n+    HEADERS: headers\n+  };\n+};\n+\n+const envToLogger = {\n+  development: {\n+    transport: {\n+      target: 'pino-pretty',\n+      options: {\n+        singleLine: true,\n+        translateTime: 'HH:MM:ss Z',\n+        ignore: 'pid,hostname'\n+      }\n+    },\n+    level: FCC_API_LOG_LEVEL || 'info',\n+    serializers: {\n+      req: (req: FastifyRequest) => {\n+        return {\n+          method: req.method,\n+          url: req.url\n+        };\n+      }\n+    }\n+    // No need to redact in development\n+  },\n+  production: {\n+    level: FCC_API_LOG_LEVEL || 'info',\n+    serializers: {\n+      req: requestSerializer\n+    },\n+    redact: ['req.HEADERS.cookie']\n+  }\n+};\n+\n+export const buildOptions = {\n+  logger: envToLogger[FREECODECAMP_NODE_ENV] ?? true,\n+  genReqId: () => randomBytes(8).toString('hex'),\n+  disableRequestLogging: true\n+};\n+\n /**\n  * Top-level wrapper to instantiate the API server. This is where all middleware and\n  * routes should be mounted."
        },
        {
            "sha": "84b106c437370b7281c7fad0f5d96cbe5f629f9b",
            "filename": "api/src/server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 72,
            "changes": 75,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fsrc%2Fserver.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/46b910ee408d8c32ff289ba72ee4acc2ad956e77/api%2Fsrc%2Fserver.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fserver.ts?ref=46b910ee408d8c32ff289ba72ee4acc2ad956e77",
            "patch": "@@ -1,79 +1,10 @@\n import './instrument';\n \n-import { randomBytes } from 'crypto';\n-\n-import { FastifyRequest } from 'fastify';\n-import { isEmpty } from 'lodash';\n-\n-import { build } from './app';\n-import {\n-  FREECODECAMP_NODE_ENV,\n-  FCC_API_LOG_LEVEL,\n-  HOST,\n-  PORT\n-} from './utils/env';\n-\n-const requestSerializer = (req: FastifyRequest) => {\n-  const method = req.method || 'METHOD not found';\n-  const url = req.url || 'URL not found';\n-  const headers = req.headers || 'HEADERS not found';\n-  const xForwardedFor = Array.isArray(req.headers['x-forwarded-for'])\n-    ? req.headers['x-forwarded-for'][0]\n-    : req.headers['x-forwarded-for'];\n-  const ip =\n-    xForwardedFor || req.headers['x-real-ip'] || req.ip || 'IP not found';\n-  const query = isEmpty(req.query) ? 'QUERY not found' : req.query;\n-  const hostname = req.hostname || 'HOSTNAME not found';\n-  const remotePort = req.socket.remotePort || 'REMOTE_PORT not found';\n-\n-  return {\n-    REQ_ID: req.id,\n-    METHOD: method,\n-    URL: url,\n-    IP: ip,\n-    HOSTNAME: hostname,\n-    REMOTE_PORT: remotePort,\n-    QUERY: query,\n-    HEADERS: headers\n-  };\n-};\n-\n-const envToLogger = {\n-  development: {\n-    transport: {\n-      target: 'pino-pretty',\n-      options: {\n-        singleLine: true,\n-        translateTime: 'HH:MM:ss Z',\n-        ignore: 'pid,hostname'\n-      }\n-    },\n-    level: FCC_API_LOG_LEVEL || 'info',\n-    serializers: {\n-      req: (req: FastifyRequest) => {\n-        return {\n-          method: req.method,\n-          url: req.url\n-        };\n-      }\n-    }\n-    // No need to redact in development\n-  },\n-  production: {\n-    level: FCC_API_LOG_LEVEL || 'info',\n-    serializers: {\n-      req: requestSerializer\n-    },\n-    redact: ['req.HEADERS.cookie']\n-  }\n-};\n+import { build, buildOptions } from './app';\n+import { HOST, PORT } from './utils/env';\n \n const start = async () => {\n-  const fastify = await build({\n-    logger: envToLogger[FREECODECAMP_NODE_ENV] ?? true,\n-    genReqId: () => randomBytes(8).toString('hex'),\n-    disableRequestLogging: true\n-  });\n+  const fastify = await build(buildOptions);\n   try {\n     const port = Number(PORT);\n     fastify.log.info(`Starting server on port ${port}`);"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 77,
        "deletions": 75
    }
}