{
    "author": "ojeytonwilliams",
    "message": "feat(api): add more debug logging (#61980)",
    "sha": "d781102513bbba1b15dde7fc4a3f25d872cb0ed4",
    "files": [
        {
            "sha": "dff2cdfbc939455de4678cb380a5b85f768dd121",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d781102513bbba1b15dde7fc4a3f25d872cb0ed4/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d781102513bbba1b15dde7fc4a3f25d872cb0ed4/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=d781102513bbba1b15dde7fc4a3f25d872cb0ed4",
            "patch": "@@ -86,6 +86,7 @@ export const buildOptions: FastifyHttpOptions<\n > = {\n   loggerInstance: getLogger(),\n   genReqId: () => randomBytes(8).toString('hex'),\n+  // disabled so we can customise the request/response logging\n   disableRequestLogging: true\n };\n \n@@ -104,6 +105,17 @@ export const build = async (\n   const fastify = Fastify(options).withTypeProvider<TypeBoxTypeProvider>();\n \n   fastify.setValidatorCompiler(({ schema }) => ajv.compile(schema));\n+  fastify.addHook('onRequest', (req, _reply, done) => {\n+    const logger = fastify.log.child({ req });\n+    logger.debug({ req }, 'received request');\n+    done();\n+  });\n+\n+  fastify.addHook('onResponse', (req, reply, done) => {\n+    const logger = fastify.log.child({ res: reply });\n+    logger.debug({ req, res: reply }, 'responding to request');\n+    done();\n+  });\n \n   void fastify.register(redirectWithMessage);\n   void fastify.register(security);"
        },
        {
            "sha": "73bcb588d5ba8edaed3f403187ca7186375dc4f8",
            "filename": "api/src/plugins/cors.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d781102513bbba1b15dde7fc4a3f25d872cb0ed4/api%2Fsrc%2Fplugins%2Fcors.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d781102513bbba1b15dde7fc4a3f25d872cb0ed4/api%2Fsrc%2Fplugins%2Fcors.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcors.test.ts?ref=d781102513bbba1b15dde7fc4a3f25d872cb0ed4",
            "patch": "@@ -2,12 +2,11 @@ import { describe, test, expect, beforeAll, afterAll, vi } from 'vitest';\n import Fastify, { FastifyInstance, LogLevel } from 'fastify';\n import cors from './cors';\n \n-const LOG_LEVELS: LogLevel[] = [\n+const NON_DEBUG_LOG_LEVELS: LogLevel[] = [\n   'fatal',\n   'error',\n   'warn',\n   'info',\n-  'debug',\n   'trace'\n ];\n \n@@ -22,27 +21,31 @@ describe('cors', () => {\n     await fastify.close();\n   });\n \n-  test('should not log for /status/* routes', async () => {\n+  test('should only debug log for /status/* routes', async () => {\n     const logger = fastify.log.child({ req: { url: '/status/ping' } });\n-    const spies = LOG_LEVELS.map(level => vi.spyOn(logger, level));\n+    const spies = NON_DEBUG_LOG_LEVELS.map(level => vi.spyOn(logger, level));\n+    const debugSpy = vi.spyOn(logger, 'debug');\n     await fastify.inject({\n       url: '/status/ping'\n     });\n \n     spies.forEach(spy => {\n       expect(spy).not.toHaveBeenCalled();\n     });\n+    expect(debugSpy).toHaveBeenCalled();\n   });\n \n-  test('should not log if the origin is undefined', async () => {\n+  test('should debug log if the origin is undefined', async () => {\n     const logger = fastify.log.child({ req: { url: '/api/some-endpoint' } });\n-    const spies = LOG_LEVELS.map(level => vi.spyOn(logger, level));\n+    const spies = NON_DEBUG_LOG_LEVELS.map(level => vi.spyOn(logger, level));\n+    const debugSpy = vi.spyOn(logger, 'debug');\n     await fastify.inject({\n       url: '/api/some-endpoint'\n     });\n \n     spies.forEach(spy => {\n       expect(spy).not.toHaveBeenCalled();\n     });\n+    expect(debugSpy).toHaveBeenCalled();\n   });\n });"
        },
        {
            "sha": "faa52f8b17c4e988aa3913ab846eaa3b6014f367",
            "filename": "api/src/plugins/cors.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d781102513bbba1b15dde7fc4a3f25d872cb0ed4/api%2Fsrc%2Fplugins%2Fcors.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d781102513bbba1b15dde7fc4a3f25d872cb0ed4/api%2Fsrc%2Fplugins%2Fcors.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcors.ts?ref=d781102513bbba1b15dde7fc4a3f25d872cb0ed4",
            "patch": "@@ -10,10 +10,10 @@ const cors: FastifyPluginCallback = (fastify, _options, done) => {\n   });\n \n   fastify.addHook('onRequest', async (req, reply) => {\n-    const logger = fastify.log.child({ req, res: reply });\n+    const logger = fastify.log.child({ req });\n     const origin = req.headers.origin;\n     if (origin && allowedOrigins.includes(origin)) {\n-      // Do we want to log allowed origins?\n+      logger.debug(`Allowing access to origin: ${origin}`);\n       void reply.header('Access-Control-Allow-Origin', origin);\n     } else {\n       // TODO: Discuss if this is the correct approach. Standard practice is to\n@@ -24,6 +24,8 @@ const cors: FastifyPluginCallback = (fastify, _options, done) => {\n \n       if (origin && !req.url?.startsWith('/status/')) {\n         logger.info(`Received request from disallowed origin: ${origin}`);\n+      } else {\n+        logger.debug(`Unknown or missing origin: ${origin}`);\n       }\n     }\n "
        }
    ],
    "stats": {
        "total": 33,
        "additions": 25,
        "deletions": 8
    }
}