{
    "author": "ojeytonwilliams",
    "message": "feat(api): add logs to protected user routes (#59102)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "fa5f4cd83d025b2bfa382969d45f382c09a49544",
    "files": [
        {
            "sha": "6728c46008cf3eb38a70189115a160f2dc361f9a",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 7,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/fa5f4cd83d025b2bfa382969d45f382c09a49544/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/fa5f4cd83d025b2bfa382969d45f382c09a49544/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=fa5f4cd83d025b2bfa382969d45f382c09a49544",
            "patch": "@@ -64,6 +64,8 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.deleteMyAccount\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} requested account deletion`);\n       await fastify.prisma.userToken.deleteMany({\n         where: { userId: req.user!.id }\n       });\n@@ -88,6 +90,8 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.resetMyProgress\n     },\n     async req => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} requested progress reset`);\n       await fastify.prisma.userToken.deleteMany({\n         where: { userId: req.user!.id }\n       });\n@@ -107,6 +111,9 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n   );\n   // TODO(Post-MVP): POST -> PUT\n   fastify.post('/user/user-token', async req => {\n+    const logger = fastify.log.child({ req });\n+    logger.info(`User ${req.user?.id} requested a new user token`);\n+\n     await fastify.prisma.userToken.deleteMany({\n       where: { userId: req.user?.id }\n     });\n@@ -132,11 +139,15 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.deleteUserToken\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} requested token deletion`);\n+\n       const { count } = await fastify.prisma.userToken.deleteMany({\n         where: { userId: req.user?.id }\n       });\n \n       if (count === 0) {\n+        logger.warn('No userToken found for deletion');\n         void reply.code(404);\n         return {\n           message: 'userToken not found',\n@@ -157,13 +168,16 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} reported user ${req.body.username}`);\n+\n       const user = await fastify.prisma.user.findUniqueOrThrow({\n         where: { id: req.user?.id }\n       });\n       const { username, reportDescription: report } = req.body;\n \n       if (!username || !report) {\n-        // NOTE: Do we want to log these instances?\n+        logger.warn('Missing username or reportDescription');\n         void reply.code(400);\n         return {\n           type: 'danger',\n@@ -193,6 +207,9 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.deleteMsUsername\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} requested unlinking of msUsername`);\n+\n       try {\n         await fastify.prisma.msUsername.deleteMany({\n           where: { userId: req.user?.id }\n@@ -201,7 +218,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n         // TODO(Post-MVP): return a generic success message.\n         return { msUsername: null };\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         void reply.send({\n@@ -216,18 +233,23 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n     '/user/ms-username',\n     {\n       schema: schemas.postMsUsername,\n-      errorHandler(error, request, reply) {\n+      errorHandler(error, req, reply) {\n+        const logger = fastify.log.child({ req });\n         if (error.validation) {\n+          logger.warn({ validationError: error.validation });\n           void reply.code(400).send({\n             message: 'flash.ms.transcript.link-err-1',\n             type: 'error'\n           });\n         } else {\n-          fastify.errorHandler(error, request, reply);\n+          fastify.errorHandler(error, req, reply);\n         }\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} requested linking of msUsername`);\n+\n       try {\n         const user = await fastify.prisma.user.findUniqueOrThrow({\n           where: { id: req.user?.id }\n@@ -238,6 +260,10 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n         );\n \n         if (!msApiRes.ok) {\n+          logger.warn(\n+            { status: msApiRes.status },\n+            \"Unable to fetch user's Microsoft transcript\"\n+          );\n           return reply\n             .status(404)\n             .send({ type: 'error', message: 'flash.ms.transcript.link-err-2' });\n@@ -246,6 +272,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n         const { userName } = (await msApiRes.json()) as { userName: string };\n \n         if (!userName) {\n+          logger.warn('No userName found in msApiRes');\n           return reply.status(500).send({\n             type: 'error',\n             message: 'flash.ms.transcript.link-err-3'\n@@ -261,6 +288,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n         }));\n \n         if (usernameUsed) {\n+          logger.warn('msUsername already in use');\n           return reply.status(403).send({\n             type: 'error',\n             message: 'flash.ms.transcript.link-err-4'\n@@ -289,7 +317,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n \n         return { msUsername: userName };\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         return reply.code(500).send({\n           type: 'error',\n@@ -315,6 +343,8 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       }\n     },\n     async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info(`User ${req.user?.id} submitted a survey`);\n       try {\n         const user = await fastify.prisma.user.findUniqueOrThrow({\n           where: { id: req.user?.id }\n@@ -330,6 +360,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n           s => s.title === title\n         );\n         if (surveyAlreadyTaken) {\n+          logger.warn('Survey already taken');\n           return reply.code(400).send({\n             type: 'error',\n             message: 'flash.survey.err-2'\n@@ -350,7 +381,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n           message: 'flash.survey.success'\n         } as const;\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void reply.code(500);\n         return {\n@@ -383,6 +414,8 @@ async function examEnvironmentTokenHandler(\n   req: UpdateReqType<typeof schemas.userExamEnvironmentToken>,\n   reply: FastifyReply\n ) {\n+  const logger = this.log.child({ req });\n+  logger.info(`User ${req.user?.id} requested a new exam environment token`);\n   const userId = req.user?.id;\n   if (!userId) {\n     throw new Error('Unreachable. User should be authenticated.');\n@@ -433,6 +466,10 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n       schema: schemas.getSessionUser\n     },\n     async (req, res) => {\n+      const logger = fastify.log.child({ req });\n+      // This is one of the most requested routes. To avoid spamming the logs\n+      // with this route, we'll log requests at the debug level.\n+      logger.debug({ userId: req.user?.id });\n       try {\n         const userTokenP = fastify.prisma.userToken.findFirst({\n           where: { userId: req.user!.id }\n@@ -511,6 +548,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n           ]);\n \n         if (!user?.username) {\n+          logger.error(`User ${req.user?.id} has no username`);\n           void res.code(500);\n           return { user: {}, result: '' };\n         }\n@@ -570,7 +608,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n           result: user.username\n         });\n       } catch (err) {\n-        fastify.log.error(err);\n+        logger.error(err);\n         fastify.Sentry.captureException(err);\n         void res.code(500);\n         return { user: {}, result: '' };"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 45,
        "deletions": 7
    }
}