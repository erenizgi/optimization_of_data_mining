{
    "author": "ojeytonwilliams",
    "message": "refactor: use srcdoc instead of frame.write (#59161)",
    "sha": "fb416061281a06dbfa49c6a2794c0a252991291e",
    "files": [
        {
            "sha": "769a77c86ac2602e97f0e36e266f4a020364f59d",
            "filename": "client/src/templates/Challenges/utils/frame.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 30,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/fb416061281a06dbfa49c6a2794c0a252991291e/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fframe.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/fb416061281a06dbfa49c6a2794c0a252991291e/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fframe.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fframe.ts?ref=fb416061281a06dbfa49c6a2794c0a252991291e",
            "patch": "@@ -22,8 +22,11 @@ interface Hooks {\n \n export interface Context {\n   window?: Window &\n-    typeof globalThis & { i18nContent?: i18n; __pyodide: unknown };\n-  document?: FrameDocument | PythonDocument;\n+    typeof globalThis & {\n+      i18nContent?: i18n;\n+      __pyodide: unknown;\n+      document: FrameDocument | PythonDocument;\n+    };\n   element: HTMLIFrameElement;\n   build: string;\n   sources: Source;\n@@ -197,6 +200,7 @@ const createFrame =\n   (document: Document, id: string, title?: string) =>\n   (frameContext: Context) => {\n     const frame = document.createElement('iframe');\n+    frame.srcdoc = createContent(id, frameContext);\n     frame.id = id;\n     if (typeof title === 'string') {\n       frame.title = i18next.t('misc.iframe-preview', { title });\n@@ -225,7 +229,6 @@ const mountFrame =\n     return {\n       ...frameContext,\n       element,\n-      document: element.contentDocument,\n       window: element.contentWindow\n     };\n   };\n@@ -310,7 +313,7 @@ const initTestFrame = (frameReady?: () => void) => (frameContext: Context) => {\n       // provide the file name and get the original source\n       const getUserInput = (fileName: string) =>\n         toString(sources[fileName as keyof typeof sources]);\n-      await frameContext.document?.__initTestFrame({\n+      await frameContext.window?.document?.__initTestFrame({\n         code: sources,\n         getUserInput,\n         loadEnzyme\n@@ -348,11 +351,9 @@ const initMainFrame =\n           };\n         }\n \n-        if (\n-          frameContext.document &&\n-          '__initPythonFrame' in frameContext.document\n-        ) {\n-          await frameContext.document?.__initPythonFrame();\n+        const document = frameContext.window?.document;\n+        if (document && '__initPythonFrame' in document) {\n+          await document.__initPythonFrame();\n         }\n         if (frameReady) frameReady();\n       })\n@@ -369,15 +370,19 @@ function handleDocumentNotFound(err: string) {\n const initPreviewFrame = () => (frameContext: Context) => frameContext;\n \n const waitForFrame = (frameContext: Context) => {\n-  return new Promise((resolve, reject) => {\n-    if (!frameContext.document) {\n+  return new Promise<void>((resolve, reject) => {\n+    const rejectId = setTimeout(() => {\n       // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n       reject(DOCUMENT_NOT_FOUND_ERROR);\n-    } else if (frameContext.document.readyState === 'loading') {\n-      frameContext.document.addEventListener('DOMContentLoaded', resolve);\n-    } else {\n-      resolve(null);\n-    }\n+    }, 10000);\n+\n+    // We have to add the listener to the frame, not its contentWindow, because\n+    // the the latter does not receive the load event in Safari. It does not\n+    // matter which we use for Chrome and Firefox.\n+    frameContext.element?.addEventListener('load', () => {\n+      clearTimeout(rejectId);\n+      resolve();\n+    });\n   });\n };\n \n@@ -393,19 +398,6 @@ export const createContent = (\n   );\n };\n \n-const writeContentToFrame = (id: string) => (frameContext: Context) => {\n-  const frame = frameContext.document;\n-\n-  // it's possible, if the preview is rapidly opened and closed, for the frame\n-  // to be null at this point.\n-  if (frame) {\n-    frame.open();\n-    frame.write(createContent(id, frameContext));\n-    frame.close();\n-  }\n-  return frameContext;\n-};\n-\n const restoreScrollPosition = (frameContext: Context) => {\n   scrollManager.registerScrollEventListener(frameContext.element);\n \n@@ -478,7 +470,6 @@ const createFramer = ({\n     updateWindowFunctions ?? noop,\n     updateProxyConsole(proxyLogger),\n     updateWindowI18next,\n-    writeContentToFrame(id),\n     restoreScrollPosition,\n     init(frameReady, proxyLogger)\n   ) as (args: Context) => void;"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 21,
        "deletions": 30
    }
}