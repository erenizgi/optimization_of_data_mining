{
    "author": "ojeytonwilliams",
    "message": "fix(api): handle Date values for completedChallenge.completedDate (#60400)",
    "sha": "f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
    "files": [
        {
            "sha": "00ad0dd1873e5a778d64c0249353a913dd2f40d1",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -20,7 +20,7 @@ type File {\n \n type CompletedChallenge {\n   challengeType      Int?         @db.Int // Null | Undefined\n-  completedDate      Float // TODO(Post-MVP): Change to DateTime\n+  completedDate      Json // DateTime | Float, but not, as far as we know, Null\n   files              File[]\n   githubLink         String? // Undefined\n   id                 String"
        },
        {
            "sha": "01b14f71f7a626475ef3feedada179002d811ec8",
            "filename": "api/src/routes/helpers/certificate-utils.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fcertificate-utils.ts?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -1,7 +1,9 @@\n+import { Prisma } from '@prisma/client';\n import {\n   certSlugTypeMap,\n   certIds\n } from '../../../../shared/config/certification-settings';\n+import { normalizeDate } from '../../utils/normalize';\n \n const {\n   legacyInfosecQaId,\n@@ -41,12 +43,16 @@ export function isKnownCertSlug(\n  * @returns The latest certification date or the completed date if no certification is found.\n  */\n export function getFallbackFullStackDate(\n-  completedChallenges: { id: string; completedDate: number }[],\n-  completedDate: number\n-) {\n+  completedChallenges: { id: string; completedDate: Prisma.JsonValue }[],\n+  completedDate: Prisma.JsonValue\n+): number {\n   const latestCertDate = completedChallenges\n     .filter(chal => fullStackCertificateIds.includes(chal.id))\n+    .map(chal => ({\n+      ...chal,\n+      completedDate: normalizeDate(chal.completedDate)\n+    }))\n     .sort((a, b) => b.completedDate - a.completedDate)[0]?.completedDate;\n \n-  return latestCertDate ?? completedDate;\n+  return latestCertDate ?? normalizeDate(completedDate);\n }"
        },
        {
            "sha": "751cd7a081e64cff274e0149cb5d087473ad54f2",
            "filename": "api/src/routes/protected/challenge.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 10,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -35,6 +35,7 @@ import {\n   verifyTrophyWithMicrosoft\n } from '../helpers/challenge-helpers';\n import { UpdateReqType } from '../../utils';\n+import { normalizeDate } from '../../utils/normalize';\n \n interface JwtPayload {\n   userToken: string;\n@@ -263,13 +264,12 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n           'User tried to submit a codeRoad cert project before completing the required challenges'\n         );\n         void reply.code(403);\n-        return {\n+        return reply.send({\n           type: 'error',\n           message:\n             'You have to complete the project before you can submit a URL.'\n-        } as const;\n+        });\n       }\n-\n       const challenge = {\n         challengeType,\n         solution,\n@@ -287,13 +287,13 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         challenge\n       );\n \n-      return {\n+      reply.send({\n         alreadyCompleted,\n         // TODO(Post-MVP): audit the client and remove this if the client does\n         // not use it.\n-        completedDate,\n+        completedDate: normalizeDate(completedDate),\n         points: alreadyCompleted ? points : points + 1\n-      };\n+      });\n     }\n   );\n \n@@ -685,11 +685,11 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n             completedChallenge\n           );\n \n-        return {\n+        reply.send({\n           alreadyCompleted,\n           points: getPoints(progressTimestamps) + (alreadyCompleted ? 0 : 1),\n-          completedDate\n-        };\n+          completedDate: normalizeDate(completedDate)\n+        });\n       } catch (error) {\n         logger.error(error, 'Error submitting Microsoft trophy challenge');\n         fastify.Sentry.captureException(error);\n@@ -808,7 +808,10 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n         }\n \n         const newCompletedChallenges: CompletedChallenge[] =\n-          completedChallenges;\n+          completedChallenges.map(c => {\n+            const { completedDate, ...rest } = c;\n+            return { completedDate: normalizeDate(completedDate), ...rest };\n+          });\n         const newCompletedExams: CompletedExam[] = completedExams;\n         const newProgressTimeStamps = progressTimestamps as ProgressTimestamp[];\n         const completedDate = Date.now();"
        },
        {
            "sha": "f9027ec9d4335150a0d8e19e87ec810c7300d5fa",
            "filename": "api/src/routes/public/certificate.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fcertificate.ts?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -13,6 +13,7 @@ import {\n   getFallbackFullStackDate,\n   isKnownCertSlug\n } from '../helpers/certificate-utils';\n+import { normalizeDate } from '../../utils/normalize';\n \n /**\n  * Plugin for the unprotected certificate endpoints.\n@@ -228,7 +229,7 @@ export const unprotectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n           certSlug,\n           certTitle,\n           username,\n-          date: completedDate,\n+          date: normalizeDate(completedDate),\n           completionTime\n         });\n       }\n@@ -239,7 +240,7 @@ export const unprotectedCertificateRoutes: FastifyPluginCallbackTypebox = (\n         certTitle,\n         username,\n         name,\n-        date: completedDate,\n+        date: normalizeDate(completedDate),\n         completionTime\n       });\n     }"
        },
        {
            "sha": "2cf46fa0112a23f6b5b8386d68ab2668d42acec1",
            "filename": "api/src/utils/common-challenge-functions.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fcommon-challenge-functions.ts?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -3,6 +3,7 @@ import { FastifyInstance } from 'fastify';\n import { omit, pick } from 'lodash';\n import { challengeTypes } from '../../../shared/config/challenge-types';\n import { getChallenges } from './get-challenges';\n+import { normalizeDate } from './normalize';\n \n export const jsCertProjectIds = [\n   'aaa48de84e1ecc7c742e1124',\n@@ -149,7 +150,8 @@ export async function updateUserChallengeData(\n             'path',\n             'ext'\n           ]) as CompletedChallengeFile\n-      )\n+      ),\n+      completedDate: normalizeDate(_completedChallenge.completedDate)\n     };\n   } else {\n     completedChallenge = omit(_completedChallenge, ['files']);\n@@ -171,7 +173,7 @@ export async function updateUserChallengeData(\n   const finalChallenge = alreadyCompleted\n     ? {\n         ...completedChallenge,\n-        completedDate: oldChallenge.completedDate\n+        completedDate: normalizeDate(oldChallenge.completedDate)\n       }\n     : completedChallenge;\n \n@@ -180,7 +182,11 @@ export async function updateUserChallengeData(\n   // check and update some property of the user record such that the same update\n   // can't be applied twice.\n   const userCompletedChallenges = alreadyCompleted\n-    ? completedChallenges.map(x => (x.id === challengeId ? finalChallenge : x))\n+    ? completedChallenges.map(x =>\n+        x.id === challengeId\n+          ? finalChallenge\n+          : { ...x, completedDate: normalizeDate(x.completedDate) }\n+      )\n     : { push: finalChallenge };\n \n   // We can't use push, because progressTimestamps is a JSON blob and, until"
        },
        {
            "sha": "94a38321f6ed3864be1a97d4c018c6c3d80ec3da",
            "filename": "api/src/utils/normalize.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Futils%2Fnormalize.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Futils%2Fnormalize.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fnormalize.test.ts?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -2,7 +2,8 @@ import {\n   normalizeTwitter,\n   normalizeProfileUI,\n   normalizeChallenges,\n-  normalizeFlags\n+  normalizeFlags,\n+  normalizeDate\n } from './normalize';\n \n describe('normalize', () => {\n@@ -156,4 +157,22 @@ describe('normalize', () => {\n       });\n     });\n   });\n+\n+  describe('validateDate', () => {\n+    it('should return the date as a number', () => {\n+      expect(normalizeDate(1)).toEqual(1);\n+      expect(normalizeDate({ $date: '2023-10-01T00:00:00Z' })).toEqual(\n+        1696118400000\n+      );\n+    });\n+\n+    it('should throw an error if the date is not in the expected shape', () => {\n+      expect(() => normalizeDate('2023-10-01T00:00:00Z')).toThrow(\n+        'Unexpected date value: \"2023-10-01T00:00:00Z\"'\n+      );\n+      expect(() => normalizeDate({ date: '123' })).toThrow(\n+        'Unexpected date value: {\"date\":\"123\"}'\n+      );\n+    });\n+  });\n });"
        },
        {
            "sha": "4bd341dcddb477ef88d8ac94ea500197025104b6",
            "filename": "api/src/utils/normalize.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 3,
            "changes": 36,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Futils%2Fnormalize.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f5b0071a68aca7b88a6cf8ccbc8685153f93462c/api%2Fsrc%2Futils%2Fnormalize.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fnormalize.ts?ref=f5b0071a68aca7b88a6cf8ccbc8685153f93462c",
            "patch": "@@ -1,10 +1,11 @@\n /* This module's job is to parse the database output and prepare it for\n serialization */\n-import {\n+import type {\n   ProfileUI,\n   CompletedChallenge,\n   ExamResults,\n-  type Survey\n+  Survey,\n+  Prisma\n } from '@prisma/client';\n import _ from 'lodash';\n \n@@ -39,6 +40,27 @@ export const normalizeTwitter = (\n   return url ?? handleOrUrl;\n };\n \n+/**\n+ * Normalizes a date value to a timestamp number.\n+ *\n+ * @param date An object with a $date string or a number.\n+ * @returns The date as a timestamp number.\n+ */\n+export const normalizeDate = (date?: Prisma.JsonValue): number => {\n+  if (typeof date === 'number') {\n+    return date;\n+  } else if (\n+    date &&\n+    typeof date === 'object' &&\n+    '$date' in date &&\n+    typeof date.$date === 'string'\n+  ) {\n+    return new Date(date.$date).getTime();\n+  } else {\n+    throw Error('Unexpected date value: ' + JSON.stringify(date));\n+  }\n+};\n+\n /**\n  * Ensure that the user's profile UI settings are valid.\n  *\n@@ -114,7 +136,15 @@ export const normalizeChallenges = (\n     return { ...rest, files: noNullFiles };\n   });\n \n-  return noNullPath;\n+  const withNumberDates = noNullPath.map(challenge => {\n+    const { completedDate, ...rest } = challenge;\n+    return {\n+      ...rest,\n+      completedDate: normalizeDate(completedDate)\n+    };\n+  });\n+\n+  return withNumberDates;\n };\n \n type NormalizedSurvey = {"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 89,
        "deletions": 24
    }
}