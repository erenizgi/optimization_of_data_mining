{
    "author": "ojeytonwilliams",
    "message": "feat(api): remove rate limiting (#58289)",
    "sha": "9429f52fd42b7066a36bd6a69044401ce5c39af2",
    "files": [
        {
            "sha": "bacbccf46fc751ce87e29555fdbfe5b0e3f7c4f1",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=9429f52fd42b7066a36bd6a69044401ce5c39af2",
            "patch": "@@ -127,16 +127,6 @@ const indexData: IndexData[] = [\n     collection: 'Survey',\n     indexes: [{ key: { userId: 1 }, name: 'userId_1' }]\n   },\n-  {\n-    collection: 'UserRateLimit',\n-    indexes: [\n-      {\n-        key: { expirationDate: 1 },\n-        name: 'expirationDate_1',\n-        expireAfterSeconds: 0\n-      }\n-    ]\n-  },\n   {\n     collection: 'UserToken',\n     indexes: [{ key: { userId: 1 }, name: 'userId_1' }]"
        },
        {
            "sha": "bd21cd68af1e745a07b84a376158ca23b2fb82e4",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=9429f52fd42b7066a36bd6a69044401ce5c39af2",
            "patch": "@@ -9,7 +9,6 @@\n     \"@fastify/cookie\": \"9.4.0\",\n     \"@fastify/csrf-protection\": \"6.4.1\",\n     \"@fastify/oauth2\": \"7.8.1\",\n-    \"@fastify/rate-limit\": \"9.1.0\",\n     \"@fastify/swagger\": \"8.14.0\",\n     \"@fastify/swagger-ui\": \"1.10.2\",\n     \"@fastify/type-provider-typebox\": \"3.6.0\",\n@@ -33,7 +32,6 @@\n     \"nodemon\": \"2.0.22\",\n     \"pino-pretty\": \"10.2.3\",\n     \"query-string\": \"7.1.3\",\n-    \"rate-limit-mongo\": \"^2.3.2\",\n     \"stripe\": \"16.0.0\",\n     \"validator\": \"13.11.0\"\n   },"
        },
        {
            "sha": "f606d142de588e69a7e9d9a0c743e9e62ce6fa08",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=9429f52fd42b7066a36bd6a69044401ce5c39af2",
            "patch": "@@ -365,14 +365,6 @@ model Donation {\n   @@index([userId], map: \"userId_1\")\n }\n \n-model UserRateLimit {\n-  id             String   @id @map(\"_id\")\n-  counter        Int\n-  expirationDate DateTime @db.Date\n-\n-  @@index([expirationDate], map: \"expirationDate_1\")\n-}\n-\n model UserToken {\n   id      String   @id @map(\"_id\")\n   created DateTime @db.Date"
        },
        {
            "sha": "43eab1b46ef395e79f12f107ef81b3391c6aaf3b",
            "filename": "api/src/routes/public/auth.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fsrc%2Froutes%2Fpublic%2Fauth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fsrc%2Froutes%2Fpublic%2Fauth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth.test.ts?ref=9429f52fd42b7066a36bd6a69044401ce5c39af2",
            "patch": "@@ -54,26 +54,11 @@ describe('auth0 routes', () => {\n       superGet = createSuperRequest({ method: 'GET' });\n     });\n     beforeEach(async () => {\n-      await fastifyTestInstance.prisma.userRateLimit.deleteMany({});\n       await fastifyTestInstance.prisma.user.deleteMany({\n         where: { email: newUserEmail }\n       });\n     });\n \n-    it('should be rate-limited', async () => {\n-      // Rather than spamming the endpoint, we can check the headers.\n-      const res = await superGet('/mobile-login');\n-      // These headers are semi-official\n-      // https://www.ietf.org/archive/id/draft-polli-ratelimit-headers-02.html\n-      // so should not depend on the details of the rate-limiting library\n-      expect(res.headers['ratelimit-limit']).toBe('10');\n-      expect(res.headers['ratelimit-remaining']).toBe('9');\n-      expect(res.headers['ratelimit-reset']).toMatch(/^\\d+$/);\n-\n-      const res2 = await superGet('/mobile-login');\n-      expect(res2.headers['ratelimit-remaining']).toBe('8');\n-    });\n-\n     it('should return 401 if the authorization header is invalid', async () => {\n       mockedFetch.mockResolvedValueOnce(mockAuth0NotOk());\n       const res = await superGet('/mobile-login').set("
        },
        {
            "sha": "fcc67f216a4a769631ef1c94780d2de993044297",
            "filename": "api/src/routes/public/auth.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 70,
            "changes": 78,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fsrc%2Froutes%2Fpublic%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9429f52fd42b7066a36bd6a69044401ce5c39af2/api%2Fsrc%2Froutes%2Fpublic%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth.ts?ref=9429f52fd42b7066a36bd6a69044401ce5c39af2",
            "patch": "@@ -1,15 +1,7 @@\n-import type {\n-  FastifyPluginCallback,\n-  FastifyPluginAsync,\n-  FastifyRequest,\n-  RouteOptions\n-} from 'fastify';\n-import rateLimit, { type FastifyRateLimitStore } from '@fastify/rate-limit';\n-// @ts-expect-error - no types\n-import MongoStoreRL from 'rate-limit-mongo';\n+import type { FastifyPluginCallback, FastifyRequest } from 'fastify';\n import isEmail from 'validator/lib/isEmail';\n \n-import { AUTH0_DOMAIN, MONGOHQ_URL } from '../../utils/env';\n+import { AUTH0_DOMAIN } from '../../utils/env';\n import { auth0Client } from '../../plugins/auth0';\n import { createAccessToken } from '../../utils/tokens';\n import { findOrCreateUser } from '../helpers/auth-helpers';\n@@ -31,75 +23,19 @@ const getEmailFromAuth0 = async (\n   return typeof email === 'string' ? email : null;\n };\n \n-// TODO: Use Redis! Then we don't need to maintain this store.\n-class Store implements FastifyRateLimitStore {\n-  mongoStore: MongoStoreRL;\n-  // We don't really need this.options, but it's here for consistency with the\n-  // custom store in the fastify-rate-limit docs.\n-  options: { timeWindow: number };\n-  constructor({ timeWindow }: { timeWindow: number }) {\n-    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call\n-    this.mongoStore = new MongoStoreRL({\n-      collectionName: 'UserRateLimit',\n-      uri: MONGOHQ_URL,\n-      expireTimeMs: timeWindow // timeWindow is Fastify's equivalent of express-rate-limit's expireTimeMs\n-    });\n-    this.options = { timeWindow };\n-  }\n-\n-  incr(\n-    key: string,\n-    cb: (err: Error | null, result?: { current: number; ttl: number }) => void\n-  ) {\n-    // This converts between what rate-limit-mongo calls and what\n-    // fastify-rate-limit expects\n-    const callbackConverted = (\n-      err: Error | null,\n-      current: number,\n-      expires: Date\n-    ) => {\n-      const ttl = expires.getTime() - Date.now();\n-      cb(err, { current, ttl });\n-    };\n-    // eslint-disable-next-line @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access\n-    this.mongoStore.incr(key, callbackConverted);\n-  }\n-\n-  // routeOptions are ignored for now, but this is the signature we need to implement\n-  child(\n-    routeOptions: RouteOptions & { path: string; prefix: string }\n-  ): FastifyRateLimitStore {\n-    const childParams = { ...this.options, ...routeOptions };\n-    const store = new Store(childParams);\n-    return store;\n-  }\n-}\n-\n /**\n  * Route handler for Mobile authentication.\n  *\n  * @param fastify The Fastify instance.\n  * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n  *\n  */\n-export const mobileAuth0Routes: FastifyPluginAsync = async (\n+export const mobileAuth0Routes: FastifyPluginCallback = (\n   fastify,\n-  _options\n+  _options,\n+  done\n ) => {\n-  // Rate limit for mobile login\n-  // 10 requests per 15 minute windows\n-  // @ts-expect-error - no types\n-  await fastify.register(rateLimit, {\n-    timeWindow: 15 * 60 * 1000,\n-    max: 10,\n-    enableDraftSpec: true, // ratelimit-* instead of x-ratelimit-*\n-    keyGenerator: req => {\n-      return (req.headers['x-forwarded-for'] as string) || 'localhost';\n-    },\n-    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call\n-    store: Store\n-  });\n-\n   // TODO(Post-MVP): move this into the app, so that we add this hook once for\n   // all auth routes.\n   fastify.addHook('onRequest', fastify.redirectIfSignedIn);\n@@ -124,6 +60,8 @@ export const mobileAuth0Routes: FastifyPluginAsync = async (\n \n     reply.setAccessTokenCookie(createAccessToken(id));\n   });\n+\n+  done();\n };\n \n /**"
        },
        {
            "sha": "f6864609ee0c1d3073c739c3ebb4fa42b7db490d",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 13,
            "deletions": 30,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9429f52fd42b7066a36bd6a69044401ce5c39af2/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9429f52fd42b7066a36bd6a69044401ce5c39af2/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=9429f52fd42b7066a36bd6a69044401ce5c39af2",
            "patch": "@@ -147,9 +147,6 @@ importers:\n       '@fastify/oauth2':\n         specifier: 7.8.1\n         version: 7.8.1\n-      '@fastify/rate-limit':\n-        specifier: 9.1.0\n-        version: 9.1.0\n       '@fastify/swagger':\n         specifier: 8.14.0\n         version: 8.14.0\n@@ -219,9 +216,6 @@ importers:\n       query-string:\n         specifier: 7.1.3\n         version: 7.1.3\n-      rate-limit-mongo:\n-        specifier: ^2.3.2\n-        version: 2.3.2\n       stripe:\n         specifier: 16.0.0\n         version: 16.0.0\n@@ -3038,9 +3032,6 @@ packages:\n   '@fastify/oauth2@7.8.1':\n     resolution: {integrity: sha512-PBIMizzgEOcUcttyfX1hC6CR9vESoI1lfNucBywgcqrxvknVg+zvBCgH2+oU8NvrpSDMtlY6nyuEYYZtVhDT7Q==}\n \n-  '@fastify/rate-limit@9.1.0':\n-    resolution: {integrity: sha512-h5dZWCkuZXN0PxwqaFQLxeln8/LNwQwH9popywmDCFdKfgpi4b/HoMH1lluy6P+30CG9yzzpSpwTCIPNB9T1JA==}\n-\n   '@fastify/send@2.1.0':\n     resolution: {integrity: sha512-yNYiY6sDkexoJR0D8IDy3aRP3+L4wdqCpvx5WP+VtEU58sn7USmKynBzDQex5X42Zzvw2gNzzYgP90UfWShLFA==}\n \n@@ -12749,10 +12740,6 @@ packages:\n     resolution: {integrity: sha512-3oDzcogWGHZdkwrHyvJVpPjA7oNzY6ENOV3PsWJY9XYPZ6INo94Yd47s5may1U+nleBPwDhrRiTPMIvKaa3MQg==}\n     engines: {node: '>=12'}\n \n-  toad-cache@3.7.0:\n-    resolution: {integrity: sha512-/m8M+2BJUpoJdgAHoG+baCwBT+tf2VraSfkBgl0Y00qIWt41DJ8R5B8nsEw0I58YwF5IZH6z24/2TobDKnqSWw==}\n-    engines: {node: '>=12'}\n-\n   toidentifier@1.0.0:\n     resolution: {integrity: sha512-yaOH/Pk/VEhBWWTlhI+qXxDFXlejDGcQipMlyxda9nthulaxLZUNcUqFxokp0vcYnvteJln5FNQDRrxj3YcbVw==}\n     engines: {node: '>=0.6'}\n@@ -14489,7 +14476,7 @@ snapshots:\n       '@babel/traverse': 7.23.7\n       '@babel/types': 7.23.9\n       convert-source-map: 2.0.0\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       gensync: 1.0.0-beta.2\n       json5: 2.2.3\n       semver: 6.3.1\n@@ -16694,7 +16681,7 @@ snapshots:\n       '@babel/helper-split-export-declaration': 7.22.6\n       '@babel/parser': 7.23.6\n       '@babel/types': 7.23.9\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       globals: 11.12.0\n     transitivePeerDependencies:\n       - supports-color\n@@ -17033,12 +17020,6 @@ snapshots:\n     transitivePeerDependencies:\n       - supports-color\n \n-  '@fastify/rate-limit@9.1.0':\n-    dependencies:\n-      '@lukeed/ms': 2.0.2\n-      fastify-plugin: 4.5.1\n-      toad-cache: 3.7.0\n-\n   '@fastify/send@2.1.0':\n     dependencies:\n       '@lukeed/ms': 2.0.2\n@@ -19265,7 +19246,7 @@ snapshots:\n \n   agent-base@6.0.2:\n     dependencies:\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n     transitivePeerDependencies:\n       - supports-color\n \n@@ -19592,7 +19573,7 @@ snapshots:\n     dependencies:\n       '@fastify/error': 3.4.1\n       archy: 1.0.0\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       fastq: 1.17.1\n     transitivePeerDependencies:\n       - supports-color\n@@ -21172,6 +21153,10 @@ snapshots:\n     optionalDependencies:\n       supports-color: 5.5.0\n \n+  debug@4.3.4:\n+    dependencies:\n+      ms: 2.1.2\n+\n   debug@4.3.4(supports-color@8.1.1):\n     dependencies:\n       ms: 2.1.2\n@@ -24106,7 +24091,7 @@ snapshots:\n   https-proxy-agent@5.0.1:\n     dependencies:\n       agent-base: 6.0.2\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n     transitivePeerDependencies:\n       - supports-color\n \n@@ -24652,7 +24637,7 @@ snapshots:\n \n   istanbul-lib-source-maps@4.0.1:\n     dependencies:\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       istanbul-lib-coverage: 3.2.0\n       source-map: 0.6.1\n     transitivePeerDependencies:\n@@ -25198,7 +25183,7 @@ snapshots:\n \n   json-schema-resolver@2.0.0:\n     dependencies:\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       rfdc: 1.3.0\n       uri-js: 4.4.1\n     transitivePeerDependencies:\n@@ -28999,7 +28984,7 @@ snapshots:\n     dependencies:\n       '@hapi/hoek': 11.0.4\n       '@hapi/wreck': 18.1.0\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       joi: 17.12.2\n     transitivePeerDependencies:\n       - supports-color\n@@ -29621,7 +29606,7 @@ snapshots:\n     dependencies:\n       component-emitter: 1.3.0\n       cookiejar: 2.1.4\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       fast-safe-stringify: 2.1.1\n       form-data: 4.0.0\n       formidable: 2.1.2\n@@ -29873,8 +29858,6 @@ snapshots:\n \n   toad-cache@3.3.0: {}\n \n-  toad-cache@3.7.0: {}\n-\n   toidentifier@1.0.0: {}\n \n   toidentifier@1.0.1: {}"
        }
    ],
    "stats": {
        "total": 156,
        "additions": 21,
        "deletions": 135
    }
}