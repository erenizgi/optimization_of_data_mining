{
    "author": "Sembauke",
    "message": "feat: validate portfolio image correctly (#57084)",
    "sha": "ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a",
    "files": [
        {
            "sha": "7d45bae306b12a46844e8f936d2a72fa82f88f69",
            "filename": "client/src/components/profile/components/portfolio.tsx",
            "status": "modified",
            "additions": 61,
            "deletions": 24,
            "changes": 85,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fportfolio.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fportfolio.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Fprofile%2Fcomponents%2Fportfolio.tsx?ref=ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a",
            "patch": "@@ -33,6 +33,7 @@ type PortfolioProps = {\n type PortfolioState = {\n   portfolio: PortfolioProjectData[];\n   unsavedItemId: string | null;\n+  isImageValid: ProfileValidation;\n };\n \n interface ProfileValidation {\n@@ -55,15 +56,20 @@ function createFindById(id: string) {\n }\n \n class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n+  validationImage: HTMLImageElement;\n   static displayName: string;\n   constructor(props: PortfolioProps) {\n     super(props);\n-\n+    this.validationImage = new Image();\n     const { portfolio = [] } = props;\n \n     this.state = {\n       portfolio: [...portfolio],\n-      unsavedItemId: null\n+      unsavedItemId: null,\n+      isImageValid: {\n+        state: 'success',\n+        message: ''\n+      }\n     };\n   }\n \n@@ -76,7 +82,7 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n     (e: React.ChangeEvent<HTMLInputElement>) => {\n       e.preventDefault();\n       const userInput = e.target.value.slice();\n-      return this.setState(state => {\n+      this.setState(state => {\n         const { portfolio: currentPortfolio } = state;\n         const mutablePortfolio = currentPortfolio.slice(0);\n         const index = findIndex(currentPortfolio, p => p.id === id);\n@@ -86,6 +92,14 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n           [key]: userInput\n         };\n \n+        if (key === 'image' && userInput) {\n+          void this.validateImageLoad(userInput).then(imageValidation => {\n+            this.setState({ isImageValid: imageValidation });\n+          });\n+        } else if (key === 'image' && !userInput) {\n+          this.setState({ isImageValid: { state: 'success', message: '' } });\n+        }\n+\n         return { portfolio: mutablePortfolio };\n       });\n     };\n@@ -168,29 +182,45 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n     return { state: 'success', message: '' };\n   }\n \n-  getUrlValidation(maybeUrl: string, isImage?: boolean) {\n-    const { t } = this.props;\n-    const len = maybeUrl.length;\n-    if (len >= 4 && !hasProtocolRE.test(maybeUrl)) {\n-      return {\n-        state: 'error',\n-        message: t('validation.invalid-protocol')\n+  async validateImageLoad(image: string): Promise<ProfileValidation> {\n+    return new Promise(resolve => {\n+      this.validationImage.src = encodeURI(image);\n+\n+      this.validationImage.onload = () => {\n+        resolve({\n+          state: 'success',\n+          message: ''\n+        });\n       };\n+\n+      this.validationImage.onerror = () => {\n+        resolve({\n+          state: 'error',\n+          message: this.props.t('validation.url-not-image')\n+        });\n+      };\n+    });\n+  }\n+\n+  getUrlValidation(url: string) {\n+    const { t } = this.props;\n+    const len = url.length;\n+\n+    if (!url) {\n+      return { state: 'success', message: '' };\n     }\n-    if (isImage && !maybeUrl) {\n-      return { state: null, message: '' };\n-    }\n-    if (isImage && !/\\.(png|jpg|jpeg|gif)$/.test(maybeUrl)) {\n+\n+    if (len >= 4 && !hasProtocolRE.test(url)) {\n       return {\n         state: 'error',\n-        message: t('validation.url-not-image')\n+        message: t('validation.invalid-protocol')\n       };\n     }\n-    return isURL(maybeUrl)\n+\n+    return isURL(url)\n       ? { state: 'success', message: '' }\n       : { state: 'warning', message: t('validation.use-valid-url') };\n   }\n-\n   formCorrect(portfolio: PortfolioProjectData) {\n     const { id, title, description, url, image } = portfolio;\n \n@@ -199,10 +229,9 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n     const { state: urlState, message: urlMessage } = this.getUrlValidation(url);\n     const { state: descriptionState, message: descriptionMessage } =\n       this.getDescriptionValidation(description);\n-    const { state: imageState, message: imageMessage } = this.getUrlValidation(\n-      image,\n-      true\n-    );\n+    const { state: imageState, message: imageMessage } =\n+      this.getUrlValidation(image);\n+\n     const pristine = this.isFormPristine(id);\n \n     const urlIsValid = !isURL(url, {\n@@ -263,6 +292,13 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n       this.toggleEditing();\n       return this.updateItem(id);\n     };\n+\n+    const combineImageStatus =\n+      imageState === 'success' && this.state.isImageValid.state === 'success'\n+        ? null\n+        : 'error';\n+    const combineImageMessage = imageMessage || this.state.isImageValid.message;\n+\n     return (\n       <FullWidthRow key={id}>\n         <form\n@@ -316,7 +352,7 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n           </FormGroup>\n           <FormGroup\n             controlId={`${id}-image`}\n-            validationState={pristine ? null : imageState}\n+            validationState={pristine ? null : combineImageStatus}\n           >\n             <ControlLabel htmlFor={`${id}-image-input`}>\n               {t('settings.labels.image')}\n@@ -328,9 +364,9 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n               name='portfolio-image'\n               id={`${id}-image-input`}\n             />\n-            {imageMessage ? (\n+            {combineImageMessage ? (\n               <HelpBlock data-playwright-test-label='image-validation'>\n-                {imageMessage}\n+                {combineImageMessage}\n               </HelpBlock>\n             ) : null}\n           </FormGroup>\n@@ -387,6 +423,7 @@ class PortfolioSettings extends Component<PortfolioProps, PortfolioState> {\n   render() {\n     const { t } = this.props;\n     const { portfolio = [], unsavedItemId } = this.state;\n+\n     return (\n       <section id='portfolio-settings'>\n         <SectionHeader>{t('settings.headings.portfolio')}</SectionHeader>"
        },
        {
            "sha": "631daba3f7734a1f46439e6abc5b8afcd9a31867",
            "filename": "e2e/portfolio.spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a/e2e%2Fportfolio.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a/e2e%2Fportfolio.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fportfolio.spec.ts?ref=ef25dfee50ae4f73fb7d4896138d2f6ec5a8783a",
            "patch": "@@ -63,12 +63,21 @@ test.describe('Add Portfolio Item', () => {\n   test('The image has validation', async ({ page }) => {\n     await page.getByLabel(translations.settings.labels.image).fill('T');\n     await expect(page.getByTestId('image-validation')).toContainText(\n-      'URL must link directly to an image file'\n+      'Please use a valid URL'\n     );\n     await page\n       .getByLabel(translations.settings.labels.image)\n-      .fill('http://helloworld.com/image.png');\n+      .fill(\n+        'https://cdn.freecodecamp.org/universal/favicons/favicon-32x32.png'\n+      );\n     await expect(page.getByTestId('image-validation')).toBeHidden();\n+\n+    await page\n+      .getByLabel(translations.settings.labels.image)\n+      .fill('https://cdn.freecodecamp.org/universal/favicons/favicon-32x32.pn');\n+    await expect(page.getByTestId('image-validation')).toContainText(\n+      'URL must link directly to an image file'\n+    );\n   });\n \n   test('The description has validation', async ({ page }) => {"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 72,
        "deletions": 26
    }
}