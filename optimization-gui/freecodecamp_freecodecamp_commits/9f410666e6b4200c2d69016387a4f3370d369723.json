{
    "author": "huyenltnguyen",
    "message": "fix(challenge-helper-scripts): make `create-language-block` support chapter-based structure (#62268)",
    "sha": "9f410666e6b4200c2d69016387a4f3370d369723",
    "files": [
        {
            "sha": "cbb4a1c19e8931fc65664e2b3f60ac83d18d8540",
            "filename": "tools/challenge-helper-scripts/create-language-block.ts",
            "status": "modified",
            "additions": 207,
            "deletions": 13,
            "changes": 220,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9f410666e6b4200c2d69016387a4f3370d369723/tools%2Fchallenge-helper-scripts%2Fcreate-language-block.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9f410666e6b4200c2d69016387a4f3370d369723/tools%2Fchallenge-helper-scripts%2Fcreate-language-block.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-helper-scripts%2Fcreate-language-block.ts?ref=9f410666e6b4200c2d69016387a4f3370d369723",
            "patch": "@@ -1,22 +1,29 @@\n import fs from 'fs/promises';\n+import { existsSync } from 'fs';\n import path from 'path';\n import { prompt } from 'inquirer';\n import { format } from 'prettier';\n import ObjectID from 'bson-objectid';\n \n import {\n   SuperBlocks,\n-  languageSuperBlocks\n+  languageSuperBlocks,\n+  chapterBasedSuperBlocks\n } from '../../shared/config/curriculum';\n+import { BlockLayouts, BlockTypes } from '../../shared/config/blocks';\n import {\n   getContentConfig,\n-  writeBlockStructure\n+  writeBlockStructure,\n+  getSuperblockStructure\n } from '../../curriculum/file-handler';\n import { superBlockToFilename } from '../../curriculum/build-curriculum';\n import { getBaseMeta } from './helpers/get-base-meta';\n import { createIntroMD } from './helpers/create-intro';\n-import { createDialogueFile, validateBlockName } from './utils';\n-import { updateSimpleSuperblockStructure } from './helpers/create-project';\n+import { createDialogueFile, createQuizFile, validateBlockName } from './utils';\n+import {\n+  updateSimpleSuperblockStructure,\n+  updateChapterModuleSuperblockStructure\n+} from './helpers/create-project';\n \n const helpCategories = ['English'] as const;\n \n@@ -36,25 +43,70 @@ interface CreateBlockArgs {\n   block: string;\n   helpCategory: string;\n   title?: string;\n+  chapter?: string;\n+  module?: string;\n+  position?: number;\n+  blockType?: string;\n+  blockLayout?: string;\n+  questionCount?: number;\n }\n \n async function createLanguageBlock(\n   superBlock: SuperBlocks,\n   block: string,\n   helpCategory: string,\n-  title?: string\n+  title?: string,\n+  chapter?: string,\n+  module?: string,\n+  position?: number,\n+  blockType?: string,\n+  blockLayout?: string,\n+  questionCount?: number\n ) {\n   if (!title) {\n     title = block;\n   }\n   await updateIntroJson(superBlock, block, title);\n \n-  const challengeId = await createDialogueChallenge(superBlock, block);\n-  await createMetaJson(block, title, helpCategory, challengeId);\n+  let challengeId: ObjectID;\n+\n+  if (blockType === BlockTypes.quiz) {\n+    challengeId = await createQuizChallenge(block, title, questionCount!);\n+    blockLayout = BlockLayouts.Link;\n+  } else {\n+    challengeId = await createDialogueChallenge(superBlock, block);\n+  }\n+\n+  await createMetaJson(\n+    block,\n+    title,\n+    helpCategory,\n+    challengeId,\n+    blockType,\n+    blockLayout\n+  );\n+\n   const superblockFilename = (\n     superBlockToFilename as Record<SuperBlocks, string>\n   )[superBlock];\n-  void updateSimpleSuperblockStructure(block, {}, superblockFilename);\n+\n+  if (chapterBasedSuperBlocks.includes(superBlock)) {\n+    if (!chapter || !module || typeof position === 'undefined') {\n+      throw Error(\n+        'Missing one of the following arguments: chapter, module, position'\n+      );\n+    }\n+\n+    void updateChapterModuleSuperblockStructure(\n+      block,\n+      // Convert human-friendly (1-based) position to 0-based index for insertion.\n+      { order: position - 1, chapter, module },\n+      superblockFilename\n+    );\n+  } else {\n+    void updateSimpleSuperblockStructure(block, {}, superblockFilename);\n+  }\n+\n   // TODO: remove once we stop relying on markdown in the client.\n   await createIntroMD(superBlock, block, title);\n }\n@@ -84,15 +136,31 @@ async function createMetaJson(\n   block: string,\n   title: string,\n   helpCategory: string,\n-  challengeId: ObjectID\n+  challengeId: ObjectID,\n+  blockType?: string,\n+  blockLayout?: string\n ) {\n   const newMeta = getBaseMeta('Language');\n   newMeta.name = title;\n   newMeta.dashedName = block;\n   newMeta.helpCategory = helpCategory;\n+\n+  if (blockType) {\n+    newMeta.blockType = blockType;\n+  }\n+  if (blockLayout) {\n+    newMeta.blockLayout = blockLayout;\n+  }\n+\n+  const challengeTitle =\n+    blockType === BlockTypes.quiz ? title : \"Dialogue 1: I'm Tom\";\n+\n   newMeta.challengeOrder = [\n-    // eslint-disable-next-line @typescript-eslint/no-base-to-string\n-    { id: challengeId.toString(), title: \"Dialogue 1: I'm Tom\" }\n+    {\n+      // eslint-disable-next-line @typescript-eslint/no-base-to-string\n+      id: challengeId.toString(),\n+      title: challengeTitle\n+    }\n   ];\n \n   await writeBlockStructure(block, newMeta);\n@@ -114,6 +182,26 @@ async function createDialogueChallenge(\n   });\n }\n \n+async function createQuizChallenge(\n+  block: string,\n+  title: string,\n+  questionCount: number\n+): Promise<ObjectID> {\n+  const newChallengeDir = path.resolve(\n+    __dirname,\n+    `../../curriculum/challenges/english/${block}`\n+  );\n+  if (!existsSync(newChallengeDir)) {\n+    await withTrace(fs.mkdir, newChallengeDir);\n+  }\n+  return createQuizFile({\n+    projectPath: newChallengeDir + '/',\n+    title: title,\n+    dashedName: block,\n+    questionCount: questionCount\n+  });\n+}\n+\n function parseJson<JsonSchema>(filePath: string) {\n   return withTrace(fs.readFile, filePath, 'utf8').then(\n     // unfortunately, withTrace does not correctly infer that the third argument\n@@ -160,11 +248,117 @@ void prompt([\n     default: 'English',\n     type: 'list',\n     choices: helpCategories\n+  },\n+  {\n+    name: 'blockType',\n+    message: 'Choose a block type',\n+    default: BlockTypes.learn,\n+    type: 'list',\n+    choices: Object.values(BlockTypes),\n+    when: (answers: CreateBlockArgs) =>\n+      chapterBasedSuperBlocks.includes(answers.superBlock)\n+  },\n+  {\n+    name: 'blockLayout',\n+    message: 'Choose a block layout',\n+    default: BlockLayouts.DialogueGrid,\n+    type: 'list',\n+    choices: Object.values(BlockLayouts),\n+    when: (answers: CreateBlockArgs) =>\n+      chapterBasedSuperBlocks.includes(answers.superBlock) &&\n+      answers.blockType !== BlockTypes.quiz\n+  },\n+  {\n+    name: 'questionCount',\n+    message: 'Choose a question count',\n+    default: 20,\n+    type: 'list',\n+    choices: [10, 20],\n+    when: (answers: CreateBlockArgs) => answers.blockType === BlockTypes.quiz\n+  },\n+  {\n+    name: 'chapter',\n+    message: 'What chapter should this language block go in?',\n+    type: 'list',\n+    choices: (answers: CreateBlockArgs) => {\n+      const superblockFilename = (\n+        superBlockToFilename as Record<SuperBlocks, string>\n+      )[answers.superBlock];\n+      const structure = getSuperblockStructure(superblockFilename) as {\n+        chapters: {\n+          dashedName: string;\n+          modules: { dashedName: string; blocks: string[] }[];\n+        }[];\n+      };\n+      return structure.chapters.map(chapter => chapter.dashedName);\n+    },\n+    when: (answers: CreateBlockArgs) =>\n+      chapterBasedSuperBlocks.includes(answers.superBlock)\n+  },\n+  {\n+    name: 'module',\n+    message: 'What module should this language block go in?',\n+    type: 'list',\n+    choices: (answers: CreateBlockArgs) => {\n+      const superblockFilename = (\n+        superBlockToFilename as Record<SuperBlocks, string>\n+      )[answers.superBlock];\n+      const structure = getSuperblockStructure(superblockFilename) as {\n+        chapters: {\n+          dashedName: string;\n+          modules: { dashedName: string; blocks: string[] }[];\n+        }[];\n+      };\n+      return (\n+        structure.chapters\n+          .find(chapter => chapter.dashedName === answers.chapter)\n+          ?.modules.map(module => module.dashedName) ?? []\n+      );\n+    },\n+    when: (answers: CreateBlockArgs) =>\n+      chapterBasedSuperBlocks.includes(answers.superBlock)\n+  },\n+  {\n+    name: 'position',\n+    message: 'At which position does this appear in the module?',\n+    default: 1,\n+    validate: (position: string) => {\n+      return parseInt(position, 10) > 0\n+        ? true\n+        : 'Position must be an number greater than zero.';\n+    },\n+    when: (answers: CreateBlockArgs) =>\n+      chapterBasedSuperBlocks.includes(answers.superBlock),\n+    filter: (position: string) => {\n+      return parseInt(position, 10);\n+    }\n   }\n ])\n   .then(\n-    async ({ superBlock, block, helpCategory, title }: CreateBlockArgs) =>\n-      await createLanguageBlock(superBlock, block, helpCategory, title)\n+    async ({\n+      superBlock,\n+      block,\n+      helpCategory,\n+      title,\n+      chapter,\n+      module,\n+      position,\n+      blockType,\n+      blockLayout,\n+      questionCount\n+    }: CreateBlockArgs) =>\n+      await createLanguageBlock(\n+        superBlock,\n+        block,\n+        helpCategory,\n+        title,\n+        chapter,\n+        module,\n+        position,\n+        blockType,\n+        blockLayout,\n+        questionCount\n+      )\n   )\n   .then(() =>\n     console.log("
        }
    ],
    "stats": {
        "total": 220,
        "additions": 207,
        "deletions": 13
    }
}