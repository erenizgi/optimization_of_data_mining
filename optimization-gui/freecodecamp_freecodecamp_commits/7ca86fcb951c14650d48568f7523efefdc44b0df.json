{
    "author": "ShaunSHamilton",
    "message": "fix(api): upsert moderation record on invalid attempt (#64635)",
    "sha": "7ca86fcb951c14650d48568f7523efefdc44b0df",
    "files": [
        {
            "sha": "ef2db2bc0fb7b85b3c19b6ceb0a92f3ae4298f3c",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 12,
            "changes": 26,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7ca86fcb951c14650d48568f7523efefdc44b0df/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7ca86fcb951c14650d48568f7523efefdc44b0df/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=7ca86fcb951c14650d48568f7523efefdc44b0df",
            "patch": "@@ -681,23 +681,25 @@ async function postExamAttemptHandler(\n   );\n \n   if (maybeValidExamAttempt.hasError) {\n-    logger.warn(\n-      { validExamAttemptError: maybeValidExamAttempt.error },\n-      'Invalid exam attempt.'\n-    );\n-    // As attempt is invalid, create moderation record to investigate\n-    await this.prisma.examEnvironmentExamModeration.create({\n-      data: {\n+    const message =\n+      maybeValidExamAttempt.error instanceof Error\n+        ? maybeValidExamAttempt.error.message\n+        : 'Unknown attempt validation error';\n+    logger.warn({ validExamAttemptError: message }, 'Invalid exam attempt.');\n+    // As attempt is invalid, create moderation record to investigate or update existing record\n+    await this.prisma.examEnvironmentExamModeration.upsert({\n+      where: { examAttemptId: latestAttempt.id },\n+      create: {\n         examAttemptId: latestAttempt.id,\n-        status: ExamEnvironmentExamModerationStatus.Pending\n+        status: ExamEnvironmentExamModerationStatus.Pending,\n+        feedback: message\n+      },\n+      update: {\n+        feedback: message\n       }\n     });\n \n     void reply.code(400);\n-    const message =\n-      maybeValidExamAttempt.error instanceof Error\n-        ? maybeValidExamAttempt.error.message\n-        : 'Unknown attempt validation error';\n     return reply.send(ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT(message));\n   }\n "
        }
    ],
    "stats": {
        "total": 26,
        "additions": 14,
        "deletions": 12
    }
}