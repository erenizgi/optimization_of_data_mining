{
    "author": "shynonagons",
    "message": "test: validate email sending (#58889)\n\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "d1b4a9b89f1f36a485909bedf3461508c4a9f341",
    "files": [
        {
            "sha": "150ab9ffd3076442bf05abe06fb562744843b8cf",
            "filename": "e2e/certification.spec.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d1b4a9b89f1f36a485909bedf3461508c4a9f341/e2e%2Fcertification.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d1b4a9b89f1f36a485909bedf3461508c4a9f341/e2e%2Fcertification.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fcertification.spec.ts?ref=d1b4a9b89f1f36a485909bedf3461508c4a9f341",
            "patch": "@@ -1,7 +1,42 @@\n+import { execSync } from 'child_process';\n import { test, expect, Page } from '@playwright/test';\n-\n import translations from '../client/i18n/locales/english/translations.json';\n import { alertToBeVisible } from './utils/alerts';\n+import {\n+  deleteAllEmails,\n+  getAllEmails,\n+  getFirstEmail,\n+  getSubject\n+} from './utils/mailhog';\n+\n+test.describe('Claim a certification - almost certified user', () => {\n+  test.beforeEach(async () => {\n+    await deleteAllEmails();\n+    execSync('node ./tools/scripts/seed/seed-demo-user --unclaimed-user');\n+  });\n+\n+  test.afterAll(() => {\n+    execSync('node ./tools/scripts/seed/seed-demo-user --certified-user');\n+  });\n+  test.use({ storageState: 'playwright/.auth/certified-user.json' });\n+\n+  test('User receives a congratulations email on completing all certs', async ({\n+    page\n+  }) => {\n+    await page.goto('/settings#cert-front-end-development-libraries');\n+    await page\n+      .getByRole('button', { name: 'Claim Certification Front End' })\n+      .click();\n+    // verify that an email is sent\n+    await expect(async () => {\n+      const emails = await getAllEmails();\n+      expect(emails.items).toHaveLength(1);\n+      expect(getSubject(getFirstEmail(emails))).toBe(\n+        'Congratulations on completing all of the freeCodeCamp certifications!'\n+      );\n+    }).toPass();\n+  });\n+});\n \n test.describe('Certification page - Non Microsoft', () => {\n   test.beforeEach(async ({ page }) => {"
        },
        {
            "sha": "ac031b5a4a0cb55339049116442a8827e2cab368",
            "filename": "e2e/update-email.spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d1b4a9b89f1f36a485909bedf3461508c4a9f341/e2e%2Fupdate-email.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d1b4a9b89f1f36a485909bedf3461508c4a9f341/e2e%2Fupdate-email.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fupdate-email.spec.ts?ref=d1b4a9b89f1f36a485909bedf3461508c4a9f341",
            "patch": "@@ -1,6 +1,16 @@\n import { test, expect } from '@playwright/test';\n import translations from '../client/i18n/locales/english/translations.json';\n import { allowTrailingSlash } from './utils/url';\n+import {\n+  deleteAllEmails,\n+  getAllEmails,\n+  getFirstEmail,\n+  getSubject\n+} from './utils/mailhog';\n+\n+test.beforeEach(async () => {\n+  await deleteAllEmails();\n+});\n \n test.describe('The update-email page when the user is signed in', () => {\n   test.beforeEach(async ({ page }) => {\n@@ -47,6 +57,24 @@ test.describe('The update-email page when the user is signed in', () => {\n     await emailInput.fill('123@gmail.com');\n     await expect(submitButton).toBeEnabled();\n   });\n+\n+  test('actually sends an email', async ({ page }) => {\n+    const emailInput = page.getByLabel(translations.misc.email);\n+    const submitButton = page.getByRole('button', { name: 'Update my Email' });\n+\n+    await expect(submitButton).toBeDisabled();\n+    await emailInput.fill('123');\n+    await expect(submitButton).toBeDisabled();\n+    await emailInput.fill('123@gmail.com');\n+    await submitButton.click();\n+    await expect(async () => {\n+      const emails = await getAllEmails();\n+      expect(emails.items).toHaveLength(1);\n+      expect(getSubject(getFirstEmail(emails))).toBe(\n+        'Please confirm your updated email address for freeCodeCamp.org'\n+      );\n+    }).toPass();\n+  });\n });\n \n test.describe('The update-email page when the user is not signed in', () => {"
        },
        {
            "sha": "ba2d42eb756c56a88654ae33558265ecedf25c92",
            "filename": "tools/scripts/seed/seed-demo-user.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d1b4a9b89f1f36a485909bedf3461508c4a9f341/tools%2Fscripts%2Fseed%2Fseed-demo-user.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d1b4a9b89f1f36a485909bedf3461508c4a9f341/tools%2Fscripts%2Fseed%2Fseed-demo-user.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fscripts%2Fseed%2Fseed-demo-user.js?ref=d1b4a9b89f1f36a485909bedf3461508c4a9f341",
            "patch": "@@ -11,7 +11,8 @@ const {\n   publicUser,\n   fullyCertifiedUser,\n   userIds,\n-  almostFullyCertifiedUser\n+  almostFullyCertifiedUser,\n+  unclaimedUser\n } = require('./user-data');\n \n const options = {\n@@ -20,7 +21,8 @@ const options = {\n   'set-false': { type: 'string', multiple: true },\n   'seed-trophy-challenges': { type: 'boolean' },\n   'certified-user': { type: 'boolean' },\n-  'almost-certified-user': { type: 'boolean' }\n+  'almost-certified-user': { type: 'boolean' },\n+  'unclaimed-user': { type: 'boolean' }\n };\n \n const { values: argValues } = parseArgs({ options });\n@@ -127,6 +129,8 @@ const run = async () => {\n     await user.insertOne(fullyCertifiedUser);\n   } else if (argValues['almost-certified-user']) {\n     await user.insertOne(almostFullyCertifiedUser);\n+  } else if (argValues['unclaimed-user']) {\n+    await user.insertOne(unclaimedUser);\n   } else {\n     await user.insertOne(demoUser);\n   }"
        },
        {
            "sha": "46e9187099a7a6f7dbe1c0889c651cccd556626c",
            "filename": "tools/scripts/seed/user-data.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d1b4a9b89f1f36a485909bedf3461508c4a9f341/tools%2Fscripts%2Fseed%2Fuser-data.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d1b4a9b89f1f36a485909bedf3461508c4a9f341/tools%2Fscripts%2Fseed%2Fuser-data.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fscripts%2Fseed%2Fuser-data.js?ref=d1b4a9b89f1f36a485909bedf3461508c4a9f341",
            "patch": "@@ -5,13 +5,15 @@ const publicUserId = new ObjectId('663b839b24a8b29f57728b13');\n const demoUserId = new ObjectId('5bd30e0f1caf6ac3ddddddb5');\n const fullyCertifiedUserId = new ObjectId('5fa2db00a25c1c1fa49ce067');\n const almostFullyCertifiedUserId = new ObjectId('5bd30e0f1caf6ac3ddddddb9');\n+const unclaimedUserId = new ObjectId('5bd30e0f1caf6ac3ddddddb1');\n \n const userIds = [\n   blankUserId,\n   publicUserId,\n   demoUserId,\n   fullyCertifiedUserId,\n-  almostFullyCertifiedUserId\n+  almostFullyCertifiedUserId,\n+  unclaimedUserId\n ];\n \n module.exports.blankUser = {\n@@ -12293,6 +12295,12 @@ module.exports.fullyCertifiedUser = {\n   unsubscribeId: 'tBX8stC5jiustPBteF2mV'\n };\n \n+module.exports.unclaimedUser = {\n+  ...module.exports.fullyCertifiedUser,\n+  id: unclaimedUserId,\n+  isFrontEndLibsCert: false\n+};\n+\n module.exports.almostFullyCertifiedUser = {\n   ...module.exports.fullyCertifiedUser,\n   id: almostFullyCertifiedUserId,"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 79,
        "deletions": 4
    }
}