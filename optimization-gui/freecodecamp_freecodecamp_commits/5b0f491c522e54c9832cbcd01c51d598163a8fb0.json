{
    "author": "ojeytonwilliams",
    "message": "refactor(api): simplify logging (#58707)\n\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "5b0f491c522e54c9832cbcd01c51d598163a8fb0",
    "files": [
        {
            "sha": "0dbca24ad5b697273ac41f8f50cbefb4e89db2c6",
            "filename": "api/src/routes/public/status.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 20,
            "changes": 21,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5b0f491c522e54c9832cbcd01c51d598163a8fb0/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5b0f491c522e54c9832cbcd01c51d598163a8fb0/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fstatus.ts?ref=5b0f491c522e54c9832cbcd01c51d598163a8fb0",
            "patch": "@@ -1,5 +1,4 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n-import { isEmpty } from 'lodash';\n \n /**\n  * Plugin for the health check endpoint.\n@@ -15,25 +14,7 @@ export const statusRoute: FastifyPluginCallbackTypebox = (\n   done\n ) => {\n   fastify.get('/status/ping', async (req, _reply) => {\n-    const url = req.url || 'URL not found';\n-    const reqId = req.id || 'REQ_ID not found';\n-    const headers = isEmpty(req.headers) ? 'HEADERS not found' : req.headers;\n-    const ip =\n-      req.headers['x-forwarded-for'] ||\n-      req.headers['x-real-ip'] ||\n-      req.ip ||\n-      'IP not found';\n-    const query = isEmpty(req.query) ? 'QUERY not found' : req.query;\n-\n-    fastify.log\n-      .child({\n-        URL: url,\n-        REQ_ID: reqId,\n-        HEADERS: headers,\n-        IP: ip,\n-        QUERY: query\n-      })\n-      .debug('returning a ping');\n+    fastify.log.child({ req }).debug('returning a ping');\n     return { msg: 'pong' };\n   });\n "
        },
        {
            "sha": "ad53fbda20af8a62cbf80ec0af6f79c66c5d4d25",
            "filename": "api/src/server.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 12,
            "changes": 49,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5b0f491c522e54c9832cbcd01c51d598163a8fb0/api%2Fsrc%2Fserver.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5b0f491c522e54c9832cbcd01c51d598163a8fb0/api%2Fsrc%2Fserver.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fserver.ts?ref=5b0f491c522e54c9832cbcd01c51d598163a8fb0",
            "patch": "@@ -3,8 +3,12 @@\n // is not included in the build (it's a dev dependency).\n // eslint-disable-next-line @typescript-eslint/triple-slash-reference\n /// <reference path=\"./reset.d.ts\" />\n+\n import { randomBytes } from 'crypto';\n+\n import { FastifyRequest } from 'fastify';\n+import { isEmpty } from 'lodash';\n+\n import { build } from './app';\n import {\n   FREECODECAMP_NODE_ENV,\n@@ -13,16 +17,30 @@ import {\n   PORT\n } from './utils/env';\n \n-const requestSerializer = (request: FastifyRequest) => ({\n-  method: request.method,\n-  url: request.url,\n-  ip: request.headers['x-forwarded-for'] || request.ip,\n-  hostname: request.hostname,\n-  remoteAddress: Array.isArray(request.headers['x-forwarded-for'])\n-    ? request.headers['x-forwarded-for'][0]\n-    : request.headers['x-forwarded-for'] || request.ip,\n-  remotePort: request.socket.remotePort\n-});\n+const requestSerializer = (req: FastifyRequest) => {\n+  const method = req.method || 'METHOD not found';\n+  const url = req.url || 'URL not found';\n+  const headers = req.headers || 'HEADERS not found';\n+  const xForwardedFor = Array.isArray(req.headers['x-forwarded-for'])\n+    ? req.headers['x-forwarded-for'][0]\n+    : req.headers['x-forwarded-for'];\n+  const ip =\n+    xForwardedFor || req.headers['x-real-ip'] || req.ip || 'IP not found';\n+  const query = isEmpty(req.query) ? 'QUERY not found' : req.query;\n+  const hostname = req.hostname || 'HOSTNAME not found';\n+  const remotePort = req.socket.remotePort || 'REMOTE_PORT not found';\n+\n+  return {\n+    REQ_ID: req.id,\n+    METHOD: method,\n+    URL: url,\n+    IP: ip,\n+    HOSTNAME: hostname,\n+    REMOTE_PORT: remotePort,\n+    QUERY: query,\n+    HEADERS: headers\n+  };\n+};\n \n const envToLogger = {\n   development: {\n@@ -36,14 +54,21 @@ const envToLogger = {\n     },\n     level: FCC_API_LOG_LEVEL || 'info',\n     serializers: {\n-      req: requestSerializer\n+      req: (req: FastifyRequest) => {\n+        return {\n+          method: req.method,\n+          url: req.url\n+        };\n+      }\n     }\n+    // No need to redact in development\n   },\n   production: {\n     level: FCC_API_LOG_LEVEL || 'info',\n     serializers: {\n       req: requestSerializer\n-    }\n+    },\n+    redact: ['req.HEADERS.cookie']\n   }\n };\n "
        }
    ],
    "stats": {
        "total": 70,
        "additions": 38,
        "deletions": 32
    }
}