{
    "author": "farchettiensis",
    "message": "fix: handle NaN percentage completion for completed lab challenges (#63773)",
    "sha": "a605462f6fda63ac84029332d5dd93ee2d6e3003",
    "files": [
        {
            "sha": "32ea874f708d27142b505d85772ba06dc90a81c6",
            "filename": "client/src/utils/get-completion-percentage.test.ts",
            "status": "added",
            "additions": 277,
            "deletions": 0,
            "changes": 277,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/a605462f6fda63ac84029332d5dd93ee2d6e3003/client%2Fsrc%2Futils%2Fget-completion-percentage.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/a605462f6fda63ac84029332d5dd93ee2d6e3003/client%2Fsrc%2Futils%2Fget-completion-percentage.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fget-completion-percentage.test.ts?ref=a605462f6fda63ac84029332d5dd93ee2d6e3003",
            "patch": "@@ -0,0 +1,277 @@\n+import { describe, it, expect } from 'vitest';\n+import type { AllChallengesInfo, ChallengeNode } from '../redux/prop-types';\n+import { challengeTypes } from '../../../shared-dist/config/challenge-types';\n+import {\n+  getCompletedPercentage,\n+  getCompletedChallengesInBlock,\n+  getCurrentBlockIds\n+} from './get-completion-percentage';\n+\n+describe('get-completion-percentage', () => {\n+  describe('getCompletedPercentage', () => {\n+    it('calculates percentage when challenge not yet completed', () => {\n+      const completedChallengesIds = ['challenge-1', 'challenge-2'];\n+      const currentBlockIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3',\n+        'challenge-4',\n+        'challenge-5'\n+      ];\n+      const currentChallengeId = 'challenge-3';\n+\n+      const result = getCompletedPercentage(\n+        completedChallengesIds,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(60);\n+    });\n+\n+    it('calculates percentage when challenge already completed', () => {\n+      const completedChallengesIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3'\n+      ];\n+      const currentBlockIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3',\n+        'challenge-4',\n+        'challenge-5'\n+      ];\n+      const currentChallengeId = 'challenge-3';\n+\n+      const result = getCompletedPercentage(\n+        completedChallengesIds,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(60);\n+    });\n+\n+    it('caps percentage at 100', () => {\n+      const completedChallengesIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3'\n+      ];\n+      const currentBlockIds = ['challenge-1', 'challenge-2'];\n+      const currentChallengeId = 'challenge-3';\n+\n+      const result = getCompletedPercentage(\n+        completedChallengesIds,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(100);\n+    });\n+\n+    it('handles undefined completedChallengesIds', () => {\n+      const currentBlockIds = ['challenge-1', 'challenge-2', 'challenge-3'];\n+      const currentChallengeId = 'challenge-1';\n+\n+      const result = getCompletedPercentage(\n+        undefined,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(33);\n+    });\n+  });\n+\n+  describe('getCompletedChallengesInBlock', () => {\n+    it('counts new challenge when not already completed', () => {\n+      const completedChallengesIds = ['challenge-1', 'challenge-2'];\n+      const currentBlockIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3',\n+        'challenge-4'\n+      ];\n+      const currentChallengeId = 'challenge-3';\n+\n+      const result = getCompletedChallengesInBlock(\n+        completedChallengesIds,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(3);\n+    });\n+\n+    it('does not double-count when challenge already completed', () => {\n+      const completedChallengesIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3'\n+      ];\n+      const currentBlockIds = [\n+        'challenge-1',\n+        'challenge-2',\n+        'challenge-3',\n+        'challenge-4'\n+      ];\n+      const currentChallengeId = 'challenge-3';\n+\n+      const result = getCompletedChallengesInBlock(\n+        completedChallengesIds,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(3);\n+    });\n+\n+    it('only counts challenges in the current block', () => {\n+      const completedChallengesIds = [\n+        'block1-challenge-1',\n+        'block1-challenge-2',\n+        'block2-challenge-1',\n+        'block2-challenge-2'\n+      ];\n+      const currentBlockIds = ['block1-challenge-1', 'block1-challenge-2'];\n+      const currentChallengeId = 'block1-challenge-3';\n+\n+      const result = getCompletedChallengesInBlock(\n+        completedChallengesIds,\n+        currentBlockIds,\n+        currentChallengeId\n+      );\n+\n+      expect(result).toBe(3);\n+    });\n+  });\n+\n+  describe('getCurrentBlockIds', () => {\n+    it('returns block IDs for non-project-based challenges', () => {\n+      const allChallengesInfo: AllChallengesInfo = {\n+        challengeNodes: [\n+          {\n+            challenge: {\n+              id: 'block-challenge-1',\n+              block: 'basic-html',\n+              certification: 'responsive-web-design'\n+            }\n+          } as Partial<ChallengeNode> as ChallengeNode,\n+          {\n+            challenge: {\n+              id: 'block-challenge-2',\n+              block: 'basic-html',\n+              certification: 'responsive-web-design'\n+            }\n+          } as Partial<ChallengeNode> as ChallengeNode,\n+          {\n+            challenge: {\n+              id: 'other-block-challenge',\n+              block: 'basic-css',\n+              certification: 'responsive-web-design'\n+            }\n+          } as Partial<ChallengeNode> as ChallengeNode\n+        ],\n+        certificateNodes: []\n+      };\n+\n+      const result = getCurrentBlockIds(\n+        allChallengesInfo,\n+        'basic-html',\n+        'responsive-web-design',\n+        challengeTypes.step\n+      );\n+\n+      expect(result).toEqual(['block-challenge-1', 'block-challenge-2']);\n+    });\n+\n+    it('returns certificate IDs for project-based challenges when available', () => {\n+      const allChallengesInfo: AllChallengesInfo = {\n+        challengeNodes: [],\n+        certificateNodes: [\n+          {\n+            challenge: {\n+              certification: 'responsive-web-design',\n+              tests: [\n+                { id: 'cert-project-1' },\n+                { id: 'cert-project-2' },\n+                { id: 'cert-project-3' }\n+              ]\n+            }\n+          }\n+        ]\n+      };\n+\n+      const result = getCurrentBlockIds(\n+        allChallengesInfo,\n+        'responsive-web-design-projects',\n+        'responsive-web-design',\n+        challengeTypes.frontEndProject\n+      );\n+\n+      expect(result).toEqual([\n+        'cert-project-1',\n+        'cert-project-2',\n+        'cert-project-3'\n+      ]);\n+    });\n+\n+    // this is a provisional fix to the issue mentioned in #63773\n+    it('falls back to block IDs when certificate not available', () => {\n+      const allChallengesInfo: AllChallengesInfo = {\n+        challengeNodes: [\n+          {\n+            challenge: {\n+              id: 'project-1',\n+              block: 'back-end-projects',\n+              certification: 'back-end-development'\n+            }\n+          } as Partial<ChallengeNode> as ChallengeNode,\n+          {\n+            challenge: {\n+              id: 'project-2',\n+              block: 'back-end-projects',\n+              certification: 'back-end-development'\n+            }\n+          } as Partial<ChallengeNode> as ChallengeNode\n+        ],\n+        certificateNodes: []\n+      };\n+\n+      const result = getCurrentBlockIds(\n+        allChallengesInfo,\n+        'back-end-projects',\n+        'back-end-development',\n+        challengeTypes.backEndProject\n+      );\n+\n+      expect(result).toEqual(['project-1', 'project-2']);\n+    });\n+\n+    it('returns empty array when no matching challenges found', () => {\n+      const allChallengesInfo: AllChallengesInfo = {\n+        challengeNodes: [\n+          {\n+            challenge: {\n+              id: 'challenge-1',\n+              block: 'different-block',\n+              certification: 'responsive-web-design'\n+            }\n+          } as Partial<ChallengeNode> as ChallengeNode\n+        ],\n+        certificateNodes: []\n+      };\n+\n+      const result = getCurrentBlockIds(\n+        allChallengesInfo,\n+        'non-existent-block',\n+        'responsive-web-design',\n+        challengeTypes.step\n+      );\n+\n+      expect(result).toEqual([]);\n+    });\n+  });\n+});"
        },
        {
            "sha": "4d754186ec23b922a40939c45b1d91414bf97c29",
            "filename": "client/src/utils/get-completion-percentage.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/a605462f6fda63ac84029332d5dd93ee2d6e3003/client%2Fsrc%2Futils%2Fget-completion-percentage.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/a605462f6fda63ac84029332d5dd93ee2d6e3003/client%2Fsrc%2Futils%2Fget-completion-percentage.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fget-completion-percentage.ts?ref=a605462f6fda63ac84029332d5dd93ee2d6e3003",
            "patch": "@@ -48,7 +48,11 @@ export const getCurrentBlockIds = (\n     .filter(node => node.challenge.block === block)\n     .map(node => node.challenge.id);\n \n-  return isProjectBased(challengeType)\n-    ? currentCertificateIds\n-    : currentBlockIds;\n+  if (isProjectBased(challengeType)) {\n+    return currentCertificateIds.length > 0\n+      ? currentCertificateIds\n+      : currentBlockIds;\n+  }\n+\n+  return currentBlockIds;\n };"
        }
    ],
    "stats": {
        "total": 287,
        "additions": 284,
        "deletions": 3
    }
}