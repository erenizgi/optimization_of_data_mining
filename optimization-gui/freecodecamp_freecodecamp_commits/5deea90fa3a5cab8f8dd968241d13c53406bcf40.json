{
    "author": "ojeytonwilliams",
    "message": "fix(api): delete exam auth tokens with user (#58284)",
    "sha": "5deea90fa3a5cab8f8dd968241d13c53406bcf40",
    "files": [
        {
            "sha": "b30c24b0fbd0c17668376f208d9e0892840f3111",
            "filename": "api/__mocks__/env-exam.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2F__mocks__%2Fenv-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2F__mocks__%2Fenv-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fenv-exam.ts?ref=5deea90fa3a5cab8f8dd968241d13c53406bcf40",
            "patch": "@@ -379,3 +379,9 @@ export async function seedEnvExamAttempt() {\n     data: examAttempt\n   });\n }\n+\n+export async function seedExamEnvExamAuthToken() {\n+  return fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.create({\n+    data: { userId: defaultUserId, expireAt: new Date(Date.now() + 60000) }\n+  });\n+}"
        },
        {
            "sha": "79800993ecce3bf92d1b13eccffc714eb4dc2ec6",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=5deea90fa3a5cab8f8dd968241d13c53406bcf40",
            "patch": "@@ -382,7 +382,7 @@ model ExamEnvironmentAuthorizationToken {\n   userId   String   @unique @db.ObjectId\n \n   // Relations\n-  user user @relation(fields: [userId], references: [id])\n+  user user @relation(fields: [userId], references: [id], onDelete: Cascade)\n }\n \n model sessions {"
        },
        {
            "sha": "02ba3bf62f3f0fa95f915222a1fd8b7bc470f331",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 12,
            "changes": 38,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=5deea90fa3a5cab8f8dd968241d13c53406bcf40",
            "patch": "@@ -19,7 +19,8 @@ import { JWT_SECRET } from '../../utils/env';\n import {\n   clearEnvExam,\n   seedEnvExam,\n-  seedEnvExamAttempt\n+  seedEnvExamAttempt,\n+  seedExamEnvExamAuthToken\n } from '../../../__mocks__/env-exam';\n import { getMsTranscriptApiUrl } from './user';\n \n@@ -349,10 +350,6 @@ describe('userRoutes', () => {\n     });\n \n     describe('/account/delete', () => {\n-      beforeEach(async () => {\n-        await seedEnvExam();\n-        await seedEnvExamAttempt();\n-      });\n       afterEach(async () => {\n         await fastifyTestInstance.prisma.userToken.deleteMany({\n           where: { OR: [{ userId: defaultUserId }, { userId: otherUserId }] }\n@@ -418,15 +415,32 @@ describe('userRoutes', () => {\n       });\n \n       test(\"POST deletes all the user's exam attempts\", async () => {\n-        const examAttempts =\n-          await fastifyTestInstance.prisma.envExamAttempt.findMany();\n-        expect(examAttempts).toHaveLength(1);\n+        await seedEnvExam();\n+        await seedEnvExamAttempt();\n+        const countBefore =\n+          await fastifyTestInstance.prisma.envExamAttempt.count();\n+        expect(countBefore).toBe(1);\n \n-        await superPost('/account/delete');\n+        const res = await superPost('/account/delete');\n+\n+        const countAfter =\n+          await fastifyTestInstance.prisma.envExamAttempt.count();\n+        expect(countAfter).toBe(0);\n+        expect(res.status).toBe(200);\n+      });\n+\n+      test(\"POST deletes all the user's exam tokens\", async () => {\n+        await seedExamEnvExamAuthToken();\n+        const countBefore =\n+          await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.count();\n+        expect(countBefore).toBe(1);\n+\n+        const res = await superPost('/account/delete');\n \n-        const examAttemptsAfter =\n-          await fastifyTestInstance.prisma.envExamAttempt.findMany();\n-        expect(examAttemptsAfter).toHaveLength(0);\n+        const countAfter =\n+          await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.count();\n+        expect(countAfter).toBe(0);\n+        expect(res.status).toBe(200);\n       });\n     });\n "
        },
        {
            "sha": "6741c32036975ed960bd0ea84e3e58b0d87388d0",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5deea90fa3a5cab8f8dd968241d13c53406bcf40/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=5deea90fa3a5cab8f8dd968241d13c53406bcf40",
            "patch": "@@ -76,9 +76,6 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       await fastify.prisma.user.delete({\n         where: { id: req.user!.id }\n       });\n-      await fastify.prisma.examEnvironmentAuthorizationToken.deleteMany({\n-        where: { userId: req.user!.id }\n-      });\n       reply.clearOurCookies();\n \n       return {};"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 33,
        "deletions": 16
    }
}