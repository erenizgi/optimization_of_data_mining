{
    "author": "raisedadead",
    "message": "feat(deployments): build and deploy the stack",
    "sha": "528b2e4d2b45f9f449af5a60e61cd4bea351aae2",
    "files": [
        {
            "sha": "cec68a23a1d5f7afaa7ccde4275589d6b3381bdd",
            "filename": ".github/workflows/build-images.yml",
            "status": "removed",
            "additions": 0,
            "deletions": 43,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/76c0b29b14ebd21de5cadaca92e99678425fc38d/.github%2Fworkflows%2Fbuild-images.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/76c0b29b14ebd21de5cadaca92e99678425fc38d/.github%2Fworkflows%2Fbuild-images.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fbuild-images.yml?ref=76c0b29b14ebd21de5cadaca92e99678425fc38d",
            "patch": "@@ -1,43 +0,0 @@\n-name: CI - Build Images\n-on:\n-  workflow_dispatch:\n-\n-jobs:\n-  build:\n-    name: Build (Image)\n-    runs-on: ubuntu-22.04\n-    strategy:\n-      matrix:\n-        node-version: [20.x]\n-        apps: [api]\n-        site_tlds: [dev, org]\n-      fail-fast: false\n-\n-    steps:\n-      - name: Checkout Source Files\n-        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n-\n-      - name: Create a tagname\n-        id: tagname\n-        run: |\n-          echo \"tagname=$(git rev-parse --short HEAD)-$(date +%Y%m%d)-$(date +%H%M)\" >> $GITHUB_ENV\n-\n-      - name: Build & Tag Image\n-        run: |\n-          docker build \\\n-            --tag registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:$tagname \\\n-            --tag registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:latest \\\n-            --file docker/${{ matrix.apps }}/Dockerfile .\n-\n-      - name: Install doctl\n-        uses: digitalocean/action-doctl@v2\n-        with:\n-          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}\n-\n-      - name: Log in to DigitalOcean Container Registry with short-lived credentials\n-        run: doctl registry login --expiry-seconds 1200\n-\n-      - name: Push image to DigitalOcean Container Registry\n-        run: |\n-          docker push registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:$tagname\n-          docker push registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ matrix.site_tlds }}/learn-${{ matrix.apps }}:latest"
        },
        {
            "sha": "0afc923360b6912ba7ad90e99d82515195ea0718",
            "filename": ".github/workflows/deploy.yml",
            "status": "added",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/528b2e4d2b45f9f449af5a60e61cd4bea351aae2/.github%2Fworkflows%2Fdeploy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/528b2e4d2b45f9f449af5a60e61cd4bea351aae2/.github%2Fworkflows%2Fdeploy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy.yml?ref=528b2e4d2b45f9f449af5a60e61cd4bea351aae2",
            "patch": "@@ -0,0 +1,100 @@\n+name: CD -- Deploy - API (Docker Swarm)\n+\n+on:\n+  workflow_dispatch:\n+\n+jobs:\n+  static:\n+    runs-on: ubuntu-24.04\n+    outputs:\n+      site_tld: ${{ steps.static_data.outputs.site_tld }}\n+      environment: ${{ steps.static_data.outputs.environment }}\n+\n+    steps:\n+      - name: Set site_tld\n+        id: static_data\n+        run: |\n+          if [ \"${{ github.ref }}\" == \"refs/heads/prod-staging\" ]; then\n+            echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n+            echo \"environment=staging\" >> $GITHUB_OUTPUT\n+          elif [ \"${{ github.ref }}\" == \"refs/heads/prod-current\" ]; then\n+            echo \"site_tld=org\" >> $GITHUB_OUTPUT\n+            echo \"environment=production\" >> $GITHUB_OUTPUT\n+          else\n+            echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n+            echo \"environment=staging\" >> $GITHUB_OUTPUT\n+          fi\n+\n+  build:\n+    name: Build & Push Docker Image\n+    needs: static\n+    uses: ./.github/workflows/re--docker-docr.yml\n+    with:\n+      site_tld: ${{ needs.static.outputs.site_tld }}\n+      app: api\n+\n+  deploy:\n+    runs-on: ubuntu-24.04\n+    needs: [static, build]\n+    permissions:\n+      deployments: write\n+    environment:\n+      name: ${{ needs.static.outputs.environment }}\n+      url: https://api.freecodecamp.${{ needs.static.outputs.site_tld }}/status/ping?version=${{ needs.build.outputs.tagname }}\n+\n+    steps:\n+      - name: Setup and connect to Tailscale network\n+        uses: tailscale/github-action@v3\n+        with:\n+          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}\n+          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}\n+          tags: tag:ci\n+          version: latest\n+\n+      - name: Configure SSH\n+        # This is a workaround to avoid the SSH warning about known hosts & strict host key checking.\n+        # It's not a problem for us, because we're using Tailscale to connect.\n+        run: |\n+          mkdir -p ~/.ssh\n+          echo \"Host *\n+            UserKnownHostsFile=/dev/null\n+            StrictHostKeyChecking no\" > ~/.ssh/config\n+\n+      - name: Check connection to Deployment Target\n+        run: |\n+          tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Machine not found\"; exit 1; }\n+          ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n+\n+      - name: Deploy with Docker Stack\n+        env:\n+          STACK_NAME: stg-api\n+          RUNTIME_ENVS: ${{ secrets.RUNTIME_ENVS }}\n+          DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n+        run: |\n+          REMOTE_USER=$TS_USERNAME\n+          ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n+\n+            # Change to the config directory\n+            cd /home/${REMOTE_USER}/docker-swarm-config/stacks/api || exit 1\n+            echo \"Debug: Current directory: \\$(pwd)\"\n+\n+            # Create temp file for the environment variables\n+            echo \"${RUNTIME_ENVS}\" > .env.tmp\n+            echo \"DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}\" >> .env.tmp\n+\n+            # Source the environment variables\n+            set -a  # Automatically export all variables\n+            source .env.tmp || exit 1\n+            set +a\n+\n+            # Clean up the temp file\n+            rm -f .env.tmp\n+\n+            # Verify the environment variables\n+            echo \"Debug: Sanity check variables: \"\n+            env | grep -E '^DEPLOYMENT' || echo 'Vars not found'\n+            echo \"Debug: Sanity check config: \"\n+            docker stack config -c stack-api.yml | rg 'DOMAIN' || echo 'Config not found'\n+\n+          EOF\n+        shell: bash"
        },
        {
            "sha": "a3ebcca6a9bdf08e0eb60a218a8857fcc9519334",
            "filename": ".github/workflows/docker-docr.yml",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/528b2e4d2b45f9f449af5a60e61cd4bea351aae2/.github%2Fworkflows%2Fdocker-docr.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/528b2e4d2b45f9f449af5a60e61cd4bea351aae2/.github%2Fworkflows%2Fdocker-docr.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdocker-docr.yml?ref=528b2e4d2b45f9f449af5a60e61cd4bea351aae2",
            "patch": "@@ -0,0 +1,72 @@\n+name: Docker -- DOCR\n+\n+on:\n+  workflow_dispatch:\n+    inputs:\n+      site_tld:\n+        required: true\n+        type: choice\n+        description: 'Input: The site tld (variant) to build'\n+        options:\n+          - dev\n+          - org\n+        default: 'dev'\n+      app:\n+        required: true\n+        type: string\n+        description: 'Input: The app (component) to build'\n+        default: 'api'\n+  workflow_call:\n+    inputs:\n+      site_tld:\n+        required: true\n+        type: string\n+        description: 'Input: The site tld (variant) to build'\n+      app:\n+        required: true\n+        type: string\n+        description: 'Input: The app (component) to build'\n+    outputs:\n+      tagname:\n+        description: 'Output: The tagname for the image built'\n+        value: ${{ jobs.build.outputs.tagname }}\n+\n+jobs:\n+  build:\n+    name: Build (Image)\n+    runs-on: ubuntu-24.04\n+    permissions:\n+      contents: read\n+    outputs:\n+      tagname: ${{ steps.tagname.outputs.tagname }}\n+\n+    steps:\n+      - name: Checkout Source Files\n+        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1\n+\n+      - name: Create a tagname\n+        id: tagname\n+        run: |\n+          tagname=$(git rev-parse --short HEAD)-$(date +%Y%m%d)-$(date +%H%M)\n+          echo \"tagname=$tagname\" >> $GITHUB_ENV\n+          echo \"tagname=$tagname\" >> $GITHUB_OUTPUT\n+\n+      - name: Build & Tag Image\n+        run: |\n+          docker build \\\n+            --tag registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ inputs.site_tld }}/learn-${{ inputs.app }}:$tagname \\\n+            --tag registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ inputs.site_tld }}/learn-${{ inputs.app }}:latest \\\n+            --file docker/${{ inputs.app }}/Dockerfile .\n+\n+      - name: Install doctl\n+        uses: digitalocean/action-doctl@v2\n+        with:\n+          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}\n+\n+      - name: Log in to DigitalOcean Container Registry with short-lived credentials\n+        run: doctl registry login --expiry-seconds 1200\n+\n+      - name: Push image to DigitalOcean Container Registry\n+        run: |\n+          docker push registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ inputs.site_tld }}/learn-${{ inputs.app }}:$tagname\n+          docker push registry.digitalocean.com/${{ secrets.DOCR_NAME }}/${{ inputs.site_tld }}/learn-${{ inputs.app }}:latest"
        }
    ],
    "stats": {
        "total": 215,
        "additions": 172,
        "deletions": 43
    }
}