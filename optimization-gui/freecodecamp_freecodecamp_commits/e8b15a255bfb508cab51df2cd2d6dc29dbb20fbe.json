{
    "author": "ojeytonwilliams",
    "message": "feat(api): handle missing endpoints (#55429)",
    "sha": "e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe",
    "files": [
        {
            "sha": "6a43d32a49fdb21dbbf4dc9ccb9f95ba5987a989",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe",
            "patch": "@@ -5,6 +5,7 @@\n   },\n   \"dependencies\": {\n     \"@aws-sdk/client-ses\": \"3.521.0\",\n+    \"@fastify/accepts\": \"4.3.0\",\n     \"@fastify/cookie\": \"9.3.1\",\n     \"@fastify/csrf-protection\": \"6.4.1\",\n     \"@fastify/express\": \"^2.3.0\","
        },
        {
            "sha": "3a35946f4138091656f3645bdd09ae17fda71018",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe",
            "patch": "@@ -25,6 +25,7 @@ import mailer from './plugins/mailer';\n import redirectWithMessage from './plugins/redirect-with-message';\n import security from './plugins/security';\n import codeFlowAuth from './plugins/code-flow-auth';\n+import notFound from './plugins/not-found';\n import { mobileAuth0Routes } from './routes/auth';\n import { devAuthRoutes } from './routes/auth-dev';\n import {\n@@ -181,6 +182,7 @@ export const build = async (\n   // redirectWithMessage must be registered before codeFlowAuth\n   void fastify.register(redirectWithMessage);\n   void fastify.register(codeFlowAuth);\n+  void fastify.register(notFound);\n   void fastify.register(prismaPlugin);\n   void fastify.register(mobileAuth0Routes);\n   if (FCC_ENABLE_DEV_LOGIN_MODE) {"
        },
        {
            "sha": "7481d8a3ea3d5a8a248b5c143a3460680e40d631",
            "filename": "api/src/plugins/not-found.test.ts",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fsrc%2Fplugins%2Fnot-found.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fsrc%2Fplugins%2Fnot-found.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fnot-found.test.ts?ref=e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe",
            "patch": "@@ -0,0 +1,73 @@\n+import Fastify, { type FastifyInstance } from 'fastify';\n+\n+import notFound from './not-found';\n+import redirectWithMessage, { formatMessage } from './redirect-with-message';\n+\n+describe('fourOhFour', () => {\n+  let fastify: FastifyInstance;\n+\n+  beforeEach(async () => {\n+    fastify = Fastify();\n+    await fastify.register(redirectWithMessage);\n+    await fastify.register(notFound);\n+  });\n+\n+  afterEach(async () => {\n+    await fastify.close();\n+  });\n+\n+  it('should redirect to origin/404 if the request does not Accept json', async () => {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test',\n+      headers: {\n+        referer: 'https://www.freecodecamp.org/anything',\n+        accept: 'text/plain'\n+      }\n+    });\n+\n+    expect(res.headers['location']).toEqual(\n+      'https://www.freecodecamp.org/404?' +\n+        formatMessage({\n+          type: 'danger',\n+          content: \"We couldn't find path /test\"\n+        })\n+    );\n+    expect(res.statusCode).toEqual(302);\n+  });\n+\n+  it('should return a 404 json response if the request does Accept json', async () => {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test',\n+      headers: {\n+        referer: 'https://www.freecodecamp.org/anything',\n+        accept: 'application/json,text/plain'\n+      }\n+    });\n+\n+    expect(res.json()).toEqual({ error: 'path not found' });\n+    expect(res.statusCode).toEqual(404);\n+  });\n+\n+  it('should redirect if the request prefers text/html to json', async () => {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test',\n+      headers: {\n+        referer: 'https://www.freecodecamp.org/anything',\n+        // this does accept json, (via the */*), but prefers text/html\n+        accept: 'text/html,*/*'\n+      }\n+    });\n+\n+    expect(res.headers['location']).toEqual(\n+      'https://www.freecodecamp.org/404?' +\n+        formatMessage({\n+          type: 'danger',\n+          content: \"We couldn't find path /test\"\n+        })\n+    );\n+    expect(res.statusCode).toEqual(302);\n+  });\n+});"
        },
        {
            "sha": "ff59bfd25bcc075e09851e5e7b0eafdb6088c298",
            "filename": "api/src/plugins/not-found.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fsrc%2Fplugins%2Fnot-found.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/api%2Fsrc%2Fplugins%2Fnot-found.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fnot-found.ts?ref=e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe",
            "patch": "@@ -0,0 +1,37 @@\n+import type { FastifyPluginCallback } from 'fastify';\n+\n+import fp from 'fastify-plugin';\n+import accepts from '@fastify/accepts';\n+\n+import { getRedirectParams } from '../utils/redirection';\n+\n+/**\n+ * Plugin for handling missing endpoints.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+const fourOhFour: FastifyPluginCallback = (fastify, _options, done) => {\n+  void fastify.register(accepts);\n+\n+  // If the request accepts JSON and does not specifically prefer text/html,\n+  // this will return a 404 JSON response. Everything else will be redirected.\n+  fastify.setNotFoundHandler((request, reply) => {\n+    const accepted = request.accepts().type(['json', 'html']);\n+\n+    if (accepted == 'json') {\n+      void reply.code(404).send({ error: 'path not found' });\n+    } else {\n+      const { origin } = getRedirectParams(request);\n+      void reply.status(302);\n+      void reply.redirectWithMessage(`${origin}/404`, {\n+        type: 'danger',\n+        content: `We couldn't find path ${request.url}`\n+      });\n+    }\n+  });\n+  done();\n+};\n+\n+export default fp(fourOhFour, { dependencies: ['redirect-with-message'] });"
        },
        {
            "sha": "05564135d52b56d8a1f02fbd4c0f310a33d1858c",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=e8b15a255bfb508cab51df2cd2d6dc29dbb20fbe",
            "patch": "@@ -153,6 +153,9 @@ importers:\n       '@aws-sdk/client-ses':\n         specifier: 3.521.0\n         version: 3.521.0\n+      '@fastify/accepts':\n+        specifier: 4.3.0\n+        version: 4.3.0\n       '@fastify/cookie':\n         specifier: 9.3.1\n         version: 9.3.1\n@@ -2962,6 +2965,9 @@ packages:\n     resolution: {integrity: sha512-OIHZrb2ImZ7XG85HXOONLcJWGosv7sIvM2ifAPQVhg9Lv7qdmMBNVaai4QTdyuaqbKM5eO6sLSQOYI7wEQeCJQ==}\n     engines: {node: '>=14'}\n \n+  '@fastify/accepts@4.3.0':\n+    resolution: {integrity: sha512-QK4FoqXdwwPmaPOLL6NrxsyaXVvdviYVoS6ltHyOLdFlUyREIaMykHQIp+x0aJz9hB3B3n/Ht6QRdvBeGkptGQ==}\n+\n   '@fastify/ajv-compiler@3.5.0':\n     resolution: {integrity: sha512-ebbEtlI7dxXF5ziNdr05mOY8NnDiPB1XvAlLHctRt/Rc+C3LCOVW5imUVX+mhvUhnNzmPBHewUkOFgGlCxgdAA==}\n \n@@ -17078,6 +17084,11 @@ snapshots:\n \n   '@fastify/accept-negotiator@1.1.0': {}\n \n+  '@fastify/accepts@4.3.0':\n+    dependencies:\n+      accepts: 1.3.8\n+      fastify-plugin: 4.5.1\n+\n   '@fastify/ajv-compiler@3.5.0':\n     dependencies:\n       ajv: 8.12.0"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 124,
        "deletions": 0
    }
}