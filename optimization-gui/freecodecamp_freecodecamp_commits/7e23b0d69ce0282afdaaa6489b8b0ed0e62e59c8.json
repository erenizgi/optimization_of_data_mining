{
    "author": "ahmaxed",
    "message": "fix: update stripe wallets to use payment intent (#54668)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
    "files": [
        {
            "sha": "05aee1ac93e62afa228ee5cb76672382f5b30673",
            "filename": "api-server/src/server/boot/donate.js",
            "status": "modified",
            "additions": 74,
            "deletions": 104,
            "changes": 178,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Fboot%2Fdonate.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Fboot%2Fdonate.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fboot%2Fdonate.js?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -1,11 +1,15 @@\n import debug from 'debug';\n import Stripe from 'stripe';\n \n-import { donationSubscriptionConfig } from '../../../../shared/config/donation-settings';\n+import {\n+  donationSubscriptionConfig,\n+  allStripeProductIdsArray\n+} from '../../../../shared/config/donation-settings';\n import keys from '../../../config/secrets';\n import {\n   createStripeCardDonation,\n-  handleStripeCardUpdateSession\n+  handleStripeCardUpdateSession,\n+  inLastFiveMinutes\n } from '../utils/donation';\n import { validStripeForm } from '../utils/stripeHelpers';\n \n@@ -42,117 +46,82 @@ export default function donateBoot(app, done) {\n     });\n   }\n \n-  function createStripeDonation(req, res) {\n-    const { user, body } = req;\n+  async function createStripeDonation(req, res) {\n+    const { body } = req;\n+    const { amount, duration, email, subscriptionId } = body;\n+    try {\n+      const subscription = await stripe.subscriptions.retrieve(subscriptionId);\n+      const isSubscriptionActive = subscription.status === 'active';\n+      const productId = subscription.items.data[0].plan.product;\n+      const isStartedRecently = inLastFiveMinutes(\n+        subscription.current_period_start\n+      );\n+      const isProductIdValid = allStripeProductIdsArray.includes(productId);\n+\n+      if (isSubscriptionActive && isProductIdValid && isStartedRecently) {\n+        const [donatingUser] = await User.findOrCreate(\n+          { where: { email } },\n+          { email }\n+        );\n+        const donation = {\n+          email,\n+          amount,\n+          duration,\n+          provider: 'stripe',\n+          subscriptionId,\n+          customerId: subscription.customer,\n+          startDate: new Date().toISOString()\n+        };\n+        await donatingUser.createDonation(donation);\n+        return res.status(200).send({ isDonating: true });\n+      } else {\n+        throw new Error('Donation failed due to a server error.');\n+      }\n+    } catch (err) {\n+      return res\n+        .status(500)\n+        .send({ error: 'Donation failed due to a server error.' });\n+    }\n+  }\n \n-    const {\n-      amount,\n-      duration,\n-      token: { id },\n-      email,\n-      name\n-    } = body;\n+  async function createStripePaymentIntent(req, res) {\n+    const { body } = req;\n+    const { amount, duration, email, name } = body;\n \n     if (!validStripeForm(amount, duration, email)) {\n-      return res.status(500).send({\n+      return res.status(400).send({\n         error: 'The donation form had invalid values for this submission.'\n       });\n     }\n \n-    const fccUser = user\n-      ? Promise.resolve(user)\n-      : new Promise((resolve, reject) =>\n-          User.findOrCreate(\n-            { where: { email } },\n-            { email },\n-            (err, instance) => {\n-              if (err) {\n-                return reject(err);\n-              }\n-              return resolve(instance);\n-            }\n-          )\n-        );\n+    try {\n+      const stripeCustomer = await stripe.customers.create({\n+        email,\n+        name\n+      });\n \n-    let donatingUser = {};\n-    let donation = {\n-      email,\n-      amount,\n-      duration,\n-      provider: 'stripe',\n-      startDate: new Date(Date.now()).toISOString()\n-    };\n-\n-    const createCustomer = async user => {\n-      let customer;\n-      donatingUser = user;\n-      try {\n-        customer = await stripe.customers.create({\n-          email,\n-          card: id,\n-          name\n-        });\n-      } catch (err) {\n-        throw new Error('Error creating stripe customer');\n-      }\n-      log(`Stripe customer with id ${customer.id} created`);\n-      return customer;\n-    };\n-\n-    const createSubscription = async customer => {\n-      donation.customerId = customer.id;\n-      let sub;\n-      try {\n-        sub = await stripe.subscriptions.create({\n-          customer: customer.id,\n-          items: [\n-            {\n-              plan: `${donationSubscriptionConfig.duration[\n-                duration\n-              ].toLowerCase()}-donation-${amount}`\n-            }\n-          ]\n-        });\n-      } catch (err) {\n-        throw new Error('Error creating stripe subscription');\n-      }\n-      return sub;\n-    };\n-\n-    const createAsyncUserDonation = () => {\n-      donatingUser\n-        .createDonation(donation)\n-        .toPromise()\n-        .catch(err => {\n-          throw new Error(err);\n-        });\n-    };\n-\n-    return Promise.resolve(fccUser)\n-      .then(nonDonatingUser => {\n-        // the logic is removed since users can donate without an account\n-        return nonDonatingUser;\n-      })\n-      .then(createCustomer)\n-      .then(customer => {\n-        return createSubscription(customer).then(subscription => {\n-          log(`Stripe subscription with id ${subscription.id} created`);\n-          donation.subscriptionId = subscription.id;\n-          return res.send(subscription);\n-        });\n-      })\n-      .then(createAsyncUserDonation)\n-      .catch(err => {\n-        if (\n-          err.type === 'StripeCardError' ||\n-          err.type === 'AlreadyDonatingError'\n-        ) {\n-          return res.status(402).send({ error: err.message });\n-        }\n-        return res\n-          .status(500)\n-          .send({ error: 'Donation failed due to a server error.' });\n+      const stripeSubscription = await stripe.subscriptions.create({\n+        customer: stripeCustomer.id,\n+        items: [\n+          {\n+            plan: `${donationSubscriptionConfig.duration[duration]}-donation-${amount}`\n+          }\n+        ],\n+        payment_behavior: 'default_incomplete',\n+        payment_settings: { save_default_payment_method: 'on_subscription' },\n+        expand: ['latest_invoice.payment_intent']\n+      });\n+\n+      res.status(200).send({\n+        subscriptionId: stripeSubscription.id,\n+        clientSecret:\n+          stripeSubscription.latest_invoice.payment_intent.client_secret\n       });\n+    } catch (err) {\n+      return res\n+        .status(500)\n+        .send({ error: 'Donation failed due to a server error.' });\n+    }\n   }\n \n   function addDonation(req, res) {\n@@ -208,6 +177,7 @@ export default function donateBoot(app, done) {\n   } else {\n     api.post('/charge-stripe', createStripeDonation);\n     api.post('/charge-stripe-card', handleStripeCardDonation);\n+    api.post('/create-stripe-payment-intent', createStripePaymentIntent);\n     api.put('/update-stripe-card', handleStripeCardUpdate);\n     api.post('/add-donation', addDonation);\n     donateRouter.use('/donate', api);"
        },
        {
            "sha": "c9287af705e2ad39854107cf72ac06953d3dd0f0",
            "filename": "api-server/src/server/middlewares/csurf.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Fcsurf.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Fcsurf.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Fcsurf.js?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -14,7 +14,9 @@ export default function getCsurf() {\n     const { path } = req;\n     if (\n       // eslint-disable-next-line max-len\n-      /^\\/donate\\/charge-stripe$|^\\/coderoad-challenge-completed$/.test(path)\n+      /^\\/donate\\/charge-stripe$|^\\/donate\\/create-stripe-payment-intent$|^\\/coderoad-challenge-completed$/.test(\n+        path\n+      )\n     ) {\n       next();\n     } else {"
        },
        {
            "sha": "aeb6edf1b07a5ace1ea2550feada8e321df42220",
            "filename": "api-server/src/server/middlewares/request-authorization.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.js?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -24,6 +24,7 @@ const unsubscribedRE = /^\\/unsubscribed\\//;\n const unsubscribeRE = /^\\/u\\/|^\\/unsubscribe\\/|^\\/ue\\//;\n // note: this would be replaced by webhooks later\n const donateRE = /^\\/donate\\/charge-stripe$/;\n+const paymentIntentRE = /^\\/donate\\/create-stripe-payment-intent$/;\n const submitCoderoadChallengeRE = /^\\/coderoad-challenge-completed$/;\n const mobileLoginRE = /^\\/mobile-login\\/?$/;\n \n@@ -40,6 +41,7 @@ const _pathsAllowedREs = [\n   unsubscribedRE,\n   unsubscribeRE,\n   donateRE,\n+  paymentIntentRE,\n   submitCoderoadChallengeRE,\n   mobileLoginRE\n ];"
        },
        {
            "sha": "a8d9208ffe1691db3ec7e712b4bd91afdf67187f",
            "filename": "api-server/src/server/utils/donation.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Futils%2Fdonation.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Futils%2Fdonation.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Futils%2Fdonation.js?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -173,3 +173,9 @@ export async function handleStripeCardUpdateSession(req, app, stripe) {\n   });\n   return { sessionId: session.id };\n }\n+\n+export function inLastFiveMinutes(unixTimestamp) {\n+  const currentTimestamp = Math.floor(Date.now() / 1000);\n+  const timeDifference = currentTimestamp - unixTimestamp;\n+  return timeDifference <= 300; // 300 seconds is 5 minutes\n+}"
        },
        {
            "sha": "4c5f30889b1e9e2185cfa1e92d64eae78788f901",
            "filename": "api-server/src/server/utils/stripeHelpers.js",
            "status": "modified",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Futils%2FstripeHelpers.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/api-server%2Fsrc%2Fserver%2Futils%2FstripeHelpers.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Futils%2FstripeHelpers.js?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -1,15 +1,10 @@\n import { isEmail, isNumeric } from 'validator';\n-import {\n-  durationKeysConfig,\n-  donationOneTimeConfig,\n-  donationSubscriptionConfig\n-} from '../../../../shared/config/donation-settings';\n+import { donationSubscriptionConfig } from '../../../../shared/config/donation-settings';\n \n export function validStripeForm(amount, duration, email) {\n-  return isEmail('' + email) &&\n+  return (\n+    isEmail('' + email) &&\n     isNumeric('' + amount) &&\n-    durationKeysConfig.includes(duration) &&\n-    duration === 'one-time'\n-    ? donationOneTimeConfig.includes(amount)\n-    : donationSubscriptionConfig.plans[duration];\n+    donationSubscriptionConfig.plans[duration].includes(amount)\n+  );\n }"
        },
        {
            "sha": "e0783d1a15ba16a3a578e6d6a4f0258cbf0eb43c",
            "filename": "client/i18n/locales/english/translations.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fi18n%2Flocales%2Fenglish%2Ftranslations.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fi18n%2Flocales%2Fenglish%2Ftranslations.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fi18n%2Flocales%2Fenglish%2Ftranslations.json?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -575,6 +575,7 @@\n     \"other-ways\": \"Here are many <0>other ways you can support our charity's mission</0>.\",\n     \"if-support-further\": \"If you want to support our charity further, please consider <0>making a one-time donation</0>, <1>sending us a check</1>, or <2>learning about other ways you could support our charity.</2>\",\n     \"failed-pay\": \"Uh - oh. It looks like your transaction didn't go through. Could you please try again?\",\n+    \"try-another-method\": \"Uh - oh. It looks like your transaction didn't go through. Could you please try another payment method?\",\n     \"try-again\": \"Please try again.\",\n     \"card-number\": \"Your Card Number:\",\n     \"expiration\": \"Expiration Date:\",\n@@ -787,7 +788,6 @@\n     \"cert-claim-success\": \"@{{username}}, you have successfully claimed the {{name}} Certification! Congratulations on behalf of the freeCodeCamp.org team!\",\n     \"wrong-name\": \"Something went wrong with the verification of {{name}}, please try again. If you continue to receive this error, you can send a message to support@freeCodeCamp.org to get help.\",\n     \"error-claiming\": \"Error claiming {{certName}}\",\n-    \"refresh-needed\": \"You can only use the PaymentRequest button once. Refresh the page to start over.\",\n     \"username-not-found\": \"We could not find a user with the username \\\"{{username}}\\\"\",\n     \"add-name\": \"This user needs to add their name to their account in order for others to be able to view their certification.\",\n     \"not-eligible\": \"This user is not eligible for freeCodeCamp.org certifications at this time.\","
        },
        {
            "sha": "05accc0cba1caf520cc9582662c2a2b9bb86d811",
            "filename": "client/src/components/Donation/donate-form.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Fcomponents%2FDonation%2Fdonate-form.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Fcomponents%2FDonation%2Fdonate-form.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2FDonation%2Fdonate-form.tsx?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -56,6 +56,7 @@ type PostCharge = (data: {\n   name?: string | undefined;\n   paymentMethodId?: string;\n   handleAuthentication?: HandleAuthentication;\n+  subscriptionId?: string;\n }) => void;\n \n type DonateFormProps = {\n@@ -162,9 +163,9 @@ class DonateForm extends Component<DonateFormProps, DonateFormComponentState> {\n     data,\n     payerEmail,\n     payerName,\n-    token,\n     paymentMethodId,\n-    handleAuthentication\n+    handleAuthentication,\n+    subscriptionId\n   }: PostPayment): void => {\n     const { donationAmount, donationDuration: duration } = this.state;\n     const { paymentContext, email, selectedDonationAmount } = this.props;\n@@ -176,11 +177,11 @@ class DonateForm extends Component<DonateFormProps, DonateFormComponentState> {\n       amount,\n       duration,\n       data,\n-      token,\n       email: email || payerEmail,\n       name: payerName,\n       paymentMethodId,\n-      handleAuthentication\n+      handleAuthentication,\n+      subscriptionId\n     });\n     if (this.props.handleProcessing) this.props.handleProcessing();\n   };\n@@ -254,11 +255,11 @@ class DonateForm extends Component<DonateFormProps, DonateFormComponentState> {\n           {loading.stripe && loading.paypal && <PaymentButtonsLoader />}\n           <WalletsWrapper\n             amount={donationAmount}\n+            duration={donationDuration}\n             handlePaymentButtonLoad={this.handlePaymentButtonLoad}\n             label={walletlabel}\n             onDonationStateChange={this.onDonationStateChange}\n             postPayment={this.postPayment}\n-            refreshErrorMessage={t('donate.refresh-needed')}\n             theme={priorityTheme}\n           />\n           <PaypalButton"
        },
        {
            "sha": "454780e4f9233f8b3f591389b27b0ffd12dcaaec",
            "filename": "client/src/components/Donation/types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Fcomponents%2FDonation%2Ftypes.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Fcomponents%2FDonation%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2FDonation%2Ftypes.ts?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -1,4 +1,4 @@\n-import type { Token, PaymentIntentResult } from '@stripe/stripe-js';\n+import type { PaymentIntentResult } from '@stripe/stripe-js';\n \n export type PaymentContext = 'modal' | 'donate page' | 'certificate';\n export type PaymentProvider = 'patreon' | 'paypal' | 'stripe' | 'stripe card';\n@@ -11,11 +11,11 @@ export type HandleAuthentication = (\n export interface PostPayment {\n   paymentProvider: PaymentProvider;\n   data?: DonationApprovalData;\n-  token?: Token;\n   payerEmail?: string | undefined;\n   payerName?: string | undefined;\n   paymentMethodId?: string;\n   handleAuthentication?: HandleAuthentication;\n+  subscriptionId?: string;\n }\n \n export interface DonationApprovalData {"
        },
        {
            "sha": "311dea53383d433201bf85432a75d5b1d09548f4",
            "filename": "client/src/components/Donation/wallets-button.tsx",
            "status": "modified",
            "additions": 82,
            "deletions": 39,
            "changes": 121,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Fcomponents%2FDonation%2Fwallets-button.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Fcomponents%2FDonation%2Fwallets-button.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2FDonation%2Fwallets-button.tsx?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -2,20 +2,25 @@ import {\n   PaymentRequestButtonElement,\n   ElementsConsumer\n } from '@stripe/react-stripe-js';\n-import type { Token, PaymentRequest, Stripe } from '@stripe/stripe-js';\n-import React, { useState, useEffect } from 'react';\n+import type { PaymentRequest, Stripe } from '@stripe/stripe-js';\n+import React, { useState, useEffect, useCallback } from 'react';\n+import { useTranslation } from 'react-i18next';\n \n import { Themes } from '../settings/theme';\n-import { PaymentProvider } from '../../../../shared/config/donation-settings';\n+import {\n+  PaymentProvider,\n+  DonationDuration\n+} from '../../../../shared/config/donation-settings';\n+import { createStripePaymentIntent } from '../../utils/ajax';\n import { DonationApprovalData, PostPayment } from './types';\n \n interface WrapperProps {\n   label: string;\n   amount: number;\n   theme: Themes;\n+  duration: DonationDuration;\n   postPayment: (arg0: PostPayment) => void;\n   onDonationStateChange: (donationState: DonationApprovalData) => void;\n-  refreshErrorMessage: string;\n   handlePaymentButtonLoad: (provider: 'stripe' | 'paypal') => void;\n }\n interface WalletsButtonProps extends WrapperProps {\n@@ -27,16 +32,27 @@ const WalletsButton = ({\n   label,\n   amount,\n   theme,\n-  refreshErrorMessage,\n+  duration,\n   postPayment,\n   onDonationStateChange,\n   handlePaymentButtonLoad\n }: WalletsButtonProps) => {\n-  const [token, setToken] = useState<Token | null>(null);\n   const [paymentRequest, setPaymentRequest] = useState<PaymentRequest | null>(\n     null\n   );\n-  const [canMakePayment, checkPaymentPossibility] = useState(false);\n+  const { t } = useTranslation();\n+\n+  const displayError = useCallback(\n+    (errorMessage: string): void => {\n+      onDonationStateChange({\n+        redirecting: false,\n+        processing: false,\n+        success: false,\n+        error: errorMessage\n+      });\n+    },\n+    [onDonationStateChange]\n+  );\n \n   useEffect(() => {\n     if (!stripe) {\n@@ -52,51 +68,78 @@ const WalletsButton = ({\n       disableWallets: ['browserCard']\n     });\n \n-    pr.on('token', event => {\n-      const { token, payerEmail, payerName } = event;\n-      setToken(token);\n-      event.complete('success');\n-      postPayment({\n-        paymentProvider: PaymentProvider.Stripe,\n-        token,\n+    pr.on('paymentmethod', async event => {\n+      const {\n         payerEmail,\n-        payerName\n+        payerName,\n+        paymentMethod: { id: paymentMethodId }\n+      } = event;\n+      //create payment intent\n+      const {\n+        data: { clientSecret, subscriptionId, error }\n+      } = await createStripePaymentIntent({\n+        email: payerEmail,\n+        name: payerName,\n+        amount,\n+        duration\n       });\n-    });\n \n-    void pr.canMakePayment().then(canMakePaymentRes => {\n-      if (canMakePaymentRes) {\n-        setPaymentRequest(pr);\n-        checkPaymentPossibility(true);\n-      } else {\n-        checkPaymentPossibility(false);\n+      if (error) {\n+        event.complete('fail');\n+        displayError(t('donate.try-another-method'));\n+      } else if (clientSecret) {\n+        // confirm payment intent\n+        const { paymentIntent, error: confirmError } =\n+          await stripe.confirmCardPayment(\n+            clientSecret,\n+            { payment_method: event.paymentMethod.id },\n+            { handleActions: false }\n+          );\n+\n+        if (confirmError) {\n+          event.complete('fail');\n+          displayError(t('donate.try-another-method'));\n+        } else {\n+          event.complete('success');\n+          if (paymentIntent.status === 'requires_action') {\n+            const { error } = await stripe.confirmCardPayment(clientSecret);\n+            if (error) {\n+              return displayError(t('donate.try-another-method'));\n+            }\n+          }\n+          postPayment({\n+            paymentProvider: PaymentProvider.Stripe,\n+            paymentMethodId,\n+            payerEmail,\n+            payerName,\n+            subscriptionId\n+          });\n+        }\n       }\n     });\n \n+    void pr.canMakePayment().then(result => {\n+      if (result) setPaymentRequest(pr);\n+    });\n+\n     return () => {\n       setPaymentRequest(null);\n-      checkPaymentPossibility(false);\n     };\n-  }, [label, amount, stripe, postPayment, handlePaymentButtonLoad]);\n-\n-  const displayRefreshError = (): void => {\n-    onDonationStateChange({\n-      redirecting: false,\n-      processing: false,\n-      success: false,\n-      error: refreshErrorMessage\n-    });\n-  };\n+  }, [\n+    label,\n+    amount,\n+    stripe,\n+    postPayment,\n+    handlePaymentButtonLoad,\n+    duration,\n+    displayError,\n+    t\n+  ]);\n \n   return (\n     <form className='wallets-form'>\n-      {canMakePayment && paymentRequest && (\n+      {paymentRequest && (\n         <PaymentRequestButtonElement\n-          onClick={() => {\n-            if (token) {\n-              displayRefreshError();\n-            }\n-          }}\n           onReady={() => handlePaymentButtonLoad('stripe')}\n           options={{\n             style: {"
        },
        {
            "sha": "07bb22ae5c5c4718616e95c2704566f2a6b25763",
            "filename": "client/src/utils/ajax.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Futils%2Fajax.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/client%2Fsrc%2Futils%2Fajax.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fajax.ts?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -11,6 +11,7 @@ import type {\n   SurveyResults,\n   User\n } from '../redux/prop-types';\n+import { DonationDuration } from '../../../shared/config/donation-settings';\n \n const { apiLocation } = envData;\n \n@@ -256,6 +257,31 @@ export function postChargeStripeCard(\n ): Promise<ResponseWithData<void>> {\n   return post('/donate/charge-stripe-card', body);\n }\n+\n+type PaymentIntentResponse = Promise<\n+  ResponseWithData<\n+    | {\n+        clientSecret?: never;\n+        subscriptionId?: never;\n+        error: string;\n+      }\n+    | {\n+        clientSecret: string;\n+        subscriptionId: string;\n+        error?: never;\n+      }\n+  >\n+>;\n+\n+export function createStripePaymentIntent(body: {\n+  email: string | undefined;\n+  name: string | undefined;\n+  amount: number;\n+  duration: DonationDuration;\n+}): PaymentIntentResponse {\n+  return post('/donate/create-stripe-payment-intent', body);\n+}\n+\n interface Report {\n   username: string;\n   reportDescription: string;"
        },
        {
            "sha": "b938173336ce31752d0186566f8e9260a6d5968d",
            "filename": "shared/config/donation-settings.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/shared%2Fconfig%2Fdonation-settings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8/shared%2Fconfig%2Fdonation-settings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/shared%2Fconfig%2Fdonation-settings.ts?ref=7e23b0d69ce0282afdaaa6489b8b0ed0e62e59c8",
            "patch": "@@ -38,10 +38,10 @@ export const durationKeysConfig = ['month', 'one-time'];\n export const donationOneTimeConfig = [100000, 25000, 6000];\n export const donationSubscriptionConfig = {\n   duration: {\n-    month: 'Monthly'\n+    month: 'monthly'\n   },\n   plans: {\n-    month: [25000, 3500, 500]\n+    month: subscriptionAmounts\n   }\n };\n \n@@ -123,3 +123,27 @@ export enum PaymentProvider {\n   Stripe = 'stripe',\n   StripeCard = 'stripe card'\n }\n+\n+const stripeProductIds = {\n+  live: {\n+    month: {\n+      500: 'prod_Cc9bIxB2NvjpLy',\n+      1000: 'prod_BuiSxWk7jGSFlJ',\n+      2000: 'prod_IElpZVK7kOn6Fe',\n+      4000: 'prod_IElq1foW39g3Cx'\n+    }\n+  },\n+  staging: {\n+    month: {\n+      500: 'prod_GD1GGbJsqQaupl',\n+      1000: 'prod_GD1IzNEXfSCGgy',\n+      2000: 'prod_IEkNp8M03xvsuB',\n+      4000: 'prod_IEkPebxS63mVbs'\n+    }\n+  }\n+};\n+\n+export const allStripeProductIdsArray = [\n+  ...Object.values(stripeProductIds['live']['month']),\n+  ...Object.values(stripeProductIds['staging']['month'])\n+];"
        }
    ],
    "stats": {
        "total": 397,
        "additions": 233,
        "deletions": 164
    }
}