{
    "author": "ojeytonwilliams",
    "message": "feat(api): port /confirm-email to new api (#54975)\n\nCo-authored-by: Niraj Nandish <nirajnandish@icloud.com>",
    "sha": "22e74e640670a2959887f91ef94f6b08032c46aa",
    "files": [
        {
            "sha": "f15eef95fa10ba6c8b4ee51276828d72299050d0",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -46,10 +46,11 @@ export function superRequest(\n   config: {\n     method: 'GET' | 'POST' | 'PUT' | 'DELETE';\n     setCookies?: string[];\n+    headers?: { referer: string };\n   },\n   options?: Options\n ): request.Test {\n-  const { method, setCookies } = config;\n+  const { method, setCookies, headers } = config;\n   const { sendCSRFToken = true } = options ?? {};\n \n   const req = requests[method](resource).set('Origin', ORIGIN);\n@@ -58,6 +59,10 @@ export function superRequest(\n     void req.set('Cookie', getCookies(setCookies));\n   }\n \n+  if (headers) {\n+    void req.set('Referer', headers.referer);\n+  }\n+\n   const csrfToken = (setCookies && getCsrfToken(setCookies)) ?? '';\n   if (sendCSRFToken) {\n     void req.set('CSRF-Token', csrfToken);"
        },
        {
            "sha": "7078a705e560340e0742391c3012013dc345fb09",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -36,7 +36,7 @@ import { deprecatedEndpoints } from './routes/deprecated-endpoints';\n import { unsubscribeDeprecated } from './routes/deprecated-unsubscribe';\n import { donateRoutes } from './routes/donate';\n import { emailSubscribtionRoutes } from './routes/email-subscription';\n-import { settingRoutes } from './routes/settings';\n+import { settingRoutes, settingRedirectRoutes } from './routes/settings';\n import { statusRoute } from './routes/status';\n import { userGetRoutes, userRoutes, userPublicGetRoutes } from './routes/user';\n import {\n@@ -180,6 +180,8 @@ export const build = async (\n     fastify.log.info(`Swagger UI available at ${API_LOCATION}/documentation`);\n   }\n \n+  // redirectWithMessage must be registered before codeFlowAuth\n+  void fastify.register(redirectWithMessage);\n   void fastify.register(codeFlowAuth);\n   void fastify.register(prismaPlugin);\n   void fastify.register(mobileAuth0Routes);\n@@ -188,6 +190,7 @@ export const build = async (\n   }\n   void fastify.register(challengeRoutes);\n   void fastify.register(settingRoutes);\n+  void fastify.register(settingRedirectRoutes);\n   void fastify.register(donateRoutes);\n   void fastify.register(emailSubscribtionRoutes);\n   void fastify.register(userRoutes);\n@@ -198,7 +201,6 @@ export const build = async (\n   void fastify.register(deprecatedEndpoints);\n   void fastify.register(statusRoute);\n   void fastify.register(unsubscribeDeprecated);\n-  void fastify.register(redirectWithMessage);\n \n   return fastify;\n };"
        },
        {
            "sha": "95f5e5efba4c3a991dbbb1ea8095ee96416d71b4",
            "filename": "api/src/plugins/code-flow-auth.test.ts",
            "status": "modified",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fplugins%2Fcode-flow-auth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fplugins%2Fcode-flow-auth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcode-flow-auth.test.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -5,13 +5,15 @@ import { COOKIE_DOMAIN, JWT_SECRET } from '../utils/env';\n import { type Token, createAccessToken } from '../utils/tokens';\n import cookies, { sign as signCookie, unsign as unsignCookie } from './cookies';\n import codeFlowAuth from './code-flow-auth';\n+import redirectWithMessage, { formatMessage } from './redirect-with-message';\n \n describe('auth', () => {\n   let fastify: FastifyInstance;\n \n   beforeEach(async () => {\n     fastify = Fastify();\n     await fastify.register(cookies);\n+    await fastify.register(redirectWithMessage);\n     await fastify.register(codeFlowAuth);\n   });\n \n@@ -203,4 +205,124 @@ describe('auth', () => {\n       expect(res.json()).toEqual({ ok: true });\n     });\n   });\n+\n+  describe('authorizeOrRedirect', () => {\n+    const redirectLocation = `http://localhost:8000?${formatMessage({ type: 'info', content: 'Only authenticated users can access this route. Please sign in and try again.' })}`;\n+\n+    beforeEach(() => {\n+      fastify.addHook('onRequest', fastify.authorizeOrRedirect);\n+      fastify.get('/test', () => {\n+        return { message: 'ok' };\n+      });\n+    });\n+\n+    it('should redirect to the origin if the access token is missing', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test'\n+      });\n+\n+      expect(res.headers.location).toBe(redirectLocation);\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should redirect to the origin if the access token is not signed', async () => {\n+      const token = jwt.sign(\n+        { accessToken: createAccessToken('123') },\n+        JWT_SECRET\n+      );\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test',\n+        cookies: {\n+          jwt_access_token: token\n+        }\n+      });\n+\n+      expect(res.headers.location).toBe(redirectLocation);\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should redirect to the origin if the access token is invalid', async () => {\n+      const token = jwt.sign(\n+        { accessToken: createAccessToken('123') },\n+        'invalid-secret'\n+      );\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test',\n+        cookies: {\n+          jwt_access_token: signCookie(token)\n+        }\n+      });\n+\n+      expect(res.headers.location).toBe(redirectLocation);\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should redirect to the origin if the access token has expired', async () => {\n+      const token = jwt.sign(\n+        { accessToken: createAccessToken('123', -1) },\n+        JWT_SECRET\n+      );\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test',\n+        cookies: {\n+          jwt_access_token: signCookie(token)\n+        }\n+      });\n+\n+      expect(res.headers.location).toBe(redirectLocation);\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should redirect to the origin if the user is not found', async () => {\n+      // @ts-expect-error prisma isn't defined, since we're not building the\n+      // full application here.\n+      fastify.prisma = { user: { findUnique: () => null } };\n+      const token = jwt.sign(\n+        { accessToken: createAccessToken('123') },\n+        JWT_SECRET\n+      );\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test',\n+        cookies: {\n+          jwt_access_token: signCookie(token)\n+        }\n+      });\n+\n+      expect(res.headers.location).toBe(redirectLocation);\n+      expect(res.statusCode).toBe(302);\n+    });\n+\n+    it('should populate the request with the user if the token is valid', async () => {\n+      const fakeUser = { id: '123', username: 'test-user' };\n+      // @ts-expect-error prisma isn't defined, since we're not building the\n+      // full application here.\n+      fastify.prisma = { user: { findUnique: () => fakeUser } };\n+      fastify.get('/test-user', req => {\n+        expect(req.user).toEqual(fakeUser);\n+        return { ok: true };\n+      });\n+\n+      const token = jwt.sign(\n+        { accessToken: createAccessToken('123') },\n+        JWT_SECRET\n+      );\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test-user',\n+        cookies: {\n+          jwt_access_token: signCookie(token)\n+        }\n+      });\n+\n+      expect(res.json()).toEqual({ ok: true });\n+    });\n+  });\n });"
        },
        {
            "sha": "bbcac240a60550b2c3bb0c56f715a8039439e54a",
            "filename": "api/src/plugins/code-flow-auth.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 20,
            "changes": 70,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -1,11 +1,11 @@\n import { FastifyPluginCallback, FastifyReply, FastifyRequest } from 'fastify';\n import fp from 'fastify-plugin';\n import jwt from 'jsonwebtoken';\n-import { isBefore } from 'date-fns';\n import { type user } from '@prisma/client';\n \n import { COOKIE_DOMAIN, JWT_SECRET } from '../utils/env';\n-import { type Token } from '../utils/tokens';\n+import { type Token, isExpired } from '../utils/tokens';\n+import { getRedirectParams } from '../utils/redirection';\n \n declare module 'fastify' {\n   interface FastifyReply {\n@@ -19,6 +19,7 @@ declare module 'fastify' {\n \n   interface FastifyInstance {\n     authorize: (req: FastifyRequest, reply: FastifyReply) => void;\n+    authorizeOrRedirect: (req: FastifyRequest, reply: FastifyReply) => void;\n   }\n }\n \n@@ -40,41 +41,70 @@ const codeFlowAuth: FastifyPluginCallback = (fastify, _options, done) => {\n   const TOKEN_INVALID = 'Your access token is invalid';\n   const TOKEN_EXPIRED = 'Access token is no longer valid';\n \n-  const send401 = (reply: FastifyReply, message: string) =>\n-    reply.status(401).send({ type: 'info', message });\n+  const send401 = (\n+    _req: FastifyRequest,\n+    reply: FastifyReply,\n+    message: string\n+  ): void => {\n+    void reply.status(401).send({ type: 'info', message });\n+  };\n \n-  fastify.decorate(\n-    'authorize',\n-    async function (req: FastifyRequest, reply: FastifyReply) {\n+  const redirectHome = (\n+    req: FastifyRequest,\n+    reply: FastifyReply,\n+    _ignored: string\n+  ) => {\n+    const { origin } = getRedirectParams(req);\n+\n+    void reply.redirectWithMessage(origin, {\n+      type: 'info',\n+      content:\n+        'Only authenticated users can access this route. Please sign in and try again.'\n+    });\n+  };\n+\n+  const handleAuth =\n+    (\n+      rejectStrategy: (\n+        req: FastifyRequest,\n+        reply: FastifyReply,\n+        message: string\n+      ) => void\n+    ) =>\n+    async (req: FastifyRequest, reply: FastifyReply) => {\n       const tokenCookie = req.cookies.jwt_access_token;\n-      if (!tokenCookie) return send401(reply, TOKEN_REQUIRED);\n+      if (!tokenCookie) return rejectStrategy(req, reply, TOKEN_REQUIRED);\n \n       const unsignedToken = req.unsignCookie(tokenCookie);\n-      if (!unsignedToken.valid) return send401(reply, TOKEN_REQUIRED);\n+      if (!unsignedToken.valid)\n+        return rejectStrategy(req, reply, TOKEN_REQUIRED);\n \n       const jwtAccessToken = unsignedToken.value;\n \n       try {\n         jwt.verify(jwtAccessToken!, JWT_SECRET);\n       } catch {\n-        return send401(reply, TOKEN_INVALID);\n+        return rejectStrategy(req, reply, TOKEN_INVALID);\n       }\n \n-      const {\n-        accessToken: { created, ttl, userId }\n-      } = jwt.decode(jwtAccessToken!) as { accessToken: Token };\n-      const valid = isBefore(Date.now(), Date.parse(created) + ttl);\n-      if (!valid) return send401(reply, TOKEN_EXPIRED);\n+      const { accessToken } = jwt.decode(jwtAccessToken!) as {\n+        accessToken: Token;\n+      };\n+\n+      if (isExpired(accessToken))\n+        return rejectStrategy(req, reply, TOKEN_EXPIRED);\n \n       const user = await fastify.prisma.user.findUnique({\n-        where: { id: userId }\n+        where: { id: accessToken.userId }\n       });\n-      if (!user) return send401(reply, TOKEN_INVALID);\n+      if (!user) return rejectStrategy(req, reply, TOKEN_INVALID);\n       req.user = user;\n-    }\n-  );\n+    };\n+\n+  fastify.decorate('authorize', handleAuth(send401));\n+  fastify.decorate('authorizeOrRedirect', handleAuth(redirectHome));\n \n   done();\n };\n \n-export default fp(codeFlowAuth);\n+export default fp(codeFlowAuth, { dependencies: ['redirect-with-message'] });"
        },
        {
            "sha": "683f589b8dddd5dfacbab2ee00db8310a7fb2765",
            "filename": "api/src/plugins/redirect-with-message.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fplugins%2Fredirect-with-message.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fplugins%2Fredirect-with-message.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fredirect-with-message.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -32,15 +32,22 @@ function redirectWithMessage(\n   url: string,\n   message: Message\n ) {\n-  return this.redirect(\n-    `${url}?${qs.stringify(\n-      {\n-        messages: qs.stringify(prepareMessage(message), {\n-          arrayFormat: 'index'\n-        })\n-      },\n-      { arrayFormat: 'index' }\n-    )}`\n+  return this.redirect(`${url}?${formatMessage(message)}`);\n+}\n+\n+/**\n+ * Formats the message into a querystring.\n+ * @param message The message to format.\n+ * @returns The formatted message string.\n+ */\n+export function formatMessage(message: Message): string {\n+  return qs.stringify(\n+    {\n+      messages: qs.stringify(prepareMessage(message), {\n+        arrayFormat: 'index'\n+      })\n+    },\n+    { arrayFormat: 'index' }\n   );\n }\n \n@@ -50,4 +57,4 @@ const plugin: FastifyPluginCallback = (fastify, _options, done) => {\n   done();\n };\n \n-export default fp(plugin);\n+export default fp(plugin, { name: 'redirect-with-message' });"
        },
        {
            "sha": "a82a3c4847e0b71e870c7381cbe24c4f08581335",
            "filename": "api/src/routes/settings.test.ts",
            "status": "modified",
            "additions": 265,
            "deletions": 31,
            "changes": 296,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Froutes%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Froutes%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.test.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -1,13 +1,16 @@\n /* eslint-disable @typescript-eslint/no-unsafe-assignment */\n+/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n import {\n   devLogin,\n   setupServer,\n   superRequest,\n   createSuperRequest,\n-  defaultUserId\n+  defaultUserId,\n+  defaultUserEmail\n } from '../../jest.utils';\n+import { formatMessage } from '../plugins/redirect-with-message';\n import { createUserInput } from '../utils/create-user';\n-import { API_LOCATION } from '../utils/env';\n+import { API_LOCATION, HOME_LOCATION } from '../utils/env';\n import { isPictureWithProtocol, getWaitMessage } from './settings';\n \n const baseProfileUI = {\n@@ -98,11 +101,13 @@ describe('settingRoutes', () => {\n \n   describe('Authenticated user', () => {\n     let superPut: ReturnType<typeof createSuperRequest>;\n+    let superGet: ReturnType<typeof createSuperRequest>;\n \n     // Authenticate user\n     beforeAll(async () => {\n       const setCookies = await devLogin();\n       superPut = createSuperRequest({ method: 'PUT', setCookies });\n+      superGet = createSuperRequest({ method: 'GET', setCookies });\n       // This is not strictly necessary, since the defaultUser has this\n       // profileUI, but we're interested in how the profileUI is updated. As\n       // such, setting this explicitly isolates these tests.\n@@ -122,6 +127,221 @@ describe('settingRoutes', () => {\n       }\n     });\n \n+    describe('/confirm-email', () => {\n+      const defaultErrorMessage = {\n+        type: 'danger',\n+        content:\n+          'Oops! Something went wrong. Please try again in a moment or contact support@freecodecamp.org if the error persists.'\n+      } as const;\n+\n+      const successMessage = {\n+        type: 'success',\n+        content: 'flash.email-valid'\n+      } as const;\n+\n+      const validToken =\n+        '4kZFEVHChxzY7kX1XSzB4uhh8fcUwcqAGWV9hv25hsI6nviVlwzXCv2YE9lENYGy';\n+      // This is a valid id for a token, but it doesn't exist in the database\n+      const validButMissingToken =\n+        '4kZFEVHChxzY7kX1XSzB4uhh8fcUwcqAGWV9hv25hsI6nviVlwzXCv2YE9lENYGY';\n+      const tokenWithMissingUser =\n+        '4kZFEVHChxzY7kX1XSzB4uhh8fcUwcqAGWV9hv25hsI6nviVlwzXCv2YE9lENYGH';\n+      const expiredToken =\n+        '4kZFEVHChxzY7kX1XSzB4uhh8fcUwcqAGWV9hv25hsI6nviVlwzXCv2YE9lENYGE';\n+\n+      const tokens = [validToken, tokenWithMissingUser, expiredToken];\n+      const newEmail = 'anything@goes.com';\n+      const encodedEmail = Buffer.from(newEmail).toString('base64');\n+      const notEmail = Buffer.from('foobar.com').toString('base64');\n+\n+      beforeEach(async () => {\n+        await fastifyTestInstance.prisma.authToken.create({\n+          data: {\n+            created: new Date(),\n+            id: validToken,\n+            ttl: 1000,\n+            userId: defaultUserId\n+          }\n+        });\n+\n+        await fastifyTestInstance.prisma.authToken.create({\n+          data: {\n+            created: new Date(),\n+            id: tokenWithMissingUser,\n+            ttl: 1000,\n+            // Random ObjectId\n+            userId: '6650ac23ccc46c0349a86dee'\n+          }\n+        });\n+\n+        await fastifyTestInstance.prisma.authToken.create({\n+          data: {\n+            created: new Date(Date.now() - 1000),\n+            id: expiredToken,\n+            ttl: 1000,\n+            userId: defaultUserId\n+          }\n+        });\n+\n+        // We expect these properties to be changed by the endpoint, so they\n+        // need to be set so that change can be confirmed.\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: {\n+            newEmail,\n+            emailVerified: false,\n+            emailVerifyTTL: new Date(),\n+            emailAuthLinkTTL: new Date()\n+          }\n+        });\n+      });\n+\n+      afterEach(async () => {\n+        await fastifyTestInstance.prisma.authToken.deleteMany({\n+          where: { id: { in: tokens } }\n+        });\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: { newEmail: null, email: defaultUserEmail, emailVerified: true }\n+        });\n+      });\n+\n+      it('should reject requests without params', async () => {\n+        const resNoParams = await superGet('/confirm-email');\n+\n+        expect(resNoParams.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(defaultErrorMessage)\n+        );\n+        expect(resNoParams.status).toBe(302);\n+      });\n+\n+      it('should reject requests which have an invalid token param', async () => {\n+        const res = await superGet(\n+          // token should be 64 characters long\n+          `/confirm-email?email=${encodedEmail}&token=tooshort`\n+        );\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(defaultErrorMessage)\n+        );\n+        expect(res.status).toBe(302);\n+      });\n+\n+      it('should reject requests which have an invalid email param', async () => {\n+        const res = await superGet(\n+          `/confirm-email?email=${notEmail}&token=${validToken}`\n+        );\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(defaultErrorMessage)\n+        );\n+        expect(res.status).toBe(302);\n+      });\n+\n+      it('should reject requests when the auth token is not in the database', async () => {\n+        const res = await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${validButMissingToken}`\n+        );\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(defaultErrorMessage)\n+        );\n+        expect(res.status).toBe(302);\n+      });\n+\n+      it('should reject requests when the auth token exists, but the user does not', async () => {\n+        const res = await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${validButMissingToken}`\n+        );\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(defaultErrorMessage)\n+        );\n+        expect(res.status).toBe(302);\n+      });\n+\n+      // TODO(Post-MVP): there's no need to keep the auth token around if,\n+      // somehow, the user is missing\n+      it.todo(\n+        'should delete the auth token if there is no user associated with it'\n+      );\n+\n+      it('should reject requests when the email param is different from user.newEmail', async () => {\n+        await fastifyTestInstance.prisma.user.update({\n+          where: { id: defaultUserId },\n+          data: { newEmail: 'an@oth.er' }\n+        });\n+\n+        const res = await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${validToken}`\n+        );\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(defaultErrorMessage)\n+        );\n+        expect(res.status).toBe(302);\n+      });\n+\n+      it('should reject requests if the auth token has expired', async () => {\n+        const res = await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${expiredToken}`\n+        );\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` +\n+            formatMessage({\n+              content:\n+                'The link to confirm your new email address has expired. Please try again.',\n+              type: 'info'\n+            })\n+        );\n+        expect(res.status).toBe(302);\n+      });\n+\n+      it('should update the user email', async () => {\n+        const res = await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${validToken}`\n+        );\n+        const user = await fastifyTestInstance.prisma.user.findUniqueOrThrow({\n+          where: { id: defaultUserId }\n+        });\n+\n+        expect(res.headers.location).toBe(\n+          `${HOME_LOCATION}?` + formatMessage(successMessage)\n+        );\n+        expect(user.email).toBe(newEmail);\n+      });\n+\n+      it('should clean up the user record', async () => {\n+        await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${validToken}`\n+        );\n+\n+        const user = await fastifyTestInstance.prisma.user.findUniqueOrThrow({\n+          where: { id: defaultUserId }\n+        });\n+\n+        expect(user.newEmail).toBeNull();\n+        expect(user.emailVerified).toBe(true);\n+        expect(user.emailVerifyTTL).toBeNull();\n+        expect(user.emailAuthLinkTTL).toBeNull();\n+      });\n+\n+      it('should remove the auth token on success', async () => {\n+        await superGet(\n+          `/confirm-email?email=${encodedEmail}&token=${validToken}`\n+        );\n+\n+        const authToken = await fastifyTestInstance.prisma.authToken.findUnique(\n+          {\n+            where: { id: validToken }\n+          }\n+        );\n+\n+        expect(authToken).toBeNull();\n+      });\n+    });\n+\n     describe('/update-my-profileui', () => {\n       test('PUT returns 200 status code with \"success\" message', async () => {\n         const response = await superPut('/update-my-profileui').send({\n@@ -799,37 +1019,51 @@ Happy coding!\n         expect(user?.isClassroomAccount).toEqual(false);\n       });\n     });\n+  });\n+\n+  describe('Unauthenticated User', () => {\n+    let setCookies: string[];\n+\n+    // Get the CSRF cookies from an unprotected route\n+    beforeAll(async () => {\n+      const res = await superRequest('/status/ping', { method: 'GET' });\n+      setCookies = res.get('Set-Cookie');\n+    });\n \n-    describe('Unauthenticated User', () => {\n-      let setCookies: string[];\n-\n-      // Get the CSRF cookies from an unprotected route\n-      beforeAll(async () => {\n-        const res = await superRequest('/status/ping', { method: 'GET' });\n-        setCookies = res.get('Set-Cookie');\n-      });\n-\n-      const endpoints: { path: string; method: 'PUT' }[] = [\n-        { path: '/update-my-profileui', method: 'PUT' },\n-        { path: '/update-my-theme', method: 'PUT' },\n-        { path: '/update-my-username', method: 'PUT' },\n-        { path: '/update-my-keyboard-shortcuts', method: 'PUT' },\n-        { path: '/update-my-socials', method: 'PUT' },\n-        { path: '/update-my-quincy-email', method: 'PUT' },\n-        { path: '/update-my-about', method: 'PUT' },\n-        { path: '/update-my-honesty', method: 'PUT' },\n-        { path: '/update-privacy-terms', method: 'PUT' },\n-        { path: '/update-my-portfolio', method: 'PUT' }\n-      ];\n-\n-      endpoints.forEach(({ path, method }) => {\n-        test(`${method} ${path} returns 401 status code with error message`, async () => {\n-          const response = await superRequest(path, {\n-            method,\n-            setCookies\n-          });\n-          expect(response.statusCode).toBe(401);\n+    describe('/confirm-email', () => {\n+      it('redirects to the HOME_LOCATION with flash message', async () => {\n+        const res = await superRequest('/confirm-email', {\n+          method: 'GET',\n+          headers: { referer: 'https://who.knows/' }\n         });\n+\n+        expect(res.status).toBe(302);\n+        expect(res.headers).toMatchObject({\n+          location: `http://localhost:8000?${formatMessage({ type: 'info', content: 'Only authenticated users can access this route. Please sign in and try again.' })}`\n+        });\n+      });\n+    });\n+\n+    const endpoints: { path: string; method: 'PUT' }[] = [\n+      { path: '/update-my-profileui', method: 'PUT' },\n+      { path: '/update-my-theme', method: 'PUT' },\n+      { path: '/update-my-username', method: 'PUT' },\n+      { path: '/update-my-keyboard-shortcuts', method: 'PUT' },\n+      { path: '/update-my-socials', method: 'PUT' },\n+      { path: '/update-my-quincy-email', method: 'PUT' },\n+      { path: '/update-my-about', method: 'PUT' },\n+      { path: '/update-my-honesty', method: 'PUT' },\n+      { path: '/update-privacy-terms', method: 'PUT' },\n+      { path: '/update-my-portfolio', method: 'PUT' }\n+    ];\n+\n+    endpoints.forEach(({ path, method }) => {\n+      test(`${method} ${path} returns 401 status code with error message`, async () => {\n+        const response = await superRequest(path, {\n+          method,\n+          setCookies\n+        });\n+        expect(response.statusCode).toBe(401);\n       });\n     });\n   });"
        },
        {
            "sha": "3cb5505bead58f99750caa45eeeaf665118c57ea",
            "filename": "api/src/routes/settings.ts",
            "status": "modified",
            "additions": 121,
            "deletions": 1,
            "changes": 122,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Froutes%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Froutes%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -5,6 +5,7 @@ import {\n import type {\n   ContextConfigDefault,\n   FastifyError,\n+  FastifyInstance,\n   FastifyReply,\n   FastifyRequest,\n   RawReplyDefaultExpression,\n@@ -14,13 +15,17 @@ import type {\n } from 'fastify';\n import { ResolveFastifyReplyType } from 'fastify/types/type-provider';\n import { differenceInMinutes } from 'date-fns';\n+import validator from 'validator';\n \n import { isValidUsername } from '../../../shared/utils/validate';\n import * as schemas from '../schemas';\n-import { createAuthToken } from '../utils/tokens';\n+import { createAuthToken, isExpired } from '../utils/tokens';\n import { API_LOCATION } from '../utils/env';\n+import { getRedirectParams } from '../utils/redirection';\n import { isRestricted } from './helpers/is-restricted';\n \n+const { isEmail } = validator;\n+\n type WaitMesssageArgs = {\n   sentAt: Date | null;\n   now?: Date;\n@@ -439,6 +444,7 @@ ${isLinkSentWithinLimitTTL}`\n       }\n     }\n   );\n+\n   fastify.put(\n     '/update-my-about',\n     {\n@@ -662,3 +668,117 @@ ${isLinkSentWithinLimitTTL}`\n \n   done();\n };\n+\n+/**\n+ * Plugin for endpoints that redirect if the user is not authenticated.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options for the plugin.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  fastify.addHook('onRequest', fastify.authorizeOrRedirect);\n+\n+  const redirectMessage = {\n+    type: 'danger',\n+    content:\n+      'Oops! Something went wrong. Please try again in a moment or contact support@freecodecamp.org if the error persists.'\n+  } as const;\n+\n+  const expirationMessage = {\n+    type: 'info',\n+    content:\n+      'The link to confirm your new email address has expired. Please try again.'\n+  } as const;\n+\n+  const successMessage = {\n+    type: 'success',\n+    content: 'flash.email-valid'\n+  } as const;\n+\n+  async function updateEmail(\n+    fastify: FastifyInstance,\n+    { id, email }: { id: string; email: string }\n+  ) {\n+    await fastify.prisma.user.update({\n+      where: { id },\n+      data: {\n+        email,\n+        emailAuthLinkTTL: null,\n+        emailVerified: true,\n+        emailVerifyTTL: null,\n+        newEmail: null\n+      }\n+    });\n+  }\n+\n+  async function deleteAuthToken(\n+    fastify: FastifyInstance,\n+    { id }: { id: string }\n+  ) {\n+    await fastify.prisma.authToken.delete({\n+      where: { id }\n+    });\n+  }\n+\n+  fastify.get(\n+    '/confirm-email',\n+    {\n+      schema: schemas.confirmEmail,\n+      errorHandler(error, request, reply) {\n+        if (error.validation) {\n+          const { origin } = getRedirectParams(request);\n+          void reply.redirectWithMessage(origin, redirectMessage);\n+        } else {\n+          fastify.errorHandler(error, request, reply);\n+        }\n+      }\n+    },\n+    async (req, reply) => {\n+      const email = Buffer.from(req.query.email, 'base64').toString();\n+\n+      const { origin } = getRedirectParams(req);\n+      if (!isEmail(email)) {\n+        return reply.redirectWithMessage(origin, redirectMessage);\n+      }\n+\n+      const authToken = await fastify.prisma.authToken.findUnique({\n+        where: { id: req.query.token }\n+      });\n+\n+      if (!authToken) {\n+        return reply.redirectWithMessage(origin, redirectMessage);\n+      }\n+\n+      // TODO(Post-MVP): clean up expired auth tokens.\n+      if (isExpired(authToken)) {\n+        return reply.redirectWithMessage(origin, expirationMessage);\n+      }\n+\n+      // TODO(Post-MVP): should this fail if it's not the currently signed in\n+      // user?\n+      const targetUser = await fastify.prisma.user.findUnique({\n+        where: { id: authToken.userId }\n+      });\n+\n+      if (targetUser?.newEmail !== email) {\n+        return reply.redirectWithMessage(origin, redirectMessage);\n+      }\n+\n+      // TODO(Post-MVP): clean up any other auth tokens for this user once\n+      // the email is confirmed.\n+      await Promise.all([\n+        updateEmail(fastify, { id: targetUser.id, email }),\n+        deleteAuthToken(fastify, { id: authToken.id })\n+      ]);\n+\n+      return reply.redirectWithMessage(origin, successMessage);\n+    }\n+  );\n+\n+  done();\n+};"
        },
        {
            "sha": "7e78a5e9e2cff8a7244adc5c1d634a71f77e89f6",
            "filename": "api/src/schemas.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fschemas.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fschemas.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -15,6 +15,7 @@ export { chargeStripeCard } from './schemas/donate/charge-stripe-card';\n export { resubscribe } from './schemas/email-subscription/resubscribe';\n export { unsubscribe } from './schemas/email-subscription/unsubscribe';\n export { updateMyAbout } from './schemas/settings/update-my-about';\n+export { confirmEmail } from './schemas/settings/confirm-email';\n export { updateMyClassroomMode } from './schemas/settings/update-my-classroom-mode';\n export { updateMyEmail } from './schemas/settings/update-my-email';\n export { updateMyHonesty } from './schemas/settings/update-my-honesty';"
        },
        {
            "sha": "a80742a5a9a8d95cc67a561270e38a46a1d0bd07",
            "filename": "api/src/schemas/settings/confirm-email.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fschemas%2Fsettings%2Fconfirm-email.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Fschemas%2Fsettings%2Fconfirm-email.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fsettings%2Fconfirm-email.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -0,0 +1,8 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+\n+export const confirmEmail = {\n+  querystring: Type.Object({\n+    email: Type.String({ maxLength: 1000 }),\n+    token: Type.String({ minLength: 64, maxLength: 64 })\n+  })\n+};"
        },
        {
            "sha": "befcd392a33a38df2147c637371a3aef3256e59d",
            "filename": "api/src/utils/tokens.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Futils%2Ftokens.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Futils%2Ftokens.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Ftokens.test.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -1,5 +1,6 @@\n+jest.useFakeTimers();\n /* eslint-disable @typescript-eslint/no-unsafe-assignment */\n-import { createAccessToken, createAuthToken } from './tokens';\n+import { createAccessToken, createAuthToken, isExpired } from './tokens';\n \n describe('createAccessToken', () => {\n   it('creates an object with id, ttl, created and userId', () => {\n@@ -52,3 +53,25 @@ describe('createAuthToken', () => {\n     expect(createAuthToken(userId).ttl).toBe(900000);\n   });\n });\n+\n+describe('isExpired', () => {\n+  it('returns true if the token expiry date is in the past', () => {\n+    const token = createAccessToken('abc', 1000);\n+    expect(isExpired(token)).toBe(false);\n+    jest.advanceTimersByTime(500);\n+    expect(isExpired(token)).toBe(false);\n+    jest.advanceTimersByTime(500);\n+    expect(isExpired(token)).toBe(false);\n+    jest.advanceTimersByTime(1);\n+    expect(isExpired(token)).toBe(true);\n+  });\n+\n+  it('handles tokens with Date values for created', () => {\n+    const token = { ...createAccessToken('abc', 2000), created: new Date() };\n+    expect(isExpired(token)).toBe(false);\n+    jest.advanceTimersByTime(2000);\n+    expect(isExpired(token)).toBe(false);\n+    jest.advanceTimersByTime(1);\n+    expect(isExpired(token)).toBe(true);\n+  });\n+});"
        },
        {
            "sha": "9cdde15b7d71e44b3db8e41e8a72a7d1830d6e6e",
            "filename": "api/src/utils/tokens.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Futils%2Ftokens.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/22e74e640670a2959887f91ef94f6b08032c46aa/api%2Fsrc%2Futils%2Ftokens.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Ftokens.ts?ref=22e74e640670a2959887f91ef94f6b08032c46aa",
            "patch": "@@ -20,6 +20,13 @@ export type Token = {\n   created: string;\n };\n \n+type DbToken = {\n+  userId: string;\n+  id: string;\n+  ttl: number;\n+  created: Date;\n+};\n+\n /**\n  * Creates an access token.\n  * @param userId The user ID as a string (yes, it's an ObjectID, but it will be serialized to a string anyway).\n@@ -49,3 +56,13 @@ export const createAuthToken = (userId: string, ttl?: number): Token => {\n     created: new Date().toISOString()\n   };\n };\n+\n+/**\n+ * Check if an access token has expired.\n+ * @param token The access token to check.\n+ * @returns True if the token has expired, false otherwise.\n+ */\n+export const isExpired = (token: Token | DbToken): boolean => {\n+  const created = new Date(token.created);\n+  return Date.now() > created.getTime() + token.ttl;\n+};"
        }
    ],
    "stats": {
        "total": 701,
        "additions": 635,
        "deletions": 66
    }
}