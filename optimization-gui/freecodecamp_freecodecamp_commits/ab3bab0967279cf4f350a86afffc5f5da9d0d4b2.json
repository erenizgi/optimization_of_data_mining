{
    "author": "raisedadead",
    "message": "fix(gha): cleaner and working matrix (#62081)",
    "sha": "ab3bab0967279cf4f350a86afffc5f5da9d0d4b2",
    "files": [
        {
            "sha": "daaf37891e85830519354aa3ee5669a57472aa43",
            "filename": ".github/workflows/deploy-client.yml",
            "status": "modified",
            "additions": 80,
            "deletions": 41,
            "changes": 121,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ab3bab0967279cf4f350a86afffc5f5da9d0d4b2/.github%2Fworkflows%2Fdeploy-client.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ab3bab0967279cf4f350a86afffc5f5da9d0d4b2/.github%2Fworkflows%2Fdeploy-client.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-client.yml?ref=ab3bab0967279cf4f350a86afffc5f5da9d0d4b2",
            "patch": "@@ -58,56 +58,95 @@ jobs:\n       matrix: ${{ steps.matrix.outputs.matrix }}\n     steps:\n       - name: Setup Matrix\n+        uses: actions/github-script@v7\n         id: matrix\n-        run: |\n-          TARGET_LANG=\"${{ inputs.target_language || 'all' }}\"\n-          echo \"Target language: $TARGET_LANG\"\n-\n-          if [[ \"$TARGET_LANG\" == \"all\" ]]; then\n-            # Build all languages\n-            MATRIX='{\n-              \"node-version\": [22],\n-              \"include\": [\n-                {\"lang-name-full\": \"english\", \"lang-name-short\": \"eng\"},\n-                {\"lang-name-full\": \"chinese\", \"lang-name-short\": \"chn\"},\n-                {\"lang-name-full\": \"espanol\", \"lang-name-short\": \"esp\"},\n-                {\"lang-name-full\": \"chinese-traditional\", \"lang-name-short\": \"cnt\"},\n-                {\"lang-name-full\": \"italian\", \"lang-name-short\": \"ita\"},\n-                {\"lang-name-full\": \"portuguese\", \"lang-name-short\": \"por\"},\n-                {\"lang-name-full\": \"ukrainian\", \"lang-name-short\": \"ukr\"},\n-                {\"lang-name-full\": \"japanese\", \"lang-name-short\": \"jpn\"},\n-                {\"lang-name-full\": \"german\", \"lang-name-short\": \"ger\"},\n-                {\"lang-name-full\": \"swahili\", \"lang-name-short\": \"swa\"}\n-              ]\n-            }'\n-          else\n-            # Build single language\n-            case \"$TARGET_LANG\" in\n-              \"english\") SHORT=\"eng\" ;;\n-              \"chinese\") SHORT=\"chn\" ;;\n-              \"espanol\") SHORT=\"esp\" ;;\n-              \"chinese-traditional\") SHORT=\"cnt\" ;;\n-              \"italian\") SHORT=\"ita\" ;;\n-              \"portuguese\") SHORT=\"por\" ;;\n-              \"ukrainian\") SHORT=\"ukr\" ;;\n-              \"japanese\") SHORT=\"jpn\" ;;\n-              \"german\") SHORT=\"ger\" ;;\n-              \"swahili\") SHORT=\"swa\" ;;\n-              *) echo \"Error: Unknown language $TARGET_LANG\"; exit 1 ;;\n-            esac\n-            \n-            MATRIX=\"{\\\"node-version\\\": [22], \\\"include\\\": [{\\\"lang-name-full\\\": \\\"$TARGET_LANG\\\", \\\"lang-name-short\\\": \\\"$SHORT\\\"}]}\"\n-          fi\n+        env:\n+          TARGET_LANG: ${{ inputs.target_language }}\n+        with:\n+          script: |\n+            // Constants\n+            const NODE_VERSION = 22;\n+\n+            // Input sanitization and validation\n+            const rawTargetLang = process.env.TARGET_LANG || 'all';\n+            const targetLang = rawTargetLang.trim().toLowerCase();\n+            console.log(`Target language: ${targetLang}`);\n+\n+            // Language mappings (single source of truth)\n+            const languageMap = {\n+              'english': 'eng',\n+              'chinese': 'chn',\n+              'espanol': 'esp',\n+              'chinese-traditional': 'cnt',\n+              'italian': 'ita',\n+              'portuguese': 'por',\n+              'ukrainian': 'ukr',\n+              'japanese': 'jpn',\n+              'german': 'ger',\n+              'swahili': 'swa'\n+            };\n+\n+            const allLanguages = Object.keys(languageMap);\n+            let matrix;\n+\n+            if (targetLang === 'all') {\n+              console.log('Building matrix for all languages');\n+              console.log(`Available languages: ${allLanguages.join(', ')}`);\n+\n+              // Build include array for all languages\n+              const include = allLanguages.map(lang => ({\n+                'node-version': NODE_VERSION,\n+                'lang-name-full': lang,\n+                'lang-name-short': languageMap[lang]\n+              }));\n+\n+              matrix = {\n+                include: include\n+              };\n+\n+            } else {\n+              console.log(`Building matrix for single language: ${targetLang}`);\n+\n+              // Validate language selection\n+              if (!languageMap[targetLang]) {\n+                const errorMsg = `Unknown language '${targetLang}'. Available: ${allLanguages.join(', ')}`;\n+                console.error(errorMsg);\n+                core.setFailed(errorMsg);\n+                return;\n+              }\n+\n+              console.log(`Processing: ${targetLang} -> ${languageMap[targetLang]}`);\n+\n+              // Create single language matrix\n+              matrix = {\n+                include: [{\n+                  'node-version': NODE_VERSION,\n+                  'lang-name-full': targetLang,\n+                  'lang-name-short': languageMap[targetLang]\n+                }]\n+              };\n+            }\n+\n+            // Final validation\n+            if (!matrix || !matrix.include || matrix.include.length === 0) {\n+              core.setFailed('Generated matrix is empty or invalid');\n+              return;\n+            }\n+\n+            console.log('Generated matrix:');\n+            console.log(JSON.stringify(matrix, null, 2));\n+            console.log(`Matrix will create ${matrix.include.length} job(s)`);\n \n-          echo \"matrix=$MATRIX\" >> $GITHUB_OUTPUT\n+            // Set output for GitHub Actions\n+            core.setOutput('matrix', JSON.stringify(matrix));\n \n   client:\n     name: Clients - [${{ needs.setup-jobs.outputs.tgt_env_short }}] [${{ matrix.lang-name-short }}]\n     needs: [setup-jobs, setup-matrix]\n     runs-on: ubuntu-22.04\n     strategy:\n       fail-fast: false\n-      matrix: ${{ fromJSON(needs.setup-matrix.outputs.matrix) }}\n+      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}\n     permissions:\n       deployments: write\n       contents: read"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 80,
        "deletions": 41
    }
}