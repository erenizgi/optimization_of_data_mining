{
    "author": "ojeytonwilliams",
    "message": "refactor(client): fixed/hid type errors + extended isPoly (#58527)",
    "sha": "d2effdaa413c51feb9634241cd11eb5da4be6472",
    "files": [
        {
            "sha": "d480832e223dd5743b6b10b6adaa2c3dd6ca1a0a",
            "filename": "client/src/templates/Challenges/classic/saved-challenges.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d2effdaa413c51feb9634241cd11eb5da4be6472/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Fsaved-challenges.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d2effdaa413c51feb9634241cd11eb5da4be6472/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Fsaved-challenges.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Fsaved-challenges.test.ts?ref=d2effdaa413c51feb9634241cd11eb5da4be6472",
            "patch": "@@ -5,39 +5,39 @@ import type {\n import { mergeChallengeFiles } from './saved-challenges';\n \n const jsChallenge = {\n-  id: '1',\n   contents: 'js contents',\n   fileKey: 'jsFileKey',\n   name: 'name',\n   ext: 'js' as const,\n   head: 'head',\n   tail: 'tail',\n   history: [],\n-  seed: 'original js contents'\n+  seed: 'original js contents',\n+  path: 'index.js'\n };\n \n const cssChallenge = {\n-  id: '2',\n   contents: 'css contents',\n   fileKey: 'cssFileKey',\n   name: 'name',\n   ext: 'css' as const,\n   head: 'head',\n   tail: 'tail',\n   history: [],\n-  seed: 'original css contents'\n+  seed: 'original css contents',\n+  path: 'styles.css'\n };\n \n const htmlChallenge = {\n-  id: '3',\n   contents: 'html contents',\n   fileKey: 'htmlFileKey',\n   name: 'name',\n   ext: 'html' as const,\n   head: 'head',\n   tail: 'tail',\n   history: [],\n-  seed: 'original html contents'\n+  seed: 'original html contents',\n+  path: 'index.html'\n };\n \n const savedJsChallenge: SavedChallengeFile = {"
        },
        {
            "sha": "de8007549d144677b1655138075c2b60d1bdbaaf",
            "filename": "client/src/templates/Challenges/utils/build.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d2effdaa413c51feb9634241cd11eb5da4be6472/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d2effdaa413c51feb9634241cd11eb5da4be6472/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts?ref=d2effdaa413c51feb9634241cd11eb5da4be6472",
            "patch": "@@ -51,7 +51,9 @@ const jsWorkerExecutor = new WorkerExecutor(jsTestEvaluator, {\n   terminateWorker: true\n });\n \n-type ApplyFunctionProps = (file: ChallengeFile) => Promise<ChallengeFile>;\n+type ApplyFunctionProps = (\n+  file: ChallengeFile\n+) => Promise<ChallengeFile> | ChallengeFile;\n \n const applyFunction =\n   (fn: ApplyFunctionProps) => async (file: ChallengeFile) => {\n@@ -80,7 +82,7 @@ function buildSourceMap(challengeFiles: ChallengeFile[]): Source | undefined {\n     (sources, challengeFile) => {\n       sources.index += challengeFile.source || '';\n       sources.contents = sources.index;\n-      sources.original[challengeFile.history[0]] = challengeFile.source;\n+      sources.original[challengeFile.history[0]] = challengeFile.source ?? null;\n       sources.editableContents += challengeFile.editableContents || '';\n       return sources;\n     },\n@@ -235,11 +237,11 @@ export async function buildDOMChallenge(\n   );\n   const isMultifile = challengeFiles.length > 1;\n \n-  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-  const transformers =\n-    isMultifile && hasJsx\n-      ? getMultifileJSXTransformers(options)\n-      : getTransformers(options);\n+  // I'm reasonably sure this is fine, but we need to migrate transformers to\n+  // TypeScript to be sure.\n+  const transformers: ApplyFunctionProps[] = (isMultifile && hasJsx\n+    ? getMultifileJSXTransformers(options)\n+    : getTransformers(options)) as unknown as ApplyFunctionProps[];\n \n   const pipeLine = composeFunctions(...transformers);\n   const usesTestRunner = options?.usesTestRunner ?? false;\n@@ -274,7 +276,9 @@ export async function buildJSChallenge(\n   options: BuildOptions\n ): Promise<BuildResult> {\n   if (!challengeFiles) throw Error('No challenge files provided');\n-  const pipeLine = composeFunctions(...getTransformers(options));\n+  const pipeLine = composeFunctions(\n+    ...(getTransformers(options) as unknown as ApplyFunctionProps[])\n+  );\n \n   const finalFiles = await Promise.all(challengeFiles?.map(pipeLine));\n   const error = finalFiles.find(({ error }) => error)?.error;\n@@ -311,7 +315,9 @@ export async function buildPythonChallenge({\n   challengeFiles\n }: BuildChallengeData): Promise<BuildResult> {\n   if (!challengeFiles) throw new Error('No challenge files provided');\n-  const pipeLine = composeFunctions(...getPythonTransformers());\n+  const pipeLine = composeFunctions(\n+    ...(getPythonTransformers() as unknown as ApplyFunctionProps[])\n+  );\n   const finalFiles = await Promise.all(challengeFiles.map(pipeLine));\n   const error = finalFiles.find(({ error }) => error)?.error;\n "
        },
        {
            "sha": "de4cb6ec8289337981d19e9e5f3bb8f2a9ecfd7d",
            "filename": "client/utils/__fixtures__/challenges.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d2effdaa413c51feb9634241cd11eb5da4be6472/client%2Futils%2F__fixtures__%2Fchallenges.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d2effdaa413c51feb9634241cd11eb5da4be6472/client%2Futils%2F__fixtures__%2Fchallenges.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Futils%2F__fixtures__%2Fchallenges.ts?ref=d2effdaa413c51feb9634241cd11eb5da4be6472",
            "patch": "@@ -2,7 +2,6 @@ import { ChallengeFile } from \"../../src/redux/prop-types\";\n \n export const challengeFiles: ChallengeFile[] = [\n   {\n-    id: '0',\n     contents: 'some ts',\n     error: null,\n     ext: 'ts',\n@@ -14,9 +13,9 @@ export const challengeFiles: ChallengeFile[] = [\n     tail: '',\n     editableRegionBoundaries: [],\n     usesMultifileEditor: true,\n+    path: 'index.ts',\n   },\n   {\n-    id: '1',\n     contents: 'some css',\n     error: null,\n     ext: 'css',\n@@ -28,9 +27,9 @@ export const challengeFiles: ChallengeFile[] = [\n     tail: '',\n     editableRegionBoundaries: [],\n     usesMultifileEditor: true,\n+    path: 'styles.css',\n   },\n   {\n-    id: '2',\n     contents: 'some html',\n     error: null,\n     ext: 'html',\n@@ -42,9 +41,9 @@ export const challengeFiles: ChallengeFile[] = [\n     tail: '',\n     editableRegionBoundaries: [],\n     usesMultifileEditor: true,\n+    path: 'index.html',\n   },\n   {\n-    id: '3',\n     contents: 'some js',\n     error: null,\n     ext: 'js',\n@@ -56,9 +55,9 @@ export const challengeFiles: ChallengeFile[] = [\n     tail: '',\n     editableRegionBoundaries: [],\n     usesMultifileEditor: true,\n+    path: 'script.js',\n   },\n   {\n-    id: '4',\n     contents: 'some jsx',\n     error: null,\n     ext: 'jsx',\n@@ -70,5 +69,6 @@ export const challengeFiles: ChallengeFile[] = [\n     tail: '',\n     editableRegionBoundaries: [],\n     usesMultifileEditor: true,\n+    path: 'index.jsx',\n   }\n ]"
        },
        {
            "sha": "6a81a573dc82f8a9845cfd70a5419f313c17190d",
            "filename": "shared/utils/polyvinyl.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 21,
            "changes": 59,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d2effdaa413c51feb9634241cd11eb5da4be6472/shared%2Futils%2Fpolyvinyl.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d2effdaa413c51feb9634241cd11eb5da4be6472/shared%2Futils%2Fpolyvinyl.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/shared%2Futils%2Fpolyvinyl.ts?ref=d2effdaa413c51feb9634241cd11eb5da4be6472",
            "patch": "@@ -1,22 +1,26 @@\n // originally based off of https://github.com/gulpjs/vinyl\n import invariant from 'invariant';\n \n-export type Ext = 'js' | 'html' | 'css' | 'jsx' | 'ts';\n+const exts = ['js', 'html', 'css', 'jsx', 'ts'] as const;\n+export type Ext = (typeof exts)[number];\n \n-export type ChallengeFile = {\n+export type IncompleteChallengeFile = {\n   fileKey: string;\n   ext: Ext;\n   name: string;\n+  contents: string;\n+};\n+\n+export type ChallengeFile = IncompleteChallengeFile & {\n   editableRegionBoundaries?: number[];\n   editableContents?: string;\n   usesMultifileEditor?: boolean;\n   error?: unknown;\n   head: string;\n   tail: string;\n   seed: string;\n-  contents: string;\n   source?: string | null;\n-  id: string;\n+  path: string;\n   history: string[];\n };\n \n@@ -65,25 +69,39 @@ export function createPoly<Rest>({\n }\n \n export function isPoly(poly: unknown): poly is ChallengeFile {\n-  return (\n-    !!poly &&\n-    typeof poly === 'object' &&\n-    'contents' in poly &&\n+  function hasProperties(poly: unknown): poly is Record<string, unknown> {\n+    return (\n+      !!poly &&\n+      typeof poly === 'object' &&\n+      'contents' in poly &&\n+      'name' in poly &&\n+      'ext' in poly &&\n+      'fileKey' in poly &&\n+      'head' in poly &&\n+      'tail' in poly &&\n+      'seed' in poly &&\n+      'history' in poly\n+    );\n+  }\n+\n+  const hasCorrectTypes = (poly: Record<string, unknown>): boolean =>\n     typeof poly.contents === 'string' &&\n-    'name' in poly &&\n     typeof poly.name === 'string' &&\n-    'ext' in poly &&\n-    typeof poly.ext === 'string' &&\n-    'history' in poly &&\n-    Array.isArray(poly.history)\n-  );\n+    exts.includes(poly.ext as Ext) &&\n+    typeof poly.fileKey === 'string' &&\n+    typeof poly.head === 'string' &&\n+    typeof poly.tail === 'string' &&\n+    typeof poly.seed === 'string' &&\n+    Array.isArray(poly.history);\n+\n+  return hasProperties(poly) && hasCorrectTypes(poly);\n }\n \n function checkPoly(poly: ChallengeFile) {\n   invariant(\n     isPoly(poly),\n     'function should receive a PolyVinyl, but got %s',\n-    poly\n+    JSON.stringify(poly)\n   );\n }\n \n@@ -102,15 +120,14 @@ export function setContent(\n \n // This is currently only used to add back properties that are not stored in the\n // database.\n-export function regeneratePathAndHistory(poly: ChallengeFile) {\n-  const newPath = poly.name + '.' + poly.ext;\n-  const newPoly = {\n-    ...poly,\n+export function regeneratePathAndHistory(file: IncompleteChallengeFile) {\n+  const newPath = file.name + '.' + file.ext;\n+  const newFile = {\n+    ...file,\n     path: newPath,\n     history: [newPath]\n   };\n-  checkPoly(newPoly);\n-  return newPoly;\n+  return newFile;\n }\n \n async function clearHeadTail(polyP: Promise<ChallengeFile>) {"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 64,
        "deletions": 41
    }
}