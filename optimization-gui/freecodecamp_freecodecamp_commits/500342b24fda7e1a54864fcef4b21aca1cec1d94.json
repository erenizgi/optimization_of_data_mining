{
    "author": "ShaunSHamilton",
    "message": "fix(api): shuffle generated exam answers each time (#61352)\n\nCo-authored-by: Tom <20648924+moT01@users.noreply.github.com>\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "500342b24fda7e1a54864fcef4b21aca1cec1d94",
    "files": [
        {
            "sha": "823f31abb6bb5f16ca4e8c67e803987762348868",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=500342b24fda7e1a54864fcef4b21aca1cec1d94",
            "patch": "@@ -492,28 +492,28 @@ type SurveyResponse {\n // ----------------------\n \n model DailyCodingChallenges {\n-  id                String @id @default(auto()) @map(\"_id\") @db.ObjectId\n-  challengeNumber   Int\n-  date              DateTime\n-  title             String\n-  description       String\n-  javascript        DailyCodingChallengeApiLanguage\n-  python            DailyCodingChallengeApiLanguage\n+  id              String                          @id @default(auto()) @map(\"_id\") @db.ObjectId\n+  challengeNumber Int\n+  date            DateTime\n+  title           String\n+  description     String\n+  javascript      DailyCodingChallengeApiLanguage\n+  python          DailyCodingChallengeApiLanguage\n }\n \n type DailyCodingChallengeApiLanguage {\n-  tests           DailyCodingChallengeApiLanguageTests[]\n-  challengeFiles  DailyCodingChallengeApiLanguageChallengeFiles[]\n+  tests          DailyCodingChallengeApiLanguageTests[]\n+  challengeFiles DailyCodingChallengeApiLanguageChallengeFiles[]\n }\n \n type DailyCodingChallengeApiLanguageTests {\n-  text        String\n-  testString  String\n+  text       String\n+  testString String\n }\n \n type DailyCodingChallengeApiLanguageChallengeFiles {\n-  contents  String\n-  fileKey   String\n+  contents String\n+  fileKey  String\n }\n \n // ----------------------"
        },
        {
            "sha": "3ecdf606a294fc9751d597e477272b9301b2f4e4",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=500342b24fda7e1a54864fcef4b21aca1cec1d94",
            "patch": "@@ -546,6 +546,8 @@ describe('/exam-environment/', () => {\n       });\n \n       it('should return the user exam with the exam attempt', async () => {\n+        // Mock Math.random for `shuffleArray` to be equivalent between `/generated-exam` and `constructUserExam`\n+        jest.spyOn(Math, 'random').mockReturnValue(0.123456789);\n         const body: Static<typeof examEnvironmentPostExamGeneratedExam.body> = {\n           examId: mock.examId\n         };\n@@ -576,12 +578,9 @@ describe('/exam-environment/', () => {\n \n         const userExam = constructUserExam(generatedExam!, mock.exam);\n \n-        expect(res).toMatchObject({\n-          status: 200,\n-          body: {\n-            examAttempt,\n-            exam: userExam\n-          }\n+        expect(res.body).toMatchObject({\n+          examAttempt,\n+          exam: userExam\n         });\n       });\n     });"
        },
        {
            "sha": "c86793735b722dd3a58cf7764852f94d9e1dc0f1",
            "filename": "api/src/exam-environment/utils/exam-environment.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 10,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts?ref=500342b24fda7e1a54864fcef4b21aca1cec1d94",
            "patch": "@@ -13,17 +13,22 @@ import {\n   generateExam,\n   userAttemptToDatabaseAttemptQuestionSets,\n   validateAttempt,\n-  compareAnswers\n+  compareAnswers,\n+  shuffleArray\n } from './exam-environment';\n \n // NOTE: Whilst the tests could be run against a single generation of exam,\n //       it is more useful to run the tests against a new generation each time.\n //       This helps ensure the config/logic is _reasonably_ likely to be able to\n //       generate a valid exam.\n //       Another option is to call `generateExam` hundreds of times in a loop test :shrug:\n-describe('Exam Environment', () => {\n+describe('Exam Environment mocked Math.random', () => {\n+  let spy: jest.SpyInstance;\n   beforeAll(() => {\n-    jest.spyOn(Math, 'random').mockReturnValue(0.123456789);\n+    spy = jest.spyOn(Math, 'random').mockReturnValue(0.123456789);\n+  });\n+  afterAll(() => {\n+    spy.mockRestore();\n   });\n   describe('checkAttemptAgainstGeneratedExam()', () => {\n     it('should return true if all questions are answered', () => {\n@@ -84,13 +89,6 @@ describe('Exam Environment', () => {\n     });\n   });\n \n-  describe('constructUserExam()', () => {\n-    it('should not provide the answers', () => {\n-      const userExam = constructUserExam(generatedExam, exam);\n-      expect(userExam).not.toHaveProperty('answers.isCorrect');\n-    });\n-  });\n-\n   describe('generateExam()', () => {\n     it('should generate a randomized exam without throwing', () => {\n       const _randomizedExam = generateExam(exam);\n@@ -385,3 +383,28 @@ describe('Exam Environment', () => {\n     });\n   });\n });\n+\n+describe('Exam Environment', () => {\n+  describe('constructUserExam()', () => {\n+    it('should not provide the answers', () => {\n+      const userExam = constructUserExam(generatedExam, exam);\n+      expect(userExam).not.toHaveProperty('answers.isCorrect');\n+    });\n+  });\n+\n+  describe('shuffleArray()', () => {\n+    it('reasonably shuffles an array', () => {\n+      const unshuff = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];\n+      const shuff = shuffleArray(unshuff);\n+\n+      expect(shuff).not.toEqual(unshuff);\n+    });\n+\n+    it('does not mutate the input', () => {\n+      const unshuff = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];\n+      shuffleArray(unshuff);\n+\n+      expect(unshuff).toEqual(unshuff);\n+    });\n+  });\n+});"
        },
        {
            "sha": "b2907b74a6548e9b6ae295b9312d57cff4bdf228",
            "filename": "api/src/exam-environment/utils/exam-environment.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/500342b24fda7e1a54864fcef4b21aca1cec1d94/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts?ref=500342b24fda7e1a54864fcef4b21aca1cec1d94",
            "patch": "@@ -82,11 +82,14 @@ export function constructUserExam(\n         return answer;\n       });\n \n+      // NOTE: Shuffling here means when saved attempt is re-fetched, answers will be in different order.\n+      const shuffledAnswers = shuffleArray(answers);\n+\n       return {\n         id: examQuestion.id,\n         audio: examQuestion.audio,\n         text: examQuestion.text,\n-        answers\n+        answers: shuffledAnswers\n       };\n     });\n \n@@ -731,8 +734,9 @@ function getRandomAnswers(\n  *\n  * https://bost.ocks.org/mike/shuffle/\n  */\n-function shuffleArray<T>(array: Array<T>) {\n-  let m = array.length;\n+export function shuffleArray<T>(array: Array<T>) {\n+  const arr = structuredClone(array);\n+  let m = arr.length;\n   let t;\n   let i;\n \n@@ -742,12 +746,12 @@ function shuffleArray<T>(array: Array<T>) {\n     i = Math.floor(Math.random() * m--);\n \n     // And swap it with the current element.\n-    t = array[m]!;\n-    array[m] = array[i]!;\n-    array[i] = t;\n+    t = arr[m]!;\n+    arr[m] = arr[i]!;\n+    arr[i] = t;\n   }\n \n-  return array;\n+  return arr;\n }\n /* eslint-enable jsdoc/require-description-complete-sentence */\n "
        }
    ],
    "stats": {
        "total": 98,
        "additions": 62,
        "deletions": 36
    }
}