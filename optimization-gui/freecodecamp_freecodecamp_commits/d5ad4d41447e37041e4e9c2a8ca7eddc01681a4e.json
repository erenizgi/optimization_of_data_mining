{
    "author": "raisedadead",
    "message": "revert: add 100% branch coverage for env.ts (#63492)",
    "sha": "d5ad4d41447e37041e4e9c2a8ca7eddc01681a4e",
    "files": [
        {
            "sha": "0ffc7b950794860d23e52701b693346236d16294",
            "filename": "api/src/utils/env.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 232,
            "changes": 232,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b33a01963f6f8857d60faed2874343d8fc90d6b4/api%2Fsrc%2Futils%2Fenv.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b33a01963f6f8857d60faed2874343d8fc90d6b4/api%2Fsrc%2Futils%2Fenv.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fenv.test.ts?ref=b33a01963f6f8857d60faed2874343d8fc90d6b4",
            "patch": "@@ -1,232 +0,0 @@\n-import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';\n-\n-vi.mock('dotenv', () => ({\n-  config: vi.fn(() => ({ error: null, parsed: {} }))\n-}));\n-\n-const setupMinimalProdEnv = () => {\n-  vi.stubEnv('FREECODECAMP_NODE_ENV', 'production');\n-  vi.stubEnv('EMAIL_PROVIDER', 'ses');\n-  vi.stubEnv('SES_ID', 'my-ses-id');\n-  vi.stubEnv('SES_SECRET', 'my-ses-secret');\n-  vi.stubEnv('COOKIE_DOMAIN', 'freecodecamp.org');\n-  vi.stubEnv('COOKIE_SECRET', 'my-real-cookie-secret');\n-  vi.stubEnv('SENTRY_DSN', 'my-real-sentry-dsn');\n-  vi.stubEnv('SENTRY_ENVIRONMENT', 'production');\n-  vi.stubEnv('DEPLOYMENT_VERSION', '1.2.3');\n-  vi.stubEnv('JWT_SECRET', 'my-real-jwt-secret');\n-  vi.stubEnv('FCC_ENABLE_DEV_LOGIN_MODE', 'false');\n-  vi.stubEnv('STRIPE_SECRET_KEY', 'sk_live_my-real-key');\n-  vi.stubEnv('NODE_ENV', 'production');\n-  vi.stubEnv('AUTH0_CLIENT_SECRET', 'my-real-auth0-secret');\n-  vi.stubEnv('GROWTHBOOK_FASTIFY_API_HOST', 'my-real-growthbook-host');\n-  vi.stubEnv('GROWTHBOOK_FASTIFY_CLIENT_KEY', 'my-real-growthbook-key');\n-};\n-\n-describe.sequential('Environment Variable Validation (env.ts)', () => {\n-  beforeEach(() => {\n-    vi.resetModules();\n-    vi.unstubAllEnvs();\n-\n-    vi.stubEnv('HOME_LOCATION', 'http://localhost:8000');\n-    vi.stubEnv('FREECODECAMP_NODE_ENV', 'development');\n-    vi.stubEnv('DEPLOYMENT_ENV', 'staging');\n-    vi.stubEnv('EMAIL_PROVIDER', 'nodemailer');\n-    vi.stubEnv('AUTH0_CLIENT_ID', 'test_client_id');\n-    vi.stubEnv('AUTH0_CLIENT_SECRET', 'test_client_secret');\n-    vi.stubEnv('AUTH0_DOMAIN', 'test.auth0.com');\n-    vi.stubEnv('API_LOCATION', 'http://localhost:3000');\n-    vi.stubEnv('JWT_SECRET', 'a_jwt_secret');\n-    vi.stubEnv('STRIPE_SECRET_KEY', 'sk_test_key');\n-    vi.stubEnv(\n-      'MONGOHQ_URL',\n-      'mongodb://127.0.0.1:27017/freecodecamp?directConnection=true'\n-    );\n-    vi.stubEnv('COOKIE_SECRET', 'a_cookie_secret');\n-    vi.stubEnv('FCC_API_LOG_LEVEL', 'info');\n-    vi.stubEnv('VITEST_WORKER_ID', '1');\n-  });\n-\n-  afterEach(() => {\n-    vi.unstubAllEnvs();\n-  });\n-\n-  describe('dotenv Warning Logic', () => {\n-    it('should warn if .env is missing in development', async () => {\n-      const consoleWarnSpy = vi\n-        .spyOn(console, 'warn')\n-        .mockImplementation(() => {});\n-\n-      vi.doMock('dotenv', () => ({\n-        config: vi.fn(() => ({ error: new Error('.env not found') }))\n-      }));\n-\n-      await import('./env.js');\n-      expect(consoleWarnSpy).toHaveBeenCalledWith(\n-        expect.stringContaining('Warning: .env file not found')\n-      );\n-      consoleWarnSpy.mockRestore();\n-    });\n-\n-    it('should NOT warn if .env is missing in production', async () => {\n-      const consoleWarnSpy = vi\n-        .spyOn(console, 'warn')\n-        .mockImplementation(() => {});\n-\n-      vi.doMock('dotenv', () => ({\n-        config: vi.fn(() => ({ error: new Error('.env not found') }))\n-      }));\n-\n-      setupMinimalProdEnv();\n-\n-      await import('./env.js');\n-      expect(consoleWarnSpy).not.toHaveBeenCalled();\n-      consoleWarnSpy.mockRestore();\n-    });\n-  });\n-\n-  describe('FCC_API_LOG_TRANSPORT Logic (MC/DC)', () => {\n-    it('should not throw error when FCC_API_LOG_TRANSPORT is \"pretty\"', async () => {\n-      vi.stubEnv('FCC_API_LOG_TRANSPORT', 'pretty');\n-      await expect(import('./env.js')).resolves.toBeDefined();\n-    });\n-\n-    it('should not throw error when FCC_API_LOG_TRANSPORT is \"default\"', async () => {\n-      vi.stubEnv('FCC_API_LOG_TRANSPORT', 'default');\n-      await expect(import('./env.js')).resolves.toBeDefined();\n-    });\n-\n-    it('should throw error when FCC_API_LOG_TRANSPORT is invalid', async () => {\n-      vi.stubEnv('FCC_API_LOG_TRANSPORT', 'invalid-value');\n-      await expect(import('./env.js')).rejects.toThrow(\n-        \"FCC_API_LOG_TRANSPORT must be one of 'pretty' or 'default'. Found invalid-value\"\n-      );\n-    });\n-\n-    it('should assign \"default\" and pass validation when FCC_API_LOG_TRANSPORT is undefined', async () => {\n-      const envModule = await import('./env.js');\n-      expect(envModule.FCC_API_LOG_TRANSPORT).toBe('default');\n-    });\n-  });\n-\n-  describe('Default Value Assignments', () => {\n-    it('should use the provided values from stubs', async () => {\n-      const envModule = await import('./env.js');\n-      expect(envModule.EMAIL_PROVIDER).toBe('nodemailer');\n-      expect(envModule.FREECODECAMP_NODE_ENV).toBe('development');\n-      expect(envModule.FCC_API_LOG_LEVEL).toBe('info');\n-      expect(envModule.DEPLOYMENT_VERSION).toBe('unknown');\n-    });\n-\n-    it('should use default values for EMAIL_PROVIDER and LOG_LEVEL in development', async () => {\n-      vi.stubEnv('EMAIL_PROVIDER', undefined);\n-      vi.stubEnv('FCC_API_LOG_LEVEL', undefined);\n-\n-      const envModule = await import('./env.js');\n-\n-      expect(envModule.EMAIL_PROVIDER).toBe('ses');\n-      expect(envModule.FCC_API_LOG_LEVEL).toBe('info');\n-    });\n-\n-    it('should use default value for FREECODECAMP_NODE_ENV (production)', async () => {\n-      setupMinimalProdEnv();\n-      vi.stubEnv('FREECODECAMP_NODE_ENV', undefined);\n-\n-      const envModule = await import('./env.js');\n-      expect(envModule.FREECODECAMP_NODE_ENV).toBe('production');\n-    });\n-  });\n-\n-  describe('Boolean Flag (undefinedOrBool) Logic', () => {\n-    it('should correctly parse \"true\" string to boolean true', async () => {\n-      vi.stubEnv('FCC_ENABLE_DEV_LOGIN_MODE', 'true');\n-      vi.stubEnv('SHOW_UPCOMING_CHANGES', 'true');\n-      const envModule = await import('./env.js');\n-      expect(envModule.FCC_ENABLE_DEV_LOGIN_MODE).toBe(true);\n-      expect(envModule.SHOW_UPCOMING_CHANGES).toBe(true);\n-    });\n-\n-    it('should correctly parse \"false\" (or any) string to boolean false', async () => {\n-      vi.stubEnv('FCC_ENABLE_DEV_LOGIN_MODE', 'false');\n-      vi.stubEnv('SHOW_UPCOMING_CHANGES', 'false');\n-      const envModule = await import('./env.js');\n-      expect(envModule.FCC_ENABLE_DEV_LOGIN_MODE).toBe(false);\n-      expect(envModule.SHOW_UPCOMING_CHANGES).toBe(false);\n-    });\n-\n-    it('should correctly parse undefined variable to undefined', async () => {\n-      const envModule = await import('./env.js');\n-      expect(envModule.FCC_ENABLE_SWAGGER_UI).toBe(undefined);\n-    });\n-  });\n-\n-  describe('Sentry Default Value Logic', () => {\n-    it('should return empty strings for default Sentry values', async () => {\n-      vi.stubEnv('SENTRY_DSN', 'dsn_from_sentry_dashboard');\n-      vi.stubEnv('SENTRY_ENVIRONMENT', 'development');\n-      const envModule = await import('./env.js');\n-      expect(envModule.SENTRY_DSN).toBe('');\n-      expect(envModule.SENTRY_ENVIRONMENT).toBe('');\n-    });\n-\n-    it('should return real values for Sentry', async () => {\n-      vi.stubEnv('SENTRY_DSN', 'my-real-sentry-dsn');\n-      vi.stubEnv('SENTRY_ENVIRONMENT', 'my-production-env');\n-      const envModule = await import('./env.js');\n-      expect(envModule.SENTRY_DSN).toBe('my-real-sentry-dsn');\n-      expect(envModule.SENTRY_ENVIRONMENT).toBe('my-production-env');\n-    });\n-  });\n-\n-  describe('Database URL (MONGOHQ_URL) Logic', () => {\n-    it('should use the plain MONGOHQ_URL in development', async () => {\n-      vi.stubEnv('NODE_ENV', 'development');\n-      const envModule = await import('./env.js');\n-      expect(envModule.MONGOHQ_URL).toBe(\n-        'mongodb://127.0.0.1:27017/freecodecamp?directConnection=true'\n-      );\n-    });\n-\n-    it('should call createTestConnectionURL in a test environment', async () => {\n-      vi.stubEnv('NODE_ENV', 'test');\n-      vi.stubEnv('VITEST_WORKER_ID', '5');\n-      const envModule = await import('./env.js');\n-      expect(envModule.MONGOHQ_URL).toContain(\n-        'mongodb://127.0.0.1:27017/freecodecamp5?directConnection=true'\n-      );\n-    });\n-\n-    it('should throw if createTestConnectionURL is called in production', async () => {\n-      setupMinimalProdEnv();\n-      vi.stubEnv('FREECODECAMP_NODE_ENV', 'production');\n-      vi.stubEnv('NODE_ENV', 'test');\n-\n-      await expect(import('./env.js')).rejects.toThrow(\"'test' != 'test'\");\n-    });\n-\n-    it('should throw if createTestConnectionURL is called without a dbId', async () => {\n-      vi.stubEnv('NODE_ENV', 'test');\n-      vi.stubEnv('VITEST_WORKER_ID', undefined);\n-\n-      await expect(import('./env.js')).rejects.toThrow(\n-        'dbId is required for test connection URL'\n-      );\n-    });\n-  });\n-\n-  describe('Production Environment (Strict Assertions)', () => {\n-    it('should NOT throw errors in production if all secrets are valid', async () => {\n-      setupMinimalProdEnv();\n-      await expect(import('./env.js')).resolves.toBeDefined();\n-    });\n-\n-    it('should throw errors if production env uses default secrets', async () => {\n-      setupMinimalProdEnv();\n-      vi.stubEnv('JWT_SECRET', 'a_jwt_secret');\n-\n-      await expect(import('./env.js')).rejects.toThrow(\n-        'The JWT secret should be changed from the default value.'\n-      );\n-    });\n-  });\n-});"
        }
    ],
    "stats": {
        "total": 232,
        "additions": 0,
        "deletions": 232
    }
}