{
    "author": "ShaunSHamilton",
    "message": "fix(api): unsubscribe all subscribed emails (#54953)",
    "sha": "63a3b8ac05e509260f096f6c26a12b971ef7d627",
    "files": [
        {
            "sha": "dce1ddd1b334b6e08477f23603baa07000025073",
            "filename": "api/src/routes/email-subscription.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 12,
            "changes": 40,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63a3b8ac05e509260f096f6c26a12b971ef7d627/api%2Fsrc%2Froutes%2Femail-subscription.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63a3b8ac05e509260f096f6c26a12b971ef7d627/api%2Fsrc%2Froutes%2Femail-subscription.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Femail-subscription.test.ts?ref=63a3b8ac05e509260f096f6c26a12b971ef7d627",
            "patch": "@@ -17,21 +17,27 @@ const urlEncodedSuccessMessage2 =\n \n const unsubscribeId1 = 'abcde';\n const unsubscribeId2 = 'abcdef';\n+const unsubscribeId3 = 'abcdefg';\n \n const testUserData1: Prisma.userCreateInput[] = [\n   {\n     ...createUserInput('user1@freecodecamp.org'),\n     unsubscribeId: unsubscribeId1,\n     sendQuincyEmail: true\n   },\n+  {\n+    ...createUserInput('user1@freecodecamp.org'),\n+    unsubscribeId: unsubscribeId2,\n+    sendQuincyEmail: true\n+  },\n   {\n     ...createUserInput('user2@freecodecamp.org'),\n     unsubscribeId: unsubscribeId2,\n     sendQuincyEmail: true\n   },\n   {\n     ...createUserInput('user3@freecodecamp.org'),\n-    unsubscribeId: unsubscribeId2,\n+    unsubscribeId: unsubscribeId3,\n     sendQuincyEmail: true\n   }\n ];\n@@ -57,7 +63,7 @@ const testUserData2: Prisma.userCreateInput[] = [\n describe('Email Subscription endpoints', () => {\n   setupServer();\n \n-  describe('GET /ue/unsubscribe/:unsubscribeId', () => {\n+  describe('GET /ue/:unsubscribeId', () => {\n     test('should 302 redirect with info message if no ID', async () => {\n       const response = await superRequest('/ue/', { method: 'GET' });\n       expect(response.headers.location).toStrictEqual(\n@@ -74,7 +80,7 @@ describe('Email Subscription endpoints', () => {\n       expect(response.status).toBe(302);\n     });\n \n-    test(\"should set 'sendQuincyEmail' to 'false' for user with matching ID and 302 redirect with success message\", async () => {\n+    test(\"1: should set 'sendQuincyEmail' to 'false' for users with matching email and 302 redirect with success message\", async () => {\n       await fastifyTestInstance.prisma.user.createMany({\n         data: testUserData1\n       });\n@@ -87,14 +93,15 @@ describe('Email Subscription endpoints', () => {\n         where: {\n           OR: [\n             { unsubscribeId: unsubscribeId1 },\n-            { unsubscribeId: unsubscribeId2 }\n+            { unsubscribeId: unsubscribeId2 },\n+            { unsubscribeId: unsubscribeId3 }\n           ]\n         }\n       });\n \n-      expect(users).toHaveLength(3);\n+      expect(users).toHaveLength(4);\n       users.forEach(user => {\n-        if (user.unsubscribeId === unsubscribeId1) {\n+        if (['user1@freecodecamp.org'].includes(user.email)) {\n           expect(user.sendQuincyEmail).toBe(false);\n         } else {\n           expect(user.sendQuincyEmail).toBe(true);\n@@ -106,17 +113,19 @@ describe('Email Subscription endpoints', () => {\n       );\n \n       expect(response.status).toBe(302);\n+      // TODO: If any assertions fail before this call, other tests will fail for no actual reason.\n       await fastifyTestInstance.prisma.user.deleteMany({\n         where: {\n           OR: [\n             { unsubscribeId: unsubscribeId1 },\n-            { unsubscribeId: unsubscribeId2 }\n+            { unsubscribeId: unsubscribeId2 },\n+            { unsubscribeId: unsubscribeId3 }\n           ]\n         }\n       });\n     });\n \n-    test(\"should set 'sendQuincyEmail' to 'false' for all users with matching ID and 302 redirect with success message\", async () => {\n+    test(\"2: should set 'sendQuincyEmail' to 'false' for all users with matching email and 302 redirect with success message\", async () => {\n       await fastifyTestInstance.prisma.user.createMany({\n         data: testUserData1\n       });\n@@ -129,14 +138,19 @@ describe('Email Subscription endpoints', () => {\n         where: {\n           OR: [\n             { unsubscribeId: unsubscribeId1 },\n-            { unsubscribeId: unsubscribeId2 }\n+            { unsubscribeId: unsubscribeId2 },\n+            { unsubscribeId: unsubscribeId3 }\n           ]\n         }\n       });\n \n-      expect(users).toHaveLength(3);\n+      expect(users).toHaveLength(4);\n       users.forEach(user => {\n-        if (user.unsubscribeId === unsubscribeId2) {\n+        if (\n+          ['user1@freecodecamp.org', 'user2@freecodecamp.org'].includes(\n+            user.email\n+          )\n+        ) {\n           expect(user.sendQuincyEmail).toBe(false);\n         } else {\n           expect(user.sendQuincyEmail).toBe(true);\n@@ -148,11 +162,13 @@ describe('Email Subscription endpoints', () => {\n       );\n \n       expect(response.status).toBe(302);\n+      // TODO: If any assertions fail before this call, other tests will fail for no actual reason.\n       await fastifyTestInstance.prisma.user.deleteMany({\n         where: {\n           OR: [\n             { unsubscribeId: unsubscribeId1 },\n-            { unsubscribeId: unsubscribeId2 }\n+            { unsubscribeId: unsubscribeId2 },\n+            { unsubscribeId: unsubscribeId3 }\n           ]\n         }\n       });"
        },
        {
            "sha": "6f78fd938c2f8a7fc266c1f411c635ed0f76ed68",
            "filename": "api/src/routes/email-subscription.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63a3b8ac05e509260f096f6c26a12b971ef7d627/api%2Fsrc%2Froutes%2Femail-subscription.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63a3b8ac05e509260f096f6c26a12b971ef7d627/api%2Fsrc%2Froutes%2Femail-subscription.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Femail-subscription.ts?ref=63a3b8ac05e509260f096f6c26a12b971ef7d627",
            "patch": "@@ -36,21 +36,21 @@ export const emailSubscribtionRoutes: FastifyPluginCallbackTypebox = (\n       try {\n         const { origin } = getRedirectParams(req);\n         const { unsubscribeId } = req.params;\n-        const users = await fastify.prisma.user.findMany({\n+        const unsubUsers = await fastify.prisma.user.findMany({\n           where: { unsubscribeId }\n         });\n \n-        if (!users.length) {\n+        if (!unsubUsers.length) {\n           void reply.code(302);\n           return reply.redirectWithMessage(origin, {\n             type: 'info',\n             content: 'We could not find an account to unsubscribe.'\n           });\n         }\n \n-        const userUpdatePromises = users.map(user =>\n-          fastify.prisma.user.update({\n-            where: { id: user.id },\n+        const userUpdatePromises = unsubUsers.map(user =>\n+          fastify.prisma.user.updateMany({\n+            where: { email: user.email },\n             data: {\n               sendQuincyEmail: false\n             }"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 33,
        "deletions": 17
    }
}