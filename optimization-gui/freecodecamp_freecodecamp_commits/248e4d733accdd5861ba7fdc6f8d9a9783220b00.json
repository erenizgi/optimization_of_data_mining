{
    "author": "raisedadead",
    "message": "fix(api): update logging in routes -- donate",
    "sha": "248e4d733accdd5861ba7fdc6f8d9a9783220b00",
    "files": [
        {
            "sha": "3af0a1c2bd270f14f1b674b18b00de20f0f42852",
            "filename": "api/src/routes/public/donate.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 35,
            "changes": 97,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/248e4d733accdd5861ba7fdc6f8d9a9783220b00/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/248e4d733accdd5861ba7fdc6f8d9a9783220b00/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fdonate.ts?ref=248e4d733accdd5861ba7fdc6f8d9a9783220b00",
            "patch": "@@ -35,6 +35,8 @@ export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n     },\n     async (req, reply) => {\n       const { email, name, amount, duration } = req.body;\n+      const log = fastify.log.child({ req, email, amount, duration });\n+      log.debug('Creating Stripe payment intent');\n \n       if (!donationSubscriptionConfig.plans[duration].includes(amount)) {\n         void reply.code(400);\n@@ -72,6 +74,7 @@ export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n         ) {\n           const clientSecret =\n             stripeSubscription.latest_invoice.payment_intent.client_secret;\n+          log.info('Successfully created payment intent');\n           return reply.send({\n             subscriptionId: stripeSubscription.id,\n             clientSecret\n@@ -80,7 +83,7 @@ export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n           throw new Error('Stripe payment intent client secret is missing');\n         }\n       } catch (error) {\n-        fastify.log.error(error);\n+        log.error(error, 'Failed to create payment intent');\n         fastify.Sentry.captureException(error);\n         void reply.code(500);\n         return reply.send({\n@@ -98,6 +101,14 @@ export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n     async (req, reply) => {\n       try {\n         const { email, amount, duration, subscriptionId } = req.body;\n+        const log = fastify.log.child({\n+          req,\n+          email,\n+          amount,\n+          duration,\n+          subscriptionId\n+        });\n+        log.debug('Processing Stripe charge');\n \n         const subscription =\n           await stripe.subscriptions.retrieve(subscriptionId);\n@@ -111,50 +122,66 @@ export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n           productId && allStripeProductIdsArray.includes(productId);\n         const isValidCustomer = typeof subscription.customer === 'string';\n \n-        if (!isSubscriptionActive)\n+        if (!isSubscriptionActive) {\n+          log.warn('Invalid subscription status', {\n+            status: subscription.status\n+          });\n           throw new Error(\n             `Stripe subscription information is invalid: ${subscriptionId}`\n           );\n-        if (!isProductIdValid)\n+        }\n+        if (!isProductIdValid) {\n+          log.warn('Invalid product ID', { productId });\n           throw new Error(`Product ID is invalid: ${subscriptionId}`);\n-        if (!isStartedRecently)\n+        }\n+        if (!isStartedRecently) {\n+          log.warn('Subscription not recent', {\n+            startTime: subscription.current_period_start\n+          });\n           throw new Error(`Subscription is not recent: ${subscriptionId}`);\n-        if (!isValidCustomer)\n+        }\n+        if (!isValidCustomer) {\n+          log.warn('Invalid customer ID', {\n+            customerId: subscription.customer\n+          });\n           throw new Error(`Customer ID is invalid: ${subscriptionId}`);\n-        else {\n-          // TODO(Post-MVP) new users should not be created if user is not found\n-          const user = await findOrCreateUser(fastify, email);\n-          const donation = {\n-            userId: user.id,\n-            email,\n-            amount,\n-            duration,\n-            provider: 'stripe',\n-            subscriptionId,\n-            customerId: subscription.customer as string,\n-            // TODO(Post-MVP) migrate to startDate: new Date()\n-            startDate: {\n-              date: new Date().toISOString(),\n-              when: new Date().toISOString().replace(/.$/, '+00:00')\n-            }\n-          };\n+        }\n \n-          await fastify.prisma.donation.create({\n-            data: donation\n-          });\n+        const user = await findOrCreateUser(fastify, email);\n+        log.debug('Found or created user', { userId: user.id });\n \n-          await fastify.prisma.user.update({\n-            where: { id: user.id },\n-            data: {\n-              isDonating: true\n-            }\n-          });\n-          return reply.send({\n+        const donation = {\n+          userId: user.id,\n+          email,\n+          amount,\n+          duration,\n+          provider: 'stripe',\n+          subscriptionId,\n+          customerId: subscription.customer as string,\n+          // TODO(Post-MVP) migrate to startDate: new Date()\n+          startDate: {\n+            date: new Date().toISOString(),\n+            when: new Date().toISOString().replace(/.$/, '+00:00')\n+          }\n+        };\n+\n+        await fastify.prisma.donation.create({\n+          data: donation\n+        });\n+\n+        await fastify.prisma.user.update({\n+          where: { id: user.id },\n+          data: {\n             isDonating: true\n-          });\n-        }\n+          }\n+        });\n+        log.info('Successfully processed donation');\n+\n+        return reply.send({\n+          isDonating: true\n+        });\n       } catch (error) {\n-        fastify.log.error(error);\n+        fastify.log.error(error, 'Failed to process Stripe charge');\n         fastify.Sentry.captureException(error);\n         void reply.code(500);\n         return {"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 62,
        "deletions": 35
    }
}