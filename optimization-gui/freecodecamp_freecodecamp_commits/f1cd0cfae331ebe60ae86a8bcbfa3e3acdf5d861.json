{
    "author": "ShaunSHamilton",
    "message": "fix(api): handle 4XX errors get-public-profile (#55205)\n\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861",
    "files": [
        {
            "sha": "afac7fad3e4c4e0bdf3444d87e02150347b04462",
            "filename": "api-server/src/common/models/user.js",
            "status": "modified",
            "additions": 0,
            "deletions": 115,
            "changes": 115,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861/api-server%2Fsrc%2Fcommon%2Fmodels%2Fuser.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861/api-server%2Fsrc%2Fcommon%2Fmodels%2Fuser.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fcommon%2Fmodels%2Fuser.js?ref=f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861",
            "patch": "@@ -22,11 +22,6 @@ import {\n   setAccessTokenToResponse,\n   removeCookies\n } from '../../server/utils/getSetAccessToken';\n-import {\n-  normaliseUserFields,\n-  getProgress,\n-  publicUserProps\n-} from '../../server/utils/publicUserProps';\n import { saveUser, observeMethod } from '../../server/utils/rx.js';\n import { getEmailSender } from '../../server/utils/url-utils';\n import {\n@@ -744,116 +739,6 @@ export default function initializeUser(User) {\n     );\n   };\n \n-  function prepUserForPublish(user, profileUI) {\n-    const {\n-      about,\n-      calendar,\n-      completedChallenges,\n-      isDonating,\n-      joinDate,\n-      location,\n-      name,\n-      points,\n-      portfolio,\n-      username,\n-      yearsTopContributor\n-    } = user;\n-    const {\n-      isLocked = true,\n-      showAbout = false,\n-      showCerts = false,\n-      showDonation = false,\n-      showHeatMap = false,\n-      showLocation = false,\n-      showName = false,\n-      showPoints = false,\n-      showPortfolio = false,\n-      showTimeLine = false\n-    } = profileUI;\n-\n-    if (isLocked) {\n-      return {\n-        isLocked,\n-        profileUI,\n-        username\n-      };\n-    }\n-    return {\n-      ...user,\n-      about: showAbout ? about : '',\n-      calendar: showHeatMap ? calendar : {},\n-      completedChallenges: (function () {\n-        if (showTimeLine) {\n-          return showCerts\n-            ? completedChallenges\n-            : completedChallenges.filter(\n-                ({ challengeType }) => challengeType !== 7\n-              );\n-        } else {\n-          return [];\n-        }\n-      })(),\n-      isDonating: showDonation ? isDonating : null,\n-      joinDate: showAbout ? joinDate : '',\n-      location: showLocation ? location : '',\n-      name: showName ? name : '',\n-      points: showPoints ? points : null,\n-      portfolio: showPortfolio ? portfolio : [],\n-      yearsTopContributor: yearsTopContributor\n-    };\n-  }\n-\n-  User.getPublicProfile = function getPublicProfile(username, cb) {\n-    return User.findOne$({ where: { username } })\n-      .flatMap(user => {\n-        if (!user) {\n-          return Observable.of({});\n-        }\n-        const { completedChallenges, progressTimestamps, profileUI } = user;\n-        const allUser = {\n-          ..._.pick(user, publicUserProps),\n-          points: progressTimestamps.length,\n-          completedChallenges,\n-          ...getProgress(progressTimestamps),\n-          ...normaliseUserFields(user),\n-          joinDate: user.id.getTimestamp()\n-        };\n-\n-        const publicUser = prepUserForPublish(allUser, profileUI);\n-\n-        return Observable.of({\n-          entities: {\n-            user: {\n-              [user.username]: {\n-                ...publicUser\n-              }\n-            }\n-          },\n-          result: user.username\n-        });\n-      })\n-      .subscribe(user => cb(null, user), cb);\n-  };\n-\n-  User.remoteMethod('getPublicProfile', {\n-    accepts: {\n-      arg: 'username',\n-      type: 'string',\n-      required: true\n-    },\n-    returns: [\n-      {\n-        arg: 'user',\n-        type: 'object',\n-        root: true\n-      }\n-    ],\n-    http: {\n-      path: '/get-public-profile',\n-      verb: 'GET'\n-    }\n-  });\n-\n   User.giveBrowniePoints = function giveBrowniePoints(\n     receiver,\n     giver,"
        },
        {
            "sha": "11e3c91241e574a6fab0af026f2acb1d25d34ea3",
            "filename": "api-server/src/server/boot/randomAPIs.js",
            "status": "modified",
            "additions": 121,
            "deletions": 0,
            "changes": 121,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861/api-server%2Fsrc%2Fserver%2Fboot%2FrandomAPIs.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861/api-server%2Fsrc%2Fserver%2Fboot%2FrandomAPIs.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fboot%2FrandomAPIs.js?ref=f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861",
            "patch": "@@ -1,5 +1,11 @@\n+import { pick } from 'lodash';\n import { getRedirectParams } from '../utils/redirection';\n import { deprecatedEndpoint } from '../utils/disabled-endpoints';\n+import {\n+  getProgress,\n+  normaliseUserFields,\n+  publicUserProps\n+} from '../utils/publicUserProps';\n \n module.exports = function (app) {\n   const router = app.loopback.Router();\n@@ -10,6 +16,7 @@ module.exports = function (app) {\n   router.get('/unsubscribe/:email', unsubscribeDeprecated);\n   router.get('/ue/:unsubscribeId', unsubscribeById);\n   router.get('/resubscribe/:unsubscribeId', resubscribe);\n+  router.get('/api/users/get-public-profile', blockUserAgent, getPublicProfile);\n \n   app.use(router);\n \n@@ -105,4 +112,118 @@ module.exports = function (app) {\n         .catch(next);\n     });\n   }\n+\n+  const blockedUserAgentParts = ['python', 'google-apps-script', 'curl'];\n+\n+  function blockUserAgent(req, res, next) {\n+    const userAgent = req.headers['user-agent'];\n+\n+    if (\n+      !userAgent ||\n+      blockedUserAgentParts.some(ua => userAgent.toLowerCase().includes(ua))\n+    ) {\n+      return res\n+        .status(400)\n+        .send(\n+          'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n+        );\n+    }\n+\n+    return next();\n+  }\n+\n+  async function getPublicProfile(req, res) {\n+    const { username } = req.query;\n+    if (!username) {\n+      return res.status(400).json({ error: 'No username provided' });\n+    }\n+\n+    const user = await User.findOne({ where: { username } });\n+\n+    if (!user) {\n+      return res.status(404).json({ error: 'User not found' });\n+    }\n+\n+    const { completedChallenges, progressTimestamps, profileUI } = user;\n+    const allUser = {\n+      ...pick(user, publicUserProps),\n+      points: progressTimestamps.length,\n+      completedChallenges,\n+      ...getProgress(progressTimestamps),\n+      ...normaliseUserFields(user),\n+      joinDate: user.id.getTimestamp()\n+    };\n+\n+    const publicUser = prepUserForPublish(allUser, profileUI);\n+\n+    return res.json({\n+      entities: {\n+        user: {\n+          [user.username]: {\n+            ...publicUser\n+          }\n+        }\n+      },\n+      result: user.username\n+    });\n+  }\n+\n+  function prepUserForPublish(user, profileUI) {\n+    const {\n+      about,\n+      calendar,\n+      completedChallenges,\n+      isDonating,\n+      joinDate,\n+      location,\n+      name,\n+      points,\n+      portfolio,\n+      username,\n+      yearsTopContributor\n+    } = user;\n+    const {\n+      isLocked = true,\n+      showAbout = false,\n+      showCerts = false,\n+      showDonation = false,\n+      showHeatMap = false,\n+      showLocation = false,\n+      showName = false,\n+      showPoints = false,\n+      showPortfolio = false,\n+      showTimeLine = false\n+    } = profileUI;\n+\n+    if (isLocked) {\n+      return {\n+        isLocked,\n+        profileUI,\n+        username\n+      };\n+    }\n+    return {\n+      ...user,\n+      about: showAbout ? about : '',\n+      calendar: showHeatMap ? calendar : {},\n+      completedChallenges: (function () {\n+        if (showTimeLine) {\n+          return showCerts\n+            ? completedChallenges\n+            : completedChallenges.filter(\n+                ({ challengeType }) => challengeType !== 7\n+              );\n+        } else {\n+          return [];\n+        }\n+      })(),\n+      isDonating: showDonation ? isDonating : null,\n+      joinDate: showAbout ? joinDate : '',\n+      location: showLocation ? location : '',\n+      name: showName ? name : '',\n+      points: showPoints ? points : null,\n+      portfolio: showPortfolio ? portfolio : [],\n+      yearsTopContributor: yearsTopContributor\n+    };\n+  }\n };"
        },
        {
            "sha": "70288aae5539b3e8f64644c92a047001724f5768",
            "filename": "api-server/src/server/boot/user.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861/api-server%2Fsrc%2Fserver%2Fboot%2Fuser.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861/api-server%2Fsrc%2Fserver%2Fboot%2Fuser.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fboot%2Fuser.js?ref=f1cd0cfae331ebe60ae86a8bcbfa3e3acdf5d861",
            "patch": "@@ -43,7 +43,6 @@ function bootUser(app) {\n   const deleteMsUsername = createDeleteMsUsername(app);\n   const postSubmitSurvey = createPostSubmitSurvey(app);\n   const deleteUserSurveys = createDeleteUserSurveys(app);\n-\n   api.get('/account', sendNonUserToHome, deprecatedEndpoint);\n   api.get('/account/unlink/:social', sendNonUserToHome, getUnlinkSocial);\n   api.get('/user/get-session-user', getSessionUser);\n@@ -532,4 +531,5 @@ function createPostReportUserProfile(app) {\n     );\n   };\n }\n+\n export default bootUser;"
        }
    ],
    "stats": {
        "total": 238,
        "additions": 122,
        "deletions": 116
    }
}