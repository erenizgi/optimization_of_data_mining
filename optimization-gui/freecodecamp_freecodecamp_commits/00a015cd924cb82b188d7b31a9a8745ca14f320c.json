{
    "author": "ojeytonwilliams",
    "message": "feat: update growthbook and handle network errors (#61374)\n\nCo-authored-by: ahmad abdolsaheb <ahmad.abdolsaheb@gmail.com>",
    "sha": "00a015cd924cb82b188d7b31a9a8745ca14f320c",
    "files": [
        {
            "sha": "b21b14eee1715b862614d09aec17d519d061eccc",
            "filename": "client/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fpackage.json?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -52,7 +52,7 @@\n     \"@freecodecamp/loop-protect\": \"3.0.0\",\n     \"@freecodecamp/ui\": \"4.3.0\",\n     \"@gatsbyjs/reach-router\": \"1.3.9\",\n-    \"@growthbook/growthbook-react\": \"0.20.0\",\n+    \"@growthbook/growthbook-react\": \"1.6.0\",\n     \"@headlessui/react\": \"1.7.19\",\n     \"@loadable/component\": \"5.16.3\",\n     \"@redux-devtools/extension\": \"3.3.0\","
        },
        {
            "sha": "71d390681f09c021d55adeecc4ec3ea5e7e51f04",
            "filename": "client/src/client-only-routes/show-settings.test.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.test.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.test.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fclient-only-routes%2Fshow-settings.test.tsx?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -4,12 +4,14 @@ import React from 'react';\n import ShallowRenderer from 'react-test-renderer/shallow';\n import { describe, it, expect, vi } from 'vitest';\n import envData from '../../config/env.json';\n-\n import { ShowSettings } from './show-settings';\n \n-const { apiLocation } = envData as Record<string, string>;\n-\n vi.mock('../analytics');\n+vi.mock('@growthbook/growthbook-react', () => ({\n+  useFeatureIsOn: () => false\n+}));\n+\n+const { apiLocation } = envData as Record<string, string>;\n \n describe('<ShowSettings />', () => {\n   it('renders to the DOM when user is logged in', () => {"
        },
        {
            "sha": "95e69cc281da0146e6e25c4378517816172ce672",
            "filename": "client/src/components/Intro/intro.test.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fcomponents%2FIntro%2Fintro.test.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fcomponents%2FIntro%2Fintro.test.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2FIntro%2Fintro.test.tsx?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -7,6 +7,10 @@ import { createStore } from '../../redux/create-store';\n import Intro from '.';\n \n vi.mock('../../analytics');\n+vi.mock('@growthbook/growthbook-react', () => ({\n+  useFeature: () => ({ on: false, value: undefined }),\n+  useFeatureIsOn: () => false\n+}));\n vi.mock('../../utils/get-words');\n \n function renderWithRedux("
        },
        {
            "sha": "4191fa1045c76983e76f46f061a7f57f12ad90ac",
            "filename": "client/src/components/growth-book/growth-book-wrapper.test.tsx",
            "status": "added",
            "additions": 145,
            "deletions": 0,
            "changes": 145,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fcomponents%2Fgrowth-book%2Fgrowth-book-wrapper.test.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fcomponents%2Fgrowth-book%2Fgrowth-book-wrapper.test.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Fgrowth-book%2Fgrowth-book-wrapper.test.tsx?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -0,0 +1,145 @@\n+import React from 'react';\n+import { vi, describe, test, expect, beforeEach } from 'vitest';\n+import { render, waitFor } from '@testing-library/react';\n+import GrowthBookWrapper from './growth-book-wrapper';\n+\n+interface MinimalUser {\n+  completedChallenges: unknown[];\n+  email: string;\n+  joinDate: string;\n+}\n+\n+interface TestWrapperProps {\n+  user: MinimalUser | null;\n+  userFetchState: {\n+    pending: boolean;\n+    complete: boolean;\n+    errored: boolean;\n+    error: string | null;\n+  };\n+  children: JSX.Element;\n+}\n+\n+const UnconnectedTestWrapper = ({\n+  children,\n+  user,\n+  userFetchState\n+}: TestWrapperProps) => (\n+  <GrowthBookWrapper\n+    {...({ user, userFetchState } as unknown as Record<string, unknown>)}\n+  >\n+    {children}\n+  </GrowthBookWrapper>\n+);\n+\n+vi.mock('react-redux', () => ({\n+  connect: () => (Comp: React.ComponentType) => Comp\n+}));\n+\n+vi.mock('./growth-book-redux-connector', () => ({\n+  __esModule: true,\n+  default: ({ children }: { children: React.ReactNode }) => (\n+    <div>{children}</div>\n+  )\n+}));\n+\n+vi.mock('../../../config/env.json', () => ({\n+  default: {\n+    clientLocale: 'en',\n+    growthbookUri: 'https://example.com/api/features/gb_client_123'\n+  }\n+}));\n+\n+vi.mock('../../../config/growthbook-features-default.json', () => ({\n+  default: {\n+    mockFeature: { defaultValue: true }\n+  }\n+}));\n+\n+let currentInitImpl: () =>\n+  | Promise<{ success: boolean; source?: string }>\n+  | Promise<never> = () => Promise.resolve({ success: true });\n+\n+const mockInit = vi.fn(() => currentInitImpl());\n+const mockSetPayload = vi.fn((_arg: Record<string, unknown>) =>\n+  Promise.resolve()\n+);\n+const mockSetAttributes = vi.fn((_arg: Record<string, unknown>) =>\n+  Promise.resolve()\n+);\n+\n+export function setInitImpl(\n+  impl: () => Promise<{ success: boolean; source?: string }> | Promise<never>\n+) {\n+  currentInitImpl = impl;\n+}\n+\n+vi.mock('@growthbook/growthbook-react', () => ({\n+  GrowthBook: vi.fn().mockImplementation(() => ({\n+    init: () => mockInit(),\n+    setPayload: (arg: Record<string, unknown>) => mockSetPayload(arg),\n+    setAttributes: (arg: Record<string, unknown>) => mockSetAttributes(arg)\n+  })),\n+  GrowthBookProvider: ({ children }: { children: React.ReactNode }) => (\n+    <div>{children}</div>\n+  )\n+}));\n+\n+function renderWrapper(initOptions: { complete: boolean }) {\n+  return render(\n+    <UnconnectedTestWrapper\n+      user={{ completedChallenges: [], email: '', joinDate: '' }}\n+      userFetchState={{\n+        pending: false,\n+        complete: initOptions.complete,\n+        errored: false,\n+        error: null\n+      }}\n+    >\n+      <div data-testid='child' />\n+    </UnconnectedTestWrapper>\n+  );\n+}\n+\n+describe('GrowthBookWrapper init effect', () => {\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+    setInitImpl(() => Promise.resolve({ success: true }));\n+    mockInit.mockImplementation(() => currentInitImpl());\n+  });\n+\n+  test('does not apply fallback when init succeeds', async () => {\n+    setInitImpl(() => Promise.resolve({ success: true }));\n+\n+    renderWrapper({ complete: false });\n+\n+    await waitFor(() => expect(mockInit).toHaveBeenCalled());\n+    expect(mockSetPayload).not.toHaveBeenCalled();\n+  });\n+\n+  test('applies fallback when init resolves with success: false', async () => {\n+    vi.spyOn(console, 'warn').mockImplementation(() => {});\n+    setInitImpl(() => Promise.resolve({ success: false, source: 'network' }));\n+\n+    renderWrapper({ complete: false });\n+\n+    await waitFor(() => expect(mockInit).toHaveBeenCalled());\n+    expect(mockSetPayload).toHaveBeenCalledWith({\n+      features: { mockFeature: { defaultValue: true } }\n+    });\n+  });\n+\n+  test('applies fallback when init rejects', async () => {\n+    vi.spyOn(console, 'error').mockImplementation(() => {});\n+    setInitImpl(() => Promise.reject(new Error('boom')));\n+\n+    renderWrapper({ complete: false });\n+\n+    await waitFor(() => expect(mockInit).toHaveBeenCalled());\n+    await waitFor(() =>\n+      expect(mockSetPayload).toHaveBeenCalledWith({\n+        features: { mockFeature: { defaultValue: true } }\n+      })\n+    );\n+  });\n+});"
        },
        {
            "sha": "24add2fedf97d1e981185bb3fb597411757687ae",
            "filename": "client/src/components/growth-book/growth-book-wrapper.tsx",
            "status": "modified",
            "additions": 48,
            "deletions": 20,
            "changes": 68,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fcomponents%2Fgrowth-book%2Fgrowth-book-wrapper.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fcomponents%2Fgrowth-book%2Fgrowth-book-wrapper.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Fgrowth-book%2Fgrowth-book-wrapper.tsx?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -1,9 +1,5 @@\n import React, { useEffect, useMemo } from 'react';\n-import {\n-  FeatureDefinition,\n-  GrowthBook,\n-  GrowthBookProvider\n-} from '@growthbook/growthbook-react';\n+import { GrowthBook, GrowthBookProvider } from '@growthbook/growthbook-react';\n import { connect } from 'react-redux';\n import { createSelector } from 'reselect';\n import { userSelector, userFetchStateSelector } from '../../redux/selectors';\n@@ -19,6 +15,25 @@ const { clientLocale, growthbookUri } = envData as {\n   growthbookUri: string | null;\n };\n \n+// Parses GrowthBook URL to extract apiHost and clientKey\n+function parseGrowthBookUrl(\n+  url: string | null | undefined\n+): { apiHost: string; clientKey: string } | null {\n+  if (!url) return null;\n+  try {\n+    const u = new URL(url);\n+    // Expect: /api/features/<clientKey> (with optional trailing slash)\n+    const match = u.pathname.match(/^\\/api\\/features\\/([^/]+)\\/?$/);\n+    if (!match) return null;\n+    const clientKey = match[1];\n+    const apiHost = `${u.protocol}//${u.host}`;\n+    if (!clientKey || !apiHost) return null;\n+    return { apiHost, clientKey };\n+  } catch {\n+    return null;\n+  }\n+}\n+\n declare global {\n   interface Window {\n     dataLayer: [Record<string, number | string>];\n@@ -53,9 +68,14 @@ const GrowthBookWrapper = ({\n   user,\n   userFetchState\n }: GrowthBookWrapper) => {\n+  const parsedUrl = parseGrowthBookUrl(growthbookUri);\n   const growthbook = useMemo(\n     () =>\n       new GrowthBook({\n+        ...(parsedUrl && {\n+          apiHost: parsedUrl.apiHost,\n+          clientKey: parsedUrl.clientKey\n+        }),\n         trackingCallback: (experiment, result) => {\n           callGA({\n             event: 'experiment_viewed',\n@@ -66,25 +86,33 @@ const GrowthBookWrapper = ({\n         }\n       }),\n \n-    []\n+    [parsedUrl]\n   );\n \n   useEffect(() => {\n-    async function setGrowthBookFeatures() {\n+    void growthbook\n+      .init({ timeout: 1000 })\n+      .then(res => {\n+        if (!res || !res.success) {\n+          console.warn('GrowthBook initialization failed.', {\n+            source: res?.source,\n+            error: res?.error\n+          });\n+          void growthbook.setPayload({ features: defaultGrowthBookFeatures });\n+          return;\n+        }\n+      })\n+      .catch(error => {\n+        console.error('Error initializing GrowthBook:', error);\n+        void growthbook.setPayload({ features: defaultGrowthBookFeatures });\n+      });\n+  }, [growthbook]);\n+\n+  useEffect(() => {\n+    function setGrowthBookFeatures() {\n       if (!growthbookUri) {\n         // Defaults are added to facilitate testing, and avoid passing the related env\n-        growthbook.setFeatures(defaultGrowthBookFeatures);\n-      } else {\n-        try {\n-          const res = await fetch(growthbookUri);\n-          const data = (await res.json()) as {\n-            features: Record<string, FeatureDefinition>;\n-          };\n-          growthbook.setFeatures(data.features);\n-        } catch (e) {\n-          // TODO: report to sentry when it's enabled\n-          console.error(e);\n-        }\n+        void growthbook.setPayload({ features: defaultGrowthBookFeatures });\n       }\n     }\n \n@@ -111,7 +139,7 @@ const GrowthBookWrapper = ({\n           signedIn: true\n         };\n       }\n-      growthbook.setAttributes(userAttributes);\n+      void growthbook.setAttributes(userAttributes);\n     }\n   }, [user, userFetchState, growthbook]);\n "
        },
        {
            "sha": "6399ca48f11d1f4d262de9e6bcb83e4a6f4ff8d9",
            "filename": "client/src/pages/index.tsx",
            "status": "modified",
            "additions": 30,
            "deletions": 8,
            "changes": 38,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/client%2Fsrc%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fpages%2Findex.tsx?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -1,6 +1,8 @@\n import React from 'react';\n import { useTranslation } from 'react-i18next';\n+import { useGrowthBook } from '@growthbook/growthbook-react';\n import SEO from '../components/seo';\n+import { Loader } from '../components/helpers';\n import LandingTopB from '../components/landing/components/landing-top-b';\n import LandingTop from '../components/landing/components/landing-top';\n import Testimonials from '../components/landing/components/testimonials';\n@@ -14,7 +16,11 @@ type LandingProps = {\n };\n \n const Landing = ({ showLandingPageRedesign }: LandingProps) => (\n-  <main className={`landing-page`}>\n+  <main\n+    id='landing-content'\n+    data-testid='landing-content'\n+    className={`landing-page`}\n+  >\n     {showLandingPageRedesign ? <LandingTopB /> : <LandingTop />}\n     <Benefits />\n     <Testimonials />\n@@ -25,13 +31,29 @@ const Landing = ({ showLandingPageRedesign }: LandingProps) => (\n \n function IndexPage(): JSX.Element {\n   const { t } = useTranslation();\n-\n-  return (\n-    <>\n-      <SEO title={t('metaTags:title')} />\n-      <Landing showLandingPageRedesign={true} />\n-    </>\n-  );\n+  const growthbook = useGrowthBook();\n+  if (growthbook && growthbook.ready) {\n+    console.error('GrowthBook Ready', growthbook);\n+    const showLandingPageRedesign = growthbook.getFeatureValue(\n+      'landing-top-skill-focused',\n+      false\n+    );\n+    growthbook.getFeatureValue('landing-aa-test', false);\n+    return (\n+      <>\n+        <SEO title={t('metaTags:title')} />\n+        <Landing showLandingPageRedesign={showLandingPageRedesign} />\n+      </>\n+    );\n+  } else {\n+    console.error('GrowthBook not ready yet', growthbook);\n+    return (\n+      <>\n+        <SEO title={t('metaTags:title')} />\n+        <Loader fullScreen={true} />\n+      </>\n+    );\n+  }\n }\n \n IndexPage.displayName = 'IndexPage';"
        },
        {
            "sha": "0b2dbb641bb54bafd2fd626837e8cd20bbf82c20",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/00a015cd924cb82b188d7b31a9a8745ca14f320c/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/00a015cd924cb82b188d7b31a9a8745ca14f320c/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=00a015cd924cb82b188d7b31a9a8745ca14f320c",
            "patch": "@@ -346,8 +346,8 @@ importers:\n         specifier: 1.3.9\n         version: 1.3.9(react-dom@17.0.2(react@17.0.2))(react@17.0.2)\n       '@growthbook/growthbook-react':\n-        specifier: 0.20.0\n-        version: 0.20.0(react@17.0.2)\n+        specifier: 1.6.0\n+        version: 1.6.0(react@17.0.2)\n       '@headlessui/react':\n         specifier: 1.7.19\n         version: 1.7.19(react-dom@17.0.2(react@17.0.2))(react@17.0.2)\n@@ -3044,20 +3044,20 @@ packages:\n     peerDependencies:\n       graphql: ^0.8.0 || ^0.9.0 || ^0.10.0 || ^0.11.0 || ^0.12.0 || ^0.13.0 || ^14.0.0 || ^15.0.0 || ^16.0.0 || ^17.0.0\n \n-  '@growthbook/growthbook-react@0.20.0':\n-    resolution: {integrity: sha512-mFlp0z6oZv71uRcze7QMkr5xRqoWAFxXahY9DFa/mwHwLS1giqC7wE5DQUKz2ZaC8G3YZ7ORpXB9bOc9ucILZw==}\n+  '@growthbook/growthbook-react@1.6.0':\n+    resolution: {integrity: sha512-B1zSLfjRKfDlXNXMCvDLBGRAEslNDu2acUgCtHLvtGm/ZeiXtT4TuSG6dy9U2XcXczMFHoDtDln3skGb6mbo7g==}\n     engines: {node: '>=10'}\n     peerDependencies:\n-      react: ^16.8.0-0 || ^17.0.0-0 || ^18.0.0-0\n-\n-  '@growthbook/growthbook@0.30.0':\n-    resolution: {integrity: sha512-ennMHKZIhAZokHHcnA9/tOTLFdBB4DQR0WHT8Lf1pD80jWVv8JBCAzsV1jzSjYUQhb8R8pLR2Kho0IfgjzIZGQ==}\n-    engines: {node: '>=10'}\n+      react: ^16.8.0-0 || ^17.0.0-0 || ^18.0.0-0 || ^19.0.0-0\n \n   '@growthbook/growthbook@1.3.1':\n     resolution: {integrity: sha512-ewtwq6+86rRKwcYUXEmBVR1JuiEIYZhxow/Z52qyAxJwEHdXmpS4Yk8sVeVD9bphCwE2r0zuifxFkBxmnIL4Mg==}\n     engines: {node: '>=10'}\n \n+  '@growthbook/growthbook@1.6.0':\n+    resolution: {integrity: sha512-0aMB8j1lVLob4uXpFpTmylMEzlMsaaeFZiXgtaveCQwF+vwdKZG+aCOX/XQyLEvdsU1x3M4s/kZSiFM1lRMgQw==}\n+    engines: {node: '>=10'}\n+\n   '@hapi/address@2.1.4':\n     resolution: {integrity: sha512-QD1PhQk+s31P1ixsX0H0Suoupp3VMXzIVMSwobR3F3MSUO2YCV0B7xqLcUw/Bh8yuvd3LhpyqLQWTNcRmp6IdQ==}\n     deprecated: Moved to 'npm install @sideway/address'\n@@ -17603,16 +17603,16 @@ snapshots:\n     dependencies:\n       graphql: 15.8.0\n \n-  '@growthbook/growthbook-react@0.20.0(react@17.0.2)':\n+  '@growthbook/growthbook-react@1.6.0(react@17.0.2)':\n     dependencies:\n-      '@growthbook/growthbook': 0.30.0\n+      '@growthbook/growthbook': 1.6.0\n       react: 17.0.2\n \n-  '@growthbook/growthbook@0.30.0':\n+  '@growthbook/growthbook@1.3.1':\n     dependencies:\n       dom-mutator: 0.6.0\n \n-  '@growthbook/growthbook@1.3.1':\n+  '@growthbook/growthbook@1.6.0':\n     dependencies:\n       dom-mutator: 0.6.0\n \n@@ -24368,7 +24368,7 @@ snapshots:\n       '@babel/plugin-proposal-numeric-separator': 7.18.6(@babel/core@7.23.7)\n       '@babel/plugin-proposal-optional-chaining': 7.17.12(@babel/core@7.23.7)\n       '@babel/preset-typescript': 7.23.3(@babel/core@7.23.7)\n-      '@babel/runtime': 7.27.3\n+      '@babel/runtime': 7.23.9\n       babel-plugin-remove-graphql-queries: 3.15.0(@babel/core@7.23.7)(gatsby@3.15.0(@types/node@20.12.8)(babel-eslint@10.1.0(eslint@7.32.0))(eslint-import-resolver-typescript@3.10.1)(eslint-plugin-testing-library@3.9.0(eslint@7.32.0)(typescript@5.2.2))(react-dom@17.0.2(react@17.0.2))(react@17.0.2)(typescript@5.2.2))\n       gatsby: 3.15.0(@types/node@20.12.8)(babel-eslint@10.1.0(eslint@7.32.0))(eslint-import-resolver-typescript@3.10.1)(eslint-plugin-testing-library@3.9.0(eslint@7.32.0)(typescript@5.2.2))(react-dom@17.0.2(react@17.0.2))(react@17.0.2)(typescript@5.2.2)\n     transitivePeerDependencies:"
        }
    ],
    "stats": {
        "total": 293,
        "additions": 247,
        "deletions": 46
    }
}