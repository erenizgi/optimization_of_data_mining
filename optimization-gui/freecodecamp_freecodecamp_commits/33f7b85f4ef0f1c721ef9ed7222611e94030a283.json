{
    "author": "ojeytonwilliams",
    "message": "fix(api): only query for potentially valid tokens (#57383)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "33f7b85f4ef0f1c721ef9ed7222611e94030a283",
    "files": [
        {
            "sha": "c153a04517307d2c1509d6b3bfc6be1d70360d2d",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33f7b85f4ef0f1c721ef9ed7222611e94030a283/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33f7b85f4ef0f1c721ef9ed7222611e94030a283/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=33f7b85f4ef0f1c721ef9ed7222611e94030a283",
            "patch": "@@ -1,4 +1,6 @@\n import { Static } from '@fastify/type-provider-typebox';\n+import jwt from 'jsonwebtoken';\n+\n import {\n   createSuperRequest,\n   defaultUserId,\n@@ -11,6 +13,7 @@ import {\n } from '../schemas';\n import * as mock from '../../../__mocks__/env-exam';\n import { constructUserExam } from '../utils/exam';\n+import { JWT_SECRET } from '../../utils/env';\n \n jest.mock('../../utils/env', () => {\n   // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n@@ -639,7 +642,7 @@ describe('/exam-environment/', () => {\n     });\n \n     describe('GET /exam-environment/token-meta', () => {\n-      it('should allow a valid request', async () => {\n+      it('should reject invalid tokens', async () => {\n         const res = await superGet('/exam-environment/token-meta').set(\n           'exam-environment-authorization-token',\n           'invalid-token'\n@@ -652,6 +655,24 @@ describe('/exam-environment/', () => {\n           }\n         });\n       });\n+\n+      it('should tell the requester if the token does not exist', async () => {\n+        const validToken = jwt.sign(\n+          { examEnvironmentAuthorizationToken: 'does-not-exist' },\n+          JWT_SECRET\n+        );\n+        const res = await superGet('/exam-environment/token-meta').set(\n+          'exam-environment-authorization-token',\n+          validToken\n+        );\n+\n+        expect(res).toMatchObject({\n+          status: 418,\n+          body: {\n+            code: 'FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN'\n+          }\n+        });\n+      });\n     });\n \n     describe('GET /exam-environment/exams', () => {"
        },
        {
            "sha": "a9484e9c3341927848ad18acdeb4b94bc3dd260f",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/33f7b85f4ef0f1c721ef9ed7222611e94030a283/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/33f7b85f4ef0f1c721ef9ed7222611e94030a283/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=33f7b85f4ef0f1c721ef9ed7222611e94030a283",
            "patch": "@@ -14,6 +14,7 @@ import {\n   validateAttempt\n } from '../utils/exam';\n import { ERRORS } from '../utils/errors';\n+import { isObjectID } from '../../utils/validation';\n \n /**\n  * Wrapper for endpoints related to the exam environment desktop app.\n@@ -91,8 +92,9 @@ async function tokenMetaHandler(\n ) {\n   const { 'exam-environment-authorization-token': encodedToken } = req.headers;\n \n+  let payload: JwtPayload;\n   try {\n-    jwt.verify(encodedToken, JWT_SECRET);\n+    payload = jwt.verify(encodedToken, JWT_SECRET) as JwtPayload;\n   } catch (e) {\n     // Server refuses to brew (verify) coffee (jwts) with a teapot (random strings)\n     void reply.code(418);\n@@ -101,14 +103,18 @@ async function tokenMetaHandler(\n     );\n   }\n \n-  const payload = jwt.decode(encodedToken) as JwtPayload;\n-\n-  const examEnvironmentAuthorizationToken =\n-    payload.examEnvironmentAuthorizationToken;\n+  if (!isObjectID(payload.examEnvironmentAuthorizationToken)) {\n+    void reply.code(418);\n+    return reply.send(\n+      ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(\n+        'Token is not valid'\n+      )\n+    );\n+  }\n \n   const token = await this.prisma.examEnvironmentAuthorizationToken.findUnique({\n     where: {\n-      id: examEnvironmentAuthorizationToken\n+      id: payload.examEnvironmentAuthorizationToken\n     }\n   });\n "
        }
    ],
    "stats": {
        "total": 41,
        "additions": 34,
        "deletions": 7
    }
}