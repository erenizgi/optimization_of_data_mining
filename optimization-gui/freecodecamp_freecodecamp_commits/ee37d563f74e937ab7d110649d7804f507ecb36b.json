{
    "author": "ojeytonwilliams",
    "message": "fix(api): reject social urls with invalid domains (#55595)",
    "sha": "ee37d563f74e937ab7d110649d7804f507ecb36b",
    "files": [
        {
            "sha": "111e989392e64e16e83912cad8e22385f663478b",
            "filename": "api/src/routes/settings.test.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 3,
            "changes": 48,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ee37d563f74e937ab7d110649d7804f507ecb36b/api%2Fsrc%2Froutes%2Fsettings.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ee37d563f74e937ab7d110649d7804f507ecb36b/api%2Fsrc%2Froutes%2Fsettings.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.test.ts?ref=ee37d563f74e937ab7d110649d7804f507ecb36b",
            "patch": "@@ -11,7 +11,11 @@ import {\n import { formatMessage } from '../plugins/redirect-with-message';\n import { createUserInput } from '../utils/create-user';\n import { API_LOCATION, HOME_LOCATION } from '../utils/env';\n-import { isPictureWithProtocol, getWaitMessage } from './settings';\n+import {\n+  isPictureWithProtocol,\n+  getWaitMessage,\n+  validateSocialUrl\n+} from './settings';\n \n const baseProfileUI = {\n   isLocked: false,\n@@ -827,12 +831,24 @@ Happy coding!\n         expect(response.statusCode).toEqual(200);\n       });\n \n-      test('PUT returns 400 status code with invalid socials setting', async () => {\n+      test('PUT rejects non-url values', async () => {\n         const response = await superPut('/update-my-socials').send({\n           website: 'invalid',\n           twitter: '',\n           linkedin: '',\n-          githubProfile: 'invalid'\n+          githubProfile: ''\n+        });\n+\n+        expect(response.body).toEqual(updateErrorResponse);\n+        expect(response.statusCode).toEqual(400);\n+      });\n+\n+      test('PUT only accepts urls to certain domains', async () => {\n+        const response = await superPut('/update-my-socials').send({\n+          website: '',\n+          twitter: '',\n+          linkedin: '',\n+          githubProfile: 'https://x.com/should-be-github'\n         });\n \n         expect(response.body).toEqual(updateErrorResponse);\n@@ -1122,3 +1138,29 @@ describe('getWaitMessage', () => {\n     );\n   });\n });\n+\n+describe('validateSocialUrl', () => {\n+  it.each(['githubProfile', 'linkedin', 'twitter'] as const)(\n+    'accepts empty strings for %s',\n+    social => {\n+      expect(validateSocialUrl('', social)).toBe(true);\n+    }\n+  );\n+\n+  it.each([\n+    ['githubProfile', 'https://something.com/user'],\n+    ['linkedin', 'https://www.x.com/in/username'],\n+    ['twitter', 'https://www.toomanyexes.com/username']\n+  ] as const)('rejects invalid urls for %s', (social, url) => {\n+    expect(validateSocialUrl(url, social)).toBe(false);\n+  });\n+\n+  it.each([\n+    ['githubProfile', 'https://something.github.com/user'],\n+    ['linkedin', 'https://www.linkedin.com/in/username'],\n+    ['twitter', 'https://twitter.com/username'],\n+    ['twitter', 'https://x.com/username']\n+  ] as const)('accepts valid urls for %s', (social, url) => {\n+    expect(validateSocialUrl(url, social)).toBe(true);\n+  });\n+});"
        },
        {
            "sha": "0b575d9e128f7d3ac0a98c718aa4254bbdcce65f",
            "filename": "api/src/routes/settings.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ee37d563f74e937ab7d110649d7804f507ecb36b/api%2Fsrc%2Froutes%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ee37d563f74e937ab7d110649d7804f507ecb36b/api%2Fsrc%2Froutes%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.ts?ref=ee37d563f74e937ab7d110649d7804f507ecb36b",
            "patch": "@@ -69,6 +69,35 @@ export const isPictureWithProtocol = (picture?: string): boolean => {\n   }\n };\n \n+const ALLOWED_DOMAINS_MAP = {\n+  githubProfile: ['github.com'],\n+  linkedin: ['linkedin.com'],\n+  twitter: ['twitter.com', 'x.com']\n+};\n+\n+/**\n+ * Validate a social URL.\n+ *\n+ * @param socialUrl The URL to check.\n+ * @param key The key of the allowed socials and domains.\n+ * @returns Whether the URL is valid.\n+ */\n+export const validateSocialUrl = (\n+  socialUrl: string,\n+  key: keyof typeof ALLOWED_DOMAINS_MAP\n+): boolean => {\n+  if (!socialUrl) return true;\n+\n+  try {\n+    const url = new URL(socialUrl);\n+    const domains = ALLOWED_DOMAINS_MAP[key];\n+    const domainAndTld = url.hostname.split('.').slice(-2).join('.');\n+    return domains.includes(domainAndTld);\n+  } catch {\n+    return false;\n+  }\n+};\n+\n /**\n  * Plugin for all endpoints related to user settings.\n  *\n@@ -328,6 +357,18 @@ ${isLinkSentWithinLimitTTL}`\n       errorHandler: updateErrorHandler\n     },\n     async (req, reply) => {\n+      const valid = (['twitter', 'githubProfile', 'linkedin'] as const).every(\n+        key => validateSocialUrl(req.body[key], key)\n+      );\n+\n+      if (!valid) {\n+        void reply.code(400);\n+        return reply.send({\n+          message: 'flash.wrong-updating',\n+          type: 'danger'\n+        });\n+      }\n+\n       try {\n         await fastify.prisma.user.update({\n           where: { id: req.user?.id },"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 86,
        "deletions": 3
    }
}