{
    "author": "ShaunSHamilton",
    "message": "feat(api): add version to exam collections (#61644)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "6adc98a42674754430267dc550affc9b4b737154",
    "files": [
        {
            "sha": "28eda433a2f8bd2df356b4710a9ea13289b32691",
            "filename": "api/__mocks__/exam-environment-exam.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6adc98a42674754430267dc550affc9b4b737154/api%2F__mocks__%2Fexam-environment-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6adc98a42674754430267dc550affc9b4b737154/api%2F__mocks__%2Fexam-environment-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fexam-environment-exam.ts?ref=6adc98a42674754430267dc550affc9b4b737154",
            "patch": "@@ -248,7 +248,8 @@ export const generatedExam: ExamEnvironmentGeneratedExam = {\n         }\n       ]\n     }\n-  ]\n+  ],\n+  version: 1\n };\n \n export const examAttempt: ExamEnvironmentExamAttempt = {\n@@ -293,7 +294,8 @@ export const examAttempt: ExamEnvironmentExamAttempt = {\n     }\n   ],\n   startTimeInMS: Date.now(),\n-  userId: defaultUserId\n+  userId: defaultUserId,\n+  version: 1\n };\n \n export const examAttemptSansSubmissionTimeInMS: Static<\n@@ -340,7 +342,8 @@ export const exam: ExamEnvironmentExam = {\n   config,\n   questionSets,\n   prerequisites: ['67112fe1c994faa2c26d0b1d'],\n-  deprecated: false\n+  deprecated: false,\n+  version: 1\n };\n \n export async function seedEnvExam() {"
        },
        {
            "sha": "a4f17fe3f341b5e9ddf0392565e793116e82f33d",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6adc98a42674754430267dc550affc9b4b737154/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6adc98a42674754430267dc550affc9b4b737154/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=6adc98a42674754430267dc550affc9b4b737154",
            "patch": "@@ -182,6 +182,9 @@ model ExamEnvironmentExam {\n   prerequisites String[]                     @db.ObjectId\n   /// If `deprecated`, the exam should no longer be considered for users\n   deprecated    Boolean\n+  /// Version of the record\n+  /// The default must be incremented by 1, if anything in the schema changes\n+  version       Int                          @default(1)\n \n   // Relations\n   generatedExams ExamEnvironmentGeneratedExam[]\n@@ -313,6 +316,9 @@ model ExamEnvironmentExamAttempt {\n   questionSets  ExamEnvironmentQuestionSetAttempt[]\n   /// Time exam was started as milliseconds since epoch\n   startTimeInMS Int\n+  /// Version of the record\n+  /// The default must be incremented by 1, if anything in the schema changes\n+  version       Int                                 @default(1)\n \n   // Relations\n   user                          user                            @relation(fields: [userId], references: [id], onDelete: Cascade)\n@@ -347,6 +353,9 @@ model ExamEnvironmentGeneratedExam {\n   questionSets ExamEnvironmentGeneratedQuestionSet[]\n   /// If `deprecated`, the generation should not longer be considered for users\n   deprecated   Boolean\n+  /// Version of the record\n+  /// The default must be incremented by 1, if anything in the schema changes\n+  version      Int                                   @default(1)\n \n   // Relations\n   exam           ExamEnvironmentExam          @relation(fields: [examId], references: [id], onDelete: Cascade)\n@@ -549,6 +558,9 @@ model ExamEnvironmentExamModeration {\n \n   /// Date the exam attempt was added to the moderation queue\n   submissionDate DateTime @default(now()) @db.Date\n+  /// Version of the record\n+  /// The default must be incremented by 1, if anything in the schema changes\n+  version        Int      @default(1)\n \n   // Relations\n   examAttempt ExamEnvironmentExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)"
        },
        {
            "sha": "3e6698cd6e6f7494d7e7e3516b6a00e4bfb0531d",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6adc98a42674754430267dc550affc9b4b737154/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6adc98a42674754430267dc550affc9b4b737154/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=6adc98a42674754430267dc550affc9b4b737154",
            "patch": "@@ -512,7 +512,9 @@ describe('/exam-environment/', () => {\n           generatedExamId: generatedExam!.id,\n           questionSets: [],\n           // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-          startTimeInMS: expect.any(Number)\n+          startTimeInMS: expect.any(Number),\n+          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+          version: expect.any(Number)\n         });\n       });\n "
        },
        {
            "sha": "7fe9682a9d5a118b58590de97fb089bbeac139c3",
            "filename": "api/src/exam-environment/utils/exam-environment.test.ts",
            "status": "modified",
            "additions": 121,
            "deletions": 2,
            "changes": 123,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6adc98a42674754430267dc550affc9b4b737154/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6adc98a42674754430267dc550affc9b4b737154/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.test.ts?ref=6adc98a42674754430267dc550affc9b4b737154",
            "patch": "@@ -1,11 +1,16 @@\n-import { ExamEnvironmentAnswer } from '@prisma/client';\n+import {\n+  ExamEnvironmentAnswer,\n+  ExamEnvironmentQuestionType\n+} from '@prisma/client';\n import { type Static } from '@fastify/type-provider-typebox';\n import {\n   exam,\n   examAttempt,\n-  generatedExam\n+  generatedExam,\n+  oid\n } from '../../../__mocks__/exam-environment-exam';\n import * as schemas from '../schemas';\n+import { setupServer } from '../../../jest.utils';\n import {\n   checkAttemptAgainstGeneratedExam,\n   checkPrerequisites,\n@@ -408,3 +413,117 @@ describe('Exam Environment', () => {\n     });\n   });\n });\n+\n+describe('Exam Environment Schema', () => {\n+  setupServer();\n+  describe('ExamEnvironmentExam', () => {\n+    afterAll(async () => {\n+      await fastifyTestInstance.prisma.examEnvironmentExam.deleteMany({});\n+    });\n+\n+    it(\"If this test fails and you've deliberately altered the schema, then increment the `version` field by 1\", async () => {\n+      const configQuestionSets = [\n+        {\n+          numberOfCorrectAnswers: 0,\n+          numberOfIncorrectAnswers: 0,\n+          numberOfQuestions: 0,\n+          numberOfSet: 0,\n+          type: ExamEnvironmentQuestionType.MultipleChoice\n+        }\n+      ];\n+      const tags = [\n+        {\n+          group: [''],\n+          numberOfQuestions: 0\n+        }\n+      ];\n+      const config = {\n+        name: '',\n+        note: '',\n+        passingPercent: 0.0,\n+        questionSets: configQuestionSets,\n+        retakeTimeInMS: 0,\n+        tags,\n+        totalTimeInMS: 0\n+      };\n+\n+      const questions = [\n+        {\n+          answers: [\n+            {\n+              id: oid(),\n+              isCorrect: false,\n+              text: ''\n+            }\n+          ],\n+          audio: { captions: '', url: '' },\n+          deprecated: false,\n+          id: oid(),\n+          tags: [''],\n+          text: ''\n+        }\n+      ];\n+      const questionSets = [\n+        {\n+          context: '',\n+          id: oid(),\n+          questions,\n+          type: ExamEnvironmentQuestionType.MultipleChoice\n+        }\n+      ];\n+      const data = {\n+        config,\n+        deprecated: false,\n+        prerequisites: [oid()],\n+        questionSets\n+      };\n+\n+      await fastifyTestInstance.prisma.examEnvironmentExam.create({\n+        data\n+      });\n+    });\n+  });\n+  describe('ExamEnvironmentGeneratedExam', () => {\n+    afterAll(async () => {\n+      await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.deleteMany(\n+        {}\n+      );\n+    });\n+    it(\"If this test fails and you've deliberately altered the schema, then increment the `version` field by 1\", async () => {\n+      await fastifyTestInstance.prisma.examEnvironmentGeneratedExam.create({\n+        data: {\n+          deprecated: false,\n+          examId: oid(),\n+          questionSets: [\n+            { id: oid(), questions: [{ answers: [oid()], id: oid() }] }\n+          ]\n+        }\n+      });\n+    });\n+  });\n+  describe('ExamEnvironmentExamAttempt', () => {\n+    afterAll(async () => {\n+      await fastifyTestInstance.prisma.examEnvironmentExamAttempt.deleteMany(\n+        {}\n+      );\n+    });\n+    it(\"If this test fails and you've deliberately altered the schema, then increment the `version` field by 1\", async () => {\n+      await fastifyTestInstance.prisma.examEnvironmentExamAttempt.create({\n+        data: {\n+          examId: oid(),\n+          generatedExamId: oid(),\n+          questionSets: [\n+            {\n+              id: oid(),\n+              questions: [\n+                { answers: [oid()], id: oid(), submissionTimeInMS: 0 }\n+              ]\n+            }\n+          ],\n+          startTimeInMS: 0,\n+          userId: oid()\n+        }\n+      });\n+    });\n+  });\n+});"
        },
        {
            "sha": "df02b3b976898cb2affa6068e514b03c14e980ca",
            "filename": "api/src/exam-environment/utils/exam-environment.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6adc98a42674754430267dc550affc9b4b737154/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6adc98a42674754430267dc550affc9b4b737154/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam-environment.ts?ref=6adc98a42674754430267dc550affc9b4b737154",
            "patch": "@@ -41,7 +41,7 @@ export function checkPrerequisites(\n \n export type UserExam = Omit<\n   ExamEnvironmentExam,\n-  'questionSets' | 'config' | 'id' | 'prerequisites' | 'deprecated'\n+  'questionSets' | 'config' | 'id' | 'prerequisites' | 'deprecated' | 'version'\n > & {\n   config: Omit<ExamEnvironmentExam['config'], 'tags' | 'questionSets'>;\n   questionSets: (Omit<ExamEnvironmentQuestionSet, 'questions'> & {\n@@ -280,7 +280,7 @@ export function userAttemptToDatabaseAttemptQuestionSets(\n  */\n export function generateExam(\n   exam: ExamEnvironmentExam\n-): Omit<ExamEnvironmentGeneratedExam, 'id'> {\n+): Omit<ExamEnvironmentGeneratedExam, 'id' | 'version'> {\n   const examCopy = structuredClone(exam);\n \n   const TIMEOUT_IN_MS = 5_000;"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 144,
        "deletions": 8
    }
}