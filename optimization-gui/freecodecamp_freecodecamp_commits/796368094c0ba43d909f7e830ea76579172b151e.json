{
    "author": "ojeytonwilliams",
    "message": "fix(client): retain editableContents through reload (#59573)",
    "sha": "796368094c0ba43d909f7e830ea76579172b151e",
    "files": [
        {
            "sha": "076370fd9822808ea2dd1106896539353c19da7e",
            "filename": "client/src/templates/Challenges/classic/editor.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx?ref=796368094c0ba43d909f7e830ea76579172b151e",
            "patch": "@@ -108,7 +108,7 @@ export interface EditorProps {\n   previewOpen: boolean;\n   updateFile: (object: {\n     fileKey: string;\n-    editorValue: string;\n+    contents: string;\n     editableRegionBoundaries?: number[];\n   }) => void;\n   usesMultifileEditor: boolean;\n@@ -846,7 +846,7 @@ const Editor = (props: EditorProps): JSX.Element => {\n     }\n   }\n \n-  const onChange = (editorValue: string) => {\n+  const onChange = (contents: string) => {\n     const { updateFile, fileKey, isResetting } = props;\n     if (isResetting) return;\n     // TODO: now that we have getCurrentEditableRegion, should the overlays\n@@ -873,7 +873,7 @@ const Editor = (props: EditorProps): JSX.Element => {\n         }\n       });\n     }\n-    updateFile({ fileKey, editorValue, editableRegionBoundaries });\n+    updateFile({ fileKey, contents, editableRegionBoundaries });\n   };\n \n   function createBreadcrumb(): HTMLElement {"
        },
        {
            "sha": "05d00c4bf99a94d82322535cb60209979bf98061",
            "filename": "client/src/templates/Challenges/redux/action-types.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Faction-types.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Faction-types.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Faction-types.js?ref=796368094c0ba43d909f7e830ea76579172b151e",
            "patch": "@@ -23,7 +23,6 @@ export const actionTypes = createTypes(\n     'cancelTests',\n     'logsToConsole',\n     'disableBuildOnError',\n-    'storedCodeFound',\n     'noStoredCodeFound',\n     'saveEditorContent',\n     'setShowPreviewPane',"
        },
        {
            "sha": "5ee494c278ea02ecd3e8ea44315ed7cf8eb99163",
            "filename": "client/src/templates/Challenges/redux/actions.js",
            "status": "modified",
            "additions": 1,
            "deletions": 18,
            "changes": 19,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Factions.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Factions.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Factions.js?ref=796368094c0ba43d909f7e830ea76579172b151e",
            "patch": "@@ -1,24 +1,8 @@\n import { createAction } from 'redux-actions';\n \n-import { getLines } from '../../../../../shared/utils/get-lines';\n import { actionTypes } from './action-types';\n \n-export const createFiles = createAction(\n-  actionTypes.createFiles,\n-  challengeFiles =>\n-    challengeFiles.map(challengeFile => ({\n-      ...challengeFile,\n-      seed: challengeFile.contents.slice(),\n-      editableContents: getLines(\n-        challengeFile.contents,\n-        challengeFile.editableRegionBoundaries\n-      ),\n-      editableRegionBoundaries:\n-        challengeFile.editableRegionBoundaries?.slice() ?? [],\n-      seedEditableRegionBoundaries:\n-        challengeFile.editableRegionBoundaries?.slice() ?? []\n-    }))\n-);\n+export const createFiles = createAction(actionTypes.createFiles);\n \n export const createQuestion = createAction(actionTypes.createQuestion);\n export const initTests = createAction(actionTypes.initTests);\n@@ -50,7 +34,6 @@ export const logsToConsole = createAction(actionTypes.logsToConsole);\n export const disableBuildOnError = createAction(\n   actionTypes.disableBuildOnError\n );\n-export const storedCodeFound = createAction(actionTypes.storedCodeFound);\n export const noStoredCodeFound = createAction(actionTypes.noStoredCodeFound);\n export const saveEditorContent = createAction(actionTypes.saveEditorContent);\n export const setIsAdvancing = createAction(actionTypes.setIsAdvancing);"
        },
        {
            "sha": "583dded90b95363839fa2a7f14eeebb6e5806af8",
            "filename": "client/src/templates/Challenges/redux/code-storage-epic.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcode-storage-epic.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcode-storage-epic.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcode-storage-epic.js?ref=796368094c0ba43d909f7e830ea76579172b151e",
            "patch": "@@ -9,7 +9,7 @@ import { FlashMessages } from '../../../components/Flash/redux/flash-messages';\n import { savedChallengesSelector } from '../../../redux/selectors';\n import { actionTypes as appTypes } from '../../../redux/action-types';\n import { actionTypes } from './action-types';\n-import { noStoredCodeFound, storedCodeFound } from './actions';\n+import { noStoredCodeFound, updateFile } from './actions';\n import { challengeFilesSelector, challengeMetaSelector } from './selectors';\n \n const legacyPrefixes = [\n@@ -200,7 +200,9 @@ function loadCodeEpic(action$, state$) {\n         }\n       }\n       if (finalFiles) {\n-        return of(storedCodeFound(finalFiles));\n+        // update the contents, rather than replacing the entire file, so that\n+        // we do not lose the seed values.\n+        return of(...finalFiles.map(file => updateFile(file)));\n       }\n       return of(noStoredCodeFound());\n     })"
        },
        {
            "sha": "6b74d5e4bed8915e36b05187a318b17940229ce2",
            "filename": "client/src/templates/Challenges/redux/index.js",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Findex.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/796368094c0ba43d909f7e830ea76579172b151e/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Findex.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Findex.js?ref=796368094c0ba43d909f7e830ea76579172b151e",
            "patch": "@@ -2,7 +2,6 @@ import { isEmpty } from 'lodash-es';\n import { handleActions } from 'redux-actions';\n \n import { getLines } from '../../../../../shared/utils/get-lines';\n-import { mergeChallengeFiles } from '../classic/saved-challenges';\n import { getTargetEditor } from '../utils/get-target-editor';\n import { actionTypes, ns } from './action-types';\n import codeStorageEpic from './code-storage-epic';\n@@ -84,23 +83,31 @@ export const reducer = handleActions(\n     }),\n     [actionTypes.createFiles]: (state, { payload }) => ({\n       ...state,\n-      challengeFiles: payload\n+      challengeFiles: payload.map(challengeFile => ({\n+        ...challengeFile,\n+        seed: challengeFile.contents.slice(),\n+        editableContents: getLines(\n+          challengeFile.contents,\n+          challengeFile.editableRegionBoundaries\n+        ),\n+        editableRegionBoundaries:\n+          challengeFile.editableRegionBoundaries?.slice() ?? [],\n+        seedEditableRegionBoundaries:\n+          challengeFile.editableRegionBoundaries?.slice() ?? []\n+      }))\n     }),\n     [actionTypes.updateFile]: (\n       state,\n-      { payload: { fileKey, editorValue, editableRegionBoundaries } }\n+      { payload: { fileKey, contents, editableRegionBoundaries } }\n     ) => {\n       const updates = {};\n       // if a given part of the payload is null, we leave that part of the state\n       // unchanged\n       if (editableRegionBoundaries !== null)\n         updates.editableRegionBoundaries = editableRegionBoundaries;\n-      if (editorValue !== null) updates.contents = editorValue;\n-      if (editableRegionBoundaries !== null && editorValue !== null)\n-        updates.editableContents = getLines(\n-          editorValue,\n-          editableRegionBoundaries\n-        );\n+      if (contents !== null) updates.contents = contents;\n+      if (editableRegionBoundaries !== null && contents !== null)\n+        updates.editableContents = getLines(contents, editableRegionBoundaries);\n       return {\n         ...state,\n         challengeFiles: state.challengeFiles.map(challengeFile =>\n@@ -111,12 +118,6 @@ export const reducer = handleActions(\n         isBuildEnabled: true\n       };\n     },\n-    [actionTypes.storedCodeFound]: (state, { payload }) => ({\n-      ...state,\n-      challengeFiles: state.challengeFiles.length\n-        ? mergeChallengeFiles(state.challengeFiles, payload)\n-        : payload\n-    }),\n     [actionTypes.initTests]: (state, { payload }) => ({\n       ...state,\n       challengeTests: payload"
        },
        {
            "sha": "a23b3d0cc5b1a9faf5a06c9c5b399524d1549bd3",
            "filename": "e2e/challenge.spec.ts",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/796368094c0ba43d909f7e830ea76579172b151e/e2e%2Fchallenge.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/796368094c0ba43d909f7e830ea76579172b151e/e2e%2Fchallenge.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fchallenge.spec.ts?ref=796368094c0ba43d909f7e830ea76579172b151e",
            "patch": "@@ -0,0 +1,47 @@\n+import { test, expect } from '@playwright/test';\n+\n+import translations from '../client/i18n/locales/english/translations.json';\n+import { clearEditor, focusEditor, getEditors } from './utils/editor';\n+\n+test.describe('when reloading the page', () => {\n+  test.beforeEach(async ({ page }) => {\n+    const pageUsingEditableRegionInTests =\n+      '/learn/2022/responsive-web-design/learn-basic-css-by-building-a-cafe-menu/step-14';\n+    await page.goto(pageUsingEditableRegionInTests);\n+  });\n+  // This is quite brittle. If it breaks, try to come up with a unit test instead.\n+\n+  test('should keep the editable content for testing', async ({\n+    page,\n+    isMobile,\n+    browserName\n+  }) => {\n+    await focusEditor({ page, isMobile });\n+    await clearEditor({ page, browserName });\n+    // For some reason, fill doesn't work properly on firefox if there are new lines\n+    // in the text, hence one line:\n+    const solution = `h1, h2, p { text-align: center; }`;\n+\n+    await getEditors(page).fill(solution);\n+    const editorTextLocator = page\n+      .getByTestId('editor-container-stylescss')\n+      .getByText(solution);\n+    await expect(editorTextLocator).toBeVisible();\n+\n+    // save the code\n+    await page.keyboard.down('Control');\n+    await page.keyboard.press('S');\n+\n+    await page.reload();\n+\n+    await expect(editorTextLocator).toBeVisible();\n+\n+    // check the tests pass\n+    await page.keyboard.down('Control');\n+    await page.keyboard.press('Enter');\n+\n+    await expect(\n+      page.getByText(translations.learn.congratulations)\n+    ).toBeVisible();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 110,
        "additions": 71,
        "deletions": 39
    }
}