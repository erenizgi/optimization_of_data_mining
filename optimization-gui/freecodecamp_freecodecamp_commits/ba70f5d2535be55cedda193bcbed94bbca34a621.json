{
    "author": "huyenltnguyen",
    "message": "feat(api): add /submit-quiz-attempt endpoint (#57201)",
    "sha": "ba70f5d2535be55cedda193bcbed94bbca34a621",
    "files": [
        {
            "sha": "d31ac2e1de045aabddd79b5dec035cac33b6d46d",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -69,13 +69,20 @@ type SavedChallenge {\n   lastSavedDate Float\n }\n \n+type QuizAttempt {\n+  challengeId String\n+  quizId      String\n+  timestamp   Float\n+}\n+\n /// Corresponds to the `user` collection.\n model user {\n   id                           String                        @id @default(auto()) @map(\"_id\") @db.ObjectId\n   about                        String\n   acceptedPrivacyTerms         Boolean\n   completedChallenges          CompletedChallenge[]\n   completedExams               CompletedExam[] // Undefined\n+  quizAttempts                 QuizAttempt[] // Undefined\n   currentChallengeId           String?\n   donationEmails               String[] // Undefined | String[] (only possible for built in Types like String)\n   email                        String"
        },
        {
            "sha": "d41de813934388b335880900a15a91796093794d",
            "filename": "api/src/plugins/__fixtures__/user.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fplugins%2F__fixtures__%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fplugins%2F__fixtures__%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2F__fixtures__%2Fuser.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -12,6 +12,7 @@ export const newUser = (email: string) => ({\n   acceptedPrivacyTerms: false,\n   completedChallenges: [],\n   completedExams: [],\n+  quizAttempts: [],\n   currentChallengeId: '',\n   donationEmails: [],\n   email,"
        },
        {
            "sha": "e4ad65b7feddbb0459b2801590936581399c2c1c",
            "filename": "api/src/routes/protected/challenge.test.ts",
            "status": "modified",
            "additions": 140,
            "deletions": 0,
            "changes": 140,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.test.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -35,6 +35,9 @@ import {\n import { Answer } from '../../utils/exam-types';\n import type { getSessionUser } from '../../schemas/user/get-session-user';\n \n+const EXISTING_COMPLETED_DATE = new Date('2024-11-08').getTime();\n+const DATE_NOW = Date.now();\n+\n jest.mock('../helpers/challenge-helpers', () => {\n   const originalModule = jest.requireActual<\n     typeof import('../helpers/challenge-helpers')\n@@ -1676,6 +1679,143 @@ describe('challengeRoutes', () => {\n         });\n       });\n     });\n+\n+    describe('/submit-quiz-attempt', () => {\n+      describe('validation', () => {\n+        test('POST rejects requests without challengeId', async () => {\n+          const response = await superPost('/submit-quiz-attempt').send({\n+            quizId: 'id'\n+          });\n+\n+          expect(response.body).toStrictEqual({\n+            type: 'error',\n+            message:\n+              'That does not appear to be a valid quiz attempt submission.'\n+          });\n+          expect(response.statusCode).toBe(400);\n+        });\n+\n+        test('POST rejects requests without quizId', async () => {\n+          const response = await superPost('/submit-quiz-attempt').send({\n+            challengeId: '66df3b712c41c499e9d31e5b'\n+          });\n+\n+          expect(response.body).toStrictEqual({\n+            type: 'error',\n+            message:\n+              'That does not appear to be a valid quiz attempt submission.'\n+          });\n+          expect(response.statusCode).toBe(400);\n+        });\n+\n+        test('POST rejects requests without valid ObjectID', async () => {\n+          const response = await superPost('/submit-quiz-attempt').send({\n+            challengeId: 'not-a-valid-id'\n+          });\n+\n+          expect(response.body).toStrictEqual({\n+            type: 'error',\n+            message:\n+              'That does not appear to be a valid quiz attempt submission.'\n+          });\n+          expect(response.statusCode).toBe(400);\n+        });\n+      });\n+\n+      describe('handling', () => {\n+        beforeAll(() => {\n+          jest.useFakeTimers({\n+            doNotFake: ['nextTick']\n+          });\n+          jest.setSystemTime(DATE_NOW);\n+        });\n+\n+        afterAll(() => {\n+          jest.useRealTimers();\n+        });\n+\n+        afterEach(async () => {\n+          await fastifyTestInstance.prisma.user.updateMany({\n+            where: { email: 'foo@bar.com' },\n+            data: {\n+              completedChallenges: [],\n+              quizAttempts: []\n+            }\n+          });\n+        });\n+\n+        test('POST adds new attempt to quizAttempts', async () => {\n+          const response = await superPost('/submit-quiz-attempt').send({\n+            challengeId: '66df3b712c41c499e9d31e5b',\n+            quizId: '0'\n+          });\n+\n+          const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+            where: { email: 'foo@bar.com' }\n+          });\n+\n+          expect(user).toMatchObject({\n+            quizAttempts: [\n+              {\n+                challengeId: '66df3b712c41c499e9d31e5b',\n+                quizId: '0',\n+                timestamp: DATE_NOW\n+              }\n+            ]\n+          });\n+\n+          expect(response.statusCode).toBe(200);\n+          expect(response.body).toStrictEqual({});\n+        });\n+\n+        test('POST updates the timestamp of the existing attempt', async () => {\n+          await fastifyTestInstance.prisma.user.updateMany({\n+            where: { id: defaultUserId },\n+            data: {\n+              quizAttempts: [\n+                {\n+                  challengeId: '66df3b712c41c499e9d31e5b', // quiz-basic-html\n+                  quizId: '0',\n+                  timestamp: EXISTING_COMPLETED_DATE\n+                },\n+                {\n+                  challengeId: '66ed903cf45ce3ece4053ebe', // quiz-semantic-html\n+                  quizId: '1',\n+                  timestamp: EXISTING_COMPLETED_DATE\n+                }\n+              ]\n+            }\n+          });\n+\n+          const response = await superPost('/submit-quiz-attempt').send({\n+            challengeId: '66df3b712c41c499e9d31e5b',\n+            quizId: '1'\n+          });\n+\n+          const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n+            where: { email: 'foo@bar.com' }\n+          });\n+\n+          expect(user).toMatchObject({\n+            quizAttempts: [\n+              {\n+                challengeId: '66df3b712c41c499e9d31e5b',\n+                quizId: '1',\n+                timestamp: DATE_NOW\n+              },\n+              {\n+                challengeId: '66ed903cf45ce3ece4053ebe',\n+                quizId: '1',\n+                timestamp: EXISTING_COMPLETED_DATE\n+              }\n+            ]\n+          });\n+\n+          expect(response.statusCode).toBe(200);\n+          expect(response.body).toStrictEqual({});\n+        });\n+      });\n+    });\n   });\n \n   describe('Unauthenticated user', () => {"
        },
        {
            "sha": "829b225e20cececf35bce60a6cf60514c4c79110",
            "filename": "api/src/routes/protected/challenge.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fchallenge.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -1,6 +1,6 @@\n import { type FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n import jwt from 'jsonwebtoken';\n-import { uniqBy } from 'lodash';\n+import { uniqBy, matches } from 'lodash';\n import { CompletedExam, ExamResults } from '@prisma/client';\n import isURL from 'validator/lib/isURL';\n \n@@ -776,5 +776,56 @@ export const challengeRoutes: FastifyPluginCallbackTypebox = (\n     }\n   );\n \n+  fastify.post(\n+    '/submit-quiz-attempt',\n+    {\n+      schema: schemas.submitQuizAttempt,\n+      errorHandler(error, request, reply) {\n+        if (error.validation) {\n+          void reply.code(400);\n+          void reply.send({\n+            type: 'error',\n+            message:\n+              'That does not appear to be a valid quiz attempt submission.'\n+          });\n+        } else {\n+          fastify.errorHandler(error, request, reply);\n+        }\n+      }\n+    },\n+    async req => {\n+      const { challengeId, quizId } = req.body;\n+\n+      const user = await fastify.prisma.user.findUniqueOrThrow({\n+        where: { id: req.user?.id },\n+        select: {\n+          id: true,\n+          quizAttempts: true\n+        }\n+      });\n+\n+      const existingAttempt = user.quizAttempts.find(matches({ challengeId }));\n+\n+      const newAttempt = {\n+        challengeId,\n+        quizId,\n+        timestamp: Date.now()\n+      };\n+\n+      await fastify.prisma.user.update({\n+        where: { id: user.id },\n+        data: {\n+          quizAttempts: existingAttempt\n+            ? {\n+                updateMany: { where: { challengeId }, data: newAttempt }\n+              }\n+            : { push: newAttempt }\n+        }\n+      });\n+\n+      return {};\n+    }\n+  );\n+\n   done();\n };"
        },
        {
            "sha": "e8f068ae65d74f1600d9301a62de3974f0acede8",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -78,6 +78,13 @@ const testUserData: Prisma.userCreateInput = {\n   ],\n   partiallyCompletedChallenges: [{ id: '123', completedDate: 123 }],\n   completedExams: [],\n+  quizAttempts: [\n+    {\n+      challengeId: '66df3b712c41c499e9d31e5b',\n+      quizId: '0',\n+      timestamp: 1731924665902\n+    }\n+  ],\n   githubProfile: 'github.com/foobar',\n   website: 'https://www.freecodecamp.org',\n   donationEmails: ['an@add.ress'],\n@@ -211,6 +218,7 @@ const publicUserData = {\n   ],\n   completedExams: testUserData.completedExams,\n   completedSurveys: [], // TODO: add surveys\n+  quizAttempts: testUserData.quizAttempts,\n   githubProfile: testUserData.githubProfile,\n   is2018DataVisCert: testUserData.is2018DataVisCert,\n   is2018FullStackCert: testUserData.is2018FullStackCert, // TODO: should this be returned? The client doesn't use it at the moment.\n@@ -717,6 +725,7 @@ describe('userRoutes', () => {\n           partiallyCompletedChallenges: [],\n           portfolio: [],\n           savedChallenges: [],\n+          quizAttempts: [],\n           yearsTopContributor: [],\n           is2018DataVisCert: false,\n           is2018FullStackCert: false,"
        },
        {
            "sha": "adb063d97eb721ddef872f379f37f5ace4cb1b24",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -449,6 +449,7 @@ export const userGetRoutes: FastifyPluginCallbackTypebox = (\n             completedChallenges: true,\n             completedExams: true,\n             currentChallengeId: true,\n+            quizAttempts: true,\n             email: true,\n             emailVerified: true,\n             githubProfile: true,"
        },
        {
            "sha": "78ac4034d22371da32c723042edf464f005104de",
            "filename": "api/src/schemas.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fschemas.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fschemas.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -10,6 +10,7 @@ export { modernChallengeCompleted } from './schemas/challenge/modern-challenge-c\n export { msTrophyChallengeCompleted } from './schemas/challenge/ms-trophy-challenge-completed';\n export { projectCompleted } from './schemas/challenge/project-completed';\n export { saveChallenge } from './schemas/challenge/save-challenge';\n+export { submitQuizAttempt } from './schemas/challenge/submit-quiz-attempt';\n export { deprecatedEndpoints } from './schemas/deprecated';\n export { addDonation } from './schemas/donate/add-donation';\n export { chargeStripeCard } from './schemas/donate/charge-stripe-card';"
        },
        {
            "sha": "07ed7e1bf492785e1295732db8cc0df0b9476fd2",
            "filename": "api/src/schemas/challenge/submit-quiz-attempt.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fschemas%2Fchallenge%2Fsubmit-quiz-attempt.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fschemas%2Fchallenge%2Fsubmit-quiz-attempt.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fchallenge%2Fsubmit-quiz-attempt.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -0,0 +1,23 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+import { genericError } from '../types';\n+\n+export const submitQuizAttempt = {\n+  body: Type.Object({\n+    challengeId: Type.String({\n+      format: 'objectid',\n+      maxLength: 24,\n+      minLength: 24\n+    }),\n+    quizId: Type.String()\n+  }),\n+  response: {\n+    200: Type.Object({}),\n+    400: Type.Object({\n+      type: Type.Literal('error'),\n+      message: Type.Literal(\n+        'That does not appear to be a valid quiz attempt submission.'\n+      )\n+    }),\n+    default: genericError\n+  }\n+};"
        },
        {
            "sha": "fcab27ca7cfca79d45c18e234a256a5c930e4540",
            "filename": "api/src/schemas/user/get-session-user.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fschemas%2Fuser%2Fget-session-user.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ba70f5d2535be55cedda193bcbed94bbca34a621/api%2Fsrc%2Fschemas%2Fuser%2Fget-session-user.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fuser%2Fget-session-user.ts?ref=ba70f5d2535be55cedda193bcbed94bbca34a621",
            "patch": "@@ -41,6 +41,17 @@ export const getSessionUser = {\n               examResults\n             })\n           ),\n+          quizAttempts: Type.Array(\n+            Type.Object({\n+              challengeId: Type.String({\n+                format: 'objectid',\n+                maxLength: 24,\n+                minLength: 24\n+              }),\n+              quizId: Type.String(),\n+              timestamp: Type.Number()\n+            })\n+          ),\n           completedChallengeCount: Type.Number(),\n           currentChallengeId: Type.String(),\n           email: Type.String(),"
        }
    ],
    "stats": {
        "total": 246,
        "additions": 245,
        "deletions": 1
    }
}