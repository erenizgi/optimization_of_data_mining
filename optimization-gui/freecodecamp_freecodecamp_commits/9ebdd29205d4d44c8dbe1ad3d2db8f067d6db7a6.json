{
    "author": "huyenltnguyen",
    "message": "feat(challenge-parser): add validateSections plugin (#61148)",
    "sha": "9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6",
    "files": [
        {
            "sha": "231f15d38eb8e067134d762623534b4adaf298c3",
            "filename": "tools/challenge-parser/parser/index.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6/tools%2Fchallenge-parser%2Fparser%2Findex.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6/tools%2Fchallenge-parser%2Fparser%2Findex.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Findex.js?ref=9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6",
            "patch": "@@ -5,6 +5,7 @@ const { readSync } = require('to-vfile');\n const unified = require('unified');\n const addFillInTheBlank = require('./plugins/add-fill-in-the-blank');\n const addFrontmatter = require('./plugins/add-frontmatter');\n+const validateSections = require('./plugins/validate-sections');\n const addSeed = require('./plugins/add-seed');\n const addSolution = require('./plugins/add-solution');\n const addHooks = require('./plugins/add-hooks');\n@@ -32,6 +33,8 @@ const processor = unified()\n   .use(frontmatter, ['yaml'])\n   // extract the content from that 'yaml' node\n   .use(addFrontmatter)\n+  // validate all section markers before any plugin tries to extract sections\n+  .use(validateSections)\n   // Any imports will be replaced (in the tree) with\n   // the sub-tree of the target file. e.g.\n   // ::import{component=\"Script\" from=\"./file.path\" }"
        },
        {
            "sha": "d20aa0b9c2375c1c4d2394d54a521a94fb56d3c8",
            "filename": "tools/challenge-parser/parser/plugins/validate-sections.js",
            "status": "added",
            "additions": 126,
            "deletions": 0,
            "changes": 126,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fvalidate-sections.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fvalidate-sections.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fvalidate-sections.js?ref=9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6",
            "patch": "@@ -0,0 +1,126 @@\n+const { findAll } = require('./utils/find-all');\n+const { isMarker } = require('./utils/get-section');\n+\n+const VALID_MARKERS = [\n+  // Level 1\n+  '# --after-all--',\n+  '# --after-each--',\n+  '# --assignment--',\n+  '# --before-all--',\n+  '# --before-each--',\n+  '# --description--',\n+  '# --explanation--',\n+  '# --fillInTheBlank--',\n+  '# --hints--',\n+  '# --instructions--',\n+  '# --notes--',\n+  '# --questions--',\n+  '# --quizzes--',\n+  '# --scene--',\n+  '# --seed--',\n+  '# --solutions--',\n+  '# --transcript--',\n+\n+  // Level 2\n+  '## --answers--',\n+  '## --blanks--',\n+  '## --quiz--',\n+  '## --seed-contents--',\n+  '## --sentence--',\n+  '## --text--',\n+  '## --video-solution--',\n+  // TODO: Remove these two markers when https://github.com/freeCodeCamp/freeCodeCamp/issues/57107 is resolved\n+  '## --after-user-code--',\n+  '## --before-user-code--',\n+\n+  // Level 3\n+  '### --feedback--',\n+  '### --question--',\n+\n+  // Level 4\n+  '#### --answer--',\n+  '#### --distractors--',\n+  '#### --text--'\n+];\n+\n+// Special markers that should not be used as headings\n+const NON_HEADING_MARKERS = ['--fcc-editable-region--'];\n+\n+function validateSections() {\n+  function transformer(tree) {\n+    const allMarkers = findAll(tree, isMarker);\n+\n+    const invalidMarkerNames = [];\n+    const invalidHeadingLevels = [];\n+    const nonHeadingMarkersAsHeadings = [];\n+\n+    const errors = [];\n+\n+    for (const markerNode of allMarkers) {\n+      const markerValue = markerNode.children[0].value;\n+      const headingLevel = markerNode.depth;\n+      const fullMarker = '#'.repeat(headingLevel) + ' ' + markerValue;\n+\n+      if (NON_HEADING_MARKERS.includes(markerValue)) {\n+        nonHeadingMarkersAsHeadings.push(fullMarker);\n+        continue;\n+      }\n+\n+      if (!VALID_MARKERS.includes(fullMarker)) {\n+        const markerExistsAtAnyLevel = VALID_MARKERS.some(validMarker =>\n+          validMarker.endsWith(markerValue)\n+        );\n+\n+        if (markerExistsAtAnyLevel) {\n+          const validLevels = VALID_MARKERS.filter(validMarker =>\n+            validMarker.endsWith(markerValue)\n+          ).map(validMarker => validMarker.split(' ')[0]); // Extract the # symbols\n+\n+          invalidHeadingLevels.push({\n+            fullMarker,\n+            markerValue,\n+            validLevels\n+          });\n+        } else {\n+          invalidMarkerNames.push(markerValue);\n+        }\n+      }\n+    }\n+\n+    if (invalidMarkerNames.length > 0) {\n+      errors.push(\n+        `Invalid marker names: ${invalidMarkerNames.map(m => `\"${m}\"`).join(', ')}.`\n+      );\n+    }\n+\n+    if (nonHeadingMarkersAsHeadings.length > 0) {\n+      errors.push(\n+        `Non-heading markers should not be used as headings: ${nonHeadingMarkersAsHeadings.map(m => `\"${m}\"`).join(', ')}.`\n+      );\n+    }\n+\n+    if (invalidHeadingLevels.length > 0) {\n+      const levelErrors = invalidHeadingLevels.map(\n+        ({ fullMarker, markerValue, validLevels }) => {\n+          const validText =\n+            validLevels.length === 1\n+              ? `${validLevels[0]} ${markerValue}`\n+              : validLevels\n+                  .map(level => `${level} ${markerValue}`)\n+                  .join(' or ');\n+          return `\"${fullMarker}\" should be \"${validText}\"`;\n+        }\n+      );\n+\n+      errors.push(`Invalid heading levels: ${levelErrors.join(', ')}.`);\n+    }\n+\n+    if (errors.length > 0) {\n+      throw new Error(errors.join('\\n'));\n+    }\n+  }\n+\n+  return transformer;\n+}\n+\n+module.exports = validateSections;"
        },
        {
            "sha": "bc750848ce2ba23f78a57d2d224be012a5cf6b34",
            "filename": "tools/challenge-parser/parser/plugins/validate-sections.test.js",
            "status": "added",
            "additions": 248,
            "deletions": 0,
            "changes": 248,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fvalidate-sections.test.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fvalidate-sections.test.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-parser%2Fparser%2Fplugins%2Fvalidate-sections.test.js?ref=9ebdd29205d4d44c8dbe1ad3d2db8f067d6db7a6",
            "patch": "@@ -0,0 +1,248 @@\n+const unified = require('unified');\n+const remark = require('remark-parse');\n+const frontmatter = require('remark-frontmatter');\n+const addFrontmatter = require('./add-frontmatter');\n+const validateSections = require('./validate-sections');\n+\n+const processor = unified()\n+  .use(remark)\n+  .use(frontmatter, ['yaml'])\n+  .use(addFrontmatter)\n+  .use(validateSections);\n+\n+describe('validate-sections plugin', () => {\n+  it('should pass when all section markers are valid', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+# --after-all--\n+After all hook.\n+\n+# --after-each--\n+After each hook.\n+\n+# --assignment--\n+Assignment.\n+\n+# --before-all--\n+Before all hook.\n+\n+# --before-each--\n+Before each hook.\n+\n+# --description--\n+Text content.\n+\n+# --explanation--\n+Explanation.\n+\n+# --fillInTheBlank--\n+Fill in blank.\n+\n+# --hints--\n+Hints.\n+\n+# --instructions--\n+More text.\n+\n+# --notes--\n+Notes.\n+\n+# --questions--\n+Video questions.\n+\n+# --quizzes--\n+Quiz section.\n+\n+# --scene--\n+Scene content.\n+\n+# --seed--\n+Seed section.\n+\n+# --solutions--\n+Solutions.\n+\n+# --transcript--\n+Transcript.\n+\n+## --answers--\n+Answers.\n+\n+## --blanks--\n+Blanks.\n+\n+## --quiz--\n+Individual quiz.\n+\n+## --seed-contents--\n+Contents here.\n+\n+## --sentence--\n+Sentence.\n+\n+## --text--\n+Question text.\n+\n+## --video-solution--\n+Video solution.\n+\n+## --after-user-code--\n+After code.\n+\n+## --before-user-code--\n+Before code.\n+\n+### --feedback--\n+Feedback.\n+\n+### --question--\n+Quiz question.\n+\n+#### --answer--\n+Correct answer.\n+\n+#### --distractors--\n+Distractors.\n+\n+#### --text--\n+Question text.\n+\n+--fcc-editable-region--\n+Editable region.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).not.toThrow();\n+  });\n+\n+  it('should throw error for invalid marker names', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+# --descriptio--\n+Typo in marker name.\n+\n+# --instructionss--\n+Another typo.\n+\n+# -- instructions--\n+Another typo.\n+\n+# --feedback---\n+Another typo.\n+\n+# --invalid-marker--\n+Completely invalid marker.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).toThrow(\n+      'Invalid marker names: \"--descriptio--\", \"--instructionss--\", \"-- instructions--\", \"--feedback---\", \"--invalid-marker--\".'\n+    );\n+  });\n+\n+  it('should validate case-sensitive markers', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+# --INSTRUCTIONS--\n+Wrong case.\n+\n+# --Instructions--\n+Also wrong case.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).toThrow('Invalid marker names: \"--INSTRUCTIONS--\", \"--Instructions--\".');\n+  });\n+\n+  it('should throw error for correct marker at wrong heading level', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+## --instructions--\n+Instructions should be at level 1, not 2.\n+\n+### --seed-contents--\n+Seed contents should be at level 2, not 3.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).toThrow(\n+      'Invalid heading levels: \"## --instructions--\" should be \"# --instructions--\", \"### --seed-contents--\" should be \"## --seed-contents--\".'\n+    );\n+  });\n+\n+  it('should throw combined errors for invalid markers and wrong levels', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+## --instructions--\n+Wrong level.\n+\n+# --invalid-marker--\n+Invalid marker.\n+\n+### --seed-contents--\n+Wrong level.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).toThrow(\n+      'Invalid marker names: \"--invalid-marker--\".\\nInvalid heading levels: \"## --instructions--\" should be \"# --instructions--\", \"### --seed-contents--\" should be \"## --seed-contents--\".'\n+    );\n+  });\n+\n+  it('should throw error for fcc-editable-region when used as headings', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+# --fcc-editable-region--\n+This should not be a heading.\n+\n+## --fcc-editable-region--\n+This should also not be a heading.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).toThrow(\n+      'Non-heading markers should not be used as headings: \"# --fcc-editable-region--\", \"## --fcc-editable-region--\".'\n+    );\n+  });\n+\n+  it('should throw error for markers valid at multiple levels but used at an invalid level', () => {\n+    const file = `---\n+id: test\n+title: Test\n+---\n+\n+### --text--\n+This marker is valid at level 2 or level 4, but not at level 3.\n+`;\n+\n+    expect(() => {\n+      processor.runSync(processor.parse(file));\n+    }).toThrow(\n+      'Invalid heading levels: \"### --text--\" should be \"## --text-- or #### --text--\".'\n+    );\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 377,
        "additions": 377,
        "deletions": 0
    }
}