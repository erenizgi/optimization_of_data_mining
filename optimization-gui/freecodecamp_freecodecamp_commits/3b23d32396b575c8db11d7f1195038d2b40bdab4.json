{
    "author": "ojeytonwilliams",
    "message": "feat(client): import user's react file into html (#57184)\n\nCo-authored-by: moT01 <20648924+moT01@users.noreply.github.com>",
    "sha": "3b23d32396b575c8db11d7f1195038d2b40bdab4",
    "files": [
        {
            "sha": "86c60e044d6d312b78bab105a9cb70f72b20f8b5",
            "filename": "client/src/templates/Challenges/classic/multifile-editor.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3b23d32396b575c8db11d7f1195038d2b40bdab4/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Fmultifile-editor.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3b23d32396b575c8db11d7f1195038d2b40bdab4/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Fmultifile-editor.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Fmultifile-editor.tsx?ref=3b23d32396b575c8db11d7f1195038d2b40bdab4",
            "patch": "@@ -106,10 +106,10 @@ const MultifileEditor = (props: MultifileEditorProps) => {\n \n   const editorKeys = [];\n \n-  if (indexjsx) editorKeys.push('indexjsx');\n   if (indexhtml) editorKeys.push('indexhtml');\n   if (stylescss) editorKeys.push('stylescss');\n   if (scriptjs) editorKeys.push('scriptjs');\n+  if (indexjsx) editorKeys.push('indexjsx');\n   if (mainpy) editorKeys.push('mainpy');\n   if (indexts) editorKeys.push('indexts');\n "
        },
        {
            "sha": "b01c3a8a31baea3d1ae44330dff51ed6eb2695c6",
            "filename": "client/src/templates/Challenges/rechallenge/transformers.js",
            "status": "modified",
            "additions": 69,
            "deletions": 18,
            "changes": 87,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3b23d32396b575c8db11d7f1195038d2b40bdab4/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3b23d32396b575c8db11d7f1195038d2b40bdab4/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js?ref=3b23d32396b575c8db11d7f1195038d2b40bdab4",
            "patch": "@@ -28,6 +28,7 @@ const protectTimeout = 100;\n const testProtectTimeout = 1500;\n const loopsPerTimeoutCheck = 100;\n const testLoopsPerTimeoutCheck = 2000;\n+const MODULE_TRANSFORM_PLUGIN = 'transform-modules-umd';\n \n function loopProtectCB(line) {\n   console.log(\n@@ -132,6 +133,18 @@ const getJSXTranspiler = loopProtectOptions => async challengeFile => {\n   );\n };\n \n+const getJSXModuleTranspiler = loopProtectOptions => async challengeFile => {\n+  await loadBabel();\n+  await loadPresetReact();\n+  const baseOptions = getBabelOptions(presetsJSX, loopProtectOptions);\n+  const babelOptions = {\n+    ...baseOptions,\n+    plugins: [...baseOptions.plugins, MODULE_TRANSFORM_PLUGIN],\n+    moduleId: 'index' // TODO: this should be dynamic\n+  };\n+  return transformContents(babelTransformCode(babelOptions), challengeFile);\n+};\n+\n const getTSTranspiler = loopProtectOptions => async challengeFile => {\n   await loadBabel();\n   await checkTSServiceIsReady();\n@@ -147,7 +160,15 @@ const createTranspiler = loopProtectOptions => {\n     [testJS, getJSTranspiler(loopProtectOptions)],\n     [testJSX, getJSXTranspiler(loopProtectOptions)],\n     [testTypeScript, getTSTranspiler(loopProtectOptions)],\n-    [testHTML, transformHtml],\n+    [testHTML, getHtmlTranspiler({ useModules: false })],\n+    [stubTrue, identity]\n+  ]);\n+};\n+\n+const createModuleTransformer = loopProtectOptions => {\n+  return cond([\n+    [testJSX, getJSXModuleTranspiler(loopProtectOptions)],\n+    [testHTML, getHtmlTranspiler({ useModules: true })],\n     [stubTrue, identity]\n   ]);\n };\n@@ -186,7 +207,7 @@ async function transformSASS(documentElement) {\n   );\n }\n \n-async function transformScript(documentElement) {\n+async function transformScript(documentElement, { useModules }) {\n   await loadBabel();\n   await loadPresetEnv();\n   await loadPresetReact();\n@@ -196,12 +217,19 @@ async function transformScript(documentElement) {\n     // TODO: make the use of JSX conditional on more than just the script type.\n     // It should only be used for React challenges since it would be confusing\n     // for learners to see the results of a transformation they didn't ask for.\n-    const options = isBabel ? presetsJSX : presetsJS;\n+    const baseOptions = isBabel ? presetsJSX : presetsJS;\n \n-    if (isBabel) script.removeAttribute('type'); // otherwise the browser will ignore the script\n-    script.innerHTML = babelTransformCode(getBabelOptions(options))(\n-      script.innerHTML\n-    );\n+    const options = {\n+      ...baseOptions,\n+      ...(useModules && { plugins: [MODULE_TRANSFORM_PLUGIN] })\n+    };\n+\n+    // The type has to be removed, otherwise the browser will ignore the script.\n+    // However, if we're importing modules, the type will be removed when the\n+    // scripts are embedded in the HTML.\n+    if (isBabel && !useModules) script.removeAttribute('type');\n+\n+    script.innerHTML = babelTransformCode(options)(script.innerHTML);\n   });\n }\n \n@@ -222,6 +250,15 @@ export const embedFilesInHtml = async function (challengeFiles) {\n     const tsScript =\n       documentElement.querySelector('script[src=\"index.ts\"]') ??\n       documentElement.querySelector('script[src=\"./index.ts\"]');\n+\n+    const jsxScript =\n+      documentElement.querySelector(\n+        `script[data-plugins=\"${MODULE_TRANSFORM_PLUGIN}\"][type=\"text/babel\"][src=\"index.jsx\"]`\n+      ) ??\n+      documentElement.querySelector(\n+        `script[data-plugins=\"${MODULE_TRANSFORM_PLUGIN}\"][type=\"text/babel\"][src=\"./index.jsx\"]`\n+      );\n+\n     if (link) {\n       const style = contentDocument.createElement('style');\n       style.classList.add('fcc-injected-styles');\n@@ -242,6 +279,13 @@ export const embedFilesInHtml = async function (challengeFiles) {\n       tsScript.removeAttribute('src');\n       tsScript.setAttribute('data-src', 'index.ts');\n     }\n+    if (jsxScript) {\n+      jsxScript.innerHTML = indexJsx?.contents;\n+      jsxScript.removeAttribute('src');\n+      jsxScript.removeAttribute('type');\n+      jsxScript.setAttribute('data-src', 'index.jsx');\n+      jsxScript.setAttribute('data-type', 'text/babel');\n+    }\n     return documentElement.innerHTML;\n   };\n \n@@ -278,26 +322,33 @@ const parseAndTransform = async function (transform, contents) {\n   return await transform(newDoc.documentElement, newDoc);\n };\n \n-const transformHtml = async function (file) {\n-  const transform = async documentElement => {\n-    await Promise.all([\n-      transformSASS(documentElement),\n-      transformScript(documentElement)\n-    ]);\n-    return documentElement.innerHTML;\n+const getHtmlTranspiler = scriptOptions =>\n+  async function (file) {\n+    const transform = async documentElement => {\n+      await Promise.all([\n+        transformSASS(documentElement),\n+        transformScript(documentElement, scriptOptions)\n+      ]);\n+      return documentElement.innerHTML;\n+    };\n+\n+    const contents = await parseAndTransform(transform, file.contents);\n+    return transformContents(() => contents, file);\n   };\n \n-  const contents = await parseAndTransform(transform, file.contents);\n-  return transformContents(() => contents, file);\n-};\n-\n export const getTransformers = loopProtectOptions => [\n   createSource,\n   replaceNBSP,\n   createTranspiler(loopProtectOptions),\n   partial(compileHeadTail, '')\n ];\n \n+export const getMultifileJSXTransformers = loopProtectOptions => [\n+  createSource,\n+  replaceNBSP,\n+  createModuleTransformer(loopProtectOptions)\n+];\n+\n export const getPythonTransformers = () => [\n   createSource,\n   replaceNBSP,"
        },
        {
            "sha": "c39e703bef98d076a90cfca956861354f37d3b51",
            "filename": "client/src/templates/Challenges/utils/build.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3b23d32396b575c8db11d7f1195038d2b40bdab4/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3b23d32396b575c8db11d7f1195038d2b40bdab4/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts?ref=3b23d32396b575c8db11d7f1195038d2b40bdab4",
            "patch": "@@ -8,7 +8,8 @@ import { concatHtml } from '../rechallenge/builders';\n import {\n   getTransformers,\n   embedFilesInHtml,\n-  getPythonTransformers\n+  getPythonTransformers,\n+  getMultifileJSXTransformers\n } from '../rechallenge/transformers';\n import {\n   createTestFramer,\n@@ -227,11 +228,18 @@ export async function buildDOMChallenge(\n ): Promise<BuildResult> {\n   // TODO: make this required in the schema.\n   if (!challengeFiles) throw Error('No challenge files provided');\n-  const loadEnzyme = challengeFiles.some(\n+  const hasJsx = challengeFiles.some(\n     challengeFile => challengeFile.ext === 'jsx'\n   );\n+  const isMultifile = challengeFiles.length > 1;\n \n-  const pipeLine = composeFunctions(...getTransformers(options));\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  const transformers =\n+    isMultifile && hasJsx\n+      ? getMultifileJSXTransformers(options)\n+      : getTransformers(options);\n+\n+  const pipeLine = composeFunctions(...transformers);\n   const usesTestRunner = options?.usesTestRunner ?? false;\n   const finalFiles = await Promise.all(challengeFiles.map(pipeLine));\n   const error = finalFiles.find(({ error }) => error)?.error;\n@@ -257,7 +265,7 @@ export async function buildDOMChallenge(\n     challengeType: challengeTypes.html,\n     build: concatHtml(toBuild),\n     sources: buildSourceMap(embeddedFiles),\n-    loadEnzyme,\n+    loadEnzyme: hasJsx,\n     error\n   };\n }"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 82,
        "deletions": 23
    }
}