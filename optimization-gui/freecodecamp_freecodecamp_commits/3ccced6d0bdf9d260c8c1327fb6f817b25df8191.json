{
    "author": "raisedadead",
    "message": "fix(GHA): Use Machine IP and add delay for latching (#59651)",
    "sha": "3ccced6d0bdf9d260c8c1327fb6f817b25df8191",
    "files": [
        {
            "sha": "bffa420b10bf0d6def7134eac368f55a4d1e2c4f",
            "filename": ".github/workflows/deploy-legacy.yml",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3ccced6d0bdf9d260c8c1327fb6f817b25df8191/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3ccced6d0bdf9d260c8c1327fb6f817b25df8191/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-legacy.yml?ref=3ccced6d0bdf9d260c8c1327fb6f817b25df8191",
            "patch": "@@ -80,11 +80,13 @@ jobs:\n             UserKnownHostsFile=/dev/null\n             StrictHostKeyChecking no\" > ~/.ssh/config\n           chmod 644 ~/.ssh/config\n-\n+          sleep 10\n           for i in {1..3}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-api-${i}\n-            tailscale status | grep -q \"$TS_MACHINE_NAME\"\n-            ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n+            tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Machine not found\"; exit 1; }\n+            sleep 1\n+            MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n+            ssh $TS_USERNAME@$MACHINE_IP \"uptime\"\n           done\n \n       - name: Deploy API\n@@ -134,7 +136,8 @@ jobs:\n               pm2 save\n               echo -e '\\nLOG:Finished deployment.'\n             \"\n-            ssh $TS_USERNAME@$TS_MACHINE_NAME \"$REMOTE_SCRIPT\"\n+            MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n+            ssh $TS_USERNAME@$MACHINE_IP \"$REMOTE_SCRIPT\"\n           done\n \n   client:\n@@ -251,11 +254,13 @@ jobs:\n             UserKnownHostsFile=/dev/null\n             StrictHostKeyChecking no\" > ~/.ssh/config\n           chmod 644 ~/.ssh/config\n-\n+          sleep 10\n           for i in {0..1}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-${{ matrix.lang-name-short }}-${i}\n-            tailscale status | grep -q \"$TS_MACHINE_NAME\"\n-            ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n+            tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Machine not found\"; exit 1; }\n+            sleep 1\n+            MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n+            ssh $TS_USERNAME@$MACHINE_IP \"uptime\"\n           done\n \n       - name: Upload and Deploy\n@@ -268,7 +273,8 @@ jobs:\n             CLIENT_BINARIES=${{needs.setup-jobs.outputs.tgt_env_short}}-release-$CURRENT_DATE-${{ github.run_id }}\n \n             echo -e \"\\nLOG:Uploading client archive to $TS_MACHINE_NAME...\"\n-            scp $CLIENT_SRC $TS_USERNAME@$TS_MACHINE_NAME:$CLIENT_DST\n+            MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n+            scp $CLIENT_SRC $TS_USERNAME@$MACHINE_IP:$CLIENT_DST\n \n             REMOTE_SCRIPT=\"\n               set -e\n@@ -318,5 +324,5 @@ jobs:\n \n               echo -e '\\nLOG:Finished deployment.'\n             \"\n-            ssh $TS_USERNAME@$TS_MACHINE_NAME \"$REMOTE_SCRIPT\"\n+            ssh $TS_USERNAME@$MACHINE_IP \"$REMOTE_SCRIPT\"\n           done"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 15,
        "deletions": 9
    }
}