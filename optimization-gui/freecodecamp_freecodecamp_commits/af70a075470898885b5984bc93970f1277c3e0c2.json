{
    "author": "a2937",
    "message": "feat(client): tsx compilation (#62236)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "af70a075470898885b5984bc93970f1277c3e0c2",
    "files": [
        {
            "sha": "2c6c4841e5efc2baf8696d0f7669145d3b8bbcd0",
            "filename": "client/.babelrc.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2F.babelrc.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2F.babelrc.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2F.babelrc.js?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -54,6 +54,7 @@ const config = {\n           'sql',\n           'svg',\n           'typescript',\n+          'tsx',\n           'xml'\n         ],\n         theme: 'default',"
        },
        {
            "sha": "bcd7ca4dbd505f160cc091b0a204f05a8741f123",
            "filename": "client/src/templates/Challenges/classic/editor.tsx",
            "status": "modified",
            "additions": 48,
            "deletions": 1,
            "changes": 49,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Feditor.tsx?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -1,5 +1,6 @@\n import * as ReactDOMServer from 'react-dom/server';\n import Loadable from '@loadable/component';\n+\n // eslint-disable-next-line import/no-duplicates\n import type * as monacoEditor from 'monaco-editor/esm/vs/editor/editor.api';\n import type {\n@@ -68,10 +69,18 @@ import { getScrollbarWidth } from '../../../utils/scrollbar-width';\n import { isProjectBased } from '../../../utils/curriculum-layout';\n import envConfig from '../../../../config/env.json';\n import LowerJaw from './lower-jaw';\n+// Direct from npm, license in react-types-licence\n+import reactTypes from './react-types.json';\n+\n import './editor.css';\n \n const MonacoEditor = Loadable(() => import('react-monaco-editor'));\n \n+const monacoModelFileMap = {\n+  tsxFile: 'index.tsx',\n+  reactTypes: 'react.d.ts'\n+};\n+\n export interface EditorProps {\n   attempts: number;\n   canFocus: boolean;\n@@ -353,15 +362,44 @@ const Editor = (props: EditorProps): JSX.Element => {\n     const { usesMultifileEditor = false } = props;\n \n     monacoRef.current = monaco;\n+    monaco.languages.typescript.typescriptDefaults.setCompilerOptions({\n+      ...monaco.languages.typescript.typescriptDefaults.getCompilerOptions(),\n+      jsx: monaco.languages.typescript.JsxEmit.Preserve,\n+      allowUmdGlobalAccess: true\n+    });\n+\n     defineMonacoThemes(monaco, { usesMultifileEditor });\n     // If a model is not provided, then the editor 'owns' the model it creates\n     // and will dispose of that model if it is replaced. Since we intend to\n     // swap and reuse models, we have to create our own models to prevent\n     // disposal.\n \n+    const setupTSModels = (monaco: typeof monacoEditor) => {\n+      const reactFile = monaco.Uri.file(monacoModelFileMap.reactTypes);\n+      monaco.editor.createModel(\n+        reactTypes['react-18'],\n+        'typescript',\n+        reactFile\n+      );\n+\n+      const file = monaco.Uri.file(monacoModelFileMap.tsxFile);\n+      return monaco.editor.createModel('', 'typescript', file);\n+    };\n+\n+    // TODO: make sure these aren't getting created over and over\n+    function createModel(contents: string, language: string) {\n+      if (language !== 'typescript') {\n+        return monaco.editor.createModel(contents, language);\n+      } else {\n+        const model = setupTSModels(monaco);\n+        model.setValue(contents);\n+        return model;\n+      }\n+    }\n+\n     const model =\n       dataRef.current.model ||\n-      monaco.editor.createModel(\n+      createModel(\n         challengeFile?.contents ?? '',\n         modeMap[challengeFile?.ext ?? 'html']\n       );\n@@ -1328,6 +1366,15 @@ const Editor = (props: EditorProps): JSX.Element => {\n         <MonacoEditor\n           editorDidMount={editorDidMount}\n           editorWillMount={editorWillMount}\n+          editorWillUnmount={(editor, monaco) => {\n+            const reactFile = monaco.Uri.file(monacoModelFileMap.reactTypes);\n+            const file = monaco.Uri.file(monacoModelFileMap.tsxFile);\n+            // Any model we've created has to be manually disposed of to prevent\n+            // memory leaks.\n+            editor.getModel()?.dispose();\n+            monaco.editor.getModel(reactFile)?.dispose();\n+            monaco.editor.getModel(file)?.dispose();\n+          }}\n           onChange={onChange}\n           options={{ ...options, folding: !hasEditableRegion() }}\n           theme={editorTheme}"
        },
        {
            "sha": "48ea6616b5b8581df3401872996cecf1f8b08a0d",
            "filename": "client/src/templates/Challenges/classic/react-types-license",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Freact-types-license",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Freact-types-license",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Freact-types-license?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -0,0 +1,21 @@\n+MIT License\n+\n+Copyright (c) Microsoft Corporation.\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy\n+of this software and associated documentation files (the \"Software\"), to deal\n+in the Software without restriction, including without limitation the rights\n+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+copies of the Software, and to permit persons to whom the Software is\n+furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all\n+copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+SOFTWARE"
        },
        {
            "sha": "c4e908a4c0efb6c2eb96d60d942b5549b23001a8",
            "filename": "client/src/templates/Challenges/classic/react-types.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Freact-types.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Freact-types.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fclassic%2Freact-types.json?ref=af70a075470898885b5984bc93970f1277c3e0c2"
        },
        {
            "sha": "200b5a81437977d3e37bbcdeb596ed33375e2bc7",
            "filename": "client/src/templates/Challenges/rechallenge/transformers.js",
            "status": "modified",
            "additions": 47,
            "deletions": 5,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Frechallenge%2Ftransformers.js?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -96,13 +96,20 @@ const NBSPReg = new RegExp(String.fromCharCode(160), 'g');\n \n const testJS = matchesProperty('ext', 'js');\n const testJSX = matchesProperty('ext', 'jsx');\n+const testTSX = matchesProperty('ext', 'tsx');\n const testTypeScript = matchesProperty('ext', 'ts');\n const testHTML = matchesProperty('ext', 'html');\n-const testHTML$JS$JSX$TS = overSome(testHTML, testJS, testJSX, testTypeScript);\n+const testHTML$JS$JSX$TS$TSX = overSome(\n+  testHTML,\n+  testJS,\n+  testJSX,\n+  testTypeScript,\n+  testTSX\n+);\n \n const replaceNBSP = cond([\n   [\n-    testHTML$JS$JSX$TS,\n+    testHTML$JS$JSX$TS$TSX,\n     partial(transformContents, contents => contents.replace(NBSPReg, ' '))\n   ],\n   [stubTrue, identity]\n@@ -150,6 +157,22 @@ const getTSTranspiler = loopProtectOptions => async challengeFile => {\n   )(challengeFile);\n };\n \n+const getTSXModuleTranspiler = loopProtectOptions => async challengeFile => {\n+  await loadBabel();\n+  await loadPresetReact();\n+  await checkTSServiceIsReady();\n+  const baseOptions = getBabelOptions(presetsJSX, loopProtectOptions);\n+  const babelOptions = {\n+    ...baseOptions,\n+    plugins: [...baseOptions.plugins, MODULE_TRANSFORM_PLUGIN],\n+    moduleId: 'index' // TODO: this should be dynamic\n+  };\n+  return flow(\n+    partial(transformHeadTailAndContents, compileTypeScriptCode),\n+    partial(transformHeadTailAndContents, babelTransformCode(babelOptions))\n+  )(challengeFile);\n+};\n+\n const createTranspiler = loopProtectOptions => {\n   return cond([\n     [testJS, getJSTranspiler(loopProtectOptions)],\n@@ -163,6 +186,7 @@ const createTranspiler = loopProtectOptions => {\n const createModuleTransformer = loopProtectOptions => {\n   return cond([\n     [testJSX, getJSXModuleTranspiler(loopProtectOptions)],\n+    [testTSX, getTSXModuleTranspiler(loopProtectOptions)],\n     [testHTML, getHtmlTranspiler({ useModules: true })],\n     [stubTrue, identity]\n   ]);\n@@ -242,7 +266,7 @@ async function transformScript(documentElement, { useModules }) {\n // This does the final transformations of the files needed to embed them into\n // HTML.\n export const embedFilesInHtml = async function (challengeFiles) {\n-  const { indexHtml, stylesCss, scriptJs, indexJsx, indexTs } =\n+  const { indexHtml, stylesCss, scriptJs, indexJsx, indexTs, indexTsx } =\n     challengeFilesToObject(challengeFiles);\n \n   const embedStylesAndScript = contentDocument => {\n@@ -266,6 +290,14 @@ export const embedFilesInHtml = async function (challengeFiles) {\n         `script[data-plugins=\"${MODULE_TRANSFORM_PLUGIN}\"][type=\"text/babel\"][src=\"./index.jsx\"]`\n       );\n \n+    const tsxScript =\n+      documentElement.querySelector(\n+        `script[data-plugins=\"${MODULE_TRANSFORM_PLUGIN}\"][type=\"text/babel\"][src=\"index.tsx\"]`\n+      ) ??\n+      documentElement.querySelector(\n+        `script[data-plugins=\"${MODULE_TRANSFORM_PLUGIN}\"][type=\"text/babel\"][src=\"./index.tsx\"]`\n+      );\n+\n     if (link) {\n       const style = contentDocument.createElement('style');\n       style.classList.add('fcc-injected-styles');\n@@ -293,6 +325,13 @@ export const embedFilesInHtml = async function (challengeFiles) {\n       jsxScript.setAttribute('data-src', 'index.jsx');\n       jsxScript.setAttribute('data-type', 'text/babel');\n     }\n+    if (tsxScript) {\n+      tsxScript.innerHTML = indexTsx?.contents;\n+      tsxScript.removeAttribute('src');\n+      tsxScript.removeAttribute('type');\n+      tsxScript.setAttribute('data-src', 'index.tsx');\n+      tsxScript.setAttribute('data-type', 'text/babel');\n+    }\n     return documentElement.innerHTML;\n   };\n \n@@ -308,8 +347,10 @@ export const embedFilesInHtml = async function (challengeFiles) {\n     return `<script>${scriptJs.contents}</script>`;\n   } else if (indexTs) {\n     return `<script>${indexTs.contents}</script>`;\n+  } else if (indexTsx) {\n+    return `<script>${indexTsx.contents}</script>`;\n   } else {\n-    throw Error('No html, ts or js(x) file found');\n+    throw Error('No html, ts(x) or js(x) file found');\n   }\n };\n \n@@ -319,7 +360,8 @@ function challengeFilesToObject(challengeFiles) {\n   const stylesCss = challengeFiles.find(file => file.fileKey === 'stylescss');\n   const scriptJs = challengeFiles.find(file => file.fileKey === 'scriptjs');\n   const indexTs = challengeFiles.find(file => file.fileKey === 'indexts');\n-  return { indexHtml, indexJsx, stylesCss, scriptJs, indexTs };\n+  const indexTsx = challengeFiles.find(file => file.fileKey === 'indextsx');\n+  return { indexHtml, indexJsx, stylesCss, scriptJs, indexTs, indexTsx };\n }\n \n const parseAndTransform = async function (transform, contents) {"
        },
        {
            "sha": "130e5a48d084d45995cadba66ef4e030c0b70f94",
            "filename": "client/src/templates/Challenges/utils/build.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Fbuild.ts?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -186,7 +186,7 @@ export async function buildDOMChallenge(\n   // TODO: make this required in the schema.\n   if (!challengeFiles) throw Error('No challenge files provided');\n   const hasJsx = challengeFiles.some(\n-    challengeFile => challengeFile.ext === 'jsx'\n+    challengeFile => challengeFile.ext === 'jsx' || challengeFile.ext === 'tsx'\n   );\n   const isMultifile = challengeFiles.length > 1;\n "
        },
        {
            "sha": "843f497591400e637d96a183fced3940ca127475",
            "filename": "client/src/templates/Challenges/utils/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Futils%2Findex.ts?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -52,7 +52,8 @@ export function enhancePrismAccessibility(\n     json: 'JSON',\n     pug: 'pug',\n     ts: 'TypeScript',\n-    typescript: 'TypeScript'\n+    typescript: 'TypeScript',\n+    tsx: 'TSX'\n   };\n   const parent = prismEnv?.element?.parentElement;\n   if ("
        },
        {
            "sha": "c4e908a4c0efb6c2eb96d60d942b5549b23001a8",
            "filename": "tools/client-plugins/browser-scripts/react-types.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/tools%2Fclient-plugins%2Fbrowser-scripts%2Freact-types.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/tools%2Fclient-plugins%2Fbrowser-scripts%2Freact-types.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Freact-types.json?ref=af70a075470898885b5984bc93970f1277c3e0c2"
        },
        {
            "sha": "2c6397d134f6289a3e26d7b95af5c5fac4f9c908",
            "filename": "tools/client-plugins/browser-scripts/typescript-worker.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 6,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/af70a075470898885b5984bc93970f1277c3e0c2/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftypescript-worker.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/af70a075470898885b5984bc93970f1277c3e0c2/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftypescript-worker.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fclient-plugins%2Fbrowser-scripts%2Ftypescript-worker.ts?ref=af70a075470898885b5984bc93970f1277c3e0c2",
            "patch": "@@ -1,5 +1,6 @@\n import { type VirtualTypeScriptEnvironment } from '@typescript/vfs';\n import type { CompilerOptions, CompilerHost } from 'typescript';\n+import reactTypes from './react-types.json';\n \n // Most of the ts types are only a guideline. This is because we're not bundling\n // TS in this worker. The specific TS version is going to be determined by the\n@@ -40,7 +41,7 @@ interface CancelEvent extends MessageEvent {\n }\n \n // Pin at the latest TS version available as cdnjs doesn't support version range.\n-const TS_VERSION = '5.7.3';\n+const TS_VERSION = '5.9.2';\n \n let tsEnv: VirtualTypeScriptEnvironment | null = null;\n let compilerHost: CompilerHost | null = null;\n@@ -54,7 +55,12 @@ importScripts(\n function importTS(version: string) {\n   if (cachedVersion == version) return;\n   importScripts(\n-    `https://cdnjs.cloudflare.com/ajax/libs/typescript/${version}/typescript.min.js`\n+    /*  typescript.min.js fails with\n+\n+    typescript.min.js:320 Uncaught TypeError: Class constructors cannot be invoked without 'new'\n+\n+    so we're using the non-minified version for now. */\n+    `https://cdnjs.cloudflare.com/ajax/libs/typescript/${version}/typescript.js`\n   );\n   cachedVersion = version;\n }\n@@ -63,10 +69,13 @@ async function setupTypeScript() {\n   importTS(TS_VERSION);\n   const compilerOptions: CompilerOptions = {\n     target: ts.ScriptTarget.ES2015,\n-    skipLibCheck: true // TODO: look into why this is needed. Are we doing something wrong? Could it be that it's not \"synced\"  with this TS version?\n+    module: ts.ModuleKind.Preserve, // Babel is handling module transformation, so TS should leave them alone.\n+    skipLibCheck: true, // TODO: look into why this is needed. Are we doing something wrong? Could it be that it's not \"synced\"  with this TS version?\n     // from the docs: \"Note: it's possible for this list to get out of\n     // sync with TypeScript over time. It was last synced with TypeScript\n     // 3.8.0-rc.\"\n+    jsx: ts.JsxEmit.Preserve, // Babel will handle JSX,\n+    allowUmdGlobalAccess: true // Necessary because React is loaded via a UMD script.\n   };\n   const fsMap = await createDefaultMapFromCDN(\n     compilerOptions,\n@@ -75,17 +84,24 @@ async function setupTypeScript() {\n     ts\n   );\n \n+  // This can be any path, but doing this means import React from 'react' works, if we ever need it.\n+  const reactTypesPath = `/node_modules/@types/react/index.d.ts`;\n+\n+  // It may be necessary to get all the types (global.d.ts etc)\n+  fsMap.set(reactTypesPath, reactTypes['react-18'] || '');\n+\n   const system = tsvfs.createSystem(fsMap);\n   // TODO: if passed an invalid compiler options object (e.g. { module:\n   // ts.ModuleKind.CommonJS, moduleResolution: ts.ModuleResolutionKind.NodeNext\n   // }), this will throw. When we allow users to set compiler options, we should\n   // show them the diagnostics from this function.\n   const env = tsvfs.createVirtualTypeScriptEnvironment(\n     system,\n-    [],\n+    [reactTypesPath],\n     ts,\n     compilerOptions\n   );\n+\n   compilerHost = createVirtualCompilerHost(\n     system,\n     compilerOptions,\n@@ -133,11 +149,12 @@ function handleCompileRequest(data: TSCompileEvent['data'], port: MessagePort) {\n \n   // TODO: If creating the file fresh each time is too slow, we can try checking\n   // if the file exists and updating it if it does.\n-  tsEnv?.createFile('index.ts', code);\n+  // TODO: make sure the .tsx extension doesn't cause issues with vanilla TS.\n+  tsEnv?.createFile('/index.tsx', code);\n \n   const program = tsEnv!.languageService.getProgram()!;\n \n-  const emitOutput = tsEnv!.languageService.getEmitOutput('index.ts');\n+  const emitOutput = tsEnv!.languageService.getEmitOutput('index.tsx');\n   const compiled = emitOutput.outputFiles[0].text;\n \n   const message: TSCompiledMessage = {"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 149,
        "deletions": 14
    }
}