{
    "author": "ojeytonwilliams",
    "message": "feat(api): GET /api/users/exists (#54875)",
    "sha": "8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
    "files": [
        {
            "sha": "6e843a647181ab6d6de2c9edd1d3cea799bb3b41",
            "filename": "api/src/routes/helpers/is-restricted.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fhelpers%2Fis-restricted.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fhelpers%2Fis-restricted.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fis-restricted.ts?ref=8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
            "patch": "@@ -0,0 +1,12 @@\n+import { isProfane } from 'no-profanity';\n+\n+import { blocklistedUsernames } from '../../../../shared/config/constants';\n+\n+/**\n+ * Checks if a username is restricted (i.e. It's profane or reserved).\n+ * @param username - The username to check.\n+ * @returns True if the username is restricted, false otherwise.\n+ */\n+export const isRestricted = (username: string): boolean => {\n+  return isProfane(username) || blocklistedUsernames.includes(username);\n+};"
        },
        {
            "sha": "44d975c844c4362047df0348153cd10bd281287a",
            "filename": "api/src/routes/settings.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fsettings.ts?ref=8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
            "patch": "@@ -14,13 +14,12 @@ import type {\n } from 'fastify';\n import { ResolveFastifyReplyType } from 'fastify/types/type-provider';\n import { differenceInMinutes } from 'date-fns';\n-import { isProfane } from 'no-profanity';\n \n-import { blocklistedUsernames } from '../../../shared/config/constants';\n import { isValidUsername } from '../../../shared/utils/validate';\n import * as schemas from '../schemas';\n import { createAuthToken } from '../utils/tokens';\n import { API_LOCATION } from '../utils/env';\n+import { isRestricted } from './helpers/is-restricted';\n \n type WaitMesssageArgs = {\n   sentAt: Date | null;\n@@ -401,17 +400,14 @@ ${isLinkSentWithinLimitTTL}`\n           });\n         }\n \n-        const isUserNameProfane = isProfane(newUsername);\n-        const onBlocklist = blocklistedUsernames.includes(newUsername);\n-\n         const usernameTaken =\n           newUsername === oldUsername\n             ? false\n             : await fastify.prisma.user.count({\n                 where: { username: newUsername }\n               });\n \n-        if (usernameTaken || isUserNameProfane || onBlocklist) {\n+        if (usernameTaken || isRestricted(newUsername)) {\n           void reply.code(400);\n           return reply.send({\n             message: 'flash.username-taken',"
        },
        {
            "sha": "bcf9dfac8d87596f700a2c593fcdc1ebdd5f0d0e",
            "filename": "api/src/routes/user.test.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.test.ts?ref=8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
            "patch": "@@ -1286,6 +1286,56 @@ Thanks and regards,\n         });\n       });\n     });\n+    describe('GET /api/users/exists', () => {\n+      beforeAll(async () => {\n+        await fastifyTestInstance.prisma.user.create({\n+          data: minimalUserData\n+        });\n+      });\n+\n+      it('should return { exists: true } with a 400 status code if the username param is missing or empty', async () => {\n+        const res = await superGet('/api/users/exists');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.statusCode).toBe(400);\n+\n+        const res2 = await superGet('/api/users/exists?username=');\n+\n+        expect(res2.body).toStrictEqual({ exists: true });\n+        expect(res2.statusCode).toBe(400);\n+      });\n+\n+      it('should return { exists: true } if the username exists', async () => {\n+        const res = await superGet('/api/users/exists?username=testuser');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.statusCode).toBe(200);\n+      });\n+\n+      it('should ignore case when checking for username existence', async () => {\n+        const res = await superGet('/api/users/exists?username=TeStUsEr');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.statusCode).toBe(200);\n+      });\n+\n+      it('should return { exists: false } if the username does not exist', async () => {\n+        const res = await superGet('/api/users/exists?username=nonexistent');\n+\n+        expect(res.body).toStrictEqual({ exists: false });\n+        expect(res.statusCode).toBe(200);\n+      });\n+\n+      it('should return { exists: true } if the username is restricted (ignoring case)', async () => {\n+        const res = await superGet('/api/users/exists?username=pRofIle');\n+\n+        expect(res.body).toStrictEqual({ exists: true });\n+\n+        const res2 = await superGet('/api/users/exists?username=flAnge');\n+\n+        expect(res2.body).toStrictEqual({ exists: true });\n+      });\n+    });\n   });\n });\n "
        },
        {
            "sha": "9e9d4a9e992248d4ca3ca84a914923931b4d48b1",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
            "patch": "@@ -27,6 +27,7 @@ import { trimTags } from '../utils/validation';\n import { generateReportEmail } from '../utils/email-templates';\n import { createResetProperties } from '../utils/create-user';\n import { challengeTypes } from '../../../shared/config/challenge-types';\n+import { isRestricted } from './helpers/is-restricted';\n \n // user flags that the api-server returns as false if they're missing in the\n // user document. Since Prisma returns null for missing fields, we need to\n@@ -786,5 +787,32 @@ export const userPublicGetRoutes: FastifyPluginCallbackTypebox = (\n     }\n   );\n \n+  fastify.get(\n+    '/api/users/exists',\n+    {\n+      schema: schemas.userExists,\n+      attachValidation: true\n+    },\n+    async (req, reply) => {\n+      if (req.validationError) {\n+        void reply.code(400);\n+        // TODO(Post-MVP): return a message telling the requester that their\n+        // request was malformed.\n+        return await reply.send({ exists: true });\n+      }\n+\n+      const username = req.query.username.toLowerCase();\n+\n+      if (isRestricted(username)) return await reply.send({ exists: true });\n+\n+      const exists =\n+        (await fastify.prisma.user.count({\n+          where: { username }\n+        })) > 0;\n+\n+      await reply.send({ exists });\n+    }\n+  );\n+\n   done();\n };"
        },
        {
            "sha": "d322e502fc1309756edf332e4ea31fb52be4a1fe",
            "filename": "api/src/schemas.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Fschemas.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Fschemas.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas.ts?ref=8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
            "patch": "@@ -1,4 +1,5 @@\n export { getPublicProfile } from './schemas/api/users/get-public-profile';\n+export { userExists } from './schemas/api/users/exists';\n export { certSlug } from './schemas/certificate/cert-slug';\n export { certificateVerify } from './schemas/certificate/certificate-verify';\n export { backendChallengeCompleted } from './schemas/challenge/backend-challenge-completed';"
        },
        {
            "sha": "0416d3ff28ec9837d2911fa1a147aa71121b4525",
            "filename": "api/src/schemas/api/users/exists.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Fschemas%2Fapi%2Fusers%2Fexists.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1/api%2Fsrc%2Fschemas%2Fapi%2Fusers%2Fexists.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fapi%2Fusers%2Fexists.ts?ref=8bcf080ad27314bd81b7df3ea287ae1cdde7a8a1",
            "patch": "@@ -0,0 +1,15 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+\n+export const userExists = {\n+  querystring: Type.Object({\n+    username: Type.String({ minLength: 1 })\n+  }),\n+  response: {\n+    200: Type.Object({\n+      exists: Type.Boolean()\n+    }),\n+    400: Type.Object({\n+      exists: Type.Literal(true)\n+    })\n+  }\n+};"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 108,
        "deletions": 6
    }
}