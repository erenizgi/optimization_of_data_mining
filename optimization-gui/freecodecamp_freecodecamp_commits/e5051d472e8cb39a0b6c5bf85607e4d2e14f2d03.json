{
    "author": "raisedadead",
    "message": "fix(GHA): update environment validation (#60011)",
    "sha": "e5051d472e8cb39a0b6c5bf85607e4d2e14f2d03",
    "files": [
        {
            "sha": "d821810813666f6c1a105f9b0a9cb8dd8c0c8411",
            "filename": ".github/workflows/deploy.yml",
            "status": "modified",
            "additions": 47,
            "deletions": 9,
            "changes": 56,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e5051d472e8cb39a0b6c5bf85607e4d2e14f2d03/.github%2Fworkflows%2Fdeploy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e5051d472e8cb39a0b6c5bf85607e4d2e14f2d03/.github%2Fworkflows%2Fdeploy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy.yml?ref=e5051d472e8cb39a0b6c5bf85607e4d2e14f2d03",
            "patch": "@@ -91,7 +91,7 @@ jobs:\n         env:\n           AGE_ENCRYPTED_ASC_SECRETS: ${{ secrets.AGE_ENCRYPTED_ASC_SECRETS }}\n           AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}\n-          # These are set in the \"Environment\" specifc secrets\n+          # Variable set from GitHub \"Environment\" secrets (AGE encrypted)\n           # DOCKER_REGISTRY\n           # MONGOHQ_URL\n           # SENTRY_DSN\n@@ -109,11 +109,13 @@ jobs:\n           # HOME_LOCATION\n           # API_LOCATION\n           # STRIPE_SECRET_KEY\n-          # These are set in the static job above\n-          STACK_NAME: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api\n+          # LOKI_URL\n+          # Variables set from SetupJob\n           DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n           DEPLOYMENT_ENV: ${{ needs.setup-jobs.outputs.site_tld }}\n           FCC_API_LOG_LEVEL: ${{ needs.setup-jobs.outputs.api_log_lvl }}\n+          # Stack name\n+          STACK_NAME: ${{ needs.setup-jobs.outputs.tgt_env_short }}-api\n         run: |\n           REMOTE_SCRIPT=\"\n             set -e\n@@ -151,29 +153,65 @@ jobs:\n             } >> .env\n \n             echo -e '\\nLOG:Sourcing environment...'\n+            REQUIRED_VARS=(\n+              \\\"DOCKER_REGISTRY\\\"\n+              \\\"MONGOHQ_URL\\\"\n+              \\\"SENTRY_DSN\\\"\n+              \\\"SENTRY_ENVIRONMENT\\\"\n+              \\\"AUTH0_CLIENT_ID\\\"\n+              \\\"AUTH0_CLIENT_SECRET\\\"\n+              \\\"AUTH0_DOMAIN\\\"\n+              \\\"JWT_SECRET\\\"\n+              \\\"COOKIE_SECRET\\\"\n+              \\\"COOKIE_DOMAIN\\\"\n+              \\\"SES_ID\\\"\n+              \\\"SES_SECRET\\\"\n+              \\\"GROWTHBOOK_FASTIFY_API_HOST\\\"\n+              \\\"GROWTHBOOK_FASTIFY_CLIENT_KEY\\\"\n+              \\\"HOME_LOCATION\\\"\n+              \\\"API_LOCATION\\\"\n+              \\\"STRIPE_SECRET_KEY\\\"\n+              \\\"LOKI_URL\\\"\n+              \\\"DEPLOYMENT_VERSION\\\"\n+              \\\"DEPLOYMENT_ENV\\\"\n+              \\\"FCC_API_LOG_LEVEL\\\"\n+            )\n+\n             while IFS='=' read -r key value; do\n               if [[ -n \\\"\\$key\\\" && ! \\\"\\$key\\\" =~ ^# ]]; then\n                 export \\\"\\${key}=\\${value}\\\"\n               fi\n             done < .env\n-            rm -rf .env\n \n-            echo -e '\\nLOG:Validating environment...'\n-            if [[ -z \\\"\\$DOCKER_REGISTRY\\\" || -z \\\"\\$DEPLOYMENT_ENV\\\" || -z \\\"\\$DEPLOYMENT_VERSION\\\" || -z \\\"\\$MONGOHQ_URL\\\" || -z \\\"\\$FCC_API_LOG_LEVEL\\\" ]]; then\n-              echo \\\"Error: Missing required environment variables\\\"\n+            MISSING_VARS=()\n+            for var in \\\"\\${REQUIRED_VARS[@]}\\\"; do\n+              if [[ -z \\\"\\${!var}\\\" ]]; then\n+                MISSING_VARS+=(\\\"\\$var\\\")\n+              fi\n+            done\n+\n+            if [[ \\${#MISSING_VARS[@]} -gt 0 ]]; then\n+              echo \\\"ERROR: The following required environment variables are missing or empty:\\\"\n+              for var in \\\"\\${MISSING_VARS[@]}\\\"; do\n+                echo \\\"  - \\$var\\\"\n+              done\n               exit 1\n             fi\n+\n+            rm -rf .env\n+\n+            echo -e '\\nLOG:Validating deployment version...'\n             if [[ \\\"\\$DEPLOYMENT_VERSION\\\" != \\\"$DEPLOYMENT_VERSION\\\" ]]; then\n               echo \\\"Error: Version mismatch. Expected: $DEPLOYMENT_VERSION, Got: \\$DEPLOYMENT_VERSION\\\"\n               exit 1\n             fi\n-            env | grep -E 'DOMAIN|DEPLOYMENT'\n+            env | grep -E 'DEPLOYMENT_VERSION'\n \n             echo -e '\\nLOG:Checking stack configuration...'\n             CONFIG_OUTPUT=\\\"/dev/null\\\"\n             if [[ \\\"\\$FCC_API_LOG_LEVEL\\\" == \\\"debug\\\" ]]; then\n               CONFIG_FILENAME=\\\"debug-docker-stack-config-\\${DEPLOYMENT_VERSION}.yml\\\"\n-              echo -e '\\nLOG:Saving stack configuration to \\$CONFIG_FILENAME for debugging...'\n+              echo -e '\\nLOG:Saving stack configuration for debugging...'\n               CONFIG_OUTPUT=\\\"\\$CONFIG_FILENAME\\\"\n             fi\n             docker stack config -c stack-api.yml > \\$CONFIG_OUTPUT"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 47,
        "deletions": 9
    }
}