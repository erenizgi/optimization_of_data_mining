{
    "author": "ShaunSHamilton",
    "message": "chore(api): add request/response shadow dev tool (#56628)",
    "sha": "7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b",
    "files": [
        {
            "sha": "b8450316fdd522c46aa81b593b9369ead4b37b92",
            "filename": ".gitignore",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/.gitignore",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/.gitignore",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.gitignore?ref=7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b",
            "patch": "@@ -210,3 +210,6 @@ curriculum/build\n ### Playwright ###\n \n /playwright\n+\n+### Shadow Testing Log Files Folder ###\n+api/logs/"
        },
        {
            "sha": "a41fa566dd39890da1d1c9baa047fceb72d26916",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b",
            "patch": "@@ -27,6 +27,8 @@ import bouncer from './plugins/bouncer';\n import errorHandling from './plugins/error-handling';\n import csrf from './plugins/csrf';\n import notFound from './plugins/not-found';\n+import shadowCapture from './plugins/shadow-capture';\n+\n import * as publicRoutes from './routes/public';\n import * as protectedRoutes from './routes/protected';\n \n@@ -35,6 +37,7 @@ import {\n   EMAIL_PROVIDER,\n   FCC_ENABLE_DEV_LOGIN_MODE,\n   FCC_ENABLE_SWAGGER_UI,\n+  FCC_ENABLE_SHADOW_CAPTURE,\n   FREECODECAMP_NODE_ENV\n } from './utils/env';\n import { isObjectID } from './utils/validation';\n@@ -127,6 +130,10 @@ export const build = async (\n     fastify.log.info(`Swagger UI available at ${API_LOCATION}/documentation`);\n   }\n \n+  if (FCC_ENABLE_SHADOW_CAPTURE) {\n+    void fastify.register(shadowCapture);\n+  }\n+\n   void fastify.register(auth);\n   void fastify.register(notFound);\n   void fastify.register(prismaPlugin);"
        },
        {
            "sha": "1fd74f5eca77e3ae3ff670f6c59e2cfbaca21da1",
            "filename": "api/src/plugins/shadow-capture.ts",
            "status": "added",
            "additions": 137,
            "deletions": 0,
            "changes": 137,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/api%2Fsrc%2Fplugins%2Fshadow-capture.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/api%2Fsrc%2Fplugins%2Fshadow-capture.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fshadow-capture.ts?ref=7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b",
            "patch": "@@ -0,0 +1,137 @@\n+import { randomUUID } from 'crypto';\n+import { appendFileSync, mkdirSync } from 'fs';\n+import { join } from 'path';\n+import type { FastifyPluginCallback } from 'fastify';\n+\n+import fp from 'fastify-plugin';\n+import { FastifyReply } from 'fastify/types/reply';\n+import { FastifyRequest } from 'fastify/types/request';\n+\n+const LOGS_DIRECTORY = 'logs';\n+const REQUEST_CAPTURE_FILE = 'request-capture.jsonl';\n+const RESPONSE_CAPTURE_FILE = 'response-capture.jsonl';\n+\n+let REQUEST_BUFFER: unknown[] = [];\n+let RESPONSE_BUFFER: unknown[] = [];\n+\n+/**\n+ * Plugin for capturing requests and responses to allow shadow testing.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+const shadowCapture: FastifyPluginCallback = (fastify, _options, done) => {\n+  mkdirSync(LOGS_DIRECTORY, { recursive: true });\n+  fastify.addHook('onRequest', (req, rep, done) => {\n+    // Attach timestamp at beginning of lifecycle\n+    // @ts-expect-error Exists\n+    req.__timestamp = Date.now();\n+\n+    // Give request and response same id to match.\n+    const id = randomUUID();\n+    // @ts-expect-error Exists\n+    req.__id = id;\n+    // @ts-expect-error Exists\n+    rep.__id = id;\n+    done();\n+  });\n+\n+  // Body is only included after `Parsing` lifecycle\n+  fastify.addHook('preValidation', (req, rep, done) => {\n+    captureRequest(req);\n+    done();\n+  });\n+\n+  fastify.addHook('onSend', async (_req, rep, payload) => {\n+    // @ts-expect-error Exists\n+    rep.__payload = payload;\n+    return payload;\n+  });\n+\n+  fastify.addHook('onResponse', (_req, rep, done) => {\n+    captureReply(rep);\n+    done();\n+  });\n+\n+  done();\n+};\n+\n+/* eslint-disable @typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-return */\n+function captureRequest(req: FastifyRequest) {\n+  const savedRequest = {\n+    // @ts-expect-error Exists\n+    id: req.__id,\n+    // @ts-expect-error Exists\n+    timestamp: req.__timestamp,\n+    url: req.url,\n+    headers: omit(req.headers, 'cookie'),\n+    cookies: include(req.cookies, '_csrf', 'csrf_token', 'jwt_access_token'),\n+    user: req.user,\n+    body: req.body\n+  };\n+\n+  if (REQUEST_BUFFER.length > 10) {\n+    appendFileSync(\n+      join(LOGS_DIRECTORY, REQUEST_CAPTURE_FILE),\n+      REQUEST_BUFFER.map(rb => JSON.stringify(rb)).join('\\n') + '\\n'\n+    );\n+    REQUEST_BUFFER = [savedRequest];\n+  } else {\n+    REQUEST_BUFFER.push(savedRequest);\n+  }\n+}\n+\n+function captureReply(rep: FastifyReply) {\n+  const savedReply = {\n+    // @ts-expect-error Exists\n+    id: rep.__id,\n+    headers: rep.getHeaders(),\n+    timestamp: Date.now(),\n+    // @ts-expect-error Exists\n+    payload: rep.__payload,\n+    statusCode: rep.statusCode\n+  };\n+\n+  if (RESPONSE_BUFFER.length > 10) {\n+    appendFileSync(\n+      join(LOGS_DIRECTORY, RESPONSE_CAPTURE_FILE),\n+      RESPONSE_BUFFER.map(rb => JSON.stringify(rb)).join('\\n') + '\\n'\n+    );\n+    RESPONSE_BUFFER = [savedReply];\n+  } else {\n+    RESPONSE_BUFFER.push(savedReply);\n+  }\n+}\n+\n+/**\n+ * Returns a subset of the given object with the values or properties given removed.\n+ * @param obj - An array or an object literal.\n+ * @param vals - Items or properties to exclude from `obj`.\n+ * @returns Subset of `obj`.\n+ */\n+function omit(obj: Record<string, unknown> | unknown[], ...vals: unknown[]) {\n+  if (Array.isArray(obj)) {\n+    return obj.filter(o => !vals.includes(o));\n+  } else {\n+    return Object.keys(obj)\n+      .filter(k => {\n+        return !vals.includes(k);\n+      })\n+      .reduce((acc, curr) => ({ ...acc, [curr]: obj[curr] }), {});\n+  }\n+}\n+\n+function include(obj: Record<string, unknown> | unknown[], ...vals: unknown[]) {\n+  if (Array.isArray(obj)) {\n+    return obj.filter(o => vals.includes(o));\n+  } else {\n+    return Object.keys(obj)\n+      .filter(k => {\n+        return vals.includes(k);\n+      })\n+      .reduce((acc, curr) => ({ ...acc, [curr]: obj[curr] }), {});\n+  }\n+}\n+\n+export default fp(shadowCapture);"
        },
        {
            "sha": "c3abc0a1ea57517e6b218a5d5b41348edc69937c",
            "filename": "api/src/utils/env.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/api%2Fsrc%2Futils%2Fenv.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/api%2Fsrc%2Futils%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fenv.ts?ref=7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b",
            "patch": "@@ -125,6 +125,8 @@ export const FCC_ENABLE_SWAGGER_UI =\n   process.env.FCC_ENABLE_SWAGGER_UI === 'true';\n export const FCC_ENABLE_DEV_LOGIN_MODE =\n   process.env.FCC_ENABLE_DEV_LOGIN_MODE === 'true';\n+export const FCC_ENABLE_SHADOW_CAPTURE =\n+  process.env.FCC_ENABLE_SHADOW_CAPTURE === 'true';\n export const SENTRY_DSN =\n   process.env.SENTRY_DSN === 'dsn_from_sentry_dashboard'\n     ? ''"
        },
        {
            "sha": "99d7d9cd59b8b9acf94c0dc18aea72b1a367ce4a",
            "filename": "sample.env",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/sample.env",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b/sample.env",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/sample.env?ref=7f1a6e553fb0b4aa009453d5340d4d3a3d36c63b",
            "patch": "@@ -68,6 +68,7 @@ NODE_ENV=development\n PORT=3000\n FCC_ENABLE_SWAGGER_UI=true\n FCC_ENABLE_DEV_LOGIN_MODE=true\n+FCC_ENABLE_SHADOW_CAPTURE=false\n \n # Email\n # use ses in production"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 150,
        "deletions": 0
    }
}