{
    "author": "gikf",
    "message": "feat(tools): rename-block helper script (#64201)",
    "sha": "075375700f5f0c09e15439642510a89b4e031d4a",
    "files": [
        {
            "sha": "5c4fe4cf1f6282f49a8a1894c8264bb86d25c347",
            "filename": "tools/challenge-helper-scripts/create-project.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 31,
            "changes": 33,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fcreate-project.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fcreate-project.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-helper-scripts%2Fcreate-project.ts?ref=075375700f5f0c09e15439642510a89b4e031d4a",
            "patch": "@@ -22,11 +22,13 @@ import {\n } from './utils.js';\n import { getBaseMeta } from './helpers/get-base-meta.js';\n import { createIntroMD } from './helpers/create-intro.js';\n+import { IntroJson, parseJson } from './helpers/parse-json.js';\n import {\n   ChapterModuleSuperblockStructure,\n   updateChapterModuleSuperblockStructure,\n   updateSimpleSuperblockStructure\n } from './helpers/create-project.js';\n+import { withTrace } from './helpers/utils.js';\n \n const helpCategories = [\n   'HTML-CSS',\n@@ -39,17 +41,6 @@ const helpCategories = [\n   'Rosetta'\n ] as const;\n \n-type BlockInfo = {\n-  title: string;\n-  intro: string[];\n-};\n-\n-type SuperBlockInfo = {\n-  blocks: Record<string, BlockInfo>;\n-};\n-\n-type IntroJson = Record<SuperBlocks, SuperBlockInfo>;\n-\n interface CreateProjectArgs {\n   superBlock: SuperBlocks;\n   block: string;\n@@ -241,26 +232,6 @@ async function createQuizChallenge(\n   });\n }\n \n-function parseJson<JsonSchema>(filePath: string) {\n-  return withTrace(fs.readFile, filePath, 'utf8').then(\n-    // unfortunately, withTrace does not correctly infer that the third argument\n-    // is a string, so it uses the (path, options?) overload and we have to cast\n-    // result to string.\n-    result => JSON.parse(result as string) as JsonSchema\n-  );\n-}\n-\n-// fs Promise functions return errors, but no stack trace.  This adds back in\n-// the stack trace.\n-function withTrace<Args extends unknown[], Result>(\n-  fn: (...x: Args) => Promise<Result>,\n-  ...args: Args\n-): Promise<Result> {\n-  return fn(...args).catch((reason: Error) => {\n-    throw Error(reason.message);\n-  });\n-}\n-\n async function getChapters(superBlock: string) {\n   const blockMetaFile = await fs.readFile(\n     '../../curriculum/structure/superblocks/' + superBlock + '.json',"
        },
        {
            "sha": "0cefdeb23242a2cf8344088cf5fa888a6e29e610",
            "filename": "tools/challenge-helper-scripts/helpers/parse-json.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fhelpers%2Fparse-json.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fhelpers%2Fparse-json.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-helper-scripts%2Fhelpers%2Fparse-json.ts?ref=075375700f5f0c09e15439642510a89b4e031d4a",
            "patch": "@@ -0,0 +1,24 @@\n+import fs from 'fs/promises';\n+\n+import { SuperBlocks } from '../../../shared-dist/config/curriculum.js';\n+import { withTrace } from './utils.js';\n+\n+export type BlockInfo = {\n+  title: string;\n+  intro: string[];\n+};\n+\n+export type SuperBlockInfo = {\n+  blocks: Record<string, BlockInfo>;\n+};\n+\n+export type IntroJson = Record<SuperBlocks, SuperBlockInfo>;\n+\n+export function parseJson<JsonSchema>(filePath: string) {\n+  return withTrace(fs.readFile, filePath, 'utf8').then(\n+    // unfortunately, withTrace does not correctly infer that the third argument\n+    // is a string, so it uses the (path, options?) overload and we have to cast\n+    // result to string.\n+    result => JSON.parse(result as string) as JsonSchema\n+  );\n+}"
        },
        {
            "sha": "bddb5dcc211c19dd9bc741ea4a1495d9c848b26c",
            "filename": "tools/challenge-helper-scripts/helpers/utils.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fhelpers%2Futils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fhelpers%2Futils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-helper-scripts%2Fhelpers%2Futils.ts?ref=075375700f5f0c09e15439642510a89b4e031d4a",
            "patch": "@@ -6,3 +6,14 @@ export function insertInto<T>(arr: T[], index: number, elem: T): T[] {\n     return id === index ? [elem, x] : x;\n   });\n }\n+\n+// fs Promise functions return errors, but no stack trace.  This adds back in\n+// the stack trace.\n+export function withTrace<Args extends unknown[], Result>(\n+  fn: (...x: Args) => Promise<Result>,\n+  ...args: Args\n+): Promise<Result> {\n+  return fn(...args).catch((reason: Error) => {\n+    throw Error(reason.message);\n+  });\n+}"
        },
        {
            "sha": "7bce431a1de3d0d349e3c996cf52063372c20e34",
            "filename": "tools/challenge-helper-scripts/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-helper-scripts%2Fpackage.json?ref=075375700f5f0c09e15439642510a89b4e031d4a",
            "patch": "@@ -23,6 +23,7 @@\n     \"create-project\": \"tsx create-project\",\n     \"create-language-block\": \"tsx create-language-block\",\n     \"create-quiz\": \"tsx create-quiz\",\n+    \"rename-block\": \"tsx rename-block\",\n     \"lint\": \"eslint --max-warnings 0\",\n     \"test\": \"vitest\"\n   },"
        },
        {
            "sha": "efcde974167cdb9f38adbbd94e5474a115b7346f",
            "filename": "tools/challenge-helper-scripts/rename-block.ts",
            "status": "added",
            "additions": 136,
            "deletions": 0,
            "changes": 136,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Frename-block.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/075375700f5f0c09e15439642510a89b4e031d4a/tools%2Fchallenge-helper-scripts%2Frename-block.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fchallenge-helper-scripts%2Frename-block.ts?ref=075375700f5f0c09e15439642510a89b4e031d4a",
            "patch": "@@ -0,0 +1,136 @@\n+import fs from 'fs/promises';\n+import path, { join } from 'path';\n+import { prompt } from 'inquirer';\n+import { format } from 'prettier';\n+\n+import { IntroJson, parseJson } from './helpers/parse-json';\n+import { withTrace } from './helpers/utils';\n+import { getAllBlocks, validateBlockName } from './utils';\n+import {\n+  getBlockStructure,\n+  getBlockStructurePath,\n+  getSuperblockStructure,\n+  writeBlockStructure,\n+  writeSuperblockStructure,\n+  getContentConfig,\n+  getCurriculumStructure\n+} from '../../curriculum/src/file-handler';\n+import matter from 'gray-matter';\n+\n+interface RenameBlockArgs {\n+  newBlock: string;\n+  oldBlock: string;\n+  newName: string;\n+}\n+\n+async function renameBlock({ newBlock, newName, oldBlock }: RenameBlockArgs) {\n+  const blockStructure = getBlockStructure(oldBlock);\n+  const blockStructurePath = getBlockStructurePath(oldBlock);\n+  blockStructure.dashedName = newBlock;\n+  blockStructure.name = newName;\n+  await writeBlockStructure(newBlock, blockStructure);\n+  await fs.rm(blockStructurePath);\n+  console.log('New block structure .json written.');\n+\n+  const { blockContentDir } = getContentConfig('english');\n+  const oldBlockContentDir = join(blockContentDir, oldBlock);\n+  const newBlockContentDir = join(blockContentDir, newBlock);\n+  await fs.rename(oldBlockContentDir, newBlockContentDir);\n+  console.log('Block challenges moved to new directory.');\n+\n+  const { superblocks } = getCurriculumStructure();\n+  console.log('Updating superblocks containing renamed block.');\n+  for (const superblock of superblocks) {\n+    const superblockStructure = getSuperblockStructure(superblock);\n+    const { chapters = [] } = superblockStructure;\n+    for (const chapter of chapters) {\n+      for (const module of chapter.modules) {\n+        const { blocks } = module;\n+        const blockIndex = blocks.findIndex(block => block === oldBlock);\n+        if (blockIndex !== -1) {\n+          module.blocks[blockIndex] = newBlock;\n+          await writeSuperblockStructure(superblock, superblockStructure);\n+          console.log(\n+            `Updated superblock .json file written for ${superblock}.`\n+          );\n+\n+          const superblockPagesDir = path.resolve(\n+            __dirname,\n+            `../../client/src/pages/learn/${superblock}/`\n+          );\n+          const blockPagesDir = join(superblockPagesDir, oldBlock);\n+          const indexMdPath = join(blockPagesDir, 'index.md');\n+          const frontMatter = matter.read(indexMdPath);\n+          const newData = {\n+            ...frontMatter.data,\n+            block: newBlock\n+          };\n+\n+          await fs.writeFile(\n+            indexMdPath,\n+            matter.stringify(frontMatter.content, newData)\n+          );\n+          const newBlockClientDir = join(superblockPagesDir, newBlock);\n+          await fs.rename(blockPagesDir, newBlockClientDir);\n+          console.log(\"Updated block's index.md file written.\");\n+\n+          const introJsonPath = path.resolve(\n+            __dirname,\n+            `../../client/i18n/locales/english/intro.json`\n+          );\n+          const newIntro = await parseJson<IntroJson>(introJsonPath);\n+          const introBlocks = Object.entries(newIntro[superblock].blocks);\n+          const blockIntroIndex = introBlocks.findIndex(\n+            ([block]) => block === oldBlock\n+          );\n+          introBlocks[blockIntroIndex] = [\n+            newBlock,\n+            { ...introBlocks[blockIntroIndex][1], title: newName }\n+          ];\n+          newIntro[superblock].blocks = Object.fromEntries(introBlocks);\n+\n+          await withTrace(\n+            fs.writeFile,\n+            introJsonPath,\n+            await format(JSON.stringify(newIntro), { parser: 'json' })\n+          );\n+          console.log('Updated locale intro.json file written.');\n+        }\n+      }\n+    }\n+  }\n+}\n+\n+void getAllBlocks()\n+  .then(existingBlocks =>\n+    prompt([\n+      {\n+        name: 'oldBlock',\n+        message: 'What is the dashed name of block to rename?',\n+        type: 'input',\n+        validate: (block: string) => existingBlocks.includes(block)\n+      },\n+      {\n+        name: 'newName',\n+        message: 'What is the new name?',\n+        type: 'input',\n+        default: ({ oldBlock }: RenameBlockArgs) =>\n+          getBlockStructure(oldBlock).name\n+      },\n+      {\n+        name: 'newBlock',\n+        message: 'What is the new dashed name (in kebab-case)?',\n+        validate: (newBlock: string) =>\n+          validateBlockName(newBlock, existingBlocks)\n+      }\n+    ])\n+  )\n+  .then(\n+    async ({ newBlock, newName, oldBlock }: RenameBlockArgs) =>\n+      await renameBlock({ newBlock, newName, oldBlock })\n+  )\n+  .then(() =>\n+    console.log(\n+      'All set. Now use pnpm run clean:client in the root and it should be good to go'\n+    )\n+  );"
        }
    ],
    "stats": {
        "total": 205,
        "additions": 174,
        "deletions": 31
    }
}