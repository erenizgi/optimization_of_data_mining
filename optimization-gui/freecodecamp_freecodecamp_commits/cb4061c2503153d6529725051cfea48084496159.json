{
    "author": "ojeytonwilliams",
    "message": "feat(api): redirect on error if request ACCEPTs html (#56445)",
    "sha": "cb4061c2503153d6529725051cfea48084496159",
    "files": [
        {
            "sha": "17d3d7473af6e7b9a7fed1cdb2be04d8cf76a5ac",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 25,
            "changes": 31,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=cb4061c2503153d6529725051cfea48084496159",
            "patch": "@@ -1,8 +1,8 @@\n+import fastifyAccepts from '@fastify/accepts';\n import fastifyCsrfProtection from '@fastify/csrf-protection';\n import fastifySwagger from '@fastify/swagger';\n import fastifySwaggerUI from '@fastify/swagger-ui';\n import type { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';\n-import fastifySentry from '@immobiliarelabs/fastify-sentry';\n import Ajv from 'ajv';\n import addFormats from 'ajv-formats';\n import uriResolver from 'fast-uri';\n@@ -25,6 +25,7 @@ import redirectWithMessage from './plugins/redirect-with-message';\n import security from './plugins/security';\n import auth from './plugins/auth';\n import bouncer from './plugins/bouncer';\n+import errorHandling from './plugins/error-handling';\n import notFound from './plugins/not-found';\n import * as publicRoutes from './routes/public';\n import * as protectedRoutes from './routes/protected';\n@@ -33,8 +34,7 @@ import {\n   API_LOCATION,\n   EMAIL_PROVIDER,\n   FCC_ENABLE_DEV_LOGIN_MODE,\n-  FCC_ENABLE_SWAGGER_UI,\n-  SENTRY_DSN\n+  FCC_ENABLE_SWAGGER_UI\n } from './utils/env';\n import { isObjectID } from './utils/validation';\n \n@@ -81,27 +81,10 @@ export const build = async (\n \n   fastify.setValidatorCompiler(({ schema }) => ajv.compile(schema));\n \n+  void fastify.register(redirectWithMessage);\n   void fastify.register(security);\n-\n-  await fastify.register(fastifySentry, {\n-    dsn: SENTRY_DSN,\n-    // No need to initialize if DSN is not provided (e.g. in development and\n-    // test environments)\n-    skipInit: !SENTRY_DSN,\n-    errorResponse: (error, _request, reply) => {\n-      const isCSRFError =\n-        error.code === 'FST_CSRF_INVALID_TOKEN' ||\n-        error.code === 'FST_CSRF_MISSING_SECRET';\n-      if (reply.statusCode === 500 || isCSRFError) {\n-        void reply.send({\n-          message: 'flash.generic-error',\n-          type: 'danger'\n-        });\n-      } else {\n-        void reply.send(error);\n-      }\n-    }\n-  });\n+  void fastify.register(fastifyAccepts);\n+  void fastify.register(errorHandling);\n \n   await fastify.register(cors);\n   await fastify.register(cookies);\n@@ -165,8 +148,6 @@ export const build = async (\n     fastify.log.info(`Swagger UI available at ${API_LOCATION}/documentation`);\n   }\n \n-  // redirectWithMessage must be registered before codeFlowAuth\n-  void fastify.register(redirectWithMessage);\n   void fastify.register(auth);\n   void fastify.register(notFound);\n   void fastify.register(prismaPlugin);"
        },
        {
            "sha": "4dc4ac560a6a0627c4fdfdfc81edc1375377fe70",
            "filename": "api/src/plugins/error-handling.test.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Ferror-handling.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Ferror-handling.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Ferror-handling.test.ts?ref=cb4061c2503153d6529725051cfea48084496159",
            "patch": "@@ -0,0 +1,83 @@\n+import Fastify, { type FastifyInstance } from 'fastify';\n+import accepts from '@fastify/accepts';\n+\n+import errorHandling from './error-handling';\n+import redirectWithMessage, { formatMessage } from './redirect-with-message';\n+\n+describe('errorHandling', () => {\n+  let fastify: FastifyInstance;\n+\n+  beforeEach(async () => {\n+    fastify = Fastify();\n+    await fastify.register(redirectWithMessage);\n+    await fastify.register(accepts);\n+    await fastify.register(errorHandling);\n+\n+    fastify.get('/test', async (_req, _reply) => {\n+      throw new Error('a very bad thing happened');\n+      return { ok: true };\n+    });\n+  });\n+\n+  afterEach(async () => {\n+    await fastify.close();\n+  });\n+\n+  it('should redirect to the referer if the request does not Accept json', async () => {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test',\n+      headers: {\n+        referer: 'https://www.freecodecamp.org/anything',\n+        accept: 'text/plain'\n+      }\n+    });\n+\n+    expect(res.headers['location']).toEqual(\n+      'https://www.freecodecamp.org/anything?' +\n+        formatMessage({\n+          type: 'danger',\n+          content: 'flash.generic-error'\n+        })\n+    );\n+    expect(res.statusCode).toEqual(302);\n+  });\n+\n+  it('should return a json response if the request does Accept json', async () => {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test',\n+      headers: {\n+        referer: 'https://www.freecodecamp.org/anything',\n+        accept: 'application/json,text/plain'\n+      }\n+    });\n+\n+    expect(res.json()).toEqual({\n+      message: 'flash.generic-error',\n+      type: 'danger'\n+    });\n+    expect(res.statusCode).toEqual(500);\n+  });\n+\n+  it('should redirect if the request prefers text/html to json', async () => {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test',\n+      headers: {\n+        referer: 'https://www.freecodecamp.org/anything',\n+        // this does accept json, (via the */*), but prefers text/html\n+        accept: 'text/html,*/*'\n+      }\n+    });\n+\n+    expect(res.headers['location']).toEqual(\n+      'https://www.freecodecamp.org/anything?' +\n+        formatMessage({\n+          type: 'danger',\n+          content: 'flash.generic-error'\n+        })\n+    );\n+    expect(res.statusCode).toEqual(302);\n+  });\n+});"
        },
        {
            "sha": "519288322c69e3e9909106dcdf3e426f41d819c7",
            "filename": "api/src/plugins/error-handling.ts",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Ferror-handling.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Ferror-handling.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Ferror-handling.ts?ref=cb4061c2503153d6529725051cfea48084496159",
            "patch": "@@ -0,0 +1,53 @@\n+import type { FastifyPluginCallback } from 'fastify';\n+import fastifySentry from '@immobiliarelabs/fastify-sentry';\n+import fp from 'fastify-plugin';\n+\n+import { SENTRY_DSN } from '../utils/env';\n+import { getRedirectParams } from '../utils/redirection';\n+\n+/**\n+ * Plugin to handle errors and send them to Sentry.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+const errorHandling: FastifyPluginCallback = (fastify, _options, done) => {\n+  void fastify.register(fastifySentry, {\n+    dsn: SENTRY_DSN,\n+    // No need to initialize if DSN is not provided (e.g. in development and\n+    // test environments)\n+    skipInit: !SENTRY_DSN,\n+    errorResponse: (error, request, reply) => {\n+      const accepts = request.accepts().type(['json', 'html']);\n+      const isCSRFError =\n+        error.code === 'FST_CSRF_INVALID_TOKEN' ||\n+        error.code === 'FST_CSRF_MISSING_SECRET';\n+\n+      const { returnTo } = getRedirectParams(request);\n+\n+      const message =\n+        reply.statusCode === 500 || isCSRFError\n+          ? 'flash.generic-error'\n+          : error.message;\n+      if (accepts === 'json') {\n+        void reply.send({\n+          message,\n+          type: 'danger'\n+        });\n+      } else {\n+        void reply.status(302);\n+        void reply.redirectWithMessage(returnTo, {\n+          type: 'danger',\n+          content: message\n+        });\n+      }\n+    }\n+  });\n+\n+  done();\n+};\n+\n+export default fp(errorHandling, {\n+  dependencies: ['redirect-with-message', '@fastify/accepts']\n+});"
        },
        {
            "sha": "1d71a51d04ae8f67e59426fb22a67797bc0ac2ec",
            "filename": "api/src/plugins/not-found.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Fnot-found.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Fnot-found.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fnot-found.test.ts?ref=cb4061c2503153d6529725051cfea48084496159",
            "patch": "@@ -1,4 +1,5 @@\n import Fastify, { type FastifyInstance } from 'fastify';\n+import accepts from '@fastify/accepts';\n \n import notFound from './not-found';\n import redirectWithMessage, { formatMessage } from './redirect-with-message';\n@@ -9,6 +10,7 @@ describe('fourOhFour', () => {\n   beforeEach(async () => {\n     fastify = Fastify();\n     await fastify.register(redirectWithMessage);\n+    await fastify.register(accepts);\n     await fastify.register(notFound);\n   });\n "
        },
        {
            "sha": "4ed4b187d65458cc848bd2eeb5a76af36ccfc8a2",
            "filename": "api/src/plugins/not-found.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Fnot-found.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cb4061c2503153d6529725051cfea48084496159/api%2Fsrc%2Fplugins%2Fnot-found.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fnot-found.ts?ref=cb4061c2503153d6529725051cfea48084496159",
            "patch": "@@ -1,7 +1,6 @@\n import type { FastifyPluginCallback } from 'fastify';\n \n import fp from 'fastify-plugin';\n-import accepts from '@fastify/accepts';\n \n import { getRedirectParams } from '../utils/redirection';\n \n@@ -13,8 +12,6 @@ import { getRedirectParams } from '../utils/redirection';\n  * @param done Callback to signal that the logic has completed.\n  */\n const fourOhFour: FastifyPluginCallback = (fastify, _options, done) => {\n-  void fastify.register(accepts);\n-\n   // If the request accepts JSON and does not specifically prefer text/html,\n   // this will return a 404 JSON response. Everything else will be redirected.\n   fastify.setNotFoundHandler((request, reply) => {\n@@ -34,4 +31,6 @@ const fourOhFour: FastifyPluginCallback = (fastify, _options, done) => {\n   done();\n };\n \n-export default fp(fourOhFour, { dependencies: ['redirect-with-message'] });\n+export default fp(fourOhFour, {\n+  dependencies: ['redirect-with-message', '@fastify/accepts']\n+});"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 147,
        "deletions": 29
    }
}