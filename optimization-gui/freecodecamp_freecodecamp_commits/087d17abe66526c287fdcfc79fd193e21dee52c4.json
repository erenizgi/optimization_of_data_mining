{
    "author": "ojeytonwilliams",
    "message": "feat(api): copy /api endpoints (#59283)\n\nCo-authored-by: Tom <20648924+moT01@users.noreply.github.com>\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>",
    "sha": "087d17abe66526c287fdcfc79fd193e21dee52c4",
    "files": [
        {
            "sha": "a8db1d98a71d5d6dc9a41468ed71deae84764d9b",
            "filename": "api-server/src/server/boot/randomAPIs.js",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api-server%2Fsrc%2Fserver%2Fboot%2FrandomAPIs.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api-server%2Fsrc%2Fserver%2Fboot%2FrandomAPIs.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fboot%2FrandomAPIs.js?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -17,6 +17,9 @@ module.exports = function (app) {\n   router.get('/ue/:unsubscribeId', unsubscribeById);\n   router.get('/resubscribe/:unsubscribeId', resubscribe);\n   router.get('/api/users/get-public-profile', blockUserAgent, getPublicProfile);\n+  router.get('/users/get-public-profile', blockUserAgent, getPublicProfile);\n+  const getUserExists = createGetUserExists(app);\n+  router.get('/users/exists', getUserExists);\n \n   app.use(router);\n \n@@ -168,6 +171,17 @@ module.exports = function (app) {\n     });\n   }\n \n+  function createGetUserExists(app) {\n+    const User = app.models.User;\n+    return function getUserExists(req, res) {\n+      const username = req.query.username.toLowerCase();\n+\n+      User.doesExist(username, null).then(exists => {\n+        res.send({ exists });\n+      });\n+    };\n+  }\n+\n   function prepUserForPublish(user, profileUI) {\n     const {\n       about,"
        },
        {
            "sha": "7cc94a85338b06641d3f9d61773cca8e01d36b2b",
            "filename": "api-server/src/server/middlewares/request-authorization.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.js?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -13,8 +13,10 @@ import { getUserById as _getUserById } from '../utils/user-stats';\n const authRE = /^\\/auth\\//;\n const confirmEmailRE = /^\\/confirm-email$/;\n const newsShortLinksRE = /^\\/n\\/|^\\/p\\//;\n-const publicUserRE = /^\\/api\\/users\\/get-public-profile$/;\n-const publicUsernameRE = /^\\/api\\/users\\/exists$/;\n+const publicApiUserRE = /^\\/api\\/users\\/get-public-profile$/;\n+const publicUserRE = /^\\/users\\/get-public-profile$/;\n+const publicApiUsernameRE = /^\\/api\\/users\\/exists$/;\n+const publicUsernameRE = /^\\/users\\/exists$/;\n const resubscribeRE = /^\\/resubscribe\\//;\n const showCertRE = /^\\/certificate\\/showCert\\//;\n // note: signin may not have a trailing slash\n@@ -32,7 +34,9 @@ const _pathsAllowedREs = [\n   authRE,\n   confirmEmailRE,\n   newsShortLinksRE,\n+  publicApiUserRE,\n   publicUserRE,\n+  publicApiUsernameRE,\n   publicUsernameRE,\n   resubscribeRE,\n   showCertRE,"
        },
        {
            "sha": "6d3a00982d5e66684ab7589ce7feac9bb683d6a0",
            "filename": "api-server/src/server/middlewares/request-authorization.test.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.test.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.test.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api-server%2Fsrc%2Fserver%2Fmiddlewares%2Frequest-authorization.test.js?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -39,8 +39,10 @@ describe('request-authorization', () => {\n     const authRE = /^\\/auth\\//;\n     const confirmEmailRE = /^\\/confirm-email$/;\n     const newsShortLinksRE = /^\\/n\\/|^\\/p\\//;\n-    const publicUserRE = /^\\/api\\/users\\/get-public-profile$/;\n-    const publicUsernameRE = /^\\/api\\/users\\/exists$/;\n+    const publicApiUserRE = /^\\/api\\/users\\/get-public-profile$/;\n+    const publicUserRE = /^\\/users\\/get-public-profile$/;\n+    const publicApiUsernameRE = /^\\/api\\/users\\/exists$/;\n+    const publicUsernameRE = /^\\/users\\/exists$/;\n     const resubscribeRE = /^\\/resubscribe\\//;\n     const showCertRE = /^\\/certificate\\/showCert\\//;\n     // note: signin may not have a trailing slash\n@@ -53,7 +55,9 @@ describe('request-authorization', () => {\n       authRE,\n       confirmEmailRE,\n       newsShortLinksRE,\n+      publicApiUserRE,\n       publicUserRE,\n+      publicApiUsernameRE,\n       publicUsernameRE,\n       resubscribeRE,\n       showCertRE,"
        },
        {
            "sha": "f8eb290354a472b2b8145625a9fb5b275c467cf8",
            "filename": "api/src/routes/public/user.test.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 19,
            "changes": 44,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fuser.test.ts?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -222,7 +222,7 @@ describe('userRoutes', () => {\n       superGet = createSuperRequest({ method: 'GET' });\n     });\n \n-    describe('/api/users/get-public-profile', () => {\n+    describe('/users/get-public-profile', () => {\n       const profilelessUsername = 'profileless-user';\n       const lockedUsername = 'locked-user';\n       const publicUsername = 'public-user';\n@@ -281,7 +281,7 @@ describe('userRoutes', () => {\n       describe('GET', () => {\n         test('returns 400 status code if the user agent is blocked', async () => {\n           const response = await superGet(\n-            '/api/users/get-public-profile?username=public-user'\n+            '/users/get-public-profile?username=public-user'\n           ).set('User-Agent', 'curl');\n \n           expect(response.text).toBe(\n@@ -291,22 +291,22 @@ describe('userRoutes', () => {\n         });\n \n         test('returns 400 status code if the username param is missing', async () => {\n-          const res = await superGet('/api/users/get-public-profile');\n+          const res = await superGet('/users/get-public-profile');\n           // TODO(Post-MVP): return something more informative\n           expect(res.body).toStrictEqual({});\n           expect(res.statusCode).toBe(400);\n         });\n \n         test('returns 400 status code if the username param is empty', async () => {\n-          const res = await superGet('/api/users/get-public-profile?username=');\n+          const res = await superGet('/users/get-public-profile?username=');\n           // TODO(Post-MVP): return something more informative\n           expect(res.body).toStrictEqual({});\n           expect(res.statusCode).toBe(400);\n         });\n \n         test('returns 404 status code for non-existent user', async () => {\n           const response = await superGet(\n-            '/api/users/get-public-profile?username=non-existent'\n+            '/users/get-public-profile?username=non-existent'\n           );\n           // TODO(Post-MVP): return something more informative\n           expect(response.body).toStrictEqual({});\n@@ -315,7 +315,7 @@ describe('userRoutes', () => {\n \n         test('returns 200 status code with a locked profile if the profile is private', async () => {\n           const response = await superGet(\n-            `/api/users/get-public-profile?username=${lockedUsername}`\n+            `/users/get-public-profile?username=${lockedUsername}`\n           );\n \n           expect(response.body).toStrictEqual({\n@@ -335,7 +335,7 @@ describe('userRoutes', () => {\n \n         test('returns 200 status code locked profile if the profile is missing', async () => {\n           const response = await superGet(\n-            `/api/users/get-public-profile?username=${profilelessUsername}`\n+            `/users/get-public-profile?username=${profilelessUsername}`\n           );\n \n           expect(response.body).toStrictEqual({\n@@ -360,7 +360,7 @@ describe('userRoutes', () => {\n               where: { email: publicUsername }\n             });\n           const response = await superGet(\n-            `/api/users/get-public-profile?username=${publicUsername}`\n+            `/users/get-public-profile?username=${publicUsername}`\n           );\n \n           // TODO: create a fixture for this without 'completedSurveys', ideally\n@@ -385,52 +385,58 @@ describe('userRoutes', () => {\n         });\n       });\n     });\n-    describe('GET /api/users/exists', () => {\n+    describe('GET /users/exists', () => {\n       beforeAll(async () => {\n         await fastifyTestInstance.prisma.user.create({\n           data: minimalUserData\n         });\n       });\n \n-      it('should return { exists: true } with a 400 status code if the username param is missing or empty', async () => {\n-        const res = await superGet('/api/users/exists');\n+      it('should reject with a 400 status code if the username param is missing or empty', async () => {\n+        const res = await superGet('/users/exists');\n \n-        expect(res.body).toStrictEqual({ exists: true });\n+        expect(res.body).toStrictEqual({\n+          type: 'danger',\n+          message: 'username parameter is required'\n+        });\n         expect(res.statusCode).toBe(400);\n \n-        const res2 = await superGet('/api/users/exists?username=');\n+        const res2 = await superGet('/users/exists?username=');\n \n-        expect(res2.body).toStrictEqual({ exists: true });\n+        expect(res2.body).toStrictEqual({\n+          type: 'danger',\n+          message: 'username parameter is required'\n+        });\n         expect(res2.statusCode).toBe(400);\n       });\n \n       it('should return { exists: true } if the username exists', async () => {\n-        const res = await superGet('/api/users/exists?username=testuser');\n+        const res = await superGet('/users/exists?username=testuser');\n \n         expect(res.body).toStrictEqual({ exists: true });\n         expect(res.statusCode).toBe(200);\n       });\n \n       it('should ignore case when checking for username existence', async () => {\n-        const res = await superGet('/api/users/exists?username=TeStUsEr');\n+        const res = await superGet('/users/exists?username=TeStUsEr');\n \n         expect(res.body).toStrictEqual({ exists: true });\n         expect(res.statusCode).toBe(200);\n       });\n \n       it('should return { exists: false } if the username does not exist', async () => {\n-        const res = await superGet('/api/users/exists?username=nonexistent');\n+        const res = await superGet('/users/exists?username=nonexistent');\n \n         expect(res.body).toStrictEqual({ exists: false });\n         expect(res.statusCode).toBe(200);\n       });\n \n       it('should return { exists: true } if the username is restricted (ignoring case)', async () => {\n-        const res = await superGet('/api/users/exists?username=pRofIle');\n+        const res = await superGet('/users/exists?username=pRofIle');\n \n         expect(res.body).toStrictEqual({ exists: true });\n \n-        const res2 = await superGet('/api/users/exists?username=flAnge');\n+        const res2 = await superGet('/users/exists?username=flAnge');\n \n         expect(res2.body).toStrictEqual({ exists: true });\n       });"
        },
        {
            "sha": "75bc45aad09d1e1d77c2c6c0a82e09ca3a83073f",
            "filename": "api/src/routes/public/user.ts",
            "status": "modified",
            "additions": 149,
            "deletions": 2,
            "changes": 151,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Froutes%2Fpublic%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Froutes%2Fpublic%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fuser.ts?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -212,6 +212,118 @@ export const userPublicGetRoutes: FastifyPluginCallbackTypebox = (\n     }\n   );\n \n+  fastify.get(\n+    '/users/get-public-profile',\n+    {\n+      schema: schemas.getPublicProfile,\n+      onRequest: (req, reply, done) => {\n+        const userAgent = req.headers['user-agent'];\n+\n+        if (\n+          userAgent &&\n+          blockedUserAgentParts.some(ua => userAgent.toLowerCase().includes(ua))\n+        ) {\n+          void reply.code(400);\n+          void reply.send(\n+            'This endpoint is no longer available outside of the freeCodeCamp ecosystem'\n+          );\n+        }\n+        done();\n+      }\n+    },\n+    async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+      logger.info({ username: req.query.username });\n+      // TODO(Post-MVP): look for duplicates unless we can make username unique in the db.\n+      const user = await fastify.prisma.user.findFirst({\n+        where: { username: req.query.username }\n+        // TODO: only select desired fields, then stop 'omit'ing the undesired\n+        // ones.\n+      });\n+\n+      if (!user) {\n+        logger.warn('User not found');\n+        void reply.code(404);\n+        return reply.send({});\n+      }\n+\n+      const [flags, rest] = splitUser(user);\n+\n+      const publicUser = _.omit(rest, [\n+        'currentChallengeId',\n+        'email',\n+        'emailVerified',\n+        'sendQuincyEmail',\n+        'theme',\n+        // keyboardShortcuts is included in flags.\n+        // 'keyboardShortcuts',\n+        'acceptedPrivacyTerms',\n+        'progressTimestamps',\n+        'unsubscribeId',\n+        'donationEmails',\n+        'externalId',\n+        'usernameDisplay',\n+        'isBanned'\n+      ]);\n+\n+      const normalizedProfileUI = normalizeProfileUI(user.profileUI);\n+\n+      void reply.code(200);\n+      if (normalizedProfileUI.isLocked) {\n+        // TODO(Post-MVP): just return isLocked: true and either a null user\n+        // or no user at all. (see other TODO in the else branch below)\n+        return reply.send({\n+          entities: {\n+            user: {\n+              [user.username]: {\n+                isLocked: true,\n+                profileUI: normalizedProfileUI,\n+                username: user.username\n+              }\n+            }\n+          },\n+          result: user.username\n+        });\n+      } else {\n+        const progressTimestamps = user.progressTimestamps as\n+          | ProgressTimestamp[]\n+          | null;\n+        const sharedUser = replacePrivateData({\n+          ...user,\n+          calendar: getCalendar(progressTimestamps),\n+          completedChallenges: normalizeChallenges(user.completedChallenges),\n+          location: user.location ?? '',\n+          joinDate: new ObjectId(user.id).getTimestamp().toISOString(),\n+          name: user.name ?? '',\n+          points: getPoints(progressTimestamps),\n+          profileUI: normalizedProfileUI\n+        });\n+\n+        const returnedUser = {\n+          ...removeNulls(publicUser),\n+          ...normalizeFlags(flags),\n+          ...sharedUser,\n+          profileUI: normalizedProfileUI,\n+          // TODO: should this always be returned? Shouldn't some privacy\n+          // setting control it? Same applies to website, githubProfile,\n+          // and linkedin.\n+          twitter: normalizeTwitter(user.twitter),\n+          yearsTopContributor: user.yearsTopContributor\n+        };\n+        return reply.send({\n+          // TODO(Post-MVP): just return a user object (i.e. returnedUser) and\n+          // isLocked: false. The there should be no need for Type.Union in the\n+          // schema. Alternatively, have the user object be nullable and don't\n+          // bother with isLocked.\n+          entities: {\n+            user: { [user.username]: returnedUser }\n+          },\n+          result: user.username\n+        });\n+      }\n+    }\n+  );\n+\n   fastify.get(\n     '/api/users/exists',\n     {\n@@ -224,11 +336,46 @@ export const userPublicGetRoutes: FastifyPluginCallbackTypebox = (\n       if (req.validationError) {\n         logger.warn({ validationError: req.validationError });\n         void reply.code(400);\n-        // TODO(Post-MVP): return a message telling the requester that their\n-        // request was malformed.\n+        return await reply.send({\n+          type: 'danger',\n+          message: 'username parameter is required'\n+        });\n+      }\n+\n+      const username = req.query.username.toLowerCase();\n+\n+      if (isRestricted(username)) {\n+        logger.info({ username }, 'Restricted username');\n         return await reply.send({ exists: true });\n       }\n \n+      const exists =\n+        (await fastify.prisma.user.count({\n+          where: { username }\n+        })) > 0;\n+\n+      await reply.send({ exists });\n+    }\n+  );\n+\n+  fastify.get(\n+    '/users/exists',\n+    {\n+      schema: schemas.userExists,\n+      attachValidation: true\n+    },\n+    async (req, reply) => {\n+      const logger = fastify.log.child({ req });\n+\n+      if (req.validationError) {\n+        logger.warn({ validationError: req.validationError });\n+        void reply.code(400);\n+        return await reply.send({\n+          type: 'danger',\n+          message: 'username parameter is required'\n+        });\n+      }\n+\n       const username = req.query.username.toLowerCase();\n \n       if (isRestricted(username)) {"
        },
        {
            "sha": "6d9ef398cd0f9dc7067ee1f5ae1fa4469685bf93",
            "filename": "api/src/schemas.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Fschemas.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Fschemas.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas.ts?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -1,5 +1,5 @@\n-export { getPublicProfile } from './schemas/api/users/get-public-profile';\n-export { userExists } from './schemas/api/users/exists';\n+export { getPublicProfile } from './schemas/users/get-public-profile';\n+export { userExists } from './schemas/users/exists';\n export { certSlug } from './schemas/certificate/cert-slug';\n export { certificateVerify } from './schemas/certificate/certificate-verify';\n export { backendChallengeCompleted } from './schemas/challenge/backend-challenge-completed';"
        },
        {
            "sha": "8655c824ee5a3e4a28da7c1515eac70e11978c12",
            "filename": "api/src/schemas/users/exists.ts",
            "status": "renamed",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Fschemas%2Fusers%2Fexists.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Fschemas%2Fusers%2Fexists.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fusers%2Fexists.ts?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -9,7 +9,9 @@ export const userExists = {\n       exists: Type.Boolean()\n     }),\n     400: Type.Object({\n-      exists: Type.Literal(true)\n+      type: Type.Literal('danger'),\n+      message: Type.Literal('username parameter is required')\n+      // message: Type.Literal(\"'username' parameter is required\")\n     })\n   }\n };",
            "previous_filename": "api/src/schemas/api/users/exists.ts"
        },
        {
            "sha": "06ff7f90a4dc1e450032d14d7a5b949bea8445bd",
            "filename": "api/src/schemas/users/get-public-profile.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Fschemas%2Fusers%2Fget-public-profile.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/087d17abe66526c287fdcfc79fd193e21dee52c4/api%2Fsrc%2Fschemas%2Fusers%2Fget-public-profile.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fusers%2Fget-public-profile.ts?ref=087d17abe66526c287fdcfc79fd193e21dee52c4",
            "patch": "@@ -1,5 +1,5 @@\n import { Type } from '@fastify/type-provider-typebox';\n-import { profileUI, examResults, savedChallenge } from '../../types';\n+import { profileUI, examResults, savedChallenge } from '../types';\n \n export const getPublicProfile = {\n   querystring: Type.Object({",
            "previous_filename": "api/src/schemas/api/users/get-public-profile.ts"
        }
    ],
    "stats": {
        "total": 235,
        "additions": 206,
        "deletions": 29
    }
}