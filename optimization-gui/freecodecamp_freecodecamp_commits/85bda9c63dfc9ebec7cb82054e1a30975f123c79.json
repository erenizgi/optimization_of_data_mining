{
    "author": "ojeytonwilliams",
    "message": "fix: handle when userinfo has no email address (#60557)",
    "sha": "85bda9c63dfc9ebec7cb82054e1a30975f123c79",
    "files": [
        {
            "sha": "23a1466218cf4ba6923b128ba2d2af35c3275030",
            "filename": "api/src/plugins/auth0.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/85bda9c63dfc9ebec7cb82054e1a30975f123c79/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/85bda9c63dfc9ebec7cb82054e1a30975f123c79/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.test.ts?ref=85bda9c63dfc9ebec7cb82054e1a30975f123c79",
            "patch": "@@ -208,13 +208,18 @@ describe('auth0 plugin', () => {\n         token: 'any token'\n       });\n       userinfoSpy.mockResolvedValueOnce(Promise.reject(Error('any error')));\n+      const returnTo = 'https://www.freecodecamp.org/espanol/learn';\n \n       const res = await fastify.inject({\n         method: 'GET',\n-        url: '/auth/auth0/callback?state=valid'\n+        url: '/auth/auth0/callback?state=valid',\n+        cookies: { 'login-returnto': sign(returnTo) }\n       });\n \n-      expect(res.headers.location).toMatch('/signin');\n+      expect(res.headers.location).toMatch(\n+        returnTo +\n+          `?${formatMessage({ type: 'danger', content: 'flash.generic-error' })}`\n+      );\n       expect(res.statusCode).toBe(302);\n       expect(await fastify.prisma.user.count()).toBe(0);\n     });\n@@ -224,13 +229,18 @@ describe('auth0 plugin', () => {\n         token: 'any token'\n       });\n       userinfoSpy.mockResolvedValueOnce(Promise.resolve({}));\n+      const returnTo = 'https://www.freecodecamp.org/espanol/learn';\n \n       const res = await fastify.inject({\n         method: 'GET',\n-        url: '/auth/auth0/callback?state=valid'\n+        url: '/auth/auth0/callback?state=valid',\n+        cookies: { 'login-returnto': sign(returnTo) }\n       });\n \n-      expect(res.headers.location).toMatch('/signin');\n+      expect(res.headers.location).toMatch(\n+        returnTo +\n+          `?${formatMessage({ type: 'danger', content: 'flash.no-email-in-userinfo' })}`\n+      );\n       expect(res.statusCode).toBe(302);\n       expect(await fastify.prisma.user.count()).toBe(0);\n     });"
        },
        {
            "sha": "515408e92f35297d2298a53d00373b0b9802ca35",
            "filename": "api/src/plugins/auth0.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/85bda9c63dfc9ebec7cb82054e1a30975f123c79/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/85bda9c63dfc9ebec7cb82054e1a30975f123c79/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.ts?ref=85bda9c63dfc9ebec7cb82054e1a30975f123c79",
            "patch": "@@ -144,13 +144,18 @@ export const auth0Client: FastifyPluginCallbackTypebox = fp(\n         logger.info(`Auth0 userinfo: ${JSON.stringify(userinfo)}`);\n         email = userinfo.email;\n         if (typeof email !== 'string') {\n-          const msg = `Invalid userinfo email: ${JSON.stringify(userinfo)}`;\n-          throw Error(msg);\n+          return reply.redirectWithMessage(returnTo, {\n+            type: 'danger',\n+            content: 'flash.no-email-in-userinfo'\n+          });\n         }\n       } catch (error) {\n         logger.error(error, 'Failed to get userinfo from Auth0');\n         fastify.Sentry.captureException(error);\n-        return reply.redirect('/signin');\n+        return reply.redirectWithMessage(returnTo, {\n+          type: 'danger',\n+          content: 'flash.generic-error'\n+        });\n       }\n \n       const { id, acceptedPrivacyTerms } = await findOrCreateUser("
        },
        {
            "sha": "4b6e3531d332c556ba98cad943f02f58c8a96ed4",
            "filename": "client/i18n/locales/english/translations.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/85bda9c63dfc9ebec7cb82054e1a30975f123c79/client%2Fi18n%2Flocales%2Fenglish%2Ftranslations.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/85bda9c63dfc9ebec7cb82054e1a30975f123c79/client%2Fi18n%2Flocales%2Fenglish%2Ftranslations.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fi18n%2Flocales%2Fenglish%2Ftranslations.json?ref=85bda9c63dfc9ebec7cb82054e1a30975f123c79",
            "patch": "@@ -852,6 +852,7 @@\n     \"edit-my-profile\": \"Edit my profile\"\n   },\n   \"flash\": {\n+    \"no-email-in-userinfo\": \"We could not retrieve an email from your chosen provider. Please try another provider or use the 'Continue with Email' option.\",\n     \"honest-first\": \"To claim a certification, you must first agree to our academic honesty policy\",\n     \"really-weird\": \"Something really weird happened, if it happens again, please consider raising an issue on https://github.com/freeCodeCamp/freeCodeCamp/issues/new\",\n     \"generic-error\": \"Something went wrong. Please try again in a moment or contact support@freecodecamp.org if the error persists.\","
        }
    ],
    "stats": {
        "total": 30,
        "additions": 23,
        "deletions": 7
    }
}