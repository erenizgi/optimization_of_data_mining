{
    "author": "ShaunSHamilton",
    "message": "breaking(api): refactor exam environment endpoints (#56806)",
    "sha": "bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
    "files": [
        {
            "sha": "188a3ea11ff1c2dcafb26e6956b31870ad3c0652",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -379,9 +379,11 @@ model UserToken {\n }\n \n model ExamEnvironmentAuthorizationToken {\n-  id          String   @id @map(\"_id\")\n-  createdDate DateTime @db.Date\n-  userId      String   @unique @db.ObjectId\n+  /// An ObjectId is used to provide access to the created timestamp\n+  id       String   @id @default(auto()) @map(\"_id\") @db.ObjectId\n+  /// Used to set an `expireAt` index to delete documents\n+  expireAt DateTime @db.Date\n+  userId   String   @unique @db.ObjectId\n \n   // Relations\n   user user @relation(fields: [userId], references: [id])"
        },
        {
            "sha": "cca82576ef28642906d8d3b4424c8ab80eb23d0f",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -35,11 +35,11 @@ describe('/exam-environment/', () => {\n       await mock.seedEnvExam();\n       // Add exam environment authorization token\n       const res = await superPost('/user/exam-environment/token');\n-      expect(res.status).toBe(200);\n+      expect(res.status).toBe(201);\n       // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n       examEnvironmentAuthorizationToken =\n         // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n-        res.body.data.examEnvironmentAuthorizationToken;\n+        res.body.examEnvironmentAuthorizationToken;\n     });\n \n     describe('POST /exam-environment/exam/attempt', () => {\n@@ -389,11 +389,9 @@ describe('/exam-environment/', () => {\n         expect(res).toMatchObject({\n           status: 200,\n           body: {\n-            data: {\n-              examAttempt: {\n-                // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-                id: expect.not.stringMatching(mock.examAttempt.id)\n-              }\n+            examAttempt: {\n+              // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+              id: expect.not.stringMatching(mock.examAttempt.id)\n             }\n           }\n         });\n@@ -419,9 +417,7 @@ describe('/exam-environment/', () => {\n         expect(res).toMatchObject({\n           status: 200,\n           body: {\n-            data: {\n-              examAttempt: latestAttempt\n-            }\n+            examAttempt: latestAttempt\n           }\n         });\n       });\n@@ -555,10 +551,8 @@ describe('/exam-environment/', () => {\n         expect(res).toMatchObject({\n           status: 200,\n           body: {\n-            data: {\n-              examAttempt,\n-              exam: userExam\n-            }\n+            examAttempt,\n+            exam: userExam\n           }\n         });\n       });\n@@ -644,15 +638,15 @@ describe('/exam-environment/', () => {\n       });\n     });\n \n-    describe('POST /exam-environment/token/verify', () => {\n+    describe('GET /exam-environment/token-meta', () => {\n       it('should allow a valid request', async () => {\n-        const res = await superPost('/exam-environment/token/verify').set(\n+        const res = await superGet('/exam-environment/token-meta').set(\n           'exam-environment-authorization-token',\n           'invalid-token'\n         );\n \n         expect(res).toMatchObject({\n-          status: 200,\n+          status: 418,\n           body: {\n             code: 'FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN'\n           }"
        },
        {
            "sha": "f8fdcce6726e46888dd8a81e031d1e01caa18532",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 23,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -64,12 +64,12 @@ export const examEnvironmentOpenRoutes: FastifyPluginCallbackTypebox = (\n   _options,\n   done\n ) => {\n-  fastify.post(\n-    '/exam-environment/token/verify',\n+  fastify.get(\n+    '/exam-environment/token-meta',\n     {\n-      schema: schemas.examEnvironmentTokenVerify\n+      schema: schemas.examEnvironmentTokenMeta\n     },\n-    tokenVerifyHandler\n+    tokenMetaHandler\n   );\n   done();\n };\n@@ -85,18 +85,18 @@ interface JwtPayload {\n  *\n  * **Note**: This has no guarantees of which user the token is for. Just that one exists in the database.\n  */\n-async function tokenVerifyHandler(\n+async function tokenMetaHandler(\n   this: FastifyInstance,\n-  req: UpdateReqType<typeof schemas.examEnvironmentTokenVerify>,\n+  req: UpdateReqType<typeof schemas.examEnvironmentTokenMeta>,\n   reply: FastifyReply\n ) {\n   const { 'exam-environment-authorization-token': encodedToken } = req.headers;\n \n   try {\n     jwt.verify(encodedToken, JWT_SECRET);\n   } catch (e) {\n-    // TODO: What to send back here? Request is valid, but token is not?\n-    void reply.code(200);\n+    // Server refuses to brew (verify) coffee (jwts) with a teapot (random strings)\n+    void reply.code(418);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(JSON.stringify(e))\n     );\n@@ -114,16 +114,17 @@ async function tokenVerifyHandler(\n   });\n \n   if (!token) {\n-    void reply.code(200);\n-    return reply.send({\n-      data: 'Token does not appear to have been created.'\n-    });\n+    // Endpoint is valid, but resource does not exists\n+    void reply.code(404);\n+    return reply.send(\n+      ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(\n+        'Token does not appear to exist'\n+      )\n+    );\n   } else {\n     void reply.code(200);\n     return reply.send({\n-      data: {\n-        createdDate: token.createdDate\n-      }\n+      expireAt: token.expireAt\n     });\n   }\n }\n@@ -257,10 +258,8 @@ async function postExamGeneratedExamHandler(\n       const userExam = constructUserExam(generated.data, exam);\n \n       return reply.send({\n-        data: {\n-          exam: userExam,\n-          examAttempt: lastAttempt\n-        }\n+        exam: userExam,\n+        examAttempt: lastAttempt\n       });\n     }\n   }\n@@ -375,10 +374,8 @@ async function postExamGeneratedExamHandler(\n \n   void reply.code(200);\n   return reply.send({\n-    data: {\n-      exam: userExam,\n-      examAttempt: attempt.data\n-    }\n+    exam: userExam,\n+    examAttempt: attempt.data\n   });\n }\n "
        },
        {
            "sha": "4e3ba3926d598f010875bdbc1dfec1ee60f94f1f",
            "filename": "api/src/exam-environment/schemas/exam-generated-exam.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-generated-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-generated-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Fexam-generated-exam.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -10,10 +10,8 @@ export const examEnvironmentPostExamGeneratedExam = {\n   }),\n   response: {\n     200: Type.Object({\n-      data: Type.Object({\n-        exam: Type.Record(Type.String(), Type.Unknown()),\n-        examAttempt: Type.Record(Type.String(), Type.Unknown())\n-      })\n+      exam: Type.Record(Type.String(), Type.Unknown()),\n+      examAttempt: Type.Record(Type.String(), Type.Unknown())\n     }),\n     403: STANDARD_ERROR,\n     404: STANDARD_ERROR,"
        },
        {
            "sha": "8f321bd900480fb4d72ab280b25ebaf0e161db84",
            "filename": "api/src/exam-environment/schemas/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Findex.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -1,5 +1,5 @@\n export { examEnvironmentPostExamAttempt } from './exam-attempt';\n export { examEnvironmentPostExamGeneratedExam } from './exam-generated-exam';\n export { examEnvironmentPostScreenshot } from './screenshot';\n-export { examEnvironmentTokenVerify } from './token-verify';\n+export { examEnvironmentTokenMeta } from './token-meta';\n export { examEnvironmentExams } from './exams';"
        },
        {
            "sha": "d98095045a8acb47e39b3719188ed95cc128cd3d",
            "filename": "api/src/exam-environment/schemas/token-meta.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Fschemas%2Ftoken-meta.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fexam-environment%2Fschemas%2Ftoken-meta.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Ftoken-meta.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -0,0 +1,15 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+import { STANDARD_ERROR } from '../utils/errors';\n+\n+export const examEnvironmentTokenMeta = {\n+  headers: Type.Object({\n+    'exam-environment-authorization-token': Type.String()\n+  }),\n+  response: {\n+    200: Type.Object({\n+      expireAt: Type.String({ format: 'date-time' })\n+    }),\n+    404: STANDARD_ERROR,\n+    418: STANDARD_ERROR\n+  }\n+};"
        },
        {
            "sha": "d8042da65f1e87b31872daa081fd1b5f8cc2c48c",
            "filename": "api/src/exam-environment/schemas/token-verify.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/a580118e9085c9ef116f3a792528d9f6efc19b1e/api%2Fsrc%2Fexam-environment%2Fschemas%2Ftoken-verify.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/a580118e9085c9ef116f3a792528d9f6efc19b1e/api%2Fsrc%2Fexam-environment%2Fschemas%2Ftoken-verify.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fschemas%2Ftoken-verify.ts?ref=a580118e9085c9ef116f3a792528d9f6efc19b1e",
            "patch": "@@ -1,21 +0,0 @@\n-import { Type } from '@fastify/type-provider-typebox';\n-import { STANDARD_ERROR } from '../utils/errors';\n-\n-export const examEnvironmentTokenVerify = {\n-  headers: Type.Object({\n-    'exam-environment-authorization-token': Type.String()\n-  }),\n-  response: {\n-    200: Type.Union([\n-      Type.Object({\n-        data: Type.Union([\n-          Type.String(),\n-          Type.Object({\n-            createdDate: Type.String({ format: 'date-time' })\n-          })\n-        ])\n-      }),\n-      STANDARD_ERROR\n-    ])\n-  }\n-};"
        },
        {
            "sha": "65f288dad0ff857d2ac7f4521eda56388f332e35",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 16,
            "changes": 30,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -16,7 +16,6 @@ import {\n   createSuperRequest\n } from '../../../jest.utils';\n import { JWT_SECRET } from '../../utils/env';\n-import { customNanoid } from '../../utils/ids';\n import { getMsTranscriptApiUrl } from './user';\n \n const mockedFetch = jest.fn();\n@@ -1148,13 +1147,13 @@ Thanks and regards,\n \n       test('POST generates a new token if one does not exist', async () => {\n         const response = await superPost('/user/exam-environment/token');\n-        const { examEnvironmentAuthorizationToken } = response.body.data;\n+        const { examEnvironmentAuthorizationToken } = response.body;\n \n         const decodedToken = jwt.decode(examEnvironmentAuthorizationToken);\n \n         expect(decodedToken).toStrictEqual({\n           examEnvironmentAuthorizationToken:\n-            expect.stringMatching(/^[a-zA-Z0-9]{64}$/),\n+            expect.stringMatching(/^[a-z0-9]{24}$/),\n           iat: expect.any(Number)\n         });\n \n@@ -1165,33 +1164,32 @@ Thanks and regards,\n           jwt.verify(examEnvironmentAuthorizationToken, JWT_SECRET)\n         ).not.toThrow();\n \n-        expect(response.status).toBe(200);\n+        expect(response.status).toBe(201);\n       });\n \n       test('POST only allows for one token per user id', async () => {\n-        const id = customNanoid();\n-        await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.create(\n-          {\n-            data: {\n-              userId: defaultUserId,\n-              id,\n-              createdDate: new Date()\n+        const token =\n+          await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.create(\n+            {\n+              data: {\n+                userId: defaultUserId,\n+                expireAt: new Date()\n+              }\n             }\n-          }\n-        );\n+          );\n \n         const response = await superPost('/user/exam-environment/token');\n \n-        const { examEnvironmentAuthorizationToken } = response.body.data;\n+        const { examEnvironmentAuthorizationToken } = response.body;\n \n         const decodedToken = jwt.decode(examEnvironmentAuthorizationToken);\n \n         expect(decodedToken).not.toHaveProperty(\n           'examEnvironmentAuthorizationToken',\n-          id\n+          token.id\n         );\n \n-        expect(response.status).toBe(200);\n+        expect(response.status).toBe(201);\n \n         const tokens =\n           await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.findMany("
        },
        {
            "sha": "a54de1a25e777db7d641e22cd0f9e8b3b2cfabc4",
            "filename": "api/src/routes/protected/user.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -397,10 +397,11 @@ async function examEnvironmentTokenHandler(\n     }\n   });\n \n+  const ONE_YEAR_IN_MS = 365 * 24 * 60 * 60 * 1000;\n+\n   const token = await this.prisma.examEnvironmentAuthorizationToken.create({\n     data: {\n-      createdDate: new Date(),\n-      id: customNanoid(),\n+      expireAt: new Date(Date.now() + ONE_YEAR_IN_MS),\n       userId\n     }\n   });\n@@ -410,10 +411,9 @@ async function examEnvironmentTokenHandler(\n     JWT_SECRET\n   );\n \n+  void reply.code(201);\n   void reply.send({\n-    data: {\n-      examEnvironmentAuthorizationToken\n-    }\n+    examEnvironmentAuthorizationToken\n   });\n }\n "
        },
        {
            "sha": "2135c3086efc901a06245a25618e7930a1e30d8c",
            "filename": "api/src/schemas/user/exam-environment-token.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fschemas%2Fuser%2Fexam-environment-token.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb16ab9245a25850f1c87fe3fa5e03db0b3d7348/api%2Fsrc%2Fschemas%2Fuser%2Fexam-environment-token.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fuser%2Fexam-environment-token.ts?ref=bb16ab9245a25850f1c87fe3fa5e03db0b3d7348",
            "patch": "@@ -3,9 +3,7 @@ import { Type } from '@fastify/type-provider-typebox';\n export const userExamEnvironmentToken = {\n   response: {\n     200: Type.Object({\n-      data: Type.Object({\n-        examEnvironmentAuthorizationToken: Type.String()\n-      })\n+      examEnvironmentAuthorizationToken: Type.String()\n     })\n   }\n };"
        }
    ],
    "stats": {
        "total": 167,
        "additions": 74,
        "deletions": 93
    }
}