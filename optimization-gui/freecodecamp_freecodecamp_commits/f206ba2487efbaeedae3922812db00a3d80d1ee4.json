{
    "author": "Sembauke",
    "message": "feat(api): add logging to Auth0 endpoint (#59160)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>\nCo-authored-by: Naomi Carrigan <commits@nhcarrigan.com>",
    "sha": "f206ba2487efbaeedae3922812db00a3d80d1ee4",
    "files": [
        {
            "sha": "d3dc26fdb04af3ab7e0ddb4ef5f7c10a319ce06a",
            "filename": "api/src/plugins/auth0.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 12,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f206ba2487efbaeedae3922812db00a3d80d1ee4/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f206ba2487efbaeedae3922812db00a3d80d1ee4/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.ts?ref=f206ba2487efbaeedae3922812db00a3d80d1ee4",
            "patch": "@@ -78,42 +78,43 @@ export const auth0Client: FastifyPluginCallbackTypebox = fp(\n     });\n \n     // TODO: use a schema to validate the query params.\n-    fastify.get('/auth/auth0/callback', async function (request, reply) {\n-      const { error, error_description } = request.query as Record<\n-        string,\n-        string\n-      >;\n+    fastify.get('/auth/auth0/callback', async function (req, reply) {\n+      const logger = fastify.log.child({ req });\n+\n+      const { error, error_description } = req.query as Record<string, string>;\n       if (error === 'access_denied') {\n         const blockedByLaw =\n           error_description === 'Access denied from your location';\n-\n         if (blockedByLaw) {\n+          logger.info('Access denied due to user location');\n           return reply.redirect(`${HOME_LOCATION}/blocked`);\n         } else {\n+          logger.error('Authentication failed for user:' + error_description);\n+\n           return reply.redirectWithMessage(`${HOME_LOCATION}/learn`, {\n             type: 'info',\n             content: error_description ?? 'Authentication failed'\n           });\n         }\n       }\n \n-      const { returnTo, pathPrefix, origin } = getLoginRedirectParams(request);\n+      const { returnTo, pathPrefix, origin } = getLoginRedirectParams(req);\n       const redirectBase = getPrefixedLandingPath(origin, pathPrefix);\n \n       let token;\n       try {\n         token = (\n-          await this.auth0OAuth.getAccessTokenFromAuthorizationCodeFlow(request)\n+          await this.auth0OAuth.getAccessTokenFromAuthorizationCodeFlow(req)\n         ).token;\n       } catch (error) {\n         // This is the plugin's error message. If it changes, we will either\n         // have to update the test or write custom state create/verify\n         // functions.\n         if (error instanceof Error && error.message === 'Invalid state') {\n-          fastify.log.error('Auth failed: invalid state');\n+          logger.error('Auth failed: invalid state');\n         } else {\n-          fastify.log.error('Auth failed:');\n-          fastify.log.error(error);\n+          logger.error('Auth failed:');\n+          logger.error(error);\n           fastify.Sentry.captureException(error);\n         }\n         // It's important _not_ to redirect to /signin here, as that could\n@@ -132,7 +133,7 @@ export const auth0Client: FastifyPluginCallbackTypebox = fp(\n         email = userinfo.email;\n         if (typeof email !== 'string') throw Error('Invalid userinfo response');\n       } catch (error) {\n-        fastify.log.error('Auth failed', error);\n+        logger.error({ error }, 'Auth failed');\n         fastify.Sentry.captureException(error);\n         return reply.redirect('/signin');\n       }"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 13,
        "deletions": 12
    }
}