{
    "author": "ShaunSHamilton",
    "message": "fix(api): use lowercase email address (#61490)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "f662b64a37530280f3b58a8342d2a559fed450da",
    "files": [
        {
            "sha": "7414d752abf5795f4df2612ffd0bc9297575e856",
            "filename": "api/src/routes/helpers/auth-helpers.test.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 1,
            "changes": 33,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f662b64a37530280f3b58a8342d2a559fed450da/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f662b64a37530280f3b58a8342d2a559fed450da/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.test.ts?ref=f662b64a37530280f3b58a8342d2a559fed450da",
            "patch": "@@ -24,7 +24,13 @@ describe('findOrCreateUser', () => {\n   });\n \n   afterEach(async () => {\n-    await fastify.prisma.user.deleteMany({ where: { email } });\n+    await fastify.prisma.user.deleteMany({\n+      where: {\n+        email: {\n+          in: [email, email.toUpperCase()]\n+        }\n+      }\n+    });\n     await fastify.close();\n     jest.clearAllMocks();\n   });\n@@ -60,4 +66,29 @@ describe('findOrCreateUser', () => {\n \n     expect(captureException).not.toHaveBeenCalled();\n   });\n+\n+  it(\"should NOT create a user if there is already an account with the lowercase version of the user's email\", async () => {\n+    const upperCaseEmail = email.toUpperCase();\n+\n+    // Create a user with lowercase email\n+    const existingUser = await fastify.prisma.user.create({\n+      data: createUserInput(email)\n+    });\n+\n+    // Try to find or create with uppercase email\n+    const result = await findOrCreateUser(fastify, upperCaseEmail);\n+\n+    // Should return the existing user, not create a new one\n+    expect(result.id).toBe(existingUser.id);\n+\n+    // Verify only one user exists in the database\n+    const allUsers = await fastify.prisma.user.findMany({\n+      where: {\n+        email: {\n+          in: [upperCaseEmail, email]\n+        }\n+      }\n+    });\n+    expect(allUsers).toHaveLength(1);\n+  });\n });"
        },
        {
            "sha": "7f2ed983e3e1de8bb3e3ba4d5a5133a6120a7b60",
            "filename": "api/src/routes/helpers/auth-helpers.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f662b64a37530280f3b58a8342d2a559fed450da/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f662b64a37530280f3b58a8342d2a559fed450da/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fhelpers%2Fauth-helpers.ts?ref=f662b64a37530280f3b58a8342d2a559fed450da",
            "patch": "@@ -11,10 +11,16 @@ export const findOrCreateUser = async (\n   fastify: FastifyInstance,\n   email: string\n ): Promise<{ id: string; acceptedPrivacyTerms: boolean }> => {\n+  const lowerCaseEmail = email.toLowerCase();\n   // TODO: handle the case where there are multiple users with the same email.\n   // e.g. use findMany and throw an error if more than one is found.\n   const existingUser = await fastify.prisma.user.findMany({\n-    where: { email },\n+    where: {\n+      // https://www.mongodb.com/docs/manual/reference/operator/query/or/#-or-versus--in\n+      email: {\n+        in: [email, lowerCaseEmail]\n+      }\n+    },\n     select: { id: true, acceptedPrivacyTerms: true }\n   });\n   if (existingUser.length > 1) {\n@@ -28,7 +34,7 @@ export const findOrCreateUser = async (\n   return (\n     existingUser[0] ??\n     (await fastify.prisma.user.create({\n-      data: createUserInput(email),\n+      data: createUserInput(lowerCaseEmail),\n       select: { id: true, acceptedPrivacyTerms: true }\n     }))\n   );"
        },
        {
            "sha": "b8e031fde11bd0844eb70dc3068390ff024c12c4",
            "filename": "api/src/routes/protected/settings.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/f662b64a37530280f3b58a8342d2a559fed450da/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/f662b64a37530280f3b58a8342d2a559fed450da/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fsettings.ts?ref=f662b64a37530280f3b58a8342d2a559fed450da",
            "patch": "@@ -765,7 +765,9 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n     },\n     async (req, reply) => {\n       const logger = fastify.log.child({ req, res: reply });\n-      const email = Buffer.from(req.query.email, 'base64').toString();\n+      const email = Buffer.from(req.query.email, 'base64')\n+        .toString()\n+        .toLowerCase();\n \n       const { origin } = getRedirectParams(req);\n       if (!isEmail(email)) {\n@@ -791,9 +793,12 @@ export const settingRedirectRoutes: FastifyPluginCallbackTypebox = (\n       // TODO(Post-MVP): should this fail if it's not the currently signed in\n       // user?\n       const targetUser = await fastify.prisma.user.findUnique({\n-        where: { id: authToken.userId }\n+        where: { id: authToken.userId },\n+        select: { id: true, newEmail: true }\n       });\n \n+      // TODO: update redirect message to be specific about issue\n+      //       Most likely cause being user tampered callback url\n       if (targetUser?.newEmail !== email) {\n         return reply.redirectWithMessage(origin, redirectMessage);\n       }"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 47,
        "deletions": 5
    }
}