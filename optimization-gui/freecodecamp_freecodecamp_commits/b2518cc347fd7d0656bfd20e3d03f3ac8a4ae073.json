{
    "author": "ahmaxed",
    "message": "feat(api): add charge-stripe and create-stripe-payment-intent endpoints (#54545)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
    "files": [
        {
            "sha": "2b109c49d38655d4b9dbe2fb0d2e0cb9fe0d14f3",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -33,7 +33,7 @@\n     \"pino-pretty\": \"10.2.3\",\n     \"query-string\": \"7.1.3\",\n     \"rate-limit-mongo\": \"^2.3.2\",\n-    \"stripe\": \"8.222.0\",\n+    \"stripe\": \"16.0.0\",\n     \"validator\": \"13.11.0\"\n   },\n   \"description\": \"The freeCodeCamp.org open-source codebase and curriculum\","
        },
        {
            "sha": "aff6fc520598ad5eaaba3f9aa78212984d03b884",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -35,7 +35,7 @@ import {\n import { challengeRoutes } from './routes/challenge';\n import { deprecatedEndpoints } from './routes/deprecated-endpoints';\n import { unsubscribeDeprecated } from './routes/deprecated-unsubscribe';\n-import { donateRoutes } from './routes/donate';\n+import { donateRoutes, chargeStripeRoute } from './routes/donate';\n import { emailSubscribtionRoutes } from './routes/email-subscription';\n import { settingRoutes, settingRedirectRoutes } from './routes/settings';\n import { statusRoute } from './routes/status';\n@@ -223,6 +223,7 @@ export const build = async (\n   if (FCC_ENABLE_DEV_LOGIN_MODE) {\n     void fastify.register(devAuthRoutes);\n   }\n+  void fastify.register(chargeStripeRoute);\n   void fastify.register(emailSubscribtionRoutes);\n   void fastify.register(userPublicGetRoutes);\n   void fastify.register(unprotectedCertificateRoutes);"
        },
        {
            "sha": "1d65e46d6e6103596f878429884b7d4535012a71",
            "filename": "api/src/routes/donate.test.ts",
            "status": "modified",
            "additions": 284,
            "deletions": 46,
            "changes": 330,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Froutes%2Fdonate.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Froutes%2Fdonate.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fdonate.test.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -8,48 +8,11 @@ import {\n } from '../../jest.utils';\n import { createUserInput } from '../utils/create-user';\n \n-const chargeStripeCardReqBody = {\n-  paymentMethodId: 'UID',\n-  amount: 500,\n-  duration: 'month'\n-};\n-const mockSubCreate = jest.fn();\n-const generateMockSubCreate = (status: string) => () =>\n-  Promise.resolve({\n-    id: 'cust_111',\n-    latest_invoice: {\n-      payment_intent: {\n-        client_secret: 'superSecret',\n-        status\n-      }\n-    }\n-  });\n-const defaultError = () =>\n-  Promise.reject(new Error('Stripe encountered an error'));\n-\n-jest.mock('stripe', () => {\n-  return jest.fn().mockImplementation(() => {\n-    return {\n-      customers: {\n-        create: jest.fn(() =>\n-          Promise.resolve({\n-            id: 'cust_111',\n-            name: 'Jest_User',\n-            currency: 'sgd',\n-            description: 'Jest User Account created'\n-          })\n-        )\n-      },\n-      subscriptions: {\n-        create: mockSubCreate\n-      }\n-    };\n-  });\n-});\n-\n+const testEWalletEmail = 'baz@bar.com';\n+const testSubscriptionId = 'sub_test_id';\n+const testCustomerId = 'cust_test_id';\n const userWithoutProgress: Prisma.userCreateInput =\n   createUserInput(defaultUserEmail);\n-\n const userWithProgress: Prisma.userCreateInput = {\n   ...createUserInput(defaultUserEmail),\n   completedChallenges: [\n@@ -79,12 +42,124 @@ const userWithProgress: Prisma.userCreateInput = {\n     }\n   ]\n };\n+const sharedDonationReqBody = {\n+  amount: 500,\n+  duration: 'month'\n+};\n+const chargeStripeReqBody = {\n+  email: testEWalletEmail,\n+  subscriptionId: 'sub_test_id',\n+  ...sharedDonationReqBody\n+};\n+const chargeStripeCardReqBody = {\n+  paymentMethodId: 'UID',\n+  ...sharedDonationReqBody\n+};\n+const createStripePaymentIntentReqBody = {\n+  email: testEWalletEmail,\n+  name: 'Baz Bar',\n+  token: { id: 'tok_123' },\n+  ...sharedDonationReqBody\n+};\n+const mockSubCreate = jest.fn();\n+const mockAttachPaymentMethod = jest.fn(() =>\n+  Promise.resolve({\n+    id: 'pm_1MqLiJLkdIwHu7ixUEgbFdYF',\n+    object: 'payment_method'\n+  })\n+);\n+const mockCustomerCreate = jest.fn(() =>\n+  Promise.resolve({\n+    id: testCustomerId,\n+    name: 'Jest_User',\n+    currency: 'sgd',\n+    description: 'Jest User Account created'\n+  })\n+);\n+const mockSubRetrieveObj = {\n+  id: testSubscriptionId,\n+  items: {\n+    data: [\n+      {\n+        plan: {\n+          product: 'prod_GD1GGbJsqQaupl'\n+        }\n+      }\n+    ]\n+  },\n+  // 1 Jan 2040\n+  current_period_start: Math.floor(Date.now() / 1000),\n+  customer: testCustomerId,\n+  status: 'active'\n+};\n+const mockSubRetrieve = jest.fn(() => Promise.resolve(mockSubRetrieveObj));\n+const mockCustomerUpdate = jest.fn();\n+const generateMockSubCreate = (status: string) => () =>\n+  Promise.resolve({\n+    id: testSubscriptionId,\n+    latest_invoice: {\n+      payment_intent: {\n+        client_secret: 'superSecret',\n+        status\n+      }\n+    }\n+  });\n+const defaultError = () =>\n+  Promise.reject(new Error('Stripe encountered an error'));\n+\n+jest.mock('stripe', () => {\n+  return jest.fn().mockImplementation(() => {\n+    return {\n+      customers: {\n+        create: mockCustomerCreate,\n+        update: mockCustomerUpdate\n+      },\n+      paymentMethods: {\n+        attach: mockAttachPaymentMethod\n+      },\n+      subscriptions: {\n+        create: mockSubCreate,\n+        retrieve: mockSubRetrieve\n+      }\n+    };\n+  });\n+});\n \n describe('Donate', () => {\n   setupServer();\n-\n   describe('Authenticated User', () => {\n     let superPost: ReturnType<typeof createSuperRequest>;\n+    const verifyUpdatedUserAndNewDonation = async (email: string) => {\n+      const user = await fastifyTestInstance.prisma.user.findFirst({\n+        where: { email }\n+      });\n+      const donations = await fastifyTestInstance.prisma.donation.findMany({\n+        where: { userId: user?.id }\n+      });\n+      const donation = donations[0];\n+      expect(donations.length).toBe(1);\n+      expect(donation?.amount).toBe(sharedDonationReqBody.amount);\n+      expect(donation?.duration).toBe(sharedDonationReqBody.duration);\n+      expect(typeof donation?.subscriptionId).toBe('string');\n+      expect(donation?.customerId).toBe(testCustomerId);\n+      expect(donation?.provider).toBe('stripe');\n+    };\n+    const verifyNoUpdatedUserAndNoNewDonation = async (email: string) => {\n+      const user = await fastifyTestInstance.prisma.user.findFirst({\n+        where: { email }\n+      });\n+      const donations = await fastifyTestInstance.prisma.donation.findMany({});\n+      expect(user?.isDonating).toBe(false);\n+      expect(donations.length).toBe(0);\n+    };\n+    const verifyNoNewUserAndNoNewDonation = async () => {\n+      const user = await fastifyTestInstance.prisma.user.findFirst({\n+        where: { email: testEWalletEmail }\n+      });\n+      const donations = await fastifyTestInstance.prisma.donation.findMany({});\n+      expect(user).toBe(null);\n+      expect(donations.length).toBe(0);\n+    };\n \n     beforeEach(async () => {\n       const setCookies = await devLogin();\n@@ -93,6 +168,10 @@ describe('Donate', () => {\n         where: { email: userWithProgress.email },\n         data: userWithProgress\n       });\n+      await fastifyTestInstance.prisma.user.deleteMany({\n+        where: { email: testEWalletEmail }\n+      });\n+      await fastifyTestInstance.prisma.donation.deleteMany({});\n     });\n \n     describe('POST /donate/charge-stripe-card', () => {\n@@ -103,6 +182,7 @@ describe('Donate', () => {\n         const response = await superPost('/donate/charge-stripe-card').send(\n           chargeStripeCardReqBody\n         );\n+        await verifyUpdatedUserAndNewDonation(userWithProgress.email);\n         expect(response.body).toEqual({ isDonating: true, type: 'success' });\n         expect(response.status).toBe(200);\n       });\n@@ -114,7 +194,7 @@ describe('Donate', () => {\n         const response = await superPost('/donate/charge-stripe-card').send(\n           chargeStripeCardReqBody\n         );\n-\n+        await verifyNoUpdatedUserAndNoNewDonation(userWithProgress.email);\n         expect(response.body).toEqual({\n           error: {\n             type: 'UserActionRequired',\n@@ -132,7 +212,7 @@ describe('Donate', () => {\n         const response = await superPost('/donate/charge-stripe-card').send(\n           chargeStripeCardReqBody\n         );\n-\n+        await verifyNoUpdatedUserAndNoNewDonation(userWithProgress.email);\n         expect(response.body).toEqual({\n           error: {\n             type: 'PaymentMethodRequired',\n@@ -149,11 +229,13 @@ describe('Donate', () => {\n         const successResponse = await superPost(\n           '/donate/charge-stripe-card'\n         ).send(chargeStripeCardReqBody);\n-\n-        expect(successResponse.status).toBe(200);\n         const failResponse = await superPost('/donate/charge-stripe-card').send(\n           chargeStripeCardReqBody\n         );\n+\n+        //Verify that only the first call changed the DB\n+        await verifyUpdatedUserAndNewDonation(userWithProgress.email);\n+        expect(successResponse.status).toBe(200);\n         expect(failResponse.body).toEqual({\n           error: {\n             type: 'AlreadyDonatingError',\n@@ -168,6 +250,7 @@ describe('Donate', () => {\n         const response = await superPost('/donate/charge-stripe-card').send(\n           chargeStripeCardReqBody\n         );\n+        await verifyNoUpdatedUserAndNoNewDonation(userWithProgress.email);\n         expect(response.status).toBe(500);\n         expect(response.body).toEqual({\n           error: 'Donation failed due to a server error.'\n@@ -182,6 +265,7 @@ describe('Donate', () => {\n         const failResponse = await superPost('/donate/charge-stripe-card').send(\n           chargeStripeCardReqBody\n         );\n+        await verifyNoUpdatedUserAndNoNewDonation(userWithProgress.email);\n         expect(failResponse.body).toEqual({\n           error: {\n             type: 'MethodRestrictionError',\n@@ -198,7 +282,10 @@ describe('Donate', () => {\n           anything: true,\n           itIs: 'ignored'\n         });\n-\n+        const user = await fastifyTestInstance.prisma.user.findFirst({\n+          where: { email: userWithProgress.email }\n+        });\n+        expect(user?.isDonating).toBe(true);\n         expect(response.body).toEqual({\n           isDonating: true\n         });\n@@ -214,6 +301,134 @@ describe('Donate', () => {\n         expect(failResponse.status).toBe(400);\n       });\n     });\n+\n+    describe('POST /donate/create-stripe-payment-intent', () => {\n+      it('should return 200 and call stripe api properly', async () => {\n+        mockSubCreate.mockImplementationOnce(\n+          generateMockSubCreate('no-errors')\n+        );\n+        const response = await superPost(\n+          '/donate/create-stripe-payment-intent'\n+        ).send(createStripePaymentIntentReqBody);\n+        expect(mockCustomerCreate).toHaveBeenCalledWith({\n+          email: testEWalletEmail,\n+          name: 'Baz Bar'\n+        });\n+        expect(response.status).toBe(200);\n+      });\n+\n+      it('should return 400 when email format is wrong', async () => {\n+        const response = await superPost(\n+          '/donate/create-stripe-payment-intent'\n+        ).send({\n+          ...createStripePaymentIntentReqBody,\n+          email: '12raqdcev'\n+        });\n+        expect(response.body).toEqual({\n+          error: 'The donation form had invalid values for this submission.'\n+        });\n+        expect(response.status).toBe(400);\n+      });\n+\n+      it('should return 400 if amount is incorrect', async () => {\n+        const response = await superPost(\n+          '/donate/create-stripe-payment-intent'\n+        ).send({\n+          ...createStripePaymentIntentReqBody,\n+          amount: '350'\n+        });\n+        expect(response.body).toEqual({\n+          error: 'The donation form had invalid values for this submission.'\n+        });\n+        expect(response.status).toBe(400);\n+      });\n+\n+      it('should return 500 if Stripe encounters an error', async () => {\n+        mockSubCreate.mockImplementationOnce(defaultError);\n+        const response = await superPost(\n+          '/donate/create-stripe-payment-intent'\n+        ).send(createStripePaymentIntentReqBody);\n+        expect(response.body).toEqual({\n+          error: 'Donation failed due to a server error.'\n+        });\n+        expect(response.status).toBe(500);\n+      });\n+    });\n+\n+    describe('POST /donate/charge-stripe', () => {\n+      it('should return 200 and call stripe api properly', async () => {\n+        mockSubCreate.mockImplementationOnce(\n+          generateMockSubCreate('no-errors')\n+        );\n+        const response = await superPost('/donate/charge-stripe').send(\n+          chargeStripeReqBody\n+        );\n+        await verifyUpdatedUserAndNewDonation(testEWalletEmail);\n+        expect(mockSubRetrieve).toHaveBeenCalledWith('sub_test_id');\n+        expect(response.status).toBe(200);\n+      });\n+\n+      it('should return 500 when if product id is wrong', async () => {\n+        mockSubRetrieve.mockImplementationOnce(() =>\n+          Promise.resolve({\n+            ...mockSubRetrieveObj,\n+            items: {\n+              ...mockSubRetrieveObj.items,\n+              data: [\n+                {\n+                  ...mockSubRetrieveObj.items.data[0],\n+                  plan: {\n+                    product: 'wrong_product_id'\n+                  }\n+                }\n+              ]\n+            }\n+          })\n+        );\n+        const response = await superPost('/donate/charge-stripe').send(\n+          chargeStripeReqBody\n+        );\n+        await verifyNoNewUserAndNoNewDonation();\n+        expect(response.body).toEqual({\n+          error: 'Donation failed due to a server error.'\n+        });\n+        expect(response.status).toBe(500);\n+      });\n+\n+      it('should return 500 if subsciption is not active', async () => {\n+        mockSubRetrieve.mockImplementationOnce(() =>\n+          Promise.resolve({\n+            ...mockSubRetrieveObj,\n+            status: 'canceled'\n+          })\n+        );\n+        const response = await superPost('/donate/charge-stripe').send(\n+          chargeStripeReqBody\n+        );\n+        await verifyNoNewUserAndNoNewDonation();\n+        expect(response.body).toEqual({\n+          error: 'Donation failed due to a server error.'\n+        });\n+        expect(response.status).toBe(500);\n+      });\n+\n+      it('should return 500 if timestamp is old', async () => {\n+        mockSubRetrieve.mockImplementationOnce(() =>\n+          Promise.resolve({\n+            ...mockSubRetrieveObj,\n+            current_period_start: Math.floor(Date.now() / 1000) - 500\n+          })\n+        );\n+        const response = await superPost('/donate/charge-stripe').send(\n+          chargeStripeReqBody\n+        );\n+        await verifyNoNewUserAndNoNewDonation();\n+        expect(response.body).toEqual({\n+          error: 'Donation failed due to a server error.'\n+        });\n+        expect(response.status).toBe(500);\n+      });\n+    });\n   });\n \n   describe('Unauthenticated User', () => {\n@@ -223,10 +438,12 @@ describe('Donate', () => {\n       const res = await superRequest('/status/ping', { method: 'GET' });\n       setCookies = res.get('Set-Cookie');\n     });\n+\n     const endpoints: { path: string; method: 'POST' }[] = [\n       { path: '/donate/add-donation', method: 'POST' },\n       { path: '/donate/charge-stripe-card', method: 'POST' }\n     ];\n+\n     endpoints.forEach(({ path, method }) => {\n       test(`${method} ${path} returns 401 status code with error message`, async () => {\n         const response = await superRequest(path, {\n@@ -236,5 +453,26 @@ describe('Donate', () => {\n         expect(response.statusCode).toBe(401);\n       });\n     });\n+\n+    test('POST /donate/create-stripe-payment-intent should return 200', async () => {\n+      mockSubCreate.mockImplementationOnce(generateMockSubCreate('no-errors'));\n+      const response = await superRequest(\n+        '/donate/create-stripe-payment-intent',\n+        {\n+          method: 'POST',\n+          setCookies\n+        }\n+      ).send(createStripePaymentIntentReqBody);\n+      expect(response.status).toBe(200);\n+    });\n+\n+    test('POST /donate/charge-stripe should return 200', async () => {\n+      mockSubCreate.mockImplementationOnce(generateMockSubCreate('no-errors'));\n+      const response = await superRequest('/donate/charge-stripe', {\n+        method: 'POST',\n+        setCookies\n+      }).send(chargeStripeReqBody);\n+      expect(response.status).toBe(200);\n+    });\n   });\n });"
        },
        {
            "sha": "ad80c1fd545f852d7c752a87398ad992f5943045",
            "filename": "api/src/routes/donate.ts",
            "status": "modified",
            "additions": 165,
            "deletions": 5,
            "changes": 170,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Froutes%2Fdonate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Froutes%2Fdonate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fdonate.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -3,13 +3,17 @@ import {\n   type FastifyPluginCallbackTypebox\n } from '@fastify/type-provider-typebox';\n import Stripe from 'stripe';\n-\n-import { donationSubscriptionConfig } from '../../../shared/config/donation-settings';\n+import {\n+  donationSubscriptionConfig,\n+  allStripeProductIdsArray\n+} from '../../../shared/config/donation-settings';\n import * as schemas from '../schemas';\n import { STRIPE_SECRET_KEY } from '../utils/env';\n+import { inLastFiveMinutes } from '../utils/validate-donation';\n+import { findOrCreateUser } from './helpers/auth-helpers';\n \n /**\n- * Plugin for the donation endpoints.\n+ * Plugin for the donation endpoints requiring auth.\n  *\n  * @param fastify The Fastify instance.\n  * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n@@ -22,7 +26,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n ) => {\n   // Stripe plugin\n   const stripe = new Stripe(STRIPE_SECRET_KEY, {\n-    apiVersion: '2020-08-27',\n+    apiVersion: '2024-06-20',\n     typescript: true\n   });\n \n@@ -173,7 +177,7 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n           duration,\n           provider: 'stripe',\n           subscriptionId,\n-          customerId: id,\n+          customerId: customerId,\n           // TODO(Post-MVP) migrate to startDate: new Date()\n           startDate: {\n             date: new Date().toISOString(),\n@@ -208,3 +212,159 @@ export const donateRoutes: FastifyPluginCallbackTypebox = (\n \n   done();\n };\n+\n+/**\n+ * Plugin for public donation endpoints.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n+ * @param done The callback to signal that the plugin is ready.\n+ */\n+export const chargeStripeRoute: FastifyPluginCallbackTypebox = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  // Stripe plugin\n+  const stripe = new Stripe(STRIPE_SECRET_KEY, {\n+    apiVersion: '2024-06-20',\n+    typescript: true\n+  });\n+\n+  fastify.post(\n+    '/donate/create-stripe-payment-intent',\n+    {\n+      schema: schemas.createStripePaymentIntent\n+    },\n+    async (req, reply) => {\n+      const { email, name, amount, duration } = req.body;\n+\n+      if (!donationSubscriptionConfig.plans[duration].includes(amount)) {\n+        void reply.code(400);\n+        return {\n+          error: 'The donation form had invalid values for this submission.'\n+        } as const;\n+      }\n+\n+      try {\n+        const stripeCustomer = await stripe.customers.create({\n+          email,\n+          name\n+        });\n+\n+        const stripeSubscription = await stripe.subscriptions.create({\n+          customer: stripeCustomer.id,\n+          items: [\n+            {\n+              plan: `${donationSubscriptionConfig.duration[duration]}-donation-${amount}`\n+            }\n+          ],\n+          payment_behavior: 'default_incomplete',\n+          payment_settings: { save_default_payment_method: 'on_subscription' },\n+          expand: ['latest_invoice.payment_intent']\n+        });\n+\n+        if (\n+          stripeSubscription.latest_invoice &&\n+          typeof stripeSubscription.latest_invoice !== 'string' &&\n+          stripeSubscription.latest_invoice.payment_intent &&\n+          typeof stripeSubscription.latest_invoice.payment_intent !==\n+            'string' &&\n+          stripeSubscription.latest_invoice.payment_intent.client_secret !==\n+            null\n+        ) {\n+          const clientSecret =\n+            stripeSubscription.latest_invoice.payment_intent.client_secret;\n+          return reply.send({\n+            subscriptionId: stripeSubscription.id,\n+            clientSecret\n+          });\n+        } else {\n+          throw new Error('Stripe payment intent client secret is missing');\n+        }\n+      } catch (error) {\n+        fastify.log.error(error);\n+        fastify.Sentry.captureException(error);\n+        void reply.code(500);\n+        return reply.send({\n+          error: 'Donation failed due to a server error.'\n+        });\n+      }\n+    }\n+  );\n+\n+  fastify.post(\n+    '/donate/charge-stripe',\n+    {\n+      schema: schemas.chargeStripe\n+    },\n+    async (req, reply) => {\n+      try {\n+        const { email, amount, duration, subscriptionId } = req.body;\n+\n+        const subscription =\n+          await stripe.subscriptions.retrieve(subscriptionId);\n+        const isSubscriptionActive = subscription.status === 'active';\n+        const productId = subscription.items.data[0]?.plan.product?.toString();\n+        const isStartedRecently = inLastFiveMinutes(\n+          subscription.current_period_start\n+        );\n+        const isProductIdValid =\n+          productId && allStripeProductIdsArray.includes(productId);\n+        const isValidCustomer = typeof subscription.customer === 'string';\n+\n+        if (!isSubscriptionActive)\n+          throw new Error(\n+            `Stripe subscription information is invalid: ${subscriptionId}`\n+          );\n+        if (!isProductIdValid)\n+          throw new Error(`Product ID is invalid: ${subscriptionId}`);\n+        if (!isStartedRecently)\n+          throw new Error(`Subscription is not recent: ${subscriptionId}`);\n+        if (!isValidCustomer)\n+          throw new Error(`Customer ID is invalid: ${subscriptionId}`);\n+        else {\n+          // TODO(Post-MVP) new users should not be created if user is not found\n+          const user = await findOrCreateUser(fastify, email);\n+          const donation = {\n+            userId: user.id,\n+            email,\n+            amount,\n+            duration,\n+            provider: 'stripe',\n+            subscriptionId,\n+            customerId: subscription.customer as string,\n+            // TODO(Post-MVP) migrate to startDate: new Date()\n+            startDate: {\n+              date: new Date().toISOString(),\n+              when: new Date().toISOString().replace(/.$/, '+00:00')\n+            }\n+          };\n+\n+          await fastify.prisma.donation.create({\n+            data: donation\n+          });\n+\n+          await fastify.prisma.user.update({\n+            where: { id: user.id },\n+            data: {\n+              isDonating: true\n+            }\n+          });\n+          return reply.send({\n+            isDonating: true\n+          });\n+        }\n+      } catch (error) {\n+        fastify.log.error(error);\n+        fastify.Sentry.captureException(error);\n+        void reply.code(500);\n+        return {\n+          error: 'Donation failed due to a server error.'\n+        } as const;\n+      }\n+    }\n+  );\n+\n+  done();\n+};"
        },
        {
            "sha": "2ecf1de3b812c11c26084b5581a0b351297d4c9e",
            "filename": "api/src/schemas.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fschemas.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fschemas.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -12,6 +12,8 @@ export { projectCompleted } from './schemas/challenge/project-completed';\n export { saveChallenge } from './schemas/challenge/save-challenge';\n export { deprecatedEndpoints } from './schemas/deprecated';\n export { chargeStripeCard } from './schemas/donate/charge-stripe-card';\n+export { chargeStripe } from './schemas/donate/charge-stripe';\n+export { createStripePaymentIntent } from './schemas/donate/create-stripe-payment-intent';\n export { resubscribe } from './schemas/email-subscription/resubscribe';\n export { unsubscribe } from './schemas/email-subscription/unsubscribe';\n export { updateMyAbout } from './schemas/settings/update-my-about';"
        },
        {
            "sha": "b1ebe96a789a9c12b52284c78873889d8d1ac106",
            "filename": "api/src/schemas/donate/charge-stripe.ts",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fschemas%2Fdonate%2Fcharge-stripe.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fschemas%2Fdonate%2Fcharge-stripe.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fdonate%2Fcharge-stripe.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -0,0 +1,18 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+\n+export const chargeStripe = {\n+  body: Type.Object({\n+    amount: Type.Number(),\n+    duration: Type.Literal('month'),\n+    email: Type.String({ format: 'email', maxLength: 1024 }),\n+    subscriptionId: Type.String()\n+  }),\n+  response: {\n+    200: Type.Object({\n+      isDonating: Type.Boolean()\n+    }),\n+    default: Type.Object({\n+      error: Type.Literal('Donation failed due to a server error.')\n+    })\n+  }\n+};"
        },
        {
            "sha": "f28827443e529d8fa750a454b1ec7a68c0120613",
            "filename": "api/src/schemas/donate/create-stripe-payment-intent.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fschemas%2Fdonate%2Fcreate-stripe-payment-intent.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Fschemas%2Fdonate%2Fcreate-stripe-payment-intent.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fschemas%2Fdonate%2Fcreate-stripe-payment-intent.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -0,0 +1,24 @@\n+import { Type } from '@fastify/type-provider-typebox';\n+\n+export const createStripePaymentIntent = {\n+  body: Type.Object({\n+    amount: Type.Number(),\n+    duration: Type.Literal('month'),\n+    email: Type.String({ format: 'email', maxLength: 1024 }),\n+    name: Type.String()\n+  }),\n+  response: {\n+    200: Type.Object({\n+      subscriptionId: Type.String(),\n+      clientSecret: Type.String()\n+    }),\n+    400: Type.Object({\n+      error: Type.Literal(\n+        'The donation form had invalid values for this submission.'\n+      )\n+    }),\n+    default: Type.Object({\n+      error: Type.Literal('Donation failed due to a server error.')\n+    })\n+  }\n+};"
        },
        {
            "sha": "16a318d9e04b09d75bee4c8db6f17f185893451a",
            "filename": "api/src/utils/validate-donation.test.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Futils%2Fvalidate-donation.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Futils%2Fvalidate-donation.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fvalidate-donation.test.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -0,0 +1,29 @@\n+import { inLastFiveMinutes } from './validate-donation';\n+\n+describe('inLastFiveMinutes', () => {\n+  beforeAll(() => {\n+    jest.useFakeTimers();\n+  });\n+\n+  afterAll(() => {\n+    jest.useRealTimers();\n+  });\n+\n+  it('should return true if the timestamp is within the last five minutes', () => {\n+    const currentTimestamp = Math.floor(Date.now() / 1000);\n+    const recentTimestamp = currentTimestamp - 100;\n+    expect(inLastFiveMinutes(recentTimestamp)).toBe(true);\n+  });\n+\n+  it('should return false if the timestamp is more than five minutes ago', () => {\n+    const currentTimestamp = Math.floor(Date.now() / 1000);\n+    const oldTimestamp = currentTimestamp - 400;\n+    expect(inLastFiveMinutes(oldTimestamp)).toBe(false);\n+  });\n+\n+  it('should return true if the timestamp is exactly five minutes ago', () => {\n+    const currentTimestamp = Math.floor(Date.now() / 1000);\n+    const exactTimestamp = currentTimestamp - 300;\n+    expect(inLastFiveMinutes(exactTimestamp)).toBe(true);\n+  });\n+});"
        },
        {
            "sha": "d51daaecc0a374596b8b8e4466503c7ba0be7f51",
            "filename": "api/src/utils/validate-donation.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Futils%2Fvalidate-donation.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/api%2Fsrc%2Futils%2Fvalidate-donation.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fvalidate-donation.ts?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * Checks if a timestamp was created within five minutes.\n+ * @param unixTimestamp - A unix timestamp .\n+ * @returns - The generated email template.\n+ */\n+export const inLastFiveMinutes = (unixTimestamp: number) => {\n+  const currentTimestamp = Math.floor(Date.now() / 1000);\n+  const timeDifference = currentTimestamp - unixTimestamp;\n+  return timeDifference <= 300; // 300 seconds is 5 minutes\n+};"
        },
        {
            "sha": "cbe0d2df3ef456f950a689630e138d98bfc8fae9",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=b2518cc347fd7d0656bfd20e3d03f3ac8a4ae073",
            "patch": "@@ -238,8 +238,8 @@ importers:\n         specifier: ^2.3.2\n         version: 2.3.2\n       stripe:\n-        specifier: 8.222.0\n-        version: 8.222.0\n+        specifier: 16.0.0\n+        version: 16.0.0\n       validator:\n         specifier: 13.11.0\n         version: 13.11.0\n@@ -12669,14 +12669,14 @@ packages:\n     resolution: {integrity: sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==}\n     engines: {node: '>=8'}\n \n+  stripe@16.0.0:\n+    resolution: {integrity: sha512-HNPTzXrSompUxeGqDpbNmPvH/UEzziIxGWvTDTZwIBLlL6CFqR+3YLpV+g4HXOsPKbQRguauptQwVWO7Y/yEGg==}\n+    engines: {node: '>=12.*'}\n+\n   stripe@8.205.0:\n     resolution: {integrity: sha512-hmYnc7je6j0n9GlkUpc8USsUquLzSxmWj78g9NKFokCtSybNy7y9fYS+VB5AuZUwmIkzhTczgf+TaSmI4kbk9A==}\n     engines: {node: ^8.1 || >=10.*}\n \n-  stripe@8.222.0:\n-    resolution: {integrity: sha512-hrA79fjmN2Eb6K3kxkDzU4ODeVGGjXQsuVaAPSUro6I9MM3X+BvIsVqdphm3BXWfimAGFvUqWtPtHy25mICY1w==}\n-    engines: {node: ^8.1 || >=10.*}\n-\n   strnum@1.0.5:\n     resolution: {integrity: sha512-J8bbNyKKXl5qYcR36TIO8W3mVGVHrmmxsd5PAItGkmyzwJvybiw2IVq5nqd0i4LSNSkB/sx9VHllbfFdr9k1JA==}\n \n@@ -30088,14 +30088,14 @@ snapshots:\n \n   strip-json-comments@3.1.1: {}\n \n-  stripe@8.205.0:\n+  stripe@16.0.0:\n     dependencies:\n-      '@types/node': 20.8.0\n+      '@types/node': 20.12.8\n       qs: 6.11.2\n \n-  stripe@8.222.0:\n+  stripe@8.205.0:\n     dependencies:\n-      '@types/node': 20.8.2\n+      '@types/node': 20.8.0\n       qs: 6.11.2\n \n   strnum@1.0.5: {}"
        }
    ],
    "stats": {
        "total": 608,
        "additions": 545,
        "deletions": 63
    }
}