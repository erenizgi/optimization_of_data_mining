{
    "author": "ojeytonwilliams",
    "message": "chore(api): log growthbook initialization failures (#59889)\n\nCo-authored-by: Mrugesh Mohapatra <1884376+raisedadead@users.noreply.github.com>\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "37028f2bb80b532bf22092ca837c1f754eda93d1",
    "files": [
        {
            "sha": "9c98251a8b505b644292be473c6173c1e9f2fcd4",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/37028f2bb80b532bf22092ca837c1f754eda93d1/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/37028f2bb80b532bf22092ca837c1f754eda93d1/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=37028f2bb80b532bf22092ca837c1f754eda93d1",
            "patch": "@@ -2,7 +2,6 @@ import fastifyAccepts from '@fastify/accepts';\n import fastifySwagger from '@fastify/swagger';\n import fastifySwaggerUI from '@fastify/swagger-ui';\n import type { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';\n-import { GrowthBook } from '@growthbook/growthbook';\n import Ajv from 'ajv';\n import addFormats from 'ajv-formats';\n import uriResolver from 'fast-uri';\n@@ -60,12 +59,6 @@ type FastifyInstanceWithTypeProvider = FastifyInstance<\n   TypeBoxTypeProvider\n >;\n \n-declare module 'fastify' {\n-  interface FastifyInstance {\n-    gb: GrowthBook;\n-  }\n-}\n-\n // Options that fastify uses\n const ajv = new Ajv({\n   coerceTypes: 'array', // change data type of data to match type keyword"
        },
        {
            "sha": "569ce4ac403288e01b9d3da3f6784d5d3152f700",
            "filename": "api/src/plugins/growth-book.test.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/37028f2bb80b532bf22092ca837c1f754eda93d1/api%2Fsrc%2Fplugins%2Fgrowth-book.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/37028f2bb80b532bf22092ca837c1f754eda93d1/api%2Fsrc%2Fplugins%2Fgrowth-book.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fgrowth-book.test.ts?ref=37028f2bb80b532bf22092ca837c1f754eda93d1",
            "patch": "@@ -0,0 +1,29 @@\n+import Fastify, { type FastifyInstance } from 'fastify';\n+import growthBook from './growth-book';\n+\n+const captureException = jest.fn();\n+\n+describe('growth-book', () => {\n+  let fastify: FastifyInstance;\n+  beforeAll(() => {\n+    fastify = Fastify();\n+    // @ts-expect-error we're mocking the Sentry plugin\n+    fastify.Sentry = { captureException };\n+  });\n+\n+  afterAll(async () => {\n+    await fastify.close();\n+  });\n+\n+  it('should log the error if the GrowthBook initialization fails', async () => {\n+    const spy = jest.spyOn(fastify.log, 'error');\n+\n+    await fastify.register(growthBook, {\n+      apiHost: 'invalid-url',\n+      clientKey: 'invalid-key'\n+    });\n+\n+    expect(spy).toHaveBeenCalled();\n+    expect(captureException).toHaveBeenCalled();\n+  });\n+});"
        },
        {
            "sha": "d8a57ac6d5bc8e85f051bd54e1ab5f5095167041",
            "filename": "api/src/plugins/growth-book.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/37028f2bb80b532bf22092ca837c1f754eda93d1/api%2Fsrc%2Fplugins%2Fgrowth-book.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/37028f2bb80b532bf22092ca837c1f754eda93d1/api%2Fsrc%2Fplugins%2Fgrowth-book.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fgrowth-book.ts?ref=37028f2bb80b532bf22092ca837c1f754eda93d1",
            "patch": "@@ -2,9 +2,20 @@ import { GrowthBook, Options } from '@growthbook/growthbook';\n import { FastifyPluginAsync } from 'fastify';\n import fp from 'fastify-plugin';\n \n+declare module 'fastify' {\n+  interface FastifyInstance {\n+    gb: GrowthBook;\n+  }\n+}\n+\n const growthBook: FastifyPluginAsync<Options> = async (fastify, options) => {\n   const gb = new GrowthBook(options);\n-  await gb.init({ timeout: 3000 });\n+  const res = await gb.init({ timeout: 3000 });\n+\n+  if (res.error) {\n+    fastify.log.error(res.error, 'Failed to initialize GrowthBook');\n+    fastify.Sentry.captureException(res.error);\n+  }\n \n   fastify.decorate('gb', gb);\n "
        }
    ],
    "stats": {
        "total": 49,
        "additions": 41,
        "deletions": 8
    }
}