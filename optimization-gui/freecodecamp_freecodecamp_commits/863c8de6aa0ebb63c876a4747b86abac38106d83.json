{
    "author": "raisedadead",
    "message": "fix(GHA): update checks and exits",
    "sha": "863c8de6aa0ebb63c876a4747b86abac38106d83",
    "files": [
        {
            "sha": "c3b6a0925d51443f2fe9f50e4601981f84bd0df7",
            "filename": ".github/workflows/deploy-legacy.yml",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/863c8de6aa0ebb63c876a4747b86abac38106d83/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/863c8de6aa0ebb63c876a4747b86abac38106d83/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-legacy.yml?ref=863c8de6aa0ebb63c876a4747b86abac38106d83",
            "patch": "@@ -11,6 +11,7 @@ jobs:\n       site_tld: ${{ steps.setup.outputs.site_tld }} # org, dev\n       tgt_env_short: ${{ steps.setup.outputs.tgt_env_short }} # prd, stg\n       tgt_env_long: ${{ steps.setup.outputs.tgt_env_long }} # production, staging\n+      tgt_env_branch: ${{ steps.setup.outputs.tgt_env_branch }} # prod-current, prod-staging\n     steps:\n       - name: Setup\n         id: setup\n@@ -20,11 +21,13 @@ jobs:\n               echo \"site_tld=org\" >> $GITHUB_OUTPUT\n               echo \"tgt_env_short=prd\" >> $GITHUB_OUTPUT\n               echo \"tgt_env_long=production\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_branch=prod-current\" >> $GITHUB_OUTPUT\n               ;;\n             *)\n               echo \"site_tld=dev\" >> $GITHUB_OUTPUT\n               echo \"tgt_env_short=stg\" >> $GITHUB_OUTPUT\n               echo \"tgt_env_long=staging\" >> $GITHUB_OUTPUT\n+              echo \"tgt_env_branch=prod-staging\" >> $GITHUB_OUTPUT\n               ;;\n           esac\n \n@@ -68,25 +71,22 @@ jobs:\n \n       - name: Deploy API\n         run: |\n-          export GIT_SOURCE_BRANCH=prod-${{ needs.setup-jobs.outputs.tgt_env_long }}\n+          export GIT_SOURCE_BRANCH=${{ needs.setup-jobs.outputs.tgt_env_branch }}\n           for i in {1..3}; do\n             TS_MACHINE_NAME=${TS_MACHINE_NAME_PREFIX}-api-${i}\n             ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n               set -e\n               echo \"Deploying API (Legacy) to $TS_MACHINE_NAME\"\n \n               cd /home/$TS_USERNAME/freeCodeCamp\n-              if [ $? -ne 0 ]; then echo \"::error::Failed to change to working directory\"; exit 1; fi\n \n               # Environment setup\n               export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\\$NVM_DIR/nvm.sh\" && \\\n               nvm ls | grep 'default' && \\\n               echo \"Node.js version:\" && node --version\n-              if [ $? -ne 0 ]; then echo \"::error::Failed during environment setup\"; exit 1; fi\n \n               # Stop all PM2 services\n               pm2 stop all\n-              if [ $? -ne 0 ]; then echo \"::error::Failed to stop PM2 services\"; exit 1; fi\n \n               # Git operations\n               git status && \\\n@@ -95,7 +95,6 @@ jobs:\n               git checkout -f $GIT_SOURCE_BRANCH && \\\n               git reset --hard origin/$GIT_SOURCE_BRANCH && \\\n               git status\n-              if [ $? -ne 0 ]; then echo \"::error::Failed during git operations\"; exit 1; fi\n \n               # Build\n               npm i -g pnpm@9 && \\\n@@ -105,14 +104,16 @@ jobs:\n               pnpm prebuild && \\\n               pnpm build:curriculum && \\\n               pnpm build:server\n-              if [ $? -ne 0 ]; then echo \"::error::Failed during build process\"; exit 1; fi\n \n               # Server reload\n               pnpm reload:server && \\\n               pm2 ls && \\\n               pm2 save\n-              if [ $? -ne 0 ]; then echo \"::error::Failed during server reload\"; exit 1; fi\n           EOF\n+            if [ $? -ne 0 ]; then\n+              echo \"::error::Deployment to $TS_MACHINE_NAME failed\"\n+              exit 1\n+            fi\n           done\n \n   client:\n@@ -260,34 +261,32 @@ jobs:\n             tar -xzf $CLIENT_DST -C /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES --strip-components=2 && \\\n             rm $CLIENT_DST && \\\n             du -sh /home/$TS_USERNAME/client/releases/$CLIENT_BINARIES\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to extract client archive\"; exit 1; fi\n \n             cd /home/$TS_USERNAME/client\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to change to working directory\"; exit 1; fi\n \n             # Environment setup\n             export NVM_DIR=\\$HOME/.nvm && [ -s \"\\$NVM_DIR/nvm.sh\" ] && source \"\\$NVM_DIR/nvm.sh\" && \\\n             nvm ls | grep 'default' && \\\n             echo \"Node.js version:\" && node --version\n-            if [ $? -ne 0 ]; then echo \"::error::Failed during environment setup\"; exit 1; fi\n \n             npm install -g serve@13\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to install serve\"; exit 1; fi\n \n             # Primary client setup\n             rm -f client-start-primary.sh && \\\n             echo \"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 50505\" >> client-start-primary.sh && \\\n             chmod +x client-start-primary.sh && \\\n             pm2 delete client-primary || true && \\\n             pm2 start ./client-start-primary.sh --name client-primary\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to setup primary client\"; exit 1; fi\n \n             # Secondary client setup\n             rm -f client-start-secondary.sh && \\\n             echo \"serve -c ../../serve.json releases/$CLIENT_BINARIES -p 52525\" >> client-start-secondary.sh && \\\n             chmod +x client-start-secondary.sh && \\\n             pm2 delete client-secondary || true && \\\n             pm2 start ./client-start-secondary.sh --name client-secondary\n-            if [ $? -ne 0 ]; then echo \"::error::Failed to setup secondary client\"; exit 1; fi\n           EOF\n+            if [ $? -ne 0 ]; then\n+              echo \"::error::Deployment to $TS_MACHINE_NAME failed\"\n+              exit 1\n+            fi\n           done"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 12,
        "deletions": 13
    }
}