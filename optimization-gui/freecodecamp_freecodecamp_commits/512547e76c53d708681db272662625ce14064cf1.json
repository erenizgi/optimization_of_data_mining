{
    "author": "ojeytonwilliams",
    "message": "refactor(api): sensible default cookie config (#55227)",
    "sha": "512547e76c53d708681db272662625ce14064cf1",
    "files": [
        {
            "sha": "21f7c04790a422dd94b49f11ef671d27d287038b",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=512547e76c53d708681db272662625ce14064cf1",
            "patch": "@@ -41,11 +41,9 @@ import { statusRoute } from './routes/status';\n import { userGetRoutes, userRoutes, userPublicGetRoutes } from './routes/user';\n import {\n   API_LOCATION,\n-  COOKIE_DOMAIN,\n   EMAIL_PROVIDER,\n   FCC_ENABLE_DEV_LOGIN_MODE,\n   FCC_ENABLE_SWAGGER_UI,\n-  FREECODECAMP_NODE_ENV,\n   SENTRY_DSN\n } from './utils/env';\n import { isObjectID } from './utils/validation';\n@@ -127,7 +125,8 @@ export const build = async (\n \n     ///Ignore all other possible sources of CSRF\n     // tokens since we know we can provide this one\n-    getToken: req => req.headers['csrf-token'] as string\n+    getToken: req => req.headers['csrf-token'] as string,\n+    cookieOpts: { signed: false, sameSite: 'strict' }\n   });\n \n   // All routes except signout should add a CSRF token to the response\n@@ -136,13 +135,9 @@ export const build = async (\n \n     if (!isSignout) {\n       const token = reply.generateCsrf();\n-      // Path is necessary to ensure that only one cookie is set and it is valid\n-      // for all routes.\n       void reply.setCookie('csrf_token', token, {\n-        path: '/',\n         sameSite: 'strict',\n-        domain: COOKIE_DOMAIN,\n-        secure: FREECODECAMP_NODE_ENV === 'production'\n+        signed: false\n       });\n     }\n     done();"
        },
        {
            "sha": "b76594ab261135fb8278028a163476c3150dbb5c",
            "filename": "api/src/plugins/code-flow-auth.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcode-flow-auth.ts?ref=512547e76c53d708681db272662625ce14064cf1",
            "patch": "@@ -3,7 +3,7 @@ import fp from 'fastify-plugin';\n import jwt from 'jsonwebtoken';\n import { type user } from '@prisma/client';\n \n-import { COOKIE_DOMAIN, JWT_SECRET } from '../utils/env';\n+import { JWT_SECRET } from '../utils/env';\n import { type Token, isExpired } from '../utils/tokens';\n import { getRedirectParams } from '../utils/redirection';\n \n@@ -27,12 +27,8 @@ const codeFlowAuth: FastifyPluginCallback = (fastify, _options, done) => {\n   fastify.decorateReply('setAccessTokenCookie', function (accessToken: Token) {\n     const signedToken = jwt.sign({ accessToken }, JWT_SECRET);\n     void this.setCookie('jwt_access_token', signedToken, {\n-      path: '/',\n       httpOnly: false,\n       secure: false,\n-      sameSite: 'lax',\n-      domain: COOKIE_DOMAIN,\n-      signed: true,\n       maxAge: accessToken.ttl\n     });\n   });"
        },
        {
            "sha": "8337a23ea595031ccc68a462d518aa92ea9ca3d2",
            "filename": "api/src/plugins/cookies.test.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fplugins%2Fcookies.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fplugins%2Fcookies.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookies.test.ts?ref=512547e76c53d708681db272662625ce14064cf1",
            "patch": "@@ -4,6 +4,12 @@ import fastifyCookie from '@fastify/cookie';\n import { COOKIE_SECRET } from '../utils/env';\n import cookies from './cookies';\n \n+// eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+jest.mock('../utils/env', () => ({\n+  ...jest.requireActual('../utils/env'),\n+  COOKIE_DOMAIN: 'www.example.com'\n+}));\n+\n describe('cookies', () => {\n   let fastify: FastifyInstance;\n \n@@ -67,4 +73,30 @@ describe('cookies', () => {\n       unsigned: { value: null, renew: false, valid: false }\n     });\n   });\n+\n+  it('should have reasonable defaults', async () => {\n+    fastify.get('/test', async (req, reply) => {\n+      void reply.setCookie('test', 'value');\n+      return { ok: true };\n+    });\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test'\n+    });\n+\n+    // No max-age, so we default to a session cookie.\n+    expect(res.cookies[0]).toStrictEqual({\n+      name: 'test',\n+      // defaults:\n+      domain: 'www.example.com',\n+      httpOnly: true,\n+      path: '/',\n+      sameSite: 'Lax',\n+      secure: true,\n+      // sign by default:\n+      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+      value: expect.stringMatching(/s:value\\.\\w*/)\n+    });\n+  });\n });"
        },
        {
            "sha": "6b5e6b99e97980e206433f95be695cc6d6416cad",
            "filename": "api/src/plugins/cookies.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookies.ts?ref=512547e76c53d708681db272662625ce14064cf1",
            "patch": "@@ -2,7 +2,7 @@ import fastifyCookie from '@fastify/cookie';\n import { FastifyPluginCallback } from 'fastify';\n import fp from 'fastify-plugin';\n \n-import { COOKIE_SECRET } from '../utils/env';\n+import { COOKIE_DOMAIN, COOKIE_SECRET } from '../utils/env';\n \n /**\n  * Signs a cookie value by prefixing it with \"s:\" and using the COOKIE_SECRET.\n@@ -41,6 +41,16 @@ const cookies: FastifyPluginCallback = (fastify, _options, done) => {\n     secret: {\n       sign,\n       unsign\n+    },\n+    parseOptions: {\n+      domain: COOKIE_DOMAIN,\n+      httpOnly: true,\n+      // Path is necessary to ensure that only one cookie is set and it is valid\n+      // for all routes.\n+      path: '/',\n+      sameSite: 'lax',\n+      secure: true,\n+      signed: true\n     }\n   });\n "
        },
        {
            "sha": "60ef6cc9a2f040c16a68f1144291d9770e2e2e9d",
            "filename": "api/src/routes/auth-dev.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Froutes%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Froutes%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth-dev.test.ts?ref=512547e76c53d708681db272662625ce14064cf1",
            "patch": "@@ -180,9 +180,15 @@ describe('dev login', () => {\n       const setCookie = res.headers['set-cookie'];\n       expect(setCookie).toEqual(\n         expect.arrayContaining([\n-          'jwt_access_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT',\n-          '_csrf=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT',\n-          'csrf_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT'\n+          expect.stringMatching(\n+            /^jwt_access_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+          ),\n+          expect.stringMatching(\n+            /^csrf_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+          ),\n+          expect.stringMatching(\n+            /^_csrf=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+          )\n         ])\n       );\n       expect(setCookie).toHaveLength(3);"
        },
        {
            "sha": "67c3c7b95df69d34f139cc183f04d39ebd0795eb",
            "filename": "api/src/routes/user.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/512547e76c53d708681db272662625ce14064cf1/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.test.ts?ref=512547e76c53d708681db272662625ce14064cf1",
            "patch": "@@ -369,9 +369,15 @@ describe('userRoutes', () => {\n         const setCookie = res.headers['set-cookie'];\n         expect(setCookie).toEqual(\n           expect.arrayContaining([\n-            'jwt_access_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT',\n-            '_csrf=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT',\n-            'csrf_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT'\n+            expect.stringMatching(\n+              /^jwt_access_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+            ),\n+            expect.stringMatching(\n+              /^csrf_token=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+            ),\n+            expect.stringMatching(\n+              /^_csrf=; Path=\\/; Expires=Thu, 01 Jan 1970 00:00:00 GMT/\n+            )\n           ])\n         );\n         expect(setCookie).toHaveLength(3);"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 65,
        "deletions": 20
    }
}