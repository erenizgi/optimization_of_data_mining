{
    "author": "ShaunSHamilton",
    "message": "chore(api): add env exam scripts (#58208)\n\nCo-authored-by: Naomi <accounts+github@nhcarrigan.com>",
    "sha": "63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
    "files": [
        {
            "sha": "21c3e027c8b23d5ae2d84938e7b101b666f603d2",
            "filename": "api/__mocks__/env-exam.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2F__mocks__%2Fenv-exam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2F__mocks__%2Fenv-exam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2F__mocks__%2Fenv-exam.ts?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -339,7 +339,8 @@ export const exam: EnvExam = {\n   id: examId,\n   config,\n   questionSets,\n-  prerequisites: ['67112fe1c994faa2c26d0b1d']\n+  prerequisites: ['67112fe1c994faa2c26d0b1d'],\n+  deprecated: false\n };\n \n export async function seedEnvExam() {"
        },
        {
            "sha": "778fb5864c12a1a6fd590087700dd9d2014738ba",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -81,6 +81,8 @@\n     \"postinstall\": \"prisma generate\",\n     \"lint\": \"cd .. && eslint api/src --max-warnings 0\",\n     \"generate-exams\": \"tsx src/exam-environment/generate/index.ts\",\n+    \"deprecate-exam\": \"tsx src/exam-environment/generate/deprecate.ts\",\n+    \"insert-exam\": \"tsx src/exam-environment/generate/insert.ts\",\n     \"seed:env-exam\": \"tsx src/exam-environment/seed/index.ts\"\n   },\n   \"version\": \"0.0.1\""
        },
        {
            "sha": "e17167205d1b89fee11687188ebfc560cbb7b792",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -166,6 +166,8 @@ model EnvExam {\n   config        EnvConfig\n   /// ObjectIds for required challenges/blocks to take the exam\n   prerequisites String[]         @db.ObjectId\n+  /// If `deprecated`, the exam should no longer be considered for users\n+  deprecated    Boolean\n \n   // Relations\n   generatedExams EnvGeneratedExam[]"
        },
        {
            "sha": "5883fbe0835fbca5c2bcff5591f004c77212cdce",
            "filename": "api/src/exam-environment/generate/deprecate.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Fgenerate%2Fdeprecate.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Fgenerate%2Fdeprecate.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fgenerate%2Fdeprecate.ts?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -0,0 +1,52 @@\n+import { PrismaClient } from '@prisma/client';\n+import { MONGOHQ_URL } from '../../utils/env';\n+\n+const args = process.argv.slice(2);\n+const ENV_EXAM_ID = args[0];\n+\n+if (!ENV_EXAM_ID) {\n+  throw 'First argument must be the EnvExam _id';\n+}\n+\n+const prisma = new PrismaClient({\n+  datasources: {\n+    db: {\n+      url: MONGOHQ_URL\n+    }\n+  }\n+});\n+\n+async function main() {\n+  console.info('Connecting to cluster...');\n+  await prisma.$connect();\n+  console.info('Connected.');\n+\n+  try {\n+    await prisma.envExam.update({\n+      where: {\n+        id: ENV_EXAM_ID\n+      },\n+      data: {\n+        deprecated: true\n+      }\n+    });\n+    console.info(`Exam \"${ENV_EXAM_ID}\" deprecated...`);\n+    const res = await prisma.envGeneratedExam.updateMany({\n+      where: {\n+        examId: ENV_EXAM_ID\n+      },\n+      data: {\n+        deprecated: true\n+      }\n+    });\n+\n+    console.info(`${res.count} generated exams deprecated...`);\n+  } catch (e) {\n+    console.error('Unable to deprecate exam due to:');\n+    console.error(e);\n+  }\n+\n+  console.info(`Finished deprecating exam.`);\n+}\n+\n+void main();"
        },
        {
            "sha": "248f6b7897342ce38908ac807fab8685816cb480",
            "filename": "api/src/exam-environment/generate/insert.ts",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Fgenerate%2Finsert.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Fgenerate%2Finsert.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Fgenerate%2Finsert.ts?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -0,0 +1,43 @@\n+import { readFile } from 'fs/promises';\n+import { EnvExam, PrismaClient } from '@prisma/client';\n+import { MONGOHQ_URL } from '../../utils/env';\n+\n+const args = process.argv.slice(2);\n+const EXAM_JSON_PATH = args[0];\n+\n+const prisma = new PrismaClient({\n+  datasources: {\n+    db: {\n+      url: MONGOHQ_URL\n+    }\n+  }\n+});\n+\n+async function main() {\n+  console.info('Connecting to cluster...');\n+  await prisma.$connect();\n+  console.info('Connected.');\n+\n+  if (!EXAM_JSON_PATH) {\n+    throw 'First argument must be the file path to the exam';\n+  }\n+\n+  const exam_str = await readFile(EXAM_JSON_PATH, 'utf-8');\n+\n+  const exam = JSON.parse(exam_str) as EnvExam;\n+\n+  try {\n+    const res = await prisma.envExam.create({\n+      data: exam\n+    });\n+\n+    console.info(\n+      `Exam \"${res.config.name}\" has been assigned id: \"${res.id}\".`\n+    );\n+  } catch (e) {\n+    console.error('Unable to insert exam due to:');\n+    console.error(e);\n+  }\n+}\n+\n+void main();"
        },
        {
            "sha": "1b755e852156d58b8327302a79fc3767f05427f7",
            "filename": "api/src/exam-environment/routes/exam-environment.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.test.ts?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -570,7 +570,6 @@ describe('/exam-environment/', () => {\n           'exam-environment-authorization-token',\n           examEnvironmentAuthorizationToken\n         );\n-        expect(res.status).toBe(200);\n \n         expect(res.body).toStrictEqual({\n           exams: [\n@@ -586,6 +585,26 @@ describe('/exam-environment/', () => {\n             }\n           ]\n         });\n+\n+        expect(res.status).toBe(200);\n+      });\n+\n+      it('should not return any deprecated exams', async () => {\n+        await fastifyTestInstance.prisma.envExam.update({\n+          where: { id: mock.examId },\n+          data: { deprecated: true }\n+        });\n+\n+        const res = await superGet('/exam-environment/exams').set(\n+          'exam-environment-authorization-token',\n+          examEnvironmentAuthorizationToken\n+        );\n+\n+        expect(res.body).toStrictEqual({\n+          exams: []\n+        });\n+\n+        expect(res.status).toBe(200);\n       });\n     });\n   });"
        },
        {
            "sha": "4d820a9c5a8ac344553e6948356f2b2bbcf46ad6",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -557,6 +557,9 @@ async function getExams(\n ) {\n   const user = req.user!;\n   const exams = await this.prisma.envExam.findMany({\n+    where: {\n+      deprecated: false\n+    },\n     select: {\n       id: true,\n       config: true,"
        },
        {
            "sha": "889eefeeb5f66a4f42961dd3976297505819f72f",
            "filename": "api/src/exam-environment/utils/exam.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/63dc0d81aaf55b959bd6d6e4ff16e53199003f0b/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Futils%2Fexam.ts?ref=63dc0d81aaf55b959bd6d6e4ff16e53199003f0b",
            "patch": "@@ -32,7 +32,7 @@ export function checkPrerequisites(\n \n export type UserExam = Omit<\n   EnvExam,\n-  'questionSets' | 'config' | 'id' | 'prerequisites'\n+  'questionSets' | 'config' | 'id' | 'prerequisites' | 'deprecated'\n > & {\n   config: Omit<EnvExam['config'], 'tags' | 'questionSets'>;\n   questionSets: (Omit<EnvQuestionSet, 'questions'> & {"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 125,
        "deletions": 3
    }
}