{
    "author": "ShaunSHamilton",
    "message": "chore(api): add ExamEnvironmentAuthorizationToken -> user relation (#56627)\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "51802492b1ff7b0469b2737178abcfef77d2fa2b",
    "files": [
        {
            "sha": "174ac5c8f4def71a421bec9e283a516437304a20",
            "filename": "api/jest.utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fjest.utils.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fjest.utils.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fjest.utils.ts?ref=51802492b1ff7b0469b2737178abcfef77d2fa2b",
            "patch": "@@ -207,6 +207,11 @@ export const defaultUserEmail = 'foo@bar.com';\n export const defaultUsername = 'fcc-test-user';\n \n export const resetDefaultUser = async (): Promise<void> => {\n+  await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.deleteMany(\n+    {\n+      where: { userId: defaultUserId }\n+    }\n+  );\n   await fastifyTestInstance.prisma.user.deleteMany({\n     where: { email: defaultUserEmail }\n   });"
        },
        {
            "sha": "cec7cf4c82ccd63987731381bd3105351240a631",
            "filename": "api/prisma/schema.prisma",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fprisma%2Fschema.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fprisma%2Fschema.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fschema.prisma?ref=51802492b1ff7b0469b2737178abcfef77d2fa2b",
            "patch": "@@ -143,7 +143,8 @@ model user {\n   isClassroomAccount           Boolean? // Undefined\n \n   // Relations\n-  examAttempts EnvExamAttempt[]\n+  examAttempts                      EnvExamAttempt[]\n+  examEnvironmentAuthorizationToken ExamEnvironmentAuthorizationToken?\n }\n \n // -----------------------------------\n@@ -377,15 +378,13 @@ model UserToken {\n   @@index([userId], map: \"userId_1\")\n }\n \n-/// TODO: Token has to outlive the exam attempt\n-/// Validation has to be taken as the attempt is requested\n-/// to ensure it lives long enough.\n model ExamEnvironmentAuthorizationToken {\n   id          String   @id @map(\"_id\")\n   createdDate DateTime @db.Date\n-  userId      String   @db.ObjectId\n+  userId      String   @unique @db.ObjectId\n \n-  @@index([userId], map: \"userId_1\")\n+  // Relations\n+  user user @relation(fields: [userId], references: [id])\n }\n \n model sessions {"
        },
        {
            "sha": "734924a2799febfdf021503536a60a0bed740cb9",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=51802492b1ff7b0469b2737178abcfef77d2fa2b",
            "patch": "@@ -107,7 +107,7 @@ async function tokenVerifyHandler(\n   const examEnvironmentAuthorizationToken =\n     payload.examEnvironmentAuthorizationToken;\n \n-  const token = await this.prisma.examEnvironmentAuthorizationToken.findFirst({\n+  const token = await this.prisma.examEnvironmentAuthorizationToken.findUnique({\n     where: {\n       id: examEnvironmentAuthorizationToken\n     }"
        },
        {
            "sha": "a8014cfbd64a9835bfeecf627b789e4b448c07a8",
            "filename": "api/src/routes/protected/user.test.ts",
            "status": "modified",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/51802492b1ff7b0469b2737178abcfef77d2fa2b/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fprotected%2Fuser.test.ts?ref=51802492b1ff7b0469b2737178abcfef77d2fa2b",
            "patch": "@@ -16,6 +16,7 @@ import {\n   createSuperRequest\n } from '../../../jest.utils';\n import { JWT_SECRET } from '../../utils/env';\n+import { customNanoid } from '../../utils/ids';\n import { getMsTranscriptApiUrl } from './user';\n \n const mockedFetch = jest.fn();\n@@ -564,6 +565,11 @@ describe('userRoutes', () => {\n         await fastifyTestInstance.prisma.userToken.deleteMany({\n           where: { id: userTokenId }\n         });\n+        await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.deleteMany(\n+          {\n+            where: { userId: defaultUserId }\n+          }\n+        );\n       });\n \n       test('GET rejects with 500 status code if the username is missing', async () => {\n@@ -1130,6 +1136,72 @@ Thanks and regards,\n         });\n       });\n     });\n+\n+    describe('/user/exam-environment/token', () => {\n+      afterEach(async () => {\n+        await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.deleteMany(\n+          {\n+            where: { userId: defaultUserId }\n+          }\n+        );\n+      });\n+\n+      test('POST generates a new token if one does not exist', async () => {\n+        const response = await superPost('/user/exam-environment/token');\n+        const { examEnvironmentAuthorizationToken } = response.body.data;\n+\n+        const decodedToken = jwt.decode(examEnvironmentAuthorizationToken);\n+\n+        expect(decodedToken).toStrictEqual({\n+          examEnvironmentAuthorizationToken:\n+            expect.stringMatching(/^[a-zA-Z0-9]{64}$/),\n+          iat: expect.any(Number)\n+        });\n+\n+        expect(() =>\n+          jwt.verify(examEnvironmentAuthorizationToken, 'wrong-secret')\n+        ).toThrow();\n+        expect(() =>\n+          jwt.verify(examEnvironmentAuthorizationToken, JWT_SECRET)\n+        ).not.toThrow();\n+\n+        expect(response.status).toBe(200);\n+      });\n+\n+      test('POST only allows for one token per user id', async () => {\n+        const id = customNanoid();\n+        await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.create(\n+          {\n+            data: {\n+              userId: defaultUserId,\n+              id,\n+              createdDate: new Date()\n+            }\n+          }\n+        );\n+\n+        const response = await superPost('/user/exam-environment/token');\n+\n+        const { examEnvironmentAuthorizationToken } = response.body.data;\n+\n+        const decodedToken = jwt.decode(examEnvironmentAuthorizationToken);\n+\n+        expect(decodedToken).not.toHaveProperty(\n+          'examEnvironmentAuthorizationToken',\n+          id\n+        );\n+\n+        expect(response.status).toBe(200);\n+\n+        const tokens =\n+          await fastifyTestInstance.prisma.examEnvironmentAuthorizationToken.findMany(\n+            {\n+              where: { userId: defaultUserId }\n+            }\n+          );\n+        expect(tokens).toHaveLength(1);\n+      });\n+    });\n   });\n \n   describe('Unauthenticated user', () => {"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 83,
        "deletions": 7
    }
}