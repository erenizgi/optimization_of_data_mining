{
    "author": "ojeytonwilliams",
    "message": "refactor(api): sync dev and auth0 plugins (#57136)",
    "sha": "2f4e6ae8f5ca557f34c140e3f2640c96e630a680",
    "files": [
        {
            "sha": "bbe7e8efcf1b0c0f88a404f563472023b283f58a",
            "filename": "api/src/plugins/__fixtures__/user.ts",
            "status": "added",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2F__fixtures__%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2F__fixtures__%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2F__fixtures__%2Fuser.ts?ref=2f4e6ae8f5ca557f34c140e3f2640c96e630a680",
            "patch": "@@ -0,0 +1,92 @@\n+import { nanoidCharSet } from '../../utils/create-user';\n+\n+const uuidRe = /^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n+const fccUuidRe = /^fcc-[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n+const unsubscribeIdRe = new RegExp(`^[${nanoidCharSet}]{21}$`);\n+const mongodbIdRe = /^[a-f0-9]{24}$/;\n+\n+\n+// eslint-disable-next-line jsdoc/require-jsdoc\n+export const newUser = (email: string) => ({\n+  about: '',\n+  acceptedPrivacyTerms: false,\n+  completedChallenges: [],\n+  completedExams: [],\n+  currentChallengeId: '',\n+  donationEmails: [],\n+  email,\n+  emailAuthLinkTTL: null,\n+  emailVerified: true,\n+  emailVerifyTTL: null,\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  externalId: expect.stringMatching(uuidRe),\n+  githubProfile: null,\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  id: expect.stringMatching(mongodbIdRe),\n+  is2018DataVisCert: false,\n+  is2018FullStackCert: false,\n+  isApisMicroservicesCert: false,\n+  isBackEndCert: false,\n+  isBanned: false,\n+  isCheater: false,\n+  isClassroomAccount: null,\n+  isDataAnalysisPyCertV7: false,\n+  isDataVisCert: false,\n+  isDonating: false,\n+  isFoundationalCSharpCertV8: false,\n+  isFrontEndCert: false,\n+  isFrontEndLibsCert: false,\n+  isFullStackCert: false,\n+  isHonest: false,\n+  isInfosecCertV7: false,\n+  isInfosecQaCert: false,\n+  isJsAlgoDataStructCert: false,\n+  isJsAlgoDataStructCertV8: false,\n+  isMachineLearningPyCertV7: false,\n+  isQaCertV7: false,\n+  isRelationalDatabaseCertV8: false,\n+  isCollegeAlgebraPyCertV8: false,\n+  isRespWebDesignCert: false,\n+  isSciCompPyCertV7: false,\n+  isUpcomingPythonCertV8: null,\n+  keyboardShortcuts: false,\n+  linkedin: null,\n+  location: '',\n+  name: '',\n+  needsModeration: false,\n+  newEmail: null,\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  unsubscribeId: expect.stringMatching(unsubscribeIdRe),\n+  partiallyCompletedChallenges: [],\n+  password: null,\n+  picture: '',\n+  portfolio: [],\n+  profileUI: {\n+    isLocked: false,\n+    showAbout: false,\n+    showCerts: false,\n+    showDonation: false,\n+    showHeatMap: false,\n+    showLocation: false,\n+    showName: false,\n+    showPoints: false,\n+    showPortfolio: false,\n+    showTimeLine: false\n+  },\n+  progressTimestamps: [expect.any(Number)],\n+  rand: null, // TODO(Post-MVP): delete from schema (it's not used or required).\n+  savedChallenges: [],\n+  sendQuincyEmail: false,\n+  theme: 'default',\n+  timezone: null,\n+  twitter: null,\n+  updateCount: 0, // see extendClient in prisma.ts\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  username: expect.stringMatching(fccUuidRe),\n+  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+  usernameDisplay: expect.stringMatching(fccUuidRe),\n+  verificationToken: null,\n+  website: null,\n+  yearsTopContributor: []\n+}\n+)"
        },
        {
            "sha": "4c772b2a4703ad7dd5e928868ba5ef6bff236b57",
            "filename": "api/src/plugins/auth-dev.test.ts",
            "status": "added",
            "additions": 139,
            "deletions": 0,
            "changes": 139,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth-dev.test.ts?ref=2f4e6ae8f5ca557f34c140e3f2640c96e630a680",
            "patch": "@@ -0,0 +1,139 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n+/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n+import Fastify, { FastifyInstance } from 'fastify';\n+\n+import { defaultUserEmail } from '../../jest.utils';\n+import { HOME_LOCATION } from '../utils/env';\n+import { devAuth } from '../plugins/auth-dev';\n+import prismaPlugin from '../db/prisma';\n+import auth from './auth';\n+import cookies from './cookies';\n+\n+import { newUser } from './__fixtures__/user';\n+\n+describe('dev login', () => {\n+  let fastify: FastifyInstance;\n+\n+  beforeAll(async () => {\n+    fastify = Fastify();\n+\n+    await fastify.register(cookies);\n+    await fastify.register(auth);\n+    await fastify.register(devAuth);\n+    await fastify.register(prismaPlugin);\n+  });\n+\n+  beforeEach(async () => {\n+    await fastify.prisma.user.deleteMany({\n+      where: { email: defaultUserEmail }\n+    });\n+  });\n+\n+  afterAll(async () => {\n+    await fastify.prisma.user.deleteMany({\n+      where: { email: defaultUserEmail }\n+    });\n+    await fastify.close();\n+  });\n+\n+  describe('GET /signin', () => {\n+    it('should create an account if one does not exist', async () => {\n+      const before = await fastify.prisma.user.count({});\n+      await fastify.inject({\n+        method: 'GET',\n+        url: '/signin'\n+      });\n+\n+      const after = await fastify.prisma.user.count({});\n+\n+      expect(before).toBe(0);\n+      expect(after).toBe(before + 1);\n+    });\n+\n+    it('should populate the user with the correct data', async () => {\n+      await fastify.inject({\n+        method: 'GET',\n+        url: '/signin'\n+      });\n+\n+      const user = await fastify.prisma.user.findFirstOrThrow({\n+        where: { email: defaultUserEmail }\n+      });\n+\n+      expect(user).toEqual(newUser(defaultUserEmail));\n+      expect(user.username).toBe(user.usernameDisplay);\n+    });\n+\n+    it('should set the jwt_access_token cookie', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin'\n+      });\n+\n+      expect(res.statusCode).toBe(302);\n+\n+      expect(res.cookies).toEqual(\n+        expect.arrayContaining([\n+          expect.objectContaining({ name: 'jwt_access_token' })\n+        ])\n+      );\n+    });\n+\n+    it.todo('should create a session');\n+\n+    it('should redirect to the Referer (if it is a valid origin)', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin',\n+        headers: {\n+          referer: 'https://www.freecodecamp.org/some-path/or/other'\n+        }\n+      });\n+\n+      expect(res.statusCode).toBe(302);\n+      expect(res.headers.location).toBe(\n+        'https://www.freecodecamp.org/some-path/or/other'\n+      );\n+    });\n+\n+    it('should redirect to /valid-language/learn when signing in from /valid-language', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin',\n+        headers: {\n+          referer: 'https://www.freecodecamp.org/espanol'\n+        }\n+      });\n+\n+      expect(res.statusCode).toBe(302);\n+      expect(res.headers.location).toBe(\n+        'https://www.freecodecamp.org/espanol/learn'\n+      );\n+    });\n+\n+    it('should handle referers with trailing slahes', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin',\n+        headers: {\n+          referer: 'https://www.freecodecamp.org/espanol/'\n+        }\n+      });\n+\n+      expect(res.statusCode).toBe(302);\n+      expect(res.headers.location).toBe(\n+        'https://www.freecodecamp.org/espanol/learn'\n+      );\n+    });\n+\n+    it('should redirect to /learn by default', async () => {\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/signin'\n+      });\n+\n+      expect(res.statusCode).toBe(302);\n+      expect(res.headers.location).toBe(`${HOME_LOCATION}/learn`);\n+    });\n+  });\n+});"
        },
        {
            "sha": "5db34cc837d54450863c313c4baa36aaa32a82cb",
            "filename": "api/src/plugins/auth-dev.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2Fauth-dev.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2Fauth-dev.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth-dev.ts?ref=2f4e6ae8f5ca557f34c140e3f2640c96e630a680",
            "patch": "@@ -0,0 +1,48 @@\n+import type { FastifyPluginCallbackTypebox } from '@fastify/type-provider-typebox';\n+import type { FastifyReply, FastifyRequest } from 'fastify';\n+import {\n+  getRedirectParams,\n+  getPrefixedLandingPath,\n+  haveSamePath\n+} from '../utils/redirection';\n+import { findOrCreateUser } from '../routes/helpers/auth-helpers';\n+import { createAccessToken } from '../utils/tokens';\n+\n+const trimTrailingSlash = (str: string) =>\n+  str.endsWith('/') ? str.slice(0, -1) : str;\n+\n+async function handleRedirects(req: FastifyRequest, reply: FastifyReply) {\n+  const params = getRedirectParams(req);\n+  const { origin, pathPrefix } = params;\n+  const returnTo = trimTrailingSlash(params.returnTo);\n+  const landingUrl = getPrefixedLandingPath(origin, pathPrefix);\n+\n+  return await reply.redirect(\n+    haveSamePath(landingUrl, returnTo) ? `${returnTo}/learn` : returnTo\n+  );\n+}\n+\n+/**\n+ * Fastify plugin for dev authentication.\n+ *\n+ * @param fastify - The Fastify instance.\n+ * @param _options - The plugin options.\n+ * @param done - The callback function.\n+ */\n+export const devAuth: FastifyPluginCallbackTypebox = (\n+  fastify,\n+  _options,\n+  done\n+) => {\n+  fastify.get('/signin', async (req, reply) => {\n+    const email = 'foo@bar.com';\n+\n+    const { id } = await findOrCreateUser(fastify, email);\n+\n+    reply.setAccessTokenCookie(createAccessToken(id));\n+\n+    await handleRedirects(req, reply);\n+  });\n+\n+  done();\n+};"
        },
        {
            "sha": "198b594ae7c45ab2b09850e3ece9040230f5768b",
            "filename": "api/src/plugins/auth0.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 87,
            "changes": 90,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.test.ts?ref=2f4e6ae8f5ca557f34c140e3f2640c96e630a680",
            "patch": "@@ -1,14 +1,15 @@\n const COOKIE_DOMAIN = 'test.com';\n import Fastify, { FastifyInstance } from 'fastify';\n \n-import { createUserInput, nanoidCharSet } from '../utils/create-user';\n+import { createUserInput } from '../utils/create-user';\n import { AUTH0_DOMAIN, HOME_LOCATION } from '../utils/env';\n import prismaPlugin from '../db/prisma';\n import cookies, { sign, unsign } from './cookies';\n import { auth0Client } from './auth0';\n import redirectWithMessage, { formatMessage } from './redirect-with-message';\n import auth from './auth';\n import bouncer from './bouncer';\n+import { newUser } from './__fixtures__/user';\n \n // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n jest.mock('../utils/env', () => ({\n@@ -305,10 +306,6 @@ describe('auth0 plugin', () => {\n \n     it('should populate the user with the correct data', async () => {\n       mockAuthSuccess();\n-      const uuidRe = /^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n-      const fccUuidRe = /^fcc-[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n-      const unsubscribeIdRe = new RegExp(`^[${nanoidCharSet}]{21}$`);\n-      const mongodbIdRe = /^[a-f0-9]{24}$/;\n \n       await fastify.inject({\n         method: 'GET',\n@@ -319,88 +316,7 @@ describe('auth0 plugin', () => {\n         where: { email }\n       });\n \n-      expect(user).toEqual({\n-        about: '',\n-        acceptedPrivacyTerms: false,\n-        completedChallenges: [],\n-        completedExams: [],\n-        currentChallengeId: '',\n-        donationEmails: [],\n-        email,\n-        emailAuthLinkTTL: null,\n-        emailVerified: true,\n-        emailVerifyTTL: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        externalId: expect.stringMatching(uuidRe),\n-        githubProfile: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        id: expect.stringMatching(mongodbIdRe),\n-        is2018DataVisCert: false,\n-        is2018FullStackCert: false,\n-        isApisMicroservicesCert: false,\n-        isBackEndCert: false,\n-        isBanned: false,\n-        isCheater: false,\n-        isClassroomAccount: null,\n-        isDataAnalysisPyCertV7: false,\n-        isDataVisCert: false,\n-        isDonating: false,\n-        isFoundationalCSharpCertV8: false,\n-        isFrontEndCert: false,\n-        isFrontEndLibsCert: false,\n-        isFullStackCert: false,\n-        isHonest: false,\n-        isInfosecCertV7: false,\n-        isInfosecQaCert: false,\n-        isJsAlgoDataStructCert: false,\n-        isJsAlgoDataStructCertV8: false,\n-        isMachineLearningPyCertV7: false,\n-        isQaCertV7: false,\n-        isRelationalDatabaseCertV8: false,\n-        isCollegeAlgebraPyCertV8: false,\n-        isRespWebDesignCert: false,\n-        isSciCompPyCertV7: false,\n-        isUpcomingPythonCertV8: null,\n-        keyboardShortcuts: false,\n-        linkedin: null,\n-        location: '',\n-        name: '',\n-        needsModeration: false,\n-        newEmail: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        unsubscribeId: expect.stringMatching(unsubscribeIdRe),\n-        partiallyCompletedChallenges: [],\n-        password: null,\n-        picture: '',\n-        portfolio: [],\n-        profileUI: {\n-          isLocked: false,\n-          showAbout: false,\n-          showCerts: false,\n-          showDonation: false,\n-          showHeatMap: false,\n-          showLocation: false,\n-          showName: false,\n-          showPoints: false,\n-          showPortfolio: false,\n-          showTimeLine: false\n-        },\n-        progressTimestamps: [expect.any(Number)],\n-        rand: null,\n-        savedChallenges: [],\n-        sendQuincyEmail: false,\n-        theme: 'default',\n-        timezone: null,\n-        twitter: null,\n-        updateCount: 0,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        username: expect.stringMatching(fccUuidRe),\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        usernameDisplay: expect.stringMatching(fccUuidRe),\n-        verificationToken: null,\n-        website: null,\n-        yearsTopContributor: []\n-      });\n+      expect(user).toEqual(newUser(email));\n       expect(user.username).toBe(user.usernameDisplay);\n     });\n   });"
        },
        {
            "sha": "47d66a236aacf450d4b23934918b70bd4b024901",
            "filename": "api/src/routes/public/auth-dev.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 199,
            "changes": 199,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c69e9c6fff756983de768ea9f98a583a5547ff25/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c69e9c6fff756983de768ea9f98a583a5547ff25/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.test.ts?ref=c69e9c6fff756983de768ea9f98a583a5547ff25",
            "patch": "@@ -1,199 +0,0 @@\n-/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n-/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n-import {\n-  defaultUserEmail,\n-  setupServer,\n-  superRequest\n-} from '../../../jest.utils';\n-import { HOME_LOCATION } from '../../utils/env';\n-import { nanoidCharSet } from '../../utils/create-user';\n-\n-describe('dev login', () => {\n-  setupServer();\n-\n-  beforeEach(async () => {\n-    await fastifyTestInstance.prisma.user.deleteMany({\n-      where: { email: defaultUserEmail }\n-    });\n-  });\n-\n-  afterAll(async () => {\n-    await fastifyTestInstance.prisma.user.deleteMany({\n-      where: { email: defaultUserEmail }\n-    });\n-  });\n-\n-  describe('GET /signin', () => {\n-    it('should create an account if one does not exist', async () => {\n-      const res = await superRequest('/signin', { method: 'GET' });\n-\n-      const count = await fastifyTestInstance.prisma.user.count({\n-        where: { email: defaultUserEmail }\n-      });\n-\n-      expect(count).toBe(1);\n-      expect(res.body).toStrictEqual({});\n-      expect(res.status).toBe(302);\n-    });\n-\n-    it('should populate the user with the correct data', async () => {\n-      const uuidRe = /^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n-      const fccUuidRe = /^fcc-[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$/;\n-      const unsubscribeIdRe = new RegExp(`^[${nanoidCharSet}]{21}$`);\n-      const mongodbIdRe = /^[a-f0-9]{24}$/;\n-\n-      await superRequest('/signin', { method: 'GET' });\n-      const user = await fastifyTestInstance.prisma.user.findFirstOrThrow({\n-        where: { email: defaultUserEmail }\n-      });\n-\n-      expect(user).toMatchObject({\n-        about: '',\n-        acceptedPrivacyTerms: false,\n-        completedChallenges: [],\n-        completedExams: [],\n-        currentChallengeId: '',\n-        donationEmails: [],\n-        email: defaultUserEmail,\n-        emailAuthLinkTTL: null,\n-        emailVerified: true,\n-        emailVerifyTTL: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        externalId: expect.stringMatching(uuidRe),\n-        githubProfile: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        id: expect.stringMatching(mongodbIdRe),\n-        is2018DataVisCert: false,\n-        is2018FullStackCert: false,\n-        isApisMicroservicesCert: false,\n-        isBackEndCert: false,\n-        isBanned: false,\n-        isCheater: false,\n-        isClassroomAccount: null,\n-        isDataAnalysisPyCertV7: false,\n-        isDataVisCert: false,\n-        isDonating: false,\n-        isFoundationalCSharpCertV8: false,\n-        isFrontEndCert: false,\n-        isFrontEndLibsCert: false,\n-        isFullStackCert: false,\n-        isHonest: false,\n-        isInfosecCertV7: false,\n-        isInfosecQaCert: false,\n-        isJsAlgoDataStructCert: false,\n-        isJsAlgoDataStructCertV8: false,\n-        isMachineLearningPyCertV7: false,\n-        isQaCertV7: false,\n-        isRelationalDatabaseCertV8: false,\n-        isCollegeAlgebraPyCertV8: false,\n-        isRespWebDesignCert: false,\n-        isSciCompPyCertV7: false,\n-        isUpcomingPythonCertV8: null,\n-        keyboardShortcuts: false,\n-        linkedin: null,\n-        location: '',\n-        name: '',\n-        needsModeration: false,\n-        newEmail: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        unsubscribeId: expect.stringMatching(unsubscribeIdRe),\n-        partiallyCompletedChallenges: [],\n-        password: null,\n-        picture: '',\n-        portfolio: [],\n-        profileUI: {\n-          isLocked: false,\n-          showAbout: false,\n-          showCerts: false,\n-          showDonation: false,\n-          showHeatMap: false,\n-          showLocation: false,\n-          showName: false,\n-          showPoints: false,\n-          showPortfolio: false,\n-          showTimeLine: false\n-        },\n-        progressTimestamps: [expect.any(Number)],\n-        savedChallenges: [],\n-        sendQuincyEmail: false,\n-        theme: 'default',\n-        timezone: null,\n-        twitter: null,\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        username: expect.stringMatching(fccUuidRe),\n-        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n-        usernameDisplay: expect.stringMatching(fccUuidRe),\n-        verificationToken: null,\n-        website: null,\n-        yearsTopContributor: []\n-      });\n-      expect(user.username).toBe(user.usernameDisplay);\n-    });\n-\n-    it('should set the jwt_access_token cookie', async () => {\n-      const res = await superRequest('/signin', { method: 'GET' });\n-\n-      expect(res.status).toBe(302);\n-      expect(res.headers['set-cookie']).toEqual(\n-        expect.arrayContaining([expect.stringMatching(/jwt_access_token=/)])\n-      );\n-      // TODO: check the cookie value\n-    });\n-\n-    it.todo('should create a session');\n-\n-    // duplicate of the server.test test to make sure I've not done something\n-    // silly\n-    it('should have OWASP recommended headers', async () => {\n-      const res = await superRequest('/signin', { method: 'GET' });\n-      expect(res.headers).toMatchObject({\n-        'cache-control': 'no-store',\n-        'content-security-policy': \"frame-ancestors 'none'\",\n-        'x-content-type-options': 'nosniff',\n-        'x-frame-options': 'DENY'\n-      });\n-    });\n-\n-    it('should redirect to the Referer (if it is a valid origin)', async () => {\n-      const res = await superRequest('/signin', { method: 'GET' }).set(\n-        'referer',\n-        'https://www.freecodecamp.org/some-path/or/other'\n-      );\n-\n-      expect(res.status).toBe(302);\n-      expect(res.headers.location).toBe(\n-        'https://www.freecodecamp.org/some-path/or/other'\n-      );\n-    });\n-\n-    it('should redirect to /valid-language/learn when signing in from /valid-language', async () => {\n-      const res = await superRequest('/signin', { method: 'GET' }).set(\n-        'referer',\n-        'https://www.freecodecamp.org/espanol'\n-      );\n-\n-      expect(res.status).toBe(302);\n-      expect(res.headers.location).toBe(\n-        'https://www.freecodecamp.org/espanol/learn'\n-      );\n-    });\n-\n-    it('should handle referers with trailing slahes', async () => {\n-      const res = await superRequest('/signin', {\n-        method: 'GET'\n-      }).set('referer', 'https://www.freecodecamp.org/espanol/');\n-\n-      expect(res.status).toBe(302);\n-      expect(res.headers.location).toBe(\n-        'https://www.freecodecamp.org/espanol/learn'\n-      );\n-    });\n-\n-    it('should redirect to /learn by default', async () => {\n-      const res = await superRequest('/signin', { method: 'GET' });\n-\n-      expect(res.status).toBe(302);\n-      expect(res.headers.location).toBe(`${HOME_LOCATION}/learn`);\n-    });\n-  });\n-});"
        },
        {
            "sha": "04ec983ff19102e41a0d5108564aec59fc3149ac",
            "filename": "api/src/routes/public/auth-dev.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 32,
            "changes": 35,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/2f4e6ae8f5ca557f34c140e3f2640c96e630a680/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fpublic%2Fauth-dev.ts?ref=2f4e6ae8f5ca557f34c140e3f2640c96e630a680",
            "patch": "@@ -1,15 +1,6 @@\n-import { FastifyPluginCallback, FastifyReply, FastifyRequest } from 'fastify';\n+import type { FastifyPluginCallback } from 'fastify';\n \n-import { createAccessToken } from '../../utils/tokens';\n-import {\n-  getPrefixedLandingPath,\n-  getRedirectParams,\n-  haveSamePath\n-} from '../../utils/redirection';\n-import { findOrCreateUser } from '../helpers/auth-helpers';\n-\n-const trimTrailingSlash = (str: string) =>\n-  str.endsWith('/') ? str.slice(0, -1) : str;\n+import { devAuth } from '../../plugins/auth-dev';\n \n /**\n  * Route handler for development login.\n@@ -25,26 +16,6 @@ export const devAuthRoutes: FastifyPluginCallback = (\n   _options,\n   done\n ) => {\n-  async function handleRedirects(req: FastifyRequest, reply: FastifyReply) {\n-    const params = getRedirectParams(req);\n-    const { origin, pathPrefix } = params;\n-    const returnTo = trimTrailingSlash(params.returnTo);\n-    const landingUrl = getPrefixedLandingPath(origin, pathPrefix);\n-\n-    return await reply.redirect(\n-      haveSamePath(landingUrl, returnTo) ? `${returnTo}/learn` : returnTo\n-    );\n-  }\n-\n-  fastify.get('/signin', async (req, reply) => {\n-    const email = 'foo@bar.com';\n-\n-    const { id } = await findOrCreateUser(fastify, email);\n-\n-    reply.setAccessTokenCookie(createAccessToken(id));\n-\n-    await handleRedirects(req, reply);\n-  });\n-\n+  void fastify.register(devAuth);\n   done();\n };"
        }
    ],
    "stats": {
        "total": 603,
        "additions": 285,
        "deletions": 318
    }
}