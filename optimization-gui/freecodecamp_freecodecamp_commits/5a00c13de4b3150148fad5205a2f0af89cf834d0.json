{
    "author": "ojeytonwilliams",
    "message": "refactor(api): use decorator to clear our cookies (#55470)",
    "sha": "5a00c13de4b3150148fad5205a2f0af89cf834d0",
    "files": [
        {
            "sha": "41dbd19ebbba148d91f193c3bedd6de7d469dcf6",
            "filename": "api/src/plugins/cookies.test.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Fplugins%2Fcookies.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Fplugins%2Fcookies.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookies.test.ts?ref=5a00c13de4b3150148fad5205a2f0af89cf834d0",
            "patch": "@@ -100,4 +100,38 @@ describe('cookies', () => {\n       value: expect.stringMatching(/s:value\\.\\w*/)\n     });\n   });\n+\n+  // TODO(Post-MVP): Clear all cookies rather than just three specific ones?\n+  // Then it should be called something like clearAllCookies.\n+  it('clearOurCookies should clear cookies that we set', async () => {\n+    fastify.get('/test', async (req, reply) => {\n+      void reply.clearOurCookies();\n+      return { ok: true };\n+    });\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/test'\n+    });\n+\n+    expect(res.cookies).toStrictEqual(\n+      expect.arrayContaining([\n+        expect.objectContaining({\n+          name: 'jwt_access_token',\n+          expires: new Date(0),\n+          value: ''\n+        }),\n+        expect.objectContaining({\n+          name: '_csrf',\n+          expires: new Date(0),\n+          value: ''\n+        }),\n+        expect.objectContaining({\n+          name: 'csrf_token',\n+          expires: new Date(0),\n+          value: ''\n+        })\n+      ])\n+    );\n+  });\n });"
        },
        {
            "sha": "6ed7e3aa47b0516e36338db704828a0880fb54c8",
            "filename": "api/src/plugins/cookies.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookies.ts?ref=5a00c13de4b3150148fad5205a2f0af89cf834d0",
            "patch": "@@ -10,6 +10,12 @@ import {\n \n export { type CookieSerializeOptions } from '@fastify/cookie';\n \n+declare module 'fastify' {\n+  interface FastifyReply {\n+    clearOurCookies: () => void;\n+  }\n+}\n+\n /**\n  * Signs a cookie value by prefixing it with \"s:\" and using the COOKIE_SECRET.\n  *\n@@ -60,6 +66,12 @@ const cookies: FastifyPluginCallback = (fastify, _options, done) => {\n     }\n   });\n \n+  void fastify.decorateReply('clearOurCookies', function () {\n+    void this.clearCookie('jwt_access_token');\n+    void this.clearCookie('_csrf');\n+    void this.clearCookie('csrf_token');\n+  });\n+\n   done();\n };\n "
        },
        {
            "sha": "cf16a720a28c3abb8a742fe874d824a50ad82a5b",
            "filename": "api/src/routes/auth-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Froutes%2Fauth-dev.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Froutes%2Fauth-dev.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth-dev.ts?ref=5a00c13de4b3150148fad5205a2f0af89cf834d0",
            "patch": "@@ -47,9 +47,7 @@ export const devAuthRoutes: FastifyPluginCallback = (\n   });\n \n   fastify.get('/signout', async (req, reply) => {\n-    void reply.clearCookie('jwt_access_token');\n-    void reply.clearCookie('csrf_token');\n-    void reply.clearCookie('_csrf');\n+    reply.clearOurCookies();\n \n     const { returnTo } = getRedirectParams(req);\n     await reply.redirect(returnTo);"
        },
        {
            "sha": "ff4b10dbf8d545bedda70843c7baa8d51a5b9b85",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/5a00c13de4b3150148fad5205a2f0af89cf834d0/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=5a00c13de4b3150148fad5205a2f0af89cf834d0",
            "patch": "@@ -116,9 +116,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n       await fastify.prisma.user.delete({\n         where: { id: req.user!.id }\n       });\n-      void reply.clearCookie('jwt_access_token');\n-      void reply.clearCookie('_csrf');\n-      void reply.clearCookie('csrf_token');\n+      reply.clearOurCookies();\n \n       return {};\n     }"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 48,
        "deletions": 6
    }
}