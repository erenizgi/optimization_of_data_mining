{
    "author": "ojeytonwilliams",
    "message": "refactor: use fastify/rate-limit, drop express (#56328)",
    "sha": "3654a297fda0550fe155639fec6e118ca7190b58",
    "files": [
        {
            "sha": "ebf004495c739e5a3b142216a14225460f92ee25",
            "filename": "api/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fpackage.json",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fpackage.json?ref=3654a297fda0550fe155639fec6e118ca7190b58",
            "patch": "@@ -8,8 +8,8 @@\n     \"@fastify/accepts\": \"4.3.0\",\n     \"@fastify/cookie\": \"9.4.0\",\n     \"@fastify/csrf-protection\": \"6.4.1\",\n-    \"@fastify/express\": \"^2.3.0\",\n     \"@fastify/oauth2\": \"7.8.1\",\n+    \"@fastify/rate-limit\": \"9.1.0\",\n     \"@fastify/swagger\": \"8.14.0\",\n     \"@fastify/swagger-ui\": \"1.10.2\",\n     \"@fastify/type-provider-typebox\": \"3.6.0\",\n@@ -19,7 +19,6 @@\n     \"ajv-formats\": \"2.1.1\",\n     \"date-fns\": \"2.30.0\",\n     \"dotenv\": \"16.4.5\",\n-    \"express-rate-limit\": \"^6.7.0\",\n     \"fast-uri\": \"2.3.0\",\n     \"fastify\": \"4.26.1\",\n     \"fastify-plugin\": \"4.5.1\",\n@@ -40,7 +39,6 @@\n   \"description\": \"The freeCodeCamp.org open-source codebase and curriculum\",\n   \"devDependencies\": {\n     \"@total-typescript/ts-reset\": \"0.5.1\",\n-    \"@types/express\": \"4.17.21\",\n     \"@types/jsonwebtoken\": \"9.0.5\",\n     \"@types/nodemailer\": \"6.4.14\",\n     \"@types/supertest\": \"2.0.16\","
        },
        {
            "sha": "8935cc7e57d8a00836187abf2ee57fb64034f8bc",
            "filename": "api/src/app.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fsrc%2Fapp.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fsrc%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fapp.ts?ref=3654a297fda0550fe155639fec6e118ca7190b58",
            "patch": "@@ -1,5 +1,4 @@\n import fastifyCsrfProtection from '@fastify/csrf-protection';\n-import express from '@fastify/express';\n import fastifySwagger from '@fastify/swagger';\n import fastifySwaggerUI from '@fastify/swagger-ui';\n import type { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';\n@@ -96,9 +95,6 @@ export const build = async (\n \n   void fastify.register(security);\n \n-  // NOTE: Awaited to ensure `.use` is registered on `fastify`\n-  await fastify.register(express);\n-\n   await fastify.register(fastifySentry, {\n     dsn: SENTRY_DSN,\n     // No need to initialize if DSN is not provided (e.g. in development and"
        },
        {
            "sha": "db06598562c46cf92e435831cd200c441c7737f8",
            "filename": "api/src/routes/auth.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fsrc%2Froutes%2Fauth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fsrc%2Froutes%2Fauth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth.test.ts?ref=3654a297fda0550fe155639fec6e118ca7190b58",
            "patch": "@@ -68,6 +68,7 @@ describe('auth0 routes', () => {\n       // so should not depend on the details of the rate-limiting library\n       expect(res.headers['ratelimit-limit']).toBe('10');\n       expect(res.headers['ratelimit-remaining']).toBe('9');\n+      expect(res.headers['ratelimit-reset']).toMatch(/^\\d+$/);\n \n       const res2 = await superGet('/mobile-login');\n       expect(res2.headers['ratelimit-remaining']).toBe('8');"
        },
        {
            "sha": "75940e9ae10673ceb11d73e923398e27e425bde3",
            "filename": "api/src/routes/auth.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 26,
            "changes": 91,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fsrc%2Froutes%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3654a297fda0550fe155639fec6e118ca7190b58/api%2Fsrc%2Froutes%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth.ts?ref=3654a297fda0550fe155639fec6e118ca7190b58",
            "patch": "@@ -1,6 +1,10 @@\n-import { FastifyPluginCallback, FastifyRequest } from 'fastify';\n-// TODO(Post-MVP): use fastify-rate-limit instead of express-rate-limit\n-import rateLimit from 'express-rate-limit';\n+import type {\n+  FastifyPluginCallback,\n+  FastifyPluginAsync,\n+  FastifyRequest,\n+  RouteOptions\n+} from 'fastify';\n+import rateLimit, { type FastifyRateLimitStore } from '@fastify/rate-limit';\n // @ts-expect-error - no types\n import MongoStoreRL from 'rate-limit-mongo';\n import isEmail from 'validator/lib/isEmail';\n@@ -27,37 +31,74 @@ const getEmailFromAuth0 = async (\n   return typeof email === 'string' ? email : null;\n };\n \n+// TODO: Use Redis! Then we don't need to maintain this store.\n+class Store implements FastifyRateLimitStore {\n+  mongoStore: MongoStoreRL;\n+  // We don't really need this.options, but it's here for consistency with the\n+  // custom store in the fastify-rate-limit docs.\n+  options: { timeWindow: number };\n+  constructor({ timeWindow }: { timeWindow: number }) {\n+    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call\n+    this.mongoStore = new MongoStoreRL({\n+      collectionName: 'UserRateLimit',\n+      uri: MONGOHQ_URL,\n+      expireTimeMs: timeWindow // timeWindow is Fastify's equivalent of express-rate-limit's expireTimeMs\n+    });\n+    this.options = { timeWindow };\n+  }\n+\n+  incr(\n+    key: string,\n+    cb: (err: Error | null, result?: { current: number; ttl: number }) => void\n+  ) {\n+    // This converts between what rate-limit-mongo calls and what\n+    // fastify-rate-limit expects\n+    const callbackConverted = (\n+      err: Error | null,\n+      current: number,\n+      expires: Date\n+    ) => {\n+      const ttl = expires.getTime() - Date.now();\n+      cb(err, { current, ttl });\n+    };\n+    // eslint-disable-next-line @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access\n+    this.mongoStore.incr(key, callbackConverted);\n+  }\n+\n+  // routeOptions are ignored for now, but this is the signature we need to implement\n+  child(\n+    routeOptions: RouteOptions & { path: string; prefix: string }\n+  ): FastifyRateLimitStore {\n+    const childParams = { ...this.options, ...routeOptions };\n+    const store = new Store(childParams);\n+    return store;\n+  }\n+}\n+\n /**\n  * Route handler for Mobile authentication.\n  *\n  * @param fastify The Fastify instance.\n  * @param _options Options passed to the plugin via `fastify.register(plugin, options)`.\n- * @param done Callback to signal that the logic has completed.\n+ *\n  */\n-export const mobileAuth0Routes: FastifyPluginCallback = (\n+export const mobileAuth0Routes: FastifyPluginAsync = async (\n   fastify,\n-  _options,\n-  done\n+  _options\n ) => {\n   // Rate limit for mobile login\n   // 10 requests per 15 minute windows\n-  void fastify.use(\n-    rateLimit({\n-      windowMs: 15 * 60 * 1000,\n-      max: 10,\n-      standardHeaders: true,\n-      legacyHeaders: false,\n-      keyGenerator: req => {\n-        return (req.headers['x-forwarded-for'] as string) || 'localhost';\n-      },\n-      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call\n-      store: new MongoStoreRL({\n-        collectionName: 'UserRateLimit',\n-        uri: MONGOHQ_URL,\n-        expireTimeMs: 15 * 60 * 1000\n-      })\n-    })\n-  );\n+  // @ts-expect-error - no types\n+  await fastify.register(rateLimit, {\n+    timeWindow: 15 * 60 * 1000,\n+    max: 10,\n+    enableDraftSpec: true, // ratelimit-* instead of x-ratelimit-*\n+    keyGenerator: req => {\n+      return (req.headers['x-forwarded-for'] as string) || 'localhost';\n+    },\n+    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call\n+    store: Store\n+  });\n \n   // TODO(Post-MVP): move this into the app, so that we add this hook once for\n   // all auth routes.\n@@ -83,8 +124,6 @@ export const mobileAuth0Routes: FastifyPluginCallback = (\n \n     reply.setAccessTokenCookie(createAccessToken(id));\n   });\n-\n-  done();\n };\n \n /**"
        },
        {
            "sha": "14b14c0ed8dcd8a0c42c26f6458073b159344433",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 37,
            "deletions": 34,
            "changes": 71,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/3654a297fda0550fe155639fec6e118ca7190b58/pnpm-lock.yaml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/3654a297fda0550fe155639fec6e118ca7190b58/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/pnpm-lock.yaml?ref=3654a297fda0550fe155639fec6e118ca7190b58",
            "patch": "@@ -144,12 +144,12 @@ importers:\n       '@fastify/csrf-protection':\n         specifier: 6.4.1\n         version: 6.4.1\n-      '@fastify/express':\n-        specifier: ^2.3.0\n-        version: 2.3.0\n       '@fastify/oauth2':\n         specifier: 7.8.1\n         version: 7.8.1\n+      '@fastify/rate-limit':\n+        specifier: 9.1.0\n+        version: 9.1.0\n       '@fastify/swagger':\n         specifier: 8.14.0\n         version: 8.14.0\n@@ -177,9 +177,6 @@ importers:\n       dotenv:\n         specifier: 16.4.5\n         version: 16.4.5\n-      express-rate-limit:\n-        specifier: ^6.7.0\n-        version: 6.7.0(express@4.18.2)\n       fast-uri:\n         specifier: 2.3.0\n         version: 2.3.0\n@@ -232,9 +229,6 @@ importers:\n       '@total-typescript/ts-reset':\n         specifier: 0.5.1\n         version: 0.5.1\n-      '@types/express':\n-        specifier: 4.17.21\n-        version: 4.17.21\n       '@types/jsonwebtoken':\n         specifier: 9.0.5\n         version: 9.0.5\n@@ -2858,15 +2852,15 @@ packages:\n   '@fastify/error@3.4.1':\n     resolution: {integrity: sha512-wWSvph+29GR783IhmvdwWnN4bUxTD01Vm5Xad4i7i1VuAOItLvbPAb69sb0IQ2N57yprvhNIwAP5B6xfKTmjmQ==}\n \n-  '@fastify/express@2.3.0':\n-    resolution: {integrity: sha512-jvvjlPPCfJsSHfF6tQDyARJ3+c3xXiqcxVZu6bi3xMWCWB3fl07vrjFDeaqnwqKhLZ9+m6cog5dw7gIMKEsTnQ==}\n-\n   '@fastify/fast-json-stringify-compiler@4.3.0':\n     resolution: {integrity: sha512-aZAXGYo6m22Fk1zZzEUKBvut/CIIQe/BapEORnxiD5Qr0kPHqqI69NtEMCme74h+at72sPhbkb4ZrLd1W3KRLA==}\n \n   '@fastify/oauth2@7.8.1':\n     resolution: {integrity: sha512-PBIMizzgEOcUcttyfX1hC6CR9vESoI1lfNucBywgcqrxvknVg+zvBCgH2+oU8NvrpSDMtlY6nyuEYYZtVhDT7Q==}\n \n+  '@fastify/rate-limit@9.1.0':\n+    resolution: {integrity: sha512-h5dZWCkuZXN0PxwqaFQLxeln8/LNwQwH9popywmDCFdKfgpi4b/HoMH1lluy6P+30CG9yzzpSpwTCIPNB9T1JA==}\n+\n   '@fastify/send@2.1.0':\n     resolution: {integrity: sha512-yNYiY6sDkexoJR0D8IDy3aRP3+L4wdqCpvx5WP+VtEU58sn7USmKynBzDQex5X42Zzvw2gNzzYgP90UfWShLFA==}\n \n@@ -3265,8 +3259,8 @@ packages:\n     peerDependencies:\n       react: ^16.3.0 || ^17.0.0 || ^18.0.0\n \n-  '@lukeed/ms@2.0.1':\n-    resolution: {integrity: sha512-Xs/4RZltsAL7pkvaNStUQt7netTkyxrS0K+RILcVr3TRMS/ToOg4I6uNfhB9SlGsnWBym4U+EaXq0f0cEMNkHA==}\n+  '@lukeed/ms@2.0.2':\n+    resolution: {integrity: sha512-9I2Zn6+NJLfaGoz9jN3lpwDgAYvfGeNYdbAIjJOqzs4Tpc+VU3Jqq4IofSUBKajiDS8k9fZIg18/z13mpk1bsA==}\n     engines: {node: '>=8'}\n \n   '@mdx-js/util@2.0.0-next.8':\n@@ -12441,6 +12435,10 @@ packages:\n     resolution: {integrity: sha512-3oDzcogWGHZdkwrHyvJVpPjA7oNzY6ENOV3PsWJY9XYPZ6INo94Yd47s5may1U+nleBPwDhrRiTPMIvKaa3MQg==}\n     engines: {node: '>=12'}\n \n+  toad-cache@3.7.0:\n+    resolution: {integrity: sha512-/m8M+2BJUpoJdgAHoG+baCwBT+tf2VraSfkBgl0Y00qIWt41DJ8R5B8nsEw0I58YwF5IZH6z24/2TobDKnqSWw==}\n+    engines: {node: '>=12'}\n+\n   toidentifier@1.0.0:\n     resolution: {integrity: sha512-yaOH/Pk/VEhBWWTlhI+qXxDFXlejDGcQipMlyxda9nthulaxLZUNcUqFxokp0vcYnvteJln5FNQDRrxj3YcbVw==}\n     engines: {node: '>=0.6'}\n@@ -14155,7 +14153,7 @@ snapshots:\n       '@babel/traverse': 7.23.7\n       '@babel/types': 7.23.9\n       convert-source-map: 2.0.0\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       gensync: 1.0.0-beta.2\n       json5: 2.2.3\n       semver: 6.3.1\n@@ -16368,7 +16366,7 @@ snapshots:\n       '@babel/helper-split-export-declaration': 7.22.6\n       '@babel/parser': 7.23.6\n       '@babel/types': 7.23.9\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       globals: 11.12.0\n     transitivePeerDependencies:\n       - supports-color\n@@ -16606,13 +16604,6 @@ snapshots:\n \n   '@fastify/error@3.4.1': {}\n \n-  '@fastify/express@2.3.0':\n-    dependencies:\n-      express: 4.18.2\n-      fastify-plugin: 4.5.1\n-    transitivePeerDependencies:\n-      - supports-color\n-\n   '@fastify/fast-json-stringify-compiler@4.3.0':\n     dependencies:\n       fast-json-stringify: 5.8.0\n@@ -16625,9 +16616,15 @@ snapshots:\n     transitivePeerDependencies:\n       - supports-color\n \n+  '@fastify/rate-limit@9.1.0':\n+    dependencies:\n+      '@lukeed/ms': 2.0.2\n+      fastify-plugin: 4.5.1\n+      toad-cache: 3.7.0\n+\n   '@fastify/send@2.1.0':\n     dependencies:\n-      '@lukeed/ms': 2.0.1\n+      '@lukeed/ms': 2.0.2\n       escape-html: 1.0.3\n       fast-decode-uri-component: 1.0.1\n       http-errors: 2.0.0\n@@ -17190,8 +17187,8 @@ snapshots:\n \n   '@jridgewell/trace-mapping@0.3.9':\n     dependencies:\n-      '@jridgewell/resolve-uri': 3.1.1\n-      '@jridgewell/sourcemap-codec': 1.4.15\n+      '@jridgewell/resolve-uri': 3.1.2\n+      '@jridgewell/sourcemap-codec': 1.5.0\n \n   '@lmdb/lmdb-darwin-arm64@2.5.3':\n     optional: true\n@@ -17218,7 +17215,7 @@ snapshots:\n       react: 16.14.0\n       react-is: 16.13.1\n \n-  '@lukeed/ms@2.0.1': {}\n+  '@lukeed/ms@2.0.2': {}\n \n   '@mdx-js/util@2.0.0-next.8': {}\n \n@@ -18855,7 +18852,7 @@ snapshots:\n \n   agent-base@6.0.2:\n     dependencies:\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n     transitivePeerDependencies:\n       - supports-color\n \n@@ -19187,7 +19184,7 @@ snapshots:\n     dependencies:\n       '@fastify/error': 3.4.1\n       archy: 1.0.0\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       fastq: 1.17.1\n     transitivePeerDependencies:\n       - supports-color\n@@ -20749,6 +20746,10 @@ snapshots:\n     optionalDependencies:\n       supports-color: 5.5.0\n \n+  debug@4.3.4:\n+    dependencies:\n+      ms: 2.1.2\n+\n   debug@4.3.4(supports-color@8.1.1):\n     dependencies:\n       ms: 2.1.2\n@@ -23622,7 +23623,7 @@ snapshots:\n   https-proxy-agent@5.0.1:\n     dependencies:\n       agent-base: 6.0.2\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n     transitivePeerDependencies:\n       - supports-color\n \n@@ -24146,7 +24147,7 @@ snapshots:\n \n   istanbul-lib-source-maps@4.0.1:\n     dependencies:\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       istanbul-lib-coverage: 3.2.0\n       source-map: 0.6.1\n     transitivePeerDependencies:\n@@ -24692,7 +24693,7 @@ snapshots:\n \n   json-schema-resolver@2.0.0:\n     dependencies:\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       rfdc: 1.3.0\n       uri-js: 4.4.1\n     transitivePeerDependencies:\n@@ -28474,7 +28475,7 @@ snapshots:\n     dependencies:\n       '@hapi/hoek': 11.0.4\n       '@hapi/wreck': 18.1.0\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       joi: 17.12.2\n     transitivePeerDependencies:\n       - supports-color\n@@ -29056,7 +29057,7 @@ snapshots:\n     dependencies:\n       component-emitter: 1.3.0\n       cookiejar: 2.1.4\n-      debug: 4.3.4(supports-color@8.1.1)\n+      debug: 4.3.4\n       fast-safe-stringify: 2.1.1\n       form-data: 4.0.0\n       formidable: 2.1.2\n@@ -29293,6 +29294,8 @@ snapshots:\n \n   toad-cache@3.3.0: {}\n \n+  toad-cache@3.7.0: {}\n+\n   toidentifier@1.0.0: {}\n \n   toidentifier@1.0.1: {}"
        }
    ],
    "stats": {
        "total": 171,
        "additions": 104,
        "deletions": 67
    }
}