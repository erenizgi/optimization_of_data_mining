{
    "author": "ojeytonwilliams",
    "message": "fix(client): only fetch completion data on challenge pages (#55787)",
    "sha": "d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
    "files": [
        {
            "sha": "23935003f8c15ba708632651f9946eac3cf2a643",
            "filename": "client/src/components/Progress/progress.tsx",
            "status": "modified",
            "additions": 65,
            "deletions": 6,
            "changes": 71,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fcomponents%2FProgress%2Fprogress.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fcomponents%2FProgress%2Fprogress.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2FProgress%2Fprogress.tsx?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -1,15 +1,19 @@\n-import React from 'react';\n-import { connect } from 'react-redux';\n+import React, { useEffect } from 'react';\n+import { connect, ConnectedProps } from 'react-redux';\n import { createSelector } from 'reselect';\n import { TFunction } from 'i18next';\n import { withTranslation } from 'react-i18next';\n+import { useStaticQuery, graphql } from 'gatsby';\n+\n import {\n   challengeMetaSelector,\n   currentBlockIdsSelector,\n   completedChallengesInBlockSelector,\n   completedPercentageSelector\n } from '../../templates/Challenges/redux/selectors';\n import { liveCerts } from '../../../config/cert-and-project-map';\n+import { updateAllChallengesInfo } from '../../redux/actions';\n+import { CertificateNode, ChallengeNode } from '../../redux/prop-types';\n import ProgressInner from './progress-inner';\n \n const mapStateToProps = createSelector(\n@@ -40,9 +44,11 @@ const mapStateToProps = createSelector(\n   })\n );\n \n-type StateProps = ReturnType<typeof mapStateToProps>;\n+const mapDispatchToProps = { updateAllChallengesInfo };\n+\n+type PropsFromRedux = ConnectedProps<typeof connector>;\n \n-interface ProgressProps extends StateProps {\n+interface ProgressProps extends PropsFromRedux {\n   t: TFunction;\n }\n function Progress({\n@@ -52,14 +58,20 @@ function Progress({\n   superBlock,\n   completedChallengesInBlock,\n   completedPercent,\n-  t\n+  t,\n+  updateAllChallengesInfo\n }: ProgressProps): JSX.Element {\n   const blockTitle = t(`intro:${superBlock}.blocks.${block}.title`);\n   // Always false for legacy full stack, since it has no projects.\n   const isCertificationProject = liveCerts.some(cert =>\n     cert.projects?.some((project: { id: string }) => project.id === id)\n   );\n \n+  const { challengeNodes, certificateNodes } = useGetAllBlockIds();\n+  useEffect(() => {\n+    updateAllChallengesInfo({ challengeNodes, certificateNodes });\n+  }, [challengeNodes, certificateNodes, updateAllChallengesInfo]);\n+\n   const totalChallengesInBlock = currentBlockIds?.length ?? 0;\n   const meta =\n     isCertificationProject && totalChallengesInBlock > 0\n@@ -84,6 +96,53 @@ function Progress({\n   );\n }\n \n+// TODO: extract this hook and call it when needed (i.e. here, in the lower-jaw\n+// and in completion-modal). Then we don't have to pass the data into redux.\n+// This would mean that we have to memoize any complex calculations in the hook.\n+// Otherwise, this will undo all the recent performance improvements.\n+const useGetAllBlockIds = () => {\n+  const {\n+    allChallengeNode: { nodes: challengeNodes },\n+    allCertificateNode: { nodes: certificateNodes }\n+  }: {\n+    allChallengeNode: { nodes: ChallengeNode[] };\n+    allCertificateNode: { nodes: CertificateNode[] };\n+  } = useStaticQuery(graphql`\n+    query getBlockNode {\n+      allChallengeNode(\n+        sort: {\n+          fields: [\n+            challenge___superOrder\n+            challenge___order\n+            challenge___challengeOrder\n+          ]\n+        }\n+      ) {\n+        nodes {\n+          challenge {\n+            block\n+            id\n+          }\n+        }\n+      }\n+      allCertificateNode {\n+        nodes {\n+          challenge {\n+            certification\n+            tests {\n+              id\n+            }\n+          }\n+        }\n+      }\n+    }\n+  `);\n+\n+  return { challengeNodes, certificateNodes };\n+};\n+\n Progress.displayName = 'Progress';\n \n-export default connect(mapStateToProps)(withTranslation()(Progress));\n+const connector = connect(mapStateToProps, mapDispatchToProps);\n+\n+export default connector(withTranslation()(Progress));"
        },
        {
            "sha": "88754c42c1ff4717302a3fd9e7f49108683598c2",
            "filename": "client/src/components/layouts/default.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 59,
            "changes": 63,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fcomponents%2Flayouts%2Fdefault.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fcomponents%2Flayouts%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Flayouts%2Fdefault.tsx?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -5,7 +5,6 @@ import { useMediaQuery } from 'react-responsive';\n import { connect } from 'react-redux';\n import { bindActionCreators, Dispatch } from 'redux';\n import { createSelector } from 'reselect';\n-import { useStaticQuery, graphql } from 'gatsby';\n \n import latoBoldURL from '../../../static/fonts/lato/Lato-Bold.woff';\n import latoLightURL from '../../../static/fonts/lato/Lato-Light.woff';\n@@ -18,8 +17,7 @@ import { isBrowser } from '../../../utils';\n import {\n   fetchUser,\n   onlineStatusChange,\n-  serverStatusChange,\n-  updateAllChallengesInfo\n+  serverStatusChange\n } from '../../redux/actions';\n import {\n   isSignedInSelector,\n@@ -30,12 +28,7 @@ import {\n   userFetchStateSelector\n } from '../../redux/selectors';\n \n-import {\n-  UserFetchState,\n-  User,\n-  AllChallengeNode,\n-  CertificateNode\n-} from '../../redux/prop-types';\n+import { UserFetchState, User } from '../../redux/prop-types';\n import BreadCrumb from '../../templates/Challenges/components/bread-crumb';\n import Flash from '../Flash';\n import { flashMessageSelector, removeFlashMessage } from '../Flash/redux';\n@@ -95,8 +88,7 @@ const mapDispatchToProps = (dispatch: Dispatch) =>\n       fetchUser,\n       removeFlashMessage,\n       onlineStatusChange,\n-      serverStatusChange,\n-      updateAllChallengesInfo\n+      serverStatusChange\n     },\n     dispatch\n   );\n@@ -138,8 +130,7 @@ function DefaultLayout({\n   superBlock,\n   theme,\n   user,\n-  fetchUser,\n-  updateAllChallengesInfo\n+  fetchUser\n }: DefaultLayoutProps): JSX.Element {\n   const { t } = useTranslation();\n   const isMobileLayout = useMediaQuery({ maxWidth: MAX_MOBILE_WIDTH });\n@@ -150,10 +141,8 @@ function DefaultLayout({\n   const isExSmallViewportHeight = useMediaQuery({\n     maxHeight: EX_SMALL_VIEWPORT_HEIGHT\n   });\n-  const { challengeEdges, certificateNodes } = useGetAllBlockIds();\n   useEffect(() => {\n     // componentDidMount\n-    updateAllChallengesInfo({ challengeEdges, certificateNodes });\n     if (!isSignedIn) {\n       fetchUser();\n     }\n@@ -278,50 +267,6 @@ function DefaultLayout({\n   }\n }\n \n-// TODO: get challenge nodes directly rather than wrapped in edges\n-const useGetAllBlockIds = () => {\n-  const {\n-    allChallengeNode: { edges: challengeEdges },\n-    allCertificateNode: { nodes: certificateNodes }\n-  }: {\n-    allChallengeNode: AllChallengeNode;\n-    allCertificateNode: { nodes: CertificateNode[] };\n-  } = useStaticQuery(graphql`\n-    query getBlockNode {\n-      allChallengeNode(\n-        sort: {\n-          fields: [\n-            challenge___superOrder\n-            challenge___order\n-            challenge___challengeOrder\n-          ]\n-        }\n-      ) {\n-        edges {\n-          node {\n-            challenge {\n-              block\n-              id\n-            }\n-          }\n-        }\n-      }\n-      allCertificateNode {\n-        nodes {\n-          challenge {\n-            certification\n-            tests {\n-              id\n-            }\n-          }\n-        }\n-      }\n-    }\n-  `);\n-\n-  return { challengeEdges, certificateNodes };\n-};\n-\n DefaultLayout.displayName = 'DefaultLayout';\n \n export default connect("
        },
        {
            "sha": "2720b42186ccf4bd505e33322a01b5acda7a3d5d",
            "filename": "client/src/redux/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fredux%2Findex.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fredux%2Findex.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Findex.js?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -66,7 +66,7 @@ const initialState = {\n     ...defaultFetchState\n   },\n   allChallengesInfo: {\n-    challengeEdges: [],\n+    challengeNodes: [],\n     certificateNodes: []\n   },\n   userProfileFetchState: {"
        },
        {
            "sha": "72b5f053ed1542475df9851621b2926e020a27f8",
            "filename": "client/src/redux/prop-types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fredux%2Fprop-types.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Fredux%2Fprop-types.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Fprop-types.ts?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -243,7 +243,7 @@ export type CertificateNode = {\n };\n \n export type AllChallengesInfo = {\n-  challengeEdges: { node: ChallengeNode }[];\n+  challengeNodes: ChallengeNode[];\n   certificateNodes: CertificateNode[];\n };\n "
        },
        {
            "sha": "251b9da65ebf5a25f3e3b107055b6281f442d4b5",
            "filename": "client/src/templates/Challenges/components/completion-modal.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fcompletion-modal.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fcompletion-modal.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fcompletion-modal.tsx?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -8,11 +8,8 @@ import { createSelector } from 'reselect';\n import { Button, Modal } from '@freecodecamp/ui';\n \n import Login from '../../../components/Header/components/login';\n-import {\n-  isSignedInSelector,\n-  allChallengesInfoSelector\n-} from '../../../redux/selectors';\n-import { AllChallengesInfo, ChallengeFiles } from '../../../redux/prop-types';\n+import { isSignedInSelector } from '../../../redux/selectors';\n+import { ChallengeFiles } from '../../../redux/prop-types';\n import { closeModal, submitChallenge } from '../redux/actions';\n import {\n   completedChallengesIdsSelector,\n@@ -35,7 +32,6 @@ const mapStateToProps = createSelector(\n   completedChallengesIdsSelector,\n   isCompletionModalOpenSelector,\n   isSignedInSelector,\n-  allChallengesInfoSelector,\n   successMessageSelector,\n   isSubmittingSelector,\n   (\n@@ -44,7 +40,6 @@ const mapStateToProps = createSelector(\n     completedChallengesIds: string[],\n     isOpen: boolean,\n     isSignedIn: boolean,\n-    allChallengesInfo: AllChallengesInfo,\n     message: string,\n     isSubmitting: boolean\n   ) => ({\n@@ -54,7 +49,6 @@ const mapStateToProps = createSelector(\n     completedChallengesIds,\n     isOpen,\n     isSignedIn,\n-    allChallengesInfo,\n     message,\n     isSubmitting\n   })"
        },
        {
            "sha": "3d15e634ee4ec23fd2cee9c3c565ce13c0ce4a12",
            "filename": "client/src/templates/Challenges/redux/completion-epic.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcompletion-epic.test.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcompletion-epic.test.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fredux%2Fcompletion-epic.test.js?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -19,7 +19,7 @@ describe('completionEpic', () => {\n           challenge: { challengeMeta: { challengeType: 0 } },\n           app: {\n             user: { username: 'test' },\n-            allChallengesInfo: { challengeEdges: [], certificateNodes: [] }\n+            allChallengesInfo: { challengeNodes: [], certificateNodes: [] }\n           }\n         }\n       };"
        },
        {
            "sha": "96a0dbe1a6db96736acca6ef44b38fe49ebf3a77",
            "filename": "client/src/utils/get-completion-percentage.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Futils%2Fget-completion-percentage.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/d5f109ac4e5fbc3c90ca61657dd2a820d155720b/client%2Fsrc%2Futils%2Fget-completion-percentage.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fget-completion-percentage.ts?ref=d5f109ac4e5fbc3c90ca61657dd2a820d155720b",
            "patch": "@@ -39,14 +39,14 @@ export const getCurrentBlockIds = (\n   certification: string,\n   challengeType: number\n ): string[] => {\n-  const { challengeEdges, certificateNodes } = allChallengesInfo;\n+  const { challengeNodes, certificateNodes } = allChallengesInfo;\n   const currentCertificateIds =\n     certificateNodes\n       .filter(node => node.challenge.certification === certification)[0]\n       ?.challenge.tests.map(test => test.id) ?? [];\n-  const currentBlockIds = challengeEdges\n-    .filter(edge => edge.node.challenge.block === block)\n-    .map(edge => edge.node.challenge.id);\n+  const currentBlockIds = challengeNodes\n+    .filter(node => node.challenge.block === block)\n+    .map(node => node.challenge.id);\n \n   return isProjectBased(challengeType)\n     ? currentCertificateIds"
        }
    ],
    "stats": {
        "total": 158,
        "additions": 78,
        "deletions": 80
    }
}