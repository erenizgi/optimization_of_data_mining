{
    "author": "raisedadead",
    "message": "fix(GHA): exit if latest run is failed",
    "sha": "ed3e2082152fab2bfb4a837640ca8f64bc76404f",
    "files": [
        {
            "sha": "bdef938aafdda533c72ba4e1d51604e232d416ad",
            "filename": ".github/workflows/deploy-legacy.yml",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/ed3e2082152fab2bfb4a837640ca8f64bc76404f/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/ed3e2082152fab2bfb4a837640ca8f64bc76404f/.github%2Fworkflows%2Fdeploy-legacy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy-legacy.yml?ref=ed3e2082152fab2bfb4a837640ca8f64bc76404f",
            "patch": "@@ -12,8 +12,59 @@ jobs:\n       tgt_env_short: ${{ steps.setup.outputs.tgt_env_short }} # prd, stg\n       tgt_env_long: ${{ steps.setup.outputs.tgt_env_long }} # production, staging\n     steps:\n+      - name: Validate\n+        id: check\n+        uses: actions/github-script@v7\n+        with:\n+          script: |\n+            const workflows = ['node.js-tests.yml'];\n+            const owner = context.repo.owner;\n+            const repo = context.repo.repo;\n+            const branch = context.ref.replace('refs/heads/', '');\n+            const sha = context.sha;\n+\n+            for (const workflow_id of workflows) {\n+              console.log(`\\nChecking workflow ${workflow_id} for branch ${branch} at commit ${sha}`);\n+\n+              const response = await github.rest.actions.listWorkflowRuns({\n+                owner,\n+                repo,\n+                workflow_id,\n+                branch,\n+                head_sha: sha,\n+                status: 'completed',\n+                per_page: 1\n+              });\n+\n+              if (response.data.workflow_runs.length === 0) {\n+                core.setFailed(`No completed workflow runs found for ${workflow_id} on branch ${branch}`);\n+                return false;\n+              }\n+\n+              const latestRun = response.data.workflow_runs[0];\n+              console.log(`Latest run: ${latestRun.html_url}`);\n+              console.log(`Status: ${latestRun.status}`);\n+              console.log(`Conclusion: ${latestRun.conclusion}`);\n+\n+              if (latestRun.status !== 'completed') {\n+                core.setFailed(`Latest workflow run is not completed. Current status: ${latestRun.status}`);\n+                return false;\n+              }\n+\n+              if (latestRun.conclusion !== 'success') {\n+                const failureMessage = `Workflow ${workflow_id} failed on branch ${branch} at commit ${sha}. ` +\n+                  `Latest run: ${latestRun.html_url}. Conclusion: ${latestRun.conclusion}`;\n+                core.setFailed(failureMessage);\n+                return false;\n+              }\n+            }\n+\n+            console.log('\\nAll workflow checks passed!');\n+            return true;\n+\n       - name: Setup\n         id: setup\n+        if: ${{ steps.check.outputs.result == 'true' }}\n         run: |\n           case \"${{ github.ref }}\" in\n             \"refs/heads/prod-current\")"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 51,
        "deletions": 0
    }
}