{
    "author": "raisedadead",
    "message": "Merge commit from fork\n\nhttpOnly (invisible to JS) and secure (https only) are now used. In\norder to update existing users without requiring them to\nre-authenticate, each request sets those properties on the cookie.\n\nFinally, the maxAge is now 30 days and is also updated on each request.\ni.e. it's a rolling 30 days.\n\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "6848da8320fe4b57cd08e99a9233e6c81a0141d8",
    "files": [
        {
            "sha": "2a0c95a90535c3486df322223620f8b81436d0a1",
            "filename": "api/src/plugins/auth.test.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 22,
            "changes": 69,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6848da8320fe4b57cd08e99a9233e6c81a0141d8/api%2Fsrc%2Fplugins%2Fauth.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6848da8320fe4b57cd08e99a9233e6c81a0141d8/api%2Fsrc%2Fplugins%2Fauth.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth.test.ts?ref=6848da8320fe4b57cd08e99a9233e6c81a0141d8",
            "patch": "@@ -13,6 +13,8 @@ async function setupServer() {\n   return fastify;\n }\n \n+const THIRTY_DAYS_IN_SECONDS = 2592000;\n+\n describe('auth', () => {\n   let fastify: FastifyInstance;\n \n@@ -51,30 +53,11 @@ describe('auth', () => {\n         path: '/',\n         sameSite: 'Lax',\n         domain: COOKIE_DOMAIN,\n-        maxAge: token.ttl\n+        maxAge: THIRTY_DAYS_IN_SECONDS,\n+        httpOnly: true,\n+        secure: true\n       });\n     });\n-\n-    // TODO: Post-MVP sync the cookie max-age with the token ttl (i.e. the\n-    // max-age should be the ttl/1000, not ttl)\n-    it('should set the max-age of the cookie to match the ttl of the token', async () => {\n-      const token = createAccessToken('test-id', 123000);\n-      fastify.get('/test', async (req, reply) => {\n-        reply.setAccessTokenCookie(token);\n-        return { ok: true };\n-      });\n-\n-      const res = await fastify.inject({\n-        method: 'GET',\n-        url: '/test'\n-      });\n-\n-      expect(res.cookies[0]).toEqual(\n-        expect.objectContaining({\n-          maxAge: 123000\n-        })\n-      );\n-    });\n   });\n \n   describe('authorize', () => {\n@@ -250,4 +233,46 @@ describe('auth', () => {\n       expect(res.statusCode).toEqual(200);\n     });\n   });\n+\n+  describe('onRequest Hook', () => {\n+    it('should update the jwt_access_token to httpOnly and secure', async () => {\n+      const rawValue = 'should-not-change';\n+      fastify.get('/test', (req, reply) => {\n+        reply.send({ ok: true });\n+      });\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test',\n+        cookies: {\n+          jwt_access_token: signCookie(rawValue)\n+        }\n+      });\n+\n+      expect(res.cookies[0]).toMatchObject({\n+        httpOnly: true,\n+        secure: true,\n+        value: signCookie(rawValue),\n+        maxAge: THIRTY_DAYS_IN_SECONDS\n+      });\n+\n+      expect(res.json()).toStrictEqual({ ok: true });\n+      expect(res.statusCode).toBe(200);\n+    });\n+\n+    it('should do nothing if there is no jwt_access_token', async () => {\n+      fastify.get('/test', (req, reply) => {\n+        reply.send({ ok: true });\n+      });\n+\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/test'\n+      });\n+\n+      expect(res.cookies).toHaveLength(0);\n+      expect(res.json()).toStrictEqual({ ok: true });\n+      expect(res.statusCode).toBe(200);\n+    });\n+  });\n });"
        },
        {
            "sha": "4829d85d1af28410ddbbb6e9e78aaa2875914b1a",
            "filename": "api/src/plugins/auth.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/6848da8320fe4b57cd08e99a9233e6c81a0141d8/api%2Fsrc%2Fplugins%2Fauth.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/6848da8320fe4b57cd08e99a9233e6c81a0141d8/api%2Fsrc%2Fplugins%2Fauth.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth.ts?ref=6848da8320fe4b57cd08e99a9233e6c81a0141d8",
            "patch": "@@ -28,13 +28,26 @@ declare module 'fastify' {\n }\n \n const auth: FastifyPluginCallback = (fastify, _options, done) => {\n+  const cookieOpts = {\n+    httpOnly: true,\n+    secure: true,\n+    maxAge: 2592000 // thirty days in seconds\n+  };\n   fastify.decorateReply('setAccessTokenCookie', function (accessToken: Token) {\n     const signedToken = jwt.sign({ accessToken }, JWT_SECRET);\n-    void this.setCookie('jwt_access_token', signedToken, {\n-      httpOnly: false,\n-      secure: false,\n-      maxAge: accessToken.ttl\n-    });\n+    void this.setCookie('jwt_access_token', signedToken, cookieOpts);\n+  });\n+\n+  // update existing jwt_access_token cookie properties\n+  fastify.addHook('onRequest', (req, reply, done) => {\n+    const rawCookie = req.cookies['jwt_access_token'];\n+    if (rawCookie) {\n+      const jwtAccessToken = req.unsignCookie(rawCookie);\n+      if (jwtAccessToken.valid) {\n+        reply.setCookie('jwt_access_token', jwtAccessToken.value, cookieOpts);\n+      }\n+    }\n+    done();\n   });\n \n   fastify.decorateRequest('accessDeniedMessage', null);"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 65,
        "deletions": 27
    }
}