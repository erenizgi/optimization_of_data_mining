{
    "author": "ShaunSHamilton",
    "message": "feat(api): add logs to exam environment routes (#59139)",
    "sha": "e89a9b9e3f751b3c0e0e9deab3c8636dec85a381",
    "files": [
        {
            "sha": "791a9c342fac3b54425761fe79dd4373b0ed9772",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 86,
            "deletions": 5,
            "changes": 91,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/e89a9b9e3f751b3c0e0e9deab3c8636dec85a381/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/e89a9b9e3f751b3c0e0e9deab3c8636dec85a381/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=e89a9b9e3f751b3c0e0e9deab3c8636dec85a381",
            "patch": "@@ -107,20 +107,33 @@ async function tokenMetaHandler(\n   req: UpdateReqType<typeof schemas.examEnvironmentTokenMeta>,\n   reply: FastifyReply\n ) {\n+  const logger = this.log.child({ req });\n   const { 'exam-environment-authorization-token': encodedToken } = req.headers;\n+  logger.info({ encodedToken });\n \n   let payload: JwtPayload;\n   try {\n     payload = jwt.verify(encodedToken, JWT_SECRET) as JwtPayload;\n   } catch (e) {\n     // Server refuses to brew (verify) coffee (jwts) with a teapot (random strings)\n+    logger.warn(\n+      { examEnvironmentAuthorizationTokenError: e },\n+      'Invalid token provided.'\n+    );\n     void reply.code(418);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(JSON.stringify(e))\n     );\n   }\n \n   if (!isObjectID(payload.examEnvironmentAuthorizationToken)) {\n+    logger.warn(\n+      {\n+        examEnvironmentAuthorizationToken:\n+          payload.examEnvironmentAuthorizationToken\n+      },\n+      'Token is not an object id.'\n+    );\n     void reply.code(418);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(\n@@ -137,6 +150,7 @@ async function tokenMetaHandler(\n \n   if (!token) {\n     // Endpoint is valid, but resource does not exists\n+    logger.warn('Token does not appear to exist.');\n     void reply.code(404);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_AUTHORIZATION_TOKEN(\n@@ -161,6 +175,8 @@ async function postExamGeneratedExamHandler(\n   req: UpdateReqType<typeof schemas.examEnvironmentPostExamGeneratedExam>,\n   reply: FastifyReply\n ) {\n+  const logger = this.log.child({ req });\n+  logger.info({ userId: req.user?.id });\n   // Get exam from DB\n   const examId = req.body.examId;\n   const maybeExam = await mapErr(\n@@ -172,10 +188,12 @@ async function postExamGeneratedExamHandler(\n   );\n   if (maybeExam.hasError) {\n     if (maybeExam.error instanceof PrismaClientValidationError) {\n+      logger.warn({ examError: maybeExam.error }, 'Invalid exam id given.');\n       void reply.code(400);\n       return reply.send(ERRORS.FCC_EINVAL_EXAM_ID(maybeExam.error.message));\n     }\n \n+    logger.error({ examError: maybeExam.error });\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExam.error))\n@@ -185,6 +203,7 @@ async function postExamGeneratedExamHandler(\n   const exam = maybeExam.data;\n \n   if (!exam) {\n+    logger.warn({ examId }, 'No exam with given id.');\n     void reply.code(404);\n     return reply.send(\n       ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_MISSING_EXAM('Invalid exam id given.')\n@@ -196,6 +215,10 @@ async function postExamGeneratedExamHandler(\n   const isExamPrerequisitesMet = checkPrerequisites(user, exam.prerequisites);\n \n   if (!isExamPrerequisitesMet) {\n+    logger.warn(\n+      { examId: exam.id },\n+      'User has not completed prerequisites to take exam.'\n+    );\n     void reply.code(403);\n     // TODO: Consider sending unmet prerequisites\n     return reply.send(\n@@ -216,6 +239,10 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeExamAttempts.hasError) {\n+    logger.error(\n+      { examAttemptsError: maybeExamAttempts.error },\n+      'Unable to query exam attempts.'\n+    );\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExamAttempts.error))\n@@ -238,6 +265,10 @@ async function postExamGeneratedExamHandler(\n         examExpirationTime + exam.config.retakeTimeInMS < Date.now();\n \n       if (!retakeAllowed) {\n+        logger.warn(\n+          { examExpirationTime },\n+          'User has completed exam too recently to retake.'\n+        );\n         void reply.code(429);\n         // TODO: Consider sending last completed time\n         return reply.send(\n@@ -259,13 +290,21 @@ async function postExamGeneratedExamHandler(\n       );\n \n       if (generated.hasError) {\n+        logger.error(\n+          { generatedError: generated.error },\n+          'Unable to query generated exam.'\n+        );\n         void reply.code(500);\n         return reply.send(\n           ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(generated.error))\n         );\n       }\n \n       if (generated.data === null) {\n+        logger.error(\n+          { generatedExamId: lastAttempt.generatedExamId },\n+          'Generated exam not found.'\n+        );\n         void reply.code(500);\n         return reply.send(\n           ERRORS.FCC_ERR_EXAM_ENVIRONMENT(\n@@ -301,6 +340,7 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeGeneratedExams.hasError) {\n+    logger.error({ generatedExamsError: maybeGeneratedExams.error });\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(maybeGeneratedExams.error)\n@@ -310,12 +350,10 @@ async function postExamGeneratedExamHandler(\n   const generatedExams = maybeGeneratedExams.data;\n \n   if (generatedExams.length === 0) {\n+    const errMessage = `Unable to provide a generated exam. Either all generated exams have been exhausted, or all generated exams are deprecated.`;\n+    logger.error({ examId: exam.id }, errMessage);\n     void reply.code(500);\n-    return reply.send(\n-      ERRORS.FCC_ERR_EXAM_ENVIRONMENT(\n-        `Unable to provide a generated exam. Either all generated exams have been exhausted, or all generated exams are deprecated.`\n-      )\n-    );\n+    return reply.send(ERRORS.FCC_ERR_EXAM_ENVIRONMENT(errMessage));\n   }\n \n   const randomGeneratedExam =\n@@ -330,6 +368,7 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeGeneratedExam.hasError) {\n+    logger.error({ generatedExamError: maybeGeneratedExam.error });\n     void reply.code(500);\n     return reply.send(\n       // TODO: Consider more specific code\n@@ -343,6 +382,10 @@ async function postExamGeneratedExamHandler(\n   const generatedExam = maybeGeneratedExam.data;\n \n   if (generatedExam === null) {\n+    logger.error(\n+      { generatedExamId: randomGeneratedExam.id },\n+      'Generated exam not found.'\n+    );\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(`Unable to locate generated exam.`)\n@@ -364,6 +407,7 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (attempt.hasError) {\n+    logger.error({ attemptError: attempt.error });\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT_CREATE_EXAM_ATTEMPT(\n@@ -378,6 +422,7 @@ async function postExamGeneratedExamHandler(\n   );\n \n   if (maybeUserExam.hasError) {\n+    logger.error({ userExamError: maybeUserExam.error });\n     await this.prisma.envExamAttempt.delete({\n       where: {\n         id: attempt.data.id\n@@ -413,6 +458,8 @@ async function postExamAttemptHandler(\n   req: UpdateReqType<typeof schemas.examEnvironmentPostExamAttempt>,\n   reply: FastifyReply\n ) {\n+  const logger = this.log.child({ req });\n+  logger.info({ userId: req.user?.id });\n   const { attempt } = req.body;\n \n   const user = req.user!;\n@@ -427,6 +474,10 @@ async function postExamAttemptHandler(\n   );\n \n   if (maybeAttempts.hasError) {\n+    logger.error(\n+      { error: maybeAttempts.error },\n+      'User attempt cannot be linked to an exam attempt.'\n+    );\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempts.error))\n@@ -436,6 +487,7 @@ async function postExamAttemptHandler(\n   const attempts = maybeAttempts.data;\n \n   if (attempts.length === 0) {\n+    logger.warn({ examId: attempt.examId }, 'No attempts found for user.');\n     void reply.code(404);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT_EXAM_ATTEMPT(\n@@ -457,6 +509,7 @@ async function postExamAttemptHandler(\n   );\n \n   if (maybeExam.hasError) {\n+    logger.error({ examError: maybeExam.error });\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeExam.error))\n@@ -466,6 +519,7 @@ async function postExamAttemptHandler(\n   const exam = maybeExam.data;\n \n   if (exam === null) {\n+    logger.warn({ examId: attempt.examId }, 'Invalid exam id given.');\n     void reply.code(404);\n     return reply.send(\n       ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_MISSING_EXAM('Invalid exam id given.')\n@@ -476,6 +530,10 @@ async function postExamAttemptHandler(\n     latestAttempt.startTimeInMS + exam.config.totalTimeInMS < Date.now();\n \n   if (isAttemptExpired) {\n+    logger.warn(\n+      { examAttemptId: latestAttempt.id },\n+      'Attempt has exceeded submission time.'\n+    );\n     void reply.code(403);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_EXAM_ATTEMPT(\n@@ -494,6 +552,7 @@ async function postExamAttemptHandler(\n   );\n \n   if (maybeGeneratedExam.hasError) {\n+    logger.error({ generatedExamError: maybeGeneratedExam.error });\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeGeneratedExam.error))\n@@ -503,6 +562,10 @@ async function postExamAttemptHandler(\n   const generatedExam = maybeGeneratedExam.data;\n \n   if (generatedExam === null) {\n+    logger.warn(\n+      { generatedExamId: latestAttempt.generatedExamId },\n+      'Generated exam not found.'\n+    );\n     void reply.code(404);\n     return reply.send(\n       ERRORS.FCC_ENOENT_EXAM_ENVIRONMENT_GENERATED_EXAM(\n@@ -536,6 +599,10 @@ async function postExamAttemptHandler(\n   );\n \n   if (maybeValidExamAttempt.hasError) {\n+    logger.warn(\n+      { validExamAttemptError: maybeValidExamAttempt.error },\n+      'Invalid exam attempt.'\n+    );\n     void reply.code(400);\n     const message =\n       maybeValidExamAttempt.error instanceof Error\n@@ -545,6 +612,7 @@ async function postExamAttemptHandler(\n   }\n \n   if (maybeUpdatedAttempt.hasError) {\n+    logger.error({ updatedAttemptError: maybeUpdatedAttempt.error });\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeUpdatedAttempt.error))\n@@ -564,9 +632,12 @@ async function postScreenshotHandler(\n   req: UpdateReqType<typeof schemas.examEnvironmentPostScreenshot>,\n   reply: FastifyReply\n ) {\n+  const logger = this.log.child({ req });\n+  logger.info({ userId: req.user?.id });\n   const isMultipart = req.isMultipart();\n \n   if (!isMultipart) {\n+    logger.warn('Request is not multipart form data.');\n     void reply.code(400);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_SCREENSHOT(\n@@ -579,6 +650,7 @@ async function postScreenshotHandler(\n   const imgData = await req.file();\n \n   if (!imgData) {\n+    logger.warn('No image provided.');\n     void reply.code(400);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_SCREENSHOT('No image provided.')\n@@ -594,6 +666,10 @@ async function postScreenshotHandler(\n   );\n \n   if (maybeAttempt.hasError) {\n+    logger.error(\n+      { error: maybeAttempt.error },\n+      'User screenshot cannot be linked to an exam attempt.'\n+    );\n     void reply.code(500);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT(JSON.stringify(maybeAttempt.error))\n@@ -603,6 +679,7 @@ async function postScreenshotHandler(\n   const attempt = maybeAttempt.data;\n \n   if (attempt.length === 0) {\n+    logger.warn('No exam attempts found for user.');\n     void reply.code(404);\n     return reply.send(\n       ERRORS.FCC_ERR_EXAM_ENVIRONMENT_EXAM_ATTEMPT(\n@@ -615,6 +692,7 @@ async function postScreenshotHandler(\n \n   // Verify image is JPG using magic number\n   if (imgBinary[0] !== 0xff || imgBinary[1] !== 0xd8 || imgBinary[2] !== 0xff) {\n+    logger.warn('Invalid image format');\n     void reply.code(400);\n     return reply.send(\n       ERRORS.FCC_EINVAL_EXAM_ENVIRONMENT_SCREENSHOT('Invalid image format.')\n@@ -642,6 +720,9 @@ async function getExams(\n   req: UpdateReqType<typeof schemas.examEnvironmentExams>,\n   reply: FastifyReply\n ) {\n+  const logger = this.log.child({ req });\n+  logger.info({ user: req.user });\n+\n   const user = req.user!;\n   const exams = await this.prisma.envExam.findMany({\n     where: {"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 86,
        "deletions": 5
    }
}