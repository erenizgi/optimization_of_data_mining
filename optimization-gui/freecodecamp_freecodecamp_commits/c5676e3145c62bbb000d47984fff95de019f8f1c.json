{
    "author": "Jamesren64",
    "message": "fix(auth): redirect users signing in from landing page to /learn (#63868)\n\nCo-authored-by: ahmad abdolsaheb <ahmad.abdolsaheb@gmail.com>\nCo-authored-by: Oliver Eyton-Williams <ojeytonwilliams@gmail.com>",
    "sha": "c5676e3145c62bbb000d47984fff95de019f8f1c",
    "files": [
        {
            "sha": "9a9406c0e11abfb396d5c11185c67037a7849254",
            "filename": "api/src/plugins/auth0.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c5676e3145c62bbb000d47984fff95de019f8f1c/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c5676e3145c62bbb000d47984fff95de019f8f1c/api%2Fsrc%2Fplugins%2Fauth0.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.test.ts?ref=c5676e3145c62bbb000d47984fff95de019f8f1c",
            "patch": "@@ -342,6 +342,23 @@ describe('auth0 plugin', () => {\n       );\n     });\n \n+    test('should redirect to learn if the user has signed in from the landing page', async () => {\n+      mockAuthSuccess();\n+\n+      const returnTo = 'https://www.freecodecamp.org/';\n+      const res = await fastify.inject({\n+        method: 'GET',\n+        url: '/auth/auth0/callback?state=valid',\n+        cookies: {\n+          'login-returnto': sign(returnTo)\n+        }\n+      });\n+\n+      expect(res.headers.location).toEqual(\n+        expect.stringContaining('https://www.freecodecamp.org/learn?')\n+      );\n+    });\n+\n     test('should redirect home if the login-returnto cookie is invalid', async () => {\n       mockAuthSuccess();\n       const returnTo = 'https://www.evilcodecamp.org/espanol/learn';"
        },
        {
            "sha": "86e302a0cb243fe9437861164f1c0e07e7a1aa20",
            "filename": "api/src/plugins/auth0.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/c5676e3145c62bbb000d47984fff95de019f8f1c/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/c5676e3145c62bbb000d47984fff95de019f8f1c/api%2Fsrc%2Fplugins%2Fauth0.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fauth0.ts?ref=c5676e3145c62bbb000d47984fff95de019f8f1c",
            "patch": "@@ -124,7 +124,7 @@ export const auth0Client: FastifyPluginCallbackTypebox = fp(\n         }\n       }\n \n-      const { returnTo } = getLoginRedirectParams(req);\n+      const { returnTo, origin } = getLoginRedirectParams(req);\n \n       let token;\n       try {\n@@ -185,7 +185,10 @@ export const auth0Client: FastifyPluginCallbackTypebox = fp(\n \n       reply.setAccessTokenCookie(createAccessToken(id));\n \n-      void reply.redirectWithMessage(returnTo, {\n+      const returnPath = new URL(returnTo).pathname;\n+      const returnURL = returnPath === '/' ? `${origin}/learn` : returnTo;\n+\n+      void reply.redirectWithMessage(returnURL, {\n         type: 'success',\n         content: 'flash.signin-success'\n       });"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
    }
}