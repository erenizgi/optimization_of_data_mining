{
    "author": "ahmaxed",
    "message": "fix: check for total challenge completion before donation pop up (#57425)",
    "sha": "bf253db285c35cec36cf557c97709f2aac598f4c",
    "files": [
        {
            "sha": "0f1ee707ca42fb9cb0916180b071487c67b0189f",
            "filename": "client/src/redux/selectors.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bf253db285c35cec36cf557c97709f2aac598f4c/client%2Fsrc%2Fredux%2Fselectors.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bf253db285c35cec36cf557c97709f2aac598f4c/client%2Fsrc%2Fredux%2Fselectors.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Fselectors.js?ref=bf253db285c35cec36cf557c97709f2aac598f4c",
            "patch": "@@ -42,6 +42,10 @@ export const shouldRequestDonationSelector = state => {\n   // don't request donation if already donating\n   if (isDonating) return false;\n \n+  // donations only appear after the user has completed ten challenges (i.e.\n+  // not before the 11th challenge has mounted)\n+  if (completedChallengeCount < 10) return false;\n+\n   // a block has been completed\n   if (recentlyClaimedBlock) return true;\n \n@@ -56,10 +60,6 @@ export const shouldRequestDonationSelector = state => {\n     return sessionChallengeData.countSinceSave >= 20;\n   }\n \n-  // donations only appear after the user has completed ten challenges (i.e.\n-  // not before the 11th challenge has mounted)\n-  if (completedChallengeCount < 10) return false;\n-\n   /*\n    Show modal if user has completed 10 challanged in total\n    and 3 or more in this session."
        },
        {
            "sha": "a0041e5de61733a00715100bf8511e7b3bc188bb",
            "filename": "e2e/donation-modal.spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 5,
            "changes": 31,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bf253db285c35cec36cf557c97709f2aac598f4c/e2e%2Fdonation-modal.spec.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bf253db285c35cec36cf557c97709f2aac598f4c/e2e%2Fdonation-modal.spec.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/e2e%2Fdonation-modal.spec.ts?ref=bf253db285c35cec36cf557c97709f2aac598f4c",
            "patch": "@@ -6,7 +6,7 @@ import { clearEditor, focusEditor } from './utils/editor';\n \n const slowExpect = expect.configure({ timeout: 25000 });\n \n-const completeFrontEndCert = async (page: Page) => {\n+const completeFrontEndCert = async (page: Page, number?: number) => {\n   await page.goto(\n     `/learn/front-end-development-libraries/front-end-development-libraries-projects/build-a-random-quote-machine`\n   );\n@@ -19,9 +19,10 @@ const completeFrontEndCert = async (page: Page) => {\n     '25--5-clock'\n   ];\n \n-  for (const project of projects) {\n+  const loopNumber = number || projects.length;\n+  for (let i = 0; i < loopNumber; i++) {\n     await page.waitForURL(\n-      `/learn/front-end-development-libraries/front-end-development-libraries-projects/build-a-${project}`\n+      `/learn/front-end-development-libraries/front-end-development-libraries-projects/build-a-${projects[i]}`\n     );\n     await page\n       .getByRole('textbox', { name: 'solution' })\n@@ -257,13 +258,33 @@ test.describe('Donation modal appearance logic - New user', () => {\n     await expect(donationModal).toBeHidden();\n   });\n \n-  test('should appear if the user has just completed a new block, and should not appear if the user re-submits the projects of the block', async ({\n+  test('should not appear if the user has just completed a new block but has less than 10 completed challenges', async ({\n     page\n   }) => {\n     test.setTimeout(40000);\n \n     await completeFrontEndCert(page);\n \n+    const donationModal = page\n+      .getByRole('dialog')\n+      .filter({ hasText: 'Become a Supporter' });\n+    await expect(donationModal).toBeHidden();\n+  });\n+});\n+\n+test.describe('Donation modal appearance logic - Certified user claiming a new block', () => {\n+  test.use({ storageState: 'playwright/.auth/certified-user.json' });\n+  execSync('node ./tools/scripts/seed/seed-demo-user --almost-certified-user');\n+\n+  test('should appear if the user has just completed a new block, and should not appear if the user re-submits the projects of the block', async ({\n+    page,\n+    context\n+  }) => {\n+    await context.grantPermissions(['clipboard-read', 'clipboard-write']);\n+    test.setTimeout(40000);\n+\n+    await completeFrontEndCert(page, 1);\n+\n     const donationModal = page\n       .getByRole('dialog')\n       .filter({ hasText: 'Become a Supporter' });\n@@ -284,7 +305,7 @@ test.describe('Donation modal appearance logic - New user', () => {\n     await donationModal.getByRole('button', { name: 'Ask me later' }).click();\n     await expect(donationModal).toBeHidden();\n \n-    await completeFrontEndCert(page);\n+    await completeFrontEndCert(page, 1);\n     await expect(donationModal).toBeHidden();\n   });\n });"
        },
        {
            "sha": "f4c3c934353a436114ffab5bded894bce1c6c08f",
            "filename": "tools/scripts/seed/seed-demo-user.js",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bf253db285c35cec36cf557c97709f2aac598f4c/tools%2Fscripts%2Fseed%2Fseed-demo-user.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bf253db285c35cec36cf557c97709f2aac598f4c/tools%2Fscripts%2Fseed%2Fseed-demo-user.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fscripts%2Fseed%2Fseed-demo-user.js?ref=bf253db285c35cec36cf557c97709f2aac598f4c",
            "patch": "@@ -10,15 +10,17 @@ const {\n   blankUser,\n   publicUser,\n   fullyCertifiedUser,\n-  userIds\n+  userIds,\n+  almostFullyCertifiedUser\n } = require('./user-data');\n \n const options = {\n   'set-true': { type: 'string', multiple: true },\n   'top-contributor': { type: 'boolean' },\n   'set-false': { type: 'string', multiple: true },\n   'seed-trophy-challenges': { type: 'boolean' },\n-  'certified-user': { type: 'boolean' }\n+  'certified-user': { type: 'boolean' },\n+  'almost-certified-user': { type: 'boolean' }\n };\n \n const { values: argValues } = parseArgs({ options });\n@@ -124,13 +126,15 @@ const run = async () => {\n   await dropUsers();\n   if (argValues['certified-user']) {\n     await user.insertOne(fullyCertifiedUser);\n-    await user.insertOne(blankUser);\n-    await user.insertOne(publicUser);\n+  } else if (argValues['almost-certified-user']) {\n+    await user.insertOne(almostFullyCertifiedUser);\n   } else {\n     await user.insertOne(demoUser);\n-    await user.insertOne(blankUser);\n-    await user.insertOne(publicUser);\n   }\n+\n+  await user.insertOne(blankUser);\n+  await user.insertOne(publicUser);\n+\n   log('local auth user seed complete');\n };\n "
        },
        {
            "sha": "28c92c3fa7a602162e4fd693f3c9c4f7e645e461",
            "filename": "tools/scripts/seed/user-data.js",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bf253db285c35cec36cf557c97709f2aac598f4c/tools%2Fscripts%2Fseed%2Fuser-data.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bf253db285c35cec36cf557c97709f2aac598f4c/tools%2Fscripts%2Fseed%2Fuser-data.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/tools%2Fscripts%2Fseed%2Fuser-data.js?ref=bf253db285c35cec36cf557c97709f2aac598f4c",
            "patch": "@@ -5,8 +5,15 @@ const blankUserId = new ObjectId('5bd30e0f1caf6ac3ddddddb9');\n const publicUserId = new ObjectId('663b839b24a8b29f57728b13');\n const demoUserId = new ObjectId('5bd30e0f1caf6ac3ddddddb5');\n const fullyCertifiedUserId = new ObjectId('5fa2db00a25c1c1fa49ce067');\n+const almostFullyCertifiedUserId = new ObjectId('5bd30e0f1caf6ac3ddddddb9');\n \n-const userIds = [blankUserId, publicUserId, demoUserId, fullyCertifiedUserId];\n+const userIds = [\n+  blankUserId,\n+  publicUserId,\n+  demoUserId,\n+  fullyCertifiedUserId,\n+  almostFullyCertifiedUserId\n+];\n \n module.exports.blankUser = {\n   _id: blankUserId,\n@@ -12287,4 +12294,13 @@ module.exports.fullyCertifiedUser = {\n   unsubscribeId: 'tBX8stC5jiustPBteF2mV'\n };\n \n+module.exports.almostFullyCertifiedUser = {\n+  ...module.exports.fullyCertifiedUser,\n+  id: almostFullyCertifiedUserId,\n+  completedChallenges:\n+    module.exports.fullyCertifiedUser.completedChallenges.filter(\n+      challenge => challenge.id !== 'bd7158d8c442eddfaeb5bd13'\n+    )\n+};\n+\n module.exports.userIds = userIds;"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 57,
        "deletions": 16
    }
}