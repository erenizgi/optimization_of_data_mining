{
    "author": "ojeytonwilliams",
    "message": "fix(client): gracefully handle errors while fetching user (#61623)\n\nCo-authored-by: Shaun Hamilton <shauhami020@gmail.com>",
    "sha": "7fdaa034c8f42504056c0af08510d6b1a2da1228",
    "files": [
        {
            "sha": "b9da69a81fc8fcb89dde508205738a7e129ac87c",
            "filename": "client/src/components/layouts/default.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fcomponents%2Flayouts%2Fdefault.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fcomponents%2Flayouts%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fcomponents%2Flayouts%2Fdefault.tsx?ref=7fdaa034c8f42504056c0af08510d6b1a2da1228",
            "patch": "@@ -181,7 +181,7 @@ function DefaultLayout({\n \n   const isJapanese = clientLocale === 'japanese';\n \n-  if (fetchState.pending) {\n+  if (!fetchState.complete) {\n     return <Loader fullScreen={true} messageDelay={5000} />;\n   } else {\n     return ("
        },
        {
            "sha": "d242e461e26332c576138fc990d7ef4e7b374252",
            "filename": "client/src/redux/action-types.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Faction-types.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Faction-types.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Faction-types.js?ref=7fdaa034c8f42504056c0af08510d6b1a2da1228",
            "patch": "@@ -46,7 +46,8 @@ export const actionTypes = createTypes(\n     ...createAsyncTypes('showCert'),\n     ...createAsyncTypes('reportUser'),\n     ...createAsyncTypes('deleteUserToken'),\n-    ...createAsyncTypes('saveChallenge')\n+    ...createAsyncTypes('saveChallenge'),\n+    'fetchUserTimeout'\n   ],\n   ns\n );"
        },
        {
            "sha": "a6d2ed2f9efa62563912d7ab03278c84ae3f2205",
            "filename": "client/src/redux/actions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Factions.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Factions.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Factions.ts?ref=7fdaa034c8f42504056c0af08510d6b1a2da1228",
            "patch": "@@ -50,6 +50,7 @@ export const acceptTermsError = createAction(actionTypes.acceptTermsError);\n \n export const fetchUser = createAction(actionTypes.fetchUser);\n export const fetchUserComplete = createAction(actionTypes.fetchUserComplete);\n+export const fetchUserTimeout = createAction(actionTypes.fetchUserTimeout);\n export const fetchUserError = createAction(actionTypes.fetchUserError);\n \n export const toggleTheme = createAction(actionTypes.toggleTheme);"
        },
        {
            "sha": "d093dda4d665461fd69b620a07efd7a900e00789",
            "filename": "client/src/redux/fetch-user-saga.js",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Ffetch-user-saga.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Ffetch-user-saga.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Ffetch-user-saga.js?ref=7fdaa034c8f42504056c0af08510d6b1a2da1228",
            "patch": "@@ -1,20 +1,41 @@\n-import { call, put, takeEvery } from 'redux-saga/effects';\n+import { call, cancel, delay, fork, put, takeEvery } from 'redux-saga/effects';\n import { getSessionUser, getUserProfile } from '../utils/ajax';\n import {\n   fetchProfileForUserComplete,\n   fetchProfileForUserError,\n   fetchUserComplete,\n-  fetchUserError\n+  fetchUserError,\n+  fetchUserTimeout\n } from './actions';\n \n function* fetchSessionUser() {\n+  const timeoutTask = yield fork(function* () {\n+    // The server should not take anywhere near 2 seconds to respond. If it\n+    // does, we assume the request has failed and dispatch a timeout action to\n+    // dismiss the loading state.\n+    yield delay(2000);\n+    yield put(fetchUserTimeout());\n+  });\n+\n   try {\n-    const { data: user } = yield call(getSessionUser);\n+    // This is on a longer timeout to make sure that users with slow connections\n+    // do, eventually, get signed in.\n+    const res = yield call(getSessionUser, AbortSignal.timeout(10000));\n+\n+    const isSignedOut = res.response.status === 401;\n+    if (!res.response.ok && !isSignedOut) {\n+      throw new Error(\n+        `HTTP Error: ${res.response.status} ${res.response.statusText}`\n+      );\n+    }\n \n+    const { data: user } = res;\n     yield put(fetchUserComplete({ user }));\n   } catch (e) {\n     console.log('failed to fetch user', e);\n     yield put(fetchUserError(e));\n+  } finally {\n+    yield cancel(timeoutTask);\n   }\n }\n "
        },
        {
            "sha": "2335cd15dfe88c752a25fafc46d334dec6e7308c",
            "filename": "client/src/redux/index.js",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Findex.js",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Fredux%2Findex.js",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Fredux%2Findex.js?ref=7fdaa034c8f42504056c0af08510d6b1a2da1228",
            "patch": "@@ -218,11 +218,22 @@ export const reducer = handleActions(\n         error: null\n       }\n     }),\n+    [actionTypes.fetchUserTimeout]: state => ({\n+      ...state,\n+      userFetchState: {\n+        // Pending because the fetch may still complete. This allows the UI to\n+        // render what it can while waiting for the fetch to complete.\n+        pending: true,\n+        complete: true,\n+        errored: false,\n+        error: null\n+      }\n+    }),\n     [actionTypes.fetchUserError]: (state, { payload }) => ({\n       ...state,\n       userFetchState: {\n         pending: false,\n-        complete: false,\n+        complete: true,\n         errored: true,\n         error: payload\n       }"
        },
        {
            "sha": "bb045e6205952c33eccb0739d97e912593aa475f",
            "filename": "client/src/utils/ajax.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Futils%2Fajax.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/7fdaa034c8f42504056c0af08510d6b1a2da1228/client%2Fsrc%2Futils%2Fajax.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Futils%2Fajax.ts?ref=7fdaa034c8f42504056c0af08510d6b1a2da1228",
            "patch": "@@ -37,10 +37,14 @@ export interface ResponseWithData<T> {\n \n // TODO: Might want to handle flash messages as close to the request as possible\n // to make use of the Response object (message, status, etc)\n-async function get<T>(path: string): Promise<ResponseWithData<T>> {\n+async function get<T>(\n+  path: string,\n+  signal?: AbortSignal\n+): Promise<ResponseWithData<T>> {\n   const response = await fetch(`${base}${path}`, {\n     ...defaultOptions,\n-    headers: { 'CSRF-Token': getCSRFToken() }\n+    headers: { 'CSRF-Token': getCSRFToken() },\n+    signal\n   });\n \n   return combineDataWithResponse(response);\n@@ -144,9 +148,12 @@ function mapKeyToFileKey<K>(\n   return files.map(({ key, ...rest }) => ({ ...rest, fileKey: key }));\n }\n \n-export function getSessionUser(): Promise<ResponseWithData<User | null>> {\n+export function getSessionUser(\n+  signal?: AbortSignal\n+): Promise<ResponseWithData<User | null>> {\n   const responseWithData: Promise<ResponseWithData<ApiUserResponse>> = get(\n-    '/user/get-session-user'\n+    '/user/get-session-user',\n+    signal\n   );\n   // TODO: Once DB is migrated, no longer need to parse `files` -> `challengeFiles` etc.\n   return responseWithData.then(({ response, data }) => {"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 51,
        "deletions": 10
    }
}