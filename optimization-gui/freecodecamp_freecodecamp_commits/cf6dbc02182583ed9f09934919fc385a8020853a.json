{
    "author": "ShaunSHamilton",
    "message": "fix(api): can take exam if attempt not expired (#62543)",
    "sha": "cf6dbc02182583ed9f09934919fc385a8020853a",
    "files": [
        {
            "sha": "1d27c548842c174464427a688f91228ab5a211f2",
            "filename": "api/prisma/exam-environment.prisma",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cf6dbc02182583ed9f09934919fc385a8020853a/api%2Fprisma%2Fexam-environment.prisma",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cf6dbc02182583ed9f09934919fc385a8020853a/api%2Fprisma%2Fexam-environment.prisma",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fprisma%2Fexam-environment.prisma?ref=cf6dbc02182583ed9f09934919fc385a8020853a",
            "patch": "@@ -14,7 +14,6 @@ model ExamEnvironmentExam {\n   /// The default must be incremented by 1, if anything in the schema changes\n   version       Int                          @default(2)\n \n-\n   // Relations\n   generatedExams           ExamEnvironmentGeneratedExam[]\n   examAttempts             ExamEnvironmentExamAttempt[]\n@@ -140,7 +139,6 @@ model ExamEnvironmentExamAttempt {\n   /// The default must be incremented by 1, if anything in the schema changes\n   version       Int                                 @default(2)\n \n-\n   // Relations\n   user                          user                            @relation(fields: [userId], references: [id], onDelete: Cascade)\n   exam                          ExamEnvironmentExam             @relation(fields: [examId], references: [id], onDelete: Cascade)\n@@ -180,7 +178,6 @@ model ExamEnvironmentGeneratedExam {\n   /// The default must be incremented by 1, if anything in the schema changes\n   version      Int                                   @default(1)\n \n-\n   // Relations\n   exam           ExamEnvironmentExam          @relation(fields: [examId], references: [id], onDelete: Cascade)\n   EnvExamAttempt ExamEnvironmentExamAttempt[]\n@@ -208,7 +205,6 @@ model ExamEnvironmentChallenge {\n \n   version Int @default(1)\n \n-\n   exam ExamEnvironmentExam @relation(fields: [examId], references: [id], onDelete: Cascade)\n }\n \n@@ -220,7 +216,6 @@ model ExamEnvironmentAuthorizationToken {\n   userId   String   @unique @db.ObjectId\n   version  Int      @default(1)\n \n-\n   // Relations\n   user user @relation(fields: [userId], references: [id], onDelete: Cascade)\n }\n@@ -238,12 +233,11 @@ model ExamEnvironmentExamModeration {\n   /// Foreign key to moderator. This is `null` until the item is moderated.\n   moderatorId    String?                             @db.ObjectId\n \n-  /// Date the exam attempt was added to the moderation queue\n+  /// Date the exam attempt expired\n   submissionDate DateTime @default(now()) @db.Date\n   /// Version of the record\n   /// The default must be incremented by 1, if anything in the schema changes\n-  version        Int      @default(1)\n-\n+  version        Int      @default(2)\n \n   // Relations\n   examAttempt ExamEnvironmentExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)"
        },
        {
            "sha": "e22da6660efa9ce27a1a7bc25cde01fcf5b74232",
            "filename": "api/src/exam-environment/routes/exam-environment.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/cf6dbc02182583ed9f09934919fc385a8020853a/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/cf6dbc02182583ed9f09934919fc385a8020853a/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fexam-environment%2Froutes%2Fexam-environment.ts?ref=cf6dbc02182583ed9f09934919fc385a8020853a",
            "patch": "@@ -823,8 +823,17 @@ async function getExams(\n       : exam.config.retakeTimeInMS;\n     const retakeDateInMS =\n       lastAttemptStartTime + examTotalTimeInMS + examRetakeTimeInMS;\n-    const isRetakeTimePassed = Date.now() > retakeDateInMS;\n \n+    const lastAttemptExpired =\n+      Date.now() > lastAttemptStartTime + examTotalTimeInMS;\n+    if (!lastAttemptExpired) {\n+      logger.info(`Exam ${exam.id} in progress.`);\n+      availableExam.canTake = true;\n+      availableExams.push(availableExam);\n+      continue;\n+    }\n+\n+    const isRetakeTimePassed = Date.now() > retakeDateInMS;\n     if (!isRetakeTimePassed) {\n       logger.info(`Time until retake: ${retakeDateInMS - Date.now()} [ms]`);\n       availableExam.canTake = false;"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 12,
        "deletions": 9
    }
}