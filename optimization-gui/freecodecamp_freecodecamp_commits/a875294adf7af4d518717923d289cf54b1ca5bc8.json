{
    "author": "raisedadead",
    "message": "fix(gha): use machine IP, and better logs",
    "sha": "a875294adf7af4d518717923d289cf54b1ca5bc8",
    "files": [
        {
            "sha": "7f44642c0f42e5112ef4b4c1eae87384e0e2eead",
            "filename": ".github/workflows/deploy.yml",
            "status": "modified",
            "additions": 19,
            "deletions": 15,
            "changes": 34,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/a875294adf7af4d518717923d289cf54b1ca5bc8/.github%2Fworkflows%2Fdeploy.yml",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/a875294adf7af4d518717923d289cf54b1ca5bc8/.github%2Fworkflows%2Fdeploy.yml",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/.github%2Fworkflows%2Fdeploy.yml?ref=a875294adf7af4d518717923d289cf54b1ca5bc8",
            "patch": "@@ -70,19 +70,19 @@ jobs:\n           tags: tag:ci\n           version: latest\n \n-      - name: Configure SSH\n-        # This is a workaround to avoid the SSH warning about known hosts & strict host key checking.\n-        # It's not a problem for us, because we're using Tailscale to connect.\n+      - name: Configure SSH & Check Connection\n         run: |\n           mkdir -p ~/.ssh\n           echo \"Host *\n             UserKnownHostsFile=/dev/null\n             StrictHostKeyChecking no\" > ~/.ssh/config\n-\n-      - name: Check connection\n-        run: |\n+          chmod 644 ~/.ssh/config\n+          sleep 10\n           tailscale status | grep -q \"$TS_MACHINE_NAME\" || { echo \"Error: Machine not found\"; exit 1; }\n-          ssh $TS_USERNAME@$TS_MACHINE_NAME \"uptime\"\n+          sleep 1\n+          MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n+          echo -e \"\\nLOG:Checking connection to $TS_MACHINE_NAME...\"\n+          ssh $TS_USERNAME@$MACHINE_IP \"uptime\"\n \n       - name: Deploy with Docker Stack\n         env:\n@@ -94,36 +94,40 @@ jobs:\n           DEPLOYMENT_VERSION: ${{ needs.build.outputs.tagname }}\n           FCC_API_LOG_LEVEL: ${{ needs.static.outputs.fcc_api_log_level }}\n         run: |\n-          ssh $TS_USERNAME@$TS_MACHINE_NAME /bin/bash << EOF\n-            set -e\n+          REMOTE_SCRIPT=\"\n+          set -e\n+            echo -e '\\nLOG:Deploying API to $TS_MACHINE_NAME...'\n             cd /home/${TS_USERNAME}/docker-swarm-config/stacks/api || { echo \"Error: Failed to change directory\"; exit 1; }\n             which age > /dev/null || { echo \"Error: age not installed\"; exit 1; }\n \n-            # Decrypt secrets\n+            echo -e '\\nLOG:Decrypting secrets...'\n             echo \"${AGE_ENCRYPTED_ASC_SECRETS}\" > secrets.age.asc\n             echo \"${AGE_SECRET_KEY}\" > age.key && chmod 600 age.key\n             age --identity age.key --decrypt secrets.age.asc > .env\n             rm -f age.key secrets.age.asc\n \n-            # Add deployment variables\n+            echo -e '\\nLOG:Adding deployment variables...'\n             {\n               echo \"DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}\"\n               echo \"FCC_API_LOG_LEVEL=${FCC_API_LOG_LEVEL}\"\n             } >> .env\n \n-            # Export environment variables with proper escaping\n+            echo -e '\\nLOG:Exporting environment variables...'\n             while IFS='=' read -r key value; do\n               if [[ -n \\$key && ! \\$key =~ ^# ]]; then\n                 export \"\\${key}=\\${value}\"\n               fi\n             done < .env\n             rm -f .env\n \n-            # Validate environment and config\n+            echo -e '\\nLOG:Validating environment and config...'\n             env | grep -E 'DOMAIN|DEPLOYMENT' || { echo \"Error: Required environment variables not found\"; exit 1; }\n             docker stack config -c stack-api.yml > /dev/null || { echo \"Error: Invalid stack configuration\"; exit 1; }\n \n-            # Deploy\n+            echo -e '\\nLOG:Deploying stack...'\n             docker stack deploy -c stack-api.yml --prune --with-registry-auth --detach=false ${STACK_NAME}\n-          EOF\n+            echo -e '\\nLOG:Finished deployment.'\n+          \"\n+          MACHINE_IP=$(tailscale ip -4 $TS_MACHINE_NAME)\n+          ssh $TS_USERNAME@$MACHINE_IP \"$REMOTE_SCRIPT\"\n         shell: bash"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 19,
        "deletions": 15
    }
}