{
    "author": "ojeytonwilliams",
    "message": "fix(api): reset all claimed certs during reset (#54883)",
    "sha": "dae7701b1ab0456dffb46ddc5ca9c917348b5c2a",
    "files": [
        {
            "sha": "0133d904c073f0f07bb0e9d34ed286cbba386996",
            "filename": "api/src/routes/auth-dev.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Froutes%2Fauth-dev.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Froutes%2Fauth-dev.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fauth-dev.test.ts?ref=dae7701b1ab0456dffb46ddc5ca9c917348b5c2a",
            "patch": "@@ -94,7 +94,7 @@ describe('dev login', () => {\n           showPortfolio: false,\n           showTimeLine: false\n         },\n-        progressTimestamps: [],\n+        progressTimestamps: [expect.any(Number)],\n         sendQuincyEmail: false,\n         theme: 'default',\n         username: expect.stringMatching(fccUuidRe),"
        },
        {
            "sha": "23a12260556603335f1e644969afbadf5d3c696a",
            "filename": "api/src/routes/user.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Froutes%2Fuser.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.test.ts?ref=dae7701b1ab0456dffb46ddc5ca9c917348b5c2a",
            "patch": "@@ -402,6 +402,8 @@ describe('userRoutes', () => {\n         expect(userTokens).toHaveLength(1);\n         expect(userTokens[0]?.userId).toBe(otherUserId);\n       });\n+\n+      test.todo('POST resets the user to the default state');\n     });\n \n     describe('/user/user-token', () => {"
        },
        {
            "sha": "e7449692e67e062871aa92cd3b6eb9e2c30ece8f",
            "filename": "api/src/routes/user.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 27,
            "changes": 29,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Froutes%2Fuser.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Froutes%2Fuser.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Froutes%2Fuser.ts?ref=dae7701b1ab0456dffb46ddc5ca9c917348b5c2a",
            "patch": "@@ -22,6 +22,7 @@ import {\n import { encodeUserToken } from '../utils/tokens';\n import { trimTags } from '../utils/validation';\n import { generateReportEmail } from '../utils/email-templates';\n+import { createResetProperties } from '../utils/create-user';\n \n // user flags that the api-server returns as false if they're missing in the\n // user document. Since Prisma returns null for missing fields, we need to\n@@ -148,33 +149,7 @@ export const userRoutes: FastifyPluginCallbackTypebox = (\n         });\n         await fastify.prisma.user.update({\n           where: { id: req.user!.id },\n-          data: {\n-            progressTimestamps: [Date.now()],\n-            currentChallengeId: '',\n-            isRespWebDesignCert: false,\n-            is2018DataVisCert: false,\n-            isFrontEndLibsCert: false,\n-            isJsAlgoDataStructCert: false,\n-            isApisMicroservicesCert: false,\n-            isInfosecQaCert: false,\n-            isQaCertV7: false,\n-            isInfosecCertV7: false,\n-            is2018FullStackCert: false,\n-            isFrontEndCert: false,\n-            isBackEndCert: false,\n-            isDataVisCert: false,\n-            isFullStackCert: false,\n-            isSciCompPyCertV7: false,\n-            isDataAnalysisPyCertV7: false,\n-            isMachineLearningPyCertV7: false,\n-            isRelationalDatabaseCertV8: false,\n-            isCollegeAlgebraPyCertV8: false,\n-            completedChallenges: [],\n-            completedExams: [],\n-            savedChallenges: [],\n-            partiallyCompletedChallenges: [],\n-            needsModeration: false\n-          }\n+          data: createResetProperties()\n         });\n \n         return {};"
        },
        {
            "sha": "0c5fb20008b9c5629dae833556db43d5fe88a737",
            "filename": "api/src/utils/create-user.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 27,
            "changes": 63,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Futils%2Fcreate-user.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/dae7701b1ab0456dffb46ddc5ca9c917348b5c2a/api%2Fsrc%2Futils%2Fcreate-user.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Futils%2Fcreate-user.ts?ref=dae7701b1ab0456dffb46ddc5ca9c917348b5c2a",
            "patch": "@@ -7,6 +7,40 @@ export const nanoidCharSet =\n   '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n const nanoid = customAlphabet(nanoidCharSet, 21);\n \n+/**\n+ * Creates the necessary data to reset a user's properties.\n+ * @returns Default data for resetting a user's properties.\n+ */\n+export const createResetProperties = () => ({\n+  completedChallenges: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n+  completedExams: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n+  currentChallengeId: '',\n+  is2018DataVisCert: false,\n+  is2018FullStackCert: false,\n+  isApisMicroservicesCert: false,\n+  isBackEndCert: false,\n+  isCollegeAlgebraPyCertV8: false,\n+  isDataAnalysisPyCertV7: false,\n+  isDataVisCert: false,\n+  isFoundationalCSharpCertV8: false,\n+  isFrontEndCert: false,\n+  isFrontEndLibsCert: false,\n+  isFullStackCert: false,\n+  isInfosecCertV7: false,\n+  isInfosecQaCert: false,\n+  isJsAlgoDataStructCert: false,\n+  isJsAlgoDataStructCertV8: false,\n+  isMachineLearningPyCertV7: false,\n+  isQaCertV7: false,\n+  isRelationalDatabaseCertV8: false,\n+  isRespWebDesignCert: false,\n+  isSciCompPyCertV7: false,\n+  needsModeration: false,\n+  partiallyCompletedChallenges: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n+  progressTimestamps: [Date.now()], // TODO(Post-MVP): This may need normalising before we can omit it. Also, does it need to start with a timestamp?\n+  savedChallenges: [] // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n+});\n+\n /**\n  * Creates the necessary data to create a new user.\n  * @param email The email address of the new user.\n@@ -22,43 +56,19 @@ export function createUserInput(email: string): Prisma.userCreateInput {\n   return {\n     about: '',\n     acceptedPrivacyTerms: false,\n-    completedChallenges: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n-    completedExams: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n-    currentChallengeId: '',\n     donationEmails: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n     email,\n     emailVerified: true, // this should be true until a user changes their email address\n     // TODO(Post-MVP): remove externalId?\n     externalId,\n-    is2018DataVisCert: false,\n-    is2018FullStackCert: false,\n-    isApisMicroservicesCert: false,\n-    isBackEndCert: false,\n     isBanned: false,\n     isCheater: false,\n-    isDataAnalysisPyCertV7: false,\n-    isDataVisCert: false,\n     isDonating: false,\n-    isFoundationalCSharpCertV8: false,\n-    isFrontEndCert: false,\n-    isFrontEndLibsCert: false,\n-    isFullStackCert: false,\n     isHonest: false,\n-    isInfosecCertV7: false,\n-    isInfosecQaCert: false,\n-    isJsAlgoDataStructCert: false,\n-    isJsAlgoDataStructCertV8: false,\n-    isMachineLearningPyCertV7: false,\n-    isQaCertV7: false,\n-    isRelationalDatabaseCertV8: false,\n-    isCollegeAlgebraPyCertV8: false,\n-    isRespWebDesignCert: false,\n-    isSciCompPyCertV7: false,\n     keyboardShortcuts: false,\n     location: '',\n     name: '',\n     unsubscribeId: nanoid(),\n-    partiallyCompletedChallenges: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n     picture: '',\n     portfolio: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n     profileUI: {\n@@ -73,12 +83,11 @@ export function createUserInput(email: string): Prisma.userCreateInput {\n       showPortfolio: false,\n       showTimeLine: false\n     },\n-    progressTimestamps: [], // TODO(Post-MVP): This may need normalising before we can omit it.\n-    savedChallenges: [], // TODO(Post-MVP): Omit this from the document? (prisma will always return [])\n     sendQuincyEmail: false,\n     theme: 'default',\n     username,\n     usernameDisplay: username,\n-    yearsTopContributor: [] // TODO: Omit this from the document? (prisma will always return [])\n+    yearsTopContributor: [], // TODO: Omit this from the document? (prisma will always return []),\n+    ...createResetProperties()\n   };\n }"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 41,
        "deletions": 55
    }
}