{
    "author": "ojeytonwilliams",
    "message": "feat(api): add plugin allowing server to update cookies (#55395)",
    "sha": "bb95e2ff5478c6a61826241e75cc74612163ace4",
    "files": [
        {
            "sha": "dac6ee88ff4f80776a849066a8a106a5de8d7f87",
            "filename": "api/src/plugins/cookie-update.test.ts",
            "status": "added",
            "additions": 113,
            "deletions": 0,
            "changes": 113,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb95e2ff5478c6a61826241e75cc74612163ace4/api%2Fsrc%2Fplugins%2Fcookie-update.test.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb95e2ff5478c6a61826241e75cc74612163ace4/api%2Fsrc%2Fplugins%2Fcookie-update.test.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookie-update.test.ts?ref=bb95e2ff5478c6a61826241e75cc74612163ace4",
            "patch": "@@ -0,0 +1,113 @@\n+import Fastify, { FastifyInstance } from 'fastify';\n+import cookies, { type CookieSerializeOptions, sign } from './cookies';\n+import { cookieUpdate } from './cookie-update';\n+\n+// eslint-disable-next-line @typescript-eslint/no-unsafe-return\n+jest.mock('../utils/env', () => ({\n+  ...jest.requireActual('../utils/env'),\n+  COOKIE_DOMAIN: 'www.example.com',\n+  FREECODECAMP_NODE_ENV: 'not-development'\n+}));\n+\n+describe('Cookie updates', () => {\n+  let fastify: FastifyInstance;\n+\n+  const setup = async (attributes: CookieSerializeOptions) => {\n+    // Since register creates a new scope, we need to create a route inside the\n+    // scope for the plugin to be applied.\n+    await fastify.register(cookieUpdate, fastify => {\n+      // eslint-disable-next-line @typescript-eslint/require-await\n+      fastify.get('/', async () => {\n+        return { hello: 'world' };\n+      });\n+      return {\n+        cookies: ['cookie_name'],\n+        attributes\n+      };\n+    });\n+  };\n+\n+  beforeEach(async () => {\n+    fastify = Fastify();\n+    await fastify.register(cookies);\n+  });\n+\n+  afterEach(async () => {\n+    await fastify.close();\n+  });\n+\n+  it('should not set cookies that are not in the request', async () => {\n+    await setup({});\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      headers: {\n+        cookie: 'cookie_name_two=cookie_value'\n+      }\n+    });\n+\n+    expect(res.headers['set-cookie']).toBeUndefined();\n+  });\n+\n+  it(\"should update the cookie's attributes without changing the value\", async () => {\n+    await setup({ sameSite: 'strict' });\n+    const signedCookie = sign('cookie_value');\n+    const encodedCookie = encodeURIComponent(signedCookie);\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      headers: {\n+        cookie: `cookie_name=${signedCookie}`\n+      }\n+    });\n+\n+    const updatedCookie = res.headers['set-cookie'] as string;\n+    expect(updatedCookie).toEqual(\n+      expect.stringContaining(`cookie_name=${encodedCookie}`)\n+    );\n+    expect(updatedCookie).toEqual(expect.stringContaining('SameSite=Strict'));\n+  });\n+\n+  it('should unsign the cookie if required', async () => {\n+    await setup({ signed: false });\n+    const signedCookie = sign('cookie_value');\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      headers: {\n+        cookie: `cookie_name=${signedCookie}`\n+      }\n+    });\n+\n+    const updatedCookie = res.headers['set-cookie'] as string;\n+    expect(updatedCookie).toEqual(\n+      expect.stringContaining('cookie_name=cookie_value')\n+    );\n+  });\n+\n+  it('should respect the default cookie config if not overriden', async () => {\n+    await setup({});\n+\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      headers: {\n+        cookie: 'cookie_name=anything'\n+      }\n+    });\n+\n+    expect(res.cookies[0]).toStrictEqual({\n+      domain: 'www.example.com',\n+      httpOnly: true,\n+      name: 'cookie_name',\n+      path: '/',\n+      sameSite: 'Lax',\n+      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n+      value: expect.any(String),\n+      secure: true\n+    });\n+  });\n+});"
        },
        {
            "sha": "65de3f69085c7e156d06a8c7b3feba5a0be41c10",
            "filename": "api/src/plugins/cookie-update.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb95e2ff5478c6a61826241e75cc74612163ace4/api%2Fsrc%2Fplugins%2Fcookie-update.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb95e2ff5478c6a61826241e75cc74612163ace4/api%2Fsrc%2Fplugins%2Fcookie-update.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookie-update.ts?ref=bb95e2ff5478c6a61826241e75cc74612163ace4",
            "patch": "@@ -0,0 +1,37 @@\n+import { FastifyPluginCallback } from 'fastify';\n+\n+import type { CookieSerializeOptions } from './cookies';\n+\n+type Options = { cookies: string[]; attributes: CookieSerializeOptions };\n+\n+/**\n+ * Plugin that updates the attributes of cookies in the response, without\n+ * changing the value.\n+ *\n+ * @param fastify The Fastify instance.\n+ * @param options Options passed to the plugin via `fastify.register(plugin,\n+ * options)`.\n+ * @param options.cookies The names of the cookies to update.\n+ * @param options.attributes The attributes to update the cookies with. NOTE:\n+ * The attributes are merged with the default values given to \\@fastify/cookie.\n+ * @param done Callback to signal that the logic has completed.\n+ */\n+export const cookieUpdate: FastifyPluginCallback<Options> = (\n+  fastify,\n+  options,\n+  done\n+) => {\n+  fastify.addHook('onSend', (request, reply, _payload, next) => {\n+    for (const cookie of options.cookies) {\n+      const oldCookie = request.cookies[cookie];\n+      if (!oldCookie) continue;\n+\n+      const unsigned = reply.unsignCookie(oldCookie);\n+      const raw = unsigned.valid ? unsigned.value : oldCookie;\n+      void reply.setCookie(cookie, raw, options.attributes);\n+    }\n+    next();\n+  });\n+\n+  done();\n+};"
        },
        {
            "sha": "5203614c9db6d6cbe802a599e3c63001eb17a9dd",
            "filename": "api/src/plugins/cookies.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/bb95e2ff5478c6a61826241e75cc74612163ace4/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/bb95e2ff5478c6a61826241e75cc74612163ace4/api%2Fsrc%2Fplugins%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/api%2Fsrc%2Fplugins%2Fcookies.ts?ref=bb95e2ff5478c6a61826241e75cc74612163ace4",
            "patch": "@@ -8,6 +8,8 @@ import {\n   FREECODECAMP_NODE_ENV\n } from '../utils/env';\n \n+export { type CookieSerializeOptions } from '@fastify/cookie';\n+\n /**\n  * Signs a cookie value by prefixing it with \"s:\" and using the COOKIE_SECRET.\n  *"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 152,
        "deletions": 0
    }
}