{
    "author": "ojeytonwilliams",
    "message": "refactor: control character from scene (#58551)",
    "sha": "25c964abc012c93aa6f1624afa6e25841c5d88fa",
    "files": [
        {
            "sha": "133c2235c1396d91adca14e115adc84e00621ddf",
            "filename": "client/src/templates/Challenges/components/scene/character.tsx",
            "status": "modified",
            "additions": 34,
            "deletions": 18,
            "changes": 52,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fcharacter.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fcharacter.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fcharacter.tsx?ref=25c964abc012c93aa6f1624afa6e25841c5d88fa",
            "patch": "@@ -3,13 +3,14 @@ import { Characters, CharacterPosition } from '../../../../redux/prop-types';\n import { characterAssets } from './scene-assets';\n \n import './character.css';\n+import { SceneSubject } from './scene-subject';\n \n interface CharacterProps {\n   position: CharacterPosition;\n   opacity: number;\n   name: Characters;\n-  isBlinking: boolean;\n   isTalking: boolean;\n+  sceneSubject: SceneSubject;\n }\n \n interface CharacterStyles {\n@@ -27,39 +28,54 @@ export function Character({\n   position,\n   opacity,\n   name,\n-  isBlinking,\n-  isTalking\n+  isTalking,\n+  sceneSubject\n }: CharacterProps): JSX.Element {\n   const [eyesAreOpen, setEyesAreOpen] = useState(true);\n   const [mouthIsOpen, setMouthIsOpen] = useState(false);\n+  const [isPlaying, setIsPlaying] = useState(false);\n+\n+  const onNotify = (eventType: 'play' | 'stop') => {\n+    if (eventType === 'play') {\n+      setIsPlaying(true);\n+    } else {\n+      setIsPlaying(false);\n+    }\n+  };\n+\n+  useEffect(() => {\n+    sceneSubject.attach(onNotify);\n+    return () => {\n+      sceneSubject.detach(onNotify);\n+    };\n+  }, [sceneSubject]);\n \n   useEffect(() => {\n-    let blinkIntervalId: NodeJS.Timeout;\n+    if (!isPlaying) return;\n     let blinkTimeoutId: NodeJS.Timeout;\n \n-    if (isBlinking) {\n-      const blinkPeriod = getRandomInt(2000, 5000);\n-      blinkIntervalId = setInterval(() => {\n-        const blinkJitter = getRandomInt(0, 1000);\n-        blinkTimeoutId = setTimeout(() => {\n-          setEyesAreOpen(false);\n+    const blinkPeriod = getRandomInt(2000, 5000);\n+    const blinkIntervalId = setInterval(() => {\n+      const blinkJitter = getRandomInt(0, 1000);\n+      blinkTimeoutId = setTimeout(() => {\n+        setEyesAreOpen(false);\n \n-          blinkTimeoutId = setTimeout(() => {\n-            setEyesAreOpen(true);\n-          }, 30); // always unblink after 30ms\n-        }, blinkJitter);\n-      }, blinkPeriod);\n-    }\n+        blinkTimeoutId = setTimeout(() => {\n+          setEyesAreOpen(true);\n+        }, 30); // always unblink after 30ms\n+      }, blinkJitter);\n+    }, blinkPeriod);\n \n     // Clear intervals when component is unmounted or conditions change\n     return () => {\n       setEyesAreOpen(true);\n       clearInterval(blinkIntervalId);\n       clearTimeout(blinkTimeoutId);\n     };\n-  }, [isBlinking]);\n+  }, [isPlaying]);\n \n   useEffect(() => {\n+    if (!isPlaying) return;\n     let talkIntervalId: NodeJS.Timeout;\n     let mouthOpenTimeoutId: NodeJS.Timeout;\n     let mouthCloseTimeoutId: NodeJS.Timeout;\n@@ -91,7 +107,7 @@ export function Character({\n       clearTimeout(mouthOpenTimeoutId);\n       clearTimeout(mouthCloseTimeoutId);\n     };\n-  }, [isTalking]);\n+  }, [isTalking, isPlaying]);\n \n   const characterWrapStyles: CharacterStyles = {\n     opacity"
        },
        {
            "sha": "24e04b06994a7b916ac607cb225825e64ea943f5",
            "filename": "client/src/templates/Challenges/components/scene/scene-subject.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene-subject.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene-subject.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene-subject.tsx?ref=25c964abc012c93aa6f1624afa6e25841c5d88fa",
            "patch": "@@ -1,4 +1,4 @@\n-type Observer = () => void;\n+type Observer = (eventType: 'play' | 'stop') => void;\n \n export class SceneSubject {\n   #observers: Observer[];\n@@ -16,7 +16,7 @@ export class SceneSubject {\n \n   // For now, we don't need to pass any data to the observers, so notify()\n   // doesn't take any arguments.\n-  notify() {\n-    this.#observers.forEach(observer => observer());\n+  notify(eventType: 'play' | 'stop') {\n+    this.#observers.forEach(observer => observer(eventType));\n   }\n }"
        },
        {
            "sha": "34bda2298abb9e245e3399bf1b832dfc3a8ea013",
            "filename": "client/src/templates/Challenges/components/scene/scene.tsx",
            "status": "modified",
            "additions": 23,
            "deletions": 8,
            "changes": 31,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fcomponents%2Fscene%2Fscene.tsx?ref=25c964abc012c93aa6f1624afa6e25841c5d88fa",
            "patch": "@@ -153,7 +153,7 @@ export function Scene({\n     canPauseRef.current = false;\n   };\n \n-  const playScene = useCallback(() => {\n+  const handlePlay = useCallback(() => {\n     const updateCurrentTime = () => {\n       const time = Date.now() - startRef.current;\n       setCurrentTime(time);\n@@ -207,9 +207,9 @@ export function Scene({\n       },\n       duration + sToMs(audio.startTime)\n     );\n-  }, [isPlaying, sceneIsReady, audio, duration]);\n+  }, [audio, duration, isPlaying, sceneIsReady]);\n \n-  const resetScene = useCallback(() => {\n+  const handleStop = useCallback(() => {\n     usedCommandsRef.current.clear();\n     pause();\n     audioRef.current.currentTime = audio.startTimestamp || 0;\n@@ -222,12 +222,27 @@ export function Scene({\n     setBackground(initBackground);\n   }, [audio, initCharacters, initBackground]);\n \n+  const onNotify = useCallback(\n+    (eventType: 'play' | 'stop') => {\n+      if (eventType === 'play') {\n+        handlePlay();\n+      } else {\n+        handleStop();\n+      }\n+    },\n+    [handlePlay, handleStop]\n+  );\n+\n+  const resetScene = useCallback(() => {\n+    sceneSubject.notify('stop');\n+  }, [sceneSubject]);\n+\n   useEffect(() => {\n-    sceneSubject.attach(playScene);\n+    sceneSubject.attach(onNotify);\n     return () => {\n-      sceneSubject.detach(playScene);\n+      sceneSubject.detach(onNotify);\n     };\n-  }, [playScene, sceneSubject]);\n+  }, [onNotify, sceneSubject]);\n \n   useEffect(() => {\n     if (isEmpty(sortedCommands)) return;\n@@ -306,8 +321,8 @@ export function Scene({\n                     name={character}\n                     position={position}\n                     opacity={opacity}\n+                    sceneSubject={sceneSubject}\n                     isTalking={isTalking}\n-                    isBlinking={isPlaying}\n                   />\n                 );\n               }\n@@ -328,7 +343,7 @@ export function Scene({\n               <div className='scene-start-screen'>\n                 <button\n                   className='scene-start-btn scene-play-btn'\n-                  onClick={() => sceneSubject.notify()}\n+                  onClick={() => sceneSubject.notify('play')}\n                 >\n                   <img\n                     src={`${images}/play-button.png`}"
        },
        {
            "sha": "71231c9d3650cf15c74e7d4f4dc4cc62844739d6",
            "filename": "client/src/templates/Challenges/generic/show.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/freeCodeCamp/freeCodeCamp/blob/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fgeneric%2Fshow.tsx",
            "raw_url": "https://github.com/freeCodeCamp/freeCodeCamp/raw/25c964abc012c93aa6f1624afa6e25841c5d88fa/client%2Fsrc%2Ftemplates%2FChallenges%2Fgeneric%2Fshow.tsx",
            "contents_url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp/contents/client%2Fsrc%2Ftemplates%2FChallenges%2Fgeneric%2Fshow.tsx?ref=25c964abc012c93aa6f1624afa6e25841c5d88fa",
            "patch": "@@ -198,7 +198,7 @@ const ShowGeneric = ({\n     <Hotkeys\n       executeChallenge={handleSubmit}\n       containerRef={container}\n-      playScene={scene ? () => sceneSubject.notify() : undefined}\n+      playScene={scene ? () => sceneSubject.notify('play') : undefined}\n     >\n       <LearnLayout>\n         <Helmet"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 61,
        "deletions": 30
    }
}