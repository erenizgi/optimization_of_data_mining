{
    "author": "winglian",
    "message": "pass module to Params4bit.from_prequantized to ensure quant_state (#32524)\n\n* pass module to Params4bit.from_prequantized to ensure quant_state\r\n\r\n* make sure to check bnb version\r\n\r\n* revert min bnb version and use inspect on method instead\r\n\r\n* use version instead of inspect to prevent performance hit\r\n\r\n* make the property name readable",
    "sha": "39bfb2f514274e95664b7b6fd4efd1e7405bd2ed",
    "files": [
        {
            "sha": "827ca310f35a1a481da7135be07cccdd5d8a25ee",
            "filename": "src/transformers/quantizers/quantizer_bnb_4bit.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/huggingface/transformers/blob/39bfb2f514274e95664b7b6fd4efd1e7405bd2ed/src%2Ftransformers%2Fquantizers%2Fquantizer_bnb_4bit.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/39bfb2f514274e95664b7b6fd4efd1e7405bd2ed/src%2Ftransformers%2Fquantizers%2Fquantizer_bnb_4bit.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fquantizers%2Fquantizer_bnb_4bit.py?ref=39bfb2f514274e95664b7b6fd4efd1e7405bd2ed",
            "patch": "@@ -12,6 +12,7 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n import importlib\n+from functools import cached_property\n from typing import TYPE_CHECKING, Any, Dict, List, Optional, Union\n \n from packaging import version\n@@ -207,11 +208,16 @@ def create_quantized_param(\n                     if unexpected_keys is not None and k in unexpected_keys:\n                         unexpected_keys.remove(k)\n \n+            param_kwargs = {}\n+            if self.is_bnb_supports_quant_storage_module:\n+                param_kwargs[\"module\"] = module\n+\n             new_value = bnb.nn.Params4bit.from_prequantized(\n                 data=param_value,\n                 quantized_stats=quantized_stats,\n                 requires_grad=False,\n                 device=target_device,\n+                **param_kwargs,\n             )\n         else:\n             new_value = param_value.to(\"cpu\")\n@@ -318,6 +324,15 @@ def is_serializable(self):\n \n         return True\n \n+    @cached_property\n+    def is_bnb_supports_quant_storage_module(self) -> bool:\n+        \"\"\"\n+        determines if the current version of bitsandbytes supports\n+        the `module` parameter in `Params4bit.from_prequantized`\n+        :return:\n+        \"\"\"\n+        return version.parse(importlib.metadata.version(\"bitsandbytes\")) >= version.parse(\"0.43.3\")\n+\n     @property\n     def is_trainable(self) -> bool:\n         return True"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 15,
        "deletions": 0
    }
}