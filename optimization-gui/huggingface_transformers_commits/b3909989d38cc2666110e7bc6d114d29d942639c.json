{
    "author": "matthewdouglas",
    "message": "Fix excessive CPU memory usage with FSDP and cpu_ram_efficient_loading (#33154)",
    "sha": "b3909989d38cc2666110e7bc6d114d29d942639c",
    "files": [
        {
            "sha": "2faa60210ed4d71647924bdaf42a1e2f8158cc01",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/b3909989d38cc2666110e7bc6d114d29d942639c/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b3909989d38cc2666110e7bc6d114d29d942639c/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=b3909989d38cc2666110e7bc6d114d29d942639c",
            "patch": "@@ -958,6 +958,9 @@ def _load_state_dict_into_meta_model(\n                 )\n             )\n         ):\n+            if is_fsdp_enabled():\n+                param_device = \"cpu\" if is_local_dist_rank_0() else \"meta\"\n+\n             # For backward compatibility with older versions of `accelerate` and for non-quantized params\n             set_module_tensor_to_device(model, param_name, param_device, **set_module_kwargs)\n         else:\n@@ -968,7 +971,10 @@ def _load_state_dict_into_meta_model(\n             if is_fsdp_enabled() or is_deepspeed_zero3_enabled():\n                 module, tensor_name = get_module_from_name(model, param_name)\n                 value = getattr(module, tensor_name)\n-                value = type(value)(value.data.to(\"cpu\"), **value.__dict__)\n+                param_to = \"cpu\"\n+                if is_fsdp_enabled() and not is_local_dist_rank_0():\n+                    param_to = \"meta\"\n+                value = type(value)(value.data.to(param_to), **value.__dict__)\n                 setattr(module, tensor_name, value)\n             # TODO: consider removing used param_parts from state_dict before return\n "
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}