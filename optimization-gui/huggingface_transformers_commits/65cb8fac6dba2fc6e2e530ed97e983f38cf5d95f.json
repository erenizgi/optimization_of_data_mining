{
    "author": "HollowMan6",
    "message": "[Qwen3VL] fix: hidden_states in place modification error (#41535)\n\n```\n  File \"transformers/models/qwen3_vl_moe/modeling_qwen3_vl_moe.py\", line 941, in forward\n    hidden_states = self._deepstack_process(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"transformers/models/qwen3_vl_moe/modeling_qwen3_vl_moe.py\", line 960, in _deepstack_process\n    hidden_states[visual_pos_masks, :] = local_this\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\nRuntimeError: Output 0 of SliceBackward0 is a view and is being modified inplace. This view was created inside a custom Function (or because an input was returned as-is) and the autograd logic to handle view+inplace would override the custom backward associated with the custom Function, leading to incorrect gradients. This behavior is forbidden. You can fix this by cloning the output of the custom Function.\n```\n\nSigned-off-by: Hollow Man <hollowman@opensuse.org>",
    "sha": "65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f",
    "files": [
        {
            "sha": "6d8ad757b968167c0643338f1ddbaaff32097ba8",
            "filename": "src/transformers/models/qwen3_omni_moe/modeling_qwen3_omni_moe.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_omni_moe%2Fmodeling_qwen3_omni_moe.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_omni_moe%2Fmodeling_qwen3_omni_moe.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fqwen3_omni_moe%2Fmodeling_qwen3_omni_moe.py?ref=65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f",
            "patch": "@@ -1694,7 +1694,8 @@ def _deepstack_process(self, hidden_states, visual_pos_masks, visual_embeds):\n         visual_pos_masks = visual_pos_masks[..., 0]\n         visual_pos_masks = visual_pos_masks.to(hidden_states.device)\n         visual_embeds = visual_embeds.to(hidden_states.device, hidden_states.dtype)\n-        local_this = hidden_states[visual_pos_masks, :].clone() + visual_embeds\n+        hidden_states = hidden_states.clone()\n+        local_this = hidden_states[visual_pos_masks, :] + visual_embeds\n         hidden_states[visual_pos_masks, :] = local_this\n         return hidden_states\n \n@@ -2888,7 +2889,8 @@ def _deepstack_process(\n     ):\n         visual_pos_masks = visual_pos_masks.to(hidden_states.device)\n         visual_embeds = visual_embeds.to(hidden_states.device, hidden_states.dtype)\n-        local_this = hidden_states[visual_pos_masks, :].clone() + visual_embeds\n+        hidden_states = hidden_states.clone()\n+        local_this = hidden_states[visual_pos_masks, :] + visual_embeds\n         hidden_states[visual_pos_masks, :] = local_this\n         return hidden_states\n "
        },
        {
            "sha": "bba6c6cd37e3a83fd042e894bbd731b12f6c704c",
            "filename": "src/transformers/models/qwen3_vl/modeling_qwen3_vl.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_vl%2Fmodeling_qwen3_vl.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_vl%2Fmodeling_qwen3_vl.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fqwen3_vl%2Fmodeling_qwen3_vl.py?ref=65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f",
            "patch": "@@ -876,7 +876,8 @@ def _deepstack_process(\n     ):\n         visual_pos_masks = visual_pos_masks.to(hidden_states.device)\n         visual_embeds = visual_embeds.to(hidden_states.device, hidden_states.dtype)\n-        local_this = hidden_states[visual_pos_masks, :].clone() + visual_embeds\n+        hidden_states = hidden_states.clone()\n+        local_this = hidden_states[visual_pos_masks, :] + visual_embeds\n         hidden_states[visual_pos_masks, :] = local_this\n         return hidden_states\n "
        },
        {
            "sha": "9875aca00699829b0c95d3d29bdaa5bbe0f22a02",
            "filename": "src/transformers/models/qwen3_vl/modular_qwen3_vl.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_vl%2Fmodular_qwen3_vl.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_vl%2Fmodular_qwen3_vl.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fqwen3_vl%2Fmodular_qwen3_vl.py?ref=65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f",
            "patch": "@@ -746,7 +746,8 @@ def _deepstack_process(\n     ):\n         visual_pos_masks = visual_pos_masks.to(hidden_states.device)\n         visual_embeds = visual_embeds.to(hidden_states.device, hidden_states.dtype)\n-        local_this = hidden_states[visual_pos_masks, :].clone() + visual_embeds\n+        hidden_states = hidden_states.clone()\n+        local_this = hidden_states[visual_pos_masks, :] + visual_embeds\n         hidden_states[visual_pos_masks, :] = local_this\n         return hidden_states\n "
        },
        {
            "sha": "7bfbdb5dfb4d6576734504258ec7fa6c6df992af",
            "filename": "src/transformers/models/qwen3_vl_moe/modeling_qwen3_vl_moe.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_vl_moe%2Fmodeling_qwen3_vl_moe.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f/src%2Ftransformers%2Fmodels%2Fqwen3_vl_moe%2Fmodeling_qwen3_vl_moe.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fqwen3_vl_moe%2Fmodeling_qwen3_vl_moe.py?ref=65cb8fac6dba2fc6e2e530ed97e983f38cf5d95f",
            "patch": "@@ -957,7 +957,8 @@ def _deepstack_process(\n     ):\n         visual_pos_masks = visual_pos_masks.to(hidden_states.device)\n         visual_embeds = visual_embeds.to(hidden_states.device, hidden_states.dtype)\n-        local_this = hidden_states[visual_pos_masks, :].clone() + visual_embeds\n+        hidden_states = hidden_states.clone()\n+        local_this = hidden_states[visual_pos_masks, :] + visual_embeds\n         hidden_states[visual_pos_masks, :] = local_this\n         return hidden_states\n "
        }
    ],
    "stats": {
        "total": 15,
        "additions": 10,
        "deletions": 5
    }
}