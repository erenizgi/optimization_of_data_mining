{
    "author": "ArthurZucker",
    "message": "make it go brrrr (#38409)\n\n* make it go brrrr\n\n* date time\n\n* update\n\n* fix\n\n* up\n\n* uppp\n\n* up\n\n* no number i\n\n* udpate\n\n* fix\n\n* [paligemma] fix processor with suffix (#38365)\n\nfix pg processor\n\n* [video utils] group and reorder by number of frames (#38374)\n\nfix\n\n* Fix convert to original state dict for VLMs (#38385)\n\n* fix convert to original state dict\n\n* fix\n\n* lint\n\n* Update modeling_utils.py\n\n* update\n\n* warn\n\n* no verbose\n\n* fginal\n\n* ouft\n\n* style\n\n---------\n\nCo-authored-by: Raushan Turganbay <raushan@huggingface.co>\nCo-authored-by: hoshi-hiyouga <hiyouga@buaa.edu.cn>",
    "sha": "858ce6879a4aa7fa76a7c4e2ac20388e087ace26",
    "files": [
        {
            "sha": "9b7b4b0b569b473593a1e18f6066ced5976abe64",
            "filename": "utils/patch_helper.py",
            "status": "modified",
            "additions": 111,
            "deletions": 51,
            "changes": 162,
            "blob_url": "https://github.com/huggingface/transformers/blob/858ce6879a4aa7fa76a7c4e2ac20388e087ace26/utils%2Fpatch_helper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/858ce6879a4aa7fa76a7c4e2ac20388e087ace26/utils%2Fpatch_helper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fpatch_helper.py?ref=858ce6879a4aa7fa76a7c4e2ac20388e087ace26",
            "patch": "@@ -35,61 +35,121 @@\n ```\n \"\"\"\n \n-import argparse\n+import json\n+import subprocess\n \n-from git import GitCommandError, Repo\n-from packaging import version\n+import transformers\n \n \n-def get_merge_commit(repo, pr_number, since_tag):\n+LABEL = \"for patch\"  # Replace with your label\n+REPO = \"huggingface/transformers\"  # Optional if already in correct repo\n+\n+\n+def get_release_branch_name():\n+    \"\"\"Derive branch name from transformers version.\"\"\"\n+    major, minor, *_ = transformers.__version__.split(\".\")\n+    major = int(major)\n+    minor = int(minor)\n+\n+    if minor == 0:\n+        # Handle major version rollback, e.g., from 5.0 to 4.latest (if ever needed)\n+        major -= 1\n+        # You'll need logic to determine the last minor of the previous major version\n+        raise ValueError(\"Minor version is 0; need logic to find previous major version's last minor\")\n+    else:\n+        minor -= 1\n+\n+    return f\"v{major}.{minor}-release\"\n+\n+\n+def checkout_branch(branch):\n+    \"\"\"Checkout the target branch.\"\"\"\n     try:\n-        # Use git log to find the merge commit for the PR within the given tag range\n-        merge_commit = next(repo.iter_commits(f\"v{since_tag}...origin/main\", grep=f\"#{pr_number}\"))\n-        return merge_commit\n-    except StopIteration:\n-        print(f\"No merge commit found for PR #{pr_number} between tags {since_tag} and {main}\")\n-        return None\n-    except GitCommandError as e:\n-        print(f\"Error finding merge commit for PR #{pr_number}: {str(e)}\")\n-        return None\n-\n-\n-def main(pr_numbers):\n-    repo = Repo(\".\")  # Initialize the Repo object for the current directory\n-    merge_commits = []\n-\n-    tags = {}\n-    for tag in repo.tags:\n-        try:\n-            # Parse and sort tags, skip invalid ones\n-            tag_ver = version.parse(tag.name)\n-            tags[tag_ver] = tag\n-        except Exception:\n-            print(f\"Skipping invalid version tag: {tag.name}\")\n-\n-    last_tag = sorted(tags)[-1]\n-    major_minor = f\"{last_tag.major}.{last_tag.minor}.0\"\n-    # Iterate through tag ranges to find the merge commits\n-    for pr in pr_numbers:\n-        pr = pr.split(\"https://github.com/huggingface/transformers/pull/\")[-1]\n-        commit = get_merge_commit(repo, pr, major_minor)\n-        if commit:\n-            merge_commits.append(commit)\n-\n-    # Sort commits by date\n-    merge_commits.sort(key=lambda commit: commit.committed_datetime)\n-\n-    # Output the git cherry-pick commands\n-    print(\"Git cherry-pick commands to run:\")\n-    for commit in merge_commits:\n-        print(f\"git cherry-pick {commit.hexsha} #{commit.committed_datetime}\")\n+        subprocess.run([\"git\", \"checkout\", branch], check=True)\n+        print(f\"‚úÖ Checked out branch: {branch}\")\n+    except subprocess.CalledProcessError:\n+        print(f\"‚ùå Failed to checkout branch: {branch}. Does it exist?\")\n+        exit(1)\n \n \n-if __name__ == \"__main__\":\n-    parser = argparse.ArgumentParser(description=\"Find and sort merge commits for specified PRs.\")\n-    parser.add_argument(\"--prs\", nargs=\"+\", required=False, type=str, help=\"PR numbers to find merge commits for\")\n+def get_prs_by_label(label):\n+    \"\"\"Call gh CLI to get PRs with a specific label.\"\"\"\n+    cmd = [\n+        \"gh\",\n+        \"pr\",\n+        \"list\",\n+        \"--label\",\n+        label,\n+        \"--state\",\n+        \"all\",\n+        \"--json\",\n+        \"number,title,mergeCommit,url\",\n+        \"--limit\",\n+        \"100\",\n+    ]\n+    result = subprocess.run(cmd, capture_output=True, text=True)\n+    result.check_returncode()\n+    prs = json.loads(result.stdout)\n+    for pr in prs:\n+        is_merged = pr.get(\"mergeCommit\", {})\n+        if is_merged:\n+            pr[\"oid\"] = is_merged.get(\"oid\")\n+    return prs\n+\n+\n+def get_commit_timestamp(commit_sha):\n+    \"\"\"Get UNIX timestamp of a commit using git.\"\"\"\n+    result = subprocess.run([\"git\", \"show\", \"-s\", \"--format=%ct\", commit_sha], capture_output=True, text=True)\n+    result.check_returncode()\n+    return int(result.stdout.strip())\n \n-    args = parser.parse_args()\n-    if args.prs is None:\n-        args.prs = \"https://github.com/huggingface/transformers/pull/33753  https://github.com/huggingface/transformers/pull/33861  https://github.com/huggingface/transformers/pull/33906  https://github.com/huggingface/transformers/pull/33761  https://github.com/huggingface/transformers/pull/33586  https://github.com/huggingface/transformers/pull/33766  https://github.com/huggingface/transformers/pull/33958 https://github.com/huggingface/transformers/pull/33965\".split()\n-    main(args.prs)\n+\n+def cherry_pick_commit(sha):\n+    \"\"\"Cherry-pick a given commit SHA.\"\"\"\n+    try:\n+        subprocess.run([\"git\", \"cherry-pick\", sha], check=True)\n+        print(f\"‚úÖ Cherry-picked commit {sha}\")\n+    except subprocess.CalledProcessError:\n+        print(f\"‚ö†Ô∏è Failed to cherry-pick {sha}. Manual intervention required.\")\n+\n+\n+def commit_in_history(commit_sha, base_branch=\"HEAD\"):\n+    \"\"\"Return True if commit is already part of base_branch history.\"\"\"\n+    result = subprocess.run(\n+        [\"git\", \"merge-base\", \"--is-ancestor\", commit_sha, base_branch],\n+        stdout=subprocess.DEVNULL,\n+        stderr=subprocess.DEVNULL,\n+    )\n+    return result.returncode == 0\n+\n+\n+def main(verbose=False):\n+    branch = get_release_branch_name()\n+    checkout_branch(branch)\n+    prs = get_prs_by_label(LABEL)\n+    # Attach commit timestamps\n+    for pr in prs:\n+        sha = pr.get(\"oid\")\n+        if sha:\n+            pr[\"timestamp\"] = get_commit_timestamp(sha)\n+        else:\n+            print(\"\\n\" + \"=\" * 80)\n+            print(f\"‚ö†Ô∏è  WARNING: PR #{pr['number']} ({sha}) is NOT in main!\")\n+            print(\"‚ö†Ô∏è  A core maintainer must review this before cherry-picking.\")\n+            print(\"=\" * 80 + \"\\n\")\n+    # Sort by commit timestamp (ascending)\n+    prs = [pr for pr in prs if pr.get(\"timestamp\") is not None]\n+    prs.sort(key=lambda pr: pr[\"timestamp\"])\n+    for pr in prs:\n+        sha = pr.get(\"oid\")\n+        if sha:\n+            if commit_in_history(sha):\n+                if verbose:\n+                    print(f\"üîÅ PR #{pr['number']} ({pr['title']}) already in history. Skipping.\")\n+            else:\n+                print(f\"üöÄ PR #{pr['number']} ({pr['title']}) not in history. Cherry-picking...\")\n+                cherry_pick_commit(sha)\n+\n+\n+if __name__ == \"__main__\":\n+    main()"
        }
    ],
    "stats": {
        "total": 162,
        "additions": 111,
        "deletions": 51
    }
}