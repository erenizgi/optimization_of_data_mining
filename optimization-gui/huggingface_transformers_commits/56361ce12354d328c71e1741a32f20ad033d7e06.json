{
    "author": "ydshieh",
    "message": "run all test files on CircleCI (#43146)\n\n* update\n\n* update\n\n* update\n\n* update\n\n* create constant\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\nCo-authored-by: Cyril Vallez <cyril.vallez@gmail.com>",
    "sha": "56361ce12354d328c71e1741a32f20ad033d7e06",
    "files": [
        {
            "sha": "594fa762025bbcee561c1d5b16d4622f519ec3fc",
            "filename": "tests/repo_utils/test_tests_fetcher.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/56361ce12354d328c71e1741a32f20ad033d7e06/tests%2Frepo_utils%2Ftest_tests_fetcher.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/56361ce12354d328c71e1741a32f20ad033d7e06/tests%2Frepo_utils%2Ftest_tests_fetcher.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Frepo_utils%2Ftest_tests_fetcher.py?ref=56361ce12354d328c71e1741a32f20ad033d7e06",
            "patch": "@@ -645,7 +645,7 @@ def test_infer_tests_to_run(self):\n             assert set(example_tests_to_run.split(\" \")) == example_tests\n \n             with patch_transformer_repo_path(tmp_folder):\n-                infer_tests_to_run(tmp_folder / \"test-output.txt\", filter_models=False)\n+                infer_tests_to_run(tmp_folder / \"test-output.txt\")\n                 with open(tmp_folder / \"test-output.txt\") as f:\n                     tests_to_run = f.read()\n                 with open(tmp_folder / \"examples_test_list.txt\") as f:"
        },
        {
            "sha": "fc76e2ea4308a09f3c70822f5cb15a450ef3a872",
            "filename": "utils/tests_fetcher.py",
            "status": "modified",
            "additions": 19,
            "deletions": 53,
            "changes": 72,
            "blob_url": "https://github.com/huggingface/transformers/blob/56361ce12354d328c71e1741a32f20ad033d7e06/utils%2Ftests_fetcher.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/56361ce12354d328c71e1741a32f20ad033d7e06/utils%2Ftests_fetcher.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ftests_fetcher.py?ref=56361ce12354d328c71e1741a32f20ad033d7e06",
            "patch": "@@ -59,8 +59,8 @@\n \n from git import Repo\n \n+\n # List here the models not to be filtered by `filter_tests`.\n-from important_files import IMPORTANT_MODELS\n \n \n PATH_TO_REPO = Path(__file__).parent.parent.resolve()\n@@ -69,8 +69,16 @@\n PATH_TO_TESTS = PATH_TO_REPO / \"tests\"\n \n # The value is just a heuristic to determine if we `guess` all models are impacted.\n-# This variable has effect only if `filter_models=False`.\n-NUM_MODELS_TO_TRIGGER_FULL_CI = 30\n+NUM_MODELS_TO_TRIGGER_FULL_CI = 15\n+\n+# A list of very important files that should trigger all tests if modified (because they can have impact almost anywhere\n+# in the library)\n+CORE_FILES = (\n+    \"setup.py\",\n+    \".circleci/create_circleci_config.py\",\n+    \"src/transformers/modeling_utils.py\",\n+    \"src/transformers/core_model_loading.py\",\n+)\n \n \n @contextmanager\n@@ -876,18 +884,14 @@ def create_reverse_dependency_map() -> dict[str, list[str]]:\n     return reverse_map\n \n \n-def create_module_to_test_map(\n-    reverse_map: dict[str, list[str]] | None = None, filter_models: bool = False\n-) -> dict[str, list[str]]:\n+def create_module_to_test_map(reverse_map: dict[str, list[str]] | None = None) -> dict[str, list[str]]:\n     \"\"\"\n     Extract the tests from the reverse_dependency_map and potentially filters the model tests.\n \n     Args:\n         reverse_map (`Dict[str, List[str]]`, *optional*):\n             The reverse dependency map as created by `create_reverse_dependency_map`. Will default to the result of\n             that function if not provided.\n-        filter_models (`bool`, *optional*, defaults to `False`):\n-            Whether or not to filter model tests to only include core models if a file impacts a lot of models.\n \n     Returns:\n         `Dict[str, List[str]]`: A dictionary that maps each file to the tests to execute if that file was modified.\n@@ -906,38 +910,7 @@ def is_test(fname):\n     # Build the test map\n     test_map = {module: [f for f in deps if is_test(f)] for module, deps in reverse_map.items()}\n \n-    if not filter_models:\n-        return test_map\n-\n-    # Now we deal with the filtering if `filter_models` is True.\n-    num_model_tests = len(list(PATH_TO_TESTS.glob(\"models/*\")))\n-\n-    def has_many_models(tests):\n-        # We filter to core models when a given file impacts more than half the model tests.\n-        model_tests = {Path(t).parts[2] for t in tests if t.startswith(\"tests/models/\")}\n-        return len(model_tests) > num_model_tests // 2\n-\n-    # for each module (if specified in the argument `module`) of the form `models/my_model` (i.e. starting with it),\n-    # we always keep the tests (those are already in the argument `tests`) which are in `tests/models/my_model`.\n-    # This is to avoid them being excluded when a module has many impacted tests: the directly related test files should\n-    # always be included!\n-    def filter_tests(tests, module=\"\"):\n-        filtered_tests = []\n-        for t in tests:\n-            if (\n-                not t.startswith(\"tests/models/\")\n-                or Path(t).parts[2] in IMPORTANT_MODELS\n-                # at this point, `t` is of the form `tests/models/my_model`, and we check if `models/my_model`\n-                # (i.e. `parts[1:3]`) is in `module`.\n-                or \"/\".join(Path(t).parts[1:3]) in module\n-            ):\n-                filtered_tests += [t]\n-        return filtered_tests\n-\n-    return {\n-        module: (filter_tests(tests, module=module) if has_many_models(tests) else tests)\n-        for module, tests in test_map.items()\n-    }\n+    return test_map\n \n \n def _print_list(l) -> str:\n@@ -947,9 +920,7 @@ def _print_list(l) -> str:\n     return \"\\n\".join([f\"- {f}\" for f in l])\n \n \n-def infer_tests_to_run(\n-    output_file: str, diff_with_last_commit: bool = False, filter_models: bool = False, test_all: bool = False\n-):\n+def infer_tests_to_run(output_file: str, diff_with_last_commit: bool = False, test_all: bool = False):\n     \"\"\"\n     The main function called by the test fetcher. Determines the tests to run from the diff.\n \n@@ -965,9 +936,6 @@ def infer_tests_to_run(\n         diff_with_last_commit (`bool`, *optional*, defaults to `False`):\n             Whether to analyze the diff with the last commit (for use on the main branch after a PR is merged) or with\n             the branching point from main (for use on each PR).\n-        filter_models (`bool`, *optional*, defaults to `True`):\n-            Whether or not to filter the tests to core models only, when a file modified results in a lot of model\n-            tests.\n     \"\"\"\n     if not test_all:\n         modified_files = get_modified_python_files(diff_with_last_commit=diff_with_last_commit)\n@@ -989,25 +957,24 @@ def infer_tests_to_run(\n     model_impacted = {\"/\".join(x.split(\"/\")[:3]) for x in impacted_files if x.startswith(\"tests/models/\")}\n     # Grab the corresponding test files:\n     if (\n-        any(x in modified_files for x in [\"setup.py\", \".circleci/create_circleci_config.py\"])\n-        or not filter_models\n-        and len(model_impacted) >= NUM_MODELS_TO_TRIGGER_FULL_CI\n+        any(file in CORE_FILES for file in modified_files)\n+        or len(model_impacted) >= NUM_MODELS_TO_TRIGGER_FULL_CI\n         or commit_flags[\"test_all\"]\n     ):\n         test_files_to_run = glob.glob(\"tests/**/test_**.py\", recursive=True) + glob.glob(\n             \"examples/**/*.py\", recursive=True\n         )\n-        if len(model_impacted) >= NUM_MODELS_TO_TRIGGER_FULL_CI and filter_models:\n+        if len(model_impacted) >= NUM_MODELS_TO_TRIGGER_FULL_CI:\n             print(\n-                f\"More than {NUM_MODELS_TO_TRIGGER_FULL_CI - 1} models are impacted and `filter_models=False`. CI is configured to test everything.\"\n+                f\"More than {NUM_MODELS_TO_TRIGGER_FULL_CI - 1} models are impacted. CI is configured to test everything.\"\n             )\n     else:\n         # All modified tests need to be run.\n         test_files_to_run = [f for f in modified_files if f.startswith(\"tests\") and \"/test_\" in f]\n         impacted_files = get_impacted_files_from_tiny_model_summary(diff_with_last_commit=diff_with_last_commit)\n \n         # Then we grab the corresponding test files.\n-        test_map = create_module_to_test_map(reverse_map=reverse_map, filter_models=filter_models)\n+        test_map = create_module_to_test_map(reverse_map=reverse_map)\n         for f in modified_files + impacted_files:\n             if f in test_map:\n                 test_files_to_run.extend(test_map[f])\n@@ -1180,7 +1147,6 @@ def create_test_list_from_filter(full_test_list, out_path):\n         infer_tests_to_run(\n             args.output_file,\n             diff_with_last_commit=diff_with_last_commit,\n-            filter_models=False,\n             test_all=commit_flags[\"test_all\"],\n         )\n         filter_tests(args.output_file, [\"repo_utils\"])"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 20,
        "deletions": 54
    }
}