{
    "author": "ydshieh",
    "message": "Update `test_flash_attn_2_can_dispatch_composite_models` (#36050)\n\n* update\r\n\r\n* update\r\n\r\n* update\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "dce9970884f39e90da99cf65cff3a6ad137df542",
    "files": [
        {
            "sha": "6a47324a333b9b4ff8e9a750ee17dfe2048d6cbf",
            "filename": "tests/test_modeling_common.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/dce9970884f39e90da99cf65cff3a6ad137df542/tests%2Ftest_modeling_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/dce9970884f39e90da99cf65cff3a6ad137df542/tests%2Ftest_modeling_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_modeling_common.py?ref=dce9970884f39e90da99cf65cff3a6ad137df542",
            "patch": "@@ -4436,10 +4436,15 @@ def test_flash_attn_2_can_dispatch_composite_models(self):\n                 model.save_pretrained(tmpdirname)\n                 model = model_class.from_pretrained(tmpdirname, torch_dtype=torch_dtype)\n \n-                supports_fa2_all_modules = all(\n+                sub_models_supporting_fa2 = [\n                     module._supports_flash_attn_2\n                     for name, module in model.named_modules()\n                     if isinstance(module, PreTrainedModel) and name != \"\"\n+                ]\n+                supports_fa2_all_modules = (\n+                    all(sub_models_supporting_fa2)\n+                    if len(sub_models_supporting_fa2) > 0\n+                    else model._supports_flash_attn_2\n                 )\n                 if not supports_fa2_all_modules:\n                     with self.assertRaises(ValueError):"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 6,
        "deletions": 1
    }
}