{
    "author": "ydshieh",
    "message": "Avoid `utils/check_bad_commit.py` failing due to rate limit (requesting  `api.github.com`) (#39918)\n\nfix\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "369c99d0cea403b77bd0aef818527106453fd9fc",
    "files": [
        {
            "sha": "6750e29668cba7459933c2e810b4d95b79755fd4",
            "filename": "utils/check_bad_commit.py",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/huggingface/transformers/blob/369c99d0cea403b77bd0aef818527106453fd9fc/utils%2Fcheck_bad_commit.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/369c99d0cea403b77bd0aef818527106453fd9fc/utils%2Fcheck_bad_commit.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_bad_commit.py?ref=369c99d0cea403b77bd0aef818527106453fd9fc",
            "patch": "@@ -171,6 +171,12 @@ def get_commit_info(commit):\n     print(f\"start_commit: {args.start_commit}\")\n     print(f\"end_commit: {args.end_commit}\")\n \n+    # `get_commit_info` uses `requests.get()` to request info. via `api.github.com` without using token.\n+    # If there are many new failed tests in a workflow run, this script may fail at some point with `KeyError` at\n+    # `pr_number = pr_info_for_commit[0][\"number\"]` due to the rate limit.\n+    # Let's cache the commit info. and reuse them whenever possible.\n+    commit_info_cache = {}\n+\n     if len({args.test is None, args.file is None}) != 2:\n         raise ValueError(\"Exactly one argument `test` or `file` must be specified.\")\n \n@@ -191,7 +197,14 @@ def get_commit_info(commit):\n             for test in failed_tests:\n                 commit = find_bad_commit(target_test=test, start_commit=args.start_commit, end_commit=args.end_commit)\n                 info = {\"test\": test, \"commit\": commit}\n-                info.update(get_commit_info(commit))\n+\n+                if commit in commit_info_cache:\n+                    commit_info = commit_info_cache[commit]\n+                else:\n+                    commit_info = get_commit_info(commit)\n+                    commit_info_cache[commit] = commit_info\n+\n+                info.update(commit_info)\n                 failed_tests_with_bad_commits.append(info)\n \n             # If no single-gpu test failures, remove the key"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 14,
        "deletions": 1
    }
}