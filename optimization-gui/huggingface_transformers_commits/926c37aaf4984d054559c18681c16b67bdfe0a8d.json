{
    "author": "kho",
    "message": "Correctly handle unbatched audio inputs in Gemma3nAudioFeatureExtractor (#42076)\n\n* Correctly handle unbatched audio inputs in Gemma3nAudioFeatureExtractor\n\n* Simplify the logic for batching the unbatched speech input in Gemma3nAudioFeatureExtractor",
    "sha": "926c37aaf4984d054559c18681c16b67bdfe0a8d",
    "files": [
        {
            "sha": "a64148e98b4100a40055f9721c60e413ebb1af2a",
            "filename": "src/transformers/models/gemma3n/feature_extraction_gemma3n.py",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/926c37aaf4984d054559c18681c16b67bdfe0a8d/src%2Ftransformers%2Fmodels%2Fgemma3n%2Ffeature_extraction_gemma3n.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/926c37aaf4984d054559c18681c16b67bdfe0a8d/src%2Ftransformers%2Fmodels%2Fgemma3n%2Ffeature_extraction_gemma3n.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma3n%2Ffeature_extraction_gemma3n.py?ref=926c37aaf4984d054559c18681c16b67bdfe0a8d",
            "patch": "@@ -305,13 +305,10 @@ def __call__(\n         is_batched_sequence = isinstance(raw_speech, Sequence) and isinstance(raw_speech[0], (np.ndarray, Sequence))\n         is_batched = is_batched_numpy or is_batched_sequence\n \n-        if is_batched:\n-            raw_speech = [np.asarray([rs]).T for rs in raw_speech]\n-        elif not is_batched and not isinstance(raw_speech, np.ndarray):\n-            raw_speech = np.asarray(raw_speech)\n-\n-        if not is_batched:  # always return a batch\n-            raw_speech = [np.asarray([raw_speech])]\n+        # Always return a batch\n+        if not is_batched:\n+            raw_speech = [raw_speech]\n+        raw_speech = [np.asarray([rs]).T for rs in raw_speech]\n \n         batched_speech = self.pad(\n             BatchFeature({\"input_features\": raw_speech}),"
        },
        {
            "sha": "fd3db8156e0d353aa3985a26f0e62fcc69eff538",
            "filename": "tests/models/gemma3n/test_feature_extraction_gemma3n.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/926c37aaf4984d054559c18681c16b67bdfe0a8d/tests%2Fmodels%2Fgemma3n%2Ftest_feature_extraction_gemma3n.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/926c37aaf4984d054559c18681c16b67bdfe0a8d/tests%2Fmodels%2Fgemma3n%2Ftest_feature_extraction_gemma3n.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fgemma3n%2Ftest_feature_extraction_gemma3n.py?ref=926c37aaf4984d054559c18681c16b67bdfe0a8d",
            "patch": "@@ -228,6 +228,13 @@ def test_call(self, audio_inputs, test_truncation=False):\n             for enc_seq_1, enc_seq_2 in zip(encoded_sequences_1, encoded_sequences_2):\n                 self.assertTrue(np.allclose(enc_seq_1, enc_seq_2, atol=1e-3))\n \n+    def test_call_unbatched(self):\n+        feature_extractor = self.feature_extraction_class(**self.feat_extract_tester.prepare_feat_extract_dict())\n+        np_audio = floats_list((1, 800))[0]\n+        input_features = feature_extractor(np_audio, return_tensors=\"np\").input_features\n+        expected_input_features = feature_extractor([np_audio], return_tensors=\"np\").input_features\n+        np.testing.assert_allclose(input_features, expected_input_features)\n+\n     def test_audio_features_attn_mask_consistent(self):\n         # regression test for https://github.com/huggingface/transformers/issues/39911\n         # Test input_features and input_features_mask have consistent shape"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 11,
        "deletions": 7
    }
}