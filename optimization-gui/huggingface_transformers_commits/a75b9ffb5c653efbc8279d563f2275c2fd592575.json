{
    "author": "iamsernine",
    "message": "Update Loss Functions to Accept Tensor num_items_in_batch (#38029)\n\n* Update Loss Functions to Accept Tensor num_items_in_batch\n\n* Fix device mismatch by moving num_items_in_batch to loss device in fixed_cross_entropy\n\n* fix the ruff check\n\n* delete the unused if stat\n\n* fix the type problem",
    "sha": "a75b9ffb5c653efbc8279d563f2275c2fd592575",
    "files": [
        {
            "sha": "cf6d9078a945574680f1cbdd5d88aa7e0d53a93f",
            "filename": "src/transformers/loss/loss_utils.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/a75b9ffb5c653efbc8279d563f2275c2fd592575/src%2Ftransformers%2Floss%2Floss_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a75b9ffb5c653efbc8279d563f2275c2fd592575/src%2Ftransformers%2Floss%2Floss_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Floss%2Floss_utils.py?ref=a75b9ffb5c653efbc8279d563f2275c2fd592575",
            "patch": "@@ -35,6 +35,11 @@ def fixed_cross_entropy(\n     reduction = \"sum\" if num_items_in_batch is not None else \"mean\"\n     loss = nn.functional.cross_entropy(source, target, ignore_index=ignore_index, reduction=reduction)\n     if reduction == \"sum\":\n+        if not isinstance(num_items_in_batch, torch.Tensor):\n+            num_items_in_batch = torch.tensor(num_items_in_batch, device=loss.device, dtype=loss.dtype)\n+        elif num_items_in_batch.device != loss.device:\n+            num_items_in_batch = num_items_in_batch.to(loss.device)\n+\n         loss = loss / num_items_in_batch\n     return loss\n "
        }
    ],
    "stats": {
        "total": 5,
        "additions": 5,
        "deletions": 0
    }
}