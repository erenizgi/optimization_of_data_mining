{
    "author": "djmarti",
    "message": "HfArgumentParser: allow for hyhenated field names in long-options (#33990)\n\nAllow for hyphenated field names in long-options\r\n\r\nargparse converts hyphens into underscores before assignment (e.g., an\r\noption passed as `--long-option` will be stored under `long_option`), So\r\nthere is no need to pass options as literal attributes, as in\r\n`--long_option` (with an underscore instead of a hyphen). This commit\r\nensures that this behavior is respected by `parse_args_into_dataclasses`\r\nas well.\r\n\r\nIssue: #33933\r\n\r\nCo-authored-by: Daniel Marti <mrtidm@amazon.com>",
    "sha": "a84c413773cdfdba58b35194c5ba51e2ccb2ca39",
    "files": [
        {
            "sha": "d03ff7004f2b6c0f14af55efd1bd4b8336dde305",
            "filename": "src/transformers/hf_argparser.py",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/huggingface/transformers/blob/a84c413773cdfdba58b35194c5ba51e2ccb2ca39/src%2Ftransformers%2Fhf_argparser.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a84c413773cdfdba58b35194c5ba51e2ccb2ca39/src%2Ftransformers%2Fhf_argparser.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fhf_argparser.py?ref=a84c413773cdfdba58b35194c5ba51e2ccb2ca39",
            "patch": "@@ -138,7 +138,14 @@ def __init__(self, dataclass_types: Union[DataClassType, Iterable[DataClassType]\n \n     @staticmethod\n     def _parse_dataclass_field(parser: ArgumentParser, field: dataclasses.Field):\n-        field_name = f\"--{field.name}\"\n+        # Long-option strings are conventionlly separated by hyphens rather\n+        # than underscores, e.g., \"--long-format\" rather than \"--long_format\".\n+        # Argparse converts hyphens to underscores so that the destination\n+        # string is a valid attribute name. Hf_argparser should do the same.\n+        long_options = [f\"--{field.name}\"]\n+        if \"_\" in field.name:\n+            long_options.append(f\"--{field.name.replace('_', '-')}\")\n+\n         kwargs = field.metadata.copy()\n         # field.metadata is not used at all by Data Classes,\n         # it is provided as a third-party extension mechanism.\n@@ -198,11 +205,11 @@ def _parse_dataclass_field(parser: ArgumentParser, field: dataclasses.Field):\n             if field.type is bool or (field.default is not None and field.default is not dataclasses.MISSING):\n                 # Default value is False if we have no default when of type bool.\n                 default = False if field.default is dataclasses.MISSING else field.default\n-                # This is the value that will get picked if we don't include --field_name in any way\n+                # This is the value that will get picked if we don't include --{field.name} in any way\n                 kwargs[\"default\"] = default\n-                # This tells argparse we accept 0 or 1 value after --field_name\n+                # This tells argparse we accept 0 or 1 value after --{field.name}\n                 kwargs[\"nargs\"] = \"?\"\n-                # This is the value that will get picked if we do --field_name (without value)\n+                # This is the value that will get picked if we do --{field.name} (without value)\n                 kwargs[\"const\"] = True\n         elif isclass(origin_type) and issubclass(origin_type, list):\n             kwargs[\"type\"] = field.type.__args__[0]\n@@ -219,15 +226,21 @@ def _parse_dataclass_field(parser: ArgumentParser, field: dataclasses.Field):\n                 kwargs[\"default\"] = field.default_factory()\n             else:\n                 kwargs[\"required\"] = True\n-        parser.add_argument(field_name, *aliases, **kwargs)\n+        parser.add_argument(*long_options, *aliases, **kwargs)\n \n         # Add a complement `no_*` argument for a boolean field AFTER the initial field has already been added.\n         # Order is important for arguments with the same destination!\n         # We use a copy of earlier kwargs because the original kwargs have changed a lot before reaching down\n         # here and we do not need those changes/additional keys.\n         if field.default is True and (field.type is bool or field.type == Optional[bool]):\n             bool_kwargs[\"default\"] = False\n-            parser.add_argument(f\"--no_{field.name}\", action=\"store_false\", dest=field.name, **bool_kwargs)\n+            parser.add_argument(\n+                f\"--no_{field.name}\",\n+                f\"--no-{field.name.replace('_', '-')}\",\n+                action=\"store_false\",\n+                dest=field.name,\n+                **bool_kwargs,\n+            )\n \n     def _add_dataclass_arguments(self, dtype: DataClassType):\n         if hasattr(dtype, \"_argument_group_name\"):"
        },
        {
            "sha": "08c730f7348b6835341d6c24465caefc87038596",
            "filename": "tests/utils/test_hf_argparser.py",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/huggingface/transformers/blob/a84c413773cdfdba58b35194c5ba51e2ccb2ca39/tests%2Futils%2Ftest_hf_argparser.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a84c413773cdfdba58b35194c5ba51e2ccb2ca39/tests%2Futils%2Ftest_hf_argparser.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_hf_argparser.py?ref=a84c413773cdfdba58b35194c5ba51e2ccb2ca39",
            "patch": "@@ -189,7 +189,7 @@ def test_with_default_bool(self):\n         expected.add_argument(\"--baz\", type=string_to_bool, default=True, const=True, nargs=\"?\")\n         # A boolean no_* argument always has to come after its \"default: True\" regular counter-part\n         # and its default must be set to False\n-        expected.add_argument(\"--no_baz\", action=\"store_false\", default=False, dest=\"baz\")\n+        expected.add_argument(\"--no_baz\", \"--no-baz\", action=\"store_false\", default=False, dest=\"baz\")\n         expected.add_argument(\"--opt\", type=string_to_bool, default=None)\n \n         dataclass_types = [WithDefaultBoolExample]\n@@ -206,6 +206,9 @@ def test_with_default_bool(self):\n             args = parser.parse_args([\"--foo\", \"--no_baz\"])\n             self.assertEqual(args, Namespace(foo=True, baz=False, opt=None))\n \n+            args = parser.parse_args([\"--foo\", \"--no-baz\"])\n+            self.assertEqual(args, Namespace(foo=True, baz=False, opt=None))\n+\n             args = parser.parse_args([\"--foo\", \"--baz\"])\n             self.assertEqual(args, Namespace(foo=True, baz=True, opt=None))\n \n@@ -271,10 +274,10 @@ def test_with_list(self):\n         parser = HfArgumentParser(ListExample)\n \n         expected = argparse.ArgumentParser()\n-        expected.add_argument(\"--foo_int\", nargs=\"+\", default=[], type=int)\n-        expected.add_argument(\"--bar_int\", nargs=\"+\", default=[1, 2, 3], type=int)\n-        expected.add_argument(\"--foo_str\", nargs=\"+\", default=[\"Hallo\", \"Bonjour\", \"Hello\"], type=str)\n-        expected.add_argument(\"--foo_float\", nargs=\"+\", default=[0.1, 0.2, 0.3], type=float)\n+        expected.add_argument(\"--foo_int\", \"--foo-int\", nargs=\"+\", default=[], type=int)\n+        expected.add_argument(\"--bar_int\", \"--bar-int\", nargs=\"+\", default=[1, 2, 3], type=int)\n+        expected.add_argument(\"--foo_str\", \"--foo-str\", nargs=\"+\", default=[\"Hallo\", \"Bonjour\", \"Hello\"], type=str)\n+        expected.add_argument(\"--foo_float\", \"--foo-float\", nargs=\"+\", default=[0.1, 0.2, 0.3], type=float)\n \n         self.argparsersEqual(parser, expected)\n \n@@ -287,6 +290,9 @@ def test_with_list(self):\n         args = parser.parse_args(\"--foo_int 1 --bar_int 2 3 --foo_str a b c --foo_float 0.1 0.7\".split())\n         self.assertEqual(args, Namespace(foo_int=[1], bar_int=[2, 3], foo_str=[\"a\", \"b\", \"c\"], foo_float=[0.1, 0.7]))\n \n+        args = parser.parse_args(\"--foo-int 1 --bar-int 2 3 --foo-str a b c --foo-float 0.1 0.7\".split())\n+        self.assertEqual(args, Namespace(foo_int=[1], bar_int=[2, 3], foo_str=[\"a\", \"b\", \"c\"], foo_float=[0.1, 0.7]))\n+\n     def test_with_optional(self):\n         expected = argparse.ArgumentParser()\n         expected.add_argument(\"--foo\", default=None, type=int)\n@@ -314,10 +320,11 @@ def test_with_required(self):\n         parser = HfArgumentParser(RequiredExample)\n \n         expected = argparse.ArgumentParser()\n-        expected.add_argument(\"--required_list\", nargs=\"+\", type=int, required=True)\n-        expected.add_argument(\"--required_str\", type=str, required=True)\n+        expected.add_argument(\"--required_list\", \"--required-list\", nargs=\"+\", type=int, required=True)\n+        expected.add_argument(\"--required_str\", \"--required-str\", type=str, required=True)\n         expected.add_argument(\n             \"--required_enum\",\n+            \"--required-enum\",\n             type=make_choice_type_function([\"titi\", \"toto\"]),\n             choices=[\"titi\", \"toto\"],\n             required=True,\n@@ -331,13 +338,14 @@ def test_with_string_literal_annotation(self):\n         expected.add_argument(\"--foo\", type=int, required=True)\n         expected.add_argument(\n             \"--required_enum\",\n+            \"--required-enum\",\n             type=make_choice_type_function([\"titi\", \"toto\"]),\n             choices=[\"titi\", \"toto\"],\n             required=True,\n         )\n         expected.add_argument(\"--opt\", type=string_to_bool, default=None)\n         expected.add_argument(\"--baz\", default=\"toto\", type=str, help=\"help message\")\n-        expected.add_argument(\"--foo_str\", nargs=\"+\", default=[\"Hallo\", \"Bonjour\", \"Hello\"], type=str)\n+        expected.add_argument(\"--foo_str\", \"--foo-str\", nargs=\"+\", default=[\"Hallo\", \"Bonjour\", \"Hello\"], type=str)\n         self.argparsersEqual(parser, expected)\n \n     def test_parse_dict(self):"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 35,
        "deletions": 14
    }
}