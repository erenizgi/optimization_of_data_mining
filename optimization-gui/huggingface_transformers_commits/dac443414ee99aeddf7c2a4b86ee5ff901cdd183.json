{
    "author": "Jerry-Terrasse",
    "message": "fix: use mtime by default in Trainer._rotate_checkpoints with automatic fallback (#37260)\n\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>",
    "sha": "dac443414ee99aeddf7c2a4b86ee5ff901cdd183",
    "files": [
        {
            "sha": "48ff7339913fea2b6a5a7984116b6bda29d253d3",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/huggingface/transformers/blob/dac443414ee99aeddf7c2a4b86ee5ff901cdd183/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/dac443414ee99aeddf7c2a4b86ee5ff901cdd183/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=dac443414ee99aeddf7c2a4b86ee5ff901cdd183",
            "patch": "@@ -3224,9 +3224,8 @@ def _save_checkpoint(self, model, trial):\n \n         # Maybe delete some older checkpoints.\n         if self.args.should_save:\n-            # Solely rely on numerical checkpoint id for rotation.\n-            # mtime is not reliable especially on some fuse fs in cloud environments.\n-            self._rotate_checkpoints(use_mtime=False, output_dir=run_dir)\n+            # we use mtime as default, filesystems without mtime support will be detected in `_sorted_checkpoints`\n+            self._rotate_checkpoints(use_mtime=True, output_dir=run_dir)\n \n     def _save_rng_state(self, output_dir):\n         # Save RNG state in non-distributed training\n@@ -4039,7 +4038,17 @@ def _sorted_checkpoints(\n                     ordering_and_checkpoint_path.append((int(regex_match.groups()[0]), path))\n \n         checkpoints_sorted = sorted(ordering_and_checkpoint_path)\n+        # mtime is not reliable on all filesystems, especially on some fuse fs in cloud environments\n+        # so we check if the mtime is fake and fallback to numerical ordering if needed\n+        if use_mtime and len(ordering_and_checkpoint_path) > 1:\n+            mtime_diff = checkpoints_sorted[-1][0] - checkpoints_sorted[0][0]\n+            if mtime_diff < 1.0:  # less than 1 second, which is almost impossible when mtime works fine\n+                warnings.warn(\"mtime may not be reliable on this filesystem, falling back to numerical ordering\")\n+                return self._sorted_checkpoints(\n+                    use_mtime=False, output_dir=output_dir, checkpoint_prefix=checkpoint_prefix\n+                )\n         checkpoints_sorted = [checkpoint[1] for checkpoint in checkpoints_sorted]\n+\n         # Make sure we don't delete the best model.\n         if (\n             self.state.best_model_checkpoint is not None"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 12,
        "deletions": 3
    }
}