{
    "author": "A-Duss",
    "message": "Add explicit example for RAG chat templating (#33503)\n\n* Add explicit example for RAG chat templating\r\n\r\n* Add Tip box and reformulate\r\n\r\nCo-authored-by: Matt <Rocketknight1@users.noreply.github.com>\r\n\r\n---------\r\n\r\nCo-authored-by: Matt <Rocketknight1@users.noreply.github.com>",
    "sha": "763548427d028878f4d4d8fb6f0be57cc3915fbd",
    "files": [
        {
            "sha": "543d9fa00b8b5a1dd966a9a6a8adf280bcbdc611",
            "filename": "docs/source/en/chat_templating.md",
            "status": "modified",
            "additions": 55,
            "deletions": 12,
            "changes": 67,
            "blob_url": "https://github.com/huggingface/transformers/blob/763548427d028878f4d4d8fb6f0be57cc3915fbd/docs%2Fsource%2Fen%2Fchat_templating.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/763548427d028878f4d4d8fb6f0be57cc3915fbd/docs%2Fsource%2Fen%2Fchat_templating.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fchat_templating.md?ref=763548427d028878f4d4d8fb6f0be57cc3915fbd",
            "patch": "@@ -616,22 +616,65 @@ than the JSON schemas used for tools, no helper functions are necessary.\n Here's an example of a RAG template in action:\n \n ```python\n-document1 = {\n-    \"title\": \"The Moon: Our Age-Old Foe\",\n-    \"contents\": \"Man has always dreamed of destroying the moon. In this essay, I shall...\"\n-}\n+from transformers import AutoTokenizer, AutoModelForCausalLM\n \n-document2 = {\n-    \"title\": \"The Sun: Our Age-Old Friend\",\n-    \"contents\": \"Although often underappreciated, the sun provides several notable benefits...\"\n-}\n+# Load the model and tokenizer\n+model_id = \"CohereForAI/c4ai-command-r-v01-4bit\"\n+tokenizer = AutoTokenizer.from_pretrained(model_id)\n+model = AutoModelForCausalLM.from_pretrained(model_id, device_map=\"auto\")\n+device = model.device # Get the device the model is loaded on\n \n-model_input = tokenizer.apply_chat_template(\n-    messages,\n-    documents=[document1, document2]\n-)\n+# Define conversation input\n+conversation = [\n+    {\"role\": \"user\", \"content\": \"What has Man always dreamed of?\"}\n+]\n+\n+# Define documents for retrieval-based generation\n+documents = [\n+    {\n+        \"title\": \"The Moon: Our Age-Old Foe\", \n+        \"text\": \"Man has always dreamed of destroying the moon. In this essay, I shall...\"\n+    },\n+    {\n+        \"title\": \"The Sun: Our Age-Old Friend\",\n+        \"text\": \"Although often underappreciated, the sun provides several notable benefits...\"\n+    }\n+]\n+\n+# Tokenize conversation and documents using a RAG template, returning PyTorch tensors.\n+input_ids = tokenizer.apply_chat_template(\n+    conversation=conversation,\n+    documents=documents,\n+    chat_template=\"rag\",\n+    tokenize=True,\n+    add_generation_prompt=True,\n+    return_tensors=\"pt\").to(device)\n+\n+# Generate a response \n+gen_tokens = model.generate(\n+    input_ids,\n+    max_new_tokens=100,\n+    do_sample=True,\n+    temperature=0.3,\n+    )\n+\n+# Decode and print the generated text along with generation prompt\n+gen_text = tokenizer.decode(gen_tokens[0])\n+print(gen_text)\n ```\n \n+<Tip>\n+\n+The `documents` input for retrieval-augmented generation is not widely supported, and many models have chat templates which simply ignore this input.\n+\n+To verify if a model supports the `documents` input, you can read its model card, or `print(tokenizer.chat_template)` to see if the `documents` key is used anywhere.\n+\n+One model class that does support it, though, is Cohere's [Command-R](https://huggingface.co/CohereForAI/c4ai-command-r-08-2024) and [Command-R+](https://huggingface.co/CohereForAI/c4ai-command-r-plus-08-2024), through their `rag` chat template. You can see additional examples of grounded generation using this feature in their model cards.\n+\n+</Tip>\n+\n+\n+\n ## Advanced: How do chat templates work?\n \n The chat template for a model is stored on the `tokenizer.chat_template` attribute. If no chat template is set, the"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 55,
        "deletions": 12
    }
}