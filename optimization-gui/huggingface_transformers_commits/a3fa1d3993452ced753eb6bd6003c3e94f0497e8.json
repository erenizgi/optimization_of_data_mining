{
    "author": "lilin-1",
    "message": "Fix inaccurate train_tokens_per_second when resuming from checkpoint (#41156)\n\n* fix(trainer): Fix the issue of inaccurate token count in training sessions\n\nDuring the training process, the initial token count was not saved, leading to inaccurate speed calculation. Now, the initial token count is saved and the increment during the session is calculated, ensuring that the speed metric accurately reflects the performance of the current training session.\n\n* 修复错误\n\n---------\n\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>",
    "sha": "a3fa1d3993452ced753eb6bd6003c3e94f0497e8",
    "files": [
        {
            "sha": "f71797c8b599bca357a71b4426be23d68a5439ef",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/a3fa1d3993452ced753eb6bd6003c3e94f0497e8/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a3fa1d3993452ced753eb6bd6003c3e94f0497e8/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=a3fa1d3993452ced753eb6bd6003c3e94f0497e8",
            "patch": "@@ -2516,6 +2516,7 @@ def _inner_training_loop(\n \n         self.state.epoch = 0\n         start_time = time.time()\n+        self.initial_num_input_tokens_seen_for_session = self.state.num_input_tokens_seen\n         epochs_trained = 0\n         steps_trained_in_current_epoch = 0\n \n@@ -3772,7 +3773,10 @@ def log(self, logs: dict[str, float], start_time: Optional[float] = None) -> Non\n         if self.args.include_num_input_tokens_seen != \"no\":\n             logs[\"num_input_tokens_seen\"] = self.state.num_input_tokens_seen\n             if start_time is not None:\n-                logs.update(speed_metrics(\"train\", start_time, num_tokens=self.state.num_input_tokens_seen))\n+                current_session_num_tokens = (\n+                    self.state.num_input_tokens_seen - self.initial_num_input_tokens_seen_for_session\n+                )\n+                logs.update(speed_metrics(\"train\", start_time, num_tokens=current_session_num_tokens))\n \n         output = {**logs, **{\"step\": self.state.global_step}}\n         self.state.log_history.append(output)"
        }
    ],
    "stats": {
        "total": 6,
        "additions": 5,
        "deletions": 1
    }
}