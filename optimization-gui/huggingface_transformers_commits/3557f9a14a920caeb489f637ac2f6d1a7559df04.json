{
    "author": "gante",
    "message": "Generate: `can_generate()` recursive check (#33718)\n\n* add recursive check and test warnings\r\n\r\n* missing space\r\n\r\n* models without can_generate",
    "sha": "3557f9a14a920caeb489f637ac2f6d1a7559df04",
    "files": [
        {
            "sha": "d0f4239c38cc8a1e83afec1fec2b47eef74d3829",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/3557f9a14a920caeb489f637ac2f6d1a7559df04/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/3557f9a14a920caeb489f637ac2f6d1a7559df04/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=3557f9a14a920caeb489f637ac2f6d1a7559df04",
            "patch": "@@ -1645,6 +1645,12 @@ def can_generate(cls) -> bool:\n         # Model class overwrites `generate` (e.g. time series models) -> can generate\n         if str(cls.__name__) in str(cls.generate):\n             return True\n+        # The class inherits from a class that can generate (recursive check) -> can generate\n+        for base in cls.__bases__:\n+            if not hasattr(base, \"can_generate\"):\n+                continue\n+            if \"PreTrainedModel\" not in str(base) and base.can_generate():\n+                return True\n         # BC: Detects whether `prepare_inputs_for_generation` has been overwritten in the model. Prior to v4.45, this\n         # was how we detected whether a model could generate.\n         if \"GenerationMixin\" not in str(cls.prepare_inputs_for_generation):"
        },
        {
            "sha": "3317a47d75603c77070ffb15ec50756d9d79b28c",
            "filename": "tests/utils/test_modeling_utils.py",
            "status": "modified",
            "additions": 27,
            "deletions": 5,
            "changes": 32,
            "blob_url": "https://github.com/huggingface/transformers/blob/3557f9a14a920caeb489f637ac2f6d1a7559df04/tests%2Futils%2Ftest_modeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/3557f9a14a920caeb489f637ac2f6d1a7559df04/tests%2Futils%2Ftest_modeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_modeling_utils.py?ref=3557f9a14a920caeb489f637ac2f6d1a7559df04",
            "patch": "@@ -1718,29 +1718,51 @@ def test_isin_mps_friendly(self):\n \n     def test_can_generate(self):\n         \"\"\"Tests the behavior of `PreTrainedModel.can_generate` method.\"\"\"\n+        logger = logging.get_logger(\"transformers.modeling_utils\")\n+        logger.warning_once.cache_clear()\n+\n         # 1 - By default, a model CAN'T generate\n-        self.assertFalse(BertModel.can_generate())\n+        can_generate = BertModel.can_generate()\n+        self.assertFalse(can_generate)\n \n         # 2 - The most common case for a model to be able to generate is to inherit from `GenerationMixin` directly\n         class DummyBertWithMixin(BertModel, GenerationMixin):\n             pass\n \n-        self.assertTrue(DummyBertWithMixin.can_generate())\n+        with CaptureLogger(logger) as cl:\n+            can_generate = DummyBertWithMixin.can_generate()\n+        self.assertTrue(\"\" == cl.out)\n+        self.assertTrue(can_generate)\n \n         # 3 - Alternatively, a model can implement a `generate` method\n         class DummyBertWithGenerate(BertModel):\n             def generate(self):\n                 pass\n \n-        self.assertTrue(DummyBertWithGenerate.can_generate())\n+        with CaptureLogger(logger) as cl:\n+            can_generate = DummyBertWithGenerate.can_generate()\n+        self.assertTrue(\"\" == cl.out)\n+        self.assertTrue(can_generate)\n+\n+        # 4 - Finally, it can inherit from a model that can generate\n+        class DummyBertWithParent(DummyBertWithMixin):\n+            pass\n+\n+        with CaptureLogger(logger) as cl:\n+            can_generate = DummyBertWithParent.can_generate()\n+        self.assertTrue(\"\" == cl.out)\n+        self.assertTrue(can_generate)\n \n-        # 4 - BC: models with a custom `prepare_inputs_for_generation` can generate (it was assumed they inherited\n+        # 5 - BC: models with a custom `prepare_inputs_for_generation` can generate (it was assumed they inherited\n         # `GenerationMixin`)\n         class DummyBertWithPrepareInputs(BertModel):\n             def prepare_inputs_for_generation(self):\n                 pass\n \n-        self.assertTrue(DummyBertWithPrepareInputs.can_generate())\n+        with CaptureLogger(logger) as cl:\n+            can_generate = DummyBertWithPrepareInputs.can_generate()\n+        self.assertTrue(\"it doesn't directly inherit from `GenerationMixin`\" in cl.out)\n+        self.assertTrue(can_generate)\n \n     def test_save_and_load_config_with_custom_generation(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 38,
        "additions": 33,
        "deletions": 5
    }
}