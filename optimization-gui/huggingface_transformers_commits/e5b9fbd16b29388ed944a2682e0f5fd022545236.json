{
    "author": "Cyrilvallez",
    "message": "Fix buffer offloading (#43131)\n\nfix",
    "sha": "e5b9fbd16b29388ed944a2682e0f5fd022545236",
    "files": [
        {
            "sha": "c5b26192c4d8144f3ba7cb8a5fb933377512d988",
            "filename": "src/transformers/core_model_loading.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/e5b9fbd16b29388ed944a2682e0f5fd022545236/src%2Ftransformers%2Fcore_model_loading.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e5b9fbd16b29388ed944a2682e0f5fd022545236/src%2Ftransformers%2Fcore_model_loading.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcore_model_loading.py?ref=e5b9fbd16b29388ed944a2682e0f5fd022545236",
            "patch": "@@ -896,6 +896,7 @@ def convert_and_load_state_dict_in_model(\n     device_mesh: torch.distributed.device_mesh.DeviceMesh | None = None,\n     disk_offload_index: dict | None = None,\n     disk_offload_folder: str | None = None,\n+    offload_buffers: bool = False,\n ):\n     r\"\"\"\n     We build a mapping from the keys obtained by renaming each of the checkpoint keys according to the weight_mapping rules.\n@@ -989,8 +990,9 @@ def convert_and_load_state_dict_in_model(\n     dtype_plan = dtype_plan or {}\n     weight_mapping = weight_mapping or []\n     meta_model_state_dict = model.state_dict()\n-    missing_keys = set(meta_model_state_dict.keys())\n+    model_buffers = {k for k, _ in model.named_buffers()}\n \n+    missing_keys = set(meta_model_state_dict.keys())\n     conversion_errors = {}\n     mismatch_keys = set()\n     unexpected_keys = set()\n@@ -1108,7 +1110,7 @@ def convert_and_load_state_dict_in_model(\n                         param = param[0] if isinstance(param, list) else param\n                         param_device = get_device(device_map, target_name)\n                         # Offloading support\n-                        if param_device == \"disk\":\n+                        if param_device == \"disk\" and (target_name not in model_buffers or offload_buffers):\n                             disk_offload_index = offload_and_maybe_resave_param(\n                                 target_name, param, missing_keys, disk_offload_folder, disk_offload_index, mapping\n                             )"
        },
        {
            "sha": "34da6e6948dee76394a862cae6566ec8d23059a4",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/e5b9fbd16b29388ed944a2682e0f5fd022545236/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e5b9fbd16b29388ed944a2682e0f5fd022545236/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=e5b9fbd16b29388ed944a2682e0f5fd022545236",
            "patch": "@@ -4083,6 +4083,7 @@ def from_pretrained(\n             sharded_metadata=sharded_metadata,\n             device_map=device_map,\n             disk_offload_folder=offload_folder,\n+            offload_buffers=offload_buffers,\n             dtype=dtype,\n             hf_quantizer=hf_quantizer,\n             device_mesh=device_mesh,\n@@ -4146,6 +4147,7 @@ def _load_pretrained_model(\n         sharded_metadata: Optional[dict] = None,\n         device_map: Optional[dict] = None,\n         disk_offload_folder: Optional[str] = None,\n+        offload_buffers: bool = False,\n         dtype: Optional[torch.dtype] = None,\n         hf_quantizer: Optional[HfQuantizer] = None,\n         device_mesh: Optional[\"torch.distributed.device_mesh.DeviceMesh\"] = None,\n@@ -4228,6 +4230,7 @@ def _load_pretrained_model(\n                     device_mesh=device_mesh,\n                     disk_offload_index=disk_offload_index,\n                     disk_offload_folder=disk_offload_folder,\n+                    offload_buffers=offload_buffers,\n                 )\n             )\n "
        }
    ],
    "stats": {
        "total": 9,
        "additions": 7,
        "deletions": 2
    }
}