{
    "author": "ydshieh",
    "message": "Fix `torch+deepspeed` docker file (#41985)\n\n* fix\n\n* delete\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "6d4450e341da386c47ebfd4f37374693d2788257",
    "files": [
        {
            "sha": "4174157b4fbd3aa87cfd38f593974a3da605ffc9",
            "filename": ".github/workflows/build-docker-images.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/6d4450e341da386c47ebfd4f37374693d2788257/.github%2Fworkflows%2Fbuild-docker-images.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/6d4450e341da386c47ebfd4f37374693d2788257/.github%2Fworkflows%2Fbuild-docker-images.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fbuild-docker-images.yml?ref=6d4450e341da386c47ebfd4f37374693d2788257",
            "patch": "@@ -97,7 +97,7 @@ jobs:\n   latest-torch-deepspeed-docker:\n     name: \"Latest PyTorch + DeepSpeed\"\n     runs-on:\n-      group: aws-g4dn-2xlarge-cache\n+      group: aws-general-8-plus\n     steps:\n       -\n         name: Set up Docker Buildx"
        },
        {
            "sha": "342cb3ad94d30e5dcccc6c25e854c5f9b2575a66",
            "filename": ".github/workflows/self-scheduled.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/6d4450e341da386c47ebfd4f37374693d2788257/.github%2Fworkflows%2Fself-scheduled.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/6d4450e341da386c47ebfd4f37374693d2788257/.github%2Fworkflows%2Fself-scheduled.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-scheduled.yml?ref=6d4450e341da386c47ebfd4f37374693d2788257",
            "patch": "@@ -338,7 +338,7 @@ jobs:\n         working-directory: ${{ inputs.working-directory-prefix }}/\n         run: |\n           python3 -m pip uninstall -y deepspeed\n-          DS_DISABLE_NINJA=1 DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip install deepspeed --global-option=\"build_ext\" --global-option=\"-j8\" --no-cache -v --disable-pip-version-check\n+          DS_DISABLE_NINJA=1 DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip install deepspeed --no-build-isolation --config-settings=\"--build-option=build_ext\" --config-settings=\"--build-option=-j8\" --no-cache -v --disable-pip-version-check\n \n       # To avoid unknown test failures\n       - name: Pre build DeepSpeed *again* (for nightly & Past CI)\n@@ -348,7 +348,7 @@ jobs:\n           python3 -m pip uninstall -y deepspeed\n           rm -rf DeepSpeed\n           git clone https://github.com/deepspeedai/DeepSpeed && cd DeepSpeed && rm -rf build\n-          DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip install . --global-option=\"build_ext\" --global-option=\"-j8\" --no-cache -v --disable-pip-version-check\n+          DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip install . --no-build-isolation --config-settings=\"--build-option=build_ext\" --config-settings=\"--build-option=-j8\" --no-cache -v --disable-pip-version-check\n \n       - name: NVIDIA-SMI\n         run: |"
        },
        {
            "sha": "bb1bc830eeafa5781453eaeaefdc46ab0ff8c4b1",
            "filename": "docker/transformers-pytorch-deepspeed-latest-gpu/Dockerfile",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/6d4450e341da386c47ebfd4f37374693d2788257/docker%2Ftransformers-pytorch-deepspeed-latest-gpu%2FDockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/6d4450e341da386c47ebfd4f37374693d2788257/docker%2Ftransformers-pytorch-deepspeed-latest-gpu%2FDockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftransformers-pytorch-deepspeed-latest-gpu%2FDockerfile?ref=6d4450e341da386c47ebfd4f37374693d2788257",
            "patch": "@@ -21,7 +21,7 @@ RUN python3 -m pip install --no-cache-dir './transformers[deepspeed-testing]' 'p\n # Install latest release PyTorch\n # (PyTorch must be installed before pre-compiling any DeepSpeed c++/cuda ops.)\n # (https://www.deepspeed.ai/tutorials/advanced-install/#pre-install-deepspeed-ops)\n-RUN python3 -m pip uninstall -y torch torchvision torchaudio && python3 -m pip install --no-cache-dir -U torch==$PYTORCH torchvision torchaudio torchcodec --extra-index-url https://download.pytorch.org/whl/$CUDA\n+RUN python3 -m pip uninstall -y torch torchvision torchaudio torchcodec && python3 -m pip install --no-cache-dir -U torch==$PYTORCH torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/$CUDA\n \n RUN python3 -m pip install --no-cache-dir git+https://github.com/huggingface/accelerate@main#egg=accelerate\n \n@@ -43,7 +43,7 @@ RUN python3 -m pip uninstall -y deepspeed\n # This has to be run (again) inside the GPU VMs running the tests.\n # The installation works here, but some tests fail, if we don't pre-build deepspeed again in the VMs running the tests.\n # TODO: Find out why test fail.\n-RUN DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip install deepspeed --global-option=\"build_ext\" --global-option=\"-j8\" --no-cache -v --disable-pip-version-check 2>&1\n+RUN DS_BUILD_CPU_ADAM=1 DS_BUILD_FUSED_ADAM=1 python3 -m pip install deepspeed --no-build-isolation --config-settings=\"--build-option=build_ext\" --config-settings=\"--build-option=-j8\" --no-cache -v --disable-pip-version-check 2>&1\n \n # `kernels` may give different outputs (within 1e-5 range) even with the same model (weights) and the same inputs\n RUN python3 -m pip uninstall -y kernels"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 5,
        "deletions": 5
    }
}