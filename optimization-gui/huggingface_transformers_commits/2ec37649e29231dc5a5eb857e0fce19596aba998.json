{
    "author": "remi-or",
    "message": "Ci utils (#40978)\n\n* Add CI reports dir to gitignore\n\n* Add utils to run local CI\n\n* Review compliance\n\n* Style\n\n* License",
    "sha": "2ec37649e29231dc5a5eb857e0fce19596aba998",
    "files": [
        {
            "sha": "b59797c2188b50c0b658f199ee719674a3157113",
            "filename": ".gitignore",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/2ec37649e29231dc5a5eb857e0fce19596aba998/.gitignore",
            "raw_url": "https://github.com/huggingface/transformers/raw/2ec37649e29231dc5a5eb857e0fce19596aba998/.gitignore",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.gitignore?ref=2ec37649e29231dc5a5eb857e0fce19596aba998",
            "patch": "@@ -13,6 +13,7 @@ tests/fixtures/cached_*_text.txt\n logs/\n lightning_logs/\n lang_code_data/\n+reports/\n \n # Distribution / packaging\n .Python"
        },
        {
            "sha": "2c814d133e650b37b245ed285b28c8218a745364",
            "filename": "utils/get_test_reports.py",
            "status": "added",
            "additions": 272,
            "deletions": 0,
            "changes": 272,
            "blob_url": "https://github.com/huggingface/transformers/blob/2ec37649e29231dc5a5eb857e0fce19596aba998/utils%2Fget_test_reports.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2ec37649e29231dc5a5eb857e0fce19596aba998/utils%2Fget_test_reports.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fget_test_reports.py?ref=2ec37649e29231dc5a5eb857e0fce19596aba998",
            "patch": "@@ -0,0 +1,272 @@\n+# coding=utf-8\n+# Copyright 2025 The HuggingFace Inc. team. All rights reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\"\"\"\n+This util provides a way to manually run the tests of the transformers repo as they would be run by the CI.\n+It was mainly used for models tests, so if you find features missing for another suite, do not hesitate to open a PR.\n+\n+Functionnalities:\n+- Running specific test suite (models, tokenizers, etc.)\n+- Parallel execution across multiple processes (each has to be launched separately with different `--processes` argument)\n+- GPU/CPU test filtering and slow tests filter\n+- Temporary cache management for isolated test runs\n+- Resume functionality for interrupted test runs\n+- Important models subset testing\n+\n+Example usages are below.\n+\"\"\"\n+\n+import argparse\n+import contextlib\n+import os\n+import subprocess\n+import tempfile\n+from pathlib import Path\n+from typing import Optional\n+\n+import torch\n+\n+from .important_files import IMPORTANT_MODELS\n+\n+\n+def is_valid_test_dir(path: Path) -> bool:\n+    \"\"\"Check if a given path represents a valid test dir: the path must point to a dir, not start with '__' or '.'\"\"\"\n+    return path.is_dir() and not path.name.startswith(\"__\") and not path.name.startswith(\".\")\n+\n+\n+def run_pytest(\n+    suite: str, subdir: Path, root_test_dir: Path, machine_type: str, dry_run: bool, tmp_cache: str, cpu_tests: bool\n+) -> None:\n+    \"\"\"\n+    Execute pytest on a specific test directory with configured options:\n+        - suite (str): name of the test suite being run (e.g., 'models', 'tokenizers')\n+        - subdir (Path): the specific directory containing tests to run\n+        - root_test_dir (Path): the root directory of all tests, used for relative paths\n+        - machine_type (str): type of machine/environment (e.g., 'cpu', 'single-gpu', 'multi-gpu')\n+        - dry_run (bool): if True, only print the command without executing it\n+        - tmp_cache (str): prefix for temporary cache directory. If empty, no temp cache is used\n+        - cpu_tests (bool): if True, include CPU-only tests; if False, exclude non-device tests\n+    \"\"\"\n+    relative_path = subdir.relative_to(root_test_dir)\n+    report_name = f\"{machine_type}_{suite}_{relative_path}_test_reports\"\n+    print(f\"Suite: {suite} | Running on: {relative_path}\")\n+\n+    cmd = [\"python3\", \"-m\", \"pytest\", \"-rsfE\", \"-v\", f\"--make-reports={report_name}\", str(subdir)]\n+    if not cpu_tests:\n+        cmd = cmd + [\"-m\", \"not not_device_test\"]\n+\n+    ctx_manager = tempfile.TemporaryDirectory(prefix=tmp_cache) if tmp_cache else contextlib.nullcontext()\n+    with ctx_manager as tmp_dir:\n+        env = os.environ.copy()\n+        if tmp_cache:\n+            env[\"HUGGINGFACE_HUB_CACHE\"] = tmp_dir\n+\n+            print(f\"Using temporary cache located at {tmp_dir = }\")\n+\n+        print(\"Command:\", \" \".join(cmd))\n+        if not dry_run:\n+            subprocess.run(cmd, check=False, env=env)\n+\n+\n+def handle_suite(\n+    suite: str,\n+    test_root: Path,\n+    machine_type: str,\n+    dry_run: bool,\n+    tmp_cache: str = \"\",\n+    resume_at: Optional[str] = None,\n+    only_in: Optional[list[str]] = None,\n+    cpu_tests: bool = False,\n+    process_id: int = 1,\n+    total_processes: int = 1,\n+) -> None:\n+    \"\"\"\n+    Handle execution of a complete test suite with advanced filtering and process distribution.\n+    Args:\n+        - suite (str): Name of the test suite to run (corresponds to a directory under test_root).\n+        - test_root (Path): Root directory containing all test suites.\n+        - machine_type (str): Machine/environment type for report naming and identification.\n+        - dry_run (bool): If True, only print commands without executing them.\n+        - tmp_cache (str, optional): Prefix for temporary cache directories. If empty, no temp cache is used.\n+        - resume_at (str, optional): Resume execution starting from this subdirectory name.\n+            Useful for restarting interrupted test runs. Defaults to None (run from the beginning).\n+        - only_in (list[str], optional): Only run tests in these specific subdirectories.\n+            Can include special values like IMPORTANT_MODELS. Defaults to None (run all tests).\n+        - cpu_tests (bool, optional): Whether to include CPU-only tests. Defaults to False.\n+        - process_id (int, optional): Current process ID for parallel execution (1-indexed). Defaults to 1.\n+        - total_processes (int, optional): Total number of parallel processes. Defaults to 1.\n+    \"\"\"\n+    # Check path to suite\n+    full_path = test_root / suite\n+    if not full_path.exists():\n+        print(f\"Test folder does not exist: {full_path}\")\n+        return\n+\n+    # Establish the list of subdir to go through\n+    subdirs = sorted(full_path.iterdir())\n+    subdirs = [s for s in subdirs if is_valid_test_dir(s)]\n+    if resume_at is not None:\n+        subdirs = [s for s in subdirs if s.name >= resume_at]\n+    if only_in is not None:\n+        subdirs = [s for s in subdirs if s.name in only_in]\n+    if subdirs and total_processes > 1:\n+        # This interleaves the subdirs / files. For instance for subdirs = [A, B, C, D, E] and 2 processes:\n+        # - script launcehd with `--processes 0 2` will run A, C, E\n+        # - script launcehd with `--processes 1 2` will run B, D\n+        subdirs = subdirs[process_id::total_processes]\n+\n+    # If the subdir list is not empty, go through each\n+    if subdirs:\n+        for subdir in subdirs:\n+            run_pytest(suite, subdir, test_root, machine_type, dry_run, tmp_cache, cpu_tests)\n+    # Otherwise, launch pytest from the full path\n+    else:\n+        run_pytest(suite, full_path, test_root, machine_type, dry_run, tmp_cache, cpu_tests)\n+\n+\n+if __name__ == \"__main__\":\n+    \"\"\"Command-line interface for running test suite with comprehensive reporting. Check handle_suite for more details.\n+\n+    Command-line Arguments:\n+        folder: Path to the root test directory (required)\n+        --suite: Test suite name to run (default: \"models\")\n+        --cpu-tests: Include CPU-only tests in addition to device tests\n+        --run-slow: Execute slow tests instead of skipping them\n+        --resume-at: Resume execution from a specific subdirectory\n+        --only-in: Run tests only in specified subdirectories (supports IMPORTANT_MODELS)\n+        --processes: Process distribution as \"process_id total_processes\"\n+        --dry-run: Print commands without executing them\n+        --tmp-cache: Use temporary cache directories for isolated runs\n+        --machine-type: Override automatic machine type detection\n+\n+    Machine Type Detection:\n+        - 'cpu': No CUDA available\n+        - 'single-gpu': CUDA available with 1 GPU\n+        - 'multi-gpu': CUDA available with multiple GPUs\n+\n+    Process Distribution:\n+        Use --processes to split work across multiple parallel processes:\n+        --processes 0 4  # This is process 0 of 4 total processes\n+        --processes 1 4  # This is process 1 of 4 total processes\n+        ...\n+\n+    Usage Examples:\n+        # Basic model testing\n+        python3 -m utils.get_test_reports tests/ --suite models\n+\n+        # Run slow tests for important models only\n+        python3 -m utils.get_test_reports tests/ --suite models --run-slow --only-in IMPORTANT_MODELS\n+\n+        # Parallel execution across 4 processes, second process to launch (processes are 0-indexed)\n+        python3 -m utils.get_test_reports tests/ --suite models --processes 1 4\n+\n+        # Resume interrupted run from 'bert' subdirectory with a tmp cache\n+        python3 -m utils.get_test_reports tests/ --suite models --resume-at bert --tmp-cache /tmp/\n+\n+        # Run specific models with CPU tests\n+        python3 -m utils.get_test_reports tests/ --suite models --only-in bert gpt2 --cpu-tests\n+\n+        # Run slow tests for only important models with a tmp cache\n+        python3 -m utils.get_test_reports tests/ --suite models --run-slow --only-in IMPORTANT_MODELS --tmp-cache /tmp/\n+    \"\"\"\n+\n+    parser = argparse.ArgumentParser()\n+    parser.add_argument(\"folder\", help=\"Path to test root folder (e.g., ./tests)\")\n+\n+    # Choose which tests to run (broad picture)\n+    parser.add_argument(\"--suite\", type=str, default=\"models\", help=\"Test suit to run\")\n+    parser.add_argument(\"--cpu-tests\", action=\"store_true\", help=\"Also runs non-device tests\")\n+    parser.add_argument(\"--run-slow\", action=\"store_true\", help=\"Run slow tests instead of skipping them\")\n+    parser.add_argument(\"--collect-outputs\", action=\"store_true\", help=\"Collect outputs of the tests\")\n+\n+    # Fine-grain control over the tests to run\n+    parser.add_argument(\"--resume-at\", type=str, default=None, help=\"Resume at a specific subdir / file in the suite\")\n+    parser.add_argument(\n+        \"--only-in\",\n+        type=str,\n+        nargs=\"+\",\n+        help=\"Only run tests in the given subdirs / file. Use IMPORTANT_MODELS to run only the important models tests.\",\n+    )\n+\n+    # How to run the test suite: is the work divided among processes, do a try run, use temp cache?\n+    parser.add_argument(\n+        \"--processes\",\n+        type=int,\n+        nargs=\"+\",\n+        help=\"Inform each CI process as to the work to do: format as `process_id total_processes`. \"\n+        \"In order to run with multiple (eg. 3) processes, you need to run the script multiple times (eg. 3 times).\",\n+    )\n+    parser.add_argument(\"--dry-run\", action=\"store_true\", help=\"Only print commands without running them\")\n+    parser.add_argument(\"--tmp-cache\", type=str, help=\"Change HUGGINGFACE_HUB_CACHE to a tmp dir for each test\")\n+\n+    # This is a purely decorative argument, but it can be useful to distinguish between runs\n+    parser.add_argument(\n+        \"--machine-type\", type=str, default=\"\", help=\"Machine type, automatically inferred if not provided\"\n+    )\n+    args = parser.parse_args()\n+\n+    # Handle run slow\n+    if args.run_slow:\n+        os.environ[\"RUN_SLOW\"] = \"yes\"\n+        print(\"[WARNING] Running slow tests.\")\n+    else:\n+        print(\"[WARNING] Skipping slow tests.\")\n+\n+    # Handle multiple CI processes\n+    if args.processes is None:\n+        process_id, total_processes = 1, 1\n+    elif len(args.processes) == 2:\n+        process_id, total_processes = args.processes\n+    else:\n+        raise ValueError(f\"Invalid processes argument: {args.processes}\")\n+\n+    # Assert test root exists\n+    test_root = Path(args.folder).resolve()\n+    if not test_root.exists():\n+        print(f\"Root test folder not found: {test_root}\")\n+        exit(1)\n+\n+    # Handle collection of outputs\n+    if args.collect_outputs:\n+        os.environ[\"PATCH_TESTING_METHODS_TO_COLLECT_OUTPUTS\"] = \"yes\"\n+        reports_dir = test_root.parent / \"reports\"\n+        os.environ[\"_PATCHED_TESTING_METHODS_OUTPUT_DIR\"] = str(reports_dir)\n+\n+    # Infer machine type if not provided\n+    if args.machine_type == \"\":\n+        if not torch.cuda.is_available():\n+            machine_type = \"cpu\"\n+        else:\n+            machine_type = \"multi-gpu\" if torch.cuda.device_count() > 1 else \"single-gpu\"\n+    else:\n+        machine_type = args.machine_type\n+\n+    # Reduce the scope for models if necessary\n+    only_in = args.only_in if args.only_in else None\n+    if only_in == [\"IMPORTANT_MODELS\"]:\n+        only_in = IMPORTANT_MODELS\n+\n+    # Launch suite\n+    handle_suite(\n+        suite=args.suite,\n+        test_root=test_root,\n+        machine_type=machine_type,\n+        dry_run=args.dry_run,\n+        tmp_cache=args.tmp_cache,\n+        resume_at=args.resume_at,\n+        only_in=only_in,\n+        cpu_tests=args.cpu_tests,\n+        process_id=process_id,\n+        total_processes=total_processes,\n+    )"
        }
    ],
    "stats": {
        "total": 273,
        "additions": 273,
        "deletions": 0
    }
}