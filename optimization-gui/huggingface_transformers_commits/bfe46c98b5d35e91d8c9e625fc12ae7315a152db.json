{
    "author": "ydshieh",
    "message": "Make `check_repository_consistency` run faster by MP (#36175)\n\n* speeddddd\r\n\r\n* speeddddd\r\n\r\n* speeddddd\r\n\r\n* speeddddd\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "bfe46c98b5d35e91d8c9e625fc12ae7315a152db",
    "files": [
        {
            "sha": "7e497d755a14a8f725ad716452ed0dfa6b53e07c",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/bfe46c98b5d35e91d8c9e625fc12ae7315a152db/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/bfe46c98b5d35e91d8c9e625fc12ae7315a152db/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fconfig.yml?ref=bfe46c98b5d35e91d8c9e625fc12ae7315a152db",
            "patch": "@@ -170,7 +170,7 @@ jobs:\n             - store_artifacts:\n                   path: ~/transformers/installed.txt\n             - run: python utils/check_copies.py\n-            - run: python utils/check_modular_conversion.py\n+            - run: python utils/check_modular_conversion.py --num_workers 4\n             - run: python utils/check_table.py\n             - run: python utils/check_dummies.py\n             - run: python utils/check_repo.py"
        },
        {
            "sha": "c12fc90dc1f73fe58e42247cd06722c37da587c5",
            "filename": "utils/check_modular_conversion.py",
            "status": "modified",
            "additions": 32,
            "deletions": 8,
            "changes": 40,
            "blob_url": "https://github.com/huggingface/transformers/blob/bfe46c98b5d35e91d8c9e625fc12ae7315a152db/utils%2Fcheck_modular_conversion.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/bfe46c98b5d35e91d8c9e625fc12ae7315a152db/utils%2Fcheck_modular_conversion.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_modular_conversion.py?ref=bfe46c98b5d35e91d8c9e625fc12ae7315a152db",
            "patch": "@@ -120,6 +120,12 @@ def guaranteed_no_diff(modular_file_path, dependencies, models_in_diff):\n     parser.add_argument(\n         \"--fix_and_overwrite\", action=\"store_true\", help=\"Overwrite the modeling_xxx.py file if differences are found.\"\n     )\n+    parser.add_argument(\n+        \"--num_workers\",\n+        default=1,\n+        type=int,\n+        help=\"The number of workers to run. No effect if `fix_and_overwrite` is specified.\",\n+    )\n     args = parser.parse_args()\n     if args.files == [\"all\"]:\n         args.files = glob.glob(\"src/transformers/models/**/modular_*.py\", recursive=True)\n@@ -135,14 +141,32 @@ def guaranteed_no_diff(modular_file_path, dependencies, models_in_diff):\n     skipped_models = set()\n     non_matching_files = 0\n     ordered_files, dependencies = find_priority_list(args.files)\n-    for modular_file_path in ordered_files:\n-        is_guaranteed_no_diff = guaranteed_no_diff(modular_file_path, dependencies, models_in_diff)\n-        if is_guaranteed_no_diff:\n-            model_name = modular_file_path.rsplit(\"modular_\", 1)[1].replace(\".py\", \"\")\n-            skipped_models.add(model_name)\n-            continue\n-        non_matching_files += compare_files(modular_file_path, args.fix_and_overwrite)\n-        models_in_diff = get_models_in_diff()  # When overwriting, the diff changes\n+    if args.fix_and_overwrite or args.num_workers == 1:\n+        for modular_file_path in ordered_files:\n+            is_guaranteed_no_diff = guaranteed_no_diff(modular_file_path, dependencies, models_in_diff)\n+            if is_guaranteed_no_diff:\n+                model_name = modular_file_path.rsplit(\"modular_\", 1)[1].replace(\".py\", \"\")\n+                skipped_models.add(model_name)\n+                continue\n+            non_matching_files += compare_files(modular_file_path, args.fix_and_overwrite)\n+            models_in_diff = get_models_in_diff()  # When overwriting, the diff changes\n+    else:\n+        new_ordered_files = []\n+        for modular_file_path in ordered_files:\n+            is_guaranteed_no_diff = guaranteed_no_diff(modular_file_path, dependencies, models_in_diff)\n+            if is_guaranteed_no_diff:\n+                model_name = modular_file_path.rsplit(\"modular_\", 1)[1].replace(\".py\", \"\")\n+                skipped_models.add(model_name)\n+            else:\n+                new_ordered_files.append(modular_file_path)\n+\n+        new_ordered_files = ordered_files\n+        import multiprocessing\n+\n+        with multiprocessing.Pool(4) as p:\n+            outputs = p.map(compare_files, new_ordered_files)\n+        for output in outputs:\n+            non_matching_files += output\n \n     if non_matching_files and not args.fix_and_overwrite:\n         raise ValueError(\"Some diff and their modeling code did not match.\")"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 33,
        "deletions": 9
    }
}