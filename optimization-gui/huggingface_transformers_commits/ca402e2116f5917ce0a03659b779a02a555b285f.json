{
    "author": "sbucaille",
    "message": "[LightGlue] Fixed attribute usage from descriptor_dim to keypoint_detector_descriptor_dim (#39021)\n\nfix: fix descriptor dimension handling in LightGlue model",
    "sha": "ca402e2116f5917ce0a03659b779a02a555b285f",
    "files": [
        {
            "sha": "17faba587014415d22310b2fafb65ec958b76362",
            "filename": "src/transformers/models/lightglue/modeling_lightglue.py",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/ca402e2116f5917ce0a03659b779a02a555b285f/src%2Ftransformers%2Fmodels%2Flightglue%2Fmodeling_lightglue.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ca402e2116f5917ce0a03659b779a02a555b285f/src%2Ftransformers%2Fmodels%2Flightglue%2Fmodeling_lightglue.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Flightglue%2Fmodeling_lightglue.py?ref=ca402e2116f5917ce0a03659b779a02a555b285f",
            "patch": "@@ -516,16 +516,15 @@ def __init__(self, config: LightGlueConfig):\n \n         self.keypoint_detector = AutoModelForKeypointDetection.from_config(config.keypoint_detector_config)\n \n+        self.keypoint_detector_descriptor_dim = config.keypoint_detector_config.descriptor_decoder_dim\n         self.descriptor_dim = config.descriptor_dim\n         self.num_layers = config.num_hidden_layers\n         self.filter_threshold = config.filter_threshold\n         self.depth_confidence = config.depth_confidence\n         self.width_confidence = config.width_confidence\n \n-        if self.descriptor_dim != config.keypoint_detector_config.descriptor_decoder_dim:\n-            self.input_projection = nn.Linear(\n-                config.keypoint_detector_config.descriptor_decoder_dim, self.descriptor_dim, bias=True\n-            )\n+        if self.descriptor_dim != self.keypoint_detector_descriptor_dim:\n+            self.input_projection = nn.Linear(self.keypoint_detector_descriptor_dim, self.descriptor_dim, bias=True)\n         else:\n             self.input_projection = nn.Identity()\n \n@@ -721,7 +720,7 @@ def _match_image_pair(\n         # (batch_size, 2, num_keypoints, 2) -> (batch_size * 2, num_keypoints, 2)\n         keypoints = keypoints.reshape(batch_size * 2, initial_num_keypoints, 2)\n         mask = mask.reshape(batch_size * 2, initial_num_keypoints) if mask is not None else None\n-        descriptors = descriptors.reshape(batch_size * 2, initial_num_keypoints, self.descriptor_dim)\n+        descriptors = descriptors.reshape(batch_size * 2, initial_num_keypoints, self.keypoint_detector_descriptor_dim)\n         image_indices = torch.arange(batch_size * 2, device=device)\n         # Keypoint normalization\n         keypoints = normalize_keypoints(keypoints, height, width)\n@@ -892,7 +891,7 @@ def forward(\n \n         keypoints, _, descriptors, mask = keypoint_detections[:4]\n         keypoints = keypoints.reshape(batch_size, 2, -1, 2).to(pixel_values)\n-        descriptors = descriptors.reshape(batch_size, 2, -1, self.descriptor_dim).to(pixel_values)\n+        descriptors = descriptors.reshape(batch_size, 2, -1, self.keypoint_detector_descriptor_dim).to(pixel_values)\n         mask = mask.reshape(batch_size, 2, -1)\n \n         absolute_keypoints = keypoints.clone()"
        },
        {
            "sha": "a71fc3c273be4d47d30a1f1ee184026a9f039148",
            "filename": "src/transformers/models/lightglue/modular_lightglue.py",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/ca402e2116f5917ce0a03659b779a02a555b285f/src%2Ftransformers%2Fmodels%2Flightglue%2Fmodular_lightglue.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ca402e2116f5917ce0a03659b779a02a555b285f/src%2Ftransformers%2Fmodels%2Flightglue%2Fmodular_lightglue.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Flightglue%2Fmodular_lightglue.py?ref=ca402e2116f5917ce0a03659b779a02a555b285f",
            "patch": "@@ -587,16 +587,15 @@ def __init__(self, config: LightGlueConfig):\n \n         self.keypoint_detector = AutoModelForKeypointDetection.from_config(config.keypoint_detector_config)\n \n+        self.keypoint_detector_descriptor_dim = config.keypoint_detector_config.descriptor_decoder_dim\n         self.descriptor_dim = config.descriptor_dim\n         self.num_layers = config.num_hidden_layers\n         self.filter_threshold = config.filter_threshold\n         self.depth_confidence = config.depth_confidence\n         self.width_confidence = config.width_confidence\n \n-        if self.descriptor_dim != config.keypoint_detector_config.descriptor_decoder_dim:\n-            self.input_projection = nn.Linear(\n-                config.keypoint_detector_config.descriptor_decoder_dim, self.descriptor_dim, bias=True\n-            )\n+        if self.descriptor_dim != self.keypoint_detector_descriptor_dim:\n+            self.input_projection = nn.Linear(self.keypoint_detector_descriptor_dim, self.descriptor_dim, bias=True)\n         else:\n             self.input_projection = nn.Identity()\n \n@@ -792,7 +791,7 @@ def _match_image_pair(\n         # (batch_size, 2, num_keypoints, 2) -> (batch_size * 2, num_keypoints, 2)\n         keypoints = keypoints.reshape(batch_size * 2, initial_num_keypoints, 2)\n         mask = mask.reshape(batch_size * 2, initial_num_keypoints) if mask is not None else None\n-        descriptors = descriptors.reshape(batch_size * 2, initial_num_keypoints, self.descriptor_dim)\n+        descriptors = descriptors.reshape(batch_size * 2, initial_num_keypoints, self.keypoint_detector_descriptor_dim)\n         image_indices = torch.arange(batch_size * 2, device=device)\n         # Keypoint normalization\n         keypoints = normalize_keypoints(keypoints, height, width)\n@@ -963,7 +962,7 @@ def forward(\n \n         keypoints, _, descriptors, mask = keypoint_detections[:4]\n         keypoints = keypoints.reshape(batch_size, 2, -1, 2).to(pixel_values)\n-        descriptors = descriptors.reshape(batch_size, 2, -1, self.descriptor_dim).to(pixel_values)\n+        descriptors = descriptors.reshape(batch_size, 2, -1, self.keypoint_detector_descriptor_dim).to(pixel_values)\n         mask = mask.reshape(batch_size, 2, -1)\n \n         absolute_keypoints = keypoints.clone()"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 10,
        "deletions": 12
    }
}