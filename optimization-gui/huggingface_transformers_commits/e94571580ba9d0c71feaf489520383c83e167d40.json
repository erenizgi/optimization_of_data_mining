{
    "author": "Cyrilvallez",
    "message": "Fix deepspeed loading (part 2) (#37306)\n\n* fix\n\n* Update modeling_utils.py\n\n* Update modeling_utils.py\n\n* oups remove print",
    "sha": "e94571580ba9d0c71feaf489520383c83e167d40",
    "files": [
        {
            "sha": "2e0a389d74b054d235d29c4df0a4c319ecd06f31",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/huggingface/transformers/blob/e94571580ba9d0c71feaf489520383c83e167d40/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e94571580ba9d0c71feaf489520383c83e167d40/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=e94571580ba9d0c71feaf489520383c83e167d40",
            "patch": "@@ -3723,18 +3723,22 @@ def float(self, *args):\n \n     @classmethod\n     def get_init_context(cls, is_quantized: bool, _is_ds_init_called: bool):\n-        if is_deepspeed_zero3_enabled() and not is_quantized and not _is_ds_init_called:\n-            logger.info(\"Detected DeepSpeed ZeRO-3: activating zero.init() for this model\")\n-            init_contexts = [\n-                deepspeed.zero.Init(config_dict_or_path=deepspeed_config()),\n-                set_zero3_state(),\n-                no_init_weights(),\n-            ]\n+        # With deepspeed, we cannot initialize the model on meta device\n+        if is_deepspeed_zero3_enabled():\n+            init_contexts = [no_init_weights()]\n+            if not is_quantized and not _is_ds_init_called:\n+                logger.info(\"Detected DeepSpeed ZeRO-3: activating zero.init() for this model\")\n+                init_contexts.extend(\n+                    [\n+                        deepspeed.zero.Init(config_dict_or_path=deepspeed_config()),\n+                        set_zero3_state(),\n+                    ]\n+                )\n+            elif is_quantized:\n+                init_contexts.append(set_quantized_state())\n         else:\n             init_contexts = [no_init_weights(), init_empty_weights()]\n \n-        if is_deepspeed_zero3_enabled() and is_quantized:\n-            init_contexts.append(set_quantized_state())\n         return init_contexts\n \n     @classmethod"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 13,
        "deletions": 9
    }
}