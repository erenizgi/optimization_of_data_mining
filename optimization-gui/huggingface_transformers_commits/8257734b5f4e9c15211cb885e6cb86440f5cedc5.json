{
    "author": "ydshieh",
    "message": "Fix `llava` tests (#38722)\n\n* update\n\n* fix 1\n\n* fix 2\n\n* fix 3\n\n* fix 4\n\n* fix 5\n\n* fix 6\n\n* fix 7\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "8257734b5f4e9c15211cb885e6cb86440f5cedc5",
    "files": [
        {
            "sha": "a4457a45f42f4c26337b6ade48ccc6f928314317",
            "filename": "tests/models/llava/test_modeling_llava.py",
            "status": "modified",
            "additions": 51,
            "deletions": 31,
            "changes": 82,
            "blob_url": "https://github.com/huggingface/transformers/blob/8257734b5f4e9c15211cb885e6cb86440f5cedc5/tests%2Fmodels%2Fllava%2Ftest_modeling_llava.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/8257734b5f4e9c15211cb885e6cb86440f5cedc5/tests%2Fmodels%2Fllava%2Ftest_modeling_llava.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fllava%2Ftest_modeling_llava.py?ref=8257734b5f4e9c15211cb885e6cb86440f5cedc5",
            "patch": "@@ -29,6 +29,7 @@\n     is_vision_available,\n )\n from transformers.testing_utils import (\n+    Expectations,\n     cleanup,\n     require_bitsandbytes,\n     require_torch,\n@@ -362,7 +363,14 @@ def test_small_model_integration_test_llama_single(self):\n         inputs = processor(images=raw_image, text=prompt, return_tensors=\"pt\").to(torch_device, torch.float16)\n \n         output = model.generate(**inputs, max_new_tokens=900, do_sample=False)\n-        EXPECTED_DECODED_TEXT = \"USER:  \\nWhat are the things I should be cautious about when I visit this place? ASSISTANT: When visiting this place, which is a pier or dock extending over a body of water, there are a few things to be cautious about. First, be aware of the weather conditions, as sudden changes in weather can make the pier unsafe to walk on. Second, be mindful of the water depth and any potential hazards, such as submerged rocks or debris, that could cause accidents or injuries. Additionally, be cautious of the tides and currents, as they can change rapidly and pose a risk to swimmers or those who venture too close to the edge of the pier. Finally, be respectful of the environment and other visitors, and follow any posted rules or guidelines for the area.\"  # fmt: skip\n+\n+        EXPECTED_DECODED_TEXTS = Expectations(\n+            {\n+                (\"cuda\", 7): 'USER:  \\nWhat are the things I should be cautious about when I visit this place? ASSISTANT: When visiting this place, which is a pier or dock extending over a body of water, there are a few things to be cautious about. First, be aware of the weather conditions, as sudden changes in weather can make the pier unsafe to walk on. Second, be mindful of the water depth and any potential hazards, such as submerged rocks or debris, that could cause accidents or injuries. Additionally, be cautious of the tides and currents, as they can change rapidly and pose a risk to swimmers or those who venture too close to the edge of the pier. Lastly, be respectful of the environment and other visitors, as the pier is a shared space where people can enjoy the view, relax, or engage in recreational activities.',\n+                (\"cuda\", 8): 'USER:  \\nWhat are the things I should be cautious about when I visit this place? ASSISTANT: When visiting this place, which is a pier or dock extending over a body of water, there are a few things to be cautious about. First, be aware of the weather conditions, as sudden changes in weather can make the pier unsafe to walk on. Second, be mindful of the water depth and any potential hazards, such as submerged rocks or debris, that could cause accidents or injuries. Additionally, be cautious of the tides and currents, as they can change rapidly and pose a risk to swimmers or those who venture too close to the edge of the pier. Lastly, be respectful of the environment and other visitors, as the pier is a shared space where people can enjoy the view, relax, or engage in recreational activities.',\n+            }\n+        )  # fmt: skip\n+        EXPECTED_DECODED_TEXT = EXPECTED_DECODED_TEXTS.get_expectation()\n \n         self.assertEqual(\n             processor.decode(output[0], skip_special_tokens=True),\n@@ -415,10 +423,20 @@ def test_small_model_integration_test_batch(self):\n \n         output = model.generate(**inputs, max_new_tokens=20)\n \n-        EXPECTED_DECODED_TEXT = [\n-            'USER:  \\nWhat are the things I should be cautious about when I visit this place? What should I bring with me?\\nASSISTANT: When visiting this place, there are a few things to be cautious about and items to bring.',\n-            'USER:  \\nWhat is this?\\nASSISTANT: Cats'\n-        ]  # fmt: skip\n+        EXPECTED_DECODED_TEXTS = Expectations(\n+            {\n+                (\"cuda\", 7): [\n+                    'USER:  \\nWhat are the things I should be cautious about when I visit this place? What should I bring with me?\\nASSISTANT: When visiting this place, there are a few things to be cautious about and items to bring along',\n+                    'USER:  \\nWhat is this?\\nASSISTANT: Cats',\n+                ],\n+                (\"cuda\", 8): [\n+                    'USER:  \\nWhat are the things I should be cautious about when I visit this place? What should I bring with me?\\nASSISTANT: When visiting this place, there are a few things to be cautious about and items to bring along',\n+                    'USER:  \\nWhat is this?\\nASSISTANT: Cats',\n+                ],\n+            }\n+        )  # fmt: skip\n+        EXPECTED_DECODED_TEXT = EXPECTED_DECODED_TEXTS.get_expectation()\n+\n         self.assertEqual(\n             self.processor.batch_decode(output, skip_special_tokens=True),\n             EXPECTED_DECODED_TEXT,\n@@ -481,11 +499,21 @@ def test_batched_generation(self):\n \n         model = model.eval()\n \n-        EXPECTED_OUTPUT = [\n-            \"\\n \\nUSER: What's the difference of two images?\\nASSISTANT: The difference between the two images is that one shows a dog standing on a grassy field, while\",\n-            \"\\nUSER: Describe the image.\\nASSISTANT: The image features a brown and white dog sitting on a sidewalk. The dog is holding a small\",\n-            \"\\nUSER: Describe the image.\\nASSISTANT: The image features a lone llama standing on a grassy hill. The llama is the\",\n-        ]\n+        EXPECTED_OUTPUTS = Expectations(\n+            {\n+                (\"cuda\", 7): [\n+                    \"\\n \\nUSER: What's the difference of two images?\\nASSISTANT: The difference between the two images is that one of them has a dog standing on a field, while\",\n+                    \"\\nUSER: Describe the image.\\nASSISTANT: The image features a brown and white dog sitting on a sidewalk. The dog is holding a small\",\n+                    \"\\nUSER: Describe the image.\\nASSISTANT: The image features a lone llama standing on a grassy hill. The llama is the\",\n+                ],\n+                (\"cuda\", 8): [\n+                    \"\\n \\nUSER: What's the difference of two images?\\nASSISTANT: The difference between the two images is that one of them has a dog standing on a field, while\",\n+                    '\\nUSER: Describe the image.\\nASSISTANT: The image features a beautiful blonde dog sitting on a sidewalk. The dog is holding a small',\n+                    '\\nUSER: Describe the image.\\nASSISTANT: The image features a lone llama standing on a grassy hill. The llama is the',\n+                ],\n+            }\n+        )  # fmt: skip\n+        EXPECTED_OUTPUT = EXPECTED_OUTPUTS.get_expectation()\n \n         generate_ids = model.generate(**inputs, max_new_tokens=20)\n         outputs = processor.batch_decode(generate_ids, skip_special_tokens=True, clean_up_tokenization_spaces=False)\n@@ -556,32 +584,23 @@ def test_pixtral(self):\n         IMG_URLS = [\n             Image.open(requests.get(\"https://picsum.photos/id/237/400/300\", stream=True).raw),\n             Image.open(requests.get(\"https://picsum.photos/id/231/200/300\", stream=True).raw),\n-            Image.open(requests.get(\"https://picsum.photos/id/27/500/500\", stream=True).raw),\n-            Image.open(requests.get(\"https://picsum.photos/id/17/150/600\", stream=True).raw),\n         ]\n-        PROMPT = \"<s>[INST]Describe the images.\\n[IMG][IMG][IMG][IMG][/INST]\"\n+        PROMPT = \"<s>[INST]Describe the images.\\n[IMG][IMG][/INST]\"\n \n         # image = Image.open(requests.get(url, stream=True).raw)\n         inputs = processor(text=PROMPT, images=IMG_URLS, return_tensors=\"pt\").to(model.device)\n-        generate_ids = model.generate(**inputs, max_new_tokens=500)\n+        generate_ids = model.generate(**inputs, max_new_tokens=100)\n         output = processor.batch_decode(generate_ids, skip_special_tokens=True, clean_up_tokenization_spaces=False)[0]\n-        print(output)\n \n         # fmt: off\n         EXPECTED_GENERATION = \"\"\"\n Describe the images.\n-Certainly! Here are the descriptions of the images:\n-\n-1. **Image 1**: This image features a black dog with a glossy coat sitting on a wooden surface. The dog has a calm and attentive expression, looking directly at the camera. The wooden background has a rustic appearance with visible grain and texture.\n+The first image shows a black dog sitting on a wooden surface. The dog has a glossy coat and is looking directly at the camera with a calm expression. The wooden background appears to be made of weathered wooden planks, giving the image a rustic feel.\n \n-2. **Image 2**: This image captures a breathtaking view of a mountainous landscape. The mountains are rugged and covered with patches of green vegetation. The sky above is clear, and the scene conveys a sense of tranquility and natural beauty.\n-\n-3. **Image 3**: This image shows a beach scene during sunset. The waves are gently rolling onto the shore, and several people can be seen in the water, possibly surfing or swimming. The sky is painted with warm hues of orange and yellow, creating a serene and picturesque atmosphere.\n-\n-4. **Image 4**: This image depicts a narrow, winding path that cuts through a lush, green landscape. On either side of the path, there is dense grass and various trees, including a prominent tree with white blossoms. The sky is clear and blue, adding to the peaceful and inviting ambiance of the scene.\n-\n-These descriptions provide a detailed overview of the content and atmosphere of each image.\n+The second image depicts a scenic mountain landscape. The mountains are rugged and covered with patches of green vegetation. The sky is clear, and the scene conveys a sense of tranquility and natural beauty. The mountains extend into the\n \"\"\"\n+        # Remove the first and last empty character.\n+        EXPECTED_GENERATION = EXPECTED_GENERATION[1:-1]\n         # fmt: on\n         # check that both inputs are handled correctly and generate the same output\n         self.assertEqual(output, EXPECTED_GENERATION)\n@@ -603,12 +622,13 @@ def test_pixtral_4bit(self):\n         generate_ids = model.generate(**inputs, max_new_tokens=50)\n         output = processor.batch_decode(generate_ids, skip_special_tokens=True, clean_up_tokenization_spaces=False)[0]\n \n-        EXPECTED_GENERATION = [\n-            # CUDA output\n-            \"Describe the images. The image showcases a dog, which is prominently positioned in the center, taking up a significant portion of the frame. The dog is situated against a backdrop of a wooden surface, which spans the entire image. The dog appears to be a black Labrador\",\n-            # XPU output\n-            \"Describe the images.The image showcases a dog, which is prominently positioned in the center, taking up a significant portion of the frame. The dog is situated against a backdrop of a wooden surface, which covers the entire background. The dog appears to be the main focus\",\n-        ]  # fmt: skip\n+        EXPECTED_GENERATIONS = Expectations(\n+            {\n+                (\"cuda\", 7): \"Describe the images.The image showcases a dog, which is prominently positioned in the center, taking up a significant portion of the frame. The dog is situated against a backdrop of a wooden surface, which spans the entire image. The dog appears to be a black Labrador\",\n+                (\"xpu\", 3): \"Describe the images.The image showcases a dog, which is prominently positioned in the center, taking up a significant portion of the frame. The dog is situated against a backdrop of a wooden surface, which covers the entire background. The dog appears to be the main focus\",\n+            }\n+        )  # fmt: skip\n+        EXPECTED_GENERATION = EXPECTED_GENERATIONS.get_expectation()\n         self.assertTrue(output in EXPECTED_GENERATION)\n \n     @slow"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 51,
        "deletions": 31
    }
}