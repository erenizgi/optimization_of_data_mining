{
    "author": "LysandreJik",
    "message": "Fix the \"test_offline\" test (#42458)\n\n* Fix the test offline test\n\n* Refactor test_offline method with context patches\n\nRefactor test_offline to use patch for offline mode.\n\n* Apply suggestion from @Wauplin\n\n---------\n\nCo-authored-by: Lucain <lucainp@gmail.com>",
    "sha": "a8457eb866c8fc6cf3b4db0eb51288b27c001f44",
    "files": [
        {
            "sha": "2c3b6c422d577d60b38c9442d2e60ca61f668b7e",
            "filename": "tests/utils/test_modeling_utils.py",
            "status": "modified",
            "additions": 9,
            "deletions": 11,
            "changes": 20,
            "blob_url": "https://github.com/huggingface/transformers/blob/a8457eb866c8fc6cf3b4db0eb51288b27c001f44/tests%2Futils%2Ftest_modeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a8457eb866c8fc6cf3b4db0eb51288b27c001f44/tests%2Futils%2Ftest_modeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_modeling_utils.py?ref=a8457eb866c8fc6cf3b4db0eb51288b27c001f44",
            "patch": "@@ -290,22 +290,20 @@ def forward(self, mask, inputs_embeds):\n             return attention_mask\n \n     class TestOffline(unittest.TestCase):\n-        @patch(\"huggingface_hub.constants\")\n-        def test_offline(self, mock_hf_hub_constants):\n+        def test_offline(self):\n             with tempfile.TemporaryDirectory() as tmpdir:\n-                mock_hf_hub_constants.HF_HUB_OFFLINE = True\n-\n                 # First offline load should fail\n-                with pytest.raises(OSError):\n-                    AutoModelForImageClassification.from_pretrained(TINY_IMAGE_CLASSIF, cache_dir=tmpdir)\n+                with patch(\"transformers.utils.hub.is_offline_mode\", return_value=True):\n+                    with pytest.raises(OSError):\n+                        AutoModelForImageClassification.from_pretrained(TINY_IMAGE_CLASSIF, cache_dir=tmpdir)\n \n-                # Download model from Hub\n-                mock_hf_hub_constants.HF_HUB_OFFLINE = False\n-                snapshot_download(TINY_IMAGE_CLASSIF, cache_dir=tmpdir)\n+                # Enable online mode for download\n+                with patch(\"transformers.utils.hub.is_offline_mode\", return_value=False):\n+                    snapshot_download(TINY_IMAGE_CLASSIF, cache_dir=tmpdir)\n \n                 # Load again in offline mode - should work now\n-                mock_hf_hub_constants.HF_HUB_OFFLINE = True\n-                AutoModelForImageClassification.from_pretrained(TINY_IMAGE_CLASSIF, cache_dir=tmpdir)\n+                with patch(\"transformers.utils.hub.is_offline_mode\", return_value=True):\n+                    AutoModelForImageClassification.from_pretrained(TINY_IMAGE_CLASSIF, cache_dir=tmpdir)\n \n         def test_local_files_only(self):\n             with tempfile.TemporaryDirectory() as tmpdir:"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 9,
        "deletions": 11
    }
}