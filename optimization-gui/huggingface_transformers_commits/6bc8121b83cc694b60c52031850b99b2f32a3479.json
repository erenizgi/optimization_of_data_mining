{
    "author": "AmitMY",
    "message": "Fix Mac mps dataloader_num_workers > 1 causes RuntimeError: _share_filename_: only available on CPU (#38819)\n\n* Update trainer.py: add multiprocessing_context for mps devices\n\n* Fix multiprocessing context for MPS with workers\n\n* Apply style fixes\n\n---------\n\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>\nCo-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>",
    "sha": "6bc8121b83cc694b60c52031850b99b2f32a3479",
    "files": [
        {
            "sha": "bccb5a881732076147b5658301b95b45829187a3",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/6bc8121b83cc694b60c52031850b99b2f32a3479/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/6bc8121b83cc694b60c52031850b99b2f32a3479/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=6bc8121b83cc694b60c52031850b99b2f32a3479",
            "patch": "@@ -1023,12 +1023,16 @@ def _get_dataloader(\n         else:\n             data_collator = self._get_collator_with_removed_columns(self.data_collator, description=description)\n \n+        # MPS requrires forking if multiple workers are specified\n+        should_fork = torch.backends.mps.is_available() and self.args.dataloader_num_workers > 1\n+\n         dataloader_params = {\n             \"batch_size\": batch_size,\n             \"collate_fn\": data_collator,\n             \"num_workers\": self.args.dataloader_num_workers,\n             \"pin_memory\": self.args.dataloader_pin_memory,\n             \"persistent_workers\": self.args.dataloader_persistent_workers,\n+            \"multiprocessing_context\": \"fork\" if should_fork else None,\n         }\n \n         if not isinstance(dataset, torch.utils.data.IterableDataset):"
        }
    ],
    "stats": {
        "total": 4,
        "additions": 4,
        "deletions": 0
    }
}