{
    "author": "ydshieh",
    "message": "Better security for `pr-repo-consistency-bot.yml` (#42646)\n\n* better\n\n* better\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "ee7e67bf6abf0fe994bb02b1d3e6a30a4ea0970f",
    "files": [
        {
            "sha": "8264d9ee527021a3963c531e5138785ae48c57cc",
            "filename": ".github/workflows/pr-repo-consistency-bot.yml",
            "status": "modified",
            "additions": 107,
            "deletions": 30,
            "changes": 137,
            "blob_url": "https://github.com/huggingface/transformers/blob/ee7e67bf6abf0fe994bb02b1d3e6a30a4ea0970f/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ee7e67bf6abf0fe994bb02b1d3e6a30a4ea0970f/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml?ref=ee7e67bf6abf0fe994bb02b1d3e6a30a4ea0970f",
            "patch": "@@ -138,18 +138,29 @@ jobs:\n           # Check if there are changes\n           if [ -n \"$(git status --porcelain)\" ]; then\n             echo \"changes_detected=true\" >> $GITHUB_OUTPUT\n-            # Create a patch file with all changes\n-            git diff > consistency-fixes.patch\n           else\n             echo \"changes_detected=false\" >> $GITHUB_OUTPUT\n           fi\n \n-      - name: Upload patch\n+      - name: Save modified files\n+        if: steps.run_checks.outputs.changes_detected == 'true'\n+        run: |\n+          mkdir -p pr-repo\n+          git diff --name-only > modified-files.txt\n+          # Copy each modified file to pr-repo directory\n+          while IFS= read -r file; do\n+            mkdir -p \"pr-repo/$(dirname \"$file\")\"\n+            cp \"$file\" \"pr-repo/$file\"\n+          done < modified-files.txt\n+\n+      - name: Upload modified files\n         if: steps.run_checks.outputs.changes_detected == 'true'\n         uses: actions/upload-artifact@v4\n         with:\n-          name: consistency-fixes-patch\n-          path: consistency-fixes.patch\n+          name: modified-files\n+          path: |\n+            modified-files.txt\n+            pr-repo/\n \n   commit-and-comment:\n     runs-on: ubuntu-22.04\n@@ -158,37 +169,103 @@ jobs:\n     permissions:\n       pull-requests: write\n     steps:\n-      - uses: actions/checkout@v4\n-        if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'\n-        with:\n-          repository: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}\n-          ref: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}\n-          fetch-depth: \"1\"\n-          # Need to specify `token` here, so we can push in `Commit and push changes` below.\n-          token: ${{ secrets.HF_STYLE_BOT_ACTION }}\n-\n-      - name: Download patch\n+      - name: Download modified files\n         if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'\n         uses: actions/download-artifact@v4\n         with:\n-          name: consistency-fixes-patch\n+          name: modified-files\n \n-      - name: Apply patch and push\n+      - name: Push changes via GitHub API (no checkout)\n         if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'\n+        uses: actions/github-script@v6\n         env:\n           PR_HEAD_REF: ${{ needs.get-pr-info.outputs.PR_HEAD_REF }}\n-          GITHUB_TOKEN: ${{ secrets.HF_STYLE_BOT_ACTION }}\n-        run: |\n-          git config user.name \"github-actions[bot]\"\n-          git config user.email \"github-actions[bot]@users.noreply.github.com\"\n-          \n-          # Apply the patch\n-          git apply consistency-fixes.patch\n-          \n-          # Only add updates to tracked files (ignores new untracked files like the patch)\n-          git add -u\n-          git commit -m \"Apply repo. consistency fixes\"\n-          git push origin HEAD:$PR_HEAD_REF\n+          PR_HEAD_SHA: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}\n+          PR_HEAD_REPO_OWNER: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}\n+          PR_HEAD_REPO_NAME: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}\n+        with:\n+          github-token: ${{ secrets.HF_STYLE_BOT_ACTION }}\n+          script: |\n+            const fs = require('fs');\n+            const path = require('path');\n+            \n+            const owner = process.env.PR_HEAD_REPO_OWNER;\n+            const repo = process.env.PR_HEAD_REPO_NAME;\n+            const baseSha = process.env.PR_HEAD_SHA;\n+            const branch = process.env.PR_HEAD_REF;\n+            \n+            console.log(`Creating commit on ${owner}/${repo} branch ${branch} from ${baseSha}`);\n+            \n+            // Read list of modified files\n+            const modifiedFiles = fs.readFileSync('modified-files.txt', 'utf8')\n+              .trim()\n+              .split('\\n')\n+              .filter(f => f.length > 0);\n+            \n+            console.log(`Modified files: ${modifiedFiles.join(', ')}`);\n+            \n+            // Get the base commit to retrieve its tree SHA (metadata only, no checkout)\n+            const { data: baseCommit } = await github.rest.git.getCommit({\n+              owner,\n+              repo,\n+              commit_sha: baseSha\n+            });\n+            \n+            console.log(`Base tree SHA: ${baseCommit.tree.sha}`);\n+            \n+            // Create blobs for each modified file\n+            const tree = [];\n+            for (const file of modifiedFiles) {\n+              const filePath = path.join('pr-repo', file);\n+              const content = fs.readFileSync(filePath, 'utf8');\n+              \n+              console.log(`Creating blob for ${file}`);\n+              const { data: blob } = await github.rest.git.createBlob({\n+                owner,\n+                repo,\n+                content: content,\n+                encoding: 'utf-8'\n+              });\n+              \n+              tree.push({\n+                path: file,\n+                mode: '100644',\n+                type: 'blob',\n+                sha: blob.sha\n+              });\n+            }\n+            \n+            // Create new tree based on the base tree\n+            console.log(`Creating tree with ${tree.length} modified files`);\n+            const { data: newTree } = await github.rest.git.createTree({\n+              owner,\n+              repo,\n+              base_tree: baseCommit.tree.sha,\n+              tree: tree\n+            });\n+            \n+            // Create commit\n+            console.log(`Creating commit`);\n+            const { data: newCommit } = await github.rest.git.createCommit({\n+              owner,\n+              repo,\n+              message: 'Apply repo. consistency fixes',\n+              tree: newTree.sha,\n+              parents: [baseSha]\n+            });\n+            \n+            console.log(`Created commit: ${newCommit.sha}`);\n+            \n+            // Update branch ref\n+            console.log(`Updating ref heads/${branch} to ${newCommit.sha}`);\n+            await github.rest.git.updateRef({\n+              owner,\n+              repo,\n+              ref: `heads/${branch}`,\n+              sha: newCommit.sha\n+            });\n+            \n+            console.log(`Successfully pushed commit to ${branch}`);\n \n       - name: Prepare final comment message\n         id: prepare_final_comment\n@@ -215,4 +292,4 @@ jobs:\n               repo: context.repo.repo,\n               comment_id: ${{ needs.init_comment_with_url.outputs.comment_id }},\n               body: `${{ steps.prepare_final_comment.outputs.final_comment }}`\n-            });\n+            });\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 137,
        "additions": 107,
        "deletions": 30
    }
}