{
    "author": "matthewdouglas",
    "message": "bitsandbytes: simplify 8bit dequantization (#35068)",
    "sha": "401aa39d7b36e1b7ad0991f67389a19ad4b54064",
    "files": [
        {
            "sha": "b10a3b599174cdad2a03e41d4da63318df865fca",
            "filename": "src/transformers/integrations/bitsandbytes.py",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/huggingface/transformers/blob/401aa39d7b36e1b7ad0991f67389a19ad4b54064/src%2Ftransformers%2Fintegrations%2Fbitsandbytes.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/401aa39d7b36e1b7ad0991f67389a19ad4b54064/src%2Ftransformers%2Fintegrations%2Fbitsandbytes.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fintegrations%2Fbitsandbytes.py?ref=401aa39d7b36e1b7ad0991f67389a19ad4b54064",
            "patch": "@@ -363,13 +363,14 @@ def dequantize_bnb_weight(weight: \"torch.nn.Parameter\", dtype: \"torch.dtype\", st\n     if state.SCB is None:\n         state.SCB = weight.SCB\n \n-    im = torch.eye(weight.data.shape[-1]).contiguous().half().to(weight.device)\n-    im, imt, SCim, SCimt, coo_tensorim = bnb.functional.double_quant(im)\n-    im, Sim = bnb.functional.transform(im, \"col32\")\n-    if state.CxB is None:\n-        state.CxB, state.SB = bnb.functional.transform(weight.data, to_order=state.formatB)\n-    out32, Sout32 = bnb.functional.igemmlt(im, state.CxB, Sim, state.SB)\n-    return bnb.functional.mm_dequant(out32, Sout32, SCim, state.SCB, bias=None).t().to(dtype)\n+    if hasattr(bnb.functional, \"int8_vectorwise_dequant\"):\n+        # Use bitsandbytes API if available (requires v0.45.0+)\n+        dequantized = bnb.functional.int8_vectorwise_dequant(weight.data, state.SCB)\n+    else:\n+        # Multiply by (scale/127) to dequantize.\n+        dequantized = weight.data * state.SCB.view(-1, 1) * 7.874015718698502e-3\n+\n+    return dequantized.to(dtype)\n \n \n def _create_accelerate_new_hook(old_hook):"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 8,
        "deletions": 7
    }
}