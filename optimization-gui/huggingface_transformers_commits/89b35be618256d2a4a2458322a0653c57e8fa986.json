{
    "author": "Rocketknight1",
    "message": "Allow make-fixup on main branch, albeit slowly (#38892)\n\n* Allow make-fixup on main branch, albeit slowly\n\n* Make the other style checks work correctly on main too\n\n* More update\n\n* More makefile update",
    "sha": "89b35be618256d2a4a2458322a0653c57e8fa986",
    "files": [
        {
            "sha": "17315c8a9e2dea74114e3a3a6ba336806cba83a6",
            "filename": "Makefile",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/huggingface/transformers/blob/89b35be618256d2a4a2458322a0653c57e8fa986/Makefile",
            "raw_url": "https://github.com/huggingface/transformers/raw/89b35be618256d2a4a2458322a0653c57e8fa986/Makefile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/Makefile?ref=89b35be618256d2a4a2458322a0653c57e8fa986",
            "patch": "@@ -8,13 +8,19 @@ check_dirs := examples tests src utils\n exclude_folders :=  \"\"\n \n modified_only_fixup:\n-\t$(eval modified_py_files := $(shell python utils/get_modified_files.py $(check_dirs)))\n-\t@if test -n \"$(modified_py_files)\"; then \\\n-\t\techo \"Checking/fixing $(modified_py_files)\"; \\\n-\t\truff check $(modified_py_files) --fix --exclude $(exclude_folders); \\\n-\t\truff format $(modified_py_files) --exclude $(exclude_folders);\\\n+\t@current_branch=$$(git branch --show-current); \\\n+\tif [ \"$$current_branch\" = \"main\" ]; then \\\n+\t\techo \"On main branch, running 'style' target instead...\"; \\\n+\t\t$(MAKE) style; \\\n \telse \\\n-\t\techo \"No library .py files were modified\"; \\\n+\t\tmodified_py_files=$$(python utils/get_modified_files.py $(check_dirs)); \\\n+\t\tif [ -n \"$$modified_py_files\" ]; then \\\n+\t\t\techo \"Checking/fixing files: $${modified_py_files}\"; \\\n+\t\t\truff check $${modified_py_files} --fix --exclude $(exclude_folders); \\\n+\t\t\truff format $${modified_py_files} --exclude $(exclude_folders); \\\n+\t\telse \\\n+\t\t\techo \"No library .py files were modified\"; \\\n+\t\tfi; \\\n \tfi\n \n # Update src/transformers/dependency_versions_table.py"
        },
        {
            "sha": "fa233d0cf2ae261ed328314658c28260222192a7",
            "filename": "utils/check_modular_conversion.py",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/huggingface/transformers/blob/89b35be618256d2a4a2458322a0653c57e8fa986/utils%2Fcheck_modular_conversion.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/89b35be618256d2a4a2458322a0653c57e8fa986/utils%2Fcheck_modular_conversion.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_modular_conversion.py?ref=89b35be618256d2a4a2458322a0653c57e8fa986",
            "patch": "@@ -133,10 +133,19 @@ def guaranteed_no_diff(modular_file_path, dependencies, models_in_diff):\n     # Assuming there is a topological sort on the dependency mapping: if the file being checked and its dependencies\n     # are not in the diff, then there it is guaranteed to have no differences. If no models are in the diff, then this\n     # script will do nothing.\n-    models_in_diff = get_models_in_diff()\n-    if not models_in_diff:\n-        console.print(\"[bold green]No models files or model tests in the diff, skipping modular checks[/bold green]\")\n-        exit(0)\n+    current_branch = subprocess.check_output([\"git\", \"branch\", \"--show-current\"], text=True).strip()\n+    if current_branch == \"main\":\n+        console.print(\n+            \"[bold red]You are developing on the main branch. We cannot identify the list of changed files and will have to check all files. This may take a while.[/bold red]\"\n+        )\n+        models_in_diff = {file_path.split(\"/\")[-2] for file_path in args.files}\n+    else:\n+        models_in_diff = get_models_in_diff()\n+        if not models_in_diff:\n+            console.print(\n+                \"[bold green]No models files or model tests in the diff, skipping modular checks[/bold green]\"\n+            )\n+            exit(0)\n \n     skipped_models = set()\n     non_matching_files = 0\n@@ -149,7 +158,8 @@ def guaranteed_no_diff(modular_file_path, dependencies, models_in_diff):\n                 skipped_models.add(model_name)\n                 continue\n             non_matching_files += compare_files(modular_file_path, args.fix_and_overwrite)\n-            models_in_diff = get_models_in_diff()  # When overwriting, the diff changes\n+            if current_branch != \"main\":\n+                models_in_diff = get_models_in_diff()  # When overwriting, the diff changes\n     else:\n         new_ordered_files = []\n         for modular_file_path in ordered_files:"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 27,
        "deletions": 11
    }
}