{
    "author": "manueldeprada",
    "message": "Fix `fix_and_overwrite` mode of `utils/check_docstring.py` (#39369)\n\n* bug in fix mode of check_docstring",
    "sha": "cf243a1bf85e2197dac2cfc1f9b23c0e99493fa2",
    "files": [
        {
            "sha": "8878491e4e0c000aac74335c64fd7e970ae10c03",
            "filename": "utils/check_docstrings.py",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/huggingface/transformers/blob/cf243a1bf85e2197dac2cfc1f9b23c0e99493fa2/utils%2Fcheck_docstrings.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/cf243a1bf85e2197dac2cfc1f9b23c0e99493fa2/utils%2Fcheck_docstrings.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_docstrings.py?ref=cf243a1bf85e2197dac2cfc1f9b23c0e99493fa2",
            "patch": "@@ -823,16 +823,19 @@ def match_docstring_with_signature(obj: Any) -> Optional[tuple[str, str]]:\n     except OSError:\n         source = []\n \n+    # Find the line where the docstring starts\n     idx = 0\n     while idx < len(source) and '\"\"\"' not in source[idx]:\n         idx += 1\n \n     ignore_order = False\n     if idx < len(source):\n         line_before_docstring = source[idx - 1]\n+        # Match '# no-format' (allowing surrounding whitespaces)\n         if re.search(r\"^\\s*#\\s*no-format\\s*$\", line_before_docstring):\n-            # This object is ignored\n+            # This object is ignored by the auto-docstring tool\n             return\n+        # Match '# ignore-order' (allowing surrounding whitespaces)\n         elif re.search(r\"^\\s*#\\s*ignore-order\\s*$\", line_before_docstring):\n             ignore_order = True\n \n@@ -959,14 +962,15 @@ def fix_docstring(obj: Any, old_doc_args: str, new_doc_args: str):\n         idx -= 1\n     idx += 1\n \n-    if \"\".join(source[start_idx:idx])[:-1] != old_doc_args:\n+    # `old_doc_args` is built from `obj.__doc__`, which may have\n+    # different indentation than the raw source from `inspect.getsourcelines`.\n+    # We use `inspect.cleandoc` to remove indentation uniformly from both\n+    # strings before comparing them.\n+    source_args_as_str = \"\".join(source[start_idx:idx])\n+    if inspect.cleandoc(source_args_as_str) != inspect.cleandoc(old_doc_args):\n         # Args are not fully defined in the docstring of this object\n-        # This can happen due to a mismatch in indentation calculation where the docstring parsing\n-        # in match_docstring_with_signature uses obj.__doc__.split(\"\\n\") while here we use\n-        # inspect.getsourcelines(obj) which can have different line endings or indentation.\n-        # See https://github.com/huggingface/transformers/pull/38915/files#r2200675302 for more details.\n         obj_file = find_source_file(obj)\n-        actual_args_section = \"\".join(source[start_idx:idx])[:-1]\n+        actual_args_section = source_args_as_str.rstrip()\n         raise ValueError(\n             f\"Cannot fix docstring of {obj.__name__} in {obj_file} because the argument section in the source code \"\n             f\"does not match the expected format. This usually happens when:\\n\"\n@@ -983,6 +987,10 @@ def fix_docstring(obj: Any, old_doc_args: str, new_doc_args: str):\n \n     # Replace content\n     lines = content.split(\"\\n\")\n+    prev_line_indentation = find_indent(lines[line_number + start_idx - 2])\n+    # Now increase the indentation of every line in new_doc_args by prev_line_indentation\n+    new_doc_args = \"\\n\".join([f\"{' ' * prev_line_indentation}{line}\" for line in new_doc_args.split(\"\\n\")])\n+\n     lines = lines[: line_number + start_idx - 1] + [new_doc_args] + lines[line_number + idx - 1 :]\n \n     print(f\"Fixing the docstring of {obj.__name__} in {obj_file}.\")"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 15,
        "deletions": 7
    }
}