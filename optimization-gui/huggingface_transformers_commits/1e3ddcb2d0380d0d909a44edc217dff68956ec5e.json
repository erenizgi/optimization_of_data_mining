{
    "author": "warner-benjamin",
    "message": "ModernBERT bug fixes (#35404)\n\n* bug fixes\r\n\r\n* organize imports\r\n\r\n* wrap cpu warning in reference_compile\r\n\r\n* Avoid needing repad_logits_with_grad, always repad with grads when training\r\n\r\nI'm not 100% that the conditional with \"or labels is None\" makes sense though - not sure what the intention is there. Perhaps we can remove that?\r\n\r\n* Revert \"Avoid needing repad_logits_with_grad, always repad with grads when training\"\r\n\r\nThis reverts commit cedcb4e89bcea199a1135a0933e71f534b656239.\r\n\r\n* Fix grammar: keep -> keeps\r\n\r\n* Propagate grammar fix with modular_model_converter\r\n\r\n---------\r\n\r\nCo-authored-by: Tom Aarsen <Cubiegamedev@gmail.com>\r\nCo-authored-by: Tom Aarsen <37621491+tomaarsen@users.noreply.github.com>",
    "sha": "1e3ddcb2d0380d0d909a44edc217dff68956ec5e",
    "files": [
        {
            "sha": "c65a470ed564a4cae77fa1d2131e1ce7a6ad70da",
            "filename": "docs/source/en/_toctree.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/docs%2Fsource%2Fen%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/docs%2Fsource%2Fen%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2F_toctree.yml?ref=1e3ddcb2d0380d0d909a44edc217dff68956ec5e",
            "patch": "@@ -505,7 +505,7 @@\n       - local: model_doc/mobilebert\n         title: MobileBERT\n       - local: model_doc/modernbert\n-        title: ModernBert\n+        title: ModernBERT\n       - local: model_doc/mpnet\n         title: MPNet\n       - local: model_doc/mpt"
        },
        {
            "sha": "e90f34a903e49bae8ad773b1e7b1865b3b0d9fe5",
            "filename": "docs/source/en/model_doc/modernbert.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/docs%2Fsource%2Fen%2Fmodel_doc%2Fmodernbert.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/docs%2Fsource%2Fen%2Fmodel_doc%2Fmodernbert.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmodel_doc%2Fmodernbert.md?ref=1e3ddcb2d0380d0d909a44edc217dff68956ec5e",
            "patch": "@@ -14,7 +14,7 @@ rendered properly in your Markdown viewer.\n \n -->\n \n-# ModernBert\n+# ModernBERT\n \n <div class=\"flex flex-wrap space-x-1\">\n <a href=\"https://huggingface.co/models?filter=modernbert\">\n@@ -27,7 +27,7 @@ rendered properly in your Markdown viewer.\n \n ## Overview\n \n-The ModernBert model was proposed in [Smarter, Better, Faster, Longer: A Modern Bidirectional Encoder for Fast, Memory Efficient, and Long Context Finetuning and Inference](https://arxiv.org/abs/2412.13663) by Benjamin Warner, Antoine Chaffin, Benjamin Clavié, Orion Weller, Oskar Hallström, Said Taghadouini, Alexis Galalgher, Raja Bisas, Faisal Ladhak, Tom Aarsen, Nathan Cooper, Grifin Adams, Jeremy Howard and Iacopo Poli.\n+The ModernBERT model was proposed in [Smarter, Better, Faster, Longer: A Modern Bidirectional Encoder for Fast, Memory Efficient, and Long Context Finetuning and Inference](https://arxiv.org/abs/2412.13663) by Benjamin Warner, Antoine Chaffin, Benjamin Clavié, Orion Weller, Oskar Hallström, Said Taghadouini, Alexis Galalgher, Raja Bisas, Faisal Ladhak, Tom Aarsen, Nathan Cooper, Grifin Adams, Jeremy Howard and Iacopo Poli.\n \n It is a refresh of the traditional encoder architecture, as used in previous models such as [BERT](https://huggingface.co/docs/transformers/en/model_doc/bert) and [RoBERTa](https://huggingface.co/docs/transformers/en/model_doc/roberta). \n "
        },
        {
            "sha": "cc0295c25b55d7e5ac431b83c0d5c0b4fdf9762b",
            "filename": "src/transformers/models/modernbert/configuration_modernbert.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fconfiguration_modernbert.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fconfiguration_modernbert.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fconfiguration_modernbert.py?ref=1e3ddcb2d0380d0d909a44edc217dff68956ec5e",
            "patch": "@@ -109,6 +109,9 @@ class ModernBertConfig(PretrainedConfig):\n             the model will be compiled if 1) `triton` is installed, 2) the model is not on MPS, 3) the model is not\n             shared between devices, and 4) the model is not resized after initialization. If `True`, then the model may\n             be faster in some scenarios.\n+        repad_logits_with_grad (`bool`, *optional*, defaults to `False`):\n+            When True, ModernBertForMaskedLM keeps track of the logits' gradient when repadding for output. This only\n+            applies when using Flash Attention 2 with passed labels. Otherwise output logits always have a gradient.\n \n     Examples:\n \n@@ -164,6 +167,7 @@ def __init__(\n         sparse_prediction=False,\n         sparse_pred_ignore_index=-100,\n         reference_compile=None,\n+        repad_logits_with_grad=False,\n         **kwargs,\n     ):\n         super().__init__(\n@@ -203,6 +207,7 @@ def __init__(\n         self.sparse_prediction = sparse_prediction\n         self.sparse_pred_ignore_index = sparse_pred_ignore_index\n         self.reference_compile = reference_compile\n+        self.repad_logits_with_grad = repad_logits_with_grad\n \n         if self.classifier_pooling not in [\"cls\", \"mean\"]:\n             raise ValueError("
        },
        {
            "sha": "9d145de98499368b9afdf49e0556b813c42acf12",
            "filename": "src/transformers/models/modernbert/modeling_modernbert.py",
            "status": "modified",
            "additions": 20,
            "deletions": 8,
            "changes": 28,
            "blob_url": "https://github.com/huggingface/transformers/blob/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fmodeling_modernbert.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fmodeling_modernbert.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fmodeling_modernbert.py?ref=1e3ddcb2d0380d0d909a44edc217dff68956ec5e",
            "patch": "@@ -20,6 +20,7 @@\n # limitations under the License.\n \n import math\n+from contextlib import nullcontext\n from typing import Dict, Optional, Tuple, Union\n \n import torch\n@@ -632,12 +633,14 @@ def _autoset_attn_implementation(\n     ):\n         # If the user didn't specify anything, try to use flash_attention_2 if available.\n         # Otherwise we fall back to the default SDPA -> Eager from the super() method.\n+        # ModernBert's FA2 implementation correctly handles non-fp16/bf16 dtypes, we don't\n+        # need the FA2 warning for non-fp16/bf16 dtypes so we set fp16 for the FA2 check.\n         if config._attn_implementation_internal is None:\n             config._attn_implementation_internal = \"flash_attention_2\"\n             try:\n                 return cls._check_and_enable_flash_attn_2(\n                     config,\n-                    torch_dtype=torch_dtype,\n+                    torch_dtype=torch.float16,\n                     device_map=device_map,\n                     hard_check_only=False,\n                     check_device_map=check_device_map,\n@@ -647,7 +650,7 @@ def _autoset_attn_implementation(\n         return super()._autoset_attn_implementation(\n             config,\n             use_flash_attention_2=use_flash_attention_2,\n-            torch_dtype=torch_dtype,\n+            torch_dtype=torch.float16,\n             device_map=device_map,\n             check_device_map=check_device_map,\n         )\n@@ -672,6 +675,14 @@ def _maybe_set_compile(self):\n                 )\n             self.config.reference_compile = False\n \n+        if self.device.type == \"cpu\":\n+            if self.config.reference_compile:\n+                logger.warning_once(\n+                    \"Compiling the model with `torch.compile` and using a `torch.cpu` device is not supported. \"\n+                    \"Falling back to non-compiled mode.\"\n+                )\n+            self.config.reference_compile = False\n+\n         if self.config.reference_compile is None:\n             self.config.reference_compile = is_triton_available()\n \n@@ -763,8 +774,8 @@ def _pad_modernbert_output(\n MODERNBERT_INPUTS_DOCSTRING = r\"\"\"\n     Args:\n         input_ids (`torch.LongTensor` of shape `(batch_size, sequence_length)`):\n-            Indices of input sequence tokens in the vocabulary. Padding will be ignored by default should you provide\n-            it.\n+            Indices of input sequence tokens in the vocabulary. With Flash Attention 2.0, padding will be ignored\n+            by default should you provide it.\n \n             Indices can be obtained using [`AutoTokenizer`]. See [`PreTrainedTokenizer.encode`] and\n             [`PreTrainedTokenizer.__call__`] for details.\n@@ -790,7 +801,7 @@ def _pad_modernbert_output(\n         sliding_window_mask (`torch.Tensor` of shape `(batch_size, sequence_length)`, *optional*):\n             Mask to avoid performing attention on padding or far-away tokens. In ModernBert, only every few layers\n             perform global attention, while the rest perform local attention. This mask is used to avoid attending to\n-            far-away tokens in the local attention layers.\n+            far-away tokens in the local attention layers when not using Flash Attention.\n         position_ids (`torch.LongTensor` of shape `(batch_size, sequence_length)`, *optional*):\n             Indices of positions of each input sequence tokens in the position embeddings. Selected in the range `[0,\n             config.n_positions - 1]`.\n@@ -805,11 +816,11 @@ def _pad_modernbert_output(\n         cu_seqlens (`torch.Tensor` of shape `(batch + 1,)`, *optional*):\n             Cumulative sequence lengths of the input sequences. Used to index the unpadded tensors.\n         max_seqlen (`int`, *optional*):\n-            Maximum sequence length in the batch. Used to pad the output tensors.\n+            Maximum sequence length in the batch excluding padding tokens. Used to unpad input_ids and pad output tensors.\n         batch_size (`int`, *optional*):\n             Batch size of the input sequences. Used to pad the output tensors.\n         seq_len (`int`, *optional*):\n-            Sequence length of the input sequences. Used to pad the output tensors.\n+            Sequence length of the input sequences including padding tokens. Used to pad the output tensors.\n         output_attentions (`bool`, *optional*):\n             Whether or not to return the attentions tensors of all attention layers. See `attentions` under returned\n             tensors for more detail.\n@@ -1128,8 +1139,9 @@ def forward(\n             loss = self.loss_function(logits, labels, vocab_size=self.config.vocab_size)\n \n         if self.config._attn_implementation == \"flash_attention_2\":\n-            with torch.no_grad():\n+            with nullcontext() if self.config.repad_logits_with_grad or labels is None else torch.no_grad():\n                 logits = _pad_modernbert_output(inputs=logits, indices=indices, batch=batch_size, seqlen=seq_len)\n+\n         if not return_dict:\n             output = (logits,)\n             return ((loss,) + output) if loss is not None else output"
        },
        {
            "sha": "05821973b14727e5d83e30b02f8cc068ae8dfa40",
            "filename": "src/transformers/models/modernbert/modular_modernbert.py",
            "status": "modified",
            "additions": 25,
            "deletions": 8,
            "changes": 33,
            "blob_url": "https://github.com/huggingface/transformers/blob/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fmodular_modernbert.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1e3ddcb2d0380d0d909a44edc217dff68956ec5e/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fmodular_modernbert.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fmodernbert%2Fmodular_modernbert.py?ref=1e3ddcb2d0380d0d909a44edc217dff68956ec5e",
            "patch": "@@ -14,6 +14,7 @@\n # limitations under the License.\n \n import math\n+from contextlib import nullcontext\n from typing import Dict, Literal, Optional, Tuple, Union\n \n import torch\n@@ -141,6 +142,9 @@ class ModernBertConfig(PretrainedConfig):\n             the model will be compiled if 1) `triton` is installed, 2) the model is not on MPS, 3) the model is not\n             shared between devices, and 4) the model is not resized after initialization. If `True`, then the model may\n             be faster in some scenarios.\n+        repad_logits_with_grad (`bool`, *optional*, defaults to `False`):\n+            When True, ModernBertForMaskedLM keeps track of the logits' gradient when repadding for output. This only\n+            applies when using Flash Attention 2 with passed labels. Otherwise output logits always have a gradient.\n \n     Examples:\n \n@@ -196,6 +200,7 @@ def __init__(\n         sparse_prediction=False,\n         sparse_pred_ignore_index=-100,\n         reference_compile=None,\n+        repad_logits_with_grad=False,\n         **kwargs,\n     ):\n         super().__init__(\n@@ -235,6 +240,7 @@ def __init__(\n         self.sparse_prediction = sparse_prediction\n         self.sparse_pred_ignore_index = sparse_pred_ignore_index\n         self.reference_compile = reference_compile\n+        self.repad_logits_with_grad = repad_logits_with_grad\n \n         if self.classifier_pooling not in [\"cls\", \"mean\"]:\n             raise ValueError(\n@@ -857,12 +863,14 @@ def _autoset_attn_implementation(\n     ):\n         # If the user didn't specify anything, try to use flash_attention_2 if available.\n         # Otherwise we fall back to the default SDPA -> Eager from the super() method.\n+        # ModernBert's FA2 implementation correctly handles non-fp16/bf16 dtypes, we don't\n+        # need the FA2 warning for non-fp16/bf16 dtypes so we set fp16 for the FA2 check.\n         if config._attn_implementation_internal is None:\n             config._attn_implementation_internal = \"flash_attention_2\"\n             try:\n                 return cls._check_and_enable_flash_attn_2(\n                     config,\n-                    torch_dtype=torch_dtype,\n+                    torch_dtype=torch.float16,\n                     device_map=device_map,\n                     hard_check_only=False,\n                     check_device_map=check_device_map,\n@@ -872,7 +880,7 @@ def _autoset_attn_implementation(\n         return super()._autoset_attn_implementation(\n             config,\n             use_flash_attention_2=use_flash_attention_2,\n-            torch_dtype=torch_dtype,\n+            torch_dtype=torch.float16,\n             device_map=device_map,\n             check_device_map=check_device_map,\n         )\n@@ -897,6 +905,14 @@ def _maybe_set_compile(self):\n                 )\n             self.config.reference_compile = False\n \n+        if self.device.type == \"cpu\":\n+            if self.config.reference_compile:\n+                logger.warning_once(\n+                    \"Compiling the model with `torch.compile` and using a `torch.cpu` device is not supported. \"\n+                    \"Falling back to non-compiled mode.\"\n+                )\n+            self.config.reference_compile = False\n+\n         if self.config.reference_compile is None:\n             self.config.reference_compile = is_triton_available()\n \n@@ -916,8 +932,8 @@ def resize_token_embeddings(self, *args, **kwargs):\n MODERNBERT_INPUTS_DOCSTRING = r\"\"\"\n     Args:\n         input_ids (`torch.LongTensor` of shape `(batch_size, sequence_length)`):\n-            Indices of input sequence tokens in the vocabulary. Padding will be ignored by default should you provide\n-            it.\n+            Indices of input sequence tokens in the vocabulary. With Flash Attention 2.0, padding will be ignored\n+            by default should you provide it.\n \n             Indices can be obtained using [`AutoTokenizer`]. See [`PreTrainedTokenizer.encode`] and\n             [`PreTrainedTokenizer.__call__`] for details.\n@@ -943,7 +959,7 @@ def resize_token_embeddings(self, *args, **kwargs):\n         sliding_window_mask (`torch.Tensor` of shape `(batch_size, sequence_length)`, *optional*):\n             Mask to avoid performing attention on padding or far-away tokens. In ModernBert, only every few layers\n             perform global attention, while the rest perform local attention. This mask is used to avoid attending to\n-            far-away tokens in the local attention layers.\n+            far-away tokens in the local attention layers when not using Flash Attention.\n         position_ids (`torch.LongTensor` of shape `(batch_size, sequence_length)`, *optional*):\n             Indices of positions of each input sequence tokens in the position embeddings. Selected in the range `[0,\n             config.n_positions - 1]`.\n@@ -958,11 +974,11 @@ def resize_token_embeddings(self, *args, **kwargs):\n         cu_seqlens (`torch.Tensor` of shape `(batch + 1,)`, *optional*):\n             Cumulative sequence lengths of the input sequences. Used to index the unpadded tensors.\n         max_seqlen (`int`, *optional*):\n-            Maximum sequence length in the batch. Used to pad the output tensors.\n+            Maximum sequence length in the batch excluding padding tokens. Used to unpad input_ids and pad output tensors.\n         batch_size (`int`, *optional*):\n             Batch size of the input sequences. Used to pad the output tensors.\n         seq_len (`int`, *optional*):\n-            Sequence length of the input sequences. Used to pad the output tensors.\n+            Sequence length of the input sequences including padding tokens. Used to pad the output tensors.\n         output_attentions (`bool`, *optional*):\n             Whether or not to return the attentions tensors of all attention layers. See `attentions` under returned\n             tensors for more detail.\n@@ -1281,8 +1297,9 @@ def forward(\n             loss = self.loss_function(logits, labels, vocab_size=self.config.vocab_size)\n \n         if self.config._attn_implementation == \"flash_attention_2\":\n-            with torch.no_grad():\n+            with nullcontext() if self.config.repad_logits_with_grad or labels is None else torch.no_grad():\n                 logits = _pad_modernbert_output(inputs=logits, indices=indices, batch=batch_size, seqlen=seq_len)\n+\n         if not return_dict:\n             output = (logits,)\n             return ((loss,) + output) if loss is not None else output"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 53,
        "deletions": 19
    }
}