{
    "author": "jeffhataws",
    "message": "Fix ValueError when eval_do_concat_batches=False with examples (#37621)\n\nhttps://github.com/huggingface/transformers/issues/37593\n\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>",
    "sha": "964a1b6b7de8a83414917b5344f85d79bb0be808",
    "files": [
        {
            "sha": "e152cd9911d55fc2b787b9fae00ebcb4b1855e67",
            "filename": "examples/pytorch/text-classification/run_glue.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/964a1b6b7de8a83414917b5344f85d79bb0be808/examples%2Fpytorch%2Ftext-classification%2Frun_glue.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/964a1b6b7de8a83414917b5344f85d79bb0be808/examples%2Fpytorch%2Ftext-classification%2Frun_glue.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/examples%2Fpytorch%2Ftext-classification%2Frun_glue.py?ref=964a1b6b7de8a83414917b5344f85d79bb0be808",
            "patch": "@@ -508,8 +508,12 @@ def preprocess_function(examples):\n     # predictions and label_ids field) and has to return a dictionary string to float.\n     def compute_metrics(p: EvalPrediction):\n         preds = p.predictions[0] if isinstance(p.predictions, tuple) else p.predictions\n+        labels = p.label_ids\n+        if not training_args.eval_do_concat_batches:\n+            preds = np.concatenate(preds, axis=0)\n+            labels = np.concatenate(p.label_ids, axis=0)\n         preds = np.squeeze(preds) if is_regression else np.argmax(preds, axis=1)\n-        result = metric.compute(predictions=preds, references=p.label_ids)\n+        result = metric.compute(predictions=preds, references=labels)\n         if len(result) > 1:\n             result[\"combined_score\"] = np.mean(list(result.values())).item()\n         return result"
        },
        {
            "sha": "28c344de27e83495da8af1b5ea7b3fe41495a91f",
            "filename": "examples/pytorch/token-classification/run_ner.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/964a1b6b7de8a83414917b5344f85d79bb0be808/examples%2Fpytorch%2Ftoken-classification%2Frun_ner.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/964a1b6b7de8a83414917b5344f85d79bb0be808/examples%2Fpytorch%2Ftoken-classification%2Frun_ner.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/examples%2Fpytorch%2Ftoken-classification%2Frun_ner.py?ref=964a1b6b7de8a83414917b5344f85d79bb0be808",
            "patch": "@@ -529,6 +529,9 @@ def tokenize_and_align_labels(examples):\n \n     def compute_metrics(p):\n         predictions, labels = p\n+        if not training_args.eval_do_concat_batches:\n+            predictions = np.hstack(predictions)\n+            labels = np.hstack(labels)\n         predictions = np.argmax(predictions, axis=2)\n \n         # Remove ignored index (special tokens)"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 8,
        "deletions": 1
    }
}