{
    "author": "abdokaseb",
    "message": "Fix `continue_final_message` in `apply_chat_template` to prevent substring matching issues (#40732)\n\n* Fix continue_final_message parameter in apply_chat_template\n\n* after run fixup\n\n* Handle trim in the template\n\n* after fixup\n\n* Update src/transformers/utils/chat_template_utils.py\n\n---------\n\nCo-authored-by: Matt <Rocketknight1@users.noreply.github.com>",
    "sha": "5a468e56b7c04ffe2e4acd4ba0e1b64325e3b83e",
    "files": [
        {
            "sha": "36018c19ccc671d7aad1915bfa0e0a91ce0abe49",
            "filename": "src/transformers/utils/chat_template_utils.py",
            "status": "modified",
            "additions": 26,
            "deletions": 17,
            "changes": 43,
            "blob_url": "https://github.com/huggingface/transformers/blob/5a468e56b7c04ffe2e4acd4ba0e1b64325e3b83e/src%2Ftransformers%2Futils%2Fchat_template_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5a468e56b7c04ffe2e4acd4ba0e1b64325e3b83e/src%2Ftransformers%2Futils%2Fchat_template_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fchat_template_utils.py?ref=5a468e56b7c04ffe2e4acd4ba0e1b64325e3b83e",
            "patch": "@@ -17,6 +17,7 @@\n import re\n import types\n from contextlib import contextmanager\n+from copy import deepcopy\n from datetime import datetime\n from functools import lru_cache\n from inspect import isfunction\n@@ -503,10 +504,27 @@ def render_jinja_template(\n \n     rendered = []\n     all_generation_indices = []\n+    continue_final_message_tag = \"CONTINUE_FINAL_MESSAGE_TAG \"\n     for chat in conversations:\n         if hasattr(chat, \"messages\"):\n             # Indicates it's a Conversation object\n             chat = chat.messages\n+        if continue_final_message:\n+            chat = deepcopy(chat)\n+            final_message = chat[-1][\"content\"]\n+            if isinstance(final_message, (list, tuple)):\n+                for content_block in reversed(final_message):\n+                    if \"text\" in content_block:\n+                        # Pick the last text block in the message (the first one we hit while iterating in reverse)\n+                        final_message = content_block[\"text\"]\n+                        content_block[\"text\"] = content_block[\"text\"] + continue_final_message_tag\n+                        break\n+                else:\n+                    raise ValueError(\n+                        \"continue_final_message is set but we could not find any text to continue in the final message!\"\n+                    )\n+            else:\n+                chat[-1][\"content\"] = chat[-1][\"content\"] + continue_final_message_tag\n         if return_assistant_tokens_mask:\n             rendered_chat, generation_indices = _render_with_assistant_indices(\n                 compiled_template=compiled_template,\n@@ -526,31 +544,22 @@ def render_jinja_template(\n                 **kwargs,\n             )\n         if continue_final_message:\n-            final_message = chat[-1][\"content\"]\n-            if isinstance(final_message, (list, tuple)):\n-                for content_block in reversed(final_message):\n-                    if \"text\" in content_block:\n-                        # Pick the last text block in the message (the first one we hit while iterating in reverse)\n-                        final_message = content_block[\"text\"]\n-                        break\n-                else:\n-                    raise ValueError(\n-                        \"continue_final_message is set but we could not find any text to continuein the final message!\"\n-                    )\n-            if final_message.strip() not in rendered_chat:\n+            if (final_message.strip() not in rendered_chat) or (\n+                continue_final_message_tag.strip() not in rendered_chat\n+            ):\n                 raise ValueError(\n                     \"continue_final_message is set but the final message does not appear in the chat after \"\n                     \"applying the chat template! This can happen if the chat template deletes portions of \"\n                     \"the final message. Please verify the chat template and final message in your chat to \"\n                     \"ensure they are compatible.\"\n                 )\n-            final_msg_loc = rendered_chat.rindex(final_message.strip())\n-            if rendered_chat[final_msg_loc : final_msg_loc + len(final_message.lstrip())] == final_message:\n-                # The template preserves spacing or the message doesn't have trailing spacing, so things are simple\n-                rendered_chat = rendered_chat[: final_msg_loc + len(final_message.lstrip())]\n+            tag_loc = rendered_chat.rindex(continue_final_message_tag.strip())\n+            if rendered_chat[tag_loc : tag_loc + len(continue_final_message_tag)] == continue_final_message_tag:\n+                # The template preserves spacing, so things are simple\n+                rendered_chat = rendered_chat[:tag_loc]\n             else:\n                 # The message has trailing spacing that was trimmed, so we must be more cautious\n-                rendered_chat = rendered_chat[: final_msg_loc + len(final_message.strip())]\n+                rendered_chat = rendered_chat[:tag_loc].rstrip()\n         rendered.append(rendered_chat)\n \n     return rendered, all_generation_indices"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 26,
        "deletions": 17
    }
}