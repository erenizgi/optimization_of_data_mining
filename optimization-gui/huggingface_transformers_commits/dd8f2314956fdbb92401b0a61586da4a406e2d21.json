{
    "author": "kaixuanliu",
    "message": "fix 3 failed test cases for video_llama_3 model on Intel XPU (#41931)\n\n* fix 3 failed test cases for video_llama_3 model on Intel XPU\n\nSigned-off-by: Liu, Kaixuan <kaixuan.liu@intel.com>\n\n* update\n\nSigned-off-by: Liu, Kaixuan <kaixuan.liu@intel.com>\n\n* adjust format\n\nSigned-off-by: Liu, Kaixuan <kaixuan.liu@intel.com>\n\n* update code\n\nSigned-off-by: Liu, Kaixuan <kaixuan.liu@intel.com>\n\n---------\n\nSigned-off-by: Liu, Kaixuan <kaixuan.liu@intel.com>",
    "sha": "dd8f2314956fdbb92401b0a61586da4a406e2d21",
    "files": [
        {
            "sha": "0a6ba10898d89c87aaa28e9abbb365d9c1cc3ccc",
            "filename": "tests/models/video_llama_3/test_modeling_video_llama_3.py",
            "status": "modified",
            "additions": 23,
            "deletions": 5,
            "changes": 28,
            "blob_url": "https://github.com/huggingface/transformers/blob/dd8f2314956fdbb92401b0a61586da4a406e2d21/tests%2Fmodels%2Fvideo_llama_3%2Ftest_modeling_video_llama_3.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/dd8f2314956fdbb92401b0a61586da4a406e2d21/tests%2Fmodels%2Fvideo_llama_3%2Ftest_modeling_video_llama_3.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fvideo_llama_3%2Ftest_modeling_video_llama_3.py?ref=dd8f2314956fdbb92401b0a61586da4a406e2d21",
            "patch": "@@ -36,6 +36,7 @@\n     is_torch_available,\n )\n from transformers.testing_utils import (\n+    Expectations,\n     backend_empty_cache,\n     require_flash_attn,\n     require_torch,\n@@ -831,7 +832,14 @@ def test_small_model_integration_test(self):\n         torch.testing.assert_close(expected_pixel_slice, inputs.pixel_values[:6, :3], atol=1e-4, rtol=1e-4)\n \n         output = model.generate(**inputs, max_new_tokens=20, do_sample=False, repetition_penalty=None)\n-        EXPECTED_DECODED_TEXT = \"user\\n\\nDescribe the image.\\nassistant\\nThe image captures a vibrant nighttime scene on a bustling city street. A woman in a striking red dress\"\n+        # fmt: off\n+        EXPECTED_DECODED_TEXT = Expectations(\n+            {\n+                (\"cuda\", None): \"user\\n\\nDescribe the image.\\nassistant\\nThe image captures a vibrant nighttime scene on a bustling city street. A woman in a striking red dress\",\n+                (\"xpu\", None): \"user\\n\\nDescribe the image.\\nassistant\\nThe image captures a vibrant night scene in a bustling Japanese city. A woman in a striking red dress\",\n+            }\n+        ).get_expectation()\n+        # fmt: on\n \n         self.assertEqual(\n             self.processor.decode(output[0], skip_special_tokens=True),\n@@ -874,11 +882,21 @@ def test_small_model_integration_test_batch_wo_image(self):\n \n         # it should not matter whether two images are the same size or not\n         output = model.generate(**inputs, max_new_tokens=20, do_sample=False, repetition_penalty=None)\n+        # fmt: off\n+        EXPECTED_DECODED_TEXT = Expectations(\n+            {\n+                (\"cuda\", None): [\n+                    \"user\\n\\nDescribe the image.\\nassistant\\nThe image captures a vibrant nighttime scene on a bustling city street. A woman in a striking red dress\",\n+                    \"user\\nWhat is relativity?\\nassistant\\nRelativity is a scientific theory that describes the relationship between space and time. It was first proposed by\",\n+                ],\n+                (\"xpu\", None): [\n+                    \"user\\n\\nDescribe the image.\\nassistant\\nThe image captures a vibrant night scene in a bustling Japanese city. A woman in a striking red dress\",\n+                    \"user\\nWhat is relativity?\\nassistant\\nRelativity is a scientific theory that describes the relationship between space and time. It was first proposed by\",\n+                ],\n+            }\n+        ).get_expectation()\n+        # fmt: on\n \n-        EXPECTED_DECODED_TEXT = [\n-            \"user\\n\\nDescribe the image.\\nassistant\\nThe image captures a vibrant nighttime scene on a bustling city street. A woman in a striking red dress\",\n-            \"user\\nWhat is relativity?\\nassistant\\nRelativity is a scientific theory that describes the relationship between space and time. It was first proposed by\",\n-        ]  # fmt: skip\n         self.assertEqual(\n             self.processor.batch_decode(output, skip_special_tokens=True),\n             EXPECTED_DECODED_TEXT,"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 23,
        "deletions": 5
    }
}