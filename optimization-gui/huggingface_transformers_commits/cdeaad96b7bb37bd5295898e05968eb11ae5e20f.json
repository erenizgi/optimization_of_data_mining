{
    "author": "sbucaille",
    "message": "[superglue] Fixed the way batch mask was applied to the scores before match assignment computation (#39968)\n\nfix: mask filling to score was wrong",
    "sha": "cdeaad96b7bb37bd5295898e05968eb11ae5e20f",
    "files": [
        {
            "sha": "60cb52c7e89b28f7e6c98a00c03b2e9a8ee1a965",
            "filename": "src/transformers/models/superglue/modeling_superglue.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/cdeaad96b7bb37bd5295898e05968eb11ae5e20f/src%2Ftransformers%2Fmodels%2Fsuperglue%2Fmodeling_superglue.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/cdeaad96b7bb37bd5295898e05968eb11ae5e20f/src%2Ftransformers%2Fmodels%2Fsuperglue%2Fmodeling_superglue.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fsuperglue%2Fmodeling_superglue.py?ref=cdeaad96b7bb37bd5295898e05968eb11ae5e20f",
            "patch": "@@ -676,8 +676,10 @@ def _match_image_pair(\n \n         if mask is not None:\n             mask = mask.reshape(batch_size, 2, num_keypoints)\n-            mask0 = mask[:, 0].unsqueeze(-1).expand(-1, -1, num_keypoints)\n-            scores = scores.masked_fill(mask0 == 0, -1e9)\n+            mask0 = mask[:, 0].unsqueeze(2)\n+            mask1 = mask[:, 1].unsqueeze(1)\n+            mask = torch.logical_and(mask0, mask1)\n+            scores = scores.masked_fill(mask == 0, torch.finfo(scores.dtype).min)\n \n         # Run the optimal transport.\n         scores = log_optimal_transport(scores, self.bin_score, iterations=self.config.sinkhorn_iterations)"
        },
        {
            "sha": "daafbef62b3a8bb23a858ecae673309702185f6f",
            "filename": "tests/models/superglue/test_modeling_superglue.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/cdeaad96b7bb37bd5295898e05968eb11ae5e20f/tests%2Fmodels%2Fsuperglue%2Ftest_modeling_superglue.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/cdeaad96b7bb37bd5295898e05968eb11ae5e20f/tests%2Fmodels%2Fsuperglue%2Ftest_modeling_superglue.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fsuperglue%2Ftest_modeling_superglue.py?ref=cdeaad96b7bb37bd5295898e05968eb11ae5e20f",
            "patch": "@@ -423,3 +423,5 @@ def test_inference(self):\n             torch.sum(~torch.isclose(predicted_matching_scores_values, expected_matching_scores_values, atol=1e-2)) < 4\n         )\n         self.assertTrue(torch.sum(predicted_matches_values != expected_matches_values) < 4)\n+        self.assertTrue(torch.all(outputs.matches[0, 1] < torch.sum(outputs.mask[0, 0])))\n+        self.assertTrue(torch.all(outputs.matches[0, 0] < torch.sum(outputs.mask[0, 1])))"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 6,
        "deletions": 2
    }
}