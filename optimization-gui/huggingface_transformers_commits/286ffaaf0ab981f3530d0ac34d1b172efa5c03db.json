{
    "author": "BenjaminBossan",
    "message": "[CI] Skip EETQ tests while package is broken with latest transformers (#34854)\n\n* CI Skip EETQ tests while package is broken\r\n\r\nEETQ tries to import the shard_checkpoint function from transformers but\r\nthe function has been removed. Therefore, trying to use EETQ currently\r\nresults in an import error. This fix results in EETQ tests being skipped\r\nif there is an import error.\r\n\r\nThe issue has been reported to EETQ:\r\n\r\nhttps://github.com/NetEase-FuXi/EETQ/issues/34\r\n\r\n* Raise helpful error when trying to use eetq\r\n\r\n* Forget to raise the error in else clause",
    "sha": "286ffaaf0ab981f3530d0ac34d1b172efa5c03db",
    "files": [
        {
            "sha": "7dfce75c373ad7c1411e99f0d3536bc0c475bfd1",
            "filename": "src/transformers/quantizers/quantizer_eetq.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/huggingface/transformers/blob/286ffaaf0ab981f3530d0ac34d1b172efa5c03db/src%2Ftransformers%2Fquantizers%2Fquantizer_eetq.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/286ffaaf0ab981f3530d0ac34d1b172efa5c03db/src%2Ftransformers%2Fquantizers%2Fquantizer_eetq.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fquantizers%2Fquantizer_eetq.py?ref=286ffaaf0ab981f3530d0ac34d1b172efa5c03db",
            "patch": "@@ -53,6 +53,20 @@ def validate_environment(self, *args, **kwargs):\n                 \"Please install the latest version of eetq from : https://github.com/NetEase-FuXi/EETQ\"\n             )\n \n+        try:\n+            import eetq  # noqa: F401\n+        except ImportError as exc:\n+            if \"shard_checkpoint\" in str(exc):\n+                # EETQ 1.0.0 is currently broken with the latest transformers because it tries to import the removed\n+                # shard_checkpoint function, see https://github.com/NetEase-FuXi/EETQ/issues/34.\n+                # TODO: Update message once eetq releases a fix\n+                raise ImportError(\n+                    \"You are using a version of EETQ that is incompatible with the current transformers version. \"\n+                    \"Either downgrade transformers to <= v4.46.3 or, if available, upgrade EETQ to > v1.0.0.\"\n+                ) from exc\n+            else:\n+                raise\n+\n         if not is_accelerate_available():\n             raise ImportError(\"Loading an EETQ quantized model requires accelerate (`pip install accelerate`)\")\n "
        },
        {
            "sha": "25d837ccec0fbec4f0dfdba49036a55e32756773",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/286ffaaf0ab981f3530d0ac34d1b172efa5c03db/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/286ffaaf0ab981f3530d0ac34d1b172efa5c03db/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=286ffaaf0ab981f3530d0ac34d1b172efa5c03db",
            "patch": "@@ -1143,7 +1143,17 @@ def require_eetq(test_case):\n     \"\"\"\n     Decorator marking a test that requires eetq\n     \"\"\"\n-    return unittest.skipUnless(is_eetq_available(), \"test requires eetq\")(test_case)\n+    eetq_available = is_eetq_available()\n+    if eetq_available:\n+        try:\n+            import eetq  # noqa: F401\n+        except ImportError as exc:\n+            if \"shard_checkpoint\" in str(exc):\n+                # EETQ 1.0.0 is currently broken with the latest transformers because it tries to import the removed\n+                # shard_checkpoint function, see https://github.com/NetEase-FuXi/EETQ/issues/34.\n+                # TODO: Remove once eetq releases a fix and this release is used in CI\n+                eetq_available = False\n+    return unittest.skipUnless(eetq_available, \"test requires eetq\")(test_case)\n \n \n def require_av(test_case):"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 25,
        "deletions": 1
    }
}