{
    "author": "Yacklin",
    "message": "rewrite _process_parameter_type in auto_docstring.py to improve usability (#42431)\n\n* rewrite to improve its usability\n\n* rewrite to improve its usability\n\n* Clarify comment about function parameter elements\n\n* Update implementation of _process_parameter_type\n\n* rewrite to improve its usability\n\n* Clarify comment about function parameter elements\n\n* reformat it a little bit\n\n* reformat it a little bit\n\n* used a wrong ruff version..... this one should be good\n\n* update the string manipulation\n\n* Trying for more consistency\n\n* make fixup\n\n* Try another approach\n\n* Don't include \"None\" in the out_str when we're already setting optional\n\n* Add some new-style types to GPT-J to see what happens\n\n* Correct use of UnionType\n\n* make fixup\n\n* Add a little snarky comment about typing just because\n\n* Correctly return the same strings as the old function\n\n* Drop unnecessary args\n\n* Remove redundant args information\n\n* add one more elif statement to deal with the case when type hint is None\n\n* add if statement to handle the parameter with default value\n\n* Revert GPT-J changes\n\n* Trigger tests\n\n---------\n\nCo-authored-by: Matt <Rocketknight1@users.noreply.github.com>\nCo-authored-by: Matt <rocketknight1@gmail.com>",
    "sha": "728f34c3c31cde2b6015b8368fa5c1a71eaec8a6",
    "files": [
        {
            "sha": "2f435189c2194f0afe4174ae3a631d0c4b4b5b6f",
            "filename": "src/transformers/utils/auto_docstring.py",
            "status": "modified",
            "additions": 34,
            "deletions": 25,
            "changes": 59,
            "blob_url": "https://github.com/huggingface/transformers/blob/728f34c3c31cde2b6015b8368fa5c1a71eaec8a6/src%2Ftransformers%2Futils%2Fauto_docstring.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/728f34c3c31cde2b6015b8368fa5c1a71eaec8a6/src%2Ftransformers%2Futils%2Fauto_docstring.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fauto_docstring.py?ref=728f34c3c31cde2b6015b8368fa5c1a71eaec8a6",
            "patch": "@@ -17,7 +17,8 @@\n import os\n import textwrap\n from pathlib import Path\n-from typing import get_args\n+from types import UnionType\n+from typing import Union, get_args, get_origin\n \n import regex as re\n \n@@ -1280,38 +1281,46 @@ def _get_model_info(func, parent_class):\n     return model_name_lowercase, class_name, config_class\n \n \n-def _process_parameter_type(param, param_name, func):\n+def _process_parameter_type(param):\n     \"\"\"\n     Process and format a parameter's type annotation.\n \n     Args:\n         param (`inspect.Parameter`): The parameter from the function signature\n-        param_name (`str`): The name of the parameter\n-        func (`function`): The function the parameter belongs to\n     \"\"\"\n     optional = False\n-    if param.annotation != inspect.Parameter.empty:\n-        param_type = param.annotation\n-        if \"typing\" in str(param_type):\n-            param_type = \"\".join(str(param_type).split(\"typing.\")).replace(\"transformers.\", \"~\")\n-        elif hasattr(param_type, \"__module__\"):\n-            param_type = f\"{param_type.__module__.replace('transformers.', '~').replace('builtins', '')}.{param.annotation.__name__}\"\n-            if param_type[0] == \".\":\n-                param_type = param_type[1:]\n-        else:\n-            if False:\n-                print(\n-                    f\"[ERROR] {param_type} for {param_name} of {func.__qualname__} in file {func.__code__.co_filename} has an invalid type\"\n-                )\n-        if \"ForwardRef\" in param_type:\n-            param_type = re.sub(r\"ForwardRef\\('([\\w.]+)'\\)\", r\"\\1\", param_type)\n-        if \"Optional\" in param_type:\n-            param_type = re.sub(r\"Optional\\[(.*?)\\]\", r\"\\1\", param_type)\n+    if param.annotation == inspect.Parameter.empty:\n+        return \"\", False\n+    elif param.annotation is None:\n+        return \"None\", True\n+    # This is, astonishingly, the right way to do it: https://docs.python.org/3/library/typing.html#typing.Union\n+    elif get_origin(param.annotation) is Union or get_origin(param.annotation) is UnionType:\n+        subtypes = get_args(param.annotation)\n+    else:\n+        subtypes = [param.annotation]  # Just pretend it's a single-element union so we don't need two code paths\n+    out_str = []\n+    for subtype in subtypes:\n+        if subtype is type(None):\n             optional = True\n+            continue\n+        if hasattr(subtype, \"__module__\") and hasattr(subtype, \"__name__\"):\n+            subtype = f\"{subtype.__module__.replace('transformers.', '~').replace('builtins', '').replace('typing.', '')}.{subtype.__name__}\".removeprefix(\n+                \".\"\n+            )\n+        else:\n+            subtype = str(subtype)  # Just give up\n+        if \"ForwardRef\" in subtype:\n+            subtype = re.sub(r\"ForwardRef\\('([\\w.]+)'\\)\", r\"\\1\", subtype)\n+        out_str.append(subtype)\n+\n+    if param.default is not inspect.Parameter.empty:\n+        optional = True\n+    if not out_str:\n+        return \"\", optional\n+    elif len(out_str) == 1:\n+        return out_str[0], optional\n     else:\n-        param_type = \"\"\n-\n-    return param_type, optional\n+        return f\"Union[{', '.join(out_str)}]\", optional\n \n \n def _get_parameter_info(param_name, documented_params, source_args_dict, param_type, optional):\n@@ -1392,7 +1401,7 @@ def _process_regular_parameters(\n             continue\n \n         # Process parameter type and optional status\n-        param_type, optional = _process_parameter_type(param, param_name, func)\n+        param_type, optional = _process_parameter_type(param)\n \n         # Check for default value\n         param_default = \"\""
        }
    ],
    "stats": {
        "total": 59,
        "additions": 34,
        "deletions": 25
    }
}