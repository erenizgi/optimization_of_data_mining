{
    "author": "remi-or",
    "message": "Break tie in Expectations and gemma3 fixes (#38943)\n\n* Added major / minor version to Expectations ordering\n\n* Added fixes to gemma3\n\n* Style",
    "sha": "1a96127e465b54048fe8ad5638bf0fc11ce94f39",
    "files": [
        {
            "sha": "cedfad084ccd739139d82b6157238b1337eb1d1f",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/1a96127e465b54048fe8ad5638bf0fc11ce94f39/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1a96127e465b54048fe8ad5638bf0fc11ce94f39/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=1a96127e465b54048fe8ad5638bf0fc11ce94f39",
            "patch": "@@ -3334,9 +3334,18 @@ def score(properties: DeviceProperties, other: DeviceProperties) -> float:\n \n     def find_expectation(self, properties: DeviceProperties = (None, None, None)) -> Any:\n         \"\"\"\n-        Find best matching expectation based on provided device properties.\n+        Find best matching expectation based on provided device properties. We score each expectation, and to\n+        distinguish between expectations with the same score, we use the major and minor version numbers, prioritizing\n+        most recent versions.\n         \"\"\"\n-        (result_key, result) = max(self.unpacked(), key=lambda x: Expectations.score(properties, x[0]))\n+        (result_key, result) = max(\n+            self.unpacked(),\n+            key=lambda x: (\n+                Expectations.score(properties, x[0]),  # x[0] is a device properties tuple (device_type, major, minor)\n+                x[0][1] if x[0][1] is not None else -1,  # This key is the major version, -1 if major is None\n+                x[0][2] if x[0][2] is not None else -1,  # This key is the minor version, -1 if minor is None\n+            ),\n+        )\n \n         if Expectations.score(properties, result_key) == 0:\n             raise ValueError(f\"No matching expectation found for {properties}\")"
        },
        {
            "sha": "2c4643cf6c5a7c590ec8330349cae2d800cc104b",
            "filename": "tests/models/gemma3/test_modeling_gemma3.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/1a96127e465b54048fe8ad5638bf0fc11ce94f39/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1a96127e465b54048fe8ad5638bf0fc11ce94f39/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py?ref=1a96127e465b54048fe8ad5638bf0fc11ce94f39",
            "patch": "@@ -409,6 +409,7 @@ def test_model_4b_bf16(self):\n                 (\"xpu\", 3): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water in the background. It looks like a lovely,'],\n                 (\"cuda\", 7): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water in the background. It looks like a lovely,'],\n                 (\"cuda\", 8): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach next to a turquoise ocean. It looks like a very sunny and'],\n+                (\"rocm\", (9, 5)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant coastline in the background. It looks'],\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()\n@@ -461,6 +462,11 @@ def test_model_4b_batch(self):\n                         'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach next to a turquoise ocean. It looks like a very sunny and',\n                         'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, these images are not identical. They depict very different scenes:\\n\\n*   **Image 1** shows a cow standing on a beach.',\n                     ],\n+                (\"rocm\", (9, 5)):\n+                    [\n+                        'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach next to a turquoise ocean. There are some clouds in the blue',\n+                        'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, these images are not identical. They depict very different scenes. \\n\\n*   **Image 1** shows a cow standing on a beach',\n+                    ],\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()\n@@ -558,6 +564,10 @@ def test_model_4b_batch_crops(self):\n                     'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There are clouds in the blue sky above.',\n                     'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first image shows a cow on a beach, while the second image shows a street scene with a',\n                 ],\n+                (\"rocm\", (9, 5)) : [\n+                    'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There are clouds in the blue sky above.',\n+                    'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first image shows a cow on a beach, while the second image shows a street scene with a',\n+                ],\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()\n@@ -618,6 +628,7 @@ def test_model_1b_text_only(self):\n                 (\"xpu\", 3): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a river deep,\\nWith patterns hidden, secrets sleep.\\nA neural net, a watchful eye,\\nLearning'],\n                 (\"cuda\", 7): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n                 (\"cuda\", 8): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n+                (\"rocm\", (9, 5)): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a river deep,\\nWith patterns hidden, secrets sleep.\\nA neural net, a watchful eye,\\nLearning'],\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()\n@@ -650,6 +661,7 @@ def test_model_4b_flash_attn(self):\n                 (\"xpu\", 3): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant island in the background. It looks like a sunny day'],\n                 (\"cuda\", 7): [],\n                 (\"cuda\", 8): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant island in the background. It looks like a sunny day'],\n+                (\"rocm\", (9, 5)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with a turquoise ocean and a distant island in the background. It looks like a sunny'],\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()"
        },
        {
            "sha": "c482cd43d4d32f5574e9844975b9bcbc0729b38f",
            "filename": "tests/test_modeling_common.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/1a96127e465b54048fe8ad5638bf0fc11ce94f39/tests%2Ftest_modeling_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1a96127e465b54048fe8ad5638bf0fc11ce94f39/tests%2Ftest_modeling_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_modeling_common.py?ref=1a96127e465b54048fe8ad5638bf0fc11ce94f39",
            "patch": "@@ -3801,9 +3801,9 @@ def test_sdpa_can_dispatch_on_flash(self):\n                 self.skipTest(\n                     \"PaliGemma-like models currently (transformers==4.41.0) requires an attention_mask input\"\n                 )\n-            if config.model_type in [\"modernbert\"]:\n+            if config.model_type in [\"modernbert\", \"gemma3\"]:\n                 self.skipTest(\n-                    reason=\"ModernBert currently (transformers==4.52.0) automatically adds an attention_mask input\"\n+                    reason=f\"{config.model_type} currently (transformers==4.52.0) automatically adds an attention_mask input\"\n                 )\n             if config.model_type in [\"idefics\", \"idefics2\", \"idefics3\"]:\n                 self.skipTest(reason=\"Idefics currently (transformers==4.39.1) requires an image_attention_mask input\")"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 25,
        "deletions": 4
    }
}