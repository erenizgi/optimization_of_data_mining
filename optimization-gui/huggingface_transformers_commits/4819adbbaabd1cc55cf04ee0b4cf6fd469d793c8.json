{
    "author": "qgallouedec",
    "message": "Refactor label name handling for PEFT models in Trainer class (#39265)\n\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>",
    "sha": "4819adbbaabd1cc55cf04ee0b4cf6fd469d793c8",
    "files": [
        {
            "sha": "94c3a8620cbb2313511690bff0b95b2725d0c242",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/huggingface/transformers/blob/4819adbbaabd1cc55cf04ee0b4cf6fd469d793c8/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4819adbbaabd1cc55cf04ee0b4cf6fd469d793c8/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=4819adbbaabd1cc55cf04ee0b4cf6fd469d793c8",
            "patch": "@@ -783,15 +783,17 @@ def __init__(\n         # returned to 0 every time flos need to be logged\n         self.current_flos = 0\n         self.hp_search_backend = None\n-        if _is_peft_model(self.model) and self.args.label_names is None:\n-            logger.warning(\n-                f\"No label_names provided for model class `{self.model.__class__.__name__}`.\"\n-                \" Since `PeftModel` hides base models input arguments, if label_names is not given, label_names can't be set automatically within `Trainer`.\"\n-                \" Note that empty label_names list will be used instead.\"\n-            )\n-        default_label_names = find_labels(self.model.__class__)\n+\n+        model_to_inspect = self.model\n+        if _is_peft_model(self.model):\n+            if hasattr(self.model, \"get_base_model\"):\n+                model_to_inspect = self.model.get_base_model()\n+            else:\n+                # PeftMixedModel do not provide a `get_base_model` method\n+                model_to_inspect = self.model.base_model.model\n+        default_label_names = find_labels(model_to_inspect.__class__)\n         self.label_names = default_label_names if self.args.label_names is None else self.args.label_names\n-        self.can_return_loss = can_return_loss(self.model.__class__)\n+        self.can_return_loss = can_return_loss(model_to_inspect.__class__)\n         self.control = self.callback_handler.on_init_end(self.args, self.state, self.control)\n \n         # Internal variables to help with automatic batch size reduction"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 10,
        "deletions": 8
    }
}