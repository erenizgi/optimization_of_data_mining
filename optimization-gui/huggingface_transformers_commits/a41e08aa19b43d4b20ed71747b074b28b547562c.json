{
    "author": "dvrogozh",
    "message": "tests: fix asyncio.wait() usage for python>=3.11 (#36898)\n\ntests: fix asyncio.wait() usage for python>=3.7\n\nPassing coroutings directly to `asyncio.wait()` is deprecated since\npython 3.8 and removed starting from python 3.11. Instead, it's required\nto explicitly wrap coroutine in the task with `asyncio.create_task()` which\nfirst appeared in python 3.7.\n\nWe step into this issue running the following Transformers tests on a\nsystem with python 3.11 or later (for example, Ubuntu 24.04 has python 3.12):\n\n* `tests/trainer/test_trainer_distributed.py`\n* `tests/extended/test_trainer_ext.py`\n\nThe error will be:\n```\nsrc/transformers/testing_utils.py:2380: in execute_subprocess_async\n    result = loop.run_until_complete(\n/usr/lib/python3.12/asyncio/base_events.py:687: in run_until_complete\n    return future.result()\nsrc/transformers/testing_utils.py:2368: in _stream_subprocess\n    await asyncio.wait(\n...\nE           TypeError: Passing coroutines is forbidden, use tasks explicitly.\n\n```\n\nSee: https://docs.python.org/3.10/library/asyncio-task.html#asyncio.wait\nSee: https://docs.python.org/3.10/library/asyncio-task.html#asyncio.wait\nSee: https://docs.python.org/3.7/library/asyncio-task.html#asyncio.create_task\n\nSigned-off-by: Dmitry Rogozhkin <dmitry.v.rogozhkin@intel.com>\nCo-authored-by: Yih-Dar <2521628+ydshieh@users.noreply.github.com>",
    "sha": "a41e08aa19b43d4b20ed71747b074b28b547562c",
    "files": [
        {
            "sha": "1ebdac53487f74e3c9d2fa3d3231e5aaa282757c",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/a41e08aa19b43d4b20ed71747b074b28b547562c/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a41e08aa19b43d4b20ed71747b074b28b547562c/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=a41e08aa19b43d4b20ed71747b074b28b547562c",
            "patch": "@@ -2367,8 +2367,8 @@ def tee(line, sink, pipe, label=\"\"):\n     # XXX: the timeout doesn't seem to make any difference here\n     await asyncio.wait(\n         [\n-            _read_stream(p.stdout, lambda l: tee(l, out, sys.stdout, label=\"stdout:\")),\n-            _read_stream(p.stderr, lambda l: tee(l, err, sys.stderr, label=\"stderr:\")),\n+            asyncio.create_task(_read_stream(p.stdout, lambda l: tee(l, out, sys.stdout, label=\"stdout:\"))),\n+            asyncio.create_task(_read_stream(p.stderr, lambda l: tee(l, err, sys.stderr, label=\"stderr:\"))),\n         ],\n         timeout=timeout,\n     )"
        }
    ],
    "stats": {
        "total": 4,
        "additions": 2,
        "deletions": 2
    }
}