{
    "author": "wejoncy",
    "message": "FEAT : Adding VPTQ quantization method to HFQuantizer (#34770)\n\n* init vptq\n\n* add integration\n\n* add vptq support\n\nfix readme\n\n* add tests && format\n\n* format\n\n* address comments\n\n* format\n\n* format\n\n* address comments\n\n* format\n\n* address comments\n\n* remove debug code\n\n* Revert \"remove debug code\"\n\nThis reverts commit ed3b3eaaba82caf58cb3aa6e865d98e49650cf66.\n\n* fix test\n\n---------\n\nCo-authored-by: Yang Wang <wyatuestc@gmail.com>",
    "sha": "4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
    "files": [
        {
            "sha": "3cb2acdc53bb1ac8d7fdbb36a2dff7cc98198612",
            "filename": "docker/transformers-quantization-latest-gpu/Dockerfile",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docker%2Ftransformers-quantization-latest-gpu%2FDockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docker%2Ftransformers-quantization-latest-gpu%2FDockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftransformers-quantization-latest-gpu%2FDockerfile?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -50,6 +50,9 @@ RUN python3 -m pip install --no-cache-dir git+https://github.com/huggingface/pef\n # Add aqlm for quantization testing\n RUN python3 -m pip install --no-cache-dir aqlm[gpu]==1.0.2\n \n+# Add vptq for quantization testing\n+RUN python3 -m pip install --no-cache-dir vptq\n+\n # Add hqq for quantization testing\n RUN python3 -m pip install --no-cache-dir hqq\n "
        },
        {
            "sha": "287f4dffbb384ecb32e27137ae90bca6095a58e4",
            "filename": "docs/source/ar/_toctree.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Far%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Far%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Far%2F_toctree.yml?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -157,6 +157,8 @@\n #     title: AWQ\n #   - local: quantization/aqlm\n #     title: AQLM\n+#   - local: quantization/vptq\n+#     title: VPTQ\n #   - local: quantization/quanto\n #     title: Quanto\n #   - local: quantization/eetq"
        },
        {
            "sha": "18de03e1df8016b53a883ab3dd02f3b70a7317fc",
            "filename": "docs/source/en/_toctree.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2F_toctree.yml?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -167,6 +167,8 @@\n     title: AWQ\n   - local: quantization/aqlm\n     title: AQLM\n+  - local: quantization/vptq\n+    title: VPTQ\n   - local: quantization/quanto\n     title: Quanto\n   - local: quantization/eetq"
        },
        {
            "sha": "17ebb841de7a3914292a84c6aafeaba6d7f91c8b",
            "filename": "docs/source/en/llm_optims.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fllm_optims.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fllm_optims.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fllm_optims.md?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -473,7 +473,7 @@ with torch.backends.cuda.sdp_kernel(enable_flash=True, enable_math=False, enable\n Quantization reduces the size of the LLM weights by storing them in a lower precision. This translates to lower memory usage and makes loading LLMs for inference more accessible if you're constrained by your GPUs memory. If you aren't limited by your GPU, you don't necessarily need to quantize your model because it can incur a small latency cost (except for AWQ and fused AWQ modules) due to the extra step required to quantize and dequantize the weights.\n \n > [!TIP]\n-> There are many quantization libraries (see the [Quantization](./quantization) guide for more details) available, such as Quanto, AQLM, AWQ, and AutoGPTQ. Feel free to try them out and see which one works best for your use case. We also recommend reading the [Overview of natively supported quantization schemes in ðŸ¤— Transformers](https://hf.co/blog/overview-quantization-transformers) blog post which compares AutoGPTQ and bitsandbytes.\n+> There are many quantization libraries (see the [Quantization](./quantization) guide for more details) available, such as Quanto, AQLM, VPTQ, AWQ, and AutoGPTQ. Feel free to try them out and see which one works best for your use case. We also recommend reading the [Overview of natively supported quantization schemes in ðŸ¤— Transformers](https://hf.co/blog/overview-quantization-transformers) blog post which compares AutoGPTQ and bitsandbytes.\n \n Use the Model Memory Calculator below to estimate and compare how much memory is required to load a model. For example, try estimating how much memory it costs to load [Mistral-7B-v0.1](https://huggingface.co/mistralai/Mistral-7B-v0.1).\n "
        },
        {
            "sha": "9b500b69374c88a22b095578f228ec44fe68f8e0",
            "filename": "docs/source/en/main_classes/quantization.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fmain_classes%2Fquantization.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fmain_classes%2Fquantization.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmain_classes%2Fquantization.md?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -34,6 +34,10 @@ Learn how to quantize models in the [Quantization](../quantization) guide.\n \n [[autodoc]] AqlmConfig\n \n+## VptqConfig\n+\n+[[autodoc]] VptqConfig\n+\n ## AwqConfig\n \n [[autodoc]] AwqConfig"
        },
        {
            "sha": "f3508aed0674f68806ef60ab1fb7e64a09e45928",
            "filename": "docs/source/en/quantization/overview.md",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fquantization%2Foverview.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fquantization%2Foverview.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fquantization%2Foverview.md?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -58,6 +58,7 @@ Use the table below to help you decide which quantization method to use.\n | [optimum-quanto](./quanto)                              | ðŸŸ¢                       | ðŸŸ¢   | ðŸŸ¢        | ðŸ”´              | ðŸŸ¢                     | ðŸ”´         | ðŸŸ¢                       | 2 / 4 / 8      | ðŸ”´                                   | ðŸ”´            | ðŸŸ¢                      | https://github.com/huggingface/optimum-quanto       |\n | [FBGEMM_FP8](./fbgemm_fp8.md)                              | ðŸŸ¢                       | ðŸ”´    | ðŸŸ¢        | ðŸ”´              | ðŸ”´                      | ðŸ”´         | ðŸ”´                        | 8      | ðŸ”´                                   | ðŸŸ¢            | ðŸŸ¢                      | https://github.com/pytorch/FBGEMM       |\n | [torchao](./torchao.md)                              | ðŸŸ¢                       |     | ðŸŸ¢        | ðŸ”´              | partial support (int4 weight only)       | ðŸ”´         |                       | 4 / 8      |                                   | ðŸŸ¢ðŸ”´           | ðŸŸ¢                      | https://github.com/pytorch/ao       |\n+| [VPTQ](./vptq)                      | ðŸ”´                       |  ðŸ”´   |     ðŸŸ¢     | ðŸŸ¡              | ðŸ”´      | ðŸ”´                | ðŸŸ¢                      | 1 - 8          | ðŸ”´                                   | ðŸŸ¢            | ðŸŸ¢                      | https://github.com/microsoft/VPTQ            |\n \n <Tip>\n \n@@ -71,4 +72,4 @@ We value your feedback to help identify bugs before the full release! Check out\n \n \\** bitsandbytes is seeking contributors to help develop and lead the Apple Silicon backend. Interested? Contact them directly via their repo. Stipends may be available through sponsorships.\n \n-</Tip>\n+</Tip>\n\\ No newline at end of file"
        },
        {
            "sha": "b86e82f0a3503d9186281ba92d8eb261a2636c25",
            "filename": "docs/source/en/quantization/vptq.md",
            "status": "added",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fquantization%2Fvptq.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fen%2Fquantization%2Fvptq.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fquantization%2Fvptq.md?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -0,0 +1,111 @@\n+<!--Copyright 2024 The HuggingFace Team. All rights reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+the License. You may obtain a copy of the License at\n+\n+http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+specific language governing permissions and limitations under the License.\n+\n+âš ï¸ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be\n+rendered properly in your Markdown viewer.\n+\n+-->\n+\n+# VPTQ \n+\n+> [!TIP]\n+> Try VPTQ on [Hugging Face](https://huggingface.co/spaces/microsoft/VPTQ)!\n+> Try VPTQ on [Google Colab](https://colab.research.google.com/github/microsoft/VPTQ/blob/main/notebooks/vptq_example.ipynb)!\n+> Know more about VPTQ on [ArXiv](https://arxiv.org/pdf/2409.17066)!\n+\n+Vector Post-Training Quantization ([VPTQ](https://github.com/microsoft/VPTQ)) is a novel Post-Training Quantization method that leverages Vector Quantization to high accuracy on LLMs at an extremely low bit-width (<2-bit). VPTQ can compress 70B, even the 405B model, to 1-2 bits without retraining and maintain high accuracy.\n+\n+- Better Accuracy on 1-2 bits, (405B @ <2bit, 70B @ 2bit)\n+- Lightweight Quantization Algorithm: only cost ~17 hours to quantize 405B Llama-3.1\n+- Agile Quantization Inference: low decode overhead, best throughput, and TTFT\n+\n+Inference support for VPTQ is released in the `vptq` library. Make sure to install it to run the models:\n+```bash\n+pip install vptq\n+```\n+\n+The library provides efficient kernels for NVIDIA/AMD GPU inference.\n+\n+To run VPTQ models simply load a model that has been quantized with VPTQ:\n+\n+## Inference example\n+**Run Llama 3.1 70b on RTX4090 (24G @ ~2bits) in real time**\n+![Llama3 1-70b-prompt](https://github.com/user-attachments/assets/d8729aca-4e1d-4fe1-ac71-c14da4bdd97f)\n+\n+\n+```python\n+from transformers import AutoTokenizer, AutoModelForCausalLM\n+\n+quantized_model = AutoModelForCausalLM.from_pretrained(\n+    \"VPTQ-community/Meta-Llama-3.1-70B-Instruct-v16-k65536-65536-woft\",\n+    torch_dtype=\"auto\", \n+    device_map=\"auto\"\n+)\n+tokenizer = AutoTokenizer.from_pretrained(\"VPTQ-community/Meta-Llama-3.1-70B-Instruct-v16-k65536-65536-woft\")\n+input_ids = tokenizer(\"hello, it's me\", return_tensors=\"pt\").to(\"cuda\")\n+out = model.generate(**input_ids, max_new_tokens=32, do_sample=False)\n+```\n+\n+## Quantize your own model\n+VPTQ algorithm early-released at [VPTQ ](https://github.com/microsoft/VPTQ/tree/algorithm), \n+and checkout the [tutorial](https://github.com/microsoft/VPTQ/blob/algorithm/algorithm.md).\n+\n+## Early Results from Tech Report\n+VPTQ achieves better accuracy and higher throughput with lower quantization overhead across models of different sizes. The following experimental results are for reference only; VPTQ can achieve better outcomes under reasonable parameters, especially in terms of model accuracy and inference speed.\n+\n+\n+| Model       | bitwidth | W2â†“  | C4â†“  | AvgQAâ†‘ | tok/sâ†‘ | mem(GB) | cost/hâ†“ |\n+| ----------- | -------- | ---- | ---- | ------ | ------ | ------- | ------- |\n+| LLaMA-2 7B  | 2.02     | 6.13 | 8.07 | 58.2   | 39.9   | 2.28    | 2       |\n+|             | 2.26     | 5.95 | 7.87 | 59.4   | 35.7   | 2.48    | 3.1     |\n+| LLaMA-2 13B | 2.02     | 5.32 | 7.15 | 62.4   | 26.9   | 4.03    | 3.2     |\n+|             | 2.18     | 5.28 | 7.04 | 63.1   | 18.5   | 4.31    | 3.6     |\n+| LLaMA-2 70B | 2.07     | 3.93 | 5.72 | 68.6   | 9.7    | 19.54   | 19      |\n+|             | 2.11     | 3.92 | 5.71 | 68.7   | 9.7    | 20.01   | 19      |\n+\n+\n+\n+## More Models in [VPTQ-community](https://huggingface.co/VPTQ-community) \n+\n+âš ï¸ The repository only provides a method of model quantization algorithm. \n+\n+âš ï¸ The open-source community VPTQ-community provides models based on the technical report and quantization algorithm.\n+\n+\n+\n+**Quick Estimation of Model Bitwidth (Excluding Codebook Overhead)**:\n+\n+- **Model Naming Convention**: The model's name includes the **vector length** $v$, **codebook (lookup table) size**, and **residual codebook size**. For example, \"Meta-Llama-3.1-70B-Instruct-v8-k65536-256-woft\" is \"Meta-Llama-3.1-70B-Instruct\", where:\n+  - **Vector Length**: 8\n+  - **Number of Centroids**: 65536 (2^16)\n+  - **Number of Residual Centroids**: 256 (2^8)\n+- **Equivalent Bitwidth Calculation**:\n+  - **Index**: log2(65536) = 16 / 8 = 2 bits\n+  - **Residual Index**: log2(256) = 8 / 8 = 1 bit\n+  - **Total Bitwidth**: 2 + 1 = 3 bits\n+- **Model Size Estimation**: 70B * 3 bits / 8 bits per Byte = 26.25 GB\n+\n+- **Note**: This estimate does not include the size of the codebook (lookup table), other parameter overheads, and the padding overhead for storing indices. For the detailed calculation method, please refer to **Tech Report Appendix C.2**.\n+\n+\n+|            Model Series            |  Collections                              | (Estimated) Bit per weight     |\n+| :--------------------------------: | :-----------------------------------------------------------------------------------------------------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n+|       Llama 3.1 Nemotron 70B Instruct HF        |  [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-llama-31-nemotron-70b-instruct-hf-without-finetune-671730b96f16208d0b3fe942)  | [4 bits](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v8-k65536-256-woft) [2 bits (1)](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v16-k65536-65536-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v8-k65536-0-woft) [1.875 bits](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v16-k65536-16384-woft) [1.625 bits](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v16-k65536-1024-woft) [1.5 bits](https://huggingface.co/VPTQ-community/Llama-3.1-Nemotron-70B-Instruct-HF-v16-k65536-256-woft) |\n+|       Llama 3.1 8B Instruct        |  [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-llama-31-8b-instruct-without-finetune-66f2b70b1d002ceedef02d2e)  | [4 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-8B-Instruct-v8-k65536-65536-woft) [3.5 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-8B-Instruct-v8-k65536-4096-woft) [3 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-8B-Instruct-v8-k65536-256-woft) [2.3 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-8B-Instruct-v12-k65536-4096-woft)                                                                                                                                                                                                                                                                                                                                                                                                              |\n+|       Llama 3.1 70B Instruct       | [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-llama-31-70b-instruct-without-finetune-66f2bf454d3dd78dfee2ff11)  | [4 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v8-k65536-256-woft) [2.25 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v8-k65536-4-woft)  [2 bits (1)](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v16-k65536-65536-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v8-k65536-0-woft) [1.93 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v16-k65536-32768-woft) [1.875 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v8-k32768-0-woft) [1.75 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-70B-Instruct-v8-k16384-0-woft) |\n+|      Llama 3.1 405B Instruct       | [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-llama-31-405b-instruct-without-finetune-66f4413f9ba55e1a9e52cfb0) | [4 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v8-k65536-256-woft) [2 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v16-k65536-65536-woft) [1.875 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v16-k32768-32768-woft) [1.625 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v16-k65536-1024-woft) [1.5 bits (1)](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v8-k4096-0-woft) [1.5 bits (2)](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v16-k65536-256-woft) [1.43 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v16-k65536-128-woft) [1.375 bits](https://huggingface.co/VPTQ-community/Meta-Llama-3.1-405B-Instruct-v16-k65536-64-woft) |\n+| Mistral Large Instruct 2407 (123B) | [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-mistral-large-instruct-2407-without-finetune-6711ebfb7faf85eed9cceb16) | [4 bits](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v8-k65536-256-woft) [2 bits (1)](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v16-k65536-65536-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v8-k65536-0-woft) [1.875 bits](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v16-k65536-16384-woft) [1.75 bits](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v16-k65536-4096-woft) [1.625 bits](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v16-k65536-1024-woft) [1.5 bits](https://huggingface.co/VPTQ-community/Mistral-Large-Instruct-2407-v16-k65536-256-woft) |\n+|        Qwen 2.5 7B Instruct        |  [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-qwen-25-7b-instruct-without-finetune-66f3e9866d3167cc05ce954a)   | [4 bits](https://huggingface.co/VPTQ-community/Qwen2.5-7B-Instruct-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Qwen2.5-7B-Instruct-v8-k65536-256-woft) [2 bits (1)](https://huggingface.co/VPTQ-community/Qwen2.5-7B-Instruct-v8-k256-256-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Qwen2.5-7B-Instruct-v8-k65536-0-woft)  [2 bits (3)](https://huggingface.co/VPTQ-community/Qwen2.5-7B-Instruct-v16-k65536-65536-woft)                                                                                                                                                                                                                                                                                                                                              |\n+|       Qwen 2.5 14B Instruct        |  [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-qwen-25-14b-instruct-without-finetune-66f827f83c7ffa7931b8376c)  | [4 bits](https://huggingface.co/VPTQ-community/Qwen2.5-14B-Instruct-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Qwen2.5-14B-Instruct-v8-k65536-256-woft) [2 bits (1)](https://huggingface.co/VPTQ-community/Qwen2.5-14B-Instruct-v8-k256-256-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Qwen2.5-14B-Instruct-v8-k65536-0-woft)  [2 bits (3)](https://huggingface.co/VPTQ-community/Qwen2.5-14B-Instruct-v16-k65536-65536-woft)                                                                                                                                                                                                                                                                                                                                         |\n+|       Qwen 2.5 32B Instruct        |  [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-qwen-25-32b-instruct-without-finetune-66fe77173bf7d64139f0f613)  | [4 bits](https://huggingface.co/VPTQ-community/Qwen2.5-32B-Instruct-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Qwen2.5-32B-Instruct-v8-k65536-256-woft) [2 bits (1)](https://huggingface.co/VPTQ-community/Qwen2.5-32B-Instruct-v16-k65536-65536-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Qwen2.5-32B-Instruct-v8-k65536-0-woft) [2 bits (3)](https://huggingface.co/VPTQ-community/Qwen2.5-32B-Instruct-v8-k256-256-woft)                                                                                                                                                                                                                                                                                                                                          |\n+|       Qwen 2.5 72B Instruct        |  [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/vptq-qwen-25-72b-instruct-without-finetune-66f3bf1b3757dfa1ecb481c0)  | [4 bits](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v8-k65536-65536-woft) [3 bits](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v8-k65536-256-woft) [2.38 bits](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v8-k1024-512-woft) [2.25 bits (1)](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v8-k512-512-woft) [2.25 bits (2)](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v8-k65536-4-woft) [2 bits (1)](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v8-k65536-0-woft) [2 bits (2)](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v16-k65536-65536-woft) [1.94 bits](https://huggingface.co/VPTQ-community/Qwen2.5-72B-Instruct-v16-k65536-32768-woft)                                                  |\n+|  Reproduced from the tech report   |     [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/reproduced-vptq-tech-report-baseline-66fbf1dffe741cc9e93ecf04)     | Results from the open source community for reference only, please use them responsibly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |\n+| Hessian and Inverse Hessian Matrix |      [HF ðŸ¤—](https://huggingface.co/collections/VPTQ-community/hessian-and-invhessian-checkpoints-66fd249a104850d17b23fd8b)      | Collected from RedPajama-Data-1T-Sample, following [Quip#](https://github.com/Cornell-RelaxML/quip-sharp/blob/main/quantize_llama/hessian_offline_llama.py)                                                                                                                                                                                                               \n\\ No newline at end of file"
        },
        {
            "sha": "54740610ee1148222ec4b1fae7e664685b3e0c1e",
            "filename": "docs/source/ko/_toctree.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fko%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fko%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fko%2F_toctree.yml?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -151,6 +151,8 @@\n     title: AWQ\n   - local: in_translation\n     title: (ë²ˆì—­ì¤‘) AQLM\n+  - local: in_translation\n+    title: (ë²ˆì—­ì¤‘) VPTQ \n   - local: in_translation\n     title: (ë²ˆì—­ì¤‘) Quanto\n   - local: in_translation\n@@ -173,6 +175,8 @@\n     title: (ë²ˆì—­ì¤‘) AWQ\n   - local: in_translation\n     title: (ë²ˆì—­ì¤‘) AQLM\n+  - local: in_translation\n+    title: (ë²ˆì—­ì¤‘) VPTQ\n   - local: quantization/quanto\n     title: Quanto\n   - local: quantization/eetq"
        },
        {
            "sha": "99eabc19ce860aa78531e6bf4f0e8c1ca6f43f6e",
            "filename": "docs/source/ko/llm_optims.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fko%2Fllm_optims.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fko%2Fllm_optims.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fko%2Fllm_optims.md?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -375,7 +375,7 @@ with torch.backends.cuda.sdp_kernel(enable_flash=True, enable_math=False, enable\n ì–‘ìží™”ëŠ” LLM ê°€ì¤‘ì¹˜ë¥¼ ë” ë‚®ì€ ì •ë°€ë„ë¡œ ì €ìž¥í•˜ì—¬ í¬ê¸°ë¥¼ ì¤„ìž…ë‹ˆë‹¤. ì´ëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ì¤„ì´ë©° GPU ë©”ëª¨ë¦¬ì— ì œì•½ì´ ìžˆëŠ” ê²½ìš° ì¶”ë¡ ì„ ìœ„í•´ LLMì„ ë¡œë“œí•˜ëŠ” ê²ƒì„ ë” ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤. GPUê°€ ì¶©ë¶„í•˜ë‹¤ë©´, ëª¨ë¸ì„ ì–‘ìží™”í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ì–‘ìží™” ë° ì–‘ìží™” í•´ì œ ë‹¨ê³„ë¡œ ì¸í•´ ì•½ê°„ì˜ ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìžˆê¸° ë•Œë¬¸ìž…ë‹ˆë‹¤(AWQ ë° ìœµí•© AWQ ëª¨ë“ˆ ì œì™¸).\n \n > [!TIP]\n-> ë‹¤ì–‘í•œ ì–‘ìží™” ë¼ì´ë¸ŒëŸ¬ë¦¬(ìžì„¸í•œ ë‚´ìš©ì€ [Quantization](./quantization) ê°€ì´ë“œë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤)ê°€ ìžˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” Quanto, AQLM, AWQ ë° AutoGPTQê°€ í¬í•¨ë©ë‹ˆë‹¤. ì‚¬ìš© ì‚¬ë¡€ì— ê°€ìž¥ ìž˜ ë§žëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ ë³´ì‹­ì‹œì˜¤. ë˜í•œ AutoGPTQì™€ bitsandbytesë¥¼ ë¹„êµí•˜ëŠ” [Overview of natively supported quantization schemes in ðŸ¤— Transformers](https://hf.co/blog/overview-quantization-transformers) ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ì½ì–´ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.\n+> ë‹¤ì–‘í•œ ì–‘ìží™” ë¼ì´ë¸ŒëŸ¬ë¦¬(ìžì„¸í•œ ë‚´ìš©ì€ [Quantization](./quantization) ê°€ì´ë“œë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤)ê°€ ìžˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” Quanto, AQLM, VPTQ, AWQ ë° AutoGPTQê°€ í¬í•¨ë©ë‹ˆë‹¤. ì‚¬ìš© ì‚¬ë¡€ì— ê°€ìž¥ ìž˜ ë§žëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ ë³´ì‹­ì‹œì˜¤. ë˜í•œ AutoGPTQì™€ bitsandbytesë¥¼ ë¹„êµí•˜ëŠ” [Overview of natively supported quantization schemes in ðŸ¤— Transformers](https://hf.co/blog/overview-quantization-transformers) ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ì½ì–´ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.\n \n ì•„ëž˜ì˜ ëª¨ë¸ ë©”ëª¨ë¦¬ ê³„ì‚°ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ ë¡œë“œí•˜ëŠ” ë° í•„ìš”í•œ ë©”ëª¨ë¦¬ë¥¼ ì¶”ì •í•˜ê³  ë¹„êµí•´ ë³´ì‹­ì‹œì˜¤. ì˜ˆë¥¼ ë“¤ì–´ [Mistral-7B-v0.1](https://huggingface.co/mistralai/Mistral-7B-v0.1)ë¥¼ ë¡œë“œí•˜ëŠ” ë° í•„ìš”í•œ ë©”ëª¨ë¦¬ë¥¼ ì¶”ì •í•´ ë³´ì‹­ì‹œì˜¤.\n "
        },
        {
            "sha": "6f793f2210741788cf67a2e2a8232c654ea77484",
            "filename": "docs/source/ko/main_classes/quantization.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fko%2Fmain_classes%2Fquantization.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/docs%2Fsource%2Fko%2Fmain_classes%2Fquantization.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fko%2Fmain_classes%2Fquantization.md?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -35,6 +35,10 @@ Transformersì—ì„œ ì§€ì›ë˜ì§€ ì•ŠëŠ” ì–‘ìží™” ê¸°ë²•ë“¤ì€ [`HfQuantizer`] \n \n [[autodoc]] AqlmConfig\n \n+## VptqConfig[[transformers.VptqConfig]]\n+\n+[[autodoc]] VptqConfig\n+\n ## AwqConfig[[transformers.AwqConfig]]\n \n [[autodoc]] AwqConfig"
        },
        {
            "sha": "681bf1a5d16a36b5bb6fc34ff672445cdecfe786",
            "filename": "src/transformers/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2F__init__.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2F__init__.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2F__init__.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -1000,6 +1000,7 @@\n         \"HqqConfig\",\n         \"QuantoConfig\",\n         \"TorchAoConfig\",\n+        \"VptqConfig\",\n     ],\n }\n \n@@ -6017,6 +6018,7 @@\n         HqqConfig,\n         QuantoConfig,\n         TorchAoConfig,\n+        VptqConfig,\n     )\n \n     try:"
        },
        {
            "sha": "32c828cd6e5b44f009ea206e599a47e7fe9b980f",
            "filename": "src/transformers/integrations/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fintegrations%2F__init__.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fintegrations%2F__init__.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fintegrations%2F__init__.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -105,6 +105,7 @@\n     ],\n     \"peft\": [\"PeftAdapterMixin\"],\n     \"quanto\": [\"replace_with_quanto_layers\"],\n+    \"vptq\": [\"replace_with_vptq_linear\"],\n }\n \n try:\n@@ -207,6 +208,7 @@\n     )\n     from .peft import PeftAdapterMixin\n     from .quanto import replace_with_quanto_layers\n+    from .vptq import replace_with_vptq_linear\n \n     try:\n         if not is_torch_available():"
        },
        {
            "sha": "aa435517e81ebe3f9e624b45d34a601e512f5b1b",
            "filename": "src/transformers/integrations/vptq.py",
            "status": "added",
            "additions": 101,
            "deletions": 0,
            "changes": 101,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fintegrations%2Fvptq.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fintegrations%2Fvptq.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fintegrations%2Fvptq.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -0,0 +1,101 @@\n+# Copyright 2024 The HuggingFace Team. All rights reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\"VPTQ (Vector Post-Training Quantization) integration file\"\n+\n+import torch.nn as nn\n+from accelerate import init_empty_weights\n+from vptq import VQuantLinear\n+\n+\n+def replace_with_vptq_linear(\n+    model,\n+    quantization_config=None,\n+    modules_to_not_convert=None,\n+    current_key_name=None,\n+    has_been_replaced=False,\n+):\n+    \"\"\"\n+    Public method that recursively replaces the Linear layers of the given model with VPTQ quantized layers.\n+    `accelerate` is needed to use this method. Returns the converted model and a boolean that indicates if the\n+    conversion has been successfull or not.\n+\n+    Args:\n+        model (`torch.nn.Module`):\n+            The model to convert, can be any `torch.nn.Module` instance.\n+        quantization_config (`VptqConfig`):\n+            The quantization config object that contains the quantization parameters.\n+        modules_to_not_convert (`List[`str`]`, *optional*, defaults to `[\"lm_head\"]`):\n+            Names of the modules to not convert in `VQuantLinear`. In practice we keep the `lm_head` in full precision\n+            for numerical stability reasons.\n+        current_key_name (`list`, *optional*):\n+            A list that contains the current key name. This is used for recursion and should not be passed by the user.\n+        has_been_replaced (`bool`, *optional*):\n+            A boolean that indicates if the conversion has been successful or not. This is used for recursion and\n+            should not be passed by the user.\n+    \"\"\"\n+\n+    modules_to_not_convert = [\"lm_head\"] if not modules_to_not_convert else modules_to_not_convert\n+\n+    for name, module in model.named_children():\n+        if current_key_name is None:\n+            current_key_name = []\n+        current_key_name.append(name)\n+        layer_name = \".\".join(current_key_name)\n+        shared_layer_config = quantization_config.shared_layer_config\n+        config_for_layers = quantization_config.config_for_layers\n+\n+        if (\n+            isinstance(module, nn.Linear)\n+            and layer_name not in modules_to_not_convert\n+            and ((layer_name in config_for_layers) or (current_key_name[-1] in shared_layer_config))\n+        ):\n+            layer_params = config_for_layers.get(layer_name, None) or shared_layer_config.get(\n+                current_key_name[-1], None\n+            )\n+\n+            with init_empty_weights():\n+                in_features = module.in_features\n+                out_features = module.out_features\n+\n+                model._modules[name] = VQuantLinear(\n+                    in_features,\n+                    out_features,\n+                    vector_lens=layer_params[\"vector_lens\"],\n+                    num_centroids=layer_params[\"num_centroids\"],\n+                    num_res_centroids=layer_params[\"num_res_centroids\"],\n+                    group_num=layer_params[\"group_num\"],\n+                    group_size=layer_params[\"group_size\"],\n+                    outlier_size=layer_params[\"outlier_size\"],\n+                    indices_as_float=layer_params[\"indices_as_float\"],\n+                    enable_norm=layer_params[\"enable_norm\"],\n+                    enable_perm=layer_params[\"enable_perm\"],\n+                    is_indice_packed=True,\n+                    enable_proxy_error=False,\n+                    bias=module.bias is not None,\n+                )\n+                has_been_replaced = True\n+\n+                # Force requires grad to False to avoid unexpected errors\n+                model._modules[name].requires_grad_(False)\n+        if len(list(module.children())) > 0:\n+            _, has_been_replaced = replace_with_vptq_linear(\n+                module,\n+                quantization_config=quantization_config,\n+                modules_to_not_convert=modules_to_not_convert,\n+                current_key_name=current_key_name,\n+                has_been_replaced=has_been_replaced,\n+            )\n+        # Remove the last key for recursion\n+        current_key_name.pop(-1)\n+    return model, has_been_replaced"
        },
        {
            "sha": "47b54cd27bcebe3dc5dab08ef428998c0fb43bf7",
            "filename": "src/transformers/quantizers/auto.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fquantizers%2Fauto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fquantizers%2Fauto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fquantizers%2Fauto.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -29,6 +29,7 @@\n     QuantizationMethod,\n     QuantoConfig,\n     TorchAoConfig,\n+    VptqConfig,\n )\n from .quantizer_aqlm import AqlmHfQuantizer\n from .quantizer_awq import AwqQuantizer\n@@ -42,6 +43,7 @@\n from .quantizer_hqq import HqqHfQuantizer\n from .quantizer_quanto import QuantoHfQuantizer\n from .quantizer_torchao import TorchAoHfQuantizer\n+from .quantizer_vptq import VptqHfQuantizer\n \n \n AUTO_QUANTIZER_MAPPING = {\n@@ -57,6 +59,7 @@\n     \"fbgemm_fp8\": FbgemmFp8HfQuantizer,\n     \"torchao\": TorchAoHfQuantizer,\n     \"bitnet\": BitNetHfQuantizer,\n+    \"vptq\": VptqHfQuantizer,\n }\n \n AUTO_QUANTIZATION_CONFIG_MAPPING = {\n@@ -72,6 +75,7 @@\n     \"fbgemm_fp8\": FbgemmFp8Config,\n     \"torchao\": TorchAoConfig,\n     \"bitnet\": BitNetConfig,\n+    \"vptq\": VptqConfig,\n }\n \n "
        },
        {
            "sha": "1672c3ebc5a7d35d7c788671340eaca9762c356e",
            "filename": "src/transformers/quantizers/quantizer_vptq.py",
            "status": "added",
            "additions": 98,
            "deletions": 0,
            "changes": 98,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fquantizers%2Fquantizer_vptq.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Fquantizers%2Fquantizer_vptq.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fquantizers%2Fquantizer_vptq.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -0,0 +1,98 @@\n+# Copyright 2024 The HuggingFace Inc. team. All rights reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+from typing import TYPE_CHECKING, Optional\n+\n+from .base import HfQuantizer\n+\n+\n+if TYPE_CHECKING:\n+    from ..modeling_utils import PreTrainedModel\n+\n+from ..utils import is_accelerate_available, is_torch_available, is_vptq_available, logging\n+from ..utils.quantization_config import QuantizationConfigMixin\n+\n+\n+if is_torch_available():\n+    import torch\n+\n+logger = logging.get_logger(__name__)\n+\n+\n+class VptqHfQuantizer(HfQuantizer):\n+    \"\"\"\n+    Quantizer of the VPTQ method. Enables the loading of prequantized models.\n+    \"\"\"\n+\n+    requires_calibration = True\n+    required_packages = [\"vptq\"]\n+\n+    def __init__(self, quantization_config: QuantizationConfigMixin, **kwargs):\n+        super().__init__(quantization_config, **kwargs)\n+        self.quantization_config = quantization_config\n+\n+    def validate_environment(self, *args, **kwargs):\n+        if not is_accelerate_available():\n+            raise ImportError(\"Using `vptq` quantization requires Accelerate: `pip install accelerate`\")\n+\n+        if not is_vptq_available():\n+            raise ImportError(\"Using `vptq` quantization requires VPTQ>=0.0.4: `pip install -U vptq`\")\n+\n+    def update_torch_dtype(self, torch_dtype: \"torch.dtype\") -> \"torch.dtype\":\n+        if torch_dtype is None:\n+            if torch.cuda.is_available():\n+                torch_dtype = torch.float16\n+                logger.info(\n+                    \"CUDA available. Assuming VPTQ inference on GPU and loading the model in `torch.float16`. To overwrite it, set `torch_dtype` manually.\"\n+                )\n+            else:\n+                import vptq\n+\n+                device_availability = getattr(vptq, \"device_availability\", lambda device: False)\n+                if device_availability(\"cpu\") is True:\n+                    raise RuntimeError(\"No GPU found. Please wait for the next release of VPTQ to use CPU inference\")\n+                torch_dtype = torch.float32\n+                logger.info(\"No GPU found. Assuming VPTQ inference on CPU and loading the model in `torch.float32`.\")\n+        return torch_dtype\n+\n+    def _process_model_before_weight_loading(\n+        self,\n+        model: \"PreTrainedModel\",\n+        **kwargs,\n+    ):\n+        \"\"\"\n+        we don't have param like modules_to_not_convert to indicate which layers should not be quantized\n+        because `quantization_config` include the layers that should be quantized\n+        \"\"\"\n+        from ..integrations import replace_with_vptq_linear\n+\n+        modules_to_not_convert = kwargs.get(\"modules_to_not_convert\", []) + (\n+            self.quantization_config.modules_to_not_convert or []\n+        )\n+\n+        replace_with_vptq_linear(\n+            model,\n+            quantization_config=self.quantization_config,\n+            modules_to_not_convert=modules_to_not_convert,\n+        )\n+        model.config.quantization_config = self.quantization_config\n+\n+    def _process_model_after_weight_loading(self, model: \"PreTrainedModel\", **kwargs):\n+        return model\n+\n+    @property\n+    def is_trainable(self, model: Optional[\"PreTrainedModel\"] = None):\n+        return False\n+\n+    def is_serializable(self, safe_serialization=None):\n+        return True"
        },
        {
            "sha": "5b0b9e7686e92587362ec7de71fe75f1fd644ca6",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -142,6 +142,7 @@\n     is_torchdynamo_available,\n     is_torchvision_available,\n     is_vision_available,\n+    is_vptq_available,\n     strtobool,\n )\n \n@@ -1142,6 +1143,13 @@ def require_aqlm(test_case):\n     return unittest.skipUnless(is_aqlm_available(), \"test requires aqlm\")(test_case)\n \n \n+def require_vptq(test_case):\n+    \"\"\"\n+    Decorator marking a test that requires vptq\n+    \"\"\"\n+    return unittest.skipUnless(is_vptq_available(), \"test requires vptq\")(test_case)\n+\n+\n def require_eetq(test_case):\n     \"\"\"\n     Decorator marking a test that requires eetq"
        },
        {
            "sha": "2edfcdcd101c78b4e103ebea036d8a9f9493f77b",
            "filename": "src/transformers/utils/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Futils%2F__init__.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Futils%2F__init__.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2F__init__.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -233,6 +233,7 @@\n     is_training_run_on_sagemaker,\n     is_uroman_available,\n     is_vision_available,\n+    is_vptq_available,\n     requires_backends,\n     torch_only_method,\n )"
        },
        {
            "sha": "cfc8b88fd81ed6f370e71081a92d7f8eddac7e83",
            "filename": "src/transformers/utils/import_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Futils%2Fimport_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Futils%2Fimport_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fimport_utils.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -93,11 +93,13 @@ def _is_package_available(pkg_name: str, return_version: bool = False) -> Union[\n GGUF_MIN_VERSION = \"0.10.0\"\n XLA_FSDPV2_MIN_VERSION = \"2.2.0\"\n HQQ_MIN_VERSION = \"0.2.1\"\n+VPTQ_MIN_VERSION = \"0.0.4\"\n \n \n _accelerate_available, _accelerate_version = _is_package_available(\"accelerate\", return_version=True)\n _apex_available = _is_package_available(\"apex\")\n _aqlm_available = _is_package_available(\"aqlm\")\n+_vptq_available, _vptq_version = _is_package_available(\"vptq\", return_version=True)\n _av_available = importlib.util.find_spec(\"av\") is not None\n _bitsandbytes_available = _is_package_available(\"bitsandbytes\")\n _eetq_available = _is_package_available(\"eetq\")\n@@ -816,6 +818,10 @@ def is_aqlm_available():\n     return _aqlm_available\n \n \n+def is_vptq_available(min_version: str = VPTQ_MIN_VERSION):\n+    return _vptq_available and version.parse(_vptq_version) >= version.parse(min_version)\n+\n+\n def is_av_available():\n     return _av_available\n "
        },
        {
            "sha": "44e47e4f6e65c21b3c0c4876be6d45b95b478da5",
            "filename": "src/transformers/utils/quantization_config.py",
            "status": "modified",
            "additions": 97,
            "deletions": 0,
            "changes": 97,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Futils%2Fquantization_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/src%2Ftransformers%2Futils%2Fquantization_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fquantization_config.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -39,6 +39,7 @@ class QuantizationMethod(str, Enum):\n     GPTQ = \"gptq\"\n     AWQ = \"awq\"\n     AQLM = \"aqlm\"\n+    VPTQ = \"vptq\"\n     QUANTO = \"quanto\"\n     EETQ = \"eetq\"\n     HQQ = \"hqq\"\n@@ -994,6 +995,102 @@ def post_init(self):\n             self.linear_weights_not_to_quantize = []\n \n \n+@dataclass\n+class VptqLayerConfig(QuantizationConfigMixin):\n+    \"\"\"\n+    This is used to explain vptq config params for each layer\n+    Args:\n+        enable_norm (`bool`, *optional*, defaults to `True`): to control if we have scale/bias for fp-weight\n+        enable_perm (`bool`, *optional*, defaults to `True`): to perm input_channel or not\n+        group_num (`int`, *optional*, defaults to `1`): how many single groups for vector-quantization\n+        group_size (`int`, *optional*, defaults to `-1`): depends on out-features\n+        indices_as_float (`bool`, *optional*, defaults to `False`): for Finetuning\n+        is_indice_packed (`bool`, *optional*, defaults to `True`): should always be True\n+        num_centroids (`list`, *optional*, defaults to `[-1, -1]`): centriod numbers of clusters\n+        num_res_centroids (`list`, *optional*, defaults to `[-1, -1]`): ditto for residual\n+        outlier_size (`int`, *optional*, defaults to `1`): outliers\n+        vector_lens (`list`, *optional*, defaults to `[-1, -1]`): centroid vector length in quantization\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        enable_norm: bool = True,\n+        enable_perm: bool = True,\n+        group_num: int = 1,\n+        group_size: int = -1,\n+        in_features: int = -1,\n+        indices_as_float: bool = False,\n+        is_indice_packed: bool = True,\n+        num_centroids: tuple = [-1, -1],\n+        num_res_centroids: tuple = [-1, -1],\n+        out_features: int = -1,\n+        outlier_size: int = 0,\n+        vector_lens: tuple = [-1, -1],\n+        **kwargs,\n+    ):\n+        self.enable_norm = enable_norm\n+        self.enable_perm = enable_perm\n+        self.group_num = group_num\n+        self.group_size = group_size\n+        self.in_features = in_features\n+        self.indices_as_float = indices_as_float\n+        self.is_indice_packed = is_indice_packed\n+        self.num_centroids = num_centroids\n+        self.num_res_centroids = num_res_centroids\n+        self.out_features = out_features\n+        self.outlier_size = outlier_size\n+        self.vector_lens = vector_lens\n+        self.post_init()\n+\n+    def post_init(self):\n+        r\"\"\"\n+        Safety checker that arguments are correct\n+        \"\"\"\n+        if self.is_indice_packed is False:\n+            raise ValueError(\"is_indice_packed should always be True\")\n+\n+\n+@dataclass\n+class VptqConfig(QuantizationConfigMixin):\n+    \"\"\"\n+    This is a wrapper class about `vptq` parameters.\n+\n+    Args:\n+        enable_proxy_error (`bool`, *optional*, defaults to `False`): calculate proxy error for each layer\n+        config_for_layers (`Dict`, *optional*, defaults to `{}`): quantization params for each layer\n+        shared_layer_config (`Dict`, *optional*, defaults to `{}`): shared quantization params among layers\n+        modules_to_not_convert (`list`, *optional*, default to `None`):\n+            The list of modules to not quantize, useful for quantizing models that explicitly require to have\n+            some modules left in their original precision (e.g. Whisper encoder, Llava encoder, Mixtral gate layers).\n+        kwargs (`Dict[str, Any]`, *optional*):\n+            Additional parameters from which to initialize the configuration object.\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        enable_proxy_error: bool = False,\n+        config_for_layers: Dict[str, Any] = {},\n+        shared_layer_config: Dict[str, Any] = {},\n+        modules_to_not_convert: Optional[List] = None,\n+        **kwargs,\n+    ):\n+        self.quant_method = QuantizationMethod.VPTQ\n+        self.enable_proxy_error = enable_proxy_error\n+        self.config_for_layers: Dict[str, Any] = config_for_layers\n+        self.shared_layer_config: Dict[str, Any] = shared_layer_config\n+        self.modules_to_not_convert = modules_to_not_convert\n+        self.post_init()\n+\n+    def post_init(self):\n+        r\"\"\"\n+        Safety checker that arguments are correct\n+        \"\"\"\n+        for layer_name, layer_param in self.config_for_layers.items():\n+            VptqLayerConfig(**layer_param)\n+        if self.enable_proxy_error is True:\n+            raise ValueError(\"enable_proxy_error should always be False until we support training\")\n+\n+\n @dataclass\n class QuantoConfig(QuantizationConfigMixin):\n     \"\"\""
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/quantization/vptq_integration/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/tests%2Fquantization%2Fvptq_integration%2F__init__.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/tests%2Fquantization%2Fvptq_integration%2F__init__.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fquantization%2Fvptq_integration%2F__init__.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4"
        },
        {
            "sha": "faa9a5879d1dcc1fdd395b66d0dbc6c3f969eb56",
            "filename": "tests/quantization/vptq_integration/test_vptq.py",
            "status": "added",
            "additions": 194,
            "deletions": 0,
            "changes": 194,
            "blob_url": "https://github.com/huggingface/transformers/blob/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/tests%2Fquantization%2Fvptq_integration%2Ftest_vptq.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4e27a4009d3f9d4e44e9be742e8cd742daf074f4/tests%2Fquantization%2Fvptq_integration%2Ftest_vptq.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fquantization%2Fvptq_integration%2Ftest_vptq.py?ref=4e27a4009d3f9d4e44e9be742e8cd742daf074f4",
            "patch": "@@ -0,0 +1,194 @@\n+# coding=utf-8\n+# Copyright 2024 The HuggingFace Team. All rights reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+import gc\n+import tempfile\n+import unittest\n+\n+from transformers import AutoConfig, AutoModelForCausalLM, AutoTokenizer, VptqConfig\n+from transformers.testing_utils import (\n+    require_accelerate,\n+    require_torch_gpu,\n+    require_torch_multi_gpu,\n+    require_vptq,\n+    slow,\n+    torch_device,\n+)\n+from transformers.utils import is_accelerate_available, is_torch_available\n+\n+\n+if is_torch_available():\n+    import torch\n+\n+if is_accelerate_available():\n+    from accelerate import init_empty_weights\n+\n+\n+class VptqConfigTest(unittest.TestCase):\n+    def test_to_dict(self):\n+        \"\"\"\n+        Makes sure the config format is properly set\n+        \"\"\"\n+        quantization_config = VptqConfig()\n+        vptq_orig_config = quantization_config.to_dict()\n+\n+        self.assertEqual(quantization_config.quant_config, vptq_orig_config[\"quant_config\"])\n+\n+\n+@slow\n+@require_torch_gpu\n+@require_vptq\n+@require_accelerate\n+class VptqTest(unittest.TestCase):\n+    model_name = \"VPTQ-community/Meta-Llama-3.1-8B-Instruct-v12-k65536-4096-woft\"\n+\n+    input_text = \"Hello my name is\"\n+    max_new_tokens = 32\n+\n+    EXPECTED_OUTPUT = \"Hello my name is Sarah and I am a 25 year old woman from the United States. I am a college graduate and I am currently working as a marketing specialist for a small\"\n+\n+    device_map = \"cuda\"\n+\n+    # called only once for all test in this class\n+    @classmethod\n+    def setUpClass(cls):\n+        \"\"\"\n+        Setup quantized model\n+        \"\"\"\n+        cls.tokenizer = AutoTokenizer.from_pretrained(cls.model_name)\n+        cls.quantized_model = AutoModelForCausalLM.from_pretrained(\n+            cls.model_name,\n+            device_map=cls.device_map,\n+        )\n+\n+    def tearDown(self):\n+        gc.collect()\n+        torch.cuda.empty_cache()\n+        gc.collect()\n+\n+    def test_quantized_model(self):\n+        \"\"\"\n+        Simple test that checks if the quantized model is working properly\n+        \"\"\"\n+        input_ids = self.tokenizer(self.input_text, return_tensors=\"pt\").to(torch_device)\n+\n+        output = self.quantized_model.generate(**input_ids, max_new_tokens=self.max_new_tokens, do_sample=False)\n+        self.assertEqual(self.tokenizer.decode(output[0], skip_special_tokens=True), self.EXPECTED_OUTPUT)\n+\n+    def test_raise_if_non_quantized(self):\n+        model_id = \"facebook/opt-125m\"\n+        quantization_config = VptqConfig()\n+\n+        with self.assertRaises(ValueError):\n+            _ = AutoModelForCausalLM.from_pretrained(model_id, quantization_config=quantization_config)\n+\n+    def test_save_pretrained(self):\n+        \"\"\"\n+        Simple test that checks if the quantized model is working properly after being saved and loaded\n+        \"\"\"\n+        with tempfile.TemporaryDirectory() as tmpdirname:\n+            self.quantized_model.save_pretrained(tmpdirname)\n+            model = AutoModelForCausalLM.from_pretrained(tmpdirname, device_map=self.device_map)\n+\n+            input_ids = self.tokenizer(self.input_text, return_tensors=\"pt\").to(torch_device)\n+\n+            output = model.generate(**input_ids, max_new_tokens=self.max_new_tokens, do_sample=False)\n+            self.assertEqual(self.tokenizer.decode(output[0], skip_special_tokens=True), self.EXPECTED_OUTPUT)\n+\n+    @require_torch_multi_gpu\n+    def test_quantized_model_multi_gpu(self):\n+        \"\"\"\n+        Simple test that checks if the quantized model is working properly with multiple GPUs\n+        \"\"\"\n+        input_ids = self.tokenizer(self.input_text, return_tensors=\"pt\").to(torch_device)\n+\n+        quantized_model = AutoModelForCausalLM.from_pretrained(self.model_name, device_map=\"auto\")\n+\n+        self.assertTrue(set(quantized_model.hf_device_map.values()) == {0, 1})\n+\n+        output = quantized_model.generate(**input_ids, max_new_tokens=self.max_new_tokens, do_sample=False)\n+\n+        self.assertEqual(self.tokenizer.decode(output[0], skip_special_tokens=True), self.EXPECTED_OUTPUT)\n+\n+    def test_quantized_model_conversion(self):\n+        \"\"\"\n+        Simple test that checks if the quantized model has been converted properly\n+        \"\"\"\n+        from vptq import VQuantLinear\n+\n+        from transformers.integrations import replace_with_vptq_linear\n+\n+        model_id = \"facebook/opt-350m\"\n+        config = AutoConfig.from_pretrained(model_id, revision=\"cb32f77e905cccbca1d970436fb0f5e6b58ee3c5\")\n+        modules_to_not_convert = [\"lm_head\"]\n+        names = [\n+            \"q_proj\",\n+            \"k_proj\",\n+            \"v_proj\",\n+            \"out_proj\",\n+            \"fc1\",\n+            \"fc2\",\n+        ]\n+        value = {\n+            \"enable_norm\": True,\n+            \"enable_perm\": True,\n+            \"group_num\": 1,\n+            \"group_size\": 128,\n+            \"indices_as_float\": False,\n+            \"num_centroids\": [-1, 128],\n+            \"num_res_centroids\": [-1, 128],\n+            \"outlier_size\": 0,\n+            \"vector_lens\": [-1, 12],\n+        }\n+        shared_layer_config = {}\n+        for name in names:\n+            shared_layer_config[name] = value\n+        for i in range(24):\n+            modules_to_not_convert.append(\"model.decoder.layers.{layer_idx}.fc1\".format(layer_idx=i))\n+        layer_configs = {}\n+        layer_configs[\"model.decoder.project_out\"] = value\n+        layer_configs[\"model.decoder.project_in\"] = value\n+        quantization_config = VptqConfig(config_for_layers=layer_configs, shared_layer_config=shared_layer_config)\n+\n+        with init_empty_weights():\n+            model = AutoModelForCausalLM.from_config(config)\n+\n+        nb_linears = 0\n+        for module in model.modules():\n+            if isinstance(module, torch.nn.Linear):\n+                nb_linears += 1\n+\n+        model, _ = replace_with_vptq_linear(model, quantization_config=quantization_config)\n+        nb_vptq_linear = 0\n+        for module in model.modules():\n+            if isinstance(module, VQuantLinear):\n+                nb_vptq_linear += 1\n+\n+        self.assertEqual(nb_linears - 1, nb_vptq_linear)\n+\n+        # Try with `linear_weights_not_to_quantize`\n+        with init_empty_weights():\n+            model = AutoModelForCausalLM.from_config(config)\n+        quantization_config = VptqConfig(config_for_layers=layer_configs, shared_layer_config=shared_layer_config)\n+        model, _ = replace_with_vptq_linear(\n+            model, quantization_config=quantization_config, modules_to_not_convert=modules_to_not_convert\n+        )\n+        nb_vptq_linear = 0\n+        for module in model.modules():\n+            if isinstance(module, VQuantLinear):\n+                nb_vptq_linear += 1\n+        # 25 comes from 24 decoder.layers.{layer_idx}.fc1\n+        # and the last lm_head\n+        self.assertEqual(nb_linears - 25, nb_vptq_linear)"
        }
    ],
    "stats": {
        "total": 650,
        "additions": 647,
        "deletions": 3
    }
}