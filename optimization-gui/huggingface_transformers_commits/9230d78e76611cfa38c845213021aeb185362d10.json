{
    "author": "yonigozlan",
    "message": "Add validate images and text inputs order util for processors and test_processing_utils (#33285)\n\n* Add validate images and test processing utils\r\n\r\n* Remove encoded text from possible inputs in tests\r\n\r\n* Removed encoded inputs as valid in processing_utils\r\n\r\n* change text input check to be recursive\r\n\r\n* change text check to all element of lists and not just the first one in recursive checks",
    "sha": "9230d78e76611cfa38c845213021aeb185362d10",
    "files": [
        {
            "sha": "59a1ba98c73fdca36eacfc7c3265f33bfd33fca9",
            "filename": "src/transformers/processing_utils.py",
            "status": "modified",
            "additions": 45,
            "deletions": 1,
            "changes": 46,
            "blob_url": "https://github.com/huggingface/transformers/blob/9230d78e76611cfa38c845213021aeb185362d10/src%2Ftransformers%2Fprocessing_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9230d78e76611cfa38c845213021aeb185362d10/src%2Ftransformers%2Fprocessing_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fprocessing_utils.py?ref=9230d78e76611cfa38c845213021aeb185362d10",
            "patch": "@@ -27,7 +27,7 @@\n import numpy as np\n \n from .dynamic_module_utils import custom_object_save\n-from .image_utils import ChannelDimension, is_vision_available\n+from .image_utils import ChannelDimension, is_vision_available, valid_images\n \n \n if is_vision_available():\n@@ -993,6 +993,50 @@ def apply_chat_template(\n         )\n \n \n+def _validate_images_text_input_order(images, text):\n+    \"\"\"\n+    For backward compatibility: reverse the order of `images` and `text` inputs if they are swapped.\n+    This method should only be called for processors where `images` and `text` have been swapped for uniformization purposes.\n+    Note that this method assumes that two `None` inputs are valid inputs. If this is not the case, it should be handled\n+    in the processor's `__call__` method before calling this method.\n+    \"\"\"\n+\n+    def _is_valid_text_input_for_processor(t):\n+        if isinstance(t, str):\n+            # Strings are fine\n+            return True\n+        elif isinstance(t, (list, tuple)):\n+            # List are fine as long as they are...\n+            if len(t) == 0:\n+                # ... not empty\n+                return False\n+            for t_s in t:\n+                return _is_valid_text_input_for_processor(t_s)\n+        return False\n+\n+    def _is_valid(input, validator):\n+        return validator(input) or input is None\n+\n+    images_is_valid = _is_valid(images, valid_images)\n+    images_is_text = _is_valid_text_input_for_processor(images) if not images_is_valid else False\n+\n+    text_is_valid = _is_valid(text, _is_valid_text_input_for_processor)\n+    text_is_images = valid_images(text) if not text_is_valid else False\n+    # Handle cases where both inputs are valid\n+    if images_is_valid and text_is_valid:\n+        return images, text\n+\n+    # Handle cases where inputs need to and can be swapped\n+    if (images is None and text_is_images) or (text is None and images_is_text) or (images_is_text and text_is_images):\n+        logger.warning_once(\n+            \"You may have used the wrong order for inputs. `images` should be passed before `text`. \"\n+            \"The `images` and `text` inputs will be swapped. This behavior will be deprecated in transformers v4.47.\"\n+        )\n+        return text, images\n+\n+    raise ValueError(\"Invalid input type. Check that `images` and/or `text` are valid inputs.\")\n+\n+\n ProcessorMixin.push_to_hub = copy_func(ProcessorMixin.push_to_hub)\n if ProcessorMixin.push_to_hub.__doc__ is not None:\n     ProcessorMixin.push_to_hub.__doc__ = ProcessorMixin.push_to_hub.__doc__.format("
        },
        {
            "sha": "cf0e66cd7bd08f5812486b88eaddc0ed2e9cdc34",
            "filename": "tests/utils/test_processing_utils.py",
            "status": "added",
            "additions": 164,
            "deletions": 0,
            "changes": 164,
            "blob_url": "https://github.com/huggingface/transformers/blob/9230d78e76611cfa38c845213021aeb185362d10/tests%2Futils%2Ftest_processing_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9230d78e76611cfa38c845213021aeb185362d10/tests%2Futils%2Ftest_processing_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_processing_utils.py?ref=9230d78e76611cfa38c845213021aeb185362d10",
            "patch": "@@ -0,0 +1,164 @@\n+# coding=utf-8\n+# Copyright 2024 HuggingFace Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+import unittest\n+\n+import numpy as np\n+\n+from transformers import is_torch_available, is_vision_available\n+from transformers.processing_utils import _validate_images_text_input_order\n+from transformers.testing_utils import require_torch, require_vision\n+\n+\n+if is_vision_available():\n+    import PIL\n+\n+if is_torch_available():\n+    import torch\n+\n+\n+@require_vision\n+class ProcessingUtilTester(unittest.TestCase):\n+    def test_validate_images_text_input_order(self):\n+        # text string and PIL images inputs\n+        images = PIL.Image.new(\"RGB\", (224, 224))\n+        text = \"text\"\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertEqual(valid_images, images)\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertEqual(valid_images, images)\n+        self.assertEqual(valid_text, text)\n+\n+        # text list of string and numpy images inputs\n+        images = np.random.rand(224, 224, 3)\n+        text = [\"text1\", \"text2\"]\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertTrue(np.array_equal(valid_images, images))\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertTrue(np.array_equal(valid_images, images))\n+        self.assertEqual(valid_text, text)\n+\n+        # text nested list of string and list of pil images inputs\n+        images = [PIL.Image.new(\"RGB\", (224, 224)), PIL.Image.new(\"RGB\", (224, 224))]\n+        text = [[\"text1\", \"text2, text3\"], [\"text3\", \"text4\"]]\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertEqual(valid_images, images)\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertEqual(valid_images, images)\n+        self.assertEqual(valid_text, text)\n+\n+        # list of strings and list of numpy images inputs\n+        images = [np.random.rand(224, 224, 3), np.random.rand(224, 224, 3)]\n+        text = [\"text1\", \"text2\"]\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertTrue(np.array_equal(valid_images[0], images[0]))\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertTrue(np.array_equal(valid_images[0], images[0]))\n+        self.assertEqual(valid_text, text)\n+\n+        # list of strings and nested list of numpy images inputs\n+        images = [[np.random.rand(224, 224, 3), np.random.rand(224, 224, 3)], [np.random.rand(224, 224, 3)]]\n+        text = [\"text1\", \"text2\"]\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertTrue(np.array_equal(valid_images[0][0], images[0][0]))\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertTrue(np.array_equal(valid_images[0][0], images[0][0]))\n+        self.assertEqual(valid_text, text)\n+\n+        # nested list of strings and nested list of PIL images inputs\n+        images = [\n+            [PIL.Image.new(\"RGB\", (224, 224)), PIL.Image.new(\"RGB\", (224, 224))],\n+            [PIL.Image.new(\"RGB\", (224, 224))],\n+        ]\n+        text = [[\"text1\", \"text2, text3\"], [\"text3\", \"text4\"]]\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertEqual(valid_images, images)\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertEqual(valid_images, images)\n+        self.assertEqual(valid_text, text)\n+\n+        # None images\n+        images = None\n+        text = \"text\"\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertEqual(images, None)\n+        self.assertEqual(text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertEqual(images, None)\n+        self.assertEqual(text, text)\n+\n+        # None text\n+        images = PIL.Image.new(\"RGB\", (224, 224))\n+        text = None\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertEqual(images, images)\n+        self.assertEqual(text, None)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertEqual(images, images)\n+        self.assertEqual(text, None)\n+\n+        # incorrect inputs\n+        images = \"text\"\n+        text = \"text\"\n+        with self.assertRaises(ValueError):\n+            _validate_images_text_input_order(images=images, text=text)\n+\n+    @require_torch\n+    def test_validate_images_text_input_order_torch(self):\n+        # text string and torch images inputs\n+        images = torch.rand(224, 224, 3)\n+        text = \"text\"\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertTrue(torch.equal(valid_images, images))\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertTrue(torch.equal(valid_images, images))\n+        self.assertEqual(valid_text, text)\n+\n+        # text list of string and list of torch images inputs\n+        images = [torch.rand(224, 224, 3), torch.rand(224, 224, 3)]\n+        text = [\"text1\", \"text2\"]\n+        # test correct text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=images, text=text)\n+        self.assertTrue(torch.equal(valid_images[0], images[0]))\n+        self.assertEqual(valid_text, text)\n+        # test incorrect text and images order\n+        valid_images, valid_text = _validate_images_text_input_order(images=text, text=images)\n+        self.assertTrue(torch.equal(valid_images[0], images[0]))\n+        self.assertEqual(valid_text, text)"
        }
    ],
    "stats": {
        "total": 210,
        "additions": 209,
        "deletions": 1
    }
}