{
    "author": "yonigozlan",
    "message": "Fix handling of slow/fast image processors in image_processing_auto.py (#38161)\n\nFix wrong error when torchvision is not installed",
    "sha": "cba94e92724be4080173c4379381dbd5801495a5",
    "files": [
        {
            "sha": "059c4c40e682effb1fe1a697e55058a47088a7ec",
            "filename": "src/transformers/models/auto/image_processing_auto.py",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/huggingface/transformers/blob/cba94e92724be4080173c4379381dbd5801495a5/src%2Ftransformers%2Fmodels%2Fauto%2Fimage_processing_auto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/cba94e92724be4080173c4379381dbd5801495a5/src%2Ftransformers%2Fmodels%2Fauto%2Fimage_processing_auto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fauto%2Fimage_processing_auto.py?ref=cba94e92724be4080173c4379381dbd5801495a5",
            "patch": "@@ -511,15 +511,20 @@ def from_pretrained(cls, pretrained_model_name_or_path, *inputs, **kwargs):\n                         \"`use_fast=True` will be the default behavior in v4.52, even if the model was saved with a slow processor. \"\n                         \"This will result in minor differences in outputs. You'll still be able to use a slow processor with `use_fast=False`.\"\n                     )\n-            # Update class name to reflect the use_fast option. If class is not found, we fall back to the slow version.\n+            if use_fast and not image_processor_type.endswith(\"Fast\"):\n+                image_processor_type += \"Fast\"\n             if use_fast and not is_torchvision_available():\n+                # check if there is a slow image processor class to fallback to\n+                image_processor_class = get_image_processor_class_from_name(image_processor_type[:-4])\n+                if image_processor_class is None:\n+                    raise ValueError(\n+                        f\"`{image_processor_type}` requires `torchvision` to be installed. Please install `torchvision` and try again.\"\n+                    )\n                 logger.warning_once(\n                     \"Using `use_fast=True` but `torchvision` is not available. Falling back to the slow image processor.\"\n                 )\n                 use_fast = False\n             if use_fast:\n-                if not image_processor_type.endswith(\"Fast\"):\n-                    image_processor_type += \"Fast\"\n                 for _, image_processors in IMAGE_PROCESSOR_MAPPING_NAMES.items():\n                     if image_processor_type in image_processors:\n                         break\n@@ -532,10 +537,14 @@ def from_pretrained(cls, pretrained_model_name_or_path, *inputs, **kwargs):\n                     )\n                 image_processor_class = get_image_processor_class_from_name(image_processor_type)\n             else:\n-                image_processor_type = (\n+                image_processor_type_slow = (\n                     image_processor_type[:-4] if image_processor_type.endswith(\"Fast\") else image_processor_type\n                 )\n-                image_processor_class = get_image_processor_class_from_name(image_processor_type)\n+                image_processor_class = get_image_processor_class_from_name(image_processor_type_slow)\n+                if image_processor_class is None and image_processor_type.endswith(\"Fast\"):\n+                    raise ValueError(\n+                        f\"`{image_processor_type}` does not have a slow version. Please set `use_fast=True` when instantiating the processor.\"\n+                    )\n \n         has_remote_code = image_processor_auto_map is not None\n         has_local_code = image_processor_class is not None or type(config) in IMAGE_PROCESSOR_MAPPING"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 14,
        "deletions": 5
    }
}