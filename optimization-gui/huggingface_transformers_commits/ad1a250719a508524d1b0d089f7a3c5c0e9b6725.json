{
    "author": "MagnusS0",
    "message": "[Docs] Add Developer Guide: How to Hack Any Transformers Model (#33979)\n\n* docs: add example for separating q, k, v projections in SAM\r\n\r\n* docs: How to Hack Any Transformers Model\r\n\r\n* docs: remove changes from sam model docs\r\n\r\n* Apply suggestions from code review\r\n\r\nCo-authored-by: Arthur <48595927+ArthurZucker@users.noreply.github.com>\r\n\r\n---------\r\n\r\nCo-authored-by: Arthur <48595927+ArthurZucker@users.noreply.github.com>",
    "sha": "ad1a250719a508524d1b0d089f7a3c5c0e9b6725",
    "files": [
        {
            "sha": "36e1d069e0150652be3c4ffdbda151a657ca9b41",
            "filename": "docs/source/en/_toctree.yml",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/ad1a250719a508524d1b0d089f7a3c5c0e9b6725/docs%2Fsource%2Fen%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ad1a250719a508524d1b0d089f7a3c5c0e9b6725/docs%2Fsource%2Fen%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2F_toctree.yml?ref=ad1a250719a508524d1b0d089f7a3c5c0e9b6725",
            "patch": "@@ -153,6 +153,8 @@\n     title: Interoperability with TikToken files\n   - local: modular_transformers\n     title: Modularity in `transformers`\n+  - local: how_to_hack_models\n+    title: Model Hacking (overwriting a class to your usage)\n   title: Developer guides\n - sections:\n   - local: quantization/overview\n@@ -965,4 +967,4 @@\n     - local: internal/time_series_utils\n       title: Utilities for Time Series\n     title: Internal Helpers\n-  title: API\n+  title: API\n\\ No newline at end of file"
        },
        {
            "sha": "411539e104bfc286f5999bd4a8325e4d788a6ea8",
            "filename": "docs/source/en/how_to_hack_models.md",
            "status": "added",
            "additions": 180,
            "deletions": 0,
            "changes": 180,
            "blob_url": "https://github.com/huggingface/transformers/blob/ad1a250719a508524d1b0d089f7a3c5c0e9b6725/docs%2Fsource%2Fen%2Fhow_to_hack_models.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/ad1a250719a508524d1b0d089f7a3c5c0e9b6725/docs%2Fsource%2Fen%2Fhow_to_hack_models.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fhow_to_hack_models.md?ref=ad1a250719a508524d1b0d089f7a3c5c0e9b6725",
            "patch": "@@ -0,0 +1,180 @@\n+<!--Copyright 2024 The HuggingFace Team. All rights reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+the License. You may obtain a copy of the License at\n+\n+http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+\n+âš ï¸ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be\n+rendered properly in your Markdown viewer.\n+\n+-->\n+\n+# How to Hack Any Transformers Model\n+\n+The [ðŸ¤— Transformers](https://github.com/huggingface/transformers) library offers a collection of pre-trained models and tools for natural language processing, vision, and beyond. While these models cover a wide range of applications, you might encounter use cases that aren't supported out of the box. Customizing models can unlock new possibilities, such as adding new layers, altering architectures, or optimizing attention mechanisms. This guide will show you how to modify existing Transformers models to fit your specific needs. The great thing is, you donâ€™t have to step away from the Transformers framework to make these changes. You can actually modify models directly in Transformers and still take advantage of features like the [Trainer API](https://huggingface.co/docs/transformers/main/en/main_classes/trainer), [PreTrainedModel](https://huggingface.co/docs/transformers/main/en/main_classes/model#transformers.PreTrainedModel), and efficient fine-tuning with tools like [PEFT](https://huggingface.co/docs/peft/index).\n+\n+In this guide, weâ€™ll walk you through how to customize existing Transformers models to meet your requirementsâ€”without losing the benefits of the ecosystem.\n+\n+You'll learn how to:\n+\n+- Modify a model's architecture by changing its attention mechanism.\n+- Apply techniques like Low-Rank Adaptation (LoRA) to specific model components.\n+\n+We encourage you to contribute your own hacks and share them here with the community1\n+\n+## Example: Modifying the Attention Mechanism in the Segment Anything Model (SAM)\n+\n+The **Segment Anything Model (SAM)** is a state-of-the-art model for image segmentation. In its default implementation, SAM uses a combined query-key-value (`qkv`) projection in its attention mechanism. However, you might want to fine-tune only specific components of the attention mechanism, such as the query (`q`) and value (`v`) projections, to reduce the number of trainable parameters and computational resources required.\n+\n+### Motivation\n+\n+By splitting the combined `qkv` projection into separate `q`, `k`, and `v` projections, you can apply techniques like **LoRA** (Low-Rank Adaptation) to only the `q` and `v` projections. This approach allows you to:\n+\n+- Fine-tune fewer parameters, reducing computational overhead.\n+- Potentially achieve better performance by focusing on specific components.\n+- Experiment with different adaptation strategies in the attention mechanism.\n+\n+### Implementation\n+\n+#### **Step 1: Create a Custom Attention Class**\n+\n+Next, subclass the original `SamVisionAttention` class and modify it to have separate `q`, `k`, and `v` projections.\n+\n+```python\n+import torch\n+import torch.nn as nn\n+from transformers.models.sam.modeling_sam import SamVisionAttention\n+\n+class SamVisionAttentionSplit(SamVisionAttention, nn.Module):\n+    def __init__(self, config, window_size):\n+        super().__init__(config, window_size)\n+        del self.qkv\n+        # Separate q, k, v projections\n+        self.q = nn.Linear(config.hidden_size, config.hidden_size, bias=config.qkv_bias)\n+        self.k = nn.Linear(config.hidden_size, config.hidden_size, bias=config.qkv_bias)\n+        self.v = nn.Linear(config.hidden_size, config.hidden_size, bias=config.qkv_bias)\n+        self._register_load_state_dict_pre_hook(self.split_q_k_v_load_hook)\n+\n+    def split_q_k_v_load_hook(self, state_dict, prefix, *args):\n+        keys_to_delete = []\n+        for key in list(state_dict.keys()):\n+            if \"qkv.\" in key:\n+                # Split q, k, v from the combined projection\n+                q, k, v = state_dict[key].chunk(3, dim=0)\n+                # Replace with individual q, k, v projections\n+                state_dict[key.replace(\"qkv.\", \"q.\")] = q\n+                state_dict[key.replace(\"qkv.\", \"k.\")] = k\n+                state_dict[key.replace(\"qkv.\", \"v.\")] = v\n+                # Mark the old qkv key for deletion\n+                keys_to_delete.append(key)\n+        \n+        # Remove old qkv keys\n+        for key in keys_to_delete:\n+            del state_dict[key]\n+\n+    def forward(self, hidden_states: torch.Tensor, output_attentions=False) -> torch.Tensor:\n+        batch_size, height, width, _ = hidden_states.shape\n+        qkv_shapes = (batch_size *  self.num_attention_heads,  height * width, -1)\n+        query = self.q(hidden_states).reshape((batch_size,  height * width,self.num_attention_heads, -1)).permute(0,2,1,3).reshape(qkv_shapes)\n+        key = self.k(hidden_states).reshape((batch_size,  height * width,self.num_attention_heads, -1)).permute(0,2,1,3).reshape(qkv_shapes)\n+        value = self.v(hidden_states).reshape((batch_size,  height * width,self.num_attention_heads, -1)).permute(0,2,1,3).reshape(qkv_shapes)\n+\n+        attn_weights = (query * self.scale) @ key.transpose(-2, -1)\n+\n+        if self.use_rel_pos:\n+            attn_weights = self.add_decomposed_rel_pos(\n+                attn_weights, query, self.rel_pos_h, self.rel_pos_w, (height, width), (height, width)\n+            )\n+\n+        attn_weights = torch.nn.functional.softmax(attn_weights, dtype=torch.float32, dim=-1).to(query.dtype)\n+        attn_probs = nn.functional.dropout(attn_weights, p=self.dropout, training=self.training)\n+        attn_output = (attn_probs @ value).reshape(batch_size, self.num_attention_heads, height, width, -1)\n+        attn_output = attn_output.permute(0, 2, 3, 1, 4).reshape(batch_size, height, width, -1)\n+        attn_output = self.proj(attn_output)\n+\n+        if output_attentions:\n+            outputs = (attn_output, attn_weights)\n+        else:\n+            outputs = (attn_output, None)\n+        return outputs\n+```\n+\n+**Explanation:**\n+\n+- **Separate Projections:** The combined `qkv` projection is removed, and separate `q`, `k`, and `v` linear layers are created.\n+- **Weight Loading Hook:** The `_split_qkv_load_hook` method splits the pre-trained `qkv` weights into separate `q`, `k`, and `v` weights when loading the model. This ensures compatibility with any pre-trained model.\n+- **Forward Pass:** Queries, keys, and values are computed separately, and the attention mechanism proceeds as usual.\n+\n+#### **Step 2: Replace the Original Attention Class**\n+\n+Replace the original `SamVisionAttention` class with your custom class so that the model uses the modified attention mechanism.\n+\n+```python\n+from transformers import SamModel\n+from transformers.models.sam import modeling_sam\n+\n+# Replace the attention class in the modeling_sam module\n+modeling_sam.SamVisionAttention = SamVisionAttentionSplit\n+\n+# Load the pre-trained SAM model\n+model = SamModel.from_pretrained(\"facebook/sam-vit-base\")\n+```\n+\n+**Explanation:**\n+\n+- **Class Replacement:** By assigning your custom class to `modeling_sam.SamVisionAttention`, any instances of `SamVisionAttention` in the model will use the modified version. Thus when you call `SamModel`, it will use the newly defined `SamVisionAttentionSplit`. \n+- **Model Loading:** The model is loaded using `from_pretrained`, and the custom attention mechanism is integrated.\n+\n+#### **Step 3: Apply LoRA to Specific Projections**\n+\n+With separate `q`, `k`, and `v` projections, you can now apply LoRA to specific components, such as the `q` and `v` projections.\n+\n+```python\n+from peft import LoraConfig, get_peft_model\n+\n+config = LoraConfig(\n+    r=16,\n+    lora_alpha=32,\n+    target_modules=[\"q\", \"v\"],  # Apply LoRA to q and v projections\n+    lora_dropout=0.1,\n+    task_type=\"mask-generation\"\n+)\n+\n+# Apply LoRA to the model\n+model = get_peft_model(model, config)\n+```\n+\n+**Explanation:**\n+\n+- **LoRA Configuration:** The `LoraConfig` specifies the rank `r`, scaling factor `lora_alpha`, target modules (`\"q\"` and `\"v\"`), dropout, and task type.\n+- **Applying LoRA:** The `get_peft_model` function applies LoRA to the specified modules in the model.\n+- **Parameter Reduction:** By focusing on `q` and `v`, you reduce the number of trainable parameters, leading to faster training and lower memory usage.\n+\n+#### **Step 4: Verify the Number of Trainable Parameters**\n+\n+It's simple to verify the number of trainable parameters and see what impact your modification had. \n+\n+```python\n+model.print_trainable_parameters()\n+```\n+\n+**Expected Output:**\n+\n+```\n+trainable params: 608,256 || all params: 94,343,728 || trainable%: 0.6447\n+trainable params: 912,384 || all params: 94,647,856 || trainable%: 0.9640 # with k \n+```\n+\n+## Contributing Your Own Hacks\n+\n+Modifying pre-trained models can open up new avenues for research and application. By understanding and adjusting the internal mechanisms of models like SAM, you can tailor them to your specific needs, optimize performance, and experiment with new ideas.\n+\n+If you've developed your own hacks for Transformers models and would like to share them, consider contributing to this doc.\n+\n+- **Open a Pull Request:** Share your code changes and improvements directly in the repository.\n+- **Write Documentation:** Provide clear explanations and examples of your modifications.\n+- **Engage with the Community:** Discuss your ideas and get feedback from other developers and researchers by opening an issue.\n\\ No newline at end of file"
        },
        {
            "sha": "f45b08c2c23540c27bcaf15b9d4d834237e62b3a",
            "filename": "docs/source/en/model_doc/sam.md",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/ad1a250719a508524d1b0d089f7a3c5c0e9b6725/docs%2Fsource%2Fen%2Fmodel_doc%2Fsam.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/ad1a250719a508524d1b0d089f7a3c5c0e9b6725/docs%2Fsource%2Fen%2Fmodel_doc%2Fsam.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmodel_doc%2Fsam.md?ref=ad1a250719a508524d1b0d089f7a3c5c0e9b6725",
            "patch": "@@ -93,7 +93,6 @@ masks = processor.image_processor.post_process_masks(\n )\n scores = outputs.iou_scores\n ```\n-\n ## Resources\n \n A list of official Hugging Face and community (indicated by ðŸŒŽ) resources to help you get started with SAM."
        }
    ],
    "stats": {
        "total": 185,
        "additions": 183,
        "deletions": 2
    }
}