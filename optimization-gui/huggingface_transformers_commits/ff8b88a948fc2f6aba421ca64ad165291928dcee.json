{
    "author": "ydshieh",
    "message": "Fix nightly torch CI (#40469)\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "ff8b88a948fc2f6aba421ca64ad165291928dcee",
    "files": [
        {
            "sha": "48edaf8187fedfcc0bfa93f92ff48ac20e0e9113",
            "filename": ".github/workflows/self-nightly-caller.yml",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/huggingface/transformers/blob/ff8b88a948fc2f6aba421ca64ad165291928dcee/.github%2Fworkflows%2Fself-nightly-caller.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ff8b88a948fc2f6aba421ca64ad165291928dcee/.github%2Fworkflows%2Fself-nightly-caller.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-nightly-caller.yml?ref=ff8b88a948fc2f6aba421ca64ad165291928dcee",
            "patch": "@@ -12,12 +12,34 @@ on:\n     branches:\n       - run_ci_with_nightly_torch*\n \n+# Used for `push` to easily modify the target workflow runs to compare against\n+env:\n+    prev_workflow_run_id: \"\"\n+    other_workflow_run_id: \"\"\n+\n+\n jobs:\n   build_nightly_torch_ci_images:\n     name: Build CI Docker Images with nightly torch\n     uses: ./.github/workflows/build-nightly-ci-docker-images.yml\n     secrets: inherit\n \n+  setup:\n+    name: Setup\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - name: Setup\n+        run: |\n+          mkdir \"setup_values\"\n+          echo \"${{ inputs.prev_workflow_run_id || env.prev_workflow_run_id }}\" > \"setup_values/prev_workflow_run_id.txt\"\n+          echo \"${{ inputs.other_workflow_run_id || env.other_workflow_run_id }}\" > \"setup_values/other_workflow_run_id.txt\"\n+\n+      - name: Upload artifacts\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: setup_values\n+          path: setup_values\n+\n   model-ci:\n     name: Model CI\n     needs: build_nightly_torch_ci_images"
        },
        {
            "sha": "66aef6578fc91d6e52146f3d73ff3c0a876693e4",
            "filename": "docker/transformers-all-latest-gpu/Dockerfile",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/ff8b88a948fc2f6aba421ca64ad165291928dcee/docker%2Ftransformers-all-latest-gpu%2FDockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/ff8b88a948fc2f6aba421ca64ad165291928dcee/docker%2Ftransformers-all-latest-gpu%2FDockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftransformers-all-latest-gpu%2FDockerfile?ref=ff8b88a948fc2f6aba421ca64ad165291928dcee",
            "patch": "@@ -32,7 +32,10 @@ RUN python3 -m pip uninstall -y flax jax\n \n RUN python3 -m pip install --no-cache-dir -U timm\n \n-RUN python3 -m pip install --no-cache-dir git+https://github.com/facebookresearch/detectron2.git pytesseract\n+RUN [ \"$PYTORCH\" != \"pre\" ] && python3 -m pip install --no-cache-dir git+https://github.com/facebookresearch/detectron2.git || echo \"Don't install detectron2 with nightly torch\"\n+\n+RUN python3 -m pip install --no-cache-dir pytesseract\n+\n RUN python3 -m pip install -U \"itsdangerous<2.1.0\"\n \n RUN python3 -m pip install --no-cache-dir git+https://github.com/huggingface/accelerate@main#egg=accelerate\n@@ -52,7 +55,7 @@ RUN python3 -m pip install --no-cache-dir bitsandbytes\n RUN python3 -m pip install --no-cache-dir quanto\n \n # After using A10 as CI runner, let's run FA2 tests\n-RUN python3 -m pip uninstall -y ninja && python3 -m pip install --no-cache-dir ninja && python3 -m pip install flash-attn --no-cache-dir --no-build-isolation\n+RUN [ \"$PYTORCH\" != \"pre\" ] && python3 -m pip uninstall -y ninja && python3 -m pip install --no-cache-dir ninja && python3 -m pip install flash-attn --no-cache-dir --no-build-isolation || echo \"Don't install FA2 with nightly torch\"\n \n # TODO (ydshieh): check this again\n # `quanto` will install `ninja` which leads to many `CUDA error: an illegal memory access ...` in some model tests"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 27,
        "deletions": 2
    }
}