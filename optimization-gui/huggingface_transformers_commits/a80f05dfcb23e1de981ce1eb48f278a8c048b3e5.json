{
    "author": "gante",
    "message": "[generate] cache missing custom generate file (#41216)\n\n* cache missing custom generate file\n\n* make fixup",
    "sha": "a80f05dfcb23e1de981ce1eb48f278a8c048b3e5",
    "files": [
        {
            "sha": "156dca000176574a72f15868c49078137d55a682",
            "filename": "src/transformers/generation/utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 15,
            "changes": 23,
            "blob_url": "https://github.com/huggingface/transformers/blob/a80f05dfcb23e1de981ce1eb48f278a8c048b3e5/src%2Ftransformers%2Fgeneration%2Futils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a80f05dfcb23e1de981ce1eb48f278a8c048b3e5/src%2Ftransformers%2Fgeneration%2Futils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fgeneration%2Futils.py?ref=a80f05dfcb23e1de981ce1eb48f278a8c048b3e5",
            "patch": "@@ -22,7 +22,6 @@\n \n import torch\n import torch.distributed as dist\n-from huggingface_hub import file_exists\n from packaging import version\n from torch import nn\n \n@@ -392,23 +391,20 @@ def load_custom_generate(\n         Returns:\n             A callable that can be used to generate text.\n         \"\"\"\n-        # Does `pretrained_model_name_or_path` have a `custom_generate` subdirectory? If not -> OSError\n-        is_local_code = os.path.exists(pretrained_model_name_or_path)\n-        has_custom_generate_folder = True\n-        if is_local_code:\n-            if not os.path.exists(os.path.join(pretrained_model_name_or_path, \"custom_generate/generate.py\")):\n-                has_custom_generate_folder = False\n-        else:\n-            if not file_exists(pretrained_model_name_or_path, \"custom_generate/generate.py\"):\n-                has_custom_generate_folder = False\n-\n-        if not has_custom_generate_folder:\n+        # Fetches the generate.py file from the model repo. If it doesn't exist, a file in `.no_exist` cache directory\n+        # is created (preventing future hub requests), and an OSError is raised.\n+        try:\n+            module = get_cached_module_file(\n+                pretrained_model_name_or_path, module_file=\"custom_generate/generate.py\", **kwargs\n+            )\n+        except OSError:\n             raise OSError(\n                 f\"`{pretrained_model_name_or_path}` does not contain a `custom_generate` subdirectory with a \"\n                 \"`generate.py` file, can't load the custom generate function.\"\n             )\n \n         # Handle opt-in `trust_remote_code` and related exceptions\n+        is_local_code = os.path.exists(pretrained_model_name_or_path)\n         error_message = (\n             f\"The repository `{pretrained_model_name_or_path}` contains custom generation code that will override \"\n             \"the default `generate` method.\"\n@@ -425,9 +421,6 @@ def load_custom_generate(\n         check_python_requirements(\n             pretrained_model_name_or_path, requirements_file=\"custom_generate/requirements.txt\", **kwargs\n         )\n-        module = get_cached_module_file(\n-            pretrained_model_name_or_path, module_file=\"custom_generate/generate.py\", **kwargs\n-        )\n         custom_generate_function = get_class_in_module(\"generate\", module)\n         return custom_generate_function\n "
        }
    ],
    "stats": {
        "total": 23,
        "additions": 8,
        "deletions": 15
    }
}