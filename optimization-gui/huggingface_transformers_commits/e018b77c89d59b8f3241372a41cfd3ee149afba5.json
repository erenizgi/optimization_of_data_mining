{
    "author": "remi-or",
    "message": "wav2vec2 fixes (#40341)\n\n* Changed datasets to avoid a datasets error\n\n* Changed back split to test",
    "sha": "e018b77c89d59b8f3241372a41cfd3ee149afba5",
    "files": [
        {
            "sha": "006ac1ca77272b5aeb58f7cf8c23379fd2a99f02",
            "filename": "tests/models/wav2vec2/test_modeling_wav2vec2.py",
            "status": "modified",
            "additions": 15,
            "deletions": 12,
            "changes": 27,
            "blob_url": "https://github.com/huggingface/transformers/blob/e018b77c89d59b8f3241372a41cfd3ee149afba5/tests%2Fmodels%2Fwav2vec2%2Ftest_modeling_wav2vec2.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e018b77c89d59b8f3241372a41cfd3ee149afba5/tests%2Fmodels%2Fwav2vec2%2Ftest_modeling_wav2vec2.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fwav2vec2%2Ftest_modeling_wav2vec2.py?ref=e018b77c89d59b8f3241372a41cfd3ee149afba5",
            "patch": "@@ -97,7 +97,7 @@ def _test_wav2vec2_with_lm_invalid_pool(in_queue, out_queue, timeout):\n     try:\n         _ = in_queue.get(timeout=timeout)\n \n-        ds = load_dataset(\"mozilla-foundation/common_voice_11_0\", \"es\", split=\"test\", streaming=True)\n+        ds = load_dataset(\"fixie-ai/common_voice_17_0\", \"es\", split=\"test\", streaming=True)\n         sample = next(iter(ds))\n \n         resampled_audio = torchaudio.functional.resample(\n@@ -118,16 +118,17 @@ def _test_wav2vec2_with_lm_invalid_pool(in_queue, out_queue, timeout):\n         with CaptureLogger(pyctcdecode.decoder.logger) as cl, multiprocessing.get_context(\"spawn\").Pool(1) as pool:\n             transcription = processor.batch_decode(logits.cpu().numpy(), pool).text\n \n+        expected_transcription = \"el resto de los equipos se mantienen en su sede\"\n         unittest.TestCase().assertIn(\"Falling back to sequential decoding.\", cl.out)\n-        unittest.TestCase().assertEqual(transcription[0], \"habitan aguas poco profundas y rocosas\")\n+        unittest.TestCase().assertEqual(transcription[0], expected_transcription)\n \n         # force batch_decode to internally create a spawn pool, which should trigger a warning if different than fork\n         multiprocessing.set_start_method(\"spawn\", force=True)\n         with CaptureLogger(processing_wav2vec2_with_lm.logger) as cl:\n             transcription = processor.batch_decode(logits.cpu().numpy()).text\n \n         unittest.TestCase().assertIn(\"Falling back to sequential decoding.\", cl.out)\n-        unittest.TestCase().assertEqual(transcription[0], \"habitan aguas poco profundas y rocosas\")\n+        unittest.TestCase().assertEqual(transcription[0], expected_transcription)\n     except Exception:\n         error = f\"{traceback.format_exc()}\"\n \n@@ -1828,7 +1829,7 @@ def test_phoneme_recognition(self):\n     @require_pyctcdecode\n     @require_torchaudio\n     def test_wav2vec2_with_lm(self):\n-        ds = load_dataset(\"mozilla-foundation/common_voice_11_0\", \"es\", split=\"test\", streaming=True)\n+        ds = load_dataset(\"fixie-ai/common_voice_17_0\", \"es\", split=\"test\", streaming=True)\n         sample = next(iter(ds))\n \n         resampled_audio = torchaudio.functional.resample(\n@@ -1847,12 +1848,13 @@ def test_wav2vec2_with_lm(self):\n \n         transcription = processor.batch_decode(logits.cpu().numpy()).text\n \n-        self.assertEqual(transcription[0], \"habitan aguas poco profundas y rocosas\")\n+        expected_transcription = \"el resto de los equipos se mantienen en su sede\"\n+        self.assertEqual(transcription[0], expected_transcription)\n \n     @require_pyctcdecode\n     @require_torchaudio\n     def test_wav2vec2_with_lm_pool(self):\n-        ds = load_dataset(\"mozilla-foundation/common_voice_11_0\", \"es\", split=\"test\", streaming=True)\n+        ds = load_dataset(\"fixie-ai/common_voice_17_0\", \"es\", split=\"test\", streaming=True)\n         sample = next(iter(ds))\n \n         resampled_audio = torchaudio.functional.resample(\n@@ -1873,7 +1875,8 @@ def test_wav2vec2_with_lm_pool(self):\n         with multiprocessing.get_context(\"fork\").Pool(2) as pool:\n             transcription = processor.batch_decode(logits.cpu().numpy(), pool).text\n \n-        self.assertEqual(transcription[0], \"habitan aguas poco profundas y rocosas\")\n+        expected_transcription = \"el resto de los equipos se mantienen en su sede\"\n+        self.assertEqual(transcription[0], expected_transcription)\n \n         # user-managed pool + num_processes should trigger a warning\n         with (\n@@ -1885,7 +1888,7 @@ def test_wav2vec2_with_lm_pool(self):\n         self.assertIn(\"num_process\", cl.out)\n         self.assertIn(\"it will be ignored\", cl.out)\n \n-        self.assertEqual(transcription[0], \"habitan aguas poco profundas y rocosas\")\n+        self.assertEqual(transcription[0], expected_transcription)\n \n     @require_pyctcdecode\n     @require_torchaudio\n@@ -1951,7 +1954,7 @@ def test_inference_mms_1b_all(self):\n         LANG_MAP = {\"it\": \"ita\", \"es\": \"spa\", \"fr\": \"fra\", \"en\": \"eng\"}\n \n         def run_model(lang):\n-            ds = load_dataset(\"mozilla-foundation/common_voice_11_0\", lang, split=\"test\", streaming=True)\n+            ds = load_dataset(\"fixie-ai/common_voice_17_0\", lang, split=\"test\", streaming=True)\n             sample = next(iter(ds))\n \n             wav2vec2_lang = LANG_MAP[lang]\n@@ -1976,9 +1979,9 @@ def run_model(lang):\n             return transcription\n \n         TRANSCRIPTIONS = {\n-            \"it\": \"il libro ha suscitato molte polemiche a causa dei suoi contenuti\",\n-            \"es\": \"habitan aguas poco profundas y rocosas\",\n-            \"fr\": \"ce dernier est vol√© tout au long de l'histoire romaine\",\n+            \"it\": \"viaggiarono in italia dove lavorarono con hamilton\",\n+            \"es\": \"el resto de los equipos se mantienen en su sede\",\n+            \"fr\": \"il a obtenu son batchelor of lows\",\n             \"en\": \"joe keton disapproved of films and buster also had reservations about the media\",\n         }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 15,
        "deletions": 12
    }
}