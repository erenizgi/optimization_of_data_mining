{
    "author": "ArthurZucker",
    "message": "fix the parallel number of CI nodes when it is smaller than number of tests (#33276)\n\n* fix the parallel number\r\n\r\n* this?\r\n\r\n* keep it simple\r\n\r\n* woups\r\n\r\n* nit\r\n\r\n* style\r\n\r\n* fix param name\r\n\r\n* fix\r\n\r\n* fix dtype\r\n\r\n* yups\r\n\r\n* ???\r\n\r\n* ??\r\n\r\n* this?\r\n\r\n* ????\r\n\r\n* no default flow style\r\n\r\n* ??\r\n\r\n* print config\r\n\r\n* ????\r\n\r\n* there we go!\r\n\r\n* documentation\r\n\r\n* update\r\n\r\n* remove unwanted file",
    "sha": "979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a",
    "files": [
        {
            "sha": "483e315e260c6ddaecdbd624a7be0a5e3b68bfd4",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fconfig.yml?ref=979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a",
            "patch": "@@ -55,9 +55,9 @@ jobs:\n                     url=\"https://circleci.com/api/v2/project/${project_slug}/${job_number}/artifacts\"\n                     curl -o  test_preparation/artifacts.json ${url}\n             - run:\n-                name: \"Show Artifacts\"\n+                name: \"Prepare pipeline parameters\"\n                 command: |\n-                    cat test_preparation/artifacts.json | jq '.items | map({(.path | split(\"/\")[-1][:-4]): .url}) | add | del(.[\"generated_config\"])' > test_preparation/transformed_artifacts.json\n+                    python utils/process_test_artifacts.py \n             \n             # To avoid too long generated_config.yaml on the continuation orb, we pass the links to the artifacts as parameters.\n             # Otherwise the list of tests was just too big. Explicit is good but for that it was a limitation.\n@@ -68,6 +68,8 @@ jobs:\n                 \n             - store_artifacts:\n                 path: test_preparation/transformed_artifacts.json\n+            - store_artifacts:\n+                path: test_preparation/artifacts.json\n             - continuation/continue:\n                 parameters:  test_preparation/transformed_artifacts.json\n                 configuration_path: test_preparation/generated_config.yml"
        },
        {
            "sha": "d8d3e7d86cf383b03ffdb1b62c70dbb12f386d68",
            "filename": ".circleci/create_circleci_config.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a/.circleci%2Fcreate_circleci_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a/.circleci%2Fcreate_circleci_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fcreate_circleci_config.py?ref=979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a",
            "patch": "@@ -113,6 +113,7 @@ def to_dict(self):\n         timeout_cmd = f\"timeout {self.command_timeout} \" if self.command_timeout else \"\"\n         marker_cmd = f\"-m '{self.marker}'\" if self.marker is not None else \"\"\n         additional_flags = f\" -p no:warning -o junit_family=xunit1 --junitxml=test-results/junit.xml\"\n+        parallel = f' << pipeline.parameters.{self.job_name}_parallelism >> '\n         steps = [\n             \"checkout\",\n             {\"attach_workspace\": {\"at\": \"test_preparation\"}},\n@@ -133,7 +134,7 @@ def to_dict(self):\n             },\n             {\"run\": {\"name\": \"Create `test-results` directory\", \"command\": \"mkdir test-results\"}},\n             {\"run\": {\"name\": \"Get files to test\", \"command\":f'curl -L -o {self.job_name}_test_list.txt <<pipeline.parameters.{self.job_name}_test_list>>' if self.name != \"pr_documentation_tests\" else 'echo \"Skipped\"'}},\n-            {\"run\": {\"name\": \"Split tests across parallel nodes: show current parallel tests\",\n+                        {\"run\": {\"name\": \"Split tests across parallel nodes: show current parallel tests\",\n                     \"command\": f\"TESTS=$(circleci tests split  --split-by=timings {self.job_name}_test_list.txt) && echo $TESTS > splitted_tests.txt && echo $TESTS | tr ' ' '\\n'\" if self.parallelism else f\"awk '{{printf \\\"%s \\\", $0}}' {self.job_name}_test_list.txt > splitted_tests.txt\"\n                     }\n             },\n@@ -152,7 +153,7 @@ def to_dict(self):\n             {\"store_artifacts\": {\"path\": \"installed.txt\"}},\n         ]\n         if self.parallelism:\n-            job[\"parallelism\"] = self.parallelism\n+            job[\"parallelism\"] = parallel\n         job[\"steps\"] = steps\n         return job\n \n@@ -359,12 +360,13 @@ def create_circleci_config(folder=None):\n             \"nightly\": {\"type\": \"boolean\", \"default\": False},\n             \"tests_to_run\": {\"type\": \"string\", \"default\": ''},\n             **{j.job_name + \"_test_list\":{\"type\":\"string\", \"default\":''} for j in jobs},\n+            **{j.job_name + \"_parallelism\":{\"type\":\"integer\", \"default\":1} for j in jobs},\n         },\n         \"jobs\" : {j.job_name: j.to_dict() for j in jobs},\n         \"workflows\": {\"version\": 2, \"run_tests\": {\"jobs\": [j.job_name for j in jobs]}}\n     }\n     with open(os.path.join(folder, \"generated_config.yml\"), \"w\") as f:\n-        f.write(yaml.dump(config, indent=2, width=1000000, sort_keys=False))\n+        f.write(yaml.dump(config, sort_keys=False, default_flow_style=False).replace(\"' << pipeline\", \" << pipeline\").replace(\">> '\", \" >>\"))\n \n \n if __name__ == \"__main__\":"
        },
        {
            "sha": "e685a99095067b012fc8a036dd7555c6b0143271",
            "filename": "utils/process_test_artifacts.py",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/huggingface/transformers/blob/979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a/utils%2Fprocess_test_artifacts.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a/utils%2Fprocess_test_artifacts.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fprocess_test_artifacts.py?ref=979d24e7fd82a10d1457d500bef8ec3b5ddf2f8a",
            "patch": "@@ -0,0 +1,75 @@\n+# coding=utf-8\n+# Copyright 2024 The HuggingFace Inc. team.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\"\"\"\n+\n+This helper computes the \"ideal\" number of nodes to use in circle CI.\n+For each job, we compute this parameter and pass it to the `generated_config.yaml`.\n+\"\"\"\n+\n+import json\n+import math\n+import os\n+\n+\n+MAX_PARALLEL_NODES = 8  # TODO create a mapping!\n+AVERAGE_TESTS_PER_NODES = 5\n+\n+\n+def count_lines(filepath):\n+    \"\"\"Count the number of lines in a file.\"\"\"\n+    try:\n+        with open(filepath, \"r\") as f:\n+            return len(f.read().split(\"\\n\"))\n+    except FileNotFoundError:\n+        return 0\n+\n+\n+def compute_parallel_nodes(line_count, max_tests_per_node=10):\n+    \"\"\"Compute the number of parallel nodes required.\"\"\"\n+    num_nodes = math.ceil(line_count / AVERAGE_TESTS_PER_NODES)\n+    if line_count < 4:\n+        return 1\n+    return min(MAX_PARALLEL_NODES, num_nodes)\n+\n+\n+def process_artifacts(input_file, output_file):\n+    # Read the JSON data from the input file\n+    with open(input_file, \"r\") as f:\n+        data = json.load(f)\n+\n+    # Process items and build the new JSON structure\n+    transformed_data = {}\n+    for item in data.get(\"items\", []):\n+        if \"test_list\" in item[\"path\"]:\n+            key = os.path.splitext(os.path.basename(item[\"path\"]))[0]\n+            transformed_data[key] = item[\"url\"]\n+            parallel_key = key.split(\"_test\")[0] + \"_parallelism\"\n+            file_path = os.path.join(\"test_preparation\", f\"{key}.txt\")\n+            line_count = count_lines(file_path)\n+            transformed_data[parallel_key] = compute_parallel_nodes(line_count)\n+\n+    # Remove the \"generated_config\" key if it exists\n+    if \"generated_config\" in transformed_data:\n+        del transformed_data[\"generated_config\"]\n+\n+    # Write the transformed data to the output file\n+    with open(output_file, \"w\") as f:\n+        json.dump(transformed_data, f, indent=2)\n+\n+\n+if __name__ == \"__main__\":\n+    input_file = \"test_preparation/artifacts.json\"\n+    output_file = \"test_preparation/transformed_artifacts.json\"\n+    process_artifacts(input_file, output_file)"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 84,
        "deletions": 5
    }
}