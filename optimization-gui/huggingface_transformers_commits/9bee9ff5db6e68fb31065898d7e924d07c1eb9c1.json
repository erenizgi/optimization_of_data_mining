{
    "author": "Rocketknight1",
    "message": "Un-deprecate timeout arg in pipelines (#34382)\n\n* Un-deprecate timeout\r\n\r\n* Put \"timeout\" on the allowed list\r\n\r\n* make fixup",
    "sha": "9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
    "files": [
        {
            "sha": "2203ac09c9cf9b6e9a51055c60678f5266ddd439",
            "filename": "src/transformers/pipelines/depth_estimation.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fdepth_estimation.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fdepth_estimation.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fdepth_estimation.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -1,4 +1,3 @@\n-import warnings\n from typing import List, Union\n \n from ..utils import (\n@@ -72,6 +71,9 @@ def __call__(self, inputs: Union[str, List[str], \"Image.Image\", List[\"Image.Imag\n                 A dictionary of argument names to parameter values, to control pipeline behaviour.\n                 The only parameter available right now is `timeout`, which is the length of time, in seconds,\n                 that the pipeline should wait before giving up on trying to download an image.\n+            timeout (`float`, *optional*, defaults to None):\n+                The maximum time in seconds to wait for fetching images from the web. If None, no timeout is set and\n+                the call may block forever.\n \n         Return:\n             A dictionary or a list of dictionaries containing result. If the input is a single image, will return a\n@@ -93,9 +95,6 @@ def __call__(self, inputs: Union[str, List[str], \"Image.Image\", List[\"Image.Imag\n     def _sanitize_parameters(self, timeout=None, parameters=None, **kwargs):\n         preprocess_params = {}\n         if timeout is not None:\n-            warnings.warn(\n-                \"The `timeout` argument is deprecated and will be removed in version 5 of Transformers\", FutureWarning\n-            )\n             preprocess_params[\"timeout\"] = timeout\n         if isinstance(parameters, dict) and \"timeout\" in parameters:\n             preprocess_params[\"timeout\"] = parameters[\"timeout\"]"
        },
        {
            "sha": "0085e5eb73f826598dae8461a15431e3e5ef8f80",
            "filename": "src/transformers/pipelines/image_classification.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fimage_classification.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fimage_classification.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fimage_classification.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -11,7 +11,6 @@\n # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n # See the License for the specific language governing permissions and\n # limitations under the License.\n-import warnings\n from typing import List, Union\n \n import numpy as np\n@@ -113,9 +112,6 @@ def __init__(self, *args, **kwargs):\n     def _sanitize_parameters(self, top_k=None, function_to_apply=None, timeout=None):\n         preprocess_params = {}\n         if timeout is not None:\n-            warnings.warn(\n-                \"The `timeout` argument is deprecated and will be removed in version 5 of Transformers\", FutureWarning\n-            )\n             preprocess_params[\"timeout\"] = timeout\n         postprocess_params = {}\n         if top_k is not None:\n@@ -159,6 +155,9 @@ def __call__(self, inputs: Union[str, List[str], \"Image.Image\", List[\"Image.Imag\n             top_k (`int`, *optional*, defaults to 5):\n                 The number of top labels that will be returned by the pipeline. If the provided number is higher than\n                 the number of labels available in the model configuration, it will default to the number of labels.\n+            timeout (`float`, *optional*, defaults to None):\n+                The maximum time in seconds to wait for fetching images from the web. If None, no timeout is set and\n+                the call may block forever.\n \n         Return:\n             A dictionary or a list of dictionaries containing result. If the input is a single image, will return a"
        },
        {
            "sha": "d388e591bf9df45c4905a6c8ff86fdce1e123906",
            "filename": "src/transformers/pipelines/image_segmentation.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fimage_segmentation.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fimage_segmentation.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fimage_segmentation.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -1,4 +1,3 @@\n-import warnings\n from typing import Any, Dict, List, Union\n \n import numpy as np\n@@ -91,9 +90,6 @@ def _sanitize_parameters(self, **kwargs):\n         if \"overlap_mask_area_threshold\" in kwargs:\n             postprocess_kwargs[\"overlap_mask_area_threshold\"] = kwargs[\"overlap_mask_area_threshold\"]\n         if \"timeout\" in kwargs:\n-            warnings.warn(\n-                \"The `timeout` argument is deprecated and will be removed in version 5 of Transformers\", FutureWarning\n-            )\n             preprocess_kwargs[\"timeout\"] = kwargs[\"timeout\"]\n \n         return preprocess_kwargs, {}, postprocess_kwargs\n@@ -122,6 +118,9 @@ def __call__(self, inputs=None, **kwargs) -> Union[Predictions, List[Prediction]\n                 Threshold to use when turning the predicted masks into binary values.\n             overlap_mask_area_threshold (`float`, *optional*, defaults to 0.5):\n                 Mask overlap threshold to eliminate small, disconnected segments.\n+            timeout (`float`, *optional*, defaults to None):\n+                The maximum time in seconds to wait for fetching images from the web. If None, no timeout is set and\n+                the call may block forever.\n \n         Return:\n             A dictionary or a list of dictionaries containing the result. If the input is a single image, will return a"
        },
        {
            "sha": "0d37ce91dadc899dbd5137f203a3e1934a96e936",
            "filename": "src/transformers/pipelines/image_to_text.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fimage_to_text.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fimage_to_text.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fimage_to_text.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -13,7 +13,6 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n \n-import warnings\n from typing import List, Union\n \n from ..utils import (\n@@ -81,9 +80,6 @@ def _sanitize_parameters(self, max_new_tokens=None, generate_kwargs=None, prompt\n         if prompt is not None:\n             preprocess_params[\"prompt\"] = prompt\n         if timeout is not None:\n-            warnings.warn(\n-                \"The `timeout` argument is deprecated and will be removed in version 5 of Transformers\", FutureWarning\n-            )\n             preprocess_params[\"timeout\"] = timeout\n \n         if max_new_tokens is not None:\n@@ -118,6 +114,10 @@ def __call__(self, inputs: Union[str, List[str], \"Image.Image\", List[\"Image.Imag\n             generate_kwargs (`Dict`, *optional*):\n                 Pass it to send all of these arguments directly to `generate` allowing full control of this function.\n \n+            timeout (`float`, *optional*, defaults to None):\n+                The maximum time in seconds to wait for fetching images from the web. If None, no timeout is set and\n+                the call may block forever.\n+\n         Return:\n             A list or a list of list of `dict`: Each result comes as a dictionary with the following key:\n "
        },
        {
            "sha": "c84f17b2bd6ad0ac2bbbe95a3421e7197a5744c6",
            "filename": "src/transformers/pipelines/object_detection.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fobject_detection.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fobject_detection.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fobject_detection.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -1,4 +1,3 @@\n-import warnings\n from typing import Any, Dict, List, Union\n \n from ..utils import add_end_docstrings, is_torch_available, is_vision_available, logging, requires_backends\n@@ -64,9 +63,6 @@ def __init__(self, *args, **kwargs):\n     def _sanitize_parameters(self, **kwargs):\n         preprocess_params = {}\n         if \"timeout\" in kwargs:\n-            warnings.warn(\n-                \"The `timeout` argument is deprecated and will be removed in version 5 of Transformers\", FutureWarning\n-            )\n             preprocess_params[\"timeout\"] = kwargs[\"timeout\"]\n         postprocess_kwargs = {}\n         if \"threshold\" in kwargs:\n@@ -89,6 +85,9 @@ def __call__(self, *args, **kwargs) -> Union[Predictions, List[Prediction]]:\n                 same format: all as HTTP(S) links, all as local paths, or all as PIL images.\n             threshold (`float`, *optional*, defaults to 0.5):\n                 The probability necessary to make a prediction.\n+            timeout (`float`, *optional*, defaults to None):\n+                The maximum time in seconds to wait for fetching images from the web. If None, no timeout is set and\n+                the call may block forever.\n \n         Return:\n             A list of dictionaries or a list of list of dictionaries containing the result. If the input is a single"
        },
        {
            "sha": "c53b515dcccd9c1f277a3f8a8871be08661e7a1c",
            "filename": "src/transformers/pipelines/zero_shot_image_classification.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fzero_shot_image_classification.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/src%2Ftransformers%2Fpipelines%2Fzero_shot_image_classification.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fzero_shot_image_classification.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -94,6 +94,10 @@ def __call__(self, image: Union[str, List[str], \"Image\", List[\"Image\"]] = None,\n                 replacing the placeholder with the candidate_labels. Pass \"{}\" if *candidate_labels* are\n                 already formatted.\n \n+            timeout (`float`, *optional*, defaults to None):\n+                The maximum time in seconds to wait for fetching images from the web. If None, no timeout is set and\n+                the call may block forever.\n+\n         Return:\n             A list of dictionaries containing one entry per proposed label. Each dictionary contains the\n             following keys:\n@@ -113,9 +117,6 @@ def _sanitize_parameters(self, tokenizer_kwargs=None, **kwargs):\n         if \"candidate_labels\" in kwargs:\n             preprocess_params[\"candidate_labels\"] = kwargs[\"candidate_labels\"]\n         if \"timeout\" in kwargs:\n-            warnings.warn(\n-                \"The `timeout` argument is deprecated and will be removed in version 5 of Transformers\", FutureWarning\n-            )\n             preprocess_params[\"timeout\"] = kwargs[\"timeout\"]\n         if \"hypothesis_template\" in kwargs:\n             preprocess_params[\"hypothesis_template\"] = kwargs[\"hypothesis_template\"]"
        },
        {
            "sha": "f079bcdd92e580dba0db25657086a1087e93c49a",
            "filename": "tests/test_pipeline_mixin.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/tests%2Ftest_pipeline_mixin.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9bee9ff5db6e68fb31065898d7e924d07c1eb9c1/tests%2Ftest_pipeline_mixin.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_pipeline_mixin.py?ref=9bee9ff5db6e68fb31065898d7e924d07c1eb9c1",
            "patch": "@@ -916,6 +916,8 @@ def parse_args_from_docstring_by_indentation(docstring):\n \n \n def compare_pipeline_args_to_hub_spec(pipeline_class, hub_spec):\n+    ALLOWED_TRANSFORMERS_ONLY_ARGS = [\"timeout\"]\n+\n     docstring = inspect.getdoc(pipeline_class.__call__).strip()\n     docstring_args = set(parse_args_from_docstring_by_indentation(docstring))\n     hub_args = set(get_arg_names_from_hub_spec(hub_spec))\n@@ -933,6 +935,11 @@ def compare_pipeline_args_to_hub_spec(pipeline_class, hub_spec):\n         hub_args.remove(js_generate_args[0])\n         docstring_args.remove(docstring_generate_args[0])\n \n+    # Special casing 2: We permit some transformers-only arguments that don't affect pipeline output\n+    for arg in ALLOWED_TRANSFORMERS_ONLY_ARGS:\n+        if arg in docstring_args and arg not in hub_args:\n+            docstring_args.remove(arg)\n+\n     if hub_args != docstring_args:\n         error = [f\"{pipeline_class.__name__} differs from JS spec {hub_spec.__name__}\"]\n         matching_args = hub_args & docstring_args"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 27,
        "deletions": 23
    }
}