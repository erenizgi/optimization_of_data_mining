{
    "author": "ri938",
    "message": "speed up loading checkpoints for zero stage 3 (#41850)\n\n* update\n\n* update\n\n* update\n\n---------\n\nCo-authored-by: Robert Irvine <robert@seamlessml.com>",
    "sha": "b22d0d07acc3c8617c25af4f7dd0705aa563939b",
    "files": [
        {
            "sha": "e76d586d7a811a28046850f4e39f0ba0d10f7ba0",
            "filename": "src/transformers/integrations/deepspeed.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/b22d0d07acc3c8617c25af4f7dd0705aa563939b/src%2Ftransformers%2Fintegrations%2Fdeepspeed.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b22d0d07acc3c8617c25af4f7dd0705aa563939b/src%2Ftransformers%2Fintegrations%2Fdeepspeed.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fintegrations%2Fdeepspeed.py?ref=b22d0d07acc3c8617c25af4f7dd0705aa563939b",
            "patch": "@@ -314,13 +314,14 @@ def load(module: nn.Module, state_dict, prefix=\"\", assign_to_params_buffers=Fals\n         args = (state_dict, prefix, local_metadata, True, [], [], error_msgs)\n         # Parameters of module and children will start with prefix. We can exit early if there are none in this\n         # state_dict\n-        if is_deepspeed_zero3_enabled() and len([key for key in state_dict if key.startswith(prefix)]) > 0:\n+        if is_deepspeed_zero3_enabled():\n             import deepspeed\n \n             # In sharded models, each shard has only part of the full state_dict, so only gather\n             # parameters that are in the current state_dict.\n             named_parameters = dict(module.named_parameters(prefix=prefix[:-1], recurse=False))\n-            params_to_gather = [named_parameters[k] for k in state_dict if k in named_parameters]\n+            params_to_gather = [named_parameters[k] for k in named_parameters if k in state_dict]\n+\n             if len(params_to_gather) > 0:\n                 # because zero3 puts placeholders in model params, this context\n                 # manager gathers (unpartitions) the params of the current layer, then loads from"
        }
    ],
    "stats": {
        "total": 5,
        "additions": 3,
        "deletions": 2
    }
}