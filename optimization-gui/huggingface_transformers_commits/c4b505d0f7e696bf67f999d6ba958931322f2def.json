{
    "author": "ydshieh",
    "message": "Don't convert to `safetensors` on the fly if the call is from testing (#41194)\n\n* don't convert\n\n* disable\n\n* Update src/transformers/modeling_utils.py\n\nCo-authored-by: Cyril Vallez <cyril.vallez@huggingface.co>\n\n* fix\n\n* disable\n\n* disable\n\n* disable\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\nCo-authored-by: Cyril Vallez <cyril.vallez@huggingface.co>",
    "sha": "c4b505d0f7e696bf67f999d6ba958931322f2def",
    "files": [
        {
            "sha": "1705b2fe5585fb3e9410c11cf4afcbf9d8d70244",
            "filename": ".circleci/create_circleci_config.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/c4b505d0f7e696bf67f999d6ba958931322f2def/.circleci%2Fcreate_circleci_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/c4b505d0f7e696bf67f999d6ba958931322f2def/.circleci%2Fcreate_circleci_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fcreate_circleci_config.py?ref=c4b505d0f7e696bf67f999d6ba958931322f2def",
            "patch": "@@ -29,6 +29,7 @@\n     \"RUN_PIPELINE_TESTS\": False,\n     # will be adjust in `CircleCIJob.to_dict`.\n     \"RUN_FLAKY\": True,\n+    \"DISABLE_SAFETENSORS_CONVERSION\": True,\n }\n # Disable the use of {\"s\": None} as the output is way too long, causing the navigation on CircleCI impractical\n COMMON_PYTEST_OPTIONS = {\"max-worker-restart\": 0, \"vvv\": None, \"rsfE\":None}"
        },
        {
            "sha": "670ceba2f272ace57e743062a417e40943824816",
            "filename": "conftest.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/c4b505d0f7e696bf67f999d6ba958931322f2def/conftest.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/c4b505d0f7e696bf67f999d6ba958931322f2def/conftest.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/conftest.py?ref=c4b505d0f7e696bf67f999d6ba958931322f2def",
            "patch": "@@ -90,6 +90,8 @@ def pytest_configure(config):\n     config.addinivalue_line(\"markers\", \"torch_compile_test: mark test which tests torch compile functionality\")\n     config.addinivalue_line(\"markers\", \"torch_export_test: mark test which tests torch export functionality\")\n \n+    os.environ['DISABLE_SAFETENSORS_CONVERSION'] = 'true'\n+\n \n def pytest_collection_modifyitems(items):\n     for item in items:"
        },
        {
            "sha": "7dcafa323a9c349b8e11ef0cbcc7dc0c57cd3d57",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/c4b505d0f7e696bf67f999d6ba958931322f2def/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/c4b505d0f7e696bf67f999d6ba958931322f2def/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=c4b505d0f7e696bf67f999d6ba958931322f2def",
            "patch": "@@ -1021,7 +1021,12 @@ def _get_resolved_checkpoint_files(\n                         is_sharded = True\n                 if not local_files_only and not is_offline_mode():\n                     if resolved_archive_file is not None:\n-                        if filename in [WEIGHTS_NAME, WEIGHTS_INDEX_NAME]:\n+                        # In a CI environment (CircleCI / Github Actions workflow runs) or in a pytest run,\n+                        # we set `DISABLE_SAFETENSORS_CONVERSION=true` to prevent the conversion.\n+                        if (\n+                            filename in [WEIGHTS_NAME, WEIGHTS_INDEX_NAME]\n+                            and os.getenv(\"DISABLE_SAFETENSORS_CONVERSION\", None) != \"true\"\n+                        ):\n                             # If the PyTorch file was found, check if there is a safetensors file on the repository\n                             # If there is no safetensors file on the repositories, start an auto conversion\n                             safe_weights_name = SAFE_WEIGHTS_INDEX_NAME if is_sharded else SAFE_WEIGHTS_NAME"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}