{
    "author": "ydshieh",
    "message": "Suggest jobs to use in `run-slow` (#39100)\n\n* pr\n\n* pr\n\n* pr\n\n* pr\n\n* pr\n\n* pr\n\n* pr\n\n* pr\n\n* pr\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "ab59cc27fe1e166095f1b53e050a718fa7e86f34",
    "files": [
        {
            "sha": "989281e5b904ff49894908877d5e8d8864b8b1fd",
            "filename": ".github/workflows/get-pr-info.yml",
            "status": "added",
            "additions": 157,
            "deletions": 0,
            "changes": 157,
            "blob_url": "https://github.com/huggingface/transformers/blob/ab59cc27fe1e166095f1b53e050a718fa7e86f34/.github%2Fworkflows%2Fget-pr-info.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ab59cc27fe1e166095f1b53e050a718fa7e86f34/.github%2Fworkflows%2Fget-pr-info.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fget-pr-info.yml?ref=ab59cc27fe1e166095f1b53e050a718fa7e86f34",
            "patch": "@@ -0,0 +1,157 @@\n+name: Get PR commit SHA\n+on:\n+  workflow_call:\n+    inputs:\n+      pr_number:\n+        required: true\n+        type: string\n+    outputs:\n+      PR_HEAD_REPO_FULL_NAME:\n+        description: \"The full name of the repository from which the pull request is created\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}\n+      PR_BASE_REPO_FULL_NAME:\n+        description: \"The full name of the repository to which the pull request is created\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_BASE_REPO_FULL_NAME }}\n+      PR_HEAD_REPO_OWNER:\n+        description: \"The owner of the repository from which the pull request is created\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}\n+      PR_BASE_REPO_OWNER:\n+        description: \"The owner of the repository to which the pull request is created\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_BASE_REPO_OWNER }}\n+      PR_HEAD_REPO_NAME:\n+        description: \"The name of the repository from which the pull request is created\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}\n+      PR_BASE_REPO_NAME:\n+        description: \"The name of the repository to which the pull request is created\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_BASE_REPO_NAME }}\n+      PR_HEAD_REF:\n+        description: \"The branch name of the pull request in the head repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_REF }}\n+      PR_BASE_REF:\n+        description: \"The branch name in the base repository (to merge into)\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_BASE_REF }}\n+      PR_HEAD_SHA:\n+        description: \"The head sha of the pull request branch in the head repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_SHA }}\n+      PR_BASE_SHA:\n+        description: \"The head sha of the target branch in the base repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_BASE_SHA }}\n+      PR_MERGE_COMMIT_SHA:\n+        description: \"The sha of the merge commit for the pull request (created by GitHub) in the base repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_MERGE_COMMIT_SHA }}\n+      PR_HEAD_COMMIT_DATE:\n+        description: \"The date of the head sha of the pull request branch in the head repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_COMMIT_DATE }}\n+      PR_MERGE_COMMIT_DATE:\n+        description: \"The date of the merge commit for the pull request (created by GitHub) in the base repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_MERGE_COMMIT_DATE }}\n+      PR_HEAD_COMMIT_TIMESTAMP:\n+        description: \"The timestamp of the head sha of the pull request branch in the head repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_HEAD_COMMIT_TIMESTAMP }}\n+      PR_MERGE_COMMIT_TIMESTAMP:\n+        description: \"The timestamp of the merge commit for the pull request (created by GitHub) in the base repository\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP }}\n+      PR:\n+        description: \"The PR\"\n+        value: ${{ jobs.get-pr-info.outputs.PR }}\n+      PR_FILES:\n+        description: \"The files touched in the PR\"\n+        value: ${{ jobs.get-pr-info.outputs.PR_FILES }}\n+\n+\n+jobs:\n+  get-pr-info:\n+    runs-on: ubuntu-22.04\n+    name: Get PR commit SHA better\n+    outputs:\n+      PR_HEAD_REPO_FULL_NAME: ${{ steps.pr_info.outputs.head_repo_full_name }}\n+      PR_BASE_REPO_FULL_NAME: ${{ steps.pr_info.outputs.base_repo_full_name }}\n+      PR_HEAD_REPO_OWNER: ${{ steps.pr_info.outputs.head_repo_owner }}\n+      PR_BASE_REPO_OWNER: ${{ steps.pr_info.outputs.base_repo_owner }}\n+      PR_HEAD_REPO_NAME: ${{ steps.pr_info.outputs.head_repo_name }}\n+      PR_BASE_REPO_NAME: ${{ steps.pr_info.outputs.base_repo_name }}\n+      PR_HEAD_REF: ${{ steps.pr_info.outputs.head_ref }}\n+      PR_BASE_REF: ${{ steps.pr_info.outputs.base_ref }}\n+      PR_HEAD_SHA: ${{ steps.pr_info.outputs.head_sha }}\n+      PR_BASE_SHA: ${{ steps.pr_info.outputs.base_sha }}\n+      PR_MERGE_COMMIT_SHA: ${{ steps.pr_info.outputs.merge_commit_sha }}\n+      PR_HEAD_COMMIT_DATE: ${{ steps.pr_info.outputs.head_commit_date }}\n+      PR_MERGE_COMMIT_DATE: ${{ steps.pr_info.outputs.merge_commit_date }}\n+      PR_HEAD_COMMIT_TIMESTAMP: ${{ steps.get_timestamps.outputs.head_commit_timestamp }}\n+      PR_MERGE_COMMIT_TIMESTAMP: ${{ steps.get_timestamps.outputs.merge_commit_timestamp }}\n+      PR: ${{ steps.pr_info.outputs.pr }}\n+      PR_FILES: ${{ steps.pr_info.outputs.files }}\n+    if: ${{ inputs.pr_number != '' }}\n+    steps:\n+      - name: Extract PR details\n+        id: pr_info\n+        uses: actions/github-script@v6\n+        with:\n+          script: |            \n+            const { data: pr } = await github.rest.pulls.get({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              pull_number: ${{ inputs.pr_number }}\n+            });\n+\n+            const { data: head_commit }  = await github.rest.repos.getCommit({\n+              owner: pr.head.repo.owner.login,\n+              repo: pr.head.repo.name,\n+              ref: pr.head.ref\n+            });\n+\n+            const { data: merge_commit }  = await github.rest.repos.getCommit({\n+              owner: pr.base.repo.owner.login,\n+              repo: pr.base.repo.name,\n+              ref: pr.merge_commit_sha,\n+            });\n+\n+            const { data: files } = await github.rest.pulls.listFiles({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              pull_number: ${{ inputs.pr_number }}\n+            });\n+\n+            core.setOutput('head_repo_full_name', pr.head.repo.full_name);\n+            core.setOutput('base_repo_full_name', pr.base.repo.full_name);\n+            core.setOutput('head_repo_owner', pr.head.repo.owner.login);\n+            core.setOutput('base_repo_owner', pr.base.repo.owner.login);\n+            core.setOutput('head_repo_name', pr.head.repo.name);\n+            core.setOutput('base_repo_name', pr.base.repo.name);\n+            core.setOutput('head_ref', pr.head.ref);\n+            core.setOutput('base_ref', pr.base.ref);\n+            core.setOutput('head_sha', pr.head.sha);\n+            core.setOutput('base_sha', pr.base.sha);\n+            core.setOutput('merge_commit_sha', pr.merge_commit_sha);\n+            core.setOutput('pr', pr);\n+\n+            core.setOutput('head_commit_date', head_commit.commit.committer.date);\n+            core.setOutput('merge_commit_date', merge_commit.commit.committer.date);\n+            \n+            core.setOutput('files', files);            \n+            \n+            console.log('PR head commit:', {\n+              head_commit: head_commit,\n+              commit: head_commit.commit,\n+              date: head_commit.commit.committer.date\n+            });\n+\n+            console.log('PR merge commit:', {\n+              merge_commit: merge_commit,\n+              commit: merge_commit.commit,\n+              date: merge_commit.commit.committer.date\n+            });\n+\n+      - name: Convert dates to timestamps\n+        id: get_timestamps\n+        run: |\n+          head_commit_date=${{ steps.pr_info.outputs.head_commit_date }}\n+          merge_commit_date=${{ steps.pr_info.outputs.merge_commit_date }}\n+          echo $head_commit_date\n+          echo $merge_commit_date\n+          head_commit_timestamp=$(date -d \"$head_commit_date\" +%s)\n+          merge_commit_timestamp=$(date -d \"$merge_commit_date\" +%s)\n+          echo $head_commit_timestamp\n+          echo $merge_commit_timestamp\n+          echo \"head_commit_timestamp=$head_commit_timestamp\" >> $GITHUB_OUTPUT\n+          echo \"merge_commit_timestamp=$merge_commit_timestamp\" >> $GITHUB_OUTPUT"
        },
        {
            "sha": "316b0f7503f2d24a3cdfe8a6e086726edaaec892",
            "filename": ".github/workflows/get-pr-number.yml",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/huggingface/transformers/blob/ab59cc27fe1e166095f1b53e050a718fa7e86f34/.github%2Fworkflows%2Fget-pr-number.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ab59cc27fe1e166095f1b53e050a718fa7e86f34/.github%2Fworkflows%2Fget-pr-number.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fget-pr-number.yml?ref=ab59cc27fe1e166095f1b53e050a718fa7e86f34",
            "patch": "@@ -0,0 +1,36 @@\n+name: Get PR number\n+on:\n+  workflow_call:\n+    outputs:\n+      PR_NUMBER:\n+        description: \"The extracted PR number\"\n+        value: ${{ jobs.get-pr-number.outputs.PR_NUMBER }}\n+\n+jobs:\n+  get-pr-number:\n+    runs-on: ubuntu-22.04\n+    name: Get PR number\n+    outputs:\n+      PR_NUMBER: ${{ steps.set_pr_number.outputs.PR_NUMBER }}\n+    steps:\n+      - name: Get PR number\n+        shell: bash\n+        run: |\n+          if [[ \"${{ github.event.issue.number }}\" != \"\" && \"${{ github.event.issue.pull_request }}\" != \"\" ]]; then\n+            echo \"PR_NUMBER=${{ github.event.issue.number }}\" >> $GITHUB_ENV\n+          elif [[ \"${{ github.event.pull_request.number }}\" != \"\" ]]; then\n+            echo \"PR_NUMBER=${{ github.event.pull_request.number }}\" >> $GITHUB_ENV\n+          elif [[ \"${{ github.event.pull_request }}\" != \"\" ]]; then\n+            echo \"PR_NUMBER=${{ github.event.number }}\" >> $GITHUB_ENV\n+          else\n+            echo \"PR_NUMBER=\" >> $GITHUB_ENV\n+          fi\n+\n+      - name: Check PR number\n+        shell: bash\n+        run: |\n+          echo \"${{ env.PR_NUMBER }}\"\n+\n+      - name: Set PR number\n+        id: set_pr_number\n+        run: echo \"PR_NUMBER=${{ env.PR_NUMBER }}\" >> \"$GITHUB_OUTPUT\""
        },
        {
            "sha": "f3070a6f4d2390bf125b8874070f918932ee3399",
            "filename": ".github/workflows/pr_run_slow_ci.yml",
            "status": "added",
            "additions": 163,
            "deletions": 0,
            "changes": 163,
            "blob_url": "https://github.com/huggingface/transformers/blob/ab59cc27fe1e166095f1b53e050a718fa7e86f34/.github%2Fworkflows%2Fpr_run_slow_ci.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ab59cc27fe1e166095f1b53e050a718fa7e86f34/.github%2Fworkflows%2Fpr_run_slow_ci.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fpr_run_slow_ci.yml?ref=ab59cc27fe1e166095f1b53e050a718fa7e86f34",
            "patch": "@@ -0,0 +1,163 @@\n+name: PR slow CI\n+on:\n+  pull_request_target:\n+    types: [opened, synchronize, reopened]\n+\n+jobs:\n+  get-pr-number:\n+    name: Get PR number\n+    uses: ./.github/workflows/get-pr-number.yml\n+\n+  get-pr-info:\n+    name: Get PR commit SHA\n+    needs: get-pr-number\n+    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n+    uses: ./.github/workflows/get-pr-info.yml\n+    with:\n+      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n+\n+  # We only need to verify the timestamp if the workflow is triggered by `issue_comment`.\n+  verity_pr_commit:\n+    name: Verity PR commit corresponds to a specific event by comparing timestamps\n+    if: ${{ github.event.comment.created_at != '' }}\n+    runs-on: ubuntu-22.04\n+    needs: get-pr-info\n+    env:\n+      COMMENT_DATE: ${{ github.event.comment.created_at }}\n+      PR_MERGE_COMMIT_DATE: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_DATE }}\n+      PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP }}\n+    steps:\n+      - run: |\n+          COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\n+          echo \"COMMENT_DATE: $COMMENT_DATE\"\n+          echo \"PR_MERGE_COMMIT_DATE: $PR_MERGE_COMMIT_DATE\"\n+          echo \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\n+          echo \"PR_MERGE_COMMIT_TIMESTAMP: $PR_MERGE_COMMIT_TIMESTAMP\"\n+          if [ $COMMENT_TIMESTAMP -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n+            echo \"Last commit on the pull request is newer than the issue comment triggering this run! Abort!\";\n+            exit -1;\n+          fi\n+\n+  get-jobs:\n+    name: Get test files to run\n+    runs-on: ubuntu-22.04\n+    needs: [get-pr-number, get-pr-info]\n+    outputs:\n+      jobs: ${{ steps.get_jobs.outputs.jobs_to_run }}\n+    steps:\n+      - name: Get repository content\n+        id: repo_content\n+        uses: actions/github-script@v6\n+        with:\n+          script: |\n+            const { data: tests_dir } = await github.rest.repos.getContent({\n+              owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n+              repo: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n+              path: 'tests',\n+              ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n+            });\n+\n+            const { data: tests_models_dir } = await github.rest.repos.getContent({\n+              owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n+              repo: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n+              path: 'tests/models',\n+              ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n+            });\n+\n+            const { data: tests_quantization_dir } = await github.rest.repos.getContent({\n+              owner: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_OWNER }}',\n+              repo: '${{ needs.get-pr-info.outputs.PR_HEAD_REPO_NAME }}',\n+              path: 'tests/quantization',\n+              ref: '${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}',\n+            });\n+\n+            core.setOutput('tests_dir', tests_dir);\n+            core.setOutput('tests_models_dir', tests_models_dir);\n+            core.setOutput('tests_quantization_dir', tests_quantization_dir);\n+\n+      # This checkout to the main branch\n+      - uses: actions/checkout@v4\n+        with:\n+          fetch-depth: \"0\"\n+\n+      - name: Write pr_files file\n+        run: |\n+          cat > pr_files.txt << 'EOF'\n+          ${{ needs.get-pr-info.outputs.PR_FILES }}\n+          EOF\n+\n+      - name: Write tests_dir file\n+        run: |\n+          cat > tests_dir.txt << 'EOF'\n+          ${{ steps.repo_content.outputs.tests_dir }}\n+          EOF\n+\n+      - name: Write tests_models_dir file\n+        run: |\n+          cat > tests_models_dir.txt << 'EOF'\n+          ${{ steps.repo_content.outputs.tests_models_dir }}\n+          EOF\n+\n+      - name: Write tests_quantization_dir file\n+        run: |\n+          cat > tests_quantization_dir.txt << 'EOF'\n+          ${{ steps.repo_content.outputs.tests_quantization_dir }}\n+          EOF\n+\n+      - name: Run script to get jobs to run\n+        id: get_jobs\n+        run: |\n+          python utils/get_pr_run_slow_jobs.py | tee output.txt\n+          echo \"jobs_to_run: $(tail -n 1 output.txt)\"\n+          echo \"jobs_to_run=$(tail -n 1 output.txt)\" >> $GITHUB_OUTPUT\n+\n+  send_comment:\n+    name: Send a comment to suggest jobs to run\n+    if: ${{ needs.get-jobs.outputs.jobs != '' }}\n+    needs: [get-pr-number, get-jobs]\n+    permissions:\n+      pull-requests: write\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - name: Delete existing comment and send new one\n+        uses: actions/github-script@v7\n+        env:\n+          BODY: \"\\n\\nrun-slow: ${{ needs.get-jobs.outputs.jobs }}\"\n+        with:\n+          script: |\n+            const prNumber = ${{ needs.get-pr-number.outputs.PR_NUMBER }};\n+            const commentPrefix = \"**[For maintainers]** Suggested jobs to run (before merge)\";\n+            \n+            // Get all comments on the PR\n+            const { data: comments } = await github.rest.issues.listComments({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              issue_number: prNumber\n+            });\n+            \n+            // Find existing comment(s) that start with our prefix\n+            const existingComments = comments.filter(comment => \n+              comment.user.login === 'github-actions[bot]' && \n+              comment.body.startsWith(commentPrefix)\n+            );\n+            \n+            // Delete existing comment(s)\n+            for (const comment of existingComments) {\n+              console.log(`Deleting existing comment #${comment.id}`);\n+              await github.rest.issues.deleteComment({\n+                owner: context.repo.owner,\n+                repo: context.repo.repo,\n+                comment_id: comment.id\n+              });\n+            }\n+            \n+            // Create new comment\n+            const newBody = `${commentPrefix}${process.env.BODY}`;\n+            await github.rest.issues.createComment({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              issue_number: prNumber,\n+              body: newBody\n+            });\n+            \n+            console.log('âœ… Comment updated successfully');\n\\ No newline at end of file"
        },
        {
            "sha": "fa56a6c305e113061e3582c9e1b85781ddbb092b",
            "filename": "utils/get_pr_run_slow_jobs.py",
            "status": "added",
            "additions": 133,
            "deletions": 0,
            "changes": 133,
            "blob_url": "https://github.com/huggingface/transformers/blob/ab59cc27fe1e166095f1b53e050a718fa7e86f34/utils%2Fget_pr_run_slow_jobs.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ab59cc27fe1e166095f1b53e050a718fa7e86f34/utils%2Fget_pr_run_slow_jobs.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fget_pr_run_slow_jobs.py?ref=ab59cc27fe1e166095f1b53e050a718fa7e86f34",
            "patch": "@@ -0,0 +1,133 @@\n+import argparse\n+import json\n+import re\n+import string\n+\n+\n+MAX_NUM_JOBS_TO_SUGGEST = 16\n+\n+\n+def get_jobs_to_run():\n+    # The file `pr_files.txt` contains the information about the files changed in a pull request, and it is prepared by\n+    # the caller (using GitHub api).\n+    # We can also use the following api to get the information if we don't have them before calling this script.\n+    # url = f\"https://api.github.com/repos/huggingface/transformers/pulls/PULL_NUMBER/files?ref={pr_sha}\"\n+    with open(\"pr_files.txt\") as fp:\n+        pr_files = json.load(fp)\n+        pr_files = [{k: v for k, v in item.items() if k in [\"filename\", \"status\"]} for item in pr_files]\n+    pr_files = [item[\"filename\"] for item in pr_files if item[\"status\"] in [\"added\", \"modified\"]]\n+\n+    # models or quantizers\n+    re_1 = re.compile(r\"src/transformers/(models/.*)/modeling_.*\\.py\")\n+    re_2 = re.compile(r\"src/transformers/(quantizers/quantizer_.*)\\.py\")\n+\n+    # tests for models or quantizers\n+    re_3 = re.compile(r\"tests/(models/.*)/test_.*\\.py\")\n+    re_4 = re.compile(r\"tests/(quantization/.*)/test_.*\\.py\")\n+\n+    # files in a model directory but not necessary a modeling file\n+    re_5 = re.compile(r\"src/transformers/(models/.*)/.*\\.py\")\n+\n+    regexes = [re_1, re_2, re_3, re_4, re_5]\n+\n+    jobs_to_run = []\n+    for pr_file in pr_files:\n+        for regex in regexes:\n+            matched = regex.findall(pr_file)\n+            if len(matched) > 0:\n+                item = matched[0]\n+                item = item.replace(\"quantizers/quantizer_\", \"quantization/\")\n+                # TODO: for files in `quantizers`, the processed item above may not exist. Try using a fuzzy matching\n+                if item in repo_content:\n+                    jobs_to_run.append(item)\n+                break\n+    jobs_to_run = sorted(set(jobs_to_run))\n+\n+    return jobs_to_run\n+\n+\n+def parse_message(message: str) -> str:\n+    \"\"\"\n+    Parses a GitHub pull request's comment to find the models specified in it to run slow CI.\n+\n+    Args:\n+        message (`str`): The body of a GitHub pull request's comment.\n+\n+    Returns:\n+        `str`: The substring in `message` after `run-slow`, run_slow` or run slow`. If no such prefix is found, the\n+        empty string is returned.\n+    \"\"\"\n+    if message is None:\n+        return \"\"\n+\n+    message = message.strip().lower()\n+\n+    # run-slow: model_1, model_2, quantization_1, quantization_2\n+    if not message.startswith((\"run-slow\", \"run_slow\", \"run slow\")):\n+        return \"\"\n+    message = message[len(\"run slow\") :]\n+    # remove leading `:`\n+    while message.strip().startswith(\":\"):\n+        message = message.strip()[1:]\n+\n+    return message\n+\n+\n+def get_jobs(message: str):\n+    models = parse_message(message)\n+    return models.replace(\",\", \" \").split()\n+\n+\n+def check_name(model_name: str):\n+    allowed = string.ascii_letters + string.digits + \"_\"\n+    return not (model_name.startswith(\"_\") or model_name.endswith(\"_\")) and all(c in allowed for c in model_name)\n+\n+\n+if __name__ == \"__main__\":\n+    parser = argparse.ArgumentParser()\n+    parser.add_argument(\"--message\", type=str, default=\"\", help=\"The content of a comment.\")\n+    parser.add_argument(\"--quantization\", action=\"store_true\", help=\"If we collect quantization tests\")\n+    args = parser.parse_args()\n+\n+    # The files are prepared by the caller (using GitHub api).\n+    # We can also use the following api to get the information if we don't have them before calling this script.\n+    # url = f\"https://api.github.com/repos/OWNER/REPO/contents/PATH?ref={pr_sha}\"\n+    # (we avoid to checkout the repository using `actions/checkout` to reduce the run time, but mostly to avoid the potential security issue as much as possible)\n+    repo_content = []\n+    for filename in [\"tests_dir.txt\", \"tests_models_dir.txt\", \"tests_quantization_dir.txt\"]:\n+        with open(filename) as fp:\n+            data = json.load(fp)\n+            data = [item[\"path\"][len(\"tests/\") :] for item in data if item[\"type\"] == \"dir\"]\n+            repo_content.extend(data)\n+\n+    # These don't have the prefix `models/` or `quantization/`, so we need to add them.\n+    if args.message:\n+        specified_jobs = get_jobs(args.message)\n+        specified_jobs = [job for job in specified_jobs if check_name(job)]\n+\n+        # Add prefix (`models/` or `quantization`)\n+        jobs_to_run = []\n+        for job in specified_jobs:\n+            if not args.quantization:\n+                if f\"models/{job}\" in repo_content:\n+                    jobs_to_run.append(f\"models/{job}\")\n+                elif job in repo_content and job != \"quantization\":\n+                    jobs_to_run.append(job)\n+            elif f\"quantization/{job}\" in repo_content:\n+                jobs_to_run.append(f\"quantization/{job}\")\n+\n+        print(sorted(set(jobs_to_run)))\n+\n+    else:\n+        # Compute (from the added/modified files) the directories under `tests/`, `tests/models/` and `tests/quantization`to run tests.\n+        # These are already with the prefix `models/` or `quantization/`, so we don't need to add them.\n+        jobs_to_run = get_jobs_to_run()\n+        jobs_to_run = [x.replace(\"models/\", \"\").replace(\"quantization/\", \"\") for x in jobs_to_run]\n+        jobs_to_run = [job for job in jobs_to_run if check_name(job)]\n+\n+        if len(jobs_to_run) > MAX_NUM_JOBS_TO_SUGGEST:\n+            jobs_to_run = jobs_to_run[:MAX_NUM_JOBS_TO_SUGGEST]\n+\n+        suggestion = f\"{', '.join(jobs_to_run)}\"\n+\n+        print(suggestion)"
        }
    ],
    "stats": {
        "total": 489,
        "additions": 489,
        "deletions": 0
    }
}