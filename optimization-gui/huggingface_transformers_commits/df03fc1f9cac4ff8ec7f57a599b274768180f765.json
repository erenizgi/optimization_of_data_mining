{
    "author": "XuehaiPan",
    "message": "Improve module name handling for local custom code (#40809)\n\n* Improve module name handling for local custom code\n\n* Use `%lazy` in logging messages\n\n* Revert \"Use `%lazy` in logging messages\"\n\nThis reverts commit 5848755d5805e67177c5218f351c0ac852df9340.\n\n* Add notes for sanitization rule in docstring\n\n* Remove too many underscores\n\n* Update src/transformers/dynamic_module_utils.py\n\n* Update src/transformers/dynamic_module_utils.py\n\n---------\n\nCo-authored-by: Matt <Rocketknight1@users.noreply.github.com>",
    "sha": "df03fc1f9cac4ff8ec7f57a599b274768180f765",
    "files": [
        {
            "sha": "5b541c076f632e61720878586ec905effe06fd63",
            "filename": "src/transformers/dynamic_module_utils.py",
            "status": "modified",
            "additions": 30,
            "deletions": 4,
            "changes": 34,
            "blob_url": "https://github.com/huggingface/transformers/blob/df03fc1f9cac4ff8ec7f57a599b274768180f765/src%2Ftransformers%2Fdynamic_module_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/df03fc1f9cac4ff8ec7f57a599b274768180f765/src%2Ftransformers%2Fdynamic_module_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fdynamic_module_utils.py?ref=df03fc1f9cac4ff8ec7f57a599b274768180f765",
            "patch": "@@ -19,6 +19,7 @@\n import importlib\n import importlib.metadata\n import importlib.util\n+import keyword\n import os\n import re\n import shutil\n@@ -48,11 +49,36 @@\n \n \n def _sanitize_module_name(name: str) -> str:\n+    r\"\"\"\n+    Tries to sanitize a module name so that it can be used as a Python module.\n+\n+    The following transformations are applied:\n+\n+    1. Replace `.` in module names with `_dot_`.\n+    2. Replace `-` in module names with `_hyphen_`.\n+    3. If the module name starts with a digit, prepend it with `_`.\n+    4. Warn if the sanitized name is a Python reserved keyword or not a valid identifier.\n+\n+    If the input name is already a valid identifier, it is returned unchanged.\n     \"\"\"\n-    Replace `.` in module names with `_dot_` so that it doesn't\n-    look like an import path separator.\n-    \"\"\"\n-    return name.replace(\".\", \"_dot_\")\n+    # We not replacing `\\W` characters with `_` to avoid collisions. Because `_` is a very common\n+    # separator used in module names, replacing `\\W` with `_` would create too many collisions.\n+    # Once a module is imported, it is cached in `sys.modules` and the second import would return\n+    # the first module, which might not be the expected behavior if name collisions happen.\n+    new_name = name.replace(\".\", \"_dot_\").replace(\"-\", \"_hyphen_\")\n+    if new_name and new_name[0].isdigit():\n+        new_name = f\"_{new_name}\"\n+    if keyword.iskeyword(new_name):\n+        logger.warning(\n+            f\"The module name {new_name} (originally {name}) is a reserved keyword in Python. \"\n+            \"Please rename the original module to avoid import issues.\"\n+        )\n+    elif not new_name.isidentifier():\n+        logger.warning(\n+            f\"The module name {new_name} (originally {name}) is not a valid Python identifier. \"\n+            \"Please rename the original module to avoid import issues.\"\n+        )\n+    return new_name\n \n \n _HF_REMOTE_CODE_LOCK = threading.Lock()"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}