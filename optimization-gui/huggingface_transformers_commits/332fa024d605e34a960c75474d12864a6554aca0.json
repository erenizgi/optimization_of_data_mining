{
    "author": "ydshieh",
    "message": "Security fix for `self-comment-ci.yml` (#35548)\n\n* Revert \"Disable  `.github/workflows/self-comment-ci.yml` for now (#35366)\"\r\n\r\nThis reverts commit ccc4a5a59b2d4134a49971915db0710e7a8c7824.\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* least permission\r\n\r\n* add env\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "332fa024d605e34a960c75474d12864a6554aca0",
    "files": [
        {
            "sha": "f62b3bacdcd1ef82309c0411b8c7ce49b9564fd8",
            "filename": ".github/workflows/self-comment-ci.yml",
            "status": "added",
            "additions": 289,
            "deletions": 0,
            "changes": 289,
            "blob_url": "https://github.com/huggingface/transformers/blob/332fa024d605e34a960c75474d12864a6554aca0/.github%2Fworkflows%2Fself-comment-ci.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/332fa024d605e34a960c75474d12864a6554aca0/.github%2Fworkflows%2Fself-comment-ci.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-comment-ci.yml?ref=332fa024d605e34a960c75474d12864a6554aca0",
            "patch": "@@ -0,0 +1,289 @@\n+name: PR comment GitHub CI\n+\n+on:\n+  issue_comment:\n+    types:\n+      - created\n+    branches-ignore:\n+      - main\n+concurrency:\n+  group: ${{ github.workflow }}-${{ github.event.issue.number }}-${{ startsWith(github.event.comment.body, 'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body, 'run_slow') }}\n+  cancel-in-progress: true\n+permissions: read-all\n+\n+env:\n+  HF_HOME: /mnt/cache\n+  TRANSFORMERS_IS_CI: yes\n+  OMP_NUM_THREADS: 8\n+  MKL_NUM_THREADS: 8\n+  RUN_SLOW: yes\n+  # For gated repositories, we still need to agree to share information on the Hub repo. page in order to get access.\n+  # This token is created under the bot `hf-transformers-bot`.\n+  HF_HUB_READ_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}\n+  SIGOPT_API_TOKEN: ${{ secrets.SIGOPT_API_TOKEN }}\n+  TF_FORCE_GPU_ALLOW_GROWTH: true\n+  RUN_PT_TF_CROSS_TESTS: 1\n+  CUDA_VISIBLE_DEVICES: 0,1\n+\n+jobs:\n+  get-pr-number:\n+    runs-on: ubuntu-22.04\n+    name: Get PR number\n+    # For security: only allow team members to run\n+    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('[\"ydshieh\", \"ArthurZucker\", \"zucchini-nlp\", \"qubvel\", \"molbap\", \"gante\", \"LysandreJik\", \"Cyrilvallez\"]'), github.actor) && (startsWith(github.event.comment.body, 'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body, 'run_slow')) }}\n+    outputs:\n+      PR_NUMBER: ${{ steps.set_pr_number.outputs.PR_NUMBER }}\n+    steps:\n+      - name: Get PR number\n+        shell: bash\n+        run: |\n+          if [[ \"${{ github.event.issue.number }}\" != \"\" && \"${{ github.event.issue.pull_request }}\" != \"\" ]]; then\n+            echo \"PR_NUMBER=${{ github.event.issue.number }}\" >> $GITHUB_ENV\n+          else\n+            echo \"PR_NUMBER=\" >> $GITHUB_ENV\n+          fi\n+\n+      - name: Check PR number\n+        shell: bash\n+        run: |\n+          echo \"${{ env.PR_NUMBER }}\"\n+\n+      - name: Set PR number\n+        id: set_pr_number\n+        run: echo \"PR_NUMBER=${{ env.PR_NUMBER }}\" >> \"$GITHUB_OUTPUT\"\n+\n+  get-sha:\n+    runs-on: ubuntu-22.04\n+    needs: get-pr-number\n+    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n+    outputs:\n+      PR_HEAD_SHA: ${{ steps.get_sha.outputs.PR_HEAD_SHA }}\n+    steps:\n+      - uses: actions/checkout@v4\n+        with:\n+          fetch-depth: \"0\"\n+          ref: \"refs/pull/${{needs.get-pr-number.outputs.PR_NUMBER}}/merge\"\n+\n+      - name: Get SHA (and verify timestamps against the issue comment date)\n+        id: get_sha\n+        env:\n+          PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n+          COMMENT_DATE: ${{ github.event.comment.created_at }}\n+        run: |\n+            git fetch origin refs/pull/$PR_NUMBER/head:refs/remotes/pull/$PR_NUMBER/head\n+            git checkout refs/remotes/pull/$PR_NUMBER/head\n+            echo \"PR_HEAD_SHA: $(git log -1 --format=%H)\"\n+            echo \"PR_HEAD_SHA=$(git log -1 --format=%H)\" >> \"$GITHUB_OUTPUT\"\n+            git fetch origin refs/pull/$PR_NUMBER/merge:refs/remotes/pull/$PR_NUMBER/merge\n+            git checkout refs/remotes/pull/$PR_NUMBER/merge\n+            PR_MERGE_COMMIT_TIMESTAMP=$(git log -1 --date=unix --format=%cd)\n+            echo \"PR_MERGE_COMMIT_TIMESTAMP: $PR_MERGE_COMMIT_TIMESTAMP\"\n+            COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\n+            echo \"PR_HEAD_SHA: $COMMENT_DATE\"\n+            echo \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\n+            if [ $COMMENT_TIMESTAMP -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n+              echo \"Last commit on the pull request is newer than the issue comment triggering this run! Abort!\";\n+              exit -1;\n+            fi\n+\n+  # use a python script to handle this complex logic\n+  # case 1: `run-slow` (auto. infer with limited number of models, but in particular, new model)\n+  # case 2: `run-slow model_1, model_2`\n+  get-tests:\n+    runs-on: ubuntu-22.04\n+    needs: get-pr-number\n+    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n+    outputs:\n+      models: ${{ steps.models_to_run.outputs.models }}\n+    steps:\n+      - uses: actions/checkout@v4\n+        with:\n+          fetch-depth: \"0\"\n+          ref: \"refs/pull/${{needs.get-pr-number.outputs.PR_NUMBER}}/merge\"\n+\n+      - name: Get models to test\n+        env:\n+          PR_COMMENT: ${{ github.event.comment.body }}\n+        run: |\n+          python -m pip install GitPython\n+          python utils/pr_slow_ci_models.py --message \"$PR_COMMENT\" | tee output.txt\n+          echo \"models=$(tail -n 1 output.txt)\" >> $GITHUB_ENV\n+\n+      - name: Show models to test\n+        id: models_to_run\n+        run: |\n+          echo \"${{ env.models }}\"\n+          echo \"models=${{ env.models }}\" >> $GITHUB_ENV\n+          echo \"models=${{ env.models }}\" >> $GITHUB_OUTPUT\n+\n+  reply_to_comment:\n+    name: Reply to the comment\n+    if: ${{ needs.get-tests.outputs.models != '[]' }}\n+    needs: [get-pr-number, get-tests]\n+    permissions:\n+      pull-requests: write\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - name: Reply to the comment\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          MODELS: ${{ needs.get-tests.outputs.models }}\n+        run: |\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            repos/${{ github.repository }}/issues/${{ needs.get-pr-number.outputs.PR_NUMBER }}/comments \\\n+            -f \"body=This comment contains run-slow, running the specified jobs: ${{ env.MODELS }} ...\"\n+\n+  create_run:\n+    name: Create run\n+    if: ${{ needs.get-tests.outputs.models != '[]' }}\n+    needs: [get-sha, get-tests, reply_to_comment]\n+    permissions:\n+      statuses: write\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - name: Create Run\n+        id: create_run\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          # Create a commit status (pending) for a run of this workflow. The status has to be updated later in `update_run_status`.\n+          # See https://docs.github.com/en/rest/commits/statuses?apiVersion=2022-11-28#create-a-commit-status\n+          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n+        run: |\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            repos/${{ github.repository }}/statuses/${{ needs.get-sha.outputs.PR_HEAD_SHA }} \\\n+            -f \"target_url=$GITHUB_RUN_URL\" -f \"state=pending\" -f \"description=Slow CI job\" -f \"context=pytest/custom-tests\"\n+\n+  run_models_gpu:\n+      name: Run all tests for the model\n+      if: ${{ needs.get-tests.outputs.models != '[]' }}\n+      needs: [get-pr-number, get-tests, create_run]\n+      strategy:\n+        fail-fast: false\n+        matrix:\n+          folders: ${{ fromJson(needs.get-tests.outputs.models) }}\n+          machine_type: [aws-g4dn-2xlarge-cache, aws-g4dn-12xlarge-cache]\n+      runs-on:\n+         group: '${{ matrix.machine_type }}'\n+      container:\n+        image: huggingface/transformers-all-latest-gpu\n+        options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+      steps:\n+      - name: Echo input and matrix info\n+        shell: bash\n+        run: |\n+          echo \"${{ matrix.folders }}\"\n+\n+      - name: Echo folder ${{ matrix.folders }}\n+        shell: bash\n+        # For folders like `models/bert`, set an env. var. (`matrix_folders`) to `models_bert`, which will be used to\n+        # set the artifact folder names (because the character `/` is not allowed).\n+        run: |\n+          echo \"${{ matrix.folders }}\"\n+          matrix_folders=${{ matrix.folders }}\n+          matrix_folders=${matrix_folders/'models/'/'models_'}\n+          echo \"$matrix_folders\"\n+          echo \"matrix_folders=$matrix_folders\" >> $GITHUB_ENV\n+\n+      - name: Checkout to PR merge commit\n+        working-directory: /transformers\n+        run: |\n+            git fetch origin refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge:refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n+            git checkout refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n+            git log -1 --format=%H\n+\n+      - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n+        working-directory: /transformers\n+        run: python3 -m pip uninstall -y transformers && python3 -m pip install -e .\n+\n+      - name: NVIDIA-SMI\n+        run: |\n+          nvidia-smi\n+\n+      - name: Set `machine_type` for report and artifact names\n+        working-directory: /transformers\n+        shell: bash\n+        run: |\n+          echo \"${{ matrix.machine_type }}\"\n+          if [ \"${{ matrix.machine_type }}\" = \"aws-g4dn-2xlarge-cache\" ]; then\n+            machine_type=single-gpu\n+          elif [ \"${{ matrix.machine_type }}\" = \"aws-g4dn-12xlarge-cache\" ]; then\n+            machine_type=multi-gpu\n+          else\n+            machine_type=${{ matrix.machine_type }}\n+          fi\n+          echo \"$machine_type\"\n+          echo \"machine_type=$machine_type\" >> $GITHUB_ENV\n+\n+      - name: Environment\n+        working-directory: /transformers\n+        run: |\n+          python3 utils/print_env.py\n+\n+      - name: Show installed libraries and their versions\n+        working-directory: /transformers\n+        run: pip freeze\n+\n+      - name: Run all tests on GPU\n+        working-directory: /transformers\n+        run: |\n+          export CUDA_VISIBLE_DEVICES=\"$(python3 utils/set_cuda_devices_for_ci.py --test_folder ${{ matrix.folders }})\"\n+          echo $CUDA_VISIBLE_DEVICES\n+          python3 -m pytest -v -rsfE --make-reports=${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports tests/${{ matrix.folders }}\n+\n+      - name: Failure short reports\n+        if: ${{ failure() }}\n+        continue-on-error: true\n+        run: cat /transformers/reports/${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports/failures_short.txt\n+\n+      - name: Make sure report directory exists\n+        shell: bash\n+        run: |\n+          mkdir -p /transformers/reports/${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports\n+          echo \"hello\" > /transformers/reports/${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports/hello.txt\n+          echo \"${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports\"\n+\n+      - name: \"Test suite reports artifacts: ${{ env.machine_type }}_run_models_gpu_${{ env.matrix_folders }}_test_reports\"\n+        if: ${{ always() }}\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: ${{ env.machine_type }}_run_models_gpu_${{ env.matrix_folders }}_test_reports\n+          path: /transformers/reports/${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports\n+\n+  update_run_status:\n+    name: Update Check Run Status\n+    needs: [get-sha, create_run, run_models_gpu]\n+    permissions:\n+      statuses: write\n+    if: ${{ always() && needs.create_run.result == 'success' }}\n+    runs-on: ubuntu-22.04\n+    env:\n+      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+      GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n+    steps:\n+      - name: Get `run_models_gpu` job status\n+        run: |\n+          echo \"${{ needs.run_models_gpu.result }}\"\n+          if [ \"${{ needs.run_models_gpu.result }}\" = \"cancelled\" ]; then\n+            echo \"STATUS=failure\" >> $GITHUB_ENV\n+          elif [ \"${{ needs.run_models_gpu.result }}\" = \"skipped\" ]; then\n+            echo \"STATUS=success\" >> $GITHUB_ENV\n+          else\n+            echo \"STATUS=${{ needs.run_models_gpu.result }}\" >> $GITHUB_ENV\n+          fi\n+\n+      - name: Update PR commit statuses\n+        run: |\n+          echo \"${{ needs.run_models_gpu.result }}\"\n+          echo \"${{ env.STATUS }}\"\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            repos/${{ github.repository }}/statuses/${{ needs.get-sha.outputs.PR_HEAD_SHA }} \\\n+            -f \"target_url=$GITHUB_RUN_URL\" -f \"state=${{ env.STATUS }}\" -f \"description=Slow CI job\" -f \"context=pytest/custom-tests\""
        }
    ],
    "stats": {
        "total": 289,
        "additions": 289,
        "deletions": 0
    }
}