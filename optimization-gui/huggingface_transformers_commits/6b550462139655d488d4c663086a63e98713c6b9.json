{
    "author": "faaany",
    "message": "[docs] fix not-working example code in `perf_infer_gpu_one.md` (#36087)\n\n* bug fix\n\n* update memory limit",
    "sha": "6b550462139655d488d4c663086a63e98713c6b9",
    "files": [
        {
            "sha": "6ffd3213c2ca377c62580003ed7cc452c973f21b",
            "filename": "docs/source/en/perf_infer_gpu_one.md",
            "status": "modified",
            "additions": 11,
            "deletions": 14,
            "changes": 25,
            "blob_url": "https://github.com/huggingface/transformers/blob/6b550462139655d488d4c663086a63e98713c6b9/docs%2Fsource%2Fen%2Fperf_infer_gpu_one.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/6b550462139655d488d4c663086a63e98713c6b9/docs%2Fsource%2Fen%2Fperf_infer_gpu_one.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fperf_infer_gpu_one.md?ref=6b550462139655d488d4c663086a63e98713c6b9",
            "patch": "@@ -357,7 +357,7 @@ tokenizer = AutoTokenizer.from_pretrained(\"facebook/opt-350m\")\n model = AutoModelForCausalLM.from_pretrained(\"facebook/opt-350m\", torch_dtype=torch.float16).to(\"cuda\")\n \n input_text = \"Hello my dog is cute and\"\n-inputs = tokenizer(input_text, return_tensors=\"pt\").to(\"cuda\")\n+inputs = tokenizer(input_text, return_tensors=\"pt\").to(model.device)\n \n + with sdpa_kernel(SDPBackend.FLASH_ATTENTION):\n     outputs = model.generate(**inputs)\n@@ -431,14 +431,14 @@ To load a model in 4-bit for inference, use the `load_in_4bit` parameter. The `d\n ```py\n from transformers import AutoModelForCausalLM\n \n-model_name = \"bigscience/bloom-2b5\"\n+model_name = \"bigscience/bloom-1b7\"\n model_4bit = AutoModelForCausalLM.from_pretrained(model_name, torch_dtype=\"auto\", device_map=\"auto\", load_in_4bit=True)\n ```\n \n-To load a model in 4-bit for inference with multiple GPUs, you can control how much GPU RAM you want to allocate to each GPU. For example, to distribute 600MB of memory to the first GPU and 1GB of memory to the second GPU:\n+To load a model in 4-bit for inference with multiple GPUs, you can control how much GPU RAM you want to allocate to each GPU. For example, to distribute 2GB of memory to the first GPU and 5GB of memory to the second GPU:\n \n ```py\n-max_memory_mapping = {0: \"600MB\", 1: \"1GB\"}\n+max_memory_mapping = {0: \"2GB\", 1: \"5GB\"}\n model_name = \"bigscience/bloom-3b\"\n model_4bit = AutoModelForCausalLM.from_pretrained(\n     model_name, torch_dtype=\"auto\", device_map=\"auto\", load_in_4bit=True, max_memory=max_memory_mapping\n@@ -458,7 +458,7 @@ To load a model in 8-bit for inference, use the `load_in_8bit` parameter. The `d\n ```py\n from transformers import AutoModelForCausalLM, BitsAndBytesConfig\n \n-model_name = \"bigscience/bloom-2b5\"\n+model_name = \"bigscience/bloom-1b7\"\n model_8bit = AutoModelForCausalLM.from_pretrained(model_name, torch_dtype=\"auto\", quantization_config=BitsAndBytesConfig(load_in_8bit=True))\n ```\n \n@@ -467,20 +467,20 @@ If you're loading a model in 8-bit for text generation, you should use the [`~tr\n ```py\n from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig\n \n-model_name = \"bigscience/bloom-2b5\"\n+model_name = \"bigscience/bloom-1b7\"\n tokenizer = AutoTokenizer.from_pretrained(model_name)\n model_8bit = AutoModelForCausalLM.from_pretrained(model_name, torch_dtype=\"auto\", quantization_config=BitsAndBytesConfig(load_in_8bit=True))\n \n prompt = \"Hello, my llama is cute\"\n-inputs = tokenizer(prompt, return_tensors=\"pt\").to(\"cuda\")\n-generated_ids = model.generate(**inputs)\n+inputs = tokenizer(prompt, return_tensors=\"pt\").to(model_8bit.device)\n+generated_ids = model_8bit.generate(**inputs)\n outputs = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)\n ```\n \n-To load a model in 8-bit for inference with multiple GPUs, you can control how much GPU RAM you want to allocate to each GPU. For example, to distribute 1GB of memory to the first GPU and 2GB of memory to the second GPU:\n+To load a model in 8-bit for inference with multiple GPUs, you can control how much GPU RAM you want to allocate to each GPU. For example, to distribute 2GB of memory to the first GPU and 5GB of memory to the second GPU:\n \n ```py\n-max_memory_mapping = {0: \"1GB\", 1: \"2GB\"}\n+max_memory_mapping = {0: \"2GB\", 1: \"5GB\"}\n model_name = \"bigscience/bloom-3b\"\n model_8bit = AutoModelForCausalLM.from_pretrained(\n     model_name, torch_dtype=\"auto\", device_map=\"auto\", load_in_8bit=True, max_memory=max_memory_mapping\n@@ -545,11 +545,8 @@ quantization_config = BitsAndBytesConfig(\n tokenizer = AutoTokenizer.from_pretrained(\"facebook/opt-350m\")\n model = AutoModelForCausalLM.from_pretrained(\"facebook/opt-350m\", torch_dtype=\"auto\", quantization_config=quantization_config)\n \n-# enable BetterTransformer\n-model = model.to_bettertransformer()\n-\n input_text = \"Hello my dog is cute and\"\n-inputs = tokenizer(input_text, return_tensors=\"pt\").to(\"cuda\")\n+inputs = tokenizer(input_text, return_tensors=\"pt\").to(model.device)\n \n # enable FlashAttention\n with sdpa_kernel(SDPBackend.FLASH_ATTENTION):"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 11,
        "deletions": 14
    }
}