{
    "author": "eustlb",
    "message": "[audio utils] fix fft_bin_width computation (#36603)\n\n* fix fft_bin_width computation\n\n* update docstring + enforce correct params\n\n* update test with correct value\n\n* udpate test\n\n* update feature extractors for concerned models\n\n* update\n\n* make\n\n* udpate docstring\n\n* udpate docstring",
    "sha": "fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d",
    "files": [
        {
            "sha": "8420a84e089e03be9a80fb63c237e34203ea28a0",
            "filename": "src/transformers/audio_utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Faudio_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Faudio_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Faudio_utils.py?ref=fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d",
            "patch": "@@ -293,7 +293,7 @@ def mel_filter_bank(\n \n     Args:\n         num_frequency_bins (`int`):\n-            Number of frequencies used to compute the spectrogram (should be the same as in `stft`).\n+            Number of frequency bins (should be the same as `n_fft // 2 + 1` where `n_fft` is the size of the Fourier Transform used to compute the spectrogram).\n         num_mel_filters (`int`):\n             Number of mel filters to generate.\n         min_frequency (`float`):\n@@ -317,6 +317,12 @@ def mel_filter_bank(\n     if norm is not None and norm != \"slaney\":\n         raise ValueError('norm must be one of None or \"slaney\"')\n \n+    if num_frequency_bins < 2:\n+        raise ValueError(f\"Require num_frequency_bins: {num_frequency_bins} >= 2\")\n+\n+    if min_frequency > max_frequency:\n+        raise ValueError(f\"Require min_frequency: {min_frequency} <= max_frequency: {max_frequency}\")\n+\n     # center points of the triangular mel filters\n     mel_min = hertz_to_mel(min_frequency, mel_scale=mel_scale)\n     mel_max = hertz_to_mel(max_frequency, mel_scale=mel_scale)\n@@ -325,7 +331,7 @@ def mel_filter_bank(\n \n     if triangularize_in_mel_space:\n         # frequencies of FFT bins in Hz, but filters triangularized in mel space\n-        fft_bin_width = sampling_rate / (num_frequency_bins * 2)\n+        fft_bin_width = sampling_rate / ((num_frequency_bins - 1) * 2)\n         fft_freqs = hertz_to_mel(fft_bin_width * np.arange(num_frequency_bins), mel_scale=mel_scale)\n         filter_freqs = mel_freqs\n     else:"
        },
        {
            "sha": "888d38e1870367526492ecfa38f3a488cc5a0b02",
            "filename": "src/transformers/models/audio_spectrogram_transformer/feature_extraction_audio_spectrogram_transformer.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Fmodels%2Faudio_spectrogram_transformer%2Ffeature_extraction_audio_spectrogram_transformer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Fmodels%2Faudio_spectrogram_transformer%2Ffeature_extraction_audio_spectrogram_transformer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Faudio_spectrogram_transformer%2Ffeature_extraction_audio_spectrogram_transformer.py?ref=fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d",
            "patch": "@@ -91,7 +91,7 @@ def __init__(\n \n         if not is_speech_available():\n             mel_filters = mel_filter_bank(\n-                num_frequency_bins=256,\n+                num_frequency_bins=257,\n                 num_mel_filters=self.num_mel_bins,\n                 min_frequency=20,\n                 max_frequency=sampling_rate // 2,\n@@ -101,7 +101,7 @@ def __init__(\n                 triangularize_in_mel_space=True,\n             )\n \n-            self.mel_filters = np.pad(mel_filters, ((0, 1), (0, 0)))\n+            self.mel_filters = mel_filters\n             self.window = window_function(400, \"hann\", periodic=False)\n \n     def _extract_fbank_features("
        },
        {
            "sha": "b17dcf792e187bf0d52b2beb5764cad0043d2723",
            "filename": "src/transformers/models/seamless_m4t/feature_extraction_seamless_m4t.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Fmodels%2Fseamless_m4t%2Ffeature_extraction_seamless_m4t.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Fmodels%2Fseamless_m4t%2Ffeature_extraction_seamless_m4t.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fseamless_m4t%2Ffeature_extraction_seamless_m4t.py?ref=fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d",
            "patch": "@@ -74,7 +74,7 @@ def __init__(\n         self.stride = stride\n \n         mel_filters = mel_filter_bank(\n-            num_frequency_bins=256,\n+            num_frequency_bins=257,\n             num_mel_filters=self.num_mel_bins,\n             min_frequency=20,\n             max_frequency=sampling_rate // 2,\n@@ -84,7 +84,7 @@ def __init__(\n             triangularize_in_mel_space=True,\n         )\n \n-        self.mel_filters = np.pad(mel_filters, ((0, 1), (0, 0)))\n+        self.mel_filters = mel_filters\n         self.window = window_function(400, \"povey\", periodic=False)\n \n         super().__init__(feature_size=feature_size, sampling_rate=sampling_rate, padding_value=padding_value, **kwargs)"
        },
        {
            "sha": "3abbfacb8de0a584360952e2674ede12ffc2750a",
            "filename": "src/transformers/models/speech_to_text/feature_extraction_speech_to_text.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Fmodels%2Fspeech_to_text%2Ffeature_extraction_speech_to_text.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/src%2Ftransformers%2Fmodels%2Fspeech_to_text%2Ffeature_extraction_speech_to_text.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fspeech_to_text%2Ffeature_extraction_speech_to_text.py?ref=fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d",
            "patch": "@@ -91,7 +91,7 @@ def __init__(\n \n         if not is_speech_available():\n             mel_filters = mel_filter_bank(\n-                num_frequency_bins=256,\n+                num_frequency_bins=257,\n                 num_mel_filters=self.num_mel_bins,\n                 min_frequency=20,\n                 max_frequency=sampling_rate // 2,\n@@ -101,7 +101,7 @@ def __init__(\n                 triangularize_in_mel_space=True,\n             )\n \n-            self.mel_filters = np.pad(mel_filters, ((0, 1), (0, 0)))\n+            self.mel_filters = mel_filters\n             self.window = window_function(400, \"povey\", periodic=False)\n \n     def _extract_fbank_features("
        },
        {
            "sha": "9ece033d06409ee5074b7c7cd6b0d5909a7da64f",
            "filename": "tests/utils/test_audio_utils.py",
            "status": "modified",
            "additions": 31,
            "deletions": 23,
            "changes": 54,
            "blob_url": "https://github.com/huggingface/transformers/blob/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/tests%2Futils%2Ftest_audio_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d/tests%2Futils%2Ftest_audio_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_audio_utils.py?ref=fb8e6c50e4a3a4bb1011e286d9bd26d79cd6334d",
            "patch": "@@ -194,26 +194,38 @@ def test_mel_filter_bank_kaldi(self):\n             triangularize_in_mel_space=True,\n         )\n         # fmt: off\n+        # here the expected values from torchaudio.compliance.kaldi.get_mel_banks\n+        # note that we compute values in float64 while they do it in float32\n         expected = np.array(\n-        [[0.0000, 0.0000, 0.0000, 0.0000],\n-        [0.6086, 0.0000, 0.0000, 0.0000],\n-        [0.8689, 0.1311, 0.0000, 0.0000],\n-        [0.4110, 0.5890, 0.0000, 0.0000],\n-        [0.0036, 0.9964, 0.0000, 0.0000],\n-        [0.0000, 0.6366, 0.3634, 0.0000],\n-        [0.0000, 0.3027, 0.6973, 0.0000],\n-        [0.0000, 0.0000, 0.9964, 0.0036],\n-        [0.0000, 0.0000, 0.7135, 0.2865],\n-        [0.0000, 0.0000, 0.4507, 0.5493],\n-        [0.0000, 0.0000, 0.2053, 0.7947],\n-        [0.0000, 0.0000, 0.0000, 0.9752],\n-        [0.0000, 0.0000, 0.0000, 0.7585],\n-        [0.0000, 0.0000, 0.0000, 0.5539],\n-        [0.0000, 0.0000, 0.0000, 0.3599],\n-        [0.0000, 0.0000, 0.0000, 0.1756]]\n+            [\n+                [0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000],\n+                [0.6457883715629578, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000],\n+                [0.8044781088829041, 0.1955219060182571, 0.0000000000000000, 0.0000000000000000],\n+                [0.3258901536464691, 0.6741098165512085, 0.0000000000000000, 0.0000000000000000],\n+                [0.0000000000000000, 0.9021250009536743, 0.0978749766945839, 0.0000000000000000],\n+                [0.0000000000000000, 0.5219038724899292, 0.4780961275100708, 0.0000000000000000],\n+                [0.0000000000000000, 0.1771058291196823, 0.8228941559791565, 0.0000000000000000],\n+                [0.0000000000000000, 0.0000000000000000, 0.8616894483566284, 0.1383105516433716],\n+                [0.0000000000000000, 0.0000000000000000, 0.5710380673408508, 0.4289619624614716],\n+                [0.0000000000000000, 0.0000000000000000, 0.3015440106391907, 0.6984559893608093],\n+                [0.0000000000000000, 0.0000000000000000, 0.0503356307744980, 0.9496643543243408],\n+                [0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.8150880336761475],\n+                [0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.5938932299613953],\n+                [0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.3851676583290100],\n+                [0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.1875794380903244],\n+            ],\n+            dtype=np.float64,\n         )\n         # fmt: on\n-        self.assertTrue(np.allclose(mel_filters, expected, atol=5e-5))\n+\n+        # kaldi implementation does not compute values for last fft bin\n+        # indeed, they enforce max_frequency <= sampling_rate / 2 and\n+        # therefore they know that last fft bin filter bank values will be all 0\n+        # and pad after with zeros\n+        # to comply with our API for `mel_filter_bank`, we need to also pad here\n+        expected = np.pad(expected, ((0, 1), (0, 0)))\n+\n+        self.assertTrue(np.allclose(mel_filters, expected))\n \n     def test_mel_filter_bank_slaney_norm(self):\n         mel_filters = mel_filter_bank(\n@@ -369,7 +381,7 @@ def test_spectrogram_integration_test(self):\n         self.assertTrue(np.allclose(spec[:64, 400], expected))\n \n         mel_filters = mel_filter_bank(\n-            num_frequency_bins=256,\n+            num_frequency_bins=257,\n             num_mel_filters=400,\n             min_frequency=20,\n             max_frequency=8000,\n@@ -379,8 +391,6 @@ def test_spectrogram_integration_test(self):\n             triangularize_in_mel_space=True,\n         )\n \n-        mel_filters = np.pad(mel_filters, ((0, 1), (0, 0)))\n-\n         spec = spectrogram(\n             waveform,\n             window_function(400, \"povey\", periodic=False),\n@@ -510,7 +520,7 @@ def test_spectrogram_batch_integration_test(self):\n         self.assertTrue(np.allclose(spec_list[2][:64, 400], expected3))\n \n         mel_filters = mel_filter_bank(\n-            num_frequency_bins=256,\n+            num_frequency_bins=257,\n             num_mel_filters=400,\n             min_frequency=20,\n             max_frequency=8000,\n@@ -520,8 +530,6 @@ def test_spectrogram_batch_integration_test(self):\n             triangularize_in_mel_space=True,\n         )\n \n-        mel_filters = np.pad(mel_filters, ((0, 1), (0, 0)))\n-\n         spec_list = spectrogram_batch(\n             waveform_list,\n             window_function(400, \"povey\", periodic=False),"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 45,
        "deletions": 31
    }
}