{
    "author": "ydshieh",
    "message": "Fix CircleCI nightly run (#33558)\n\nfix\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "6dc364616d58b9fdc70f88cd2c136e741fc28d26",
    "files": [
        {
            "sha": "0c03538f07db185712251e3321c0a353225e512e",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 40,
            "deletions": 13,
            "changes": 53,
            "blob_url": "https://github.com/huggingface/transformers/blob/6dc364616d58b9fdc70f88cd2c136e741fc28d26/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/6dc364616d58b9fdc70f88cd2c136e741fc28d26/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fconfig.yml?ref=6dc364616d58b9fdc70f88cd2c136e741fc28d26",
            "patch": "@@ -82,22 +82,49 @@ jobs:\n         parallelism: 1\n         steps:\n             - checkout\n-            - run: uv pip install -e .\n-            - run: |\n-                  mkdir test_preparation\n-                  echo -n \"tests\" > test_preparation/test_list.txt\n-                  echo -n \"all\" > test_preparation/examples_test_list.txt\n-                  echo -n \"tests/repo_utils\" > test_preparation/test_repo_utils.txt\n+            - run: uv pip install -U -e .\n+            - run: echo 'export \"GIT_COMMIT_MESSAGE=$(git show -s --format=%s)\"' >> \"$BASH_ENV\" && source \"$BASH_ENV\"\n+            - run: mkdir -p test_preparation\n+            - run: python utils/tests_fetcher.py --fetch_all | tee tests_fetched_summary.txt\n+            - run: python utils/tests_fetcher.py --filter_tests\n+            - run: export \"GIT_COMMIT_MESSAGE=$(git show -s --format=%s)\" && echo $GIT_COMMIT_MESSAGE && python .circleci/create_circleci_config.py --fetcher_folder test_preparation\n             - run: |\n-                  echo -n \"tests\" > test_list.txt\n-                  python utils/tests_fetcher.py --filter_tests\n-                  mv test_list.txt test_preparation/filtered_test_list.txt\n-            - run: python .circleci/create_circleci_config.py --fetcher_folder test_preparation\n-            - run: cp test_preparation/generated_config.yml test_preparation/generated_config.txt\n+                if [ ! -s test_preparation/generated_config.yml ]; then\n+                    echo \"No tests to run, exiting early!\"\n+                    circleci-agent step halt\n+                fi\n+\n             - store_artifacts:\n-                  path: test_preparation/generated_config.txt\n+                path: test_preparation\n+\n+            - run:\n+                name: \"Retrieve Artifact Paths\"\n+                env:\n+                    CIRCLE_TOKEN: ${{ secrets.CI_ARTIFACT_TOKEN }}\n+                command: |\n+                    project_slug=\"gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\"\n+                    job_number=${CIRCLE_BUILD_NUM}\n+                    url=\"https://circleci.com/api/v2/project/${project_slug}/${job_number}/artifacts\"\n+                    curl -o  test_preparation/artifacts.json ${url}\n+            - run:\n+                name: \"Prepare pipeline parameters\"\n+                command: |\n+                    python utils/process_test_artifacts.py \n+\n+            # To avoid too long generated_config.yaml on the continuation orb, we pass the links to the artifacts as parameters.\n+            # Otherwise the list of tests was just too big. Explicit is good but for that it was a limitation.\n+            # We used:\n+\n+            # https://circleci.com/docs/api/v2/index.html#operation/getJobArtifacts : to get the job artifacts\n+            # We could not pass a nested dict, which is why we create the test_file_... parameters for every single job\n+\n+            - store_artifacts:\n+                path: test_preparation/transformed_artifacts.json\n+            - store_artifacts:\n+                path: test_preparation/artifacts.json\n             - continuation/continue:\n-                  configuration_path: test_preparation/generated_config.yml\n+                parameters:  test_preparation/transformed_artifacts.json\n+                configuration_path: test_preparation/generated_config.yml\n \n     check_code_quality:\n         working_directory: ~/transformers"
        },
        {
            "sha": "1aa663e967c92defdeac58bdce1a7a85c3f3fe95",
            "filename": "utils/tests_fetcher.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/huggingface/transformers/blob/6dc364616d58b9fdc70f88cd2c136e741fc28d26/utils%2Ftests_fetcher.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/6dc364616d58b9fdc70f88cd2c136e741fc28d26/utils%2Ftests_fetcher.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ftests_fetcher.py?ref=6dc364616d58b9fdc70f88cd2c136e741fc28d26",
            "patch": "@@ -1193,9 +1193,9 @@ def create_test_list_from_filter(full_test_list, out_path):\n         default=None,\n     )\n     parser.add_argument(\n-        \"--commit_message\",\n-        type=str,\n-        help=\"The commit message (which could contain a command to force all tests or skip the CI).\",\n+        \"--fetch_all\",\n+        action=\"store_true\",\n+        help=\"Will fetch all tests.\",\n         default=None,\n     )\n     args = parser.parse_args()\n@@ -1212,6 +1212,9 @@ def create_test_list_from_filter(full_test_list, out_path):\n             quit()\n         if commit_flags[\"no_filter\"]:\n             print(\"Running all tests fetched without filtering.\")\n+\n+        if args.fetch_all:\n+            commit_flags[\"test_all\"] = True\n         if commit_flags[\"test_all\"]:\n             print(\"Force-launching all tests\")\n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 46,
        "deletions": 16
    }
}