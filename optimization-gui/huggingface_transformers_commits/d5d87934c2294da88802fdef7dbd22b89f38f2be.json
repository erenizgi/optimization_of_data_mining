{
    "author": "ydshieh",
    "message": "repo. consistency bot (#42575)\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* draft\n\n* fail to see the check\n\n* fail to see the check\n\n* fail to see the check\n\n* fail to see the check\n\n* fail to see the check\n\n* Apply style fixes\n\n* fail to see the check\n\n* fail to see the check\n\n* fail to see the check\n\n* Apply repo. consistency fixes\n\n* fail to see the check\n\n* Apply repo. consistency fixes\n\n* fail to see the check\n\n* delete\n\n* Apply repo. consistency fixes\n\n* comment\n\n* Apply repo. consistency fixes\n\n* comment\n\n* Apply repo. consistency fixes\n\n* comment\n\n* Apply repo. consistency fixes\n\n* comment\n\n* Apply repo. consistency fixes\n\n* back\n\n* check\n\n* check\n\n* check\n\n* check\n\n* check\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\nCo-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>",
    "sha": "d5d87934c2294da88802fdef7dbd22b89f38f2be",
    "files": [
        {
            "sha": "29a1b50b1001839503191e7d57541c69107a3595",
            "filename": ".github/workflows/pr-repo-consistency-bot.yml",
            "status": "added",
            "additions": 218,
            "deletions": 0,
            "changes": 218,
            "blob_url": "https://github.com/huggingface/transformers/blob/d5d87934c2294da88802fdef7dbd22b89f38f2be/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/d5d87934c2294da88802fdef7dbd22b89f38f2be/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml?ref=d5d87934c2294da88802fdef7dbd22b89f38f2be",
            "patch": "@@ -0,0 +1,218 @@\n+name: PR Repo. Consistency Bot\n+\n+on:\n+  issue_comment:\n+    types:\n+      - created\n+    branches-ignore:\n+      - main\n+concurrency:\n+  group: ${{ github.workflow }}-${{ github.event.issue.number }}-${{ startsWith(github.event.comment.body, '@bot /repo') }}\n+  cancel-in-progress: true\n+permissions: read-all\n+\n+\n+jobs:\n+  get-pr-number:\n+    name: Get PR number\n+    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('[\"ydshieh\", \"ArthurZucker\", \"zucchini-nlp\", \"molbap\", \"gante\", \"LysandreJik\", \"Cyrilvallez\", \"Rocketknight1\", \"SunMarc\", \"eustlb\", \"MekkCyber\", \"vasqu\", \"ivarflakstad\", \"stevhliu\", \"ebezzam\", \"remi-or\", \"itazap\", \"3outeille\"]'), github.actor) && startsWith(github.event.comment.body, '@bot /repo') }}\n+    uses: ./.github/workflows/get-pr-number.yml\n+\n+  get-pr-info:\n+    name: Get PR commit SHA\n+    needs: get-pr-number\n+    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n+    uses: ./.github/workflows/get-pr-info.yml\n+    with:\n+      pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n+\n+  check-timestamps:\n+    name: Check timestamps (security check)\n+    runs-on: ubuntu-22.04\n+    needs: get-pr-info\n+    outputs:\n+      VERIFIED_PR_HEAD_SHA: ${{ needs.get-pr-info.outputs.PR_HEAD_SHA }}\n+    steps:\n+      - name: Verify `merge_commit` timestamp is older than the issue comment timestamp\n+        env:\n+          COMMENT_DATE: ${{ github.event.comment.created_at }}\n+          PR_MERGE_COMMIT_TIMESTAMP: ${{ needs.get-pr-info.outputs.PR_MERGE_COMMIT_TIMESTAMP }}\n+        run: |\n+            COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\n+            echo \"COMMENT_DATE: $COMMENT_DATE\"\n+            echo \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\n+            if [ $COMMENT_TIMESTAMP -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n+              echo \"Last commit on the pull request is newer than the issue comment triggering this run! Abort!\";\n+              exit -1;\n+            fi\n+\n+  init_comment_with_url:\n+    name: Init Comment on PR\n+    runs-on: ubuntu-22.04\n+    needs: [get-pr-number, check-timestamps]\n+    outputs:\n+       comment_id: ${{ steps.init_comment.outputs.comment_id }}\n+    permissions:\n+      pull-requests: write\n+    steps:\n+      - name: Delete existing bot comment if it exists\n+        env:\n+          PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n+        uses: actions/github-script@v6\n+        with:\n+          script: |\n+            const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\n+            \n+            // Get all comments on the PR\n+            const { data: comments } = await github.rest.issues.listComments({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              issue_number: PR_NUMBER\n+            });\n+            \n+            // Find existing bot comments that start with \"Repo. Consistency\"\n+            const existingComments = comments.filter(comment => \n+              comment.user.login === 'github-actions[bot]' && \n+              comment.body.startsWith('Repo. Consistency')\n+            );\n+\n+            if (existingComments.length > 0) {\n+              // Get the most recent comment\n+              const mostRecentComment = existingComments\n+                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];\n+              \n+              console.log(`Deleting most recent comment #${mostRecentComment.id}`);\n+              await github.rest.issues.deleteComment({\n+                owner: context.repo.owner,\n+                repo: context.repo.repo,\n+                comment_id: mostRecentComment.id\n+              });\n+            }\n+\n+      - name: Comment on PR with workflow run link\n+        id: init_comment\n+        env:\n+          PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n+        uses: actions/github-script@v6\n+        with:\n+          script: |\n+            const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\n+            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`\n+\n+            const { data: botComment } = await github.rest.issues.createComment({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              issue_number: PR_NUMBER,\n+              body: `Repo. Consistency fix is beginning .... [View the workflow run here](${runUrl}).`\n+            });\n+            core.setOutput('comment_id', botComment.id);\n+\n+  run-repo-consistency-checks:\n+    runs-on: ubuntu-22.04\n+    needs: [get-pr-info, check-timestamps, init_comment_with_url]\n+    outputs:\n+      changes_detected: ${{ steps.run_checks.outputs.changes_detected }}\n+    steps:\n+      - uses: actions/checkout@v4\n+        with:\n+          repository: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}\n+          ref: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}\n+          fetch-depth: \"1\"\n+\n+      - name: Set up Python\n+        uses: actions/setup-python@v4\n+        with:\n+          python-version: \"3.10\"\n+\n+      - name: Install dependencies\n+        run: |\n+          python -m pip install --upgrade pip\n+          pip install -e \".[quality]\"\n+          pip install --no-cache-dir --upgrade 'torch' 'torchaudio' 'torchvision' --index-url https://download.pytorch.org/whl/cpu\n+\n+      - name: Run checks\n+        id: run_checks\n+        run: |\n+          python utils/check_copies.py --fix_and_overwrite\n+          \n+          # Check if there are changes\n+          if [ -n \"$(git status --porcelain)\" ]; then\n+            echo \"changes_detected=true\" >> $GITHUB_OUTPUT\n+            # Create a patch file with all changes\n+            git diff > consistency-fixes.patch\n+          else\n+            echo \"changes_detected=false\" >> $GITHUB_OUTPUT\n+          fi\n+\n+      - name: Upload patch\n+        if: steps.run_checks.outputs.changes_detected == 'true'\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: consistency-fixes-patch\n+          path: consistency-fixes.patch\n+\n+  commit-and-comment:\n+    runs-on: ubuntu-22.04\n+    needs: [get-pr-number, get-pr-info, check-timestamps, init_comment_with_url, run-repo-consistency-checks]\n+    if: always()\n+    permissions:\n+      pull-requests: write\n+    steps:\n+      - uses: actions/checkout@v4\n+        if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'\n+        with:\n+          repository: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}\n+          ref: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}\n+          fetch-depth: \"1\"\n+          # Need to specify `token` here, so we can push in `Commit and push changes` below.\n+          token: ${{ secrets.HF_STYLE_BOT_ACTION }}\n+\n+      - name: Download patch\n+        if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'\n+        uses: actions/download-artifact@v4\n+        with:\n+          name: consistency-fixes-patch\n+\n+      - name: Apply patch and push\n+        if: needs.run-repo-consistency-checks.outputs.changes_detected == 'true'\n+        env:\n+          PR_HEAD_REF: ${{ needs.get-pr-info.outputs.PR_HEAD_REF }}\n+          GITHUB_TOKEN: ${{ secrets.HF_STYLE_BOT_ACTION }}\n+        run: |\n+          git config user.name \"github-actions[bot]\"\n+          git config user.email \"github-actions[bot]@users.noreply.github.com\"\n+          \n+          # Apply the patch\n+          git apply consistency-fixes.patch\n+          \n+          # Only add updates to tracked files (ignores new untracked files like the patch)\n+          git add -u\n+          git commit -m \"Apply repo. consistency fixes\"\n+          git push origin HEAD:$PR_HEAD_REF\n+\n+      - name: Prepare final comment message\n+        id: prepare_final_comment\n+        if: needs.init_comment_with_url.result == 'success'\n+        env:\n+          CHANGES_DETECTED: ${{ needs.run-repo-consistency-checks.outputs.changes_detected }}\n+        run: |\n+          if [ \"$CHANGES_DETECTED\" = 'true' ]; then\n+            echo \"final_comment=Repo. Consistency bot fixed some files and pushed the changes.\" >> $GITHUB_OUTPUT\n+          else\n+            echo \"final_comment=Repo. Consistency fix runs successfully without any file modified.\" >> $GITHUB_OUTPUT\n+          fi\n+\n+      - name: Comment on PR\n+        if: needs.init_comment_with_url.result == 'success'\n+        uses: actions/github-script@v6\n+        env:\n+          PR_NUMBER: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n+        with:\n+          script: |\n+            const PR_NUMBER = parseInt(process.env.PR_NUMBER, 10);\n+            await github.rest.issues.updateComment({\n+              owner: context.repo.owner,\n+              repo: context.repo.repo,\n+              comment_id: ${{ needs.init_comment_with_url.outputs.comment_id }},\n+              body: `${{ steps.prepare_final_comment.outputs.final_comment }}`\n+            });"
        }
    ],
    "stats": {
        "total": 218,
        "additions": 218,
        "deletions": 0
    }
}