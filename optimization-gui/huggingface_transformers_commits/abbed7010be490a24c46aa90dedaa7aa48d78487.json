{
    "author": "August-murr",
    "message": "Fix dotted model names (#40745)\n\n* Fix module loading for models with dots in names\n\n* quality check\n\n* added test\n\n* wrong import\n\n* Trigger CI rerun after making test model public\n\n* Update src/transformers/dynamic_module_utils.py\n\n* Update tests/utils/test_dynamic_module_utils.py\n\n* Update tests/utils/test_dynamic_module_utils.py\n\n* Move test\n\n* make fixup\n\n---------\n\nCo-authored-by: Matt <Rocketknight1@users.noreply.github.com>\nCo-authored-by: Matt <rocketknight1@gmail.com>",
    "sha": "abbed7010be490a24c46aa90dedaa7aa48d78487",
    "files": [
        {
            "sha": "61a230999ed0b340e384639a43e320e2fd80ce86",
            "filename": "src/transformers/dynamic_module_utils.py",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/abbed7010be490a24c46aa90dedaa7aa48d78487/src%2Ftransformers%2Fdynamic_module_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/abbed7010be490a24c46aa90dedaa7aa48d78487/src%2Ftransformers%2Fdynamic_module_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fdynamic_module_utils.py?ref=abbed7010be490a24c46aa90dedaa7aa48d78487",
            "patch": "@@ -45,6 +45,16 @@\n \n \n logger = logging.get_logger(__name__)  # pylint: disable=invalid-name\n+\n+\n+def _sanitize_module_name(name: str) -> str:\n+    \"\"\"\n+    Replace `.` in module names with `_dot_` so that it doesn't\n+    look like an import path separator.\n+    \"\"\"\n+    return name.replace(\".\", \"_dot_\")\n+\n+\n _HF_REMOTE_CODE_LOCK = threading.Lock()\n \n \n@@ -358,9 +368,9 @@ def get_cached_module_file(\n     pretrained_model_name_or_path = str(pretrained_model_name_or_path)\n     is_local = os.path.isdir(pretrained_model_name_or_path)\n     if is_local:\n-        submodule = os.path.basename(pretrained_model_name_or_path)\n+        submodule = _sanitize_module_name(os.path.basename(pretrained_model_name_or_path))\n     else:\n-        submodule = pretrained_model_name_or_path.replace(\"/\", os.path.sep)\n+        submodule = _sanitize_module_name(pretrained_model_name_or_path.replace(\"/\", os.path.sep))\n         cached_module = try_to_load_from_cache(\n             pretrained_model_name_or_path, module_file, cache_dir=cache_dir, revision=_commit_hash, repo_type=repo_type\n         )\n@@ -395,7 +405,7 @@ def get_cached_module_file(\n     full_submodule = TRANSFORMERS_DYNAMIC_MODULE_NAME + os.path.sep + submodule\n     create_dynamic_module(full_submodule)\n     submodule_path = Path(HF_MODULES_CACHE) / full_submodule\n-    if submodule == os.path.basename(pretrained_model_name_or_path):\n+    if submodule == _sanitize_module_name(os.path.basename(pretrained_model_name_or_path)):\n         # We copy local files to avoid putting too many folders in sys.path. This copy is done when the file is new or\n         # has changed since last copy.\n         if not (submodule_path / module_file).exists() or not filecmp.cmp("
        },
        {
            "sha": "7af5315f844c0c13a0f199afb42a8da3acb92564",
            "filename": "tests/models/auto/test_modeling_auto.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/abbed7010be490a24c46aa90dedaa7aa48d78487/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/abbed7010be490a24c46aa90dedaa7aa48d78487/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py?ref=abbed7010be490a24c46aa90dedaa7aa48d78487",
            "patch": "@@ -594,3 +594,15 @@ def test_custom_model_patched_generation_inheritance(self):\n         # More precisely, it directly inherits from GenerationMixin. This check would fail prior to v4.45 (inheritance\n         # patching was added in v4.45)\n         self.assertTrue(\"GenerationMixin\" in str(model.__class__.__bases__))\n+\n+    def test_model_with_dotted_name_and_relative_imports(self):\n+        \"\"\"\n+        Test for issue #40496: AutoModel.from_pretrained() doesn't work for models with '.' in their name\n+        when there's a relative import.\n+\n+        Without the fix, this raises: ModuleNotFoundError: No module named 'transformers_modules.test-model_v1'\n+        \"\"\"\n+        model_id = \"hf-internal-testing/remote_code_model_with_dots\"\n+\n+        model = AutoModel.from_pretrained(model_id, trust_remote_code=True)\n+        self.assertIsNotNone(model)"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 25,
        "deletions": 3
    }
}