{
    "author": "yonigozlan",
    "message": "Fall back to slow image processor in ImageProcessingAuto when no fast processor available (#34785)\n\n* refactor image_processing_auto logic\r\n\r\n* fix fast image processor tests\r\n\r\n* Fix tests fast vit image processor\r\n\r\n* Add safeguard when use_fast True and torchvision not available\r\n\r\n* change default use_fast back to None, add warnings\r\n\r\n* remove debugging print\r\n\r\n* call get_image_processor_class_from_name once",
    "sha": "5615a393691c81e00251e420c73e4d04c6fe22e5",
    "files": [
        {
            "sha": "cbf6ae95577f70ab2c58785874484368bd4629fc",
            "filename": "docs/source/en/main_classes/image_processor.md",
            "status": "modified",
            "additions": 9,
            "deletions": 12,
            "changes": 21,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/docs%2Fsource%2Fen%2Fmain_classes%2Fimage_processor.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/docs%2Fsource%2Fen%2Fmain_classes%2Fimage_processor.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmain_classes%2Fimage_processor.md?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -27,6 +27,7 @@ from transformers import AutoImageProcessor\n \n processor = AutoImageProcessor.from_pretrained(\"facebook/detr-resnet-50\", use_fast=True)\n ```\n+Note that `use_fast` will be set to `True` by default in a future release.\n \n When using a fast image processor, you can also set the `device` argument to specify the device on which the processing should be done. By default, the processing is done on the same device as the inputs if the inputs are tensors, or on the CPU otherwise.\n \n@@ -42,21 +43,17 @@ images_processed = processor(images, return_tensors=\"pt\", device=\"cuda\")\n Here are some speed comparisons between the base and fast image processors for the `DETR` and `RT-DETR` models, and how they impact overall inference time:\n \n <div class=\"flex\">\n-  <div>\n-    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_detr_fast_padded.png\" />\n-  </div>\n-  <div>\n-    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_detr_fast_batched_compiled.png\" />\n-  </div>\n+  <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_detr_fast_padded.png\" />\n+</div>\n+<div class=\"flex\">\n+  <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_detr_fast_batched_compiled.png\" />\n </div>\n \n <div class=\"flex\">\n-  <div>\n-    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_rt_detr_fast_single.png\" />\n-  </div>\n-  <div>\n-    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_rt_detr_fast_batched.png\" />\n-  </div>\n+  <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_rt_detr_fast_single.png\" />\n+</div>\n+<div class=\"flex\">\n+  <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/benchmark_results_full_pipeline_rt_detr_fast_batched.png\" />\n </div>\n \n These benchmarks were run on an [AWS EC2 g5.2xlarge instance](https://aws.amazon.com/ec2/instance-types/g5/), utilizing an NVIDIA A10G Tensor Core GPU."
        },
        {
            "sha": "db25591eaa35440c17146cf509ea5746d42ea7ce",
            "filename": "src/transformers/models/auto/image_processing_auto.py",
            "status": "modified",
            "additions": 45,
            "deletions": 15,
            "changes": 60,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/src%2Ftransformers%2Fmodels%2Fauto%2Fimage_processing_auto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/src%2Ftransformers%2Fmodels%2Fauto%2Fimage_processing_auto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fauto%2Fimage_processing_auto.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -175,7 +175,7 @@\n IMAGE_PROCESSOR_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, IMAGE_PROCESSOR_MAPPING_NAMES)\n \n \n-def image_processor_class_from_name(class_name: str):\n+def get_image_processor_class_from_name(class_name: str):\n     if class_name == \"BaseImageProcessorFast\":\n         return BaseImageProcessorFast\n \n@@ -368,7 +368,7 @@ def from_pretrained(cls, pretrained_model_name_or_path, *inputs, **kwargs):\n                 identifier allowed by git.\n             use_fast (`bool`, *optional*, defaults to `False`):\n                 Use a fast torchvision-base image processor if it is supported for a given model.\n-                If a fast tokenizer is not available for a given model, a normal numpy-based image processor\n+                If a fast image processor is not available for a given model, a normal numpy-based image processor\n                 is returned instead.\n             return_unused_kwargs (`bool`, *optional*, defaults to `False`):\n                 If `False`, then this function returns just the final image processor object. If `True`, then this\n@@ -416,6 +416,7 @@ def from_pretrained(cls, pretrained_model_name_or_path, *inputs, **kwargs):\n             kwargs[\"token\"] = use_auth_token\n \n         config = kwargs.pop(\"config\", None)\n+        # TODO: @yoni, change in v4.48 (use_fast set to True by default)\n         use_fast = kwargs.pop(\"use_fast\", None)\n         trust_remote_code = kwargs.pop(\"trust_remote_code\", None)\n         kwargs[\"_from_auto\"] = True\n@@ -451,42 +452,71 @@ def from_pretrained(cls, pretrained_model_name_or_path, *inputs, **kwargs):\n             if not is_timm_config_dict(config_dict):\n                 raise initial_exception\n \n-        image_processor_class = config_dict.get(\"image_processor_type\", None)\n+        image_processor_type = config_dict.get(\"image_processor_type\", None)\n         image_processor_auto_map = None\n         if \"AutoImageProcessor\" in config_dict.get(\"auto_map\", {}):\n             image_processor_auto_map = config_dict[\"auto_map\"][\"AutoImageProcessor\"]\n \n         # If we still don't have the image processor class, check if we're loading from a previous feature extractor config\n         # and if so, infer the image processor class from there.\n-        if image_processor_class is None and image_processor_auto_map is None:\n+        if image_processor_type is None and image_processor_auto_map is None:\n             feature_extractor_class = config_dict.pop(\"feature_extractor_type\", None)\n             if feature_extractor_class is not None:\n-                image_processor_class = feature_extractor_class.replace(\"FeatureExtractor\", \"ImageProcessor\")\n+                image_processor_type = feature_extractor_class.replace(\"FeatureExtractor\", \"ImageProcessor\")\n             if \"AutoFeatureExtractor\" in config_dict.get(\"auto_map\", {}):\n                 feature_extractor_auto_map = config_dict[\"auto_map\"][\"AutoFeatureExtractor\"]\n                 image_processor_auto_map = feature_extractor_auto_map.replace(\"FeatureExtractor\", \"ImageProcessor\")\n \n         # If we don't find the image processor class in the image processor config, let's try the model config.\n-        if image_processor_class is None and image_processor_auto_map is None:\n+        if image_processor_type is None and image_processor_auto_map is None:\n             if not isinstance(config, PretrainedConfig):\n                 config = AutoConfig.from_pretrained(\n                     pretrained_model_name_or_path,\n                     trust_remote_code=trust_remote_code,\n                     **kwargs,\n                 )\n             # It could be in `config.image_processor_type``\n-            image_processor_class = getattr(config, \"image_processor_type\", None)\n+            image_processor_type = getattr(config, \"image_processor_type\", None)\n             if hasattr(config, \"auto_map\") and \"AutoImageProcessor\" in config.auto_map:\n                 image_processor_auto_map = config.auto_map[\"AutoImageProcessor\"]\n \n-        if image_processor_class is not None:\n-            # Update class name to reflect the use_fast option. If class is not found, None is returned.\n-            if use_fast is not None:\n-                if use_fast and not image_processor_class.endswith(\"Fast\"):\n-                    image_processor_class += \"Fast\"\n-                elif not use_fast and image_processor_class.endswith(\"Fast\"):\n-                    image_processor_class = image_processor_class[:-4]\n-            image_processor_class = image_processor_class_from_name(image_processor_class)\n+        image_processor_class = None\n+        # TODO: @yoni, change logic in v4.48 (when use_fast set to True by default)\n+        if image_processor_type is not None:\n+            # if use_fast is not set and the processor was saved with a fast processor, we use it, otherwise we use the slow processor.\n+            if use_fast is None:\n+                use_fast = image_processor_type.endswith(\"Fast\")\n+                if not use_fast:\n+                    logger.warning_once(\n+                        \"Using a slow image processor as `use_fast` is unset and a slow processor was saved with this model. \"\n+                        \"`use_fast=True` will be the default behavior in v4.48, even if the model was saved with a slow processor. \"\n+                        \"This will result in minor differences in outputs. You'll still be able to use a slow processor with `use_fast=False`.\"\n+                    )\n+            # Update class name to reflect the use_fast option. If class is not found, we fall back to the slow version.\n+            if use_fast and not is_torchvision_available():\n+                logger.warning_once(\n+                    \"Using `use_fast=True` but `torchvision` is not available. Falling back to the slow image processor.\"\n+                )\n+                use_fast = False\n+            if use_fast:\n+                if not image_processor_type.endswith(\"Fast\"):\n+                    image_processor_type += \"Fast\"\n+                for _, image_processors in IMAGE_PROCESSOR_MAPPING_NAMES.items():\n+                    if image_processor_type in image_processors:\n+                        break\n+                else:\n+                    image_processor_type = image_processor_type[:-4]\n+                    use_fast = False\n+                    logger.warning_once(\n+                        \"`use_fast` is set to `True` but the image processor class does not have a fast version. \"\n+                        \" Falling back to the slow version.\"\n+                    )\n+                image_processor_class = get_image_processor_class_from_name(image_processor_type)\n+            else:\n+                image_processor_type = (\n+                    image_processor_type[:-4] if image_processor_type.endswith(\"Fast\") else image_processor_type\n+                )\n+                image_processor_class = get_image_processor_class_from_name(image_processor_type)\n \n         has_remote_code = image_processor_auto_map is not None\n         has_local_code = image_processor_class is not None or type(config) in IMAGE_PROCESSOR_MAPPING"
        },
        {
            "sha": "e8abdcfe5cc82db9c487db55c87a16c056964281",
            "filename": "src/transformers/models/vit/image_processing_vit_fast.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/src%2Ftransformers%2Fmodels%2Fvit%2Fimage_processing_vit_fast.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/src%2Ftransformers%2Fmodels%2Fvit%2Fimage_processing_vit_fast.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fvit%2Fimage_processing_vit_fast.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -254,6 +254,7 @@ def preprocess(\n         image_std = image_std if image_std is not None else self.image_std\n         size = size if size is not None else self.size\n         do_convert_rgb = do_convert_rgb if do_convert_rgb is not None else self.do_convert_rgb\n+        return_tensors = \"pt\" if return_tensors is None else return_tensors\n         # Make hashable for cache\n         size = SizeDict(**size)\n         image_mean = tuple(image_mean) if isinstance(image_mean, list) else image_mean"
        },
        {
            "sha": "1becf25ae7c33ce4f4d39ed057fa71c662b6f8b8",
            "filename": "tests/models/auto/test_image_processing_auto.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Fauto%2Ftest_image_processing_auto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Fauto%2Ftest_image_processing_auto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fauto%2Ftest_image_processing_auto.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -140,6 +140,7 @@ def test_image_processor_not_found(self):\n     def test_use_fast_selection(self):\n         checkpoint = \"hf-internal-testing/tiny-random-vit\"\n \n+        # TODO: @yoni, change in v4.48 (when use_fast set to True by default)\n         # Slow image processor is selected by default\n         image_processor = AutoImageProcessor.from_pretrained(checkpoint)\n         self.assertIsInstance(image_processor, ViTImageProcessor)"
        },
        {
            "sha": "a0b469f2de92ff75eb46196424cf3c530937db11",
            "filename": "tests/models/detr/test_image_processing_detr.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Fdetr%2Ftest_image_processing_detr.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Fdetr%2Ftest_image_processing_detr.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fdetr%2Ftest_image_processing_detr.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -19,7 +19,7 @@\n \n import numpy as np\n \n-from transformers.testing_utils import require_torch, require_torch_gpu, require_vision, slow\n+from transformers.testing_utils import require_torch, require_torch_gpu, require_torchvision, require_vision, slow\n from transformers.utils import is_torch_available, is_torchvision_available, is_vision_available\n \n from ...test_image_processing_common import AnnotationFormatTestMixin, ImageProcessingTestMixin, prepare_image_inputs\n@@ -669,6 +669,7 @@ def test_longest_edge_shortest_edge_resizing_strategy(self):\n \n     @slow\n     @require_torch_gpu\n+    @require_torchvision\n     def test_fast_processor_equivalence_cpu_gpu_coco_detection_annotations(self):\n         # prepare image and target\n         image = Image.open(\"./tests/fixtures/tests_samples/COCO/000000039769.png\")\n@@ -724,6 +725,7 @@ def test_fast_processor_equivalence_cpu_gpu_coco_detection_annotations(self):\n \n     @slow\n     @require_torch_gpu\n+    @require_torchvision\n     def test_fast_processor_equivalence_cpu_gpu_coco_panoptic_annotations(self):\n         # prepare image, target and masks_path\n         image = Image.open(\"./tests/fixtures/tests_samples/COCO/000000039769.png\")"
        },
        {
            "sha": "2be3ea3e7651c22fd27452c8a55c80a9742d5279",
            "filename": "tests/models/rt_detr/test_image_processing_rt_detr.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Frt_detr%2Ftest_image_processing_rt_detr.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Frt_detr%2Ftest_image_processing_rt_detr.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Frt_detr%2Ftest_image_processing_rt_detr.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -16,7 +16,7 @@\n \n import requests\n \n-from transformers.testing_utils import require_torch, require_torch_gpu, require_vision, slow\n+from transformers.testing_utils import require_torch, require_torch_gpu, require_torchvision, require_vision, slow\n from transformers.utils import is_torch_available, is_torchvision_available, is_vision_available\n \n from ...test_image_processing_common import ImageProcessingTestMixin, prepare_image_inputs\n@@ -374,6 +374,7 @@ def test_batched_coco_detection_annotations(self):\n \n     @slow\n     @require_torch_gpu\n+    @require_torchvision\n     # Copied from tests.models.detr.test_image_processing_detr.DetrImageProcessingTest.test_fast_processor_equivalence_cpu_gpu_coco_detection_annotations\n     def test_fast_processor_equivalence_cpu_gpu_coco_detection_annotations(self):\n         # prepare image and target"
        },
        {
            "sha": "e62bfe704d1d93901e989821e688289033b3e773",
            "filename": "tests/models/vision_text_dual_encoder/test_processor_vision_text_dual_encoder.py",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Fvision_text_dual_encoder%2Ftest_processor_vision_text_dual_encoder.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Fmodels%2Fvision_text_dual_encoder%2Ftest_processor_vision_text_dual_encoder.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fvision_text_dual_encoder%2Ftest_processor_vision_text_dual_encoder.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -21,13 +21,13 @@\n from transformers import BertTokenizerFast\n from transformers.models.bert.tokenization_bert import VOCAB_FILES_NAMES, BertTokenizer\n from transformers.testing_utils import require_tokenizers, require_vision\n-from transformers.utils import IMAGE_PROCESSOR_NAME, is_vision_available\n+from transformers.utils import IMAGE_PROCESSOR_NAME, is_torchvision_available, is_vision_available\n \n from ...test_processing_common import ProcessorTesterMixin\n \n \n if is_vision_available():\n-    from transformers import VisionTextDualEncoderProcessor, ViTImageProcessor\n+    from transformers import VisionTextDualEncoderProcessor, ViTImageProcessor, ViTImageProcessorFast\n \n \n @require_tokenizers\n@@ -63,6 +63,8 @@ def get_tokenizer(self, **kwargs):\n         return BertTokenizer.from_pretrained(self.tmpdirname, **kwargs)\n \n     def get_image_processor(self, **kwargs):\n+        if is_torchvision_available():\n+            return ViTImageProcessorFast.from_pretrained(self.tmpdirname, **kwargs)\n         return ViTImageProcessor.from_pretrained(self.tmpdirname, **kwargs)\n \n     def tearDown(self):\n@@ -81,7 +83,7 @@ def test_save_load_pretrained_default(self):\n         self.assertIsInstance(processor.tokenizer, (BertTokenizer, BertTokenizerFast))\n \n         self.assertEqual(processor.image_processor.to_json_string(), image_processor.to_json_string())\n-        self.assertIsInstance(processor.image_processor, ViTImageProcessor)\n+        self.assertIsInstance(processor.image_processor, (ViTImageProcessor, ViTImageProcessorFast))\n \n     def test_save_load_pretrained_additional_features(self):\n         processor = VisionTextDualEncoderProcessor(\n@@ -100,7 +102,7 @@ def test_save_load_pretrained_additional_features(self):\n         self.assertIsInstance(processor.tokenizer, (BertTokenizer, BertTokenizerFast))\n \n         self.assertEqual(processor.image_processor.to_json_string(), image_processor_add_kwargs.to_json_string())\n-        self.assertIsInstance(processor.image_processor, ViTImageProcessor)\n+        self.assertIsInstance(processor.image_processor, (ViTImageProcessor, ViTImageProcessorFast))\n \n     def test_image_processor(self):\n         image_processor = self.get_image_processor()\n@@ -110,8 +112,8 @@ def test_image_processor(self):\n \n         image_input = self.prepare_image_inputs()\n \n-        input_feat_extract = image_processor(image_input, return_tensors=\"np\")\n-        input_processor = processor(images=image_input, return_tensors=\"np\")\n+        input_feat_extract = image_processor(image_input, return_tensors=\"pt\")\n+        input_processor = processor(images=image_input, return_tensors=\"pt\")\n \n         for key in input_feat_extract.keys():\n             self.assertAlmostEqual(input_feat_extract[key].sum(), input_processor[key].sum(), delta=1e-2)"
        },
        {
            "sha": "221552175a93e357c7b63ea8bb2809b13bb00994",
            "filename": "tests/test_image_processing_common.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Ftest_image_processing_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5615a393691c81e00251e420c73e4d04c6fe22e5/tests%2Ftest_image_processing_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_image_processing_common.py?ref=5615a393691c81e00251e420c73e4d04c6fe22e5",
            "patch": "@@ -228,14 +228,15 @@ def test_image_processor_from_and_save_pretrained(self):\n             self.assertEqual(image_processor_second.to_dict(), image_processor_first.to_dict())\n \n     def test_image_processor_save_load_with_autoimageprocessor(self):\n-        for image_processing_class in self.image_processor_list:\n+        for i, image_processing_class in enumerate(self.image_processor_list):\n             image_processor_first = image_processing_class(**self.image_processor_dict)\n \n             with tempfile.TemporaryDirectory() as tmpdirname:\n                 saved_file = image_processor_first.save_pretrained(tmpdirname)[0]\n                 check_json_file_has_correct_format(saved_file)\n \n-                image_processor_second = AutoImageProcessor.from_pretrained(tmpdirname)\n+                use_fast = i == 1\n+                image_processor_second = AutoImageProcessor.from_pretrained(tmpdirname, use_fast=use_fast)\n \n             self.assertEqual(image_processor_second.to_dict(), image_processor_first.to_dict())\n "
        }
    ],
    "stats": {
        "total": 109,
        "additions": 72,
        "deletions": 37
    }
}