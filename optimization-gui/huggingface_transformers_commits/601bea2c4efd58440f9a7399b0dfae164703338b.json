{
    "author": "manueldeprada",
    "message": "Verbose error in fix mode for utils/check_docstrings.py (#38915)\n\n* fix ast deprecations for python 3.14: replace node.n by node.value and use `ast.Constant`\n\nMore verbose exceptions in `fix_docstring` on docstring formatting issues.",
    "sha": "601bea2c4efd58440f9a7399b0dfae164703338b",
    "files": [
        {
            "sha": "946f678fb33f73ff41d39c825c81aa4652bcb322",
            "filename": "utils/check_docstrings.py",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/huggingface/transformers/blob/601bea2c4efd58440f9a7399b0dfae164703338b/utils%2Fcheck_docstrings.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/601bea2c4efd58440f9a7399b0dfae164703338b/utils%2Fcheck_docstrings.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_docstrings.py?ref=601bea2c4efd58440f9a7399b0dfae164703338b",
            "patch": "@@ -681,8 +681,8 @@ def eval_math_expression(expression: str) -> Optional[Union[float, int]]:\n \n \n def eval_node(node):\n-    if isinstance(node, ast.Num):  # <number>\n-        return node.n\n+    if isinstance(node, ast.Constant) and type(node.value) in (int, float, complex):\n+        return node.value\n     elif isinstance(node, ast.BinOp):  # <left> <operator> <right>\n         return MATH_OPERATORS[type(node.op)](eval_node(node.left), eval_node(node.right))\n     elif isinstance(node, ast.UnaryOp):  # <operator> <operand> e.g., -1\n@@ -941,7 +941,8 @@ def fix_docstring(obj: Any, old_doc_args: str, new_doc_args: str):\n         idx += 1\n \n     if idx == len(source):\n-        # Args are not defined in the docstring of this object\n+        # Args are not defined in the docstring of this object. This can happen when the docstring is inherited.\n+        # In this case, we are not trying to fix it on the child object.\n         return\n \n     # Get to the line where we stop documenting arguments\n@@ -958,7 +959,21 @@ def fix_docstring(obj: Any, old_doc_args: str, new_doc_args: str):\n \n     if \"\".join(source[start_idx:idx])[:-1] != old_doc_args:\n         # Args are not fully defined in the docstring of this object\n-        return\n+        # This can happen due to a mismatch in indentation calculation where the docstring parsing\n+        # in match_docstring_with_signature uses obj.__doc__.split(\"\\n\") while here we use\n+        # inspect.getsourcelines(obj) which can have different line endings or indentation.\n+        # See https://github.com/huggingface/transformers/pull/38915/files#r2200675302 for more details.\n+        obj_file = find_source_file(obj)\n+        actual_args_section = \"\".join(source[start_idx:idx])[:-1]\n+        raise ValueError(\n+            f\"Cannot fix docstring of {obj.__name__} in {obj_file} because the argument section in the source code \"\n+            f\"does not match the expected format. This usually happens when:\\n\"\n+            f\"1. The argument section is not properly indented\\n\"\n+            f\"2. The argument section contains unexpected formatting\\n\"\n+            f\"3. The docstring parsing failed to correctly identify the argument boundaries\\n\\n\"\n+            f\"Expected argument section:\\n{repr(old_doc_args)}\\n\\n\"\n+            f\"Actual argument section found:\\n{repr(actual_args_section)}\\n\\n\"\n+        )\n \n     obj_file = find_source_file(obj)\n     with open(obj_file, \"r\", encoding=\"utf-8\") as f:"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 19,
        "deletions": 4
    }
}