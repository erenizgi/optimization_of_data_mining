{
    "author": "Rocketknight1",
    "message": "Fix local repos with remote code not registering for pipelines (#33100)\n\n* Extremely experimental fix!\r\n\r\n* Try removing the clause entirely\r\n\r\n* Add test\r\n\r\n* make fixup\r\n\r\n* stash commit\r\n\r\n* Remove breakpoint\r\n\r\n* Add anti-regression test\r\n\r\n* make fixup\r\n\r\n* Move repos to hf-internal-testing!",
    "sha": "38d58a4427c7c5093dc7bde45613d2bb0a5dea2c",
    "files": [
        {
            "sha": "220ae97f5073c62fe8ce3c215fbd50fc1cc9802e",
            "filename": "src/transformers/models/auto/auto_factory.py",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/38d58a4427c7c5093dc7bde45613d2bb0a5dea2c/src%2Ftransformers%2Fmodels%2Fauto%2Fauto_factory.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/38d58a4427c7c5093dc7bde45613d2bb0a5dea2c/src%2Ftransformers%2Fmodels%2Fauto%2Fauto_factory.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fauto%2Fauto_factory.py?ref=38d58a4427c7c5093dc7bde45613d2bb0a5dea2c",
            "patch": "@@ -17,7 +17,6 @@\n import copy\n import importlib\n import json\n-import os\n import warnings\n from collections import OrderedDict\n \n@@ -427,10 +426,7 @@ def from_config(cls, config, **kwargs):\n             else:\n                 repo_id = config.name_or_path\n             model_class = get_class_from_dynamic_module(class_ref, repo_id, **kwargs)\n-            if os.path.isdir(config._name_or_path):\n-                model_class.register_for_auto_class(cls.__name__)\n-            else:\n-                cls.register(config.__class__, model_class, exist_ok=True)\n+            cls.register(config.__class__, model_class, exist_ok=True)\n             _ = kwargs.pop(\"code_revision\", None)\n             return model_class._from_config(config, **kwargs)\n         elif type(config) in cls._model_mapping.keys():\n@@ -552,10 +548,7 @@ def from_pretrained(cls, pretrained_model_name_or_path, *model_args, **kwargs):\n                 class_ref, pretrained_model_name_or_path, code_revision=code_revision, **hub_kwargs, **kwargs\n             )\n             _ = hub_kwargs.pop(\"code_revision\", None)\n-            if os.path.isdir(pretrained_model_name_or_path):\n-                model_class.register_for_auto_class(cls.__name__)\n-            else:\n-                cls.register(config.__class__, model_class, exist_ok=True)\n+            cls.register(config.__class__, model_class, exist_ok=True)\n             return model_class.from_pretrained(\n                 pretrained_model_name_or_path, *model_args, config=config, **hub_kwargs, **kwargs\n             )"
        },
        {
            "sha": "61085b9b5d4572de779e02aa2b0551e3aa8f4eb2",
            "filename": "tests/models/auto/test_modeling_auto.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/38d58a4427c7c5093dc7bde45613d2bb0a5dea2c/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/38d58a4427c7c5093dc7bde45613d2bb0a5dea2c/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py?ref=38d58a4427c7c5093dc7bde45613d2bb0a5dea2c",
            "patch": "@@ -21,6 +21,7 @@\n from pathlib import Path\n \n import pytest\n+from huggingface_hub import Repository\n \n import transformers\n from transformers import BertConfig, GPT2Model, is_safetensors_available, is_torch_available\n@@ -529,3 +530,12 @@ def test_attr_not_existing(self):\n         _MODEL_MAPPING_NAMES = OrderedDict([(\"bert\", \"GPT2Model\")])\n         _MODEL_MAPPING = _LazyAutoMapping(_CONFIG_MAPPING_NAMES, _MODEL_MAPPING_NAMES)\n         self.assertEqual(_MODEL_MAPPING[BertConfig], GPT2Model)\n+\n+    def test_dynamic_saving_from_local_repo(self):\n+        with tempfile.TemporaryDirectory() as tmp_dir, tempfile.TemporaryDirectory() as tmp_dir_out:\n+            _ = Repository(local_dir=tmp_dir, clone_from=\"hf-internal-testing/tiny-random-custom-architecture\")\n+            model = AutoModelForCausalLM.from_pretrained(tmp_dir, trust_remote_code=True)\n+            model.save_pretrained(tmp_dir_out)\n+            _ = AutoModelForCausalLM.from_pretrained(tmp_dir_out, trust_remote_code=True)\n+            self.assertTrue((Path(tmp_dir_out) / \"modeling_fake_custom.py\").is_file())\n+            self.assertTrue((Path(tmp_dir_out) / \"configuration_fake_custom.py\").is_file())"
        },
        {
            "sha": "e99af89f7c08202266049c0e6a3b8286ba39c1e3",
            "filename": "tests/pipelines/test_pipelines_common.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/38d58a4427c7c5093dc7bde45613d2bb0a5dea2c/tests%2Fpipelines%2Ftest_pipelines_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/38d58a4427c7c5093dc7bde45613d2bb0a5dea2c/tests%2Fpipelines%2Ftest_pipelines_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fpipelines%2Ftest_pipelines_common.py?ref=38d58a4427c7c5093dc7bde45613d2bb0a5dea2c",
            "patch": "@@ -22,7 +22,7 @@\n \n import datasets\n import numpy as np\n-from huggingface_hub import HfFolder, delete_repo\n+from huggingface_hub import HfFolder, Repository, delete_repo\n from requests.exceptions import HTTPError\n \n from transformers import (\n@@ -226,6 +226,14 @@ def test_torch_dtype_property(self):\n         pipe.model = None\n         self.assertIsNone(pipe.torch_dtype)\n \n+    @require_torch\n+    def test_auto_model_pipeline_registration_from_local_dir(self):\n+        with tempfile.TemporaryDirectory() as tmp_dir:\n+            _ = Repository(local_dir=tmp_dir, clone_from=\"hf-internal-testing/tiny-random-custom-architecture\")\n+            pipe = pipeline(\"text-generation\", tmp_dir, trust_remote_code=True)\n+\n+            self.assertIsInstance(pipe, TextGenerationPipeline)  # Assert successful load\n+\n \n @is_pipeline_test\n class PipelineScikitCompatTest(unittest.TestCase):"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 21,
        "deletions": 10
    }
}