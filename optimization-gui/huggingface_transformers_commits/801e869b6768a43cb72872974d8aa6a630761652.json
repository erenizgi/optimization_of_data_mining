{
    "author": "ydshieh",
    "message": "send some feedback when manually building doc via comment (#39889)\n\n* fix\n\n* fix\n\n* fix\n\n* Update .github/workflows/pr_build_doc_with_comment.yml\n\nCo-authored-by: Joao Gante <joaofranciscocardosogante@gmail.com>\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\nCo-authored-by: Joao Gante <joaofranciscocardosogante@gmail.com>",
    "sha": "801e869b6768a43cb72872974d8aa6a630761652",
    "files": [
        {
            "sha": "ec43c5b2cf96ce96bd443f651b8b1fcc196c9767",
            "filename": ".github/workflows/pr_build_doc_with_comment.yml",
            "status": "modified",
            "additions": 76,
            "deletions": 0,
            "changes": 76,
            "blob_url": "https://github.com/huggingface/transformers/blob/801e869b6768a43cb72872974d8aa6a630761652/.github%2Fworkflows%2Fpr_build_doc_with_comment.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/801e869b6768a43cb72872974d8aa6a630761652/.github%2Fworkflows%2Fpr_build_doc_with_comment.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fpr_build_doc_with_comment.yml?ref=801e869b6768a43cb72872974d8aa6a630761652",
            "patch": "@@ -46,6 +46,49 @@ jobs:\n             exit -1;\n           fi\n \n+  create_run:\n+    name: Create run\n+    needs: [get-pr-number, get-pr-info]\n+    if: ${{ needs.get-pr-number.outputs.PR_NUMBER != '' }}\n+    permissions:\n+      statuses: write\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - name: Create Run\n+        id: create_run\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          # Create a commit status (pending) for a run of this workflow. The status has to be updated later in `update_run_status`.\n+          # See https://docs.github.com/en/rest/commits/statuses?apiVersion=2022-11-28#create-a-commit-status\n+          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n+        run: |\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            repos/${{ github.repository }}/statuses/${{ needs.get-pr-info.outputs.PR_HEAD_SHA }} \\\n+            -f \"target_url=$GITHUB_RUN_URL\" -f \"state=pending\" -f \"description=Custom doc building job\" -f \"context=custom-doc-build\"\n+\n+  reply_to_comment:\n+    name: Reply to the comment\n+    if: ${{ needs.create_run.result == 'success' }}\n+    needs: [get-pr-number, create_run]\n+    permissions:\n+      pull-requests: write\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - name: Reply to the comment\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n+        run: |\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            repos/${{ github.repository }}/issues/${{ needs.get-pr-number.outputs.PR_NUMBER }}/comments \\\n+            -f \"body=[Building docs for all languages...](${{ env.GITHUB_RUN_URL }})\"\n+\n   build-doc:\n     name: Build doc\n     needs: [get-pr-number, get-pr-info]\n@@ -56,3 +99,36 @@ jobs:\n       pr_number: ${{ needs.get-pr-number.outputs.PR_NUMBER }}\n       package: transformers\n       languages: ar de en es fr hi it ko pt tr zh ja te\n+\n+  update_run_status:\n+    name: Update Check Run Status\n+    needs: [ get-pr-info, create_run, build-doc ]\n+    permissions:\n+      statuses: write\n+    if: ${{ always() && needs.create_run.result == 'success' }}\n+    runs-on: ubuntu-22.04\n+    env:\n+      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+      GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n+      STATUS_OK: ${{ contains(fromJSON('[\"skipped\", \"success\"]'), needs.create_run.result) }}\n+    steps:\n+      - name: Get `build-doc` job status\n+        run: |\n+          echo \"${{ needs.build-doc.result }}\"\n+          echo $STATUS_OK\n+          if [ \"$STATUS_OK\" = \"true\" ]; then\n+            echo \"STATUS=success\" >> $GITHUB_ENV\n+          else\n+            echo \"STATUS=failure\" >> $GITHUB_ENV\n+          fi\n+\n+      - name: Update PR commit statuses\n+        run: |\n+          echo \"${{ needs.build-doc.result }}\"\n+          echo \"${{ env.STATUS }}\"\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            repos/${{ github.repository }}/statuses/${{ needs.get-pr-info.outputs.PR_HEAD_SHA }} \\\n+            -f \"target_url=$GITHUB_RUN_URL\" -f \"state=${{ env.STATUS }}\" -f \"description=Custom doc building job\" -f \"context=custom-doc-build\""
        }
    ],
    "stats": {
        "total": 76,
        "additions": 76,
        "deletions": 0
    }
}