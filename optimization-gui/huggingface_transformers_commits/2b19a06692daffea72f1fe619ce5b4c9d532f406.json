{
    "author": "Isotr0py",
    "message": "Fix gemma3n feature extractor's incorrect squeeze (#39919)\n\n* fix gemma3n squeeze\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\n\n* add regression test\n\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>\n\n---------\n\nSigned-off-by: Isotr0py <2037008807@qq.com>\nSigned-off-by: Isotr0py <mozf@mail2.sysu.edu.cn>",
    "sha": "2b19a06692daffea72f1fe619ce5b4c9d532f406",
    "files": [
        {
            "sha": "e261100b21009d26f140c5cee1dcf9fe9087bbab",
            "filename": "src/transformers/models/gemma3n/feature_extraction_gemma3n.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/2b19a06692daffea72f1fe619ce5b4c9d532f406/src%2Ftransformers%2Fmodels%2Fgemma3n%2Ffeature_extraction_gemma3n.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2b19a06692daffea72f1fe619ce5b4c9d532f406/src%2Ftransformers%2Fmodels%2Fgemma3n%2Ffeature_extraction_gemma3n.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma3n%2Ffeature_extraction_gemma3n.py?ref=2b19a06692daffea72f1fe619ce5b4c9d532f406",
            "patch": "@@ -261,7 +261,7 @@ def _extract_spectrogram(self, waveform: np.ndarray, attention_mask: np.ndarray)\n         if self.per_bin_stddev is not None:\n             log_mel_spec = log_mel_spec / self.per_bin_stddev  # Broadcasting\n \n-        mel_spectrogram = log_mel_spec.squeeze()\n+        mel_spectrogram = log_mel_spec.squeeze(0)\n         mask = attention_mask[:: self.hop_length].astype(bool)\n         # TODO: The filtered mask is always exactly 3 elements longer than the mel_spectrogram. Why???\n         return mel_spectrogram, mask[: mel_spectrogram.shape[0]]"
        },
        {
            "sha": "eb57c7f23da7e880668377a4e649d898ac1ac4af",
            "filename": "tests/models/gemma3n/test_feature_extraction_gemma3n.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/huggingface/transformers/blob/2b19a06692daffea72f1fe619ce5b4c9d532f406/tests%2Fmodels%2Fgemma3n%2Ftest_feature_extraction_gemma3n.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2b19a06692daffea72f1fe619ce5b4c9d532f406/tests%2Fmodels%2Fgemma3n%2Ftest_feature_extraction_gemma3n.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fgemma3n%2Ftest_feature_extraction_gemma3n.py?ref=2b19a06692daffea72f1fe619ce5b4c9d532f406",
            "patch": "@@ -228,6 +228,25 @@ def test_call(self, audio_inputs, test_truncation=False):\n             for enc_seq_1, enc_seq_2 in zip(encoded_sequences_1, encoded_sequences_2):\n                 self.assertTrue(np.allclose(enc_seq_1, enc_seq_2, atol=1e-3))\n \n+    def test_audio_features_attn_mask_consistent(self):\n+        # regression test for https://github.com/huggingface/transformers/issues/39911\n+        # Test input_features and input_features_mask have consistent shape\n+        np.random.seed(42)\n+        feature_extractor = self.feature_extraction_class(**self.feat_extract_dict)\n+        for i in [512, 640, 1024]:\n+            audio = np.random.randn(i)\n+            mm_data = {\n+                \"raw_speech\": [audio],\n+                \"sampling_rate\": 16000,\n+            }\n+            inputs = feature_extractor(**mm_data, return_tensors=\"np\")\n+            out = inputs[\"input_features\"]\n+            mask = inputs[\"input_features_mask\"]\n+\n+            assert out.ndim == 3\n+            assert mask.ndim == 2\n+            assert out.shape[:2] == mask.shape[:2]\n+\n     def test_dither(self):\n         np.random.seed(42)  # seed the dithering randn()\n "
        }
    ],
    "stats": {
        "total": 21,
        "additions": 20,
        "deletions": 1
    }
}