{
    "author": "Abdennacer-Badaoui",
    "message": "update gemma3 exepectations and switch to dynamic cache (#42688)",
    "sha": "ad5410453c2938f3d1bd73d140fbba7108013049",
    "files": [
        {
            "sha": "0fa47b707bfb4cdab8f3adbc0f7ba07e17347c31",
            "filename": "tests/models/gemma3/test_modeling_gemma3.py",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/huggingface/transformers/blob/ad5410453c2938f3d1bd73d140fbba7108013049/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ad5410453c2938f3d1bd73d140fbba7108013049/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py?ref=ad5410453c2938f3d1bd73d140fbba7108013049",
            "patch": "@@ -576,6 +576,11 @@ def test_model_4b_batch(self):\n \n     @require_torch_large_accelerator\n     def test_model_4b_crops(self):\n+        # TODO: fix this test for ROCm\n+        # It fails because the static cache is not working correctly for ROCm here and also for test_model_4b_batch_crops and test_model_4b_multiimage.\n+        # The model generates only a few tokens (e.g., \"The\") and then stops early with EOS tokens\n+        # due to NaN logits caused by tensor indexing issues on ROCm devices when using static cache with multimodal inputs.\n+\n         model_id = \"google/gemma-3-4b-it\"\n \n         model = Gemma3ForConditionalGeneration.from_pretrained(model_id, dtype=torch.bfloat16).to(torch_device)\n@@ -658,7 +663,7 @@ def test_model_4b_batch_crops(self):\n             **crop_config,\n         ).to(torch_device)\n \n-        output = model.generate(**inputs, max_new_tokens=30, do_sample=False, cache_implementation=\"static\")\n+        output = model.generate(**inputs, max_new_tokens=30, do_sample=False)\n         output_text = self.processor.batch_decode(output, skip_special_tokens=True)\n         EXPECTED_NUM_IMAGES = 9  # 3 * (one for the origin image and two crops of images) = 9\n         EXPECTED_TEXTS = Expectations(\n@@ -677,7 +682,7 @@ def test_model_4b_batch_crops(self):\n                 ],\n                 (\"rocm\", (9, 4)) : [\n                     \"user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There's a bright blue sky with some white clouds in the\",\n-                    'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first image shows a cow on a beach, while the second image shows a street scene with a'\n+                    'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first set of images shows a cow on a beach, while the second set shows a street scene'\n                     ],\n                 (\"rocm\", (9, 5)) : [\n                     'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There are clouds in the blue sky above.',\n@@ -718,15 +723,15 @@ def test_model_4b_multiimage(self):\n             add_generation_prompt=True,\n         ).to(torch_device)\n \n-        output = model.generate(**inputs, max_new_tokens=30, do_sample=False, cache_implementation=\"static\")\n+        output = model.generate(**inputs, max_new_tokens=30, do_sample=False)\n         output_text = self.processor.batch_decode(output, skip_special_tokens=True)\n         EXPECTED_TEXTS = Expectations(\n             {\n                 (\"xpu\", 3): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Overall Scene:**\\n\\nIt looks like a street scene in a city with\"],\n                 (\"cuda\", (8, 0)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Overall Scene:**\\n\\nIt looks like a street scene in a vibrant,\"],\n                 (\"cuda\", (8, 6)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Overall Scene:**\\n\\nIt appears to be a street scene in a city\"],\n                 (\"cuda\", (9, 0)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image!\\n\\nHere's a description of the scene:\\n\\n*   **Location:**\"],\n-                (\"rocm\", (9, 4)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Overall Scene:**\\n\\nIt appears to be a street scene in a vibrant\"],\n+                (\"rocm\", (9, 4)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Main Features:**\\n\\n*   **Chinese Archway:** The most prominent\"],\n                 (\"rocm\", (9, 5)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Main Features:**\\n\\n*   **Chinese Archway:** The most prominent\"],\n             }\n         )  # fmt: skip\n@@ -749,7 +754,7 @@ def test_model_1b_text_only(self):\n                 (\"xpu\", 3): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a river deep,\\nWith patterns hidden, secrets sleep.\\nA neural net, a watchful eye,\\nLearning'],\n                 (\"cuda\", 7): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n                 (\"cuda\", 8): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n-                (\"rocm\", (9, 4)): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n+                (\"rocm\", (9, 4)): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data streams, a boundless flow,\\nA silent world, where patterns grow.'],\n                 (\"rocm\", (9, 5)): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a river deep,\\nWith patterns hidden, secrets sleep.\\nA neural net, a watchful eye,\\nLearning'],\n             }\n         )  # fmt: skip\n@@ -783,7 +788,7 @@ def test_model_4b_flash_attn(self):\n                 (\"xpu\", 3): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant island in the background. It looks like a sunny day'],\n                 (\"cuda\", 7): [],\n                 (\"cuda\", 8): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant island in the background. It looks like a sunny day'],\n-                (\"rocm\", (9, 4)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant island in the background. It looks like a sunny day'],\n+                (\"rocm\", (9, 4)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach next to a turquoise ocean. There are some clouds in the blue'],\n                 (\"rocm\", (9, 5)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown and white cow standing on a sandy beach with a turquoise ocean and a distant island in the background. It looks like a sunny'],\n             }\n         )  # fmt: skip"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 11,
        "deletions": 6
    }
}