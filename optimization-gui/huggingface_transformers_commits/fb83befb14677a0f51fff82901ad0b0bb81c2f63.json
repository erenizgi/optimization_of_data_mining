{
    "author": "qubvel",
    "message": "Fix pytorch integration tests for SAM (#36397)\n\nFix device in tests",
    "sha": "fb83befb14677a0f51fff82901ad0b0bb81c2f63",
    "files": [
        {
            "sha": "f6d3c4fe4b8fec24097d4d9c0d6cb1f2c76341d3",
            "filename": "tests/models/sam/test_modeling_sam.py",
            "status": "modified",
            "additions": 20,
            "deletions": 22,
            "changes": 42,
            "blob_url": "https://github.com/huggingface/transformers/blob/fb83befb14677a0f51fff82901ad0b0bb81c2f63/tests%2Fmodels%2Fsam%2Ftest_modeling_sam.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/fb83befb14677a0f51fff82901ad0b0bb81c2f63/tests%2Fmodels%2Fsam%2Ftest_modeling_sam.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fsam%2Ftest_modeling_sam.py?ref=fb83befb14677a0f51fff82901ad0b0bb81c2f63",
            "patch": "@@ -533,12 +533,10 @@ def test_inference_mask_generation_no_point(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n-        masks = outputs.pred_masks[0, 0, 0, 0, :3]\n+        scores = outputs.iou_scores.squeeze().cpu()\n+        masks = outputs.pred_masks[0, 0, 0, 0, :3].cpu()\n         torch.testing.assert_close(scores[-1], torch.tensor(0.4515), rtol=2e-4, atol=2e-4)\n-        torch.testing.assert_close(\n-            masks, torch.tensor([-4.1800, -3.4948, -3.4481]).to(torch_device), rtol=2e-4, atol=2e-4\n-        )\n+        torch.testing.assert_close(masks, torch.tensor([-4.1800, -3.4948, -3.4481]), rtol=2e-4, atol=2e-4)\n \n     def test_inference_mask_generation_one_point_one_bb(self):\n         model = SamModel.from_pretrained(\"facebook/sam-vit-base\")\n@@ -557,12 +555,10 @@ def test_inference_mask_generation_one_point_one_bb(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n-        masks = outputs.pred_masks[0, 0, 0, 0, :3]\n+        scores = outputs.iou_scores.squeeze().cpu()\n+        masks = outputs.pred_masks[0, 0, 0, 0, :3].cpu()\n         torch.testing.assert_close(scores[-1], torch.tensor(0.9566), rtol=2e-4, atol=2e-4)\n-        torch.testing.assert_close(\n-            masks, torch.tensor([-12.7729, -12.3665, -12.6061]).to(torch_device), rtol=2e-4, atol=2e-4\n-        )\n+        torch.testing.assert_close(masks, torch.tensor([-12.7729, -12.3665, -12.6061]), rtol=2e-4, atol=2e-4)\n \n     def test_inference_mask_generation_batched_points_batched_images(self):\n         model = SamModel.from_pretrained(\"facebook/sam-vit-base\")\n@@ -628,7 +624,7 @@ def test_inference_mask_generation_one_point_one_bb_zero(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n \n         torch.testing.assert_close(scores[-1], torch.tensor(0.7894), rtol=1e-4, atol=1e-4)\n \n@@ -650,7 +646,7 @@ def test_inference_mask_generation_one_point(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n         torch.testing.assert_close(scores[-1], torch.tensor(0.9675), rtol=1e-4, atol=1e-4)\n \n         # With no label\n@@ -660,7 +656,7 @@ def test_inference_mask_generation_one_point(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n         torch.testing.assert_close(scores[-1], torch.tensor(0.9675), rtol=1e-4, atol=1e-4)\n \n     def test_inference_mask_generation_two_points(self):\n@@ -681,15 +677,15 @@ def test_inference_mask_generation_two_points(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n         torch.testing.assert_close(scores[-1], torch.tensor(0.9762), rtol=1e-4, atol=1e-4)\n \n         # no labels\n         inputs = processor(images=raw_image, input_points=input_points, return_tensors=\"pt\").to(torch_device)\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n \n         torch.testing.assert_close(scores[-1], torch.tensor(0.9762), rtol=1e-4, atol=1e-4)\n \n@@ -711,7 +707,7 @@ def test_inference_mask_generation_two_points_batched(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n         torch.testing.assert_close(scores[0][-1], torch.tensor(0.9762), rtol=1e-4, atol=1e-4)\n         torch.testing.assert_close(scores[1][-1], torch.tensor(0.9637), rtol=1e-4, atol=1e-4)\n \n@@ -730,7 +726,7 @@ def test_inference_mask_generation_one_box(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores = outputs.iou_scores.squeeze()\n+        scores = outputs.iou_scores.squeeze().cpu()\n         torch.testing.assert_close(scores[-1], torch.tensor(0.7937), rtol=1e-4, atol=1e-4)\n \n     def test_inference_mask_generation_batched_image_one_point(self):\n@@ -751,15 +747,15 @@ def test_inference_mask_generation_batched_image_one_point(self):\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores_batched = outputs.iou_scores.squeeze()\n+        scores_batched = outputs.iou_scores.squeeze().cpu()\n \n         input_points = [[[220, 470]]]\n \n         inputs = processor(images=raw_dog_image, input_points=input_points, return_tensors=\"pt\").to(torch_device)\n \n         with torch.no_grad():\n             outputs = model(**inputs)\n-        scores_single = outputs.iou_scores.squeeze()\n+        scores_single = outputs.iou_scores.squeeze().cpu()\n         torch.testing.assert_close(scores_batched[1, :], scores_single, rtol=1e-4, atol=1e-4)\n \n     def test_inference_mask_generation_two_points_point_batch(self):\n@@ -797,9 +793,11 @@ def test_inference_mask_generation_three_boxes_point_batch(self):\n \n         # fmt: off\n         input_boxes = torch.Tensor([[[620, 900, 1000, 1255]], [[75, 275, 1725, 850]],  [[75, 275, 1725, 850]]]).cpu()\n-        EXPECTED_IOU = torch.tensor([[[0.9773, 0.9881, 0.9522],\n-         [0.5996, 0.7661, 0.7937],\n-         [0.5996, 0.7661, 0.7937]]])\n+        EXPECTED_IOU = torch.tensor([[\n+            [0.9773, 0.9881, 0.9522],\n+            [0.5996, 0.7661, 0.7937],\n+            [0.5996, 0.7661, 0.7937],\n+        ]])\n         # fmt: on\n         input_boxes = input_boxes.unsqueeze(0)\n "
        }
    ],
    "stats": {
        "total": 42,
        "additions": 20,
        "deletions": 22
    }
}