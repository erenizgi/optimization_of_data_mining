{
    "author": "ydshieh",
    "message": "improve `utils/check_bad_commit.py` (#41658)\n\n* robust\n\n* robust\n\n* robust\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "6344371a91e7aab4106a80f65ab6156180e35d29",
    "files": [
        {
            "sha": "da1cdbbe75fe6ff6111c978e1e7d271aa8875360",
            "filename": "utils/check_bad_commit.py",
            "status": "modified",
            "additions": 13,
            "deletions": 23,
            "changes": 36,
            "blob_url": "https://github.com/huggingface/transformers/blob/6344371a91e7aab4106a80f65ab6156180e35d29/utils%2Fcheck_bad_commit.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/6344371a91e7aab4106a80f65ab6156180e35d29/utils%2Fcheck_bad_commit.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_bad_commit.py?ref=6344371a91e7aab4106a80f65ab6156180e35d29",
            "patch": "@@ -45,23 +45,21 @@ def create_script(target_test):\n )\n print(result.stdout)\n \n-if f\"PASSED {target_test}\" in result.stdout:\n-    print(\"test passed\")\n-    exit(0)\n-elif len(result.stderr) > 0:\n+if f\"FAILED {target_test}\" in result.stdout:\n+    print(\"test failed\")\n+    exit(2)\n+elif result.returncode != 0:\n     if \"ERROR: file or directory not found: \" in result.stderr:\n         print(\"test file or directory not found in this commit\")\n         exit(0)\n     elif \"ERROR: not found: \" in result.stderr:\n         print(\"test not found in this commit\")\n         exit(0)\n     else:\n-        print(f\"pytest failed to run: {{result.stderr}}\")\n+        print(f\"pytest gets unknown error: {{result.stderr}}\")\n         exit(-1)\n-elif f\"FAILED {target_test}\" in result.stdout:\n-    print(\"test failed\")\n-    exit(2)\n \n+print(f\"pytest runs successfully.\")\n exit(0)\n \"\"\"\n \n@@ -103,22 +101,11 @@ def find_bad_commit(target_test, start_commit, end_commit):\n     )\n     print(result.stdout)\n \n+    # This happens if running the script gives exit code < 0  or other issues\n     if \"error: bisect run failed\" in result.stderr:\n-        index = result.stderr.find(\"error: bisect run failed\")\n-        bash_error = result.stderr[index:]\n-\n-        error_msg = f\"Error when running git bisect:\\nbash error: {bash_error}\"\n-\n-        pattern = \"pytest failed to run: .+\"\n-        pytest_errors = re.findall(pattern, result.stdout)\n-        if len(pytest_errors) > 0:\n-            pytest_error = pytest_errors[0]\n-            index = pytest_error.find(\"pytest failed to run: \")\n-            index += len(\"pytest failed to run: \")\n-            pytest_error = pytest_error[index:]\n-            error_msg += f\"pytest error: {pytest_error}\"\n-\n-        raise ValueError(error_msg)\n+        error_msg = f\"Error when running git bisect:\\nbash error: {result.stderr}\\nbash output:\\n{result.stdout}\\nset `bad_commit` to `None`.\"\n+        print(error_msg)\n+        return None\n \n     pattern = r\"(.+) is the first bad commit\"\n     commits = re.findall(pattern, result.stdout)\n@@ -135,6 +122,9 @@ def find_bad_commit(target_test, start_commit, end_commit):\n \n def get_commit_info(commit):\n     \"\"\"Get information for a commit via `api.github.com`.\"\"\"\n+    if commit is None:\n+        return {\"commit\": None, \"pr_number\": None, \"author\": None, \"merged_by\": None}\n+\n     pr_number = None\n     author = None\n     merged_author = None"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 13,
        "deletions": 23
    }
}