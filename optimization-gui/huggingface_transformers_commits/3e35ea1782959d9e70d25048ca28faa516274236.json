{
    "author": "ydshieh",
    "message": "Improve `test_initialization` (#38607)\n\n* fix flaky init tests\n\n* fix flaky init tests\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "3e35ea1782959d9e70d25048ca28faa516274236",
    "files": [
        {
            "sha": "bc62d56894e1e0e38523893ad1230a7013360373",
            "filename": "tests/test_modeling_common.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/3e35ea1782959d9e70d25048ca28faa516274236/tests%2Ftest_modeling_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/3e35ea1782959d9e70d25048ca28faa516274236/tests%2Ftest_modeling_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_modeling_common.py?ref=3e35ea1782959d9e70d25048ca28faa516274236",
            "patch": "@@ -716,8 +716,16 @@ def test_initialization(self):\n             model = model_class(config=configs_no_init)\n             for name, param in model.named_parameters():\n                 if param.requires_grad:\n+                    data = torch.flatten(param.data)\n+                    n_elements = torch.numel(data)\n+                    # skip 2.5% of elements on each side to avoid issues caused by `nn.init.trunc_normal_` described in\n+                    # https://github.com/huggingface/transformers/pull/27906#issuecomment-1846951332\n+                    n_elements_to_skip_on_each_side = int(n_elements * 0.025)\n+                    data_to_check = torch.sort(data).values\n+                    if n_elements_to_skip_on_each_side > 0:\n+                        data_to_check = data_to_check[n_elements_to_skip_on_each_side:-n_elements_to_skip_on_each_side]\n                     self.assertIn(\n-                        ((param.data.mean() * 1e9).round() / 1e9).item(),\n+                        ((data_to_check.mean() * 1e9).round() / 1e9).item(),\n                         [0.0, 1.0],\n                         msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                     )"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}