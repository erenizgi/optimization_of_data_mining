{
    "author": "HichTala",
    "message": "Fix check of unecessary packages (issue #37626) (#37825)\n\n* Fix check of unecessary packages (issue #37626)\n\n* Reformat using ruff\n\n* And a condition to avoind the risk of matching a random object in `import_utils`\n\n* Reformat",
    "sha": "aa6b79db4341a2f29db7ffc2a30fa084c5d951de",
    "files": [
        {
            "sha": "f5c7bb1c367d6805e5b1f4d73e389aa7fbeb9d8c",
            "filename": "src/transformers/dynamic_module_utils.py",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/huggingface/transformers/blob/aa6b79db4341a2f29db7ffc2a30fa084c5d951de/src%2Ftransformers%2Fdynamic_module_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/aa6b79db4341a2f29db7ffc2a30fa084c5d951de/src%2Ftransformers%2Fdynamic_module_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fdynamic_module_utils.py?ref=aa6b79db4341a2f29db7ffc2a30fa084c5d951de",
            "patch": "@@ -151,17 +151,24 @@ def get_imports(filename: Union[str, os.PathLike]) -> list[str]:\n         content = f.read()\n     imported_modules = set()\n \n+    import transformers.utils\n+\n     def recursive_look_for_imports(node):\n         if isinstance(node, ast.Try):\n-            return  #  Don't recurse into Try blocks and ignore imports in them\n+            return  # Don't recurse into Try blocks and ignore imports in them\n         elif isinstance(node, ast.If):\n             test = node.test\n             for condition_node in ast.walk(test):\n-                if isinstance(condition_node, ast.Call) and getattr(condition_node.func, \"id\", \"\").startswith(\n-                    \"is_flash_attn\"\n-                ):\n-                    # Don't recurse into \"if flash_attn_available()\" blocks and ignore imports in them\n-                    return\n+                if isinstance(condition_node, ast.Call):\n+                    check_function = getattr(condition_node.func, \"id\", \"\")\n+                    if (\n+                        check_function.endswith(\"available\")\n+                        and check_function.startswith(\"is_flash_attn\")\n+                        or hasattr(transformers.utils.import_utils, check_function)\n+                    ):\n+                        # Don't recurse into \"if flash_attn_available()\" or any \"if library_available\" blocks\n+                        # that appears in `transformers.utils.import_utils` and ignore imports in them\n+                        return\n         elif isinstance(node, ast.Import):\n             # Handle 'import x' statements\n             for alias in node.names:"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 13,
        "deletions": 6
    }
}