{
    "author": "ydshieh",
    "message": "Try to avoid/reduce some remaining CI job failures (#37202)\n\n* try\n\n* try\n\n* Update tests/pipelines/test_pipelines_video_classification.py\n\nCo-authored-by: Joao Gante <joaofranciscocardosogante@gmail.com>\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\nCo-authored-by: Joao Gante <joaofranciscocardosogante@gmail.com>",
    "sha": "adfc91cd468a815a5629977b5b39248cfe0dcc0b",
    "files": [
        {
            "sha": "9565aa631ee2d2b7db73d0849dce291b7a02a415",
            "filename": "tests/pipelines/test_pipelines_video_classification.py",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/huggingface/transformers/blob/adfc91cd468a815a5629977b5b39248cfe0dcc0b/tests%2Fpipelines%2Ftest_pipelines_video_classification.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adfc91cd468a815a5629977b5b39248cfe0dcc0b/tests%2Fpipelines%2Ftest_pipelines_video_classification.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fpipelines%2Ftest_pipelines_video_classification.py?ref=adfc91cd468a815a5629977b5b39248cfe0dcc0b",
            "patch": "@@ -19,6 +19,7 @@\n from transformers import MODEL_FOR_VIDEO_CLASSIFICATION_MAPPING, VideoMAEFeatureExtractor\n from transformers.pipelines import VideoClassificationPipeline, pipeline\n from transformers.testing_utils import (\n+    _run_pipeline_tests,\n     compare_pipeline_output_to_hub_spec,\n     is_pipeline_test,\n     nested_simplify,\n@@ -39,6 +40,11 @@\n class VideoClassificationPipelineTests(unittest.TestCase):\n     model_mapping = MODEL_FOR_VIDEO_CLASSIFICATION_MAPPING\n \n+    if _run_pipeline_tests:\n+        example_video_filepath = hf_hub_download(\n+            repo_id=\"nateraw/video-demo\", filename=\"archery.mp4\", repo_type=\"dataset\"\n+        )\n+\n     def get_test_pipeline(\n         self,\n         model,\n@@ -48,9 +54,6 @@ def get_test_pipeline(\n         processor=None,\n         torch_dtype=\"float32\",\n     ):\n-        example_video_filepath = hf_hub_download(\n-            repo_id=\"nateraw/video-demo\", filename=\"archery.mp4\", repo_type=\"dataset\"\n-        )\n         video_classifier = VideoClassificationPipeline(\n             model=model,\n             tokenizer=tokenizer,\n@@ -61,8 +64,9 @@ def get_test_pipeline(\n             top_k=2,\n         )\n         examples = [\n-            example_video_filepath,\n-            \"https://huggingface.co/datasets/nateraw/video-demo/resolve/main/archery.mp4\",\n+            self.example_video_filepath,\n+            # TODO: re-enable this once we have a stable hub solution for CI\n+            # \"https://huggingface.co/datasets/nateraw/video-demo/resolve/main/archery.mp4\",\n         ]\n         return video_classifier, examples\n "
        },
        {
            "sha": "f8d88b602b11eb9289fb3c901b0f55ad7022059d",
            "filename": "tests/utils/test_audio_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/adfc91cd468a815a5629977b5b39248cfe0dcc0b/tests%2Futils%2Ftest_audio_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adfc91cd468a815a5629977b5b39248cfe0dcc0b/tests%2Futils%2Ftest_audio_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_audio_utils.py?ref=adfc91cd468a815a5629977b5b39248cfe0dcc0b",
            "patch": "@@ -39,6 +39,9 @@\n \n \n class AudioUtilsFunctionTester(unittest.TestCase):\n+    # will be set in `def _load_datasamples`\n+    _dataset = None\n+\n     def test_hertz_to_mel(self):\n         self.assertEqual(hertz_to_mel(0.0), 0.0)\n         self.assertAlmostEqual(hertz_to_mel(100), 150.48910241)\n@@ -274,8 +277,9 @@ def test_window_function(self):\n     def _load_datasamples(self, num_samples):\n         from datasets import load_dataset\n \n-        ds = load_dataset(\"hf-internal-testing/librispeech_asr_dummy\", \"clean\", split=\"validation\")\n-        speech_samples = ds.sort(\"id\").select(range(num_samples))[:num_samples][\"audio\"]\n+        if self._dataset is None:\n+            self._dataset = load_dataset(\"hf-internal-testing/librispeech_asr_dummy\", \"clean\", split=\"validation\")\n+        speech_samples = self._dataset.sort(\"id\").select(range(num_samples))[:num_samples][\"audio\"]\n         return [x[\"array\"] for x in speech_samples]\n \n     def test_spectrogram_impulse(self):"
        },
        {
            "sha": "b7f2f06bebda3d2bfd8ddf2f5052227e6e4e966a",
            "filename": "utils/fetch_hub_objects_for_ci.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/adfc91cd468a815a5629977b5b39248cfe0dcc0b/utils%2Ffetch_hub_objects_for_ci.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adfc91cd468a815a5629977b5b39248cfe0dcc0b/utils%2Ffetch_hub_objects_for_ci.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ffetch_hub_objects_for_ci.py?ref=adfc91cd468a815a5629977b5b39248cfe0dcc0b",
            "patch": "@@ -1,3 +1,5 @@\n+from huggingface_hub import hf_hub_download\n+\n from transformers.testing_utils import _run_pipeline_tests\n \n \n@@ -7,3 +9,4 @@\n \n         _ = datasets.load_dataset(\"hf-internal-testing/librispeech_asr_dummy\", \"clean\", split=\"validation\")\n         _ = datasets.load_dataset(\"hf-internal-testing/fixtures_image_utils\", split=\"test\", revision=\"refs/pr/1\")\n+        _ = hf_hub_download(repo_id=\"nateraw/video-demo\", filename=\"archery.mp4\", repo_type=\"dataset\")"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 18,
        "deletions": 7
    }
}