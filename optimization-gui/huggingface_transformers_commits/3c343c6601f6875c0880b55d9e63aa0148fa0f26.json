{
    "author": "ivarflakstad",
    "message": "[Whisper] Add rocm expected results to certain tests (#40482)\n\n* Add rocm expected results to certain tests\n\n* Specify rocm version in expectations so we know origin. Improved var names\n\n* Update test var names",
    "sha": "3c343c6601f6875c0880b55d9e63aa0148fa0f26",
    "files": [
        {
            "sha": "75dc54385dddc9c0a42631b4445eade85d4dcdb6",
            "filename": "tests/models/whisper/test_modeling_whisper.py",
            "status": "modified",
            "additions": 87,
            "deletions": 11,
            "changes": 98,
            "blob_url": "https://github.com/huggingface/transformers/blob/3c343c6601f6875c0880b55d9e63aa0148fa0f26/tests%2Fmodels%2Fwhisper%2Ftest_modeling_whisper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/3c343c6601f6875c0880b55d9e63aa0148fa0f26/tests%2Fmodels%2Fwhisper%2Ftest_modeling_whisper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fwhisper%2Ftest_modeling_whisper.py?ref=3c343c6601f6875c0880b55d9e63aa0148fa0f26",
            "patch": "@@ -29,6 +29,7 @@\n \n from transformers import WhisperConfig\n from transformers.testing_utils import (\n+    Expectations,\n     is_flaky,\n     require_flash_attn,\n     require_read_token,\n@@ -1950,8 +1951,8 @@ def test_small_longform_timestamps_generation(self):\n \n         input_features = input_features.to(torch_device)\n         generated_ids = model.generate(input_features, return_timestamps=True, return_segments=True)\n-\n-        EXPECTED_TRANSCRIPT = [\n+        # fmt: off\n+        EXPECTED_CUDA = [\n             {\n                 \"text\": \" Mr. Quilter is the apostle of the middle classes, and we are glad to welcome his gospel.\",\n                 \"timestamp\": (0.0, 6.38),\n@@ -2001,9 +2002,64 @@ def test_small_longform_timestamps_generation(self):\n                 \"timestamp\": (77.16, 78.16),\n             },\n         ]\n+        EXPECTED_ROCM = [\n+            {\n+                \"text\": \" Mr. Quilter is the apostle of the middle classes, and we are glad to welcome his gospel.\",\n+                \"timestamp\": (0.0, 6.38),\n+            },\n+            {\n+                \"text\": \" Nor is Mr. Quilter's manner less interesting than his matter.\",\n+                \"timestamp\": (6.38, 11.32),\n+            },\n+            {\n+                \"text\": \" He tells us that at this festive season of the year,\",\n+                \"timestamp\": (11.32, 15.0),\n+            },\n+            {\n+                \"text\": \" With Christmas and roast beef looming before us, similes drawn from eating and its results\",\n+                \"timestamp\": (30.0, 36.76),\n+            },\n+            {\n+                \"text\": \" occur most readily to the mind.\",\n+                \"timestamp\": (36.76, 39.8),\n+            },\n+            {\n+                \"text\": \" He has grave doubts whether Sir Frederick Layton's work is really Greek after all and\",\n+                \"timestamp\": (39.8, 45.38),\n+            },\n+            {\n+                \"text\": \" can discover in it but little of rocky Ithaca.\",\n+                \"timestamp\": (45.38, 49.0),\n+            },\n+            {\n+                \"text\": \" Lenell's pictures are a sort of up-guards-and-atom paintings, and Mason's exquisite ittles\",\n+                \"timestamp\": (49.0, 56.28),\n+            },\n+            {\n+                \"text\": \" are as national as a jingo poem. Mr. Burkett fosters landscape's smile at one much in\",\n+                \"timestamp\": (56.28, 64.12),\n+            },\n+            {\n+                \"text\": \" the same way that Mr. Karker used to flash his teeth. And Mr. John Collier gives his\",\n+                \"timestamp\": (64.12, 70.76),\n+            },\n+            {\n+                \"text\": \" sitter a cheerful slap on the back before he says, like a shampoo or in a Turkish bath,\",\n+                \"timestamp\": (70.76, 77.16),\n+            },\n+            {\n+                \"text\": \" Next Man\",\n+                \"timestamp\": (77.16, 78.16),\n+            },\n+        ]\n+        # fmt: on\n+\n+        expected_output = Expectations(\n+            {(\"cuda\", None): EXPECTED_CUDA, (\"rocm\", (9, 4)): EXPECTED_ROCM}\n+        ).get_expectation()\n \n         transcript = processor.batch_decode(generated_ids[\"sequences\"], skip_special_tokens=True, output_offsets=True)\n-        self.assertEqual(transcript[0][\"offsets\"], EXPECTED_TRANSCRIPT)\n+        self.assertEqual(transcript[0][\"offsets\"], expected_output)\n \n         transcript_segments = [\n             {\n@@ -2012,7 +2068,7 @@ def test_small_longform_timestamps_generation(self):\n             }\n             for seg in generated_ids[\"segments\"][0]\n         ]\n-        self.assertEqual(transcript_segments, EXPECTED_TRANSCRIPT)\n+        self.assertEqual(transcript_segments, expected_output)\n \n     @slow\n     def test_large_timestamp_generation(self):\n@@ -2641,9 +2697,16 @@ def test_whisper_longform_single_batch_prev_cond(self):\n     @slow\n     def test_whisper_shortform_single_batch_prev_cond(self):\n         # fmt: off\n-        EXPECTED_TEXT = [\" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks. I lurched a consciousness in the back of an abandoned school bus and slap myself awake.\"]\n-        EXPECTED_TEXT1 = [\" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks. I lurched a consciousness in the back of an abandoned school bus and slap myself a wig.\"]\n+        cuda_expectation = [\" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks. I lurched a consciousness in the back of an abandoned school bus and slap myself awake.\"]\n+        cuda_expectation2 = [\" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks. I lurched a consciousness in the back of an abandoned school bus and slap myself a wig.\"]\n+        rocm_expectation = [\" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating, so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks, I lurched a consciousness in the back of an abandoned school bus and slap myself awake.\"]\n         # fmt: on\n+        expected_output = Expectations(\n+            {(\"cuda\", None): cuda_expectation, (\"rocm\", (9, 4)): rocm_expectation}\n+        ).get_expectation()\n+        expected_output2 = Expectations(\n+            {(\"cuda\", None): cuda_expectation2, (\"rocm\", (9, 4)): rocm_expectation}\n+        ).get_expectation()\n \n         processor = WhisperProcessor.from_pretrained(\"openai/whisper-tiny.en\")\n         model = WhisperForConditionalGeneration.from_pretrained(\"openai/whisper-tiny.en\")\n@@ -2669,7 +2732,7 @@ def test_whisper_shortform_single_batch_prev_cond(self):\n         torch.manual_seed(0)\n         result = model.generate(input_features, **gen_kwargs)\n         decoded = processor.batch_decode(result, skip_special_tokens=True)\n-        self.assertEqual(decoded, EXPECTED_TEXT)\n+        self.assertEqual(decoded, expected_output)\n \n         gen_kwargs = {\n             \"return_timestamps\": True,\n@@ -2683,8 +2746,7 @@ def test_whisper_shortform_single_batch_prev_cond(self):\n         torch.manual_seed(0)\n         result = model.generate(input_features, **gen_kwargs)\n         decoded = processor.batch_decode(result, skip_special_tokens=True)\n-\n-        self.assertEqual(decoded, EXPECTED_TEXT1)\n+        self.assertEqual(decoded, expected_output2)\n \n     @slow\n     def test_whisper_longform_single_batch_beam(self):\n@@ -2822,7 +2884,7 @@ def test_whisper_longform_multi_batch_prev_cond(self):\n     @slow\n     def test_whisper_longform_multi_batch_hard(self):\n         # fmt: off\n-        EXPECTED_TEXT = [\n+        EXPECTED_CUDA = [\n             \" Folks, if you watch the show, you know, I spent a lot of time right over there. Patiently and astutely scrutinizing the boxwood and mahogany chest set of the day's biggest stories developing the central headline pawns, definitely maneuvering an oso topical night to F6, fainting a classic Sicilian, nade door variation on the news, all the while seeing eight moves deep and patiently marshalling the latest press releases into a fisher's shows in Lip Nitsky attack that culminates in the elegant lethal slow-played, all-passant checkmate that is my nightly monologue. But sometimes, sometimes, folks, I. CHEERING AND APPLAUSE Sometimes I startle away, cubside down in the monkey bars of a condemned playground on a super fun site. Get all hept up on goofballs. Rummage that were discarded tag bag of defective toys. Yank out a fist bowl of disembodied doll limbs, toss them on a stained kid's place mat from a defunct dennies. set up a table inside a rusty cargo container down by the Wharf and challenged toothless drifters to the godless bughouse blitz of tournament that is my segment. Meanwhile.\",\n             \" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks. I lurched a consciousness in the back of an abandoned school and slap myself awake with a crusty floor mat. Before using a mouse-bitten timing belt to strap some old plywood to a couple of discarded oil drums, then by the light of a heathen moon, render a gas tank out of an empty big gulp, fill with white claw and denatured alcohol, then light a match and let her rip and the demented one man soapbox derby of news that is my segment. Me, Guadalupe! No!\",\n             \" Ladies and gentlemen, you know, I spent a lot of time right over there Raising the finest Holstein news cattle firmly yet tenderly milking the latest headlines from their jokes swollen teats Churning the daily stories into the decadent proven-style style triple cream breed that is my nightly monologue But sometimes sometimes folks I stagger home hungry after being released by the police and Root around in the neighbor's trash can for an old milk carton scrape out the blooming dairy residue into the remains of a wet cheese rod I won from a rat in a pre-donned street fight. Put it in a discarded paint can to leave it to ferment next to a trash fire then hunker down and hallucinate while eating the listeria laden demon custard of news that is my segment. You mean one of them.\",\n@@ -2832,8 +2894,22 @@ def test_whisper_longform_multi_batch_hard(self):\n             \" Folks, if you watch this show, you know I spend most of my time right over there carefully blending for you the day's Newsiest most topical flower eggs milk and butter and Stranding into a fine batter to make delicate and informative comedy pancakes Then I glaze them in the juice and zest of the most relevant midnight Valencia oranges and douse it all and a fine Dela main de voyage cognac Before prom baying and basting them tables. I deserve for you the James Beard award worthy crepe suzzette That is my nightly monologue, but sometimes just sometimes folks. I wake up in the baggage hold of Greyhound bus. It's being hoisted by the scrap yard claw toward the burn pit. Escape to a nearby abandoned price chopper where I scrounge for old bread scraps and busted open bags of starfruit candies and expired eggs. Chuck it all on a dirty hubcap and slap it over a tire fire before using the legs of a strain, pair of sweatpants and as oven mitts to extract and serve the demented transience poundcake of news that is my segment. Me, Guadalupe!\",\n             \" Folks, if you watched the show and I hope you do, I spent a lot of time right over there. Tiredlessly studying the lineage of the days most important thoroughbred stories and whole-stiner headlines, working with the best trainers, money can buy to rear their comedy offspring with a hand that is stern yet gentle into the triple crown winning equine specimen. That is my nightly monologue, but sometimes, sometimes, folks, I break into an unincorporated veterinary genetics lab and grab whatever test tubes I can find and then under a grow light I got from a discarded chia pet. I mixed the pilfered DNA of a horse and whatever was in a tube labeled Keith Colan extra. Slurrying the concoction with caffeine pills and a microwave red bull, I screamed, sang a prayer to Janice, initiator of human life and God of transformation as a half horse, half man, freak. Seizes to life before me and the hideous collection of loose animal parts and corrupted man tissue that is my segment. Meanwhile!\"\n         ]\n+        EXPECTED_ROCM = [\n+            \" Folks, if you watch the show, you know, I spent a lot of time right over there. Patiently and astutely scrutinizing the boxwood and mahogany chest set of the day's biggest stories developing the central headline pawns, definitely maneuvering an oso topical night to F6, fainting of classics, Sicilian, nade door variation on the news, all the while seeing eight moves deep and patiently marshalling the latest press releases into a fisher's shows in Lipnitsky attack that culminates in the elegant lethal slow-played It's an all-passant checkmate that is my nightly monologue, but sometimes sometimes folks, I... APPLAUSE Sometimes I... Startle away, cubside down in the monkey bars of a condemned playground on a super fun site. Get all hept up on goofballs, rummage that were discarded tag bag of defective toys. Yank out a fist bowl of disembodied doll limbs, toss them on a stained kid's place mat from a defunct denny's, set up a table inside a rusty cargo container down by the wharf and challenged toothless drifters to the godless, bug-house blitz of tournament that is my segment. Meanwhile!\",\n+            \" Folks, I spend a lot of time right over there, night after night after night, actually. Carefully selecting for you the day's noosiest, most aerodynamic headlines, stress testing, and those topical anti-lock breaks and power steering, painstakingly stitching, leather seating, so soft, it would make JD power and her associates blush to create the luxury sedan that is my nightly monologue. But sometimes, you sometimes, folks, I lurched a consciousness in the back of an abandoned school bus and slap myself awake with a crusty floor mat. Before using a mouse-bitten timing belt to strap some old plywood to a couple of discarded oil drums, then by the light of a heathen moon, render a gas tank out of an empty big gulp, fill with white claw and denatured alcohol, then light a match and let her rip and the demented one man soapboxed her be of news that is my segment. We need one!\",\n+            \" Ladies and gentlemen, you know, I spent a lot of time right over there Raising the finest Holstein news cattle firmly yet tenderly milking the latest headlines from their jokes swollen teats Churning the daily stories into the decadent proven-style style triple cream breed that is my nightly monologue But sometimes sometimes folks I stagger home hungry after being released by the police and Root around in the neighbor's trash can for an old milk carton scrape out the blooming dairy residue into the remains of a wet cheese rod I won from a rat in a pre-donned street fight. Put it in a discarded paint can to leave it to ferment next to a trash fire then hunker down and hallucinate while eating the listeria laden demon custard of news that is my segment. You mean one of them.\",\n+            \" Folks, if you watch this show, you know I spend most of my time right over there carefully sorting through the day's biggest stories and selecting only the most subtle and unblemished ostrich and crocodile news leather, which I then entrust to artisan graduates of the Ichol Gregoire Ferrandi, who carefully dye them in a palette of bright zesty shades and adorn them in the finest and most topical inlay work using hand tools and double magnifying glasses, then assemble them according to now classic and elegant geometry using our signature saddles stitching. In line it with bees, wax coated linen, finely attached a mallet hammer strap, pearl hardware, and close shed to create for you the one of a kind hoke couture, Erme's Birkin bag that is my monologue, but sometimes, sometimes folks, sometimes. Sometimes I wake up in the last car of an abandoned roller coaster at Coney Island where I'm I'm hiding from the triads. I have some engine lubricants out of a safe way bag and stagger down the shore to tear the sail off a beach schooner. Then I rip the coaxial cable out of an RV and elderly couple from Utah, Hank, and Mabel lovely folks. And use it to stitch the sail into a loose pouch like a rock sack. And I stow away in the back of a garbage truck to the junkyard where I pick through to the debris for only the broken toys that make me the saddest until I have loaded for you. The Hobo Fugitives bug out, bindle of news that is my segment. Me one!\",\n+            \" You know, folks, I spent a lot of time crafting for you a bespoke playlist of the day's biggest stories right over there. Meticulously selecting the most topical chakra affirming scented candles, and using Feng Shui to perfectly align the joke energy in the exclusive boutique yoga retreat that is my monologue. But sometimes just sometimes I go to the dumpster behind the waffle house at three in the morning, take off my shirt, cover myself, and used fry oil, wrap my hands with some double-duct tape by stole from the broken car window. Pound a six-pack of blueberry hard-seltzer and a sack of pills I stole from a parked ambulance. Then arm wrestle a raccoon in the back alley vision quest of news that is my segment. Meanwhile!\",\n+            \" You know, folks, I spend most of my time right over there. Mining the day's biggest, most important stories, collecting the finest, most topical iron or hand hammering it into joke panels. Then I craft sheets of bronze and blazing with patterns that tell an epic tale of conquest and glory. Then, using the Germanic tradition press black process, I place thin sheets of foil against the scenes and by hammering or otherwise applying pressure from the back, I project these scenes into a pair of cheat cards in a faceplate and finally using fluted strips of white alloyed molding, I divide the designs into framed panels and hold it all together using bronze rivets to create the beautiful and intimidating, Anglo-Saxon battle helm that is my nightly monologue. Sometimes, sometimes folks. Sometimes, just sometimes, I come into my sense as fully naked on the deck of a pirate-be-seag'd, melee container ship that picked me up floating on the detached door of a portapotty in the Indian Ocean. Then after a sun stroke-induced realization of the crew of this ship plans to sell me an exchange for a bag of oranges to fight off scurvy, I lead a mutiny using only a PVC pipe at a pool chain that accepting my new role as Captain and declaring myself king of the windarc seas. I grab a dirty mop bucket covered in barnacles and adorn it with the teeth of the vanquished to create the sopping wet pirate crown of news that is my segment. Meanwhile!\",\n+            \" Folks, if you watch this show, you know I spend most of my time right over there carefully blending for you the day's Newsiest most topical flower eggs milk and butter and Stranding into a fine batter to make delicate and informative comedy pancakes Then I glaze them in the juice and zest of the most relevant midnight Valencia oranges and douse it all and a fine Dela main de voyage cognac Before from bang and basting them tables. I deserve for you the James Beard award worthy crepe suzzette That is my nightly monologue, but sometimes just sometimes folks. I wake up in the baggage hold of Greyhound bus. It's being hoisted by the scrap yard claw toward the burn pit. Escape to a nearby abandoned price chopper where I scrounge for old bread scraps and busted open bags of starfruit candies and expired eggs. Chuck it all on a dirty hubcap and slap it over a tire fire before using the legs of a strain, pair of sweatpants and as oven mitts to extract and serve the demented transience poundcake of news that is my segment. Me, Guadalupe!\",\n+            \" Folks, if you watched the show and I hope you do, I spent a lot of time right over there. Tiredlessly studying the lineage of the days most important thoroughbred stories and wholesome or headlines, working with the best trainers, money can buy to rear their comedy offspring with a hand that is stern yet gentle into the triple crown winning equine specimen. That is my nightly monologue, but sometimes, sometimes, folks, I break into an unincorporated veterinary genetics lab, and grab whatever test tubes I can find, and then under a grow light I got from a discarded chia pet. I mixed the pilfer DNA of a horse and whatever was in a tube labeled Keith Colan extra. Slurrying the concoction with caffeine pills and a microwave red bull, I screamed, sing a prayer to Janice, initiator of human life and God of transformation as a half horse, half man, freak. Seasons to life before me and the hideous collection of loose animal parts and corrupted man tissue that is my segment. Meanwhile!\",\n+        ]\n         # fmt: on\n \n+        expected_output = Expectations(\n+            {(\"cuda\", None): EXPECTED_CUDA, (\"rocm\", (9, 4)): EXPECTED_ROCM}\n+        ).get_expectation()\n+\n         processor = WhisperProcessor.from_pretrained(\"openai/whisper-tiny.en\")\n         model = WhisperForConditionalGeneration.from_pretrained(\"openai/whisper-tiny.en\")\n         model = model.to(torch_device)\n@@ -2877,7 +2953,7 @@ def test_whisper_longform_multi_batch_hard(self):\n         decoded_all = processor.batch_decode(result, skip_special_tokens=True)\n \n         self.assertListEqual(decoded_all, decoded_single)\n-        self.assertListEqual(decoded_all, EXPECTED_TEXT)\n+        self.assertListEqual(decoded_all, expected_output)\n \n     @slow\n     def test_whisper_longform_multi_batch_hard_prev_cond(self):"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 87,
        "deletions": 11
    }
}