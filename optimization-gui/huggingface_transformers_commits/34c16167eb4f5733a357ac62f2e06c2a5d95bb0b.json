{
    "author": "ydshieh",
    "message": "Don't send new comment if the previous one is less than 30 minutes (unless the content is changed) (#39170)\n\nfix\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "34c16167eb4f5733a357ac62f2e06c2a5d95bb0b",
    "files": [
        {
            "sha": "4b93dcd8293e6099fbef764a6495d733bae1f1af",
            "filename": ".github/workflows/pr_run_slow_ci.yml",
            "status": "modified",
            "additions": 51,
            "deletions": 15,
            "changes": 66,
            "blob_url": "https://github.com/huggingface/transformers/blob/34c16167eb4f5733a357ac62f2e06c2a5d95bb0b/.github%2Fworkflows%2Fpr_run_slow_ci.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/34c16167eb4f5733a357ac62f2e06c2a5d95bb0b/.github%2Fworkflows%2Fpr_run_slow_ci.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fpr_run_slow_ci.yml?ref=34c16167eb4f5733a357ac62f2e06c2a5d95bb0b",
            "patch": "@@ -112,21 +112,26 @@ jobs:\n           echo \"jobs_to_run=$(tail -n 1 output.txt)\" >> $GITHUB_OUTPUT\n \n   send_comment:\n+    # Will delete the previous comment and send a new one if:\n+    #   - either the content is changed\n+    #   - or the previous comment is 30 minutes or more old\n     name: Send a comment to suggest jobs to run\n     if: ${{ needs.get-jobs.outputs.jobs != '' }}\n     needs: [get-pr-number, get-jobs]\n     permissions:\n       pull-requests: write\n     runs-on: ubuntu-22.04\n     steps:\n-      - name: Delete existing comment and send new one\n+      - name: Check and update comment if needed\n         uses: actions/github-script@v7\n         env:\n           BODY: \"\\n\\nrun-slow: ${{ needs.get-jobs.outputs.jobs }}\"\n         with:\n           script: |\n             const prNumber = ${{ needs.get-pr-number.outputs.PR_NUMBER }};\n             const commentPrefix = \"**[For maintainers]** Suggested jobs to run (before merge)\";\n+            const thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000); // 30 minutes ago\n+            const newBody = `${commentPrefix}${process.env.BODY}`;\n             \n             // Get all comments on the PR\n             const { data: comments } = await github.rest.issues.listComments({\n@@ -135,29 +140,60 @@ jobs:\n               issue_number: prNumber\n             });\n             \n-            // Find existing comment(s) that start with our prefix\n+            // Find existing comments that start with our prefix\n             const existingComments = comments.filter(comment => \n               comment.user.login === 'github-actions[bot]' && \n               comment.body.startsWith(commentPrefix)\n             );\n             \n-            // Delete existing comment(s)\n-            for (const comment of existingComments) {\n-              console.log(`Deleting existing comment #${comment.id}`);\n+            let shouldCreateNewComment = true;\n+            let commentsToDelete = [];\n+            \n+            if (existingComments.length > 0) {\n+              // Get the most recent comment\n+              const mostRecentComment = existingComments\n+                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];\n+              \n+              const commentDate = new Date(mostRecentComment.created_at);\n+              const isOld = commentDate < thirtyMinutesAgo;\n+              const isDifferentContent = mostRecentComment.body !== newBody;\n+              \n+              console.log(`Most recent comment created: ${mostRecentComment.created_at}`);\n+              console.log(`Is older than 30 minutes: ${isOld}`);\n+              console.log(`Has different content: ${isDifferentContent}`);\n+              \n+              if (isOld || isDifferentContent) {\n+                // Delete all existing comments and create new one\n+                commentsToDelete = existingComments;\n+                console.log(`Will delete ${commentsToDelete.length} existing comment(s) and create new one`);\n+              } else {\n+                // Content is same and comment is recent, skip\n+                shouldCreateNewComment = false;\n+                console.log('Comment is recent and content unchanged, skipping update');\n+              }\n+            } else {\n+              console.log('No existing comments found, will create new one');\n+            }\n+            \n+            // Delete old comments if needed\n+            for (const comment of commentsToDelete) {\n+              console.log(`Deleting comment #${comment.id} (created: ${comment.created_at})`);\n               await github.rest.issues.deleteComment({\n                 owner: context.repo.owner,\n                 repo: context.repo.repo,\n                 comment_id: comment.id\n               });\n             }\n             \n-            // Create new comment\n-            const newBody = `${commentPrefix}${process.env.BODY}`;\n-            await github.rest.issues.createComment({\n-              owner: context.repo.owner,\n-              repo: context.repo.repo,\n-              issue_number: prNumber,\n-              body: newBody\n-            });\n-            \n-            console.log('✅ Comment updated successfully');\n\\ No newline at end of file\n+            // Create new comment if needed\n+            if (shouldCreateNewComment) {\n+              await github.rest.issues.createComment({\n+                owner: context.repo.owner,\n+                repo: context.repo.repo,\n+                issue_number: prNumber,\n+                body: newBody\n+              });\n+              console.log('✅ New comment created');\n+            } else {\n+              console.log('ℹ️ No comment update needed');\n+            }\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 51,
        "deletions": 15
    }
}