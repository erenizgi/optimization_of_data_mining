{
    "author": "brs-pt",
    "message": "Update stateful_callbacks state before saving checkpoint (#32115)\n\n* update ExportableState callbacks state before saving trainer_state on save_checkpoint\r\n\r\n* run make fixup and fix format\r\n\r\n* manage multiple stateful callbacks of same class",
    "sha": "d1f39c484d8347aa7b3170ea250a1e8f3bdfdf31",
    "files": [
        {
            "sha": "5b34cf695783dd835957b1cf1d83e49d853dfcaf",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/d1f39c484d8347aa7b3170ea250a1e8f3bdfdf31/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/d1f39c484d8347aa7b3170ea250a1e8f3bdfdf31/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=d1f39c484d8347aa7b3170ea250a1e8f3bdfdf31",
            "patch": "@@ -2979,8 +2979,16 @@ def _save_checkpoint(self, model, trial, metrics=None):\n \n         # Save the Trainer state\n         if self.args.should_save:\n-            # Update the `TrainerControl` state to where we are currently\n-            self.state.stateful_callbacks[\"TrainerControl\"] = self.control.state()\n+            # Update `ExportableState` callbacks and `TrainerControl` state to where we are currently\n+            for cb in [\n+                cb for cb in self.callback_handler.callbacks + [self.control] if isinstance(cb, ExportableState)\n+            ]:\n+                cb_name = cb.__class__.__name__\n+                cb_state = cb.state()\n+                if isinstance(self.state.stateful_callbacks[cb_name], list):\n+                    self.state.stateful_callbacks[cb_name].append(cb_state)\n+                else:\n+                    self.state.stateful_callbacks[cb_name] = cb_state\n             self.state.save_to_json(os.path.join(output_dir, TRAINER_STATE_NAME))\n \n         if self.args.push_to_hub:"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 10,
        "deletions": 2
    }
}