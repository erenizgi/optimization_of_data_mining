{
    "author": "BenjaminBossan",
    "message": "FIX: Faulty PEFT tests (#37757)\n\nTwo PEFT tests are actually failing:\n\ntests/peft_integration/test_peft_integration.py::PeftIntegrationTester::test_delete_adapter\ntests/peft_integration/test_peft_integration.py::PeftIntegrationTester::test_peft_pipeline_no_warning\n\nThis must have been going on for some time but was apparently never\nnoticed. The cause is that the tests themselves are faulty, the PEFT\nintegration is correct in these cases.\n\ntest_delete_adapter\n\nThe first faulty test was introduced by #34650. AFAICT, it should never\nhave passed in the first place, the PEFT integration logic was not\nchanged in the meantime. At this point, the logs for the PR CI are gone,\nso I'm not sure if the test passed back then or not.\n\ntest_peft_pipeline_no_warning\n\nThis test was introduced in #36783 and should also never have passed, as\nthe self.assertNoLogs context manager only returns None, thus the assert\nshould never have worked (mea culpa for suggesting this code snippet).\nHere too, the CI logs are deleted by now, so I can't check if the test\nalready failed back then.",
    "sha": "1a9188a54e3c718064883ebfad4618c1a1c1985a",
    "files": [
        {
            "sha": "56156334e25930ca9c53b1cc9db9d2297b3df75f",
            "filename": "tests/peft_integration/test_peft_integration.py",
            "status": "modified",
            "additions": 10,
            "deletions": 15,
            "changes": 25,
            "blob_url": "https://github.com/huggingface/transformers/blob/1a9188a54e3c718064883ebfad4618c1a1c1985a/tests%2Fpeft_integration%2Ftest_peft_integration.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1a9188a54e3c718064883ebfad4618c1a1c1985a/tests%2Fpeft_integration%2Ftest_peft_integration.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fpeft_integration%2Ftest_peft_integration.py?ref=1a9188a54e3c718064883ebfad4618c1a1c1985a",
            "patch": "@@ -13,6 +13,7 @@\n # limitations under the License.\n import importlib\n import os\n+import re\n import tempfile\n import unittest\n \n@@ -385,7 +386,7 @@ def test_delete_adapter(self):\n \n                 # Delete remaining adapter\n                 model.delete_adapter(\"adapter_2\")\n-                self.assertNotIn(\"adapter_2\", model.peft_config)\n+                self.assertFalse(hasattr(model, \"peft_config\"))\n                 self.assertFalse(model._hf_peft_config_loaded)\n \n                 # Re-add adapters for edge case tests\n@@ -394,28 +395,28 @@ def test_delete_adapter(self):\n \n                 # Attempt to delete multiple adapters at once\n                 model.delete_adapter([\"adapter_1\", \"adapter_2\"])\n-                self.assertNotIn(\"adapter_1\", model.peft_config)\n-                self.assertNotIn(\"adapter_2\", model.peft_config)\n+                self.assertFalse(hasattr(model, \"peft_config\"))\n                 self.assertFalse(model._hf_peft_config_loaded)\n \n                 # Test edge cases\n+                msg = re.escape(\"No adapter loaded. Please load an adapter first.\")\n+                with self.assertRaisesRegex(ValueError, msg):\n+                    model.delete_adapter(\"nonexistent_adapter\")\n+\n+                model.add_adapter(peft_config_1, adapter_name=\"adapter_1\")\n+\n                 with self.assertRaisesRegex(ValueError, \"The following adapter\\\\(s\\\\) are not present\"):\n                     model.delete_adapter(\"nonexistent_adapter\")\n \n                 with self.assertRaisesRegex(ValueError, \"The following adapter\\\\(s\\\\) are not present\"):\n                     model.delete_adapter([\"adapter_1\", \"nonexistent_adapter\"])\n \n                 # Deleting with an empty list or None should not raise errors\n-                model.add_adapter(peft_config_1, adapter_name=\"adapter_1\")\n                 model.add_adapter(peft_config_2, adapter_name=\"adapter_2\")\n                 model.delete_adapter([])  # No-op\n                 self.assertIn(\"adapter_1\", model.peft_config)\n                 self.assertIn(\"adapter_2\", model.peft_config)\n \n-                model.delete_adapter(None)  # No-op\n-                self.assertIn(\"adapter_1\", model.peft_config)\n-                self.assertIn(\"adapter_2\", model.peft_config)\n-\n                 # Deleting duplicate adapter names in the list\n                 model.delete_adapter([\"adapter_1\", \"adapter_1\"])\n                 self.assertNotIn(\"adapter_1\", model.peft_config)\n@@ -832,7 +833,6 @@ def test_peft_pipeline_no_warning(self):\n \n         # Input text for testing\n         text = \"Who is a Elon Musk?\"\n-        expected_error_msg = \"The model 'PeftModel' is not supported for text-generation\"\n \n         model = AutoModelForCausalLM.from_pretrained(\n             BASE_PATH,\n@@ -849,7 +849,7 @@ def test_peft_pipeline_no_warning(self):\n         # Create pipeline with PEFT model while capturing log output\n         # Check that the warning message is not present in the logs\n         pipeline_logger = logging.get_logger(\"transformers.pipelines.base\")\n-        with self.assertNoLogs(pipeline_logger, logging.ERROR) as cl:\n+        with self.assertNoLogs(pipeline_logger, logging.ERROR):\n             lora_generator = pipeline(\n                 task=\"text-generation\",\n                 model=lora_model,\n@@ -859,8 +859,3 @@ def test_peft_pipeline_no_warning(self):\n \n             # Generate text to verify pipeline works\n             _ = lora_generator(text)\n-\n-        # Check that the warning message is not present in the logs\n-        self.assertNotIn(\n-            expected_error_msg, cl.out, f\"Error message '{expected_error_msg}' should not appear when using PeftModel\"\n-        )"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 10,
        "deletions": 15
    }
}