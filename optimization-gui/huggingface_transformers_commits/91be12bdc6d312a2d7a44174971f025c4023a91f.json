{
    "author": "ydshieh",
    "message": "Avoid `too many request` caused by `AutoModelTest::test_dynamic_saving_from_local_repo` (#40614)\n\n* fix\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "91be12bdc6d312a2d7a44174971f025c4023a91f",
    "files": [
        {
            "sha": "e0c12eab655e0b53e297412380a2c9014de7efa3",
            "filename": "tests/models/auto/test_modeling_auto.py",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/huggingface/transformers/blob/91be12bdc6d312a2d7a44174971f025c4023a91f/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/91be12bdc6d312a2d7a44174971f025c4023a91f/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fauto%2Ftest_modeling_auto.py?ref=91be12bdc6d312a2d7a44174971f025c4023a91f",
            "patch": "@@ -13,6 +13,9 @@\n # limitations under the License.\n \n import copy\n+import os\n+import os.path\n+import shutil\n import sys\n import tempfile\n import unittest\n@@ -39,6 +42,7 @@\n sys.path.append(str(Path(__file__).parent.parent.parent.parent / \"utils\"))\n \n from test_module.custom_configuration import CustomConfig  # noqa E402\n+from utils.fetch_hub_objects_for_ci import url_to_local_path\n \n \n if is_torch_available():\n@@ -556,7 +560,18 @@ def test_attr_not_existing(self):\n \n     def test_dynamic_saving_from_local_repo(self):\n         with tempfile.TemporaryDirectory() as tmp_dir, tempfile.TemporaryDirectory() as tmp_dir_out:\n-            _ = Repository(local_dir=tmp_dir, clone_from=\"hf-internal-testing/tiny-random-custom-architecture\")\n+            # `Repository` is deprecated and will be removed in `huggingface_hub v1.0`.\n+            # TODO: Remove this test when this comes.\n+            # Here is a ugly approach to avoid `too many requests`\n+            repo_id = url_to_local_path(\"hf-internal-testing/tiny-random-custom-architecture\")\n+            if os.path.isdir(repo_id):\n+                shutil.copytree(repo_id, tmp_dir, dirs_exist_ok=True)\n+            else:\n+                _ = Repository(\n+                    local_dir=tmp_dir,\n+                    clone_from=url_to_local_path(\"hf-internal-testing/tiny-random-custom-architecture\"),\n+                )\n+\n             model = AutoModelForCausalLM.from_pretrained(tmp_dir, trust_remote_code=True)\n             model.save_pretrained(tmp_dir_out)\n             _ = AutoModelForCausalLM.from_pretrained(tmp_dir_out, trust_remote_code=True)"
        },
        {
            "sha": "095d3d1ead8fa82bc45484212286493e83b2d69a",
            "filename": "utils/fetch_hub_objects_for_ci.py",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/huggingface/transformers/blob/91be12bdc6d312a2d7a44174971f025c4023a91f/utils%2Ffetch_hub_objects_for_ci.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/91be12bdc6d312a2d7a44174971f025c4023a91f/utils%2Ffetch_hub_objects_for_ci.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ffetch_hub_objects_for_ci.py?ref=91be12bdc6d312a2d7a44174971f025c4023a91f",
            "patch": "@@ -1,9 +1,9 @@\n import os\n \n import requests\n-from huggingface_hub import hf_hub_download\n+from huggingface_hub import Repository, hf_hub_download\n \n-from transformers.testing_utils import _run_pipeline_tests\n+from transformers.testing_utils import _run_pipeline_tests, _run_staging\n \n \n URLS_FOR_TESTING_DATA = [\n@@ -38,6 +38,17 @@ def url_to_local_path(url, return_url_if_not_found=True):\n         _ = datasets.load_dataset(\"hf-internal-testing/fixtures_image_utils\", split=\"test\", revision=\"refs/pr/1\")\n         _ = hf_hub_download(repo_id=\"nateraw/video-demo\", filename=\"archery.mp4\", repo_type=\"dataset\")\n \n+    # Need to specify the username on the endpoint `hub-ci`, otherwise we get\n+    # `fatal: could not read Username for 'https://hub-ci.huggingface.co': Success`\n+    # But this repo. is never used in a test decorated by `is_staging_test`.\n+    if not _run_staging:\n+        # Used in as `tests/models/auto/test_modeling_auto.py::AutoModelTest::test_dynamic_saving_from_local_repo --> _ = Repository( ... )`\n+        # TODO: Remove this and the above test when `huggingface_hub v1.0` comes (where `Repository` will be removed).\n+        _ = Repository(\n+            local_dir=\"tiny-random-custom-architecture\",\n+            clone_from=\"hf-internal-testing/tiny-random-custom-architecture\",\n+        )\n+\n     # Download files from URLs to local directory\n     for url in URLS_FOR_TESTING_DATA:\n         filename = url_to_local_path(url, return_url_if_not_found=False)"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 29,
        "deletions": 3
    }
}