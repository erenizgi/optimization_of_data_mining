{
    "author": "SunMarc",
    "message": "Decouple device_map='auto' and tp_plan='auto'  (#38942)\n\n* dissociate\n\n* better place\n\n* fix",
    "sha": "bff964c429a5bfc8ca85789f20f37d6bfb60b294",
    "files": [
        {
            "sha": "f7f34c75ea57217fdb2007ec659f21ab62256d93",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/bff964c429a5bfc8ca85789f20f37d6bfb60b294/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/bff964c429a5bfc8ca85789f20f37d6bfb60b294/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=bff964c429a5bfc8ca85789f20f37d6bfb60b294",
            "patch": "@@ -4431,10 +4431,12 @@ def from_pretrained(\n                 \"`tp_plan` and `device_map` are mutually exclusive. Choose either one for parallelization.\"\n             )\n \n-        # If torchrun was used, make sure to TP by default. This way people don't need to change tp or device map\n-        if device_map == \"auto\" and tp_plan is None and int(os.environ.get(\"WORLD_SIZE\", 0)):\n-            tp_plan = \"auto\"  # device_map = \"auto\" in torchrun equivalent to TP plan = AUTO!\n-            device_map = None\n+        if device_map == \"auto\" and int(os.environ.get(\"WORLD_SIZE\", 0)):\n+            logger.info(\n+                \"You've set device_map=`auto` while triggering a distributed run with torchrun. This might lead to unexpected behavior. \"\n+                \"If your plan is to load the model on each device, you should set device_map={\"\n+                \": PartialState().process_index} where PartialState comes from accelerate library\"\n+            )\n \n         # We need to correctly dispatch the model on the current process device. The easiest way for this is to use a simple\n         # `device_map` pointing to the correct device"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 6,
        "deletions": 4
    }
}