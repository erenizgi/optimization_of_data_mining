{
    "author": "sywangyi",
    "message": "fix some case failures lead by \"`torch.compile` recompiled part of thâ€¦ (#41558)\n\n* fix some case failures lead by \"`torch.compile` recompiled part of the forward pass\" in xpu\n\nSigned-off-by: Wang, Yi A <yi.a.wang@intel.com>\n\n* update comment\n\nSigned-off-by: Wang, Yi A <yi.a.wang@intel.com>\n\n---------\n\nSigned-off-by: Wang, Yi A <yi.a.wang@intel.com>",
    "sha": "e89cef66252379cf19254d247ac9bb1bd2ab487f",
    "files": [
        {
            "sha": "d82146cab2f3fc8b817e506cf95cee631962962a",
            "filename": "src/transformers/masking_utils.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/e89cef66252379cf19254d247ac9bb1bd2ab487f/src%2Ftransformers%2Fmasking_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e89cef66252379cf19254d247ac9bb1bd2ab487f/src%2Ftransformers%2Fmasking_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmasking_utils.py?ref=e89cef66252379cf19254d247ac9bb1bd2ab487f",
            "patch": "@@ -839,7 +839,8 @@ def create_causal_mask(\n     # Do not allow skip if we are compiling (this is to match BC)\n     # TODO: cyril -> probably revisit and remove this, but a lot of tests rely on it\n     if _is_torch_xpu_available:\n-        allow_is_causal_skip = True\n+        # Do not allow skip if we are compiling for decoding, but for prefill, we still allow skip to optimization the perf of 1st token generation\n+        allow_is_causal_skip = not (getattr(past_key_values, \"is_compileable\", False) and cache_position.shape[0] == 1)\n     else:\n         allow_is_causal_skip = not getattr(past_key_values, \"is_compileable\", False)\n "
        }
    ],
    "stats": {
        "total": 3,
        "additions": 2,
        "deletions": 1
    }
}