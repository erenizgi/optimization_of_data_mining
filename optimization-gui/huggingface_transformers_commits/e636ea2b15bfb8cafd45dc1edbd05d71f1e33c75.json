{
    "author": "ArthurZucker",
    "message": "CircleCI failed test summary (#42240)\n\n* clean\n\n* final run\n\n* final run\n\n* final\n\n* final\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75",
    "files": [
        {
            "sha": "64e59dc154d7aa68d0d4af47a612e0e537aed2b7",
            "filename": ".github/workflows/circleci-failure-summary-comment.yml",
            "status": "added",
            "additions": 206,
            "deletions": 0,
            "changes": 206,
            "blob_url": "https://github.com/huggingface/transformers/blob/e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75/.github%2Fworkflows%2Fcircleci-failure-summary-comment.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75/.github%2Fworkflows%2Fcircleci-failure-summary-comment.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fcircleci-failure-summary-comment.yml?ref=e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75",
            "patch": "@@ -0,0 +1,206 @@\n+name: CircleCI Failure Summary Comment\n+\n+on:\n+  pull_request_target:\n+    types: [opened, synchronize, reopened]\n+\n+jobs:\n+  comment:\n+    runs-on: ubuntu-22.04\n+    permissions:\n+      pull-requests: write\n+    env:\n+      TARGET_BRANCH: ${{ github.event.pull_request.head.ref }}\n+      TARGET_SHA: ${{ github.event.pull_request.head.sha }}\n+      PR_NUMBER: ${{ github.event.pull_request.number }}\n+    steps:\n+      - name: Checkout repository\n+        uses: actions/checkout@v4\n+\n+      - name: Setup Python\n+        uses: actions/setup-python@v5\n+        with:\n+          python-version: \"3.13\"\n+\n+      - name: Install dependencies\n+        run: python -m pip install requests huggingface_hub\n+\n+      - name: Wait for CircleCI check suite completion\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}\n+          GITHUB_REPOSITORY: ${{ github.repository }}\n+        run: |\n+          # Exit on error, undefined variables, or pipe failures\n+          set -euo pipefail\n+          \n+          echo \"Waiting for CircleCI check suite to complete...\"\n+          # Timeout after 30 minutes (1800 seconds)\n+          end=$((SECONDS + 1800))\n+          \n+          while [ $SECONDS -lt $end ]; do\n+            # Query GitHub API for check suites associated with this commit\n+            # || echo \"\" allows retry on transient API failures instead of exiting\n+            suite_json=$(gh api \"repos/${GITHUB_REPOSITORY}/commits/${COMMIT_SHA}/check-suites\" \\\n+              --jq '.check_suites[] | select(.app.slug == \"circleci-checks\")' || echo \"\")\n+            \n+            if [ -z \"$suite_json\" ]; then\n+              echo \"CircleCI check suite not found yet, retrying...\"\n+            else\n+              status=$(echo \"$suite_json\" | jq -r '.status')\n+              conclusion=$(echo \"$suite_json\" | jq -r '.conclusion // empty')\n+              echo \"CircleCI status: $status, conclusion: $conclusion\"\n+              \n+              # Check suite is done when status is \"completed\" AND conclusion is set\n+              if [ \"$status\" = \"completed\" ] && [ -n \"$conclusion\" ]; then\n+                echo \"Check suite completed successfully\"\n+                exit 0\n+              fi\n+            fi\n+            \n+            # Poll every 20 seconds\n+            sleep 20\n+          done\n+    \n+          echo \"ERROR: Timed out waiting for CircleCI check suite\"\n+          exit 1\n+\n+      - name: Get CircleCI run's artifacts and upload them to Hub\n+        id: circleci\n+        env:\n+          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}\n+          REPO: ${{ github.repository }}\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        run: |\n+          # Step 1: Get CircleCI check suite ID\n+          echo \"Getting check suites for commit ${COMMIT_SHA}...\"\n+          check_suites=$(curl -s -H \"Authorization: token ${GITHUB_TOKEN}\" \\\n+            \"https://api.github.com/repos/${REPO}/commits/${COMMIT_SHA}/check-suites\")\n+          \n+          circleci_suite_id=$(echo \"$check_suites\" | jq -r '.check_suites[] | select(.app.slug == \"circleci-checks\") | .id' | head -n 1)\n+          echo \"CircleCI check suite ID: ${circleci_suite_id}\"\n+          \n+          # Step 2: Get check runs from the CircleCI suite\n+          echo \"Getting check runs for suite ${circleci_suite_id}...\"\n+          check_runs=$(curl -s -H \"Authorization: token ${GITHUB_TOKEN}\" \\\n+            \"https://api.github.com/repos/${REPO}/check-suites/${circleci_suite_id}/check-runs\")\n+          \n+          # Step 3: Extract workflow ID from the \"run_tests\" check run\n+          workflow_id=$(echo \"$check_runs\" | jq -r '.check_runs[] | select(.name == \"run_tests\") | .details_url' | grep -oP 'workflows/\\K[a-f0-9-]+')\n+          echo \"CircleCI Workflow ID: ${workflow_id}\"\n+          \n+          # Step 4: Get all jobs in the workflow\n+          echo \"Getting jobs for workflow ${workflow_id}...\"\n+          jobs=$(curl -s \\\n+            \"https://circleci.com/api/v2/workflow/${workflow_id}/job\")\n+          \n+          # Step 5: Extract collection_job details\n+          collection_job_number=$(echo \"$jobs\" | jq -r '.items[] | select(.name == \"collection_job\") | .job_number')\n+          collection_job_id=$(echo \"$jobs\" | jq -r '.items[] | select(.name == \"collection_job\") | .id')\n+          echo \"CircleCI Collection job number: ${collection_job_number}\"\n+          echo \"CircleCI Collection job ID: ${collection_job_id}\"\n+          \n+          # Step 6: Get artifacts list\n+          echo \"Getting artifacts for job ${collection_job_number}...\"\n+          artifacts=$(curl -s \\\n+            \"https://circleci.com/api/v2/project/gh/${REPO}/${collection_job_number}/artifacts\")\n+          \n+          echo \"$artifacts\" | jq '.'\n+          \n+          # Step 7: Download failure_summary.json specifically\n+          failure_summary_url=$(echo \"$artifacts\" | jq -r '.items[] | select(.path == \"outputs/failure_summary.json\") | .url')\n+          \n+          if [ -z \"$failure_summary_url\" ]; then\n+            echo \"failure_summary.json not found in artifacts\"\n+            exit 1\n+          fi\n+          \n+          echo \"Downloading failure_summary.json from: ${failure_summary_url}\"\n+          mkdir -p outputs\n+          curl -s -L \"${failure_summary_url}\" -o outputs/failure_summary.json\n+          ls -la outputs\n+          \n+          echo \"Downloaded failure_summary.json successfully\"\n+          \n+          # Verify the file was downloaded\n+          if [ -f outputs/failure_summary.json ]; then\n+            echo \"File size: $(wc -c < outputs/failure_summary.json) bytes\"\n+          else\n+            echo \"Failed to download failure_summary.json\"\n+            exit 1\n+          fi\n+          \n+          # Export variables for next steps\n+          echo \"workflow_id=${workflow_id}\" >> $GITHUB_OUTPUT\n+          echo \"collection_job_number=${collection_job_number}\" >> $GITHUB_OUTPUT\n+\n+      - name: Upload summaries to Hub\n+        env:\n+          HF_TOKEN: ${{ secrets.HF_CI_WRITE_TOKEN }}\n+          CIRCLECI_RESULTS_DATASET_ID: \"transformers-community/circleci-test-results\"\n+          PR_NUMBER: ${{ github.event.pull_request.number }}\n+          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}\n+        run: |\n+          python << 'EOF'\n+          import os\n+          from pathlib import Path\n+          from huggingface_hub import HfApi\n+          \n+          # Setup paths\n+          pr_number = os.environ[\"PR_NUMBER\"]\n+          commit_short = os.environ[\"COMMIT_SHA\"][:12]\n+          folder_path = f\"pr-{pr_number}/sha-{commit_short}\"\n+          \n+          # Create folder and move file\n+          Path(folder_path).mkdir(parents=True, exist_ok=True)\n+          Path(\"outputs/failure_summary.json\").rename(f\"{folder_path}/failure_summary.json\")\n+          \n+          # Upload to Hub\n+          dataset_id = os.environ[\"CIRCLECI_RESULTS_DATASET_ID\"]\n+          api = HfApi(token=os.environ[\"HF_TOKEN\"])\n+          api.upload_folder(\n+              commit_message=f\"Update CircleCI artifacts for PR {pr_number} ({commit_short})\",\n+              folder_path=folder_path,\n+              path_in_repo=folder_path,\n+              repo_id=dataset_id,\n+              repo_type=\"dataset\",\n+          )\n+          \n+          print(f\"Uploaded {folder_path} to {dataset_id}\")\n+          EOF\n+\n+      - name: Post comment with helper link\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          GITHUB_REPOSITORY: ${{ github.repository }}\n+          PR_NUMBER: ${{ github.event.pull_request.number }}\n+          PR_SHA: ${{ github.event.pull_request.head.sha }}\n+        run: |\n+          COMMIT_SHORT=\"${PR_SHA:0:12}\"\n+          SUMMARY_FILE=\"pr-${PR_NUMBER}/sha-${COMMIT_SHORT}/failure_summary.json\"\n+          \n+          if [ ! -f \"$SUMMARY_FILE\" ]; then\n+            echo \"failure_summary.json missing, skipping comment.\"\n+            exit 0\n+          fi\n+          \n+          failures=$(jq '.failures | length' \"$SUMMARY_FILE\")\n+          if [ \"$failures\" -eq 0 ]; then\n+            echo \"No failures detected, skipping PR comment.\"\n+            exit 0\n+          fi\n+          \n+          # Build Space URL with encoded parameters\n+          repo_enc=$(jq -rn --arg v \"$GITHUB_REPOSITORY\" '$v|@uri')\n+          pr_enc=$(jq -rn --arg v \"$PR_NUMBER\" '$v|@uri')\n+          sha_short=\"${PR_SHA:0:6}\"\n+          sha_enc=$(jq -rn --arg v \"$sha_short\" '$v|@uri')\n+          SPACE_URL=\"https://huggingface.co/spaces/transformers-community/circle-ci-viz?pr=${pr_enc}&sha=${sha_enc}\"\n+\n+          # Post comment (using printf for proper newlines)\n+          gh api \\\n+            --method POST \\\n+            -H \"Accept: application/vnd.github+json\" \\\n+            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n+            \"repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments\" \\\n+            -f body=\"$(printf \"View the CircleCI Test Summary for this PR:\\n\\n%s\" \"$SPACE_URL\")\"\n\\ No newline at end of file"
        },
        {
            "sha": "cc828de5a90592e344521bf0db083b7a4d043958",
            "filename": "utils/process_circleci_workflow_test_reports.py",
            "status": "modified",
            "additions": 85,
            "deletions": 24,
            "changes": 109,
            "blob_url": "https://github.com/huggingface/transformers/blob/e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75/utils%2Fprocess_circleci_workflow_test_reports.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75/utils%2Fprocess_circleci_workflow_test_reports.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fprocess_circleci_workflow_test_reports.py?ref=e636ea2b15bfb8cafd45dc1edbd05d71f1e33c75",
            "patch": "@@ -14,6 +14,8 @@\n import argparse\n import json\n import os\n+import re\n+from collections import Counter\n \n import requests\n \n@@ -22,64 +24,123 @@\n     parser = argparse.ArgumentParser()\n     parser.add_argument(\"--workflow_id\", type=str, required=True)\n     args = parser.parse_args()\n-    workflow_id = args.workflow_id\n \n     r = requests.get(\n-        f\"https://circleci.com/api/v2/workflow/{workflow_id}/job\",\n+        f\"https://circleci.com/api/v2/workflow/{args.workflow_id}/job\",\n         headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")},\n     )\n     jobs = r.json()[\"items\"]\n \n     os.makedirs(\"outputs\", exist_ok=True)\n-\n     workflow_summary = {}\n-    # for each job, download artifacts\n+    failure_entries = []\n+\n     for job in jobs:\n-        project_slug = job[\"project_slug\"]\n         if job[\"name\"].startswith((\"tests_\", \"examples_\", \"pipelines_\")):\n-            url = f\"https://circleci.com/api/v2/project/{project_slug}/{job['job_number']}/artifacts\"\n+            url = f\"https://circleci.com/api/v2/project/{job['project_slug']}/{job['job_number']}/artifacts\"\n             r = requests.get(url, headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")})\n             job_artifacts = r.json()[\"items\"]\n \n-            os.makedirs(job[\"name\"], exist_ok=True)\n             os.makedirs(f\"outputs/{job['name']}\", exist_ok=True)\n \n             job_test_summaries = {}\n+            job_failure_lines = {}\n+\n             for artifact in job_artifacts:\n-                if artifact[\"path\"].startswith(\"reports/\") and artifact[\"path\"].endswith(\"/summary_short.txt\"):\n-                    node_index = artifact[\"node_index\"]\n-                    url = artifact[\"url\"]\n+                url = artifact[\"url\"]\n+                if artifact[\"path\"].endswith(\"/summary_short.txt\"):\n+                    r = requests.get(url, headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")})\n+                    job_test_summaries[artifact[\"node_index\"]] = r.text\n+                elif artifact[\"path\"].endswith(\"/failures_line.txt\"):\n                     r = requests.get(url, headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")})\n-                    test_summary = r.text\n-                    job_test_summaries[node_index] = test_summary\n+                    job_failure_lines[artifact[\"node_index\"]] = r.text\n \n             summary = {}\n             for node_index, node_test_summary in job_test_summaries.items():\n                 for line in node_test_summary.splitlines():\n                     if line.startswith(\"PASSED \"):\n-                        test = line[len(\"PASSED \") :]\n-                        summary[test] = \"passed\"\n+                        summary[line[7:]] = \"passed\"\n                     elif line.startswith(\"FAILED \"):\n-                        test = line[len(\"FAILED \") :].split()[0]\n-                        summary[test] = \"failed\"\n-            # failed before passed\n+                        summary[line[7:].split()[0]] = \"failed\"\n+\n             summary = dict(sorted(summary.items(), key=lambda x: (x[1], x[0])))\n             workflow_summary[job[\"name\"]] = summary\n \n-            # collected version\n             with open(f\"outputs/{job['name']}/test_summary.json\", \"w\") as fp:\n                 json.dump(summary, fp, indent=4)\n \n+            # Collect failure details\n+            for node_index, summary_text in job_test_summaries.items():\n+                failure_lines_list = [\n+                    l.strip()\n+                    for l in job_failure_lines.get(node_index, \"\").splitlines()\n+                    if l.strip() and not l.strip().startswith((\"=\", \"_\", \"short test summary\")) and \": \" in l\n+                ]\n+\n+                failure_idx = 0\n+                for line in summary_text.splitlines():\n+                    if line.startswith(\"FAILED \") and \" - Failed: (subprocess)\" not in line:\n+                        test_name, _, short_error = line[7:].strip().partition(\" - \")\n+                        test_name = test_name.strip()\n+                        parts = test_name.split(\"::\", 1)[0].split(\"/\")\n+                        model_name = parts[2] if len(parts) >= 3 and test_name.startswith(\"tests/models/\") else None\n+                        full_error = (\n+                            failure_lines_list[failure_idx] if failure_idx < len(failure_lines_list) else short_error\n+                        )\n+\n+                        failure_entries.append(\n+                            {\n+                                \"job_name\": job[\"name\"],\n+                                \"test_name\": test_name,\n+                                \"short_error\": short_error,\n+                                \"error\": full_error,\n+                                \"model_name\": model_name,\n+                            }\n+                        )\n+                        failure_idx += 1\n+\n+    # Build workflow summary\n     new_workflow_summary = {}\n     for job_name, job_summary in workflow_summary.items():\n         for test, status in job_summary.items():\n-            if test not in new_workflow_summary:\n-                new_workflow_summary[test] = {}\n-            new_workflow_summary[test][job_name] = status\n+            new_workflow_summary.setdefault(test, {})[job_name] = status\n \n-    for test, result in new_workflow_summary.items():\n-        new_workflow_summary[test] = dict(sorted(result.items()))\n-    new_workflow_summary = dict(sorted(new_workflow_summary.items()))\n+    new_workflow_summary = {\n+        test: dict(sorted(result.items())) for test, result in sorted(new_workflow_summary.items())\n+    }\n \n     with open(\"outputs/test_summary.json\", \"w\") as fp:\n         json.dump(new_workflow_summary, fp, indent=4)\n+\n+    # Aggregate failures by test and model\n+    by_test, by_model = {}, {}\n+\n+    for entry in failure_entries:\n+        # Normalize test name\n+        normalized = entry[\"test_name\"].split(\"[\", 1)[0]\n+        parts = normalized.split(\"::\")\n+        normalized = \"::\".join(parts[:-1] + [re.sub(r\"_\\d{2,}.*$\", \"\", parts[-1])])\n+\n+        by_test.setdefault(normalized, {\"count\": 0, \"errors\": Counter(), \"jobs\": set(), \"variants\": set()})\n+        by_test[normalized][\"count\"] += 1\n+        by_test[normalized][\"errors\"][entry[\"error\"]] += 1\n+        by_test[normalized][\"jobs\"].add(entry[\"job_name\"])\n+        by_test[normalized][\"variants\"].add(entry[\"test_name\"])\n+\n+        if entry[\"model_name\"]:\n+            by_model.setdefault(entry[\"model_name\"], {\"count\": 0, \"errors\": Counter(), \"tests\": set()})\n+            by_model[entry[\"model_name\"]][\"count\"] += 1\n+            by_model[entry[\"model_name\"]][\"errors\"][entry[\"error\"]] += 1\n+            by_model[entry[\"model_name\"]][\"tests\"].add(entry[\"test_name\"])\n+\n+    # Convert Counter and sets to dicts/lists for JSON serialization\n+    for info in by_test.values():\n+        info[\"errors\"] = dict(info[\"errors\"].most_common())\n+        info[\"jobs\"] = sorted(info[\"jobs\"])\n+        info[\"variants\"] = sorted(info[\"variants\"])\n+    for info in by_model.values():\n+        info[\"errors\"] = dict(info[\"errors\"].most_common())\n+        info[\"tests\"] = sorted(info[\"tests\"])\n+\n+    with open(\"outputs/failure_summary.json\", \"w\") as fp:\n+        json.dump({\"failures\": failure_entries, \"by_test\": by_test, \"by_model\": by_model}, fp, indent=4)"
        }
    ],
    "stats": {
        "total": 315,
        "additions": 291,
        "deletions": 24
    }
}