{
    "author": "yonigozlan",
    "message": "Force new vision models addition to include a fast image processor (#40802)\n\n* add test\n\n* fix test and change cutoff date\n\n* Add documentation to test",
    "sha": "e691f84412563b6abca098f3e044980725d8daa3",
    "files": [
        {
            "sha": "6ac1b8e18d06c0f9b66d1af3acc7ad55ee16d98d",
            "filename": "tests/test_image_processing_common.py",
            "status": "modified",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/huggingface/transformers/blob/e691f84412563b6abca098f3e044980725d8daa3/tests%2Ftest_image_processing_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e691f84412563b6abca098f3e044980725d8daa3/tests%2Ftest_image_processing_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_image_processing_common.py?ref=e691f84412563b6abca098f3e044980725d8daa3",
            "patch": "@@ -16,11 +16,13 @@\n import json\n import os\n import pathlib\n+import subprocess\n import tempfile\n import time\n import unittest\n import warnings\n from copy import deepcopy\n+from datetime import datetime\n \n import httpx\n import numpy as np\n@@ -29,6 +31,7 @@\n \n from transformers import AutoImageProcessor, BatchFeature\n from transformers.image_utils import AnnotationFormat, AnnotionFormat\n+from transformers.models.auto.image_processing_auto import IMAGE_PROCESSOR_MAPPING_NAMES\n from transformers.testing_utils import (\n     check_json_file_has_correct_format,\n     require_torch,\n@@ -630,6 +633,66 @@ def test_can_compile_fast_image_processor(self):\n             output_eager.pixel_values, output_compiled.pixel_values, atol=1e-4, rtol=1e-4, mean_atol=1e-5\n         )\n \n+    def test_new_models_require_fast_image_processor(self):\n+        \"\"\"\n+        Test that new models have a fast image processor.\n+        For more information on how to implement a fast image processor, see this issue: https://github.com/huggingface/transformers/issues/36978,\n+        and ping @yonigozlan for help.\n+        \"\"\"\n+        if self.fast_image_processing_class is not None:\n+            return\n+        if self.image_processing_class is None:\n+            self.skipTest(\"No image processing class defined\")\n+\n+        def _is_old_model_by_commit_date(model_type, date_cutoff=(2025, 9, 1)):\n+            try:\n+                # Convert model_type to directory name and construct file path\n+                model_dir = model_type.replace(\"-\", \"_\")\n+                slow_processor_file = f\"src/transformers/models/{model_dir}/image_processing_{model_dir}.py\"\n+                # Check if the file exists otherwise skip the test\n+                if not os.path.exists(slow_processor_file):\n+                    return None\n+                # Get the first commit date of the slow processor file\n+                result = subprocess.run(\n+                    [\"git\", \"log\", \"--reverse\", \"--pretty=format:%ad\", \"--date=iso\", slow_processor_file],\n+                    capture_output=True,\n+                    text=True,\n+                    cwd=os.getcwd(),\n+                )\n+                if result.returncode != 0 or not result.stdout.strip():\n+                    return None\n+                # Parse the first line (earliest commit)\n+                first_line = result.stdout.strip().split(\"\\n\")[0]\n+                date_part = first_line.split(\" \")[0]  # Extract just the date part\n+                commit_date = datetime.strptime(date_part, \"%Y-%m-%d\")\n+                # Check if committed before the cutoff date\n+                cutoff_date = datetime(*date_cutoff)\n+                return commit_date <= cutoff_date\n+\n+            except Exception:\n+                # If any error occurs, skip the test\n+                return None\n+\n+        image_processor_name = self.image_processing_class.__name__\n+        model_type = None\n+        for mapping_model_type, (slow_class, _) in IMAGE_PROCESSOR_MAPPING_NAMES.items():\n+            if slow_class == image_processor_name:\n+                model_type = mapping_model_type\n+                break\n+\n+        if model_type is None:\n+            self.skipTest(f\"Could not find model type for {image_processor_name} in IMAGE_PROCESSOR_MAPPING_NAMES\")\n+        # Check if this is a new model (added after 2024-01-01) based on git history\n+        is_old_model = _is_old_model_by_commit_date(model_type)\n+        if is_old_model is None:\n+            self.skipTest(f\"Could not determine if {model_type} is new based on git history\")\n+        # New models must have fast processors\n+        self.assertTrue(\n+            is_old_model,\n+            f\"Model '{model_type}' (processor: {image_processor_name}) was added after the cutoff date and must have \"\n+            f\"a fast image processor implementation. Please implement the corresponding fast processor.\",\n+        )\n+\n \n class AnnotationFormatTestMixin:\n     # this mixin adds a test to assert that usages of the"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 63,
        "deletions": 0
    }
}