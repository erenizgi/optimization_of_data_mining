{
    "author": "remi-or",
    "message": "Expectations re-order and corrected FA3 skip (#39195)\n\n* Fix Expectations and a FA3 skip\n\n* Fixed docstring\n\n* Added context for Default expectation",
    "sha": "a325409a5051d68879030214e9c33180505f0d81",
    "files": [
        {
            "sha": "f9cc58879718f9129e8648ac1f2b92e132312609",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/huggingface/transformers/blob/a325409a5051d68879030214e9c33180505f0d81/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a325409a5051d68879030214e9c33180505f0d81/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=a325409a5051d68879030214e9c33180505f0d81",
            "patch": "@@ -3338,17 +3338,25 @@ def unpacked(self) -> list[tuple[DeviceProperties, Any]]:\n         return [(unpack_device_properties(k), v) for k, v in self.data.items()]\n \n     @staticmethod\n-    def is_default(properties: DeviceProperties) -> bool:\n-        return all(p is None for p in properties)\n+    def is_default(expectation_key: PackedDeviceProperties) -> bool:\n+        \"\"\"\n+        This function returns True if the expectation_key is the Default expectation (None, None).\n+        When an Expectation dict contains a Default value, it is generally because the test existed before Expectations.\n+        When we modify a test to use Expectations for a specific hardware, we don't want to affect the tests on other\n+        hardwares. Thus we set the previous value as the Default expectation with key (None, None) and add a value for\n+        the specific hardware with key (hardware_type, (major, minor)).\n+        \"\"\"\n+        return all(p is None for p in expectation_key)\n \n     @staticmethod\n     def score(properties: DeviceProperties, other: DeviceProperties) -> float:\n         \"\"\"\n         Returns score indicating how similar two instances of the `Properties` tuple are.\n         Rules are as follows:\n-            * Matching `type` adds one point, semi-matching `type` adds half a point (e.g. cuda and rocm).\n+            * Matching `type` adds one point, semi-matching `type` adds 0.1 point (e.g. cuda and rocm).\n             * If types match, matching `major` adds another point, and then matching `minor` adds another.\n-            * Default expectation (if present) is worth 0.1 point to distinguish it from a straight-up zero.\n+            * The Default expectation (None, None) is worth 0.5 point, which is better than semi-matching. More on this\n+            in the `is_default` function.\n         \"\"\"\n         device_type, major, minor = properties\n         other_device_type, other_major, other_minor = other\n@@ -3361,13 +3369,13 @@ def score(properties: DeviceProperties, other: DeviceProperties) -> float:\n                 score += 1\n                 if minor is not None and minor == other_minor:\n                     score += 1\n-        # Semi-matching device type\n+        # Semi-matching device type, which carries less importance than the default expectation\n         elif device_type in [\"cuda\", \"rocm\"] and other_device_type in [\"cuda\", \"rocm\"]:\n-            score = 0.5\n+            score = 0.1\n \n         # Default expectation\n         if Expectations.is_default(other):\n-            score = 0.1\n+            score = 0.5\n \n         return score\n "
        },
        {
            "sha": "e7bd7a1603f921ea69d6d992497dbbc5f409461a",
            "filename": "tests/test_modeling_common.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/a325409a5051d68879030214e9c33180505f0d81/tests%2Ftest_modeling_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a325409a5051d68879030214e9c33180505f0d81/tests%2Ftest_modeling_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_modeling_common.py?ref=a325409a5051d68879030214e9c33180505f0d81",
            "patch": "@@ -4306,7 +4306,7 @@ def flash_attn_from_config(self, attn_implementation: str):\n     def test_flash_attn_2_from_config(self):\n         self.flash_attn_from_config(attn_implementation=\"flash_attention_2\")\n \n-    @require_flash_attn\n+    @require_flash_attn_3\n     @require_torch_gpu\n     @mark.flash_attn_3_test\n     @slow"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 16,
        "deletions": 8
    }
}