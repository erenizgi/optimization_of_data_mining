{
    "author": "ParagEkbote",
    "message": "Update Model Card for Mamba (#37863)\n\n* update model card.\n\n* Apply suggestions from code review\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* update quantization example.\n\n* update example.\n\n* update\n\n---------\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>",
    "sha": "28d3148b079fa50b82f4888dfcc3cd3de953f956",
    "files": [
        {
            "sha": "12a6a01974a0a38af4d1e011d0283a1ddcb28185",
            "filename": "docs/source/en/model_doc/mamba.md",
            "status": "modified",
            "additions": 100,
            "deletions": 61,
            "changes": 161,
            "blob_url": "https://github.com/huggingface/transformers/blob/28d3148b079fa50b82f4888dfcc3cd3de953f956/docs%2Fsource%2Fen%2Fmodel_doc%2Fmamba.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/28d3148b079fa50b82f4888dfcc3cd3de953f956/docs%2Fsource%2Fen%2Fmodel_doc%2Fmamba.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmodel_doc%2Fmamba.md?ref=28d3148b079fa50b82f4888dfcc3cd3de953f956",
            "patch": "@@ -14,84 +14,123 @@ rendered properly in your Markdown viewer.\n \n -->\n \n-# Mamba\n-\n-<div class=\"flex flex-wrap space-x-1\">\n-<img alt=\"PyTorch\" src=\"https://img.shields.io/badge/PyTorch-DE3412?style=flat&logo=pytorch&logoColor=white\">\n+<div style=\"float: right;\">\n+  <div class=\"flex flex-wrap space-x-1\">\n+    <img alt=\"PyTorch\" src=\"https://img.shields.io/badge/PyTorch-DE3412?style=flat&logo=pytorch&logoColor=white\">\n+  </div>\n </div>\n \n-## Overview\n+# Mamba\n \n-The Mamba model was proposed in [Mamba: Linear-Time Sequence Modeling with Selective State Spaces](https://arxiv.org/abs/2312.00752) by Albert Gu and Tri Dao.\n+[Mamba](https://huggingface.co/papers/2312.00752) is a selective structured state space model (SSMs) designed to work around Transformers computational inefficiency when dealing with long sequences.  It is a completely attention-free architecture, and comprised of a combination of H3 and gated MLP blocks (Mamba block). Mamba's \"content-based reasoning\" allows it to focus on specific parts of an input depending on the current token. Mamba also uses a new hardware-aware parallel algorithm to compensate for the lack of convolutional operations. As a result, Mamba has fast inference and can scale to very long sequences.\n \n-This model is a new paradigm architecture based on `state-space-models`. You can read more about the intuition behind these [here](https://srush.github.io/annotated-s4/).\n+You can find all the original Mamba checkpoints under the [State Space Models](https://huggingface.co/state-spaces) organization.\n \n-The abstract from the paper is the following:\n \n-*Foundation models, now powering most of the exciting applications in deep learning, are almost universally based on the Transformer architecture and its core attention module. Many subquadratic-time architectures such as linear attention, gated convolution and recurrent models, and structured state space models (SSMs) have been developed to address Transformers' computational inefficiency on long sequences, but they have not performed as well as attention on important modalities such as language. We identify that a key weakness of such models is their inability to perform content-based reasoning, and make several improvements. First, simply letting the SSM parameters be functions of the input addresses their weakness with discrete modalities, allowing the model to selectively propagate or forget information along the sequence length dimension depending on the current token. Second, even though this change prevents the use of efficient convolutions, we design a hardware-aware parallel algorithm in recurrent mode. We integrate these selective SSMs into a simplified end-to-end neural network architecture without attention or even MLP blocks (Mamba). Mamba enjoys fast inference (5Ã— higher throughput than Transformers) and linear scaling in sequence length, and its performance improves on real data up to million-length sequences. As a general sequence model backbone, Mamba achieves state-of-the-art performance across several modalities such as language, audio, and genomics. On language modeling, our Mamba-3B model outperforms Transformers of the same size and matches Transformers twice its size, both in pretraining and downstream evaluation.*\n+> [!TIP]\n+> Click on the Mamba models in the right sidebar for more examples of how to apply Mamba to different language tasks.\n \n-Tips:\n+The example below demonstrates how to generate text with [`Pipeline`], [`AutoModel`], and from the command line.\n \n-- Mamba is a new `state space model` architecture that rivals the classic Transformers. It is based on the line of progress on structured state space models, with an efficient hardware-aware design and implementation in the spirit of [FlashAttention](https://github.com/Dao-AILab/flash-attention).\n-- Mamba stacks `mixer` layers, which are the equivalent of `Attention` layers. The core logic of `mamba` is held in the `MambaMixer` class.\n-- Two implementations cohabit: one is optimized and uses fast cuda kernels, while the other one is naive but can run on any device!\n-- The current implementation leverages the original cuda kernels: the equivalent of flash attention for Mamba are hosted in the [`mamba-ssm`](https://github.com/state-spaces/mamba) and the [`causal_conv1d`](https://github.com/Dao-AILab/causal-conv1d) repositories. Make sure to install them if your hardware supports them!\n-- Contributions to make the naive path faster are welcome ðŸ¤—\n+<hfoptions id=\"usage\">\n+<hfoption id=\"Pipeline\">\n+\n+```py\n+import torch\n+from transformers import pipeline\n \n-This model was contributed by [ArthurZ](https://huggingface.co/ArthurZ).\n-The original code can be found [here](https://github.com/state-spaces/mamba).\n+pipeline = pipeline(\n+    task=\"text-generation\",\n+    model=\"state-spaces/mamba-130m-hf\",\n+    torch_dtype=torch.float16,\n+    device=0\n+)\n+pipeline(\"Plants create energy through a process known as\")\n+```\n \n-# Usage\n+</hfoption>\n+<hfoption id=\"AutoModel\">\n \n-### A simple generation example:\n-```python\n-from transformers import MambaConfig, MambaForCausalLM, AutoTokenizer\n-import torch\n+```py\n+import torch  \n+from transformers import AutoModelForCausalLM, AutoTokenizer  \n \n tokenizer = AutoTokenizer.from_pretrained(\"state-spaces/mamba-130m-hf\")\n-model = MambaForCausalLM.from_pretrained(\"state-spaces/mamba-130m-hf\")\n-input_ids = tokenizer(\"Hey how are you doing?\", return_tensors= \"pt\")[\"input_ids\"]\n+model = AutoModelForCausalLM.from_pretrained(\"state-spaces/mamba-130m-hf\", torch_dtype=torch.float16, device_map=\"auto\",)  \n+input_ids = tokenizer(\"Plants create energy through a process known as\", return_tensors=\"pt\").to(\"cuda\")  \n \n-out = model.generate(input_ids, max_new_tokens=10)\n-print(tokenizer.batch_decode(out))\n+output = model.generate(**input_ids)  \n+print(tokenizer.decode(output[0], skip_special_tokens=True)\n ```\n \n-### Peft finetuning\n-The slow version is not very stable for training, and the fast one needs `float32`!\n-\n-```python\n-from datasets import load_dataset\n-from trl import SFTTrainer\n-from peft import LoraConfig\n-from transformers import AutoTokenizer, AutoModelForCausalLM, TrainingArguments\n-model_id = \"state-spaces/mamba-130m-hf\"\n-tokenizer = AutoTokenizer.from_pretrained(model_id)\n-model = AutoModelForCausalLM.from_pretrained(model_id)\n-dataset = load_dataset(\"Abirate/english_quotes\", split=\"train\")\n-training_args = TrainingArguments(\n-    output_dir=\"./results\",\n-    num_train_epochs=3,\n-    per_device_train_batch_size=4,\n-    logging_dir='./logs',\n-    logging_steps=10,\n-    learning_rate=2e-3\n-)\n-lora_config =  LoraConfig(\n-        r=8,\n-        target_modules=[\"x_proj\", \"embeddings\", \"in_proj\", \"out_proj\"],\n-        task_type=\"CAUSAL_LM\",\n-        bias=\"none\"\n-)\n-trainer = SFTTrainer(\n-    model=model,\n-    processing_class=tokenizer,\n-    args=training_args,\n-    peft_config=lora_config,\n-    train_dataset=dataset,\n-    dataset_text_field=\"quote\",\n-)\n-trainer.train()\n+</hfoption>\n+<hfoption id=\"transformers CLI\">\n+\n+```bash\n+echo -e \"Plants create energy through a process known as\" | transformers run --task text-generation --model state-spaces/mamba-130m-hf --device 0\n+```\n+\n+</hfoption>\n+</hfoptions>\n+\n+Quantization reduces the memory burden of large models by representing the weights in a lower precision. Refer to the [Quantization](../quantization/overview) overview for more available quantization backends.\n+\n+The example below uses [torchao](../quantization/torchao) to only quantize the weights to 4-bit integers.\n+\n+```py\n+import torch\n+from transformers import AutoModelForCausalLM, AutoTokenizer, TorchAoConfig\n+from torchao.quantization import Int4WeightOnlyConfig\n+\n+quantization_config = Int4WeightOnlyConfig(group_size=128)\n+quantization_config = TorchAoConfig(quant_type=quant_config)\n+tokenizer = AutoTokenizer.from_pretrained(\"state-spaces/mamba-2.8b-hf\")\n+model = AutoModelForCausalLM.from_pretrained(\"state-spaces/mamba-2.8b-hf\", torch_dtype=torch.bfloat16, quantization_config=quantization_config, device_map=\"auto\",)\n+input_ids = tokenizer(\"Plants create energy through a process known as\", return_tensors=\"pt\").to(\"cuda\")\n+\n+output = model.generate(**input_ids)\n+print(tokenizer.decode(output[0], skip_special_tokens=True))\n ```\n+## Notes\n+\n+- The current implementation uses the original CUDA kernels. The FlashAttention equivalent implementation is hosted in the [mamba-ssm](https://github.com/state-spaces/mamba) and [causal_conv1d](https://github.com/Dao-AILab/causal-conv1d) repositories. Make sure to install them if your hardware supports it!\n+- Mamba stacks `mixer` layers which are equivalent to `Attention` layers. You can find the main logic of Mamba in the `MambaMixer` class.\n+- The example below demonstrates how to fine-tune Mamba with [PEFT](https://huggingface.co/docs/peft).\n+\n+   ```py\n+   from datasets import load_dataset\n+   from trl import SFTTrainer\n+   from peft import LoraConfig\n+   from transformers import AutoTokenizer, AutoModelForCausalLM, TrainingArguments\n+   \n+   model_id = \"state-spaces/mamba-130m-hf\"\n+   tokenizer = AutoTokenizer.from_pretrained(model_id)\n+   model = AutoModelForCausalLM.from_pretrained(model_id)\n+   dataset = load_dataset(\"Abirate/english_quotes\", split=\"train\")\n+   training_args = TrainingArguments(\n+       output_dir=\"./results\",\n+       num_train_epochs=3,\n+       per_device_train_batch_size=4,\n+       logging_dir='./logs',\n+       logging_steps=10,\n+       learning_rate=2e-3\n+   )\n+   lora_config =  LoraConfig(\n+           r=8,\n+           target_modules=[\"x_proj\", \"embeddings\", \"in_proj\", \"out_proj\"],\n+           task_type=\"CAUSAL_LM\",\n+           bias=\"none\"\n+   )\n+   trainer = SFTTrainer(\n+       model=model,\n+       processing_class=tokenizer,\n+      args=training_args,\n+       peft_config=lora_config,\n+       train_dataset=dataset,\n+       dataset_text_field=\"quote\",\n+   )\n+   trainer.train()\n+   ```\n \n ## MambaConfig\n "
        }
    ],
    "stats": {
        "total": 161,
        "additions": 100,
        "deletions": 61
    }
}