{
    "author": "ydshieh",
    "message": "Final test data cache - inside CI docker images (#40689)\n\n* run\n\n* build\n\n* build\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
    "files": [
        {
            "sha": "aff69510d6361a35f4013ae873b4036b5802c536",
            "filename": ".circleci/create_circleci_config.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/.circleci%2Fcreate_circleci_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/.circleci%2Fcreate_circleci_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fcreate_circleci_config.py?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -177,7 +177,9 @@ def to_dict(self):\n                     \"command\": f\"TESTS=$(circleci tests split  --split-by=timings {self.job_name}_test_list.txt) && echo $TESTS > splitted_tests.txt && echo $TESTS | tr ' ' '\\n'\" if self.parallelism else f\"awk '{{printf \\\"%s \\\", $0}}' {self.job_name}_test_list.txt > splitted_tests.txt\"\n                     }\n             },\n-            {\"run\": {\"name\": \"fetch hub objects before pytest\", \"command\": \"python3 utils/fetch_hub_objects_for_ci.py\"}},\n+            # During the CircleCI docker images build time, we might already (or not) download the data.\n+            # If it's done already, the files are inside the directory `/test_data/`.\n+            {\"run\": {\"name\": \"fetch hub objects before pytest\", \"command\": \"cp -r /test_data/* . 2>/dev/null || true; python3 utils/fetch_hub_objects_for_ci.py\"}},\n             {\"run\": {\n                 \"name\": \"Run tests\",\n                 \"command\": f\"({timeout_cmd} python3 -m pytest {marker_cmd} -n {self.pytest_num_workers} {junit_flags} {repeat_on_failure_flags} {' '.join(pytest_flags)} $(cat splitted_tests.txt) | tee tests_output.txt)\"}"
        },
        {
            "sha": "00ab463f4b5a59af4e21b6eabefcc6981b97dea7",
            "filename": "docker/custom-tokenizers.dockerfile",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fcustom-tokenizers.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fcustom-tokenizers.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fcustom-tokenizers.dockerfile?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -2,7 +2,7 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git cmake wget xz-utils build-essential g++5 libprotobuf-dev protobuf-compiler git-lfs\n+RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git cmake wget xz-utils build-essential g++5 libprotobuf-dev protobuf-compiler git-lfs curl\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n \n@@ -15,12 +15,20 @@ RUN mv catch.hpp ../libs/\n RUN cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local\n RUN make install -j 10\n \n+WORKDIR /\n \n RUN uv pip install --no-cache --upgrade 'torch' --index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-cache-dir  --no-deps accelerate --extra-index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install  --no-cache-dir \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[ja,testing,sentencepiece,spacy,ftfy,rjieba]\" unidic unidic-lite\n # spacy is not used so not tested. Causes to failures. TODO fix later\n RUN uv run python -m unidic download\n+\n+# fetch test data and hub objects within CircleCI docker images to reduce even more connections\n+# we don't need a full clone of `transformers` to run `fetch_hub_objects_for_ci.py`\n+# the data are downloaded to the directory `/test_data` and during CircleCI's CI runtime, we need to move them to the root of `transformers`\n+RUN mkdir test_data && cd test_data && curl -O https://raw.githubusercontent.com/huggingface/transformers/${REF}/utils/fetch_hub_objects_for_ci.py && python3 fetch_hub_objects_for_ci.py\n+\n+\n RUN uv pip uninstall transformers\n \n RUN apt-get clean && rm -rf /var/lib/apt/lists/*"
        },
        {
            "sha": "4f8a694021b2cfd7f308c0382274f60d8294c1e7",
            "filename": "docker/examples-torch.dockerfile",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fexamples-torch.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fexamples-torch.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fexamples-torch.dockerfile?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -2,11 +2,18 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git-lfs ffmpeg\n+RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git-lfs ffmpeg curl\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' 'torchcodec' --index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-deps timm accelerate --extra-index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-cache-dir librosa \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[sklearn,sentencepiece,vision,testing]\" seqeval albumentations jiwer\n+\n+# fetch test data and hub objects within CircleCI docker images to reduce even more connections\n+# we don't need a full clone of `transformers` to run `fetch_hub_objects_for_ci.py`\n+# the data are downloaded to the directory `/test_data` and during CircleCI's CI runtime, we need to move them to the root of `transformers`\n+RUN mkdir test_data && cd test_data && curl -O https://raw.githubusercontent.com/huggingface/transformers/${REF}/utils/fetch_hub_objects_for_ci.py && python3 fetch_hub_objects_for_ci.py\n+\n+\n RUN uv pip uninstall transformers\n RUN apt-get clean && rm -rf /var/lib/apt/lists/*"
        },
        {
            "sha": "d603a57c4c068c03280e15bc687baed32bab908a",
            "filename": "docker/exotic-models.dockerfile",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fexotic-models.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fexotic-models.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fexotic-models.dockerfile?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -2,7 +2,7 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git libgl1 g++ tesseract-ocr git-lfs\n+RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git libgl1 g++ tesseract-ocr git-lfs curl\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' --index-url https://download.pytorch.org/whl/cpu\n@@ -13,5 +13,12 @@ RUN uv pip install  --no-cache-dir \"git+https://github.com/huggingface/transform\n # RUN git clone https://github.com/facebookresearch/detectron2.git\n # RUN python3 -m pip install --no-cache-dir -e detectron2\n RUN uv pip install 'git+https://github.com/facebookresearch/detectron2.git@92ae9f0b92aba5867824b4f12aa06a22a60a45d3' --no-build-isolation\n+\n+# fetch test data and hub objects within CircleCI docker images to reduce even more connections\n+# we don't need a full clone of `transformers` to run `fetch_hub_objects_for_ci.py`\n+# the data are downloaded to the directory `/test_data` and during CircleCI's CI runtime, we need to move them to the root of `transformers`\n+RUN mkdir test_data && cd test_data && curl -O https://raw.githubusercontent.com/huggingface/transformers/${REF}/utils/fetch_hub_objects_for_ci.py && python3 fetch_hub_objects_for_ci.py\n+\n+\n RUN uv pip uninstall transformers\n RUN apt-get clean && rm -rf /var/lib/apt/lists/*"
        },
        {
            "sha": "6759f156687f95e9c672cc0bf21cd73b74f2bed3",
            "filename": "docker/pipeline-torch.dockerfile",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fpipeline-torch.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Fpipeline-torch.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fpipeline-torch.dockerfile?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -2,10 +2,17 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git pkg-config openssh-client git ffmpeg\n+RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git pkg-config openssh-client git ffmpeg curl\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' 'torchcodec' --index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-deps timm accelerate --extra-index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-cache-dir librosa \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[sklearn,sentencepiece,vision,testing]\"\n+\n+# fetch test data and hub objects within CircleCI docker images to reduce even more connections\n+# we don't need a full clone of `transformers` to run `fetch_hub_objects_for_ci.py`\n+# the data are downloaded to the directory `/test_data` and during CircleCI's CI runtime, we need to move them to the root of `transformers`\n+RUN mkdir test_data && cd test_data && curl -O https://raw.githubusercontent.com/huggingface/transformers/${REF}/utils/fetch_hub_objects_for_ci.py && python3 fetch_hub_objects_for_ci.py\n+\n+\n RUN uv pip uninstall transformers"
        },
        {
            "sha": "d670b421be7f53ebab67e5da09e0207b12366df0",
            "filename": "docker/torch-light.dockerfile",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Ftorch-light.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/docker%2Ftorch-light.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftorch-light.dockerfile?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -2,10 +2,16 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git-lfs ffmpeg\n+RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git-lfs ffmpeg curl\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' 'torchcodec' --index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-deps timm accelerate --extra-index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-cache-dir librosa \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[sklearn,sentencepiece,vision,testing,tiktoken,num2words,video]\"\n+\n+# fetch test data and hub objects within CircleCI docker images to reduce even more connections\n+# we don't need a full clone of `transformers` to run `fetch_hub_objects_for_ci.py`\n+# the data are downloaded to the directory `/test_data` and during CircleCI's CI runtime, we need to move them to the root of `transformers`\n+RUN mkdir test_data && cd test_data && curl -O https://raw.githubusercontent.com/huggingface/transformers/${REF}/utils/fetch_hub_objects_for_ci.py && python3 fetch_hub_objects_for_ci.py\n+\n RUN uv pip uninstall transformers"
        },
        {
            "sha": "041b622333b2c3b3ebf2b73536d27ab01cc9d325",
            "filename": "tests/test_processing_common.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/tests%2Ftest_processing_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/tests%2Ftest_processing_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_processing_common.py?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -1212,9 +1212,11 @@ def test_apply_chat_template_video_frame_sampling(self):\n         messages[0][0][\"content\"][0] = {\n             \"type\": \"video\",\n             \"url\": [\n-                \"https://www.ilankelman.org/stopsigns/australia.jpg\",\n-                \"https://www.ilankelman.org/stopsigns/australia.jpg\",\n-            ],\n+                url_to_local_path(\n+                    \"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/australia.jpg\"\n+                )\n+            ]\n+            * 2,\n         }\n         out_dict_with_video = processor.apply_chat_template(\n             messages,"
        },
        {
            "sha": "54cf006fd3cadaf6d88fc452034ded0fcd67d481",
            "filename": "utils/fetch_hub_objects_for_ci.py",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/utils%2Ffetch_hub_objects_for_ci.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5b0c01b5e2bb826fcc0429c151185bf6375ecf3f/utils%2Ffetch_hub_objects_for_ci.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ffetch_hub_objects_for_ci.py?ref=5b0c01b5e2bb826fcc0429c151185bf6375ecf3f",
            "patch": "@@ -35,6 +35,7 @@\n     \"https://huggingface.co/datasets/hf-internal-testing/fixtures_videos/resolve/main/tennis.mp4\",\n     \"https://huggingface.co/datasets/raushan-testing-hf/videos-test/resolve/main/tiny_video.mp4\",\n     \"https://thumbs.dreamstime.com/b/golden-gate-bridge-san-francisco-purple-flowers-california-echium-candicans-36805947.jpg\",\n+    \"https://huggingface.co/datasets/raushan-testing-hf/videos-test/resolve/main/tiny_video.mp4\",\n ]\n \n \n@@ -59,12 +60,11 @@ def url_to_local_path(url, return_url_if_not_found=True):\n     # `fatal: could not read Username for 'https://hub-ci.huggingface.co': Success`\n     # But this repo. is never used in a test decorated by `is_staging_test`.\n     if not _run_staging:\n-        # Used in as `tests/models/auto/test_modeling_auto.py::AutoModelTest::test_dynamic_saving_from_local_repo --> _ = Repository( ... )`\n-        # TODO: Remove this and the above test when `huggingface_hub v1.0` comes (where `Repository` will be removed).\n-        _ = Repository(\n-            local_dir=\"tiny-random-custom-architecture\",\n-            clone_from=\"hf-internal-testing/tiny-random-custom-architecture\",\n-        )\n+        if not os.path.isdir(\"tiny-random-custom-architecture\"):\n+            _ = Repository(\n+                local_dir=\"tiny-random-custom-architecture\",\n+                clone_from=\"hf-internal-testing/tiny-random-custom-architecture\",\n+            )\n \n         # For `tests/test_tokenization_mistral_common.py:TestMistralCommonTokenizer`, which eventually calls\n         # `mistral_common.tokens.tokenizers.utils.download_tokenizer_from_hf_hub` which (probably) doesn't have the cache."
        }
    ],
    "stats": {
        "total": 69,
        "additions": 54,
        "deletions": 15
    }
}