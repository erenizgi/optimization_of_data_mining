{
    "author": "ydshieh",
    "message": "further reducing flakiness in `utils/check_bad_commit.py` (#41658)  (#41815)\n\n* 111\n\n* fix\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "c27efe6e65fb2dfe5cbbe00694908f471b06c8ae",
    "files": [
        {
            "sha": "124aeece0a4cc750b77ed50dfcdb5a4042b31563",
            "filename": "utils/check_bad_commit.py",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/huggingface/transformers/blob/c27efe6e65fb2dfe5cbbe00694908f471b06c8ae/utils%2Fcheck_bad_commit.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/c27efe6e65fb2dfe5cbbe00694908f471b06c8ae/utils%2Fcheck_bad_commit.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcheck_bad_commit.py?ref=c27efe6e65fb2dfe5cbbe00694908f471b06c8ae",
            "patch": "@@ -97,7 +97,17 @@ def is_bad_commit(target_test, commit):\n     # Restore to original commit\n     repo.git.checkout(original_head)\n \n-    return result.returncode != 0\n+    n_passed = 0\n+    o = re.findall(r\"====.* (\\d+) passed\", result.stdout)\n+    if len(o) > 0:\n+        n_passed = int(o[0])\n+\n+    n_failed = 0\n+    o = re.findall(r\"====.* (\\d+) failed\", result.stdout)\n+    if len(o) > 0:\n+        n_failed = int(o[0])\n+\n+    return result.returncode != 0, n_failed, n_passed\n \n \n def find_bad_commit(target_test, start_commit, end_commit):\n@@ -113,7 +123,8 @@ def find_bad_commit(target_test, start_commit, end_commit):\n     \"\"\"\n \n     # check if `end_commit` fails the test\n-    failed_before = is_bad_commit(target_test, end_commit)\n+    # (we only need one failure to conclude the test is flaky on the previous run with `end_commit`)\n+    failed_before, _, _ = is_bad_commit(target_test, end_commit)\n     if failed_before:\n         return (\n             None,\n@@ -130,8 +141,9 @@ def find_bad_commit(target_test, start_commit, end_commit):\n \n     # Now, we are (almost) sure `target_test` is not failing at `end_commit`\n     # check if `start_commit` fail the test\n-    failed_now = is_bad_commit(target_test, start_commit)\n-    if not failed_now:\n+    # **IMPORTANT** we only need one pass to conclude the test is flaky on the current run with `start_commit`!\n+    _, n_failed, n_passed = is_bad_commit(target_test, start_commit)\n+    if n_passed > 0:\n         # failed on CI run, but not reproducible here --> don't report\n         return None, f\"flaky: test fails on the current CI run (commit: {start_commit}) but passes during the check.\"\n \n@@ -194,12 +206,13 @@ def get_commit_info(commit):\n         if pr_for_commit[\"merged_by\"] is not None:\n             merged_author = pr_for_commit[\"merged_by\"][\"login\"]\n \n+    url = f\"https://api.github.com/repos/huggingface/transformers/commits/{commit}\"\n+    commit_info = requests.get(url).json()\n+    parent = commit_info[\"parents\"][0][\"sha\"]\n     if author is None:\n-        url = f\"https://api.github.com/repos/huggingface/transformers/commits/{commit}\"\n-        commit_info = requests.get(url).json()\n         author = commit_info[\"author\"][\"login\"]\n \n-    return {\"commit\": commit, \"pr_number\": pr_number, \"author\": author, \"merged_by\": merged_author}\n+    return {\"commit\": commit, \"pr_number\": pr_number, \"author\": author, \"merged_by\": merged_author, \"parent\": parent}\n \n \n if __name__ == \"__main__\":"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 20,
        "deletions": 7
    }
}