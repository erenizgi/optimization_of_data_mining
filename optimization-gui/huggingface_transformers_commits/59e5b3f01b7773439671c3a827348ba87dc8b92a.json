{
    "author": "qubvel",
    "message": "Timm wrapper label names (#35553)\n\n* Add timm wrapper label names mapping\r\n\r\n* Add index to classification pipeline\r\n\r\n* Revert adding index for pipelines\r\n\r\n* Add custom model check for loading timm labels\r\n\r\n* Add tests for labels\r\n\r\n* [run-slow] timm_wrapper\r\n\r\n* Add note regarding label2id mapping",
    "sha": "59e5b3f01b7773439671c3a827348ba87dc8b92a",
    "files": [
        {
            "sha": "9562e28a8b60a31347a445a7768944d6272eb8c5",
            "filename": "src/transformers/models/timm_wrapper/configuration_timm_wrapper.py",
            "status": "modified",
            "additions": 32,
            "deletions": 2,
            "changes": 34,
            "blob_url": "https://github.com/huggingface/transformers/blob/59e5b3f01b7773439671c3a827348ba87dc8b92a/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fconfiguration_timm_wrapper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/59e5b3f01b7773439671c3a827348ba87dc8b92a/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fconfiguration_timm_wrapper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fconfiguration_timm_wrapper.py?ref=59e5b3f01b7773439671c3a827348ba87dc8b92a",
            "patch": "@@ -18,7 +18,11 @@\n from typing import Any, Dict\n \n from ...configuration_utils import PretrainedConfig\n-from ...utils import logging\n+from ...utils import is_timm_available, logging\n+\n+\n+if is_timm_available():\n+    from timm.data import ImageNetInfo, infer_imagenet_subset\n \n \n logger = logging.get_logger(__name__)\n@@ -33,6 +37,9 @@ class TimmWrapperConfig(PretrainedConfig):\n     Configuration objects inherit from [`PretrainedConfig`] and can be used to control the model outputs. Read the\n     documentation from [`PretrainedConfig`] for more information.\n \n+    Config loads imagenet label descriptions and stores them in `id2label` attribute, `label2id` attribute for default\n+    imagenet models is set to `None` due to occlusions in the label descriptions.\n+\n     Args:\n         initializer_range (`float`, *optional*, defaults to 0.02):\n             The standard deviation of the truncated_normal_initializer for initializing all weight matrices.\n@@ -60,10 +67,30 @@ def __init__(self, initializer_range: float = 0.02, do_pooling: bool = True, **k\n \n     @classmethod\n     def from_dict(cls, config_dict: Dict[str, Any], **kwargs):\n+        label_names = config_dict.get(\"label_names\", None)\n+        is_custom_model = \"num_labels\" in kwargs or \"id2label\" in kwargs\n+\n+        # if no labels added to config, use imagenet labeller in timm\n+        if label_names is None and not is_custom_model:\n+            imagenet_subset = infer_imagenet_subset(config_dict)\n+            if imagenet_subset:\n+                dataset_info = ImageNetInfo(imagenet_subset)\n+                synsets = dataset_info.label_names()\n+                label_descriptions = dataset_info.label_descriptions(as_dict=True)\n+                label_names = [label_descriptions[synset] for synset in synsets]\n+\n+        if label_names is not None and not is_custom_model:\n+            kwargs[\"id2label\"] = dict(enumerate(label_names))\n+\n+            # if all label names are unique, create label2id mapping as well\n+            if len(set(label_names)) == len(label_names):\n+                kwargs[\"label2id\"] = {name: i for i, name in enumerate(label_names)}\n+            else:\n+                kwargs[\"label2id\"] = None\n+\n         # timm config stores the `num_classes` attribute in both the root of config and in the \"pretrained_cfg\" dict.\n         # We are removing these attributes in order to have the native `transformers` num_labels attribute in config\n         # and to avoid duplicate attributes\n-\n         num_labels_in_kwargs = kwargs.pop(\"num_labels\", None)\n         num_labels_in_dict = config_dict.pop(\"num_classes\", None)\n \n@@ -80,6 +107,9 @@ def from_dict(cls, config_dict: Dict[str, Any], **kwargs):\n     def to_dict(self) -> Dict[str, Any]:\n         output = super().to_dict()\n         output[\"num_classes\"] = self.num_labels\n+        output[\"label_names\"] = list(self.id2label.values())\n+        output.pop(\"id2label\", None)\n+        output.pop(\"label2id\", None)\n         return output\n \n "
        },
        {
            "sha": "cf35d90518d62e51fb1a6412b129b0495b0d0093",
            "filename": "tests/models/timm_wrapper/test_modeling_timm_wrapper.py",
            "status": "modified",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/huggingface/transformers/blob/59e5b3f01b7773439671c3a827348ba87dc8b92a/tests%2Fmodels%2Ftimm_wrapper%2Ftest_modeling_timm_wrapper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/59e5b3f01b7773439671c3a827348ba87dc8b92a/tests%2Fmodels%2Ftimm_wrapper%2Ftest_modeling_timm_wrapper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Ftimm_wrapper%2Ftest_modeling_timm_wrapper.py?ref=59e5b3f01b7773439671c3a827348ba87dc8b92a",
            "patch": "@@ -200,6 +200,54 @@ def test_do_pooling_option(self):\n             output = model(**inputs_dict, do_pooling=True)\n         self.assertIsNotNone(output.pooler_output)\n \n+    def test_timm_config_labels(self):\n+        # test timm config with no labels\n+        checkpoint = \"timm/resnet18.a1_in1k\"\n+        config = TimmWrapperConfig.from_pretrained(checkpoint)\n+        self.assertIsNone(config.label2id)\n+        self.assertIsInstance(config.id2label, dict)\n+        self.assertEqual(len(config.id2label), 1000)\n+        self.assertEqual(config.id2label[1], \"goldfish, Carassius auratus\")\n+\n+        # test timm config with labels in config\n+        checkpoint = \"timm/eva02_large_patch14_clip_336.merged2b_ft_inat21\"\n+        config = TimmWrapperConfig.from_pretrained(checkpoint)\n+\n+        self.assertIsInstance(config.id2label, dict)\n+        self.assertEqual(len(config.id2label), 10000)\n+        self.assertEqual(config.id2label[1], \"Sabella spallanzanii\")\n+\n+        self.assertIsInstance(config.label2id, dict)\n+        self.assertEqual(len(config.label2id), 10000)\n+        self.assertEqual(config.label2id[\"Sabella spallanzanii\"], 1)\n+\n+        # test custom labels are provided\n+        checkpoint = \"timm/resnet18.a1_in1k\"\n+        config = TimmWrapperConfig.from_pretrained(checkpoint, num_labels=2)\n+        self.assertEqual(config.num_labels, 2)\n+        self.assertEqual(config.id2label, {0: \"LABEL_0\", 1: \"LABEL_1\"})\n+        self.assertEqual(config.label2id, {\"LABEL_0\": 0, \"LABEL_1\": 1})\n+\n+        # test with provided id2label and label2id\n+        checkpoint = \"timm/resnet18.a1_in1k\"\n+        config = TimmWrapperConfig.from_pretrained(\n+            checkpoint, num_labels=2, id2label={0: \"LABEL_0\", 1: \"LABEL_1\"}, label2id={\"LABEL_0\": 0, \"LABEL_1\": 1}\n+        )\n+        self.assertEqual(config.num_labels, 2)\n+        self.assertEqual(config.id2label, {0: \"LABEL_0\", 1: \"LABEL_1\"})\n+        self.assertEqual(config.label2id, {\"LABEL_0\": 0, \"LABEL_1\": 1})\n+\n+        # test save load\n+        checkpoint = \"timm/resnet18.a1_in1k\"\n+        config = TimmWrapperConfig.from_pretrained(checkpoint)\n+        with tempfile.TemporaryDirectory() as tmpdirname:\n+            config.save_pretrained(tmpdirname)\n+            restored_config = TimmWrapperConfig.from_pretrained(tmpdirname)\n+\n+        self.assertEqual(config.num_labels, restored_config.num_labels)\n+        self.assertEqual(config.id2label, restored_config.id2label)\n+        self.assertEqual(config.label2id, restored_config.label2id)\n+\n \n # We will verify our results on an image of cute cats\n def prepare_img():"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 80,
        "deletions": 2
    }
}