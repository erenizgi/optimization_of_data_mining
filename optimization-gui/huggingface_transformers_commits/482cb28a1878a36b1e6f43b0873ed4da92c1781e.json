{
    "author": "Isotr0py",
    "message": "Fix `tie_word_embeddings` handling for GGUF models (#35085)\n\n* fix tie_word_embeddings\r\n\r\nSigned-off-by: Isotr0py <2037008807@qq.com>\r\n\r\n* fix\r\n\r\nSigned-off-by: Isotr0py <2037008807@qq.com>\r\n\r\n---------\r\n\r\nSigned-off-by: Isotr0py <2037008807@qq.com>",
    "sha": "482cb28a1878a36b1e6f43b0873ed4da92c1781e",
    "files": [
        {
            "sha": "7562649be753bbd2d28a1491c7e2051ad7636b16",
            "filename": "src/transformers/modeling_gguf_pytorch_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/482cb28a1878a36b1e6f43b0873ed4da92c1781e/src%2Ftransformers%2Fmodeling_gguf_pytorch_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/482cb28a1878a36b1e6f43b0873ed4da92c1781e/src%2Ftransformers%2Fmodeling_gguf_pytorch_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_gguf_pytorch_utils.py?ref=482cb28a1878a36b1e6f43b0873ed4da92c1781e",
            "patch": "@@ -291,7 +291,6 @@ def load_gguf_checkpoint(gguf_checkpoint_path, return_tensors=False):\n     # FIXME: Currnetly this implementation is only for flan-t5 architecture.\n     # It needs to be developed for supporting legacy t5.\n     elif \"t5\" in architecture or \"t5encoder\" in architecture:\n-        parsed_parameters[\"config\"][\"tie_word_embeddings\"] = False\n         parsed_parameters[\"config\"][\"is_gated_act\"] = True\n         updated_architecture = \"t5\"\n     else:\n@@ -326,6 +325,12 @@ def load_gguf_checkpoint(gguf_checkpoint_path, return_tensors=False):\n     if architecture + model_size not in GGUF_SUPPORTED_ARCHITECTURES:\n         raise ValueError(f\"Architecture {architecture + model_size} not supported\")\n \n+    # Handle tie_word_embeddings, if lm_head.weight is not present in tensors,\n+    # tie_word_embeddings is true otherwise false\n+    parsed_parameters[\"config\"][\"tie_word_embeddings\"] = all(\n+        \"output.weight\" != tensor.name for tensor in reader.tensors\n+    )\n+\n     # List all key-value pairs in a columnized format\n     for gguf_key, field in reader.fields.items():\n         gguf_key = gguf_key.replace(architecture, updated_architecture)"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 6,
        "deletions": 1
    }
}