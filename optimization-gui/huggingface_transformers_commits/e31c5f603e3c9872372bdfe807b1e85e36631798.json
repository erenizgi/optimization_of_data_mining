{
    "author": "BenjaminBossan",
    "message": "FIX: Minimal fix for loading PEFT weights (#42387)\n\n* FIX Minimal fix for loading PEFT weights\n\nAfter the weight conversion PR #41580, some adjustments were still\nrequired for loading PEFT weights. This PR presents a minimal fix to\nmake it work again.\n\nBesides renaming keys, this PR does not address possible conversions\nthat might be required to be applied to the PEFT weights\nthemselves (most wouldn't work anyway, but e.g. chunking should be\npossible to implement).\n\nAs for test, the existing test_peft_from_pretrained in\ntest_peft_integration.py actually fails on main right now, this PR fixes\nit. As the tests are slow tests, normal CI won't pick this up though.\n\n* Allow n:n matching\n\n* Reviewer feedback",
    "sha": "e31c5f603e3c9872372bdfe807b1e85e36631798",
    "files": [
        {
            "sha": "998af1491cff12accf762472f5f1abf6156f2271",
            "filename": "src/transformers/integrations/peft.py",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/e31c5f603e3c9872372bdfe807b1e85e36631798/src%2Ftransformers%2Fintegrations%2Fpeft.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/e31c5f603e3c9872372bdfe807b1e85e36631798/src%2Ftransformers%2Fintegrations%2Fpeft.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fintegrations%2Fpeft.py?ref=e31c5f603e3c9872372bdfe807b1e85e36631798",
            "patch": "@@ -15,9 +15,9 @@\n import inspect\n import json\n import os\n-import re\n from typing import Any, Literal\n \n+from ..core_model_loading import WeightRenaming, build_glob_alternation, repl\n from ..utils import (\n     CONFIG_NAME,\n     cached_file,\n@@ -302,12 +302,10 @@ def load_adapter(\n             else:\n                 new_key = key\n \n-            if key_mapping:  # TODO dynamic weight loader for adapters\n-                for pattern, replacement in key_mapping.items():\n-                    new_key, n_replace = re.subn(pattern, replacement, new_key)\n-                    # Early exit of the loop\n-                    if n_replace > 0:\n-                        break\n+            if key_mapping:\n+                renamings = [entry for entry in key_mapping if isinstance(entry, WeightRenaming)]\n+                rename_alt, _, rename_by_group = build_glob_alternation(renamings)\n+                new_key = rename_alt.sub(lambda m: repl(m, rename_by_group), new_key).replace(\"\\\\\", \"\")\n \n             # For hotswapping, we need the adapter name to be present in the state dict keys\n             if hotswap:"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 5,
        "deletions": 7
    }
}