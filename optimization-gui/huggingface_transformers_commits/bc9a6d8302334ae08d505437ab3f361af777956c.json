{
    "author": "thedebugger",
    "message": "Fix device mismatch error in Whisper model during feature extraction (#35866)\n\n* Fix device mismatch error in whisper feature extraction\r\n\r\n* Set default device\r\n\r\n* Address code review feedback\r\n\r\n---------\r\n\r\nCo-authored-by: eustlb <94853470+eustlb@users.noreply.github.com>",
    "sha": "bc9a6d8302334ae08d505437ab3f361af777956c",
    "files": [
        {
            "sha": "1519fb02862364293479bb344a48c5f1e06dc275",
            "filename": "src/transformers/models/whisper/feature_extraction_whisper.py",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/bc9a6d8302334ae08d505437ab3f361af777956c/src%2Ftransformers%2Fmodels%2Fwhisper%2Ffeature_extraction_whisper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/bc9a6d8302334ae08d505437ab3f361af777956c/src%2Ftransformers%2Fmodels%2Fwhisper%2Ffeature_extraction_whisper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fwhisper%2Ffeature_extraction_whisper.py?ref=bc9a6d8302334ae08d505437ab3f361af777956c",
            "patch": "@@ -129,18 +129,13 @@ def _torch_extract_fbank_features(self, waveform: np.array, device: str = \"cpu\")\n         Compute the log-mel spectrogram of the audio using PyTorch's GPU-accelerated STFT implementation with batching,\n         yielding results similar to cpu computing with 1e-5 tolerance.\n         \"\"\"\n-        waveform = torch.from_numpy(waveform).type(torch.float32)\n+        waveform = torch.from_numpy(waveform).to(device, torch.float32)\n+        window = torch.hann_window(self.n_fft, device=device)\n \n-        window = torch.hann_window(self.n_fft)\n-        if device != \"cpu\":\n-            waveform = waveform.to(device)\n-            window = window.to(device)\n         stft = torch.stft(waveform, self.n_fft, self.hop_length, window=window, return_complex=True)\n         magnitudes = stft[..., :-1].abs() ** 2\n \n-        mel_filters = torch.from_numpy(self.mel_filters).type(torch.float32)\n-        if device != \"cpu\":\n-            mel_filters = mel_filters.to(device)\n+        mel_filters = torch.from_numpy(self.mel_filters).to(device, torch.float32)\n         mel_spec = mel_filters.T @ magnitudes\n \n         log_spec = torch.clamp(mel_spec, min=1e-10).log10()"
        },
        {
            "sha": "61106c040067af3231067da82d63f01fd284b991",
            "filename": "tests/models/whisper/test_feature_extraction_whisper.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/bc9a6d8302334ae08d505437ab3f361af777956c/tests%2Fmodels%2Fwhisper%2Ftest_feature_extraction_whisper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/bc9a6d8302334ae08d505437ab3f361af777956c/tests%2Fmodels%2Fwhisper%2Ftest_feature_extraction_whisper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fwhisper%2Ftest_feature_extraction_whisper.py?ref=bc9a6d8302334ae08d505437ab3f361af777956c",
            "patch": "@@ -298,8 +298,9 @@ def test_torch_integration_batch(self):\n         )\n         # fmt: on\n \n-        input_speech = self._load_datasamples(3)\n-        feature_extractor = WhisperFeatureExtractor()\n-        input_features = feature_extractor(input_speech, return_tensors=\"pt\").input_features\n+        with torch.device(\"cuda\"):\n+            input_speech = self._load_datasamples(3)\n+            feature_extractor = WhisperFeatureExtractor()\n+            input_features = feature_extractor(input_speech, return_tensors=\"pt\").input_features\n         self.assertEqual(input_features.shape, (3, 80, 3000))\n         torch.testing.assert_close(input_features[:, 0, :30], EXPECTED_INPUT_FEATURES, rtol=1e-4, atol=1e-4)"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 7,
        "deletions": 11
    }
}