{
    "author": "zucchini-nlp",
    "message": "[internvl] fix video inference (#38811)\n\nfix",
    "sha": "d2fd3868bb03dd48199ba6ddd485c0845873da49",
    "files": [
        {
            "sha": "5456788c7a2a72fac205d6874600d043acb9c680",
            "filename": "src/transformers/models/internvl/processing_internvl.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/huggingface/transformers/blob/d2fd3868bb03dd48199ba6ddd485c0845873da49/src%2Ftransformers%2Fmodels%2Finternvl%2Fprocessing_internvl.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/d2fd3868bb03dd48199ba6ddd485c0845873da49/src%2Ftransformers%2Fmodels%2Finternvl%2Fprocessing_internvl.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Finternvl%2Fprocessing_internvl.py?ref=d2fd3868bb03dd48199ba6ddd485c0845873da49",
            "patch": "@@ -223,12 +223,15 @@ def __call__(\n             image_num_patches_indices = np.cumsum(image_num_patches)\n         if videos is not None:\n             videos = make_batched_videos(videos)\n-            num_frames_per_video = [len(video) for video in videos]\n-            video_patch_indices = np.cumsum(num_frames_per_video)\n             video_inputs = self.video_processor(videos=videos, **output_kwargs[\"videos_kwargs\"])\n+            video_pixel_values = video_inputs.pop(\"pixel_values_videos\")\n+\n+            # Obtain per frame information first and then flatten to (BS * T, ...)\n+            num_frames_per_video = [len(video) for video in video_pixel_values]\n             video_num_patches = [1 for frames in num_frames_per_video for _ in range(frames)]\n-            video_pixel_values = video_inputs.pop(\"pixel_values_videos\").flatten(0, 1)\n+            video_patch_indices = np.cumsum(num_frames_per_video)\n             video_num_patches_indices = np.cumsum(video_num_patches)\n+            video_pixel_values = video_pixel_values.flatten(0, 1)\n \n         if images is not None or videos is not None:\n             text, image_video_patches, image_index, video_index = self._insert_media_placeholders("
        }
    ],
    "stats": {
        "total": 9,
        "additions": 6,
        "deletions": 3
    }
}