{
    "author": "ydshieh",
    "message": "update push CI workflow files for security (#33142)\n\n* update for security 1\r\n\r\n* update for security 2\r\n\r\n* update for security 3\r\n\r\n* update for security 4\r\n\r\n* update for security 5\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "3d79dcbda0ece367e5c311934af89fa0a0fe43b1",
    "files": [
        {
            "sha": "6931c2f3eadcad4832960d2d236d63bf576b65f2",
            "filename": ".github/workflows/self-push-amd.yml",
            "status": "modified",
            "additions": 21,
            "deletions": 16,
            "changes": 37,
            "blob_url": "https://github.com/huggingface/transformers/blob/3d79dcbda0ece367e5c311934af89fa0a0fe43b1/.github%2Fworkflows%2Fself-push-amd.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/3d79dcbda0ece367e5c311934af89fa0a0fe43b1/.github%2Fworkflows%2Fself-push-amd.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-push-amd.yml?ref=3d79dcbda0ece367e5c311934af89fa0a0fe43b1",
            "patch": "@@ -64,23 +64,24 @@ jobs:\n     outputs:\n       matrix: ${{ steps.set-matrix.outputs.matrix }}\n       test_map: ${{ steps.set-matrix.outputs.test_map }}\n+    env:\n+      # `CI_BRANCH_PUSH`: The branch name from the push event\n+      # `CI_BRANCH_WORKFLOW_RUN`: The name of the branch on which this workflow is triggered by `workflow_run` event\n+      # `CI_SHA_PUSH`: The commit SHA from the push event\n+      # `CI_SHA_WORKFLOW_RUN`: The commit SHA that triggers this workflow by `workflow_run` event\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n-        # `CI_BRANCH_PUSH`: The branch name from the push event\n-        # `CI_BRANCH_WORKFLOW_RUN`: The name of the branch on which this workflow is triggered by `workflow_run` event\n         # `CI_BRANCH`: The non-empty branch name from the above two (one and only one of them is empty)\n-        # `CI_SHA_PUSH`: The commit SHA from the push event\n-        # `CI_SHA_WORKFLOW_RUN`: The commit SHA that triggers this workflow by `workflow_run` event\n         # `CI_SHA`: The non-empty commit SHA from the above two (one and only one of them is empty)\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -159,18 +160,20 @@ jobs:\n     container:\n       image: huggingface/transformers-pytorch-amd-gpu-push-ci  # <--- We test only for PyTorch for now\n       options: --device /dev/kfd --device /dev/dri --env ROCR_VISIBLE_DEVICES --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -256,6 +259,12 @@ jobs:\n #        run_tests_torch_cuda_extensions_single_gpu,\n #        run_tests_torch_cuda_extensions_multi_gpu\n     ]\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       - name: Preliminary job status\n         shell: bash\n@@ -271,11 +280,7 @@ jobs:\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH"
        },
        {
            "sha": "b328f65d34a5fee40c88838b31bef6acfebab984",
            "filename": ".github/workflows/self-push.yml",
            "status": "modified",
            "additions": 39,
            "deletions": 28,
            "changes": 67,
            "blob_url": "https://github.com/huggingface/transformers/blob/3d79dcbda0ece367e5c311934af89fa0a0fe43b1/.github%2Fworkflows%2Fself-push.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/3d79dcbda0ece367e5c311934af89fa0a0fe43b1/.github%2Fworkflows%2Fself-push.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-push.yml?ref=3d79dcbda0ece367e5c311934af89fa0a0fe43b1",
            "patch": "@@ -40,23 +40,24 @@ jobs:\n     outputs:\n       matrix: ${{ steps.set-matrix.outputs.matrix }}\n       test_map: ${{ steps.set-matrix.outputs.test_map }}\n+    env:\n+      # `CI_BRANCH_PUSH`: The branch name from the push event\n+      # `CI_BRANCH_WORKFLOW_RUN`: The name of the branch on which this workflow is triggered by `workflow_run` event\n+      # `CI_SHA_PUSH`: The commit SHA from the push event\n+      # `CI_SHA_WORKFLOW_RUN`: The commit SHA that triggers this workflow by `workflow_run` event\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n-        # `CI_BRANCH_PUSH`: The branch name from the push event\n-        # `CI_BRANCH_WORKFLOW_RUN`: The name of the branch on which this workflow is triggered by `workflow_run` event\n         # `CI_BRANCH`: The non-empty branch name from the above two (one and only one of them is empty)\n-        # `CI_SHA_PUSH`: The commit SHA from the push event\n-        # `CI_SHA_WORKFLOW_RUN`: The commit SHA that triggers this workflow by `workflow_run` event\n         # `CI_SHA`: The non-empty commit SHA from the above two (one and only one of them is empty)\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -135,18 +136,20 @@ jobs:\n     container:\n       image: huggingface/transformers-all-latest-gpu-push-ci\n       options: --gpus 0 --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -228,18 +231,20 @@ jobs:\n     container:\n       image: huggingface/transformers-all-latest-gpu-push-ci\n       options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -321,18 +326,20 @@ jobs:\n     container:\n       image: huggingface/transformers-pytorch-deepspeed-latest-gpu-push-ci\n       options: --gpus 0 --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -411,18 +418,20 @@ jobs:\n     container:\n       image: huggingface/transformers-pytorch-deepspeed-latest-gpu-push-ci\n       options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       # Necessary to get the correct branch name and commit SHA for `workflow_run` event\n       # We also take into account the `push` event (we might want to test some changes in a branch)\n       - name: Prepare custom environment variables\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH\n@@ -500,6 +509,12 @@ jobs:\n         run_tests_torch_cuda_extensions_single_gpu,\n         run_tests_torch_cuda_extensions_multi_gpu\n     ]\n+    env:\n+      # For the meaning of these environment variables, see the job `Setup`\n+      CI_BRANCH_PUSH: ${{ github.event.ref }}\n+      CI_BRANCH_WORKFLOW_RUN: ${{ github.event.workflow_run.head_branch }}\n+      CI_SHA_PUSH: ${{ github.event.head_commit.id }}\n+      CI_SHA_WORKFLOW_RUN: ${{ github.event.workflow_run.head_sha }}\n     steps:\n       - name: Preliminary job status\n         shell: bash\n@@ -513,11 +528,7 @@ jobs:\n         shell: bash\n         # For the meaning of these environment variables, see the job `Setup`\n         run: |\n-          CI_BRANCH_PUSH=${{ github.event.ref }}\n           CI_BRANCH_PUSH=${CI_BRANCH_PUSH/'refs/heads/'/''}\n-          CI_BRANCH_WORKFLOW_RUN=${{ github.event.workflow_run.head_branch }}\n-          CI_SHA_PUSH=${{ github.event.head_commit.id }}\n-          CI_SHA_WORKFLOW_RUN=${{ github.event.workflow_run.head_sha }}\n           echo $CI_BRANCH_PUSH\n           echo $CI_BRANCH_WORKFLOW_RUN\n           echo $CI_SHA_PUSH"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 60,
        "deletions": 44
    }
}