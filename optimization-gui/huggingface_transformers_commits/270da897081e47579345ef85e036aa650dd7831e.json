{
    "author": "ydshieh",
    "message": "Remove `runner_map` (#40880)\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "270da897081e47579345ef85e036aa650dd7831e",
    "files": [
        {
            "sha": "5da145c2b0063b7a6e4467f95bda05a9eac43406",
            "filename": ".github/workflows/model_jobs.yml",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/270da897081e47579345ef85e036aa650dd7831e/.github%2Fworkflows%2Fmodel_jobs.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/270da897081e47579345ef85e036aa650dd7831e/.github%2Fworkflows%2Fmodel_jobs.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fmodel_jobs.yml?ref=270da897081e47579345ef85e036aa650dd7831e",
            "patch": "@@ -12,9 +12,6 @@ on:\n       slice_id:\n         required: true\n         type: number\n-      runner_map:\n-        required: false\n-        type: string\n       docker:\n         required: true\n         type: string\n@@ -54,10 +51,12 @@ jobs:\n       matrix:\n         folders: ${{ fromJson(inputs.folder_slices)[inputs.slice_id] }}\n     runs-on:\n-      group: ${{ fromJson(inputs.runner_map)[matrix.folders][inputs.machine_type] }}\n+      group: '${{ inputs.machine_type }}'\n     container:\n       image: ${{ inputs.docker }}\n       options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    outputs:\n+      machine_type: ${{ steps.set_machine_type.outputs.machine_type }}\n     steps:\n       - name: Echo input and matrix info\n         shell: bash\n@@ -111,6 +110,7 @@ jobs:\n         run: pip freeze\n \n       - name: Set `machine_type` for report and artifact names\n+        id: set_machine_type\n         working-directory: /transformers\n         shell: bash\n         run: |\n@@ -126,6 +126,7 @@ jobs:\n \n           echo \"$machine_type\"\n           echo \"machine_type=$machine_type\" >> $GITHUB_ENV\n+          echo \"machine_type=$machine_type\" >> $GITHUB_OUTPUT\n \n       - name: Run all tests on GPU\n         working-directory: /transformers\n@@ -159,5 +160,5 @@ jobs:\n       job: run_models_gpu\n       report_repo_id: ${{ inputs.report_repo_id }}\n       gpu_name: ${{ inputs.runner_type }}\n-      machine_type: ${{ inputs.machine_type }}\n+      machine_type: ${{ needs.run_models_gpu.outputs.machine_type }}\n     secrets: inherit"
        },
        {
            "sha": "01f5a0a48bdd3bf2bee4488ef3eefaf4116374da",
            "filename": ".github/workflows/self-scheduled-caller.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/270da897081e47579345ef85e036aa650dd7831e/.github%2Fworkflows%2Fself-scheduled-caller.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/270da897081e47579345ef85e036aa650dd7831e/.github%2Fworkflows%2Fself-scheduled-caller.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-scheduled-caller.yml?ref=270da897081e47579345ef85e036aa650dd7831e",
            "patch": "@@ -88,6 +88,7 @@ jobs:\n       job: run_trainer_and_fsdp_gpu\n       slack_report_channel: \"#transformers-ci-daily-training\"\n       docker: huggingface/transformers-all-latest-gpu\n+      runner_type: \"a10\"\n       ci_event: Daily CI\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n       commit_sha: ${{ github.sha }}"
        },
        {
            "sha": "7129b1867fc428524fdc1995487bc0341ea2f6ec",
            "filename": ".github/workflows/self-scheduled.yml",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/270da897081e47579345ef85e036aa650dd7831e/.github%2Fworkflows%2Fself-scheduled.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/270da897081e47579345ef85e036aa650dd7831e/.github%2Fworkflows%2Fself-scheduled.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-scheduled.yml?ref=270da897081e47579345ef85e036aa650dd7831e",
            "patch": "@@ -68,7 +68,6 @@ jobs:\n     outputs:\n       folder_slices: ${{ steps.set-matrix.outputs.folder_slices }}\n       slice_ids: ${{ steps.set-matrix.outputs.slice_ids }}\n-      runner_map: ${{ steps.set-matrix.outputs.runner_map }}\n       quantization_matrix: ${{ steps.set-matrix-quantization.outputs.quantization_matrix }}\n     steps:\n       - name: Update clone\n@@ -95,7 +94,6 @@ jobs:\n           if [ \"${{ inputs.job }}\" = \"run_models_gpu\" ]; then\n             echo \"folder_slices=$(python3 ../utils/split_model_tests.py --models '${{ inputs.models }}' --num_splits ${{ env.NUM_SLICES }})\" >> $GITHUB_OUTPUT\n             echo \"slice_ids=$(python3 -c 'd = list(range(${{ env.NUM_SLICES }})); print(d)')\" >> $GITHUB_OUTPUT\n-            echo \"runner_map=$(python3 ../utils/get_runner_map.py)\" >> $GITHUB_OUTPUT\n           elif [ \"${{ inputs.job }}\" = \"run_trainer_and_fsdp_gpu\" ]; then\n             echo \"folder_slices=[['trainer'], ['fsdp']]\" >> $GITHUB_OUTPUT\n             echo \"slice_ids=[0, 1]\" >> $GITHUB_OUTPUT\n@@ -119,14 +117,13 @@ jobs:\n     strategy:\n       fail-fast: false\n       matrix:\n-        machine_type: [single-gpu, multi-gpu]\n+        machine_type: [aws-g5-4xlarge-cache, aws-g5-12xlarge-cache]\n         slice_id: ${{ fromJSON(needs.setup.outputs.slice_ids) }}\n     uses: ./.github/workflows/model_jobs.yml\n     with:\n       folder_slices: ${{ needs.setup.outputs.folder_slices }}\n       machine_type: ${{ matrix.machine_type }}\n       slice_id: ${{ matrix.slice_id }}\n-      runner_map: ${{ needs.setup.outputs.runner_map }}\n       docker: ${{ inputs.docker }}\n       commit_sha: ${{ inputs.commit_sha || github.sha }}\n       runner_type: ${{ inputs.runner_type }}\n@@ -147,9 +144,10 @@ jobs:\n       folder_slices: ${{ needs.setup.outputs.folder_slices }}\n       machine_type: ${{ matrix.machine_type }}\n       slice_id: ${{ matrix.slice_id }}\n-      runner_map: ${{ needs.setup.outputs.runner_map }}\n       docker: ${{ inputs.docker }}\n       commit_sha: ${{ inputs.commit_sha || github.sha }}\n+      runner_type: ${{ inputs.runner_type }}\n+      report_repo_id: ${{ inputs.report_repo_id }}\n       report_name_prefix: run_trainer_and_fsdp_gpu\n     secrets: inherit\n "
        },
        {
            "sha": "7b36651165bc40b0bc96a7126068f0766d8fc421",
            "filename": "utils/get_runner_map.py",
            "status": "removed",
            "additions": 0,
            "deletions": 65,
            "changes": 65,
            "blob_url": "https://github.com/huggingface/transformers/blob/df03fc1f9cac4ff8ec7f57a599b274768180f765/utils%2Fget_runner_map.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/df03fc1f9cac4ff8ec7f57a599b274768180f765/utils%2Fget_runner_map.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fget_runner_map.py?ref=df03fc1f9cac4ff8ec7f57a599b274768180f765",
            "patch": "@@ -1,65 +0,0 @@\n-# Copyright 2025 The HuggingFace Team. All rights reserved.\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-\n-\"\"\"\n-This script is used to get a map containing the information of runners to use in GitHub Actions workflow files.\n-This is meant to be a temporary file that helps us to switch progressively from T4 to A10 runners.\n-\n-The data is stored in a Hub repository [hf-internal-testing/transformers_daily_ci](https://huggingface.co/datasets/hf-internal-testing/transformers_daily_ci/blob/main/runner_map.json).\n-Currently, in that file, we specify the models for which we want to run the tests with T4 runners to avoid many test failures showing on the CI reports.\n-We will work on the tests toward to use A10 for all CI jobs.\n-\"\"\"\n-\n-import os\n-\n-import requests\n-\n-\n-if __name__ == \"__main__\":\n-    # T4\n-    t4_runners = {\n-        \"single-gpu\": \"aws-g4dn-4xlarge-cache\",\n-        \"multi-gpu\": \"aws-g4dn-12xlarge-cache\",\n-    }\n-\n-    # A10\n-    a10_runners = {\n-        \"single-gpu\": \"aws-g5-4xlarge-cache\",\n-        \"multi-gpu\": \"aws-g5-12xlarge-cache\",\n-    }\n-\n-    tests = os.getcwd()\n-    model_tests = os.listdir(os.path.join(tests, \"models\"))\n-    d1 = sorted(filter(os.path.isdir, os.listdir(tests)))\n-    d2 = sorted(filter(os.path.isdir, [f\"models/{x}\" for x in model_tests]))\n-    d1.remove(\"models\")\n-    d = d2 + d1\n-\n-    response = requests.get(\n-        \"https://huggingface.co/datasets/hf-internal-testing/transformers_daily_ci/resolve/main/runner_map.json\"\n-    )\n-    # The models that we want to run with T4 runners\n-    jobs_using_t4 = response.json()\n-\n-    runner_map = {}\n-    for key in d:\n-        modified_key = key\n-        if modified_key.startswith(\"models/\"):\n-            modified_key = key[len(\"models/\") :]\n-        if modified_key in jobs_using_t4:\n-            runner_map[key] = t4_runners\n-        else:\n-            runner_map[key] = a10_runners\n-\n-    print(runner_map)"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 10,
        "deletions": 75
    }
}