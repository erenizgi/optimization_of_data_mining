{
    "author": "McPatate",
    "message": "feat: add `benchmarks_entrypoint.py` (#34495)\n\n* feat: add `benchmarks_entrypoint.py`\n\nAdding `benchmarks_entrypoint.py` file, which will be run from the\nbenchmarks CI.\n\nThis python script will list all python files from the `benchmark/`\nfolder and run the included `run_benchmark` function, allowing people to\nadd new benchmarks scripts.\n\n* feat: add `MetricsRecorder`\n\n* feat: update dashboard\n\n* fix: add missing arguments to `MetricsRecorder`\n\n* feat: update dash & add datasource + `default.yml`\n\n* fix: move responsibility to create `MetricsRecorder` in bench script\n\n* fix: update incorrect datasource UID\n\n* fix: incorrect variable values\n\n* debug: benchmark entrypoint script\n\n* refactor: update log level\n\n* fix: update broken import\n\n* feat: add debug log in `MetricsRecorder`\n\n* debug: set log level to debug\n\n* fix: set connection `autocommit` to `True`",
    "sha": "9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
    "files": [
        {
            "sha": "1bbd1c1e94d08ca21b8d3d99a2c7484d8d9a45e3",
            "filename": ".github/workflows/benchmark.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/.github%2Fworkflows%2Fbenchmark.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/.github%2Fworkflows%2Fbenchmark.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fbenchmark.yml?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -63,7 +63,7 @@ jobs:\n             commit_id=$GITHUB_SHA\r\n           fi\r\n           commit_msg=$(git show -s --format=%s | cut -c1-70)\r\n-          python3 benchmark/llama.py \"${{ github.head_ref || github.ref_name }}\" \"$commit_id\" \"$commit_msg\"\r\n+          python3 benchmark/benchmarks_entrypoint.py \"${{ github.head_ref || github.ref_name }}\" \"$commit_id\" \"$commit_msg\"\r\n         env:\r\n           HF_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}\r\n           # Enable this to see debug logs\r"
        },
        {
            "sha": "a827da444f08014815f0425edc1d4be492f058f4",
            "filename": "benchmark/README.md",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2FREADME.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2FREADME.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2FREADME.md?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -0,0 +1,49 @@\n+# Benchmarks\n+\n+You might want to add new benchmarks.\n+\n+You will need to define a python function named `run_benchmark` in your python file and the file must be located in this `benchmark/` directory.\n+\n+The expected function signature is the following:\n+\n+```py\n+def run_benchmark(logger: Logger, branch: str, commit_id: str, commit_msg: str, num_tokens_to_generate=100):\n+```\n+\n+## Writing metrics to the database\n+\n+`MetricRecorder` is thread-safe, in the sense of the python [`Thread`](https://docs.python.org/3/library/threading.html#threading.Thread). This means you can start a background thread to do the readings on the device measurements while not blocking the main thread to execute the model measurements.\n+\n+cf [`llama.py`](./llama.py) to see an example of this in practice.\n+\n+```py\n+from benchmarks_entrypoint import MetricsRecorder\n+import psycopg2\n+\n+def run_benchmark(logger: Logger, branch: str, commit_id: str, commit_msg: str, num_tokens_to_generate=100):\n+  metrics_recorder = MetricsRecorder(psycopg2.connect(\"dbname=metrics\"), logger, branch, commit_id, commit_msg)\n+  benchmark_id = metrics_recorder.initialise_benchmark({\"gpu_name\": gpu_name, \"model_id\": model_id})\n+    # To collect device measurements\n+    metrics_recorder.collect_device_measurements(\n+        benchmark_id, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes\n+    )\n+    # To collect your model measurements\n+    metrics_recorder.collect_model_measurements(\n+        benchmark_id,\n+        {\n+            \"model_load_time\": model_load_time,\n+            \"first_eager_forward_pass_time_secs\": first_eager_fwd_pass_time,\n+            \"second_eager_forward_pass_time_secs\": second_eager_fwd_pass_time,\n+            \"first_eager_generate_time_secs\": first_eager_generate_time,\n+            \"second_eager_generate_time_secs\": second_eager_generate_time,\n+            \"time_to_first_token_secs\": time_to_first_token,\n+            \"time_to_second_token_secs\": time_to_second_token,\n+            \"time_to_third_token_secs\": time_to_third_token,\n+            \"time_to_next_token_mean_secs\": mean_time_to_next_token,\n+            \"first_compile_generate_time_secs\": first_compile_generate_time,\n+            \"second_compile_generate_time_secs\": second_compile_generate_time,\n+            \"third_compile_generate_time_secs\": third_compile_generate_time,\n+            \"fourth_compile_generate_time_secs\": fourth_compile_generate_time,\n+        },\n+    )\n+```"
        },
        {
            "sha": "7925e2902834f7f1b5e94c7f27fadfc622d12f79",
            "filename": "benchmark/benchmarks_entrypoint.py",
            "status": "added",
            "additions": 144,
            "deletions": 0,
            "changes": 144,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fbenchmarks_entrypoint.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fbenchmarks_entrypoint.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fbenchmarks_entrypoint.py?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -0,0 +1,144 @@\n+import argparse\n+import importlib.util\n+import logging\n+import os\n+from typing import Dict\n+import psycopg2\n+import sys\n+\n+from psycopg2.extras import Json\n+from psycopg2.extensions import register_adapter\n+\n+\n+register_adapter(dict, Json)\n+\n+\n+class ImportModuleException(Exception):\n+    pass\n+\n+\n+class MetricsRecorder:\n+    def __init__(self, connection, logger: logging.Logger, branch: str, commit_id: str, commit_msg: str):\n+        self.conn = connection\n+        self.conn.autocommit = True\n+        self.logger = logger\n+        self.branch = branch\n+        self.commit_id = commit_id\n+        self.commit_msg = commit_msg\n+\n+    def initialise_benchmark(self, metadata: Dict[str, str]) -> int:\n+        \"\"\"\n+        Creates a new benchmark, returns the benchmark id\n+        \"\"\"\n+        # gpu_name: str, model_id: str\n+        with self.conn.cursor() as cur:\n+            cur.execute(\n+                \"INSERT INTO benchmarks (branch, commit_id, commit_message, metadata) VALUES (%s, %s, %s, %s) RETURNING benchmark_id\",\n+                (self.branch, self.commit_id, self.commit_msg, metadata),\n+            )\n+            benchmark_id = cur.fetchone()[0]\n+            logger.debug(f\"initialised benchmark #{benchmark_id}\")\n+            return benchmark_id\n+\n+    def collect_device_measurements(self, benchmark_id: int, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes):\n+        \"\"\"\n+        Collect device metrics, such as CPU & GPU usage. These are \"static\", as in you cannot pass arbitrary arguments to the function.\n+        \"\"\"\n+        with self.conn.cursor() as cur:\n+            cur.execute(\n+                \"INSERT INTO device_measurements (benchmark_id, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes) VALUES (%s, %s, %s, %s, %s)\",\n+                (benchmark_id, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes),\n+            )\n+        self.logger.debug(\n+            f\"inserted device measurements for benchmark #{benchmark_id} [CPU util: {cpu_util}, mem MBs: {mem_megabytes}, GPU util: {gpu_util}, GPU mem MBs: {gpu_mem_megabytes}]\"\n+        )\n+\n+    def collect_model_measurements(self, benchmark_id: int, measurements: Dict[str, float]):\n+        with self.conn.cursor() as cur:\n+            cur.execute(\n+                \"\"\"\n+                INSERT INTO model_measurements (\n+                    benchmark_id,\n+                    measurements\n+                ) VALUES (%s, %s)\n+                \"\"\",\n+                (\n+                    benchmark_id,\n+                    measurements,\n+                ),\n+            )\n+        self.logger.debug(f\"inserted model measurements for benchmark #{benchmark_id}: {measurements}\")\n+\n+    def close(self):\n+        self.conn.close()\n+\n+\n+logger = logging.getLogger(__name__)\n+logger.setLevel(logging.INFO)\n+\n+handler = logging.StreamHandler(sys.stdout)\n+handler.setLevel(logging.INFO)\n+formatter = logging.Formatter(\"[%(levelname)s - %(asctime)s] %(message)s\")\n+handler.setFormatter(formatter)\n+logger.addHandler(handler)\n+\n+\n+def parse_arguments():\n+    \"\"\"\n+    Parse command line arguments for the benchmarking CLI.\n+    \"\"\"\n+    parser = argparse.ArgumentParser(description=\"CLI for benchmarking the huggingface/transformers.\")\n+\n+    parser.add_argument(\n+        \"branch\",\n+        type=str,\n+        help=\"The branch name on which the benchmarking is performed.\",\n+    )\n+\n+    parser.add_argument(\n+        \"commit_id\",\n+        type=str,\n+        help=\"The commit hash on which the benchmarking is performed.\",\n+    )\n+\n+    parser.add_argument(\n+        \"commit_msg\",\n+        type=str,\n+        help=\"The commit message associated with the commit, truncated to 70 characters.\",\n+    )\n+\n+    args = parser.parse_args()\n+\n+    return args.branch, args.commit_id, args.commit_msg\n+\n+\n+def import_from_path(module_name, file_path):\n+    try:\n+        spec = importlib.util.spec_from_file_location(module_name, file_path)\n+        module = importlib.util.module_from_spec(spec)\n+        sys.modules[module_name] = module\n+        spec.loader.exec_module(module)\n+        return module\n+    except Exception as e:\n+        raise ImportModuleException(f\"failed to load python module: {e}\")\n+\n+\n+if __name__ == \"__main__\":\n+    benchmarks_folder_path = os.path.dirname(os.path.realpath(__file__))\n+\n+    branch, commit_id, commit_msg = parse_arguments()\n+\n+    for entry in os.scandir(benchmarks_folder_path):\n+        try:\n+            if not entry.name.endswith(\".py\"):\n+                continue\n+            if entry.path == __file__:\n+                continue\n+            logger.debug(f\"loading: {entry.name}\")\n+            module = import_from_path(entry.name.split(\".\")[0], entry.path)\n+            logger.info(f\"runnning benchmarks in: {entry.name}\")\n+            module.run_benchmark(logger, branch, commit_id, commit_msg)\n+        except ImportModuleException as e:\n+            logger.error(e)\n+        except Exception as e:\n+            logger.error(f\"error running benchmarks for {entry.name}: {e}\")"
        },
        {
            "sha": "f3f02cab34d1bd2451eda4744ccf4f4eb7d0e6cc",
            "filename": "benchmark/default.yml",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fdefault.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fdefault.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fdefault.yml?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -0,0 +1,10 @@\n+apiVersion: 1\n+\n+providers:\n+  - name: 'Transformers Benchmarks'\n+    orgId: 1\n+    type: file\n+    updateIntervalSeconds: 10\n+    allowUiUpdates: true\n+    options:\n+      path: /etc/grafana/dashboards"
        },
        {
            "sha": "caaec78a522303eaadc66171d405e203e7475694",
            "filename": "benchmark/grafana_dashboard.json",
            "status": "modified",
            "additions": 78,
            "deletions": 67,
            "changes": 145,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fgrafana_dashboard.json",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fgrafana_dashboard.json",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fgrafana_dashboard.json?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -30,7 +30,7 @@\n       \"title\": \"Go to data\",\n       \"tooltip\": \"Go to data\",\n       \"type\": \"link\",\n-      \"url\": \"http://transformers-benchmarks.huggingface.co/d/fdz33iyzln9c0a/transformers-benchmarks?orgId=1&from=${StartTime}&to=${EndTime}\"\n+      \"url\": \"http://transformers-benchmarks.hf.co/d/fdz33iyzln9c0a/transformers-benchmarks?orgId=1&from=${StartTime}&to=${EndTime}\"\n     }\n   ],\n   \"liveNow\": true,\n@@ -77,7 +77,7 @@\n             \"properties\": [\n               {\n                 \"id\": \"custom.width\",\n-                \"value\": 196\n+                \"value\": 202\n               }\n             ]\n           },\n@@ -101,7 +101,7 @@\n             \"properties\": [\n               {\n                 \"id\": \"custom.width\",\n-                \"value\": 581\n+                \"value\": 524\n               }\n             ]\n           },\n@@ -113,7 +113,19 @@\n             \"properties\": [\n               {\n                 \"id\": \"custom.width\",\n-                \"value\": 379\n+                \"value\": 353\n+              }\n+            ]\n+          },\n+          {\n+            \"matcher\": {\n+              \"id\": \"byName\",\n+              \"options\": \"model_id\"\n+            },\n+            \"properties\": [\n+              {\n+                \"id\": \"custom.width\",\n+                \"value\": 216\n               }\n             ]\n           }\n@@ -143,12 +155,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n-            \"type\": \"grafana-postgresql-datasource\"\n+            \"default\": true,\n+            \"type\": \"grafana-postgresql-datasource\",\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT commit_id as commit_id, commit_message, gpu_name, created_at AS date FROM benchmarks WHERE branch = '${branch}' ORDER BY benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT commit_id, commit_message, metadata->>'gpu_name' as gpu_name, metadata->>'model_id' as model_id, created_at AS date FROM benchmarks WHERE branch = '${branch}' AND metadata->>'gpu_name' = '${gpu_name}' ORDER BY benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -306,13 +320,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'first_eager_forward_pass_time_secs' AS double precision) AS first_eager_forward_pass_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'first_eager_forward_pass_time_secs' AS double precision) AS first_eager_forward_pass_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -431,13 +446,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'second_eager_forward_pass_time_secs' AS double precision) AS second_eager_forward_pass_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'second_eager_forward_pass_time_secs' AS double precision) AS second_eager_forward_pass_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -565,13 +581,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_first_token_secs' AS double precision) AS time_to_first_token_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_first_token_secs' AS double precision) AS time_to_first_token_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -686,13 +703,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_second_token_secs' AS double precision) AS time_to_second_token_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_second_token_secs' AS double precision) AS time_to_second_token_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -807,13 +825,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_third_token_secs' AS double precision) AS time_to_third_token_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_third_token_secs' AS double precision) AS time_to_third_token_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -928,13 +947,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_next_token_mean_secs' AS double precision) AS time_to_next_token_mean_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'time_to_next_token_mean_secs' AS double precision) AS time_to_next_token_mean_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -1062,13 +1082,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'first_compile_generate_time_secs' AS double precision) AS first_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'first_compile_generate_time_secs' AS double precision) AS first_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -1183,13 +1204,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'second_compile_generate_time_secs' AS double precision) AS second_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'second_compile_generate_time_secs' AS double precision) AS second_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -1304,13 +1326,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'third_compile_generate_time_secs' AS double precision) AS third_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'third_compile_generate_time_secs' AS double precision) AS third_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -1425,13 +1448,14 @@\n       \"targets\": [\n         {\n           \"datasource\": {\n+            \"default\": true,\n             \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"bdz2yss7sxo1sc\"\n+            \"uid\": \"be28nkzirtb0gd\"\n           },\n           \"editorMode\": \"code\",\n           \"format\": \"table\",\n           \"rawQuery\": true,\n-          \"rawSql\": \"SELECT CAST(m.measurements->'fourth_compile_generate_time_secs' AS double precision) AS fourth_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND gpu_name = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n+          \"rawSql\": \"SELECT CAST(m.measurements->'fourth_compile_generate_time_secs' AS double precision) AS fourth_compile_generate_time_secs, left(b.commit_id, 7), m.time FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id WHERE b.branch = '${branch}' AND b.metadata->>'gpu_name' = '${gpu_name}' ORDER BY b.benchmark_id DESC LIMIT ${last_n_commits};\",\n           \"refId\": \"A\",\n           \"sql\": {\n             \"columns\": [\n@@ -1480,11 +1504,7 @@\n       \"id\": 15,\n       \"panels\": [\n         {\n-          \"datasource\": {\n-            \"default\": true,\n-            \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"be28nkzirtb0gd\"\n-          },\n+          \"datasource\": {},\n           \"fieldConfig\": {\n             \"defaults\": {\n               \"color\": {\n@@ -1528,8 +1548,7 @@\n                 \"mode\": \"absolute\",\n                 \"steps\": [\n                   {\n-                    \"color\": \"green\",\n-                    \"value\": null\n+                    \"color\": \"green\"\n                   },\n                   {\n                     \"color\": \"red\",\n@@ -1563,8 +1582,9 @@\n           \"targets\": [\n             {\n               \"datasource\": {\n+                \"default\": true,\n                 \"type\": \"grafana-postgresql-datasource\",\n-                \"uid\": \"bdz2yss7sxo1sc\"\n+                \"uid\": \"be28nkzirtb0gd\"\n               },\n               \"editorMode\": \"code\",\n               \"format\": \"table\",\n@@ -1665,11 +1685,7 @@\n           \"type\": \"timeseries\"\n         },\n         {\n-          \"datasource\": {\n-            \"default\": true,\n-            \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"be28nkzirtb0gd\"\n-          },\n+          \"datasource\": {},\n           \"fieldConfig\": {\n             \"defaults\": {\n               \"color\": {\n@@ -1713,8 +1729,7 @@\n                 \"mode\": \"absolute\",\n                 \"steps\": [\n                   {\n-                    \"color\": \"green\",\n-                    \"value\": null\n+                    \"color\": \"green\"\n                   },\n                   {\n                     \"color\": \"red\",\n@@ -1748,8 +1763,9 @@\n           \"targets\": [\n             {\n               \"datasource\": {\n+                \"default\": true,\n                 \"type\": \"grafana-postgresql-datasource\",\n-                \"uid\": \"bdz2yss7sxo1sc\"\n+                \"uid\": \"be28nkzirtb0gd\"\n               },\n               \"editorMode\": \"code\",\n               \"format\": \"table\",\n@@ -1850,11 +1866,7 @@\n           \"type\": \"timeseries\"\n         },\n         {\n-          \"datasource\": {\n-            \"default\": true,\n-            \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"be28nkzirtb0gd\"\n-          },\n+          \"datasource\": {},\n           \"fieldConfig\": {\n             \"defaults\": {\n               \"color\": {\n@@ -1898,8 +1910,7 @@\n                 \"mode\": \"absolute\",\n                 \"steps\": [\n                   {\n-                    \"color\": \"green\",\n-                    \"value\": null\n+                    \"color\": \"green\"\n                   },\n                   {\n                     \"color\": \"red\",\n@@ -1933,8 +1944,9 @@\n           \"targets\": [\n             {\n               \"datasource\": {\n+                \"default\": true,\n                 \"type\": \"grafana-postgresql-datasource\",\n-                \"uid\": \"bdz2yss7sxo1sc\"\n+                \"uid\": \"be28nkzirtb0gd\"\n               },\n               \"editorMode\": \"code\",\n               \"format\": \"table\",\n@@ -2035,11 +2047,7 @@\n           \"type\": \"timeseries\"\n         },\n         {\n-          \"datasource\": {\n-            \"default\": true,\n-            \"type\": \"grafana-postgresql-datasource\",\n-            \"uid\": \"be28nkzirtb0gd\"\n-          },\n+          \"datasource\": {},\n           \"fieldConfig\": {\n             \"defaults\": {\n               \"color\": {\n@@ -2083,8 +2091,7 @@\n                 \"mode\": \"absolute\",\n                 \"steps\": [\n                   {\n-                    \"color\": \"green\",\n-                    \"value\": null\n+                    \"color\": \"green\"\n                   },\n                   {\n                     \"color\": \"red\",\n@@ -2118,8 +2125,9 @@\n           \"targets\": [\n             {\n               \"datasource\": {\n+                \"default\": true,\n                 \"type\": \"grafana-postgresql-datasource\",\n-                \"uid\": \"bdz2yss7sxo1sc\"\n+                \"uid\": \"be28nkzirtb0gd\"\n               },\n               \"editorMode\": \"code\",\n               \"format\": \"table\",\n@@ -2224,7 +2232,6 @@\n       \"type\": \"row\"\n     }\n   ],\n-  \"refresh\": \"\",\n   \"schemaVersion\": 39,\n   \"tags\": [],\n   \"templating\": {\n@@ -2236,6 +2243,7 @@\n           \"value\": \"main\"\n         },\n         \"datasource\": {\n+          \"default\": true,\n           \"type\": \"grafana-postgresql-datasource\",\n           \"uid\": \"be28nkzirtb0gd\"\n         },\n@@ -2248,7 +2256,7 @@\n         \"name\": \"branch\",\n         \"options\": [],\n         \"query\": \"SELECT DISTINCT branch FROM benchmarks;\",\n-        \"refresh\": 2,\n+        \"refresh\": 1,\n         \"regex\": \"\",\n         \"skipUrlSync\": false,\n         \"sort\": 0,\n@@ -2261,6 +2269,7 @@\n           \"value\": \"1729701492845\"\n         },\n         \"datasource\": {\n+          \"default\": true,\n           \"type\": \"grafana-postgresql-datasource\",\n           \"uid\": \"be28nkzirtb0gd\"\n         },\n@@ -2281,10 +2290,11 @@\n       {\n         \"current\": {\n           \"selected\": false,\n-          \"text\": \"1730120430069\",\n-          \"value\": \"1730120430069\"\n+          \"text\": \"1730393397577\",\n+          \"value\": \"1730393397577\"\n         },\n         \"datasource\": {\n+          \"default\": true,\n           \"type\": \"grafana-postgresql-datasource\",\n           \"uid\": \"be28nkzirtb0gd\"\n         },\n@@ -2312,23 +2322,24 @@\n           \"type\": \"grafana-postgresql-datasource\",\n           \"uid\": \"be28nkzirtb0gd\"\n         },\n-        \"definition\": \"SELECT DISTINCT gpu_name FROM benchmarks;\",\n+        \"definition\": \"SELECT DISTINCT metadata->>'gpu_name' FROM benchmarks;\",\n+        \"description\": \"\",\n         \"hide\": 0,\n         \"includeAll\": false,\n         \"label\": \"GPU\",\n         \"multi\": false,\n         \"name\": \"gpu_name\",\n         \"options\": [],\n-        \"query\": \"SELECT DISTINCT gpu_name FROM benchmarks;\",\n-        \"refresh\": 2,\n+        \"query\": \"SELECT DISTINCT metadata->>'gpu_name' FROM benchmarks;\",\n+        \"refresh\": 1,\n         \"regex\": \"\",\n         \"skipUrlSync\": false,\n         \"sort\": 0,\n         \"type\": \"query\"\n       },\n       {\n         \"current\": {\n-          \"selected\": false,\n+          \"selected\": true,\n           \"text\": \"10\",\n           \"value\": \"10\"\n         },\n@@ -2359,6 +2370,6 @@\n   \"timezone\": \"browser\",\n   \"title\": \"Transformers benchmarks\",\n   \"uid\": \"fdz33iyzln9c0a\",\n-  \"version\": 4,\n+  \"version\": 10,\n   \"weekStart\": \"\"\n }"
        },
        {
            "sha": "25f36254104ab5047fd36ddf00ebcde7289849a7",
            "filename": "benchmark/grafana_datasource.yaml",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fgrafana_datasource.yaml",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fgrafana_datasource.yaml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fgrafana_datasource.yaml?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -0,0 +1,17 @@\n+apiVersion: 1\n+datasources:\n+  - name: grafana-postgresql-datasource\n+    uid: be28nkzirtb0gd\n+    type: postgres\n+    url: $GRAFANA_POSTGRES_DATASOURCE_URL\n+    user: $GRAFANA_POSTGRES_DATASOURCE_USER\n+    secureJsonData:\n+      password: $GRAFANA_POSTGRES_DATASOURCE_PWD\n+    jsonData:\n+      database: metrics\n+      maxOpenConns: 100\n+      maxIdleConns: 100\n+      maxIdleConnsAuto: true\n+      connMaxLifetime: 14400\n+      postgresVersion: 1000\n+      timescaledb: false"
        },
        {
            "sha": "a7864c4af183b6ac26a8ac5dc623282e94b44c91",
            "filename": "benchmark/init_db.sql",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Finit_db.sql",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Finit_db.sql",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Finit_db.sql?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -3,7 +3,7 @@ CREATE TABLE IF NOT EXISTS benchmarks (\n   branch VARCHAR(255),\n   commit_id VARCHAR(72),\n   commit_message VARCHAR(70),\n-  gpu_name VARCHAR(255),\n+  metadata jsonb,\n   created_at timestamp without time zone NOT NULL DEFAULT (current_timestamp AT TIME ZONE 'UTC')\n );\n "
        },
        {
            "sha": "bbe1afefd5ef1bef9c9b38a74597a301cf8abb3a",
            "filename": "benchmark/llama.py",
            "status": "modified",
            "additions": 34,
            "deletions": 100,
            "changes": 134,
            "blob_url": "https://github.com/huggingface/transformers/blob/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fllama.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9a94dfe1239ddfb8010a654aa1e677d56c01eee0/benchmark%2Fllama.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fllama.py?ref=9a94dfe1239ddfb8010a654aa1e677d56c01eee0",
            "patch": "@@ -1,127 +1,75 @@\n-import argparse\n-import json\n-import logging\n+from logging import Logger\n import os\n-import sys\n-from statistics import mean\n from threading import Event, Thread\n from time import perf_counter, sleep\n from typing import Optional\n+from benchmarks_entrypoint import MetricsRecorder\n import gpustat\n import psutil\n import psycopg2\n import torch\n \n from transformers import AutoModelForCausalLM, AutoTokenizer, GenerationConfig, StaticCache\n-from psycopg2.extras import Json\n-from psycopg2.extensions import register_adapter\n \n \n os.environ[\"HF_HUB_ENABLE_HF_TRANSFER\"] = \"1\"\n \n-logger = logging.getLogger(__name__)\n-logger.setLevel(logging.INFO)\n-\n-handler = logging.StreamHandler(sys.stdout)\n-handler.setLevel(logging.INFO)\n-formatter = logging.Formatter(\"[%(levelname)s - %(asctime)s] %(message)s\")\n-handler.setFormatter(formatter)\n-logger.addHandler(handler)\n-\n os.environ[\"TOKENIZERS_PARALLELISM\"] = \"1\"\n torch.set_float32_matmul_precision(\"high\")\n-register_adapter(dict, Json)\n-\n-\n-def parse_arguments():\n-    \"\"\"\n-    Parse command line arguments for the benchmarking CLI.\n-    \"\"\"\n-    parser = argparse.ArgumentParser(description=\"CLI for benchmarking the huggingface/transformers.\")\n-\n-    parser.add_argument(\n-        \"branch\",\n-        type=str,\n-        help=\"The branch name on which the benchmarking is performed.\",\n-    )\n-\n-    parser.add_argument(\n-        \"commit_id\",\n-        type=str,\n-        help=\"The commit hash on which the benchmarking is performed.\",\n-    )\n \n-    parser.add_argument(\n-        \"commit_msg\",\n-        type=str,\n-        help=\"The commit message associated with the commit, truncated to 70 characters.\",\n-    )\n \n-    args = parser.parse_args()\n-\n-    return args.branch, args.commit_id, args.commit_msg\n-\n-\n-def collect_metrics(benchmark_id, continue_metric_collection):\n+def collect_metrics(benchmark_id, continue_metric_collection, metrics_recorder):\n     p = psutil.Process(os.getpid())\n-    conn = psycopg2.connect(\"dbname=metrics\")\n-    cur = conn.cursor()\n     while not continue_metric_collection.is_set():\n         with p.oneshot():\n             cpu_util = p.cpu_percent()\n             mem_megabytes = p.memory_info().rss / (1024 * 1024)\n         gpu_stats = gpustat.GPUStatCollection.new_query()\n         gpu_util = gpu_stats[0][\"utilization.gpu\"]\n         gpu_mem_megabytes = gpu_stats[0][\"memory.used\"]\n-        cur.execute(\n-            \"INSERT INTO device_measurements (benchmark_id, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes) VALUES (%s, %s, %s, %s, %s)\",\n-            (benchmark_id, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes),\n+        metrics_recorder.collect_device_measurements(\n+            benchmark_id, cpu_util, mem_megabytes, gpu_util, gpu_mem_megabytes\n         )\n         sleep(0.01)\n-        conn.commit()\n-    conn.close()\n \n \n-def run_benchmark(branch: str, commit_id: str, commit_msg: str, num_tokens_to_generate=100):\n+def run_benchmark(logger: Logger, branch: str, commit_id: str, commit_msg: str, num_tokens_to_generate=100):\n     continue_metric_collection = Event()\n     metrics_thread = None\n+    model_id = \"meta-llama/Llama-2-7b-hf\"\n+    metrics_recorder = MetricsRecorder(psycopg2.connect(\"dbname=metrics\"), logger, branch, commit_id, commit_msg)\n     try:\n         gpu_stats = gpustat.GPUStatCollection.new_query()\n         gpu_name = gpu_stats[0][\"name\"]\n-        conn = psycopg2.connect(\"dbname=metrics\")\n-        cur = conn.cursor()\n-        cur.execute(\n-            \"INSERT INTO benchmarks (branch, commit_id, commit_message, gpu_name) VALUES (%s, %s, %s, %s) RETURNING benchmark_id\",\n-            (branch, commit_id, commit_msg, gpu_name),\n+        benchmark_id = metrics_recorder.initialise_benchmark({\"gpu_name\": gpu_name, \"model_id\": model_id})\n+        logger.info(f\"running benchmark #{benchmark_id} on {gpu_name} for {model_id}\")\n+        metrics_thread = Thread(\n+            target=collect_metrics,\n+            args=[benchmark_id, continue_metric_collection, metrics_recorder],\n         )\n-        conn.commit()\n-        benchmark_id = cur.fetchone()[0]\n-        logger.info(f\"running benchmark #{benchmark_id} on {gpu_name}\")\n-        metrics_thread = Thread(target=collect_metrics, args=[benchmark_id, continue_metric_collection])\n         metrics_thread.start()\n         logger.info(\"started background thread to fetch device metrics\")\n \n         os.environ[\"TOKENIZERS_PARALLELISM\"] = \"false\"  # silence warnings when compiling\n \n         device = \"cuda\"\n-        ckpt = \"meta-llama/Llama-2-7b-hf\"\n \n         logger.info(\"downloading weights\")\n         # This is to avoid counting download in model load time measurement\n-        model = AutoModelForCausalLM.from_pretrained(ckpt, torch_dtype=torch.float16)\n+        model = AutoModelForCausalLM.from_pretrained(model_id, torch_dtype=torch.float16)\n         gen_config = GenerationConfig(do_sample=False, top_p=1, temperature=1)\n         logger.info(\"loading model\")\n         start = perf_counter()\n         model = AutoModelForCausalLM.from_pretrained(\n-            ckpt, torch_dtype=torch.float16, generation_config=gen_config\n+            model_id, torch_dtype=torch.float16, generation_config=gen_config\n         ).eval()\n         model.to(device)\n         torch.cuda.synchronize()\n         end = perf_counter()\n         model_load_time = end - start\n         logger.info(f\"loaded model in: {model_load_time}s\")\n \n-        tokenizer = AutoTokenizer.from_pretrained(ckpt)\n+        tokenizer = AutoTokenizer.from_pretrained(model_id)\n \n         prompt = \"Why dogs are so cute?\"\n         inputs = tokenizer(prompt, return_tensors=\"pt\").to(device)\n@@ -368,41 +316,27 @@ def decode_one_token(model, cur_token, cache_position, past_key_values):\n             logger.info(f\"completed second compile generation in: {fourth_compile_generate_time}s\")\n             logger.info(f\"generated: {tokenizer.batch_decode(output.cpu().tolist())}\")\n \n-        cur.execute(\n-            \"\"\"\n-            INSERT INTO model_measurements (\n-                benchmark_id,\n-                measurements\n-            ) VALUES (%s, %s)\n-            \"\"\",\n-            (\n-                benchmark_id,\n-                {\n-                    \"model_load_time\": model_load_time,\n-                    \"first_eager_forward_pass_time_secs\": first_eager_fwd_pass_time,\n-                    \"second_eager_forward_pass_time_secs\": second_eager_fwd_pass_time,\n-                    \"first_eager_generate_time_secs\": first_eager_generate_time,\n-                    \"second_eager_generate_time_secs\": second_eager_generate_time,\n-                    \"time_to_first_token_secs\": time_to_first_token,\n-                    \"time_to_second_token_secs\": time_to_second_token,\n-                    \"time_to_third_token_secs\": time_to_third_token,\n-                    \"time_to_next_token_mean_secs\": mean_time_to_next_token,\n-                    \"first_compile_generate_time_secs\": first_compile_generate_time,\n-                    \"second_compile_generate_time_secs\": second_compile_generate_time,\n-                    \"third_compile_generate_time_secs\": third_compile_generate_time,\n-                    \"fourth_compile_generate_time_secs\": fourth_compile_generate_time,\n-                },\n-            ),\n+        metrics_recorder.collect_model_measurements(\n+            benchmark_id,\n+            {\n+                \"model_load_time\": model_load_time,\n+                \"first_eager_forward_pass_time_secs\": first_eager_fwd_pass_time,\n+                \"second_eager_forward_pass_time_secs\": second_eager_fwd_pass_time,\n+                \"first_eager_generate_time_secs\": first_eager_generate_time,\n+                \"second_eager_generate_time_secs\": second_eager_generate_time,\n+                \"time_to_first_token_secs\": time_to_first_token,\n+                \"time_to_second_token_secs\": time_to_second_token,\n+                \"time_to_third_token_secs\": time_to_third_token,\n+                \"time_to_next_token_mean_secs\": mean_time_to_next_token,\n+                \"first_compile_generate_time_secs\": first_compile_generate_time,\n+                \"second_compile_generate_time_secs\": second_compile_generate_time,\n+                \"third_compile_generate_time_secs\": third_compile_generate_time,\n+                \"fourth_compile_generate_time_secs\": fourth_compile_generate_time,\n+            },\n         )\n-        conn.commit()\n-        conn.close()\n     except Exception as e:\n         logger.error(f\"Caught exception: {e}\")\n     continue_metric_collection.set()\n     if metrics_thread is not None:\n         metrics_thread.join()\n-\n-\n-if __name__ == \"__main__\":\n-    branch, commit_id, commit_msg = parse_arguments()\n-    run_benchmark(branch, commit_id, commit_msg, num_tokens_to_generate=20)\n+    metrics_recorder.close()"
        }
    ],
    "stats": {
        "total": 503,
        "additions": 334,
        "deletions": 169
    }
}