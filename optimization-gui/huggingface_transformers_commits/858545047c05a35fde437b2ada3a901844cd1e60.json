{
    "author": "gante",
    "message": "[`HybridCache`] disable automatic compilation (#36620)",
    "sha": "858545047c05a35fde437b2ada3a901844cd1e60",
    "files": [
        {
            "sha": "94a68bf0df70fba3f85c9063f94aa764c3601e3b",
            "filename": "src/transformers/cache_utils.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/858545047c05a35fde437b2ada3a901844cd1e60/src%2Ftransformers%2Fcache_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/858545047c05a35fde437b2ada3a901844cd1e60/src%2Ftransformers%2Fcache_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcache_utils.py?ref=858545047c05a35fde437b2ada3a901844cd1e60",
            "patch": "@@ -1602,7 +1602,9 @@ class HybridCache(Cache):\n         ```\n     \"\"\"\n \n-    is_compileable = True\n+    # TODO (joao): dive deeper into gemma2 and paligemma -- there are reports of speed loss with compilation. Revert\n+    # ALL changes from the PR that commented the line below when reactivating it.\n+    # is_compileable = True\n \n     # TODO (joao): remove `=None` in non-optional arguments in v4.46. Remove from `OBJECTS_TO_IGNORE` as well.\n     @deprecate_kwarg(\"layer_device_map\", version=\"4.52.0\")"
        },
        {
            "sha": "3a4171161f5088a441bdaf2b277db0094b53d443",
            "filename": "tests/generation/test_utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/858545047c05a35fde437b2ada3a901844cd1e60/tests%2Fgeneration%2Ftest_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/858545047c05a35fde437b2ada3a901844cd1e60/tests%2Fgeneration%2Ftest_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fgeneration%2Ftest_utils.py?ref=858545047c05a35fde437b2ada3a901844cd1e60",
            "patch": "@@ -2118,6 +2118,9 @@ def test_generate_compile_model_forward(self):\n         Tests that `.generate` is compatible with torch.compile without graph breaks, keeping the same results.\n         ⚠️ Runs two sequential generations to ensure the cache doesn't get stuck after the first compiled run! ⚠️\n         \"\"\"\n+        # Monkey-patching the HybridCache at test-time to continue testing compilation support\n+        HybridCache.is_compileable = True\n+\n         for model_class in self.all_generative_model_classes:\n             if not model_class._supports_static_cache:\n                 self.skipTest(\"This model doesn't support static cache (= no expectations of compilation support)\")\n@@ -2214,6 +2217,9 @@ def test_generate_compilation_all_outputs(self):\n         Tests that all optional outputs are behaving as expected when compilation is triggered.\n         In essence, it's the same as `test_greedy_generate_dict_outputs`, but with automatic compilation triggered.\n         \"\"\"\n+        # Monkey-patching the HybridCache at test-time to continue testing compilation support\n+        HybridCache.is_compileable = True\n+\n         for model_class in self.all_generative_model_classes:\n             if not model_class._supports_static_cache:\n                 self.skipTest(\"This model doesn't support static cache (= no expectations of compilation support)\")"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}