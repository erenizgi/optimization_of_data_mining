{
    "author": "ydshieh",
    "message": "Update CI with nightly torch workflow file (#40306)\n\n* fix nightly ci\n\n* Apply suggestions from code review\n\nCo-authored-by: ivarflakstad <69173633+ivarflakstad@users.noreply.github.com>\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\nCo-authored-by: ivarflakstad <69173633+ivarflakstad@users.noreply.github.com>",
    "sha": "5d906740d2109f04be34f90ce3cff05ef412c7c1",
    "files": [
        {
            "sha": "2214ef6c438712356d051d62bce7df1949ebdccc",
            "filename": ".github/workflows/check_failed_tests.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fcheck_failed_tests.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fcheck_failed_tests.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fcheck_failed_tests.yml?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -21,6 +21,9 @@ on:\n       report_repo_id:\n         required: true\n         type: string\n+      commit_sha:\n+        required: false\n+        type: string\n \n \n env:\n@@ -87,7 +90,7 @@ jobs:\n       - name: Update clone\n         working-directory: /transformers\n         if: ${{ env.process == 'true' }}\n-        run: git fetch && git checkout ${{ github.sha }}\n+        run: git fetch && git checkout ${{ inputs.commit_sha || github.sha }}\n \n       - name: Get target commit\n         working-directory: /transformers/utils"
        },
        {
            "sha": "6ca019e7c93f9cd23057c34df49f1d5fb861bbd4",
            "filename": ".github/workflows/model_jobs.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fmodel_jobs.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fmodel_jobs.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fmodel_jobs.yml?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -18,6 +18,9 @@ on:\n       docker:\n         required: true\n         type: string\n+      commit_sha:\n+        required: false\n+        type: string\n       report_name_prefix:\n         required: false\n         default: run_models_gpu\n@@ -70,7 +73,7 @@ jobs:\n \n       - name: Update clone\n         working-directory: /transformers\n-        run: git fetch && git checkout ${{ github.sha }}\n+        run: git fetch && git checkout ${{ inputs.commit_sha || github.sha }}\n \n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: /transformers"
        },
        {
            "sha": "6192c8039fc9d80dd49903c078d66350ecdb2ba9",
            "filename": ".github/workflows/self-nightly-caller.yml",
            "status": "modified",
            "additions": 13,
            "deletions": 24,
            "changes": 37,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fself-nightly-caller.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fself-nightly-caller.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-nightly-caller.yml?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -1,43 +1,32 @@\n-name: Self-hosted runner (nightly-ci)\n-\n+name: Nvidia CI with nightly torch\n \n on:\n   repository_dispatch:\n-  schedule:\n-    - cron: \"17 2 * * *\"\n+  # triggered when the daily scheduled Nvidia CI is completed.\n+  # This way, we can compare the results more easily.\n+  workflow_run:\n+    workflows: [\"Nvidia CI\"]\n+    branches: [\"main\"]\n+    types: [completed]\n   push:\n     branches:\n-      - run_nightly_ci*\n+      - run_ci_with_nightly_torch*\n \n jobs:\n-  build_nightly_ci_images:\n-    name: Build Nightly CI Docker Images\n-    if: (github.event_name == 'schedule') || ((github.event_name == 'push') && startsWith(github.ref_name, 'run_nightly_ci'))\n+  build_nightly_torch_ci_images:\n+    name: Build CI Docker Images with nightly torch\n     uses: ./.github/workflows/build-nightly-ci-docker-images.yml\n     secrets: inherit\n \n   model-ci:\n     name: Model CI\n-    needs: [build_nightly_ci_images]\n+    needs: build_nightly_torch_ci_images\n     uses: ./.github/workflows/self-scheduled.yml\n     with:\n       job: run_models_gpu\n       slack_report_channel: \"#transformers-ci-past-future\"\n-      runner: ci\n       docker: huggingface/transformers-all-latest-torch-nightly-gpu\n       ci_event: Nightly CI\n-    secrets: inherit\n-\n-  deepspeed-ci:\n-    name: DeepSpeed CI\n-    needs: [build_nightly_ci_images]\n-    uses: ./.github/workflows/self-scheduled.yml\n-    with:\n-      job: run_torch_cuda_extensions_gpu\n-      slack_report_channel: \"#transformers-ci-past-future\"\n-      runner: ci\n-      # test deepspeed nightly build with the latest release torch\n-      docker: huggingface/transformers-pytorch-deepspeed-latest-gpu\n-      ci_event: Nightly CI\n-      working-directory-prefix: /workspace\n+      report_repo_id: hf-internal-testing/transformers_daily_ci_with_torch_nightly\n+      commit_sha: ${{ github.event.workflow_run.head_sha || github.sha }}\n     secrets: inherit"
        },
        {
            "sha": "d709c562251e02726e87bfb933816b245c138286",
            "filename": ".github/workflows/self-scheduled-caller.yml",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fself-scheduled-caller.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fself-scheduled-caller.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-scheduled-caller.yml?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -1,13 +1,12 @@\n-name: Self-hosted runner (scheduled)\n-\n+name: Nvidia CI\n \n on:\n   repository_dispatch:\n   schedule:\n     - cron: \"17 2 * * *\"\n   push:\n     branches:\n-      - run_scheduled_ci*\n+      - run_nvidia_ci*\n   workflow_dispatch:\n     inputs:\n       prev_workflow_run_id:\n@@ -54,6 +53,7 @@ jobs:\n       docker: huggingface/transformers-all-latest-gpu\n       ci_event: Daily CI\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n+      commit_sha: ${{ github.sha }}\n     secrets: inherit\n \n   torch-pipeline:\n@@ -65,6 +65,7 @@ jobs:\n       docker: huggingface/transformers-pytorch-gpu\n       ci_event: Daily CI\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n+      commit_sha: ${{ github.sha }}\n     secrets: inherit\n \n   example-ci:\n@@ -76,6 +77,7 @@ jobs:\n       docker: huggingface/transformers-all-latest-gpu\n       ci_event: Daily CI\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n+      commit_sha: ${{ github.sha }}\n     secrets: inherit\n \n   trainer-fsdp-ci:\n@@ -87,6 +89,7 @@ jobs:\n       docker: huggingface/transformers-all-latest-gpu\n       ci_event: Daily CI\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n+      commit_sha: ${{ github.sha }}\n     secrets: inherit\n \n   deepspeed-ci:\n@@ -99,6 +102,7 @@ jobs:\n       ci_event: Daily CI\n       working-directory-prefix: /workspace\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n+      commit_sha: ${{ github.sha }}\n     secrets: inherit\n \n   quantization-ci:\n@@ -110,4 +114,5 @@ jobs:\n       docker: huggingface/transformers-quantization-latest-gpu\n       ci_event: Daily CI\n       report_repo_id: hf-internal-testing/transformers_daily_ci\n+      commit_sha: ${{ github.sha }}\n     secrets: inherit"
        },
        {
            "sha": "b5f6685d30e78338641d2bb6ba1bf27004ef9e80",
            "filename": ".github/workflows/self-scheduled.yml",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fself-scheduled.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fself-scheduled.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-scheduled.yml?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -1,4 +1,4 @@\n-name: Self-hosted runner (scheduled)\n+name: Nvidia CI (job definitions)\n \n # Note that each job's dependencies go into a corresponding docker file.\n #\n@@ -28,6 +28,9 @@ on:\n       report_repo_id:\n         required: true\n         type: string\n+      commit_sha:\n+        required: false\n+        type: string\n \n \n env:\n@@ -46,8 +49,8 @@ env:\n \n jobs:\n   setup:\n-    if: contains(fromJSON('[\"run_models_gpu\", \"run_trainer_and_fsdp_gpu\", \"run_quantization_torch_gpu\"]'), inputs.job)\n     name: Setup\n+    if: contains(fromJSON('[\"run_models_gpu\", \"run_trainer_and_fsdp_gpu\", \"run_quantization_torch_gpu\"]'), inputs.job)\n     strategy:\n       matrix:\n         machine_type: [aws-g5-4xlarge-cache, aws-g5-12xlarge-cache]\n@@ -119,6 +122,7 @@ jobs:\n       slice_id: ${{ matrix.slice_id }}\n       runner_map: ${{ needs.setup.outputs.runner_map }}\n       docker: ${{ inputs.docker }}\n+      commit_sha: ${{ inputs.commit_sha || github.sha }}\n     secrets: inherit\n \n   run_trainer_and_fsdp_gpu:\n@@ -137,6 +141,7 @@ jobs:\n       slice_id: ${{ matrix.slice_id }}\n       runner_map: ${{ needs.setup.outputs.runner_map }}\n       docker: ${{ inputs.docker }}\n+      commit_sha: ${{ inputs.commit_sha || github.sha }}\n       report_name_prefix: run_trainer_and_fsdp_gpu\n     secrets: inherit\n \n@@ -155,7 +160,7 @@ jobs:\n     steps:\n       - name: Update clone\n         working-directory: /transformers\n-        run: git fetch && git checkout ${{ github.sha }}\n+        run: git fetch && git checkout ${{ inputs.commit_sha || github.sha }}\n \n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: /transformers\n@@ -223,7 +228,7 @@ jobs:\n     steps:\n       - name: Update clone\n         working-directory: /transformers\n-        run: git fetch && git checkout ${{ github.sha }}\n+        run: git fetch && git checkout ${{ inputs.commit_sha || github.sha }}\n \n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: /transformers\n@@ -292,7 +297,7 @@ jobs:\n     steps:\n       - name: Update clone\n         working-directory: ${{ inputs.working-directory-prefix }}/transformers\n-        run: git fetch && git checkout ${{ github.sha }}\n+        run: git fetch && git checkout ${{ inputs.commit_sha || github.sha }}\n \n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: ${{ inputs.working-directory-prefix }}/transformers\n@@ -400,7 +405,7 @@ jobs:\n \n       - name: Update clone\n         working-directory: /transformers\n-        run: git fetch && git checkout ${{ github.sha }}\n+        run: git fetch && git checkout ${{ inputs.commit_sha || github.sha }}\n \n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: /transformers\n@@ -464,6 +469,7 @@ jobs:\n         uses: actions/checkout@v4\n         with:\n           fetch-depth: 2\n+          ref: ${{ inputs.commit_sha || github.sha }}\n \n       - name: Install transformers\n         run: pip install transformers\n@@ -518,6 +524,7 @@ jobs:\n       quantization_matrix: ${{ needs.setup.outputs.quantization_matrix }}\n       ci_event: ${{ inputs.ci_event }}\n       report_repo_id: ${{ inputs.report_repo_id }}\n+      commit_sha: ${{ inputs.commit_sha || github.sha }}\n \n     secrets: inherit\n \n@@ -528,7 +535,7 @@ jobs:\n     uses: ./.github/workflows/check_failed_tests.yml\n     with:\n       docker: ${{ inputs.docker }}\n-      start_sha: ${{ github.sha }}\n+      start_sha: ${{ inputs.commit_sha || github.sha }}\n       job: ${{ inputs.job }}\n       slack_report_channel: ${{ inputs.slack_report_channel }}\n       ci_event: ${{ inputs.ci_event }}"
        },
        {
            "sha": "88da4e38d4dc7ee77b7a382eb62144cbeb2539df",
            "filename": ".github/workflows/slack-report.yml",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fslack-report.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/.github%2Fworkflows%2Fslack-report.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fslack-report.yml?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -24,6 +24,10 @@ on:\n       report_repo_id:\n         required: true\n         type: string\n+      commit_sha:\n+        required: false\n+        type: string\n+\n \n env:\n   TRANSFORMERS_CI_RESULTS_UPLOAD_TOKEN: ${{ secrets.TRANSFORMERS_CI_RESULTS_UPLOAD_TOKEN }}\n@@ -41,6 +45,10 @@ jobs:\n           echo \"Setup status: ${{ inputs.setup_status }}\"\n \n       - uses: actions/checkout@v4\n+        with:\n+          fetch-depth: 2\n+          ref: ${{ inputs.commit_sha || github.sha }}\n+\n       - uses: actions/download-artifact@v4\n \n       - name: Prepare some setup values\n@@ -67,7 +75,7 @@ jobs:\n           SLACK_REPORT_CHANNEL: ${{ inputs.slack_report_channel }}\n           ACCESS_REPO_INFO_TOKEN: ${{ secrets.ACCESS_REPO_INFO_TOKEN }}\n           CI_EVENT: ${{ inputs.ci_event }}\n-          CI_SHA: ${{ github.sha }}\n+          CI_SHA: ${{ inputs.commit_sha || github.sha }}\n           CI_TEST_JOB: ${{ inputs.job }}\n           SETUP_STATUS: ${{ inputs.setup_status }}\n           REPORT_REPO_ID: ${{ inputs.report_repo_id }}"
        },
        {
            "sha": "b6d4e8b84c72677338a7b255cfc7f890ddb0c32a",
            "filename": "utils/notification_service.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/5d906740d2109f04be34f90ce3cff05ef412c7c1/utils%2Fnotification_service.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5d906740d2109f04be34f90ce3cff05ef412c7c1/utils%2Fnotification_service.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fnotification_service.py?ref=5d906740d2109f04be34f90ce3cff05ef412c7c1",
            "patch": "@@ -669,7 +669,7 @@ def payload(self) -> str:\n                         \"text\": {\n                             \"type\": \"mrkdwn\",\n                             # TODO: We should NOT assume it's always Nvidia CI, but it's the case at this moment.\n-                            \"text\": f\"*There are {nb_new_failed_tests} failed tests unique to {'this run' if not is_amd_daily_ci_workflow else 'AMD'}*\\n\\n(compared to Nvidia CI: <https://github.com/huggingface/transformers/actions/runs/{prev_workflow_run_id}|{prev_workflow_run_id}>)\",\n+                            \"text\": f\"*There are {nb_new_failed_tests} failed tests unique to this run*\\n\\n(compared to{' Nvidia CI ' if is_scheduled_ci_run else ' '}run: <https://github.com/huggingface/transformers/actions/runs/{prev_workflow_run_id}|{prev_workflow_run_id}>)\",\n                         },\n                         \"accessory\": {\n                             \"type\": \"button\",\n@@ -1406,13 +1406,13 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n     is_scheduled_ci_run = os.environ.get(\"GITHUB_EVENT_NAME\") == \"schedule\"\n     # For AMD workflow runs: the different AMD CI callers (MI210/MI250/MI300, etc.) are triggered by `workflow_run`\n     #  event of `.github/workflows/self-scheduled-amd-caller.yml`.\n-    if is_amd_daily_ci_workflow:\n+    if os.environ.get(\"GITHUB_EVENT_NAME\") == \"workflow_run\":\n         # Get the path to the file on the runner that contains the full event webhook payload.\n         event_payload_path = os.environ.get(\"GITHUB_EVENT_PATH\")\n         # Load the event payload\n         with open(event_payload_path) as fp:\n             event_payload = json.load(fp)\n-            # The event that triggers the `workflow_run` event.\n+            # The event that triggers the original `workflow_run`.\n             if \"workflow_run\" in event_payload:\n                 is_scheduled_ci_run = event_payload[\"workflow_run\"][\"event\"] == \"schedule\"\n "
        }
    ],
    "stats": {
        "total": 95,
        "additions": 55,
        "deletions": 40
    }
}