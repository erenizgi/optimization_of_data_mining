{
    "author": "zucchini-nlp",
    "message": "[chat template] add a testcase for kwargs (#39415)\n\nadd a testcase",
    "sha": "d33a1c389f737a87471c64138be30bf5c59b5e8a",
    "files": [
        {
            "sha": "f67a9e49f92c75054bbf25185cb58b477c9a5b44",
            "filename": "tests/test_processing_common.py",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/huggingface/transformers/blob/d33a1c389f737a87471c64138be30bf5c59b5e8a/tests%2Ftest_processing_common.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/d33a1c389f737a87471c64138be30bf5c59b5e8a/tests%2Ftest_processing_common.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_processing_common.py?ref=d33a1c389f737a87471c64138be30bf5c59b5e8a",
            "patch": "@@ -1110,3 +1110,42 @@ def test_chat_template_audio_from_video(self):\n         self.assertEqual(len(out_dict[\"attention_mask\"]), 1)  # batch-size=1\n         self.assertEqual(len(out_dict[self.audio_input_name]), 1)  # 1 audio in the conversation\n         self.assertEqual(len(out_dict[self.videos_input_name]), 1)  # 1 video in the conversation\n+\n+    def test_chat_template_jinja_kwargs(self):\n+        \"\"\"Tests that users can pass any kwargs and they will be used in jinja templates.\"\"\"\n+        processor = self.get_processor()\n+        if processor.chat_template is None:\n+            self.skipTest(\"Processor has no chat template\")\n+\n+        messages = [\n+            {\n+                \"role\": \"user\",\n+                \"content\": [\n+                    {\"type\": \"text\", \"text\": \"Which of these animals is making the sound?\"},\n+                ],\n+            },\n+            {\n+                \"role\": \"assistant\",\n+                \"content\": [{\"type\": \"text\", \"text\": \"It is a cow.\"}],\n+            },\n+        ]\n+\n+        dummy_template = (\n+            \"{% for message in messages %}\"\n+            \"{% if add_system_prompt %}\"\n+            \"{{'You are a helpful assistant.'}}\"\n+            \"{% endif %}\"\n+            \"{% if (message['role'] != 'assistant') %}\"\n+            \"{{'<|special_start|>' + message['role'] + '\\n' + message['content'][0]['text'] + '<|special_end|>' + '\\n'}}\"\n+            \"{% elif (message['role'] == 'assistant')%}\"\n+            \"{{'<|special_start|>' + message['role'] + '\\n'}}\"\n+            \"{{message['content'][0]['text'] + '<|special_end|>' + '\\n'}}\"\n+            \"{% endif %}\"\n+            \"{% endfor %}\"\n+        )\n+\n+        formatted_prompt = processor.apply_chat_template(\n+            messages, add_system_prompt=True, tokenize=False, chat_template=dummy_template\n+        )\n+        expected_prompt = \"You are a helpful assistant.<|special_start|>user\\nWhich of these animals is making the sound?<|special_end|>\\nYou are a helpful assistant.<|special_start|>assistant\\nIt is a cow.<|special_end|>\\n\"\n+        self.assertEqual(formatted_prompt, expected_prompt)"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 39,
        "deletions": 0
    }
}