{
    "author": "n0gu-furiosa",
    "message": "Optimize `to_py_obj` for python-native numeric lists and scalars (#36885)\n\n* Optimize to_py_obj for python-native numeric lists and scalars\n\n* Fix bug that tuple is not converted to list\n\n* Try np.array for more robust type checking\n\n* Apply review and add tests for to_py_obj",
    "sha": "d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf",
    "files": [
        {
            "sha": "f17410a20daf431f59c5fa1c28326939fb99c791",
            "filename": "src/transformers/utils/generic.py",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/huggingface/transformers/blob/d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf/src%2Ftransformers%2Futils%2Fgeneric.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf/src%2Ftransformers%2Futils%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fgeneric.py?ref=d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf",
            "patch": "@@ -257,6 +257,18 @@ def to_py_obj(obj):\n     \"\"\"\n     Convert a TensorFlow tensor, PyTorch tensor, Numpy array or python list to a python list.\n     \"\"\"\n+    if isinstance(obj, (int, float)):\n+        return obj\n+    elif isinstance(obj, (dict, UserDict)):\n+        return {k: to_py_obj(v) for k, v in obj.items()}\n+    elif isinstance(obj, (list, tuple)):\n+        try:\n+            arr = np.array(obj)\n+            if np.issubdtype(arr.dtype, np.integer) or np.issubdtype(arr.dtype, np.floating):\n+                return arr.tolist()\n+        except Exception:\n+            pass\n+        return [to_py_obj(o) for o in obj]\n \n     framework_to_py_obj = {\n         \"pt\": lambda obj: obj.detach().cpu().tolist(),\n@@ -265,11 +277,6 @@ def to_py_obj(obj):\n         \"np\": lambda obj: obj.tolist(),\n     }\n \n-    if isinstance(obj, (dict, UserDict)):\n-        return {k: to_py_obj(v) for k, v in obj.items()}\n-    elif isinstance(obj, (list, tuple)):\n-        return [to_py_obj(o) for o in obj]\n-\n     # This gives us a smart order to test the frameworks with the corresponding tests.\n     framework_to_test_func = _get_frameworks_and_test_func(obj)\n     for framework, test_func in framework_to_test_func.items():"
        },
        {
            "sha": "3eed30c16e3ac404be4754db7a6bce983e645d3b",
            "filename": "tests/utils/test_generic.py",
            "status": "modified",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/huggingface/transformers/blob/d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf/tests%2Futils%2Ftest_generic.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf/tests%2Futils%2Ftest_generic.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Futils%2Ftest_generic.py?ref=d1eafe8d4e9ecc7c8b4b5d21119e897733794ddf",
            "patch": "@@ -28,6 +28,7 @@\n     is_torch_available,\n     reshape,\n     squeeze,\n+    to_py_obj,\n     transpose,\n )\n \n@@ -201,6 +202,77 @@ def test_expand_dims_flax(self):\n         t = jnp.array(x)\n         self.assertTrue(np.allclose(expand_dims(x, axis=1), np.asarray(expand_dims(t, axis=1))))\n \n+    def test_to_py_obj_native(self):\n+        self.assertTrue(to_py_obj(1) == 1)\n+        self.assertTrue(to_py_obj([1, 2, 3]) == [1, 2, 3])\n+        self.assertTrue(to_py_obj([((1.0, 1.1), 1.2), (2, 3)]) == [[[1.0, 1.1], 1.2], [2, 3]])\n+\n+    def test_to_py_obj_numpy(self):\n+        x1 = [[1, 2, 3], [4, 5, 6]]\n+        t1 = np.array(x1)\n+        self.assertTrue(to_py_obj(t1) == x1)\n+\n+        x2 = [[1.0, 2.0, 3.0], [4.0, 5.0, 6.0]]\n+        t2 = np.array(x2)\n+        self.assertTrue(to_py_obj(t2) == x2)\n+\n+        self.assertTrue(to_py_obj([t1, t2]) == [x1, x2])\n+\n+    @require_torch\n+    def test_to_py_obj_torch(self):\n+        x1 = [[1, 2, 3], [4, 5, 6]]\n+        t1 = torch.tensor(x1)\n+        self.assertTrue(to_py_obj(t1) == x1)\n+\n+        x2 = [[1.0, 2.0, 3.0], [4.0, 5.0, 6.0]]\n+        t2 = torch.tensor(x2)\n+        self.assertTrue(to_py_obj(t2) == x2)\n+\n+        self.assertTrue(to_py_obj([t1, t2]) == [x1, x2])\n+\n+    @require_tf\n+    def test_to_py_obj_tf(self):\n+        x1 = [[1, 2, 3], [4, 5, 6]]\n+        t1 = tf.constant(x1)\n+        self.assertTrue(to_py_obj(t1) == x1)\n+\n+        x2 = [[1.0, 2.0, 3.0], [4.0, 5.0, 6.0]]\n+        t2 = tf.constant(x2)\n+        self.assertTrue(to_py_obj(t2) == x2)\n+\n+        self.assertTrue(to_py_obj([t1, t2]) == [x1, x2])\n+\n+    @require_flax\n+    def test_to_py_obj_flax(self):\n+        x1 = [[1, 2, 3], [4, 5, 6]]\n+        t1 = jnp.array(x1)\n+        self.assertTrue(to_py_obj(t1) == x1)\n+\n+        x2 = [[1.0, 2.0, 3.0], [4.0, 5.0, 6.0]]\n+        t2 = jnp.array(x2)\n+        self.assertTrue(to_py_obj(t2) == x2)\n+\n+        self.assertTrue(to_py_obj([t1, t2]) == [x1, x2])\n+\n+    @require_torch\n+    @require_tf\n+    @require_flax\n+    def test_to_py_obj_mixed(self):\n+        x1 = [[1], [2]]\n+        t1 = np.array(x1)\n+\n+        x2 = [[1.0, 2.0, 3.0], [4.0, 5.0, 6.0]]\n+        t2 = torch.tensor(x2)\n+\n+        x3 = [1, 2, 3]\n+        t3 = tf.constant(x3)\n+\n+        x4 = [[[1.0, 2.0]]]\n+        t4 = jnp.array(x4)\n+\n+        mixed = [(t1, t2), (t3, t4)]\n+        self.assertTrue(to_py_obj(mixed) == [[x1, x2], [x3, x4]])\n+\n \n class ValidationDecoratorTester(unittest.TestCase):\n     def test_cases_no_warning(self):"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 84,
        "deletions": 5
    }
}