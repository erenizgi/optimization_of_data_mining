{
    "author": "Wauplin",
    "message": "Fix PushToHubMixin when pusing to a PR revision (#34090)",
    "sha": "1c66be80624c05e8a381990378f994ebedd9128f",
    "files": [
        {
            "sha": "54f763de335cc57972941d0b2c970f9c47696d00",
            "filename": "src/transformers/utils/hub.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/1c66be80624c05e8a381990378f994ebedd9128f/src%2Ftransformers%2Futils%2Fhub.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1c66be80624c05e8a381990378f994ebedd9128f/src%2Ftransformers%2Futils%2Fhub.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fhub.py?ref=1c66be80624c05e8a381990378f994ebedd9128f",
            "patch": "@@ -802,7 +802,7 @@ def _upload_modified_files(\n                     CommitOperationAdd(path_or_fileobj=os.path.join(working_dir, file), path_in_repo=file)\n                 )\n \n-        if revision is not None:\n+        if revision is not None and not revision.startswith(\"refs/pr\"):\n             try:\n                 create_branch(repo_id=repo_id, branch=revision, token=token, exist_ok=True)\n             except HfHubHTTPError as e:"
        },
        {
            "sha": "f4bd551bd7a4fc651588e1999b20aeb82d842b57",
            "filename": "tests/generation/test_configuration_utils.py",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/huggingface/transformers/blob/1c66be80624c05e8a381990378f994ebedd9128f/tests%2Fgeneration%2Ftest_configuration_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1c66be80624c05e8a381990378f994ebedd9128f/tests%2Fgeneration%2Ftest_configuration_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fgeneration%2Ftest_configuration_utils.py?ref=1c66be80624c05e8a381990378f994ebedd9128f",
            "patch": "@@ -20,7 +20,7 @@\n import warnings\n from pathlib import Path\n \n-from huggingface_hub import HfFolder, delete_repo\n+from huggingface_hub import HfFolder, create_pull_request, create_repo, delete_repo\n from parameterized import parameterized\n \n from transformers import AutoConfig, GenerationConfig, WatermarkingConfig, is_torch_available\n@@ -764,3 +764,29 @@ def test_push_to_hub_in_organization_via_save_pretrained(self):\n             finally:\n                 # Always (try to) delete the repo.\n                 self._try_delete_repo(repo_id=tmp_repo, token=self._token)\n+\n+    def test_push_to_hub_on_pr_revision(self):\n+        with tempfile.TemporaryDirectory() as tmp_dir:\n+            try:\n+                # create a repo and a PR\n+                repo_id = f\"{USER}/test-generation-config-{Path(tmp_dir).name}\"\n+                create_repo(repo_id=repo_id, token=self._token)\n+                pr = create_pull_request(repo_id=repo_id, title=\"Test PR\", token=self._token)\n+                revision = f\"refs/pr/{pr.num}\"\n+\n+                # push to PR ref\n+                config = GenerationConfig(\n+                    do_sample=True,\n+                    temperature=0.7,\n+                    length_penalty=1.0,\n+                )\n+                config.push_to_hub(repo_id, token=self._token, revision=revision)\n+\n+                # load from PR ref\n+                new_config = GenerationConfig.from_pretrained(repo_id, revision=revision)\n+                for k, v in config.to_dict().items():\n+                    if k != \"transformers_version\":\n+                        self.assertEqual(v, getattr(new_config, k))\n+            finally:\n+                # Always (try to) delete the repo.\n+                self._try_delete_repo(repo_id=repo_id, token=self._token)"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 28,
        "deletions": 2
    }
}