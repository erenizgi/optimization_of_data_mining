{
    "author": "gante",
    "message": "[commands] remove deprecated/inoperational commands (#35718)\n\nrm deprecated/inoperational commands",
    "sha": "8a2f062eac8266d73a46082eb495a47261b56b17",
    "files": [
        {
            "sha": "25537f07911a2a2aeb9fb8df8e2091f1e9b14b4e",
            "filename": "src/transformers/commands/lfs.py",
            "status": "removed",
            "additions": 0,
            "deletions": 226,
            "changes": 226,
            "blob_url": "https://github.com/huggingface/transformers/blob/8fc6ecba4f09a738e02d8cb08736ac924f504c08/src%2Ftransformers%2Fcommands%2Flfs.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/8fc6ecba4f09a738e02d8cb08736ac924f504c08/src%2Ftransformers%2Fcommands%2Flfs.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Flfs.py?ref=8fc6ecba4f09a738e02d8cb08736ac924f504c08",
            "patch": "@@ -1,226 +0,0 @@\n-\"\"\"\n-Implementation of a custom transfer agent for the transfer type \"multipart\" for git-lfs.\n-\n-Inspired by: github.com/cbartz/git-lfs-swift-transfer-agent/blob/master/git_lfs_swift_transfer.py\n-\n-Spec is: github.com/git-lfs/git-lfs/blob/master/docs/custom-transfers.md\n-\n-\n-To launch debugger while developing:\n-\n-``` [lfs \"customtransfer.multipart\"]\n-path = /path/to/transformers/.env/bin/python args = -m debugpy --listen 5678 --wait-for-client\n-/path/to/transformers/src/transformers/commands/transformers_cli.py lfs-multipart-upload ```\"\"\"\n-\n-import json\n-import os\n-import subprocess\n-import sys\n-import warnings\n-from argparse import ArgumentParser\n-from contextlib import AbstractContextManager\n-from typing import Dict, List, Optional\n-\n-import requests\n-\n-from ..utils import logging\n-from . import BaseTransformersCLICommand\n-\n-\n-logger = logging.get_logger(__name__)  # pylint: disable=invalid-name\n-\n-\n-LFS_MULTIPART_UPLOAD_COMMAND = \"lfs-multipart-upload\"\n-\n-\n-class LfsCommands(BaseTransformersCLICommand):\n-    \"\"\"\n-    Implementation of a custom transfer agent for the transfer type \"multipart\" for git-lfs. This lets users upload\n-    large files >5GB ðŸ”¥. Spec for LFS custom transfer agent is:\n-    https://github.com/git-lfs/git-lfs/blob/master/docs/custom-transfers.md\n-\n-    This introduces two commands to the CLI:\n-\n-    1. $ transformers-cli lfs-enable-largefiles\n-\n-    This should be executed once for each model repo that contains a model file >5GB. It's documented in the error\n-    message you get if you just try to git push a 5GB file without having enabled it before.\n-\n-    2. $ transformers-cli lfs-multipart-upload\n-\n-    This command is called by lfs directly and is not meant to be called by the user.\n-    \"\"\"\n-\n-    @staticmethod\n-    def register_subcommand(parser: ArgumentParser):\n-        enable_parser = parser.add_parser(\n-            \"lfs-enable-largefiles\",\n-            help=(\n-                \"Deprecated: use `huggingface-cli` instead. Configure your repository to enable upload of files > 5GB.\"\n-            ),\n-        )\n-        enable_parser.add_argument(\"path\", type=str, help=\"Local path to repository you want to configure.\")\n-        enable_parser.set_defaults(func=lambda args: LfsEnableCommand(args))\n-\n-        upload_parser = parser.add_parser(\n-            LFS_MULTIPART_UPLOAD_COMMAND,\n-            help=(\n-                \"Deprecated: use `huggingface-cli` instead. \"\n-                \"Command will get called by git-lfs, do not call it directly.\"\n-            ),\n-        )\n-        upload_parser.set_defaults(func=lambda args: LfsUploadCommand(args))\n-\n-\n-class LfsEnableCommand:\n-    def __init__(self, args):\n-        self.args = args\n-\n-    def run(self):\n-        warnings.warn(\n-            \"Managing repositories through transformers-cli is deprecated. Please use `huggingface-cli` instead.\"\n-        )\n-        local_path = os.path.abspath(self.args.path)\n-        if not os.path.isdir(local_path):\n-            print(\"This does not look like a valid git repo.\")\n-            exit(1)\n-        subprocess.run(\n-            \"git config lfs.customtransfer.multipart.path transformers-cli\".split(), check=True, cwd=local_path\n-        )\n-        subprocess.run(\n-            f\"git config lfs.customtransfer.multipart.args {LFS_MULTIPART_UPLOAD_COMMAND}\".split(),\n-            check=True,\n-            cwd=local_path,\n-        )\n-        print(\"Local repo set up for largefiles\")\n-\n-\n-def write_msg(msg: Dict):\n-    \"\"\"Write out the message in Line delimited JSON.\"\"\"\n-    msg = json.dumps(msg) + \"\\n\"\n-    sys.stdout.write(msg)\n-    sys.stdout.flush()\n-\n-\n-def read_msg() -> Optional[Dict]:\n-    \"\"\"Read Line delimited JSON from stdin.\"\"\"\n-    msg = json.loads(sys.stdin.readline().strip())\n-\n-    if \"terminate\" in (msg.get(\"type\"), msg.get(\"event\")):\n-        # terminate message received\n-        return None\n-\n-    if msg.get(\"event\") not in (\"download\", \"upload\"):\n-        logger.critical(\"Received unexpected message\")\n-        sys.exit(1)\n-\n-    return msg\n-\n-\n-class FileSlice(AbstractContextManager):\n-    \"\"\"\n-    File-like object that only reads a slice of a file\n-\n-    Inspired by stackoverflow.com/a/29838711/593036\n-    \"\"\"\n-\n-    def __init__(self, filepath: str, seek_from: int, read_limit: int):\n-        self.filepath = filepath\n-        self.seek_from = seek_from\n-        self.read_limit = read_limit\n-        self.n_seen = 0\n-\n-    def __enter__(self):\n-        self.f = open(self.filepath, \"rb\")\n-        self.f.seek(self.seek_from)\n-        return self\n-\n-    def __len__(self):\n-        total_length = os.fstat(self.f.fileno()).st_size\n-        return min(self.read_limit, total_length - self.seek_from)\n-\n-    def read(self, n=-1):\n-        if self.n_seen >= self.read_limit:\n-            return b\"\"\n-        remaining_amount = self.read_limit - self.n_seen\n-        data = self.f.read(remaining_amount if n < 0 else min(n, remaining_amount))\n-        self.n_seen += len(data)\n-        return data\n-\n-    def __iter__(self):\n-        yield self.read(n=4 * 1024 * 1024)\n-\n-    def __exit__(self, *args):\n-        self.f.close()\n-\n-\n-class LfsUploadCommand:\n-    def __init__(self, args):\n-        self.args = args\n-\n-    def run(self):\n-        # Immediately after invoking a custom transfer process, git-lfs\n-        # sends initiation data to the process over stdin.\n-        # This tells the process useful information about the configuration.\n-        init_msg = json.loads(sys.stdin.readline().strip())\n-        if not (init_msg.get(\"event\") == \"init\" and init_msg.get(\"operation\") == \"upload\"):\n-            write_msg({\"error\": {\"code\": 32, \"message\": \"Wrong lfs init operation\"}})\n-            sys.exit(1)\n-\n-        # The transfer process should use the information it needs from the\n-        # initiation structure, and also perform any one-off setup tasks it\n-        # needs to do. It should then respond on stdout with a simple empty\n-        # confirmation structure, as follows:\n-        write_msg({})\n-\n-        # After the initiation exchange, git-lfs will send any number of\n-        # transfer requests to the stdin of the transfer process, in a serial sequence.\n-        while True:\n-            msg = read_msg()\n-            if msg is None:\n-                # When all transfers have been processed, git-lfs will send\n-                # a terminate event to the stdin of the transfer process.\n-                # On receiving this message the transfer process should\n-                # clean up and terminate. No response is expected.\n-                sys.exit(0)\n-\n-            oid = msg[\"oid\"]\n-            filepath = msg[\"path\"]\n-            completion_url = msg[\"action\"][\"href\"]\n-            header = msg[\"action\"][\"header\"]\n-            chunk_size = int(header.pop(\"chunk_size\"))\n-            presigned_urls: List[str] = list(header.values())\n-\n-            parts = []\n-            for i, presigned_url in enumerate(presigned_urls):\n-                with FileSlice(filepath, seek_from=i * chunk_size, read_limit=chunk_size) as data:\n-                    r = requests.put(presigned_url, data=data)\n-                    r.raise_for_status()\n-                    parts.append(\n-                        {\n-                            \"etag\": r.headers.get(\"etag\"),\n-                            \"partNumber\": i + 1,\n-                        }\n-                    )\n-                    # In order to support progress reporting while data is uploading / downloading,\n-                    # the transfer process should post messages to stdout\n-                    write_msg(\n-                        {\n-                            \"event\": \"progress\",\n-                            \"oid\": oid,\n-                            \"bytesSoFar\": (i + 1) * chunk_size,\n-                            \"bytesSinceLast\": chunk_size,\n-                        }\n-                    )\n-                    # Not precise but that's ok.\n-\n-            r = requests.post(\n-                completion_url,\n-                json={\n-                    \"oid\": oid,\n-                    \"parts\": parts,\n-                },\n-            )\n-            r.raise_for_status()\n-\n-            write_msg({\"event\": \"complete\", \"oid\": oid})"
        },
        {
            "sha": "15291dcf89d3c1e7c6d5977a5ff09974dc5e7907",
            "filename": "src/transformers/commands/transformers_cli.py",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/8a2f062eac8266d73a46082eb495a47261b56b17/src%2Ftransformers%2Fcommands%2Ftransformers_cli.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/8a2f062eac8266d73a46082eb495a47261b56b17/src%2Ftransformers%2Fcommands%2Ftransformers_cli.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Ftransformers_cli.py?ref=8a2f062eac8266d73a46082eb495a47261b56b17",
            "patch": "@@ -21,10 +21,8 @@\n from .convert import ConvertCommand\n from .download import DownloadCommand\n from .env import EnvironmentCommand\n-from .lfs import LfsCommands\n from .run import RunCommand\n from .serving import ServeCommand\n-from .user import UserCommands\n \n \n def main():\n@@ -38,9 +36,7 @@ def main():\n     EnvironmentCommand.register_subcommand(commands_parser)\n     RunCommand.register_subcommand(commands_parser)\n     ServeCommand.register_subcommand(commands_parser)\n-    UserCommands.register_subcommand(commands_parser)\n     AddNewModelLikeCommand.register_subcommand(commands_parser)\n-    LfsCommands.register_subcommand(commands_parser)\n     AddFastImageProcessorCommand.register_subcommand(commands_parser)\n \n     # Let's go"
        },
        {
            "sha": "bf4072ce04689b7ea4fdef1d0ebae9ad97beb735",
            "filename": "src/transformers/commands/user.py",
            "status": "removed",
            "additions": 0,
            "deletions": 197,
            "changes": 197,
            "blob_url": "https://github.com/huggingface/transformers/blob/8fc6ecba4f09a738e02d8cb08736ac924f504c08/src%2Ftransformers%2Fcommands%2Fuser.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/8fc6ecba4f09a738e02d8cb08736ac924f504c08/src%2Ftransformers%2Fcommands%2Fuser.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fuser.py?ref=8fc6ecba4f09a738e02d8cb08736ac924f504c08",
            "patch": "@@ -1,197 +0,0 @@\n-# Copyright 2020 The HuggingFace Team. All rights reserved.\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-\n-import subprocess\n-from argparse import ArgumentParser\n-from typing import List, Union\n-\n-from huggingface_hub.hf_api import HfFolder, create_repo, whoami\n-from requests.exceptions import HTTPError\n-\n-from . import BaseTransformersCLICommand\n-\n-\n-class UserCommands(BaseTransformersCLICommand):\n-    @staticmethod\n-    def register_subcommand(parser: ArgumentParser):\n-        login_parser = parser.add_parser(\"login\", help=\"Log in using the same credentials as on huggingface.co\")\n-        login_parser.set_defaults(func=lambda args: LoginCommand(args))\n-        whoami_parser = parser.add_parser(\"whoami\", help=\"Find out which huggingface.co account you are logged in as.\")\n-        whoami_parser.set_defaults(func=lambda args: WhoamiCommand(args))\n-        logout_parser = parser.add_parser(\"logout\", help=\"Log out\")\n-        logout_parser.set_defaults(func=lambda args: LogoutCommand(args))\n-\n-        # new system: git-based repo system\n-        repo_parser = parser.add_parser(\n-            \"repo\",\n-            help=\"Deprecated: use `huggingface-cli` instead. Commands to interact with your huggingface.co repos.\",\n-        )\n-        repo_subparsers = repo_parser.add_subparsers(\n-            help=\"Deprecated: use `huggingface-cli` instead. huggingface.co repos related commands\"\n-        )\n-        repo_create_parser = repo_subparsers.add_parser(\n-            \"create\", help=\"Deprecated: use `huggingface-cli` instead. Create a new repo on huggingface.co\"\n-        )\n-        repo_create_parser.add_argument(\n-            \"name\",\n-            type=str,\n-            help=\"Name for your model's repo. Will be namespaced under your username to build the model id.\",\n-        )\n-        repo_create_parser.add_argument(\"--organization\", type=str, help=\"Optional: organization namespace.\")\n-        repo_create_parser.add_argument(\"-y\", \"--yes\", action=\"store_true\", help=\"Optional: answer Yes to the prompt\")\n-        repo_create_parser.set_defaults(func=lambda args: RepoCreateCommand(args))\n-\n-\n-class ANSI:\n-    \"\"\"\n-    Helper for en.wikipedia.org/wiki/ANSI_escape_code\n-    \"\"\"\n-\n-    _bold = \"\\u001b[1m\"\n-    _red = \"\\u001b[31m\"\n-    _gray = \"\\u001b[90m\"\n-    _reset = \"\\u001b[0m\"\n-\n-    @classmethod\n-    def bold(cls, s):\n-        return f\"{cls._bold}{s}{cls._reset}\"\n-\n-    @classmethod\n-    def red(cls, s):\n-        return f\"{cls._bold}{cls._red}{s}{cls._reset}\"\n-\n-    @classmethod\n-    def gray(cls, s):\n-        return f\"{cls._gray}{s}{cls._reset}\"\n-\n-\n-def tabulate(rows: List[List[Union[str, int]]], headers: List[str]) -> str:\n-    \"\"\"\n-    Inspired by:\n-\n-    - stackoverflow.com/a/8356620/593036\n-    - stackoverflow.com/questions/9535954/printing-lists-as-tabular-data\n-    \"\"\"\n-    col_widths = [max(len(str(x)) for x in col) for col in zip(*rows, headers)]\n-    row_format = (\"{{:{}}} \" * len(headers)).format(*col_widths)\n-    lines = []\n-    lines.append(row_format.format(*headers))\n-    lines.append(row_format.format(*[\"-\" * w for w in col_widths]))\n-    for row in rows:\n-        lines.append(row_format.format(*row))\n-    return \"\\n\".join(lines)\n-\n-\n-class BaseUserCommand:\n-    def __init__(self, args):\n-        self.args = args\n-\n-\n-class LoginCommand(BaseUserCommand):\n-    def run(self):\n-        print(\n-            ANSI.red(\n-                \"ERROR! `huggingface-cli login` uses an outdated login mechanism \"\n-                \"that is not compatible with the Hugging Face Hub backend anymore. \"\n-                \"Please use `huggingface-cli login instead.\"\n-            )\n-        )\n-\n-\n-class WhoamiCommand(BaseUserCommand):\n-    def run(self):\n-        print(\n-            ANSI.red(\n-                \"WARNING! `transformers-cli whoami` is deprecated and will be removed in v5. Please use \"\n-                \"`huggingface-cli whoami` instead.\"\n-            )\n-        )\n-        token = HfFolder.get_token()\n-        if token is None:\n-            print(\"Not logged in\")\n-            exit()\n-        try:\n-            user, orgs = whoami(token)\n-            print(user)\n-            if orgs:\n-                print(ANSI.bold(\"orgs: \"), \",\".join(orgs))\n-        except HTTPError as e:\n-            print(e)\n-            print(ANSI.red(e.response.text))\n-            exit(1)\n-\n-\n-class LogoutCommand(BaseUserCommand):\n-    def run(self):\n-        print(\n-            ANSI.red(\n-                \"ERROR! `transformers-cli logout` uses an outdated logout mechanism \"\n-                \"that is not compatible with the Hugging Face Hub backend anymore. \"\n-                \"Please use `huggingface-cli logout instead.\"\n-            )\n-        )\n-\n-\n-class RepoCreateCommand(BaseUserCommand):\n-    def run(self):\n-        print(\n-            ANSI.red(\n-                \"WARNING! Managing repositories through transformers-cli is deprecated. \"\n-                \"Please use `huggingface-cli` instead.\"\n-            )\n-        )\n-        token = HfFolder.get_token()\n-        if token is None:\n-            print(\"Not logged in\")\n-            exit(1)\n-        try:\n-            stdout = subprocess.check_output([\"git\", \"--version\"]).decode(\"utf-8\")\n-            print(ANSI.gray(stdout.strip()))\n-        except FileNotFoundError:\n-            print(\"Looks like you do not have git installed, please install.\")\n-\n-        try:\n-            stdout = subprocess.check_output([\"git-lfs\", \"--version\"]).decode(\"utf-8\")\n-            print(ANSI.gray(stdout.strip()))\n-        except FileNotFoundError:\n-            print(\n-                ANSI.red(\n-                    \"Looks like you do not have git-lfs installed, please install.\"\n-                    \" You can install from https://git-lfs.github.com/.\"\n-                    \" Then run `git lfs install` (you only have to do this once).\"\n-                )\n-            )\n-        print(\"\")\n-\n-        user, _ = whoami(token)\n-        namespace = self.args.organization if self.args.organization is not None else user\n-        full_name = f\"{namespace}/{self.args.name}\"\n-        print(f\"You are about to create {ANSI.bold(full_name)}\")\n-\n-        if not self.args.yes:\n-            choice = input(\"Proceed? [Y/n] \").lower()\n-            if not (choice == \"\" or choice == \"y\" or choice == \"yes\"):\n-                print(\"Abort\")\n-                exit()\n-        try:\n-            url = create_repo(repo_id=full_name, token=token)\n-        except HTTPError as e:\n-            print(e)\n-            print(ANSI.red(e.response.text))\n-            exit(1)\n-        print(\"\\nYour repo now lives at:\")\n-        print(f\"  {ANSI.bold(url)}\")\n-        print(\"\\nYou can clone it locally with the command below, and commit/push as usual.\")\n-        print(f\"\\n  git clone {url}\")\n-        print(\"\")"
        },
        {
            "sha": "24a8a4ba7a287c1d53e0a3f128311ad474d981dc",
            "filename": "utils/not_doctested.txt",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/8a2f062eac8266d73a46082eb495a47261b56b17/utils%2Fnot_doctested.txt",
            "raw_url": "https://github.com/huggingface/transformers/raw/8a2f062eac8266d73a46082eb495a47261b56b17/utils%2Fnot_doctested.txt",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fnot_doctested.txt?ref=8a2f062eac8266d73a46082eb495a47261b56b17",
            "patch": "@@ -343,12 +343,10 @@ src/transformers/commands/add_new_model_like.py\n src/transformers/commands/convert.py\n src/transformers/commands/download.py\n src/transformers/commands/env.py\n-src/transformers/commands/lfs.py\n src/transformers/commands/run.py\n src/transformers/commands/serving.py\n src/transformers/commands/train.py\n src/transformers/commands/transformers_cli.py\n-src/transformers/commands/user.py\n src/transformers/configuration_utils.py\n src/transformers/convert_graph_to_onnx.py\n src/transformers/convert_pytorch_checkpoint_to_tf2.py"
        }
    ],
    "stats": {
        "total": 429,
        "additions": 0,
        "deletions": 429
    }
}