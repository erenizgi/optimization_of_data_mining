{
    "author": "ArthurZucker",
    "message": "fix modular order (#35297)\n\n* fix modular ordre\n\n* fix\n\n* style",
    "sha": "a7f5479b45a8040392af80bf1107a2bdd796931c",
    "files": [
        {
            "sha": "0df782d1c21740b2f01df13fa17f4e641cd6d34f",
            "filename": "utils/create_dependency_mapping.py",
            "status": "modified",
            "additions": 35,
            "deletions": 27,
            "changes": 62,
            "blob_url": "https://github.com/huggingface/transformers/blob/a7f5479b45a8040392af80bf1107a2bdd796931c/utils%2Fcreate_dependency_mapping.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a7f5479b45a8040392af80bf1107a2bdd796931c/utils%2Fcreate_dependency_mapping.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fcreate_dependency_mapping.py?ref=a7f5479b45a8040392af80bf1107a2bdd796931c",
            "patch": "@@ -1,40 +1,48 @@\n import ast\n-from collections import defaultdict, deque\n+from collections import defaultdict\n \n \n # Function to perform topological sorting\n def topological_sort(dependencies):\n-    # Create a graph and in-degree count for each node\n+    new_dependencies = {}\n     graph = defaultdict(list)\n-    in_degree = defaultdict(int)\n-\n-    # Build the graph\n     for node, deps in dependencies.items():\n         for dep in deps:\n-            graph[dep].append(node)  # node depends on dep\n-            in_degree[node] += 1  # increase in-degree of node\n+            if \"example\" not in node and \"auto\" not in dep:\n+                graph[dep.split(\".\")[-2]].append(node.split(\"/\")[-2])\n+        new_dependencies[node.split(\"/\")[-2]] = node\n \n-    # Add all nodes with zero in-degree to the queue\n-    zero_in_degree_queue = deque([node for node in dependencies if in_degree[node] == 0])\n+    # Create a graph and in-degree count for each node\n+    def filter_one_by_one(filtered_list, reverse):\n+        if len(reverse) == 0:\n+            return filtered_list\n \n-    sorted_list = []\n-    # Perform topological sorting\n-    while zero_in_degree_queue:\n-        current = zero_in_degree_queue.popleft()\n-        sorted_list.append(current)\n+        graph = defaultdict(list)\n+        # Build the graph\n+        for node, deps in reverse.items():\n+            for dep in deps:\n+                graph[dep].append(node)\n \n-        # For each node that current points to, reduce its in-degree\n-        for neighbor in graph[current]:\n-            in_degree[neighbor] -= 1\n-            if in_degree[neighbor] == 0:\n-                zero_in_degree_queue.append(neighbor)\n+        base_modules = set(reverse.keys()) - set(graph.keys())\n+        if base_modules == reverse.keys():\n+            # we are at the end\n+            return filtered_list + list(graph.keys())\n+        to_add = []\n+        for k in graph.keys():\n+            if len(graph[k]) == 1 and graph[k][0] in base_modules:\n+                if graph[k][0] in reverse:\n+                    del reverse[graph[k][0]]\n+                if k not in filtered_list:\n+                    to_add += [k]\n+        for k in base_modules:\n+            if k not in filtered_list:\n+                to_add += [k]\n+        filtered_list += list(to_add)\n+        return filter_one_by_one(filtered_list, reverse)\n \n-    # Handle nodes that have no dependencies and were not initially part of the loop\n-    for node in dependencies:\n-        if node not in sorted_list:\n-            sorted_list.append(node)\n+    final_order = filter_one_by_one([], graph)\n \n-    return sorted_list\n+    return [new_dependencies.get(k) for k in final_order if k in new_dependencies]\n \n \n # Function to extract class and import info from a file\n@@ -46,7 +54,7 @@ def extract_classes_and_imports(file_path):\n     for node in ast.walk(tree):\n         if isinstance(node, (ast.Import, ast.ImportFrom)):\n             module = node.module if isinstance(node, ast.ImportFrom) else None\n-            if module and \"transformers\" in module:\n+            if module and (\".modeling_\" in module):\n                 imports.add(module)\n     return imports\n \n@@ -56,7 +64,7 @@ def map_dependencies(py_files):\n     dependencies = defaultdict(set)\n     # First pass: Extract all classes and map to files\n     for file_path in py_files:\n-        dependencies[file_path].add(None)\n+        # dependencies[file_path].add(None)\n         class_to_file = extract_classes_and_imports(file_path)\n         for module in class_to_file:\n             dependencies[file_path].add(module)\n@@ -66,4 +74,4 @@ def map_dependencies(py_files):\n def find_priority_list(py_files):\n     dependencies = map_dependencies(py_files)\n     ordered_classes = topological_sort(dependencies)\n-    return ordered_classes[::-1]\n+    return ordered_classes"
        },
        {
            "sha": "28fcc4fc7b9e1a9f6fe876bf3799d935df1db791",
            "filename": "utils/modular_model_converter.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/a7f5479b45a8040392af80bf1107a2bdd796931c/utils%2Fmodular_model_converter.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a7f5479b45a8040392af80bf1107a2bdd796931c/utils%2Fmodular_model_converter.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fmodular_model_converter.py?ref=a7f5479b45a8040392af80bf1107a2bdd796931c",
            "patch": "@@ -1678,7 +1678,7 @@ def save_modeling_file(modular_file, converted_file):\n     parser = argparse.ArgumentParser()\n     parser.add_argument(\n         \"--files_to_parse\",\n-        default=[\"src/transformers/models/aria/modular_aria.py\"],\n+        default=[\"all\"],\n         nargs=\"+\",\n         help=\"A list of `modular_xxxx` files that should be converted to single model file\",\n     )"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 36,
        "deletions": 28
    }
}