{
    "author": "dhiaEddineRhaiem",
    "message": "[Falcon H1] Fix slow path forward pass (#38320)\n\n* Create push-important-models.yml\n\n* feat: add falcon-h1\n\n* fixup\n\n* address comment\n\n* fix\n\n* fix copies\n\n* fix copies\n\n* fix\n\n* fix\n\n* fix\n\n* fix\n\n* fix copies\n\n* fix\n\n* fix copies\n\n* fix test import to at least trigget the cis\n\n* yups\n\n* update\n\n* fix make fix copies\n\n* fix inits?\n\n* fix style\n\n* skip annoying test\n\n* add integration test for Falcon H1\n\n* fix copies\n\n* fix\n\n* fix typo\n\n* make style\n\n* fix slow path generations\n\n* clean debug traces\n\n* debug\n\n* remove debug traces final confirmation\n\n* clean debug traces final\n\n* fix format and lineup\n\n* make style\n\n* debug\n\n* Update src/transformers/models/falcon_h1/modular_falcon_h1.py\n\nCo-authored-by: Anton Vlasjuk <73884904+vasqu@users.noreply.github.com>\n\n* adress comments\n\n* fix fix-copies\n\n* fix integration test\n\n* Merge pull request #7 from ydshieh/fix-slow-path\n\nupdate\n\n* another update (#8)\n\n* update\n\n* update\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>\n\n---------\n\nCo-authored-by: Younes Belkada <49240599+younesbelkada@users.noreply.github.com>\nCo-authored-by: Younes Belkada <younesbelkada@gmail.com>\nCo-authored-by: younesbelkada <younes.belkada@tii.ae>\nCo-authored-by: Arthur Zucker <arthur.zucker@gmail.com>\nCo-authored-by: Anton Vlasjuk <73884904+vasqu@users.noreply.github.com>\nCo-authored-by: Yih-Dar <2521628+ydshieh@users.noreply.github.com>\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "7a9b071bfde1dd9f71380a66354268e4a1bc9064",
    "files": [
        {
            "sha": "6243306c89b0a3a38690b463f336dbe6c270cb66",
            "filename": "src/transformers/models/falcon_h1/modeling_falcon_h1.py",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/7a9b071bfde1dd9f71380a66354268e4a1bc9064/src%2Ftransformers%2Fmodels%2Ffalcon_h1%2Fmodeling_falcon_h1.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/7a9b071bfde1dd9f71380a66354268e4a1bc9064/src%2Ftransformers%2Fmodels%2Ffalcon_h1%2Fmodeling_falcon_h1.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Ffalcon_h1%2Fmodeling_falcon_h1.py?ref=7a9b071bfde1dd9f71380a66354268e4a1bc9064",
            "patch": "@@ -604,9 +604,10 @@ def cuda_kernels_forward(\n     ):\n         # 1. Gated MLP's linear projection\n         hidden_states = apply_mask_to_padding_states(hidden_states, attention_mask)\n+        # Add Multipliers\n         hidden_states = hidden_states * self.ssm_in_multiplier\n         projected_states = self.in_proj(hidden_states)\n-        projected_states = projected_states * self.mup_vector\n+        projected_states = projected_states * self.mup_vector  # ADD Mup Multipliers\n         d_to_remove = 2 * self.intermediate_size + 2 * self.n_groups * self.ssm_state_size + self.num_heads\n \n         # Set up dimensions for reshapes later\n@@ -800,10 +801,13 @@ def torch_forward(\n \n         # 1. Gated MLP's linear projection\n         input_states = apply_mask_to_padding_states(input_states, attention_mask)\n+        # Add Multipliers\n+        input_states = input_states * self.ssm_in_multiplier\n         projected_states = self.in_proj(input_states)\n-        gate, hidden_states_B_C, dt = projected_states.split(\n-                [self.intermediate_size, self.conv_dim, self.num_heads], dim=-1\n-        )\n+        projected_states = projected_states * self.mup_vector  # ADD Mup Multipliers\n+        gate, hidden_states_B_C, dt = projected_states.split([\n+                self.intermediate_size, self.conv_dim, self.num_heads\n+            ], dim=-1)\n \n         use_precomputed_states = (\n             cache_params is not None\n@@ -914,8 +918,8 @@ def torch_forward(\n             hidden_states = hidden_states.reshape(batch_size, seq_len, -1, self.head_dim).float()\n             B = B.reshape(batch_size, seq_len, -1, self.ssm_state_size).float()\n             C = C.reshape(batch_size, seq_len, -1, self.ssm_state_size).float()\n-            B = B.repeat(1, 1, self.num_heads // self.n_groups, 1)\n-            C = C.repeat(1, 1, self.num_heads // self.n_groups, 1)\n+            B = B.repeat_interleave(self.num_heads // self.n_groups, dim=2, output_size=self.num_heads)\n+            C = C.repeat_interleave(self.num_heads // self.n_groups, dim=2, output_size=self.num_heads)\n             pad_size = (self.chunk_size - seq_len % self.chunk_size) % self.chunk_size\n \n             D_residual = self.D[..., None] * pad_tensor_by_size(hidden_states, pad_size)"
        },
        {
            "sha": "790baac74ac96f50a9d601755693a43d5fb8a1bd",
            "filename": "src/transformers/models/falcon_h1/modular_falcon_h1.py",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/7a9b071bfde1dd9f71380a66354268e4a1bc9064/src%2Ftransformers%2Fmodels%2Ffalcon_h1%2Fmodular_falcon_h1.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/7a9b071bfde1dd9f71380a66354268e4a1bc9064/src%2Ftransformers%2Fmodels%2Ffalcon_h1%2Fmodular_falcon_h1.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Ffalcon_h1%2Fmodular_falcon_h1.py?ref=7a9b071bfde1dd9f71380a66354268e4a1bc9064",
            "patch": "@@ -415,9 +415,10 @@ def cuda_kernels_forward(\n     ):\n         # 1. Gated MLP's linear projection\n         hidden_states = apply_mask_to_padding_states(hidden_states, attention_mask)\n+        # Add Multipliers\n         hidden_states = hidden_states * self.ssm_in_multiplier\n         projected_states = self.in_proj(hidden_states)\n-        projected_states = projected_states * self.mup_vector\n+        projected_states = projected_states * self.mup_vector  # ADD Mup Multipliers\n         d_to_remove = 2 * self.intermediate_size + 2 * self.n_groups * self.ssm_state_size + self.num_heads\n \n         # Set up dimensions for reshapes later\n@@ -611,10 +612,13 @@ def torch_forward(\n \n         # 1. Gated MLP's linear projection\n         input_states = apply_mask_to_padding_states(input_states, attention_mask)\n+        # Add Multipliers\n+        input_states = input_states * self.ssm_in_multiplier\n         projected_states = self.in_proj(input_states)\n-        gate, hidden_states_B_C, dt = projected_states.split(\n-                [self.intermediate_size, self.conv_dim, self.num_heads], dim=-1\n-        )\n+        projected_states = projected_states * self.mup_vector  # ADD Mup Multipliers\n+        gate, hidden_states_B_C, dt = projected_states.split([\n+                self.intermediate_size, self.conv_dim, self.num_heads\n+            ], dim=-1)\n \n         use_precomputed_states = (\n             cache_params is not None\n@@ -725,8 +729,8 @@ def torch_forward(\n             hidden_states = hidden_states.reshape(batch_size, seq_len, -1, self.head_dim).float()\n             B = B.reshape(batch_size, seq_len, -1, self.ssm_state_size).float()\n             C = C.reshape(batch_size, seq_len, -1, self.ssm_state_size).float()\n-            B = B.repeat(1, 1, self.num_heads // self.n_groups, 1)\n-            C = C.repeat(1, 1, self.num_heads // self.n_groups, 1)\n+            B = B.repeat_interleave(self.num_heads // self.n_groups, dim=2, output_size=self.num_heads)\n+            C = C.repeat_interleave(self.num_heads // self.n_groups, dim=2, output_size=self.num_heads)\n             pad_size = (self.chunk_size - seq_len % self.chunk_size) % self.chunk_size\n \n             D_residual = self.D[..., None] * pad_tensor_by_size(hidden_states, pad_size)"
        },
        {
            "sha": "1fb85f7de82a0e0324a296a9c797f7aa50b76ddd",
            "filename": "tests/models/falcon_h1/test_modeling_falcon_h1.py",
            "status": "modified",
            "additions": 21,
            "deletions": 18,
            "changes": 39,
            "blob_url": "https://github.com/huggingface/transformers/blob/7a9b071bfde1dd9f71380a66354268e4a1bc9064/tests%2Fmodels%2Ffalcon_h1%2Ftest_modeling_falcon_h1.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/7a9b071bfde1dd9f71380a66354268e4a1bc9064/tests%2Fmodels%2Ffalcon_h1%2Ftest_modeling_falcon_h1.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Ffalcon_h1%2Ftest_modeling_falcon_h1.py?ref=7a9b071bfde1dd9f71380a66354268e4a1bc9064",
            "patch": "@@ -484,24 +484,27 @@ def test_falcon_h1_hard(self):\n         \"\"\"\n         An integration test for Falcon-H1.\n         \"\"\"\n-        EXPECTED_TEXT = (\n-            \"Tell me about the french revolution.\\n\"\n-            \"The French Revolution (1789–1799) was a period of radical social and political upheaval in France that \"\n-            \"fundamentally transformed the nation and had profound effects on the rest of Europe and the world. Here are the key aspects of the revolution:\\n\\n\"\n-            \"### **Causes**\\n\"\n-            \"1. **Economic Crisis**: France was in severe financial trouble due to costly wars (particularly the American Revolution), extravagant spending by the monarchy, and inefficient taxation.\\n\"\n-            \"2. **Social Inequality**: The rigid class system (the Ancien Régime) divided society into the privileged nobility and clergy (First Estate) and the common people (Third Estate), who bore the brunt of taxation and had few rights.\\n\"\n-            \"3. **Enlightenment Ideas**: Philosophers like Rousseau, Voltaire, and Montesquieu inspired ideas of liberty, equality, and popular sovereignty.\\n\"\n-            \"4. **Settlement of 1789**: The Estates-General convened to address the financial crisis, leading to the Third Estate's assertion of its rights and the eventual formation of the National Assembly.\\n\\n\"\n-            \"### **Key Events**\\n\"\n-            \"1. **Opening of the Revolution (1789)**:\\n\"\n-            \"- **Storming of the Bastille**: Symbolic of the fall of royal tyranny.\\n\"\n-            \"- **Declaration of the Rights of Man and of the Citizen**: Proclaimed universal rights to liberty, property, and security.\\n\"\n-            \"- **Creation of the National Assembly**: The Third Estate declared itself the representative body of France.\\n\\n\"\n-            \"2. **Radical Phase (1792–1794)**:\\n\"\n-            \"- **Reign of Terror**: Led by Maximilien Robespierre, the Committee of Public Safety enforced radical egalitarianism through the guillotine, executing thousands of perceived enemies of the revolution (monarchists, clergy, aristocrats, and counter-revolutionaries).\\n\"\n-            \"- **Execution of Louis XVI**: The king was guillotined in June 1793, symbolizing the end of the monarchy.\\n\"\n-        )\n+        EXPECTED_TEXT = \"\"\"\n+            user\n+            Tell me about the french revolution.\n+            assistant\n+            The French Revolution (1789–1799) was a period of radical social and political upheaval in France that fundamentally transformed the nation and had profound effects on the rest of Europe and the world. Here are the key aspects of the revolution:\n+\n+            ### **Causes**\n+            1. **Economic Crisis**: France was in severe financial trouble due to costly wars (particularly the American Revolution), extravagant spending by the monarchy, and inefficient taxation.\n+            2. **Social Inequality**: The rigid class system (the Ancien Régime) divided society into the privileged nobility and clergy (First Estate) and the commoners (Third Estate), who bore the brunt of taxation and had few rights.\n+            3. **Enlightenment Ideas**: Philosophers like Voltaire, Rousseau, and Montesquieu inspired ideas of liberty, equality, and popular sovereignty.\n+            4. **Settlement of 1789**: The Estates-General convened to address the financial crisis, leading to the Third Estate's assertion of its rights and the eventual abolition of the feudal system.\n+\n+            ### **Key Events**\n+            1. **Storming of the Bastille (July 14, 1789)**: A symbol of royal tyranny, the Bastille fortress was stormed by revolutionaries, sparking widespread rebellion.\n+            2. **Declaration of the Rights of Man and of the Citizen (August 1789)**: A foundational document proclaiming liberty, equality, and fraternity.\n+            3. **National Assembly and King’s Trial (1791–1792)**: King Louis XVI and his ministers were tried and executed (King Louis was guillotined, Marie Antoinette was banished), marking the end of the monarchy.\n+            4. **Rise of the Jacobins and Reign of Terror (1793–1794)**: Radical leaders like Maximilien Robespierre sought to purge France of counter-revolutionaries, leading to mass executions and widespread fear.\n+            5. **Thermidorian Reaction\n+        \"\"\"\n+        # Remove the first char (`\\n`) and the consecutive whitespaces caused by the formatting.\n+        EXPECTED_TEXT = EXPECTED_TEXT.strip().replace(\" \" * 12, \"\")\n \n         model_id = \"tiiuae/Falcon-H1-1.5B-Deep-Instruct\"\n         tokenizer = AutoTokenizer.from_pretrained(model_id)"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 41,
        "deletions": 30
    }
}