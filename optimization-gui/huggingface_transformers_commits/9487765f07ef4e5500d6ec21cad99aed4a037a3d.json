{
    "author": "rileyafox",
    "message": "Add Qwen2 MoE model card (#38649)\n\n* Add Qwen2 MoE model card\n\n* Revisions to qwen2 moe model card\n\n* Add Qwen2 MoE model card",
    "sha": "9487765f07ef4e5500d6ec21cad99aed4a037a3d",
    "files": [
        {
            "sha": "0030449a51c629cb17d18bc52c18ee3218b5a2c0",
            "filename": "docs/source/en/model_doc/qwen2_moe.md",
            "status": "modified",
            "additions": 99,
            "deletions": 28,
            "changes": 127,
            "blob_url": "https://github.com/huggingface/transformers/blob/9487765f07ef4e5500d6ec21cad99aed4a037a3d/docs%2Fsource%2Fen%2Fmodel_doc%2Fqwen2_moe.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/9487765f07ef4e5500d6ec21cad99aed4a037a3d/docs%2Fsource%2Fen%2Fmodel_doc%2Fqwen2_moe.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmodel_doc%2Fqwen2_moe.md?ref=9487765f07ef4e5500d6ec21cad99aed4a037a3d",
            "patch": "@@ -14,53 +14,124 @@ rendered properly in your Markdown viewer.\n \n -->\n \n-# Qwen2MoE\n-\n-<div class=\"flex flex-wrap space-x-1\">\n+<div style=\"float: right;\">\n <img alt=\"PyTorch\" src=\"https://img.shields.io/badge/PyTorch-DE3412?style=flat&logo=pytorch&logoColor=white\">\n <img alt=\"FlashAttention\" src=\"https://img.shields.io/badge/%E2%9A%A1%EF%B8%8E%20FlashAttention-eae0c8?style=flat\">\n <img alt=\"SDPA\" src=\"https://img.shields.io/badge/SDPA-DE3412?style=flat&logo=pytorch&logoColor=white\">\n </div>\n \n-## Overview\n-\n-Qwen2MoE is the new model series of large language models from the Qwen team. Previously, we released the Qwen series, including Qwen-72B, Qwen-1.8B, Qwen-VL, Qwen-Audio, etc.\n-\n-### Model Details\n+# Qwen2MoE\n \n-Qwen2MoE is a language model series including decoder language models of different model sizes. For each size, we release the base language model and the aligned chat model. Qwen2MoE has the following architectural choices:\n \n-- Qwen2MoE is based on the Transformer architecture with SwiGLU activation, attention QKV bias, group query attention, mixture of sliding window attention and full attention, etc. Additionally, we have an improved tokenizer adaptive to multiple natural languages and codes.\n-- Qwen2MoE employs Mixture of Experts (MoE) architecture, where the models are upcycled from dense language models. For instance, `Qwen1.5-MoE-A2.7B` is upcycled from `Qwen-1.8B`. It has 14.3B parameters in total and 2.7B activated parameters during runtime, while it achieves comparable performance with `Qwen1.5-7B`, with only 25% of the training resources.\n+[Qwen2MoE]((https://huggingface.co/papers/2407.10671) ) is a Mixture-of-Experts (MoE) variant of [Qwen2](./qwen2), available as a base model and an aligned chat model. It uses SwiGLU activation, group query attention and a mixture of sliding window attention and full attention. The tokenizer can also be adapted to multiple languages and codes.\n \n-For more details refer to the [release blog post](https://qwenlm.github.io/blog/qwen-moe/).\n+The MoE architecture uses upcyled models from the dense language models. For example, Qwen1.5-MoE-A2.7B is upcycled from Qwen-1.8B. It has 14.3B parameters but only 2.7B parameters are activated during runtime.\n \n-## Usage tips\n+You can find all the original checkpoints in the [Qwen1.5](https://huggingface.co/collections/Qwen/qwen15-65c0a2f577b1ecb76d786524) collection.\n \n-`Qwen1.5-MoE-A2.7B` and `Qwen1.5-MoE-A2.7B-Chat` can be found on the [Huggingface Hub](https://huggingface.co/Qwen)\n+> [!TIP]\n+> Click on the Qwen2MoE models in the right sidebar for more examples of how to apply Qwen2MoE to different language tasks.\n \n-In the following, we demonstrate how to use `Qwen1.5-MoE-A2.7B-Chat` for the inference. Note that we have used the ChatML format for dialog, in this demo we show how to leverage `apply_chat_template` for this purpose.\n+The example below demonstrates how to generate text with [`Pipeline`], [`AutoModel`], and from the command line.\n \n-```python\n->>> from transformers import AutoModelForCausalLM, AutoTokenizer\n->>> device = \"cuda\" # the device to load the model onto\n+<hfoptions id=\"usage\">\n+<hfoption id=\"Pipeline\">\n \n->>> model = AutoModelForCausalLM.from_pretrained(\"Qwen/Qwen1.5-MoE-A2.7B-Chat\", device_map=\"auto\")\n->>> tokenizer = AutoTokenizer.from_pretrained(\"Qwen/Qwen1.5-MoE-A2.7B-Chat\")\n+```py\n+import torch\n+from transformers import pipeline\n \n->>> prompt = \"Give me a short introduction to large language model.\"\n+pipe = pipeline(\n+    task=\"text-generation\",\n+    model=\"Qwen/Qwen1.5-MoE-A2.7B\",\n+    torch_dtype=torch.bfloat16,\n+    device_map=0\n+)\n \n->>> messages = [{\"role\": \"user\", \"content\": prompt}]\n-\n->>> text = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)\n+messages = [\n+    {\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n+    {\"role\": \"user\", \"content\": \"Tell me about the Qwen2 model family.\"},\n+]\n+outputs = pipe(messages, max_new_tokens=256, do_sample=True, temperature=0.7, top_k=50, top_p=0.95)\n+print(outputs[0][\"generated_text\"][-1]['content'])\n+```\n+</hfoption>\n+<hfoption id=\"AutoModel\">\n+\n+```py\n+import torch\n+from transformers import AutoModelForCausalLM, AutoTokenizer\n+\n+model = AutoModelForCausalLM.from_pretrained(\n+    \"Qwen/Qwen1.5-MoE-A2.7B-Chat\",\n+    torch_dtype=torch.bfloat16,\n+    device_map=\"auto\",\n+    attn_implementation=\"sdpa\"\n+)\n+tokenizer = AutoTokenizer.from_pretrained(\"Qwen/Qwen1.5-MoE-A2.7B-Chat\")\n+\n+prompt = \"Give me a short introduction to large language models.\"\n+messages = [\n+    {\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n+    {\"role\": \"user\", \"content\": prompt}\n+]\n+text = tokenizer.apply_chat_template(\n+    messages,\n+    tokenize=False,\n+    add_generation_prompt=True\n+)\n+model_inputs = tokenizer([text], return_tensors=\"pt\").to(\"cuda\")\n+\n+generated_ids = model.generate(\n+    model_inputs.input_ids,\n+    cache_implementation=\"static\",\n+    max_new_tokens=512,\n+    do_sample=True,\n+    temperature=0.7,\n+    top_k=50,\n+    top_p=0.95\n+)\n+generated_ids = [\n+    output_ids[len(input_ids):] for input_ids, output_ids in zip(model_inputs.input_ids, generated_ids)\n+]\n+\n+response = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)[0]\n+print(response)\n+```\n+</hfoption> \n+<hfoption id=\"transformers CLI\">\n+```bash\n+transformers chat Qwen/Qwen1.5-MoE-A2.7B-Chat --torch_dtype auto --attn_implementation flash_attention_2\n+```\n+</hfoption>\n+ </hfoptions> \n \n->>> model_inputs = tokenizer([text], return_tensors=\"pt\").to(device)\n \n->>> generated_ids = model.generate(model_inputs.input_ids, max_new_tokens=512, do_sample=True)\n+Quantization reduces the memory burden of large models by representing the weights in a lower precision. Refer to the [Quantization](../quantization/overview) overview for more available quantization backends.\n \n->>> generated_ids = [output_ids[len(input_ids):] for input_ids, output_ids in zip(model_inputs.input_ids, generated_ids)]\n+The example below uses [bitsandbytes](../quantization/bitsandbytes) to quantize the weights to 8-bits.\n \n->>> response = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)[0]\n+```python\n+# pip install -U flash-attn --no-build-isolation\n+import torch\n+from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig\n+\n+quantization_config = BitsAndBytesConfig(\n+    load_in_8bit=True\n+)\n+\n+tokenizer = AutoTokenizer.from_pretrained(\"Qwen/Qwen1.5-MoE-A2.7B-Chat\")\n+model = AutoModelForCausalLM.from_pretrained(\n+    \"Qwen/Qwen1.5-MoE-A2.7B-Chat\",\n+    torch_dtype=torch.bfloat16,\n+    device_map=\"auto\",\n+    quantization_config=quantization_config,\n+    attn_implementation=\"flash_attention_2\"\n+)\n+\n+inputs = tokenizer(\"The Qwen2 model family is\", return_tensors=\"pt\").to(\"cuda\")\n+outputs = model.generate(**inputs, max_new_tokens=100)\n+print(tokenizer.decode(outputs[0], skip_special_tokens=True))\n ```\n \n ## Qwen2MoeConfig"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 99,
        "deletions": 28
    }
}