{
    "author": "ydshieh",
    "message": "Fix more flaky `test_initialization` (#38932)\n\n* try\n\n* try\n\n* fix\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "b8059e1f8f9ad245d71fbe2d18723d735ffccfec",
    "files": [
        {
            "sha": "851177b01a3d16d95409cf4dbf23f95fa8a4dac5",
            "filename": "tests/models/blip/test_modeling_blip.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fblip%2Ftest_modeling_blip.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fblip%2Ftest_modeling_blip.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fblip%2Ftest_modeling_blip.py?ref=b8059e1f8f9ad245d71fbe2d18723d735ffccfec",
            "patch": "@@ -475,8 +475,19 @@ def test_initialization(self):\n                             msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                         )\n                     else:\n+                        # See PR #38607 (to avoid flakiness)\n+                        data = torch.flatten(param.data)\n+                        n_elements = torch.numel(data)\n+                        # skip 2.5% of elements on each side to avoid issues caused by `nn.init.trunc_normal_` described in\n+                        # https://github.com/huggingface/transformers/pull/27906#issuecomment-1846951332\n+                        n_elements_to_skip_on_each_side = int(n_elements * 0.025)\n+                        data_to_check = torch.sort(data).values\n+                        if n_elements_to_skip_on_each_side > 0:\n+                            data_to_check = data_to_check[\n+                                n_elements_to_skip_on_each_side:-n_elements_to_skip_on_each_side\n+                            ]\n                         self.assertIn(\n-                            ((param.data.mean() * 1e9).round() / 1e9).item(),\n+                            ((data_to_check.mean() * 1e9).round() / 1e9).item(),\n                             [0.0, 1.0],\n                             msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                         )"
        },
        {
            "sha": "7ea2cbd09d9c62e1fd4d41bd3bec4635d0dc8f12",
            "filename": "tests/models/depth_pro/test_modeling_depth_pro.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fdepth_pro%2Ftest_modeling_depth_pro.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fdepth_pro%2Ftest_modeling_depth_pro.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fdepth_pro%2Ftest_modeling_depth_pro.py?ref=b8059e1f8f9ad245d71fbe2d18723d735ffccfec",
            "patch": "@@ -311,8 +311,19 @@ def test_initialization(self):\n                 ]\n                 if param.requires_grad:\n                     if any(x in name for x in non_uniform_init_parms):\n+                        # See PR #38607 (to avoid flakiness)\n+                        data = torch.flatten(param.data)\n+                        n_elements = torch.numel(data)\n+                        # skip 2.5% of elements on each side to avoid issues caused by `nn.init.trunc_normal_` described in\n+                        # https://github.com/huggingface/transformers/pull/27906#issuecomment-1846951332\n+                        n_elements_to_skip_on_each_side = int(n_elements * 0.025)\n+                        data_to_check = torch.sort(data).values\n+                        if n_elements_to_skip_on_each_side > 0:\n+                            data_to_check = data_to_check[\n+                                n_elements_to_skip_on_each_side:-n_elements_to_skip_on_each_side\n+                            ]\n                         self.assertIn(\n-                            ((param.data.mean() * 1e9).round() / 1e9).item(),\n+                            ((data_to_check.mean() * 1e9).round() / 1e9).item(),\n                             [0.0, 1.0],\n                             msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                         )"
        },
        {
            "sha": "c5701d508804b2cbeb87ec1b1ae354b342e1307e",
            "filename": "tests/models/dinov2_with_registers/test_modeling_dinov2_with_registers.py",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fdinov2_with_registers%2Ftest_modeling_dinov2_with_registers.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fdinov2_with_registers%2Ftest_modeling_dinov2_with_registers.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fdinov2_with_registers%2Ftest_modeling_dinov2_with_registers.py?ref=b8059e1f8f9ad245d71fbe2d18723d735ffccfec",
            "patch": "@@ -252,8 +252,17 @@ def test_initialization(self):\n             model = model_class(config=configs_no_init)\n             for name, param in model.named_parameters():\n                 if param.requires_grad and \"register_tokens\" not in name:\n+                    # See PR #38607 (to avoid flakiness)\n+                    data = torch.flatten(param.data)\n+                    n_elements = torch.numel(data)\n+                    # skip 2.5% of elements on each side to avoid issues caused by `nn.init.trunc_normal_` described in\n+                    # https://github.com/huggingface/transformers/pull/27906#issuecomment-1846951332\n+                    n_elements_to_skip_on_each_side = int(n_elements * 0.025)\n+                    data_to_check = torch.sort(data).values\n+                    if n_elements_to_skip_on_each_side > 0:\n+                        data_to_check = data_to_check[n_elements_to_skip_on_each_side:-n_elements_to_skip_on_each_side]\n                     self.assertIn(\n-                        ((param.data.mean() * 1e9).round() / 1e9).item(),\n+                        ((data_to_check.mean() * 1e9).round() / 1e9).item(),\n                         [0.0, 1.0],\n                         msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                     )"
        },
        {
            "sha": "3e3bfcc1f717e98dd8af55fc813bf24e3471e478",
            "filename": "tests/models/pix2struct/test_modeling_pix2struct.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fpix2struct%2Ftest_modeling_pix2struct.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fpix2struct%2Ftest_modeling_pix2struct.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fpix2struct%2Ftest_modeling_pix2struct.py?ref=b8059e1f8f9ad245d71fbe2d18723d735ffccfec",
            "patch": "@@ -544,8 +544,19 @@ def test_initialization(self):\n                             msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                         )\n                     else:\n+                        # See PR #38607 (to avoid flakiness)\n+                        data = torch.flatten(param.data)\n+                        n_elements = torch.numel(data)\n+                        # skip 2.5% of elements on each side to avoid issues caused by `nn.init.trunc_normal_` described in\n+                        # https://github.com/huggingface/transformers/pull/27906#issuecomment-1846951332\n+                        n_elements_to_skip_on_each_side = int(n_elements * 0.025)\n+                        data_to_check = torch.sort(data).values\n+                        if n_elements_to_skip_on_each_side > 0:\n+                            data_to_check = data_to_check[\n+                                n_elements_to_skip_on_each_side:-n_elements_to_skip_on_each_side\n+                            ]\n                         self.assertIn(\n-                            ((param.data.mean() * 1e9).round() / 1e9).item(),\n+                            ((data_to_check.mean() * 1e9).round() / 1e9).item(),\n                             [0.0, 1.0],\n                             msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                         )"
        },
        {
            "sha": "125d5418e8ec4c4e70978d0fbe05a3d7b0d2f23b",
            "filename": "tests/models/swin2sr/test_modeling_swin2sr.py",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fswin2sr%2Ftest_modeling_swin2sr.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b8059e1f8f9ad245d71fbe2d18723d735ffccfec/tests%2Fmodels%2Fswin2sr%2Ftest_modeling_swin2sr.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fswin2sr%2Ftest_modeling_swin2sr.py?ref=b8059e1f8f9ad245d71fbe2d18723d735ffccfec",
            "patch": "@@ -249,8 +249,17 @@ def test_initialization(self):\n                 if \"logit_scale\" in name:\n                     continue\n                 if param.requires_grad:\n+                    # See PR #38607 (to avoid flakiness)\n+                    data = torch.flatten(param.data)\n+                    n_elements = torch.numel(data)\n+                    # skip 2.5% of elements on each side to avoid issues caused by `nn.init.trunc_normal_` described in\n+                    # https://github.com/huggingface/transformers/pull/27906#issuecomment-1846951332\n+                    n_elements_to_skip_on_each_side = int(n_elements * 0.025)\n+                    data_to_check = torch.sort(data).values\n+                    if n_elements_to_skip_on_each_side > 0:\n+                        data_to_check = data_to_check[n_elements_to_skip_on_each_side:-n_elements_to_skip_on_each_side]\n                     self.assertIn(\n-                        ((param.data.mean() * 1e9).round() / 1e9).item(),\n+                        ((data_to_check.mean() * 1e9).round() / 1e9).item(),\n                         [0.0, 1.0],\n                         msg=f\"Parameter {name} of model {model_class} seems not properly initialized\",\n                     )"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 56,
        "deletions": 5
    }
}