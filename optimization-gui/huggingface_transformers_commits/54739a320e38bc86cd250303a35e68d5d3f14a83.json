{
    "author": "ArthurZucker",
    "message": "Self-speculation (Layer-Skip Llama) (#34240)\n\n* ðŸ˜…\r\n\r\n* early exit (#34244)\r\n\r\n* mvp\r\n\r\n* docs and tests\r\n\r\n* a few fixes\r\n\r\n* no shared cache\r\n\r\n* Apply suggestions from code review\r\n\r\nCo-authored-by: Mostafa Elhoushi <m.elhoushi@ieee.org>\r\n\r\n* docs\r\n\r\n* make fix-copies\r\n\r\n* cohere fix\r\n\r\n* [test all]\r\n\r\n* [test all] consistent model code copies\r\n\r\n* [test all] make fix-copies :D\r\n\r\n* Apply suggestions from code review\r\n\r\nCo-authored-by: Pedro Cuenca <pedro@huggingface.co>\r\nCo-authored-by: Mostafa Elhoushi <m.elhoushi@ieee.org>\r\n\r\n* Update src/transformers/generation/candidate_generator.py\r\n\r\n* Update src/transformers/generation/configuration_utils.py\r\n\r\nCo-authored-by: Pedro Cuenca <pedro@huggingface.co>\r\n\r\n* [test all] don't use a stand-alone attribute; fix test\r\n\r\n---------\r\n\r\nCo-authored-by: Joao Gante <joaofranciscocardosogante@gmail.com>\r\nCo-authored-by: Joao Gante <joao@huggingface.co>\r\nCo-authored-by: Mostafa Elhoushi <m.elhoushi@ieee.org>\r\nCo-authored-by: Pedro Cuenca <pedro@huggingface.co>",
    "sha": "54739a320e38bc86cd250303a35e68d5d3f14a83",
    "files": [
        {
            "sha": "380b39fe62acdf44a9ad9cf6e74d33b37c59fd55",
            "filename": "docs/source/en/generation_strategies.md",
            "status": "modified",
            "additions": 47,
            "deletions": 23,
            "changes": 70,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/docs%2Fsource%2Fen%2Fgeneration_strategies.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/docs%2Fsource%2Fen%2Fgeneration_strategies.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fgeneration_strategies.md?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -416,16 +416,6 @@ Assisted decoding assumes the main and assistant models have the same tokenizer,\n Currently, only greedy search and sampling are supported with assisted decoding, and assisted decoding doesn't support batched inputs.\n To learn more about assisted decoding, check [this blog post](https://huggingface.co/blog/assisted-generation).\n \n-#### Universal Assisted Decoding\n-\n-Universal Assisted Decoding (UAD) adds support for main and assistant models with different tokenizers.\n-To use it, simply pass the tokenizers using the `tokenizer` and `assistant_tokenizer` arguments (see below).\n-Internally, the main model input tokens are re-encoded into assistant model tokens, then candidate tokens are generated in the assistant encoding, which are\n-in turn re-encoded into main model candidate tokens. Validation then proceeds as explained above.\n-The re-encoding steps involve decoding token ids into text and then encoding the text using a different tokenizer.\n-Since re-encoding the tokens may result in tokenization discrepancies, UAD finds the longest common subsequence between the source and target encodings, \n-to ensure the new tokens include the correct prompt suffix.\n-\n To enable assisted decoding, set the `assistant_model` argument with a model.\n \n ```python\n@@ -445,7 +435,36 @@ To enable assisted decoding, set the `assistant_model` argument with a model.\n ['Alice and Bob are sitting in a bar. Alice is drinking a beer and Bob is drinking a']\n ```\n \n-If the main and assistant models have different tokenizers, use Universal Assisted Decoding.\n+When using assisted decoding with sampling methods, you can use the `temperature` argument to control the randomness,\n+just like in multinomial sampling. However, in assisted decoding, reducing the temperature may help improve the latency.\n+\n+```python\n+>>> from transformers import AutoModelForCausalLM, AutoTokenizer, set_seed\n+>>> set_seed(42)  # For reproducibility\n+\n+>>> prompt = \"Alice and Bob\"\n+>>> checkpoint = \"EleutherAI/pythia-1.4b-deduped\"\n+>>> assistant_checkpoint = \"EleutherAI/pythia-160m-deduped\"\n+\n+>>> tokenizer = AutoTokenizer.from_pretrained(checkpoint)\n+>>> inputs = tokenizer(prompt, return_tensors=\"pt\")\n+\n+>>> model = AutoModelForCausalLM.from_pretrained(checkpoint)\n+>>> assistant_model = AutoModelForCausalLM.from_pretrained(assistant_checkpoint)\n+>>> outputs = model.generate(**inputs, assistant_model=assistant_model, do_sample=True, temperature=0.5)\n+>>> tokenizer.batch_decode(outputs, skip_special_tokens=True)\n+['Alice and Bob, a couple of friends of mine, who are both in the same office as']\n+```\n+\n+#### Universal Assisted Decoding\n+\n+Universal Assisted Decoding (UAD) adds support for main and assistant models with different tokenizers.\n+To use it, simply pass the tokenizers using the `tokenizer` and `assistant_tokenizer` arguments (see below).\n+Internally, the main model input tokens are re-encoded into assistant model tokens, then candidate tokens are generated in the assistant encoding, which are\n+in turn re-encoded into main model candidate tokens. Validation then proceeds as explained above.\n+The re-encoding steps involve decoding token ids into text and then encoding the text using a different tokenizer.\n+Since re-encoding the tokens may result in tokenization discrepancies, UAD finds the longest common subsequence between the source and target encodings,\n+to ensure the new tokens include the correct prompt suffix.\n \n ```python\n >>> from transformers import AutoModelForCausalLM, AutoTokenizer\n@@ -465,30 +484,35 @@ If the main and assistant models have different tokenizers, use Universal Assist\n ['Alice and Bob are sitting in a bar. Alice is drinking a beer and Bob is drinking a']\n ```\n \n-When using assisted decoding with sampling methods, you can use the `temperature` argument to control the randomness,\n-just like in multinomial sampling. However, in assisted decoding, reducing the temperature may help improve the latency.\n+#### Prompt Lookup\n+\n+Alternatively, you can also set the `prompt_lookup_num_tokens` to trigger n-gram based assisted decoding, as opposed\n+to model based assisted decoding. You can read more about it [here](https://twitter.com/joao_gante/status/1747322413006643259).\n+\n+#### Self-Speculative Decoding\n+\n+An LLM can be trained to also use its language modeling head with earlier hidden states as input, effectively\n+skipping layers to yield a lower-quality output -- a technique called early exiting.\n+We use the lower-quality early exit output as an assistant output, and apply self-speculation to fix the output using the remaining layers. The final generation of that self-speculative solution is the same (or has the same distribution) as the original model's generation.\n+If the model you're using was trained to do early exit, you can pass\n+`assistant_early_exit` (integer). In this case, the assistant model will be the same model but exiting early, hence the\n+\"self-speculative\" name. Because the assistant model is a portion of the target model, caches and weights can be shared, which results in lower memory requirements. As in other assisted generation methods, the final generated result has the same quality as if no assistant had been used.\n \n ```python\n->>> from transformers import AutoModelForCausalLM, AutoTokenizer, set_seed\n->>> set_seed(42)  # For reproducibility\n+>>> from transformers import AutoModelForCausalLM, AutoTokenizer\n \n >>> prompt = \"Alice and Bob\"\n->>> checkpoint = \"EleutherAI/pythia-1.4b-deduped\"\n->>> assistant_checkpoint = \"EleutherAI/pythia-160m-deduped\"\n+>>> checkpoint = \"facebook/layerskip-llama3.2-1B\"\n \n >>> tokenizer = AutoTokenizer.from_pretrained(checkpoint)\n >>> inputs = tokenizer(prompt, return_tensors=\"pt\")\n \n >>> model = AutoModelForCausalLM.from_pretrained(checkpoint)\n->>> assistant_model = AutoModelForCausalLM.from_pretrained(assistant_checkpoint)\n->>> outputs = model.generate(**inputs, assistant_model=assistant_model, do_sample=True, temperature=0.5)\n+>>> outputs = model.generate(**inputs, assistant_early_exit=4, do_sample=False, max_new_tokens=20)\n >>> tokenizer.batch_decode(outputs, skip_special_tokens=True)\n-['Alice and Bob, a couple of friends of mine, who are both in the same office as']\n+['Alice and Bob are sitting in a bar. Alice is drinking a beer and Bob is drinking a']\n ```\n \n-Alternatively, you can also set the `prompt_lookup_num_tokens` to trigger n-gram based assisted decoding, as opposed\n-to model based assisted decoding. You can read more about it [here](https://twitter.com/joao_gante/status/1747322413006643259).\n-\n ### DoLa Decoding\n \n **D**ecoding by C**o**ntrasting **La**yers (DoLa) is a contrastive decoding strategy to improve the factuality and reduce the"
        },
        {
            "sha": "aeb184f7400ce7574a1e4478078b2764a533ac0b",
            "filename": "src/transformers/cache_utils.py",
            "status": "modified",
            "additions": 16,
            "deletions": 13,
            "changes": 29,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fcache_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fcache_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcache_utils.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -433,19 +433,22 @@ def update(\n             self._seen_tokens += key_states.shape[-2]\n \n         # Update the cache\n-        if len(self.key_cache) <= layer_idx:\n-            # There may be skipped layers, fill them with empty lists\n-            for _ in range(len(self.key_cache), layer_idx):\n-                self.key_cache.append([])\n-                self.value_cache.append([])\n-            self.key_cache.append(key_states)\n-            self.value_cache.append(value_states)\n-        elif len(self.key_cache[layer_idx]) == 0:  # fills previously skipped layers; checking for tensor causes errors\n-            self.key_cache[layer_idx] = key_states\n-            self.value_cache[layer_idx] = value_states\n-        else:\n-            self.key_cache[layer_idx] = torch.cat([self.key_cache[layer_idx], key_states], dim=-2)\n-            self.value_cache[layer_idx] = torch.cat([self.value_cache[layer_idx], value_states], dim=-2)\n+        if key_states is not None:\n+            if len(self.key_cache) <= layer_idx:\n+                # There may be skipped layers, fill them with empty lists\n+                for _ in range(len(self.key_cache), layer_idx):\n+                    self.key_cache.append([])\n+                    self.value_cache.append([])\n+                self.key_cache.append(key_states)\n+                self.value_cache.append(value_states)\n+            elif (\n+                len(self.key_cache[layer_idx]) == 0\n+            ):  # fills previously skipped layers; checking for tensor causes errors\n+                self.key_cache[layer_idx] = key_states\n+                self.value_cache[layer_idx] = value_states\n+            else:\n+                self.key_cache[layer_idx] = torch.cat([self.key_cache[layer_idx], key_states], dim=-2)\n+                self.value_cache[layer_idx] = torch.cat([self.value_cache[layer_idx], value_states], dim=-2)\n \n         return self.key_cache[layer_idx], self.value_cache[layer_idx]\n "
        },
        {
            "sha": "e2ed48433b1639d011cf5a77cde70b78a7ef392b",
            "filename": "src/transformers/generation/__init__.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2F__init__.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2F__init__.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fgeneration%2F__init__.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -49,6 +49,7 @@\n     _import_structure[\"candidate_generator\"] = [\n         \"AssistedCandidateGenerator\",\n         \"CandidateGenerator\",\n+        \"EarlyExitCandidateGenerator\",\n         \"PromptLookupCandidateGenerator\",\n     ]\n     _import_structure[\"logits_process\"] = [\n@@ -206,7 +207,12 @@\n     else:\n         from .beam_constraints import Constraint, ConstraintListState, DisjunctiveConstraint, PhrasalConstraint\n         from .beam_search import BeamHypotheses, BeamScorer, BeamSearchScorer, ConstrainedBeamSearchScorer\n-        from .candidate_generator import AssistedCandidateGenerator, CandidateGenerator, PromptLookupCandidateGenerator\n+        from .candidate_generator import (\n+            AssistedCandidateGenerator,\n+            CandidateGenerator,\n+            EarlyExitCandidateGenerator,\n+            PromptLookupCandidateGenerator,\n+        )\n         from .logits_process import (\n             AlternatingCodebooksLogitsProcessor,\n             ClassifierFreeGuidanceLogitsProcessor,"
        },
        {
            "sha": "d8344c25a6526ae3997a7b26a1d828736dccef58",
            "filename": "src/transformers/generation/candidate_generator.py",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2Fcandidate_generator.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2Fcandidate_generator.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fgeneration%2Fcandidate_generator.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -670,6 +670,62 @@ def update_candidate_strategy(self, input_ids: torch.LongTensor, scores: torch.F\n         return\n \n \n+class EarlyExitCandidateGenerator(AssistedCandidateGenerator):\n+    \"\"\"\n+    `CandidateGenerator` class to be used for assisted generation and speculative decoding. This class generates\n+    candidates through the use of **the model itself**, exiting early. Can only be used with models that support early\n+    exit, e.g., `facebook/layerskip-llama3.2-1B`.\n+\n+    Args:\n+        input_ids (`torch.LongTensor` of shape `(batch_size, sequence_length)`):\n+            Indices of input sequence tokens in the vocabulary. [What are input IDs?](../glossary#input-ids)\n+        assistant_model (`PreTrainedModel`):\n+            The original model. This model must support early exit (i.e. is trained to compute logits in earlier\n+            layers).\n+        generation_config (`~generation.GenerationConfig`, *optional*):\n+            The generation configuration to be used as base parametrization for the generation call.\n+        logits_processor (`LogitsProcessorList`):\n+            An instance of [`LogitsProcessorList`]. List of instances of class derived from [`LogitsProcessor`]\n+            used to modify the prediction scores of the language modeling head applied at each generation step.\n+        model_kwargs (`Dict`):\n+            The keyword arguments that will be passed to the main model, and are used as base inputs for the assistant\n+            model as well.\n+        inputs_tensor (`torch.Tensor`, *optional*):\n+            The model input tensor. In encoder-decoder models, this is the encoder input.\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        input_ids: torch.LongTensor,\n+        assistant_model: \"PreTrainedModel\",\n+        generation_config: \"GenerationConfig\",\n+        model_kwargs: Dict,\n+        inputs_tensor: Optional[torch.Tensor] = None,\n+        logits_processor: \"LogitsProcessorList\" = None,\n+    ):\n+        super().__init__(\n+            input_ids=input_ids,\n+            assistant_model=assistant_model,\n+            generation_config=generation_config,\n+            model_kwargs=model_kwargs,\n+            inputs_tensor=inputs_tensor,\n+            logits_processor=logits_processor,\n+        )\n+        # We have to move early exit out of the generation config, otherwise the assistant will also call `generate`\n+        # with early exit\n+        self.assistant_early_exit = self.generation_config.assistant_early_exit\n+        self.generation_config.assistant_early_exit = None\n+\n+    def get_candidates(self, input_ids: torch.LongTensor) -> Tuple[torch.LongTensor, Optional[torch.FloatTensor]]:\n+        # Temporarily sets the number of hidden layers to the early exit value\n+        base_model = getattr(self.assistant_model, self.assistant_model.base_model_prefix)\n+        original_num_hidden_layers = base_model.config.num_hidden_layers\n+        base_model.config.num_hidden_layers = self.assistant_early_exit\n+        candidate_ids, candidate_logits = super().get_candidates(input_ids)\n+        base_model.config.num_hidden_layers = original_num_hidden_layers\n+        return candidate_ids, candidate_logits\n+\n+\n def _crop_past_key_values(model, past_key_values, max_length):\n     \"\"\"Crops the past key values up to a certain maximum length.\"\"\"\n     new_past = []"
        },
        {
            "sha": "de62ee767aeda0c3c961605addbb6e8e726e3411",
            "filename": "src/transformers/generation/configuration_utils.py",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2Fconfiguration_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2Fconfiguration_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fgeneration%2Fconfiguration_utils.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -353,10 +353,13 @@ class GenerationConfig(PushToHubMixin):\n             than this threshold, the assistant model stops the current token generation iteration, even if the number of _speculative tokens_\n             (defined by `num_assistant_tokens`) is not yet reached. It is an unsupervised version of the dynamic speculation lookahead\n             from Dynamic Speculation Lookahead Accelerates Speculative Decoding of Large Language Models <https://arxiv.org/abs/2405.04304>.\n-        prompt_lookup_num_tokens (`int`, *optional*, default to `None`):\n+        prompt_lookup_num_tokens (`int`, *optional*):\n             The number of tokens to be output as candidate tokens.\n-        max_matching_ngram_size (`int`, *optional*, default to `None`):\n+        max_matching_ngram_size (`int`, *optional*):\n             The maximum ngram size to be considered for matching in the prompt. Default to 2 if not provided.\n+        assistant_early_exit(`int`, *optional*):\n+            If set to a positive integer, early exit of the model will be used as an assistant. Can only be used with\n+            models that support early exit (i.e. models where logits from intermediate layers can be interpreted by the LM head).\n \n         > Wild card\n \n@@ -454,10 +457,9 @@ def __init__(self, **kwargs):\n         self.num_assistant_tokens = kwargs.pop(\"num_assistant_tokens\", 20)\n         self.num_assistant_tokens_schedule = kwargs.pop(\"num_assistant_tokens_schedule\", \"constant\")\n         self.assistant_confidence_threshold = kwargs.pop(\"assistant_confidence_threshold\", 0.4)\n-\n-        # Prompt lookup decoding\n         self.prompt_lookup_num_tokens = kwargs.pop(\"prompt_lookup_num_tokens\", None)\n         self.max_matching_ngram_size = kwargs.pop(\"max_matching_ngram_size\", None)\n+        self.assistant_early_exit = kwargs.pop(\"assistant_early_exit\", None)\n \n         # Wild card\n         self.generation_kwargs = kwargs.pop(\"generation_kwargs\", {})\n@@ -534,7 +536,11 @@ def get_generation_mode(self, assistant_model: Optional[\"PreTrainedModel\"] = Non\n                 generation_mode = GenerationMode.BEAM_SEARCH\n \n         # Assisted generation may extend some generation modes\n-        if assistant_model is not None or self.prompt_lookup_num_tokens is not None:\n+        if (\n+            assistant_model is not None\n+            or self.prompt_lookup_num_tokens is not None\n+            or self.assistant_early_exit is not None\n+        ):\n             if generation_mode in (\"greedy_search\", \"sample\"):\n                 generation_mode = GenerationMode.ASSISTED_GENERATION\n             else:"
        },
        {
            "sha": "432b3142873d39344046c833abe6740313f762dc",
            "filename": "src/transformers/generation/utils.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2Futils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fgeneration%2Futils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fgeneration%2Futils.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -54,6 +54,7 @@\n     AssistedCandidateGenerator,\n     AssistedCandidateGeneratorDifferentTokenizers,\n     CandidateGenerator,\n+    EarlyExitCandidateGenerator,\n     PromptLookupCandidateGenerator,\n     _crop_past_key_values,\n     _prepare_attention_mask,\n@@ -822,7 +823,16 @@ def _get_candidate_generator(\n         \"\"\"\n         different_tokenizers = all(v is not None for v in (assistant_model, target_tokenizer, assistant_tokenizer))\n \n-        if generation_config.prompt_lookup_num_tokens is not None:\n+        if generation_config.assistant_early_exit is not None:\n+            candidate_generator = EarlyExitCandidateGenerator(\n+                input_ids=input_ids,\n+                assistant_model=self,\n+                generation_config=generation_config,\n+                model_kwargs=model_kwargs,\n+                inputs_tensor=inputs_tensor,\n+                logits_processor=logits_processor,\n+            )\n+        elif generation_config.prompt_lookup_num_tokens is not None:\n             candidate_generator = PromptLookupCandidateGenerator(\n                 eos_token_id=generation_config._eos_token_tensor,\n                 num_output_tokens=generation_config.prompt_lookup_num_tokens,"
        },
        {
            "sha": "d481d87e7ab8ed2e387c01d0e29fc01eb7489ea0",
            "filename": "src/transformers/models/cohere/modeling_cohere.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fcohere%2Fmodeling_cohere.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fcohere%2Fmodeling_cohere.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fcohere%2Fmodeling_cohere.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -890,7 +890,7 @@ def forward(\n         all_self_attns = () if output_attentions else None\n         next_decoder_cache = None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "52d029950161679f0ab2ba0ce33a9379c6a046a3",
            "filename": "src/transformers/models/gemma/modeling_gemma.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma%2Fmodeling_gemma.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma%2Fmodeling_gemma.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma%2Fmodeling_gemma.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -808,7 +808,7 @@ def forward(\n         all_self_attns = () if output_attentions else None\n         next_decoder_cache = None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "ad1348ae5e3163fa9878fcfe63160deca709c9b6",
            "filename": "src/transformers/models/gemma/modular_gemma.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma%2Fmodular_gemma.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma%2Fmodular_gemma.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma%2Fmodular_gemma.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -886,7 +886,7 @@ def forward(\n         all_self_attns = () if output_attentions else None\n         next_decoder_cache = None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "c439ec069f7a938d7c0eca91d3402a12d166c78c",
            "filename": "src/transformers/models/gemma2/modeling_gemma2.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma2%2Fmodeling_gemma2.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma2%2Fmodeling_gemma2.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma2%2Fmodeling_gemma2.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -823,7 +823,7 @@ def forward(\n         all_hidden_states = () if output_hidden_states else None\n         all_self_attns = () if output_attentions else None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "ff2d42d671c3c43daa75e34325f69c6f918ace86",
            "filename": "src/transformers/models/gemma2/modular_gemma2.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma2%2Fmodular_gemma2.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fgemma2%2Fmodular_gemma2.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma2%2Fmodular_gemma2.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -653,7 +653,7 @@ def forward(\n         all_hidden_states = () if output_hidden_states else None\n         all_self_attns = () if output_attentions else None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "9080b5b9cc7c39c4e8bc735a535d3abbf53bb8ea",
            "filename": "src/transformers/models/glm/modeling_glm.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fglm%2Fmodeling_glm.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fglm%2Fmodeling_glm.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fglm%2Fmodeling_glm.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -789,7 +789,7 @@ def forward(\n         all_self_attns = () if output_attentions else None\n         next_decoder_cache = None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "0408bb73c7f2da0bc8a571ea20239993953ca4aa",
            "filename": "src/transformers/models/llama/modeling_llama.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fllama%2Fmodeling_llama.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Fllama%2Fmodeling_llama.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fllama%2Fmodeling_llama.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -893,7 +893,7 @@ def forward(\n         all_self_attns = () if output_attentions else None\n         next_decoder_cache = None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "169827ffd75777dfe380d2301a2287c4f16975dd",
            "filename": "src/transformers/models/olmoe/modeling_olmoe.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Folmoe%2Fmodeling_olmoe.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/src%2Ftransformers%2Fmodels%2Folmoe%2Fmodeling_olmoe.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Folmoe%2Fmodeling_olmoe.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -995,7 +995,7 @@ def forward(\n         all_router_logits = () if output_router_logits else None\n         next_decoder_cache = None\n \n-        for decoder_layer in self.layers:\n+        for decoder_layer in self.layers[: self.config.num_hidden_layers]:\n             if output_hidden_states:\n                 all_hidden_states += (hidden_states,)\n "
        },
        {
            "sha": "6630fc2ba9d15201ef9e8f3a3ccd3260830b49e3",
            "filename": "tests/generation/test_utils.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/huggingface/transformers/blob/54739a320e38bc86cd250303a35e68d5d3f14a83/tests%2Fgeneration%2Ftest_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/54739a320e38bc86cd250303a35e68d5d3f14a83/tests%2Fgeneration%2Ftest_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fgeneration%2Ftest_utils.py?ref=54739a320e38bc86cd250303a35e68d5d3f14a83",
            "patch": "@@ -4108,6 +4108,28 @@ def test_generate_compile_fullgraph_tiny(self):\n         gen_out = compiled_generate(**model_inputs, generation_config=generation_config)\n         self.assertTrue(gen_out.shape[1] > model_inputs[\"input_ids\"].shape[1])  # some text was generated\n \n+    def test_assisted_generation_early_exit(self):\n+        \"\"\"\n+        Tests that assisted generation with early exit works as expected. Under the hood, this has complex cache\n+        manipulation, which will cause the test to fail if something goes wrong there.\n+        \"\"\"\n+        expected_output = \"Alice and Bob are playing a game of poker. Alice has a pair of 8s and Bob has a pair\"\n+\n+        prompt = \"Alice and Bob\"\n+        checkpoint = \"facebook/layerskip-llama3.2-1B\"\n+\n+        tokenizer = AutoTokenizer.from_pretrained(checkpoint)\n+        inputs = tokenizer(prompt, return_tensors=\"pt\").to(torch_device)\n+\n+        model = AutoModelForCausalLM.from_pretrained(checkpoint).to(torch_device)\n+        original_outputs = model.generate(**inputs, do_sample=False, max_new_tokens=20)\n+        original_decoded = tokenizer.batch_decode(original_outputs, skip_special_tokens=True)\n+        self.assertEqual(original_decoded, [expected_output])\n+\n+        outputs_assisted = model.generate(**inputs, assistant_early_exit=4, do_sample=False, max_new_tokens=20)\n+        decoded_assisted = tokenizer.batch_decode(outputs_assisted, skip_special_tokens=True)\n+        self.assertEqual(decoded_assisted, [expected_output])\n+\n \n @require_torch\n class TokenHealingTestCase(unittest.TestCase):"
        }
    ],
    "stats": {
        "total": 229,
        "additions": 178,
        "deletions": 51
    }
}