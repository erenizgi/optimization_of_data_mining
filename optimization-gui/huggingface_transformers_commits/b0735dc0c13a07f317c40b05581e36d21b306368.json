{
    "author": "zucchini-nlp",
    "message": "[paligemma] fix processor with suffix (#38365)\n\nfix pg processor",
    "sha": "b0735dc0c13a07f317c40b05581e36d21b306368",
    "files": [
        {
            "sha": "a630c4720edb2fb8c9f15ce5b96d3fd3fa8b60a6",
            "filename": "src/transformers/models/paligemma/processing_paligemma.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/huggingface/transformers/blob/b0735dc0c13a07f317c40b05581e36d21b306368/src%2Ftransformers%2Fmodels%2Fpaligemma%2Fprocessing_paligemma.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b0735dc0c13a07f317c40b05581e36d21b306368/src%2Ftransformers%2Fmodels%2Fpaligemma%2Fprocessing_paligemma.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fpaligemma%2Fprocessing_paligemma.py?ref=b0735dc0c13a07f317c40b05581e36d21b306368",
            "patch": "@@ -315,7 +315,8 @@ def __call__(\n         return_data = {**inputs, \"pixel_values\": pixel_values}\n \n         if return_token_type_ids:\n-            labels = inputs[\"input_ids\"].masked_fill(inputs[\"token_type_ids\"] == 0, -100)\n+            labels = np.array(inputs[\"input_ids\"])\n+            labels[np.array(inputs[\"token_type_ids\"]) == 0] = -100\n             return_data.update({\"labels\": labels})\n \n         if return_mm_token_type_ids:"
        },
        {
            "sha": "56e74928925dbfb282131b4654296b14353bca25",
            "filename": "tests/models/paligemma/test_processor_paligemma.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/huggingface/transformers/blob/b0735dc0c13a07f317c40b05581e36d21b306368/tests%2Fmodels%2Fpaligemma%2Ftest_processor_paligemma.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b0735dc0c13a07f317c40b05581e36d21b306368/tests%2Fmodels%2Fpaligemma%2Ftest_processor_paligemma.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fpaligemma%2Ftest_processor_paligemma.py?ref=b0735dc0c13a07f317c40b05581e36d21b306368",
            "patch": "@@ -62,6 +62,20 @@ def test_image_seq_length(self):\n         )\n         self.assertEqual(len(inputs[\"input_ids\"][0]), 112)\n \n+    @require_torch\n+    def test_call_with_suffix(self):\n+        input_str = \"lower newer\"\n+        suffix = \"upper older longer string\"\n+        image_input = self.prepare_image_inputs()\n+        processor = self.get_processor()\n+        inputs = processor(text=input_str, images=image_input, suffix=suffix)\n+        self.assertTrue(\"labels\" in inputs)\n+        self.assertEqual(len(inputs[\"labels\"][0]), len(inputs[\"input_ids\"][0]))\n+\n+        inputs = processor(text=input_str, images=image_input, suffix=suffix, return_tensors=\"pt\")\n+        self.assertTrue(\"labels\" in inputs)\n+        self.assertEqual(len(inputs[\"labels\"][0]), len(inputs[\"input_ids\"][0]))\n+\n     def test_text_with_image_tokens(self):\n         image_processor = self.get_component(\"image_processor\")\n         tokenizer = self.get_component(\"tokenizer\")"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 16,
        "deletions": 1
    }
}