{
    "author": "yonigozlan",
    "message": "Add support for fast image processors in add-new-model-like CLI (#36313)\n\n* add support for fast image processors in add-new-model-like\n\n* fix header not found add-fast-image-processor-cli\n\n* Encourage adding fast image processor\n\n* nit\n\n* start improve doc\n\n* update docs\n\n* make requested modifs",
    "sha": "69bc848480d5f19a537a70ce14f09816b00cd80f",
    "files": [
        {
            "sha": "419b1dced4126f47ad40f84ff0569cd77cb6630c",
            "filename": "docs/source/en/add_new_model.md",
            "status": "modified",
            "additions": 44,
            "deletions": 2,
            "changes": 46,
            "blob_url": "https://github.com/huggingface/transformers/blob/69bc848480d5f19a537a70ce14f09816b00cd80f/docs%2Fsource%2Fen%2Fadd_new_model.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/69bc848480d5f19a537a70ce14f09816b00cd80f/docs%2Fsource%2Fen%2Fadd_new_model.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fadd_new_model.md?ref=69bc848480d5f19a537a70ce14f09816b00cd80f",
            "patch": "@@ -476,7 +476,7 @@ When both implementations produce the same output, verify the outputs are within\n torch.allclose(original_output, output, atol=1e-3)\n ```\n \n-This is typically the most difficult part of the process. Congratulations if you've made it this far! \n+This is typically the most difficult part of the process. Congratulations if you've made it this far!\n \n And if you're stuck or struggling with this step, don't hesitate to ask for help on your pull request.\n \n@@ -541,6 +541,48 @@ input_ids = tokenizer(input_str).input_ids\n \n When both implementations have the same `input_ids`, add a tokenizer test file. This file is analogous to the modeling test files. The tokenizer test files should contain a couple of hardcoded integration tests.\n \n+## Implement image processor\n+\n+> [!TIP]\n+> Fast image processors use the [torchvision](https://pytorch.org/vision/stable/index.html) library and can perform image processing on the GPU, significantly improving processing speed.\n+> We recommend adding a fast image processor ([`BaseImageProcessorFast`]) in addition to the \"slow\" image processor ([`BaseImageProcessor`]) to provide users with the best performance. Feel free to tag [@yonigozlan](https://github.com/yonigozlan) for help adding a [`BaseImageProcessorFast`].\n+\n+While this example doesn't include an image processor, you may need to implement one if your model requires image inputs. The image processor is responsible for converting images into a format suitable for your model. Before implementing a new one, check whether an existing image processor in the Transformers library can be reused, as many models share similar image processing techniques. Note that you can also use [modular](./modular_transformers) for image processors to reuse existing components.\n+\n+If you do need to implement a new image processor, refer to an existing image processor to understand the expected structure. Slow image processors ([`BaseImageProcessor`]) and fast image processors ([`BaseImageProcessorFast`]) are designed differently, so make sure you follow the correct structure based on the processor type you're implementing.\n+\n+Run the following command (only if you haven't already created the fast image processor with the `transformers-cli add-new-model-like` command) to generate the necessary imports and to create a prefilled template for the fast image processor. Modify the template to fit your model.\n+\n+```bash\n+transformers-cli add-fast-image-processor --model-name your_model_name\n+```\n+\n+This command will generate the necessary imports and provide a pre-filled template for the fast image processor. You can then modify it to fit your model's needs.\n+\n+Add tests for the image processor in `tests/models/your_model_name/test_image_processing_your_model_name.py`. These tests should be similar to those for other image processors and should verify that the image processor correctly handles image inputs. If your image processor includes unique features or processing methods, ensure you add specific tests for those as well.\n+\n+## Implement processor\n+\n+If your model accepts multiple modalities, like text and images, you need to add a processor. The processor centralizes the preprocessing of different modalities before passing them to the model.\n+\n+The processor should call the appropriate modality-specific processors within its `__call__` function to handle each type of input correctly. Be sure to check existing processors in the library to understand their expected structure. Transformers uses the following convention in the `__call__` function signature.\n+\n+```python\n+def __call__(\n+    self,\n+    images: ImageInput = None,\n+    text: Union[TextInput, PreTokenizedInput, List[TextInput], List[PreTokenizedInput]] = None,\n+    audio=None,\n+    videos=None,\n+    **kwargs: Unpack[YourModelProcessorKwargs],\n+) -> BatchFeature:\n+    ...\n+```\n+\n+`YourModelProcessorKwargs` is a `TypedDict` that includes all the typical processing arguments and any extra arguments a specific processor may require.\n+\n+Add tests for the processor in `tests/models/your_model_name/test_processor_your_model_name.py`. These tests should be similar to those for other processors and should verify that the processor correctly handles the different modalities.\n+\n ## Integration tests\n \n Now that you have a model and tokenizer, add end-to-end integration tests for the model and tokenizer to `tests/models/brand_new_llama/test_modeling_brand_new_llama.py`.\n@@ -620,4 +662,4 @@ There are four timelines for model additions depending on the model contributor\n \n - **Hub-first release**: Transformers [remote-code](./models#custom-models) feature allows Transformers-based projects to be shared directly on the Hub. This is a good option if you don't have the bandwidth to add a model directly to Transformers.\n \n-  If a model ends up being very popular, then it's very likely that we'll integrate it in Transformers ourselves to enable better support (documentation, maintenance, optimization, etc.) for it. A Hub-first release is the most frictionless way to add a model.\n\\ No newline at end of file\n+  If a model ends up being very popular, then it's very likely that we'll integrate it in Transformers ourselves to enable better support (documentation, maintenance, optimization, etc.) for it. A Hub-first release is the most frictionless way to add a model."
        },
        {
            "sha": "a78fc2a7cf2d69f786f0ea2f1cb06af7ec5304b5",
            "filename": "src/transformers/commands/add_fast_image_processor.py",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/huggingface/transformers/blob/69bc848480d5f19a537a70ce14f09816b00cd80f/src%2Ftransformers%2Fcommands%2Fadd_fast_image_processor.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/69bc848480d5f19a537a70ce14f09816b00cd80f/src%2Ftransformers%2Fcommands%2Fadd_fast_image_processor.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fadd_fast_image_processor.py?ref=69bc848480d5f19a537a70ce14f09816b00cd80f",
            "patch": "@@ -414,11 +414,35 @@ def get_fast_image_processing_content_header(content: str) -> str:\n     \"\"\"\n     Get the header of the slow image processor file.\n     \"\"\"\n-    # get all lines before and including the line containing \"\"\"Image processor\n-    content_header = re.search(r\"^(.*?\\n)*?\\\"\\\"\\\"Image processor.*\", content)\n+    # get all the commented lines at the beginning of the file\n+    content_header = re.search(r\"^# coding=utf-8\\n(#[^\\n]*\\n)*\", content, re.MULTILINE)\n+    if not content_header:\n+        logger.warning(\"Couldn't find the content header in the slow image processor file. Using a default header.\")\n+        return (\n+            f\"# coding=utf-8\\n\"\n+            f\"# Copyright {CURRENT_YEAR} The HuggingFace Team. All rights reserved.\\n\"\n+            f\"#\\n\"\n+            f'# Licensed under the Apache License, Version 2.0 (the \"License\");\\n'\n+            f\"# you may not use this file except in compliance with the License.\\n\"\n+            f\"# You may obtain a copy of the License at\\n\"\n+            f\"#\\n\"\n+            f\"#     http://www.apache.org/licenses/LICENSE-2.0\\n\"\n+            f\"#\\n\"\n+            f\"# Unless required by applicable law or agreed to in writing, software\\n\"\n+            f'# distributed under the License is distributed on an \"AS IS\" BASIS,\\n'\n+            f\"# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\\n\"\n+            f\"# See the License for the specific language governing permissions and\\n\"\n+            f\"# limitations under the License.\\n\"\n+            f\"\\n\"\n+        )\n     content_header = content_header.group(0)\n+    # replace the year in the copyright\n     content_header = re.sub(r\"# Copyright (\\d+)\\s\", f\"# Copyright {CURRENT_YEAR} \", content_header)\n-    content_header = content_header.replace(\"Image processor\", \"Fast Image processor\")\n+    # get the line starting with \"\"\"Image processor in content if it exists\n+    match = re.search(r'^\"\"\"Image processor.*$', content, re.MULTILINE)\n+    if match:\n+        content_header += match.group(0).replace(\"Image processor\", \"Fast Image processor\")\n+\n     return content_header\n \n "
        },
        {
            "sha": "badf6f0a4048e797230028651f9da9ef488e6df7",
            "filename": "src/transformers/commands/add_new_model_like.py",
            "status": "modified",
            "additions": 86,
            "deletions": 13,
            "changes": 99,
            "blob_url": "https://github.com/huggingface/transformers/blob/69bc848480d5f19a537a70ce14f09816b00cd80f/src%2Ftransformers%2Fcommands%2Fadd_new_model_like.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/69bc848480d5f19a537a70ce14f09816b00cd80f/src%2Ftransformers%2Fcommands%2Fadd_new_model_like.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fadd_new_model_like.py?ref=69bc848480d5f19a537a70ce14f09816b00cd80f",
            "patch": "@@ -29,6 +29,7 @@\n from ..models.auto.configuration_auto import model_type_to_module_name\n from ..utils import is_flax_available, is_tf_available, is_torch_available, logging\n from . import BaseTransformersCLICommand\n+from .add_fast_image_processor import add_fast_image_processor\n \n \n logger = logging.get_logger(__name__)  # pylint: disable=invalid-name\n@@ -66,6 +67,9 @@ class ModelPatterns:\n         image_processor_class (`str`, *optional*):\n             The image processor class associated with this model (leave to `None` for models that don't use an image\n             processor).\n+        image_processor_fast_class (`str`, *optional*):\n+            The fast image processor class associated with this model (leave to `None` for models that don't use a fast\n+            image processor).\n         feature_extractor_class (`str`, *optional*):\n             The feature extractor class associated with this model (leave to `None` for models that don't use a feature\n             extractor).\n@@ -82,6 +86,7 @@ class ModelPatterns:\n     config_class: Optional[str] = None\n     tokenizer_class: Optional[str] = None\n     image_processor_class: Optional[str] = None\n+    image_processor_fast_class: Optional[str] = None\n     feature_extractor_class: Optional[str] = None\n     processor_class: Optional[str] = None\n \n@@ -107,6 +112,7 @@ def __post_init__(self):\n     \"config_class\": \"[CONFIG_CLASS]\",\n     \"tokenizer_class\": \"[TOKENIZER_CLASS]\",\n     \"image_processor_class\": \"[IMAGE_PROCESSOR_CLASS]\",\n+    \"image_processor_fast_class\": \"[IMAGE_PROCESSOR_FAST_CLASS]\",\n     \"feature_extractor_class\": \"[FEATURE_EXTRACTOR_CLASS]\",\n     \"processor_class\": \"[PROCESSOR_CLASS]\",\n     \"checkpoint\": \"[CHECKPOINT]\",\n@@ -339,7 +345,13 @@ def replace_model_patterns(\n     # contains the camel-cased named, but will be treated before.\n     attributes_to_check = [\"config_class\"]\n     # Add relevant preprocessing classes\n-    for attr in [\"tokenizer_class\", \"image_processor_class\", \"feature_extractor_class\", \"processor_class\"]:\n+    for attr in [\n+        \"tokenizer_class\",\n+        \"image_processor_class\",\n+        \"image_processor_fast_class\",\n+        \"feature_extractor_class\",\n+        \"processor_class\",\n+    ]:\n         if getattr(old_model_patterns, attr) is not None and getattr(new_model_patterns, attr) is not None:\n             attributes_to_check.append(attr)\n \n@@ -763,10 +775,10 @@ def retrieve_info_for_model(model_type, frameworks: Optional[List[str]] = None):\n         tokenizer_class = None\n     image_processor_classes = auto_module.image_processing_auto.IMAGE_PROCESSOR_MAPPING_NAMES.get(model_type, None)\n     if isinstance(image_processor_classes, tuple):\n-        image_processor_class = image_processor_classes[0]  # we take the slow image processor class.\n+        image_processor_class, image_processor_fast_class = image_processor_classes\n     else:\n         image_processor_class = image_processor_classes\n-\n+        image_processor_fast_class = None\n     feature_extractor_class = auto_module.feature_extraction_auto.FEATURE_EXTRACTOR_MAPPING_NAMES.get(model_type, None)\n     processor_class = auto_module.processing_auto.PROCESSOR_MAPPING_NAMES.get(model_type, None)\n \n@@ -800,6 +812,7 @@ def retrieve_info_for_model(model_type, frameworks: Optional[List[str]] = None):\n         config_class=config_class,\n         tokenizer_class=tokenizer_class,\n         image_processor_class=image_processor_class,\n+        image_processor_fast_class=image_processor_fast_class,\n         feature_extractor_class=feature_extractor_class,\n         processor_class=processor_class,\n     )\n@@ -957,6 +970,7 @@ def add_model_to_main_init(\n                 processing_classes = [\n                     old_model_patterns.tokenizer_class,\n                     old_model_patterns.image_processor_class,\n+                    old_model_patterns.image_processor_fast_class,\n                     old_model_patterns.feature_extractor_class,\n                     old_model_patterns.processor_class,\n                 ]\n@@ -1034,7 +1048,7 @@ def insert_tokenizer_in_auto_module(old_model_patterns: ModelPatterns, new_model\n         '        (\"{model_type}\", \"{pretrained_archive_map}\"),',\n     ],\n     \"feature_extraction_auto.py\": ['        (\"{model_type}\", \"{feature_extractor_class}\"),'],\n-    \"image_processing_auto.py\": ['        (\"{model_type}\", \"{image_processor_class}\"),'],\n+    \"image_processing_auto.py\": ['        (\"{model_type}\", \"{image_processor_classes}\"),'],\n     \"modeling_auto.py\": ['        (\"{model_type}\", \"{any_pt_class}\"),'],\n     \"modeling_tf_auto.py\": ['        (\"{model_type}\", \"{any_tf_class}\"),'],\n     \"modeling_flax_auto.py\": ['        (\"{model_type}\", \"{any_flax_class}\"),'],\n@@ -1068,14 +1082,27 @@ def add_model_to_auto_classes(\n                     )\n             elif \"{config_class}\" in pattern:\n                 new_patterns.append(pattern.replace(\"{config_class}\", old_model_patterns.config_class))\n-            elif \"{image_processor_class}\" in pattern:\n+            elif \"{image_processor_classes}\" in pattern:\n                 if (\n                     old_model_patterns.image_processor_class is not None\n                     and new_model_patterns.image_processor_class is not None\n                 ):\n-                    new_patterns.append(\n-                        pattern.replace(\"{image_processor_class}\", old_model_patterns.image_processor_class)\n-                    )\n+                    if (\n+                        old_model_patterns.image_processor_fast_class is not None\n+                        and new_model_patterns.image_processor_fast_class is not None\n+                    ):\n+                        new_patterns.append(\n+                            pattern.replace(\n+                                '\"{image_processor_classes}\"',\n+                                f'(\"{old_model_patterns.image_processor_class}\", \"{old_model_patterns.image_processor_fast_class}\")',\n+                            )\n+                        )\n+                    else:\n+                        new_patterns.append(\n+                            pattern.replace(\n+                                '\"{image_processor_classes}\"', f'(\"{old_model_patterns.image_processor_class}\",)'\n+                            )\n+                        )\n             elif \"{feature_extractor_class}\" in pattern:\n                 if (\n                     old_model_patterns.feature_extractor_class is not None\n@@ -1101,7 +1128,6 @@ def add_model_to_auto_classes(\n             new_model_line = new_model_line.replace(\n                 old_model_patterns.model_camel_cased, new_model_patterns.model_camel_cased\n             )\n-\n             add_content_to_file(full_name, new_model_line, add_after=old_model_line)\n \n     # Tokenizers require special handling\n@@ -1198,6 +1224,10 @@ def duplicate_doc_file(\n                 # We only add the image processor if necessary\n                 if old_model_patterns.image_processor_class != new_model_patterns.image_processor_class:\n                     new_blocks.append(new_block)\n+            elif \"ImageProcessorFast\" in block_class:\n+                # We only add the image processor if necessary\n+                if old_model_patterns.image_processor_fast_class != new_model_patterns.image_processor_fast_class:\n+                    new_blocks.append(new_block)\n             elif \"FeatureExtractor\" in block_class:\n                 # We only add the feature extractor if necessary\n                 if old_model_patterns.feature_extractor_class != new_model_patterns.feature_extractor_class:\n@@ -1281,6 +1311,7 @@ def create_new_model_like(\n     add_copied_from: bool = True,\n     frameworks: Optional[List[str]] = None,\n     old_checkpoint: Optional[str] = None,\n+    create_fast_image_processor: bool = False,\n ):\n     \"\"\"\n     Creates a new model module like a given model of the Transformers library.\n@@ -1295,6 +1326,8 @@ def create_new_model_like(\n         old_checkpoint (`str`, *optional*):\n             The name of the base checkpoint for the old model. Should be passed along when it can't be automatically\n             recovered from the `model_type`.\n+        create_fast_image_processor (`bool`, *optional*, defaults to `False`):\n+            Whether or not to add a fast image processor to the new model, if the old model had only a slow one.\n     \"\"\"\n     # Retrieve all the old model info.\n     model_info = retrieve_info_for_model(model_type, frameworks=frameworks)\n@@ -1309,7 +1342,13 @@ def create_new_model_like(\n         )\n \n     keep_old_processing = True\n-    for processing_attr in [\"image_processor_class\", \"feature_extractor_class\", \"processor_class\", \"tokenizer_class\"]:\n+    for processing_attr in [\n+        \"image_processor_class\",\n+        \"image_processor_fast_class\",\n+        \"feature_extractor_class\",\n+        \"processor_class\",\n+        \"tokenizer_class\",\n+    ]:\n         if getattr(old_model_patterns, processing_attr) != getattr(new_model_patterns, processing_attr):\n             keep_old_processing = False\n \n@@ -1416,7 +1455,11 @@ def disable_fx_test(filename: Path) -> bool:\n     duplicate_doc_file(doc_file, old_model_patterns, new_model_patterns, frameworks=frameworks)\n     insert_model_in_doc_toc(old_model_patterns, new_model_patterns)\n \n-    # 6. Warn the user for duplicate patterns\n+    # 6. Add fast image processor if necessary\n+    if create_fast_image_processor:\n+        add_fast_image_processor(model_name=new_model_patterns.model_lower_cased)\n+\n+    # 7. Warn the user for duplicate patterns\n     if old_model_patterns.model_type == old_model_patterns.checkpoint:\n         print(\n             \"The model you picked has the same name for the model type and the checkpoint name \"\n@@ -1484,6 +1527,7 @@ def __init__(self, config_file=None, path_to_repo=None, *args):\n                 self.add_copied_from,\n                 self.frameworks,\n                 self.old_checkpoint,\n+                self.create_fast_image_processor,\n             ) = get_user_input()\n \n         self.path_to_repo = path_to_repo\n@@ -1503,6 +1547,7 @@ def run(self):\n             add_copied_from=self.add_copied_from,\n             frameworks=self.frameworks,\n             old_checkpoint=self.old_checkpoint,\n+            create_fast_image_processor=self.create_fast_image_processor,\n         )\n \n \n@@ -1594,6 +1639,7 @@ def get_user_input():\n     old_model_info = retrieve_info_for_model(old_model_type)\n     old_tokenizer_class = old_model_info[\"model_patterns\"].tokenizer_class\n     old_image_processor_class = old_model_info[\"model_patterns\"].image_processor_class\n+    old_image_processor_fast_class = old_model_info[\"model_patterns\"].image_processor_fast_class\n     old_feature_extractor_class = old_model_info[\"model_patterns\"].feature_extractor_class\n     old_processor_class = old_model_info[\"model_patterns\"].processor_class\n     old_frameworks = old_model_info[\"frameworks\"]\n@@ -1634,7 +1680,13 @@ def get_user_input():\n \n     old_processing_classes = [\n         c if not isinstance(c, tuple) else c[0]\n-        for c in [old_image_processor_class, old_feature_extractor_class, old_tokenizer_class, old_processor_class]\n+        for c in [\n+            old_image_processor_class,\n+            old_image_processor_fast_class,\n+            old_feature_extractor_class,\n+            old_tokenizer_class,\n+            old_processor_class,\n+        ]\n         if c is not None\n     ]\n     old_processing_classes = \", \".join(old_processing_classes)\n@@ -1645,9 +1697,11 @@ def get_user_input():\n     )\n     if keep_processing:\n         image_processor_class = old_image_processor_class\n+        image_processor_fast_class = old_image_processor_fast_class\n         feature_extractor_class = old_feature_extractor_class\n         processor_class = old_processor_class\n         tokenizer_class = old_tokenizer_class\n+        create_fast_image_processor = False\n     else:\n         if old_tokenizer_class is not None:\n             tokenizer_class = get_user_field(\n@@ -1663,6 +1717,13 @@ def get_user_input():\n             )\n         else:\n             image_processor_class = None\n+        if old_image_processor_fast_class is not None:\n+            image_processor_fast_class = get_user_field(\n+                \"What will be the name of the fast image processor class for this model? \",\n+                default_value=f\"{model_camel_cased}ImageProcessorFast\",\n+            )\n+        else:\n+            image_processor_fast_class = None\n         if old_feature_extractor_class is not None:\n             feature_extractor_class = get_user_field(\n                 \"What will be the name of the feature extractor class for this model? \",\n@@ -1677,6 +1738,16 @@ def get_user_input():\n             )\n         else:\n             processor_class = None\n+        if old_image_processor_class is not None and old_image_processor_fast_class is None:\n+            create_fast_image_processor = get_user_field(\n+                \"A fast image processor can be created from the slow one, but modifications might be needed. \"\n+                \"Should we add a fast image processor class for this model (recommended, yes/no)? \",\n+                convert_to=convert_to_bool,\n+                default_value=\"yes\",\n+                fallback_message=\"Please answer yes/no, y/n, true/false or 1/0.\",\n+            )\n+        else:\n+            create_fast_image_processor = False\n \n     model_patterns = ModelPatterns(\n         model_name,\n@@ -1688,6 +1759,7 @@ def get_user_input():\n         config_class=config_class,\n         tokenizer_class=tokenizer_class,\n         image_processor_class=image_processor_class,\n+        image_processor_fast_class=image_processor_fast_class,\n         feature_extractor_class=feature_extractor_class,\n         processor_class=processor_class,\n     )\n@@ -1706,6 +1778,7 @@ def get_user_input():\n         default_value=\"yes\",\n         fallback_message=\"Please answer yes/no, y/n, true/false or 1/0.\",\n     )\n+\n     if all_frameworks:\n         frameworks = None\n     else:\n@@ -1715,4 +1788,4 @@ def get_user_input():\n         )\n         frameworks = list(set(frameworks.split(\" \")))\n \n-    return (old_model_type, model_patterns, add_copied_from, frameworks, old_checkpoint)\n+    return (old_model_type, model_patterns, add_copied_from, frameworks, old_checkpoint, create_fast_image_processor)"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 157,
        "deletions": 18
    }
}