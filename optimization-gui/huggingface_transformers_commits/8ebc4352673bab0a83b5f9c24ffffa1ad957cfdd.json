{
    "author": "Rocketknight1",
    "message": "Fix llava_onevision tests (#37280)\n\n* Fix llava_onevision tests\n\n* Trigger tests",
    "sha": "8ebc4352673bab0a83b5f9c24ffffa1ad957cfdd",
    "files": [
        {
            "sha": "485da75c767f8b0bf8ec81605caa168148ba1f8d",
            "filename": "tests/models/llava_onevision/test_processor_llava_onevision.py",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/8ebc4352673bab0a83b5f9c24ffffa1ad957cfdd/tests%2Fmodels%2Fllava_onevision%2Ftest_processor_llava_onevision.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/8ebc4352673bab0a83b5f9c24ffffa1ad957cfdd/tests%2Fmodels%2Fllava_onevision%2Ftest_processor_llava_onevision.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fllava_onevision%2Ftest_processor_llava_onevision.py?ref=8ebc4352673bab0a83b5f9c24ffffa1ad957cfdd",
            "patch": "@@ -39,17 +39,19 @@\n class LlavaOnevisionProcessorTest(ProcessorTesterMixin, unittest.TestCase):\n     processor_class = LlavaOnevisionProcessor\n \n-    def setUp(self):\n-        self.tmpdirname = tempfile.mkdtemp()\n+    @classmethod\n+    def setUpClass(cls):\n+        cls.tmpdirname = tempfile.mkdtemp()\n+        cls.addClassCleanup(lambda tempdir=cls.tmpdirname: shutil.rmtree(tempdir))\n         image_processor = LlavaOnevisionImageProcessor()\n         video_processor = LlavaOnevisionVideoProcessor()\n         tokenizer = Qwen2TokenizerFast.from_pretrained(\"Qwen/Qwen2-0.5B-Instruct\")\n-        processor_kwargs = self.prepare_processor_dict()\n+        processor_kwargs = cls.prepare_processor_dict()\n \n         processor = LlavaOnevisionProcessor(\n             video_processor=video_processor, image_processor=image_processor, tokenizer=tokenizer, **processor_kwargs\n         )\n-        processor.save_pretrained(self.tmpdirname)\n+        processor.save_pretrained(cls.tmpdirname)\n \n     def get_tokenizer(self, **kwargs):\n         return AutoProcessor.from_pretrained(self.tmpdirname, **kwargs).tokenizer\n@@ -60,7 +62,8 @@ def get_image_processor(self, **kwargs):\n     def get_video_processor(self, **kwargs):\n         return AutoProcessor.from_pretrained(self.tmpdirname, **kwargs).video_processor\n \n-    def prepare_processor_dict(self):\n+    @staticmethod\n+    def prepare_processor_dict():\n         return {\n             \"chat_template\": \"{% for message in messages %}{{'<|im_start|>' + message['role'] + ' '}}{# Render all images first #}{% for content in message['content'] | selectattr('type', 'equalto', 'image') %}{{ '<image>' }}{% endfor %}{# Render all video then #}{% for content in message['content'] | selectattr('type', 'equalto', 'video') %}{{ '<video>' }}{% endfor %}{# Render all text next #}{% if message['role'] != 'assistant' %}{% for content in message['content'] | selectattr('type', 'equalto', 'text') %}{{ '\\n' + content['text'] }}{% endfor %}{% else %}{% for content in message['content'] | selectattr('type', 'equalto', 'text') %}{% generation %}{{ '\\n' + content['text'] }}{% endgeneration %}{% endfor %}{% endif %}{{'<|im_end|>'}}{% endfor %}{% if add_generation_prompt %}{{ '<|im_start|>assistant\\n' }}{% endif %}\",\n             \"num_image_tokens\": 6,\n@@ -88,9 +91,6 @@ def test_chat_template_is_saved(self):\n         processor_dict = self.prepare_processor_dict()\n         self.assertTrue(processor_loaded.chat_template == processor_dict.get(\"chat_template\", None))\n \n-    def tearDown(self):\n-        shutil.rmtree(self.tmpdirname)\n-\n     def test_chat_template(self):\n         processor = AutoProcessor.from_pretrained(\"llava-hf/llava-onevision-qwen2-7b-ov-hf\")\n         expected_prompt = \"<|im_start|>user <image>\\nWhat is shown in this image?<|im_end|><|im_start|>assistant\\n\""
        }
    ],
    "stats": {
        "total": 16,
        "additions": 8,
        "deletions": 8
    }
}