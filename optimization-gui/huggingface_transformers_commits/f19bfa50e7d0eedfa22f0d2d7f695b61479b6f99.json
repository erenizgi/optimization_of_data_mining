{
    "author": "ydshieh",
    "message": "Commont bot CI for other jobs (`generation` / `quantization`) (#35341)\n\n* quantization CI on PRs\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* add 2 members\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99",
    "files": [
        {
            "sha": "6287bb7154fc1a2bed8c22e952fb3535219183bf",
            "filename": ".github/workflows/self-comment-ci.yml",
            "status": "modified",
            "additions": 133,
            "deletions": 31,
            "changes": 164,
            "blob_url": "https://github.com/huggingface/transformers/blob/f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99/.github%2Fworkflows%2Fself-comment-ci.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99/.github%2Fworkflows%2Fself-comment-ci.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-comment-ci.yml?ref=f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99",
            "patch": "@@ -30,7 +30,7 @@ jobs:\n     runs-on: ubuntu-22.04\n     name: Get PR number\n     # For security: only allow team members to run\n-    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('[\"ydshieh\", \"ArthurZucker\", \"zucchini-nlp\", \"qubvel\", \"molbap\", \"gante\", \"LysandreJik\", \"Cyrilvallez\", \"Rocketknight1\"]'), github.actor) && (startsWith(github.event.comment.body, 'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body, 'run_slow')) }}\n+    if: ${{ github.event.issue.state == 'open' && contains(fromJSON('[\"ydshieh\", \"ArthurZucker\", \"zucchini-nlp\", \"qubvel\", \"molbap\", \"gante\", \"LysandreJik\", \"Cyrilvallez\", \"Rocketknight1\", \"SunMarc\", \"muellerzr\"]'), github.actor) && (startsWith(github.event.comment.body, 'run-slow') || startsWith(github.event.comment.body, 'run slow') || startsWith(github.event.comment.body, 'run_slow')) }}\n     outputs:\n       PR_NUMBER: ${{ steps.set_pr_number.outputs.PR_NUMBER }}\n     steps:\n@@ -98,6 +98,7 @@ jobs:\n     if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n     outputs:\n       models: ${{ steps.models_to_run.outputs.models }}\n+      quantizations: ${{ steps.models_to_run.outputs.quantizations }}\n     steps:\n       - uses: actions/checkout@v4\n         with:\n@@ -121,17 +122,21 @@ jobs:\n           python -m pip install GitPython\n           python utils/pr_slow_ci_models.py --message \"$PR_COMMENT\" | tee output.txt\n           echo \"models=$(tail -n 1 output.txt)\" >> $GITHUB_ENV\n+          python utils/pr_slow_ci_models.py --message \"$PR_COMMENT\" --quantization | tee output2.txt\n+          echo \"quantizations=$(tail -n 1 output2.txt)\" >> $GITHUB_ENV\n \n       - name: Show models to test\n         id: models_to_run\n         run: |\n           echo \"${{ env.models }}\"\n           echo \"models=${{ env.models }}\" >> $GITHUB_ENV\n           echo \"models=${{ env.models }}\" >> $GITHUB_OUTPUT\n+          echo \"${{ env.quantizations }}\"\n+          echo \"quantizations=${{ env.quantizations }}\" >> $GITHUB_OUTPUT\n \n   reply_to_comment:\n     name: Reply to the comment\n-    if: ${{ needs.get-tests.outputs.models != '[]' }}\n+    if: ${{ needs.get-tests.outputs.models != '[]'  || needs.get-tests.outputs.quantizations != '[]' }}\n     needs: [get-pr-number, get-tests]\n     permissions:\n       pull-requests: write\n@@ -141,17 +146,18 @@ jobs:\n         env:\n           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n           MODELS: ${{ needs.get-tests.outputs.models }}\n+          BODY: \"This comment contains run-slow, running the specified jobs:\\n\\nmodels: ${{ needs.get-tests.outputs.models }}\\nquantizations: ${{ needs.get-tests.outputs.quantizations }}\"\n         run: |\n           gh api \\\n             --method POST \\\n             -H \"Accept: application/vnd.github+json\" \\\n             -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n             repos/${{ github.repository }}/issues/${{ needs.get-pr-number.outputs.PR_NUMBER }}/comments \\\n-            -f \"body=This comment contains run-slow, running the specified jobs: ${{ env.MODELS }} ...\"\n+            -f \"body=This comment contains run-slow, running the specified jobs: ${{ env.BODY }} ...\"\n \n   create_run:\n     name: Create run\n-    if: ${{ needs.get-tests.outputs.models != '[]' }}\n+    if: ${{ needs.get-tests.outputs.models != '[]' || needs.get-tests.outputs.quantizations != '[]' }}\n     needs: [get-sha, get-tests, reply_to_comment]\n     permissions:\n       statuses: write\n@@ -173,20 +179,20 @@ jobs:\n             -f \"target_url=$GITHUB_RUN_URL\" -f \"state=pending\" -f \"description=Slow CI job\" -f \"context=pytest/custom-tests\"\n \n   run_models_gpu:\n-      name: Run all tests for the model\n-      if: ${{ needs.get-tests.outputs.models != '[]' }}\n-      needs: [get-pr-number, get-sha, get-tests, create_run]\n-      strategy:\n-        fail-fast: false\n-        matrix:\n-          folders: ${{ fromJson(needs.get-tests.outputs.models) }}\n-          machine_type: [aws-g4dn-2xlarge-cache, aws-g4dn-12xlarge-cache]\n-      runs-on:\n-         group: '${{ matrix.machine_type }}'\n-      container:\n-        image: huggingface/transformers-all-latest-gpu\n-        options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n-      steps:\n+    name: Run all tests for the model\n+    if: ${{ needs.get-tests.outputs.models != '[]' }}\n+    needs: [get-pr-number, get-sha, get-tests, create_run]\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        folders: ${{ fromJson(needs.get-tests.outputs.models) }}\n+        machine_type: [aws-g4dn-2xlarge-cache, aws-g4dn-12xlarge-cache]\n+    runs-on:\n+       group: '${{ matrix.machine_type }}'\n+    container:\n+      image: huggingface/transformers-all-latest-gpu\n+      options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    steps:\n       - name: Echo input and matrix info\n         shell: bash\n         run: |\n@@ -206,20 +212,19 @@ jobs:\n       - name: Checkout to PR merge commit\n         working-directory: /transformers\n         run: |\n-            git fetch origin refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge:refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n-            git checkout refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n-            git log -1 --format=%H\n+          git fetch origin refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge:refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n+          git checkout refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n+          git log -1 --format=%H\n \n       - name: Verify merge commit SHA\n         env:\n           VERIFIED_PR_MERGE_SHA: ${{ needs.get-sha.outputs.PR_MERGE_SHA }}\n         working-directory: /transformers\n         run: |\n-            PR_MERGE_SHA=$(git log -1 --format=%H)\n-            if [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA ]; then\n-              echo \"The merged commit SHA is not the same as the verified one! Security issue detected, abort the workflow!\";\n-              exit -1;\n-            fi\n+          PR_MERGE_SHA=$(git log -1 --format=%H)\n+          if [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA ]; then\n+            echo \"The merged commit SHA is not the same as the verified one! Security issue detected, abort the workflow!\";\n+            exit -1;\n \n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: /transformers\n@@ -279,26 +284,123 @@ jobs:\n           name: ${{ env.machine_type }}_run_models_gpu_${{ env.matrix_folders }}_test_reports\n           path: /transformers/reports/${{ env.machine_type }}_run_models_gpu_${{ matrix.folders }}_test_reports\n \n+  run_quantization_torch_gpu:\n+    name: Run all tests for a quantization\n+    if: ${{ needs.get-tests.outputs.quantizations != '[]' }}\n+    needs: [get-pr-number, get-sha, get-tests, create_run]\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        folders: ${{ fromJson(needs.get-tests.outputs.quantizations) }}\n+        machine_type: [aws-g4dn-2xlarge-cache, aws-g4dn-12xlarge-cache]\n+    runs-on:\n+      group: '${{ matrix.machine_type }}'\n+    container:\n+      image: huggingface/transformers-quantization-latest-gpu\n+      options: --gpus all --shm-size \"16gb\" --ipc host -v /mnt/cache/.cache/huggingface:/mnt/cache/\n+    steps:\n+      - name: Echo folder ${{ matrix.folders }}\n+        shell: bash\n+        run: |\n+          echo \"${{ matrix.folders }}\"\n+          matrix_folders=${{ matrix.folders }}\n+          matrix_folders=${matrix_folders/'quantization/'/'quantization_'}\n+          echo \"$matrix_folders\"\n+          echo \"matrix_folders=$matrix_folders\" >> $GITHUB_ENV\n+\n+      - name: Checkout to PR merge commit\n+        working-directory: /transformers\n+        run: |\n+          git fetch origin refs/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge:refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n+          git checkout refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n+          git log -1 --format=%H\n+\n+      - name: Verify merge commit SHA\n+        env:\n+          VERIFIED_PR_MERGE_SHA: ${{ needs.get-sha.outputs.PR_MERGE_SHA }}\n+        working-directory: /transformers\n+        run: |\n+          PR_MERGE_SHA=$(git log -1 --format=%H)\n+          if [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA ]; then\n+            echo \"The merged commit SHA is not the same as the verified one! Security issue detected, abort the workflow!\";\n+            exit -1;\n+\n+      - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n+        working-directory: /transformers\n+        run: python3 -m pip uninstall -y transformers && python3 -m pip install -e .\n+      - name: NVIDIA-SMI\n+        run: |\n+          nvidia-smi\n+\n+      - name: Set `machine_type` for report and artifact names\n+        working-directory: /transformers\n+        shell: bash\n+        run: |\n+          echo \"${{ matrix.machine_type }}\"\n+          if [ \"${{ matrix.machine_type }}\" = \"aws-g4dn-2xlarge-cache\" ]; then\n+            machine_type=single-gpu\n+          elif [ \"${{ matrix.machine_type }}\" = \"aws-g4dn-12xlarge-cache\" ]; then\n+            machine_type=multi-gpu\n+          else\n+            machine_type=${{ matrix.machine_type }}\n+          fi\n+          echo \"$machine_type\"\n+          echo \"machine_type=$machine_type\" >> $GITHUB_ENV\n+\n+      - name: Environment\n+        working-directory: /transformers\n+        run: |\n+          python3 utils/print_env.py\n+\n+      - name: Show installed libraries and their versions\n+        working-directory: /transformers\n+        run: pip freeze\n+\n+      - name: Run quantization tests on GPU\n+        working-directory: /transformers\n+        run: |\n+          python3 -m pytest -v --make-reports=${{ env.machine_type }}_run_quantization_torch_gpu_${{ matrix.folders }}_test_reports tests/${{ matrix.folders }}\n+\n+      - name: Failure short reports\n+        if: ${{ failure() }}\n+        continue-on-error: true\n+        run: cat /transformers/reports/${{ env.machine_type }}_run_quantization_torch_gpu_${{ matrix.folders }}_test_reports/failures_short.txt\n+\n+      - name: Make sure report directory exists\n+        shell: bash\n+        run: |\n+          mkdir -p /transformers/reports/${{ env.machine_type }}_run_quantization_gpu_${{ matrix.folders }}_test_reports\n+          echo \"hello\" > /transformers/reports/${{ env.machine_type }}_run_quantization_gpu_${{ matrix.folders }}_test_reports/hello.txt\n+          echo \"${{ env.machine_type }}_run_quantization_gpu_${{ matrix.folders }}_test_reports\"\n+\n+      - name: \"Test suite reports artifacts: ${{ env.machine_type }}_run_quantization_torch_gpu_${{ env.matrix_folders }}_test_reports\"\n+        if: ${{ always() }}\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: ${{ env.machine_type }}_run_quantization_torch_gpu_${{ env.matrix_folders }}_test_reports\n+          path: /transformers/reports/${{ env.machine_type }}_run_quantization_torch_gpu_${{ matrix.folders }}_test_reports\n+\n   update_run_status:\n     name: Update Check Run Status\n-    needs: [get-sha, create_run, run_models_gpu]\n+    needs: [get-sha, create_run, run_models_gpu, run_quantization_torch_gpu]\n     permissions:\n       statuses: write\n     if: ${{ always() && needs.create_run.result == 'success' }}\n     runs-on: ubuntu-22.04\n     env:\n       GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n       GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n+      STATUS_OK: ${{ contains(fromJSON('[\"skipped\", \"success\"]'), needs.run_models_gpu.result) && contains(fromJSON('[\"skipped\", \"success\"]'), needs.run_quantization_torch_gpu.result) }}\n     steps:\n       - name: Get `run_models_gpu` job status\n         run: |\n           echo \"${{ needs.run_models_gpu.result }}\"\n-          if [ \"${{ needs.run_models_gpu.result }}\" = \"cancelled\" ]; then\n-            echo \"STATUS=failure\" >> $GITHUB_ENV\n-          elif [ \"${{ needs.run_models_gpu.result }}\" = \"skipped\" ]; then\n+          echo \"${{ needs.run_quantization_torch_gpu.result }}\"\n+          echo $STATUS_OK\n+          if [ \"$STATUS_OK\" = \"true\" ]; then\n             echo \"STATUS=success\" >> $GITHUB_ENV\n           else\n-            echo \"STATUS=${{ needs.run_models_gpu.result }}\" >> $GITHUB_ENV\n+            echo \"STATUS=failure\" >> $GITHUB_ENV\n           fi\n \n       - name: Update PR commit statuses"
        },
        {
            "sha": "312bd078e63ad9c91564508b79ccea867346bd8e",
            "filename": "utils/pr_slow_ci_models.py",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/huggingface/transformers/blob/f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99/utils%2Fpr_slow_ci_models.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99/utils%2Fpr_slow_ci_models.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fpr_slow_ci_models.py?ref=f19bfa50e7d0eedfa22f0d2d7f695b61479b6f99",
            "patch": "@@ -27,6 +27,7 @@\n \"\"\"\n \n import argparse\n+import os.path\n import re\n import string\n from pathlib import Path\n@@ -142,13 +143,24 @@ def check_model_names(model_name: str):\n if __name__ == \"__main__\":\n     parser = argparse.ArgumentParser()\n     parser.add_argument(\"--message\", type=str, default=\"\", help=\"The content of a comment.\")\n+    parser.add_argument(\"--quantization\", action=\"store_true\", help=\"If we collect quantization tests\")\n     args = parser.parse_args()\n \n     new_model = get_new_model()\n     specified_models = get_models(args.message)\n     models = ([] if new_model == \"\" else [new_model]) + specified_models\n     # a guard for strange model names\n     models = [model for model in models if check_model_names(model)]\n-    # Add \"models/\"\n-    models = [f\"models/{model}\" for model in models]\n-    print(sorted(set(models)))\n+\n+    # Add prefix\n+    final_list = []\n+    for model in models:\n+        if not args.quantization:\n+            if os.path.isdir(f\"tests/models/{model}\"):\n+                final_list.append(f\"models/{model}\")\n+            elif os.path.isdir(f\"tests/{model}\") and model != \"quantization\":\n+                final_list.append(model)\n+        elif os.path.isdir(f\"tests/quantization/{model}\"):\n+            final_list.append(f\"quantization/{model}\")\n+\n+    print(sorted(set(final_list)))"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 148,
        "deletions": 34
    }
}