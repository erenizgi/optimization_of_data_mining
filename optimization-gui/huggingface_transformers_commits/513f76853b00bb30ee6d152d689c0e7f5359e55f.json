{
    "author": "yonigozlan",
    "message": "Modular fix: remove the model name in `find_file_type` (#39897)\n\n* remove the model name in the class name\n\n* add comment",
    "sha": "513f76853b00bb30ee6d152d689c0e7f5359e55f",
    "files": [
        {
            "sha": "86eecc83a5ab72d64d77e261eb63b7c6e875c7fd",
            "filename": "utils/modular_model_converter.py",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/513f76853b00bb30ee6d152d689c0e7f5359e55f/utils%2Fmodular_model_converter.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/513f76853b00bb30ee6d152d689c0e7f5359e55f/utils%2Fmodular_model_converter.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fmodular_model_converter.py?ref=513f76853b00bb30ee6d152d689c0e7f5359e55f",
            "patch": "@@ -1086,13 +1086,15 @@ def replace_class_node(\n }\n \n \n-def find_file_type(class_name: str) -> str:\n+def find_file_type(class_name: str, model_name: str) -> str:\n     \"\"\"Based on a class name, find the file type corresponding to the class.\n     If the class name is `LlamaConfig` it will return `configuration`.\n     The list of suffixes is in `TYPE_TO_FILE_TYPE`. If there are no match, we match by default to `modeling`\n     \"\"\"\n     match_pattern = \"|\".join(TYPE_TO_FILE_TYPE.keys())\n-    match = re.search(rf\"({match_pattern})$\", class_name)\n+    # We remove the model name to avoid ambiguity, e.g. for `Sam2VideoProcessor`,\n+    # removing `Sam2Video` ensures we match `Processor` instead of `VideoProcessor`.\n+    match = re.search(rf\"({match_pattern})$\", class_name.replace(get_cased_name(model_name), \"\"))\n     if match:\n         file_type = TYPE_TO_FILE_TYPE[match.group(1)]\n     else:\n@@ -1175,7 +1177,7 @@ def get_needed_imports(body: dict[str, dict], all_imports: list[cst.CSTNode]) ->\n     return usual_import_nodes + protected_import_nodes\n \n \n-def split_all_assignment(node: cst.CSTNode) -> dict[str, cst.CSTNode]:\n+def split_all_assignment(node: cst.CSTNode, model_name: str) -> dict[str, cst.CSTNode]:\n     \"\"\"Split the `__all__` assignment found in the modular between each corresponding files.\"\"\"\n     all_all_per_file = {}\n     assign_node = node.body[0]\n@@ -1186,7 +1188,7 @@ def split_all_assignment(node: cst.CSTNode) -> dict[str, cst.CSTNode]:\n             if isinstance(element.value, cst.SimpleString):\n                 # Remove quotes and add the string to the elements list\n                 class_name = element.value.value\n-                file = find_file_type(element.value.evaluated_value)\n+                file = find_file_type(element.value.evaluated_value, model_name)\n                 all_all_to_add[file] += [class_name]\n         for file, new_alls in all_all_to_add.items():\n             new_node = assign_node.with_changes(\n@@ -1275,7 +1277,7 @@ def visit_SimpleStatementLine(self, node):\n                 assigned_variable = node.body[0].targets[0].target.value\n                 # __all__ is treated differently and not added to general assignments\n                 if assigned_variable == \"__all__\":\n-                    self.all_all_to_add = split_all_assignment(node)\n+                    self.all_all_to_add = split_all_assignment(node, self.model_name)\n                 else:\n                     self.current_assignment = assigned_variable\n                     self.assignments[assigned_variable] = node\n@@ -1531,7 +1533,7 @@ class NewNameModel(LlamaModel):\n     corrected_dependencies = new_dependencies.copy()\n     new_imports = {}\n     for class_name in class_dependencies:\n-        class_file_type = find_file_type(class_name)\n+        class_file_type = find_file_type(class_name, new_name)\n         # In this case, we need to remove it from the dependencies and create a new import instead\n         if class_file_type != file_type:\n             corrected_dependencies.remove(class_name)\n@@ -1554,7 +1556,7 @@ class node based on the inherited classes if needed. Also returns any new import\n     ]\n     super_class = model_specific_bases[0] if len(model_specific_bases) == 1 else None\n \n-    file_type = find_file_type(class_name)\n+    file_type = find_file_type(class_name, modular_mapper.model_name)\n     file_to_update = files[file_type]\n     model_name = modular_mapper.model_name\n "
        }
    ],
    "stats": {
        "total": 16,
        "additions": 9,
        "deletions": 7
    }
}