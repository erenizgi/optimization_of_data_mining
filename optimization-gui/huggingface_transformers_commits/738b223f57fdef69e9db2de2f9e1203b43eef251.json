{
    "author": "ydshieh",
    "message": "Add captured actual outputs to CI artifacts (#40965)\n\n* fix\n\n* fix\n\n* Remove `# TODO: ???` as it make me `???`\n\n* fix\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "738b223f57fdef69e9db2de2f9e1203b43eef251",
    "files": [
        {
            "sha": "09279b58db3b2e8968b3db67b7fa8f098a7ec0db",
            "filename": ".github/workflows/model_jobs.yml",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/huggingface/transformers/blob/738b223f57fdef69e9db2de2f9e1203b43eef251/.github%2Fworkflows%2Fmodel_jobs.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/738b223f57fdef69e9db2de2f9e1203b43eef251/.github%2Fworkflows%2Fmodel_jobs.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fmodel_jobs.yml?ref=738b223f57fdef69e9db2de2f9e1203b43eef251",
            "patch": "@@ -128,28 +128,35 @@ jobs:\n           echo \"machine_type=$machine_type\" >> $GITHUB_ENV\n           echo \"machine_type=$machine_type\" >> $GITHUB_OUTPUT\n \n+      - name: Create report directory if it doesn't exist\n+        shell: bash\n+        run: |\n+          mkdir -p /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports\n+          echo \"dummy\" > /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports/dummy.txt\n+          ls -la /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports\n+\n       - name: Run all tests on GPU\n         working-directory: /transformers\n-        run: python3 -m pytest -rsfE -v --make-reports=${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ matrix.folders }}_test_reports tests/${{ matrix.folders }}\n+        run: |\n+          PATCH_TESTING_METHODS_TO_COLLECT_OUTPUTS=yes _PATCHED_TESTING_METHODS_OUTPUT_DIR=/transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports python3 -m pytest -rsfE -v --make-reports=${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports tests/${{ matrix.folders }}\n \n       - name: Failure short reports\n         if: ${{ failure() }}\n         continue-on-error: true\n-        run: cat /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ matrix.folders }}_test_reports/failures_short.txt\n+        run: cat /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports/failures_short.txt\n \n-      - name: Run test\n-        shell: bash\n+      - name: Captured information\n+        if: ${{ failure() }}\n+        continue-on-error: true\n         run: |\n-          mkdir -p /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ matrix.folders }}_test_reports\n-          echo \"hello\" > /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ matrix.folders }}_test_reports/hello.txt\n-          echo \"${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ matrix.folders }}_test_reports\"\n+          cat /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports/captured_info.txt\n \n       - name: \"Test suite reports artifacts: ${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports\"\n         if: ${{ always() }}\n         uses: actions/upload-artifact@v4\n         with:\n           name: ${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports\n-          path: /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ matrix.folders }}_test_reports\n+          path: /transformers/reports/${{ env.machine_type }}_${{ inputs.report_name_prefix }}_${{ env.matrix_folders }}_test_reports\n \n   collated_reports:\n     name: Collated Reports"
        },
        {
            "sha": "6449c0a84f99f7914a683578f6fdc2129e74683e",
            "filename": "utils/notification_service.py",
            "status": "modified",
            "additions": 38,
            "deletions": 1,
            "changes": 39,
            "blob_url": "https://github.com/huggingface/transformers/blob/738b223f57fdef69e9db2de2f9e1203b43eef251/utils%2Fnotification_service.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/738b223f57fdef69e9db2de2f9e1203b43eef251/utils%2Fnotification_service.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fnotification_service.py?ref=738b223f57fdef69e9db2de2f9e1203b43eef251",
            "patch": "@@ -1196,6 +1196,15 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n             \"time_spent\": [],\n             \"failures\": {},\n             \"job_link\": {},\n+            \"captured_info\": {},\n+        }\n+        for matrix_name in job_matrix\n+        if f\"{report_name_prefix}_{matrix_name}_test_reports\" in available_artifacts\n+    }\n+\n+    matrix_job_results_extra = {\n+        matrix_name: {\n+            \"captured_info\": {},\n         }\n         for matrix_name in job_matrix\n         if f\"{report_name_prefix}_{matrix_name}_test_reports\" in available_artifacts\n@@ -1225,7 +1234,21 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n \n                 stacktraces = handle_stacktraces(artifact[\"failures_line\"])\n \n-                # TODO: ???\n+                # Add the captured actual outputs for patched methods (`torch.testing.assert_close`, `assertEqual` etc.)\n+                if \"captured_info\" in artifact:\n+                    step_number = None\n+                    for step in job.get(\"steps\", []):\n+                        if step[\"name\"] == \"Captured information\":\n+                            step_number = step[\"number\"]\n+                            break\n+                    if step_number is not None:\n+                        step_link = f\"{job['html_url']}#step:{step_number}:1\"\n+                        matrix_job_results[matrix_name][\"captured_info\"][artifact_gpu] = step_link\n+                        matrix_job_results_extra[matrix_name][\"captured_info\"][artifact_gpu] = {\n+                            \"link\": step_link,\n+                            \"captured_info\": artifact[\"captured_info\"],\n+                        }\n+\n                 for line in artifact[\"summary_short\"].split(\"\\n\"):\n                     if line.startswith(\"FAILED \"):\n                         # Avoid the extra `FAILED` entry given by `run_test_using_subprocess` causing issue when calling\n@@ -1432,6 +1455,20 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n             token=os.environ.get(\"TRANSFORMERS_CI_RESULTS_UPLOAD_TOKEN\", None),\n         )\n \n+    if len(matrix_job_results_extra) > 0:\n+        with open(\n+            f\"ci_results_{job_name}/{test_to_result_name[test_name]}_results_extra.json\", \"w\", encoding=\"UTF-8\"\n+        ) as fp:\n+            json.dump(matrix_job_results_extra, fp, indent=4, ensure_ascii=False)\n+\n+        api.upload_file(\n+            path_or_fileobj=f\"ci_results_{job_name}/{test_to_result_name[test_name]}_results_extra.json\",\n+            path_in_repo=f\"{report_repo_folder}/ci_results_{job_name}/{test_to_result_name[test_name]}_results_extra.json\",\n+            repo_id=report_repo_id,\n+            repo_type=\"dataset\",\n+            token=os.environ.get(\"TRANSFORMERS_CI_RESULTS_UPLOAD_TOKEN\", None),\n+        )\n+\n     # Let's create a file contain job --> job link\n     if len(matrix_job_results) > 0:\n         target_results = matrix_job_results"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 53,
        "deletions": 9
    }
}