{
    "author": "unknown",
    "message": "bugfix: torch.export failure caused by `_make_causal_mask` (#35291)\n\n* bugfix: torch.export failure caused by `_make_causal_mask`\n\nRecent changes in torch dynamo prevent mutations on tensors converted with aten::_to_copy. To address this, we can clone such tensor before performing in-place operation `masked_fill_` only when the code is being compiled by torch dynamo.\r\n(relevant issue: https://github.com/pytorch/pytorch/issues/127571)\n\n* chore: use `is_torchdynamo_compiling` instead of `torch._dynamo.is_compiling`",
    "sha": "40292aa4e95abb827847f77318a32efc1e76d973",
    "files": [
        {
            "sha": "09fc77e46b07ed613a6f390c2dea6cc9703089dd",
            "filename": "src/transformers/modeling_attn_mask_utils.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/40292aa4e95abb827847f77318a32efc1e76d973/src%2Ftransformers%2Fmodeling_attn_mask_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/40292aa4e95abb827847f77318a32efc1e76d973/src%2Ftransformers%2Fmodeling_attn_mask_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_attn_mask_utils.py?ref=40292aa4e95abb827847f77318a32efc1e76d973",
            "patch": "@@ -169,6 +169,10 @@ def _make_causal_mask(\n             diagonal = past_key_values_length - sliding_window - 1\n \n             context_mask = torch.tril(torch.ones_like(mask, dtype=torch.bool), diagonal=diagonal)\n+            # Recent changes in PyTorch prevent mutations on tensors converted with aten::_to_copy\n+            # See https://github.com/pytorch/pytorch/issues/127571\n+            if is_torchdynamo_compiling():\n+                mask = mask.clone()\n             mask.masked_fill_(context_mask, torch.finfo(dtype).min)\n \n         return mask[None, None, :, :].expand(bsz, 1, tgt_len, tgt_len + past_key_values_length)"
        }
    ],
    "stats": {
        "total": 4,
        "additions": 4,
        "deletions": 0
    }
}