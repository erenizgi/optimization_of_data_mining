{
    "author": "SunMarc",
    "message": "Fix 8bit bnb loading (#41200)\n\n* Fix 8bit\n\n* oups forgot the case where it is not prequantized",
    "sha": "8635d8e796c77ee94f64c170168f71138380274b",
    "files": [
        {
            "sha": "b6bd833059561c0c148de313ebb7e1ff74fc0101",
            "filename": "src/transformers/quantizers/quantizer_bnb_8bit.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/8635d8e796c77ee94f64c170168f71138380274b/src%2Ftransformers%2Fquantizers%2Fquantizer_bnb_8bit.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/8635d8e796c77ee94f64c170168f71138380274b/src%2Ftransformers%2Fquantizers%2Fquantizer_bnb_8bit.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fquantizers%2Fquantizer_bnb_8bit.py?ref=8635d8e796c77ee94f64c170168f71138380274b",
            "patch": "@@ -185,7 +185,6 @@ def create_quantized_param(\n                 \"Detected int8 weights but the version of bitsandbytes is not compatible with int8 serialization. \"\n                 \"Make sure to download the latest `bitsandbytes` version. `pip install --upgrade bitsandbytes`.\"\n             )\n-\n         # Those 2 can only happen when self.pre_quantized == True\n         if tensor_name == \"SCB\":\n             setattr(module.weight, \"SCB\", param_value.to(target_device))\n@@ -202,8 +201,11 @@ def create_quantized_param(\n         old_value = getattr(module, tensor_name)\n         kwargs = old_value.__dict__\n         kwargs.pop(\"_is_hf_initialized\", None)\n+        # Need to pop SCB and reset it because of bnb internals that modifies its value when switching devices ...\n+        SCB = kwargs.pop(\"SCB\", None)\n         new_value = bnb.nn.Int8Params(param_value.to(\"cpu\"), requires_grad=False, **kwargs).to(target_device)\n-\n+        if SCB is not None:\n+            setattr(new_value, \"SCB\", SCB)\n         # Set it to the module\n         module._parameters[tensor_name] = new_value\n "
        }
    ],
    "stats": {
        "total": 6,
        "additions": 4,
        "deletions": 2
    }
}