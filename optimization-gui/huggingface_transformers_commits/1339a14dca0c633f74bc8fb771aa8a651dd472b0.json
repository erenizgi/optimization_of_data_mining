{
    "author": "dvrogozh",
    "message": "Add safe_globals to resume training on PyTorch 2.6 (#34632)\n\nStarting from version 2.4 PyTorch introduces a stricter check for the objects which\r\ncan be loaded with torch.load(). Starting from version 2.6 loading with weights_only=True\r\nrequires allowlisting of such objects.\r\n\r\nThis commit adds allowlist of some numpy objects used to load model checkpoints.\r\nUsage is restricted by context manager. User can still additionally call\r\ntorch.serialization.add_safe_globals() to add other objects into the safe globals list.\r\n\r\nAccelerate library also stepped into same problem and addressed it with PR-3036.\r\n\r\nFixes: #34631\r\nSee: https://github.com/pytorch/pytorch/pull/137602\r\nSee: https://pytorch.org/docs/stable/notes/serialization.html#torch.serialization.add_safe_globals\r\nSee: https://github.com/huggingface/accelerate/pull/3036\r\n\r\nSigned-off-by: Dmitry Rogozhkin <dmitry.v.rogozhkin@intel.com>",
    "sha": "1339a14dca0c633f74bc8fb771aa8a651dd472b0",
    "files": [
        {
            "sha": "46add00b018e3ac153fcfe4d3df1e468da5b7c96",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/huggingface/transformers/blob/1339a14dca0c633f74bc8fb771aa8a651dd472b0/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/1339a14dca0c633f74bc8fb771aa8a651dd472b0/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=1339a14dca0c633f74bc8fb771aa8a651dd472b0",
            "patch": "@@ -272,6 +272,25 @@ def _get_fsdp_ckpt_kwargs():\n         return {}\n \n \n+def safe_globals():\n+    # Starting from version 2.4 PyTorch introduces a check for the objects loaded\n+    # with torch.load(weights_only=True). Starting from 2.6 weights_only=True becomes\n+    # a default and requires allowlisting of objects being loaded.\n+    # See: https://github.com/pytorch/pytorch/pull/137602\n+    # See: https://pytorch.org/docs/stable/notes/serialization.html#torch.serialization.add_safe_globals\n+    # See: https://github.com/huggingface/accelerate/pull/3036\n+    if version.parse(torch.__version__).release < version.parse(\"2.6\").release:\n+        return contextlib.nullcontext()\n+\n+    np_core = np._core if version.parse(np.__version__) >= version.parse(\"2.0.0\") else np.core\n+    allowlist = [np_core.multiarray._reconstruct, np.ndarray, np.dtype]\n+    # numpy >1.25 defines numpy.dtypes.UInt32DType, but below works for\n+    # all versions of numpy\n+    allowlist += [type(np.dtype(np.uint32))]\n+\n+    return torch.serialization.safe_globals(allowlist)\n+\n+\n if TYPE_CHECKING:\n     import optuna\n \n@@ -3055,7 +3074,8 @@ def _load_rng_state(self, checkpoint):\n                 )\n                 return\n \n-        checkpoint_rng_state = torch.load(rng_file)\n+        with safe_globals():\n+            checkpoint_rng_state = torch.load(rng_file)\n         random.setstate(checkpoint_rng_state[\"python\"])\n         np.random.set_state(checkpoint_rng_state[\"numpy\"])\n         torch.random.set_rng_state(checkpoint_rng_state[\"cpu\"])"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 21,
        "deletions": 1
    }
}