{
    "author": "ydshieh",
    "message": "Another security patch for `self-comment-ci.yml` (#35816)\n\nfix\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "870e2c8ea0b4634f2e06d8b99cb92e08a1a45696",
    "files": [
        {
            "sha": "4f3889ca126e45e5a1fa749c2ff2162a14057574",
            "filename": ".github/workflows/self-comment-ci.yml",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/huggingface/transformers/blob/870e2c8ea0b4634f2e06d8b99cb92e08a1a45696/.github%2Fworkflows%2Fself-comment-ci.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/870e2c8ea0b4634f2e06d8b99cb92e08a1a45696/.github%2Fworkflows%2Fself-comment-ci.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fself-comment-ci.yml?ref=870e2c8ea0b4634f2e06d8b99cb92e08a1a45696",
            "patch": "@@ -58,6 +58,7 @@ jobs:\n     if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n     outputs:\n       PR_HEAD_SHA: ${{ steps.get_sha.outputs.PR_HEAD_SHA }}\n+      PR_MERGE_SHA: ${{ steps.get_sha.outputs.PR_MERGE_SHA }}\n     steps:\n       - uses: actions/checkout@v4\n         with:\n@@ -76,10 +77,12 @@ jobs:\n             echo \"PR_HEAD_SHA=$(git log -1 --format=%H)\" >> \"$GITHUB_OUTPUT\"\n             git fetch origin refs/pull/$PR_NUMBER/merge:refs/remotes/pull/$PR_NUMBER/merge\n             git checkout refs/remotes/pull/$PR_NUMBER/merge\n+            echo \"PR_MERGE_SHA: $(git log -1 --format=%H)\"\n+            echo \"PR_MERGE_SHA=$(git log -1 --format=%H)\" >> \"$GITHUB_OUTPUT\"\n             PR_MERGE_COMMIT_TIMESTAMP=$(git log -1 --date=unix --format=%cd)\n             echo \"PR_MERGE_COMMIT_TIMESTAMP: $PR_MERGE_COMMIT_TIMESTAMP\"\n             COMMENT_TIMESTAMP=$(date -d \"${COMMENT_DATE}\" +\"%s\")\n-            echo \"PR_HEAD_SHA: $COMMENT_DATE\"\n+            echo \"COMMENT_DATE: $COMMENT_DATE\"\n             echo \"COMMENT_TIMESTAMP: $COMMENT_TIMESTAMP\"\n             if [ $COMMENT_TIMESTAMP -le $PR_MERGE_COMMIT_TIMESTAMP ]; then\n               echo \"Last commit on the pull request is newer than the issue comment triggering this run! Abort!\";\n@@ -91,7 +94,7 @@ jobs:\n   # case 2: `run-slow model_1, model_2`\n   get-tests:\n     runs-on: ubuntu-22.04\n-    needs: get-pr-number\n+    needs: [get-pr-number, get-sha]\n     if: ${{ needs.get-pr-number.outputs.PR_NUMBER != ''}}\n     outputs:\n       models: ${{ steps.models_to_run.outputs.models }}\n@@ -101,6 +104,16 @@ jobs:\n           fetch-depth: \"0\"\n           ref: \"refs/pull/${{needs.get-pr-number.outputs.PR_NUMBER}}/merge\"\n \n+      - name: Verify merge commit SHA\n+        env:\n+          VERIFIED_PR_MERGE_SHA: ${{ needs.get-sha.outputs.PR_MERGE_SHA }}\n+        run: |\n+            PR_MERGE_SHA=$(git log -1 --format=%H)\n+            if [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA ]; then\n+              echo \"The merged commit SHA is not the same as the verified one! Security issue detected, abort the workflow!\";\n+              exit -1;\n+            fi\n+\n       - name: Get models to test\n         env:\n           PR_COMMENT: ${{ github.event.comment.body }}\n@@ -162,7 +175,7 @@ jobs:\n   run_models_gpu:\n       name: Run all tests for the model\n       if: ${{ needs.get-tests.outputs.models != '[]' }}\n-      needs: [get-pr-number, get-tests, create_run]\n+      needs: [get-pr-number, get-sha, get-tests, create_run]\n       strategy:\n         fail-fast: false\n         matrix:\n@@ -197,6 +210,16 @@ jobs:\n             git checkout refs/remotes/pull/${{ needs.get-pr-number.outputs.PR_NUMBER }}/merge\n             git log -1 --format=%H\n \n+      - name: Verify merge commit SHA\n+        env:\n+          VERIFIED_PR_MERGE_SHA: ${{ needs.get-sha.outputs.PR_MERGE_SHA }}\n+        run: |\n+            PR_MERGE_SHA=$(git log -1 --format=%H)\n+            if [ $PR_MERGE_SHA != $VERIFIED_PR_MERGE_SHA ]; then\n+              echo \"The merged commit SHA is not the same as the verified one! Security issue detected, abort the workflow!\";\n+              exit -1;\n+            fi\n+\n       - name: Reinstall transformers in edit mode (remove the one installed during docker image build)\n         working-directory: /transformers\n         run: python3 -m pip uninstall -y transformers && python3 -m pip install -e ."
        }
    ],
    "stats": {
        "total": 29,
        "additions": 26,
        "deletions": 3
    }
}