{
    "author": "bvantuan",
    "message": "Fix key mapping for VLMs (#39029)\n\n* fix key mapping for VLMs\n\n* use __mro__ instead\n\n* update key mapping in save_pretrained",
    "sha": "d53518c5f2dd7ada022ff5b725c684c9ed89cb44",
    "files": [
        {
            "sha": "e99fb31ca34a176c0ec26a0255f3f1d85477ec45",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/d53518c5f2dd7ada022ff5b725c684c9ed89cb44/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/d53518c5f2dd7ada022ff5b725c684c9ed89cb44/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=d53518c5f2dd7ada022ff5b725c684c9ed89cb44",
            "patch": "@@ -3746,7 +3746,11 @@ def save_pretrained(\n                         module_map[name + f\".{key}\"] = module\n             state_dict = model_to_save.state_dict()\n \n-        if any(allowed_name in self.__class__.__name__.lower() for allowed_name in VLMS):\n+        if any(\n+            allowed_name in class_name.__name__.lower()\n+            for class_name in self.__class__.__mro__[:-1]\n+            for allowed_name in VLMS\n+        ):\n             reverse_key_mapping = {v: k for k, v in self._checkpoint_conversion_mapping.items()}\n \n             original_state_dict = {}\n@@ -4402,7 +4406,9 @@ def from_pretrained(\n \n         key_mapping = kwargs.pop(\"key_mapping\", None)\n         # Load models with hardcoded key mapping on class for VLMs only, to keep BC and standardize model\n-        if key_mapping is None and any(allowed_name in cls.__name__.lower() for allowed_name in VLMS):\n+        if key_mapping is None and any(\n+            allowed_name in class_name.__name__.lower() for class_name in cls.__mro__[:-1] for allowed_name in VLMS\n+        ):\n             key_mapping = cls._checkpoint_conversion_mapping\n \n         # Not used anymore -- remove them from the kwargs"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 8,
        "deletions": 2
    }
}