{
    "author": "qubvel",
    "message": "Add kwargs for timm.create_model in TimmWrapper (#38860)\n\n* Add init kwargs for timm wrapper\n\n* model_init_kwargs -> model_args\n\n* add save-load test\n\n* fixup",
    "sha": "9120567b02a551d198337e21bee8c1465f389ab2",
    "files": [
        {
            "sha": "39ed2098d6856c979f25e39f5f9fd87496e06f63",
            "filename": "src/transformers/models/timm_wrapper/configuration_timm_wrapper.py",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/huggingface/transformers/blob/9120567b02a551d198337e21bee8c1465f389ab2/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fconfiguration_timm_wrapper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9120567b02a551d198337e21bee8c1465f389ab2/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fconfiguration_timm_wrapper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fconfiguration_timm_wrapper.py?ref=9120567b02a551d198337e21bee8c1465f389ab2",
            "patch": "@@ -15,7 +15,7 @@\n \n \"\"\"Configuration for TimmWrapper models\"\"\"\n \n-from typing import Any\n+from typing import Any, Optional\n \n from ...configuration_utils import PretrainedConfig\n from ...utils import is_timm_available, logging, requires_backends\n@@ -45,6 +45,9 @@ class TimmWrapperConfig(PretrainedConfig):\n             The standard deviation of the truncated_normal_initializer for initializing all weight matrices.\n         do_pooling (`bool`, *optional*, defaults to `True`):\n             Whether to do pooling for the last_hidden_state in `TimmWrapperModel` or not.\n+        model_args (`dict[str, Any]`, *optional*):\n+            Additional keyword arguments to pass to the `timm.create_model` function. e.g. `model_args={\"depth\": 3}`\n+            for `timm/vit_base_patch32_clip_448.laion2b_ft_in12k_in1k` to create a model with 3 blocks. Defaults to `None`.\n \n     Example:\n     ```python\n@@ -60,9 +63,16 @@ class TimmWrapperConfig(PretrainedConfig):\n \n     model_type = \"timm_wrapper\"\n \n-    def __init__(self, initializer_range: float = 0.02, do_pooling: bool = True, **kwargs):\n+    def __init__(\n+        self,\n+        initializer_range: float = 0.02,\n+        do_pooling: bool = True,\n+        model_args: Optional[dict[str, Any]] = None,\n+        **kwargs,\n+    ):\n         self.initializer_range = initializer_range\n         self.do_pooling = do_pooling\n+        self.model_args = model_args  # named \"model_args\" for BC with timm\n         super().__init__(**kwargs)\n \n     @classmethod"
        },
        {
            "sha": "7c2fe02123219de2c6668475001f05c44c9d243f",
            "filename": "src/transformers/models/timm_wrapper/modeling_timm_wrapper.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/9120567b02a551d198337e21bee8c1465f389ab2/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fmodeling_timm_wrapper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9120567b02a551d198337e21bee8c1465f389ab2/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fmodeling_timm_wrapper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Ftimm_wrapper%2Fmodeling_timm_wrapper.py?ref=9120567b02a551d198337e21bee8c1465f389ab2",
            "patch": "@@ -116,7 +116,8 @@ class TimmWrapperModel(TimmWrapperPreTrainedModel):\n     def __init__(self, config: TimmWrapperConfig):\n         super().__init__(config)\n         # using num_classes=0 to avoid creating classification head\n-        self.timm_model = timm.create_model(config.architecture, pretrained=False, num_classes=0)\n+        extra_init_kwargs = config.model_args or {}\n+        self.timm_model = timm.create_model(config.architecture, pretrained=False, num_classes=0, **extra_init_kwargs)\n         self.post_init()\n \n     @auto_docstring\n@@ -233,7 +234,10 @@ def __init__(self, config: TimmWrapperConfig):\n                 \"or use `TimmWrapperModel` for feature extraction.\"\n             )\n \n-        self.timm_model = timm.create_model(config.architecture, pretrained=False, num_classes=config.num_labels)\n+        extra_init_kwargs = config.model_args or {}\n+        self.timm_model = timm.create_model(\n+            config.architecture, pretrained=False, num_classes=config.num_labels, **extra_init_kwargs\n+        )\n         self.num_labels = config.num_labels\n         self.post_init()\n "
        },
        {
            "sha": "f7f374ed574b5dfb38d55092f0f93992aa8212ed",
            "filename": "tests/models/timm_wrapper/test_modeling_timm_wrapper.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/huggingface/transformers/blob/9120567b02a551d198337e21bee8c1465f389ab2/tests%2Fmodels%2Ftimm_wrapper%2Ftest_modeling_timm_wrapper.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9120567b02a551d198337e21bee8c1465f389ab2/tests%2Fmodels%2Ftimm_wrapper%2Ftest_modeling_timm_wrapper.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Ftimm_wrapper%2Ftest_modeling_timm_wrapper.py?ref=9120567b02a551d198337e21bee8c1465f389ab2",
            "patch": "@@ -237,6 +237,24 @@ def test_timm_config_labels(self):\n         self.assertEqual(config.id2label, restored_config.id2label)\n         self.assertEqual(config.label2id, restored_config.label2id)\n \n+    def test_model_init_args(self):\n+        # test init from config\n+        config = TimmWrapperConfig.from_pretrained(\n+            \"timm/vit_base_patch32_clip_448.laion2b_ft_in12k_in1k\",\n+            model_args={\"depth\": 3},\n+        )\n+        model = TimmWrapperModel(config)\n+        self.assertEqual(len(model.timm_model.blocks), 3)\n+\n+        cls_model = TimmWrapperForImageClassification(config)\n+        self.assertEqual(len(cls_model.timm_model.blocks), 3)\n+\n+        # test save load\n+        with tempfile.TemporaryDirectory() as tmpdirname:\n+            model.save_pretrained(tmpdirname)\n+            restored_model = TimmWrapperModel.from_pretrained(tmpdirname)\n+            self.assertEqual(len(restored_model.timm_model.blocks), 3)\n+\n \n # We will verify our results on an image of cute cats\n def prepare_img():"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 36,
        "deletions": 4
    }
}