{
    "author": "ydshieh",
    "message": "Fix `rag` (#38585)\n\n* fix\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "f9be71b34d5efbba50bc787848c6e421822b14ba",
    "files": [
        {
            "sha": "4163cf793d550bcdcae3f541258aeab270f1e5e1",
            "filename": "tests/models/rag/test_modeling_rag.py",
            "status": "modified",
            "additions": 61,
            "deletions": 18,
            "changes": 79,
            "blob_url": "https://github.com/huggingface/transformers/blob/f9be71b34d5efbba50bc787848c6e421822b14ba/tests%2Fmodels%2Frag%2Ftest_modeling_rag.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/f9be71b34d5efbba50bc787848c6e421822b14ba/tests%2Fmodels%2Frag%2Ftest_modeling_rag.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Frag%2Ftest_modeling_rag.py?ref=f9be71b34d5efbba50bc787848c6e421822b14ba",
            "patch": "@@ -21,6 +21,7 @@\n from unittest.mock import patch\n \n import numpy as np\n+import requests\n \n from transformers import BartTokenizer, T5Tokenizer\n from transformers.models.bert.tokenization_bert import VOCAB_FILES_NAMES as DPR_VOCAB_FILES_NAMES\n@@ -49,7 +50,7 @@\n if is_torch_available() and is_datasets_available() and is_faiss_available():\n     import faiss\n     import torch\n-    from datasets import Dataset\n+    from datasets import Dataset, load_dataset\n \n     from transformers import (\n         AutoConfig,\n@@ -679,6 +680,24 @@ def config_and_inputs(self):\n @require_tokenizers\n @require_torch_non_multi_accelerator\n class RagModelIntegrationTests(unittest.TestCase):\n+    @classmethod\n+    def setUpClass(cls):\n+        cls.temp_dir = tempfile.TemporaryDirectory()\n+        cls.dataset_path = cls.temp_dir.name\n+        cls.index_path = os.path.join(cls.temp_dir.name, \"index.faiss\")\n+\n+        ds = load_dataset(\"hf-internal-testing/wiki_dpr_dummy\")[\"train\"]\n+        ds.save_to_disk(cls.dataset_path)\n+\n+        url = \"https://huggingface.co/datasets/hf-internal-testing/wiki_dpr_dummy/resolve/main/index.faiss\"\n+        response = requests.get(url, stream=True)\n+        with open(cls.index_path, \"wb\") as fp:\n+            fp.write(response.content)\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        cls.temp_dir.cleanup()\n+\n     def tearDown(self):\n         super().tearDown()\n         # clean-up as much as possible GPU memory occupied by PyTorch\n@@ -722,8 +741,9 @@ def get_rag_config(self):\n             max_combined_length=300,\n             dataset=\"wiki_dpr\",\n             dataset_split=\"train\",\n-            index_name=\"exact\",\n-            index_path=None,\n+            index_name=\"custom\",\n+            passages_path=self.dataset_path,\n+            index_path=self.index_path,\n             use_dummy_dataset=True,\n             retrieval_vector_size=768,\n             retrieval_batch_size=8,\n@@ -841,8 +861,8 @@ def test_rag_token_generate_beam(self):\n         output_text_2 = rag_decoder_tokenizer.decode(output_ids[1], skip_special_tokens=True)\n \n         # Expected outputs as given by model at integration time.\n-        EXPECTED_OUTPUT_TEXT_1 = \"\\\"She's My Kind of Girl\"\n-        EXPECTED_OUTPUT_TEXT_2 = \"\\\"She's My Kind of Love\"\n+        EXPECTED_OUTPUT_TEXT_1 = '\"She\\'s My Kind of Girl\" was released through Epic Records in Japan in March 1972. The song was a Top 10 hit in the country. It was the first single to be released by ABBA in the UK. The single was followed by \"En Carousel\" and \"Love Has Its Uses\"'\n+        EXPECTED_OUTPUT_TEXT_2 = '\"She\\'s My Kind of Girl\" was released through Epic Records in Japan in March 1972. The song was a Top 10 hit in the country. It was the first single to be released by ABBA in the UK. The single was followed by \"En Carousel\" and \"Love Has Its Ways\"'\n \n         self.assertEqual(output_text_1, EXPECTED_OUTPUT_TEXT_1)\n         self.assertEqual(output_text_2, EXPECTED_OUTPUT_TEXT_2)\n@@ -903,7 +923,10 @@ def test_data_questions(self):\n     def test_rag_sequence_generate_batch(self):\n         tokenizer = RagTokenizer.from_pretrained(\"facebook/rag-sequence-nq\")\n         retriever = RagRetriever.from_pretrained(\n-            \"facebook/rag-sequence-nq\", index_name=\"exact\", use_dummy_dataset=True, dataset_revision=\"b24a417\"\n+            \"facebook/rag-sequence-nq\",\n+            index_name=\"custom\",\n+            passages_path=self.dataset_path,\n+            index_path=self.index_path,\n         )\n         rag_sequence = RagSequenceForGeneration.from_pretrained(\"facebook/rag-sequence-nq\", retriever=retriever).to(\n             torch_device\n@@ -926,12 +949,13 @@ def test_rag_sequence_generate_batch(self):\n \n         outputs = tokenizer.batch_decode(output_ids, skip_special_tokens=True)\n \n+        # PR #31938 cause the output being changed from `june 22, 2018` to `june 22 , 2018`.\n         EXPECTED_OUTPUTS = [\n             \" albert einstein\",\n-            \" june 22, 2018\",\n+            \" june 22 , 2018\",\n             \" amplitude modulation\",\n             \" tim besley ( chairman )\",\n-            \" june 20, 2018\",\n+            \" june 20 , 2018\",\n             \" 1980\",\n             \" 7.0\",\n             \" 8\",\n@@ -943,9 +967,9 @@ def test_rag_sequence_generate_batch_from_context_input_ids(self):\n         tokenizer = RagTokenizer.from_pretrained(\"facebook/rag-sequence-nq\")\n         retriever = RagRetriever.from_pretrained(\n             \"facebook/rag-sequence-nq\",\n-            index_name=\"exact\",\n-            use_dummy_dataset=True,\n-            dataset_revision=\"b24a417\",\n+            index_name=\"custom\",\n+            passages_path=self.dataset_path,\n+            index_path=self.index_path,\n         )\n         rag_sequence = RagSequenceForGeneration.from_pretrained(\"facebook/rag-sequence-nq\", retriever=retriever).to(\n             torch_device\n@@ -981,10 +1005,10 @@ def test_rag_sequence_generate_batch_from_context_input_ids(self):\n \n         EXPECTED_OUTPUTS = [\n             \" albert einstein\",\n-            \" june 22, 2018\",\n+            \" june 22 , 2018\",\n             \" amplitude modulation\",\n             \" tim besley ( chairman )\",\n-            \" june 20, 2018\",\n+            \" june 20 , 2018\",\n             \" 1980\",\n             \" 7.0\",\n             \" 8\",\n@@ -995,7 +1019,7 @@ def test_rag_sequence_generate_batch_from_context_input_ids(self):\n     def test_rag_token_generate_batch(self):\n         tokenizer = RagTokenizer.from_pretrained(\"facebook/rag-token-nq\")\n         retriever = RagRetriever.from_pretrained(\n-            \"facebook/rag-token-nq\", index_name=\"exact\", use_dummy_dataset=True, dataset_revision=\"b24a417\"\n+            \"facebook/rag-token-nq\", index_name=\"custom\", passages_path=self.dataset_path, index_path=self.index_path\n         )\n         rag_token = RagTokenForGeneration.from_pretrained(\"facebook/rag-token-nq\", retriever=retriever).to(\n             torch_device\n@@ -1023,10 +1047,10 @@ def test_rag_token_generate_batch(self):\n \n         EXPECTED_OUTPUTS = [\n             \" albert einstein\",\n-            \" september 22, 2017\",\n+            \" september 22 , 2017\",\n             \" amplitude modulation\",\n             \" stefan persson\",\n-            \" april 20, 2018\",\n+            \" april 20 , 2018\",\n             \" the 1970s\",\n             \" 7.1. 2\",\n             \" 13\",\n@@ -1037,6 +1061,24 @@ def test_rag_token_generate_batch(self):\n @require_torch\n @require_retrieval\n class RagModelSaveLoadTests(unittest.TestCase):\n+    @classmethod\n+    def setUpClass(cls):\n+        cls.temp_dir = tempfile.TemporaryDirectory()\n+        cls.dataset_path = cls.temp_dir.name\n+        cls.index_path = os.path.join(cls.temp_dir.name, \"index.faiss\")\n+\n+        ds = load_dataset(\"hf-internal-testing/wiki_dpr_dummy\")[\"train\"]\n+        ds.save_to_disk(cls.dataset_path)\n+\n+        url = \"https://huggingface.co/datasets/hf-internal-testing/wiki_dpr_dummy/resolve/main/index.faiss\"\n+        response = requests.get(url, stream=True)\n+        with open(cls.index_path, \"wb\") as fp:\n+            fp.write(response.content)\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        cls.temp_dir.cleanup()\n+\n     def tearDown(self):\n         super().tearDown()\n         # clean-up as much as possible GPU memory occupied by PyTorch\n@@ -1060,8 +1102,9 @@ def get_rag_config(self):\n             max_combined_length=300,\n             dataset=\"wiki_dpr\",\n             dataset_split=\"train\",\n-            index_name=\"exact\",\n-            index_path=None,\n+            index_name=\"custom\",\n+            passages_path=self.dataset_path,\n+            index_path=self.index_path,\n             use_dummy_dataset=True,\n             retrieval_vector_size=768,\n             retrieval_batch_size=8,"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 61,
        "deletions": 18
    }
}