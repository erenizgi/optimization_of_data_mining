{
    "author": "tohtana",
    "message": "Fix checkpoint loading with DeepSpeed ZeRO3 (#42201)\n\nfix checkpoint loading with DeepSpeed ZeRO3\n\nSigned-off-by: Masahiro Tanaka <mtanaka@anyscale.com>\nCo-authored-by: Ferdinand Mom <47445085+3outeille@users.noreply.github.com>",
    "sha": "eddd51ec3d01232572b6ef7ca02f8a15c42c7839",
    "files": [
        {
            "sha": "1383d69aea0656fde7dfe00a74b1874ad85fc39e",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/eddd51ec3d01232572b6ef7ca02f8a15c42c7839/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/eddd51ec3d01232572b6ef7ca02f8a15c42c7839/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=eddd51ec3d01232572b6ef7ca02f8a15c42c7839",
            "patch": "@@ -4233,6 +4233,19 @@ def _load_pretrained_model(\n         error_msgs = []\n \n         if is_deepspeed_zero3_enabled() and not is_quantized:\n+            if state_dict is None:\n+                if checkpoint_files is None:\n+                    raise ValueError(\n+                        \"DeepSpeed ZeRO-3 initialization requires a state_dict or checkpoint files to load from.\"\n+                    )\n+                merged_state_dict = {}\n+                for ckpt_file in checkpoint_files:\n+                    merged_state_dict.update(\n+                        load_state_dict(\n+                            ckpt_file, is_quantized=is_quantized, map_location=\"cpu\", weights_only=weights_only\n+                        )\n+                    )\n+                state_dict = merged_state_dict\n             error_msgs += _load_state_dict_into_zero3_model(model, state_dict)\n             # This is not true but for now we assume only best-case scenario with deepspeed, i.e. perfectly matching checkpoints\n             missing_keys, unexpected_keys, mismatched_keys, misc = set(), set(), set(), set()"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 13,
        "deletions": 0
    }
}