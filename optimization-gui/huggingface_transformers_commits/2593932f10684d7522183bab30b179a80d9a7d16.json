{
    "author": "remi-or",
    "message": "Gemma3 fixes (#39960)\n\n* Fix multiple devices issue\n\n* Added expectations for rocm 9.4\n\n* Ruff",
    "sha": "2593932f10684d7522183bab30b179a80d9a7d16",
    "files": [
        {
            "sha": "c5bfb9f373d60963db128bdc2abdb2465291b3c4",
            "filename": "src/transformers/models/gemma3/modeling_gemma3.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/2593932f10684d7522183bab30b179a80d9a7d16/src%2Ftransformers%2Fmodels%2Fgemma3%2Fmodeling_gemma3.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2593932f10684d7522183bab30b179a80d9a7d16/src%2Ftransformers%2Fmodels%2Fgemma3%2Fmodeling_gemma3.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma3%2Fmodeling_gemma3.py?ref=2593932f10684d7522183bab30b179a80d9a7d16",
            "patch": "@@ -922,7 +922,9 @@ def forward(\n                 is_image = (token_type_ids == 1).to(cache_position.device)\n                 new_image_start = is_image & ~nn.functional.pad(is_image, (1, 0), value=0)[:, :-1]\n                 image_group_ids = torch.cumsum(new_image_start.int(), dim=1) - 1\n-                image_group_ids = torch.where(is_image, image_group_ids, torch.full_like(token_type_ids, -1))\n+                image_group_ids = torch.where(\n+                    is_image, image_group_ids, torch.full_like(token_type_ids, -1, device=is_image.device)\n+                )\n                 mask_kwargs[\"or_mask_function\"] = token_type_ids_mask_function(\n                     token_type_ids.to(cache_position.device), image_group_ids, self.config.mm_tokens_per_image\n                 )"
        },
        {
            "sha": "df379b5544ca5406698ddb3acc2feb936dc99bf6",
            "filename": "src/transformers/models/gemma3/modular_gemma3.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/2593932f10684d7522183bab30b179a80d9a7d16/src%2Ftransformers%2Fmodels%2Fgemma3%2Fmodular_gemma3.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2593932f10684d7522183bab30b179a80d9a7d16/src%2Ftransformers%2Fmodels%2Fgemma3%2Fmodular_gemma3.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fgemma3%2Fmodular_gemma3.py?ref=2593932f10684d7522183bab30b179a80d9a7d16",
            "patch": "@@ -830,7 +830,9 @@ def forward(\n                 is_image = (token_type_ids == 1).to(cache_position.device)\n                 new_image_start = is_image & ~nn.functional.pad(is_image, (1, 0), value=0)[:, :-1]\n                 image_group_ids = torch.cumsum(new_image_start.int(), dim=1) - 1\n-                image_group_ids = torch.where(is_image, image_group_ids, torch.full_like(token_type_ids, -1))\n+                image_group_ids = torch.where(\n+                    is_image, image_group_ids, torch.full_like(token_type_ids, -1, device=is_image.device)\n+                )\n                 mask_kwargs[\"or_mask_function\"] = token_type_ids_mask_function(\n                     token_type_ids.to(cache_position.device), image_group_ids, self.config.mm_tokens_per_image\n                 )"
        },
        {
            "sha": "8eee01fc174b114167b69b9bbbbb0fde2524d1c6",
            "filename": "tests/models/gemma3/test_modeling_gemma3.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/2593932f10684d7522183bab30b179a80d9a7d16/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2593932f10684d7522183bab30b179a80d9a7d16/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fgemma3%2Ftest_modeling_gemma3.py?ref=2593932f10684d7522183bab30b179a80d9a7d16",
            "patch": "@@ -507,6 +507,7 @@ def test_model_4b_bf16(self):\n             {\n                 (\"xpu\", 3): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water in the background. It looks like a lovely,'],\n                 (\"cuda\", 8): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown cow standing on a sandy beach with clear turquoise water and a blue sky in the background. It looks like'],\n+                (\"rocm\", (9, 4)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown cow standing on a sandy beach with clear blue water and a blue sky in the background. It looks like'],\n                 (\"rocm\", (9, 5)): ['user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach with turquoise water and a distant coastline in the background. It looks'],\n             }\n         )  # fmt: skip\n@@ -559,6 +560,11 @@ def test_model_4b_batch(self):\n                         'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown cow standing on a sandy beach with clear blue water and a blue sky in the background. It looks like',\n                         \"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, these images are not identical. \\n\\nHere's a breakdown of the differences:\\n\\n*   **Image 1:** Shows a brown\"\n                     ],\n+                (\"rocm\", (9, 4)):\n+                    [\n+                        'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown cow standing on a sandy beach with clear turquoise water and a blue sky in the background. It looks like',\n+                        \"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, these images are not identical. \\n\\nHere's a breakdown of the differences:\\n\\n*   **Image 1:** Shows a cow\"\n+                    ],\n                 (\"rocm\", (9, 5)):\n                     [\n                         'user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nCertainly! \\n\\nThe image shows a brown and white cow standing on a sandy beach next to a turquoise ocean. There are some clouds in the blue',\n@@ -602,6 +608,7 @@ def test_model_4b_crops(self):\n                 (\"xpu\", 3): ['user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There are clouds in the blue sky above.'],\n                 (\"cuda\", 7): [],\n                 (\"cuda\", 8): [\"user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There's a bright blue sky with some white clouds in the\"],\n+                (\"rocm\", (9, 4)): [\"user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There's a blue sky with some white clouds in the background\"]\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()\n@@ -661,6 +668,10 @@ def test_model_4b_batch_crops(self):\n                     \"user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There's a bright blue sky with some white clouds in the\",\n                     'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first image shows a cow on a beach, while the second image shows a street scene with a'\n                 ],\n+                (\"rocm\", (9, 4)) : [\n+                    \"user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There's a blue sky with some white clouds in the background\",\n+                    'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first image shows a cow on a beach, while the second image shows a street scene with a'\n+                ],\n                 (\"rocm\", (9, 5)) : [\n                     'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nWhat is shown in this image?\\nmodel\\nThe image shows a brown cow standing on a sandy beach next to a turquoise ocean. There are clouds in the blue sky above.',\n                     'user\\nYou are a helpful assistant.\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nHere is the original image \\n\\n\\n\\n and here are some crops to help you see better \\n\\n\\n\\n \\n\\n\\n\\nAre these images identical?\\nmodel\\nNo, the images are not identical. \\n\\nThe first image shows a cow on a beach, while the second image shows a street scene with a',\n@@ -704,6 +715,7 @@ def test_model_4b_multiimage(self):\n                 (\"xpu\", 3): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image!\\n\\nHere's a description of the scene:\\n\\n*   **Chinese Arch\"],\n                 (\"cuda\", 7): [],\n                 (\"cuda\", 8): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Overall Scene:**\\n\\nIt looks like a street scene in a vibrant,\"],\n+                (\"rocm\", (9, 4)): [\"user\\nYou are a helpful assistant.\\n\\n\\n\\n\\n\\nWhat do you see here?\\nmodel\\nOkay, let's break down what I see in this image:\\n\\n**Main Features:**\\n\\n*   **Chinese Archway:** The most prominent\"],\n             }\n         )  # fmt: skip\n         EXPECTED_TEXT = EXPECTED_TEXTS.get_expectation()\n@@ -725,6 +737,7 @@ def test_model_1b_text_only(self):\n                 (\"xpu\", 3): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a river deep,\\nWith patterns hidden, secrets sleep.\\nA neural net, a watchful eye,\\nLearning'],\n                 (\"cuda\", 7): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n                 (\"cuda\", 8): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n+                (\"rocm\", (9, 4)): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a silent stream,\\nInto the neural net, a waking dream.\\nAlgorithms hum, a coded grace,\\n'],\n                 (\"rocm\", (9, 5)): ['Write a poem about Machine Learning.\\n\\n---\\n\\nThe data flows, a river deep,\\nWith patterns hidden, secrets sleep.\\nA neural net, a watchful eye,\\nLearning'],\n             }\n         )  # fmt: skip"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 19,
        "deletions": 2
    }
}