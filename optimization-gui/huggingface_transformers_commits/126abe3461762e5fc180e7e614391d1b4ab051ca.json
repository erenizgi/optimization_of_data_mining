{
    "author": "Rocketknight1",
    "message": "More ReDOS fixes! (#36964)\n\n* More ReDOS fixes!\n\n* Slight regex cleanup\n\n* Cleanup regex replacement\n\n* Drop that regex entirely too\n\n* The regex didn't match config.json, let's make sure we don't either\n\n* Cleanup allowed_value_chars a little\n\n* Cleanup the import search\n\n* Catch multi-condition blocks too\n\n* Trigger tests\n\n* Trigger tests",
    "sha": "126abe3461762e5fc180e7e614391d1b4ab051ca",
    "files": [
        {
            "sha": "124286386f05c40ff3fc65c5d9dd897cbf191444",
            "filename": "src/transformers/commands/chat.py",
            "status": "modified",
            "additions": 36,
            "deletions": 4,
            "changes": 40,
            "blob_url": "https://github.com/huggingface/transformers/blob/126abe3461762e5fc180e7e614391d1b4ab051ca/src%2Ftransformers%2Fcommands%2Fchat.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/126abe3461762e5fc180e7e614391d1b4ab051ca/src%2Ftransformers%2Fcommands%2Fchat.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fchat.py?ref=126abe3461762e5fc180e7e614391d1b4ab051ca",
            "patch": "@@ -17,7 +17,7 @@\n import json\n import os\n import platform\n-import re\n+import string\n import time\n from argparse import ArgumentParser, Namespace\n from dataclasses import dataclass, field\n@@ -44,6 +44,10 @@\n \n     from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig, TextIteratorStreamer\n \n+ALLOWED_KEY_CHARS = set(string.ascii_letters + string.whitespace)\n+ALLOWED_VALUE_CHARS = set(\n+    string.ascii_letters + string.digits + string.whitespace + r\".!\\\"#$%&'()*+,\\-/:<=>?@[]^_`{|}~\"\n+)\n \n HELP_STRING = \"\"\"\\\n \n@@ -71,8 +75,6 @@\n     \"repetition_penalty\",\n ]\n \n-SETTING_RE = r\"^set\\s+[A-Za-z\\s_]+=[A-Za-z\\d\\s.!\\\"#$%&'()*+,-/:<=>?@\\[\\]^_`{|}~]+(?:;\\s*[A-Za-z\\s_]+=[A-Za-z\\d\\s.!\\\"#$%&'()*+,-/:<=>?@\\[\\]^_`{|}~]+)*$\"\n-\n DEFAULT_EXAMPLES = {\n     \"llama\": {\"text\": \"There is a Llama in my lawn, how can I get rid of it?\"},\n     \"code\": {\n@@ -438,6 +440,36 @@ def register_subcommand(parser: ArgumentParser):\n     def __init__(self, args):\n         self.args = args\n \n+    @staticmethod\n+    def is_valid_setting_command(s: str) -> bool:\n+        # First check the basic structure\n+        if not s.startswith(\"set \") or \"=\" not in s:\n+            return False\n+\n+        # Split into individual assignments\n+        assignments = [a.strip() for a in s[4:].split(\";\") if a.strip()]\n+\n+        for assignment in assignments:\n+            # Each assignment should have exactly one '='\n+            if assignment.count(\"=\") != 1:\n+                return False\n+\n+            key, value = assignment.split(\"=\", 1)\n+            key = key.strip()\n+            value = value.strip()\n+            if not key or not value:\n+                return False\n+\n+            # Keys can only have alphabetic characters, spaces and underscores\n+            if not set(key).issubset(ALLOWED_KEY_CHARS):\n+                return False\n+\n+            # Values can have just about anything that isn't a semicolon\n+            if not set(value).issubset(ALLOWED_VALUE_CHARS):\n+                return False\n+\n+        return True\n+\n     def run(self):\n         if not is_rich_available():\n             raise ImportError(\"You need to install rich to use the chat interface. (`pip install rich`)\")\n@@ -499,7 +531,7 @@ def run(self):\n                     interface.print_green(f\"Chat saved in {filename}!\")\n                     continue\n \n-                if re.match(SETTING_RE, user_input):\n+                if self.is_valid_setting_command(user_input):\n                     current_args, success = parse_settings(user_input, current_args, interface)\n                     if success:\n                         chat = []"
        },
        {
            "sha": "808cfbcf93053e425dc50fcfc44fd659b33e0834",
            "filename": "src/transformers/configuration_utils.py",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/126abe3461762e5fc180e7e614391d1b4ab051ca/src%2Ftransformers%2Fconfiguration_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/126abe3461762e5fc180e7e614391d1b4ab051ca/src%2Ftransformers%2Fconfiguration_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fconfiguration_utils.py?ref=126abe3461762e5fc180e7e614391d1b4ab051ca",
            "patch": "@@ -17,7 +17,6 @@\n import copy\n import json\n import os\n-import re\n import warnings\n from typing import Any, Optional, Union\n \n@@ -44,8 +43,6 @@\n \n logger = logging.get_logger(__name__)\n \n-_re_configuration_file = re.compile(r\"config\\.(.*)\\.json\")\n-\n \n class PretrainedConfig(PushToHubMixin):\n     # no-format\n@@ -1160,9 +1157,8 @@ def get_configuration_file(configuration_files: list[str]) -> str:\n     \"\"\"\n     configuration_files_map = {}\n     for file_name in configuration_files:\n-        search = _re_configuration_file.search(file_name)\n-        if search is not None:\n-            v = search.groups()[0]\n+        if file_name.startswith(\"config.\") and file_name.endswith(\".json\") and file_name != \"config.json\":\n+            v = file_name.removeprefix(\"config.\").removesuffix(\".json\")\n             configuration_files_map[v] = file_name\n     available_versions = sorted(configuration_files_map.keys())\n "
        },
        {
            "sha": "f0953a7bfd4f9d4d31ea2a0cb2f11f60265a87d1",
            "filename": "src/transformers/dynamic_module_utils.py",
            "status": "modified",
            "additions": 33,
            "deletions": 16,
            "changes": 49,
            "blob_url": "https://github.com/huggingface/transformers/blob/126abe3461762e5fc180e7e614391d1b4ab051ca/src%2Ftransformers%2Fdynamic_module_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/126abe3461762e5fc180e7e614391d1b4ab051ca/src%2Ftransformers%2Fdynamic_module_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fdynamic_module_utils.py?ref=126abe3461762e5fc180e7e614391d1b4ab051ca",
            "patch": "@@ -13,6 +13,7 @@\n # limitations under the License.\n \"\"\"Utilities to dynamically load objects from the Hub.\"\"\"\n \n+import ast\n import filecmp\n import hashlib\n import importlib\n@@ -148,22 +149,38 @@ def get_imports(filename: Union[str, os.PathLike]) -> list[str]:\n     \"\"\"\n     with open(filename, encoding=\"utf-8\") as f:\n         content = f.read()\n-\n-    # filter out try/except block so in custom code we can have try/except imports\n-    content = re.sub(r\"\\s*try\\s*:.*?except.*?:\", \"\", content, flags=re.DOTALL)\n-\n-    # filter out imports under is_flash_attn_2_available block for avoid import issues in cpu only environment\n-    content = re.sub(\n-        r\"if is_flash_attn[a-zA-Z0-9_]+available\\(\\):\\s*(from flash_attn\\s*.*\\s*)+\", \"\", content, flags=re.MULTILINE\n-    )\n-\n-    # Imports of the form `import xxx`\n-    imports = re.findall(r\"^\\s*import\\s+(\\S+)\\s*$\", content, flags=re.MULTILINE)\n-    # Imports of the form `from xxx import yyy`\n-    imports += re.findall(r\"^\\s*from\\s+(\\S+)\\s+import\", content, flags=re.MULTILINE)\n-    # Only keep the top-level module\n-    imports = [imp.split(\".\")[0] for imp in imports if not imp.startswith(\".\")]\n-    return list(set(imports))\n+    imported_modules = set()\n+\n+    def recursive_look_for_imports(node):\n+        if isinstance(node, ast.Try):\n+            return  #  Don't recurse into Try blocks and ignore imports in them\n+        elif isinstance(node, ast.If):\n+            test = node.test\n+            for condition_node in ast.walk(test):\n+                if isinstance(condition_node, ast.Call) and condition_node.func.id.startswith(\"is_flash_attn\"):\n+                    # Don't recurse into \"if flash_attn_available()\" blocks and ignore imports in them\n+                    return\n+        elif isinstance(node, ast.Import):\n+            # Handle 'import x' statements\n+            for alias in node.names:\n+                top_module = alias.name.split(\".\")[0]\n+                if top_module:\n+                    imported_modules.add(top_module)\n+        elif isinstance(node, ast.ImportFrom):\n+            # Handle 'from x import y' statements, ignoring relative imports\n+            if node.level == 0 and node.module:\n+                top_module = node.module.split(\".\")[0]\n+                if top_module:\n+                    imported_modules.add(top_module)\n+\n+        # Recursively visit all children\n+        for child in ast.iter_child_nodes(node):\n+            recursive_look_for_imports(child)\n+\n+    tree = ast.parse(content)\n+    recursive_look_for_imports(tree)\n+\n+    return sorted(imported_modules)\n \n \n def check_imports(filename: Union[str, os.PathLike]) -> list[str]:"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 71,
        "deletions": 26
    }
}