{
    "author": "SunMarc",
    "message": "update deepspeed docker (#37371)\n\n* update\n\n* create docker image\n\n* 03\n\n* uninstall pytest as it conflits with transformers\n\n* wrong one\n\n* better\n\n* see which package depends on pytest\n\n* up\n\n* resintall\n\n* fix\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n* deepspeedddddddd\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "7ae0be722edf891f7686fc79d1d8cb12ccc44bc4",
    "files": [
        {
            "sha": "a51b1f9f1545a410a9039720b7b7188496bfe86c",
            "filename": ".github/workflows/build-docker-images.yml",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/huggingface/transformers/blob/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/.github%2Fworkflows%2Fbuild-docker-images.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/.github%2Fworkflows%2Fbuild-docker-images.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fbuild-docker-images.yml?ref=7ae0be722edf891f7686fc79d1d8cb12ccc44bc4",
            "patch": "@@ -63,14 +63,14 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the transformers-all-latest-gpu-push-ci docker build \n+          title: ðŸ¤— Results of the transformers-all-latest-gpu-push-ci docker build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n   latest-torch-deepspeed-docker:\n     name: \"Latest PyTorch + DeepSpeed\"\n     runs-on:\n-      group: aws-general-8-plus\n+      group: aws-g4dn-2xlarge-cache\n     steps:\n       -\n         name: Set up Docker Buildx\n@@ -99,7 +99,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER}}\n-          title: ðŸ¤— Results of the transformers-pytorch-deepspeed-latest-gpu docker build \n+          title: ðŸ¤— Results of the transformers-pytorch-deepspeed-latest-gpu docker build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -140,7 +140,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the transformers-pytorch-deepspeed-latest-gpu-push-ci docker build \n+          title: ðŸ¤— Results of the transformers-pytorch-deepspeed-latest-gpu-push-ci docker build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -176,7 +176,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the huggingface/transformers-doc-builder docker build \n+          title: ðŸ¤— Results of the huggingface/transformers-doc-builder docker build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -214,7 +214,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the huggingface/transformers-pytorch-gpudocker build \n+          title: ðŸ¤— Results of the huggingface/transformers-pytorch-gpudocker build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -223,19 +223,19 @@ jobs:\n     runs-on:\n       group: aws-general-8-plus\n     steps:\n-      - \n+      -\n         name: Set up Docker Buildx\n         uses: docker/setup-buildx-action@v3\n-      - \n+      -\n         name: Check out code\n         uses: actions/checkout@v4\n-      - \n+      -\n         name: Login to DockerHub\n         uses: docker/login-action@v3\n         with:\n           username: ${{ secrets.DOCKERHUB_USERNAME }}\n           password: ${{ secrets.DOCKERHUB_PASSWORD }}\n-      - \n+      -\n         name: Build and push\n         uses: docker/build-push-action@v5\n         with:\n@@ -263,7 +263,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the huggingface/transformers-pytorch-amd-gpu-push-ci build \n+          title: ðŸ¤— Results of the huggingface/transformers-pytorch-amd-gpu-push-ci build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -301,7 +301,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the huggingface/transformers-tensorflow-gpu build \n+          title: ðŸ¤— Results of the huggingface/transformers-tensorflow-gpu build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -310,19 +310,19 @@ jobs:\n     runs-on:\n       group: aws-general-8-plus\n     steps:\n-      - \n+      -\n         name: Set up Docker Buildx\n         uses: docker/setup-buildx-action@v3\n-      - \n+      -\n         name: Check out code\n         uses: actions/checkout@v4\n-      - \n+      -\n         name: Login to DockerHub\n         uses: docker/login-action@v3\n         with:\n           username: ${{ secrets.DOCKERHUB_USERNAME }}\n           password: ${{ secrets.DOCKERHUB_PASSWORD }}\n-      - \n+      -\n         name: Build and push\n         uses: docker/build-push-action@v5\n         with:\n@@ -350,7 +350,7 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the transformers-pytorch-deepspeed-amd-gpu build \n+          title: ðŸ¤— Results of the transformers-pytorch-deepspeed-amd-gpu build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}\n \n@@ -388,6 +388,6 @@ jobs:\n         uses: huggingface/hf-workflows/.github/actions/post-slack@main\n         with:\n           slack_channel: ${{ secrets.CI_SLACK_CHANNEL_DOCKER }}\n-          title: ðŸ¤— Results of the transformers-quantization-latest-gpu build \n+          title: ðŸ¤— Results of the transformers-quantization-latest-gpu build\n           status: ${{ job.status }}\n           slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}"
        },
        {
            "sha": "dfab083503c2ca2961b245d9be00c6d7afff3af9",
            "filename": ".github/workflows/build-nightly-ci-docker-images.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/.github%2Fworkflows%2Fbuild-nightly-ci-docker-images.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/.github%2Fworkflows%2Fbuild-nightly-ci-docker-images.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fbuild-nightly-ci-docker-images.yml?ref=7ae0be722edf891f7686fc79d1d8cb12ccc44bc4",
            "patch": "@@ -42,7 +42,7 @@ jobs:\n   nightly-torch-deepspeed-docker:\n     name: \"Nightly PyTorch + DeepSpeed\"\n     runs-on:\n-      group: aws-general-8-plus\n+      group: aws-g4dn-2xlarge-cache\n     steps:\n       -\n         name: Set up Docker Buildx"
        },
        {
            "sha": "45aa89fefb2944bda34a523a038c3a813e6096d6",
            "filename": "docker/transformers-pytorch-deepspeed-latest-gpu/Dockerfile",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/docker%2Ftransformers-pytorch-deepspeed-latest-gpu%2FDockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/docker%2Ftransformers-pytorch-deepspeed-latest-gpu%2FDockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftransformers-pytorch-deepspeed-latest-gpu%2FDockerfile?ref=7ae0be722edf891f7686fc79d1d8cb12ccc44bc4",
            "patch": "@@ -1,12 +1,12 @@\n-# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/rel-23-11.html#rel-23-11\n-FROM nvcr.io/nvidia/pytorch:23.11-py3\n+# https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/rel-24-08.html\n+FROM nvcr.io/nvidia/pytorch:24.08-py3\n LABEL maintainer=\"Hugging Face\"\n \n ARG DEBIAN_FRONTEND=noninteractive\n \n-ARG PYTORCH='2.2.0'\n+ARG PYTORCH='2.6.0'\n # Example: `cu102`, `cu113`, etc.\n-ARG CUDA='cu121'\n+ARG CUDA='cu126'\n \n RUN apt -y update\n RUN apt install -y libaio-dev\n@@ -15,7 +15,8 @@ RUN python3 -m pip install --no-cache-dir --upgrade pip\n ARG REF=main\n RUN git clone https://github.com/huggingface/transformers && cd transformers && git checkout $REF\n \n-RUN python3 -m pip install --no-cache-dir ./transformers[deepspeed-testing]\n+# `datasets` requires pandas, pandas has some modules compiled with numpy=1.x causing errors\n+RUN python3 -m pip install --no-cache-dir './transformers[deepspeed-testing]' 'pandas<2' 'numpy<2'\n \n # Install latest release PyTorch\n # (PyTorch must be installed before pre-compiling any DeepSpeed c++/cuda ops.)"
        },
        {
            "sha": "9daa27c06e4456d15ad4f28fca878d2f092973f2",
            "filename": "docker/transformers-pytorch-deepspeed-nightly-gpu/Dockerfile",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/docker%2Ftransformers-pytorch-deepspeed-nightly-gpu%2FDockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7ae0be722edf891f7686fc79d1d8cb12ccc44bc4/docker%2Ftransformers-pytorch-deepspeed-nightly-gpu%2FDockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftransformers-pytorch-deepspeed-nightly-gpu%2FDockerfile?ref=7ae0be722edf891f7686fc79d1d8cb12ccc44bc4",
            "patch": "@@ -1,11 +1,11 @@\n # https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/rel-23-11.html#rel-23-11\n-FROM nvcr.io/nvidia/pytorch:23.11-py3\n+FROM nvcr.io/nvidia/pytorch:24.08-py3\n LABEL maintainer=\"Hugging Face\"\n \n ARG DEBIAN_FRONTEND=noninteractive\n \n # Example: `cu102`, `cu113`, etc.\n-ARG CUDA='cu121'\n+ARG CUDA='cu126'\n \n RUN apt -y update\n RUN apt install -y libaio-dev\n@@ -21,7 +21,8 @@ RUN python3 -m pip uninstall -y torch torchvision torchaudio\n # (https://www.deepspeed.ai/tutorials/advanced-install/#pre-install-deepspeed-ops)\n RUN python3 -m pip install --no-cache-dir -U --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/$CUDA\n \n-RUN python3 -m pip install --no-cache-dir ./transformers[deepspeed-testing]\n+# `datasets` requires pandas, pandas has some modules compiled with numpy=1.x causing errors\n+RUN python3 -m pip install --no-cache-dir './transformers[deepspeed-testing]' 'pandas<2' 'numpy<2'\n \n RUN python3 -m pip install --no-cache-dir git+https://github.com/huggingface/accelerate@main#egg=accelerate\n "
        }
    ],
    "stats": {
        "total": 56,
        "additions": 29,
        "deletions": 27
    }
}