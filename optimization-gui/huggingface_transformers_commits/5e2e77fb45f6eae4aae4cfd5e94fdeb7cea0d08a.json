{
    "author": "cyyever",
    "message": "Improve torch_dtype checks (#40808)\n\n* Improve torch_dtype checks\n\nSigned-off-by: Yuanyuan Chen <cyyever@outlook.com>\n\n* Apply suggestions from code review\n\n---------\n\nSigned-off-by: Yuanyuan Chen <cyyever@outlook.com>\nCo-authored-by: Joao Gante <joaofranciscocardosogante@gmail.com>",
    "sha": "5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a",
    "files": [
        {
            "sha": "70ee41c0c51407d059b1deb0a91fbf506ad6003c",
            "filename": "src/transformers/commands/chat.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a/src%2Ftransformers%2Fcommands%2Fchat.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a/src%2Ftransformers%2Fcommands%2Fchat.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fchat.py?ref=5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a",
            "patch": "@@ -289,8 +289,14 @@ class ChatArguments:\n     def __post_init__(self):\n         \"\"\"Only used for BC `torch_dtype` argument.\"\"\"\n         # In this case only the BC torch_dtype was given\n-        if self.torch_dtype is not None and self.dtype == \"auto\":\n-            self.dtype = self.torch_dtype\n+        if self.torch_dtype is not None:\n+            if self.dtype is None:\n+                self.dtype = self.torch_dtype\n+            elif self.torch_dtype != self.dtype:\n+                raise ValueError(\n+                    f\"`torch_dtype` {self.torch_dtype} and `dtype` {self.dtype} have different values. `torch_dtype` is deprecated and \"\n+                    \"will be removed in 4.59.0, please set `dtype` instead.\"\n+                )\n \n \n def chat_command_factory(args: Namespace):"
        },
        {
            "sha": "33a48aed7e643564e9cd9cadb5341ead6bcade45",
            "filename": "src/transformers/commands/serving.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a/src%2Ftransformers%2Fcommands%2Fserving.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a/src%2Ftransformers%2Fcommands%2Fserving.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fserving.py?ref=5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a",
            "patch": "@@ -457,8 +457,14 @@ class ServeArguments:\n     def __post_init__(self):\n         \"\"\"Only used for BC `torch_dtype` argument.\"\"\"\n         # In this case only the BC torch_dtype was given\n-        if self.torch_dtype is not None and self.dtype == \"auto\":\n-            self.dtype = self.torch_dtype\n+        if self.torch_dtype is not None:\n+            if self.dtype is None:\n+                self.dtype = self.torch_dtype\n+            elif self.torch_dtype != self.dtype:\n+                raise ValueError(\n+                    f\"`torch_dtype` {self.torch_dtype} and `dtype` {self.dtype} have different values. `torch_dtype` is deprecated and \"\n+                    \"will be removed in 4.59.0, please set `dtype` instead.\"\n+                )\n \n \n class ServeCommand(BaseTransformersCLICommand):"
        },
        {
            "sha": "6878f40ad98563956020b2d7cbbfc318cebfd303",
            "filename": "src/transformers/pipelines/keypoint_matching.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a/src%2Ftransformers%2Fpipelines%2Fkeypoint_matching.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a/src%2Ftransformers%2Fpipelines%2Fkeypoint_matching.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fkeypoint_matching.py?ref=5e2e77fb45f6eae4aae4cfd5e94fdeb7cea0d08a",
            "patch": "@@ -147,7 +147,7 @@ def __call__(\n     def preprocess(self, images, timeout=None):\n         images = [load_image(image, timeout=timeout) for image in images]\n         model_inputs = self.image_processor(images=images, return_tensors=self.framework)\n-        model_inputs = model_inputs.to(self.torch_dtype)\n+        model_inputs = model_inputs.to(self.dtype)\n         target_sizes = [image.size for image in images]\n         preprocess_outputs = {\"model_inputs\": model_inputs, \"target_sizes\": target_sizes}\n         return preprocess_outputs"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 17,
        "deletions": 5
    }
}