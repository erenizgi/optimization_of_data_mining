{
    "author": "molbap",
    "message": "[QoL] modular conversion shows LoC saved (#41500)\n\nsmol qol conversion",
    "sha": "b92fc0c6e1e550798f7637c1650fc22936810f49",
    "files": [
        {
            "sha": "f9b7a438803f749b55e7bada3433b0150308d3f0",
            "filename": "utils/modular_model_converter.py",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/huggingface/transformers/blob/b92fc0c6e1e550798f7637c1650fc22936810f49/utils%2Fmodular_model_converter.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/b92fc0c6e1e550798f7637c1650fc22936810f49/utils%2Fmodular_model_converter.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fmodular_model_converter.py?ref=b92fc0c6e1e550798f7637c1650fc22936810f49",
            "patch": "@@ -1743,12 +1743,39 @@ def save_modeling_files(modular_file: str, converted_files: dict[str, str]):\n             f.write(converted_files[file_type])\n \n \n+def count_loc(file_path: str) -> int:\n+    with open(file_path, \"r\", encoding=\"utf-8\") as f:\n+        code = f.read()\n+    comment_less_code = re.sub(r\"#.*\", \"\", code).strip()\n+    comment_less_code = re.sub(r\" *\\n\", \"\\n\", comment_less_code).strip()\n+    return len([line for line in comment_less_code.split(\"\\n\") if line.strip()])\n+\n+\n def run_converter(modular_file: str):\n     \"\"\"Convert a modular file, and save resulting files.\"\"\"\n     print(f\"Converting {modular_file} to a single model single file format\")\n     converted_files = convert_modular_file(modular_file)\n     save_modeling_files(modular_file, converted_files)\n \n+    model_directory = os.path.dirname(modular_file)\n+    modular_loc = count_loc(modular_file)\n+\n+    autogenerated_files = []\n+    for file in os.listdir(model_directory):\n+        if file.endswith(\".py\") and not file.startswith(\"modular_\"):\n+            file_path = os.path.join(model_directory, file)\n+            with open(file_path, \"r\", encoding=\"utf-8\") as f:\n+                if \"This file was automatically generated from\" in f.read():\n+                    autogenerated_files.append(file_path)\n+\n+    if autogenerated_files:\n+        total_generated_loc = sum(count_loc(f) for f in autogenerated_files)\n+        savings = total_generated_loc - modular_loc\n+        percentage = (savings / total_generated_loc) * 100\n+        print(\n+            f\"LoC: {modular_loc} (modular) vs {total_generated_loc} (generated) - saved {savings} LoC ({percentage:.1f}%)\"\n+        )\n+\n \n if __name__ == \"__main__\":\n     parser = argparse.ArgumentParser()"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 27,
        "deletions": 0
    }
}