{
    "author": "mgoin",
    "message": "Fix PixtralProcessor patch_size when spatial_merge_size is used (#37019)",
    "sha": "927ce1d39fee46ab894519d56dd2454171c13b9b",
    "files": [
        {
            "sha": "1a542add6930274cf867875336c225211342a0b8",
            "filename": "src/transformers/models/pixtral/processing_pixtral.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/927ce1d39fee46ab894519d56dd2454171c13b9b/src%2Ftransformers%2Fmodels%2Fpixtral%2Fprocessing_pixtral.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/927ce1d39fee46ab894519d56dd2454171c13b9b/src%2Ftransformers%2Fmodels%2Fpixtral%2Fprocessing_pixtral.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodels%2Fpixtral%2Fprocessing_pixtral.py?ref=927ce1d39fee46ab894519d56dd2454171c13b9b",
            "patch": "@@ -156,6 +156,8 @@ def __call__(\n             **kwargs,\n         )\n \n+        patch_size = self.patch_size * self.spatial_merge_size\n+\n         if images is not None:\n             if is_image_or_image_url(images):\n                 images = [images]\n@@ -172,7 +174,7 @@ def __call__(\n                     \"Invalid input images. Please provide a single image, a list of images, or a list of lists of images.\"\n                 )\n             images = [load_image(im) if isinstance(im, str) else im for im in images]\n-            image_inputs = self.image_processor(images, patch_size=self.patch_size, **output_kwargs[\"images_kwargs\"])\n+            image_inputs = self.image_processor(images, patch_size=patch_size, **output_kwargs[\"images_kwargs\"])\n         else:\n             image_inputs = {}\n \n@@ -192,8 +194,8 @@ def __call__(\n             for sample in text:\n                 while self.image_token in sample:\n                     height, width = next(image_sizes)\n-                    num_height_tokens = height // (self.patch_size * self.spatial_merge_size)\n-                    num_width_tokens = width // (self.patch_size * self.spatial_merge_size)\n+                    num_height_tokens = height // patch_size\n+                    num_width_tokens = width // patch_size\n                     replace_tokens = [\n                         [self.image_token] * num_width_tokens + [self.image_break_token]\n                     ] * num_height_tokens"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 5,
        "deletions": 3
    }
}