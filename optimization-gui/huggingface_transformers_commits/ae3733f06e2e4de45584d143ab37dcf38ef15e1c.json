{
    "author": "McPatate",
    "message": "feat: add `repository` field to benchmarks table (#38582)\n\n* feat: add `repository` field to benchmarks table\n\n* fix: remove unwanted `,`",
    "sha": "ae3733f06e2e4de45584d143ab37dcf38ef15e1c",
    "files": [
        {
            "sha": "42fa1b4387715796f2d7cb6af0845ba5d0fc95dd",
            "filename": ".github/workflows/benchmark.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/.github%2Fworkflows%2Fbenchmark.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/.github%2Fworkflows%2Fbenchmark.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fbenchmark.yml?ref=ae3733f06e2e4de45584d143ab37dcf38ef15e1c",
            "patch": "@@ -64,7 +64,7 @@ jobs:\n             commit_id=$GITHUB_SHA\r\n           fi\r\n           commit_msg=$(git show -s --format=%s | cut -c1-70)\r\n-          python3 benchmark/benchmarks_entrypoint.py \"$BRANCH_NAME\" \"$commit_id\" \"$commit_msg\"\r\n+          python3 benchmark/benchmarks_entrypoint.py \"huggingface/transformers\" \"$BRANCH_NAME\" \"$commit_id\" \"$commit_msg\"\r\n         env:\r\n           HF_TOKEN: ${{ secrets.HF_HUB_READ_TOKEN }}\r\n           # Enable this to see debug logs\r"
        },
        {
            "sha": "71b83254b409bf4081c080851df9fe7ce231686c",
            "filename": "benchmark/benchmarks_entrypoint.py",
            "status": "modified",
            "additions": 18,
            "deletions": 9,
            "changes": 27,
            "blob_url": "https://github.com/huggingface/transformers/blob/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/benchmark%2Fbenchmarks_entrypoint.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/benchmark%2Fbenchmarks_entrypoint.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fbenchmarks_entrypoint.py?ref=ae3733f06e2e4de45584d143ab37dcf38ef15e1c",
            "patch": "@@ -2,11 +2,11 @@\n import importlib.util\n import logging\n import os\n-from typing import Dict\n import sys\n+from typing import Dict, Tuple\n \n-from psycopg2.extras import Json\n from psycopg2.extensions import register_adapter\n+from psycopg2.extras import Json\n \n \n register_adapter(dict, Json)\n@@ -17,10 +17,13 @@ class ImportModuleException(Exception):\n \n \n class MetricsRecorder:\n-    def __init__(self, connection, logger: logging.Logger, branch: str, commit_id: str, commit_msg: str):\n+    def __init__(\n+        self, connection, logger: logging.Logger, repository: str, branch: str, commit_id: str, commit_msg: str\n+    ):\n         self.conn = connection\n         self.conn.autocommit = True\n         self.logger = logger\n+        self.repository = repository\n         self.branch = branch\n         self.commit_id = commit_id\n         self.commit_msg = commit_msg\n@@ -32,8 +35,8 @@ def initialise_benchmark(self, metadata: Dict[str, str]) -> int:\n         # gpu_name: str, model_id: str\n         with self.conn.cursor() as cur:\n             cur.execute(\n-                \"INSERT INTO benchmarks (branch, commit_id, commit_message, metadata) VALUES (%s, %s, %s, %s) RETURNING benchmark_id\",\n-                (self.branch, self.commit_id, self.commit_msg, metadata),\n+                \"INSERT INTO benchmarks (repository, branch, commit_id, commit_message, metadata) VALUES (%s, %s, %s, %s, %s) RETURNING benchmark_id\",\n+                (self.repository, self.branch, self.commit_id, self.commit_msg, metadata),\n             )\n             benchmark_id = cur.fetchone()[0]\n             logger.debug(f\"initialised benchmark #{benchmark_id}\")\n@@ -82,12 +85,18 @@ def close(self):\n logger.addHandler(handler)\n \n \n-def parse_arguments():\n+def parse_arguments() -> Tuple[str, str, str, str]:\n     \"\"\"\n     Parse command line arguments for the benchmarking CLI.\n     \"\"\"\n     parser = argparse.ArgumentParser(description=\"CLI for benchmarking the huggingface/transformers.\")\n \n+    parser.add_argument(\n+        \"repository\",\n+        type=str,\n+        help=\"The repository name on which the benchmarking is performed.\",\n+    )\n+\n     parser.add_argument(\n         \"branch\",\n         type=str,\n@@ -108,7 +117,7 @@ def parse_arguments():\n \n     args = parser.parse_args()\n \n-    return args.branch, args.commit_id, args.commit_msg\n+    return args.repository, args.branch, args.commit_id, args.commit_msg\n \n \n def import_from_path(module_name, file_path):\n@@ -125,7 +134,7 @@ def import_from_path(module_name, file_path):\n if __name__ == \"__main__\":\n     benchmarks_folder_path = os.path.dirname(os.path.realpath(__file__))\n \n-    branch, commit_id, commit_msg = parse_arguments()\n+    repository, branch, commit_id, commit_msg = parse_arguments()\n \n     for entry in os.scandir(benchmarks_folder_path):\n         try:\n@@ -136,7 +145,7 @@ def import_from_path(module_name, file_path):\n             logger.debug(f\"loading: {entry.name}\")\n             module = import_from_path(entry.name.split(\".\")[0], entry.path)\n             logger.info(f\"running benchmarks in: {entry.name}\")\n-            module.run_benchmark(logger, branch, commit_id, commit_msg)\n+            module.run_benchmark(logger, repository, branch, commit_id, commit_msg)\n         except ImportModuleException as e:\n             logger.error(e)\n         except Exception as e:"
        },
        {
            "sha": "9a575177d72dc82dbbea73d6b3a7cdaec11de26e",
            "filename": "benchmark/init_db.sql",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/benchmark%2Finit_db.sql",
            "raw_url": "https://github.com/huggingface/transformers/raw/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/benchmark%2Finit_db.sql",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Finit_db.sql?ref=ae3733f06e2e4de45584d143ab37dcf38ef15e1c",
            "patch": "@@ -1,5 +1,6 @@\n CREATE TABLE IF NOT EXISTS benchmarks (\n   benchmark_id SERIAL PRIMARY KEY,\n+  repository VARCHAR(255),\n   branch VARCHAR(255),\n   commit_id VARCHAR(72),\n   commit_message VARCHAR(70),"
        },
        {
            "sha": "bc60454e0af34e7bc4735e1f4bab8248c0d9f493",
            "filename": "benchmark/llama.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/benchmark%2Fllama.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ae3733f06e2e4de45584d143ab37dcf38ef15e1c/benchmark%2Fllama.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/benchmark%2Fllama.py?ref=ae3733f06e2e4de45584d143ab37dcf38ef15e1c",
            "patch": "@@ -33,11 +33,15 @@ def collect_metrics(benchmark_id, continue_metric_collection, metrics_recorder):\n         sleep(0.01)\n \n \n-def run_benchmark(logger: Logger, branch: str, commit_id: str, commit_msg: str, num_tokens_to_generate=100):\n+def run_benchmark(\n+    logger: Logger, repository: str, branch: str, commit_id: str, commit_msg: str, num_tokens_to_generate=100\n+):\n     continue_metric_collection = Event()\n     metrics_thread = None\n     model_id = \"meta-llama/Llama-2-7b-hf\"\n-    metrics_recorder = MetricsRecorder(psycopg2.connect(\"dbname=metrics\"), logger, branch, commit_id, commit_msg)\n+    metrics_recorder = MetricsRecorder(\n+        psycopg2.connect(\"dbname=metrics\"), logger, repository, branch, commit_id, commit_msg\n+    )\n     try:\n         gpu_stats = gpustat.GPUStatCollection.new_query()\n         gpu_name = gpu_stats[0][\"name\"]"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 26,
        "deletions": 12
    }
}