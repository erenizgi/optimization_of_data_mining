{
    "author": "yonigozlan",
    "message": "Fix broken add-fast-image-processor CLI (#37499)",
    "sha": "4cc6b6065426bdc66cac47bab1ffb26d3807fc53",
    "files": [
        {
            "sha": "dff3cb2d7bc6061aacc6bf9d82f81d3abe0e7b54",
            "filename": "src/transformers/commands/add_fast_image_processor.py",
            "status": "modified",
            "additions": 0,
            "deletions": 143,
            "changes": 143,
            "blob_url": "https://github.com/huggingface/transformers/blob/4cc6b6065426bdc66cac47bab1ffb26d3807fc53/src%2Ftransformers%2Fcommands%2Fadd_fast_image_processor.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4cc6b6065426bdc66cac47bab1ffb26d3807fc53/src%2Ftransformers%2Fcommands%2Fadd_fast_image_processor.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fcommands%2Fadd_fast_image_processor.py?ref=4cc6b6065426bdc66cac47bab1ffb26d3807fc53",
            "patch": "@@ -30,108 +30,6 @@\n REPO_PATH = TRANSFORMERS_PATH.parent.parent\n \n \n-def add_import_structure_entry_init(content: str, fast_image_processor_name: str, model_name: str):\n-    \"\"\"\n-    Add an entry to the `_import_structure` dictionary in the `__init__.py` file of the transformers package.\n-    \"\"\"\n-    # Step 1: Find the block\n-    block_regex = re.compile(\n-        r\"if not is_torchvision_available\\(\\):.*?else:\\s*(\\n(?P<indent>\\s+)_import_structure\\[.*?\\].*?\\n(?:\\s*(?P=indent)_import_structure\\[.*?\\].*?\\n)*)\",\n-        re.DOTALL,\n-    )\n-    match = block_regex.search(content)\n-\n-    if not match:\n-        raise ValueError(\"Couldn't find the '_import_structure' block.\")\n-\n-    # Capture the block content and indentation\n-    block_content = match.group(1)\n-    indent = match.group(\"indent\")\n-\n-    # Step 2: Parse existing entries\n-    lines = block_content.strip().split(\"\\n\")\n-    entries = []\n-\n-    import_structure_header = indent + lines[0]\n-    entries = lines[1:]\n-\n-    # Add the new entry, maintaining alphabetical order\n-    new_entry = f'{indent}_import_structure[\"models.{model_name}\"].append(\"{fast_image_processor_name}\")'\n-    if new_entry not in entries:\n-        entries.append(new_entry)\n-\n-    entries.sort()\n-    entries = [import_structure_header] + entries\n-\n-    # Step 3: Reconstruct the block\n-    updated_block = \"\\n\".join(entry for entry in entries)\n-\n-    # Replace the original block in the content\n-    updated_content = content[: match.start(1)] + \"\\n\" + updated_block + \"\\n\" + content[match.end(1) :]\n-\n-    return updated_content\n-\n-\n-def add_import_statement_init(content: str, fast_image_processor_name: str, model_name: str):\n-    \"\"\"\n-    Add an import statement to the `__init__.py` file of the transformers package.\n-    \"\"\"\n-    # Step 1: Find the block\n-    block_regex = re.compile(\n-        r\"if not is_torchvision_available\\(\\):\\s+raise OptionalDependencyNotAvailable\\(\\)\\s+except OptionalDependencyNotAvailable:\\s+from \\.utils\\.dummy_torchvision_objects import \\*\\s+else:(?P<else_block>\\s*(\\n\\s*from .+ import .*\\n)+)(?=\\s*try:\\s+if not \\(is_torchvision_available\\(\\) and is_timm_available\\(\\)\\):)\",\n-        re.DOTALL,\n-    )\n-    match = block_regex.search(content)\n-\n-    if match:\n-        block_content = match.group(\"else_block\")  # The captured import block\n-    else:\n-        print(\"Couldn't find the import statement block.\")\n-\n-    # Step 2: Parse existing entries\n-    lines = block_content.strip().split(\"\\n\")\n-    entries = []\n-\n-    indent = \" \" * (len(lines[1]) - len(lines[1].lstrip()))\n-    import_structure_header = indent + lines[0]\n-    entries = lines[1:]\n-\n-    # Add the new entry, maintaining alphabetical order\n-    new_entry = f\"{indent}from .models.{model_name} import {fast_image_processor_name}\"\n-    if new_entry not in entries:\n-        entries.append(new_entry)\n-\n-    entries.sort()\n-    entries = [import_structure_header] + entries\n-\n-    # Step 3: Reconstruct the block\n-    updated_block = \"\\n\".join(entry for entry in entries)\n-\n-    # Replace the original block in the content\n-    updated_content = (\n-        content[: match.start(\"else_block\")] + \"\\n\" + updated_block + \"\\n\\n\" + content[match.end(\"else_block\") :]\n-    )\n-\n-    return updated_content\n-\n-\n-def add_fast_image_processor_to_main_init(fast_image_processor_name: str, model_name: str):\n-    \"\"\"\n-    Add the fast image processor to the main __init__.py file of the transformers package.\n-    \"\"\"\n-    with open(TRANSFORMERS_PATH / \"__init__.py\", \"r\", encoding=\"utf-8\") as f:\n-        content = f.read()\n-\n-    # add _import_structure entry\n-    content = add_import_structure_entry_init(content, fast_image_processor_name, model_name)\n-    # add import statement\n-    content = add_import_statement_init(content, fast_image_processor_name, model_name)\n-\n-    # write the updated content\n-    with open(TRANSFORMERS_PATH / \"__init__.py\", \"w\", encoding=\"utf-8\") as f:\n-        f.write(content)\n-\n-\n def add_fast_image_processor_to_model_init(\n     fast_image_processing_module_file: str, fast_image_processor_name, model_name: str\n ):\n@@ -265,40 +163,6 @@ def add_fast_image_processor_to_auto(image_processor_name: str, fast_image_proce\n         f.write(updated_content)\n \n \n-def add_fast_image_processor_to_dummy(fast_image_processor_name: str):\n-    \"\"\"\n-    Add the fast image processor to the dummy torchvision objects file.\n-    \"\"\"\n-    dummy_torchvision_objects_file = TRANSFORMERS_PATH / \"utils\" / \"dummy_torchvision_objects.py\"\n-    with open(dummy_torchvision_objects_file, \"r\", encoding=\"utf-8\") as f:\n-        content = f.read()\n-\n-    # regex to find objects starting with \"class \" and ending with \"ImageProcessorFast\", including \"ImageProcessorFast\" in the match\n-    image_processor_names = re.findall(r\"class (\\w*ImageProcessorFast)\", content)\n-    image_processor_names.append(fast_image_processor_name)\n-    image_processor_names.sort()\n-    index_new = image_processor_names.index(fast_image_processor_name)\n-\n-    new_dummy_object = (\n-        f\"class {fast_image_processor_name}(metaclass=DummyObject):\\n\"\n-        '    _backends = [\"torchvision\"]\\n\\n'\n-        \"    def __init__(self, *args, **kwargs):\\n\"\n-        '        requires_backends(self, [\"torchvision\"])\\n'\n-    )\n-    if new_dummy_object not in content:\n-        if index_new != len(image_processor_names) - 1:\n-            # add the dummy object just before the next ImageProcessorFast\n-            first_line = f\"class {image_processor_names[index_new + 1]}(metaclass=DummyObject):\"\n-            updated_content = content.replace(first_line, new_dummy_object + \"\\n\\n\" + first_line)\n-        else:\n-            # add the dummy object at the very end\n-            updated_content = content + \"\\n\\n\" + new_dummy_object\n-\n-        # write the updated content\n-        with open(dummy_torchvision_objects_file, \"w\", encoding=\"utf-8\") as f:\n-            f.write(updated_content)\n-\n-\n def add_fast_image_processor_to_doc(fast_image_processor_name: str, model_name: str):\n     \"\"\"\n     Add the fast image processor to the model's doc file.\n@@ -619,11 +483,6 @@ def add_fast_image_processor(model_name: str):\n \n     print(f\"Adding {fast_image_processor_name} to {fast_image_processing_module_file}\")\n \n-    add_fast_image_processor_to_main_init(\n-        fast_image_processor_name=fast_image_processor_name,\n-        model_name=model_name,\n-    )\n-\n     add_fast_image_processor_to_model_init(\n         fast_image_processing_module_file=fast_image_processing_module_file,\n         fast_image_processor_name=fast_image_processor_name,\n@@ -635,8 +494,6 @@ def add_fast_image_processor(model_name: str):\n         fast_image_processor_name=fast_image_processor_name,\n     )\n \n-    add_fast_image_processor_to_dummy(fast_image_processor_name=fast_image_processor_name)\n-\n     add_fast_image_processor_to_doc(\n         fast_image_processor_name=fast_image_processor_name,\n         model_name=model_name,"
        }
    ],
    "stats": {
        "total": 143,
        "additions": 0,
        "deletions": 143
    }
}