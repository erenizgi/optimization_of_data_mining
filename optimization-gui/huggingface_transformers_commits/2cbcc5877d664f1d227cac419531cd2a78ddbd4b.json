{
    "author": "techkang",
    "message": "Fix condition when GA loss bug fix is not performed (#35651)\n\n* fix condition when GA loss bug fix is not performed\r\n\r\n* max loss diff is 2.29\r\n\r\n* fix typo\r\n\r\n* add an extra validation that loss should not vary too much",
    "sha": "2cbcc5877d664f1d227cac419531cd2a78ddbd4b",
    "files": [
        {
            "sha": "f7108b12b9048eb8ae937cb04df3916d7ed02a02",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/2cbcc5877d664f1d227cac419531cd2a78ddbd4b/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2cbcc5877d664f1d227cac419531cd2a78ddbd4b/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=2cbcc5877d664f1d227cac419531cd2a78ddbd4b",
            "patch": "@@ -3672,10 +3672,7 @@ def training_step(\n             return loss_mb.reduce_mean().detach().to(self.args.device)\n \n         with self.compute_loss_context_manager():\n-            if self.model_accepts_loss_kwargs:\n-                loss = self.compute_loss(model, inputs)\n-            else:\n-                loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)\n+            loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)\n \n         del inputs\n         if (\n@@ -3709,7 +3706,7 @@ def training_step(\n                 scaled_loss.backward()\n         else:\n             # Finally we need to normalize the loss for reporting\n-            if num_items_in_batch is None:\n+            if not self.model_accepts_loss_kwargs and self.compute_loss_func is None:\n                 loss = loss / self.args.gradient_accumulation_steps\n \n             self.accelerator.backward(loss, **kwargs)\n@@ -5157,10 +5154,6 @@ def get_batch_samples(self, epoch_iterator, num_batches):\n             except StopIteration:\n                 break\n \n-        # Keep default behavior the same\n-        if not self.model_accepts_loss_kwargs:\n-            return batch_samples, None\n-\n         if len(batch_samples) > 0 and \"labels\" in batch_samples[0]:\n             # For now we don't support object detection\n             try:"
        },
        {
            "sha": "0799f690a3407de07f130e8334d73586f0b84b35",
            "filename": "tests/trainer/test_trainer.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/huggingface/transformers/blob/2cbcc5877d664f1d227cac419531cd2a78ddbd4b/tests%2Ftrainer%2Ftest_trainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/2cbcc5877d664f1d227cac419531cd2a78ddbd4b/tests%2Ftrainer%2Ftest_trainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftrainer%2Ftest_trainer.py?ref=2cbcc5877d664f1d227cac419531cd2a78ddbd4b",
            "patch": "@@ -855,7 +855,14 @@ def tokenize_function(examples):\n             self.assertLess(max(diff_truth), 0.01, f\"Difference {max(diff_truth)} is not within 0.01\")\n \n             # max diff broken should be very off\n-            self.assertGreater(max(diff_broken), 3, f\"Difference {max(diff_broken)} is not greater than 3\")\n+            self.assertGreater(max(diff_broken), 2, f\"Difference {max(diff_broken)} is not greater than 2\")\n+\n+            loss_base = sum(base_loss_callback.losses)\n+            loss_broken = sum(broken_loss_callback.losses)\n+\n+            # mean/sum loss should not vary too much.\n+            relative_diff = abs(loss_base - loss_broken) / max(loss_base, loss_broken)\n+            self.assertLess(relative_diff, 0.1, f\"Relative difference {relative_diff} is not within 0.1\")\n \n     @slow\n     def test_gradient_accumulation_loss_alignment_with_loss_func(self):"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 10,
        "deletions": 10
    }
}