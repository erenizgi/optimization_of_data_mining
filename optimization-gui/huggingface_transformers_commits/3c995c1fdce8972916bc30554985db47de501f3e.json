{
    "author": "ydshieh",
    "message": "Fix `chameleon` tests (#38565)\n\n* update\n\n* update\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "3c995c1fdce8972916bc30554985db47de501f3e",
    "files": [
        {
            "sha": "d9716272984647c962057c7669a05047d1d8aa28",
            "filename": "tests/models/chameleon/test_modeling_chameleon.py",
            "status": "modified",
            "additions": 23,
            "deletions": 5,
            "changes": 28,
            "blob_url": "https://github.com/huggingface/transformers/blob/3c995c1fdce8972916bc30554985db47de501f3e/tests%2Fmodels%2Fchameleon%2Ftest_modeling_chameleon.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/3c995c1fdce8972916bc30554985db47de501f3e/tests%2Fmodels%2Fchameleon%2Ftest_modeling_chameleon.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fchameleon%2Ftest_modeling_chameleon.py?ref=3c995c1fdce8972916bc30554985db47de501f3e",
            "patch": "@@ -21,6 +21,7 @@\n \n from transformers import ChameleonConfig, is_torch_available, is_vision_available, set_seed\n from transformers.testing_utils import (\n+    Expectations,\n     require_bitsandbytes,\n     require_read_token,\n     require_torch,\n@@ -417,7 +418,14 @@ def test_model_7b(self):\n         inputs = processor(images=image, text=prompt, return_tensors=\"pt\").to(model.device, torch.float16)\n \n         # greedy generation outputs\n-        EXPECTED_TEXT_COMPLETION = ['Describe what do you see here and tell me about the history behind it?The image depicts a star map, with a bright blue dot in the center representing the star Alpha Centauri. The star map is a representation of the night sky, showing the positions of stars in']  # fmt: skip\n+        EXPECTED_TEXT_COMPLETIONS = Expectations(\n+            {\n+                (\"cuda\", 7): ['Describe what do you see here and tell me about the history behind it?The image depicts a star map, with a bright blue dot in the center representing the star Alpha Centauri. The star map is a representation of the night sky, showing the positions of stars in'],\n+                (\"cuda\", 8): ['Describe what do you see here and tell me about the history behind it?The image depicts a star map, with a bright blue dot representing the position of the star Alpha Centauri. Alpha Centauri is the brightest star in the constellation Centaurus and is located'],\n+            }\n+        )  # fmt: skip\n+        EXPECTED_TEXT_COMPLETION = EXPECTED_TEXT_COMPLETIONS.get_expectation()\n+\n         generated_ids = model.generate(**inputs, max_new_tokens=40, do_sample=False)\n         text = processor.batch_decode(generated_ids, skip_special_tokens=True)\n         self.assertEqual(EXPECTED_TEXT_COMPLETION, text)\n@@ -447,10 +455,20 @@ def test_model_7b_batched(self):\n         )\n \n         # greedy generation outputs\n-        EXPECTED_TEXT_COMPLETION = [\n-            'Describe what do you see here and tell me about the history behind it?The image depicts a star map, with a bright blue dot in the center representing the star Alpha Centauri. The star map is a representation of the night sky, showing the positions of stars in',\n-            'What constellation is this image showing?The image shows the constellation of Orion.The image shows the constellation of Orion.The image shows the constellation of Orion.The image shows the constellation of Orion.'\n-            ]  # fmt: skip\n+        EXPECTED_TEXT_COMPLETIONS = Expectations(\n+            {\n+                (\"cuda\", 7): [\n+                    'Describe what do you see here and tell me about the history behind it?The image depicts a star map, with a bright blue line extending across the center of the image. The line is labeled \"390 light years\" and is accompanied by a small black and',\n+                    'What constellation is this image showing?The image shows the constellation of Orion.The image shows the constellation of Orion.The image shows the constellation of Orion.The image shows the constellation of Orion.',\n+                ],\n+                (\"cuda\", 8): [\n+                    'Describe what do you see here and tell me about the history behind it?The image depicts a star map, with a bright blue dot in the center representing the star Alpha Centauri. The star map is a representation of the night sky, showing the positions of stars in',\n+                    'What constellation is this image showing?The image shows the constellation of Orion.The image shows the constellation of Orion.The image shows the constellation of Orion.The image shows the constellation of Orion.',\n+                ],\n+            }\n+        )  # fmt: skip\n+        EXPECTED_TEXT_COMPLETION = EXPECTED_TEXT_COMPLETIONS.get_expectation()\n+\n         generated_ids = model.generate(**inputs, max_new_tokens=40, do_sample=False)\n         text = processor.batch_decode(generated_ids, skip_special_tokens=True)\n         self.assertEqual(EXPECTED_TEXT_COMPLETION, text)"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 23,
        "deletions": 5
    }
}