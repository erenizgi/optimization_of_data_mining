{
    "author": "zucchini-nlp",
    "message": "ðŸš¨ Image-text pipeline expects correctly formatted chat (#42359)\n\n* don't support images as separate arg\n\n* adjust the test case",
    "sha": "9c1082af99e1b290f9e17199ca0a9291dcbb0a1a",
    "files": [
        {
            "sha": "537c8dac491ed0d8d3b1fabe113c17c80aa50b9b",
            "filename": "src/transformers/pipelines/image_text_to_text.py",
            "status": "modified",
            "additions": 11,
            "deletions": 55,
            "changes": 66,
            "blob_url": "https://github.com/huggingface/transformers/blob/9c1082af99e1b290f9e17199ca0a9291dcbb0a1a/src%2Ftransformers%2Fpipelines%2Fimage_text_to_text.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9c1082af99e1b290f9e17199ca0a9291dcbb0a1a/src%2Ftransformers%2Fpipelines%2Fimage_text_to_text.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fimage_text_to_text.py?ref=9c1082af99e1b290f9e17199ca0a9291dcbb0a1a",
            "patch": "@@ -14,7 +14,6 @@\n # limitations under the License.\n \n import enum\n-from collections.abc import Iterable\n from typing import Any, Union, overload\n \n from ..generation import GenerationConfig\n@@ -55,62 +54,13 @@ class Chat:\n     to this format because the rest of the pipeline code tends to assume that lists of messages are\n     actually a batch of samples rather than messages in the same conversation.\"\"\"\n \n-    def __init__(\n-        self, messages: dict, images: Union[str, list[str], \"Image.Image\", list[\"Image.Image\"]] | None = None\n-    ):\n+    def __init__(self, messages: dict):\n         for message in messages:\n             if not (\"role\" in message and \"content\" in message):\n                 raise ValueError(\"When passing chat dicts as input, each dict must have a 'role' and 'content' key.\")\n-        messages = add_images_to_messages(messages, images)\n-\n         self.messages = messages\n \n \n-def add_images_to_messages(messages: dict, images: Union[str, list[str], \"Image.Image\", list[\"Image.Image\"]] | None):\n-    \"\"\"\n-    Retrieve and combine images from the chat and the images passed as input.\n-    \"\"\"\n-    if images is None:\n-        images = []\n-    elif not isinstance(images, Iterable) or isinstance(images, str):\n-        images = [images]\n-    idx_images = 0\n-    for message in messages:\n-        for content in message[\"content\"]:\n-            if not isinstance(content, dict):\n-                continue\n-            content_type = content.get(\"type\")\n-            if content_type == \"image\":\n-                if not any(key in content for key in [\"image\", \"url\", \"path\", \"base64\"]):\n-                    if idx_images < len(images):\n-                        # Insert the image passed as argument in the chat message\n-                        content[\"image\"] = images[idx_images]\n-                        idx_images += 1\n-                    else:\n-                        raise ValueError(\n-                            \"The number of images in the chat messages should be the same as the number of images passed to the pipeline.\"\n-                        )\n-            # Add support for OpenAI/TGI chat format\n-            elif content_type == \"image_url\":\n-                if isinstance(content.get(\"image_url\"), dict) and \"url\" in content[\"image_url\"]:\n-                    # Rewrite content to be in the Transformers chat format\n-                    content[\"type\"] = \"image\"\n-                    content[\"image\"] = content[\"image_url\"][\"url\"]\n-                    del content[\"image_url\"]\n-                else:\n-                    raise ValueError(\n-                        \"Wrong format for 'image_url' content type. The content should have an 'image_url' dict with a 'url' key.\"\n-                    )\n-\n-    # The number of images passed should be consistent with the number of images in the chat without an image key\n-    if idx_images != len(images):\n-        raise ValueError(\n-            \"The number of images in the chat messages should be the same as the number of images passed to the pipeline.\"\n-        )\n-\n-    return messages\n-\n-\n @add_end_docstrings(build_pipeline_init_args(has_processor=True))\n class ImageTextToTextPipeline(Pipeline):\n     \"\"\"\n@@ -332,13 +282,19 @@ def _is_chat(arg):\n             return isinstance(arg, (list, tuple, KeyDataset)) and isinstance(arg[0], (list, tuple, dict))\n \n         if _is_chat(text):\n+            if images is not None:\n+                raise ValueError(\n+                    \"Invalid input: you passed `chat` and `images` as separate input arguments. \"\n+                    \"Images must be placed inside the chat message's `content`. For example, \"\n+                    \"'content': [\"\n+                    \"      {'type': 'image', 'url': 'image_url'}, {'type': 'text', 'text': 'Describe the image.'}}\"\n+                    \"]\"\n+                )\n             # We have one or more prompts in list-of-dicts format, so this is chat mode\n             if isinstance(text[0], dict):\n-                return super().__call__(Chat(text, images), **kwargs)\n+                return super().__call__(Chat(text), **kwargs)\n             else:\n-                if images is None:\n-                    images = [None] * len(text)\n-                chats = [Chat(chat, image) for chat, image in zip(text, images)]  # ðŸˆ ðŸˆ ðŸˆ\n+                chats = [Chat(chat) for chat in text]  # ðŸˆ ðŸˆ ðŸˆ\n                 return super().__call__(chats, **kwargs)\n \n         # Same as above, but the `images` argument contains the chat. This can happen e.g. is the user only passes a"
        },
        {
            "sha": "858a92b25a32da547770ab5d15438937a84c9f44",
            "filename": "tests/pipelines/test_pipelines_image_text_to_text.py",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/huggingface/transformers/blob/9c1082af99e1b290f9e17199ca0a9291dcbb0a1a/tests%2Fpipelines%2Ftest_pipelines_image_text_to_text.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/9c1082af99e1b290f9e17199ca0a9291dcbb0a1a/tests%2Fpipelines%2Ftest_pipelines_image_text_to_text.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fpipelines%2Ftest_pipelines_image_text_to_text.py?ref=9c1082af99e1b290f9e17199ca0a9291dcbb0a1a",
            "patch": "@@ -196,7 +196,21 @@ def test_model_pt_chat_template(self):\n                 ],\n             }\n         ]\n-        outputs = pipe([image_ny, image_chicago], text=messages, return_full_text=True, max_new_tokens=10)\n+        # Deprecated behavior should raise an error after v5\n+        with self.assertRaises(ValueError):\n+            outputs = pipe([image_ny, image_chicago], text=messages, return_full_text=True, max_new_tokens=10)\n+\n+        messages = [\n+            {\n+                \"role\": \"user\",\n+                \"content\": [\n+                    {\"type\": \"text\", \"text\": \"Whatâ€™s the difference between these two images?\"},\n+                    {\"type\": \"image\", \"url\": image_ny},\n+                    {\"type\": \"image\", \"url\": image_chicago},\n+                ],\n+            }\n+        ]\n+        outputs = pipe(text=messages, return_full_text=True, max_new_tokens=10)\n         self.assertEqual(\n             outputs,\n             [\n@@ -208,11 +222,11 @@ def test_model_pt_chat_template(self):\n                                 {\"type\": \"text\", \"text\": \"Whatâ€™s the difference between these two images?\"},\n                                 {\n                                     \"type\": \"image\",\n-                                    \"image\": \"https://cdn.britannica.com/61/93061-050-99147DCE/Statue-of-Liberty-Island-New-York-Bay.jpg\",\n+                                    \"url\": \"https://cdn.britannica.com/61/93061-050-99147DCE/Statue-of-Liberty-Island-New-York-Bay.jpg\",\n                                 },\n                                 {\n                                     \"type\": \"image\",\n-                                    \"image\": \"https://cdn.britannica.com/59/94459-050-DBA42467/Skyline-Chicago.jpg\",\n+                                    \"url\": \"https://cdn.britannica.com/59/94459-050-DBA42467/Skyline-Chicago.jpg\",\n                                 },\n                             ],\n                         }\n@@ -224,11 +238,11 @@ def test_model_pt_chat_template(self):\n                                 {\"type\": \"text\", \"text\": \"Whatâ€™s the difference between these two images?\"},\n                                 {\n                                     \"type\": \"image\",\n-                                    \"image\": \"https://cdn.britannica.com/61/93061-050-99147DCE/Statue-of-Liberty-Island-New-York-Bay.jpg\",\n+                                    \"url\": \"https://cdn.britannica.com/61/93061-050-99147DCE/Statue-of-Liberty-Island-New-York-Bay.jpg\",\n                                 },\n                                 {\n                                     \"type\": \"image\",\n-                                    \"image\": \"https://cdn.britannica.com/59/94459-050-DBA42467/Skyline-Chicago.jpg\",\n+                                    \"url\": \"https://cdn.britannica.com/59/94459-050-DBA42467/Skyline-Chicago.jpg\",\n                                 },\n                             ],\n                         },"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 30,
        "deletions": 60
    }
}