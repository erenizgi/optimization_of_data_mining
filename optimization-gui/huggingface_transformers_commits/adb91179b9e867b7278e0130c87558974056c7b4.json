{
    "author": "JasonZhu1313",
    "message": "Integrate Liger (Linkedin GPU Efficient Runtime) Kernel to Trainer (#32860)\n\n* add liger integration\r\n\r\n* fix syntax\r\n\r\n* fix import issue\r\n\r\n* add trainer.md\r\n\r\n* Use _apply_liger_kernel()\r\n\r\n* Fixed log message\r\n\r\n* Update docs/source/en/trainer.md\r\n\r\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>\r\n\r\n* Update docs/source/en/trainer.md\r\n\r\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>\r\n\r\n* Update src/transformers/training_args.py\r\n\r\nCo-authored-by: Byron Hsu <byronhsu1230@gmail.com>\r\n\r\n* Update src/transformers/trainer.py\r\n\r\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>\r\n\r\n* Update src/transformers/training_args.py\r\n\r\nCo-authored-by: Byron Hsu <byronhsu1230@gmail.com>\r\n\r\n* Update docs/source/en/trainer.md\r\n\r\nCo-authored-by: Byron Hsu <byronhsu1230@gmail.com>\r\n\r\n* Fixed checkstyle and updated readme\r\n\r\n* Added test\r\n\r\n* Fixed checkstyle\r\n\r\n* fix docstring\r\n\r\n* rename use_liger to use_liger_kernel\r\n\r\n* Trigger Build\r\n\r\n* Added test\r\n\r\n* add fix-copies\r\n\r\n* Fixed copy inconsistencies\r\n\r\n---------\r\n\r\nCo-authored-by: shimizust <sshimizu@linkedin.com>\r\nCo-authored-by: Steven Shimizu <shimizust@gmail.com>\r\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>\r\nCo-authored-by: Byron Hsu <byronhsu1230@gmail.com>",
    "sha": "adb91179b9e867b7278e0130c87558974056c7b4",
    "files": [
        {
            "sha": "b5a89c55c96af71a2d5aa977c5c9f9d39235e49d",
            "filename": "docs/source/en/trainer.md",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/docs%2Fsource%2Fen%2Ftrainer.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/docs%2Fsource%2Fen%2Ftrainer.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Ftrainer.md?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -382,6 +382,41 @@ trainer.train()\n \n Note layerwise optimization is a bit experimental and does not support DDP (Distributed Data Parallel), thus you can run the training script only on a single GPU. Please see [this appropriate section](https://github.com/jiaweizzhao/GaLore?tab=readme-ov-file#train-7b-model-with-a-single-gpu-with-24gb-memory) for more details. Other features such as gradient clipping, DeepSpeed, etc might not be supported out of the box. Please [raise an issue on GitHub](https://github.com/huggingface/transformers/issues) if you encounter such issue.\n \n+## Liger Kernel\n+\n+[Liger-Kernel](https://github.com/linkedin/Liger-Kernel) Kernel is a collection of Triton kernels developed by Linkedin designed specifically for LLM training. We have implemented Hugging Face Compatible RMSNorm, RoPE, SwiGLU, CrossEntropy, FusedLinearCrossEntropy, and more to come. It can effectively increase multi-GPU training throughput by 20% and reduces memory usage by 60%. The kernel works out of the box with flash attention, PyTorch FSDP, and Microsoft DeepSpeed.\n+\n+<Tip>\n+Gain +20% throughput and reduce memory usage by 60% on LLaMA 3-8B model training. Achieve longer context lengths and larger batch sizes. Itâ€™s also useful if you want to scale up your model to multi-head training or large vocabulary sizes. Unleash multi-head training (medusa) and more. See details and examples in [Liger](https://github.com/linkedin/Liger-Kernel/tree/main/examples)\n+</Tip>\n+\n+First make sure to install Liger official repository:\n+```bash\n+pip install liger-kernel\n+```\n+\n+You should pass `use_liger_kernel=True` to apply liger kernel on your model, for example:\n+\n+```py\n+from transformers import TrainingArguments\n+\n+training_args = TrainingArguments(\n+    output_dir=\"your-model\",\n+    learning_rate=2e-5,\n+    per_device_train_batch_size=16,\n+    per_device_eval_batch_size=16,\n+    num_train_epochs=2,\n+    weight_decay=0.01,\n+    eval_strategy=\"epoch\",\n+    save_strategy=\"epoch\",\n+    load_best_model_at_end=True,\n+    push_to_hub=True,\n+    use_liger_kernel=True\n+)\n+```\n+\n+The kernel supports the Llama, Gemma, Mistral, and Mixtral model architectures. The most up-to-date list of supported models can be found [here](https://github.com/linkedin/Liger-Kernel). When `use_liger_kernel` is set to `True`, the corresponding layers in the original model will be patched with Liger's efficient implementation, so you don't need to do anything extra other than setting the argument value.\n+\n ## LOMO optimizer\n \n The LOMO optimizers have been introduced in [Full Parameter Fine-Tuning for Large Language Models with Limited Resources](https://hf.co/papers/2306.09782) and [AdaLomo: Low-memory Optimization with Adaptive Learning Rate](https://hf.co/papers/2310.10195). "
        },
        {
            "sha": "3d30c9ff647980639f8e773209e668094f80e3d0",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -84,6 +84,7 @@\n     is_keras_nlp_available,\n     is_levenshtein_available,\n     is_librosa_available,\n+    is_liger_kernel_available,\n     is_lomo_available,\n     is_natten_available,\n     is_nltk_available,\n@@ -1162,6 +1163,13 @@ def require_librosa(test_case):\n     return unittest.skipUnless(is_librosa_available(), \"test requires librosa\")(test_case)\n \n \n+def require_liger_kernel(test_case):\n+    \"\"\"\n+    Decorator marking a test that requires liger_kernel\n+    \"\"\"\n+    return unittest.skipUnless(is_liger_kernel_available(), \"test requires liger_kernel\")(test_case)\n+\n+\n def require_essentia(test_case):\n     \"\"\"\n     Decorator marking a test that requires essentia"
        },
        {
            "sha": "2684b3f0ec0db122e9e21ca33d61ccbadb3cb572",
            "filename": "src/transformers/trainer.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Ftrainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Ftrainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftrainer.py?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -155,6 +155,7 @@\n     is_grokadamw_available,\n     is_in_notebook,\n     is_ipex_available,\n+    is_liger_kernel_available,\n     is_lomo_available,\n     is_peft_available,\n     is_safetensors_available,\n@@ -464,6 +465,24 @@ def __init__(\n                     \" to `True` to avoid any unexpected behavior such as device placement mismatching.\"\n                 )\n \n+        if self.args.use_liger_kernel:\n+            if is_liger_kernel_available():\n+                from liger_kernel.transformers.trainer_integration import _apply_liger_kernel\n+\n+                model_type = getattr(model, \"config\", None) and getattr(model.config, \"model_type\", None)\n+                if model_type:\n+                    # Monkey patch the model with liger kernels. Use the default kernel configurations.\n+                    _apply_liger_kernel(model_type=model_type)\n+                else:\n+                    logger.warning(\n+                        \"The model does not have a valid `model_type` specified. No liger kernels will be applied.\"\n+                    )\n+            else:\n+                raise ImportError(\n+                    \"You have set `use_liger_kernel` to `True` but liger-kernel >= 0.1.0 is not available. \"\n+                    \"Please install it with `pip install liger-kernel`\"\n+                )\n+\n         _is_quantized_and_base_model = getattr(model, \"is_quantized\", False) and not getattr(\n             model, \"_hf_peft_config_loaded\", False\n         )"
        },
        {
            "sha": "6b587bdd65ae971d3d11037798610b5e0abae73e",
            "filename": "src/transformers/training_args.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Ftraining_args.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Ftraining_args.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftraining_args.py?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -793,6 +793,11 @@ class TrainingArguments:\n \n         eval_use_gather_object (`bool`, *optional*, defaults to `False`):\n             Whether to run recursively gather object in a nested list/tuple/dictionary of objects from all devices. This should only be enabled if users are not just returning tensors, and this is actively discouraged by PyTorch.\n+\n+        use_liger_kernel (`bool`, *optional*, defaults to `False`):\n+            Whether enable [Liger](https://github.com/linkedin/Liger-Kernel) Kernel for LLM model training.\n+            It can effectively increase multi-GPU training throughput by ~20% and reduces memory usage by ~60%, works out of the box with\n+            flash attention, PyTorch FSDP, and Microsoft DeepSpeed. Currently, it supports llama, mistral, mixtral and gemma models.\n     \"\"\"\n \n     framework = \"pt\"\n@@ -1493,6 +1498,11 @@ class TrainingArguments:\n         },\n     )\n \n+    use_liger_kernel: Optional[bool] = field(\n+        default=False,\n+        metadata={\"help\": \"Whether or not to enable the Liger Kernel for model training.\"},\n+    )\n+\n     eval_use_gather_object: Optional[bool] = field(\n         default=False,\n         metadata={"
        },
        {
            "sha": "56f594da15f122936190b859039f4bba359103b5",
            "filename": "src/transformers/utils/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Futils%2F__init__.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Futils%2F__init__.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2F__init__.py?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -148,6 +148,7 @@\n     is_keras_nlp_available,\n     is_levenshtein_available,\n     is_librosa_available,\n+    is_liger_kernel_available,\n     is_lomo_available,\n     is_mlx_available,\n     is_natten_available,"
        },
        {
            "sha": "0c16cac0f0713fa9621a6d4db01b7760dfe9ca95",
            "filename": "src/transformers/utils/import_utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Futils%2Fimport_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/src%2Ftransformers%2Futils%2Fimport_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fimport_utils.py?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -177,6 +177,7 @@ def _is_package_available(pkg_name: str, return_version: bool = False) -> Union[\n _torchvision_available = _is_package_available(\"torchvision\")\n _mlx_available = _is_package_available(\"mlx\")\n _hqq_available = _is_package_available(\"hqq\")\n+_liger_kernel_available = _is_package_available(\"liger_kernel\")\n \n \n _torch_version = \"N/A\"\n@@ -1164,6 +1165,13 @@ def is_mlx_available():\n     return _mlx_available\n \n \n+def is_liger_kernel_available():\n+    if not _liger_kernel_available:\n+        return False\n+\n+    return version.parse(importlib.metadata.version(\"liger_kernel\")) >= version.parse(\"0.1.0\")\n+\n+\n # docstyle-ignore\n AV_IMPORT_ERROR = \"\"\"\n {0} requires the PyAv library but it was not found in your environment. You can install it with:"
        },
        {
            "sha": "00d15acf18be4a7d55f5d4cd61b12e36fbfe7a5f",
            "filename": "tests/trainer/test_trainer.py",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/huggingface/transformers/blob/adb91179b9e867b7278e0130c87558974056c7b4/tests%2Ftrainer%2Ftest_trainer.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/adb91179b9e867b7278e0130c87558974056c7b4/tests%2Ftrainer%2Ftest_trainer.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftrainer%2Ftest_trainer.py?ref=adb91179b9e867b7278e0130c87558974056c7b4",
            "patch": "@@ -64,6 +64,7 @@\n     require_galore_torch,\n     require_grokadamw,\n     require_intel_extension_for_pytorch,\n+    require_liger_kernel,\n     require_lomo,\n     require_optuna,\n     require_peft,\n@@ -1325,6 +1326,42 @@ def test_get_eval_dataloader_with_persistent_workers(self):\n         self.assertEqual(first_dataloader, first_dataloader_repeated)\n         self.assertEqual(second_dataloader, second_dataloader_repeated)\n \n+    @require_liger_kernel\n+    def test_use_liger_kernel_patching(self):\n+        # Test that the model code actually gets patched with Liger kernel\n+        from liger_kernel.transformers.rms_norm import LigerRMSNorm\n+\n+        from transformers.models.llama import modeling_llama\n+\n+        config = LlamaConfig(vocab_size=100, hidden_size=32, num_hidden_layers=3, num_attention_heads=4)\n+        tiny_llama = LlamaForCausalLM(config)\n+\n+        args = TrainingArguments(\n+            \"./test\",\n+            use_liger_kernel=True,\n+        )\n+        Trainer(tiny_llama, args)\n+\n+        # Check that one of the Llama model layers has been correctly patched with Liger kernel\n+        self.assertEqual(modeling_llama.LlamaRMSNorm, LigerRMSNorm)\n+\n+    @require_liger_kernel\n+    @require_torch_gpu\n+    def test_use_liger_kernel_trainer(self):\n+        # Check that trainer still works with liger kernel applied\n+        config = LlamaConfig(vocab_size=100, hidden_size=32, num_hidden_layers=3, num_attention_heads=4)\n+        tiny_llama = LlamaForCausalLM(config)\n+\n+        x = torch.randint(0, 100, (128,))\n+        train_dataset = RepeatDataset(x)\n+\n+        with tempfile.TemporaryDirectory() as tmpdir:\n+            args = TrainingArguments(tmpdir, learning_rate=1e-2, logging_steps=5, max_steps=20, use_liger_kernel=True)\n+            trainer = Trainer(tiny_llama, args, train_dataset=train_dataset)\n+\n+            # Check this works\n+            _ = trainer.train()\n+\n     @require_lomo\n     @require_torch_gpu\n     def test_lomo(self):"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 118,
        "deletions": 0
    }
}