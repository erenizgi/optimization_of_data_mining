{
    "author": "ydshieh",
    "message": "CircleCI docker images cleanup / update / fix (#40681)\n\n* fix\n\n* fix\n\n---------\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
    "files": [
        {
            "sha": "5033f3dacf9d47dd494e5482ed01bc5df689449a",
            "filename": ".circleci/create_circleci_config.py",
            "status": "modified",
            "additions": 1,
            "deletions": 17,
            "changes": 18,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/.circleci%2Fcreate_circleci_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/.circleci%2Fcreate_circleci_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fcreate_circleci_config.py?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -262,7 +262,6 @@ def job_name(self):\n     docker_image=[{\"image\": \"huggingface/transformers-custom-tokenizers\"}],\n )\n \n-\n examples_torch_job = CircleCIJob(\n     \"examples_torch\",\n     additional_env={\"OMP_NUM_THREADS\": 8},\n@@ -286,35 +285,20 @@ def job_name(self):\n     resource_class=\"medium\",\n )\n \n-\n-onnx_job = CircleCIJob(\n-    \"onnx\",\n-    docker_image=[{\"image\":\"huggingface/transformers-torch-tf-light\"}],\n-    install_steps=[\n-        \"uv pip install .[testing,sentencepiece,onnxruntime,vision,rjieba]\",\n-    ],\n-    pytest_options={\"k onnx\": None},\n-    pytest_num_workers=1,\n-    resource_class=\"small\",\n-)\n-\n-\n exotic_models_job = CircleCIJob(\n     \"exotic_models\",\n     docker_image=[{\"image\":\"huggingface/transformers-exotic-models\"}],\n     parallelism=4,\n     pytest_options={\"durations\": 100},\n )\n \n-\n repo_utils_job = CircleCIJob(\n     \"repo_utils\",\n     docker_image=[{\"image\":\"huggingface/transformers-consistency\"}],\n     pytest_num_workers=4,\n     resource_class=\"large\",\n )\n \n-\n non_model_job = CircleCIJob(\n     \"non_model\",\n     docker_image=[{\"image\": \"huggingface/transformers-torch-light\"}],\n@@ -350,7 +334,7 @@ def job_name(self):\n     pytest_num_workers=1,\n )\n \n-REGULAR_TESTS = [torch_job, hub_job, onnx_job, tokenization_job, processor_job, generate_job, non_model_job] # fmt: skip\n+REGULAR_TESTS = [torch_job, hub_job, tokenization_job, processor_job, generate_job, non_model_job] # fmt: skip\n EXAMPLES_TESTS = [examples_torch_job]\n PIPELINE_TESTS = [pipelines_torch_job]\n REPO_UTIL_TESTS = [repo_utils_job]"
        },
        {
            "sha": "fa32ff820cb7f162583825ef43fc6d95d51c1d8e",
            "filename": ".github/workflows/build-ci-docker-images.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/.github%2Fworkflows%2Fbuild-ci-docker-images.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/.github%2Fworkflows%2Fbuild-ci-docker-images.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fbuild-ci-docker-images.yml?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -26,7 +26,7 @@ jobs:\n \n     strategy:\n       matrix:\n-        file: [\"quality\", \"consistency\", \"custom-tokenizers\", \"torch-light\", \"tf-light\", \"exotic-models\", \"torch-tf-light\", \"jax-light\", \"examples-torch\",  \"examples-tf\"]\n+        file: [\"quality\", \"consistency\", \"custom-tokenizers\", \"torch-light\", \"exotic-models\", \"examples-torch\"]\n     continue-on-error: true\n \n     steps:"
        },
        {
            "sha": "74687f4a1558c9d886088ad557eddb7fabc5f587",
            "filename": "docker/custom-tokenizers.dockerfile",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Fcustom-tokenizers.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Fcustom-tokenizers.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fcustom-tokenizers.dockerfile?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -2,7 +2,7 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git cmake wget xz-utils build-essential g++5 libprotobuf-dev protobuf-compiler\n+RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git cmake wget xz-utils build-essential g++5 libprotobuf-dev protobuf-compiler git-lfs\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n "
        },
        {
            "sha": "b357821d045c0416a4b0b721fe9b4c6e34f002e8",
            "filename": "docker/examples-tf.dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Fexamples-tf.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Fexamples-tf.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fexamples-tf.dockerfile?ref=7f92e1f91aa40002e5efdb7f616048ebe581e730",
            "patch": "@@ -1,13 +0,0 @@\n-FROM python:3.9-slim\n-ENV PYTHONDONTWRITEBYTECODE=1\n-ARG REF=main\n-USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git\n-RUN apt-get install -y g++ cmake\n-ENV UV_PYTHON=/usr/local/bin/python\n-RUN pip --no-cache-dir install uv\n-RUN uv pip install --no-cache-dir -U pip setuptools albumentations seqeval\n-RUN uv pip install  --upgrade --no-cache-dir \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[tf-cpu,sklearn,testing,sentencepiece,tf-speech,vision]\"\n-RUN uv pip install --no-cache-dir  \"protobuf==3.20.3\"\n-RUN uv pip uninstall transformers\n-RUN apt-get clean && rm -rf /var/lib/apt/lists/*"
        },
        {
            "sha": "26b71f5e7f35e18988f1eeef52e23bdf44b187a5",
            "filename": "docker/examples-torch.dockerfile",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Fexamples-torch.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Fexamples-torch.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fexamples-torch.dockerfile?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -2,7 +2,7 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git ffmpeg\n+RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git-lfs ffmpeg\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' 'torchcodec' --index-url https://download.pytorch.org/whl/cpu"
        },
        {
            "sha": "5ab7b510a83ed17f09f95b53323db2d5226799a2",
            "filename": "docker/exotic-models.dockerfile",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Fexotic-models.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Fexotic-models.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fexotic-models.dockerfile?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -2,12 +2,12 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git libgl1-mesa-glx libgl1 g++ tesseract-ocr\n+RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git libgl1 g++ tesseract-ocr git-lfs\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' --index-url https://download.pytorch.org/whl/cpu\n RUN uv pip install --no-cache-dir  --no-deps timm accelerate\n-RUN uv pip install -U --upgrade-strategy eager --no-cache-dir pytesseract python-Levenshtein opencv-python nltk\n+RUN uv pip install -U --no-cache-dir pytesseract python-Levenshtein opencv-python nltk\n # RUN uv pip install --no-cache-dir natten==0.15.1+torch210cpu -f https://shi-labs.com/natten/wheels\n RUN uv pip install  --no-cache-dir \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[testing, vision]\" 'scikit-learn' 'torch-stft' 'nose'  'dataset'\n # RUN git clone https://github.com/facebookresearch/detectron2.git"
        },
        {
            "sha": "eff17cd8bf10b9023d6a5624cbf437ef461e0b84",
            "filename": "docker/jax-light.dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Fjax-light.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Fjax-light.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fjax-light.dockerfile?ref=7f92e1f91aa40002e5efdb7f616048ebe581e730",
            "patch": "@@ -1,10 +0,0 @@\n-FROM python:3.9-slim\n-ENV PYTHONDONTWRITEBYTECODE=1\n-ARG REF=main\n-USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git g++ cmake\n-ENV UV_PYTHON=/usr/local/bin/python\n-RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n-RUN uv pip install --no-cache-dir \"scipy<1.13\" \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[flax,testing,sentencepiece,flax-speech,vision]\"\n-RUN uv pip uninstall transformers\n-RUN apt-get clean && rm -rf /var/lib/apt/lists/* && apt-get autoremove && apt-get autoclean"
        },
        {
            "sha": "9e22c2a80f14955bf7ce345e5fdbf1c1ab07fa28",
            "filename": "docker/pipeline-tf.dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Fpipeline-tf.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Fpipeline-tf.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Fpipeline-tf.dockerfile?ref=7f92e1f91aa40002e5efdb7f616048ebe581e730",
            "patch": "@@ -1,10 +0,0 @@\n-FROM python:3.9-slim\n-ENV PYTHONDONTWRITEBYTECODE=1\n-ARG REF=main\n-USER root\n-RUN apt-get update && apt-get install -y libsndfile1-dev espeak-ng time git cmake g++\n-ENV UV_PYTHON=/usr/local/bin/python\n-RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n-RUN uv pip install --no-cache-dir \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[sklearn,tf-cpu,testing,sentencepiece,tf-speech,vision]\"\n-RUN uv pip install --no-cache-dir  \"protobuf==3.20.3\" tensorflow_probability\n-RUN apt-get clean && rm -rf /var/lib/apt/lists/*"
        },
        {
            "sha": "9c4bb5a96daa1bf3591e0815319dcc9ac47fdbcc",
            "filename": "docker/tf-light.dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/huggingface/transformers/blob/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Ftf-light.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Ftf-light.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftf-light.dockerfile?ref=7f92e1f91aa40002e5efdb7f616048ebe581e730",
            "patch": "@@ -1,12 +0,0 @@\n-FROM python:3.9-slim\n-ENV PYTHONDONTWRITEBYTECODE=1\n-ARG REF=main\n-USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ pkg-config openssh-client git\n-RUN apt-get install -y  cmake\n-ENV UV_PYTHON=/usr/local/bin/python\n-RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n-RUN uv pip install  --upgrade --no-cache-dir \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[tf-cpu,sklearn,testing,sentencepiece,tf-speech,vision]\"\n-RUN uv pip install --no-cache-dir  \"protobuf==3.20.3\"\n-RUN uv pip uninstall transformers\n-RUN apt-get clean && rm -rf /var/lib/apt/lists/* && apt-get autoremove && apt-get autoclean"
        },
        {
            "sha": "9c7835eca133146de4e336632613e8cdaeb714d9",
            "filename": "docker/torch-jax-light.dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/huggingface/transformers/blob/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Ftorch-jax-light.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Ftorch-jax-light.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftorch-jax-light.dockerfile?ref=7f92e1f91aa40002e5efdb7f616048ebe581e730",
            "patch": "@@ -1,16 +0,0 @@\n-FROM python:3.9-slim\n-ENV PYTHONDONTWRITEBYTECODE=1\n-ARG REF=main\n-USER root\n-RUN apt-get update &&  apt-get install -y libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git\n-ENV UV_PYTHON=/usr/local/bin/python\n-RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n-RUN uv pip install --no-deps accelerate\n-RUN uv pip install --no-cache-dir 'torch' 'torchvision' 'torchaudio' --index-url https://download.pytorch.org/whl/cpu\n-RUN uv pip install --no-cache-dir \"scipy<1.13\" \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[flax,audio,sklearn,sentencepiece,vision,testing]\"\n-\n-\n-# RUN pip install --no-cache-dir \"scipy<1.13\" \"transformers[flax,testing,sentencepiece,flax-speech,vision]\"\n-\n-RUN uv pip uninstall transformers\n-RUN apt-get clean && rm -rf /var/lib/apt/lists/* && apt-get autoremove && apt-get autoclean"
        },
        {
            "sha": "8a9a7ff07a95186b5223dff1def5b872a480d826",
            "filename": "docker/torch-light.dockerfile",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Ftorch-light.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/docker%2Ftorch-light.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftorch-light.dockerfile?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -2,7 +2,7 @@ FROM python:3.9-slim\n ENV PYTHONDONTWRITEBYTECODE=1\n ARG REF=main\n USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git git-lfs ffmpeg\n+RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git-lfs ffmpeg\n ENV UV_PYTHON=/usr/local/bin/python\n RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' 'torchcodec' --index-url https://download.pytorch.org/whl/cpu"
        },
        {
            "sha": "e1ad5535156dd21efbe34386b8cd85977a466e91",
            "filename": "docker/torch-tf-light.dockerfile",
            "status": "removed",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/huggingface/transformers/blob/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Ftorch-tf-light.dockerfile",
            "raw_url": "https://github.com/huggingface/transformers/raw/7f92e1f91aa40002e5efdb7f616048ebe581e730/docker%2Ftorch-tf-light.dockerfile",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docker%2Ftorch-tf-light.dockerfile?ref=7f92e1f91aa40002e5efdb7f616048ebe581e730",
            "patch": "@@ -1,19 +0,0 @@\n-FROM python:3.9-slim\n-ENV PYTHONDONTWRITEBYTECODE=1\n-ARG REF=main\n-RUN echo ${REF}\n-USER root\n-RUN apt-get update &&  apt-get install -y --no-install-recommends libsndfile1-dev espeak-ng time git g++ cmake pkg-config openssh-client git git-lfs\n-ENV UV_PYTHON=/usr/local/bin/python\n-RUN pip --no-cache-dir install uv && uv pip install --no-cache-dir -U pip setuptools\n-RUN uv pip install --no-cache-dir  --no-deps accelerate --extra-index-url https://download.pytorch.org/whl/cpu \n-RUN uv pip install --no-cache-dir 'torch' 'torchaudio' 'torchvision' --index-url https://download.pytorch.org/whl/cpu\n-RUN git lfs install\n-\n-RUN uv pip install --no-cache-dir pypi-kenlm\n-RUN uv pip install --no-cache-dir  \"git+https://github.com/huggingface/transformers.git@${REF}#egg=transformers[tf-cpu,sklearn,sentencepiece,vision,testing]\"\n-RUN uv pip install --no-cache-dir  \"protobuf==3.20.3\" librosa\n-\n-\n-RUN uv pip uninstall transformers\n-RUN apt-get clean && rm -rf /var/lib/apt/lists/* && apt-get autoremove && apt-get autoclean"
        },
        {
            "sha": "6dc7618eb31f52bbbc38c177b208b1e1e8d4e889",
            "filename": "utils/tests_fetcher.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/huggingface/transformers/blob/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/utils%2Ftests_fetcher.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/30a4b8707d93dbec4629d351e8a9c2a66be7ad9f/utils%2Ftests_fetcher.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ftests_fetcher.py?ref=30a4b8707d93dbec4629d351e8a9c2a66be7ad9f",
            "patch": "@@ -1115,7 +1115,6 @@ def parse_commit_message(commit_message: str) -> dict[str, bool]:\n     # \"repo_utils\": r\"tests/[^models].*test.*\", TODO later on we might want to do\n     \"pipelines_torch\": r\"tests/models/.*/test_modeling_(?!(?:flax_|tf_)).*\",\n     \"tests_hub\": r\"tests/.*\",\n-    \"tests_onnx\": r\"tests/models/.*/test_modeling_(?:tf_|(?!flax)).*\",\n     \"tests_non_model\": r\"tests/[^/]*?/test_.*\\.py\",\n }\n "
        }
    ],
    "stats": {
        "total": 111,
        "additions": 7,
        "deletions": 104
    }
}