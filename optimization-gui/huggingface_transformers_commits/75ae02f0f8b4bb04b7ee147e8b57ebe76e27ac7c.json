{
    "author": "ydshieh",
    "message": "Ultra security for `pr-repo-consistency-bot.yml` (#42652)\n\nbetter\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "75ae02f0f8b4bb04b7ee147e8b57ebe76e27ac7c",
    "files": [
        {
            "sha": "2dbf80ec268ad5060d84216ec33e35828bd19ee7",
            "filename": ".github/workflows/pr-repo-consistency-bot.yml",
            "status": "modified",
            "additions": 34,
            "deletions": 15,
            "changes": 49,
            "blob_url": "https://github.com/huggingface/transformers/blob/75ae02f0f8b4bb04b7ee147e8b57ebe76e27ac7c/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/75ae02f0f8b4bb04b7ee147e8b57ebe76e27ac7c/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fpr-repo-consistency-bot.yml?ref=75ae02f0f8b4bb04b7ee147e8b57ebe76e27ac7c",
            "patch": "@@ -113,26 +113,46 @@ jobs:\n     outputs:\n       changes_detected: ${{ steps.run_checks.outputs.changes_detected }}\n     steps:\n-      - uses: actions/checkout@v4\n+      # Checkout the trusted base repository (main branch) - this is safe\n+      - name: Checkout base repository\n+        uses: actions/checkout@v4\n         with:\n-          repository: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}\n-          ref: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}\n-          fetch-depth: \"1\"\n+          ref: main\n \n       - name: Set up Python\n         uses: actions/setup-python@v4\n         with:\n           python-version: \"3.10\"\n \n-      - name: Install dependencies\n+      - name: Install dependencies from trusted main branch\n         run: |\n           python -m pip install --upgrade pip\n           pip install -e \".[quality]\"\n           pip install --no-cache-dir --upgrade 'torch' 'torchaudio' 'torchvision' --index-url https://download.pytorch.org/whl/cpu\n \n-      - name: Run checks\n+      - name: Fetch and checkout PR code manually\n+        env:\n+          PR_HEAD_REPO_FULL_NAME: ${{ needs.get-pr-info.outputs.PR_HEAD_REPO_FULL_NAME }}\n+          PR_HEAD_SHA: ${{ needs.check-timestamps.outputs.VERIFIED_PR_HEAD_SHA }}\n+        run: |\n+          # Create separate directory for PR code\n+          mkdir -p pr-repo\n+          cd pr-repo\n+          \n+          # Initialize git and fetch only the specific commit\n+          git init\n+          git remote add pr-origin https://github.com/${PR_HEAD_REPO_FULL_NAME}.git\n+          git fetch --depth=1 pr-origin ${PR_HEAD_SHA}\n+          git checkout ${PR_HEAD_SHA}\n+\n+      - name: Run checks with trusted script\n         id: run_checks\n         run: |\n+          # Copy trusted script to PR directory\n+          cp utils/check_copies.py pr-repo/utils/check_copies.py\n+          \n+          # Run the trusted script in PR directory\n+          cd pr-repo\n           python utils/check_copies.py --fix_and_overwrite\n           \n           # Check if there are changes\n@@ -145,22 +165,21 @@ jobs:\n       - name: Save modified files\n         if: steps.run_checks.outputs.changes_detected == 'true'\n         run: |\n-          mkdir -p pr-repo\n-          git diff --name-only > modified-files.txt\n-          # Copy each modified file to pr-repo directory\n+          cd pr-repo\n+          mkdir -p ../artifact-staging\n+          git diff --name-only > ../artifact-staging/modified-files.txt\n+          # Copy each modified file\n           while IFS= read -r file; do\n-            mkdir -p \"pr-repo/$(dirname \"$file\")\"\n-            cp \"$file\" \"pr-repo/$file\"\n-          done < modified-files.txt\n+            mkdir -p \"../artifact-staging/pr-repo/$(dirname \"$file\")\"\n+            cp \"$file\" \"../artifact-staging/pr-repo/$file\"\n+          done < ../artifact-staging/modified-files.txt\n \n       - name: Upload modified files\n         if: steps.run_checks.outputs.changes_detected == 'true'\n         uses: actions/upload-artifact@v4\n         with:\n           name: modified-files\n-          path: |\n-            modified-files.txt\n-            pr-repo/\n+          path: artifact-staging/\n \n   commit-and-comment:\n     runs-on: ubuntu-22.04"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 34,
        "deletions": 15
    }
}