{
    "author": "1himan",
    "message": "Updated aya_vision.md (#38749)\n\n* Update aya_vision.md\n\n* Suggested changes made to aya_vision.md\n\n* Quantization Example added - aya_vision.md\n\n* Polished - aya_vision.md\n\n* Update aya_vision.md\n\n---------\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>",
    "sha": "64e9b049d96e7c42abfacc44b94d1b00f7a6c7db",
    "files": [
        {
            "sha": "4b10f99fa9e08ace0f613bc4f34e5e443aa18058",
            "filename": "docs/source/en/model_doc/aya_vision.md",
            "status": "modified",
            "additions": 167,
            "deletions": 140,
            "changes": 307,
            "blob_url": "https://github.com/huggingface/transformers/blob/64e9b049d96e7c42abfacc44b94d1b00f7a6c7db/docs%2Fsource%2Fen%2Fmodel_doc%2Faya_vision.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/64e9b049d96e7c42abfacc44b94d1b00f7a6c7db/docs%2Fsource%2Fen%2Fmodel_doc%2Faya_vision.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmodel_doc%2Faya_vision.md?ref=64e9b049d96e7c42abfacc44b94d1b00f7a6c7db",
            "patch": "@@ -14,82 +14,32 @@ rendered properly in your Markdown viewer.\n \n -->\n \n-# AyaVision\n+<div style=\"float: right;\">\n+    <div class=\"flex flex-wrap space-x-1\">\n+        <img alt=\"PyTorch\" src=\"https://img.shields.io/badge/PyTorch-DE3412?style=flat&logo=pytorch&logoColor=white\">\n+    </div>\n+</div>\n \n-## Overview\n+# Aya Vision\n \n-The Aya Vision 8B and 32B models is a state-of-the-art multilingual multimodal models developed by Cohere For AI. They build on the Aya Expanse recipe to handle both visual and textual information without compromising on the strong multilingual textual performance of the original model.\n+[Aya Vision](https://huggingface.co/papers/2505.08751) is a family of open-weight multimodal vision-language models from Cohere Labs. It is trained with a synthetic annotation framework that generates high-quality multilingual image captions, improving Aya Vision's generated responses. In addition, a cross-modal model merging technique is used to prevent the model from losing its text capabilities after adding vision capabilities. The model combines a CommandR-7B language model with a SigLIP vision encoder.\n \n-Aya Vision 8B combines the `Siglip2-so400-384-14` vision encoder with the Cohere CommandR-7B language model further post-trained with the Aya Expanse recipe, creating a powerful vision-language model capable of understanding images and generating text across 23 languages. Whereas, Aya Vision 32B uses Aya Expanse 32B as the language model.\n+You can find all the original Aya Vision checkpoints under the [Aya Vision](https://huggingface.co/collections/CohereLabs/cohere-labs-aya-vision-67c4ccd395ca064308ee1484) collection.\n \n-Key features of Aya Vision include:\n-- Multimodal capabilities in 23 languages\n-- Strong text-only multilingual capabilities inherited from CommandR-7B post-trained with the Aya Expanse recipe and Aya Expanse 32B\n-- High-quality visual understanding using the Siglip2-so400-384-14 vision encoder\n-- Seamless integration of visual and textual information in 23 languages.\n+> [!TIP]\n+> This model was contributed by [saurabhdash](https://huggingface.co/saurabhdash) and [yonigozlan](https://huggingface.co/yonigozlan).\n+> \n+> Click on the Aya Vision models in the right sidebar for more examples of how to apply Aya Vision to different image-to-text tasks.\n \n-<!-- <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/model_doc/aya_vision_architecture.webp\"\n-alt=\"drawing\" width=\"600\"/>\n+The example below demonstrates how to generate text based on an image with [`Pipeline`] or the [`AutoModel`] class.\n \n-<small> Aya Vision architecture. </small> -->\n-\n-Tips:\n-\n-- Aya Vision is a multimodal model that takes images and text as input and produces text as output.\n-- Images are represented using the `<image>` tag in the templated input.\n-- For best results, use the `apply_chat_template` method of the processor to format your inputs correctly.\n-- The model can process multiple images in a single conversation.\n-- Aya Vision can understand and generate text in 23 languages, making it suitable for multilingual multimodal applications.\n-\n-This model was contributed by [saurabhdash](https://huggingface.co/saurabhdash) and [yonigozlan](https://huggingface.co/yonigozlan).\n-\n-\n-## Usage\n-\n-Here's how to use Aya Vision for inference:\n-\n-```python\n-from transformers import AutoProcessor, AutoModelForImageTextToText\n-import torch\n-\n-model_id = \"CohereForAI/aya-vision-8b\"\n-torch_device = \"cuda:0\"\n-\n-# Use fast image processor\n-processor = AutoProcessor.from_pretrained(model_id, use_fast=True)\n-model = AutoModelForImageTextToText.from_pretrained(\n-    model_id, device_map=torch_device, torch_dtype=torch.float16\n-)\n-\n-# Format message with the aya-vision chat template\n-messages = [\n-    {\"role\": \"user\",\n-     \"content\": [\n-       {\"type\": \"image\", \"url\": \"https://pbs.twimg.com/media/Fx7YvfQWYAIp6rZ?format=jpg&name=medium\"},\n-        {\"type\": \"text\", \"text\": \"चित्र में लिखा पाठ क्या कहता है?\"},\n-    ]},\n-    ]\n-\n-# Process image on CUDA\n-inputs = processor.apply_chat_template(\n-    messages, padding=True, add_generation_prompt=True, tokenize=True, return_dict=True, return_tensors=\"pt\", device=torch_device\n-).to(model.device)\n-\n-gen_tokens = model.generate(\n-    **inputs, \n-    max_new_tokens=300, \n-    do_sample=True, \n-    temperature=0.3,\n-)\n-\n-gen_text = print(processor.tokenizer.decode(gen_tokens[0][inputs.input_ids.shape[1]:], skip_special_tokens=True))\n-```\n-### Pipeline\n+<hfoptions id=\"usage\">\n+<hfoption id=\"Pipeline\">\n \n ```python\n from transformers import pipeline\n \n-pipe = pipeline(model=\"CohereForAI/aya-vision-8b\", task=\"image-text-to-text\", device_map=\"auto\")\n+pipe = pipeline(model=\"CohereLabs/aya-vision-8b\", task=\"image-text-to-text\", device_map=\"auto\")\n \n # Format message with the aya-vision chat template\n messages = [\n@@ -104,84 +54,108 @@ outputs = pipe(text=messages, max_new_tokens=300, return_full_text=False)\n print(outputs)\n ```\n \n-### Multiple Images and Batched Inputs\n-\n-Aya Vision can process multiple images in a single conversation. Here's how to use it with multiple images:\n+</hfoption>\n+<hfoption id=\"AutoModel\">\n \n ```python\n+# pip install 'git+https://github.com/huggingface/transformers.git@v4.49.0-Aya Vision'\n from transformers import AutoProcessor, AutoModelForImageTextToText\n import torch\n \n-model_id = \"CohereForAI/aya-vision-8b\"\n+model_id = \"CohereLabs/aya-vision-8b\"\n \n processor = AutoProcessor.from_pretrained(model_id)\n model = AutoModelForImageTextToText.from_pretrained(\n-    model_id, device_map=\"cuda:0\", torch_dtype=torch.float16\n+    model_id, device_map=\"auto\", torch_dtype=torch.float16\n )\n \n-# Example with multiple images in a single message\n+# Format message with the aya-vision chat template\n messages = [\n-    {\n-        \"role\": \"user\",\n-        \"content\": [\n-            {\n-                \"type\": \"image\",\n-                \"url\": \"https://cdn.britannica.com/61/93061-050-99147DCE/Statue-of-Liberty-Island-New-York-Bay.jpg\",\n-            },\n-            {\n-                \"type\": \"image\",\n-                \"url\": \"https://thumbs.dreamstime.com/b/golden-gate-bridge-san-francisco-purple-flowers-california-echium-candicans-36805947.jpg\",\n-            },\n-            {\n-                \"type\": \"text\",\n-                \"text\": \"These images depict two different landmarks. Can you identify them?\",\n-            },\n-        ],\n-    },\n-]\n+    {\"role\": \"user\",\n+     \"content\": [\n+       {\"type\": \"image\", \"url\": \"https://pbs.twimg.com/media/Fx7YvfQWYAIp6rZ?format=jpg&name=medium\"},\n+        {\"type\": \"text\", \"text\": \"चित्र में लिखा पाठ क्या कहता है?\"},\n+    ]},\n+    ]\n \n inputs = processor.apply_chat_template(\n     messages, padding=True, add_generation_prompt=True, tokenize=True, return_dict=True, return_tensors=\"pt\"\n ).to(model.device)\n \n gen_tokens = model.generate(\n-    **inputs, \n-    max_new_tokens=300, \n-    do_sample=True, \n+    **inputs,\n+    max_new_tokens=300,\n+    do_sample=True,\n     temperature=0.3,\n )\n \n-gen_text = processor.tokenizer.decode(gen_tokens[0][inputs.input_ids.shape[1]:], skip_special_tokens=True)\n-print(gen_text)\n+print(processor.tokenizer.decode(gen_tokens[0][inputs.input_ids.shape[1]:], skip_special_tokens=True))\n ```\n \n-For processing batched inputs (multiple conversations at once):\n+</hfoption>\n+</hfoptions>\n+\n+Quantization reduces the memory footprint of large models by representing weights at lower precision. Refer to the [Quantization](../quantization/overview) overview for supported backends.\n+\n+The example below uses [bitsandbytes](../quantization/bitsandbytes) to only quantize the weights to 4-bits.\n \n ```python\n-from transformers import AutoProcessor, AutoModelForImageTextToText\n import torch\n+from transformers import (\n+    AutoProcessor,\n+    AutoModelForImageTextToText,\n+    BitsAndBytesConfig\n+)\n \n-model_id = \"CohereForAI/aya-vision-8b\"\n+bnb_config = BitsAndBytesConfig(\n+    load_in_4bit=True,\n+    bnb_4bit_quant_type=\"nf4\",\n+    bnb_4bit_compute_dtype=torch.bfloat16,\n+    bnb_4bit_use_double_quant=True\n+)\n \n-processor = AutoProcessor.from_pretrained(model_id)\n+processor = AutoProcessor.from_pretrained(\"CohereLabs/aya-vision-32b\", use_fast=True)\n model = AutoModelForImageTextToText.from_pretrained(\n-    model_id, device_map=\"cuda:0\", torch_dtype=torch.float16\n+    \"CohereLabs/aya-vision-32b\",\n+    quantization_config=bnb_config,\n+    device_map=\"auto\"\n )\n \n-# Prepare two different conversations\n-batch_messages = [\n-    # First conversation with a single image\n+inputs = processor.apply_chat_template(\n     [\n-        {\n-            \"role\": \"user\",\n-            \"content\": [\n-                {\"type\": \"image\", \"url\": \"https://llava-vl.github.io/static/images/view.jpg\"},\n-                {\"type\": \"text\", \"text\": \"Write a haiku for this image\"},\n-            ],\n-        },\n+    {\"role\": \"user\", \"content\": [\n+        {\"type\": \"image\", \"url\": \"https://huggingface.co/roschmid/dog-races/resolve/main/images/Border_Collie.jpg\"},\n+        {\"type\": \"text\",  \"text\":\"Describe what you see.\"}\n+    ]}\n     ],\n-    # Second conversation with multiple images\n-    [\n+    padding=True,\n+    add_generation_prompt=True,\n+    tokenize=True,\n+    return_tensors=\"pt\"\n+).to(\"cuda\")\n+\n+generated = model.generate(**inputs, max_new_tokens=50)\n+print(processor.tokenizer.decode(generated[0], skip_special_tokens=True))\n+```\n+\n+## Notes\n+\n+- Images are represented with the `<image>` tag in the chat template.\n+\n+- Use the [`~ProcessorMixin.apply_chat_template`] method to correctly format inputs.\n+\n+- The example below demonstrates inference with multiple images.\n+  \n+    ```py\n+    from transformers import AutoProcessor, AutoModelForImageTextToText\n+    import torch\n+        \n+    processor = AutoProcessor.from_pretrained(\"CohereForAI/aya-vision-8b\")\n+    model = AutoModelForImageTextToText.from_pretrained(\n+        \"CohereForAI/aya-vision-8b\", device_map=\"cuda\", torch_dtype=torch.float16\n+    )\n+    \n+    messages = [\n         {\n             \"role\": \"user\",\n             \"content\": [\n@@ -199,35 +173,88 @@ batch_messages = [\n                 },\n             ],\n         },\n-    ],\n-]\n-\n-# Process each conversation separately and combine into a batch\n-batch_inputs = processor.apply_chat_template(\n-    batch_messages, \n-    padding=True, \n-    add_generation_prompt=True, \n-    tokenize=True, \n-    return_dict=True, \n-    return_tensors=\"pt\"\n-).to(model.device)\n-\n-# Generate responses for the batch\n-batch_outputs = model.generate(\n-    **batch_inputs,\n-    max_new_tokens=300,\n-    do_sample=True,\n-    temperature=0.3,\n-)\n-\n-# Decode the generated responses\n-for i, output in enumerate(batch_outputs):\n-    response = processor.tokenizer.decode(\n-        output[batch_inputs.input_ids.shape[1]:], \n-        skip_special_tokens=True\n+    ]\n+    \n+    inputs = processor.apply_chat_template(\n+        messages, padding=True, add_generation_prompt=True, tokenize=True, return_dict=True, return_tensors=\"pt\"\n+    ).to(\"cuda\")\n+    \n+    gen_tokens = model.generate(\n+        **inputs, \n+        max_new_tokens=300, \n+        do_sample=True, \n+        temperature=0.3,\n     )\n-    print(f\"Response {i+1}:\\n{response}\\n\")\n-```\n+    \n+    gen_text = processor.tokenizer.decode(gen_tokens[0][inputs.input_ids.shape[1]:], skip_special_tokens=True)\n+    print(gen_text)\n+    ```\n+\n+- The example below demonstrates inference with batched inputs.\n+  \n+    ```py\n+    from transformers import AutoProcessor, AutoModelForImageTextToText\n+    import torch\n+        \n+    processor = AutoProcessor.from_pretrained(model_id)\n+    model = AutoModelForImageTextToText.from_pretrained(\n+        \"CohereForAI/aya-vision-8b\", device_map=\"cuda\", torch_dtype=torch.float16\n+    )\n+    \n+    batch_messages = [\n+        [\n+            {\n+                \"role\": \"user\",\n+                \"content\": [\n+                    {\"type\": \"image\", \"url\": \"https://llava-vl.github.io/static/images/view.jpg\"},\n+                    {\"type\": \"text\", \"text\": \"Write a haiku for this image\"},\n+                ],\n+            },\n+        ],\n+        [\n+            {\n+                \"role\": \"user\",\n+                \"content\": [\n+                    {\n+                        \"type\": \"image\",\n+                        \"url\": \"https://cdn.britannica.com/61/93061-050-99147DCE/Statue-of-Liberty-Island-New-York-Bay.jpg\",\n+                    },\n+                    {\n+                        \"type\": \"image\",\n+                        \"url\": \"https://thumbs.dreamstime.com/b/golden-gate-bridge-san-francisco-purple-flowers-california-echium-candicans-36805947.jpg\",\n+                    },\n+                    {\n+                        \"type\": \"text\",\n+                        \"text\": \"These images depict two different landmarks. Can you identify them?\",\n+                    },\n+                ],\n+            },\n+        ],\n+    ]\n+    \n+    batch_inputs = processor.apply_chat_template(\n+        batch_messages, \n+        padding=True, \n+        add_generation_prompt=True, \n+        tokenize=True, \n+        return_dict=True, \n+        return_tensors=\"pt\"\n+    ).to(model.device)\n+    \n+    batch_outputs = model.generate(\n+        **batch_inputs,\n+        max_new_tokens=300,\n+        do_sample=True,\n+        temperature=0.3,\n+    )\n+    \n+    for i, output in enumerate(batch_outputs):\n+        response = processor.tokenizer.decode(\n+            output[batch_inputs.input_ids.shape[1]:], \n+            skip_special_tokens=True\n+        )\n+        print(f\"Response {i+1}:\\n{response}\\n\")\n+    ```\n \n ## AyaVisionProcessor\n "
        }
    ],
    "stats": {
        "total": 307,
        "additions": 167,
        "deletions": 140
    }
}