{
    "author": "hmellor",
    "message": "Lazy import libraries in `src/transformers/image_utils.py` (#36435)\n\n* Lazy import libraries in `src/transformers/image_utils.py`\n\n* `make fixup`\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n* Protect imports\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>\n\n---------\n\nSigned-off-by: Harry Mellor <19981378+hmellor@users.noreply.github.com>",
    "sha": "6a876462c308bd7cd7d3ca8e93abaa7d5b02e90e",
    "files": [
        {
            "sha": "1d47f40c1ef3473bde9d207a0ce5da8782ec553f",
            "filename": "src/transformers/image_utils.py",
            "status": "modified",
            "additions": 16,
            "deletions": 11,
            "changes": 27,
            "blob_url": "https://github.com/huggingface/transformers/blob/6a876462c308bd7cd7d3ca8e93abaa7d5b02e90e/src%2Ftransformers%2Fimage_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/6a876462c308bd7cd7d3ca8e93abaa7d5b02e90e/src%2Ftransformers%2Fimage_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fimage_utils.py?ref=6a876462c308bd7cd7d3ca8e93abaa7d5b02e90e",
            "patch": "@@ -74,17 +74,6 @@\n             PILImageResampling.LANCZOS: InterpolationMode.LANCZOS,\n         }\n \n-if is_decord_available():\n-    from decord import VideoReader, cpu\n-\n-if is_av_available():\n-    import av\n-\n-if is_cv2_available():\n-    import cv2\n-\n-if is_yt_dlp_available():\n-    from yt_dlp import YoutubeDL\n \n if TYPE_CHECKING:\n     if is_torch_available():\n@@ -608,6 +597,10 @@ def sample_indices_fn(metadata, **kwargs):\n             - Numpy array of frames in RGB (shape: [num_frames, height, width, 3]).\n             - `VideoMetadata` object.\n     \"\"\"\n+    # Lazy import cv2\n+    requires_backends(read_video_opencv, [\"cv2\"])\n+    import cv2\n+\n     video = cv2.VideoCapture(video_path)\n     total_num_frames = int(video.get(cv2.CAP_PROP_FRAME_COUNT))\n     video_fps = video.get(cv2.CAP_PROP_FPS)\n@@ -661,6 +654,10 @@ def sample_indices_fn(metadata, **kwargs):\n             - Numpy array of frames in RGB (shape: [num_frames, height, width, 3]).\n             - `VideoMetadata` object.\n     \"\"\"\n+    # Lazy import from decord\n+    requires_backends(read_video_decord, [\"decord\"])\n+    from decord import VideoReader, cpu\n+\n     vr = VideoReader(uri=video_path, ctx=cpu(0))  # decord has problems with gpu\n     video_fps = vr.get_avg_fps()\n     total_num_frames = len(vr)\n@@ -700,6 +697,10 @@ def sample_indices_fn(metadata, **kwargs):\n             - Numpy array of frames in RGB (shape: [num_frames, height, width, 3]).\n             - `VideoMetadata` object.\n     \"\"\"\n+    # Lazy import av\n+    requires_backends(read_video_pyav, [\"av\"])\n+    import av\n+\n     container = av.open(video_path)\n     total_num_frames = container.streams.video[0].frames\n     video_fps = container.streams.video[0].average_rate  # should we better use `av_guess_frame_rate`?\n@@ -834,6 +835,10 @@ def sample_indices_fn_func(metadata, **fn_kwargs):\n     if video.startswith(\"https://www.youtube.com\") or video.startswith(\"http://www.youtube.com\"):\n         if not is_yt_dlp_available():\n             raise ImportError(\"To load a video from YouTube url you have  to install `yt_dlp` first.\")\n+        # Lazy import from yt_dlp\n+        requires_backends(load_video, [\"yt_dlp\"])\n+        from yt_dlp import YoutubeDL\n+\n         buffer = BytesIO()\n         with redirect_stdout(buffer), YoutubeDL() as f:\n             f.download([video])"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 16,
        "deletions": 11
    }
}