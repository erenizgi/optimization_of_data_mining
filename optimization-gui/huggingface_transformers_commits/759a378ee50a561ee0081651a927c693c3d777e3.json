{
    "author": "aymeric-roucher",
    "message": "Allow handling files as args for a tool created with Tool.from_space (#34687)\n\n* Allow handling files as args for a tool created with `Tool.from_space`",
    "sha": "759a378ee50a561ee0081651a927c693c3d777e3",
    "files": [
        {
            "sha": "6d3401bf30e94a553a70df94a2c2806ea78c10a1",
            "filename": "src/transformers/agents/tools.py",
            "status": "modified",
            "additions": 83,
            "deletions": 18,
            "changes": 101,
            "blob_url": "https://github.com/huggingface/transformers/blob/759a378ee50a561ee0081651a927c693c3d777e3/src%2Ftransformers%2Fagents%2Ftools.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/759a378ee50a561ee0081651a927c693c3d777e3/src%2Ftransformers%2Fagents%2Ftools.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fagents%2Ftools.py?ref=759a378ee50a561ee0081651a927c693c3d777e3",
            "patch": "@@ -23,6 +23,7 @@\n import os\n import tempfile\n from functools import lru_cache, wraps\n+from pathlib import Path\n from typing import Any, Callable, Dict, List, Optional, Union\n \n from huggingface_hub import create_repo, get_collection, hf_hub_download, metadata_update, upload_folder\n@@ -45,7 +46,7 @@\n     is_vision_available,\n     logging,\n )\n-from .agent_types import handle_agent_inputs, handle_agent_outputs\n+from .agent_types import ImageType, handle_agent_inputs, handle_agent_outputs\n \n \n logger = logging.get_logger(__name__)\n@@ -418,7 +419,9 @@ def push_to_hub(\n             )\n \n     @staticmethod\n-    def from_space(space_id, name, description):\n+    def from_space(\n+        space_id: str, name: str, description: str, api_name: Optional[str] = None, token: Optional[str] = None\n+    ):\n         \"\"\"\n         Creates a [`Tool`] from a Space given its id on the Hub.\n \n@@ -429,45 +432,107 @@ def from_space(space_id, name, description):\n                 The name of the tool.\n             description (`str`):\n                 The description of the tool.\n-\n+            api_name (`str`, *optional*):\n+                The specific api_name to use, if the space has several tabs. If not precised, will default to the first available api.\n+            token (`str`, *optional*):\n+                Add your token to access private spaces or increase your GPU quotas.\n         Returns:\n             [`Tool`]:\n-                The created tool.\n+                The Space, as a tool.\n \n-        Example:\n+        Examples:\n         ```\n-        tool = Tool.from_space(\"black-forest-labs/FLUX.1-schnell\", \"image-generator\", \"Generate an image from a prompt\")\n+        image_generator = Tool.from_space(\n+            space_id=\"black-forest-labs/FLUX.1-schnell\",\n+            name=\"image-generator\",\n+            description=\"Generate an image from a prompt\"\n+        )\n+        image = image_generator(\"Generate an image of a cool surfer in Tahiti\")\n+        ```\n+        ```\n+        face_swapper = Tool.from_space(\n+            \"tuan2308/face-swap\",\n+            \"face_swapper\",\n+            \"Tool that puts the face shown on the first image on the second image. You can give it paths to images.\",\n+        )\n+        image = face_swapper('./aymeric.jpeg', './ruth.jpg')\n         ```\n         \"\"\"\n-        from gradio_client import Client\n+        from gradio_client import Client, handle_file\n+        from gradio_client.utils import is_http_url_like\n \n         class SpaceToolWrapper(Tool):\n-            def __init__(self, space_id, name, description):\n-                self.client = Client(space_id)\n+            def __init__(\n+                self,\n+                space_id: str,\n+                name: str,\n+                description: str,\n+                api_name: Optional[str] = None,\n+                token: Optional[str] = None,\n+            ):\n+                self.client = Client(space_id, hf_token=token)\n                 self.name = name\n                 self.description = description\n-                space_description = self.client.view_api(return_format=\"dict\")[\"named_endpoints\"]\n-                route = list(space_description.keys())[0]\n-                space_description_route = space_description[route]\n+                space_description = self.client.view_api(return_format=\"dict\", print_info=False)[\"named_endpoints\"]\n+\n+                # If api_name is not defined, take the first of the available APIs for this space\n+                if api_name is None:\n+                    api_name = list(space_description.keys())[0]\n+                    logger.warning(\n+                        f\"Since `api_name` was not defined, it was automatically set to the first avilable API: `{api_name}`.\"\n+                    )\n+                self.api_name = api_name\n+\n+                try:\n+                    space_description_api = space_description[api_name]\n+                except KeyError:\n+                    raise KeyError(f\"Could not find specified {api_name=} among available api names.\")\n+\n                 self.inputs = {}\n-                for parameter in space_description_route[\"parameters\"]:\n+                for parameter in space_description_api[\"parameters\"]:\n                     if not parameter[\"parameter_has_default\"]:\n+                        parameter_type = parameter[\"type\"][\"type\"]\n+                        if parameter_type == \"object\":\n+                            parameter_type = \"any\"\n                         self.inputs[parameter[\"parameter_name\"]] = {\n-                            \"type\": parameter[\"type\"][\"type\"],\n+                            \"type\": parameter_type,\n                             \"description\": parameter[\"python_type\"][\"description\"],\n                         }\n-                output_component = space_description_route[\"returns\"][0][\"component\"]\n+                output_component = space_description_api[\"returns\"][0][\"component\"]\n                 if output_component == \"Image\":\n                     self.output_type = \"image\"\n                 elif output_component == \"Audio\":\n                     self.output_type = \"audio\"\n                 else:\n                     self.output_type = \"any\"\n \n-            def forward(self, *args, **kwargs):\n-                return self.client.predict(*args, **kwargs)[0]  # Usually the first output is the result\n+            def sanitize_argument_for_prediction(self, arg):\n+                if isinstance(arg, ImageType):\n+                    temp_file = tempfile.NamedTemporaryFile(suffix=\".png\", delete=False)\n+                    arg.save(temp_file.name)\n+                    arg = temp_file.name\n+                if (isinstance(arg, (str, Path)) and Path(arg).exists() and Path(arg).is_file()) or is_http_url_like(\n+                    arg\n+                ):\n+                    arg = handle_file(arg)\n+                return arg\n \n-        return SpaceToolWrapper(space_id, name, description)\n+            def forward(self, *args, **kwargs):\n+                # Preprocess args and kwargs:\n+                args = list(args)\n+                for i, arg in enumerate(args):\n+                    args[i] = self.sanitize_argument_for_prediction(arg)\n+                for arg_name, arg in kwargs.items():\n+                    kwargs[arg_name] = self.sanitize_argument_for_prediction(arg)\n+\n+                output = self.client.predict(*args, api_name=self.api_name, **kwargs)\n+                if isinstance(output, tuple) or isinstance(output, list):\n+                    return output[\n+                        0\n+                    ]  # Sometime the space also returns the generation seed, in which case the result is at index 0\n+                return output\n+\n+        return SpaceToolWrapper(space_id, name, description, api_name=api_name, token=token)\n \n     @staticmethod\n     def from_gradio(gradio_tool):"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 83,
        "deletions": 18
    }
}