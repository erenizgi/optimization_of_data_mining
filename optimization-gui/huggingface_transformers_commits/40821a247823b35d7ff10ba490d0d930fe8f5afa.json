{
    "author": "ydshieh",
    "message": "Fix CI slack reporting issue (#34833)\n\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "40821a247823b35d7ff10ba490d0d930fe8f5afa",
    "files": [
        {
            "sha": "49c2aefa09260e5ce39d5a2472af0760233bda3c",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/huggingface/transformers/blob/40821a247823b35d7ff10ba490d0d930fe8f5afa/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/40821a247823b35d7ff10ba490d0d930fe8f5afa/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=40821a247823b35d7ff10ba490d0d930fe8f5afa",
            "patch": "@@ -2385,6 +2385,10 @@ def wrapper(*args, **kwargs):\n \n                 env = copy.deepcopy(os.environ)\n                 env[\"_INSIDE_SUB_PROCESS\"] = \"1\"\n+                # This prevents the entries in `short test summary info` given by the subprocess being truncated. so the\n+                # full information can be passed to the parent pytest process.\n+                # See: https://docs.pytest.org/en/stable/explanation/ci.html\n+                env[\"CI\"] = \"true\"\n \n                 # If not subclass of `unitTest.TestCase` and `pytestconfig` is used: try to grab and use the arguments\n                 if \"pytestconfig\" in kwargs:\n@@ -2402,6 +2406,22 @@ def wrapper(*args, **kwargs):\n                 subprocess.run(command, env=env, check=True, capture_output=True)\n             except subprocess.CalledProcessError as e:\n                 exception_message = e.stdout.decode()\n+                lines = exception_message.split(\"\\n\")\n+                # Add a first line with more informative information instead of just `= test session starts =`.\n+                # This makes the `short test summary info` section more useful.\n+                if \"= test session starts =\" in lines[0]:\n+                    text = \"\"\n+                    for line in lines[1:]:\n+                        if line.startswith(\"FAILED \"):\n+                            text = line[len(\"FAILED \") :]\n+                            text = \"\".join(text.split(\" - \")[1:])\n+                        elif line.startswith(\"=\") and line.endswith(\"=\") and \" failed in \" in line:\n+                            break\n+                        elif len(text) > 0:\n+                            text += f\"\\n{line}\"\n+                    text = \"(subprocess) \" + text\n+                    lines = [text] + lines\n+                exception_message = \"\\n\".join(lines)\n                 raise pytest.fail(exception_message, pytrace=False)\n \n     return wrapper"
        },
        {
            "sha": "6c9eab3a85387b4c6a9e4ead3286401b4d7473a7",
            "filename": "utils/notification_service.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/40821a247823b35d7ff10ba490d0d930fe8f5afa/utils%2Fnotification_service.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/40821a247823b35d7ff10ba490d0d930fe8f5afa/utils%2Fnotification_service.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fnotification_service.py?ref=40821a247823b35d7ff10ba490d0d930fe8f5afa",
            "patch": "@@ -1076,6 +1076,11 @@ def prepare_reports(title, header, reports, to_truncate=True):\n \n                 for line in artifact[\"summary_short\"].split(\"\\n\"):\n                     if line.startswith(\"FAILED \"):\n+                        # Avoid the extra `FAILED` entry given by `run_test_using_subprocess` causing issue when calling\n+                        # `stacktraces.pop` below.\n+                        # See `run_test_using_subprocess` in `src/transformers/testing_utils.py`\n+                        if \" - Failed: (subprocess)\" in line:\n+                            continue\n                         line = line[len(\"FAILED \") :]\n                         line = line.split()[0].replace(\"\\n\", \"\")\n \n@@ -1186,6 +1191,11 @@ def prepare_reports(title, header, reports, to_truncate=True):\n             if failed:\n                 for line in artifact[\"summary_short\"].split(\"\\n\"):\n                     if line.startswith(\"FAILED \"):\n+                        # Avoid the extra `FAILED` entry given by `run_test_using_subprocess` causing issue when calling\n+                        # `stacktraces.pop` below.\n+                        # See `run_test_using_subprocess` in `src/transformers/testing_utils.py`\n+                        if \" - Failed: (subprocess)\" in line:\n+                            continue\n                         line = line[len(\"FAILED \") :]\n                         line = line.split()[0].replace(\"\\n\", \"\")\n "
        }
    ],
    "stats": {
        "total": 30,
        "additions": 30,
        "deletions": 0
    }
}