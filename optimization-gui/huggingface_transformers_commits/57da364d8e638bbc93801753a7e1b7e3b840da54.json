{
    "author": "yao-matrix",
    "message": "fix and enhance pipeline_webserver.md (#36992)\n\n* fix and enhance pipeline_webserver.md\n\nSigned-off-by: Yao, Matrix <matrix.yao@intel.com>\n\n* Update docs/source/en/pipeline_webserver.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/pipeline_webserver.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* use pipe\n\nSigned-off-by: YAO Matrix <matrix.yao@intel.com>\n\n---------\n\nSigned-off-by: Yao, Matrix <matrix.yao@intel.com>\nSigned-off-by: YAO Matrix <matrix.yao@intel.com>\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>",
    "sha": "57da364d8e638bbc93801753a7e1b7e3b840da54",
    "files": [
        {
            "sha": "0112d116c47da49ca6824c6046b5845425d48d5d",
            "filename": "docs/source/en/pipeline_webserver.md",
            "status": "modified",
            "additions": 25,
            "deletions": 17,
            "changes": 42,
            "blob_url": "https://github.com/huggingface/transformers/blob/57da364d8e638bbc93801753a7e1b7e3b840da54/docs%2Fsource%2Fen%2Fpipeline_webserver.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/57da364d8e638bbc93801753a7e1b7e3b840da54/docs%2Fsource%2Fen%2Fpipeline_webserver.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fpipeline_webserver.md?ref=57da364d8e638bbc93801753a7e1b7e3b840da54",
            "patch": "@@ -52,10 +52,10 @@ async def homepage(request):\n     return JSONResponse(output)\n \n async def server_loop(q):\n-    pipeline = pipeline(task=\"fill-mask\",model=\"google-bert/bert-base-uncased\")\n+    pipe = pipeline(task=\"fill-mask\",model=\"google-bert/bert-base-uncased\")\n     while True:\n         (string, response_q) = await q.get()\n-        out = pipeline(string)\n+        out = pipe(string)\n         await response_q.put(out)\n \n app = Starlette(\n@@ -81,6 +81,10 @@ Query the server with a POST request.\n \n ```bash\n curl -X POST -d \"Paris is the [MASK] of France.\" http://localhost:8000/\n+```\n+This should return the output below.\n+\n+```bash\n [{'score': 0.9969332218170166,\n   'token': 3007,\n   'token_str': 'capital',\n@@ -112,23 +116,27 @@ The example below is written in pseudocode for readability rather than performan\n 1. There is no batch size limit.\n 2. The timeout is reset on every queue fetch, so you could end up waiting much longer than the `timeout` value before processing a request. This would also delay the first inference request by that amount of time. The web server always waits 1ms even if the queue is empty, which is inefficient, because that time can be used to start inference. It could make sense though if batching is essential to your use case.\n \n-    It would be better to have a single 1ms deadline, instead of resetting it on every fetch.\n+    It would be better to have a single 1ms deadline, instead of resetting it on every fetch, as shown below.\n \n ```py\n-(string, rq) = await q.get()\n-strings = []\n-queues = []\n-while True:\n-    try:\n-        (string, rq) = await asyncio.wait_for(q.get(), timeout=0.001)\n-    except asyncio.exceptions.TimeoutError:\n-        break\n-    strings.append(string)\n-    queues.append(rq)\n-strings\n-outs = pipeline(strings, batch_size=len(strings))\n-for rq, out in zip(queues, outs):\n-    await rq.put(out)\n+async def server_loop(q):\n+    pipe = pipeline(task=\"fill-mask\", model=\"google-bert/bert-base-uncased\")\n+    while True:\n+        (string, rq) = await q.get()\n+        strings = []\n+        queues = []\n+        strings.append(string)\n+        queues.append(rq)\n+        while True:\n+            try:\n+                (string, rq) = await asyncio.wait_for(q.get(), timeout=1)\n+            except asyncio.exceptions.TimeoutError:\n+                break\n+            strings.append(string)\n+            queues.append(rq)\n+        outs = pipe(strings, batch_size=len(strings))\n+        for rq, out in zip(queues, outs):\n+            await rq.put(out)\n ```\n \n ## Error checking"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 25,
        "deletions": 17
    }
}