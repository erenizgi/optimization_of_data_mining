{
    "author": "merveenoyan",
    "message": "VDR task guide (#37485)\n\n* VDR task guide\n\n* Add to toctree\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/tasks/visual_document_retrieval.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n---------\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>",
    "sha": "c08997c52e5903a8e0a6a22c1b831545f08ef680",
    "files": [
        {
            "sha": "91522f0fc3063f3ab57007023a78adef9e97c933",
            "filename": "docs/source/en/_toctree.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/huggingface/transformers/blob/c08997c52e5903a8e0a6a22c1b831545f08ef680/docs%2Fsource%2Fen%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/c08997c52e5903a8e0a6a22c1b831545f08ef680/docs%2Fsource%2Fen%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2F_toctree.yml?ref=c08997c52e5903a8e0a6a22c1b831545f08ef680",
            "patch": "@@ -281,6 +281,8 @@\n         title: Image-text-to-text\n       - local: tasks/video_text_to_text\n         title: Video-text-to-text\n+      - local: tasks/visual_document_retrieval\n+        title: Visual Document Retrieval\n       title: Multimodal\n     title: Task recipes\n   - local: run_scripts"
        },
        {
            "sha": "4343ab59b36243efc7e6c97d55a0011caa77d64f",
            "filename": "docs/source/en/tasks/visual_document_retrieval.md",
            "status": "added",
            "additions": 144,
            "deletions": 0,
            "changes": 144,
            "blob_url": "https://github.com/huggingface/transformers/blob/c08997c52e5903a8e0a6a22c1b831545f08ef680/docs%2Fsource%2Fen%2Ftasks%2Fvisual_document_retrieval.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/c08997c52e5903a8e0a6a22c1b831545f08ef680/docs%2Fsource%2Fen%2Ftasks%2Fvisual_document_retrieval.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Ftasks%2Fvisual_document_retrieval.md?ref=c08997c52e5903a8e0a6a22c1b831545f08ef680",
            "patch": "@@ -0,0 +1,144 @@\n+<!--Copyright 2025 The HuggingFace Team. All rights reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+the License. You may obtain a copy of the License at\n+\n+http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+specific language governing permissions and limitations under the License.\n+\n+⚠️ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be\n+rendered properly in your Markdown viewer.\n+\n+-->\n+# Visual document retrieval\n+\n+Documents can contain multimodal data if they include charts, tables, and visuals in addition to text. Retrieving information from these documents is challenging because text retrieval models alone can't handle visual data and image retrieval models lack the granularity and document processing capabilities.\n+\n+Visual document retrieval can help retrieve information from all types of documents, including multimodal retrieval augmented generation (RAG). These models accept documents (as images) and texts and calculates the similarity scores between them.\n+\n+This guide demonstrates how to index and retrieve documents with [ColPali](../model_doc/colpali).  \n+\n+> [!TIP]\n+> For large scale use cases, you may want to index and retrieve documents with a vector database.\n+\n+Make sure Transformers and Datasets is installed.\n+\n+```bash\n+pip install -q datasets transformers\n+```\n+\n+We will index a dataset of documents related to UFO sightings. We filter the examples where our column of interest is missing. It contains several columns, we are interested in the column `specific_detail_query` where it contains short summary of the document, and `image` column that contains our documents.\n+\n+```python\n+from datasets import load_dataset\n+\n+dataset = load_dataset(\"davanstrien/ufo-ColPali\")\n+dataset = dataset[\"train\"]\n+dataset = dataset.filter(lambda example: example[\"specific_detail_query\"] is not None)\n+dataset\n+```\n+```\n+Dataset({\n+    features: ['image', 'raw_queries', 'broad_topical_query', 'broad_topical_explanation', 'specific_detail_query', 'specific_detail_explanation', 'visual_element_query', 'visual_element_explanation', 'parsed_into_json'],\n+    num_rows: 2172\n+})\n+```\n+\n+Let's load the model and the tokenizer.\n+\n+```python\n+import torch\n+from transformers import ColPaliForRetrieval, ColPaliProcessor\n+\n+model_name = \"vidore/colpali-v1.2-hf\"\n+\n+processor = ColPaliProcessor.from_pretrained(model_name)\n+\n+model = ColPaliForRetrieval.from_pretrained(\n+    model_name,\n+    torch_dtype=torch.bfloat16,\n+    device_map=\"cuda\",\n+).eval()\n+```\n+\n+Pass the text query to the processor and return the indexed text embeddings from the model. For image-to-text search, replace the `text` parameter in [`ColPaliProcessor`] with the `images` parameter to pass images.\n+\n+```python\n+inputs = processor(text=\"a document about Mars expedition\").to(\"cuda\")\n+with torch.no_grad():\n+  text_embeds = model(**inputs, return_tensors=\"pt\").embeddings\n+```\n+\n+Index the images offline, and during inference, return the query text embeddings to get its closest image embeddings.\n+\n+Store the image and image embeddings by writing them to the dataset with [`~datasets.Dataset.map`] as shown below. Add an `embeddings` column that contains the indexed embeddings. ColPali embeddings take up a lot of storage, so remove them from the GPU and store them in the CPU as NumPy vectors.\n+\n+```python\n+ds_with_embeddings = dataset.map(lambda example: {'embeddings': model(**processor(images=example[\"image\"]).to(\"cuda\"), return_tensors=\"pt\").embeddings.to(torch.float32).detach().cpu().numpy()})\n+```\n+\n+For online inference, create a function to search the image embeddings in batches and retrieve the k-most relevant images. The function below returns the indices in the dataset and their scores for a given indexed dataset, text embeddings, number of top results, and the batch size.\n+\n+```python\n+def find_top_k_indices_batched(dataset, text_embedding, processor, k=10, batch_size=4):\n+    scores_and_indices = []\n+\n+    for start_idx in range(0, len(dataset), batch_size):\n+\n+        end_idx = min(start_idx + batch_size, len(dataset))\n+        batch = dataset[start_idx:end_idx]        \n+        batch_embeddings = [torch.tensor(emb[0], dtype=torch.float32) for emb in batch[\"embeddings\"]]\n+        scores = processor.score_retrieval(text_embedding.to(\"cpu\").to(torch.float32), batch_embeddings)\n+\n+        if hasattr(scores, \"tolist\"):\n+            scores = scores.tolist()[0]\n+\n+        for i, score in enumerate(scores):\n+            scores_and_indices.append((score, start_idx + i))\n+\n+    sorted_results = sorted(scores_and_indices, key=lambda x: -x[0])\n+\n+    topk = sorted_results[:k]\n+    indices = [idx for _, idx in topk]\n+    scores = [score for score, _ in topk]\n+\n+    return indices, scores\n+```\n+\n+Generate the text embeddings and pass them to the function above to return the dataset indices and scores.\n+\n+```python\n+with torch.no_grad():\n+  text_embeds = model(**processor(text=\"a document about Mars expedition\").to(\"cuda\"), return_tensors=\"pt\").embeddings\n+indices, scores = find_top_k_indices_batched(ds_with_embeddings, text_embeds, processor, k=3, batch_size=4)\n+print(indices, scores)\n+```\n+\n+```\n+([440, 442, 443],\n+ [14.370786666870117,\n+  13.675487518310547,\n+  12.9899320602417])\n+```\n+\n+Display the images to view the Mars related documents.\n+\n+```python\n+for i in indices:\n+  display(dataset[i][\"image\"])\n+```\n+\n+<div style=\"display: flex; align-items: center;\">\n+    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/doc_1.png\" \n+         alt=\"Document 1\" \n+         style=\"height: 200px; object-fit: contain; margin-right: 10px;\">\n+    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/doc_2.png\" \n+         alt=\"Document 2\" \n+         style=\"height: 200px; object-fit: contain;\">\n+    <img src=\"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/doc_3.png\" \n+         alt=\"Document 3\" \n+         style=\"height: 200px; object-fit: contain;\">\n+</div>\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 146,
        "deletions": 0
    }
}