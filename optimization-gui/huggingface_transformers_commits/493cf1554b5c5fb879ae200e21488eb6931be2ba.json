{
    "author": "remi-or",
    "message": "[seamless_m4t] Skip some tests when speech is not available (#38430)\n\n* Added the require_speech decorator\n\n* Added require_speecj to some seamless_m4t tests\n\n* Changed skip message",
    "sha": "493cf1554b5c5fb879ae200e21488eb6931be2ba",
    "files": [
        {
            "sha": "c3aeeb02e2b313a24156f84b6a312501fabd3c1f",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/huggingface/transformers/blob/493cf1554b5c5fb879ae200e21488eb6931be2ba/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/493cf1554b5c5fb879ae200e21488eb6931be2ba/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=493cf1554b5c5fb879ae200e21488eb6931be2ba",
            "patch": "@@ -130,6 +130,7 @@\n     is_seqio_available,\n     is_soundfile_available,\n     is_spacy_available,\n+    is_speech_available,\n     is_spqr_available,\n     is_sudachi_available,\n     is_sudachi_projection_available,\n@@ -1476,6 +1477,13 @@ def require_tiktoken(test_case):\n     return unittest.skipUnless(is_tiktoken_available(), \"test requires TikToken\")(test_case)\n \n \n+def require_speech(test_case):\n+    \"\"\"\n+    Decorator marking a test that requires speech. These tests are skipped when speech isn't available.\n+    \"\"\"\n+    return unittest.skipUnless(is_speech_available(), \"test requires torchaudio\")(test_case)\n+\n+\n def get_gpu_count():\n     \"\"\"\n     Return the number of available gpus (regardless of whether torch, tf or jax is used)"
        },
        {
            "sha": "50523723937674f56aa92c5d2ded63f39fe495fc",
            "filename": "tests/models/seamless_m4t/test_modeling_seamless_m4t.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/493cf1554b5c5fb879ae200e21488eb6931be2ba/tests%2Fmodels%2Fseamless_m4t%2Ftest_modeling_seamless_m4t.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/493cf1554b5c5fb879ae200e21488eb6931be2ba/tests%2Fmodels%2Fseamless_m4t%2Ftest_modeling_seamless_m4t.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fseamless_m4t%2Ftest_modeling_seamless_m4t.py?ref=493cf1554b5c5fb879ae200e21488eb6931be2ba",
            "patch": "@@ -18,7 +18,7 @@\n import unittest\n \n from transformers import SeamlessM4TConfig, is_speech_available, is_torch_available\n-from transformers.testing_utils import require_torch, slow, torch_device\n+from transformers.testing_utils import require_speech, require_torch, slow, torch_device\n from transformers.trainer_utils import set_seed\n from transformers.utils import cached_property\n \n@@ -1028,6 +1028,7 @@ def test_to_swh_text(self):\n \n         self.assertListAlmostEqual(expected_wav_slice, output.waveform.squeeze().tolist()[50:60])\n \n+    @require_speech\n     @slow\n     def test_to_rus_speech(self):\n         model = SeamlessM4TModel.from_pretrained(self.repo_id).to(torch_device)\n@@ -1066,6 +1067,7 @@ def test_text_to_text_model(self):\n         }\n         self.factory_test_task(SeamlessM4TModel, SeamlessM4TForTextToText, self.input_text, kwargs1, kwargs2)\n \n+    @require_speech\n     @slow\n     def test_speech_to_text_model(self):\n         kwargs1 = {\"tgt_lang\": \"eng\", \"return_intermediate_token_ids\": True, \"generate_speech\": False}\n@@ -1077,6 +1079,7 @@ def test_speech_to_text_model(self):\n         }\n         self.factory_test_task(SeamlessM4TModel, SeamlessM4TForSpeechToText, self.input_audio, kwargs1, kwargs2)\n \n+    @require_speech\n     @slow\n     def test_speech_to_speech_model(self):\n         kwargs1 = {\"tgt_lang\": \"eng\", \"return_intermediate_token_ids\": True}"
        },
        {
            "sha": "eab2b0bd282fb72c43f9a31b2a64ff760bd5ee4b",
            "filename": "tests/models/seamless_m4t_v2/test_modeling_seamless_m4t_v2.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/493cf1554b5c5fb879ae200e21488eb6931be2ba/tests%2Fmodels%2Fseamless_m4t_v2%2Ftest_modeling_seamless_m4t_v2.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/493cf1554b5c5fb879ae200e21488eb6931be2ba/tests%2Fmodels%2Fseamless_m4t_v2%2Ftest_modeling_seamless_m4t_v2.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fmodels%2Fseamless_m4t_v2%2Ftest_modeling_seamless_m4t_v2.py?ref=493cf1554b5c5fb879ae200e21488eb6931be2ba",
            "patch": "@@ -18,7 +18,7 @@\n import unittest\n \n from transformers import SeamlessM4Tv2Config, is_speech_available, is_torch_available\n-from transformers.testing_utils import require_torch, slow, torch_device\n+from transformers.testing_utils import require_speech, require_torch, slow, torch_device\n from transformers.trainer_utils import set_seed\n from transformers.utils import cached_property\n \n@@ -1095,6 +1095,7 @@ def test_to_swh_text(self):\n             [-2.001826e-04, 8.580012e-02], [output.waveform.mean().item(), output.waveform.std().item()]\n         )\n \n+    @require_speech\n     @slow\n     def test_to_rus_speech(self):\n         model = SeamlessM4Tv2Model.from_pretrained(self.repo_id).to(torch_device)\n@@ -1139,6 +1140,7 @@ def test_text_to_text_model(self):\n         }\n         self.factory_test_task(SeamlessM4Tv2Model, SeamlessM4Tv2ForTextToText, self.input_text, kwargs1, kwargs2)\n \n+    @require_speech\n     @slow\n     def test_speech_to_text_model(self):\n         kwargs1 = {\"tgt_lang\": \"eng\", \"return_intermediate_token_ids\": True, \"generate_speech\": False}\n@@ -1150,6 +1152,7 @@ def test_speech_to_text_model(self):\n         }\n         self.factory_test_task(SeamlessM4Tv2Model, SeamlessM4Tv2ForSpeechToText, self.input_audio, kwargs1, kwargs2)\n \n+    @require_speech\n     @slow\n     def test_speech_to_speech_model(self):\n         kwargs1 = {\"tgt_lang\": \"eng\", \"return_intermediate_token_ids\": True}"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 16,
        "deletions": 2
    }
}