{
    "author": "JihadHammoud02",
    "message": "Update longformer.md (#37622)\n\n* Update longformer.md\n\n* Update longformer.md\n\n* Update docs/source/en/model_doc/longformer.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update docs/source/en/model_doc/longformer.md\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n* Update longformer.md\n\n---------\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>",
    "sha": "b2db54f66b5a618a070767646d1d4750184a417a",
    "files": [
        {
            "sha": "17360c8958684855a9cd7a6f9ec8d4ab7494bd2b",
            "filename": "docs/source/en/model_doc/longformer.md",
            "status": "modified",
            "additions": 80,
            "deletions": 88,
            "changes": 168,
            "blob_url": "https://github.com/huggingface/transformers/blob/b2db54f66b5a618a070767646d1d4750184a417a/docs%2Fsource%2Fen%2Fmodel_doc%2Flongformer.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/b2db54f66b5a618a070767646d1d4750184a417a/docs%2Fsource%2Fen%2Fmodel_doc%2Flongformer.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fmodel_doc%2Flongformer.md?ref=b2db54f66b5a618a070767646d1d4750184a417a",
            "patch": "@@ -1,5 +1,4 @@\n-<!--Copyright 2020 The HuggingFace Team. All rights reserved.\n-\n+<!--Copyright 2024 The HuggingFace Team. All rights reserved.\n Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n the License. You may obtain a copy of the License at\n \n@@ -9,93 +8,95 @@ Unless required by applicable law or agreed to in writing, software distributed\n an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n specific language governing permissions and limitations under the License.\n \n-⚠️ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be\n+⚠️ Note that this file is in Markdown but contains specific syntax for our doc-builder (similar to MDX) that may not be\n rendered properly in your Markdown viewer.\n-\n -->\n \n-# Longformer\n-\n-<div class=\"flex flex-wrap space-x-1\">\n-<img alt=\"PyTorch\" src=\"https://img.shields.io/badge/PyTorch-DE3412?style=flat&logo=pytorch&logoColor=white\">\n-<img alt=\"TensorFlow\" src=\"https://img.shields.io/badge/TensorFlow-FF6F00?style=flat&logo=tensorflow&logoColor=white\">\n+<div style=\"float: right;\">\n+    <div class=\"flex flex-wrap space-x-1\">\n+        <img alt=\"PyTorch\" src=\"https://img.shields.io/badge/PyTorch-DE3412?style=flat&logo=pytorch&logoColor=white\">\n+        <img alt=\"TensorFlow\" src=\"https://img.shields.io/badge/TensorFlow-FF6F00?style=flat&logo=tensorflow&logoColor=white\">\n+    </div>\n </div>\n \n-## Overview\n-\n-The Longformer model was presented in [Longformer: The Long-Document Transformer](https://arxiv.org/pdf/2004.05150.pdf) by Iz Beltagy, Matthew E. Peters, Arman Cohan.\n-\n-The abstract from the paper is the following:\n-\n-*Transformer-based models are unable to process long sequences due to their self-attention operation, which scales\n-quadratically with the sequence length. To address this limitation, we introduce the Longformer with an attention\n-mechanism that scales linearly with sequence length, making it easy to process documents of thousands of tokens or\n-longer. Longformer's attention mechanism is a drop-in replacement for the standard self-attention and combines a local\n-windowed attention with a task motivated global attention. Following prior work on long-sequence transformers, we\n-evaluate Longformer on character-level language modeling and achieve state-of-the-art results on text8 and enwik8. In\n-contrast to most prior work, we also pretrain Longformer and finetune it on a variety of downstream tasks. Our\n-pretrained Longformer consistently outperforms RoBERTa on long document tasks and sets new state-of-the-art results on\n-WikiHop and TriviaQA.*\n-\n-This model was contributed by [beltagy](https://huggingface.co/beltagy). The Authors' code can be found [here](https://github.com/allenai/longformer).\n-\n-## Usage tips\n-\n-- Since the Longformer is based on RoBERTa, it doesn't have `token_type_ids`. You don't need to indicate which\n-  token belongs to which segment. Just separate your segments with the separation token `tokenizer.sep_token` (or\n-  `</s>`).\n-- A transformer model replacing the attention matrices by sparse matrices to go faster. Often, the local context (e.g., what are the two tokens left and right?) is enough to take action for a given token. Some preselected input tokens are still given global attention, but the attention matrix has way less parameters, resulting in a speed-up. See the local attention section for more information.\n+# Longformer\n \n-## Longformer Self Attention\n+[Longformer](https://huggingface.co/papers/2004.05150) is a transformer model designed for processing long documents. The self-attention operation usually scales quadratically with sequence length, preventing transformers from processing longer sequences. The Longformer attention mechanism overcomes this by scaling linearly with sequence length. It combines local windowed attention with task-specific global attention, enabling efficient processing of documents with thousands of tokens.\n \n-Longformer self attention employs self attention on both a \"local\" context and a \"global\" context. Most tokens only\n-attend \"locally\" to each other meaning that each token attends to its \\\\(\\frac{1}{2} w\\\\) previous tokens and\n-\\\\(\\frac{1}{2} w\\\\) succeeding tokens with \\\\(w\\\\) being the window length as defined in\n-`config.attention_window`. Note that `config.attention_window` can be of type `List` to define a\n-different \\\\(w\\\\) for each layer. A selected few tokens attend \"globally\" to all other tokens, as it is\n-conventionally done for all tokens in `BertSelfAttention`.\n+You can find all the original Longformer checkpoints under the [Ai2](https://huggingface.co/allenai?search_models=longformer) organization.\n \n-Note that \"locally\" and \"globally\" attending tokens are projected by different query, key and value matrices. Also note\n-that every \"locally\" attending token not only attends to tokens within its window \\\\(w\\\\), but also to all \"globally\"\n-attending tokens so that global attention is *symmetric*.\n+> [!TIP]\n+> Click on the Longformer models in the right sidebar for more examples of how to apply Longformer to different language tasks.\n \n-The user can define which tokens attend \"locally\" and which tokens attend \"globally\" by setting the tensor\n-`global_attention_mask` at run-time appropriately. All Longformer models employ the following logic for\n-`global_attention_mask`:\n+The example below demonstrates how to fill the `<mask>` token with [`Pipeline`], [`AutoModel`] and from the command line.\n \n-- 0: the token attends \"locally\",\n-- 1: the token attends \"globally\".\n+<hfoptions id=\"usage\">\n+<hfoption id=\"Pipeline\">\n \n-For more information please also refer to [`~LongformerModel.forward`] method.\n+```python\n+import torch\n+from transformers import pipeline\n+\n+pipeline = pipeline(\n+    task=\"fill-mask\",\n+    model=\"allenai/longformer-base-4096\",\n+    torch_dtype=torch.float16,\n+    device=0\n+)\n+pipeline(\"\"\"San Francisco 49ers cornerback Shawntae Spencer will miss the rest of the <mask> with a torn ligament in his left knee.\n+Spencer, a fifth-year pro, will be placed on injured reserve soon after undergoing surgery Wednesday to repair the ligament. He injured his knee late in the 49ers’ road victory at Seattle on Sept. 14, and missed last week’s victory over Detroit.\n+Tarell Brown and Donald Strickland will compete to replace Spencer with the 49ers, who kept 12 defensive backs on their 53-man roster to start the season. Brown, a second-year pro, got his first career interception last weekend while filling in for Strickland, who also sat out with a knee injury.\"\"\")\n+```\n \n-Using Longformer self attention, the memory and time complexity of the query-key matmul operation, which usually\n-represents the memory and time bottleneck, can be reduced from \\\\(\\mathcal{O}(n_s \\times n_s)\\\\) to\n-\\\\(\\mathcal{O}(n_s \\times w)\\\\), with \\\\(n_s\\\\) being the sequence length and \\\\(w\\\\) being the average window\n-size. It is assumed that the number of \"globally\" attending tokens is insignificant as compared to the number of\n-\"locally\" attending tokens.\n+</hfoption>\n+<hfoption id=\"AutoModel\">\n \n-For more information, please refer to the official [paper](https://arxiv.org/pdf/2004.05150.pdf).\n+```python\n+import torch\n+from transformers import AutoModelForMaskedLM, AutoTokenizer\n+\n+tokenizer = AutoTokenizer.from_pretrained(\"allenai/longformer-base-4096\")\n+model = AutoModelForMaskedLM.from_pretrained(\"allenai/longformer-base-4096\")\n+\n+text = (\n+\"\"\"\n+San Francisco 49ers cornerback Shawntae Spencer will miss the rest of the <mask> with a torn ligament in his left knee.\n+Spencer, a fifth-year pro, will be placed on injured reserve soon after undergoing surgery Wednesday to repair the ligament. He injured his knee late in the 49ers’ road victory at Seattle on Sept. 14, and missed last week’s victory over Detroit.\n+Tarell Brown and Donald Strickland will compete to replace Spencer with the 49ers, who kept 12 defensive backs on their 53-man roster to start the season. Brown, a second-year pro, got his first career interception last weekend while filling in for Strickland, who also sat out with a knee injury.\n+\"\"\"\n+)\n+\n+input_ids = tokenizer([text], return_tensors=\"pt\")[\"input_ids\"]\n+logits = model(input_ids).logits\n+\n+masked_index = (input_ids[0] == tokenizer.mask_token_id).nonzero().item()\n+probs = logits[0, masked_index].softmax(dim=0)\n+values, predictions = probs.topk(5)\n+tokenizer.decode(predictions).split()\n+```\n \n+</hfoption>\n+<hfoption id=\"transformers-cli\">\n \n-## Training\n+```bash\n+echo -e \"San Francisco 49ers cornerback Shawntae Spencer will miss the rest of the <mask> with a torn ligament in his left knee.\" | transformers-cli run --task fill-mask --model allenai/longformer-base-4096 --device 0\n+```\n \n-[`LongformerForMaskedLM`] is trained the exact same way [`RobertaForMaskedLM`] is\n-trained and should be used as follows:\n+</hfoption>\n+</hfoptions\n \n-```python\n-input_ids = tokenizer.encode(\"This is a sentence from [MASK] training data\", return_tensors=\"pt\")\n-mlm_labels = tokenizer.encode(\"This is a sentence from the training data\", return_tensors=\"pt\")\n \n-loss = model(input_ids, labels=input_ids, masked_lm_labels=mlm_labels)[0]\n-```\n+## Notes\n \n-## Resources\n+- Longformer is based on [RoBERTa](https://huggingface.co/docs/transformers/en/model_doc/roberta) and doesn't have `token_type_ids`. You don't need to indicate which token belongs to which segment. You only need to separate the segments with the separation token `</s>` or `tokenizer.sep_token`.\n+- You can set which tokens can attend locally and which tokens attend globally with the `global_attention_mask` at inference (see this [example](https://huggingface.co/docs/transformers/en/model_doc/longformer#transformers.LongformerModel.forward.example) for more details). A value of `0` means a token attends locally and a value of `1` means a token attends globally.\n+- [`LongformerForMaskedLM`] is trained like [`RobertaForMaskedLM`] and should be used as shown below.\n \n-- [Text classification task guide](../tasks/sequence_classification)\n-- [Token classification task guide](../tasks/token_classification)\n-- [Question answering task guide](../tasks/question_answering)\n-- [Masked language modeling task guide](../tasks/masked_language_modeling)\n-- [Multiple choice task guide](../tasks/multiple_choice)\n+  ```py\n+    input_ids = tokenizer.encode(\"This is a sentence from [MASK] training data\", return_tensors=\"pt\")\n+    mlm_labels = tokenizer.encode(\"This is a sentence from the training data\", return_tensors=\"pt\")\n+    loss = model(input_ids, labels=input_ids, masked_lm_labels=mlm_labels)[0]\n+    ```\n \n ## LongformerConfig\n \n@@ -139,55 +140,49 @@ loss = model(input_ids, labels=input_ids, masked_lm_labels=mlm_labels)[0]\n \n [[autodoc]] models.longformer.modeling_tf_longformer.TFLongformerTokenClassifierOutput\n \n-<frameworkcontent>\n-<pt>\n-\n ## LongformerModel\n \n [[autodoc]] LongformerModel\n     - forward\n \n ## LongformerForMaskedLM\n \n-[[autodoc]] LongformerForMaskedLM\n+[[autodoc]] LongformerForMaskedLM \n     - forward\n \n ## LongformerForSequenceClassification\n \n-[[autodoc]] LongformerForSequenceClassification\n+[[autodoc]] LongformerForSequenceClassification \n     - forward\n \n ## LongformerForMultipleChoice\n \n-[[autodoc]] LongformerForMultipleChoice\n+[[autodoc]] LongformerForMultipleChoice \n     - forward\n \n ## LongformerForTokenClassification\n \n-[[autodoc]] LongformerForTokenClassification\n+[[autodoc]] LongformerForTokenClassification \n     - forward\n \n ## LongformerForQuestionAnswering\n \n-[[autodoc]] LongformerForQuestionAnswering\n+[[autodoc]] LongformerForQuestionAnswering \n     - forward\n \n-</pt>\n-<tf>\n-\n ## TFLongformerModel\n \n-[[autodoc]] TFLongformerModel\n+[[autodoc]] TFLongformerModel    \n     - call\n \n ## TFLongformerForMaskedLM\n \n-[[autodoc]] TFLongformerForMaskedLM\n+[[autodoc]] TFLongformerForMaskedLM \n     - call\n \n ## TFLongformerForQuestionAnswering\n \n-[[autodoc]] TFLongformerForQuestionAnswering\n+[[autodoc]] TFLongformerForQuestionAnswering \n     - call\n \n ## TFLongformerForSequenceClassification\n@@ -197,13 +192,10 @@ loss = model(input_ids, labels=input_ids, masked_lm_labels=mlm_labels)[0]\n \n ## TFLongformerForTokenClassification\n \n-[[autodoc]] TFLongformerForTokenClassification\n+[[autodoc]] TFLongformerForTokenClassification \n     - call\n \n ## TFLongformerForMultipleChoice\n \n-[[autodoc]] TFLongformerForMultipleChoice\n+[[autodoc]] TFLongformerForMultipleChoice \n     - call\n-\n-</tf>\n-</frameworkcontent>"
        }
    ],
    "stats": {
        "total": 168,
        "additions": 80,
        "deletions": 88
    }
}