{
    "author": "Rocketknight1",
    "message": "Make ASR pipeline compliant with Hub spec + add tests (#33769)\n\n* Remove max_new_tokens arg\r\n\r\n* Add ASR pipeline to testing\r\n\r\n* make fixup\r\n\r\n* Factor the output test out into a util\r\n\r\n* Full error reporting\r\n\r\n* Full error reporting\r\n\r\n* Update src/transformers/pipelines/automatic_speech_recognition.py\r\n\r\nCo-authored-by: Lysandre Debut <hi@lysand.re>\r\n\r\n* Small comment\r\n\r\n---------\r\n\r\nCo-authored-by: Lysandre Debut <hi@lysand.re>",
    "sha": "a43e84cb3b78fcac3d5d9374a8488f74f3f19245",
    "files": [
        {
            "sha": "f4ffdf6445381c78b795c983ee62a29894f5eaa9",
            "filename": "src/transformers/pipelines/automatic_speech_recognition.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/huggingface/transformers/blob/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/src%2Ftransformers%2Fpipelines%2Fautomatic_speech_recognition.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/src%2Ftransformers%2Fpipelines%2Fautomatic_speech_recognition.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fpipelines%2Fautomatic_speech_recognition.py?ref=a43e84cb3b78fcac3d5d9374a8488f74f3f19245",
            "patch": "@@ -11,6 +11,7 @@\n # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n # See the License for the specific language governing permissions and\n # limitations under the License.\n+import warnings\n from collections import defaultdict\n from typing import TYPE_CHECKING, Dict, Optional, Union\n \n@@ -269,8 +270,6 @@ def __call__(\n                 The dictionary of ad-hoc parametrization of `generate_config` to be used for the generation call. For a\n                 complete overview of generate, check the [following\n                 guide](https://huggingface.co/docs/transformers/en/main_classes/text_generation).\n-            max_new_tokens (`int`, *optional*):\n-                The maximum numbers of tokens to generate, ignoring the number of tokens in the prompt.\n \n         Return:\n             `Dict`: A dictionary with the following keys:\n@@ -310,6 +309,10 @@ def _sanitize_parameters(\n \n         forward_params = defaultdict(dict)\n         if max_new_tokens is not None:\n+            warnings.warn(\n+                \"`max_new_tokens` is deprecated and will be removed in version 4.49 of Transformers. To remove this warning, pass `max_new_tokens` as a key inside `generate_kwargs` instead.\",\n+                FutureWarning,\n+            )\n             forward_params[\"max_new_tokens\"] = max_new_tokens\n         if generate_kwargs is not None:\n             if max_new_tokens is not None and \"max_new_tokens\" in generate_kwargs:"
        },
        {
            "sha": "4986de42e0f2f3d7d0f9035c5bdd7e983c019f04",
            "filename": "src/transformers/testing_utils.py",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/huggingface/transformers/blob/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/src%2Ftransformers%2Ftesting_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/src%2Ftransformers%2Ftesting_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Ftesting_utils.py?ref=a43e84cb3b78fcac3d5d9374a8488f74f3f19245",
            "patch": "@@ -31,6 +31,7 @@\n import unittest\n from collections import defaultdict\n from collections.abc import Mapping\n+from dataclasses import MISSING, fields\n from functools import wraps\n from io import StringIO\n from pathlib import Path\n@@ -2610,3 +2611,30 @@ def update_mapping_from_spec(device_fn_dict: Dict[str, Callable], attribute_name\n         update_mapping_from_spec(BACKEND_MANUAL_SEED, \"MANUAL_SEED_FN\")\n         update_mapping_from_spec(BACKEND_EMPTY_CACHE, \"EMPTY_CACHE_FN\")\n         update_mapping_from_spec(BACKEND_DEVICE_COUNT, \"DEVICE_COUNT_FN\")\n+\n+\n+def compare_pipeline_output_to_hub_spec(output, hub_spec):\n+    missing_keys = []\n+    unexpected_keys = []\n+    all_field_names = {field.name for field in fields(hub_spec)}\n+    matching_keys = sorted([key for key in output.keys() if key in all_field_names])\n+\n+    # Fields with a MISSING default are required and must be in the output\n+    for field in fields(hub_spec):\n+        if field.default is MISSING and field.name not in output:\n+            missing_keys.append(field.name)\n+\n+    # All output keys must match either a required or optional field in the Hub spec\n+    for output_key in output:\n+        if output_key not in all_field_names:\n+            unexpected_keys.append(output_key)\n+\n+    if missing_keys or unexpected_keys:\n+        error = [\"Pipeline output does not match Hub spec!\"]\n+        if matching_keys:\n+            error.append(f\"Matching keys: {matching_keys}\")\n+        if missing_keys:\n+            error.append(f\"Missing required keys in pipeline output: {missing_keys}\")\n+        if unexpected_keys:\n+            error.append(f\"Keys in pipeline output that are not in Hub spec: {unexpected_keys}\")\n+        raise KeyError(\"\\n\".join(error))"
        },
        {
            "sha": "37990d0074315c15f2e669d2d78cc55ccd2b0e48",
            "filename": "tests/pipelines/test_pipelines_audio_classification.py",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/huggingface/transformers/blob/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/tests%2Fpipelines%2Ftest_pipelines_audio_classification.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/tests%2Fpipelines%2Ftest_pipelines_audio_classification.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fpipelines%2Ftest_pipelines_audio_classification.py?ref=a43e84cb3b78fcac3d5d9374a8488f74f3f19245",
            "patch": "@@ -13,14 +13,14 @@\n # limitations under the License.\n \n import unittest\n-from dataclasses import fields\n \n import numpy as np\n from huggingface_hub import AudioClassificationOutputElement\n \n from transformers import MODEL_FOR_AUDIO_CLASSIFICATION_MAPPING, TF_MODEL_FOR_AUDIO_CLASSIFICATION_MAPPING\n from transformers.pipelines import AudioClassificationPipeline, pipeline\n from transformers.testing_utils import (\n+    compare_pipeline_output_to_hub_spec,\n     is_pipeline_test,\n     nested_simplify,\n     require_tf,\n@@ -68,10 +68,8 @@ def run_pipeline_test(self, audio_classifier, examples):\n \n         self.run_torchaudio(audio_classifier)\n \n-        spec_output_keys = {field.name for field in fields(AudioClassificationOutputElement)}\n         for single_output in output:\n-            output_keys = set(single_output.keys())\n-            self.assertEqual(spec_output_keys, output_keys, msg=\"Pipeline output keys do not match HF Hub spec!\")\n+            compare_pipeline_output_to_hub_spec(single_output, AudioClassificationOutputElement)\n \n     @require_torchaudio\n     def run_torchaudio(self, audio_classifier):"
        },
        {
            "sha": "aecb96a5eeee8fdcdffc1956ee650eb799a49ba8",
            "filename": "tests/pipelines/test_pipelines_automatic_speech_recognition.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/tests%2Fpipelines%2Ftest_pipelines_automatic_speech_recognition.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/tests%2Fpipelines%2Ftest_pipelines_automatic_speech_recognition.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fpipelines%2Ftest_pipelines_automatic_speech_recognition.py?ref=a43e84cb3b78fcac3d5d9374a8488f74f3f19245",
            "patch": "@@ -18,7 +18,7 @@\n import numpy as np\n import pytest\n from datasets import Audio, load_dataset\n-from huggingface_hub import hf_hub_download, snapshot_download\n+from huggingface_hub import AutomaticSpeechRecognitionOutput, hf_hub_download, snapshot_download\n \n from transformers import (\n     MODEL_FOR_CTC_MAPPING,\n@@ -36,6 +36,7 @@\n from transformers.pipelines.audio_utils import chunk_bytes_iter\n from transformers.pipelines.automatic_speech_recognition import _find_timestamp_sequence, chunk_iter\n from transformers.testing_utils import (\n+    compare_pipeline_output_to_hub_spec,\n     is_pipeline_test,\n     is_torch_available,\n     nested_simplify,\n@@ -86,6 +87,8 @@ def run_pipeline_test(self, speech_recognizer, examples):\n         outputs = speech_recognizer(audio)\n         self.assertEqual(outputs, {\"text\": ANY(str)})\n \n+        compare_pipeline_output_to_hub_spec(outputs, AutomaticSpeechRecognitionOutput)\n+\n         # Striding\n         audio = {\"raw\": audio, \"stride\": (0, 4000), \"sampling_rate\": speech_recognizer.feature_extractor.sampling_rate}\n         if speech_recognizer.type == \"ctc\":"
        },
        {
            "sha": "e3c650a0e0696cf2e1c920e8fefbdccef94bfcd1",
            "filename": "tests/test_pipeline_mixin.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/tests%2Ftest_pipeline_mixin.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/a43e84cb3b78fcac3d5d9374a8488f74f3f19245/tests%2Ftest_pipeline_mixin.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Ftest_pipeline_mixin.py?ref=a43e84cb3b78fcac3d5d9374a8488f74f3f19245",
            "patch": "@@ -25,9 +25,9 @@\n from textwrap import dedent\n from typing import get_args\n \n-from huggingface_hub import AudioClassificationInput\n+from huggingface_hub import AudioClassificationInput, AutomaticSpeechRecognitionInput\n \n-from transformers.pipelines import AudioClassificationPipeline\n+from transformers.pipelines import AudioClassificationPipeline, AutomaticSpeechRecognitionPipeline\n from transformers.testing_utils import (\n     is_pipeline_test,\n     require_decord,\n@@ -104,6 +104,7 @@\n     # Adding a task to this list will cause its pipeline input signature to be checked against the corresponding\n     # task spec in the HF Hub\n     \"audio-classification\": (AudioClassificationPipeline, AudioClassificationInput),\n+    \"automatic-speech-recognition\": (AutomaticSpeechRecognitionPipeline, AutomaticSpeechRecognitionInput),\n }\n \n for task, task_info in pipeline_test_mapping.items():"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 42,
        "deletions": 9
    }
}