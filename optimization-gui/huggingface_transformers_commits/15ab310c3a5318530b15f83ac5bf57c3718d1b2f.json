{
    "author": "ydshieh",
    "message": "Fix private forked repo. CI (#35114)\n\nfix\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "15ab310c3a5318530b15f83ac5bf57c3718d1b2f",
    "files": [
        {
            "sha": "84c0f65166baef1dc91cf4cef64116712e4fd7cb",
            "filename": ".circleci/create_circleci_config.py",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/huggingface/transformers/blob/15ab310c3a5318530b15f83ac5bf57c3718d1b2f/.circleci%2Fcreate_circleci_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/15ab310c3a5318530b15f83ac5bf57c3718d1b2f/.circleci%2Fcreate_circleci_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fcreate_circleci_config.py?ref=15ab310c3a5318530b15f83ac5bf57c3718d1b2f",
            "patch": "@@ -133,7 +133,7 @@ def to_dict(self):\n                 \"command\": \"\"\"dpkg-query --show --showformat='${Installed-Size}\\t${Package}\\n' | sort -rh | head -25 | sort -h | awk '{ package=$2; sub(\".*/\", \"\", package); printf(\"%.5f GB %s\\n\", $1/1024/1024, package)}' || true\"\"\"}\n             },\n             {\"run\": {\"name\": \"Create `test-results` directory\", \"command\": \"mkdir test-results\"}},\n-            {\"run\": {\"name\": \"Get files to test\", \"command\":f'curl -L -o {self.job_name}_test_list.txt <<pipeline.parameters.{self.job_name}_test_list>>' if self.name != \"pr_documentation_tests\" else 'echo \"Skipped\"'}},\n+            {\"run\": {\"name\": \"Get files to test\", \"command\":f'curl -L -o {self.job_name}_test_list.txt <<pipeline.parameters.{self.job_name}_test_list>> --header \"Circle-Token: $CIRCLE_TOKEN\"' if self.name != \"pr_documentation_tests\" else 'echo \"Skipped\"'}},\n                         {\"run\": {\"name\": \"Split tests across parallel nodes: show current parallel tests\",\n                     \"command\": f\"TESTS=$(circleci tests split  --split-by=timings {self.job_name}_test_list.txt) && echo $TESTS > splitted_tests.txt && echo $TESTS | tr ' ' '\\n'\" if self.parallelism else f\"awk '{{printf \\\"%s \\\", $0}}' {self.job_name}_test_list.txt > splitted_tests.txt\"\n                     }\n@@ -371,9 +371,14 @@ def create_circleci_config(folder=None):\n             **{j.job_name + \"_test_list\":{\"type\":\"string\", \"default\":''} for j in jobs},\n             **{j.job_name + \"_parallelism\":{\"type\":\"integer\", \"default\":1} for j in jobs},\n         },\n-        \"jobs\" : {j.job_name: j.to_dict() for j in jobs},\n-        \"workflows\": {\"version\": 2, \"run_tests\": {\"jobs\": [j.job_name for j in jobs]}}\n+        \"jobs\" : {j.job_name: j.to_dict() for j in jobs}\n     }\n+    if \"CIRCLE_TOKEN\" in os.environ:\n+        # For private forked repo. (e.g. new model addition)\n+        config[\"workflows\"] = {\"version\": 2, \"run_tests\": {\"jobs\": [{j.job_name: {\"context\": [\"TRANSFORMERS_CONTEXT\"]}} for j in jobs]}}\n+    else:\n+        # For public repo. (e.g. `transformers`)\n+        config[\"workflows\"] = {\"version\": 2, \"run_tests\": {\"jobs\": [j.job_name for j in jobs]}}\n     with open(os.path.join(folder, \"generated_config.yml\"), \"w\") as f:\n         f.write(yaml.dump(config, sort_keys=False, default_flow_style=False).replace(\"' << pipeline\", \" << pipeline\").replace(\">> '\", \" >>\"))\n "
        }
    ],
    "stats": {
        "total": 11,
        "additions": 8,
        "deletions": 3
    }
}