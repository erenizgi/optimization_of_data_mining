{
    "author": "zucchini-nlp",
    "message": "Watermarking: fix order (#34849)\n\nfix watermarking order",
    "sha": "6a912ff2c5b3eadb9a0583d77083aae27d35d28d",
    "files": [
        {
            "sha": "1e94e9d1ef875ed4fcf0f20e8005bc2a3404cab5",
            "filename": "src/transformers/generation/utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/huggingface/transformers/blob/6a912ff2c5b3eadb9a0583d77083aae27d35d28d/src%2Ftransformers%2Fgeneration%2Futils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/6a912ff2c5b3eadb9a0583d77083aae27d35d28d/src%2Ftransformers%2Fgeneration%2Futils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fgeneration%2Futils.py?ref=6a912ff2c5b3eadb9a0583d77083aae27d35d28d",
            "patch": "@@ -1029,10 +1029,6 @@ def _get_logits_processor(\n                 \"You have explicitly specified `forced_decoder_ids`. Please remove the `forced_decoder_ids` argument \"\n                 \"in favour of `input_ids` or `decoder_input_ids` respectively.\",\n             )\n-        if generation_config.watermarking_config is not None:\n-            processors.append(\n-                generation_config.watermarking_config.construct_processor(self.config.vocab_size, device)\n-            )\n \n         # TODO (joao): find a strategy to specify the order of the processors\n         processors = self._merge_criteria_processor_list(processors, logits_processor)\n@@ -1085,6 +1081,12 @@ def _get_logits_processor(\n                     )\n                 )\n \n+        # Watermarking should be after all logits processing is finished (see #34630)\n+        if generation_config.watermarking_config is not None:\n+            processors.append(\n+                generation_config.watermarking_config.construct_processor(self.config.vocab_size, device)\n+            )\n+\n         # `LogitNormalization` should always be the last logit processor, when present\n         if generation_config.renormalize_logits is True:\n             processors.append(LogitNormalization())"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 6,
        "deletions": 4
    }
}