{
    "author": "faaany",
    "message": "[docs] add xpu environment variable for gpu selection (#38194)\n\n* squash commits\n\n* rename gpu\n\n* rename accelerator\n\n* change _toctree.yml\n\n* Apply suggestions from code review\n\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\n\n---------\n\nCo-authored-by: sdp <sdp@a4bf01943ff7.jf.intel.com>\nCo-authored-by: Steven Liu <59462357+stevhliu@users.noreply.github.com>\nCo-authored-by: Marc Sun <57196510+SunMarc@users.noreply.github.com>",
    "sha": "51d732709e5ae424e8fb6c4e58b72057a3e413c2",
    "files": [
        {
            "sha": "6269fc5ead0ee287f91a92120214b4813bbd709a",
            "filename": "docs/source/en/_toctree.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/51d732709e5ae424e8fb6c4e58b72057a3e413c2/docs%2Fsource%2Fen%2F_toctree.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/51d732709e5ae424e8fb6c4e58b72057a3e413c2/docs%2Fsource%2Fen%2F_toctree.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2F_toctree.yml?ref=51d732709e5ae424e8fb6c4e58b72057a3e413c2",
            "patch": "@@ -129,8 +129,8 @@\n       title: Hyperparameter search\n     title: Trainer API\n   - sections:\n-    - local: gpu_selection\n-      title: GPU selection\n+    - local: accelerator_selection\n+      title: Accelerator selection\n     - local: accelerate\n       title: Accelerate\n     - local: fsdp"
        },
        {
            "sha": "5d5bbc2675fa233a65f6fac1f13c4b92aa6ed5e9",
            "filename": "docs/source/en/accelerator_selection.md",
            "status": "added",
            "additions": 126,
            "deletions": 0,
            "changes": 126,
            "blob_url": "https://github.com/huggingface/transformers/blob/51d732709e5ae424e8fb6c4e58b72057a3e413c2/docs%2Fsource%2Fen%2Faccelerator_selection.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/51d732709e5ae424e8fb6c4e58b72057a3e413c2/docs%2Fsource%2Fen%2Faccelerator_selection.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Faccelerator_selection.md?ref=51d732709e5ae424e8fb6c4e58b72057a3e413c2",
            "patch": "@@ -0,0 +1,126 @@\n+<!--Copyright 2025 The HuggingFace Team. All rights reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+the License. You may obtain a copy of the License at\n+\n+http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+specific language governing permissions and limitations under the License.\n+\n+⚠️ Note that this file is in Markdown but contains specific syntax for our doc-builder (similar to MDX) that may not be\n+rendered properly in your Markdown viewer.\n+\n+-->\n+\n+# Accelerator selection\n+\n+During distributed training, you can specify the number and order of accelerators (CUDA, XPU, MPS, HPU, etc.) to use. This can be useful when you have accelerators with different computing power and you want to use the faster accelerator first. Or you could only use a subset of the available accelerators. The selection process works for both [DistributedDataParallel](https://pytorch.org/docs/stable/generated/torch.nn.parallel.DistributedDataParallel.html) and [DataParallel](https://pytorch.org/docs/stable/generated/torch.nn.DataParallel.html). You don't need Accelerate or [DeepSpeed integration](./main_classes/deepspeed).\n+\n+This guide will show you how to select the number of accelerators to use and the order to use them in.\n+\n+## Number of accelerators\n+\n+For example, if there are 4 accelerators and you only want to use the first 2, run the command below.\n+\n+<hfoptions id=\"select-accelerator\">\n+<hfoption id=\"torchrun\">\n+\n+Use the `--nproc_per_node` to select how many accelerators to use.\n+\n+```bash\n+torchrun --nproc_per_node=2  trainer-program.py ...\n+```\n+\n+</hfoption>\n+<hfoption id=\"Accelerate\">\n+\n+Use `--num_processes` to select how many accelerators to use.\n+\n+```bash\n+accelerate launch --num_processes 2 trainer-program.py ...\n+```\n+\n+</hfoption>\n+<hfoption id=\"DeepSpeed\">\n+\n+Use `--num_gpus` to select how many GPUs to use.\n+\n+```bash\n+deepspeed --num_gpus 2 trainer-program.py ...\n+```\n+\n+</hfoption>\n+</hfoptions>\n+\n+## Order of accelerators\n+To select specific accelerators to use and their order, use the environment variable appropriate for your hardware. This is often set on the command line for each run, but can also be added to your `~/.bashrc` or other startup config file.\n+\n+For example, if there are 4 accelerators (0, 1, 2, 3) and you only want to run accelerators 0 and 2:\n+\n+<hfoptions id=\"accelerator-type\">\n+<hfoption id=\"CUDA\">\n+\n+```bash\n+CUDA_VISIBLE_DEVICES=0,2 torchrun trainer-program.py ...\n+```\n+\n+Only GPUs 0 and 2 are \"visible\" to PyTorch and are mapped to `cuda:0` and `cuda:1` respectively.  \n+To reverse the order (use GPU 2 as `cuda:0` and GPU 0 as `cuda:1`):\n+\n+\n+```bash\n+CUDA_VISIBLE_DEVICES=2,0 torchrun trainer-program.py ...\n+```\n+\n+To run without any GPUs:\n+\n+```bash\n+CUDA_VISIBLE_DEVICES= python trainer-program.py ...\n+```\n+\n+You can also control the order of CUDA devices using `CUDA_DEVICE_ORDER`:\n+\n+- Order by PCIe bus ID (matches `nvidia-smi`):\n+\n+    ```bash\n+    export CUDA_DEVICE_ORDER=PCI_BUS_ID\n+    ```\n+\n+- Order by compute capability (fastest first):\n+\n+    ```bash\n+    export CUDA_DEVICE_ORDER=FASTEST_FIRST\n+    ```\n+\n+</hfoption>\n+<hfoption id=\"Intel XPU\">\n+\n+```bash\n+ZE_AFFINITY_MASK=0,2 torchrun trainer-program.py ...\n+```\n+\n+Only XPUs 0 and 2 are \"visible\" to PyTorch and are mapped to `xpu:0` and `xpu:1` respectively.  \n+To reverse the order (use XPU 2 as `xpu:0` and XPU 0 as `xpu:1`):\n+\n+```bash\n+ZE_AFFINITY_MASK=2,0 torchrun trainer-program.py ...\n+```\n+\n+\n+You can also control the order of Intel XPUs with:\n+\n+```bash\n+export ZE_ENABLE_PCI_ID_DEVICE_ORDER=1\n+```\n+\n+For more information about device enumeration and sorting on Intel XPU, please refer to the [Level Zero](https://github.com/oneapi-src/level-zero/blob/master/README.md?plain=1#L87) documentation.\n+\n+</hfoption>\n+</hfoptions>\n+\n+\n+\n+> [!WARNING]\n+> Environment variables can be exported instead of being added to the command line. This is not recommended because it can be confusing if you forget how the environment variable was set up and you end up using the wrong accelerators. Instead, it is common practice to set the environment variable for a specific training run on the same command line."
        },
        {
            "sha": "57623ed74a14f7b71ce995785e131e220e8d7d85",
            "filename": "docs/source/en/gpu_selection.md",
            "status": "removed",
            "additions": 0,
            "deletions": 94,
            "changes": 94,
            "blob_url": "https://github.com/huggingface/transformers/blob/c7f2b79dd853c28e27076686c331a1b702ecd38e/docs%2Fsource%2Fen%2Fgpu_selection.md",
            "raw_url": "https://github.com/huggingface/transformers/raw/c7f2b79dd853c28e27076686c331a1b702ecd38e/docs%2Fsource%2Fen%2Fgpu_selection.md",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/docs%2Fsource%2Fen%2Fgpu_selection.md?ref=c7f2b79dd853c28e27076686c331a1b702ecd38e",
            "patch": "@@ -1,94 +0,0 @@\n-<!--Copyright 2025 The HuggingFace Team. All rights reserved.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n-the License. You may obtain a copy of the License at\n-\n-http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n-an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n-specific language governing permissions and limitations under the License.\n-\n-⚠️ Note that this file is in Markdown but contains specific syntax for our doc-builder (similar to MDX) that may not be\n-rendered properly in your Markdown viewer.\n-\n--->\n-\n-# GPU selection\n-\n-During distributed training, you can specify the number of GPUs to use and in what order. This can be useful when you have GPUs with different computing power and you want to use the faster GPU first. Or you could only use a subset of the available GPUs. The selection process works for both [DistributedDataParallel](https://pytorch.org/docs/stable/generated/torch.nn.parallel.DistributedDataParallel.html) and [DataParallel](https://pytorch.org/docs/stable/generated/torch.nn.DataParallel.html). You don't need Accelerate or [DeepSpeed integration](./main_classes/deepspeed).\n-\n-This guide will show you how to select the number of GPUs to use and the order to use them in.\n-\n-## Number of GPUs\n-\n-For example, if there are 4 GPUs and you only want to use the first 2, run the command below.\n-\n-<hfoptions id=\"select-gpu\">\n-<hfoption id=\"torchrun\">\n-\n-Use the `--nproc_per_node` to select how many GPUs to use.\n-\n-```bash\n-torchrun --nproc_per_node=2  trainer-program.py ...\n-```\n-\n-</hfoption>\n-<hfoption id=\"Accelerate\">\n-\n-Use `--num_processes` to select how many GPUs to use.\n-\n-```bash\n-accelerate launch --num_processes 2 trainer-program.py ...\n-```\n-\n-</hfoption>\n-<hfoption id=\"DeepSpeed\">\n-\n-Use `--num_gpus` to select how many GPUs to use.\n-\n-```bash\n-deepspeed --num_gpus 2 trainer-program.py ...\n-```\n-\n-</hfoption>\n-</hfoptions>\n-\n-### Order of GPUs\n-\n-To select specific GPUs to use and their order, configure the `CUDA_VISIBLE_DEVICES` environment variable. It is easiest to set the environment variable in `~/bashrc` or another startup config file. `CUDA_VISIBLE_DEVICES` is used to map which GPUs are used. For example, if there are 4 GPUs (0, 1, 2, 3) and you only want to run GPUs 0 and 2:\n-\n-```bash\n-CUDA_VISIBLE_DEVICES=0,2 torchrun trainer-program.py ...\n-```\n-\n-Only the 2 physical GPUs (0 and 2) are \"visible\" to PyTorch and these are mapped to `cuda:0` and `cuda:1` respectively. You can also reverse the order of the GPUs to use 2 first. The mapping becomes `cuda:1` for GPU 0 and `cuda:0` for GPU 2.\n-\n-```bash\n-CUDA_VISIBLE_DEVICES=2,0 torchrun trainer-program.py ...\n-```\n-\n-You can also set the `CUDA_VISIBLE_DEVICES` environment variable to an empty value to create an environment without GPUs.\n-\n-```bash\n-CUDA_VISIBLE_DEVICES= python trainer-program.py ...\n-```\n-\n-> [!WARNING]\n-> As with any environment variable, they can be exported instead of being added to the command line. However, this is not recommended because it can be confusing if you forget how the environment variable was set up and you end up using the wrong GPUs. Instead, it is common practice to set the environment variable for a specific training run on the same command line.\n-\n-`CUDA_DEVICE_ORDER` is an alternative environment variable you can use to control how the GPUs are ordered. You can order according to the following.\n-\n-1. PCIe bus IDs that matches the order of [`nvidia-smi`](https://developer.nvidia.com/nvidia-system-management-interface) and [`rocm-smi`](https://rocm.docs.amd.com/projects/rocm_smi_lib/en/latest/.doxygen/docBin/html/index.html) for NVIDIA and AMD GPUs respectively.\n-\n-```bash\n-export CUDA_DEVICE_ORDER=PCI_BUS_ID\n-```\n-\n-2. GPU compute ability.\n-\n-```bash\n-export CUDA_DEVICE_ORDER=FASTEST_FIRST\n-```\n-\n-The `CUDA_DEVICE_ORDER` is especially useful if your training setup consists of an older and newer GPU, where the older GPU appears first, but you cannot physically swap the cards to make the newer GPU appear first. In this case, set `CUDA_DEVICE_ORDER=FASTEST_FIRST` to always use the newer and faster GPU first (`nvidia-smi` or `rocm-smi` still reports the GPUs in their PCIe order). Or you could also set `export CUDA_VISIBLE_DEVICES=1,0`.\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 224,
        "additions": 128,
        "deletions": 96
    }
}