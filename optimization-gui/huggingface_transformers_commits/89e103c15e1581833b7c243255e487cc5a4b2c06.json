{
    "author": "McPatate",
    "message": "feat(serve): add healthcheck test (#40697)",
    "sha": "89e103c15e1581833b7c243255e487cc5a4b2c06",
    "files": [
        {
            "sha": "1827832834fe6f0ee844771d115122d2ef30a3f3",
            "filename": "tests/commands/test_serving.py",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/huggingface/transformers/blob/89e103c15e1581833b7c243255e487cc5a4b2c06/tests%2Fcommands%2Ftest_serving.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/89e103c15e1581833b7c243255e487cc5a4b2c06/tests%2Fcommands%2Ftest_serving.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/tests%2Fcommands%2Ftest_serving.py?ref=89e103c15e1581833b7c243255e487cc5a4b2c06",
            "patch": "@@ -710,3 +710,29 @@ def test_full_request(self):\n                 \"As an AI language model, I am designed to assist with various tasks and provide information on different topics related to sports.\"\n             )\n         )\n+\n+\n+class ServeInfrastructureTest(unittest.TestCase):\n+    @classmethod\n+    def setUpClass(cls):\n+        cls.port = 8042\n+        args = ServeArguments(port=cls.port)\n+        serve_command = ServeCommand(args)\n+        thread = Thread(target=serve_command.run)\n+        thread.daemon = True\n+        thread.start()\n+\n+    def test_healthcheck(self):\n+        \"\"\"Tests that the healthcheck endpoint works.\"\"\"\n+        response = None\n+        retries = 10\n+        while retries > 0:\n+            try:\n+                response = requests.get(f\"http://localhost:{self.port}/health\")\n+                break\n+            except requests.exceptions.ConnectionError:\n+                time.sleep(0.1)\n+                retries -= 1\n+        self.assertIsNotNone(response, \"Failed to connect to the server health endpoint.\")\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.json(), {\"status\": \"ok\"})"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 26,
        "deletions": 0
    }
}