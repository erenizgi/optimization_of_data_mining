{
    "author": "woct0rdho",
    "message": "Improve performance of `load_state_dict` (#37902)\n\nImprove performance of load_state_dict",
    "sha": "ee25d57ed18f2dc06e88bd041830c6a32f80ff88",
    "files": [
        {
            "sha": "fe257b5694457f7d8e7ad4f35a94eb32f4ecf66e",
            "filename": "src/transformers/modeling_utils.py",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/huggingface/transformers/blob/ee25d57ed18f2dc06e88bd041830c6a32f80ff88/src%2Ftransformers%2Fmodeling_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/ee25d57ed18f2dc06e88bd041830c6a32f80ff88/src%2Ftransformers%2Fmodeling_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Fmodeling_utils.py?ref=ee25d57ed18f2dc06e88bd041830c6a32f80ff88",
            "patch": "@@ -507,13 +507,14 @@ def load_state_dict(\n                 )\n             state_dict = {}\n             for k in f.keys():\n-                k_dtype = f.get_slice(k).get_dtype()\n-                if k_dtype in str_to_torch_dtype:\n-                    dtype = str_to_torch_dtype[k_dtype]\n-                else:\n-                    raise ValueError(f\"Cannot load safetensors of unknown dtype {k_dtype}\")\n                 if map_location == \"meta\":\n-                    state_dict[k] = torch.empty(size=f.get_slice(k).get_shape(), dtype=dtype, device=\"meta\")\n+                    _slice = f.get_slice(k)\n+                    k_dtype = _slice.get_dtype()\n+                    if k_dtype in str_to_torch_dtype:\n+                        dtype = str_to_torch_dtype[k_dtype]\n+                    else:\n+                        raise ValueError(f\"Cannot load safetensors of unknown dtype {k_dtype}\")\n+                    state_dict[k] = torch.empty(size=_slice.get_shape(), dtype=dtype, device=\"meta\")\n                 else:\n                     state_dict[k] = f.get_tensor(k)\n             return state_dict"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 7,
        "deletions": 6
    }
}