{
    "author": "ydshieh",
    "message": "Improve SSH into runner (#42695)\n\nbetter\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "8d75aabf3199a561ebdb71fcf1f3f25b9e857b1f",
    "files": [
        {
            "sha": "3e22ae72fb57c6e89c10bc50f88cb8e65ffd57d6",
            "filename": ".github/workflows/ssh-runner.yml",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/huggingface/transformers/blob/8d75aabf3199a561ebdb71fcf1f3f25b9e857b1f/.github%2Fworkflows%2Fssh-runner.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/8d75aabf3199a561ebdb71fcf1f3f25b9e857b1f/.github%2Fworkflows%2Fssh-runner.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.github%2Fworkflows%2Fssh-runner.yml?ref=8d75aabf3199a561ebdb71fcf1f3f25b9e857b1f",
            "patch": "@@ -80,6 +80,38 @@ jobs:\n         run: |\n           nvidia-smi\n \n+      - name: Create python alias\n+        run: |\n+          ln -sf $(which python3) /usr/local/bin/python\n+          ln -sf $(which pip3) /usr/local/bin/pip\n+          echo \"âœ… python -> python3 symlink created\"\n+\n+      - name: Install psutil for memory monitor\n+        run: |\n+          pip install psutil --break-system-packages\n+\n+      - name: Download memory monitor script\n+        working-directory: /transformers\n+        run: |\n+          apt-get update && apt-get install -y curl\n+          curl -o memory_monitor.py https://raw.githubusercontent.com/huggingface/transformers/refs/heads/utility_scripts/utils/memory_monitor.py\n+\n+      - name: Start memory monitor\n+        working-directory: /transformers\n+        continue-on-error: true  # Don't fail workflow if monitor has issues\n+        run: |\n+          python3 memory_monitor.py --threshold 90 --interval 1 > memory_monitor.log 2>&1 &\n+          echo $! > memory_monitor.pid\n+          echo \"Memory monitor started with PID $(cat memory_monitor.pid)\"\n+          # Give it a moment to start\n+          sleep 2\n+          # Verify it's running\n+          ps aux | grep memory_monitor | grep -v grep || echo \"Warning: memory monitor may not be running\"\n+\n+      - name: Install utilities\n+        run: |\n+          apt-get install -y nano\n+\n       - name: Store Slack infos\n         #because the SSH can be enabled dynamically if the workflow failed, so we need to store slack infos to be able to retrieve them during the waitforssh step\n         shell: bash\n@@ -92,6 +124,36 @@ jobs:\n           echo \"$github_actor\"\n           echo \"github_actor=$github_actor\" >> $GITHUB_ENV\n \n+      - name: Setup automatic environment for SSH login\n+        run: |\n+          # Create shared environment setup\n+          cat > /root/.env_setup << 'EOF'\n+          # Auto-setup (non-sensitive vars)\n+          export HF_HOME=/mnt/cache\n+          export TRANSFORMERS_IS_CI=yes\n+          export OMP_NUM_THREADS=8\n+          export MKL_NUM_THREADS=8\n+          export RUN_SLOW=yes\n+          export TF_FORCE_GPU_ALLOW_GROWTH=true\n+          export CUDA_VISIBLE_DEVICES=0,1\n+          \n+          cd /transformers 2>/dev/null || true\n+          \n+          # Remind user to set token if needed\n+          if [ -z \"$HF_HUB_READ_TOKEN\" ]; then\n+              echo \"âš ï¸  HF_HUB_READ_TOKEN not set. Set it with:\"\n+              echo \"    export HF_HUB_READ_TOKEN=hf_xxxxx\"\n+          else\n+              echo \"âœ… HF_HUB_READ_TOKEN is set\"\n+          fi\n+          \n+          echo \"ðŸ“ Working directory: $(pwd)\"\n+          EOF\n+          \n+          # Source from both .bash_profile and .bashrc\n+          echo 'source /root/.env_setup' >> /root/.bash_profile\n+          echo 'source /root/.env_setup' >> /root/.bashrc\n+\n       - name: Store Slack infos\n         #because the SSH can be enabled dynamically if the workflow failed, so we need to store slack infos to be able to retrieve them during the waitforssh step\n         shell: bash"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 62,
        "deletions": 0
    }
}