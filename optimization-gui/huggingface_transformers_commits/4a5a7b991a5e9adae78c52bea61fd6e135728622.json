{
    "author": "ydshieh",
    "message": "Fix test fetcher (#36129)\n\n* fix\r\n\r\n* fix\r\n\r\n* update\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "4a5a7b991a5e9adae78c52bea61fd6e135728622",
    "files": [
        {
            "sha": "c14ff2124aa09c877b11d8557927a32c7e9d4178",
            "filename": "src/transformers/utils/import_utils.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/huggingface/transformers/blob/4a5a7b991a5e9adae78c52bea61fd6e135728622/src%2Ftransformers%2Futils%2Fimport_utils.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4a5a7b991a5e9adae78c52bea61fd6e135728622/src%2Ftransformers%2Futils%2Fimport_utils.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fimport_utils.py?ref=4a5a7b991a5e9adae78c52bea61fd6e135728622",
            "patch": "@@ -1927,11 +1927,16 @@ def fetch__all__(file_content):\n     if \"__all__\" not in file_content:\n         return []\n \n+    start_index = None\n     lines = file_content.splitlines()\n     for index, line in enumerate(lines):\n         if line.startswith(\"__all__\"):\n             start_index = index\n \n+    # There is no line starting with `__all__`\n+    if start_index is None:\n+        return []\n+\n     lines = lines[start_index:]\n \n     if not lines[0].startswith(\"__all__\"):"
        },
        {
            "sha": "865b4fb9d5db1b1153c3ffcbfac9d1e4b33f704a",
            "filename": "utils/tests_fetcher.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/huggingface/transformers/blob/4a5a7b991a5e9adae78c52bea61fd6e135728622/utils%2Ftests_fetcher.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/4a5a7b991a5e9adae78c52bea61fd6e135728622/utils%2Ftests_fetcher.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Ftests_fetcher.py?ref=4a5a7b991a5e9adae78c52bea61fd6e135728622",
            "patch": "@@ -735,11 +735,23 @@ def get_module_dependencies(module_fname: str, cache: Dict[str, List[str]] = Non\n             if module.endswith(\"__init__.py\"):\n                 # So we get the imports from that init then try to find where our objects come from.\n                 new_imported_modules = extract_imports(module, cache=cache)\n+\n+                # Add imports via `define_import_structure` after the #35167 as we remove explicit import in `__init__.py`\n+                from transformers.utils.import_utils import define_import_structure\n+\n+                new_imported_modules_2 = define_import_structure(PATH_TO_REPO / module)\n+\n+                for mapping in new_imported_modules_2.values():\n+                    for _module, _imports in mapping.items():\n+                        _module = module.replace(\"__init__.py\", f\"{_module}.py\")\n+                        new_imported_modules.append((_module, list(_imports)))\n+\n                 for new_module, new_imports in new_imported_modules:\n                     if any(i in new_imports for i in imports):\n                         if new_module not in dependencies:\n                             new_modules.append((new_module, [i for i in new_imports if i in imports]))\n                         imports = [i for i in imports if i not in new_imports]\n+\n                 if len(imports) > 0:\n                     # If there are any objects lefts, they may be a submodule\n                     path_to_module = PATH_TO_REPO / module.replace(\"__init__.py\", \"\")\n@@ -759,6 +771,7 @@ def get_module_dependencies(module_fname: str, cache: Dict[str, List[str]] = Non\n                 dependencies.append(module)\n \n         imported_modules = new_modules\n+\n     return dependencies\n \n \n@@ -880,6 +893,7 @@ def create_reverse_dependency_map() -> Dict[str, List[str]]:\n         depending on it recursively. This way the tests impacted by a change in file A are the test files in the list\n         corresponding to key A in this result.\n     \"\"\"\n+\n     cache = {}\n     # Start from the example deps init.\n     example_deps, examples = init_test_examples_dependencies()"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 19,
        "deletions": 0
    }
}