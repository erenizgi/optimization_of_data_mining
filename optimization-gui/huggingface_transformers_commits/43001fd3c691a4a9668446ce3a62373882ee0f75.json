{
    "author": "ydshieh",
    "message": "Fix `time_spent ` in `notification_service.py`. (#40081)\n\nfix\n\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "43001fd3c691a4a9668446ce3a62373882ee0f75",
    "files": [
        {
            "sha": "96d6febcabd14e01b1694323adc0bfe151d34d8d",
            "filename": "utils/notification_service.py",
            "status": "modified",
            "additions": 17,
            "deletions": 17,
            "changes": 34,
            "blob_url": "https://github.com/huggingface/transformers/blob/43001fd3c691a4a9668446ce3a62373882ee0f75/utils%2Fnotification_service.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/43001fd3c691a4a9668446ce3a62373882ee0f75/utils%2Fnotification_service.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fnotification_service.py?ref=43001fd3c691a4a9668446ce3a62373882ee0f75",
            "patch": "@@ -80,7 +80,13 @@ def handle_test_results(test_results):\n \n     # When the output is short enough, the output is surrounded by = signs: \"== OUTPUT ==\"\n     # When it is too long, those signs are not present.\n-    time_spent = expressions[-2] if \"=\" in expressions[-1] else expressions[-1]\n+    # It could be `'71.60s', '(0:01:11)', '====\\n'` or `'in', '35.01s', '================\\n'`.\n+    # Let always select the one with `s`.\n+    time_spent = expressions[-1]\n+    if \"=\" in time_spent:\n+        time_spent = expressions[-2]\n+    if \"(\" in time_spent:\n+        time_spent = expressions[-3]\n \n     for i, expression in enumerate(expressions):\n         if \"failed\" in expression:\n@@ -193,18 +199,12 @@ def __init__(\n     @property\n     def time(self) -> str:\n         all_results = [*self.model_results.values(), *self.additional_results.values()]\n-        time_spent = [r[\"time_spent\"].split(\", \")[0] for r in all_results if len(r[\"time_spent\"])]\n-        total_secs = 0\n \n-        for time in time_spent:\n-            time_parts = time.split(\":\")\n-\n-            # Time can be formatted as xx:xx:xx, as .xx, or as x.xx if the time spent was less than a minute.\n-            if len(time_parts) == 1:\n-                time_parts = [0, 0, time_parts[0]]\n-\n-            hours, minutes, seconds = int(time_parts[0]), int(time_parts[1]), float(time_parts[2])\n-            total_secs += hours * 3600 + minutes * 60 + seconds\n+        time_spent = []\n+        for r in all_results:\n+            if len(r[\"time_spent\"]):\n+                time_spent.extend(r[\"time_spent\"])\n+        total_secs = sum(time_spent)\n \n         hours, minutes, seconds = total_secs // 3600, (total_secs % 3600) // 60, total_secs % 60\n         return f\"{int(hours)}h{int(minutes)}m{int(seconds)}s\"\n@@ -1197,7 +1197,7 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n             \"errors\": 0,\n             \"success\": 0,\n             \"skipped\": 0,\n-            \"time_spent\": \"\",\n+            \"time_spent\": [],\n             \"failures\": {},\n             \"job_link\": {},\n         }\n@@ -1225,7 +1225,7 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n                 matrix_job_results[matrix_name][\"success\"] += success\n                 matrix_job_results[matrix_name][\"errors\"] += errors\n                 matrix_job_results[matrix_name][\"skipped\"] += skipped\n-                matrix_job_results[matrix_name][\"time_spent\"] += time_spent[1:-1] + \", \"\n+                matrix_job_results[matrix_name][\"time_spent\"].append(float(time_spent[:-1]))\n \n                 stacktraces = handle_stacktraces(artifact[\"failures_line\"])\n \n@@ -1330,7 +1330,7 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n             \"errors\": 0,\n             \"success\": 0,\n             \"skipped\": 0,\n-            \"time_spent\": \"\",\n+            \"time_spent\": [],\n             \"error\": False,\n             \"failures\": {},\n             \"job_link\": {},\n@@ -1360,7 +1360,7 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n             additional_results[key][\"success\"] += success\n             additional_results[key][\"errors\"] += errors\n             additional_results[key][\"skipped\"] += skipped\n-            additional_results[key][\"time_spent\"] += time_spent[1:-1] + \", \"\n+            additional_results[key][\"time_spent\"].append(float(time_spent[:-1]))\n \n             if len(artifact[\"errors\"]):\n                 additional_results[key][\"error\"] = True\n@@ -1443,7 +1443,7 @@ def pop_default(l: list[Any], i: int, default: Any) -> Any:\n         default_result = {\n             \"failed\": {\"unclassified\": 0, \"single\": 0, \"multi\": 0},\n             \"success\": 0,\n-            \"time_spent\": \"\",\n+            \"time_spent\": [],\n             \"error\": False,\n             \"failures\": {},\n             \"job_link\": {},"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 17,
        "deletions": 17
    }
}