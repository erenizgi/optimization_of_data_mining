{
    "author": "ydshieh",
    "message": "Aggeregate test summary files in CircleCI workflow runs (#34989)\n\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* try 1\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n* update\r\n\r\n* fix\r\n\r\n* fix\r\n\r\n---------\r\n\r\nCo-authored-by: ydshieh <ydshieh@users.noreply.github.com>",
    "sha": "66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0",
    "files": [
        {
            "sha": "75413af8bf5254eadfa532c5637bd1a09c2fc137",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/huggingface/transformers/blob/66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/huggingface/transformers/raw/66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fconfig.yml?ref=66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0",
            "patch": "@@ -58,14 +58,14 @@ jobs:\n                 name: \"Prepare pipeline parameters\"\n                 command: |\n                     python utils/process_test_artifacts.py \n-            \n+\n             # To avoid too long generated_config.yaml on the continuation orb, we pass the links to the artifacts as parameters.\n             # Otherwise the list of tests was just too big. Explicit is good but for that it was a limitation.\n             # We used:\n \n             # https://circleci.com/docs/api/v2/index.html#operation/getJobArtifacts : to get the job artifacts\n             # We could not pass a nested dict, which is why we create the test_file_... parameters for every single job\n-                \n+\n             - store_artifacts:\n                 path: test_preparation/transformed_artifacts.json\n             - store_artifacts:"
        },
        {
            "sha": "be8952903e2ce257d419faf72940065f05236a55",
            "filename": ".circleci/create_circleci_config.py",
            "status": "modified",
            "additions": 23,
            "deletions": 3,
            "changes": 26,
            "blob_url": "https://github.com/huggingface/transformers/blob/66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0/.circleci%2Fcreate_circleci_config.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0/.circleci%2Fcreate_circleci_config.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/.circleci%2Fcreate_circleci_config.py?ref=66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0",
            "patch": "@@ -40,9 +40,22 @@ class EmptyJob:\n     job_name = \"empty\"\n \n     def to_dict(self):\n+        steps = [{\"run\": 'ls -la'}]\n+        if self.job_name == \"collection_job\":\n+            steps.extend(\n+                [\n+                    \"checkout\",\n+                    {\"run\": \"pip install requests || true\"},\n+                    {\"run\": \"\"\"while [[ $(curl --location --request GET \"https://circleci.com/api/v2/workflow/$CIRCLE_WORKFLOW_ID/job\" --header \"Circle-Token: $CCI_TOKEN\"| jq -r '.items[]|select(.name != \"collection_job\")|.status' | grep -c \"running\") -gt 0 ]]; do sleep 5; done || true\"\"\"},\n+                    {\"run\": 'python utils/process_circleci_workflow_test_reports.py --workflow_id $CIRCLE_WORKFLOW_ID || true'},\n+                    {\"store_artifacts\": {\"path\": \"outputs\"}},\n+                    {\"run\": 'echo \"All required jobs have now completed\"'},\n+                ]\n+            )\n+\n         return {\n             \"docker\": copy.deepcopy(DEFAULT_DOCKER_IMAGE),\n-            \"steps\":[\"checkout\"],\n+            \"steps\": steps,\n         }\n \n \n@@ -352,6 +365,7 @@ def job_name(self):\n DOC_TESTS = [doc_test_job]\n ALL_TESTS = REGULAR_TESTS + EXAMPLES_TESTS + PIPELINE_TESTS + REPO_UTIL_TESTS + DOC_TESTS + [custom_tokenizers_job] + [exotic_models_job]  # fmt: skip\n \n+\n def create_circleci_config(folder=None):\n     if folder is None:\n         folder = os.getcwd()\n@@ -361,7 +375,13 @@ def create_circleci_config(folder=None):\n \n     if len(jobs) == 0:\n         jobs = [EmptyJob()]\n-    print(\"Full list of job name inputs\", {j.job_name + \"_test_list\":{\"type\":\"string\", \"default\":''} for j in jobs})\n+    else:\n+        print(\"Full list of job name inputs\", {j.job_name + \"_test_list\":{\"type\":\"string\", \"default\":''} for j in jobs})\n+        # Add a job waiting all the test jobs and aggregate their test summary files at the end\n+        collection_job = EmptyJob()\n+        collection_job.job_name = \"collection_job\"\n+        jobs = [collection_job] + jobs\n+\n     config = {\n         \"version\": \"2.1\",\n         \"parameters\": {\n@@ -371,7 +391,7 @@ def create_circleci_config(folder=None):\n             **{j.job_name + \"_test_list\":{\"type\":\"string\", \"default\":''} for j in jobs},\n             **{j.job_name + \"_parallelism\":{\"type\":\"integer\", \"default\":1} for j in jobs},\n         },\n-        \"jobs\" : {j.job_name: j.to_dict() for j in jobs}\n+        \"jobs\": {j.job_name: j.to_dict() for j in jobs}\n     }\n     if \"CIRCLE_TOKEN\" in os.environ:\n         # For private forked repo. (e.g. new model addition)"
        },
        {
            "sha": "944bc47a7e2fa42da1631eb6cfc5026aa54849df",
            "filename": "utils/process_circleci_workflow_test_reports.py",
            "status": "added",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/huggingface/transformers/blob/66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0/utils%2Fprocess_circleci_workflow_test_reports.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0/utils%2Fprocess_circleci_workflow_test_reports.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/utils%2Fprocess_circleci_workflow_test_reports.py?ref=66531a1ec3e2aafe7ffb23a9ca715cfb67b9fea0",
            "patch": "@@ -0,0 +1,85 @@\n+# Copyright 2024 The HuggingFace Team. All rights reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+import argparse\n+import json\n+import os\n+\n+import requests\n+\n+\n+if __name__ == \"__main__\":\n+    parser = argparse.ArgumentParser()\n+    parser.add_argument(\"--workflow_id\", type=str, required=True)\n+    args = parser.parse_args()\n+    workflow_id = args.workflow_id\n+\n+    r = requests.get(\n+        f\"https://circleci.com/api/v2/workflow/{workflow_id}/job\",\n+        headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")},\n+    )\n+    jobs = r.json()[\"items\"]\n+\n+    os.makedirs(\"outputs\", exist_ok=True)\n+\n+    workflow_summary = {}\n+    # for each job, download artifacts\n+    for job in jobs:\n+        project_slug = job[\"project_slug\"]\n+        if job[\"name\"].startswith((\"tests_\", \"examples_\", \"pipelines_\")):\n+            url = f'https://circleci.com/api/v2/project/{project_slug}/{job[\"job_number\"]}/artifacts'\n+            r = requests.get(url, headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")})\n+            job_artifacts = r.json()[\"items\"]\n+\n+            os.makedirs(job[\"name\"], exist_ok=True)\n+            os.makedirs(f'outputs/{job[\"name\"]}', exist_ok=True)\n+\n+            job_test_summaries = {}\n+            for artifact in job_artifacts:\n+                if artifact[\"path\"].startswith(\"reports/\") and artifact[\"path\"].endswith(\"/summary_short.txt\"):\n+                    node_index = artifact[\"node_index\"]\n+                    url = artifact[\"url\"]\n+                    r = requests.get(url, headers={\"Circle-Token\": os.environ.get(\"CIRCLE_TOKEN\", \"\")})\n+                    test_summary = r.text\n+                    job_test_summaries[node_index] = test_summary\n+\n+            summary = {}\n+            for node_index, node_test_summary in job_test_summaries.items():\n+                for line in node_test_summary.splitlines():\n+                    if line.startswith(\"PASSED \"):\n+                        test = line[len(\"PASSED \") :]\n+                        summary[test] = \"passed\"\n+                    elif line.startswith(\"FAILED \"):\n+                        test = line[len(\"FAILED \") :].split()[0]\n+                        summary[test] = \"failed\"\n+            # failed before passed\n+            summary = dict(sorted(summary.items(), key=lambda x: (x[1], x[0])))\n+            workflow_summary[job[\"name\"]] = summary\n+\n+            # collected version\n+            with open(f'outputs/{job[\"name\"]}/test_summary.json', \"w\") as fp:\n+                json.dump(summary, fp, indent=4)\n+\n+    new_workflow_summary = {}\n+    for job_name, job_summary in workflow_summary.items():\n+        for test, status in job_summary.items():\n+            if test not in new_workflow_summary:\n+                new_workflow_summary[test] = {}\n+            new_workflow_summary[test][job_name] = status\n+\n+    for test, result in new_workflow_summary.items():\n+        new_workflow_summary[test] = dict(sorted(result.items()))\n+    new_workflow_summary = dict(sorted(new_workflow_summary.items()))\n+\n+    with open(\"outputs/test_summary.json\", \"w\") as fp:\n+        json.dump(new_workflow_summary, fp, indent=4)"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 110,
        "deletions": 5
    }
}