{
    "author": "yonigozlan",
    "message": "Fix placeholders replacement logic in auto_docstring (#39433)\n\nFix and simplify placeholders replacement logic",
    "sha": "34133d0a790787739bfc9a42603985de3728ede4",
    "files": [
        {
            "sha": "11eb382bda990945caf12fb753e1d098f132e284",
            "filename": "src/transformers/utils/auto_docstring.py",
            "status": "modified",
            "additions": 18,
            "deletions": 22,
            "changes": 40,
            "blob_url": "https://github.com/huggingface/transformers/blob/34133d0a790787739bfc9a42603985de3728ede4/src%2Ftransformers%2Futils%2Fauto_docstring.py",
            "raw_url": "https://github.com/huggingface/transformers/raw/34133d0a790787739bfc9a42603985de3728ede4/src%2Ftransformers%2Futils%2Fauto_docstring.py",
            "contents_url": "https://api.github.com/repos/huggingface/transformers/contents/src%2Ftransformers%2Futils%2Fauto_docstring.py?ref=34133d0a790787739bfc9a42603985de3728ede4",
            "patch": "@@ -1145,37 +1145,34 @@ def get_placeholders_dict(placeholders: list, model_name: str) -> dict:\n             place_holder_value = getattr(\n                 getattr(auto_module, PLACEHOLDER_TO_AUTO_MODULE[placeholder][0]),\n                 PLACEHOLDER_TO_AUTO_MODULE[placeholder][1],\n-            )[model_name]\n-            if isinstance(place_holder_value, (list, tuple)):\n-                place_holder_value = place_holder_value[0]\n-            placeholders_dict[placeholder] = place_holder_value\n+            ).get(model_name, None)\n+            if place_holder_value is not None:\n+                if isinstance(place_holder_value, (list, tuple)):\n+                    place_holder_value = place_holder_value[0]\n+                placeholders_dict[placeholder] = place_holder_value\n+            else:\n+                placeholders_dict[placeholder] = placeholder\n \n     return placeholders_dict\n \n \n-def format_args_docstring(args, model_name):\n+def format_args_docstring(docstring, model_name):\n     \"\"\"\n     Replaces placeholders such as {image_processor_class} in the docstring with the actual values,\n     deducted from the model name and the auto modules.\n     \"\"\"\n-    # first check if there are any placeholders in the args, if not return them as is\n-    placeholders = set(re.findall(r\"{(.*?)}\", \"\".join(args[arg][\"description\"] for arg in args)))\n+    # first check if there are any placeholders in the docstring, if not return it as is\n+    placeholders = set(re.findall(r\"{(.*?)}\", docstring))\n     if not placeholders:\n-        return args\n+        return docstring\n \n     # get the placeholders dictionary for the given model name\n     placeholders_dict = get_placeholders_dict(placeholders, model_name)\n+    # replace the placeholders in the docstring with the values from the placeholders_dict\n+    for placeholder, value in placeholders_dict.items():\n+        docstring = docstring.replace(f\"{{{placeholder}}}\", value)\n \n-    # replace the placeholders in the args with the values from the placeholders_dict\n-    for arg in args:\n-        new_arg = args[arg][\"description\"]\n-        placeholders = re.findall(r\"{(.*?)}\", new_arg)\n-        placeholders = [placeholder for placeholder in placeholders if placeholder in placeholders_dict]\n-        if placeholders:\n-            new_arg = new_arg.format(**{placeholder: placeholders_dict[placeholder] for placeholder in placeholders})\n-        args[arg][\"description\"] = new_arg\n-\n-    return args\n+    return docstring\n \n \n def get_args_doc_from_source(args_classes: Union[object, list[object]]) -> dict:\n@@ -1494,8 +1491,6 @@ def _process_kwargs_parameters(\n             kwargs_documentation = kwarg_param.annotation.__args__[0].__doc__\n             if kwargs_documentation is not None:\n                 documented_kwargs, _ = parse_docstring(kwargs_documentation)\n-                if model_name_lowercase is not None:\n-                    documented_kwargs = format_args_docstring(documented_kwargs, model_name_lowercase)\n \n             # Process each kwarg parameter\n             for param_name, param_type_annotation in kwarg_param.annotation.__args__[0].__annotations__.items():\n@@ -1573,8 +1568,6 @@ def _process_parameters_section(\n     # Parse existing docstring if available\n     if func_documentation is not None:\n         documented_params, func_documentation = parse_docstring(func_documentation)\n-        if model_name_lowercase is not None:\n-            documented_params = format_args_docstring(documented_params, model_name_lowercase)\n \n     # Process regular parameters\n     param_docstring, missing_args = _process_regular_parameters(\n@@ -1772,6 +1765,9 @@ def auto_method_docstring(\n     )\n     docstring += example_docstring\n \n+    # Format the docstring with the placeholders\n+    docstring = format_args_docstring(docstring, model_name_lowercase)\n+\n     # Assign the dynamically generated docstring to the wrapper function\n     func.__doc__ = docstring\n     return func"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 18,
        "deletions": 22
    }
}