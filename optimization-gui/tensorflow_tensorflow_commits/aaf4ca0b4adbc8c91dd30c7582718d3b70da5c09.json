{
    "author": "beckerhe",
    "message": "Introduce TemporaryDirectory type\n\nThis is adding a small helper facility to TSL which allows us to conveniently create per-test-case temporary directories.\n\nPiperOrigin-RevId: 816746518",
    "sha": "aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09",
    "files": [
        {
            "sha": "7255cdc4e491a0e2bfc45daca7e8212798fdd9ac",
            "filename": "third_party/xla/xla/tsl/testing/BUILD",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2FBUILD?ref=aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09",
            "patch": "@@ -0,0 +1,44 @@\n+load(\n+    \"//xla/tsl/platform:build_config.bzl\",\n+    \"tsl_cc_test\",\n+)\n+load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = [\"//visibility:public\"],\n+    licenses = [\"notice\"],\n+)\n+\n+cc_library(\n+    name = \"temporary_directory\",\n+    testonly = True,\n+    srcs = [\"temporary_directory.cc\"],\n+    hdrs = [\"temporary_directory.h\"],\n+    deps = [\n+        \"//xla/tsl/platform:env\",\n+        \"//xla/tsl/platform:errors\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/utility\",\n+        \"@com_google_googletest//:gtest_for_library\",\n+        \"@local_tsl//tsl/platform:path\",\n+    ],\n+)\n+\n+tsl_cc_test(\n+    name = \"temporary_directory_test\",\n+    srcs = [\"temporary_directory_test.cc\"],\n+    deps = [\n+        \":temporary_directory\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:env\",\n+        \"//xla/tsl/platform:file_statistics\",\n+        \"//xla/tsl/platform:status_matchers\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)"
        },
        {
            "sha": "a4524fa78fdb9ded51308dd7386c3fa4dec07127",
            "filename": "third_party/xla/xla/tsl/testing/temporary_directory.cc",
            "status": "added",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory.cc?ref=aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09",
            "patch": "@@ -0,0 +1,70 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tsl/testing/temporary_directory.h\"\n+\n+#include <cstdint>\n+#include <string>\n+#include <utility>\n+\n+#include <gtest/gtest.h>\n+#include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"xla/tsl/platform/env.h\"\n+#include \"xla/tsl/platform/errors.h\"\n+#include \"tsl/platform/path.h\"\n+\n+namespace tsl {\n+namespace testing {\n+\n+absl::StatusOr<TemporaryDirectory> TemporaryDirectory::CreateForTestcase(\n+    const ::testing::TestInfo& test_info) {\n+  std::string path =\n+      tsl::io::JoinPath(::testing::TempDir(), \"xla_testing_tmp\",\n+                        test_info.test_suite_name(), test_info.name());\n+  TF_RETURN_IF_ERROR(tsl::Env::Default()->RecursivelyCreateDir(path));\n+  return TemporaryDirectory(std::move(path));\n+}\n+\n+absl::StatusOr<TemporaryDirectory>\n+TemporaryDirectory::CreateForCurrentTestcase() {\n+  auto unit_test = ::testing::UnitTest::GetInstance();\n+  if (unit_test->current_test_info() == nullptr) {\n+    return absl::FailedPreconditionError(\n+        \"No current test info. Are you calling this from a non-test \"\n+        \"environment?\");\n+  }\n+  return CreateForTestcase(*unit_test->current_test_info());\n+}\n+\n+void TemporaryDirectory::RecursiveFilepathDeleter::operator()(\n+    std::string* path) const {\n+  if (path == nullptr) {\n+    return;\n+  }\n+\n+  int64_t undeleted_files, undeleted_dirs;\n+  absl::Status status = tsl::Env::Default()->DeleteRecursively(\n+      *path, &undeleted_files, &undeleted_dirs);\n+  if (!status.ok()) {\n+    LOG(WARNING) << \"Failed to delete temporary directory \" << path << \": \"\n+                 << status;\n+  }\n+\n+  delete path;\n+}\n+}  // namespace testing\n+}  // namespace tsl"
        },
        {
            "sha": "da42ed36bbc87e45a916dd785f085adfd55d5fd4",
            "filename": "third_party/xla/xla/tsl/testing/temporary_directory.h",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory.h?ref=aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09",
            "patch": "@@ -0,0 +1,63 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_TSL_TESTING_TEMPORARY_DIRECTORY_H_\n+#define XLA_TSL_TESTING_TEMPORARY_DIRECTORY_H_\n+\n+#include <memory>\n+#include <string>\n+#include <utility>\n+\n+#include <gtest/gtest.h>\n+#include \"absl/status/statusor.h\"\n+\n+namespace tsl {\n+namespace testing {\n+\n+// Represents a temporary directory that is automatically deleted when this\n+// object is destroyed.\n+class TemporaryDirectory {\n+ public:\n+  // Creates a temporary directory unique to the given test case.\n+  static absl::StatusOr<TemporaryDirectory> CreateForTestcase(\n+      const ::testing::TestInfo& test_info);\n+\n+  // Creates a temporary directory unique to the current test case. Returns an\n+  // error if not called from a test.\n+  static absl::StatusOr<TemporaryDirectory> CreateForCurrentTestcase();\n+\n+  // Returns the path to the temporary directory.\n+  const std::string& path() const { return *path_; }\n+\n+ private:\n+  explicit TemporaryDirectory(std::string path)\n+      : path_(new std::string(std::move(path)), RecursiveFilepathDeleter()) {}\n+\n+  // A custom deleter that deletes the given directory recursively.\n+  struct RecursiveFilepathDeleter {\n+    void operator()(std::string* path) const;\n+  };\n+\n+  // We use a unique_ptr here to get move-only semantics without\n+  // having to implement the move constructor and assignment operator. This of\n+  // course introduces a double indirection, but this is a test-only class and\n+  // it significantly simplifies the implementation.\n+  std::unique_ptr<std::string, RecursiveFilepathDeleter> path_;\n+};\n+\n+}  // namespace testing\n+}  // namespace tsl\n+\n+#endif  // XLA_TSL_TESTING_TEMPORARY_DIRECTORY_H_"
        },
        {
            "sha": "0b10b312af53110986bde4ca12eda54c41879213",
            "filename": "third_party/xla/xla/tsl/testing/temporary_directory_test.cc",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Ftesting%2Ftemporary_directory_test.cc?ref=aaf4ca0b4adbc8c91dd30c7582718d3b70da5c09",
            "patch": "@@ -0,0 +1,52 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tsl/testing/temporary_directory.h\"\n+\n+#include <string>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/status/status.h\"\n+#include \"absl/status/status_matchers.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/env.h\"\n+#include \"xla/tsl/platform/file_statistics.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+\n+namespace tsl::testing {\n+namespace {\n+\n+TEST(TemporaryDirectoryTest, CreateForCurrentTestcase) {\n+  std::string path;\n+  {\n+    TF_ASSERT_OK_AND_ASSIGN(\n+        TemporaryDirectory temp_dir,\n+        TemporaryDirectory::CreateForTestcase(\n+            *::testing::UnitTest::GetInstance()->current_test_info()));\n+    path = temp_dir.path();\n+\n+    tsl::FileStatistics stat;\n+    TF_ASSERT_OK(tsl::Env::Default()->Stat(temp_dir.path(), &stat));\n+    EXPECT_TRUE(stat.is_directory);\n+  }\n+\n+  tsl::FileStatistics stat;\n+  EXPECT_THAT(tsl::Env::Default()->Stat(path, &stat),\n+              absl_testing::StatusIs(absl::StatusCode::kNotFound));\n+}\n+\n+}  // namespace\n+}  // namespace tsl::testing"
        }
    ],
    "stats": {
        "total": 229,
        "additions": 229,
        "deletions": 0
    }
}