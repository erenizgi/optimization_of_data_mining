{
    "author": "KanishAnand",
    "message": "Update mesh definition to better match it's use cases of querying tile index from device id's or vice-versa. Refactor into separate classes.\n\n#hloshardingv3\n\nPiperOrigin-RevId: 820154911",
    "sha": "b31aff76d2e79295a451e80b0e88d3ed0403e909",
    "files": [
        {
            "sha": "e6d8462d705e35a236afc7364508f6dfb718be71",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=b31aff76d2e79295a451e80b0e88d3ed0403e909",
            "patch": "@@ -60,6 +60,7 @@ cc_library(\n     deps = [\n         \":backend_config\",\n         \":hlo_sharding\",\n+        \":named_sharding\",\n         \":ptrvec\",\n         \":tile_assignment\",\n         \"//xla:array\",\n@@ -177,12 +178,31 @@ xla_cc_test(\n     ],\n )\n \n+cc_library(\n+    name = \"mesh_and_axis\",\n+    hdrs = [\"mesh_and_axis.h\"],\n+    deps = [\n+        \":tile_assignment\",\n+        \"@com_google_absl//absl/strings\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"named_sharding\",\n+    hdrs = [\"named_sharding.h\"],\n+    deps = [\n+        \":mesh_and_axis\",\n+        \"//xla:xla_data_proto_cc\",\n+    ],\n+)\n+\n cc_library(\n     name = \"hlo_sharding\",\n     srcs = [\"hlo_sharding.cc\"],\n     hdrs = [\"hlo_sharding.h\"],\n     deps = [\n         \":hlo_op_metadata\",\n+        \":named_sharding\",\n         \":tile_assignment\",\n         \"//xla:array\",\n         \"//xla:printer\","
        },
        {
            "sha": "f0c0c130e37bbbb41abe5bbb6eede12b06136e58",
            "filename": "third_party/xla/xla/hlo/ir/hlo_sharding.h",
            "status": "modified",
            "additions": 1,
            "deletions": 46,
            "changes": 47,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_sharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_sharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_sharding.h?ref=b31aff76d2e79295a451e80b0e88d3ed0403e909",
            "patch": "@@ -35,6 +35,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/array.h\"\n+#include \"xla/hlo/ir/named_sharding.h\"\n #include \"xla/hlo/ir/tile_assignment.h\"  // IWYU pragma: export\n #include \"xla/printer.h\"\n #include \"xla/shape.h\"\n@@ -53,52 +54,6 @@ class HloSharding {\n   static inline constexpr absl::string_view kShardingFrontendAttrName =\n       \"xla.sdy.sharding\";\n \n-  // C++ representation for corresponding proto types in `xla_data.proto` so\n-  // same documentation applies, except AxisRef elements are pointers to\n-  // `MeshAxis` elements instead of indices.\n-  //\n-  // TODO(b/449783607): Move mesh, axis to mesh_and_axis.h and move\n-  // NamedSharding out of HloSharding to match proto after change to using\n-  // mesh_and_axis.h. Currently simply moving this out will cause name\n-  // clashes with proto as they both use same xla namespace.\n-  struct MeshAxis {\n-    std::string name;\n-    int64_t size;\n-  };\n-\n-  struct Mesh {\n-    std::vector<MeshAxis> axes;\n-    std::vector<int64_t> device_ids;\n-  };\n-\n-  struct AxisRef {\n-    struct SubAxis {\n-      int64_t pre_size;\n-      int64_t size;\n-    };\n-\n-    const MeshAxis* axis;\n-    std::optional<SubAxis> sub_axis_info;\n-  };\n-\n-  // C++ representation for corresponding `OpSharding::NamedSharding` proto.\n-  //\n-  // TODO(b/450770542): Add corresponding IFTTT in attrs.td\n-  class NamedSharding {\n-    struct DimensionSharding {\n-      std::vector<AxisRef> axes;\n-      bool is_closed;\n-    };\n-\n-    std::vector<NamedSharding> tuple_shardings_;\n-\n-    Mesh mesh_;\n-    std::vector<DimensionSharding> dim_shardings_;\n-    std::vector<AxisRef> replicated_axes_;\n-    std::vector<AxisRef> unreduced_axes_;\n-    std::vector<OpMetadata> metadata_;\n-  };\n-\n   // Creates a trivial sharding that replicates a maximal tile across all\n   // devices.\n   static HloSharding Replicate(absl::Span<const OpMetadata> metadata = {}) {"
        },
        {
            "sha": "5e05c5d338bae285005e93ac76c56beac9829b08",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis.h",
            "status": "added",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h?ref=b31aff76d2e79295a451e80b0e88d3ed0403e909",
            "patch": "@@ -0,0 +1,66 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_HLO_IR_MESH_AND_AXIS_H_\n+#define XLA_HLO_IR_MESH_AND_AXIS_H_\n+\n+#include <cstdint>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+#include \"xla/hlo/ir/tile_assignment.h\"\n+\n+namespace xla {\n+\n+// C++ representation for corresponding `OpSharding::Mesh` proto so same\n+// documentation applies, except device assignment is represented in the array\n+// format instead of list of device ids to align with various array specific\n+// queries. Note that `TileAssignment` is used instead of `xla::Array` for\n+// optimized array representation in iota based cases which is the most common\n+// case.\n+//\n+// Example: device_assignment {{3, 0, 2}, {1, 4, 5}} with axes names\n+// {\"data\", \"model\"} represents a 2 * 3 mesh of 6 devices, with \"data\" axis of\n+// size 2 and \"model\" axis of size 3.\n+class Mesh {\n+ private:\n+  // Dimensions of the `device_assignment_` array correspond to the axes of the\n+  // mesh.\n+  TileAssignment device_assignment_;\n+  // Axes names correspond to names of axes represented by dimensions of\n+  // `device_assignment_`. Size of `axes_names_` should be equal to the number\n+  // of dimensions in the device_assignment_.\n+  std::vector<std::string> axes_names_;\n+};\n+\n+// C++ representation for corresponding `OpSharding::AxisRef`proto so same\n+// documentation applies.\n+class AxisRef {\n+ private:\n+  struct SubAxis {\n+    int64_t pre_size;\n+    int64_t size;\n+  };\n+\n+  // Index corresponding to axis in the mesh. It should be a valid index into\n+  // `mesh.axes_names_`.\n+  int64_t mesh_axis_index_;\n+  std::optional<SubAxis> sub_axis_info_;\n+};\n+\n+}  // namespace xla\n+\n+#endif  // XLA_HLO_IR_MESH_AND_AXIS_H_"
        },
        {
            "sha": "00931fff8a4b5133f01ba644812c5526d7dd2437",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding.h",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b31aff76d2e79295a451e80b0e88d3ed0403e909/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h?ref=b31aff76d2e79295a451e80b0e88d3ed0403e909",
            "patch": "@@ -0,0 +1,47 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_HLO_IR_NAMED_SHARDING_H_\n+#define XLA_HLO_IR_NAMED_SHARDING_H_\n+\n+#include <vector>\n+\n+#include \"xla/hlo/ir/mesh_and_axis.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+// C++ representation for corresponding `OpSharding::NamedSharding` proto so\n+// same documentation applies.\n+//\n+// TODO(b/450770542): Add corresponding IFTTT in attrs.td\n+class NamedSharding {\n+  struct DimensionSharding {\n+    std::vector<AxisRef> axes;\n+    bool is_closed;\n+  };\n+\n+  std::vector<NamedSharding> tuple_shardings_;\n+\n+  Mesh mesh_;\n+  std::vector<DimensionSharding> dim_shardings_;\n+  std::vector<AxisRef> replicated_axes_;\n+  std::vector<AxisRef> unreduced_axes_;\n+  std::vector<OpMetadata> metadata_;\n+};\n+\n+}  // namespace xla\n+\n+#endif  // XLA_HLO_IR_NAMED_SHARDING_H_"
        }
    ],
    "stats": {
        "total": 180,
        "additions": 134,
        "deletions": 46
    }
}