{
    "author": "deqiangc",
    "message": "Add tsl::internal::RecycleUnusedPort to complement PickUnusedPort.\n\nAdditionally, the default (non-Google) implementation of port management\nin tsl/platform/default/net.cc has been refactored. It now uses a thread-safe singleton\n(ChosenPorts) to track allocated ports. This resolves a pre-existing race condition in PickUnusedPort,\nwhich previously used a non-thread-safe static unordered_set.\n\nPiperOrigin-RevId: 830659491",
    "sha": "478f5c6d3d3810f7f61543e670819af7f2966cc5",
    "files": [
        {
            "sha": "cce8b6d43fa98374bfe1efc63983c2ab70d229d2",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/net.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fnet.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fnet.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fnet.h?ref=478f5c6d3d3810f7f61543e670819af7f2966cc5",
            "patch": "@@ -27,6 +27,16 @@ int PickUnusedPort();\n // that case, the error message is logged to FATAL.\n int PickUnusedPortOrDie();\n \n+// Relinquish a claim on the given port which was previously returned by\n+// PickUnusedPort[OrDie](). This allows PickUnusedPort[OrDie]() to return\n+// the given port to another caller in the future. Since the number of\n+// ports the portserver will give to a process is limited (typically 200),\n+// recycling ports after they are no longer needed can help avoid\n+// exhausting them. 'port' must be a positive number that was previously\n+// returned by PickUnusedPort[OrDie](), and not yet recycled, otherwise an\n+// abort may occur.\n+void RecycleUnusedPort(int port);\n+\n }  // namespace internal\n }  // namespace tsl\n "
        },
        {
            "sha": "0c4a88518f5ad0a166d4920b95d19bd983edd6fa",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/net_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fnet_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fnet_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fnet_test.cc?ref=478f5c6d3d3810f7f61543e670819af7f2966cc5",
            "patch": "@@ -31,5 +31,23 @@ TEST(Net, PickUnusedPortOrDie) {\n   CHECK_NE(port0, port1);\n }\n \n+TEST(Net, RecycleUnusedPort) {\n+  for (int i = 0; i < 1000; ++i) {\n+    int port0 = PickUnusedPortOrDie();\n+    CHECK_GE(port0, 0);\n+    CHECK_LT(port0, 65536);\n+    RecycleUnusedPort(port0);\n+  }\n+}\n+\n+TEST(Net, RecycleUnusedPortTwiceShallFail) {\n+  int port0 = PickUnusedPortOrDie();\n+  CHECK_GE(port0, 0);\n+  CHECK_LT(port0, 65536);\n+  RecycleUnusedPort(port0);\n+\n+  EXPECT_DEATH(RecycleUnusedPort(port0), \"\");\n+}\n+\n }  // namespace internal\n }  // namespace tsl"
        },
        {
            "sha": "3d13c218535bf85338927556454ccbc959241705",
            "filename": "third_party/xla/xla/tsl/platform/default/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD?ref=478f5c6d3d3810f7f61543e670819af7f2966cc5",
            "patch": "@@ -314,6 +314,8 @@ cc_library(\n     ],\n     deps = [\n         \"//xla/tsl/platform:logging\",\n+        \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/synchronization\",\n         \"@local_tsl//tsl/platform:strcat\",\n     ],\n     alwayslink = True,"
        },
        {
            "sha": "d8aa6aeef92120579647493a536b29d55240f17f",
            "filename": "third_party/xla/xla/tsl/platform/default/net.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 4,
            "changes": 53,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fnet.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/478f5c6d3d3810f7f61543e670819af7f2966cc5/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fnet.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fnet.cc?ref=478f5c6d3d3810f7f61543e670819af7f2966cc5",
            "patch": "@@ -26,6 +26,8 @@ limitations under the License.\n #include <random>\n #include <unordered_set>\n \n+#include \"absl/base/thread_annotations.h\"\n+#include \"absl/synchronization/mutex.h\"\n #include \"xla/tsl/platform/logging.h\"\n #include \"tsl/platform/strcat.h\"\n \n@@ -97,6 +99,40 @@ bool IsPortAvailable(int* port, bool is_tcp) {\n   return true;\n }\n \n+// Manages the set of ports that have been chosen by PickUnusedPort().\n+// This class is a singleton and is thread-safe.\n+class ChosenPorts {\n+ public:\n+  static ChosenPorts& GetChosenPorts() {\n+    static ChosenPorts chosen_ports;\n+    return chosen_ports;\n+  }\n+\n+  // Returns true if the port is in the chosen set.\n+  bool Contains(int port) {\n+    absl::MutexLock l(mu_);\n+    return ports_.count(port) > 0;\n+  }\n+\n+  // If the port is not in the chosen set, inserts it and returns true.\n+  // Otherwise, returns false.\n+  bool Insert(int port) {\n+    absl::MutexLock l(mu_);\n+    return ports_.insert(port).second;\n+  }\n+\n+  // Erases the port from the chosen set. Returns true if the port was present.\n+  bool Erase(int port) {\n+    absl::MutexLock l(mu_);\n+    return ports_.erase(port) > 0;\n+  }\n+\n+ private:\n+  ChosenPorts() = default;\n+  absl::Mutex mu_;\n+  std::unordered_set<int> ports_ ABSL_GUARDED_BY(mu_);\n+};\n+\n const int kNumRandomPortsToPick = 100;\n const int kMaximumTrials = 1000;\n \n@@ -109,7 +145,6 @@ int PickUnusedPortOrDie() {\n }\n \n int PickUnusedPort() {\n-  static std::unordered_set<int> chosen_ports;\n   // Type of port to first pick in the next iteration.\n   bool is_tcp = true;\n   int trial = 0;\n@@ -132,7 +167,7 @@ int PickUnusedPort() {\n       port = 0;\n     }\n \n-    if (chosen_ports.find(port) != chosen_ports.end()) {\n+    if (ChosenPorts::GetChosenPorts().Contains(port)) {\n       continue;\n     }\n     if (!IsPortAvailable(&port, is_tcp)) {\n@@ -146,12 +181,22 @@ int PickUnusedPort() {\n       continue;\n     }\n \n-    chosen_ports.insert(port);\n-    return port;\n+    if (ChosenPorts::GetChosenPorts().Insert(port)) {\n+      return port;\n+    }\n   }\n \n   return -1;\n }\n \n+void RecycleUnusedPort(int port) {\n+  if (port <= 0 || !ChosenPorts::GetChosenPorts().Erase(port)) {\n+    LOG(FATAL)\n+        << \"Port \" << port\n+        << \" is not a valid port to be recycled. It must be a positive \"\n+           \"number that was previously returned by PickUnusedPort[OrDie](), \"\n+           \"and not yet recycled.\";\n+  }\n+}\n }  // namespace internal\n }  // namespace tsl"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 79,
        "deletions": 4
    }
}