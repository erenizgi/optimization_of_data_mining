{
    "author": "ICGog",
    "message": "[XLA:CPU] Add run_id and device_ordinal to Thunk TraceMe\n\nPiperOrigin-RevId: 802674792",
    "sha": "d731081930d2d65e9f2530352a99794d1deb965a",
    "files": [
        {
            "sha": "4801d69499e782586cc7dd87324098bc144b6ee5",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.cc?ref=d731081930d2d65e9f2530352a99794d1deb965a",
            "patch": "@@ -175,11 +175,13 @@ Thunk::ExecuteSession::ExecuteSession(int64_t max_workers,\n       split_threshold_(split_threshold) {}\n \n // Encodes thunk info into the TraceMe compatible format.\n-std::string Thunk::TraceMeEncode() const {\n+std::string Thunk::TraceMeEncode(int64_t run_id, int64_t device_ordinal) const {\n   return tsl::profiler::TraceMeEncode(info_.op_name,\n                                       {{\"hlo_op\", info_.op_name},\n                                        {\"hlo_module\", info_.module_name},\n-                                       {\"program_id\", info_.module_id}});\n+                                       {\"program_id\", info_.module_id},\n+                                       {\"run_id\", run_id},\n+                                       {\"device_ordinal\", device_ordinal}});\n }\n \n std::ostream& operator<<(std::ostream& os, Thunk::Kind kind) {"
        },
        {
            "sha": "df4e276b19663ee52d24515bbb771ba56af985f4",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.h?ref=d731081930d2d65e9f2530352a99794d1deb965a",
            "patch": "@@ -277,6 +277,8 @@ class Thunk {\n     CollectiveExecuteParams* collective_params = nullptr;\n     CustomCallExecuteParams* custom_call_params = nullptr;\n     XnnParams* xnn_params = nullptr;\n+    int64_t run_id = -1;          // -1 means no run id is set.\n+    int64_t device_ordinal = -1;  // -1 means no device ordinal is set.\n     ExecuteSession session = ExecuteSession(ExecuteSession::kMaxWorkers,\n                                             ExecuteSession::kSplitThreshold);\n   };\n@@ -347,7 +349,7 @@ class Thunk {\n \n   // Encodes thunk info into the TraceMe compatible format. Used by\n   // ThunkExecutor to create TraceMe annotations for profiler.\n-  std::string TraceMeEncode() const;\n+  std::string TraceMeEncode(int64_t run_id, int64_t device_ordinal) const;\n \n   Kind kind_;\n   Info info_;"
        },
        {
            "sha": "00f8555ff4ea7600ac4fc778cfbf040a241dd77e",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_executor.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_executor.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_executor.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_executor.cc?ref=d731081930d2d65e9f2530352a99794d1deb965a",
            "patch": "@@ -225,8 +225,9 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> ThunkExecutor::TracedExecute(\n   }\n \n   // Create a producer traceme to capture the start event.\n-  tsl::profiler::TraceMeProducer producer([&] { return thunk.TraceMeEncode(); },\n-                                          tsl::profiler::ContextType::kGeneric);\n+  tsl::profiler::TraceMeProducer producer(\n+      [&] { return thunk.TraceMeEncode(params.run_id, params.device_ordinal); },\n+      tsl::profiler::ContextType::kGeneric);\n \n   auto execute_event = thunk.Execute(params);\n "
        },
        {
            "sha": "20c02351f5fc76e5e0800bb425faebbedcc9828b",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d731081930d2d65e9f2530352a99794d1deb965a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=d731081930d2d65e9f2530352a99794d1deb965a",
            "patch": "@@ -1575,7 +1575,10 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n           &task_runner,\n           &collective_params,\n           &custom_call_execute_params,\n-          xnn_params ? &*xnn_params : nullptr};\n+          xnn_params ? &*xnn_params : nullptr,\n+          run_options.run_id().ToInt(),\n+          run_options.device_ordinal(),\n+      };\n \n       thunks_execute_event = cpu_executable->thunks().Execute(execute_params);\n \n@@ -1710,7 +1713,10 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n                   &task_runner,\n                   &*collective_params,\n                   &*custom_call_params,\n-                  *xnn_params ? &**xnn_params : nullptr};\n+                  *xnn_params ? &**xnn_params : nullptr,\n+                  run_options.run_id().ToInt(),\n+                  run_options.device_ordinal(),\n+              };\n \n               auto thunks_execute_event =\n                   cpu_executable->thunks().Execute(execute_params);"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 18,
        "deletions": 7
    }
}