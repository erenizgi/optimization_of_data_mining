{
    "author": "dubstack",
    "message": "Attach DebugMeContext as a payload to XLA error statuses.\n\nPiperOrigin-RevId: 808351458",
    "sha": "779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
    "files": [
        {
            "sha": "4f58e6156aa1d65dfd9096fe29c240798b7f53e8",
            "filename": "third_party/xla/xla/errors/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferrors%2FBUILD?ref=779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
            "patch": "@@ -10,6 +10,7 @@ cc_library(\n     name = \"error_codes\",\n     hdrs = [\"error_codes.h\"],\n     deps = [\n+        \":debug_me_context_util\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:str_format\",\n@@ -20,7 +21,9 @@ xla_cc_test(\n     name = \"error_codes_test\",\n     srcs = [\"error_codes_test.cc\"],\n     deps = [\n+        \":debug_me_context_util\",\n         \":error_codes\",\n+        \"//xla/tsl/platform:debug_me_context\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n@@ -33,7 +36,9 @@ cc_library(\n     deps = [\n         \"//xla/hlo/pass:hlo_pass\",\n         \"//xla/tsl/platform:debug_me_context\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:cord\",\n     ],\n )\n "
        },
        {
            "sha": "a44ae68bdc92c5842873d9bb838a9dfab87f780b",
            "filename": "third_party/xla/xla/errors/debug_me_context_util.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Fdebug_me_context_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Fdebug_me_context_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferrors%2Fdebug_me_context_util.cc?ref=779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
            "patch": "@@ -18,14 +18,30 @@ limitations under the License.\n #include <string>\n #include <vector>\n \n+#include \"absl/status/status.h\"\n+#include \"absl/strings/cord.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_join.h\"\n #include \"xla/hlo/pass/hlo_pass_interface.h\"\n #include \"xla/tsl/platform/debug_me_context.h\"\n \n namespace xla::error {\n \n+void AttachDebugMeContextPayload(absl::Status& status) {\n+  if (!status.ok()) {\n+    std::string error_message_string = DebugMeContextToErrorMessageString();\n+    if (!error_message_string.empty()) {\n+      status.SetPayload(kDebugContextPayloadUrl,\n+                        absl::Cord(error_message_string));\n+    }\n+  }\n+}\n+\n std::string DebugMeContextToErrorMessageString() {\n+  if (!tsl::DebugMeContext<DebugMeContextKey>::HasAnyValues()) {\n+    return \"\";\n+  }\n+\n   std::string error_message = \"DebugMeContext:\\n\";\n   {\n     const std::vector<std::string> compiler_values ="
        },
        {
            "sha": "90c0a84e3ec274671ed6cecbb9a5389ab6202547",
            "filename": "third_party/xla/xla/errors/debug_me_context_util.h",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Fdebug_me_context_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Fdebug_me_context_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferrors%2Fdebug_me_context_util.h?ref=779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
            "patch": "@@ -16,8 +16,11 @@ limitations under the License.\n #ifndef XLA_ERRORS_DEBUG_ME_CONTEXT_UTIL_H_\n #define XLA_ERRORS_DEBUG_ME_CONTEXT_UTIL_H_\n \n+#include <cstdint>\n #include <string>\n \n+#include \"absl/status/status.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"xla/tsl/platform/debug_me_context.h\"\n \n // This file provides XLA-specific specializations and utilities for the\n@@ -37,7 +40,14 @@ class HloPassInterface;\n \n namespace error {\n \n-enum class DebugMeContextKey {\n+// The canonical type URL for the DebugContextPayload.\n+// This URL is used to attach the payload to an absl::Status.\n+constexpr absl::string_view kDebugContextPayloadUrl =\n+    \"types.googleapis.com/xla.errors.DebugContextPayload\";\n+\n+// Enumerate different types of debug context keys. These keys are used to\n+// identify the type of context being stored in the thread-local DebugMeContext.\n+enum class DebugMeContextKey : std::uint8_t {\n   kCompiler,\n   kHloPass,\n   kHloInstruction,\n@@ -48,6 +58,10 @@ enum class DebugMeContextKey {\n // XLA.\n std::string DebugMeContextToErrorMessageString();\n \n+// Attaches the DebugMeContextToErrorMessageString as a payload to the given\n+// status, if the context is not empty and the status is not OK.\n+void AttachDebugMeContextPayload(absl::Status& status);\n+\n // This class is a specialization of the RAII DebugMeContext specifically for\n // HloPasses. The details of its constructor dictate what information from the\n // HloPass is stored in the context."
        },
        {
            "sha": "396ada6e75ea13ad4206f95ff005445a24661b74",
            "filename": "third_party/xla/xla/errors/error_codes.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Ferror_codes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Ferror_codes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferrors%2Ferror_codes.h?ref=779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"xla/errors/debug_me_context_util.h\"\n \n namespace xla::error {\n \n@@ -154,10 +155,12 @@ inline std::string GetErrorUrl(ErrorCode code) {\n   template <typename... Args>                                            \\\n   inline absl::Status enum_name(const absl::FormatSpec<Args...>& format, \\\n                                 const Args&... args) {                   \\\n-    return absl::Status(                                                 \\\n+    auto status = absl::Status(                                          \\\n         status_code,                                                     \\\n         absl::StrCat(GetErrorCodeAndName(ErrorCode::k##enum_name), \": \", \\\n                      absl::StrFormat(format, args...)));                 \\\n+    error::AttachDebugMeContextPayload(status);                          \\\n+    return status;                                                       \\\n   }\n \n XLA_ERROR_CODE_LIST(DEFINE_ERROR_FACTORY_FUNCTION)"
        },
        {
            "sha": "f8f4053c1f177c98e3443400fd74311f0aed1d4a",
            "filename": "third_party/xla/xla/errors/error_codes_test.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Ferror_codes_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ferrors%2Ferror_codes_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferrors%2Ferror_codes_test.cc?ref=779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
            "patch": "@@ -17,12 +17,17 @@ limitations under the License.\n \n #include <string>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/status/status.h\"\n+#include \"xla/errors/debug_me_context_util.h\"\n+#include \"xla/tsl/platform/debug_me_context.h\"\n \n namespace xla::error {\n namespace {\n \n+using ::testing::HasSubstr;\n+\n // We will use kInvalidArgument for all single-value tests.\n constexpr ErrorCode kTestCode = ErrorCode::kInvalidArgument;\n \n@@ -59,5 +64,23 @@ TEST(ErrorCodesTest, FactoryFunction) {\n             \"E0002: InvalidArgument: Test error: Something was wrong\");\n }\n \n+TEST(ErrorCodesTest, FactoryFunctionNoDebugPayloadIfContextIsEmpty) {\n+  absl::Status status_no_context = InvalidArgument(\"Test error no context\");\n+  EXPECT_FALSE(\n+      status_no_context.GetPayload(kDebugContextPayloadUrl).has_value());\n+}\n+\n+TEST(ErrorCodesTest, FactoryFunctionAttachesDebugPayloadIfContextIsActive) {\n+  tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+                                                 \"MyTestPass\");\n+  absl::Status status_with_context = InvalidArgument(\"Test error with context\");\n+\n+  auto payload = status_with_context.GetPayload(kDebugContextPayloadUrl);\n+  EXPECT_TRUE(payload.has_value());\n+  std::string payload_str(payload.value());\n+  EXPECT_THAT(payload_str, HasSubstr(\"HLO Passes\"));\n+  EXPECT_THAT(payload_str, HasSubstr(\"MyTestPass\"));\n+}\n+\n }  // namespace\n }  // namespace xla::error"
        },
        {
            "sha": "281c0bc7d9b9a56aebf9d5080dbd2de3428e1cf1",
            "filename": "third_party/xla/xla/tsl/platform/debug_me_context.h",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdebug_me_context.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdebug_me_context.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdebug_me_context.h?ref=779bb1f88bb7fb8e6ad9f4e8ccc94beb2d022e79",
            "patch": "@@ -85,6 +85,9 @@ class DebugMeContext {\n     std::vector<std::string>& value_stack = context_.key_value_stack_map[key_];\n     value_stack.pop_back();\n   }\n+\n+  // Returns the values associated with the given key. If the key does not\n+  // exist, returns an empty vector.\n   static std::vector<std::string> GetValues(KeyType key) {\n     // Here we use a const reference of `context_` to try to minimize the chance\n     // of this function modifying `context_`.\n@@ -97,6 +100,18 @@ class DebugMeContext {\n     return it->second;\n   }\n \n+  // Returns true if any key has a non-empty stack.\n+  static bool HasAnyValues() {\n+    const Context& const_context = context_;\n+    for (const auto& pair : const_context.key_value_stack_map) {\n+      if (!pair.second.empty()) {\n+        return true;\n+      }\n+    }\n+\n+    return false;\n+  }\n+\n  private:\n   struct Context {\n     absl::flat_hash_map<KeyType, std::vector<std::string>> key_value_stack_map;"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 78,
        "deletions": 2
    }
}