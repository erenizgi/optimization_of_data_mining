{
    "author": "jparkerh",
    "message": "handle nullptr case in AsyncGpuBuffer\n\nThe cuda_event in the gpu buffer is defaulted to nullptr. However, if we populate this with nullptr (and the buffer that is being used to fulfill does not have nullptr) this leads to undefined behavior.\n\nPiperOrigin-RevId: 831477262",
    "sha": "1d029e30cae9f62c06593140a3d5cd130bca79bb",
    "files": [
        {
            "sha": "f10613f478ae49157d059f8fca2a3604f8faccfb",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1d029e30cae9f62c06593140a3d5cd130bca79bb/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1d029e30cae9f62c06593140a3d5cd130bca79bb/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc?ref=1d029e30cae9f62c06593140a3d5cd130bca79bb",
            "patch": "@@ -460,6 +460,13 @@ Future<> TfrtGpuBuffer::ToLiteralHelper(Future<MutableLiteralBase*> literal) {\n \n             auto d2h_stream = device->d2h_stream();\n \n+            // If we do not have a CudaEvent, we need to fall back to the host\n+            // event to check readiness.\n+            // TODO: Remove this once cuda events are always set/not nullptr.\n+            if (device_buffer->GetCudaEvent() == nullptr) {\n+              tsl::BlockUntilReady(device_buffer->ready_event());\n+            }\n+\n             absl::Status cuda_event_wait_status =\n                 WaitForEventOnStream(d2h_stream, device_buffer->GetCudaEvent());\n             if (!cuda_event_wait_status.ok()) {"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 7,
        "deletions": 0
    }
}