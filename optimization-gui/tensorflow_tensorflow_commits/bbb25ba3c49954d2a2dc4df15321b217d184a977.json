{
    "author": "nputikhin",
    "message": "[XLA:GPU] Make flop_per_ns_per_fpu a double in CalculateEffectiveFlopsPerNs\n\nOtherwise we were undercounting effective flops.\n\nExample for H100 at full occupancy:\n  fpu_count = n_active_core * n_active_fpus_per_core; // 132 * 128 = 16896\n  flop_per_ns_per_fpu = gpu_device_info.clock_rate_ghz() * /*fma:*/ 2; // (int)(1.98 * 2) = 3\n  peak_flops_per_ns = flop_per_ns_per_fpu * fpu_count; // 3 * 16896 = 50688\n\nIf we make it a float, we get clock_rate_ghz*2*fpu_count=1.98*2*16896=66908.16 which is 66.9 TFLOP/s we would expect for FP32 perf.\n\nPiperOrigin-RevId: 833277181",
    "sha": "bbb25ba3c49954d2a2dc4df15321b217d184a977",
    "files": [
        {
            "sha": "61a102b2b0290021cf10e62ae07cd8f843a8f05f",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_indexing_performance_model_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_indexing_performance_model_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_indexing_performance_model_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_indexing_performance_model_test.cc?ref=bbb25ba3c49954d2a2dc4df15321b217d184a977",
            "patch": "@@ -534,7 +534,7 @@ ENTRY main {\n           *fusion_adaptor, launch_dimensions, /*output_tile_sizes=*/{{1, 1}}));\n \n   EXPECT_NEAR(absl::ToDoubleSeconds(runtime_data.read_time), 2932, 2);\n-  EXPECT_NEAR(absl::ToDoubleSeconds(runtime_data.compute_time), 19, 1);\n+  EXPECT_NEAR(absl::ToDoubleSeconds(runtime_data.compute_time), 14, 1);\n   EXPECT_NEAR(absl::ToDoubleSeconds(runtime_data.exec_time), 2932, 2);\n }\n \n@@ -682,7 +682,7 @@ ENTRY main {\n                           indexing_cost_model_.EstimateRunTimeForTiledFusion(\n                               *fusion_adaptor, /*launch_dimensions=*/{1024, 8},\n                               /*output_tile_sizes=*/{{4, 4}}));\n-  EXPECT_NEAR(absl::ToDoubleMicroseconds(res1.exec_time), 412, 1);\n+  EXPECT_NEAR(absl::ToDoubleMicroseconds(res1.exec_time), 292, 1);\n \n   TF_ASSERT_OK_AND_ASSIGN(auto res2,\n                           indexing_cost_model_.EstimateRunTimeForTiledFusion("
        },
        {
            "sha": "1774373122fcc143d2ef663d615e83e088061f60",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_performance_model_base.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_base.cc?ref=bbb25ba3c49954d2a2dc4df15321b217d184a977",
            "patch": "@@ -346,7 +346,7 @@ int64_t GpuPerformanceModelBase::CalculateEffectiveFlopsPerNs(\n       std::min<int64_t>(num_blocks, gpu_device_info.core_count());\n   int64_t fpu_count = n_active_core * n_active_fpus_per_core;\n \n-  int64_t flop_per_ns_per_fpu = gpu_device_info.clock_rate_ghz() * /*fma:*/ 2;\n+  double flop_per_ns_per_fpu = gpu_device_info.clock_rate_ghz() * /*fma:*/ 2;\n   return flop_per_ns_per_fpu * fpu_count;\n }\n "
        },
        {
            "sha": "c1967332fe27d3bf441e47c0b3aeab395516e80e",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_performance_model_base_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_base_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_base_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_base_test.cc?ref=bbb25ba3c49954d2a2dc4df15321b217d184a977",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/service/gpu/model/gpu_performance_model_base.h\"\n \n+#include <cstdint>\n #include <memory>\n \n #include <gtest/gtest.h>\n@@ -318,6 +319,18 @@ ENTRY e {\n   EXPECT_EQ(launch_dimensions.num_threads_per_block(), 128);\n }\n \n+TEST_F(GpuPerformanceModelBaseTest,\n+       CalculateEffectiveFlopsPerNsForFullOccupancyH100) {\n+  se::DeviceDescription h100_device_info =\n+      TestGpuDeviceInfo::RTXH100SXMDeviceInfo();\n+  int64_t flops_per_ns = GpuPerformanceModelBase::CalculateEffectiveFlopsPerNs(\n+      h100_device_info, /*num_blocks=*/h100_device_info.core_count(),\n+      /*num_threads_per_block=*/h100_device_info.fpus_per_core());\n+  // H100 has a peak of 66.9 TFLOPS/s for TF32.\n+  EXPECT_GT(flops_per_ns, 66000);\n+  EXPECT_LT(flops_per_ns, 68000);\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "f58fd9181c19f7cb355229fd1f9be10afd315181",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_performance_model_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_performance_model_test.cc?ref=bbb25ba3c49954d2a2dc4df15321b217d184a977",
            "patch": "@@ -761,8 +761,8 @@ ENTRY entry_computation.1 {\n \n   auto t = gpu_performance_model_.EstimateRunTimesForMultiOutputFusion(\n       producer, consumer, &analysis_);\n-  EXPECT_NEAR(absl::ToInt64Milliseconds(t.time_unfused), 162, 1);\n-  EXPECT_NEAR(absl::ToInt64Milliseconds(t.time_fused), 145, 1);\n+  EXPECT_NEAR(absl::ToInt64Milliseconds(t.time_unfused), 120, 1);\n+  EXPECT_NEAR(absl::ToInt64Milliseconds(t.time_fused), 103, 1);\n }\n \n }  // namespace"
        },
        {
            "sha": "e66939cce1651d1b46c191f4765fe19d4ab4bcc5",
            "filename": "third_party/xla/xla/service/gpu/model/matmul_ptable_stats_collection_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_ptable_stats_collection_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bbb25ba3c49954d2a2dc4df15321b217d184a977/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_ptable_stats_collection_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_ptable_stats_collection_test.cc?ref=bbb25ba3c49954d2a2dc4df15321b217d184a977",
            "patch": "@@ -262,7 +262,7 @@ TEST_F(MatmulStatsCollectionTest,\n                   ->backend_config<GpuBackendConfig>()\n                   ->reification_cost(),\n               ElementsAre(Property(&ReificationCost::exec_time_us,\n-                                   DoubleNear(199, /*max_abs_error=*/1))));\n+                                   DoubleNear(141, /*max_abs_error=*/1))));\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 19,
        "deletions": 6
    }
}