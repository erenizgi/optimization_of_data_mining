{
    "author": "tensorflower-gardener",
    "message": "[Autotuner]Enable buffer checking by default in the autotuner.\n\n- In the Autotuner pass, check autotune_level to enable/disable buffer checking.\n\nPiperOrigin-RevId: 802491555",
    "sha": "713a2ddb7f5045caf5ca308d3da84b7cb76d1743",
    "files": [
        {
            "sha": "0b663c9955447e4b09a7b4d39aade1cc03755e28",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.h?ref=713a2ddb7f5045caf5ca308d3da84b7cb76d1743",
            "patch": "@@ -42,7 +42,7 @@ struct AutotuneConfig {\n   bool skip_failing_configs = true;\n   // Whether to check the correctness of the output buffers and OOM reads on\n   // Input Buffers.\n-  bool check_buffers = false;\n+  bool check_buffers = true;\n   // Relative tolerance for correctness check.\n   float relative_tolerance = 1e-6;\n   // Whether to crash the process on check failure."
        },
        {
            "sha": "0682f950f4e707c97c3c828e29f1b1f0bebec21b",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 24,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc?ref=713a2ddb7f5045caf5ca308d3da84b7cb76d1743",
            "patch": "@@ -68,6 +68,12 @@ std::unique_ptr<google::protobuf::Any> GetTestConfig(std::string name) {\n   return any;\n }\n \n+AutotuneConfig GetTestAutotuneConfig() {\n+  AutotuneConfig config;\n+  config.check_buffers = false;\n+  return config;\n+}\n+\n class MockCodegenBackend : public CodegenBackend {\n  public:\n   MOCK_METHOD(absl::string_view, name, (), (const, override));\n@@ -165,7 +171,7 @@ absl::StatusOr<std::unique_ptr<Autotuner>> SetupAutotunerWithExpectations(\n   std::vector<std::unique_ptr<CodegenBackend>> backends;\n   backends.push_back(std::move(backend));\n   return Autotuner::Create(std::move(backends), std::move(profiler),\n-                           AutotuneConfig(), std::move(cache_manager));\n+                           GetTestAutotuneConfig(), std::move(cache_manager));\n }\n \n constexpr absl::string_view kHlo = R\"(\n@@ -179,11 +185,15 @@ constexpr absl::string_view kHlo = R\"(\n   }\n   )\";\n \n-class AutotunerTest : public HloHardwareIndependentTestBase {};\n+class AutotunerTest : public HloHardwareIndependentTestBase {\n+ public:\n+  AutotunerTest() { config_ = GetTestAutotuneConfig(); }\n+  AutotuneConfig config_;\n+};\n \n TEST_F(AutotunerTest, NoCodegenBackend) {\n   auto device_description = CreateDummyDeviceDescription();\n-  auto autotuner = Autotuner::Create({}, nullptr, AutotuneConfig(),\n+  auto autotuner = Autotuner::Create({}, nullptr, config_,\n                                      std::make_unique<MockAutotunerCache>());\n   EXPECT_THAT(autotuner, StatusIs(absl::StatusCode::kInvalidArgument));\n }\n@@ -192,8 +202,8 @@ TEST_F(AutotunerTest, NoCacheManager) {\n   auto device_description = CreateDummyDeviceDescription();\n   std::vector<std::unique_ptr<CodegenBackend>> backends;\n   backends.push_back(std::make_unique<MockCodegenBackend>());\n-  auto autotuner = Autotuner::Create(std::move(backends), nullptr,\n-                                     AutotuneConfig(), nullptr);\n+  auto autotuner =\n+      Autotuner::Create(std::move(backends), nullptr, config_, nullptr);\n   EXPECT_THAT(autotuner, IsOk());\n }\n \n@@ -213,8 +223,8 @@ TEST_F(AutotunerTest, AutotuneButNoSupportedConfigs) {\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler),\n-                        AutotuneConfig(), std::move(cache_manager)));\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n+                        std::move(cache_manager)));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()),\n               absl_testing::StatusIs(absl::StatusCode::kInternal));\n@@ -241,8 +251,8 @@ TEST_F(AutotunerTest, AutotuneButNoCompiledConfigs) {\n   backends.push_back(std::move(backend));\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler),\n-                        AutotuneConfig(), std::move(cache_manager)));\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n+                        std::move(cache_manager)));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()),\n               absl_testing::StatusIs(absl::StatusCode::kInternal));\n@@ -280,8 +290,8 @@ TEST_F(AutotunerTest, AutotuneAppliesBestConfigAndSkipsNonCompilableConfig) {\n   backends.push_back(std::move(backend));\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler),\n-                        AutotuneConfig(), std::move(cache_manager)));\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n+                        std::move(cache_manager)));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()), absl_testing::IsOk());\n }\n@@ -318,9 +328,8 @@ TEST_F(AutotunerTest, AutotuneAppliesBestConfigUsingThreadPool) {\n   tsl::thread::ThreadPool thread_pool(tsl::Env::Default(), \"test\", 2);\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler),\n-                        AutotuneConfig(), std::move(cache_manager),\n-                        &thread_pool));\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n+                        std::move(cache_manager), &thread_pool));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()), absl_testing::IsOk());\n }\n@@ -333,7 +342,7 @@ TEST_F(AutotunerTest, AutotuneModuleFindsNoInstructionsToAutotune) {\n   auto device_description = CreateDummyDeviceDescription();\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), nullptr, AutotuneConfig(),\n+      Autotuner::Create(std::move(backends), nullptr, config_,\n                         std::make_unique<MockAutotunerCache>()));\n \n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n@@ -401,13 +410,15 @@ TEST_F(AutotunerTest, CacheHit) {\n   backends.push_back(std::move(backend));\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler),\n-                        AutotuneConfig(), std::move(cache_manager)));\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n+                        std::move(cache_manager)));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()), IsOk());\n }\n \n TEST_F(AutotunerTest, AutotuneWithBufferCheck) {\n+  config_.check_buffers = true;\n+\n   std::vector<std::unique_ptr<BackendConfig>> configs_1;\n   configs_1.push_back(GetTestConfig(\"test_config_1\"));\n   auto backend_1 = std::make_unique<MockCodegenBackend>();\n@@ -444,11 +455,9 @@ TEST_F(AutotunerTest, AutotuneWithBufferCheck) {\n   std::vector<std::unique_ptr<CodegenBackend>> backends;\n   backends.push_back(std::move(backend_1));\n   backends.push_back(std::move(backend_2));\n-  AutotuneConfig config;\n-  config.check_buffers = true;\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler), config,\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n                         std::make_unique<MockAutotunerCache>()));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()), IsOk());\n@@ -487,12 +496,11 @@ TEST_F(AutotunerTest, AutotuneWithScratchBytesOptimization) {\n \n   std::vector<std::unique_ptr<CodegenBackend>> backends;\n   backends.push_back(std::move(backend_1));\n-  AutotuneConfig config;\n-  config.optimize_scratch_bytes = true;\n-  config.scratch_bytes_window_size_us = 2;\n+  config_.optimize_scratch_bytes = true;\n+  config_.scratch_bytes_window_size_us = 2;\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner,\n-      Autotuner::Create(std::move(backends), std::move(profiler), config,\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n                         std::make_unique<MockAutotunerCache>()));\n   auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n   EXPECT_THAT(autotuner->Autotune(dummy_instr.get()), IsOk());"
        },
        {
            "sha": "d8984847035da02173bc9022e525834543f6afdd",
            "filename": "third_party/xla/xla/backends/cpu/autotuner/llvm_kernel_autotuner.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fautotuner%2Fllvm_kernel_autotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fautotuner%2Fllvm_kernel_autotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fautotuner%2Fllvm_kernel_autotuner.cc?ref=713a2ddb7f5045caf5ca308d3da84b7cb76d1743",
            "patch": "@@ -50,9 +50,11 @@ absl::StatusOr<bool> LlvmKernelAutotuner::Run(\n   std::vector<std::unique_ptr<CodegenBackend>> codegen_backends;\n   codegen_backends.push_back(std::move(backend));\n \n+  AutotuneConfig autotune_config;\n+  autotune_config.check_buffers = false;\n   TF_ASSIGN_OR_RETURN(std::unique_ptr<Autotuner> autotuner,\n                       Autotuner::Create(std::move(codegen_backends),\n-                                        std::move(profiler), AutotuneConfig(),\n+                                        std::move(profiler), autotune_config,\n                                         /*cache=*/nullptr));\n \n   bool hlo_changed = false;"
        },
        {
            "sha": "616cef2f81ff3249b302241f709c076c8832951e",
            "filename": "third_party/xla/xla/backends/gpu/autotuner/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2FBUILD?ref=713a2ddb7f5045caf5ca308d3da84b7cb76d1743",
            "patch": "@@ -759,5 +759,11 @@ xla_cc_binary(\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@local_tsl//tsl/platform:platform_port\",\n-    ] + if_cuda_is_configured([\":factory_cuda\"]) + if_rocm_is_configured([\":factory_rocm\"]),\n+    ] + if_cuda_is_configured([\n+        \":factory_cuda\",\n+        \"//xla/stream_executor/cuda:all_runtime\",\n+    ]) + if_rocm_is_configured([\n+        \":factory_rocm\",\n+        \"//xla/stream_executor/rocm:all_runtime\",\n+    ]),\n )"
        },
        {
            "sha": "36c51b15abb4527dbbfac63c70b850dcf3193971",
            "filename": "third_party/xla/xla/service/gpu/autotuning/autotuner_pass.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fautotuner_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/713a2ddb7f5045caf5ca308d3da84b7cb76d1743/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fautotuner_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fautotuner_pass.cc?ref=713a2ddb7f5045caf5ca308d3da84b7cb76d1743",
            "patch": "@@ -77,10 +77,17 @@ absl::StatusOr<std::unique_ptr<AutotunerPass>> AutotunerPass::Create(\n     TF_ASSIGN_OR_RETURN(cache, FileBasedAutotunerCache::Create(cache_config));\n   }\n \n+  AutotuneConfig autotune_config;\n+  autotune_config.check_buffers = debug_options.xla_gpu_autotune_level() >= 4;\n+  autotune_config.relative_tolerance =\n+      debug_options.xla_gpu_autotune_gemm_rtol();\n+  autotune_config.crash_on_check_failure =\n+      debug_options.xla_gpu_crash_on_verification_failures();\n+\n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<Autotuner> autotuner,\n       Autotuner::Create(std::move(backends), std::move(profiler),\n-                        AutotuneConfig(), std::move(cache), thread_pool));\n+                        autotune_config, std::move(cache), thread_pool));\n   return absl::WrapUnique(\n       new AutotunerPass(std::move(autotuner), should_autotune));\n }"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 51,
        "deletions": 28
    }
}