{
    "author": "tensorflower-gardener",
    "message": "Make the NormalizeTimestamps() for profiler lines more robust.\n\nPiperOrigin-RevId: 830632791",
    "sha": "dadc5bed611ac422fd361d09a1089ed8cc406eb7",
    "files": [
        {
            "sha": "0a1d0c850985082821b3653d261239fde5f5e37e",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_utils.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dadc5bed611ac422fd361d09a1089ed8cc406eb7/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dadc5bed611ac422fd361d09a1089ed8cc406eb7/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.cc?ref=dadc5bed611ac422fd361d09a1089ed8cc406eb7",
            "patch": "@@ -320,6 +320,18 @@ void NormalizeTimestamps(XPlane* plane, uint64_t start_time_ns) {\n   for (XLine& line : *plane->mutable_lines()) {\n     if (line.timestamp_ns() >= static_cast<int64_t>(start_time_ns)) {\n       line.set_timestamp_ns(line.timestamp_ns() - start_time_ns);\n+    } else {\n+      // When this happen, we suppose that the line.timestamp_ns() should\n+      // already be normalized, i.e., pretty small. Here use MAX_INT64 / 1000\n+      // to check, supposing when it convert to picosecond, it should not cause\n+      // overflow.\n+      if (line.timestamp_ns() >= std::numeric_limits<int64_t>::max() / 1000) {\n+        LOG(ERROR) << \"line.timestamp_ns() \" << line.timestamp_ns()\n+                   << \" is too large, which means the line.timestamp_ns() is \"\n+                      \"not normalized before, \"\n+                      \"and here it is normalized to some timestamp after it:\"\n+                   << start_time_ns;\n+      }\n     }\n   }\n }"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 12,
        "deletions": 0
    }
}