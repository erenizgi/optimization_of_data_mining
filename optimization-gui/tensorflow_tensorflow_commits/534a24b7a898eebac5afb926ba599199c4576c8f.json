{
    "author": "EusebioDM",
    "message": "Move `GpuConvConfig` creation to the `ConvolutionThunk` constructor\n\nTo (de)serialize this thunk, we'll be using the `GpuConvDescriptor` instead of the `GpuConvConfig`, since its easier to serialize (most of the config fields actually get populated during execution).\n\nSo we move the creation to the Thunk, so that in the next CL we can also store the descriptor to use for (de)serialisation. I didn't add the `GpuConvDescriptor descriptor_` field in this CL, since its technically not needed yet.\n\nPiperOrigin-RevId: 817523742",
    "sha": "534a24b7a898eebac5afb926ba599199c4576c8f",
    "files": [
        {
            "sha": "3f3957b109a6a767ac6ef5a1014e6fd8256f7209",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=534a24b7a898eebac5afb926ba599199c4576c8f",
            "patch": "@@ -525,7 +525,9 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n     ],"
        },
        {
            "sha": "4b3f9c9dfcd578cc5f8c3de7aaf976f497800e4d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/convolution_thunk.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_thunk.cc?ref=534a24b7a898eebac5afb926ba599199c4576c8f",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n \n #include \"absl/container/inlined_vector.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/memory/memory.h\"\n #include \"absl/status/status.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n@@ -46,6 +47,22 @@ limitations under the License.\n namespace xla {\n namespace gpu {\n \n+absl::StatusOr<std::unique_ptr<ConvolutionThunk>> ConvolutionThunk::Create(\n+    ThunkInfo thunk_info, GpuConvDescriptor descriptor,\n+    std::vector<BufferAllocation::Slice> operand_slices,\n+    std::vector<BufferAllocation::Slice> result_slices,\n+    BufferAllocation::Slice scratch_slice) {\n+  TF_ASSIGN_OR_RETURN(GpuConvConfig config,\n+                      GetGpuConvConfig(descriptor, /*inst_as_string=*/\"\"));\n+\n+  // Can't use std::make_unique because the constructor is private.\n+  return absl::WrapUnique(new ConvolutionThunk(\n+      thunk_info, std::move(config), std::move(operand_slices),\n+      std::move(result_slices), scratch_slice));\n+}\n+\n+// TODO: b/431980836 - Store the descriptor once when adding the\n+// (de)serialization methods.\n ConvolutionThunk::ConvolutionThunk(\n     ThunkInfo thunk_info, GpuConvConfig config,\n     std::vector<BufferAllocation::Slice> operand_slices,"
        },
        {
            "sha": "f78d5c0b431e513b5d691780f97156677d254f05",
            "filename": "third_party/xla/xla/backends/gpu/runtime/convolution_thunk.h",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_thunk.h?ref=534a24b7a898eebac5afb926ba599199c4576c8f",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n@@ -44,17 +45,23 @@ class ConvolutionThunk : public Thunk {\n   // Constructs a thunk for launching a DNN convolution.\n   //\n   // operand_slices should be in the same order as cudnn_call->operands().\n-  ConvolutionThunk(ThunkInfo thunk_info, GpuConvConfig config,\n-                   std::vector<BufferAllocation::Slice> operand_slices,\n-                   std::vector<BufferAllocation::Slice> result_slices,\n-                   BufferAllocation::Slice scratch_slice);\n+  static absl::StatusOr<std::unique_ptr<ConvolutionThunk>> Create(\n+      ThunkInfo thunk_info, GpuConvDescriptor descriptor,\n+      std::vector<BufferAllocation::Slice> operand_slices,\n+      std::vector<BufferAllocation::Slice> result_slices,\n+      BufferAllocation::Slice scratch_slice);\n \n   ConvolutionThunk(const ConvolutionThunk&) = delete;\n   ConvolutionThunk& operator=(const ConvolutionThunk&) = delete;\n \n   absl::Status ExecuteOnStream(const ExecuteParams& params) override;\n \n  private:\n+  ConvolutionThunk(ThunkInfo thunk_info, GpuConvConfig config,\n+                   std::vector<BufferAllocation::Slice> operand_slices,\n+                   std::vector<BufferAllocation::Slice> result_slices,\n+                   BufferAllocation::Slice scratch_slice);\n+\n   std::vector<BufferAllocation::Slice> operand_buffers_;\n   std::vector<BufferAllocation::Slice> result_buffers_;\n   BufferAllocation::Slice scratch_buffer_;"
        },
        {
            "sha": "83acda65146668d8553e6ff22b1c57c38ae24bce",
            "filename": "third_party/xla/xla/service/gpu/ir_emitter_unnested.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/534a24b7a898eebac5afb926ba599199c4576c8f/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc?ref=534a24b7a898eebac5afb926ba599199c4576c8f",
            "patch": "@@ -666,12 +666,13 @@ absl::Status IrEmitterUnnested::EmitConvolutionThunk(\n                                   instr->convolution_dimension_numbers(),\n                                   instr->feature_group_count()};\n \n-  TF_ASSIGN_OR_RETURN(GpuConvConfig config, GetGpuConvConfig(descriptor, \"\"));\n-  AddThunkToThunkSequence(std::make_unique<ConvolutionThunk>(\n-      Thunk::ThunkInfo::WithProfileAnnotation(\n-          instr, ir_emitter_context_->GetNextThunkId()),\n-      std::move(config), std::move(operand_slices), std::move(result_slices),\n-      scratch_slice));\n+  TF_ASSIGN_OR_RETURN(std::unique_ptr<ConvolutionThunk> thunk,\n+                      ConvolutionThunk::Create(\n+                          Thunk::ThunkInfo::WithProfileAnnotation(\n+                              instr, ir_emitter_context_->GetNextThunkId()),\n+                          std::move(descriptor), std::move(operand_slices),\n+                          std::move(result_slices), scratch_slice));\n+  AddThunkToThunkSequence(std::move(thunk));\n   return absl::OkStatus();\n }\n "
        }
    ],
    "stats": {
        "total": 47,
        "additions": 37,
        "deletions": 10
    }
}