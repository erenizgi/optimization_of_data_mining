{
    "author": "hyeontaek",
    "message": "[PJRT C] Implement `Executable::GetOutputLayouts()` in the PJRT Layouts extension\n\nThis change implements a native support for `xla::Executable::GetOutputLayouts()` in PJRT C API, when PJRT Layouts extension is available. This support does not fetch the optimized HLO, and thus this method becomes more reliable and fast.\n\nThis change strongly recommends the plugin that implemented the Layouts extension v2 to upgrade to v3 to avoid an incompatibility.\n\nPiperOrigin-RevId: 821834116",
    "sha": "67e5eafb2417e8706603ceba89f891eb391f453c",
    "files": [
        {
            "sha": "3f6b3ecd9b03ef373a38986ec62381cefa91b05e",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_layouts_extension.h",
            "status": "modified",
            "additions": 24,
            "deletions": 4,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_layouts_extension.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_layouts_extension.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_layouts_extension.h?ref=67e5eafb2417e8706603ceba89f891eb391f453c",
            "patch": "@@ -26,8 +26,9 @@ extern \"C\" {\n #endif\n \n // This extension provides capabilities around custom on-device memory layouts\n-// for PJRT_Buffers. The extension is both optional and experimental, meaning\n-// ABI-breaking and other incompatible changes may be introduced at any time.\n+// for PJRT_Buffers and PJRT_Executables. The extension is both optional and\n+// experimental, meaning ABI-breaking and other incompatible changes may be\n+// introduced at any time.\n //\n // If this extension is provided, JAX and possibly other frameworks will assume\n // that the compiler MLIR input can contain \"mhlo.layout_mode\" attributes on\n@@ -36,7 +37,7 @@ extern \"C\" {\n // https://github.com/openxla/xla/blob/main/xla/pjrt/layout_mode.h for more\n // details.\n \n-#define PJRT_API_LAYOUTS_EXTENSION_VERSION 2\n+#define PJRT_API_LAYOUTS_EXTENSION_VERSION 3\n \n // -------------------------------- Data types ---------------------------------\n \n@@ -124,6 +125,23 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args,\n typedef PJRT_Error* PJRT_Layouts_PJRT_Topology_GetDefaultLayout(\n     PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args* args);\n \n+// Returns output layouts for an executable.\n+struct PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args {\n+  size_t struct_size;\n+  PJRT_Extension_Base* extension_start;\n+  PJRT_Executable* executable;\n+  size_t num_outputs;  // out\n+  // Layout data is owned by and has the lifetime of `executable`.\n+  // Has length `num_outputs`.\n+  PJRT_Layouts_MemoryLayout** layouts;  // out\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args,\n+                          layouts);\n+\n+// Returns a list of layouts for executable outputs. Each output has a layout.\n+typedef PJRT_Error* PJRT_Layouts_PJRT_Executable_GetOutputLayouts(\n+    PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args* args);\n+\n // --------------------------- Extension entrypoint ----------------------------\n \n typedef struct PJRT_Layouts_Extension {\n@@ -136,9 +154,11 @@ typedef struct PJRT_Layouts_Extension {\n   PJRT_Layouts_PJRT_Buffer_MemoryLayout* PJRT_Layouts_PJRT_Buffer_MemoryLayout;\n   PJRT_Layouts_PJRT_Topology_GetDefaultLayout*\n       PJRT_Layouts_PJRT_Topology_GetDefaultLayout;\n+  PJRT_Layouts_PJRT_Executable_GetOutputLayouts*\n+      PJRT_Layouts_PJRT_Executable_GetOutputLayouts;\n } PJRT_Layouts_Extension;\n PJRT_DEFINE_STRUCT_TRAITS(PJRT_Layouts_Extension,\n-                          PJRT_Layouts_PJRT_Topology_GetDefaultLayout);\n+                          PJRT_Layouts_PJRT_Executable_GetOutputLayouts);\n \n #ifdef __cplusplus\n }"
        },
        {
            "sha": "8684f86d9c29459d072e44a30b60ddbd603b4794",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=67e5eafb2417e8706603ceba89f891eb391f453c",
            "patch": "@@ -219,6 +219,33 @@ static absl::Status EnsureExecutableOutputDimensionsPopulated(\n   return absl::OkStatus();\n }\n \n+static absl::Status PopulateExecutableOutputLayouts(\n+    PJRT_Executable* executable) {\n+  TF_ASSIGN_OR_RETURN(\n+      std::vector<std::shared_ptr<const xla::PjRtLayout>> cpp_out_layouts,\n+      executable->get()->GetOutputLayouts());\n+  executable->out_layouts.reserve(cpp_out_layouts.size());\n+  executable->out_layouts_pointers.reserve(cpp_out_layouts.size());\n+  for (std::shared_ptr<const xla::PjRtLayout>& layout : cpp_out_layouts) {\n+    executable->out_layouts.push_back(\n+        PJRT_Layouts_MemoryLayout{std::move(layout)});\n+  }\n+  for (PJRT_Layouts_MemoryLayout& layout : executable->out_layouts) {\n+    executable->out_layouts_pointers.push_back(&layout);\n+  }\n+  return absl::OkStatus();\n+}\n+\n+static absl::Status EnsureExecutableOutputLayoutsPopulated(\n+    PJRT_Executable* executable) {\n+  absl::MutexLock lock(executable->mutex);\n+  if (!executable->out_layouts_ran) {\n+    TF_RETURN_IF_ERROR(PopulateExecutableOutputLayouts(executable));\n+    executable->out_layouts_ran = true;\n+  }\n+  return absl::OkStatus();\n+}\n+\n static absl::Status PopulateExecutableOutputMemoryKinds(\n     PJRT_Executable* executable) {\n   TF_ASSIGN_OR_RETURN(\n@@ -2692,6 +2719,19 @@ PJRT_Error* PJRT_Layouts_PJRT_Topology_GetDefaultLayout(\n   return nullptr;\n }\n \n+PJRT_Error* PJRT_Layouts_PJRT_Executable_GetOutputLayouts(\n+    PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args* args) {\n+  PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n+      \"PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args\",\n+      PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args_STRUCT_SIZE,\n+      args->struct_size));\n+  PJRT_RETURN_IF_ERROR(\n+      EnsureExecutableOutputLayoutsPopulated(args->executable));\n+  args->num_outputs = args->executable->out_layouts_pointers.size();\n+  args->layouts = args->executable->out_layouts_pointers.data();\n+  return nullptr;\n+}\n+\n static std::vector<PJRT_NamedValue> PopulatePjrtAttributes(\n     const absl::flat_hash_map<std::string, xla::PjRtDeviceAttribute>&\n         attributes) {\n@@ -3106,6 +3146,8 @@ PJRT_Layouts_Extension CreateLayoutsExtension(PJRT_Extension_Base* next) {\n       pjrt::PJRT_Layouts_PJRT_Buffer_MemoryLayout,\n       /*PJRT_Layouts_PJRT_Topology_GetDefaultLayout=*/\n       &PJRT_Layouts_PJRT_Topology_GetDefaultLayout,\n+      /*PJRT_Layouts_PJRT_Executable_GetOutputLayouts=*/\n+      &PJRT_Layouts_PJRT_Executable_GetOutputLayouts,\n   };\n }\n "
        },
        {
            "sha": "387c8642694872a5057f4b5664dbfe7644d59edb",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h?ref=67e5eafb2417e8706603ceba89f891eb391f453c",
            "patch": "@@ -158,6 +158,10 @@ struct PJRT_Executable {\n   std::vector<int64_t> out_dimensions;\n   std::vector<size_t> out_dimension_sizes;\n \n+  bool out_layouts_ran ABSL_GUARDED_BY(mutex) = false;\n+  std::vector<PJRT_Layouts_MemoryLayout> out_layouts;\n+  std::vector<PJRT_Layouts_MemoryLayout*> out_layouts_pointers;\n+\n   explicit PJRT_Executable(std::shared_ptr<xla::PjRtExecutable> executable);\n   explicit PJRT_Executable(xla::PjRtExecutable* executable);\n "
        },
        {
            "sha": "00f2357beb4f03eb8c47a48c206793dacb73410b",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=67e5eafb2417e8706603ceba89f891eb391f453c",
            "patch": "@@ -1725,6 +1725,57 @@ PjRtCApiExecutable::GetOutputDimensions() const {\n   return std::vector<std::vector<DimensionVector>>{std::move(out)};\n }\n \n+absl::StatusOr<std::vector<std::shared_ptr<const PjRtLayout>>>\n+PjRtCApiExecutable::GetOutputLayouts() const {\n+  const PJRT_Api* c_api = pjrt_c_api();\n+  PJRT_Layouts_Extension* extension =\n+      pjrt::FindExtension<PJRT_Layouts_Extension>(\n+          c_api, PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n+  if (extension == nullptr ||\n+      extension->PJRT_Layouts_MemoryLayout_Serialize == nullptr ||\n+      extension->PJRT_Layouts_PJRT_Executable_GetOutputLayouts == nullptr) {\n+    // If we can't find PJRT_Layouts_PJRT_Executable_GetOutputLayouts support,\n+    // fall back to the default implementation.\n+    return this->PjRtExecutable::GetOutputLayouts();\n+  }\n+\n+  PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args args;\n+  args.struct_size =\n+      PJRT_Layouts_PJRT_Executable_GetOutputLayouts_Args_STRUCT_SIZE;\n+  args.extension_start = nullptr;\n+  args.executable = c_executable();\n+  RETURN_STATUS_IF_PJRT_ERROR(\n+      extension->PJRT_Layouts_PJRT_Executable_GetOutputLayouts(&args), c_api);\n+\n+  std::vector<std::shared_ptr<const PjRtLayout>> layouts;\n+  layouts.reserve(args.num_outputs);\n+  for (int i = 0; i < args.num_outputs; ++i) {\n+    // TODO(b/343274093): returns a PjRtLayout that wraps a C API layout\n+    // directly instead of de/serializing into an xla::Layout.\n+    PJRT_Layouts_MemoryLayout_Serialize_Args serialize_args;\n+    serialize_args.struct_size =\n+        PJRT_Layouts_MemoryLayout_Serialize_Args_STRUCT_SIZE;\n+    serialize_args.extension_start = nullptr;\n+    serialize_args.layout = args.layouts[i];\n+    pjrt::LogFatalIfPjrtError(\n+        extension->PJRT_Layouts_MemoryLayout_Serialize(&serialize_args), c_api);\n+\n+    // Clean up `PJRT_Layouts_SerializedLayout`.\n+    absl::Cleanup cleanup = [&serialize_args] {\n+      serialize_args.serialized_layout_deleter(\n+          serialize_args.serialized_layout);\n+    };\n+\n+    std::string serialized_layout(serialize_args.serialized_bytes,\n+                                  serialize_args.serialized_bytes_size);\n+    absl::StatusOr<std::shared_ptr<const PjRtLayout>> pjrt_layout =\n+        PjRtLayout::Deserialize(serialized_layout);\n+    TF_CHECK_OK(pjrt_layout.status());\n+    layouts.push_back(*std::move(pjrt_layout));\n+  }\n+  return layouts;\n+}\n+\n absl::StatusOr<std::vector<std::vector<absl::string_view>>>\n PjRtCApiExecutable::GetOutputMemoryKinds() const {\n   PJRT_Executable_OutputMemoryKinds_Args args;"
        },
        {
            "sha": "752457a89118bf774f57ff258af33278568ce72a",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/67e5eafb2417e8706603ceba89f891eb391f453c/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h?ref=67e5eafb2417e8706603ceba89f891eb391f453c",
            "patch": "@@ -590,6 +590,9 @@ class PjRtCApiExecutable : public PjRtExecutable {\n   absl::StatusOr<std::vector<std::vector<DimensionVector>>>\n   GetOutputDimensions() const override;\n \n+  absl::StatusOr<std::vector<std::shared_ptr<const PjRtLayout>>>\n+  GetOutputLayouts() const override;\n+\n   absl::StatusOr<std::vector<std::vector<absl::string_view>>>\n   GetOutputMemoryKinds() const override;\n \n@@ -671,6 +674,11 @@ class PjRtCApiLoadedExecutable : public PjRtLoadedExecutable {\n     return executable_->GetOutputDimensions();\n   }\n \n+  absl::StatusOr<std::vector<std::shared_ptr<const PjRtLayout>>>\n+  GetOutputLayouts() const override {\n+    return executable_->GetOutputLayouts();\n+  }\n+\n   absl::StatusOr<std::vector<std::vector<absl::string_view>>>\n   GetOutputMemoryKinds() const override {\n     return executable_->GetOutputMemoryKinds();"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 129,
        "deletions": 4
    }
}