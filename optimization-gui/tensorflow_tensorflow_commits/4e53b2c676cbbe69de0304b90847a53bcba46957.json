{
    "author": "tensorflower-gardener",
    "message": "Introduce option to deduplicate functions fully.\n\nThis change introduces `deduplicateFunctionsFully` option and the change is no-op.\n\nWhether to deduplicate functions fully, regardless of the input and output shardings of functions, and it keeps one function for each \"input function.\n\nThe default is false, meaning it will deduplicate only if the input and output shardings are the same.\n\nPiperOrigin-RevId: 808570941",
    "sha": "4e53b2c676cbbe69de0304b90847a53bcba46957",
    "files": [
        {
            "sha": "e0db1d1baf746b41cc78c8ef31de2e7e9677358c",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/export_named_computations.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.cc?ref=4e53b2c676cbbe69de0304b90847a53bcba46957",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include \"llvm/ADT/DenseMap.h\"\n #include \"llvm/ADT/STLExtras.h\"\n #include \"llvm/ADT/StringRef.h\"\n+#include \"llvm/Support/CommandLine.h\"\n #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n #include \"mlir/IR/Attributes.h\"\n #include \"mlir/IR/BuiltinAttributes.h\"\n@@ -131,6 +132,17 @@ class ExportNamedComputationsPass\n  public:\n   MLIR_DEFINE_EXPLICIT_INTERNAL_INLINE_TYPE_ID(ExportNamedComputationsPass)\n \n+  explicit ExportNamedComputationsPass(bool dedupFunctionsFully) {\n+    this->dedupFunctionsFully = dedupFunctionsFully;\n+  }\n+\n+  ExportNamedComputationsPass() = default;\n+\n+  explicit ExportNamedComputationsPass(\n+      const ExportNamedComputationsPass& other) {\n+    this->dedupFunctionsFully = other.dedupFunctionsFully;\n+  }\n+\n   llvm::SmallDenseMap<ComputationKey, StringAttr> funcCache;\n \n   void runOnOperation() final {\n@@ -187,16 +199,27 @@ class ExportNamedComputationsPass\n            \"`FuncOp` and `CallOp` have the same shardings as the original \"\n            \"`NamedComputationOp`s operands/results.\";\n   }\n+\n+  Option<bool> dedupFunctionsFully{\n+      *this, \"dedup-functions-fully\",\n+      llvm::cl::desc(\n+          \"Whether to deduplicate functions fully, regardless of the input and \"\n+          \"output shardings of functions, and it keeps one function for each \"\n+          \"input function. The default is false, meaning it will deduplicate \"\n+          \"only if the input and output shardings are the same. Not \"\n+          \"implemented yet.\"),\n+      llvm::cl::init(false)};\n };\n \n }  // namespace\n \n-std::unique_ptr<mlir::Pass> createExportNamedComputationsPass() {\n-  return std::make_unique<ExportNamedComputationsPass>();\n+std::unique_ptr<mlir::Pass> createExportNamedComputationsPass(\n+    bool dedupFunctionsFully) {\n+  return std::make_unique<ExportNamedComputationsPass>(dedupFunctionsFully);\n }\n \n void registerExportNamedComputationsPass() {\n-  mlir::registerPass(createExportNamedComputationsPass);\n+  mlir::registerPass(std::make_unique<ExportNamedComputationsPass>);\n }\n \n }  // namespace sdy"
        },
        {
            "sha": "693268ec3b8a1e66ea0eabf082c7135510d7b319",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/export_named_computations.h",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.h?ref=4e53b2c676cbbe69de0304b90847a53bcba46957",
            "patch": "@@ -28,9 +28,15 @@ namespace sdy {\n // and `CallOp` have the same shardings as the original `NamedComputationOp`s\n // operands/results.\n //\n-// If there is a function with the same name as the `NamedComputationOp` in the\n-// module, the MLIR symbol table will change it to `{name}_#`.\n-std::unique_ptr<mlir::Pass> createExportNamedComputationsPass();\n+// Deduplicates functions with the same input and output shardings if\n+// `deduplicateFunctionsFully` is false. Otherwise, it deduplicates functions of\n+// the same name regardless of their input and output shardings.\n+//\n+// Based on the deduplication logic as described, if there is a function with\n+// the same name as the `NamedComputationOp` in the module, the MLIR symbol\n+// table will change it to `{name}_#`.\n+std::unique_ptr<mlir::Pass> createExportNamedComputationsPass(\n+    bool dedupFunctionsFully);\n \n // Register the xla-sdy-export-named-computations pass.\n void registerExportNamedComputationsPass();"
        },
        {
            "sha": "def6596fb859f5ccfae445c245882677b87b69d9",
            "filename": "third_party/xla/xla/service/spmd/shardy/stablehlo_round_trip/stablehlo_export.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.cc?ref=4e53b2c676cbbe69de0304b90847a53bcba46957",
            "patch": "@@ -38,7 +38,7 @@ void addStablehloExportPipeline(\n   pm.addPass(createExportOpsPass(options.keepHloShardingConstraints));\n   pm.addPass(createStablehloRoundTripShardMapExportPass(\n       options.keepHloShardingConstraints));\n-  pm.addPass(createExportNamedComputationsPass());\n+  pm.addPass(createExportNamedComputationsPass(options.dedupFunctionsFully));\n   // If we don't add a sharding to a control flow op without one,\n   // StableHLO -> HLO conversion won't add a sharding for that op even if a\n   // free variable that has a sharding is lifted as an additional result, and in"
        },
        {
            "sha": "715b692a055fbea66e1c380f08e29e45ae37ad63",
            "filename": "third_party/xla/xla/service/spmd/shardy/stablehlo_round_trip/stablehlo_export.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4e53b2c676cbbe69de0304b90847a53bcba46957/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.h?ref=4e53b2c676cbbe69de0304b90847a53bcba46957",
            "patch": "@@ -33,6 +33,14 @@ struct StablehloExportPipelineOptions\n         \"calls - the HLO sharding constraint op. Else export \"\n         \"them to MHLO copy ops. By default, export to MHLO copy ops.\"),\n     llvm::cl::init(false)};\n+  Option<bool> dedupFunctionsFully{\n+      *this, \"dedup-functions-fully\",\n+      llvm::cl::desc(\n+          \"Whether to deduplicate functions fully, regardless of the input and \"\n+          \"output shardings of functions, and it keeps one function for each \"\n+          \"input function. The default is false, meaning it will deduplicate \"\n+          \"only if the input and output shardings are the same.\"),\n+      llvm::cl::init(false)};\n };\n \n // Register the xla-sdy-stablehlo-export-pipeline."
        }
    ],
    "stats": {
        "total": 51,
        "additions": 44,
        "deletions": 7
    }
}