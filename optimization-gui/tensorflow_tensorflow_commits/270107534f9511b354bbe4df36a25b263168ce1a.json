{
    "author": "WillFroom",
    "message": "[XLA:CPU] Set fast math flags on llvm module in fusion compiler.\n\nPiperOrigin-RevId: 803151298",
    "sha": "270107534f9511b354bbe4df36a25b263168ce1a",
    "files": [
        {
            "sha": "b51dc944b7840d3c22dd4bfdea6dc07443c0dc50",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_compiler.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc?ref=270107534f9511b354bbe4df36a25b263168ce1a",
            "patch": "@@ -28,8 +28,13 @@ limitations under the License.\n #include \"absl/strings/str_join.h\"\n #include \"absl/strings/string_view.h\"\n #include \"llvm/ADT/StringRef.h\"\n+#include \"llvm/IR/BasicBlock.h\"\n+#include \"llvm/IR/FMF.h\"\n+#include \"llvm/IR/Function.h\"\n+#include \"llvm/IR/Instruction.h\"\n #include \"llvm/IR/Metadata.h\"\n #include \"llvm/IR/Module.h\"\n+#include \"llvm/Support/Casting.h\"\n #include \"mlir/Conversion/AffineToStandard/AffineToStandard.h\"\n #include \"mlir/Conversion/ComplexToStandard/ComplexToStandard.h\"\n #include \"mlir/Conversion/MathToLLVM/MathToLLVM.h\"\n@@ -56,6 +61,7 @@ limitations under the License.\n #include \"mlir/IR/Visitors.h\"\n #include \"mlir/Pass/PassManager.h\"\n #include \"mlir/Support/LLVM.h\"\n+#include \"mlir/Support/WalkResult.h\"\n #include \"mlir/Target/LLVMIR/Dialect/Builtin/BuiltinToLLVMIRTranslation.h\"\n #include \"mlir/Target/LLVMIR/Dialect/LLVMIR/LLVMToLLVMIRTranslation.h\"\n #include \"mlir/Target/LLVMIR/Export.h\"\n@@ -200,6 +206,19 @@ static int GetLlvmFunctionDefCount(mlir::ModuleOp m) {\n   return count;\n };\n \n+static void ApplyFastMathFlags(llvm::Module& llvm_module,\n+                               const llvm::FastMathFlags& fast_math_flags) {\n+  for (llvm::Function& function : llvm_module) {\n+    for (llvm::BasicBlock& basic_block : function) {\n+      for (llvm::Instruction& instruction : basic_block) {\n+        if (llvm::isa<llvm::FPMathOperator>(instruction)) {\n+          instruction.setFastMathFlags(fast_math_flags);\n+        }\n+      }\n+    }\n+  }\n+}\n+\n FusionCompiler::FusionCompiler(mlir::MLIRContext* context, Options options,\n                                CompilationHooks hooks)\n     : options_(std::move(options)),\n@@ -298,6 +317,10 @@ absl::StatusOr<std::unique_ptr<llvm::Module>> FusionCompiler::Compile(\n \n   llvm_module->setDataLayout(llvm_module->getDataLayout());\n \n+  if (options_.fast_math_flags.any()) {\n+    ApplyFastMathFlags(*llvm_module, options_.fast_math_flags);\n+  }\n+\n   return llvm_module;\n }\n "
        },
        {
            "sha": "434a25bb634ed4ec549343d641e18458e897917f",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_compiler.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.h?ref=270107534f9511b354bbe4df36a25b263168ce1a",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n \n #include \"absl/functional/any_invocable.h\"\n #include \"absl/status/statusor.h\"\n+#include \"llvm/IR/FMF.h\"\n #include \"llvm/IR/LLVMContext.h\"\n #include \"llvm/IR/Module.h\"\n #include \"mlir/IR/BuiltinOps.h\"\n@@ -46,6 +47,7 @@ class FusionCompiler {\n     int32_t vector_width;\n     int32_t verification_level;\n     bool fast_min_max;\n+    llvm::FastMathFlags fast_math_flags;\n   };\n \n   FusionCompiler(mlir::MLIRContext* context, Options options,"
        },
        {
            "sha": "d772df146e08c49bcba405cd491b42957cd26ecc",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=270107534f9511b354bbe4df36a25b263168ce1a",
            "patch": "@@ -999,6 +999,7 @@ cc_library(\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service:hlo_proto_cc\",\n         \"//xla/service:pattern_matcher\",\n+        \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:logging\",\n@@ -2075,14 +2076,17 @@ xla_test(\n         \"//xla/backends/cpu/codegen:fusion_compiler\",\n         \"//xla/codegen:llvm_kernel_definition\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/testlib:filecheck\",\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n+        \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:threadpool_interface\",\n         \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@llvm-project//llvm:JITLink\",\n+        \"@llvm-project//llvm:ir_headers\",\n         \"@llvm-project//mlir:IR\",\n     ],\n )"
        },
        {
            "sha": "9abba57fce23c2ec4b303ff45f50e19f93f79888",
            "filename": "third_party/xla/xla/service/cpu/parallel_fusion_emitter_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter_test.cc?ref=270107534f9511b354bbe4df36a25b263168ce1a",
            "patch": "@@ -17,21 +17,26 @@ limitations under the License.\n \n #include <cstdint>\n #include <functional>\n+#include <string>\n #include <utility>\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/status/status_matchers.h\"\n #include \"absl/strings/string_view.h\"\n #include \"llvm/ExecutionEngine/Orc/ThreadSafeModule.h\"\n+#include \"llvm/IR/FMF.h\"\n+#include \"llvm/IR/Module.h\"\n #include \"mlir/IR/BuiltinOps.h\"\n #include \"xla/backends/cpu/codegen/fusion_compiler.h\"\n #include \"xla/codegen/llvm_kernel_definition.h\"\n #include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n+#include \"xla/hlo/testlib/filecheck.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n+#include \"xla/service/llvm_ir/llvm_util.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n@@ -61,6 +66,7 @@ FusionCompiler::Options CreateDefaultOptions() {\n   options.vector_width = 128;\n   options.verification_level = 1;\n   options.fast_min_max = false;\n+  options.fast_math_flags = llvm::FastMathFlags::getFast();\n \n   return options;\n }\n@@ -92,14 +98,14 @@ TEST_F(ParallelFusionEmitterTest, HappyPathSingleFusion) {\n   constexpr absl::string_view expected_name = \"root_fusion\";\n   constexpr absl::string_view trivial_fusion = R\"(\n     add1 {\n-      p = s32[] parameter(0)\n-      c = s32[] constant(1)\n-      ROOT a = s32[] add(p, c)\n+      p = f32[] parameter(0)\n+      c = f32[] constant(1)\n+      ROOT a = f32[] add(p, c)\n     }\n \n     ENTRY main {\n-      p = s32[] parameter(0)\n-      ROOT root_fusion = s32[] fusion(p), kind=kLoop, calls=add1\n+      p = f32[] parameter(0)\n+      ROOT root_fusion = f32[] fusion(p), kind=kLoop, calls=add1\n     })\";\n \n   TF_ASSERT_OK_AND_ASSIGN(auto hlo_module,\n@@ -122,10 +128,14 @@ TEST_F(ParallelFusionEmitterTest, HappyPathSingleFusion) {\n   auto [spec, source] = std::move(lowered_kernel).ReleaseStorage();\n   EXPECT_EQ(spec.name(), expected_name);\n \n-  llvm::orc::ThreadSafeModule llvm_module =\n+  llvm::orc::ThreadSafeModule thread_safe_llvm_module =\n       std::move(source).thread_safe_module();\n-  EXPECT_NE(llvm_module.getModuleUnlocked()->getFunction(expected_name),\n-            nullptr);\n+  llvm::Module* llvm_module = thread_safe_llvm_module.getModuleUnlocked();\n+  EXPECT_NE(llvm_module->getFunction(expected_name), nullptr);\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      bool passed,\n+      RunFileCheck(llvm_ir::DumpToString(*llvm_module), \"CHECK: fadd fast\"));\n+  EXPECT_TRUE(passed);\n }\n \n TEST_F(ParallelFusionEmitterTest, FusionsAreSorted) {"
        },
        {
            "sha": "fdcfd7d7b5de445945ad4d5e55bbdc4fb12a946b",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/270107534f9511b354bbe4df36a25b263168ce1a/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc?ref=270107534f9511b354bbe4df36a25b263168ce1a",
            "patch": "@@ -103,6 +103,7 @@ limitations under the License.\n #include \"xla/service/dump.h\"\n #include \"xla/service/hlo.pb.h\"\n #include \"xla/service/hlo_module_config.h\"\n+#include \"xla/service/llvm_ir/llvm_util.h\"\n #include \"xla/service/pattern_matcher.h\"\n #include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n@@ -258,7 +259,8 @@ static FusionCompiler::Options FusionCompilerOptions(\n   return FusionCompiler::Options{\n       debug_options.xla_cpu_prefer_vector_width(),\n       debug_options.xla_cpu_emitter_verification_level(),\n-      debug_options.xla_cpu_enable_fast_min_max()};\n+      debug_options.xla_cpu_enable_fast_min_max(),\n+      llvm_ir::GetCpuFastMathFlags(config)};\n }\n \n static FusionCompiler FusionCompilerFactory(mlir::MLIRContext* context,"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 50,
        "deletions": 9
    }
}