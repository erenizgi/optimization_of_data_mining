{
    "author": "ezhulenev",
    "message": "[xla:pjrt:cpu] Add e2e test for YnnFusion + PJRT client\n\nPiperOrigin-RevId: 826323865",
    "sha": "d90723f48e638e25235099a2950a174ee5f99f7f",
    "files": [
        {
            "sha": "3231118d475adf5c32aae98e634c855c1859bd00",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client_test.cc",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d90723f48e638e25235099a2950a174ee5f99f7f/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d90723f48e638e25235099a2950a174ee5f99f7f/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc?ref=d90723f48e638e25235099a2950a174ee5f99f7f",
            "patch": "@@ -1033,6 +1033,46 @@ TEST(PjRtCpuClientTest, CustomAllocator) {\n   EXPECT_THAT(data, ElementsAreArray(literal.data<float>()));\n }\n \n+TEST(PjRtCpuClientTest, SerializeYnnFusions) {\n+  constexpr absl::string_view kProgram = R\"(\n+    HloModule add_and_multiply\n+\n+    ynn_fusion {\n+      %lhs = f32[4] parameter(0)\n+      %rhs = f32[4] parameter(1)\n+      %add = f32[4] add(%lhs, %rhs)\n+      ROOT %mul = f32[4] multiply(%add, %add)\n+    }\n+\n+    ENTRY entry {\n+      %p0 = f32[4] parameter(0)\n+      %p1 = f32[4] parameter(1)\n+      ROOT %fusion = f32[4] fusion(%p0, %p1), kind=kCustom, calls=ynn_fusion,\n+        backend_config={\"fusion_config\": {kind: \"__ynn_fusion\"}}\n+    })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto client, GetPjRtCpuClient(CpuClientOptions()));\n+  TF_ASSERT_OK_AND_ASSIGN(auto m, ParseAndReturnUnverifiedModule(kProgram, {}));\n+\n+  XlaComputation xla_computation(m->ToProto());\n+  TF_ASSERT_OK_AND_ASSIGN(auto executable,\n+                          client->CompileAndLoad(xla_computation, {}));\n+\n+  Literal literal = LiteralUtil::CreateR1<float>({1.0f, 2.0f, 3.0f, 4.0f});\n+  TF_ASSERT_OK_AND_ASSIGN(auto buf, client->BufferFromHostLiteral(\n+                                        literal, client->memory_spaces()[0]));\n+\n+  ExecuteOptions opts;\n+  auto result =\n+      executable->Execute(/*argument_handles=*/{{buf.get(), buf.get()}}, opts);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<xla::Literal> result_literal,\n+                          result->at(0).at(0)->ToLiteralSync());\n+  EXPECT_TRUE(LiteralTestUtil::Equal(\n+      LiteralUtil::CreateR1<float>({4.0f, 16.0f, 36.0f, 64.0f}),\n+      *result_literal));\n+}\n+\n }  // namespace\n \n //===----------------------------------------------------------------------===//"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 40,
        "deletions": 0
    }
}