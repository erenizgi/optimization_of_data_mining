{
    "author": "nvgrw",
    "message": "Fix replicated execution defaults in HloRunnerPjRt.\n\nPiperOrigin-RevId: 843293521",
    "sha": "adc9ab4117fe1ebdc85964c2c7e141e0088f4035",
    "files": [
        {
            "sha": "a18e1b9660700f5b94a5a66b73ef0c1c4b099146",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/adc9ab4117fe1ebdc85964c2c7e141e0088f4035/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/adc9ab4117fe1ebdc85964c2c7e141e0088f4035/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=adc9ab4117fe1ebdc85964c2c7e141e0088f4035",
            "patch": "@@ -4536,6 +4536,7 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/log:die_if_null\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\","
        },
        {
            "sha": "40d43d98357280204849f0af6b0f1f40cfed6896",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/adc9ab4117fe1ebdc85964c2c7e141e0088f4035/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/adc9ab4117fe1ebdc85964c2c7e141e0088f4035/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc?ref=adc9ab4117fe1ebdc85964c2c7e141e0088f4035",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include \"absl/algorithm/container.h\"\n #include \"absl/base/nullability.h\"\n #include \"absl/functional/any_invocable.h\"\n+#include \"absl/log/check.h\"\n #include \"absl/log/die_if_null.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n@@ -560,12 +561,9 @@ absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicated(\n     std::unique_ptr<HloModule> module,\n     const HloRunnerInterface::ReplicatedExecuteOptions& options,\n     DeviceAssignment* device_assignment) {\n-  module->mutable_config().set_replica_count(options.num_devices);\n-\n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<OpaqueExecutable> executable,\n       CreateExecutable(std::move(module), options.run_hlo_passes));\n-\n   return ExecuteReplicated(executable.get(), options, device_assignment);\n }\n \n@@ -603,8 +601,13 @@ absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicated(\n     absl::AnyInvocable<const Literal*(int64_t, int64_t)> argument_provider,\n     const HloRunnerInterface::ReplicatedExecuteOptions& options,\n     DeviceAssignment* device_assignment) {\n-  TF_RET_CHECK(device_assignment->computation_count() == 1)\n-      << \"Only single-computation execution is supported.\";\n+  std::optional<DeviceAssignment> default_device_assignment = std::nullopt;\n+  if (device_assignment == nullptr) {\n+    TF_ASSIGN_OR_RETURN(default_device_assignment,\n+                        GetDefaultDeviceAssignment(options.num_devices, 1));\n+    device_assignment = &*default_device_assignment;\n+  }\n+  CHECK_NE(device_assignment, nullptr);\n   return ExecuteReplicatedImpl(\n       [&](absl::Span<const std::vector<PjRtBuffer*>> argument_buffer_slices,\n           absl::AnyInvocable<OpaqueExecutable*(int64_t)>"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 9,
        "deletions": 5
    }
}