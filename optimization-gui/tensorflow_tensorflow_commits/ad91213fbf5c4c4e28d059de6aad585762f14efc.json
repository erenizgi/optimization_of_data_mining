{
    "author": "ezhulenev",
    "message": "[xla:ffi] Move CPU FFI implementation to backends/cpu\n\nMove backend-specific FFI context decoding to CPU backends to avoid bringing all of the dependencies to default FFI target. Moving out GPU FFI is in the followup change.\n\nPiperOrigin-RevId: 837267569",
    "sha": "ad91213fbf5c4c4e28d059de6aad585762f14efc",
    "files": [
        {
            "sha": "2157066d84e2ff299967098c12b708103831ad39",
            "filename": "third_party/xla/xla/backends/cpu/BUILD",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2FBUILD?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -60,6 +60,18 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"ffi\",\n+    hdrs = [\"ffi.h\"],\n+    visibility = [\"//visibility:public\"],\n+    deps = [\n+        \"//xla/ffi\",\n+        \"//xla/ffi/api:c_api\",\n+        \"//xla/ffi/api:c_api_internal\",\n+        \"@com_google_absl//absl/base:core_headers\",\n+    ],\n+)\n+\n onednn_graph_cc_library(\n     name = \"onednn_emitter\",\n     srcs = [\"onednn_emitter.cc\"],"
        },
        {
            "sha": "3866e1659429644853374083dc27a1c0b1a68d34",
            "filename": "third_party/xla/xla/backends/cpu/ffi.h",
            "status": "added",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fffi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fffi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fffi.h?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -0,0 +1,66 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_BACKENDS_CPU_FFI_H_\n+#define XLA_BACKENDS_CPU_FFI_H_\n+\n+#include <optional>\n+\n+#include \"absl/base/optimization.h\"\n+#include \"xla/ffi/api/c_api.h\"\n+#include \"xla/ffi/api/c_api_internal.h\"  // IWYU pragma: keep\n+#include \"xla/ffi/ffi.h\"  // IWYU pragma: export\n+\n+namespace Eigen {\n+struct ThreadPoolDevice;\n+}  // namespace Eigen\n+\n+namespace xla::ffi {\n+\n+//===----------------------------------------------------------------------===//\n+// Type tags to bind parameters passed via execution context to FFI handler\n+//===----------------------------------------------------------------------===//\n+\n+struct IntraOpThreadPool {};  // binds `const Eigen::ThreadPoolDevice*`\n+\n+//===----------------------------------------------------------------------===//\n+// Context decoding\n+//===----------------------------------------------------------------------===//\n+\n+template <>\n+struct CtxDecoding<IntraOpThreadPool> {\n+  using Type = const Eigen::ThreadPoolDevice*;\n+\n+  static std::optional<Type> Decode(const XLA_FFI_Api* api,\n+                                    XLA_FFI_ExecutionContext* ctx,\n+                                    DiagnosticEngine& diagnostic) {\n+    void* thread_pool = nullptr;\n+    if (XLA_FFI_Error* error =\n+            api->internal_api->XLA_FFI_INTERNAL_IntraOpThreadPool_Get(\n+                ctx, &thread_pool);\n+        ABSL_PREDICT_FALSE(error)) {\n+      diagnostic.Emit(\"Failed to get intra op thread pool: \")\n+          << internal::GetErrorMessage(api, error);\n+      internal::DestroyError(api, error);\n+      return std::nullopt;\n+    }\n+\n+    return reinterpret_cast<Type>(thread_pool);\n+  }\n+};\n+\n+}  // namespace xla::ffi\n+\n+#endif  // XLA_BACKENDS_CPU_FFI_H_"
        },
        {
            "sha": "d01b1fc6ddd1754dee7eb6f751bcee6cce573706",
            "filename": "third_party/xla/xla/core/host_offloading/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2FBUILD?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -244,6 +244,7 @@ strict_cc_test(\n         \"//xla:shape_tree\",\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/backends/cpu:ffi\",\n         \"//xla/backends/cpu/nanort:nanort_client\",\n         \"//xla/backends/cpu/nanort:nanort_executable\",\n         \"//xla/ffi\","
        },
        {
            "sha": "6ef9f2e426faaacd9454f13d8fee84774798859c",
            "filename": "third_party/xla/xla/core/host_offloading/host_offloading_executable_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2Fhost_offloading_executable_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2Fhost_offloading_executable_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2Fhost_offloading_executable_test.cc?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n+#include \"xla/backends/cpu/ffi.h\"\n #include \"xla/backends/cpu/nanort/nanort_client.h\"\n #include \"xla/backends/cpu/nanort/nanort_executable.h\"\n #include \"xla/core/host_offloading/host_offloading_buffer.h\""
        },
        {
            "sha": "c3049b9615de6971079173c54110b8ac55f0dcf6",
            "filename": "third_party/xla/xla/ffi/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fffi%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fffi%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2FBUILD?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -7,10 +7,15 @@ package(\n     default_visibility = [\"//visibility:public\"],\n )\n \n+package_group(\n+    name = \"ffi_internal\",\n+    packages = [\"//xla/backends/cpu\"],\n+)\n+\n cc_library(\n     name = \"api\",\n     hdrs = [\"//xla/ffi/api:api_headers\"],\n-    visibility = [\"//visibility:private\"],\n+    visibility = [\":ffi_internal\"],\n     deps = [\n         \"//xla/ffi/api:c_api\",\n         \"@com_google_absl//absl/strings:string_view\",\n@@ -286,6 +291,7 @@ xla_cc_test(\n         \":type_registry\",\n         \"//xla:executable_run_options\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/backends/cpu:ffi\",\n         \"//xla/ffi/api:c_api\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:stream\","
        },
        {
            "sha": "6721031853a405c28eaa0b122cbce563ee05ecf3",
            "filename": "third_party/xla/xla/ffi/ffi.h",
            "status": "modified",
            "additions": 0,
            "deletions": 23,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fffi%2Fffi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fffi%2Fffi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fffi.h?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -68,7 +68,6 @@ struct DeviceOrdinal {};      // binds `int32_t` with device ordinal\n struct Allocator {};          // binds `se::DeviceMemoryAllocator*`\n struct ScratchAllocator {};   // binds `se::OwningScratchAllocator`\n struct CalledComputation {};  // binds `HloComputation*`\n-struct IntraOpThreadPool {};  // binds `const Eigen::ThreadPoolDevice*`\n \n template <typename T>\n struct PlatformStream {};  // binds a platform stream, e.g. `cudaStream_t`\n@@ -636,28 +635,6 @@ struct CtxDecoding<CalledComputation> {\n   }\n };\n \n-template <>\n-struct CtxDecoding<IntraOpThreadPool> {\n-  using Type = const Eigen::ThreadPoolDevice*;\n-\n-  static std::optional<Type> Decode(const XLA_FFI_Api* api,\n-                                    XLA_FFI_ExecutionContext* ctx,\n-                                    DiagnosticEngine& diagnostic) {\n-    void* thread_pool = nullptr;\n-    if (XLA_FFI_Error* error =\n-            api->internal_api->XLA_FFI_INTERNAL_IntraOpThreadPool_Get(\n-                ctx, &thread_pool);\n-        ABSL_PREDICT_FALSE(error)) {\n-      diagnostic.Emit(\"Failed to get intra op thread pool: \")\n-          << internal::GetErrorMessage(api, error);\n-      internal::DestroyError(api, error);\n-      return std::nullopt;\n-    }\n-\n-    return reinterpret_cast<Type>(thread_pool);\n-  }\n-};\n-\n template <typename T>\n struct CtxDecoding<PlatformStream<T>> {\n   using Type = T;"
        },
        {
            "sha": "741598d17afbf2a12fb48c052545f2a37ab4e2cc",
            "filename": "third_party/xla/xla/ffi/ffi_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fffi%2Fffi_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Fffi%2Fffi_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fffi_test.cc?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -33,6 +33,7 @@ limitations under the License.\n #include \"absl/strings/match.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n+#include \"xla/backends/cpu/ffi.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/ffi/api/c_api.h\"\n #include \"xla/ffi/attribute_map.h\""
        },
        {
            "sha": "9b01d3bccad7de6a610ab9197229705e98d4d401",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -2338,6 +2338,7 @@ xla_test(\n         \"//xla:literal_util\",\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/backends/cpu:ffi\",\n         \"//xla/client:client_library\",\n         \"//xla/client:local_client\",\n         \"//xla/ffi\","
        },
        {
            "sha": "676b5e287c7aba4699ab8f9da4718250a61453df",
            "filename": "third_party/xla/xla/tests/custom_call_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Ftests%2Fcustom_call_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad91213fbf5c4c4e28d059de6aad585762f14efc/third_party%2Fxla%2Fxla%2Ftests%2Fcustom_call_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcustom_call_test.cc?ref=ad91213fbf5c4c4e28d059de6aad585762f14efc",
            "patch": "@@ -36,6 +36,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"xla/array2d.h\"\n #include \"xla/array3d.h\"\n+#include \"xla/backends/cpu/ffi.h\"\n #include \"xla/client/client_library.h\"\n #include \"xla/client/local_client.h\"\n #include \"xla/executable_run_options.h\"\n@@ -227,7 +228,6 @@ TEST_F(CustomCallTest, CustomCallR2F32Reduce) {\n   LiteralTestUtil::ExpectR0Near<float>(10.0f, result, kDefaultErrorSpec);\n }\n \n-\n class CustomCallClientAPITest\n     : public ClientLibraryTestRunnerMixin<\n           HloPjRtInterpreterReferenceMixin<HloPjRtTestBase>> {};"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 90,
        "deletions": 25
    }
}