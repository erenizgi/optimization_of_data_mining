{
    "author": "penpornk",
    "message": "[xla:cpu] Fix bug in DotLibraryRewriter when merging library fusions.\n\nPiperOrigin-RevId: 799358956",
    "sha": "ca924e07d47b6f3c96a1dd07693eaefa76223f9c",
    "files": [
        {
            "sha": "2e2e364d6e6cc17363ff4a05a5879393b09b9eb8",
            "filename": "third_party/xla/xla/backends/cpu/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD?ref=ca924e07d47b6f3c96a1dd07693eaefa76223f9c",
            "patch": "@@ -56,6 +56,7 @@ xla_cc_test(\n         \"//xla/hlo/utils:hlo_query\",\n         \"//xla/tests:xla_internal_test_main\",\n         \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/base:no_destructor\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/strings\","
        },
        {
            "sha": "9a349bc5224eb19d9e76439da4ae8458b071269a",
            "filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.cc?ref=ca924e07d47b6f3c96a1dd07693eaefa76223f9c",
            "patch": "@@ -199,19 +199,24 @@ void DotLibraryRewriter::AddFusionCandidates(\n   }\n }\n \n-absl::Status DotLibraryRewriter::MergeFusionInstructions(\n-    HloFusionInstruction* main, HloFusionInstruction* neighbor,\n-    FusionDirection dir) {\n+absl::StatusOr<HloFusionInstruction*>\n+DotLibraryRewriter::MergeFusionInstructions(HloFusionInstruction* main,\n+                                            HloFusionInstruction* neighbor,\n+                                            FusionDirection dir) {\n   VLOG(3) << \"  \" << FusionDirectionToString(dir)\n           << \": Fusing with: \" << neighbor->ToString();\n   if (dir == FusionDirection::kUp) {\n     main->MergeFusionInstruction(neighbor);\n     TF_RETURN_IF_ERROR(main->parent()->RemoveInstruction(neighbor));\n-  } else if (dir == FusionDirection::kDown) {\n+    return main;\n+  }\n+  if (dir == FusionDirection::kDown) {\n     neighbor->MergeFusionInstruction(main);\n     TF_RETURN_IF_ERROR(neighbor->parent()->RemoveInstruction(main));\n+    return neighbor;\n   }\n-  return absl::OkStatus();\n+  return InvalidArgument(\"Invalid fusion direction: %s\",\n+                         FusionDirectionToString(dir));\n }\n \n absl::StatusOr<HloInstruction*> DotLibraryRewriter::GrowFusion(\n@@ -246,15 +251,17 @@ absl::Status DotLibraryRewriter::FuseNeighbors(HloFusionInstruction* fusion,\n     auto [instr, dir] = frontier.front();\n     frontier.pop();\n     if (dir != FusionDirection::kUp && dir != FusionDirection::kDown) {\n-      return InvalidArgument(\"Invalid travel direction: %c\", dir);\n+      return InvalidArgument(\"Invalid travel direction: %s\",\n+                             FusionDirectionToString(dir));\n     }\n \n     // If `instr` is another fusion of the same library type, fuse it.\n     // We don't need to add its neighbors to the frontier because anything that\n     // can be fused would have already been fused into `instr`.\n     if (IsCustomFusionWithKind(instr, lib->fusion_kind())) {\n-      TF_RETURN_IF_ERROR(MergeFusionInstructions(\n-          fusion, Cast<HloFusionInstruction>(instr), dir));\n+      TF_ASSIGN_OR_RETURN(fusion,\n+                          MergeFusionInstructions(\n+                              fusion, Cast<HloFusionInstruction>(instr), dir));\n       continue;\n     }\n "
        },
        {
            "sha": "c92670049ab7117a97b543ef1ebfc0aceb95fbcb",
            "filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.h?ref=ca924e07d47b6f3c96a1dd07693eaefa76223f9c",
            "patch": "@@ -94,9 +94,9 @@ class DotLibraryRewriter : public HloModulePass {\n   // Merges two fusions `main` and `neighbor` together. `main` is the current\n   // fusion instruction we are growing. `neighbor` is a neighboring fusion node\n   // found through BFS from `main`.\n-  absl::Status MergeFusionInstructions(HloFusionInstruction* main,\n-                                       HloFusionInstruction* neighbor,\n-                                       FusionDirection dir);\n+  absl::StatusOr<HloFusionInstruction*> MergeFusionInstructions(\n+      HloFusionInstruction* main, HloFusionInstruction* neighbor,\n+      FusionDirection dir);\n \n   // Fuses `to_fuse` into the fusion `fusion` based on the specified direction.\n   // Returns the pointer to the new `to_fuse` node in the fusion region."
        },
        {
            "sha": "180b1ec647743876b023214de23f85cc06c4b0dd",
            "filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter_test.cc",
            "status": "modified",
            "additions": 46,
            "deletions": 8,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca924e07d47b6f3c96a1dd07693eaefa76223f9c/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter_test.cc?ref=ca924e07d47b6f3c96a1dd07693eaefa76223f9c",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n #include <vector>\n \n #include <gtest/gtest.h>\n+#include \"absl/base/no_destructor.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/log/log.h\"\n #include \"absl/strings/match.h\"\n@@ -61,6 +62,12 @@ class CpuLibraryTest : public TargetMachineTestBase {\n     bool changed;\n   };\n \n+  static const DotRewriteTestSpec& GetDefaultTestSpec() {\n+    static const absl::NoDestructor<DotRewriteTestSpec> kDefaultTestSpec(\n+        {\"xnn\", \"f32\", \"f32\", \"znver3\", \"+avx,+avx2\", \"dot\"});\n+    return *kDefaultTestSpec;\n+  }\n+\n   virtual void RunTest(absl::string_view hlo_template,\n                        FusionProperties expected) {}\n \n@@ -399,21 +406,16 @@ class CpuLibraryFusionTypeTest\n       public ::testing::WithParamInterface<std::string> {\n  public:\n   static std::string Name(const ::testing::TestParamInfo<std::string>& info) {\n-    return absl::StrCat(kLib, \"_\", info.param, \"_\", kDType, \"_\", kCpuName);\n+    return info.param;\n   }\n \n  protected:\n   void RunTest(absl::string_view hlo_template,\n                FusionProperties expected) override {\n-    DotRewriteTestSpec spec = {std::string(kLib),      std::string(kDType),\n-                               std::string(kDType),    std::string(kCpuName),\n-                               std::string(kFeatures), GetParam()};\n+    DotRewriteTestSpec spec = GetDefaultTestSpec();\n+    spec.fusion_mode = GetParam();\n     RunTestInternal(spec, hlo_template, expected);\n   }\n-  static constexpr absl::string_view kLib = \"xnn\";\n-  static constexpr absl::string_view kDType = \"f32\";\n-  static constexpr absl::string_view kCpuName = \"znver3\";\n-  static constexpr absl::string_view kFeatures = \"+avx,+avx2\";\n };\n \n TEST_P(CpuLibraryFusionTypeTest, AllEltwiseFusion) {\n@@ -521,5 +523,41 @@ INSTANTIATE_TEST_SUITE_P(CpuLibraryFusionTypeTestSuite,\n                                               std::string(\"greedy\")}),\n                          CpuLibraryFusionTypeTest::Name);\n \n+TEST_F(CpuLibraryTest, UpdateFusion) {\n+  //                      c\n+  //                       \\\n+  //   b ------------------ dot2\n+  //    \\                       \\\n+  // a -- sub1 -- add1 -- dot1 -- add2\n+  //\n+  // In \"dot\" mode, `dot2` + `add2` get fused first (call this `fusion2`). Then\n+  // `dot1` will create a new fusion (`fusion1`), fuse with `add1, and try to\n+  // fuse with `fusion2`. Since fusions are merged by updating the consumer\n+  // fusion, `fusion1` will get absorbed into `fusion2`. When we continue\n+  // growing the fusion around `dot1`, we need to use `fusion2` instead of\n+  // `fusion1`. This test will fail if the old `fusion1` is used (`sub1` will\n+  // not recognize `fusion1` as its user).\n+  const absl::string_view hlo_template = R\"(\n+    HloModule matmul\n+\n+    ENTRY %main {\n+      %a = $in_dtype[64,64] parameter(0)\n+      %b = $in_dtype[64,64] parameter(1)\n+      %c = $in_dtype[64,64] parameter(2)\n+      %sub1 = $in_dtype[64,64] subtract(%a, %b)\n+      %add1 = $in_dtype[64,64] add(%a, %sub1)\n+      %dot1 = $in_dtype[64,64] dot(%add1, %b), lhs_contracting_dims={1},\n+                                            rhs_contracting_dims={0}\n+      %dot2 = $in_dtype[64,64] dot(%b, %c), lhs_contracting_dims={1},\n+                                            rhs_contracting_dims={0}\n+      ROOT %add2 = $in_dtype[64,64] add(%dot1, %dot2)\n+    })\";\n+\n+  DotRewriteTestSpec spec = GetDefaultTestSpec();\n+  spec.fusion_mode = \"dot\";\n+  RunTestInternal(spec, hlo_template,\n+                  FusionProperties{HloOpcode::kAdd, 3, 8, true});\n+}\n+\n }  // namespace\n }  // namespace xla::cpu"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 65,
        "deletions": 19
    }
}