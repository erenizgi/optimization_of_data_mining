{
    "author": "akuegel",
    "message": "Unify testing for dfs_hlo_visitor.\n\nThe test in the service directory was probably forgotten to be moved to the new\nlocation of the source files. Recently, a new test has been added in the new\nlocation. This change moves the existing test to the new test file.\n\nPiperOrigin-RevId: 809924019",
    "sha": "a18d7b42f18990cbe3e8838d64e37acd7ff10c73",
    "files": [
        {
            "sha": "e77baf28e08f309e828a611d4c7fcbd23050a986",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a18d7b42f18990cbe3e8838d64e37acd7ff10c73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a18d7b42f18990cbe3e8838d64e37acd7ff10c73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=a18d7b42f18990cbe3e8838d64e37acd7ff10c73",
            "patch": "@@ -410,6 +410,8 @@ xla_cc_test(\n     deps = [\n         \":hlo\",\n         \"//xla:literal_util\",\n+        \"//xla:status_macros\",\n+        \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/service:hlo_module_config\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:test\","
        },
        {
            "sha": "6de980221fbf00b8616910ab556a66ae829be689",
            "filename": "third_party/xla/xla/hlo/ir/dfs_hlo_visitor_test.cc",
            "status": "modified",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a18d7b42f18990cbe3e8838d64e37acd7ff10c73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a18d7b42f18990cbe3e8838d64e37acd7ff10c73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_test.cc?ref=a18d7b42f18990cbe3e8838d64e37acd7ff10c73",
            "patch": "@@ -15,24 +15,84 @@\n #include \"xla/hlo/ir/dfs_hlo_visitor.h\"\n \n #include <memory>\n+#include <string>\n #include <utility>\n #include <vector>\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/status/status.h\"\n #include \"xla/hlo/ir/dfs_hlo_visitor_with_default.h\"\n+#include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/service/hlo_module_config.h\"\n+#include \"xla/status_macros.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/test.h\"\n \n namespace xla {\n namespace {\n \n using ::testing::ElementsAre;\n+using DfsHloVisitorWithDefaultTest = HloHardwareIndependentTestBase;\n+\n+TEST_F(DfsHloVisitorWithDefaultTest, DefaultElementwiseTest) {\n+  // Verify that HandleElementwiseBinary and HandleElementwiseUnary are called\n+  // on the appropriate HLO ops (elementwise binary/unary ops).\n+\n+  class ElementwiseTestVisitor : public DfsHloVisitorWithDefault {\n+   public:\n+    absl::Status DefaultAction(HloInstruction* hlo) override {\n+      // The HLO should be neither an elementwise unary nor binary op. These\n+      // cases are handled in HandleElementwiseBinary/Unary.\n+      TF_RET_CHECK(!(hlo->IsElementwise() && hlo->operand_count() == 2))\n+          << hlo->ToString();\n+      TF_RET_CHECK(!(hlo->IsElementwise() && hlo->operand_count() == 1))\n+          << hlo->ToString();\n+      return absl::OkStatus();\n+    }\n+\n+    absl::Status HandleElementwiseBinary(HloInstruction* hlo) override {\n+      // HLO should be elementwise binary.\n+      TF_RET_CHECK(hlo->IsElementwise() && hlo->operand_count() == 2)\n+          << hlo->ToString();\n+      return absl::OkStatus();\n+    }\n+    absl::Status HandleElementwiseUnary(HloInstruction* hlo) override {\n+      // HLO should be elementwise unary.\n+      TF_RET_CHECK(hlo->IsElementwise() && hlo->operand_count() == 1)\n+          << hlo->ToString();\n+      return absl::OkStatus();\n+    }\n+  };\n+\n+  // HLO module contains are arbitrary mix of elementwise and non-elementwise\n+  // operations.\n+  const std::string& hlo_string = R\"(\n+HloModule TestModule\n+\n+ENTRY TestComputation {\n+  arg = f32[] parameter(0)\n+  tuple = (f32[]) tuple(arg)\n+  gte = f32[] get-tuple-element(tuple), index=0\n+  abs = f32[] abs(arg)\n+  add = f32[] add(arg, gte)\n+  broadcast = f32[42] broadcast(add), dimensions={}\n+  slice = f32[1] slice(broadcast), slice={[1:2]}\n+  copy = f32[] copy(arg)\n+  eq = pred[] compare(arg, gte), direction=EQ\n+  neg = f32[] negate(arg)\n+  ROOT convert = f64[] convert(f32[] arg)\n+})\";\n+  std::unique_ptr<HloModule> module =\n+      ParseAndReturnVerifiedModule(hlo_string).value();\n+  ElementwiseTestVisitor visitor;\n+  TF_EXPECT_OK(module->entry_computation()->Accept(&visitor));\n+}\n \n TEST(FilteredDfsHloVisitorTest, FiltersInstructions) {\n   // Create a module with a few instructions."
        },
        {
            "sha": "1d13ddc29f5144b4cfb84244ce6ebdb89be375ac",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a18d7b42f18990cbe3e8838d64e37acd7ff10c73/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a18d7b42f18990cbe3e8838d64e37acd7ff10c73/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=a18d7b42f18990cbe3e8838d64e37acd7ff10c73",
            "patch": "@@ -784,20 +784,6 @@ xla_test(\n     ],\n )\n \n-xla_cc_test(\n-    name = \"dfs_hlo_visitor_with_default_test\",\n-    srcs = [\"dfs_hlo_visitor_with_default_test.cc\"],\n-    deps = [\n-        \":hlo_runner\",\n-        \"//xla:shape_util\",\n-        \"//xla/hlo/ir:hlo\",\n-        \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n-        \"//xla/hlo/testlib:test\",\n-        \"//xla/tests:xla_internal_test_main\",\n-        \"//xla/tsl/lib/core:status_test_util\",\n-    ],\n-)\n-\n cc_library(\n     name = \"pattern_matcher\",\n     hdrs = [\"pattern_matcher.h\"],"
        },
        {
            "sha": "f948ff4e5adf5296bba608a8cdc775b04bd6af7e",
            "filename": "third_party/xla/xla/service/dfs_hlo_visitor_with_default_test.cc",
            "status": "removed",
            "additions": 0,
            "deletions": 88,
            "changes": 88,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb63f665b4b17d6e84f11eca0e1636fc94ca4271/third_party%2Fxla%2Fxla%2Fservice%2Fdfs_hlo_visitor_with_default_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb63f665b4b17d6e84f11eca0e1636fc94ca4271/third_party%2Fxla%2Fxla%2Fservice%2Fdfs_hlo_visitor_with_default_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdfs_hlo_visitor_with_default_test.cc?ref=cb63f665b4b17d6e84f11eca0e1636fc94ca4271",
            "patch": "@@ -1,88 +0,0 @@\n-/* Copyright 2017 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#include \"xla/hlo/ir/dfs_hlo_visitor_with_default.h\"\n-\n-#include \"xla/hlo/ir/hlo_computation.h\"\n-#include \"xla/hlo/ir/hlo_instruction.h\"\n-#include \"xla/hlo/ir/hlo_module.h\"\n-#include \"xla/hlo/ir/hlo_opcode.h\"\n-#include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n-#include \"xla/hlo/testlib/test.h\"\n-#include \"xla/service/hlo_runner.h\"\n-#include \"xla/shape_util.h\"\n-#include \"xla/tsl/lib/core/status_test_util.h\"\n-\n-namespace xla {\n-namespace {\n-\n-class DfsHloVisitorWithDefaultTest : public HloHardwareIndependentTestBase {};\n-\n-TEST_F(DfsHloVisitorWithDefaultTest, DefaultElementwiseTest) {\n-  // Verify that HandleElementwiseBinary and HandleElementwiseUnary are called\n-  // on the appropriate HLO ops (elementwise binary/unary ops).\n-\n-  class ElementwiseTestVisitor : public DfsHloVisitorWithDefault {\n-   public:\n-    absl::Status DefaultAction(HloInstruction* hlo) override {\n-      // The HLO should be neither an elementwise unary nor binary op. These\n-      // cases are handled in HandleElementwiseBinary/Unary.\n-      TF_RET_CHECK(!(hlo->IsElementwise() && hlo->operand_count() == 2))\n-          << hlo->ToString();\n-      TF_RET_CHECK(!(hlo->IsElementwise() && hlo->operand_count() == 1))\n-          << hlo->ToString();\n-      return absl::OkStatus();\n-    }\n-\n-    absl::Status HandleElementwiseBinary(HloInstruction* hlo) override {\n-      // HLO should be elementwise binary.\n-      TF_RET_CHECK(hlo->IsElementwise() && hlo->operand_count() == 2)\n-          << hlo->ToString();\n-      return absl::OkStatus();\n-    }\n-    absl::Status HandleElementwiseUnary(HloInstruction* hlo) override {\n-      // HLO should be elementwise unary.\n-      TF_RET_CHECK(hlo->IsElementwise() && hlo->operand_count() == 1)\n-          << hlo->ToString();\n-      return absl::OkStatus();\n-    }\n-  };\n-\n-  // HLO module contains are arbitrary mix of elementwise and non-elementwise\n-  // operations.\n-  const std::string& hlo_string = R\"(\n-HloModule TestModule\n-\n-ENTRY TestComputation {\n-  arg = f32[] parameter(0)\n-  tuple = (f32[]) tuple(arg)\n-  gte = f32[] get-tuple-element(tuple), index=0\n-  abs = f32[] abs(arg)\n-  add = f32[] add(arg, gte)\n-  broadcast = f32[42] broadcast(add), dimensions={}\n-  slice = f32[1] slice(broadcast), slice={[1:2]}\n-  copy = f32[] copy(arg)\n-  eq = pred[] compare(arg, gte), direction=EQ\n-  neg = f32[] negate(arg)\n-  ROOT convert = f64[] convert(f32[] arg)\n-})\";\n-  std::unique_ptr<HloModule> module =\n-      ParseAndReturnVerifiedModule(hlo_string).value();\n-  ElementwiseTestVisitor visitor;\n-  TF_EXPECT_OK(module->entry_computation()->Accept(&visitor));\n-}\n-\n-}  // namespace\n-}  // namespace xla"
        }
    ],
    "stats": {
        "total": 164,
        "additions": 62,
        "deletions": 102
    }
}