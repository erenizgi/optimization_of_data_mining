{
    "author": "frgossen",
    "message": "[XLA:GPU] Lazily initialize Pjrt client and backend to allow for merging tables w/o\nrequiring cuda build.\n\nPiperOrigin-RevId: 808586836",
    "sha": "b1b1899aba0ca2790883bc19ed5fbfcd266d8914",
    "files": [
        {
            "sha": "dbf71fe14fdd8e4c978e8037fe7e26c39a7efba0",
            "filename": "third_party/xla/xla/tools/collective_perf_table_gen.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 16,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b1b1899aba0ca2790883bc19ed5fbfcd266d8914/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b1b1899aba0ca2790883bc19ed5fbfcd266d8914/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.cc?ref=b1b1899aba0ca2790883bc19ed5fbfcd266d8914",
            "patch": "@@ -40,6 +40,7 @@ limitations under the License.\n #include \"xla/hlo/utils/hlo_query.h\"\n #include \"xla/pjrt/pjrt_client.h\"\n #include \"xla/pjrt/plugin/xla_gpu/xla_gpu_client_options.h\"\n+#include \"xla/service/backend.h\"\n #include \"xla/service/gpu/model/hlo_op_profile.pb.h\"\n #include \"xla/service/gpu/model/hlo_op_profiles.h\"\n #include \"xla/service/hlo_module_config.h\"\n@@ -277,18 +278,31 @@ IotaReplicaGroupList GetCollectiveDeviceList(\n \n /*static*/ std::unique_ptr<CollectivePerfTableGen>\n CollectivePerfTableGen::Create(CollectivePerfTableGen::Config config) {\n-  GpuClientOptions gpu_opts;\n-  gpu_opts.num_nodes = config.num_nodes;\n-  gpu_opts.node_id = config.task_id;\n-  gpu_opts.allocator_config.memory_fraction = kGpuMemFraction;\n+  return std::unique_ptr<CollectivePerfTableGen>(\n+      new CollectivePerfTableGen(config));\n+}\n \n-  auto pjrt_env = GetPjRtEnvironmentForGpu(config.coordinator_address, gpu_opts,\n-                                           config.connection_timeout);\n-  CHECK_OK(pjrt_env);\n-  CHECK_NE(pjrt_env->client.get(), nullptr);\n+PjRtEnvironment& CollectivePerfTableGen::GetPjRtEnv() {\n+  if (pjrt_env_ == nullptr) {\n+    GpuClientOptions gpu_opts;\n+    gpu_opts.num_nodes = config_.num_nodes;\n+    gpu_opts.node_id = config_.task_id;\n+    gpu_opts.allocator_config.memory_fraction = kGpuMemFraction;\n+    absl::StatusOr<PjRtEnvironment> pjrt_env = GetPjRtEnvironmentForGpu(\n+        config_.coordinator_address, gpu_opts, config_.connection_timeout);\n+    CHECK_OK(pjrt_env);\n+    CHECK_NE(pjrt_env->client.get(), nullptr);\n+    pjrt_env_ = std::make_unique<PjRtEnvironment>(*std::move(pjrt_env));\n+  }\n+  CHECK_NE(pjrt_env_, nullptr);\n+  return *pjrt_env_;\n+}\n \n-  return std::unique_ptr<CollectivePerfTableGen>(\n-      new CollectivePerfTableGen(config, std::move(*pjrt_env)));\n+Backend& CollectivePerfTableGen::GetBackend() {\n+  if (backend_ == nullptr) {\n+    backend_ = Backend::CreateDefaultBackend().value();\n+  }\n+  return *backend_;\n }\n \n std::unique_ptr<PjRtLoadedExecutable> CollectivePerfTableGen::Compile(\n@@ -298,11 +312,11 @@ std::unique_ptr<PjRtLoadedExecutable> CollectivePerfTableGen::Compile(\n   opts.num_partitions = module->config().num_partitions();\n   opts.spmd_mode = FunctionalHloRunner::SpmdMode::kUseSpmdPartitioning;\n   auto compile_opts = FunctionalHloRunner::CreateCompileOptions(\n-      *pjrt_env_.client, opts, config_.task_id, config_.num_nodes);\n+      *GetPjRtEnv().client, opts, config_.task_id, config_.num_nodes);\n   CHECK_OK(compile_opts);\n-  auto executable =\n-      FunctionalHloRunner::Compile(*pjrt_env_.client, module.get(), debug_opts,\n-                                   /*preproc_options=*/{}, *compile_opts);\n+  auto executable = FunctionalHloRunner::Compile(\n+      *GetPjRtEnv().client, module.get(), debug_opts,\n+      /*preproc_options=*/{}, *compile_opts);\n   CHECK_OK(executable);\n   return std::move(*executable);\n }\n@@ -315,7 +329,7 @@ std::vector<ExecutionProfile> CollectivePerfTableGen::Run(\n   run_opts.num_repeats = kNumProfilingRuns;\n   std::vector<ExecutionProfile> profiles;\n   run_opts.execution_profiles = &profiles;\n-  CHECK_OK(FunctionalHloRunner::Run(*pjrt_env_.client, &executable,\n+  CHECK_OK(FunctionalHloRunner::Run(*GetPjRtEnv().client, &executable,\n                                     /*arguments=*/{}, run_opts));\n   return profiles;\n }\n@@ -409,7 +423,9 @@ DeviceHloInstructionProfiles CollectivePerfTableGen::ComputeTable() {\n   }\n \n   std::string device_key = HloOpProfiles::GetProfileName(\n-      /*device_info=*/backend_->stream_executors()[0]->GetDeviceDescription());\n+      /*device_info=*/GetBackend()\n+          .stream_executors()[0]\n+          ->GetDeviceDescription());\n   profiles.mutable_entries()->insert({device_key, profile_list});\n   return profiles;\n }"
        },
        {
            "sha": "0d8cae1d8a5a1fd7efc98e2ae301f8aeec50f387",
            "filename": "third_party/xla/xla/tools/collective_perf_table_gen.h",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b1b1899aba0ca2790883bc19ed5fbfcd266d8914/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b1b1899aba0ca2790883bc19ed5fbfcd266d8914/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.h?ref=b1b1899aba0ca2790883bc19ed5fbfcd266d8914",
            "patch": "@@ -105,10 +105,10 @@ class CollectivePerfTableGen {\n   DeviceHloInstructionProfiles Merge(absl::string_view merge_path);\n \n  private:\n-  explicit CollectivePerfTableGen(Config config, PjRtEnvironment&& pjrt_env)\n-      : config_(std::move(config)),\n-        backend_(std::move(Backend::CreateDefaultBackend().value())),\n-        pjrt_env_(std::move(pjrt_env)) {}\n+  explicit CollectivePerfTableGen(Config config) : config_(std::move(config)) {}\n+\n+  PjRtEnvironment& GetPjRtEnv();\n+  Backend& GetBackend();\n \n   ProfilingData Profile(std::unique_ptr<HloModule> module);\n \n@@ -119,7 +119,7 @@ class CollectivePerfTableGen {\n \n   Config config_;\n   std::unique_ptr<Backend> backend_;\n-  PjRtEnvironment pjrt_env_;\n+  std::unique_ptr<PjRtEnvironment> pjrt_env_;\n };\n \n }  // namespace xla::gpu"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 37,
        "deletions": 21
    }
}