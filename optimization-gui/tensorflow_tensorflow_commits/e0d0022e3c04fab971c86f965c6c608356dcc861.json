{
    "author": "nvgrw",
    "message": "Fix duplicated compilation within a single test case.\n\nIn an effort to avoid accidental fingerprint collision issues, we are going to\nallow only one load per serialized executable during (split) execution.\n\nThis patch fixes all the tests that load a given executable more than once in a\nsingle test case.\n\nPiperOrigin-RevId: 828983777",
    "sha": "e0d0022e3c04fab971c86f965c6c608356dcc861",
    "files": [
        {
            "sha": "2e8b47a2d9116257478137bd245e59f4b128de07",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=e0d0022e3c04fab971c86f965c6c608356dcc861",
            "patch": "@@ -872,6 +872,7 @@ xla_test(\n         \"//xla/service\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/types:span\",\n     ],\n )\n@@ -1891,6 +1892,7 @@ xla_test(\n     name = \"dynamic_ops_test\",\n     timeout = \"moderate\",\n     srcs = [\"dynamic_ops_test.cc\"],\n+    precompile_test = False,\n     shard_count = 4,\n     tags = [\n         \"test_migrated_to_hlo_runner_pjrt\",\n@@ -3669,6 +3671,7 @@ xla_test(\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n     ],\n )\n "
        },
        {
            "sha": "82e1e657a3223d9a3ce128a4f81af625e104049e",
            "filename": "third_party/xla/xla/tests/collective_pipeliner_execution_test.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 10,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_pipeliner_execution_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_pipeliner_execution_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_pipeliner_execution_test.cc?ref=e0d0022e3c04fab971c86f965c6c608356dcc861",
            "patch": "@@ -434,13 +434,15 @@ ENTRY entry {\n   ROOT gte1 = bf16[3,8,128] get-tuple-element(while), index=1\n }\n )\";\n-  auto module = ParseAndReturnUnverifiedModule(hlo_string).value();\n-  auto module2 = ParseAndReturnUnverifiedModule(hlo_string).value();\n-  EXPECT_FALSE(RunOptimizer(module.get(), /*last_run=*/true, 0).value());\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnUnverifiedModule(hlo_string));\n+  std::unique_ptr<HloModule> module1 = module->Clone(\"module1\");\n+  std::unique_ptr<HloModule> module2 = module->Clone(\"module2\");\n+  EXPECT_FALSE(RunOptimizer(module1.get(), /*last_run=*/true, 0).value());\n   EXPECT_FALSE(RunOptimizer(module2.get(), /*last_run=*/true, 200).value());\n-  XLA_VLOG_LINES(1, module->ToString());\n+  XLA_VLOG_LINES(1, module1->ToString());\n   XLA_VLOG_LINES(1, module2->ToString());\n-  EXPECT_TRUE(RunAndCompareTwoModules(std::move(module), std::move(module2),\n+  EXPECT_TRUE(RunAndCompareTwoModules(std::move(module1), std::move(module2),\n                                       ErrorSpec{0.1, 0.1}));\n }\n \n@@ -563,13 +565,16 @@ TEST_F(CollectivePipelinerExecutionTest, EscapedInputNoTransform) {\n    get-tuple-element(while), index=1\n  }\n )\";\n-  auto module = ParseAndReturnUnverifiedModule(hlo_string).value();\n-  auto module2 = ParseAndReturnUnverifiedModule(hlo_string).value();\n-  EXPECT_FALSE(RunOptimizer(module.get(), /*last_run=*/true, 0).value());\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnUnverifiedModule(hlo_string));\n+  std::unique_ptr<HloModule> module1 = module->Clone(\"module1\");\n+  std::unique_ptr<HloModule> module2 = module->Clone(\"module2\");\n+  EXPECT_FALSE(RunOptimizer(module1.get(), /*last_run=*/true, 0).value());\n   EXPECT_FALSE(RunOptimizer(module2.get(), /*last_run=*/true, 200).value());\n-  XLA_VLOG_LINES(1, module->ToString());\n+  XLA_VLOG_LINES(1, module1->ToString());\n   XLA_VLOG_LINES(1, module2->ToString());\n-  EXPECT_TRUE(RunAndCompareTwoModules(std::move(module), std::move(module2),\n+  EXPECT_TRUE(RunAndCompareTwoModules(std::move(module1), std::move(module2),\n                                       ErrorSpec{0.1, 0.1}));\n }\n "
        },
        {
            "sha": "47dbccc1d85e9c6f4649188f01f612e947a79c7c",
            "filename": "third_party/xla/xla/tests/constants_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 10,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fconstants_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fconstants_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fconstants_test.cc?ref=e0d0022e3c04fab971c86f965c6c608356dcc861",
            "patch": "@@ -206,17 +206,25 @@ TEST_F(ConstantsTest, Small_3x2x1x1) {\n   input_array.FillWithPZ(pz);\n   Literal input_literal = LiteralUtil::CreateR4FromArray4D(input_array);\n \n-  {\n-    XlaBuilder builder(TestName());\n-    ConstantLiteral(&builder, input_literal);\n-    ComputeAndCompareR4<float>(&builder, input_array, {}, kErrorSpec);\n-  }\n+  XlaBuilder builder(TestName());\n+  ConstantLiteral(&builder, input_literal);\n+  ComputeAndCompareR4<float>(&builder, input_array, {}, kErrorSpec);\n+}\n \n-  {\n-    XlaBuilder builder(TestName());\n-    ConstantR4FromArray4D<float>(&builder, input_array);\n-    ComputeAndCompareR4<float>(&builder, input_array, {}, kErrorSpec);\n-  }\n+TEST_F(ConstantsTest, Small_3x2x1x1_array4d) {\n+  Array4D<float> input_array(3, 2, 1, 1);\n+  Array2D<float> pz({\n+      // z0 z1\n+      {-1.0f, 4.1f},  // p0\n+      {2.0f, 4.1f},   // p1\n+      {5.0f, 4.4f},   // p2\n+  });\n+  input_array.FillWithPZ(pz);\n+  Literal input_literal = LiteralUtil::CreateR4FromArray4D(input_array);\n+\n+  XlaBuilder builder(TestName());\n+  ConstantR4FromArray4D<float>(&builder, input_array);\n+  ComputeAndCompareR4<float>(&builder, input_array, {}, kErrorSpec);\n }\n \n // TODO(b/29263943): Support tuple constants."
        },
        {
            "sha": "d0b1478010ab264f27d3e2b4b8f1c51fb90c5ebf",
            "filename": "third_party/xla/xla/tests/numerics_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fnumerics_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fnumerics_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fnumerics_test.cc?ref=e0d0022e3c04fab971c86f965c6c608356dcc861",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n \n #include \"xla/tests/xla_test_backend_predicates.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"xla/error_spec.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/testlib/test.h\"\n@@ -47,6 +48,7 @@ ENTRY entry {\n   auto abs_of_complex_x = [&hlo, this](float x) {\n     std::unique_ptr<HloModule> module =\n         ParseAndReturnVerifiedModule(hlo).value();\n+    module->set_name(absl::StrCat(module->name(), \"_\", x));\n     auto x_lit = LiteralUtil::CreateR0<complex64>(x);\n     return RunAndCompare(std::move(module), {&x_lit}, ErrorSpec{1e-5, 1e-5});\n   };\n@@ -70,6 +72,7 @@ ENTRY entry {\n   auto complex_a_raised_to_complex_b = [&hlo, this](float num, float exp) {\n     std::unique_ptr<HloModule> module =\n         ParseAndReturnVerifiedModule(hlo).value();\n+    module->set_name(absl::StrCat(module->name(), \"_\", num, \"_\", exp));\n     auto num_lit = LiteralUtil::CreateR0<complex64>(num);\n     auto exp_lit = LiteralUtil::CreateR0<complex64>(exp);\n     return RunAndCompare(std::move(module), {&num_lit, &exp_lit},"
        },
        {
            "sha": "77e56519d9b9681d58fa35b4f4e59f71e8e47b1b",
            "filename": "third_party/xla/xla/tests/scalar_computations_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fscalar_computations_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e0d0022e3c04fab971c86f965c6c608356dcc861/third_party%2Fxla%2Fxla%2Ftests%2Fscalar_computations_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fscalar_computations_test.cc?ref=e0d0022e3c04fab971c86f965c6c608356dcc861",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n #include <type_traits>\n #include <vector>\n \n+#include \"absl/strings/str_cat.h\"\n #include \"absl/types/span.h\"\n #include \"xla/error_spec.h\"\n #include \"xla/hlo/builder/xla_builder.h\"\n@@ -385,6 +386,8 @@ TEST_F(ScalarComputationsTest, DivU32s) {\n             LiteralUtil::CreateR0<uint32_t>(dividend);\n         const Literal divisor_literal =\n             LiteralUtil::CreateR0<uint32_t>(divisor);\n+        *div_computation.mutable_proto()->mutable_name() =\n+            absl::StrCat(TestName(), \"_\", dividend, \"_\", divisor);\n         TF_ASSERT_OK_AND_ASSIGN(\n             const Literal actual_literal,\n             ExecuteAndTransfer(div_computation,\n@@ -423,6 +426,8 @@ TEST_F(ScalarComputationsTest, RemU32s) {\n             LiteralUtil::CreateR0<uint32_t>(dividend);\n         const Literal divisor_literal =\n             LiteralUtil::CreateR0<uint32_t>(divisor);\n+        *rem_computation.mutable_proto()->mutable_name() =\n+            absl::StrCat(TestName(), \"_\", dividend, \"_\", divisor);\n         TF_ASSERT_OK_AND_ASSIGN(\n             const Literal actual_literal,\n             ExecuteAndTransfer(rem_computation,"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 44,
        "deletions": 20
    }
}