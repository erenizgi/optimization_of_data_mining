{
    "author": "WillFroom",
    "message": "[XLA][XTile] Add pass to verify that a module conforms to XTile specification.\n\nPiperOrigin-RevId: 825488424",
    "sha": "684717efe03c5effff133b696bc35cf6e91a0f42",
    "files": [
        {
            "sha": "32d50e89205861326ac51e9c007592363ec4810a",
            "filename": "third_party/xla/xla/backends/cpu/codegen/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -155,6 +155,7 @@ cc_library(\n         \"//xla/codegen/emitters/transforms:pass_pipelines\",\n         \"//xla/codegen/emitters/transforms:passes\",\n         \"//xla/codegen/xtile/ir:xtile\",\n+        \"//xla/codegen/xtile/ir/transforms:passes\",\n         \"//xla/mlir/tools/mlir_replay/public:compiler_trace_proto_cc\",\n         \"//xla/mlir_hlo\",\n         \"//xla/tsl/framework/mlir:status_scoped_diagnostic_handler\","
        },
        {
            "sha": "5dc955eb54b7c5cb7ef96eb1d19389af397ead71",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_compiler.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -89,6 +89,7 @@ limitations under the License.\n #include \"xla/codegen/llvm_kernel_source.h\"\n #include \"xla/codegen/mlir_kernel_source.h\"\n #include \"xla/codegen/trace_pass_instrumentation.h\"\n+#include \"xla/codegen/xtile/ir/transforms/passes.h\"\n #include \"xla/codegen/xtile/ir/xtile_dialect.h\"\n #include \"xla/codegen/xtile/ir/xtile_ops.h\"\n #include \"xla/mlir/tools/mlir_replay/public/compiler_trace.pb.h\"\n@@ -311,6 +312,7 @@ FusionCompiler::FusionCompiler(mlir::MLIRContext* context, Options options,\n                           options_.fast_min_max);\n \n   // Tiled passes.\n+  tiled_pass_manager_.addPass(xtile::createVerifyLegalXTileOpsPass());\n   AddTiledOptimizationPasses(tiled_pass_manager_);\n   if (hooks_.post_optimization) {\n     tiled_pass_manager_.addPass("
        },
        {
            "sha": "272c7c43b45e20f74182f905fbcbd43955469f89",
            "filename": "third_party/xla/xla/codegen/tools/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftools%2FBUILD?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -16,6 +16,7 @@ xla_cc_binary(\n     visibility = [\n         \"//xla/backends/cpu/codegen:__subpackages__\",\n         \"//xla/backends/gpu/codegen:__subpackages__\",\n+        \"//xla/codegen:__subpackages__\",\n         \"//xla/codegen/emitters/ir/tests:__subpackages__\",\n         \"//xla/codegen/emitters/tests:__pkg__\",\n         \"//xla/codegen/emitters/transforms/tests:__subpackages__\",\n@@ -32,6 +33,7 @@ xla_cc_binary(\n         \"//xla/codegen/emitters/transforms:pass_pipelines\",\n         \"//xla/codegen/emitters/transforms:passes\",\n         \"//xla/codegen/xtile/ir:xtile\",\n+        \"//xla/codegen/xtile/ir/transforms:passes\",\n         \"//xla/mlir_hlo\",\n         \"//xla/service/gpu:gpu_device_info_for_tests\",\n         \"@llvm-project//llvm:Support\","
        },
        {
            "sha": "ff3b7febe9c4e3107fa0f46414a71816e687d1b2",
            "filename": "third_party/xla/xla/codegen/tools/emitters_opt.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Ftools%2Femitters_opt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Ftools%2Femitters_opt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftools%2Femitters_opt.cc?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -46,6 +46,7 @@ limitations under the License.\n #include \"xla/codegen/emitters/ir/xla_dialect.h\"\n #include \"xla/codegen/emitters/transforms/pass_pipelines.h\"\n #include \"xla/codegen/emitters/transforms/passes.h\"\n+#include \"xla/codegen/xtile/ir/transforms/passes.h\"\n #include \"xla/codegen/xtile/ir/xtile_dialect.h\"\n #include \"xla/mlir_hlo/mhlo/IR/hlo_ops.h\"\n #include \"xla/service/gpu/gpu_device_info_for_tests.h\"\n@@ -70,6 +71,7 @@ int main(int argc, char** argv) {\n   xla::gpu::registerGpuFusionTransformsPasses();\n   xla::cpu::registerXlaCpuTransformsPasses();\n   xla::cpu::registerXTileCpuTransformsPasses();\n+  xla::xtile::registerXTileTransformsPasses();\n   mlir::registerPassPipeline(\n       \"xla-test-optimize\",\n       \"Test pipeline of passes up to inlining. No vectorization, also does not \""
        },
        {
            "sha": "8ce2b2d8d9a5fb9773f60969b27caf641adcb278",
            "filename": "third_party/xla/xla/codegen/xtile/ir/transforms/BUILD",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2FBUILD?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -0,0 +1,53 @@\n+load(\"@llvm-project//mlir:tblgen.bzl\", \"gentbl_cc_library\")\n+load(\"//xla/tsl:tsl.default.bzl\", \"get_compatible_with_portable\")\n+load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = [\":friends\"],\n+    licenses = [\"notice\"],\n+)\n+\n+package_group(\n+    name = \"friends\",\n+    includes = [\n+        \"//xla:friends\",\n+    ],\n+)\n+\n+gentbl_cc_library(\n+    name = \"passes_inc_gen\",\n+    compatible_with = get_compatible_with_portable(),\n+    tbl_outs = {\"passes.h.inc\": [\n+        \"-gen-pass-decls\",\n+        \"-name=XTileTransforms\",\n+    ]},\n+    tblgen = \"@llvm-project//mlir:mlir-tblgen\",\n+    td_file = \"passes.td\",\n+    visibility = [\"//visibility:private\"],\n+    deps = [\"@llvm-project//mlir:PassBaseTdFiles\"],\n+)\n+\n+cc_library(\n+    name = \"passes\",\n+    srcs = [\n+        \"verify_legal_xtile_ops.cc\",\n+    ],\n+    hdrs = [\"passes.h\"],\n+    deps = [\n+        \":passes_inc_gen\",\n+        \"//xla/codegen/emitters/ir:xla\",\n+        \"//xla/codegen/xtile/ir:xtile\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@llvm-project//mlir:ArithDialect\",\n+        \"@llvm-project//mlir:FuncDialect\",\n+        \"@llvm-project//mlir:IR\",\n+        \"@llvm-project//mlir:MathDialect\",\n+        \"@llvm-project//mlir:Pass\",\n+        \"@llvm-project//mlir:SCFDialect\",\n+        \"@llvm-project//mlir:Support\",\n+        \"@llvm-project//mlir:TensorDialect\",\n+        \"@llvm-project//mlir:TransformUtils\",\n+        \"@stablehlo//:stablehlo_ops\",\n+    ],\n+)"
        },
        {
            "sha": "9991af93198f4c56a18e455aa47e2386541f36c3",
            "filename": "third_party/xla/xla/codegen/xtile/ir/transforms/passes.h",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fpasses.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fpasses.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fpasses.h?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -0,0 +1,32 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_CODEGEN_XTILE_IR_TRANSFORMS_PASSES_H_\n+#define XLA_CODEGEN_XTILE_IR_TRANSFORMS_PASSES_H_\n+\n+#include <memory>  // IWYU pragma: keep\n+\n+#include \"mlir/IR/BuiltinOps.h\"  // IWYU pragma: keep\n+#include \"mlir/Pass/Pass.h\"  // IWYU pragma: keep\n+\n+namespace xla::xtile {\n+\n+#define GEN_PASS_DECL\n+#define GEN_PASS_REGISTRATION\n+#include \"xla/codegen/xtile/ir/transforms/passes.h.inc\"\n+\n+}  // namespace xla::xtile\n+\n+#endif  // XLA_CODEGEN_XTILE_IR_TRANSFORMS_PASSES_H_"
        },
        {
            "sha": "66ab6895423597f8ef71546df220071d09d85c03",
            "filename": "third_party/xla/xla/codegen/xtile/ir/transforms/passes.td",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fpasses.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fpasses.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fpasses.td?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -0,0 +1,26 @@\n+/* Copyright 2024 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+include \"mlir/Pass/PassBase.td\"\n+\n+def VerifyLegalXTileOpsPass : Pass<\"xtile-verify-legal-ops\", \"mlir::ModuleOp\"> {\n+  let summary = \"Verify that all ops in the module are legal\";\n+\n+  let description = [{\n+    This pass verifies that all ops in the module are legal, which is defined as\n+    the ops that are supported by all of the XTile backends.\n+  }];\n+\n+}"
        },
        {
            "sha": "10228fcc460af821c5685541d937e47bb011a65e",
            "filename": "third_party/xla/xla/codegen/xtile/ir/transforms/tests/BUILD",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Ftests%2FBUILD?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -0,0 +1,16 @@\n+load(\"//xla:lit.bzl\", \"lit_test_suite\")\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    licenses = [\"notice\"],\n+)\n+\n+lit_test_suite(\n+    name = \"tests\",\n+    srcs = glob([\"*.mlir\"]),\n+    cfg = \"//xla:lit.cfg.py\",\n+    tools = [\n+        \"//xla/codegen/tools:emitters_opt\",\n+        \"@llvm-project//llvm:FileCheck\",\n+    ],\n+)"
        },
        {
            "sha": "436c0f2d404c7bef1e35e1dab8f5a67fe0c99fdf",
            "filename": "third_party/xla/xla/codegen/xtile/ir/transforms/tests/verify_legal_xtile_ops.mlir",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Ftests%2Fverify_legal_xtile_ops.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Ftests%2Fverify_legal_xtile_ops.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Ftests%2Fverify_legal_xtile_ops.mlir?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -0,0 +1,12 @@\n+// RUN: emitters_opt %s -xtile-verify-legal-ops -split-input-file -verify-diagnostics\n+\n+xtile.entry_func @fails_illegal_op(%arg0: memref<2xf32>, %arg1: index) {\n+  %c_0 = arith.constant 0. : f32\n+  // expected-error @+1 {{vector.transfer_read: unsupported op}}\n+  %0 = vector.transfer_read %arg0[%arg1], %c_0 : memref<2xf32>, vector<2xf32>\n+  // expected-error @+1 {{vector.transfer_write: unsupported op}}\n+  vector.transfer_write %0, %arg0[%arg1] : vector<2xf32>, memref<2xf32>\n+  xtile.return\n+}\n+\n+// -----"
        },
        {
            "sha": "2127bc224a855f11cd1ca761911e0bec02be66de",
            "filename": "third_party/xla/xla/codegen/xtile/ir/transforms/verify_legal_xtile_ops.cc",
            "status": "added",
            "additions": 139,
            "deletions": 0,
            "changes": 139,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fverify_legal_xtile_ops.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/684717efe03c5effff133b696bc35cf6e91a0f42/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fverify_legal_xtile_ops.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fxtile%2Fir%2Ftransforms%2Fverify_legal_xtile_ops.cc?ref=684717efe03c5effff133b696bc35cf6e91a0f42",
            "patch": "@@ -0,0 +1,139 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include <optional>\n+\n+#include \"absl/strings/string_view.h\"\n+#include \"mlir/Dialect/Arith/IR/Arith.h\"\n+#include \"mlir/Dialect/Func/IR/FuncOps.h\"\n+#include \"mlir/Dialect/Math/IR/Math.h\"\n+#include \"mlir/Dialect/SCF/IR/SCF.h\"\n+#include \"mlir/Dialect/Tensor/IR/Tensor.h\"\n+#include \"mlir/IR/BuiltinAttributes.h\"\n+#include \"mlir/IR/BuiltinDialect.h\"\n+#include \"mlir/IR/BuiltinOps.h\"\n+#include \"mlir/IR/Diagnostics.h\"\n+#include \"mlir/IR/MLIRContext.h\"\n+#include \"mlir/IR/OperationSupport.h\"\n+#include \"mlir/Support/LLVM.h\"\n+#include \"mlir/Support/WalkResult.h\"\n+#include \"mlir/Transforms/DialectConversion.h\"\n+#include \"stablehlo/dialect/StablehloOps.h\"\n+#include \"xla/codegen/emitters/ir/xla_dialect.h\"\n+#include \"xla/codegen/xtile/ir/transforms/passes.h\"  // IWYU pragma: keep\n+#include \"xla/codegen/xtile/ir/xtile_dialect.h\"\n+\n+namespace xla::xtile {\n+\n+#define GEN_PASS_DEF_VERIFYLEGALXTILEOPSPASS\n+#include \"xla/codegen/xtile/ir/transforms/passes.h.inc\"\n+\n+namespace {\n+\n+bool WholeDialectIsLegal(mlir::Dialect* dialect) {\n+  return mlir::isa<XTileDialect, XlaDialect, mlir::arith::ArithDialect,\n+                   mlir::math::MathDialect, mlir::func::FuncDialect,\n+                   mlir::BuiltinDialect>(dialect);\n+}\n+\n+std::optional<absl::string_view> IsLegalSCFOp(mlir::Operation* op) {\n+  if (mlir::isa<mlir::scf::ForOp, mlir::scf::IfOp, mlir::scf::YieldOp>(op)) {\n+    return std::nullopt;\n+  }\n+\n+  return \"unsupported SCF op\";\n+}\n+\n+std::optional<absl::string_view> IsLegalTensorOp(mlir::Operation* op) {\n+  if (mlir::isa<mlir::tensor::BitcastOp>(op)) {\n+    return std::nullopt;\n+  }\n+\n+  // TODO(willfroom): remove this ExtractOp & FromElementsOp once the special\n+  // handling of 0D tensors is removed from the emitter.\n+  if (auto extract = mlir::dyn_cast<mlir::tensor::ExtractOp>(op)) {\n+    if (extract.getTensor().getType().getRank() != 0) {\n+      return \"Expected rank 0\";\n+    }\n+    return std::nullopt;\n+  }\n+\n+  if (auto from_elements = mlir::dyn_cast<mlir::tensor::FromElementsOp>(op)) {\n+    if (from_elements.getType().getRank() != 0) {\n+      return \"Expected rank 0\";\n+    }\n+    return std::nullopt;\n+  }\n+\n+  return \"unsupported Tensor op\";\n+}\n+\n+std::optional<absl::string_view> IsLegalStablehloOp(mlir::Operation* op) {\n+  if (mlir::isa<mlir::stablehlo::BroadcastInDimOp, mlir::stablehlo::ReduceOp,\n+                mlir::stablehlo::ReturnOp, mlir::stablehlo::TransposeOp,\n+                mlir::stablehlo::IotaOp, mlir::stablehlo::DotGeneralOp,\n+                mlir::stablehlo::ReshapeOp>(op)) {\n+    return std::nullopt;\n+  }\n+\n+  return \"unsupported StableHLO op\";\n+}\n+\n+// Check if a given op is xtile legal, if it is return std::nullopt else,\n+// returns a diagnostic string.\n+std::optional<absl::string_view> IsLegalOp(mlir::Operation* op) {\n+  mlir::Dialect* dialect = op->getDialect();\n+  if (WholeDialectIsLegal(dialect)) {\n+    return std::nullopt;\n+  }\n+\n+  if (mlir::isa<mlir::scf::SCFDialect>(dialect)) {\n+    return IsLegalSCFOp(op);\n+  }\n+\n+  if (mlir::isa<mlir::tensor::TensorDialect>(dialect)) {\n+    return IsLegalTensorOp(op);\n+  }\n+\n+  if (mlir::isa<mlir::stablehlo::StablehloDialect>(dialect)) {\n+    return IsLegalStablehloOp(op);\n+  }\n+\n+  return \"unsupported op\";\n+}\n+\n+struct VerifyLegalXTileOpsPass\n+    : public impl::VerifyLegalXTileOpsPassBase<VerifyLegalXTileOpsPass> {\n+  void runOnOperation() override {\n+    mlir::ModuleOp module = getOperation();\n+\n+    bool failed = false;\n+    module->walk([&failed](mlir::Operation* op) {\n+      if (std::optional<absl::string_view> diagnostic = IsLegalOp(op)) {\n+        op->emitError() << op->getName() << \": \" << *diagnostic;\n+        failed = true;\n+      }\n+      return mlir::WalkResult::advance();\n+    });\n+\n+    if (failed) {\n+      signalPassFailure();\n+    }\n+  }\n+};\n+\n+}  // namespace\n+\n+}  // namespace xla::xtile"
        }
    ],
    "stats": {
        "total": 285,
        "additions": 285,
        "deletions": 0
    }
}