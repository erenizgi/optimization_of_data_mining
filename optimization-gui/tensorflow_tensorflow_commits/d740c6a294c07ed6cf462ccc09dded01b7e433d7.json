{
    "author": "tensorflower-gardener",
    "message": "Report mixed_priority_batching_policy metric with policy name string.\n\nAdd `GetMixedPriorityBatchingPolicyString` to convert the `MixedPriorityBatchingPolicy` enum to its string attribute value. This function is used when recording the policy in metrics, ensuring that the string representation (e.g., \"priority_isolation\") is used instead of the enum's integer value.\n\nPiperOrigin-RevId: 845370645",
    "sha": "d740c6a294c07ed6cf462ccc09dded01b7e433d7",
    "files": [
        {
            "sha": "6448e5ae36fead81c8cf0c0dd19a2ea69abacf84",
            "filename": "tensorflow/core/kernels/batching_util/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2FBUILD?ref=d740c6a294c07ed6cf462ccc09dded01b7e433d7",
            "patch": "@@ -535,6 +535,7 @@ tf_cc_test(\n         \"@local_xla//xla/tsl/lib/monitoring:cell_reader\",\n         \"@local_xla//xla/tsl/lib/monitoring:test_utils\",\n         \"@local_xla//xla/tsl/platform:criticality\",\n+        \"@local_xla//xla/tsl/platform:statusor\",\n     ],\n )\n "
        },
        {
            "sha": "8c53a2299110a5f48eeeee276805dbe22cf64324",
            "filename": "tensorflow/core/kernels/batching_util/batch_resource_base.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_resource_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_resource_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_resource_base.cc?ref=d740c6a294c07ed6cf462ccc09dded01b7e433d7",
            "patch": "@@ -284,8 +284,12 @@ static auto* mixed_priority_batching_policy_value =\n void RecordBatchParamMixedPriorityBatchingPolicy(\n     MixedPriorityBatchingPolicy mixed_priority_batching_policy,\n     const std::string& model_name, const std::string& op_name) {\n-  mixed_priority_batching_policy_value->GetCell(model_name, op_name)\n-      ->Set(absl::StrCat(mixed_priority_batching_policy));\n+  auto policy_str =\n+      GetMixedPriorityBatchingPolicyString(mixed_priority_batching_policy);\n+  if (policy_str.ok()) {\n+    mixed_priority_batching_policy_value->GetCell(model_name, op_name)\n+        ->Set(std::string(*policy_str));\n+  }\n }\n \n void RecordBatchParamMaxEnqueuedBatches(int64_t max_enqueued_batches,"
        },
        {
            "sha": "a3b813ec6b7a4fd8c9b8de78a691cfa9ee97e58e",
            "filename": "tensorflow/core/kernels/batching_util/batch_resource_base_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_resource_base_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_resource_base_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_resource_base_test.cc?ref=d740c6a294c07ed6cf462ccc09dded01b7e433d7",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"xla/tsl/lib/monitoring/cell_reader.h\"\n #include \"xla/tsl/lib/monitoring/test_utils.h\"\n #include \"xla/tsl/platform/criticality.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"tensorflow/core/common_runtime/cost_constants.h\"\n #include \"tensorflow/core/common_runtime/cost_measurement.h\"\n #include \"tensorflow/core/common_runtime/cost_measurement_registry.h\"\n@@ -282,9 +283,13 @@ TEST_P(BatchResourceBaseWithPriorityTest, BatchingWithMixedPriorityPolicy) {\n         /*forced_warmup_batch_size=*/0));\n   }\n   blocking_counter.Wait();\n+\n+  TF_ASSERT_OK_AND_ASSIGN(absl::string_view policy_str,\n+                          GetMixedPriorityBatchingPolicyString(\n+                              GetParam().mixed_priority_batching_policy));\n   EXPECT_EQ(\n       mixed_priority_policy_reader_->Read(\"my_model_name\", \"my_batch_node\"),\n-      absl::StrCat(GetParam().mixed_priority_batching_policy));\n+      policy_str);\n \n   for (const auto& [batch_size, expected_count] :\n        GetParam().expected_batch_size_count) {"
        },
        {
            "sha": "e74f6dfe9ddc080b9962a8cf710710c2a91dd522",
            "filename": "tensorflow/core/kernels/batching_util/batch_scheduler.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler.cc?ref=d740c6a294c07ed6cf462ccc09dded01b7e433d7",
            "patch": "@@ -40,5 +40,23 @@ absl::StatusOr<MixedPriorityBatchingPolicy> GetMixedPriorityBatchingPolicy(\n       \"Unknown mixed priority batching policy: %s\", attr_value));\n }\n \n+absl::StatusOr<absl::string_view> GetMixedPriorityBatchingPolicyString(\n+    MixedPriorityBatchingPolicy policy) {\n+  switch (policy) {\n+    case MixedPriorityBatchingPolicy::kLowPriorityPaddingWithMaxBatchSize:\n+      return kLowPriorityPaddingWithMaxBatchSizeAttrValue;\n+    case MixedPriorityBatchingPolicy::\n+        kLowPriorityPaddingWithNextAllowedBatchSize:\n+      return kLowPriorityPaddingWithNextAllowedBatchSizeAttrValue;\n+    case MixedPriorityBatchingPolicy::kPriorityIsolation:\n+      return kPriorityIsolationAttrValue;\n+    case MixedPriorityBatchingPolicy::kPriorityMerge:\n+      return kPriorityMergeAttrValue;\n+    default:\n+      return absl::InvalidArgumentError(absl::StrFormat(\n+          \"Unknown mixed priority batching policy: %d\", policy));\n+  }\n+}\n+\n }  // namespace serving\n }  // namespace tensorflow"
        },
        {
            "sha": "4060a8b15fbd96f4ffc25f6628ef390e0e599ffa",
            "filename": "tensorflow/core/kernels/batching_util/batch_scheduler.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler.h?ref=d740c6a294c07ed6cf462ccc09dded01b7e433d7",
            "patch": "@@ -70,6 +70,9 @@ enum class MixedPriorityBatchingPolicy {\n absl::StatusOr<MixedPriorityBatchingPolicy> GetMixedPriorityBatchingPolicy(\n     absl::string_view attr_value);\n \n+absl::StatusOr<absl::string_view> GetMixedPriorityBatchingPolicyString(\n+    MixedPriorityBatchingPolicy policy);\n+\n // The abstract superclass for a unit of work to be done as part of a batch.\n //\n // An implementing subclass typically contains (or points to):"
        },
        {
            "sha": "fce07c171b8e8516c26ce8ef70dc7b8b9410f3a2",
            "filename": "tensorflow/core/kernels/batching_util/batch_scheduler_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d740c6a294c07ed6cf462ccc09dded01b7e433d7/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fbatching_util%2Fbatch_scheduler_test.cc?ref=d740c6a294c07ed6cf462ccc09dded01b7e433d7",
            "patch": "@@ -49,6 +49,12 @@ TEST(MixedPriorityBatchingPolicyTest, InvalidAttrValueError) {\n           absl::StatusCode::kInvalidArgument,\n           ::testing::HasSubstr(\n               \"Unknown mixed priority batching policy: invalid_attr_value\")));\n+  EXPECT_THAT(\n+      GetMixedPriorityBatchingPolicyString(\n+          static_cast<MixedPriorityBatchingPolicy>(4)),\n+      absl_testing::StatusIs(\n+          absl::StatusCode::kInvalidArgument,\n+          ::testing::HasSubstr(\"Unknown mixed priority batching policy: 4\")));\n }\n \n using MixedPriorityBatchingPolicyParameterizedTest = ::testing::TestWithParam<\n@@ -59,6 +65,8 @@ TEST_P(MixedPriorityBatchingPolicyParameterizedTest,\n   auto [attr_name, policy] = GetParam();\n   EXPECT_THAT(GetMixedPriorityBatchingPolicy(attr_name),\n               absl_testing::IsOkAndHolds(Eq(policy)));\n+  EXPECT_THAT(GetMixedPriorityBatchingPolicyString(policy),\n+              absl_testing::IsOkAndHolds(Eq(attr_name)));\n }\n \n INSTANTIATE_TEST_SUITE_P("
        }
    ],
    "stats": {
        "total": 45,
        "additions": 42,
        "deletions": 3
    }
}