{
    "author": "tensorflower-gardener",
    "message": "Make the chain specifically target the reshape-transpose chain where\nthe transposes are not identity permutations. Identity transposes\nshould be eliminated separately in HandleTranspose already.\n\nPiperOrigin-RevId: 820903953",
    "sha": "4beacf5a04f5ab231cf527f579196f57ed2afa43",
    "files": [
        {
            "sha": "6fce96ac1292c4f3fade46a94f679e2bf2abe780",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/algebraic_simplifier.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4beacf5a04f5ab231cf527f579196f57ed2afa43/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4beacf5a04f5ab231cf527f579196f57ed2afa43/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.cc?ref=4beacf5a04f5ab231cf527f579196f57ed2afa43",
            "patch": "@@ -6226,6 +6226,12 @@ AlgebraicSimplifierVisitor::TryRemovingReshapeTransposeChain(\n         break;\n       }\n       if (current->opcode() == HloOpcode::kTranspose) {\n+        if (IsIdentityPermutation(\n+                Cast<HloTransposeInstruction>(current)->dimensions())) {\n+          // This transpose will be eliminated separately in HandleTranspose.\n+          is_nop = false;\n+          break;\n+        }\n         permutation = ComposePermutations(\n             get_effective_permutation(current->dimensions(),\n                                       current->operand(0)->shape(),\n@@ -6235,6 +6241,7 @@ AlgebraicSimplifierVisitor::TryRemovingReshapeTransposeChain(\n       starting_instruction = current;\n       current = current->mutable_operand(0);\n     }\n+\n     if (is_nop && starting_instruction != nullptr &&\n         Shape::Equal().IgnoreLayout()(\n             reshape->shape(), starting_instruction->operand(0)->shape()) &&"
        },
        {
            "sha": "ff9d403103dbe418994affeb34a2e171e55a719f",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/algebraic_simplifier_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4beacf5a04f5ab231cf527f579196f57ed2afa43/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4beacf5a04f5ab231cf527f579196f57ed2afa43/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier_test.cc?ref=4beacf5a04f5ab231cf527f579196f57ed2afa43",
            "patch": "@@ -364,6 +364,25 @@ TEST_F(AlgebraicSimplifierTest, NotEliminateReshapeTransposeChain) {\n   EXPECT_FALSE(AlgebraicSimplifier(default_options_).Run(m.get()).value());\n }\n \n+// Reshape-transpose chain is not eliminated since the transpose is identity\n+// permutation.\n+TEST_F(AlgebraicSimplifierTest, NotEliminateReshapeTransposeChain2) {\n+  constexpr absl::string_view kModuleStr = R\"(\n+    HloModule m\n+    test {\n+      %param = f32[4,4,1,4] parameter(0)\n+      %reshape.96335 = f32[4,4,4] reshape(%param)\n+      %transpose.8665 = f32[4,4,4] transpose(%reshape.96335), dimensions={0,1,2}\n+      ROOT %reshape.96336 = f32[4,4,1,4] reshape(%transpose.8665)\n+    }\n+  )\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto m, ParseAndReturnVerifiedModule(kModuleStr));\n+  EXPECT_TRUE(AlgebraicSimplifier(default_options_).Run(m.get()).value());\n+  EXPECT_THAT(m->entry_computation()->root_instruction(),\n+              GmockMatch(m::Reshape()));\n+  VLOG(2) << \"Module after: \" << m->ToString();\n+}\n+\n // (Abs(A)) * (Abs(A)) => (A*A)\n TEST_F(AlgebraicSimplifierTest, SquareOfAbs) {\n   constexpr absl::string_view kModuleStr = R\"("
        }
    ],
    "stats": {
        "total": 26,
        "additions": 26,
        "deletions": 0
    }
}