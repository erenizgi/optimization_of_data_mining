{
    "author": "tensorflower-gardener",
    "message": "Expose `IncrementKeyValue` from the coordination service. This call is always blocking since the behavior is that even if the key does not exist, it will be initialized (consistent with other kv-store implementations).\n\nPiperOrigin-RevId: 798349776",
    "sha": "6ea4be9e1b4a262b099b711fee2b2acaa5605c53",
    "files": [
        {
            "sha": "40ab87e97481b05776d07bd28671d175f7f9d103",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ea4be9e1b4a262b099b711fee2b2acaa5605c53/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ea4be9e1b4a262b099b711fee2b2acaa5605c53/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.cc?ref=6ea4be9e1b4a262b099b711fee2b2acaa5605c53",
            "patch": "@@ -1050,6 +1050,13 @@ absl::StatusOr<std::string> CoordinationService::TryGetKeyValue(\n   return *std::move(s);\n }\n \n+absl::StatusOr<std::string> CoordinationService::IncrementKeyValue(\n+    absl::string_view key, int64_t increment) {\n+  VLOG(3) << \"CoordinationService::IncrementKeyValue(key=\" << key\n+          << \", increment=\" << increment << \")\";\n+  return store_.IncrementBy(NormalizeKey(key), increment);\n+}\n+\n std::vector<KeyValueEntry> CoordinationService::GetKeyValueDir(\n     absl::string_view directory_key) {\n   VLOG(3) << \"CoordinationService::GetKeyValueDir(directory_key=\""
        },
        {
            "sha": "1011a772eb8bc40ba86a1de926b722915897ca30",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ea4be9e1b4a262b099b711fee2b2acaa5605c53/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ea4be9e1b4a262b099b711fee2b2acaa5605c53/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.h?ref=6ea4be9e1b4a262b099b711fee2b2acaa5605c53",
            "patch": "@@ -179,6 +179,12 @@ class CoordinationService {\n   // does not exist, return NotFound error.\n   absl::StatusOr<std::string> TryGetKeyValue(absl::string_view key);\n \n+  // Increment a configuration key-value by the provided increment. If the key\n+  // does not exist, the value is initialized to 0 and then incremented. The\n+  // result after incrementing is returned.\n+  absl::StatusOr<std::string> IncrementKeyValue(absl::string_view key,\n+                                                int64_t increment);\n+\n   // Gets all values under a directory (key).\n   // A value is considered to be in the directory if its key is prefixed with\n   // the directory. This is not a blocking call. Agent does not need to be"
        },
        {
            "sha": "21e91c49c48f396eff80fd78d261997bd15e132c",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_test.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ea4be9e1b4a262b099b711fee2b2acaa5605c53/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ea4be9e1b4a262b099b711fee2b2acaa5605c53/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_test.cc?ref=6ea4be9e1b4a262b099b711fee2b2acaa5605c53",
            "patch": "@@ -928,6 +928,27 @@ TEST(CoordinationServiceTest, TryGetKeyValue) {\n   EXPECT_THAT(result.status(), StatusIs(absl::StatusCode::kNotFound));\n }\n \n+TEST(CoordinationServiceTest, IncrementKeyValue) {\n+  const CoordinationServiceConfig config =\n+      GetCoordinationServiceConfig(/*num_tasks=*/1);\n+  auto client_cache = std::make_unique<TestCoordinationClientCache>();\n+  std::unique_ptr<CoordinationService> coord_service =\n+      CoordinationService::Create(Env::Default(), config,\n+                                  std::move(client_cache));\n+  ASSERT_OK(coord_service->InsertKeyValue(\"test_key\", \"1\"));\n+  ASSERT_OK(coord_service->IncrementKeyValue(\"test_key\", 3));\n+  ASSERT_OK_AND_ASSIGN(std::string result_0,\n+                       coord_service->TryGetKeyValue(\"test_key\"));\n+  EXPECT_EQ(result_0, \"4\");\n+  ASSERT_OK(coord_service->IncrementKeyValue(\"test_key_2\", 10));\n+  ASSERT_OK_AND_ASSIGN(std::string result_1,\n+                       coord_service->TryGetKeyValue(\"test_key_2\"));\n+  EXPECT_EQ(result_1, \"10\");\n+  ASSERT_OK(coord_service->InsertKeyValue(\"test_key_3\", \"bad_value\"));\n+  EXPECT_THAT(coord_service->IncrementKeyValue(\"test_key_3\", 10),\n+              StatusIs(absl::StatusCode::kFailedPrecondition));\n+}\n+\n TEST_F(CoordinateTwoTasksTest, GetKeyValueDir_SingleValueInDirectory) {\n   EnableCoordinationService();\n   KeyValueEntry kv = CreateKv(\"dir/path\", \"value0\");"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 34,
        "deletions": 0
    }
}