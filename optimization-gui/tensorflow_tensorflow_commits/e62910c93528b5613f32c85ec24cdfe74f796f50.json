{
    "author": "bmass02",
    "message": "Fix timestamp normalization for subprocess xplanes.\n\nPiperOrigin-RevId: 816856674",
    "sha": "e62910c93528b5613f32c85ec24cdfe74f796f50",
    "files": [
        {
            "sha": "f3ecec9770a8e225685ad92864e176ab105f74d3",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2FBUILD?ref=e62910c93528b5613f32c85ec24cdfe74f796f50",
            "patch": "@@ -53,7 +53,9 @@ cc_library(\n         \":subprocess_registry\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/profiler/utils:timestamp_utils\",\n         \"//xla/tsl/profiler/utils:xplane_schema\",\n+        \"//xla/tsl/profiler/utils:xplane_utils\",\n         \"@com_google_absl//absl/cleanup\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/memory\",\n@@ -88,8 +90,11 @@ xla_cc_test(\n         \"//xla/tsl/platform:subprocess\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/platform:test_main\",\n+        \"//xla/tsl/profiler/utils:math_utils\",\n+        \"//xla/tsl/profiler/utils:timespan\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/time\","
        },
        {
            "sha": "148e4ce2b5d80427b9a466e8d16902e1dafa1eda",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/subprocess_main.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_main.cc?ref=e62910c93528b5613f32c85ec24cdfe74f796f50",
            "patch": "@@ -35,10 +35,10 @@ int main(int argc, char** argv) {\n   auto profiler_server = std::make_unique<tsl::profiler::ProfilerServer>();\n   profiler_server->StartProfilerServer(port);\n \n-  uint64_t iteration = 0;\n   while (true) {\n     tsl::profiler::TraceMe trace_me([&] {\n-      return absl::StrCat(\"subprocess_test_\", port, \"_\", iteration++);\n+      return absl::StrCat(\"subprocess_test_\", port, \"_\",\n+                          absl::ToUnixMillis(absl::Now()));\n     });\n     absl::SleepFor(absl::Milliseconds(10));\n   }"
        },
        {
            "sha": "7a925bea2221424690a78fb4da107b7d07b2d30d",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/subprocess_profiling_session.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session.cc?ref=e62910c93528b5613f32c85ec24cdfe74f796f50",
            "patch": "@@ -34,7 +34,9 @@ limitations under the License.\n #include \"xla/backends/profiler/subprocess/subprocess_registry.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/profiler/utils/timestamp_utils.h\"\n #include \"xla/tsl/profiler/utils/xplane_schema.h\"\n+#include \"xla/tsl/profiler/utils/xplane_utils.h\"\n #include \"tsl/profiler/lib/profiler_collection.h\"\n #include \"tsl/profiler/lib/profiler_factory.h\"\n #include \"tsl/profiler/lib/profiler_interface.h\"\n@@ -164,6 +166,14 @@ absl::Status SubprocessProfilingSession::CollectData(\n         absl::StrCat(\"No XSpace data returned from subprocess: \",\n                      subprocess_info_.DebugString()));\n   }\n+  if (auto timestamps = tsl::profiler::GetSessionTimestamps(response_.xspace());\n+      timestamps.has_value()) {\n+    tsl::profiler::DenormalizeTimestamps(response_.mutable_xspace(),\n+                                         timestamps->first);\n+  } else {\n+    LOG(WARNING) << \"No session timestamps found. Skipping denormalizing \"\n+                    \"timestamps.\";\n+  }\n   for (const auto& plane : response_.xspace().planes()) {\n     // TODO(b/416884677): Implement merging task env planes from subprocesses to\n     // propagate metadata."
        },
        {
            "sha": "e41a47ff5244f4b080d05f7754189aede3a5fc12",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/subprocess_profiling_session_test.cc",
            "status": "modified",
            "additions": 68,
            "deletions": 14,
            "changes": 82,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e62910c93528b5613f32c85ec24cdfe74f796f50/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session_test.cc?ref=e62910c93528b5613f32c85ec24cdfe74f796f50",
            "patch": "@@ -21,6 +21,8 @@ limitations under the License.\n #include <sys/wait.h>\n #include <unistd.h>\n \n+#include <algorithm>\n+#include <cstdint>\n #include <cstdlib>\n #include <memory>\n #include <string>\n@@ -30,8 +32,10 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/status/status_matchers.h\"\n #include \"absl/strings/match.h\"\n+#include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_join.h\"\n #include \"absl/strings/str_split.h\"\n@@ -41,6 +45,8 @@ limitations under the License.\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/subprocess.h\"\n #include \"xla/tsl/platform/test.h\"\n+#include \"xla/tsl/profiler/utils/math_utils.h\"\n+#include \"xla/tsl/profiler/utils/timespan.h\"\n #include \"tsl/platform/path.h\"\n #include \"tsl/profiler/lib/profiler_session.h\"\n #include \"tsl/profiler/lib/traceme.h\"\n@@ -56,6 +62,19 @@ using ::absl_testing::IsOk;\n using ::testing::IsEmpty;\n using ::testing::Not;\n \n+absl::Status SaveXSpaceToUndeclaredOutputs(\n+    const tensorflow::profiler::XSpace& space) {\n+  // Emit the collected XSpace as an undeclared output file.\n+  const char* outputs_dir = std::getenv(\"TEST_UNDECLARED_OUTPUTS_DIR\");\n+  LOG_IF(WARNING, outputs_dir == nullptr)\n+      << \"TEST_UNDECLARED_OUTPUTS_DIR not set, skipping writing xspace.pb\";\n+  if (outputs_dir != nullptr) {\n+    std::string output_path = tsl::io::JoinPath(outputs_dir, \"xspace.pb\");\n+    return tsl::WriteBinaryProto(tsl::Env::Default(), output_path, space);\n+  }\n+  return absl::OkStatus();\n+}\n+\n std::unique_ptr<tsl::SubProcess> CreateSubProcess(\n     const std::vector<std::string>& args) {\n   auto subprocess = std::make_unique<tsl::SubProcess>();\n@@ -91,8 +110,6 @@ class SubprocessProfilingSessionTest : public ::testing::Test {\n           RegisterSubprocess(subprocess_runtime.port, subprocess_runtime.port),\n           IsOk());\n     }\n-    // Wait for connections to be established.\n-    absl::SleepFor(absl::Seconds(num_subprocesses + 1));\n   }\n \n   void TearDown() override {\n@@ -115,13 +132,17 @@ TEST_F(SubprocessProfilingSessionTest, MultipleSubprocessesIntegrationTest) {\n \n   auto session =\n       tsl::ProfilerSession::Create(tsl::ProfilerSession::DefaultOptions());\n-  auto deadline = absl::Now() + absl::Seconds(1);\n+  auto deadline = absl::Now() + absl::Seconds(4);\n   while (absl::Now() < deadline) {\n-    tsl::profiler::TraceMe trace_me(\"main_process\");\n+    tsl::profiler::TraceMe trace_me([&] {\n+      return absl::StrCat(\"main_process_\", absl::ToUnixMillis(absl::Now()));\n+    });\n     absl::SleepFor(absl::Milliseconds(10));\n   }\n   tensorflow::profiler::XSpace space;\n   ASSERT_THAT(session->CollectData(&space), IsOk());\n+  // For debugging purposes.\n+  EXPECT_THAT(SaveXSpaceToUndeclaredOutputs(space), IsOk());\n \n   ASSERT_THAT(space.planes(), Not(IsEmpty()));\n \n@@ -139,6 +160,12 @@ TEST_F(SubprocessProfilingSessionTest, MultipleSubprocessesIntegrationTest) {\n           ASSERT_EQ(parts.size(), 4)\n               << \"Invalid trace me name: \" << trace_me_name;\n           trace_me_name = absl::StrJoin(parts.begin(), parts.end() - 1, \"_\");\n+        } else if (absl::StartsWith(trace_me_name, \"main_process_\")) {\n+          std::vector<std::string> parts = absl::StrSplit(\n+              event_metadata.at(event.metadata_id()).name(), '_');\n+          ASSERT_EQ(parts.size(), 3)\n+              << \"Invalid trace me name: \" << trace_me_name;\n+          trace_me_name = absl::StrJoin(parts.begin(), parts.end() - 1, \"_\");\n         }\n         trace_me_names.insert(trace_me_name);\n       }\n@@ -154,16 +181,43 @@ TEST_F(SubprocessProfilingSessionTest, MultipleSubprocessesIntegrationTest) {\n   }\n   EXPECT_EQ(trace_me_names, expected_trace_me_names);\n \n-  // Emit the collected XSpace as an undeclared output file.\n-  const char* outputs_dir = std::getenv(\"TEST_UNDECLARED_OUTPUTS_DIR\");\n-  if (outputs_dir != nullptr) {\n-    std::string output_path = tsl::io::JoinPath(outputs_dir, \"xspace.pb\");\n-    ASSERT_THAT(tsl::WriteBinaryProto(tsl::Env::Default(), output_path, space),\n-                IsOk());\n-    LOG(INFO) << \"Wrote XSpace proto to: \" << output_path;\n-  } else {\n-    LOG(WARNING)\n-        << \"TEST_UNDECLARED_OUTPUTS_DIR not set, skipping writing xspace.pb\";\n+  struct EventInfo {\n+    std::string name;\n+    tsl::profiler::Timespan timespan;\n+    uint64_t timestamp_ms;\n+  };\n+  std::vector<EventInfo> events;\n+  for (const auto& plane : space.planes()) {\n+    for (const auto& line : plane.lines()) {\n+      for (const auto& event : line.events()) {\n+        std::vector<std::string> parts = absl::StrSplit(\n+            plane.event_metadata().at(event.metadata_id()).name(), '_');\n+        uint64_t timestamp_ms;\n+        ASSERT_TRUE(absl::SimpleAtoi(parts.back(), &timestamp_ms))\n+            << \"Failed to parse timestamp from: \" << parts.back();\n+        events.push_back({\n+            plane.event_metadata().at(event.metadata_id()).name(),\n+            tsl::profiler::Timespan(\n+                line.timestamp_ns() * 1000 + event.offset_ps(),\n+                event.duration_ps()),\n+            timestamp_ms,\n+        });\n+      }\n+    }\n+  }\n+\n+  std::sort(events.begin(), events.end(),\n+            [](const EventInfo& a, const EventInfo& b) {\n+              return a.timespan < b.timespan;\n+            });\n+  EventInfo first_event = events[0];\n+  for (const auto& event : events) {\n+    SCOPED_TRACE(absl::StrCat(\"Event: \", event.name));\n+    // Give some tolerance to the offsets to reduce flakiness.\n+    EXPECT_NEAR(event.timestamp_ms - first_event.timestamp_ms,\n+                tsl::profiler::PicoToMilli(event.timespan.begin_ps() -\n+                                           first_event.timespan.begin_ps()),\n+                50);\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 101,
        "additions": 85,
        "deletions": 16
    }
}