{
    "author": "matthiaskramm",
    "message": "Add new compile option `allow_in_place_mlir_modification`.\n\nPiperOrigin-RevId: 816951619",
    "sha": "5a0457cf93e0cb02e13d4512842906448e339d0a",
    "files": [
        {
            "sha": "1638398240e57a91d2ee42ff8e7c1f7cd5f03865",
            "filename": "third_party/xla/xla/pjrt/pjrt_executable.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.cc?ref=5a0457cf93e0cb02e13d4512842906448e339d0a",
            "patch": "@@ -82,6 +82,7 @@ absl::StatusOr<CompileOptionsProto> CompileOptions::ToProto() const {\n       *output.add_argument_layouts() = layout.ToProto();\n     }\n   }\n+  output.set_allow_in_place_mlir_modification(allow_in_place_mlir_modification);\n   output.set_parameter_is_tupled_arguments(parameter_is_tupled_arguments);\n   TF_ASSIGN_OR_RETURN(*output.mutable_executable_build_options(),\n                       executable_build_options.ToProto());\n@@ -123,6 +124,8 @@ absl::StatusOr<CompileOptions> CompileOptions::FromProto(\n     }\n     output.argument_layouts = std::move(output_argument_layouts);\n   }\n+  output.allow_in_place_mlir_modification =\n+      proto.allow_in_place_mlir_modification();\n   output.parameter_is_tupled_arguments = proto.parameter_is_tupled_arguments();\n   TF_ASSIGN_OR_RETURN(\n       ExecutableBuildOptions executable_build_options,"
        },
        {
            "sha": "8b3171536215ec67577e59fd791466328f4f129e",
            "filename": "third_party/xla/xla/pjrt/pjrt_executable.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.h?ref=5a0457cf93e0cb02e13d4512842906448e339d0a",
            "patch": "@@ -113,7 +113,14 @@ struct CompileOptions {\n \n   std::optional<xla::Compiler::TargetConfig> target_config;\n \n+  // Allow to modify the input MLIR / XLA program.\n+  // This is used to run passes on the MLIR parameter without having to clone it\n+  // first, thus saving memory. Additionally, it allows us to deallocate the\n+  // MLIR later in the compile, when we don't use it anymore.\n+  bool allow_in_place_mlir_modification = false;\n+\n   // Used to indicate the precision configuration.\n+  // TODO(b/450278657): Not serialized into the proto. Should it be?\n   PrecisionConfig::Precision matrix_unit_operand_precision =\n       PrecisionConfig::DEFAULT;\n "
        },
        {
            "sha": "9d2cc1577e2cd1a596f2ec4cba469414e04d4698",
            "filename": "third_party/xla/xla/pjrt/pjrt_executable_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable_test.cc?ref=5a0457cf93e0cb02e13d4512842906448e339d0a",
            "patch": "@@ -41,6 +41,7 @@ TEST(CompileOptionsTest, Serialization) {\n   src.parameter_is_tupled_arguments = true;\n   src.profile_version = 1;\n   src.argument_layouts = {ShapeUtil::MakeShape(S32, {1})};\n+  src.allow_in_place_mlir_modification = true;\n   ExecutableBuildOptions build_option;\n   build_option.set_device_assignment(DeviceAssignment(1, 1));\n   src.executable_build_options = build_option;\n@@ -65,6 +66,13 @@ TEST(CompileOptionsTest, DeserializeSerializedMultiSliceConfig) {\n   EXPECT_EQ(option.serialized_multi_slice_config, serialized_config);\n }\n \n+TEST(CompileOptionsTest, Defaults) {\n+  CompileOptions src;\n+  EXPECT_EQ(src.compile_portable_executable, false);\n+  EXPECT_EQ(src.parameter_is_tupled_arguments, false);\n+  EXPECT_EQ(src.allow_in_place_mlir_modification, false);\n+}\n+\n TEST(ExecuteOptionsTest, Serialization) {\n   ExecuteOptions src;\n   src.arguments_are_tupled = true;"
        },
        {
            "sha": "c51645e7373b5e42f45bb514e999a2723f0cb0ab",
            "filename": "third_party/xla/xla/pjrt/proto/compile_options.proto",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fcompile_options.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5a0457cf93e0cb02e13d4512842906448e339d0a/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fcompile_options.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fcompile_options.proto?ref=5a0457cf93e0cb02e13d4512842906448e339d0a",
            "patch": "@@ -166,8 +166,8 @@ message CompileOptionsProto {\n   int64 profile_version = 5;\n   bytes serialized_multi_slice_config = 6;\n   map<string, OptionOverrideProto> env_option_overrides = 7;\n-\n   stream_executor.GpuTargetConfigProto target_config = 8;\n+  bool allow_in_place_mlir_modification = 9;\n }\n \n // Helper for serializing opaque executables alongside CompileOptions."
        }
    ],
    "stats": {
        "total": 20,
        "additions": 19,
        "deletions": 1
    }
}