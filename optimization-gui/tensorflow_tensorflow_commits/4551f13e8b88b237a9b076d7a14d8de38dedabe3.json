{
    "author": "tensorflower-gardener",
    "message": "Makes XLA builder use full unique id (with parent computation's id) for the root_id of Resulting Computation Protos.\n\nPiperOrigin-RevId: 806314461",
    "sha": "4551f13e8b88b237a9b076d7a14d8de38dedabe3",
    "files": [
        {
            "sha": "210fe044eed355127ee54446ef1ad623df726823",
            "filename": "third_party/xla/xla/hlo/builder/xla_builder.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4551f13e8b88b237a9b076d7a14d8de38dedabe3/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4551f13e8b88b237a9b076d7a14d8de38dedabe3/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc?ref=4551f13e8b88b237a9b076d7a14d8de38dedabe3",
            "patch": "@@ -926,7 +926,7 @@ absl::Status XlaBuilder::BuildComputationProto(int64_t root_id,\n   SetProtoIdAndName(&proto, name_, kNameSeparator, computation_id);\n   TF_ASSIGN_OR_RETURN(ProgramShape program_shape, GetProgramShape(root_id));\n   *proto.mutable_program_shape() = program_shape.ToProto();\n-  proto.set_root_id(root_id);\n+  proto.set_root_id(HloInstruction::CalculateUniqueId(computation_id, root_id));\n \n   for (auto& instruction : instructions_) {\n     // Ensures that the instruction names are unique among the whole graph."
        },
        {
            "sha": "91ddbb851b5da0952ac158dd9c2c59952c32be9d",
            "filename": "third_party/xla/xla/hlo/builder/xla_builder_test.cc",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4551f13e8b88b237a9b076d7a14d8de38dedabe3/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4551f13e8b88b237a9b076d7a14d8de38dedabe3/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder_test.cc?ref=4551f13e8b88b237a9b076d7a14d8de38dedabe3",
            "patch": "@@ -70,6 +70,7 @@ namespace m = ::xla::match;\n \n using ::testing::_;\n using ::testing::HasSubstr;\n+using ::testing::Property;\n using ::testing::Test;\n using ::tsl::testing::StatusIs;\n \n@@ -4031,5 +4032,38 @@ TEST(XlaBuilderTest, InstructionNameFromMetadataWithDot) {\n             \"inputs_x\");\n }\n \n+TEST(XlaBuilderTest, BuildProtoWritesFullRootId) {\n+  XlaBuilder b_root(TestName());\n+\n+  auto b_call = b_root.CreateSubBuilder(\"the_only_to_apply\");\n+  auto p0 = Parameter(b_call.get(), 0, ShapeUtil::MakeShape(F32, {}), \"p0\");\n+  auto p1 = Parameter(b_call.get(), 1, ShapeUtil::MakeShape(F32, {}), \"p1\");\n+  Add(p0, p1);\n+  TF_ASSERT_OK_AND_ASSIGN(XlaComputationId call, b_call->BuildSubComputation());\n+\n+  std::unique_ptr<XlaBuilder> b = b_root.CreateSubBuilder(\"main\");\n+\n+  auto x = Parameter(b.get(), 0, ShapeUtil::MakeShape(F32, {}), \"x\");\n+  auto y = Parameter(b.get(), 1, ShapeUtil::MakeShape(F32, {}), \"y\");\n+  auto one = ConstantR0<float>(b.get(), 1);\n+  auto two = ConstantR0<float>(b.get(), 2);\n+  Add(Call(b.get(), call, {x, y}), Call(b.get(), call, {one, two}));\n+  TF_ASSERT_OK_AND_ASSIGN(XlaComputationId main, b->BuildSubComputation());\n+\n+  TF_ASSERT_OK_AND_ASSIGN(XlaComputation computation, b_root.Build(main));\n+  const HloModuleProto& proto = computation.proto();\n+\n+  EXPECT_EQ(proto.computations_size(), 2);\n+  // Root ids should be full unique ids and match the unique id of an\n+  // instruction.\n+  for (const HloComputationProto& computation_proto : proto.computations()) {\n+    EXPECT_THAT(computation_proto.instructions(),\n+                Contains(Property(\n+                    &HloInstructionProto::id,\n+                    HloInstruction::CalculateUniqueId(\n+                        computation_proto.id(), computation_proto.root_id()))));\n+  }\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 35,
        "deletions": 1
    }
}