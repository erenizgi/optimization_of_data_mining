{
    "author": "beckerhe",
    "message": "Remove LeakCheckDisabler on CUDA 13+\n\nThe leak in libnvptxcompiler has been fixed in CUDA 13, therefore\nthe LeakCheckDisabler is not needed anymore when the library version is 13 or above.\n\nPiperOrigin-RevId: 802419752",
    "sha": "ef124a9d7e38af24c48820a63e5b1204df5d1bae",
    "files": [
        {
            "sha": "dfd710c38410a7cc2828062fbe4c4d6cd810bcaa",
            "filename": "third_party/xla/xla/stream_executor/cuda/nvjitlink_impl.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef124a9d7e38af24c48820a63e5b1204df5d1bae/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fnvjitlink_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef124a9d7e38af24c48820a63e5b1204df5d1bae/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fnvjitlink_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fnvjitlink_impl.cc?ref=ef124a9d7e38af24c48820a63e5b1204df5d1bae",
            "patch": "@@ -283,10 +283,13 @@ absl::StatusOr<int> GetLatestPtxIsaVersionForLibNvJitLink() {\n     return ToStatus(create_result, error_log);\n   }\n \n-  // TODO(b/437088681): Re-enable heap checking when calling\n-  // nvJitLinkAddData. The compiler does not seem to free resources properly\n-  // on error.\n-  absl::LeakCheckDisabler disabler;\n+  std::optional<absl::LeakCheckDisabler> disabler;\n+  absl::StatusOr<NvJitLinkVersion> version = GetNvJitLinkVersion();\n+  if (!version.ok() || std::get<0>(*version) < 13) {\n+    // libnvjitlink prior to CUDA 13 has a memory leak when calling\n+    // nvJitLinkAddData when the input PTX is invalid.\n+    disabler.emplace();\n+  }\n \n   nvJitLinkResult result =\n       nvJitLinkAddData(link_handle, NVJITLINK_INPUT_PTX, ptx_contents.data(),"
        },
        {
            "sha": "49fa2972776b502b349cbcdaa7a41826a9f859a6",
            "filename": "third_party/xla/xla/stream_executor/cuda/ptx_compiler_impl.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef124a9d7e38af24c48820a63e5b1204df5d1bae/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fptx_compiler_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef124a9d7e38af24c48820a63e5b1204df5d1bae/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fptx_compiler_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fptx_compiler_impl.cc?ref=ef124a9d7e38af24c48820a63e5b1204df5d1bae",
            "patch": "@@ -210,10 +210,14 @@ absl::StatusOr<int> GetLatestPtxIsaVersionForNvptxCompiler() {\n     nvPTXCompilerDestroy(&compiler_handle);\n   };\n \n-  // TODO(b/437088681): Re-enable heap checking when calling\n-  // nvPTXCompilerCompile. The compiler does not seem to free resources properly\n-  // on error.\n-  absl::LeakCheckDisabler disabler;\n+  std::optional<absl::LeakCheckDisabler> disabler;\n+  TF_ASSIGN_OR_RETURN(SemanticVersion version, GetLibNvPtxCompilerVersion());\n+  if (version < SemanticVersion(13, 0, 0)) {\n+    // libNvptxCompiler prior to CUDA 13 has a memory leak when calling\n+    // nvPTXCompilerCompile when the input PTX is invalid.\n+    disabler.emplace();\n+  }\n+\n   std::vector<const char*> opts{};\n   nvPTXCompileResult compile_result =\n       nvPTXCompilerCompile(compiler_handle, opts.size(), opts.data());"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 15,
        "deletions": 8
    }
}