{
    "author": "tensorflower-gardener",
    "message": "[SymbolicMap] Implement Get, GetContext, GetConstantResults methods\n\nPiperOrigin-RevId: 799487918",
    "sha": "55b94336ab3e6daddb1dc34ad029f44fae83362b",
    "files": [
        {
            "sha": "a77ed1dc66439c1f3ae09a2dc8473b1316e05357",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD?ref=55b94336ab3e6daddb1dc34ad029f44fae83362b",
            "patch": "@@ -215,6 +215,8 @@ cc_library(\n     hdrs = [\"symbolic_map.h\"],\n     deps = [\n         \":symbolic_expr\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@llvm-project//llvm:Support\",\n     ],\n )\n \n@@ -225,6 +227,7 @@ xla_cc_test(\n         \":symbolic_expr\",\n         \":symbolic_map\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@llvm-project//llvm:Support\",\n     ],\n )\n "
        },
        {
            "sha": "44bc74eb8f16ac418b207f5df0cc306ffd6a13fe",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 3,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=55b94336ab3e6daddb1dc34ad029f44fae83362b",
            "patch": "@@ -19,17 +19,27 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"absl/log/check.h\"\n+#include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n namespace xla {\n namespace gpu {\n \n-SymbolicMap::SymbolicMap(int64_t num_dimensions, int64_t num_symbols,\n-                         std::vector<SymbolicExpr> exprs)\n-    : num_dimensions_(num_dimensions),\n+SymbolicMap::SymbolicMap(SymbolicExprContext* ctx, int64_t num_dimensions,\n+                         int64_t num_symbols, std::vector<SymbolicExpr> exprs)\n+    : ctx_(ctx),\n+      num_dimensions_(num_dimensions),\n       num_symbols_(num_symbols),\n       exprs_(std::move(exprs)) {}\n \n+/*static*/ SymbolicMap SymbolicMap::Get(SymbolicExprContext* ctx,\n+                                        int64_t num_dimensions,\n+                                        int64_t num_symbols,\n+                                        std::vector<SymbolicExpr> exprs) {\n+  return SymbolicMap(ctx, num_dimensions, num_symbols, std::move(exprs));\n+}\n+\n bool SymbolicMap::IsIdentity() const {\n   if (num_dimensions_ != GetNumResults()) {\n     return false;\n@@ -43,5 +53,24 @@ bool SymbolicMap::IsIdentity() const {\n   return true;\n }\n \n+bool SymbolicMap::IsConstant() const {\n+  for (const auto& expr : exprs_) {\n+    if (expr.GetType() != SymbolicExprType::kConstant) {\n+      return false;\n+    }\n+  }\n+  return true;\n+}\n+\n+llvm::SmallVector<int64_t> SymbolicMap::GetConstantResults() const {\n+  CHECK(IsConstant()) << \"Cannot get constant results from a non-constant map\";\n+  llvm::SmallVector<int64_t> constants;\n+  constants.reserve(exprs_.size());\n+  for (const auto& expr : exprs_) {\n+    constants.push_back(expr.GetValue());\n+  }\n+  return constants;\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "f90c62f6a756e1a3ae6a47cf381b5995a45d50a2",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=55b94336ab3e6daddb1dc34ad029f44fae83362b",
            "patch": "@@ -19,17 +19,21 @@ limitations under the License.\n #include <cstdint>\n #include <vector>\n \n+#include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n namespace xla {\n namespace gpu {\n \n+class SymbolicExprContext;\n+\n // Maps a set of input variables to a set of output SymbolicExpr trees.\n class SymbolicMap {\n  public:\n-  SymbolicMap(int64_t num_dimensions, int64_t num_symbols,\n-              std::vector<SymbolicExpr> exprs);\n+  static SymbolicMap Get(SymbolicExprContext* ctx, int64_t num_dimensions,\n+                         int64_t num_symbols, std::vector<SymbolicExpr> exprs);\n \n+  SymbolicExprContext* GetContext() const { return ctx_; }\n   int64_t GetNumDims() const { return num_dimensions_; }\n   int64_t GetNumSymbols() const { return num_symbols_; }\n   int64_t GetNumResults() const { return exprs_.size(); }\n@@ -42,7 +46,18 @@ class SymbolicMap {\n   // at the same index. Symbols are not considered in this check.\n   bool IsIdentity() const;\n \n+  // Returns true if all result expressions are constant.\n+  bool IsConstant() const;\n+\n+  // Returns a vector containing the values of all the results. CHECK-fails if\n+  // any result expression is not a constant.\n+  llvm::SmallVector<int64_t> GetConstantResults() const;\n+\n  private:\n+  SymbolicMap(SymbolicExprContext* ctx, int64_t num_dimensions,\n+              int64_t num_symbols, std::vector<SymbolicExpr> exprs);\n+\n+  SymbolicExprContext* ctx_;\n   int64_t num_dimensions_;\n   int64_t num_symbols_;\n   std::vector<SymbolicExpr> exprs_;"
        },
        {
            "sha": "0526c3f3e150355bb661b0cbf08e5a8ac1f532e8",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 48,
            "deletions": 22,
            "changes": 70,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55b94336ab3e6daddb1dc34ad029f44fae83362b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=55b94336ab3e6daddb1dc34ad029f44fae83362b",
            "patch": "@@ -17,42 +17,68 @@ limitations under the License.\n \n #include <vector>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n namespace xla {\n namespace gpu {\n namespace {\n \n+using ::testing::ElementsAre;\n+\n TEST(SymbolicMapTest, IsEmpty) {\n   SymbolicExprContext ctx;\n-  EXPECT_TRUE(SymbolicMap(0, 0, {}).IsEmpty());\n-  EXPECT_TRUE(SymbolicMap(2, 1, {}).IsEmpty());\n-  EXPECT_FALSE(SymbolicMap(1, 0, {ctx.CreateVariable(0)}).IsEmpty());\n+  EXPECT_TRUE(SymbolicMap::Get(&ctx, 0, 0, {}).IsEmpty());\n+  EXPECT_TRUE(SymbolicMap::Get(&ctx, 2, 1, {}).IsEmpty());\n+  EXPECT_FALSE(SymbolicMap::Get(&ctx, 1, 0, {ctx.CreateVariable(0)}).IsEmpty());\n }\n \n TEST(SymbolicMapTest, IsIdentity) {\n   SymbolicExprContext ctx;\n \n-  // True identity\n-  EXPECT_TRUE(SymbolicMap(2, 0, {ctx.CreateVariable(0), ctx.CreateVariable(1)})\n-                  .IsIdentity());\n-  // True identity with symbols\n-  EXPECT_TRUE(SymbolicMap(2, 1, {ctx.CreateVariable(0), ctx.CreateVariable(1)})\n-                  .IsIdentity());\n-\n-  // False: Wrong number of results\n-  EXPECT_FALSE(SymbolicMap(2, 0, {ctx.CreateVariable(0)}).IsIdentity());\n-  EXPECT_FALSE(SymbolicMap(1, 0, {ctx.CreateVariable(0), ctx.CreateVariable(1)})\n-                   .IsIdentity());\n-\n-  // False: Wrong expression type\n-  EXPECT_FALSE(SymbolicMap(2, 0, {ctx.CreateVariable(0), ctx.CreateConstant(1)})\n-                   .IsIdentity());\n-\n-  // False: Wrong variable ID\n-  EXPECT_FALSE(SymbolicMap(2, 0, {ctx.CreateVariable(1), ctx.CreateVariable(0)})\n-                   .IsIdentity());\n+  SymbolicMap true_identity = SymbolicMap::Get(\n+      &ctx, 2, 0, {ctx.CreateVariable(0), ctx.CreateVariable(1)});\n+  EXPECT_TRUE(true_identity.IsIdentity());\n+\n+  SymbolicMap true_identity_with_symbols = SymbolicMap::Get(\n+      &ctx, 2, 1, {ctx.CreateVariable(0), ctx.CreateVariable(1)});\n+  EXPECT_TRUE(true_identity_with_symbols.IsIdentity());\n+\n+  SymbolicMap few_results =\n+      SymbolicMap::Get(&ctx, 2, 0, {ctx.CreateVariable(0)});\n+  EXPECT_FALSE(few_results.IsIdentity());\n+\n+  SymbolicMap too_many_results = SymbolicMap::Get(\n+      &ctx, 1, 0, {ctx.CreateVariable(0), ctx.CreateVariable(1)});\n+  EXPECT_FALSE(too_many_results.IsIdentity());\n+\n+  SymbolicMap wrong_expr_type = SymbolicMap::Get(\n+      &ctx, 2, 0, {ctx.CreateVariable(0), ctx.CreateConstant(1)});\n+  EXPECT_FALSE(wrong_expr_type.IsIdentity());\n+\n+  SymbolicMap unordered_variable_id = SymbolicMap::Get(\n+      &ctx, 2, 0, {ctx.CreateVariable(1), ctx.CreateVariable(0)});\n+  EXPECT_FALSE(unordered_variable_id.IsIdentity());\n+}\n+\n+TEST(SymbolicMapTest, GetConstantResults) {\n+  SymbolicExprContext ctx;\n+\n+  SymbolicMap all_constants_map = SymbolicMap::Get(\n+      &ctx, 0, 0, {ctx.CreateConstant(5), ctx.CreateConstant(10)});\n+  EXPECT_TRUE(all_constants_map.IsConstant());\n+  EXPECT_THAT(all_constants_map.GetConstantResults(), ElementsAre(5, 10));\n+\n+  SymbolicMap mixed_map = SymbolicMap::Get(\n+      &ctx, 1, 0, {ctx.CreateConstant(5), ctx.CreateVariable(0)});\n+  EXPECT_FALSE(mixed_map.IsConstant());\n+  EXPECT_DEATH(mixed_map.GetConstantResults(),\n+               \"Cannot get constant results from a non-constant map\");\n+\n+  SymbolicMap no_results_map = SymbolicMap::Get(&ctx, 0, 0, {});\n+  EXPECT_TRUE(no_results_map.IsConstant());\n+  EXPECT_THAT(no_results_map.GetConstantResults(), ElementsAre());\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 100,
        "deletions": 27
    }
}