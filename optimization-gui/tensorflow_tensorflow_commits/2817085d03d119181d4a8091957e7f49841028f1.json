{
    "author": "felixwqp",
    "message": "Enhance `collective_perf_table_gen_main` to merge collective performance profiles and generate the new perf table profile including collective permutes.\n\nThis functionality can update the `kDefaultCollectivePTable` in `collective_interpolator_data.h`. The tool reads the current profiles from the header, merges them with new profiles provided as a file or directory of `.pbtxt` files, and writes the combined data back into the header file, replacing the existing proto string. This helps adding new collective into the perftable without changing existing perf table.\n\nPiperOrigin-RevId: 843377472",
    "sha": "2817085d03d119181d4a8091957e7f49841028f1",
    "files": [
        {
            "sha": "ac73cffff1ef0d939a9f942e08da3a7c5cba9677",
            "filename": "third_party/xla/xla/service/gpu/model/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD?ref=2817085d03d119181d4a8091957e7f49841028f1",
            "patch": "@@ -921,6 +921,12 @@ xla_cc_test(\n     ],\n )\n \n+cc_library(\n+    name = \"collective_interpolator_data\",\n+    hdrs = [\"collective_interpolator_data.h\"],\n+    compatible_with = get_compatible_with_portable(),\n+)\n+\n cc_library(\n     name = \"collective_interpolator\",\n     srcs = [\"collective_interpolator.cc\"],\n@@ -929,6 +935,7 @@ cc_library(\n         \"collective_interpolator_data.h\",\n     ],\n     deps = [\n+        \":collective_interpolator_data\",\n         \":gpu_hlo_cost_analysis\",\n         \":hlo_op_profile_proto_cc\",\n         \":hlo_op_profiles\","
        },
        {
            "sha": "ac9a6fc357173803096d6cbf5e7fe7d151d45956",
            "filename": "third_party/xla/xla/service/gpu/model/collective_interpolator_data.h",
            "status": "modified",
            "additions": 8287,
            "deletions": 4767,
            "changes": 13054,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fcollective_interpolator_data.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fcollective_interpolator_data.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fcollective_interpolator_data.h?ref=2817085d03d119181d4a8091957e7f49841028f1"
        },
        {
            "sha": "56acaa4060e3434ecfb2032c9e885c6a5d073461",
            "filename": "third_party/xla/xla/tools/BUILD",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2FBUILD?ref=2817085d03d119181d4a8091957e7f49841028f1",
            "patch": "@@ -795,12 +795,21 @@ cc_library(\n         \":collective_perf_table_gen\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/parser:hlo_parser\",\n+        \"//xla/service/gpu/model:collective_interpolator_data\",\n         \"//xla/service/gpu/model:hlo_op_profile_proto_cc\",\n+        \"//xla/tsl/platform:env\",\n+        \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/util:command_line_flags\",\n+        \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_protobuf//:protobuf\",\n+        \"@local_tsl//tsl/platform:env\",\n+        \"@local_tsl//tsl/platform:errors\",\n+        \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:platform_port\",\n     ] + if_cuda([\n         \"//xla/service:gpu_plugin\","
        },
        {
            "sha": "2ec4b59813245e997db333996dc7cc5272cc81a5",
            "filename": "third_party/xla/xla/tools/collective_perf_table_gen_main.cc",
            "status": "modified",
            "additions": 131,
            "deletions": 1,
            "changes": 132,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2817085d03d119181d4a8091957e7f49841028f1/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen_main.cc?ref=2817085d03d119181d4a8091957e7f49841028f1",
            "patch": "@@ -18,23 +18,32 @@ limitations under the License.\n \n #include <cstddef>\n #include <cstdint>\n+#include <cstdlib>\n #include <iostream>\n+#include <iterator>\n #include <memory>\n #include <string>\n #include <utility>\n #include <vector>\n \n+#include \"absl/algorithm/container.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/strings/substitute.h\"\n+#include \"google/protobuf/text_format.h\"\n+#include \"xla/service/gpu/model/collective_interpolator_data.h\"\n #include \"xla/service/gpu/model/hlo_op_profile.pb.h\"\n #include \"xla/tools/collective_perf_table_gen.h\"\n+#include \"xla/tsl/platform/env.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/util/command_line_flags.h\"\n #include \"tsl/platform/init_main.h\"\n+#include \"tsl/platform/path.h\"\n \n namespace {\n \n@@ -72,6 +81,24 @@ to 4 GPUs.\n   (--tensor_size_bytes_spec)\n * AllReduce will run across all 8 devices.\n   (--collective_devices_spec, HloShardingV2 format)\n+\n+This tool can also merge new profiles (either generated or loaded using\n+--merge or --merge_path) into the static performance table defined in\n+a C++ header file, e.g. `collective_interpolator_data.h`.\n+Use `--update_header_path` to specify header file to update in-place.\n+\n+Example for generating COLLECTIVE_PERMUTE profiles:\n+  CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 bazel run --config=cuda  -- \\\n+    tools:collective_perf_table_gen_main  \\\n+    --num_nodes=1 --task_id=0 --collectives=COLLECTIVE_PERMUTE \\\n+    --collective_devices_spec='[1,8]<=[8]' \\\n+    --tensor_size_bytes_spec='start=1024,stop=2147483648,factor=2' \\\n+\n+Example for merging profiles from `cp_perf_table.pbtxt` into\n+`service/gpu/model/collective_interpolator_data.h`:\n+  bazel run tools:collective_perf_table_gen_main -- \\\n+    --merge=cp_perf_table.pbtxt \\\n+    --update_header_path=service/gpu/model/collective_interpolator_data.h\n )\";\n \n constexpr absl::string_view kDefaultCoordinatorAddress = \"127.0.0.1:1234\";\n@@ -161,6 +188,93 @@ std::string DefaultCollectiveDevicesIfEmpty(\n   return collective_devices_spec_unparsed;\n }\n \n+// Helper to get full path if running under bazel run.\n+std::string GetFullPath(const std::string& path) {\n+  if (tsl::io::IsAbsolutePath(path)) {\n+    return path;\n+  }\n+  const char* build_workspace_dir = getenv(\"BUILD_WORKSPACE_DIRECTORY\");\n+  if (build_workspace_dir != nullptr) {\n+    return tsl::io::JoinPath(build_workspace_dir, path);\n+  }\n+  return path;  // Fallback to relative path if not in bazel run\n+}\n+\n+// Helper to inject proto string into header by replacing content between\n+// R\"pb( and )pb tags.\n+// Note: this function assumes there is only one R\"pb(...)pb\" block in the\n+// header file, and finds the first opening tag R\"pb(\\n and last closing tag\n+// \\n)pb\".\n+std::string InjectProtoToString(const std::string& header_content,\n+                                const std::string& new_proto_string) {\n+  const std::string start_str = \"R\\\"pb(\\n\";\n+  const std::string end_str = \"\\n)pb\";\n+  size_t start = header_content.find(start_str);\n+  size_t end = header_content.rfind(end_str);\n+  CHECK(start != std::string::npos && end != std::string::npos);\n+  start += start_str.length();\n+\n+  std::string result = header_content.substr(0, start);\n+  result += new_proto_string;\n+  result += header_content.substr(end);\n+  return result;\n+}\n+\n+absl::Status UpdateHeader(const DeviceHloInstructionProfiles& new_profiles,\n+                          const std::string& header_path_flag,\n+                          CollectivePerfTableGen* gen) {\n+  std::string header_path = GetFullPath(header_path_flag);\n+\n+  // 1. Parse kDefaultCollectivePTable to get current profiles\n+  DeviceHloInstructionProfiles current_profiles_proto;\n+  CHECK(tsl::protobuf::TextFormat::ParseFromString(kDefaultCollectivePTable,\n+                                                   &current_profiles_proto));\n+  std::string current_profiles_pbtxt;\n+  tsl::protobuf::TextFormat::PrintToString(current_profiles_proto,\n+                                           &current_profiles_pbtxt);\n+\n+  // 2. Save current profiles to temp file\n+  std::string temp_file_current =\n+      tsl::io::JoinPath(\"/tmp\", \"xla_gpu_perf_merge_current.pbtxt\");\n+  TF_RETURN_IF_ERROR(tsl::WriteStringToFile(\n+      tsl::Env::Default(), temp_file_current, current_profiles_pbtxt));\n+\n+  // 3. Save new profiles to temp file\n+  std::string new_profiles_pbtxt;\n+  tsl::protobuf::TextFormat::PrintToString(new_profiles, &new_profiles_pbtxt);\n+  std::string temp_file_new =\n+      tsl::io::JoinPath(\"/tmp\", \"xla_gpu_perf_merge_new.pbtxt\");\n+  TF_RETURN_IF_ERROR(tsl::WriteStringToFile(tsl::Env::Default(), temp_file_new,\n+                                            new_profiles_pbtxt));\n+\n+  // 4. Merge\n+  std::vector<std::string> files_to_merge = {temp_file_current, temp_file_new};\n+  DeviceHloInstructionProfiles merged_profiles = gen->Merge(files_to_merge);\n+\n+  // 5. Format as text\n+  tsl::protobuf::TextFormat::Printer printer;\n+  printer.SetInitialIndentLevel(1);\n+  std::string merged_profiles_pbtxt;\n+  printer.PrintToString(merged_profiles, &merged_profiles_pbtxt);\n+  // The printer might add a trailing newline which we don't want inside\n+  // R\"pb(...)pb\" to avoid unnecessary ClangTidy warnings.\n+  if (!merged_profiles_pbtxt.empty() && merged_profiles_pbtxt.back() == '\\n') {\n+    merged_profiles_pbtxt.pop_back();\n+  }\n+\n+  // 6. Update header\n+  std::string header_content;\n+  TF_RETURN_IF_ERROR(\n+      tsl::ReadFileToString(tsl::Env::Default(), header_path, &header_content));\n+  std::string new_header_content =\n+      InjectProtoToString(header_content, merged_profiles_pbtxt);\n+  TF_RETURN_IF_ERROR(tsl::WriteStringToFile(tsl::Env::Default(), header_path,\n+                                            new_header_content));\n+\n+  LOG(INFO) << \"Successfully merged profiles into \" << header_path_flag;\n+  return absl::OkStatus();\n+}\n+\n }  // namespace\n \n int main(int argc, char* argv[]) {\n@@ -178,6 +292,7 @@ int main(int argc, char* argv[]) {\n   std::string output = std::string(CollectivePerfTableGen::Config::kStdout);\n   std::string merge_path;\n   std::vector<std::string> merge_files;\n+  std::string update_header_path;\n \n   // Parse flags.\n   std::vector<tsl::Flag> flag_list = {\n@@ -219,6 +334,9 @@ int main(int argc, char* argv[]) {\n           \"none\",\n           \"Path to individual DeviceHloInstructionProfiles files. If \"\n           \"specified, these files will be merged into a single one.\"),\n+      tsl::Flag(\n+          \"update_header_path\", &update_header_path,\n+          \"Path to C++ header file to update in-place with new profiles.\"),\n   };\n \n   std::string kUsageString =\n@@ -248,10 +366,22 @@ int main(int argc, char* argv[]) {\n   if (!merge_path.empty()) {\n     profiles = gen->Merge(merge_path);\n   } else if (!merge_files.empty()) {\n-    profiles = gen->Merge(merge_files);\n+    std::vector<std::string> full_path_merge_files;\n+    full_path_merge_files.reserve(merge_files.size());\n+    absl::c_transform(merge_files, std::back_inserter(full_path_merge_files),\n+                      GetFullPath);\n+    profiles = gen->Merge(full_path_merge_files);\n   } else {\n     profiles = gen->ComputeTable();\n   }\n+\n+  if (!update_header_path.empty()) {\n+    CHECK_OK(UpdateHeader(profiles, update_header_path, gen.get()));\n+    if (output == CollectivePerfTableGen::Config::kStdout) {\n+      return 0;  // If header is updated, avoid printing to stdout.\n+    }\n+  }\n+\n   CHECK_OK(gen->Dump(profiles));\n   return 0;\n }"
        }
    ],
    "stats": {
        "total": 13202,
        "additions": 8434,
        "deletions": 4768
    }
}