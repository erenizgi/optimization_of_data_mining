{
    "author": "golechwierowicz",
    "message": "[XLA:GPU] Statically read default profiles.\n\nPiperOrigin-RevId: 811416873",
    "sha": "42c7344f0883bca10487be8a144e7a09f22e3285",
    "files": [
        {
            "sha": "1ff7048c0cb2ce9620bf397078dccbc14aa9cfbf",
            "filename": "third_party/xla/xla/service/gpu/model/collective_interpolator.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 8,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/42c7344f0883bca10487be8a144e7a09f22e3285/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fcollective_interpolator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/42c7344f0883bca10487be8a144e7a09f22e3285/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fcollective_interpolator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fcollective_interpolator.cc?ref=42c7344f0883bca10487be8a144e7a09f22e3285",
            "patch": "@@ -56,6 +56,17 @@ namespace xla::gpu {\n \n namespace {\n \n+static const DeviceHloInstructionProfiles& Profile() {\n+  static const DeviceHloInstructionProfiles* profile = []() {\n+    auto* profile = new DeviceHloInstructionProfiles();\n+    CHECK(tsl::protobuf::TextFormat::ParseFromString(kDefaultCollectivePTable,\n+                                                     profile))\n+        << \"Cannot parse a default profile.\";\n+    return profile;\n+  }();\n+  return *profile;\n+}\n+\n constexpr int64_t kMaxDefaultTransferSizeBytes = 1 << 30;\n \n constexpr int64_t kMinDefaultTransferSizeBytes = 1 << 10;\n@@ -322,18 +333,12 @@ HloOpcode AsyncToSyncOpcode(const HloCollectiveInstruction& instr) {\n \n absl::StatusOr<HloInstructionProfileList> ReadDefaultProfiles(\n     const se::DeviceDescription& device_info) {\n-  DeviceHloInstructionProfiles profile;\n-\n-  if (!tsl::protobuf::TextFormat::ParseFromString(kDefaultCollectivePTable,\n-                                                  &profile)) {\n-    return absl::FailedPreconditionError(\"Cannot parse a default profile.\");\n-  }\n   std::string key = HloOpProfiles::GetProfileName(device_info);\n \n-  if (!profile.entries().contains(key)) {\n+  if (!Profile().entries().contains(key)) {\n     return absl::NotFoundError(absl::StrCat(\"Cannot find key: \", key));\n   }\n-  return profile.entries().at(key);\n+  return Profile().entries().at(key);\n }\n \n int64_t GetBytesTransferred(const HloInstruction& instr,"
        },
        {
            "sha": "f2fdfc12e659b31edbc47f8462f261581e9de47f",
            "filename": "third_party/xla/xla/service/gpu/model/matmul_interpolator.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/42c7344f0883bca10487be8a144e7a09f22e3285/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/42c7344f0883bca10487be8a144e7a09f22e3285/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator.cc?ref=42c7344f0883bca10487be8a144e7a09f22e3285",
            "patch": "@@ -54,6 +54,17 @@ limitations under the License.\n namespace xla::gpu {\n namespace {\n \n+static const GemmPerfTable& Profile() {\n+  static const GemmPerfTable* profile = []() {\n+    auto* profile = new GemmPerfTable();\n+    CHECK(tsl::protobuf::TextFormat::ParseFromString(kDefaultMatmulPTable,\n+                                                     profile))\n+        << \"Cannot parse a default profile.\";\n+    return profile;\n+  }();\n+  return *profile;\n+}\n+\n struct InterpolationSpecification {\n   int b;\n   // Matmul dimensions are normalized to a number of bytes of output type.\n@@ -174,17 +185,12 @@ InterpolationSpecification Spec(const HloFusionInstruction& dot_fusion,\n \n absl::StatusOr<GemmPerfTableEntryValues> ReadDefaultProfile(\n     const se::DeviceDescription& device_info) {\n-  GemmPerfTable table;\n-  if (!tsl::protobuf::TextFormat::ParseFromString(kDefaultMatmulPTable,\n-                                                  &table)) {\n-    return absl::FailedPreconditionError(\"Cannot parse a default perf table.\");\n-  }\n   std::string key = HloOpProfiles::GetProfileName(device_info);\n \n-  if (!table.entries().contains(key)) {\n+  if (!Profile().entries().contains(key)) {\n     return absl::NotFoundError(absl::StrCat(\"Cannot find key: \", key));\n   }\n-  return table.entries().at(key);\n+  return Profile().entries().at(key);\n }\n \n std::optional<InterpolationSpecification> GetInterpolationSpec("
        }
    ],
    "stats": {
        "total": 41,
        "additions": 26,
        "deletions": 15
    }
}