{
    "author": "alexander-shaposhnikov",
    "message": "Add more extensive dot tests for XNNPACK.\n\nPiperOrigin-RevId: 796959052",
    "sha": "047acf02900d2cdded738a3bc34092c9b8991c02",
    "files": [
        {
            "sha": "0122b93c7ba3b1da71dd5e5a876591580b4bc215",
            "filename": "third_party/xla/xla/debug_options_flags.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/047acf02900d2cdded738a3bc34092c9b8991c02/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/047acf02900d2cdded738a3bc34092c9b8991c02/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc?ref=047acf02900d2cdded738a3bc34092c9b8991c02",
            "patch": "@@ -1123,7 +1123,9 @@ void MakeDebugOptionsFlags(std::vector<tsl::Flag>* flag_list,\n       \"  `XNN_GRAPH_FUSION_MODE_GREEDY` - greedy extraction of \"\n       \"XNNPACK-compatible subgraphs starting from root instructions,\\n\"\n       \"  `XNN_GRAPH_FUSION_MODE_GREEDY_SLINKY` - same as GREEDY plus \"\n-      \"operations that are only supported with slinky.\"));\n+      \"operations that are only supported with slinky,\"\n+      \"  `XNN_GRAPH_FUSION_MODE_BYPASS_COST_MODEL` - test-only value for \"\n+      \"disabling XNNPACK cost models.\"));\n   flag_list->push_back(tsl::Flag(\n       \"xla_cpu_parallel_codegen_split_count\",\n       int32_setter_for(&DebugOptions::set_xla_cpu_parallel_codegen_split_count),"
        },
        {
            "sha": "721f4fa27230d7bc9af7853b47c599d47d72c33c",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/047acf02900d2cdded738a3bc34092c9b8991c02/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/047acf02900d2cdded738a3bc34092c9b8991c02/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc?ref=047acf02900d2cdded738a3bc34092c9b8991c02",
            "patch": "@@ -1157,10 +1157,15 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitDotThunk(\n       // Decide whether to use XNNPACK or Eigen.\n       bool use_xnn = hlo_module_config_.debug_options().xla_cpu_use_xnnpack();\n       if (use_xnn) {\n+        const bool use_cost_model =\n+            hlo_module_config_.debug_options()\n+                .xla_cpu_experimental_xnn_graph_fusion_mode() !=\n+            DebugOptions::XNN_GRAPH_FUSION_MODE_BYPASS_COST_MODEL;\n         TF_ASSIGN_OR_RETURN(\n-            use_xnn, IsDotSupportedByXnn(dnums, lhs->shape(), rhs->shape(),\n-                                         instruction->shape(),\n-                                         &target_machine_features_));\n+            use_xnn,\n+            IsDotSupportedByXnn(dnums, lhs->shape(), rhs->shape(),\n+                                instruction->shape(), &target_machine_features_,\n+                                use_cost_model));\n       }\n \n       if (use_xnn) {"
        },
        {
            "sha": "6d8f85391a3eed645f3ebf2aa9bb3e8d01a91461",
            "filename": "third_party/xla/xla/xla.proto",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/047acf02900d2cdded738a3bc34092c9b8991c02/third_party%2Fxla%2Fxla%2Fxla.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/047acf02900d2cdded738a3bc34092c9b8991c02/third_party%2Fxla%2Fxla%2Fxla.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fxla.proto?ref=047acf02900d2cdded738a3bc34092c9b8991c02",
            "patch": "@@ -156,6 +156,7 @@ message DebugOptions {\n     XNN_GRAPH_FUSION_MODE_DISABLED = 0;\n     XNN_GRAPH_FUSION_MODE_GREEDY = 1;\n     XNN_GRAPH_FUSION_MODE_GREEDY_SLINKY = 2;\n+    XNN_GRAPH_FUSION_MODE_BYPASS_COST_MODEL = 3;\n   }\n \n   // Use region analysis in copy insertion pass."
        }
    ],
    "stats": {
        "total": 16,
        "additions": 12,
        "deletions": 4
    }
}