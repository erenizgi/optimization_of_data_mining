{
    "author": "ermilovmaxim",
    "message": "convert Thunk::TransformAllNestedThunks to return absl::Status\n\nPiperOrigin-RevId: 832506922",
    "sha": "5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
    "files": [
        {
            "sha": "8eb7771f596484bd713f06833cf68418e7f02e8b",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -471,6 +471,7 @@ xla_cc_test(\n         \":thunk\",\n         \":thunk_proto_cc\",\n         \"//xla/service:buffer_assignment\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n@@ -1815,6 +1816,7 @@ xla_cc_test(\n         \":thunk\",\n         \":thunk_id\",\n         \":thunk_proto_cc\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n@@ -2098,7 +2100,7 @@ xla_test(\n         \"//xla/stream_executor:stream\",\n         \"//xla/stream_executor:stream_executor_memory_allocator\",\n         \"//xla/tests:hlo_pjrt_test_base\",\n-        \"//xla/tsl/platform:status_matchers\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/util/proto:parse_text_proto\","
        },
        {
            "sha": "337a5b40029358d6a7d562e59cf1382075f835ea",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_group_thunk.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -135,12 +135,15 @@ void CollectiveGroupThunk::ForAllThunksMutable(\n   }\n }\n \n-void CollectiveGroupThunk::TransformAllNestedThunks(\n-    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+absl::Status CollectiveGroupThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<\n+        absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+        fn) {\n   for (std::unique_ptr<Thunk>& thunk : thunks_) {\n-    thunk->TransformAllNestedThunks(fn);\n-    thunk = fn(std::move(thunk));\n+    TF_RETURN_IF_ERROR(thunk->TransformAllNestedThunks(fn));\n+    TF_ASSIGN_OR_RETURN(thunk, fn(std::move(thunk)));\n   }\n+  return absl::OkStatus();\n }\n \n }  // namespace gpu"
        },
        {
            "sha": "9b53dd8417dec0fd7db7cce1ab60b7d74fd2791d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_group_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.h?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -45,9 +45,10 @@ class CollectiveGroupThunk : public Thunk {\n   absl::Status Initialize(const InitializeParams& params) override;\n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n-  void TransformAllNestedThunks(\n-      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n-      override;\n+  absl::Status TransformAllNestedThunks(\n+      absl::FunctionRef<\n+          absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+          fn) override;\n \n   std::shared_ptr<CollectiveThunk::AsyncEvents> async_events() const {\n     return async_events_;"
        },
        {
            "sha": "244c6b53ad35c995ded0ac8409ceec294c3c7e2f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -165,12 +165,18 @@ void ConditionalThunk::ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) {\n   }\n }\n \n-void ConditionalThunk::TransformAllNestedThunks(\n-    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+absl::Status ConditionalThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<\n+        absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+        fn) {\n   for (std::unique_ptr<SequentialThunk>& branch_thunk : branch_thunks_) {\n-    branch_thunk->TransformAllNestedThunks(fn);\n-    branch_thunk = SequentialThunk::FromThunk(fn(std::move(branch_thunk)));\n+    TF_RETURN_IF_ERROR(branch_thunk->TransformAllNestedThunks(fn));\n+\n+    TF_ASSIGN_OR_RETURN(std::unique_ptr<Thunk> thunk,\n+                        fn(std::move(branch_thunk)));\n+    branch_thunk = SequentialThunk::FromThunk(std::move(thunk));\n   }\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<ThunkProto> ConditionalThunk::ToProto() const {"
        },
        {
            "sha": "d0ffcbe7a20dba85f32a68ff7fe849b3b2ea7fe0",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -73,9 +73,10 @@ class ConditionalThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n-  void TransformAllNestedThunks(\n-      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n-      override;\n+  absl::Status TransformAllNestedThunks(\n+      absl::FunctionRef<\n+          absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+          fn) override;\n \n   bool branch_index_is_bool() const { return branch_index_is_bool_; }\n "
        },
        {
            "sha": "247ab4eca9835f0287459bf0e0a3f609fa9b95e7",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n@@ -300,9 +301,9 @@ TEST(ConditionalThunkTest, TransformAllNestedThunks) {\n       Thunk::ThunkInfo(), slice, std::move(branch_thunks),\n       /*branch_index_is_bool=*/false);\n \n-  conditional_thunk->TransformAllNestedThunks([](auto) {\n+  TF_EXPECT_OK(conditional_thunk->TransformAllNestedThunks([](auto) {\n     return std::make_unique<DummyThunk>(Kind::kCustomCall, Thunk::ThunkInfo());\n-  });\n+  }));\n \n   EXPECT_THAT(conditional_thunk->branch_thunks(), SizeIs(2));\n   EXPECT_THAT(conditional_thunk->branch_thunks()[0]->thunks(), SizeIs(1));"
        },
        {
            "sha": "f87c2155779956f54889dc96e7f8d2c71785049a",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -439,10 +439,16 @@ void DynamicSliceThunk::ForAllThunksMutable(\n   embedded_thunk_->ForAllThunksMutable(fn);\n }\n \n-void DynamicSliceThunk::TransformAllNestedThunks(\n-    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n-  embedded_thunk_->TransformAllNestedThunks(fn);\n-  embedded_thunk_ = SequentialThunk::FromThunk(fn(std::move(embedded_thunk_)));\n+absl::Status DynamicSliceThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<\n+        absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+        fn) {\n+  TF_RETURN_IF_ERROR(embedded_thunk_->TransformAllNestedThunks(fn));\n+\n+  TF_ASSIGN_OR_RETURN(std::unique_ptr<Thunk> thunk,\n+                      fn(std::move(embedded_thunk_)));\n+  embedded_thunk_ = SequentialThunk::FromThunk(std::move(thunk));\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<OptionalDynamicSliceOffsetsProto>"
        },
        {
            "sha": "9247784971b1162698db17c47d23d1dffd05ec52",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -172,9 +172,10 @@ class DynamicSliceThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n-  void TransformAllNestedThunks(\n-      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n-      override;\n+  absl::Status TransformAllNestedThunks(\n+      absl::FunctionRef<\n+          absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+          fn) override;\n \n   absl::StatusOr<ThunkProto> ToProto() const override;\n "
        },
        {
            "sha": "97db28bae28ff6a7307da58af541902a2c1b27c6",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -2110,10 +2110,10 @@ TEST_F(DynamicSliceThunkTest, TransformAllNestedThunks) {\n                           /*sliced_shapes=*/{},\n                           /*offset_byte_sizes=*/{});\n \n-  thunk.TransformAllNestedThunks([](auto) {\n+  TF_EXPECT_OK(thunk.TransformAllNestedThunks([](auto) {\n     return std::make_unique<DummyThunk>(Thunk::Kind::kCustomCall,\n                                         Thunk::ThunkInfo());\n-  });\n+  }));\n \n   EXPECT_THAT(thunk.get_embedded_thunk(), NotNull());\n   EXPECT_THAT(thunk.get_embedded_thunk()->thunks(), SizeIs(1));"
        },
        {
            "sha": "fb11c6b4517428c76860e1297b5581c2355d57c6",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -126,12 +126,15 @@ void SequentialThunk::ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) {\n   }\n }\n \n-void SequentialThunk::TransformAllNestedThunks(\n-    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+absl::Status SequentialThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<\n+        absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+        fn) {\n   for (std::unique_ptr<Thunk>& thunk : thunks_) {\n-    thunk->TransformAllNestedThunks(fn);\n-    thunk = fn(std::move(thunk));\n+    TF_RETURN_IF_ERROR(thunk->TransformAllNestedThunks(fn));\n+    TF_ASSIGN_OR_RETURN(thunk, fn(std::move(thunk)));\n   }\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<ThunkProto> SequentialThunk::ToProto() const {"
        },
        {
            "sha": "86118548b2e4a8c7ace6393249a5214b8de313e9",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.h?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -48,9 +48,10 @@ class SequentialThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n-  void TransformAllNestedThunks(\n-      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n-      override;\n+  absl::Status TransformAllNestedThunks(\n+      absl::FunctionRef<\n+          absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+          fn) override;\n \n   absl::StatusOr<ThunkProto> ToProto() const override;\n "
        },
        {
            "sha": "d3df365b966f424956729501d5bd0ac14f05e9ac",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -28,6 +28,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n #include \"xla/backends/gpu/runtime/thunk_id.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n \n namespace xla::gpu {\n@@ -172,12 +173,12 @@ TEST(SequentialThunkTest, TransformAllNestedThunks) {\n       std::make_unique<DummyThunk>(Thunk::Kind::kGemm, make_info(3)));\n   SequentialThunk sequential_thunk(Thunk::ThunkInfo(), std::move(thunks));\n \n-  sequential_thunk.TransformAllNestedThunks(\n+  TF_EXPECT_OK(sequential_thunk.TransformAllNestedThunks(\n       [&](std::unique_ptr<Thunk> thunk) -> std::unique_ptr<Thunk> {\n         return std::make_unique<DummyThunk>(\n             Thunk::Kind::kCopy,\n             make_info(thunk->thunk_info().thunk_id.value() + 10));\n-      });\n+      }));\n \n   EXPECT_EQ(sequential_thunk.thunks().size(), 3);\n   EXPECT_EQ(sequential_thunk.thunks()[0]->kind(), Thunk::Kind::kCopy);"
        },
        {
            "sha": "ed0b057b1f9706b9316c6007d022940effc5fab3",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk.h",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.h?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -539,8 +539,14 @@ class Thunk {\n \n   // Recursively replaces all nested thunks with the result of applying `fn` to\n   // them.\n-  virtual void TransformAllNestedThunks(\n-      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {}\n+  // An error will leave the transformation in invalid state.\n+  // InternalError should be used for status.\n+  virtual absl::Status TransformAllNestedThunks(\n+      absl::FunctionRef<\n+          absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+          fn) {\n+    return absl::OkStatus();\n+  }\n \n   // A helper function to get the `GpuCollectives*` pointer from the\n   // CollectiveExecuteParams."
        },
        {
            "sha": "061731673223789503b358509b60312a4c365d81",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_buffer_debug_checksum.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_checksum.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_checksum.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_checksum.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -50,6 +50,7 @@ limitations under the License.\n #include \"xla/shape.h\"\n #include \"xla/stream_executor/gpu/buffer_debug_log.h\"\n #include \"xla/stream_executor/stream.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -228,16 +229,17 @@ absl::Status RunChecksumPassInternal(SequentialThunk* root_thunk,\n       CreateBufferDebugDumpThunk(metadata_store, log_slice, hlo_module));\n \n   ThunkFilter thunk_filter = CreateThunkFilter(debug_options);\n-  root_thunk->TransformAllNestedThunks([&](std::unique_ptr<Thunk> thunk) {\n-    if (thunk_filter(*thunk) == InstrumentAction::kSkip) {\n-      return thunk;\n-    }\n-    VLOG(1) << \"Wrapping with checksum thunk\";\n-    return WrapWithChecksumThunk(std::move(thunk), log_slice,\n-                                 /*predecessor_thunk=*/*buffer_debug_init_thunk,\n-                                 /*successor_thunk=*/*buffer_debug_dump_thunk,\n-                                 metadata_store);\n-  });\n+  TF_RETURN_IF_ERROR(\n+      root_thunk->TransformAllNestedThunks([&](std::unique_ptr<Thunk> thunk) {\n+        if (thunk_filter(*thunk) == InstrumentAction::kSkip) {\n+          return thunk;\n+        }\n+        VLOG(1) << \"Wrapping with checksum thunk\";\n+        return WrapWithChecksumThunk(\n+            std::move(thunk), log_slice,\n+            /*predecessor_thunk=*/*buffer_debug_init_thunk,\n+            /*successor_thunk=*/*buffer_debug_dump_thunk, metadata_store);\n+      }));\n \n   ThunkSequence& thunks = root_thunk->thunks();\n   thunks.reserve(thunks.size() + 2);"
        },
        {
            "sha": "c5b579278459f317cbd55210ca3d5396abc9c013",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_buffer_debug_float_check.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_float_check.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_float_check.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_float_check.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -55,6 +55,7 @@ limitations under the License.\n #include \"xla/shape.h\"\n #include \"xla/stream_executor/gpu/buffer_debug_log.h\"\n #include \"xla/stream_executor/stream.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -325,16 +326,17 @@ absl::Status RunFloatCheckPassInternal(SequentialThunk* root_thunk,\n       CreateBufferDebugFloatCheckThunk(metadata_store, log_slice, hlo_module));\n \n   ThunkFilter thunk_filter = CreateThunkFilter(debug_options);\n-  root_thunk->TransformAllNestedThunks([&](std::unique_ptr<Thunk> thunk) {\n-    if (thunk_filter(*thunk) == InstrumentAction::kSkip) {\n-      return thunk;\n-    }\n-    VLOG(1) << \"Wrapping with float check thunk\";\n-    return WrapWithFloatCheckThunk(\n-        std::move(thunk), log_slice,\n-        /*predecessor_thunk=*/*buffer_debug_init_thunk,\n-        /*successor_thunk=*/*buffer_debug_dump_thunk, metadata_store);\n-  });\n+  TF_RETURN_IF_ERROR(\n+      root_thunk->TransformAllNestedThunks([&](std::unique_ptr<Thunk> thunk) {\n+        if (thunk_filter(*thunk) == InstrumentAction::kSkip) {\n+          return thunk;\n+        }\n+        VLOG(1) << \"Wrapping with float check thunk\";\n+        return WrapWithFloatCheckThunk(\n+            std::move(thunk), log_slice,\n+            /*predecessor_thunk=*/*buffer_debug_init_thunk,\n+            /*successor_thunk=*/*buffer_debug_dump_thunk, metadata_store);\n+      }));\n \n   ThunkSequence& thunks = root_thunk->thunks();\n   thunks.reserve(thunks.size() + 2);"
        },
        {
            "sha": "cd4bbed8c9f34e17ed9ce38b5cc061c32707ed7c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -199,14 +199,21 @@ void WhileThunk::ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) {\n   body_thunk_sequence_->ForAllThunksMutable(fn);\n }\n \n-void WhileThunk::TransformAllNestedThunks(\n-    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n-  condition_thunk_sequence_->TransformAllNestedThunks(fn);\n-  condition_thunk_sequence_ =\n-      SequentialThunk::FromThunk(fn(std::move(condition_thunk_sequence_)));\n-  body_thunk_sequence_->TransformAllNestedThunks(fn);\n-  body_thunk_sequence_ =\n-      SequentialThunk::FromThunk(fn(std::move(body_thunk_sequence_)));\n+absl::Status WhileThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<\n+        absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+        fn) {\n+  TF_RETURN_IF_ERROR(condition_thunk_sequence_->TransformAllNestedThunks(fn));\n+\n+  TF_ASSIGN_OR_RETURN(std::unique_ptr<Thunk> thunk,\n+                      fn(std::move(condition_thunk_sequence_)));\n+  condition_thunk_sequence_ = SequentialThunk::FromThunk(std::move(thunk));\n+\n+  TF_RETURN_IF_ERROR(body_thunk_sequence_->TransformAllNestedThunks(fn));\n+\n+  TF_ASSIGN_OR_RETURN(thunk, fn(std::move(body_thunk_sequence_)));\n+  body_thunk_sequence_ = SequentialThunk::FromThunk(std::move(thunk));\n+  return absl::OkStatus();\n }\n \n std::string WhileThunk::ToString(int indent) const {"
        },
        {
            "sha": "c60ec04bd171793d9de7b6dd91b6a38c474b91c0",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -94,9 +94,10 @@ class WhileThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n-  void TransformAllNestedThunks(\n-      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n-      override;\n+  absl::Status TransformAllNestedThunks(\n+      absl::FunctionRef<\n+          absl::StatusOr<std::unique_ptr<Thunk>>(std::unique_ptr<Thunk>)>\n+          fn) override;\n \n   std::string ToString(int indent) const override;\n "
        },
        {
            "sha": "f88361546f4db4be813d75cafbf58a66b959e5ff",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc?ref=5ef77d5b9727ab2253f0d0fc0914e950f2c36fd6",
            "patch": "@@ -43,7 +43,7 @@ limitations under the License.\n #include \"xla/stream_executor/stream.h\"\n #include \"xla/stream_executor/stream_executor_memory_allocator.h\"\n #include \"xla/tests/hlo_pjrt_test_base.h\"\n-#include \"xla/tsl/platform/status_matchers.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n #include \"xla/tsl/util/proto/parse_text_proto.h\"\n@@ -393,9 +393,9 @@ TEST(WhileThunkTest, TransformAllNestedThunks) {\n       /*body_thunk_sequence_=*/std::move(body_thunk_sequence),\n       /*trip_count=*/3);\n \n-  while_thunk->TransformAllNestedThunks([](auto) {\n+  TF_EXPECT_OK(while_thunk->TransformAllNestedThunks([](auto) {\n     return std::make_unique<DummyThunk>(Kind::kCustomCall, Thunk::ThunkInfo());\n-  });\n+  }));\n \n   EXPECT_THAT(while_thunk->condition_thunk_sequence(), NotNull());\n   EXPECT_THAT(while_thunk->condition_thunk_sequence()->thunks(), SizeIs(1));"
        }
    ],
    "stats": {
        "total": 186,
        "additions": 115,
        "deletions": 71
    }
}