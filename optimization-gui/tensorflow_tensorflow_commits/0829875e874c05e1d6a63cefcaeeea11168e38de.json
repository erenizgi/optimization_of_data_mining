{
    "author": "ddunl",
    "message": "Use `local_xla` rather than `xla` when overriding repository for TensorFlow builds\n\nExample log where TF reads the changed XLA: https://github.com/openxla/xla/actions/runs/17687532820/job/50275317061?pr=31310#step:6:418\n\nThis fixes the issue introduced by https://github.com/openxla/xla/commit/06ea00b30494e0d73dc29e7d3e785b09d1437213. In that commit, I mistakenly removed the extra `setup_commands` without reintroducing `override_repository`. This rectifies it - we still need the sed commands to ensure that things inside of xla which refer to their repo explicitly like `@xla` or `@tsl` use the `@local_xla` or `@local_tsl` repo names like TensorFlow expects due to vendoring.\n\nThe other commands previously used are no longer necessary after b/391640066, since TensorFlow always refers to XLA by using a label that references the repo itself instead of the vendored location (`@local_xla//` vs `//third_party/xla`)\n\nPiperOrigin-RevId: 807292238",
    "sha": "0829875e874c05e1d6a63cefcaeeea11168e38de",
    "files": [
        {
            "sha": "f4a89aff03c7ca22dff8e45b9c7806e90ee28dfc",
            "filename": "third_party/xla/build_tools/ci/build.py",
            "status": "modified",
            "additions": 37,
            "deletions": 3,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0829875e874c05e1d6a63cefcaeeea11168e38de/third_party%2Fxla%2Fbuild_tools%2Fci%2Fbuild.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0829875e874c05e1d6a63cefcaeeea11168e38de/third_party%2Fxla%2Fbuild_tools%2Fci%2Fbuild.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fci%2Fbuild.py?ref=0829875e874c05e1d6a63cefcaeeea11168e38de",
            "patch": "@@ -644,9 +644,26 @@ def nvidia_gpu_build_with_compute_capability(\n         color=\"yes\",\n     ),\n     override_repository=dict(\n-        xla=f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n+        local_xla=f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n     ),\n     repo_env={\"USE_PYWRAP_RULES\": \"True\"},\n+    extra_setup_commands=(\n+        # This is pretty devious - but we have to do some adhoc extra Copybara\n+        # work here to get XLA into the shape TF expects. b/407638223\n+        # pyformat:disable\n+        [\n+            \"find\",\n+            f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n+            \"-type\", \"f\",\n+            \"-exec\", \"sed\", \"-i\", \"s/@local_xla/@local_xla/g\", \"{}\", \"+\",\n+        ],\n+        [\n+            \"find\",\n+            f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n+            \"-type\", \"f\",\n+            \"-exec\", \"sed\", \"-i\", \"s/@local_tsl/@local_tsl/g\", \"{}\", \"+\",\n+        ],\n+    ),\n )\n \n Build(\n@@ -668,7 +685,7 @@ def nvidia_gpu_build_with_compute_capability(\n     build_tag_filters=tensorflow_gpu_tag_filters,\n     test_tag_filters=tensorflow_gpu_tag_filters,\n     override_repository=dict(\n-        xla=f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n+        local_xla=f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n     ),\n     options=dict(\n         verbose_failures=True,\n@@ -678,7 +695,24 @@ def nvidia_gpu_build_with_compute_capability(\n         color=\"yes\",\n     ),\n     repo_env={\"USE_PYWRAP_RULES\": \"True\"},\n-    extra_setup_commands=([\"nvidia-smi\"],),\n+    extra_setup_commands=(\n+        # This is pretty devious - but we have to do some adhoc extra Copybara\n+        # work here to get XLA into the shape TF expects. b/407638223\n+        # pyformat:disable\n+        [\n+            \"find\",\n+            f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n+            \"-type\", \"f\",\n+            \"-exec\", \"sed\", \"-i\", \"s/@local_xla/@local_xla/g\", \"{}\", \"+\",\n+        ],\n+        [\n+            \"find\",\n+            f\"{_GITHUB_WORKSPACE}/openxla/xla\",\n+            \"-type\", \"f\",\n+            \"-exec\", \"sed\", \"-i\", \"s/@local_tsl/@local_tsl/g\", \"{}\", \"+\",\n+        ],\n+        [\"nvidia-smi\"],\n+    ),\n )\n \n "
        },
        {
            "sha": "06386e2e7e5f581f0ddfbe299a08601cd11352d4",
            "filename": "third_party/xla/build_tools/ci/golden_commands.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0829875e874c05e1d6a63cefcaeeea11168e38de/third_party%2Fxla%2Fbuild_tools%2Fci%2Fgolden_commands.txt",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0829875e874c05e1d6a63cefcaeeea11168e38de/third_party%2Fxla%2Fbuild_tools%2Fci%2Fgolden_commands.txt",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fci%2Fgolden_commands.txt?ref=0829875e874c05e1d6a63cefcaeeea11168e38de",
            "patch": "@@ -10,14 +10,18 @@ bazel test --build_tag_filters=-multiaccelerator --test_tag_filters=-multiaccele\n bazel analyze-profile profile.json.gz\n # END BuildType.JAX_LINUX_X86_GPU_L4_GITHUB_ACTIONS\n # BEGIN BuildType.TENSORFLOW_LINUX_X86_CPU_GITHUB_ACTIONS\n-parallel --ungroup --retries 3 --delay 15 --nonall -- bazel build --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --config=release_cpu_linux --config=rbe_linux_cpu --repo_env=USE_PYWRAP_RULES=True --override_repository=xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes --nobuild -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n-bazel test --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --config=release_cpu_linux --config=rbe_linux_cpu --repo_env=USE_PYWRAP_RULES=True --override_repository=xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n+find $GITHUB_WORKSPACE/openxla/xla -type f -exec sed -i s/@local_xla/@local_xla/g {} +\n+find $GITHUB_WORKSPACE/openxla/xla -type f -exec sed -i s/@local_tsl/@local_tsl/g {} +\n+parallel --ungroup --retries 3 --delay 15 --nonall -- bazel build --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --config=release_cpu_linux --config=rbe_linux_cpu --repo_env=USE_PYWRAP_RULES=True --override_repository=local_xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes --nobuild -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n+bazel test --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-gpu --config=release_cpu_linux --config=rbe_linux_cpu --repo_env=USE_PYWRAP_RULES=True --override_repository=local_xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n bazel analyze-profile profile.json.gz\n # END BuildType.TENSORFLOW_LINUX_X86_CPU_GITHUB_ACTIONS\n # BEGIN BuildType.TENSORFLOW_LINUX_X86_GPU_L4_GITHUB_ACTIONS\n+find $GITHUB_WORKSPACE/openxla/xla -type f -exec sed -i s/@local_xla/@local_xla/g {} +\n+find $GITHUB_WORKSPACE/openxla/xla -type f -exec sed -i s/@local_tsl/@local_tsl/g {} +\n nvidia-smi\n-parallel --ungroup --retries 3 --delay 15 --nonall -- bazel build --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --config=release_gpu_linux --config=rbe_linux_cuda --repo_env=USE_PYWRAP_RULES=True --override_repository=xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes --nobuild -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n-bazel test --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --config=release_gpu_linux --config=rbe_linux_cuda --repo_env=USE_PYWRAP_RULES=True --override_repository=xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n+parallel --ungroup --retries 3 --delay 15 --nonall -- bazel build --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --config=release_gpu_linux --config=rbe_linux_cuda --repo_env=USE_PYWRAP_RULES=True --override_repository=local_xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes --nobuild -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n+bazel test --build_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --test_tag_filters=-no_oss,-tf_tosa,-oss_excluded,-oss_serial,-tpu,-benchmark-test,-v1only,-no_gpu,-no_gpu_presubmit,-no_cuda11,+gpu --config=release_gpu_linux --config=rbe_linux_cuda --repo_env=USE_PYWRAP_RULES=True --override_repository=local_xla=$GITHUB_WORKSPACE/openxla/xla --verbose_failures --test_output=errors --profile=profile.json.gz --test_lang_filters=cc,py --color=yes -- //tensorflow/compiler/... -//tensorflow/compiler/tf2tensorrt/... //tensorflow/python/... -//tensorflow/python/distribute/... -//tensorflow/python/kernel_tests/... -//tensorflow/python/data/... -//tensorflow/python/compiler/tensorrt/...\n bazel analyze-profile profile.json.gz\n # END BuildType.TENSORFLOW_LINUX_X86_GPU_L4_GITHUB_ACTIONS\n # BEGIN BuildType.XLA_LINUX_ARM64_CPU_48_VCPU_PRESUBMIT_GITHUB_ACTIONS"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 45,
        "deletions": 7
    }
}