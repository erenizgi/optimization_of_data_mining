{
    "author": "beckerhe",
    "message": "Refactor xtile_compiler build targets to separate implementation and stub.\n\nThe `xtile_compiler` target now acts as a selector, depending on either `xtile_compiler_impl` or `xtile_compiler_stub` based on whether CUDA or ROCm is configured. The full implementation is moved to the new `xtile_compiler_impl` target, while `xtile_compiler_stub` provides a minimal version for other configurations.\n\nThis has the advantage that build_cleaner can run on xtile_compiler_impl. (Doing that removed around 20 dependencies)\n\nPiperOrigin-RevId: 848442213",
    "sha": "0a8d3e310bb9b8611469f77f5181f62a91652508",
    "files": [
        {
            "sha": "0ccc0e7102601230a10ee34a514f7dac1ae268b6",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/BUILD",
            "status": "modified",
            "additions": 109,
            "deletions": 71,
            "changes": 180,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0a8d3e310bb9b8611469f77f5181f62a91652508/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0a8d3e310bb9b8611469f77f5181f62a91652508/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2FBUILD?ref=0a8d3e310bb9b8611469f77f5181f62a91652508",
            "patch": "@@ -313,60 +313,70 @@ cc_library(\n )\n \n cc_library(\n-    name = \"xtile_compiler\",\n-    # Using if_cuda_or_rocm_is_configured guard to prevent sycl target build / link errors.\n-    srcs = if_cuda_or_rocm_is_configured(\n-        [\"xtile_compiler.cc\"],\n-        [\"xtile_compiler_stub.cc\"],\n-    ),\n-    hdrs = [\"xtile_compiler.h\"],\n-    compatible_with = get_compatible_with_portable(),\n+    name = \"xtile_compiler_impl\",\n+    srcs =\n+        [\n+            \"xtile_compiler.cc\",\n+            \"xtile_compiler.h\",\n+        ],\n+    tags = [\n+        \"gpu\",\n+        \"manual\",\n+        \"no-oneapi\",\n+    ],\n+    visibility = [\"//visibility:private\"],\n     deps = [\n+        \":collective_emitter\",\n+        \":compilation_pipeline\",\n+        \":fusion_emitter\",\n+        \":lowering_util\",\n+        \":support\",\n         \"//xla:autotuning_proto_cc\",\n+        \"//xla:status_macros\",\n+        \"//xla:util\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"//xla:xla_proto_cc\",\n+        \"//xla/backends/gpu/codegen/emitters/ir:xla_gpu\",\n         \"//xla/backends/gpu/codegen/triton/ir:triton_xla\",\n+        \"//xla/backends/gpu/codegen/triton/transforms:passes\",\n+        \"//xla/codegen/emitters/ir:xla\",\n+        \"//xla/codegen/emitters/transforms:passes\",\n         \"//xla/codegen/tiling:symbolic_tile_analysis\",\n-        \"//xla/codegen/tiling:tiled_hlo_computation\",\n-        \"//xla/codegen/tiling:tiled_hlo_fusion_instruction\",\n-        \"//xla/codegen/tiling:tiled_hlo_instruction\",\n-        \"//xla/codegen/tiling:tiled_hlo_schedule\",\n         \"//xla/codegen/tiling:tiling_specification\",\n         \"//xla/codegen/xtile/ir:xtile\",\n         \"//xla/codegen/xtile/ir/transforms:passes\",\n-        \"//xla/hlo/analysis:symbolic_expr\",\n+        \"//xla/hlo/builder:xla_builder\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/translate/hlo_to_mhlo:hlo_function_importer\",\n+        \"//xla/service:dump\",\n         \"//xla/service:hlo_module_config\",\n+        \"//xla/service/gpu:backend_configs_cc\",\n+        \"//xla/service/gpu:ir_emission_utils\",\n+        \"//xla/service/gpu/llvm_gpu_backend:nvptx_libdevice_path\",\n         \"//xla/service/gpu/model:block_level_parameters\",\n+        \"//xla/service/gpu/model:triton_emitter_constraints\",\n+        \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/stream_executor:launch_dim\",\n+        \"//xla/stream_executor/cuda:cuda_compute_capability\",\n         \"//xla/stream_executor/gpu:tma_metadata\",\n+        \"//xla/tools:hlo_decomposer_lib\",\n         \"//xla/tsl/framework/mlir:status_scoped_diagnostic_handler\",\n+        \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/algorithm:container\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n+        \"@llvm-project//llvm:Linker\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:TargetParser\",\n         \"@llvm-project//llvm:ir_headers\",\n-        \"@llvm-project//mlir:IR\",\n-        \"@llvm-project//mlir:Pass\",\n-        \"@stablehlo//:stablehlo_ops\",\n-        \"@triton//:TritonDialects\",\n-    ] + if_cuda_or_rocm_is_configured([\n-        \":fusion_emitter\",\n-        \":lowering_util\",\n-        \":compilation_pipeline\",\n-        \":collective_emitter\",\n-        \":dot_algorithms\",\n-        \":emitter_helpers\",\n-        \":support\",\n-        \"@com_google_absl//absl/algorithm:container\",\n-        \"@com_google_absl//absl/container:flat_hash_map\",\n-        \"@com_google_absl//absl/container:inlined_vector\",\n-        \"@com_google_absl//absl/log\",\n-        \"@com_google_absl//absl/log:check\",\n-        \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/strings:str_format\",\n-        \"@llvm-project//llvm:Linker\",\n         \"@llvm-project//mlir:AffineDialect\",\n         \"@llvm-project//mlir:AffineToStandard\",\n         \"@llvm-project//mlir:ArithDialect\",\n@@ -376,59 +386,87 @@ cc_library(\n         \"@llvm-project//mlir:ExecutionEngineUtils\",\n         \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:FuncExtensions\",\n-        \"@llvm-project//mlir:FunctionInterfaces\",\n+        \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:IndexToLLVM\",\n         \"@llvm-project//mlir:LLVMDialect\",\n         \"@llvm-project//mlir:LLVMIRTransforms\",\n         \"@llvm-project//mlir:LLVMToLLVMIRTranslation\",\n         \"@llvm-project//mlir:NVVMDialect\",\n         \"@llvm-project//mlir:NVVMToLLVMIRTranslation\",\n+        \"@llvm-project//mlir:Pass\",\n         \"@llvm-project//mlir:ROCDLToLLVMIRTranslation\",\n-        \"@llvm-project//mlir:SCFDialect\",\n         \"@llvm-project//mlir:SCFToControlFlow\",\n         \"@llvm-project//mlir:Support\",\n         \"@llvm-project//mlir:TensorDialect\",\n         \"@llvm-project//mlir:ToLLVMIRTranslation\",\n         \"@llvm-project//mlir:Transforms\",\n-        \"//xla:permutation_util\",\n-        \"//xla:shape_util\",\n-        \"//xla:status_macros\",\n-        \"//xla:util\",\n-        \"//xla:xla_data_proto_cc\",\n-        \"//xla:xla_proto_cc\",\n-        \"//xla/backends/gpu/codegen/emitters/ir:xla_gpu\",\n-        \"//xla/backends/gpu/codegen/emitters/transforms:passes\",\n-        \"//xla/backends/gpu/codegen/triton/transforms:passes\",\n-        \"//xla/codegen/emitters:elemental_hlo_to_mlir\",\n-        \"//xla/codegen/emitters/ir:xla\",\n-        \"//xla/codegen/emitters/transforms:passes\",\n-        \"//xla/hlo/analysis:indexing_analysis\",\n-        \"//xla/hlo/builder:xla_builder\",\n-        \"//xla/hlo/translate/hlo_to_mhlo:hlo_function_importer\",\n-        \"//xla/hlo/utils:hlo_traversal\",\n-        \"//xla/mlir_hlo\",\n-        \"//xla/service:dump\",\n-        \"//xla/service:instruction_fusion\",\n-        \"//xla/service/gpu:backend_configs_cc\",\n-        \"//xla/service/gpu:ir_emission_utils\",\n-        \"//xla/service/gpu:launch_dimensions\",\n-        \"//xla/service/gpu/llvm_gpu_backend:nvptx_libdevice_path\",\n-        \"//xla/service/gpu:matmul_utils\",\n-        \"//xla/service/gpu:triton_fusion_analysis\",\n-        \"//xla/service/gpu/model:triton_emitter_constraints\",\n-        \"//xla/service/llvm_ir:llvm_util\",\n-        \"//xla/stream_executor/cuda:cuda_compute_capability\",\n-        \"//xla/tools:hlo_decomposer_lib\",\n-        \"//xla/tsl/platform:errors\",\n-        \"//xla/tsl/platform:rocm_rocdl_path\",\n-        \"//xla/tsl/platform:statusor\",\n-        \"@local_tsl//tsl/platform:errors\",\n         \"@local_tsl//tsl/platform:path\",\n-        \"@local_tsl//tsl/platform:statusor\",\n+        \"@stablehlo//:stablehlo_ops\",\n+        \"@triton//:TritonDialects\",\n         \"@triton//:TritonTransforms\",\n-    ]) + if_cuda_is_configured([\n+    ],\n+)\n+\n+cc_library(\n+    name = \"xtile_compiler_stub\",\n+    srcs = [\n+        \"xtile_compiler.h\",\n+        \"xtile_compiler_stub.cc\",\n+    ],\n+    compatible_with = get_compatible_with_portable(),\n+    visibility = [\"//visibility:private\"],\n+    deps = [\n+        \"//xla:autotuning_proto_cc_impl\",\n+        \"//xla/codegen/tiling:symbolic_tile_analysis\",\n+        \"//xla/codegen/tiling:tiling_specification\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/service:hlo_module_config\",\n+        \"//xla/service/gpu/model:block_level_parameters\",\n+        \"//xla/stream_executor:device_description\",\n+        \"//xla/stream_executor:launch_dim\",\n+        \"//xla/stream_executor/gpu:tma_metadata\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@llvm-project//llvm:Support\",\n+        \"@llvm-project//llvm:TargetParser\",\n+        \"@llvm-project//llvm:ir_headers\",\n+        \"@llvm-project//mlir:IR\",\n+        \"@llvm-project//mlir:Pass\",\n+        \"@triton//:TritonDialects\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"xtile_compiler\",\n+    hdrs = [\n+        \"xtile_compiler.h\",\n+    ],\n+    compatible_with = get_compatible_with_portable(),\n+    deps = if_cuda_or_rocm_is_configured(\n+        [\":xtile_compiler_impl\"],\n+        [\":xtile_compiler_stub\"],\n+    ) + if_cuda_is_configured([\n         \"//xla/service/gpu/llvm_gpu_backend:nvptx_backend\",\n-    ]),\n+    ]) + [\n+        \"//xla:autotuning_proto_cc\",\n+        \"//xla/codegen/tiling:symbolic_tile_analysis\",\n+        \"//xla/codegen/tiling:tiling_specification\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/service:hlo_module_config\",\n+        \"//xla/service/gpu/model:block_level_parameters\",\n+        \"//xla/stream_executor:device_description\",\n+        \"//xla/stream_executor:launch_dim\",\n+        \"//xla/stream_executor/gpu:tma_metadata\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@llvm-project//llvm:Support\",\n+        \"@llvm-project//llvm:TargetParser\",\n+        \"@llvm-project//llvm:ir_headers\",\n+        \"@llvm-project//mlir:IR\",\n+        \"@llvm-project//mlir:Pass\",\n+    ],\n )\n \n cc_library("
        }
    ],
    "stats": {
        "total": 180,
        "additions": 109,
        "deletions": 71
    }
}