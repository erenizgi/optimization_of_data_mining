{
    "author": "ermilovmaxim",
    "message": "[XLA:GPU] Add proto serialization for MemzeroThunk\n\nPiperOrigin-RevId: 805485125",
    "sha": "34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
    "files": [
        {
            "sha": "1613e6b4a52e7930509da78138665124ee46a1ad",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
            "patch": "@@ -968,8 +968,27 @@ cc_library(\n     deps = [\n         \":thunk\",\n         \"//xla/service:buffer_assignment\",\n-        \"//xla/stream_executor:stream_executor_h\",\n+        \"//xla/stream_executor:device_memory\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)\n+\n+xla_cc_test(\n+    name = \"memset_thunk_test\",\n+    srcs = [\"memset_thunk_test.cc\"],\n+    deps = [\n+        \":memset_thunk\",\n+        \":thunk\",\n+        \":thunk_proto_cc\",\n+        \"//xla/service:buffer_assignment\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:proto_matchers\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n \n@@ -2092,6 +2111,7 @@ cc_library(\n         \":cudnn_thunk\",\n         \":gemm_thunk\",\n         \":kernel_thunk\",\n+        \":memset_thunk\",\n         \":replica_id_thunk\",\n         \":sequential_thunk\",\n         \":thunk\","
        },
        {
            "sha": "da474335ce1ac59ca8b871479560e7eceb4901d3",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.cc?ref=34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
            "patch": "@@ -15,8 +15,15 @@ limitations under the License.\n \n #include \"xla/backends/gpu/runtime/memset_thunk.h\"\n \n+#include <memory>\n+#include <utility>\n+\n #include \"absl/status/status.h\"\n-#include \"xla/stream_executor/stream_executor.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/service/buffer_assignment.h\"\n+#include \"xla/stream_executor/device_memory.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n namespace gpu {\n@@ -27,6 +34,25 @@ absl::Status MemzeroThunk::ExecuteOnStream(const ExecuteParams& params) {\n   return params.stream->MemZero(&dest_data, dest_data.size());\n }\n \n+absl::StatusOr<std::unique_ptr<MemzeroThunk>> MemzeroThunk::FromProto(\n+    ThunkInfo thunk_info, const MemzeroThunkProto& thunk_proto,\n+    absl::Span<const BufferAllocation> buffer_allocations) {\n+  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice dest,\n+                      BufferAllocation::Slice::FromProto(\n+                          thunk_proto.dest_buffer(), buffer_allocations));\n+  return std::make_unique<MemzeroThunk>(std::move(thunk_info), dest);\n+}\n+\n+absl::StatusOr<ThunkProto> MemzeroThunk::ToProto() const {\n+  ThunkProto proto;\n+  *proto.mutable_thunk_info() = thunk_info().ToProto();\n+\n+  MemzeroThunkProto* memzero_thunk_proto = proto.mutable_memzero_thunk();\n+  TF_ASSIGN_OR_RETURN(*memzero_thunk_proto->mutable_dest_buffer(),\n+                      dest_.ToProto());\n+  return proto;\n+}\n+\n absl::Status Memset32BitValueThunk::ExecuteOnStream(\n     const ExecuteParams& params) {\n   se::DeviceMemoryBase dest_data ="
        },
        {
            "sha": "a42aaea7f886805b120f7de240be75094832294d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.h?ref=34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
            "patch": "@@ -39,6 +39,12 @@ class MemzeroThunk : public Thunk {\n \n   const BufferAllocation::Slice& destination() const { return dest_; }\n \n+  static absl::StatusOr<std::unique_ptr<MemzeroThunk>> FromProto(\n+      ThunkInfo thunk_info, const MemzeroThunkProto& thunk_proto,\n+      absl::Span<const BufferAllocation> buffer_allocations);\n+\n+  absl::StatusOr<ThunkProto> ToProto() const override;\n+\n  private:\n   const BufferAllocation::Slice dest_;\n };"
        },
        {
            "sha": "fbf512b32fbc257b33c59d42546162bcd54f3abc",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk_test.cc",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc?ref=34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
            "patch": "@@ -0,0 +1,67 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/gpu/runtime/memset_thunk.h\"\n+\n+#include <memory>\n+#include <vector>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/log/check.h\"\n+#include \"xla/backends/gpu/runtime/thunk.h\"\n+#include \"xla/backends/gpu/runtime/thunk.pb.h\"\n+#include \"xla/service/buffer_assignment.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/proto_matchers.h\"\n+#include \"tsl/platform/protobuf.h\"\n+\n+namespace xla::gpu {\n+namespace {\n+\n+using ::tsl::proto_testing::EqualsProto;\n+\n+TEST(MemzeroThunkTest, ProtoRoundTrip) {\n+  ThunkProto proto;\n+  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+      R\"pb(\n+        thunk_info {\n+          profile_annotation: \"partition_id_profile_annotation\"\n+          execution_stream_id: 2\n+        }\n+        memzero_thunk {\n+          dest_buffer { offset: 0 size: 4 buffer_allocation_index: 0 }\n+        }\n+      )pb\",\n+      &proto));\n+  std::vector<BufferAllocation> buffer_allocations = {\n+      BufferAllocation(/*index=*/0, /*size=*/4, /*color=*/0)};\n+\n+  Thunk::ThunkInfo thunk_info;\n+  thunk_info.profile_annotation = proto.thunk_info().profile_annotation();\n+  thunk_info.execution_stream_id = xla::gpu::ExecutionStreamId{\n+      static_cast<xla::gpu::ExecutionStreamId::ValueType>(\n+          proto.thunk_info().execution_stream_id())};\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<MemzeroThunk> thunk,\n+      MemzeroThunk::FromProto(thunk_info, proto.memzero_thunk(),\n+                              buffer_allocations));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(ThunkProto round_trip_proto, thunk->ToProto());\n+  EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n+}\n+\n+}  // namespace\n+}  // namespace xla::gpu"
        },
        {
            "sha": "e8b4605efc7bd7a6927a574cb4ada61a844000f5",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk.proto",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto?ref=34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
            "patch": "@@ -129,6 +129,10 @@ message DynamicSliceThunkProto {\n       offset_as_function_of_indvar_modules_metadata = 7;\n }\n \n+message MemzeroThunkProto {\n+  xla.buffer_assignment.BufferAllocationSliceProto dest_buffer = 1;\n+}\n+\n message ThunkProto {\n   ThunkInfoProto thunk_info = 1;\n \n@@ -150,6 +154,7 @@ message ThunkProto {\n     HostExecuteStartThunkProto host_execute_start_thunk = 16;\n     HostExecuteDoneThunkProto host_execute_done_thunk = 17;\n     DynamicSliceThunkProto dynamic_slice_thunk = 18;\n+    MemzeroThunkProto memzero_thunk = 19;\n   }\n }\n "
        },
        {
            "sha": "d93fefbb172af6001cd4632783af20cea902078c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_proto_deserialization.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/34ebab0a6f191d4aa94c8d7e4a29839707cee81b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc?ref=34ebab0a6f191d4aa94c8d7e4a29839707cee81b",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/cudnn_thunk.h\"\n #include \"xla/backends/gpu/runtime/gemm_thunk.h\"\n #include \"xla/backends/gpu/runtime/kernel_thunk.h\"\n+#include \"xla/backends/gpu/runtime/memset_thunk.h\"\n #include \"xla/backends/gpu/runtime/replica_id_thunk.h\"\n #include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n@@ -140,6 +141,10 @@ absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n     return CuDnnThunk::FromProto(std::move(thunk_info),\n                                  thunk_proto.cudnn_thunk(), buffer_allocations);\n   }\n+  if (thunk_proto.has_memzero_thunk()) {\n+    return MemzeroThunk::FromProto(\n+        std::move(thunk_info), thunk_proto.memzero_thunk(), buffer_allocations);\n+  }\n \n   std::optional<absl::string_view> unsupported_thunk_type =\n       GetStoredThunkTypeName(thunk_proto);"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 131,
        "deletions": 2
    }
}