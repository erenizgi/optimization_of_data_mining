{
    "author": "jakeharmon8",
    "message": "Add support for release candidate versions in PJRT wheels.\n\nPiperOrigin-RevId: 828096591",
    "sha": "0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4",
    "files": [
        {
            "sha": "f9c2984048b52900ab0a93898f47a1427e4bd716",
            "filename": "third_party/xla/MODULE.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2FMODULE.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2FMODULE.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2FMODULE.bazel?ref=0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4",
            "patch": "@@ -208,3 +208,6 @@ use_repo(tensorrt_configure, \"local_config_tensorrt\")\n \n pjrt_nightly_timestamp = use_extension(\"//build_tools/pjrt_wheels:nightly.bzl\", \"nightly_timestamp_repo_bzlmod\")\n use_repo(pjrt_nightly_timestamp, \"nightly_timestamp\")\n+\n+pjrt_rc_number = use_extension(\"//build_tools/pjrt_wheels:release_candidate.bzl\", \"rc_number_repo_bzlmod\")\n+use_repo(pjrt_rc_number, \"rc_number\")\n\\ No newline at end of file"
        },
        {
            "sha": "d3249b08d999c661e05338af0cf53fc9c1c7e7d4",
            "filename": "third_party/xla/WORKSPACE",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2FWORKSPACE",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2FWORKSPACE",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2FWORKSPACE?ref=0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4",
            "patch": "@@ -157,3 +157,8 @@ nvshmem_redist_init_repository(\n load(\"//build_tools/pjrt_wheels:nightly.bzl\", \"nightly_timestamp_repo\")\n \n nightly_timestamp_repo(name = \"nightly_timestamp\")\n+\n+# This is used for building release candidate PJRT wheels.\n+load(\"//build_tools/pjrt_wheels:release_candidate.bzl\", \"rc_number_repo\")\n+\n+rc_number_repo(name = \"rc_number\")"
        },
        {
            "sha": "8a25f59fa9c7e65f342bef68d56d1e9b86328ed8",
            "filename": "third_party/xla/build_tools/pjrt_wheels/BUILD.bazel",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel?ref=0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4",
            "patch": "@@ -1,13 +1,18 @@\n load(\"@cuda_cudart//:version.bzl\", cuda_major_version = \"VERSION\")\n load(\"@nightly_timestamp//:timestamp.bzl\", \"XLA_NIGHTLY_TIMESTAMP\")\n+load(\"@rc_number//:rc_number.bzl\", \"XLA_RC_NUMBER\")\n load(\"@rules_python//python:packaging.bzl\", \"py_wheel\")\n \n # This ensures we can only build plugins for selected CUDA versions.\n cuda_label = \"cuda\" + cuda_major_version if cuda_major_version else \"null\"\n \n # If we're building a nightly, append .devYYYYMMDD to the version\n-# If we're not, the timestamp is the empty string\n-wheel_version = \"0.0.0\" + XLA_NIGHTLY_TIMESTAMP\n+# If we're not, the timestamp is an empty string\n+# If we're building a release candidate, append rc# to the version\n+# If we're not, the rc number is an empty string\n+# Note that PEP 440 supports both of these at the same time, but\n+# our CI will never set both.\n+wheel_version = \"0.0.0\" + XLA_RC_NUMBER + XLA_NIGHTLY_TIMESTAMP\n \n wheel_platform = select({\n     \"//conditions:default\": \"manylinux_2_27_x86_64\","
        },
        {
            "sha": "f6954d33f0fbdd60692bd99ae6718e489b08280c",
            "filename": "third_party/xla/build_tools/pjrt_wheels/release_candidate.bzl",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Frelease_candidate.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Frelease_candidate.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Frelease_candidate.bzl?ref=0eb11fb11118dbf4ad1eaa7c60e00fd6afe3a6b4",
            "patch": "@@ -0,0 +1,35 @@\n+\"\"\"If we're building a release candidate, we use this to pass a rc number for the wheel version.\"\"\"\n+\n+def _rc_number_impl(rctx):\n+    rc_number = rctx.getenv(\"XLA_RC_NUMBER\", \"\")  # Default to \"\"\n+\n+    # Smuggle the value via a new .bzl file\n+    if rc_number:\n+        rctx.file(\n+            \"rc_number.bzl\",\n+            content = 'XLA_RC_NUMBER = \"rc{}\"'.format(rc_number),\n+        )\n+    else:\n+        rctx.file(\n+            \"rc_number.bzl\",\n+            content = 'XLA_RC_NUMBER = \"\"',\n+        )\n+\n+    # Create a BUILD file to make timestamp.bzl addressable\n+    rctx.file(\"BUILD.bazel\", content = \"\")\n+\n+rc_number_repo = repository_rule(\n+    implementation = _rc_number_impl,\n+    environ = [\"XLA_RC_NUMBER\"],\n+)\n+\n+# bzlmod implementation\n+def _rc_number_ext_impl(mctx):  # @unused\n+    rc_number_repo(\n+        name = \"rc_number\",\n+    )\n+\n+rc_number_repo_bzlmod = module_extension(\n+    implementation = _rc_number_ext_impl,\n+    environ = [\"XLA_RC_NUMBER\"],\n+)"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 50,
        "deletions": 2
    }
}