{
    "author": "EusebioDM",
    "message": "Use Deserializer lambda for embedded thunks in `DynamicSliceThunk`\n\nPiperOrigin-RevId: 826474606",
    "sha": "ecc2510eb0b75a0e7509cde891550f78f687485a",
    "files": [
        {
            "sha": "ca3c04404c9725d025f91632d0b54b61511578e1",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=ecc2510eb0b75a0e7509cde891550f78f687485a",
            "patch": "@@ -226,7 +226,6 @@ cc_library(\n         \":sequential_thunk\",\n         \":thunk\",\n         \":thunk_proto_cc\",\n-        \":thunk_proto_deserialization\",\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n         \"//xla:shape_util\",\n@@ -270,6 +269,7 @@ xla_test(\n         \":gemm_thunk\",\n         \":sequential_thunk\",\n         \":thunk\",\n+        \":thunk_proto_deserialization\",\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/ffi\","
        },
        {
            "sha": "b98d2d7d3ad14159b8b5850f7b8c33fa46b7debb",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc?ref=ecc2510eb0b75a0e7509cde891550f78f687485a",
            "patch": "@@ -41,7 +41,6 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n-#include \"xla/backends/gpu/runtime/thunk_proto_deserialization.h\"\n #include \"xla/hlo/evaluator/hlo_evaluator.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/literal.h\"\n@@ -617,7 +616,8 @@ absl::StatusOr<ThunkProto> DynamicSliceThunk::ToProto() const {\n absl::StatusOr<std::unique_ptr<DynamicSliceThunk>> DynamicSliceThunk::FromProto(\n     ThunkInfo thunk_info, const DynamicSliceThunkProto& proto,\n     absl::Span<const BufferAllocation> buffer_allocations,\n-    absl::Span<const BufferAllocation> fake_allocations) {\n+    absl::Span<const BufferAllocation> fake_allocations,\n+    const Deserializer& deserializer) {\n   // offset_as_function_of_indvar_metadata\n   std::optional<OffsetAsFunctionOfIndvarModulesMetadata>\n       offset_as_function_of_indvar_metadata;\n@@ -677,9 +677,9 @@ absl::StatusOr<std::unique_ptr<DynamicSliceThunk>> DynamicSliceThunk::FromProto(\n   // embedded_thunk\n   std::vector<std::unique_ptr<Thunk>> embedded_thunks;\n   for (const auto& thunk_proto : proto.embedded_thunk().thunks()) {\n-    TF_ASSIGN_OR_RETURN(auto thunk,\n-                        DeserializeThunkProto(thunk_proto, fake_allocations));\n-    embedded_thunks.push_back(std::move(thunk));\n+    TF_ASSIGN_OR_RETURN(std::unique_ptr<Thunk> embedded_thunk,\n+                        deserializer(thunk_proto));\n+    embedded_thunks.push_back(std::move(embedded_thunk));\n   }\n \n   // leave fake_allocations empty, because we manage their lifetime outside"
        },
        {
            "sha": "efb470aafc0a9dcb72f56b3c193f51ffa11195b4",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h?ref=ecc2510eb0b75a0e7509cde891550f78f687485a",
            "patch": "@@ -186,10 +186,12 @@ class DynamicSliceThunk : public Thunk {\n   // replaced during execution in `ExecuteOnStream` with the actual (dynamic)\n   // slices. We have to create these outside of this method to manage their\n   // lifetime correctly.\n+  // `deserializer`: The deserializer is used to deserialize the embedded thunk.\n   static absl::StatusOr<std::unique_ptr<DynamicSliceThunk>> FromProto(\n       ThunkInfo thunk_info, const DynamicSliceThunkProto& proto,\n       absl::Span<const BufferAllocation> buffer_allocations,\n-      absl::Span<const BufferAllocation> fake_allocations);\n+      absl::Span<const BufferAllocation> fake_allocations,\n+      const Deserializer& deserializer);\n \n   std::optional<const OffsetAsFunctionOfIndvarModulesMetadata*>\n   get_offset_function() const {"
        },
        {
            "sha": "d3b71196e3bcbf112b6a7353cfd6cb2daa008a2d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ecc2510eb0b75a0e7509cde891550f78f687485a/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc?ref=ecc2510eb0b75a0e7509cde891550f78f687485a",
            "patch": "@@ -35,6 +35,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/gemm_thunk.h\"\n #include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n+#include \"xla/backends/gpu/runtime/thunk_proto_deserialization.h\"\n #include \"xla/ffi/attribute_map.h\"\n #include \"xla/ffi/ffi.h\"\n #include \"xla/ffi/ffi_api.h\"\n@@ -108,11 +109,18 @@ void CheckProtoRoundTrip(const DynamicSliceThunk& thunk,\n           BufferAllocation(i, arguments[i].value().allocation()->size(), 0));\n     }\n   }\n+\n+  Thunk::Deserializer deserializer =\n+      [&buffer_allocations](const ThunkProto& thunk_proto)\n+      -> absl::StatusOr<std::unique_ptr<Thunk>> {\n+    return DeserializeThunkProto(thunk_proto, buffer_allocations);\n+  };\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto thunk_from_proto,\n       DynamicSliceThunk::FromProto(Thunk::ThunkInfo(), proto,\n                                    /*buffer_allocations=*/buffer_allocations,\n-                                   /*fake_allocations=*/fake_allocations_span));\n+                                   /*fake_allocations=*/fake_allocations_span,\n+                                   deserializer));\n   TF_ASSERT_OK_AND_ASSIGN(auto proto_roundtrip, thunk_from_proto->ToProto());\n   auto dynamic_slice_thunk_proto_roundtrip =\n       proto_roundtrip.dynamic_slice_thunk();"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 18,
        "deletions": 8
    }
}