{
    "author": "chr1sj0nes",
    "message": "[xla:cpu] Fix undefined behaviour in `CopyThunk` with sub-byte types.\n\nPiperOrigin-RevId: 834075135",
    "sha": "d2cfe13dc9ecc8eabc3b7a97a0aa44599f33164e",
    "files": [
        {
            "sha": "006a4c10eb5117645b9d0083fb90f9c9b071567b",
            "filename": "third_party/xla/xla/backends/cpu/runtime/copy_thunk.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d2cfe13dc9ecc8eabc3b7a97a0aa44599f33164e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcopy_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d2cfe13dc9ecc8eabc3b7a97a0aa44599f33164e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcopy_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcopy_thunk.cc?ref=d2cfe13dc9ecc8eabc3b7a97a0aa44599f33164e",
            "patch": "@@ -57,7 +57,12 @@ absl::StatusOr<std::unique_ptr<CopyThunk>> CopyThunk::Create(\n         \"Source shape %s must be compatible with destination shape %s\",\n         src_shape.ToString(true), dst_shape.ToString(true));\n   }\n-\n+  if (src_shape != dst_shape) {\n+    if (!ShapeUtil::ByteStrides(src_shape).has_value()) {\n+      return InvalidArgument(\"Source shape %s must have valid byte strides\",\n+                             src_shape.ToString(true));\n+    }\n+  }\n   return absl::WrapUnique(new CopyThunk(std::move(info), src_buffer, src_shape,\n                                         dst_buffer, dst_shape));\n }\n@@ -78,6 +83,7 @@ CopyThunk::CopyThunk(Info info, BufferAllocation::Slice src_buffer,\n     options.dims = src_shape_.dimensions();\n \n     auto byte_strides = ShapeUtil::ByteStrides(src_shape_);\n+    CHECK(byte_strides.has_value());\n     options.input_layout = TransposePlan::Striding{*byte_strides};\n \n     absl::InlinedVector<int64_t, 4> permutation(options.dims.size());"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}