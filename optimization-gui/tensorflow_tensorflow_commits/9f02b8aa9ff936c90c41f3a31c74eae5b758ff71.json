{
    "author": "pifon2a",
    "message": "[XLA] Print and parse StackFrameIndexProto when dumping HLO in text format.\n\nAlso stop populating `source_file`, `source_line`, `source_end_line`, `source_column`, `source_end_column`.\n\nPiperOrigin-RevId: 839232032",
    "sha": "9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
    "files": [
        {
            "sha": "feab9a03c5eedf95f453876b835f449bb4b2eb1e",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -128,6 +128,7 @@ cc_library(\n         \"@highwayhash\",\n         \"@highwayhash//:arch_specific\",\n         \"@highwayhash//:hh_types\",\n+        \"@llvm-project//llvm:Support\",\n         \"@local_tsl//tsl/platform:fingerprint\",\n         \"@local_tsl//tsl/platform:protobuf\",\n     ],"
        },
        {
            "sha": "4656f2a442ca914c03d891206cf1ea9c5cf7bb2b",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -40,13 +40,15 @@ limitations under the License.\n #include \"absl/strings/match.h\"\n #include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_format.h\"\n #include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n #include \"highwayhash/arch_specific.h\"\n #include \"highwayhash/hh_types.h\"\n #include \"highwayhash/highwayhash.h\"\n+#include \"llvm/ADT/STLExtras.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_clone_context.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n@@ -397,6 +399,7 @@ void HloModule::Print(\n         },\n         value);\n   }\n+  PrintStackFrameIndex(printer);\n   printer->Append(\"\\n\\n\");\n   PrintComputations(printer, options);\n }\n@@ -469,6 +472,42 @@ void HloModule::PrintComputations(Printer* printer,\n   }\n }\n \n+void HloModule::PrintStackFrameIndex(Printer* printer) const {\n+  if (!stack_frame_index_.has_value()) {\n+    return;\n+  }\n+  printer->Append(\"\\n\\nFileNames\\n\");\n+  for (const auto& [index, file_name] :\n+       llvm::enumerate(stack_frame_index_->file_names())) {\n+    printer->Append(\n+        absl::StrFormat(\"%d \\\"%s\\\"\\n\", index + 1, absl::CEscape(file_name)));\n+  }\n+  printer->Append(\"\\nFunctionNames\\n\");\n+  for (const auto& [index, function_name] :\n+       llvm::enumerate(stack_frame_index_->function_names())) {\n+    printer->Append(absl::StrFormat(\"%d \\\"%s\\\"\\n\", index + 1,\n+                                    absl::CEscape(function_name)));\n+  }\n+  printer->Append(\"\\nFileLocations\\n\");\n+  for (const auto& [index, file_location] :\n+       llvm::enumerate(stack_frame_index_->file_locations())) {\n+    printer->Append(\n+        absl::StrFormat(\"%d {file_name_id=%d function_name_id=%d line=%d \"\n+                        \"end_line=%d column=%d end_column=%d}\\n\",\n+                        index + 1, file_location.file_name_id(),\n+                        file_location.function_name_id(), file_location.line(),\n+                        file_location.end_line(), file_location.column(),\n+                        file_location.end_column()));\n+  }\n+  printer->Append(\"\\nStackFrames\\n\");\n+  for (const auto& [index, frame] :\n+       llvm::enumerate(stack_frame_index_->stack_frames())) {\n+    printer->Append(absl::StrFormat(\n+        \"%d {file_location_id=%d parent_frame_id=%d}\\n\", index + 1,\n+        frame.file_location_id(), frame.parent_frame_id() + 1));\n+  }\n+}\n+\n std::string HloModule::ToString() const {\n   const DebugOptions& db_options = config().debug_options();\n   HloPrintOptions print_options = db_options.xla_dump_hlo_as_long_text()"
        },
        {
            "sha": "25f0ba3ac2d9674d7fbceb2925d8fe0116c1d26b",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -448,6 +448,7 @@ class HloModule {\n   void PrintComputations(Printer* printer,\n                          const HloPrintOptions& options) const;\n   void PrintConfig(Printer* printer, const HloModuleConfig& config) const;\n+  void PrintStackFrameIndex(Printer* printer) const;\n \n  public:\n   // Prints a string representation of the module.\n@@ -818,6 +819,11 @@ class HloModule {\n   // Getter for the specific stack frame. Argument is a 1-based index.\n   StackFrame get_stack_frame(int id) const;\n \n+  // Setter for the stack frame index.\n+  void set_stack_frame_index(StackFrameIndexProto stack_frame_index) {\n+    stack_frame_index_ = std::move(stack_frame_index);\n+  }\n+\n   // Finalizes this module by destroying internal data structures that might be\n   // used for building or modifying the module. It is undefined behavior to\n   // modify the module (add computations or instructions) after the call. Should"
        },
        {
            "sha": "e77825a284765b810123debab4b7dcd5f4e96e57",
            "filename": "third_party/xla/xla/hlo/ir/hlo_op_metadata.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_op_metadata.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_op_metadata.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_op_metadata.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -73,6 +73,10 @@ std::string OpMetadataToString(const OpMetadata& metadata, bool only_op_name) {\n     result.push_back(\n         absl::StrCat(\"scheduling_name=\\\"\", metadata.scheduling_name(), \"\\\"\"));\n   }\n+  if (metadata.stack_frame_id() != 0) {\n+    result.push_back(\n+        absl::StrCat(\"stack_frame_id=\", metadata.stack_frame_id()));\n+  }\n   return absl::StrJoin(result, \" \");\n }\n "
        },
        {
            "sha": "3ba0ef10696bf15884bfdacbb3bf51d994d6fff4",
            "filename": "third_party/xla/xla/hlo/parser/hlo_lexer.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -334,6 +334,10 @@ TokKind HloLexer::LexIdentifier() {\n   KEYWORD(HloModule);\n   KEYWORD(ENTRY);\n   KEYWORD(ROOT);\n+  KEYWORD(FileLocations);\n+  KEYWORD(FileNames);\n+  KEYWORD(FunctionNames);\n+  KEYWORD(StackFrames);\n   KEYWORD(maximal);\n   KEYWORD(replicated);\n   KEYWORD(manual);\n@@ -690,6 +694,14 @@ std::string TokKindToString(TokKind kind) {\n       return \"kw_ENTRY\";\n     case TokKind::kw_ROOT:\n       return \"kw_ROOT\";\n+    case TokKind::kw_FileNames:\n+      return \"kw_FileNames\";\n+    case TokKind::kw_FunctionNames:\n+      return \"kw_FunctionNames\";\n+    case TokKind::kw_FileLocations:\n+      return \"kw_FileLocations\";\n+    case TokKind::kw_StackFrames:\n+      return \"kw_StackFrames\";\n     case TokKind::kw_true:\n       return \"kw_true\";\n     case TokKind::kw_false:"
        },
        {
            "sha": "c3c3108376a54f84c4db624879420156d424e7ef",
            "filename": "third_party/xla/xla/hlo/parser/hlo_lexer.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer.h?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -61,6 +61,10 @@ enum class TokKind {\n   kw_HloModule,\n   kw_ENTRY,\n   kw_ROOT,\n+  kw_FileLocations,\n+  kw_FileNames,\n+  kw_FunctionNames,\n+  kw_StackFrames,\n   kw_true,\n   kw_false,\n   kw_maximal,"
        },
        {
            "sha": "70cdce2ab525e2d4e2b5facc1c6f0864ea1dc669",
            "filename": "third_party/xla/xla/hlo/parser/hlo_lexer_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_lexer_test.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -167,5 +167,29 @@ TEST(HloLexerTest, NegativeNumberWithoutNullTerminatingCharacter) {\n   EXPECT_EQ(lexer.GetInt64Val(), -123);\n }\n \n+TEST(HloLexerTest, FileLocationsKeyword) {\n+  HloLexer lexer(\"FileLocations\");\n+  EXPECT_EQ(lexer.Lex(), TokKind::kw_FileLocations)\n+      << \"Didn't get FileLocations keyword\";\n+}\n+\n+TEST(HloLexerTest, FileNamesKeyword) {\n+  HloLexer lexer(\"FileNames\");\n+  EXPECT_EQ(lexer.Lex(), TokKind::kw_FileNames)\n+      << \"Didn't get FileNames keyword\";\n+}\n+\n+TEST(HloLexerTest, FunctionNamesKeyword) {\n+  HloLexer lexer(\"FunctionNames\");\n+  EXPECT_EQ(lexer.Lex(), TokKind::kw_FunctionNames)\n+      << \"Didn't get FunctionNames keyword\";\n+}\n+\n+TEST(HloLexerTest, StackFramesKeyword) {\n+  HloLexer lexer(\"StackFrames\");\n+  EXPECT_EQ(lexer.Lex(), TokKind::kw_StackFrames)\n+      << \"Didn't get StackFrames keyword\";\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "fe1e5298e5db58326a35e2c3c1827b28f9206116",
            "filename": "third_party/xla/xla/hlo/parser/hlo_parser.cc",
            "status": "modified",
            "additions": 94,
            "deletions": 1,
            "changes": 95,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -377,6 +377,7 @@ class HloParserImpl : public HloParser {\n   bool ParseHloModule(HloModule* module,\n                       bool parse_module_without_header = false);\n \n+  bool ParseStackFrameIndex(HloModule* module);\n   bool ParseComputations(HloModule* module);\n   bool ParseComputation(HloComputation** entry_computation);\n   bool ParseInstructionList(HloComputation** computation,\n@@ -605,6 +606,8 @@ class HloParserImpl : public HloParser {\n   bool ParseOriginalValueRecoveryTable(\n       OriginalValueRecoveryTable& original_value_recovery_table);\n   bool ParseCollectiveOpGroupMode(CollectiveOpGroupMode* result);\n+  bool ParseFileLocationList(StackFrameIndexProto* stack_frame_index);\n+  bool ParseStackFramesList(StackFrameIndexProto* stack_frame_index);\n \n   using AliasingData =\n       absl::flat_hash_map<ShapeIndex, HloInputOutputAliasConfig::Alias>;\n@@ -1133,7 +1136,7 @@ bool HloParserImpl::ParseHloModule(HloModule* module,\n     module->set_name(name);\n   }\n \n-  if (!ParseComputations(module)) {\n+  if (!ParseStackFrameIndex(module) || !ParseComputations(module)) {\n     return false;\n   }\n \n@@ -1228,6 +1231,90 @@ bool HloParserImpl::ParseHloModule(HloModule* module,\n   return true;\n }\n \n+// Parses a list of `int {file_name_id=int function_name_id=int line=int\n+// end_line=int column=int end_column=int}` into\n+// StackFrameIndexProto::file_locations.\n+bool HloParserImpl::ParseFileLocationList(\n+    StackFrameIndexProto* stack_frame_index) {\n+  optional<int32_t> file_name_id, function_name_id, line, end_line, column,\n+      end_column;\n+  absl::flat_hash_map<std::string, AttrConfig> attrs = {\n+      {\"file_name_id\", {/*required=*/true, AttrTy::kInt32, &file_name_id}},\n+      {\"function_name_id\",\n+       {/*required=*/true, AttrTy::kInt32, &function_name_id}},\n+      {\"line\", {/*required=*/true, AttrTy::kInt32, &line}},\n+      {\"end_line\", {/*required=*/true, AttrTy::kInt32, &end_line}},\n+      {\"column\", {/*required=*/true, AttrTy::kInt32, &column}},\n+      {\"end_column\", {/*required=*/true, AttrTy::kInt32, &end_column}}};\n+  while (EatIfPresent(TokKind::kInt)) {\n+    if (!ParseSubAttributes(attrs)) {\n+      return false;\n+    }\n+    StackFrameIndexProto::FileLocation* file_location =\n+        stack_frame_index->add_file_locations();\n+    file_location->set_file_name_id(*file_name_id);\n+    file_location->set_function_name_id(*function_name_id);\n+    file_location->set_line(*line);\n+    file_location->set_end_line(*end_line);\n+    file_location->set_column(*column);\n+    file_location->set_end_column(*end_column);\n+  }\n+  return true;\n+}\n+\n+// Parses a list of `int {function_location_id=int parent_frame_id=int}` into\n+// StackFrameIndexProto::stack_frames.\n+bool HloParserImpl::ParseStackFramesList(\n+    StackFrameIndexProto* stack_frame_index) {\n+  optional<int32_t> file_location_id, parent_frame_id;\n+  absl::flat_hash_map<std::string, AttrConfig> attrs = {\n+      {\"file_location_id\",\n+       {/*required=*/true, AttrTy::kInt32, &file_location_id}},\n+      {\"parent_frame_id\",\n+       {/*required=*/true, AttrTy::kInt32, &parent_frame_id}}};\n+  while (lexer_.GetKind() == TokKind::kInt) {\n+    lexer_.Lex();\n+    if (!ParseSubAttributes(attrs)) {\n+      return false;\n+    }\n+    StackFrameIndexProto::StackFrame* stack_frame =\n+        stack_frame_index->add_stack_frames();\n+    stack_frame->set_file_location_id(*file_location_id);\n+    stack_frame->set_parent_frame_id(*parent_frame_id - 1);\n+  }\n+  return true;\n+}\n+\n+bool HloParserImpl::ParseStackFrameIndex(HloModule* module) {\n+  if (!EatIfPresent(TokKind::kw_FileNames)) {\n+    return true;\n+  }\n+  StackFrameIndexProto stack_frame_index;\n+\n+  // Parse file names.\n+  while (EatIfPresent(TokKind::kInt)) {\n+    ParseString(stack_frame_index.add_file_names());\n+  }\n+\n+  // Parse function names.\n+  if (!ParseToken(TokKind::kw_FunctionNames, \"expects 'FunctionNames'\")) {\n+    return false;\n+  }\n+  while (EatIfPresent(TokKind::kInt)) {\n+    ParseString(stack_frame_index.add_function_names());\n+  }\n+\n+  // Parse file locations and stack frames.\n+  if (!ParseToken(TokKind::kw_FileLocations, \"expects 'FileLocations'\") ||\n+      !ParseFileLocationList(&stack_frame_index) ||\n+      !ParseToken(TokKind::kw_StackFrames, \"expects 'StackFrames'\") ||\n+      !ParseStackFramesList(&stack_frame_index)) {\n+    return false;\n+  }\n+  module->set_stack_frame_index(std::move(stack_frame_index));\n+  return true;\n+}\n+\n // computations ::= (computation)+\n bool HloParserImpl::ParseComputations(HloModule* module) {\n   HloComputation* entry_computation = nullptr;\n@@ -6783,6 +6870,7 @@ bool HloParserImpl::ParseMetadata(OpMetadata& metadata) {\n   optional<int32_t> source_end_line;\n   optional<int32_t> source_column;\n   optional<int32_t> source_end_column;\n+  optional<int32_t> stack_frame_id;\n   optional<std::vector<int64_t>> profile_type;\n   optional<std::string> deduplicated_name;\n   optional<std::string> scheduling_name;\n@@ -6801,6 +6889,8 @@ bool HloParserImpl::ParseMetadata(OpMetadata& metadata) {\n                                 &deduplicated_name};\n   attrs[\"scheduling_name\"] = {/*required=*/false, AttrTy::kString,\n                               &scheduling_name};\n+  attrs[\"stack_frame_id\"] = {/*required=*/false, AttrTy::kInt32,\n+                             &stack_frame_id};\n   if (!ParseSubAttributes(attrs)) {\n     return false;\n   }\n@@ -6839,6 +6929,9 @@ bool HloParserImpl::ParseMetadata(OpMetadata& metadata) {\n   if (scheduling_name) {\n     metadata.set_scheduling_name(*scheduling_name);\n   }\n+  if (stack_frame_id) {\n+    metadata.set_stack_frame_id(*stack_frame_id);\n+  }\n   return true;\n }\n "
        },
        {
            "sha": "3e33268136e874a3e5adaa667566aef8ef1840be",
            "filename": "third_party/xla/xla/hlo/parser/hlo_parser_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -1620,6 +1620,35 @@ ENTRY %entry_spmd () -> s32[1,3] {\n \n )\"\n },\n+{\n+  \"StackFrameIndex\",\n+R\"(HloModule m, entry_computation_layout={()->pred[]}\n+\n+FileNames\n+1 \"<embedded module>\"\n+2 \"experimental/module.py\"\n+3 \"yet/another/test.py\"\n+\n+FunctionNames\n+1 \"main\"\n+2 \"method\"\n+\n+FileLocations\n+1 {file_name_id=1 function_name_id=1 line=153 end_line=153 column=2 end_column=31}\n+2 {file_name_id=3 function_name_id=2 line=35 end_line=35 column=2 end_column=24}\n+3 {file_name_id=2 function_name_id=2 line=83 end_line=83 column=2 end_column=15}\n+\n+StackFrames\n+1 {file_location_id=1 parent_frame_id=1}\n+2 {file_location_id=2 parent_frame_id=2}\n+\n+\n+ENTRY %constant_pred () -> pred[] {\n+  ROOT %constant = pred[] constant(true), metadata={op_type=\"const\" op_name=\"opname\" stack_frame_id=1}\n+}\n+\n+)\"\n+}\n });\n   // clang-format on\n }"
        },
        {
            "sha": "6e19e34991465aa27d45823d727c9a7ff493980d",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/location_exporter.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.cc?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -143,12 +143,6 @@ xla::OpMetadata CreateOpMetadataFromLocation(\n     auto result = frame_index_builder->AddCallStackAndGetFirstFrameId(loc);\n     if (result.last_frame_id != mlir::StackFrameIndexBuilder::kInvalidIndex) {\n       metadata.set_stack_frame_id(result.last_frame_id);\n-      // TODO(b/311155137): Remove when profiler will support stack traces.\n-      metadata.set_source_file(result.last_frame_file);\n-      metadata.set_source_line(result.last_frame_line);\n-      metadata.set_source_end_line(result.last_frame_end_line);\n-      metadata.set_source_column(result.last_frame_column);\n-      metadata.set_source_end_column(result.last_frame_end_column);\n       return metadata;\n     }\n   }"
        },
        {
            "sha": "2f142877ea66ef8814db18540053d0f16ab07242",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/export.mlir",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -3027,8 +3027,7 @@ func.func @main(%operand: tensor<?x784xf32>) -> tensor<?x784xf32> {\n }\n \n //       CHECK: HloModule {{.*}}, entry_computation_layout={(f32[?,784]{1,0})->f32[?,784]{1,0}}\n-// CHECK-EMPTY:\n-//  CHECK-NEXT: ENTRY {{.*}} ([[ARG0:.*]]: f32[?,784]) -> f32[?,784] {\n+//  CHECK:      ENTRY {{.*}} ([[ARG0:.*]]: f32[?,784]) -> f32[?,784] {\n //  CHECK-NEXT:   %[[ARG0]] = f32[?,784] parameter(0)\n //  CHECK-NEXT:   ROOT {{.*}} = f32[?,784] abs(%[[ARG0]]), {{.*}}\n //  CHECK-NEXT: }"
        },
        {
            "sha": "140791261511438f1208e662496f40ec6a0d4499",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/location_to_op_metadata.mlir",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_op_metadata.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_op_metadata.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_op_metadata.mlir?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -1,4 +1,4 @@\n-// RUN: xla-translate -split-input-file -mlir-hlo-to-hlo-text %s | FileCheck %s --dump-input=always --check-prefixes=CHECK\n+// RUN: xla-translate -split-input-file -mlir-hlo-to-hlo-text %s | FileCheck %s --check-prefixes=CHECK\n \n // CHECK-LABEL: %main\n func.func @main(%arg0: !mhlo.token) -> !mhlo.token {\n@@ -62,7 +62,7 @@ func.func @main(%arg0: !mhlo.token) -> !mhlo.token {\n }\n \n // CHECK: after-all\n-// CHECK-SAME: metadata={op_name=\"name(anothername)\" source_file=\"file_name\" source_line=2 source_end_line=2 source_column=8 source_end_column=8}\n+// CHECK-SAME: metadata={op_name=\"name(anothername)\" stack_frame_id=1}\n \n // -----\n "
        },
        {
            "sha": "243d41f5aae102922f416208e590ab229da61088",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/location_to_stacktrace.mlir",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_stacktrace.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f02b8aa9ff936c90c41f3a31c74eae5b758ff71/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_stacktrace.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_stacktrace.mlir?ref=9f02b8aa9ff936c90c41f3a31c74eae5b758ff71",
            "patch": "@@ -1,4 +1,4 @@\n-// RUN: xla-translate -split-input-file -mlir-hlo-to-hlo %s | FileCheck %s\n+// RUN: xla-translate -split-input-file -mlir-hlo-to-hlo %s | FileCheck %s \n \n // Checks no locations\n \n@@ -33,12 +33,7 @@ module @main attributes {mhlo.cross_program_prefetches = [], mhlo.is_dynamic = f\n // CHECK-NEXT: }\n // CHECK-NEXT: metadata {\n // CHECK-NEXT:   op_name: \"name(anothername)\"\n-// CHECK-NEXT:   source_file: \"file_name\"\n-// CHECK-NEXT:   source_line: 2\n // CHECK-NEXT:   stack_frame_id: 1\n-// CHECK-NEXT:   source_end_line: 2\n-// CHECK-NEXT:   source_column: 8\n-// CHECK-NEXT:   source_end_column: 8\n // CHECK-NEXT: }\n \n // CHECK: stack_frame_index {\n@@ -79,12 +74,7 @@ module @main attributes {mhlo.cross_program_prefetches = [], mhlo.is_dynamic = f\n // CHECK-NEXT: metadata {\n // CHECK-NEXT:   op_type: \"atype\"\n // CHECK-NEXT:   op_name: \"name(anothername)\"\n-// CHECK-NEXT:   source_file: \"file_name_2\"\n-// CHECK-NEXT:   source_line: 3\n // CHECK-NEXT:   stack_frame_id: 2\n-// CHECK-NEXT:   source_end_line: 3\n-// CHECK-NEXT:   source_column: 4\n-// CHECK-NEXT:   source_end_column: 4\n // CHECK-NEXT: }\n \n // CHECK: stack_frame_index {"
        }
    ],
    "stats": {
        "total": 239,
        "additions": 217,
        "deletions": 22
    }
}