{
    "author": "ezhulenev",
    "message": "[stream_executor] Rename StreamExecutorMemoryAllocator to StreamExecutorAddressAllocator\n\nPiperOrigin-RevId: 840631771",
    "sha": "8d02abdbd5270f5efcdfe0734e1888f135a47e7a",
    "files": [
        {
            "sha": "dce1767c7a0463b36938b452e7135e74ac96eaff",
            "filename": "third_party/xla/xla/stream_executor/BUILD",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD?ref=8d02abdbd5270f5efcdfe0734e1888f135a47e7a",
            "patch": "@@ -270,15 +270,16 @@ cc_library(\n )\n \n cc_library(\n-    name = \"stream_executor_memory_allocator\",\n-    srcs = [\"stream_executor_memory_allocator.cc\"],\n-    hdrs = [\"stream_executor_memory_allocator.h\"],\n+    name = \"stream_executor_address_allocator\",\n+    srcs = [\"stream_executor_address_allocator.cc\"],\n+    hdrs = [\"stream_executor_address_allocator.h\"],\n     deps = [\n-        \":device_memory\",\n-        \":device_memory_allocator\",\n+        \":device_address\",\n+        \":device_address_allocator\",\n         \":platform\",\n         \":stream\",\n         \":stream_executor_h\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n@@ -287,9 +288,16 @@ cc_library(\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:numbers\",\n-        \"@local_tsl//tsl/platform:statusor\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"stream_executor_memory_allocator\",\n+    hdrs = [\"stream_executor_memory_allocator.h\"],\n+    deps = [\n+        \":stream_executor_address_allocator\",\n+        \"@com_google_absl//absl/base:core_headers\",\n     ],\n )\n "
        },
        {
            "sha": "8a69cdda46460db3f391515d60ad1c3a70c919cf",
            "filename": "third_party/xla/xla/stream_executor/stream_executor_address_allocator.cc",
            "status": "renamed",
            "additions": 20,
            "deletions": 20,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_address_allocator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_address_allocator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_address_allocator.cc?ref=8d02abdbd5270f5efcdfe0734e1888f135a47e7a",
            "patch": "@@ -13,7 +13,7 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/stream_executor/stream_executor_memory_allocator.h\"\n+#include \"xla/stream_executor/stream_executor_address_allocator.h\"\n \n #include <cstdint>\n #include <utility>\n@@ -25,35 +25,35 @@ limitations under the License.\n #include \"absl/strings/str_format.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n-#include \"xla/stream_executor/device_memory.h\"\n-#include \"xla/stream_executor/device_memory_allocator.h\"\n+#include \"xla/stream_executor/device_address.h\"\n+#include \"xla/stream_executor/device_address_allocator.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/stream.h\"\n #include \"xla/stream_executor/stream_executor.h\"\n-#include \"tsl/platform/logging.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"tsl/platform/numbers.h\"\n-#include \"tsl/platform/statusor.h\"\n \n namespace stream_executor {\n \n-StreamExecutorMemoryAllocator::StreamExecutorMemoryAllocator(\n+StreamExecutorAddressAllocator::StreamExecutorAddressAllocator(\n     StreamExecutor* executor)\n-    : DeviceMemoryAllocator(executor->GetPlatform()) {\n+    : DeviceAddressAllocator(executor->GetPlatform()) {\n   stream_executors_ = {executor};\n }\n \n-StreamExecutorMemoryAllocator::StreamExecutorMemoryAllocator(\n+StreamExecutorAddressAllocator::StreamExecutorAddressAllocator(\n     const Platform* platform,\n     absl::Span<StreamExecutor* const> stream_executors)\n-    : DeviceMemoryAllocator(platform),\n+    : DeviceAddressAllocator(platform),\n       stream_executors_(stream_executors.begin(), stream_executors.end()) {}\n \n-absl::StatusOr<OwningDeviceMemory> StreamExecutorMemoryAllocator::Allocate(\n-    int device_ordinal, uint64_t size, bool retry_on_failure,\n-    int64_t memory_space) {\n+absl::StatusOr<ScopedDeviceAddress<uint8_t>>\n+StreamExecutorAddressAllocator::Allocate(int device_ordinal, uint64_t size,\n+                                         bool retry_on_failure,\n+                                         int64_t memory_space) {\n   TF_ASSIGN_OR_RETURN(StreamExecutor * executor,\n                       GetStreamExecutor(device_ordinal));\n-  DeviceMemoryBase result =\n+  DeviceAddressBase result =\n       executor->AllocateArray<uint8_t>(size, memory_space);\n   if (size > 0 && result == nullptr) {\n     return absl::ResourceExhaustedError(absl::StrFormat(\n@@ -63,11 +63,11 @@ absl::StatusOr<OwningDeviceMemory> StreamExecutorMemoryAllocator::Allocate(\n   VLOG(3) << absl::StreamFormat(\"Allocated %s (%uB) on device ordinal %d: %p\",\n                                 tsl::strings::HumanReadableNumBytes(size), size,\n                                 device_ordinal, result.opaque());\n-  return OwningDeviceMemory(result, device_ordinal, this);\n+  return ScopedDeviceAddress<uint8_t>(result, device_ordinal, this);\n }\n \n-absl::Status StreamExecutorMemoryAllocator::Deallocate(int device_ordinal,\n-                                                       DeviceMemoryBase mem) {\n+absl::Status StreamExecutorAddressAllocator::Deallocate(int device_ordinal,\n+                                                        DeviceAddressBase mem) {\n   if (!mem.is_null()) {\n     TF_ASSIGN_OR_RETURN(StreamExecutor * executor,\n                         GetStreamExecutor(device_ordinal));\n@@ -79,7 +79,7 @@ absl::Status StreamExecutorMemoryAllocator::Deallocate(int device_ordinal,\n }\n \n absl::StatusOr<StreamExecutor*>\n-StreamExecutorMemoryAllocator::GetStreamExecutor(int device_ordinal) const {\n+StreamExecutorAddressAllocator::GetStreamExecutor(int device_ordinal) const {\n   if (device_ordinal < 0) {\n     return absl::InvalidArgumentError(absl::StrFormat(\n         \"device ordinal value (%d) must be non-negative\", device_ordinal));\n@@ -94,11 +94,11 @@ StreamExecutorMemoryAllocator::GetStreamExecutor(int device_ordinal) const {\n                       platform()->Name(), device_ordinal));\n }\n \n-bool StreamExecutorMemoryAllocator::AllowsAsynchronousDeallocation() const {\n+bool StreamExecutorAddressAllocator::AllowsAsynchronousDeallocation() const {\n   return false;\n }\n \n-absl::StatusOr<Stream*> StreamExecutorMemoryAllocator::GetStream(\n+absl::StatusOr<Stream*> StreamExecutorAddressAllocator::GetStream(\n     int device_ordinal) {\n   CHECK(!AllowsAsynchronousDeallocation())\n       << \"The logic below only works for synchronous allocators\";\n@@ -108,7 +108,7 @@ absl::StatusOr<Stream*> StreamExecutorMemoryAllocator::GetStream(\n   if (!streams_.count(device_ordinal)) {\n     TF_ASSIGN_OR_RETURN(auto stream, executor->CreateStream());\n     auto stream_ptr = stream.get();\n-    stream_ptr->SetName(\"StreamExecutorMemoryAllocator\");\n+    stream_ptr->SetName(\"StreamExecutorAddressAllocator\");\n     streams_.emplace(device_ordinal, std::move(stream));\n     return stream_ptr;\n   }",
            "previous_filename": "third_party/xla/xla/stream_executor/stream_executor_memory_allocator.cc"
        },
        {
            "sha": "fc33d0dd66854e57e81bea18dc89adc5aeef8fee",
            "filename": "third_party/xla/xla/stream_executor/stream_executor_address_allocator.h",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_address_allocator.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_address_allocator.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_address_allocator.h?ref=8d02abdbd5270f5efcdfe0734e1888f135a47e7a",
            "patch": "@@ -0,0 +1,82 @@\n+/* Copyright 2024 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_STREAM_EXECUTOR_STREAM_EXECUTOR_ADDRESS_ALLOCATOR_H_\n+#define XLA_STREAM_EXECUTOR_STREAM_EXECUTOR_ADDRESS_ALLOCATOR_H_\n+\n+#include <cstdint>\n+#include <map>\n+#include <memory>\n+#include <vector>\n+\n+#include \"absl/base/thread_annotations.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/synchronization/mutex.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/stream_executor/device_address.h\"\n+#include \"xla/stream_executor/device_address_allocator.h\"\n+#include \"xla/stream_executor/platform.h\"\n+#include \"xla/stream_executor/stream_executor.h\"\n+\n+namespace stream_executor {\n+\n+// Default address allocator for a platform which uses StreamExecutor\n+// Allocate/Deallocate APIs.\n+class StreamExecutorAddressAllocator : public DeviceAddressAllocator {\n+ public:\n+  // Create an allocator supporting a single device, corresponding to the\n+  // passed executor.\n+  explicit StreamExecutorAddressAllocator(StreamExecutor* executor);\n+\n+  // Create an allocator supporting multiple stream executors.\n+  //\n+  // Precondition: all stream_executors have different device ordinals.\n+  StreamExecutorAddressAllocator(\n+      const Platform* platform,\n+      absl::Span<StreamExecutor* const> stream_executors);\n+\n+  absl::StatusOr<ScopedDeviceAddress<uint8_t>> Allocate(\n+      int device_ordinal, uint64_t size, bool retry_on_failure,\n+      int64_t memory_space) override;\n+\n+  // Pull in two-arg overload that sets retry_on_failure to true.\n+  using DeviceAddressAllocator::Allocate;\n+\n+  absl::Status Deallocate(int device_ordinal, DeviceAddressBase mem) override;\n+\n+  bool AllowsAsynchronousDeallocation() const override;\n+\n+  // Gets-or-creates a stream for a given `device_ordinal` from an appropriate\n+  // stream executor.\n+  absl::StatusOr<Stream*> GetStream(int device_ordinal) override;\n+\n+  // Gets the stream executor for given device ordinal.\n+  absl::StatusOr<StreamExecutor*> GetStreamExecutor(int device_ordinal) const;\n+\n+ private:\n+  // Available stream executors. Each stream executor has a different device\n+  // ordinal.\n+  std::vector<StreamExecutor*> stream_executors_;\n+\n+  absl::Mutex mutex_;\n+\n+  // Cache of streams for GetStream.\n+  std::map<int, std::unique_ptr<Stream>> streams_ ABSL_GUARDED_BY(mutex_);\n+};\n+\n+}  // namespace stream_executor\n+\n+#endif  // XLA_STREAM_EXECUTOR_STREAM_EXECUTOR_ADDRESS_ALLOCATOR_H_"
        },
        {
            "sha": "4d7545e2f252f2a1bf5360c1c6d32f66c3aca5a8",
            "filename": "third_party/xla/xla/stream_executor/stream_executor_memory_allocator.h",
            "status": "modified",
            "additions": 6,
            "deletions": 59,
            "changes": 65,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_memory_allocator.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d02abdbd5270f5efcdfe0734e1888f135a47e7a/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_memory_allocator.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fstream_executor_memory_allocator.h?ref=8d02abdbd5270f5efcdfe0734e1888f135a47e7a",
            "patch": "@@ -1,4 +1,4 @@\n-/* Copyright 2024 The OpenXLA Authors.\n+/* Copyright 2025 The OpenXLA Authors.\n \n Licensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\n@@ -16,67 +16,14 @@ limitations under the License.\n #ifndef XLA_STREAM_EXECUTOR_STREAM_EXECUTOR_MEMORY_ALLOCATOR_H_\n #define XLA_STREAM_EXECUTOR_STREAM_EXECUTOR_MEMORY_ALLOCATOR_H_\n \n-#include <cstdint>\n-#include <map>\n-#include <memory>\n-#include <vector>\n-\n-#include \"absl/base/thread_annotations.h\"\n-#include \"absl/status/status.h\"\n-#include \"absl/status/statusor.h\"\n-#include \"absl/synchronization/mutex.h\"\n-#include \"absl/types/span.h\"\n-#include \"xla/stream_executor/device_memory.h\"\n-#include \"xla/stream_executor/device_memory_allocator.h\"\n-#include \"xla/stream_executor/platform.h\"\n-#include \"xla/stream_executor/stream_executor.h\"\n+#include \"absl/base/macros.h\"\n+#include \"xla/stream_executor/stream_executor_address_allocator.h\"\n \n namespace stream_executor {\n \n-// Default memory allocator for a platform which uses\n-// StreamExecutor::Allocate/Deallocate.\n-class StreamExecutorMemoryAllocator : public DeviceMemoryAllocator {\n- public:\n-  // Create an allocator supporting a single device, corresponding to the\n-  // passed executor.\n-  explicit StreamExecutorMemoryAllocator(StreamExecutor *executor);\n-\n-  // Create an allocator supporting multiple stream executors.\n-  //\n-  // Precondition: all stream_executors have different device ordinals.\n-  StreamExecutorMemoryAllocator(\n-      const Platform *platform,\n-      absl::Span<StreamExecutor *const> stream_executors);\n-\n-  absl::StatusOr<OwningDeviceMemory> Allocate(int device_ordinal, uint64_t size,\n-                                              bool retry_on_failure,\n-                                              int64_t memory_space) override;\n-\n-  // Pull in two-arg overload that sets retry_on_failure to true.\n-  using DeviceMemoryAllocator::Allocate;\n-\n-  absl::Status Deallocate(int device_ordinal, DeviceMemoryBase mem) override;\n-\n-  bool AllowsAsynchronousDeallocation() const override;\n-\n-  // Gets-or-creates a stream for a given `device_ordinal` from an appropriate\n-  // stream executor.\n-  absl::StatusOr<Stream *> GetStream(int device_ordinal) override;\n-\n-  // Gets the stream executor for given device ordinal.\n-  absl::StatusOr<StreamExecutor *> GetStreamExecutor(int device_ordinal) const;\n-\n- private:\n-  // Available stream executors. Each stream executor has a different device\n-  // ordinal.\n-  std::vector<StreamExecutor *> stream_executors_;\n-\n-  absl::Mutex mutex_;\n-\n-  // Cache of streams for GetStream.\n-  std::map<int, std::unique_ptr<Stream>> streams_ ABSL_GUARDED_BY(mutex_);\n-};\n+using StreamExecutorMemoryAllocator ABSL_DEPRECATE_AND_INLINE() =\n+    ::stream_executor::StreamExecutorAddressAllocator;\n \n-}  // namespace stream_executor\n+}\n \n #endif  // XLA_STREAM_EXECUTOR_STREAM_EXECUTOR_MEMORY_ALLOCATOR_H_"
        }
    ],
    "stats": {
        "total": 209,
        "additions": 123,
        "deletions": 86
    }
}