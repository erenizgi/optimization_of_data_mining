{
    "author": "jpienaar",
    "message": "Convert to nanobind.\n\nThis just converts but doesn't rename to enable cleaner diff.\n\nPiperOrigin-RevId: 819018201",
    "sha": "cb02304fd7917a53bd45021b7599d04f5ee693d5",
    "files": [
        {
            "sha": "64baf0b2fb7731f79e200534058f1d6c6af9af19",
            "filename": "tensorflow/compiler/mlir/lite/integrations/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb02304fd7917a53bd45021b7599d04f5ee693d5/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fintegrations%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb02304fd7917a53bd45021b7599d04f5ee693d5/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fintegrations%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fintegrations%2FBUILD?ref=cb02304fd7917a53bd45021b7599d04f5ee693d5",
            "patch": "@@ -40,6 +40,7 @@ pybind_extension(\n         \"//tensorflow/compiler/mlir/tensorflow:convert_tensor\",\n         \"//tensorflow/python/lib/core:ndarray_tensor\",\n         \"//tensorflow/python/lib/core:py_func_lib\",\n+        \"@com_google_absl//absl/strings:string_view\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:AllPassesAndDialects\",\n         \"@llvm-project//mlir:ArithDialect\",\n@@ -48,15 +49,14 @@ pybind_extension(\n         \"@llvm-project//mlir:FuncExtensions\",\n         \"@llvm-project//mlir:FuncTransforms\",\n         \"@llvm-project//mlir:IR\",\n-        \"@llvm-project//mlir:MLIRBindingsPythonHeaders\",\n-        \"@llvm-project//mlir:MLIRBindingsPythonHeadersAndDeps\",\n+        \"@llvm-project//mlir:MLIRBindingsPythonNanobindHeadersAndDeps\",\n         \"@llvm-project//mlir:MlirOptLib\",\n         \"@llvm-project//mlir:Pass\",\n         \"@llvm-project//mlir:QuantOps\",\n         \"@llvm-project//mlir:Support\",\n         \"@llvm-project//mlir:Transforms\",\n         \"@local_xla//third_party/python_runtime:headers\",\n-        \"@pybind11\",\n+        \"@nanobind\",\n         \"@stablehlo//:register\",\n         \"@stablehlo//:stablehlo_ops\",\n         \"@stablehlo//:vhlo_ops\","
        },
        {
            "sha": "0d83e1971072c35f15ef829b64307b45c9d3f28f",
            "filename": "tensorflow/compiler/mlir/lite/integrations/model_utils_core_pybind.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 17,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb02304fd7917a53bd45021b7599d04f5ee693d5/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fintegrations%2Fmodel_utils_core_pybind.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb02304fd7917a53bd45021b7599d04f5ee693d5/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fintegrations%2Fmodel_utils_core_pybind.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fintegrations%2Fmodel_utils_core_pybind.cc?ref=cb02304fd7917a53bd45021b7599d04f5ee693d5",
            "patch": "@@ -23,7 +23,7 @@ limitations under the License.\n #include \"mlir/Tools/mlir-opt/MlirOptMain.h\"\n #include \"llvm/Support/Casting.h\"\n #include \"mlir-c/IR.h\"  // from @llvm-project\n-#include \"mlir/Bindings/Python/PybindAdaptors.h\"  // from @llvm-project  // IWYU pragma: keep\n+#include \"mlir/Bindings/Python/NanobindAdaptors.h\"  // from @llvm-project  // IWYU pragma: keep\n #include \"mlir/CAPI/IR.h\"  // from @llvm-project\n #include \"mlir/Dialect/Arith/IR/Arith.h\"  // from @llvm-project\n #include \"mlir/Dialect/Func/Extensions/AllExtensions.h\"  // from @llvm-project\n@@ -40,9 +40,10 @@ limitations under the License.\n #include \"mlir/Pass/Pass.h\"  // from @llvm-project\n #include \"mlir/Pass/PassRegistry.h\"  // from @llvm-project\n #include \"mlir/Transforms/Passes.h\"  // from @llvm-project\n-#include \"pybind11/cast.h\"  // from @pybind11\n-#include \"pybind11/pybind11.h\"  // from @pybind11\n-#include \"pybind11/pytypes.h\"  // from @pybind11\n+#include \"nanobind/nanobind.h\"  // from @nanobind\n+#include \"nanobind/stl/string.h\"  // from @nanobind\n+#include \"nanobind/stl/string_view.h\"  // from @nanobind\n+#include \"nanobind/stl/vector.h\"  // from @nanobind\n #include \"stablehlo/dialect/Register.h\"  // from @stablehlo\n #include \"stablehlo/dialect/StablehloOps.h\"  // from @stablehlo\n #include \"stablehlo/dialect/VhloOps.h\"  // from @stablehlo\n@@ -57,7 +58,7 @@ limitations under the License.\n #include \"tensorflow/compiler/mlir/tensorflow/utils/convert_tensor.h\"\n #include \"tensorflow/python/lib/core/ndarray_tensor.h\"\n \n-namespace py = pybind11;\n+namespace nb = nanobind;\n \n // -----------------------------------------------------------------------------\n // Module initialization.\n@@ -70,7 +71,7 @@ class MlirPythonPass\n                                mlir::OperationPass<mlir::ModuleOp>> {\n  public:\n   explicit MlirPythonPass(std::string name, std::string description,\n-                          py::object pyfunc)\n+                          nb::object pyfunc)\n       : name_(name), description_(description), pyfunc_(pyfunc) {\n     pyfunc.inc_ref();\n   }\n@@ -85,8 +86,8 @@ class MlirPythonPass\n     auto module_clone = getOperation().clone();\n     MlirModule c_module = wrap(module_clone);\n \n-    auto py_module = py::cast(c_module);\n-    auto py_args = py::make_tuple(py_module);\n+    auto py_module = nb::cast(c_module);\n+    auto py_args = nb::make_tuple(py_module);\n     PyObject* py_pass_ret = PyObject_CallObject(pyfunc_.ptr(), py_args.ptr());\n \n     if (py_pass_ret == nullptr || PyErr_Occurred()) {\n@@ -95,8 +96,8 @@ class MlirPythonPass\n       signalPassFailure();\n       return;\n     }\n-    auto py_new_module_op = py::cast<py::object>(py_pass_ret);\n-    auto c_new_module_op = py::cast<MlirOperation>(py_new_module_op);\n+    auto py_new_module_op = nb::steal<nb::object>(py_pass_ret);\n+    auto c_new_module_op = nb::cast<MlirOperation>(py_new_module_op);\n     mlir::Operation* new_module_op = unwrap(c_new_module_op);\n \n     // TODO: Copy attributes from new_module\n@@ -108,7 +109,7 @@ class MlirPythonPass\n  private:\n   std::string name_;\n   std::string description_;\n-  py::object pyfunc_;\n+  nb::object pyfunc_;\n };\n \n inline void RegisterDialects(mlir::DialectRegistry& registry) {\n@@ -131,7 +132,7 @@ inline void RegisterPasses() {\n       []() { return mlir::TFL::CreateOptimizePass(); });\n }\n \n-PYBIND11_MODULE(model_utils_core_pybind, m) {\n+NB_MODULE(model_utils_core_pybind, m) {\n   Py_Initialize();\n \n   m.doc() = \"LiteRT ModelUtils Core Pybinds\";\n@@ -142,7 +143,7 @@ PYBIND11_MODULE(model_utils_core_pybind, m) {\n   m.def(\"mlir_opt_main\", [](std::vector<std::string> argv,\n                             std::vector<std::string> pass_names,\n                             std::vector<std::string> pass_descriptions,\n-                            std::vector<py::object> pass_fns) {\n+                            std::vector<nb::object> pass_fns) {\n     std::vector<char*> c_argv_vec;\n     c_argv_vec.reserve(argv.size());\n     for (size_t i = 0; i < argv.size(); ++i)\n@@ -178,14 +179,15 @@ PYBIND11_MODULE(model_utils_core_pybind, m) {\n   });\n \n   m.def(\"flatbuffer_to_mlir\",\n-        [](py::bytes buffer, MlirContext context) -> MlirModule {\n+        [](nb::bytes buffer, MlirContext context) -> MlirModule {\n           mlir::DialectRegistry registry;\n           RegisterDialects(registry);\n           unwrap(context)->appendDialectRegistry(registry);\n           unwrap(context)->loadAllAvailableDialects();\n \n           auto module_op = tflite::FlatBufferToMlir(\n-              buffer, unwrap(context), mlir::UnknownLoc::get(unwrap(context)));\n+              absl::string_view(buffer.c_str(), buffer.size()), unwrap(context),\n+              mlir::UnknownLoc::get(unwrap(context)));\n           return wrap(module_op.release());\n         });\n \n@@ -197,7 +199,7 @@ PYBIND11_MODULE(model_utils_core_pybind, m) {\n     std::string result;\n     tflite::MlirToFlatBufferTranslateFunction(module_op, options, &result,\n                                               true);\n-    return py::bytes(result);\n+    return nb::bytes(result.data(), result.size());\n   });\n \n   m.def(\"get_operation_attribute_names\", [](MlirOperation c_op) {\n@@ -227,7 +229,7 @@ PYBIND11_MODULE(model_utils_core_pybind, m) {\n     PyObject* np_array = Py_None;\n     status = tensorflow::TensorToNdarray(tensor, &np_array);\n \n-    return py::reinterpret_steal<py::object>(np_array);\n+    return nb::steal<nb::object>(np_array);\n   });\n }\n "
        }
    ],
    "stats": {
        "total": 42,
        "additions": 22,
        "deletions": 20
    }
}