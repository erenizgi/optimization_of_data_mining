{
    "author": "liepieshov",
    "message": "Make adding missing shardings to control flow configurable in StableHLO export.\n\nIntroduce `addMissingShardingToControlFlow` option in `StablehloExportPipelineOptions` to control whether `ExportStablehloShardingsPass` adds missing shardings to control flow ops. Disable this option in `mlir_to_hlo.cc` when converting MLIR to HLO.\n\nPiperOrigin-RevId: 822542288",
    "sha": "b5d09010cd0402486bdc75c98ee79feffacb3edf",
    "files": [
        {
            "sha": "3cbdf0576d8ea265df0aa042fe2909341223cf1f",
            "filename": "third_party/xla/xla/pjrt/mlir_to_hlo.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b5d09010cd0402486bdc75c98ee79feffacb3edf/third_party%2Fxla%2Fxla%2Fpjrt%2Fmlir_to_hlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b5d09010cd0402486bdc75c98ee79feffacb3edf/third_party%2Fxla%2Fxla%2Fpjrt%2Fmlir_to_hlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fmlir_to_hlo.cc?ref=b5d09010cd0402486bdc75c98ee79feffacb3edf",
            "patch": "@@ -230,6 +230,7 @@ absl::Status ExportShardyForGSPMD(mlir::ModuleOp module) {\n   // to handle.\n   xla::sdy::StablehloExportPipelineOptions options;\n   options.keepHloShardingConstraints = true;\n+  options.addMissingShardingToControlFlow = false;\n   xla::sdy::addStablehloExportPipeline(pm, options);\n   mlir::BaseScopedDiagnosticHandler diagnostic_handler(context);\n   if (!mlir::succeeded(pm.run(module))) {"
        },
        {
            "sha": "6a71171ef4fa8e33c68deb42af86c2e8aa4a8e82",
            "filename": "third_party/xla/xla/service/spmd/shardy/stablehlo_round_trip/stablehlo_export.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b5d09010cd0402486bdc75c98ee79feffacb3edf/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b5d09010cd0402486bdc75c98ee79feffacb3edf/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.cc?ref=b5d09010cd0402486bdc75c98ee79feffacb3edf",
            "patch": "@@ -28,8 +28,8 @@ limitations under the License.\n namespace xla {\n namespace sdy {\n \n-void addStablehloExportPipeline(\n-    mlir::OpPassManager& pm, const StablehloExportPipelineOptions& options) {\n+void addStablehloExportPipeline(mlir::OpPassManager& pm,\n+                                const StablehloExportPipelineOptions& options) {\n   pm.addPass(createStablehloExportManualReductionCollectivesPass());\n   // This pass converts `sdy.constant` (which isn't foldable) into\n   // `stablehlo.constant` (which is foldable), therefore greedy pattern\n@@ -44,14 +44,15 @@ void addStablehloExportPipeline(\n   // free variable that has a sharding is lifted as an additional result, and in\n   // effect the op will have a replicated sharding for all results.\n   pm.addPass(createExportStablehloShardingsPass(\n-      /*addMissingShardingToControlFlow=*/true));\n+      /*addMissingShardingToControlFlow=*/options\n+          .addMissingShardingToControlFlow));\n   pm.addPass(createStablehloRoundTripExportCallbackCustomCallsPass());\n }\n \n namespace {\n \n-void stablehloExportPipeline(\n-    mlir::OpPassManager& pm, const StablehloExportPipelineOptions& options) {\n+void stablehloExportPipeline(mlir::OpPassManager& pm,\n+                             const StablehloExportPipelineOptions& options) {\n   addStablehloExportPipeline(pm, options);\n }\n "
        },
        {
            "sha": "bfb1a60d467288bd2dbcaff1c7f84d44ed3ec817",
            "filename": "third_party/xla/xla/service/spmd/shardy/stablehlo_round_trip/stablehlo_export.h",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b5d09010cd0402486bdc75c98ee79feffacb3edf/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b5d09010cd0402486bdc75c98ee79feffacb3edf/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_export.h?ref=b5d09010cd0402486bdc75c98ee79feffacb3edf",
            "patch": "@@ -27,12 +27,12 @@ namespace sdy {\n struct StablehloExportPipelineOptions\n     : public mlir::PassPipelineOptions<StablehloExportPipelineOptions> {\n   Option<bool> keepHloShardingConstraints{\n-    *this, \"keep-hlo-sharding-constraints\",\n-    llvm::cl::desc(\n-        \"Whether to convert SDY sharding constraints to @Sharding custom \"\n-        \"calls - the HLO sharding constraint op. Else export \"\n-        \"them to MHLO copy ops. By default, export to MHLO copy ops.\"),\n-    llvm::cl::init(false)};\n+      *this, \"keep-hlo-sharding-constraints\",\n+      llvm::cl::desc(\n+          \"Whether to convert SDY sharding constraints to @Sharding custom \"\n+          \"calls - the HLO sharding constraint op. Else export \"\n+          \"them to MHLO copy ops. By default, export to MHLO copy ops.\"),\n+      llvm::cl::init(false)};\n   Option<bool> dedupFunctionsFully{\n       *this, \"dedup-functions-fully\",\n       llvm::cl::desc(\n@@ -41,6 +41,11 @@ struct StablehloExportPipelineOptions\n           \"each caller function. The default is false, meaning it will \"\n           \"deduplicate only if the input and output shardings are the same.\"),\n       llvm::cl::init(false)};\n+  Option<bool> addMissingShardingToControlFlow{\n+      *this, \"add-missing-sharding-to-control-flow\",\n+      llvm::cl::desc(\n+          \"Whether to add a sharding to a control flow op without one.\"),\n+      llvm::cl::init(true)};\n };\n \n // Register the xla-sdy-stablehlo-export-pipeline."
        }
    ],
    "stats": {
        "total": 29,
        "additions": 18,
        "deletions": 11
    }
}