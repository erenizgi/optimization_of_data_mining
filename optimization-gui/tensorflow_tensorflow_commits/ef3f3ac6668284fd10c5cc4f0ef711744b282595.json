{
    "author": "tensorflower-gardener",
    "message": "Always insert explicit reshards for `sdy.named_computation` data flow edges which represent calls.\n\nPiperOrigin-RevId: 806282104",
    "sha": "ef3f3ac6668284fd10c5cc4f0ef711744b282595",
    "files": [
        {
            "sha": "25183dc750fcdf7b8b260aff4c4f4e5bc7295143",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner_test.cc",
            "status": "modified",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef3f3ac6668284fd10c5cc4f0ef711744b282595/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef3f3ac6668284fd10c5cc4f0ef711744b282595/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc?ref=ef3f3ac6668284fd10c5cc4f0ef711744b282595",
            "patch": "@@ -393,6 +393,93 @@ ENTRY main {\n   EXPECT_THAT(call1_comp_root,\n               AllOf(op::Multiply(op::Reshape(), op::Broadcast(op::Constant())),\n                     op::Shape(\"s32[4,1]\")));\n+  EXPECT_EQ(module->computation_count(), 3);\n+}\n+\n+TEST_P(SpmdPartitioningTest, PartitionCallMultipleMatchedCallsites) {\n+  absl::string_view hlo_string = R\"(\n+HloModule jit_f\n+\n+g {\n+  param = s32[8,2]{1,0} parameter(0), sharding={devices=[2,2]<=[4]}\n+  constant.0 = s32[] constant(0), sharding={replicated}\n+  broadcast = s32[8,2]{1,0} broadcast(constant.0), dimensions={}, sharding={devices=[2,2]<=[4]}\n+  ROOT multiply = s32[8,2]{1,0} multiply(param, broadcast), sharding={devices=[2,2]<=[4]}\n+}\n+\n+ENTRY main {\n+  input0 = s32[8,2]{1,0} parameter(0), sharding={devices=[2,2]<=[4]}\n+  input1 = s32[8,2]{1,0} parameter(1), sharding={devices=[2,2]<=[4]}\n+  multiply = s32[8,2]{1,0} multiply(input0, input0), sharding={devices=[2,2]<=[4]}\n+  call.0 = s32[8,2]{1,0} call(multiply), to_apply=g, sharding={devices=[2,2]<=[4]}\n+  add = s32[8,2]{1,0} add(input1, input1), sharding={devices=[2,2]<=[4]}\n+  call.1 = s32[8,2]{1,0} call(add), to_apply=g, sharding={devices=[2,2]<=[4]}\n+  ROOT root = s32[8,2]{1,0} add(call.0, call.1), sharding={devices=[2,2]<=[4]}\n+})\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          PartitionComputation(hlo_string, /*num_devices=*/4));\n+  VLOG(1) << module->ToString();\n+  HloInstruction* root = module->entry_computation()->root_instruction();\n+  EXPECT_THAT(root,\n+              AllOf(op::Add(op::Call(), op::Call()), op::Shape(\"s32[4,1]\")));\n+  const HloInstruction* call0 = root->operand(0);\n+  const HloInstruction* call1 = root->operand(1);\n+  EXPECT_EQ(call0->to_apply(), call1->to_apply());\n+  EXPECT_THAT(call0->operand(0),\n+              AllOf(op::Multiply(op::Parameter(0), op::Parameter(0)),\n+                    op::Shape(\"s32[4,1]\")));\n+  EXPECT_THAT(call1->operand(0),\n+              AllOf(op::Add(op::Parameter(1), op::Parameter(1)),\n+                    op::Shape(\"s32[4,1]\")));\n+  const HloInstruction* call0_comp_root = call0->to_apply()->root_instruction();\n+  EXPECT_THAT(\n+      call0_comp_root,\n+      AllOf(op::Multiply(op::Parameter(0), op::Broadcast(op::Constant())),\n+            op::Shape(\"s32[4,1]\")));\n+  EXPECT_EQ(module->computation_count(), 2);\n+}\n+\n+TEST_P(SpmdPartitioningTest, PartitionCallMultipleCallsitesMatchedByReshard) {\n+  absl::string_view hlo_string = R\"(\n+HloModule jit_f\n+\n+g {\n+  param = s32[8,2]{1,0} parameter(0), sharding={devices=[2,2]<=[4]}\n+  constant.0 = s32[] constant(0), sharding={replicated}\n+  broadcast = s32[8,2]{1,0} broadcast(constant.0), dimensions={}, sharding={devices=[2,2]<=[4]}\n+  ROOT multiply = s32[8,2]{1,0} multiply(param, broadcast), sharding={devices=[2,2]<=[4]}\n+}\n+\n+ENTRY main {\n+  input0 = s32[8,2]{1,0} parameter(0), sharding={devices=[2,2]<=[4]}\n+  input1 = s32[8,2]{1,0} parameter(1), sharding={devices=[4,1]<=[4]}\n+  multiply = s32[8,2]{1,0} multiply(input0, input0), sharding={devices=[2,2]<=[4]}\n+  call.0 = s32[8,2]{1,0} call(multiply), to_apply=g, sharding={devices=[2,2]<=[4]}\n+  add = s32[8,2]{1,0} add(input1, input1), sharding={devices=[4,1]<=[4]}\n+  copy.1 = s32[8,2]{1,0} copy(add), sharding={devices=[2,2]<=[4]}\n+  call.1 = s32[8,2]{1,0} call(copy.1), to_apply=g, sharding={devices=[2,2]<=[4]}\n+  ROOT root = s32[8,2]{1,0} add(call.0, call.1), sharding={devices=[2,2]<=[4]}\n+})\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          PartitionComputation(hlo_string, /*num_devices=*/4));\n+  VLOG(1) << module->ToString();\n+  HloInstruction* root = module->entry_computation()->root_instruction();\n+  EXPECT_THAT(root,\n+              AllOf(op::Add(op::Call(), op::Call()), op::Shape(\"s32[4,1]\")));\n+  const HloInstruction* call0 = root->operand(0);\n+  const HloInstruction* call1 = root->operand(1);\n+  EXPECT_EQ(call0->to_apply(), call1->to_apply());\n+  EXPECT_THAT(call0->operand(0),\n+              AllOf(op::Multiply(op::Parameter(0), op::Parameter(0)),\n+                    op::Shape(\"s32[4,1]\")));\n+  EXPECT_THAT(call1->operand(0),\n+              AllOf(op::Copy(op::Reshape()), op::Shape(\"s32[4,1]\")));\n+  const HloInstruction* call0_comp_root = call0->to_apply()->root_instruction();\n+  EXPECT_THAT(\n+      call0_comp_root,\n+      AllOf(op::Multiply(op::Parameter(0), op::Broadcast(op::Constant())),\n+            op::Shape(\"s32[4,1]\")));\n+  EXPECT_EQ(module->computation_count(), 2);\n }\n \n TEST_P(SpmdPartitioningTest, PartitionConditionalMismatchedBranches) {"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 87,
        "deletions": 0
    }
}