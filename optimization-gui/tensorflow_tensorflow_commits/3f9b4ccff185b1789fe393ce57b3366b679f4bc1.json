{
    "author": "ZixuanJiang",
    "message": "Refactor `ExpandDeviceGroupsWithIota`.\n\n1. Remove redundant check for `iota().has_value()` and unreachable code in GetIotaReplicaGroupList.\n2. Avoid inserting elements at the beginning of a std::vector.\n\nPiperOrigin-RevId: 840364623",
    "sha": "3f9b4ccff185b1789fe393ce57b3366b679f4bc1",
    "files": [
        {
            "sha": "d87ef705b8185c485b4e1adb1d83153df5243696",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner_util.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 19,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f9b4ccff185b1789fe393ce57b3366b679f4bc1/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f9b4ccff185b1789fe393ce57b3366b679f4bc1/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_util.cc?ref=3f9b4ccff185b1789fe393ce57b3366b679f4bc1",
            "patch": "@@ -510,32 +510,30 @@ std::optional<IotaReplicaGroupList> ExpandDeviceGroupsWithIota(\n   // partition group list.\n   // 2. Apply transpose to the split dimensions matching the partition group\n   // list transpose perm.\n-  std::vector<int64_t> reshape_dims =\n-      std::vector<int64_t>(partition_group_list.reshape_dims().begin(),\n-                           partition_group_list.reshape_dims().end());\n-  reshape_dims.insert(reshape_dims.begin(), device_groups.num_groups());\n-  std::vector<int> transpose_perm =\n-      std::vector<int>(partition_group_list.transpose_perm().begin(),\n-                       partition_group_list.transpose_perm().end());\n-  for (int64_t i = 0; i < transpose_perm.size(); ++i) {\n-    transpose_perm[i] += 1;\n-  }\n-  transpose_perm.insert(transpose_perm.begin(), 0);\n+  std::vector<int64_t> reshape_dims;\n+  reshape_dims.reserve(1 + partition_group_list.reshape_dims().size());\n+  reshape_dims.push_back(device_groups.num_groups());\n+  absl::c_copy(partition_group_list.reshape_dims(),\n+               std::back_inserter(reshape_dims));\n+\n+  std::vector<int> transpose_perm;\n+  transpose_perm.reserve(1 + partition_group_list.transpose_perm().size());\n+  transpose_perm.push_back(0);\n+  for (int dim : partition_group_list.transpose_perm()) {\n+    transpose_perm.push_back(dim + 1);\n+  }\n+\n   TileAssignment processed_device_groups =\n       device_groups.Reshape(reshape_dims).Transpose(transpose_perm);\n   // If after transpose we don't have an iota, then we can't expand the device\n   // groups with iota.\n   if (!processed_device_groups.iota().has_value()) {\n     return std::nullopt;\n   }\n-\n-  if (processed_device_groups.iota().has_value()) {\n-    return IotaReplicaGroupList(\n-        final_num_replica_groups, final_num_devices_per_group,\n-        processed_device_groups.iota()->reshape_dims(),\n-        processed_device_groups.iota()->transpose_perm());\n-  }\n-  return std::nullopt;\n+  return IotaReplicaGroupList(final_num_replica_groups,\n+                              final_num_devices_per_group,\n+                              processed_device_groups.iota()->reshape_dims(),\n+                              processed_device_groups.iota()->transpose_perm());\n }\n \n SPMDCollectiveOpsCreator GetPerGroupCollectiveOpsCreator("
        }
    ],
    "stats": {
        "total": 36,
        "additions": 17,
        "deletions": 19
    }
}