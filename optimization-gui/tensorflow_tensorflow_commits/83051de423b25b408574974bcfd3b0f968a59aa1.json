{
    "author": "jakeharmon8",
    "message": "Add option to tag PJRT wheels with nightly timestamp\n\nPiperOrigin-RevId: 825706994",
    "sha": "83051de423b25b408574974bcfd3b0f968a59aa1",
    "files": [
        {
            "sha": "02456f332d0472dfaa32fbb3092632520538fbf7",
            "filename": "third_party/xla/MODULE.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2FMODULE.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2FMODULE.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2FMODULE.bazel?ref=83051de423b25b408574974bcfd3b0f968a59aa1",
            "patch": "@@ -205,3 +205,6 @@ use_repo(rocm_configure, \"local_config_rocm\")\n \n tensorrt_configure = use_extension(\"//third_party/extensions:tensorrt_configure.bzl\", \"tensorrt_configure_ext\")\n use_repo(tensorrt_configure, \"local_config_tensorrt\")\n+\n+pjrt_nightly_timestamp = use_extension(\"//build_tools/pjrt_wheels:nightly.bzl\", \"nightly_timestamp_repo_bzlmod\")\n+use_repo(pjrt_nightly_timestamp, \"nightly_timestamp\")"
        },
        {
            "sha": "82aa675c8bb096eeac88e9af58a5983b5de783c3",
            "filename": "third_party/xla/WORKSPACE",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2FWORKSPACE",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2FWORKSPACE",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2FWORKSPACE?ref=83051de423b25b408574974bcfd3b0f968a59aa1",
            "patch": "@@ -152,3 +152,8 @@ load(\n nvshmem_redist_init_repository(\n     nvshmem_redistributions = NVSHMEM_REDISTRIBUTIONS,\n )\n+\n+# This is used for building nightly PJRT wheels.\n+load(\"//build_tools/pjrt_wheels:nightly.bzl\", \"nightly_timestamp_repo\")\n+\n+nightly_timestamp_repo(name = \"nightly_timestamp\")"
        },
        {
            "sha": "6f0e08fcb29b5b5c925def6006705d8f2dd5982f",
            "filename": "third_party/xla/build_tools/pjrt_wheels/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel?ref=83051de423b25b408574974bcfd3b0f968a59aa1",
            "patch": "@@ -1,10 +1,13 @@\n load(\"@cuda_cudart//:version.bzl\", cuda_major_version = \"VERSION\")\n+load(\"@nightly_timestamp//:timestamp.bzl\", \"XLA_NIGHTLY_TIMESTAMP\")\n load(\"@rules_python//python:packaging.bzl\", \"py_wheel\")\n \n # This ensures we can only build plugins for selected CUDA versions.\n cuda_label = \"cuda\" + cuda_major_version if cuda_major_version else \"null\"\n \n-wheel_version = \"0.0.0.dev0\"\n+# If we're building a nightly, append .devYYYYMMDD to the version\n+# If we're not, the timestamp is the empty string\n+wheel_version = \"0.0.0\" + XLA_NIGHTLY_TIMESTAMP\n \n wheel_platform = select({\n     \"//conditions:default\": \"manylinux_2_27_x86_64\","
        },
        {
            "sha": "f479196ac2f9d440deff9b55d546577b55932ce2",
            "filename": "third_party/xla/build_tools/pjrt_wheels/nightly.bzl",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Fnightly.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83051de423b25b408574974bcfd3b0f968a59aa1/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Fnightly.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Fnightly.bzl?ref=83051de423b25b408574974bcfd3b0f968a59aa1",
            "patch": "@@ -0,0 +1,35 @@\n+\"\"\"If we're building a nightly, we use this to pass a timestamp for the wheel version.\"\"\"\n+\n+def _nightly_timestamp_impl(rctx):\n+    timestamp_val = rctx.getenv(\"XLA_NIGHTLY_TIMESTAMP\", \"\")  # Default to \"\"\n+\n+    # Smuggle the value via a new .bzl file\n+    if timestamp_val:\n+        rctx.file(\n+            \"timestamp.bzl\",\n+            content = 'XLA_NIGHTLY_TIMESTAMP = \".dev{}\"'.format(timestamp_val),\n+        )\n+    else:\n+        rctx.file(\n+            \"timestamp.bzl\",\n+            content = 'XLA_NIGHTLY_TIMESTAMP = \"\"',\n+        )\n+\n+    # Create a BUILD file to make timestamp.bzl addressable\n+    rctx.file(\"BUILD.bazel\", content = \"\")\n+\n+nightly_timestamp_repo = repository_rule(\n+    implementation = _nightly_timestamp_impl,\n+    environ = [\"XLA_NIGHTLY_TIMESTAMP\"],\n+)\n+\n+# bzlmod implementation\n+def _nightly_timestamp_ext_impl(mctx):  # @unused\n+    nightly_timestamp_repo(\n+        name = \"nightly_timestamp\",\n+    )\n+\n+nightly_timestamp_repo_bzlmod = module_extension(\n+    implementation = _nightly_timestamp_ext_impl,\n+    environ = [\"XLA_NIGHTLY_TIMESTAMP\"],\n+)"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 47,
        "deletions": 1
    }
}