{
    "author": "mrguenther",
    "message": "Enable Stablehlo -> HLO lowering by default.\n\nNote that, in order to maintain parity with MHLO optimizations, this enables the `assume-no-undeclared-side-effects` option. This matches the default behavior for MHLO, but StableHLO is more cautious by default. Empirically, past evidence suggests it's pretty safe given that MHLO has been doing it all this time. Disabling the flag can result in significantly larger HLO after lowering, so we enable it here.\n\nPiperOrigin-RevId: 823234079",
    "sha": "1b838a947b50f3a6031ad040f2edd1d97a4f7863",
    "files": [
        {
            "sha": "ae2dcfb2e44c358616a5e43251840f393c7442ca",
            "filename": "third_party/xla/xla/hlo/translate/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b838a947b50f3a6031ad040f2edd1d97a4f7863/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b838a947b50f3a6031ad040f2edd1d97a4f7863/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2FBUILD?ref=1b838a947b50f3a6031ad040f2edd1d97a4f7863",
            "patch": "@@ -131,5 +131,6 @@ cc_library(\n         \"@llvm-project//mlir:Transforms\",\n         \"@llvm-project//mlir:UBDialect\",\n         \"@stablehlo//:stablehlo_passes\",\n+        \"@stablehlo//:stablehlo_passes_optimization\",\n     ],\n )"
        },
        {
            "sha": "3479fe34329acbc836be3c3f5c433dd37970e726",
            "filename": "third_party/xla/xla/hlo/translate/stablehlo.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b838a947b50f3a6031ad040f2edd1d97a4f7863/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fstablehlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b838a947b50f3a6031ad040f2edd1d97a4f7863/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fstablehlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fstablehlo.cc?ref=1b838a947b50f3a6031ad040f2edd1d97a4f7863",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"mlir/Pass/PassManager.h\"\n #include \"mlir/Transforms/Passes.h\"\n #include \"stablehlo/transforms/Passes.h\"\n+#include \"stablehlo/transforms/optimization/Passes.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/translate/hlo_to_mhlo/hlo_module_importer.h\"\n #include \"xla/hlo/translate/mhlo_to_hlo/mlir_hlo_to_hlo.h\"\n@@ -73,9 +74,11 @@ absl::Status StablehloToMhlo(mlir::ModuleOp module, bool run_canonicalizer) {\n       mlir::mhlo::createChloLegalizeToHighLevelMhloPass());\n   pm.addNestedPass<mlir::func::FuncOp>(\n       mlir::stablehlo::createChloLegalizeToStablehloPass());\n-  pm.addPass(mlir::mhlo::createStablehloLegalizeToHloPass());\n   if (run_canonicalizer) {\n-    pm.addNestedPass<mlir::func::FuncOp>(mlir::createCanonicalizerPass());\n+    pm.addNestedPass<mlir::func::FuncOp>(\n+        mlir::stablehlo::createStablehloTargetIndependentOptimizationPass({\n+            /*assumeNoUndeclaredSideEffects=*/true,\n+        }));\n     pm.addPass(mlir::stablehlo_ext::\n                    createStablehloSanitizeDiscardableAttributesPass());\n   }\n@@ -108,6 +111,7 @@ absl::Status ConvertStablehloToHloProtoInternal(mlir::ModuleOp module,\n   mlir::MlirToHloConversionOptions options;\n   options.return_tuple = return_tuple;\n   options.use_tuple_args = use_tuple_args;\n+  options.direct_stablehlo_to_hlo = true;\n   TF_RETURN_IF_ERROR(mlir::ConvertMlirHloToHlo(module, hlo_proto, options));\n   return absl::OkStatus();\n }"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 7,
        "deletions": 2
    }
}