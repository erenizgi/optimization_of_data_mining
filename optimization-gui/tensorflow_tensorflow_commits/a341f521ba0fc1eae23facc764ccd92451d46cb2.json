{
    "author": "nvgrw",
    "message": "Port cholesky_test to HloTestBase.\n\nPiperOrigin-RevId: 840348607",
    "sha": "a341f521ba0fc1eae23facc764ccd92451d46cb2",
    "files": [
        {
            "sha": "eaa5a8d125df3831d904caa1fea4f5140b9a3c01",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a341f521ba0fc1eae23facc764ccd92451d46cb2/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a341f521ba0fc1eae23facc764ccd92451d46cb2/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=a341f521ba0fc1eae23facc764ccd92451d46cb2",
            "patch": "@@ -3898,17 +3898,21 @@ xla_test(\n         \"optonly\",\n     ],\n     deps = [\n-        \":client_library_test_base\",\n+        \":client_library_test_runner_mixin\",\n+        \":hlo_test_base\",\n         \":literal_test_util\",\n         \":xla_internal_test_main\",\n         \"//xla:array2d\",\n-        \"//xla:literal\",\n-        \"//xla:types\",\n+        \"//xla:array3d\",\n+        \"//xla:error_spec\",\n+        \"//xla:literal_util\",\n+        \"//xla:shape_util\",\n         \"//xla/hlo/builder:xla_builder\",\n         \"//xla/hlo/builder/lib:arithmetic\",\n         \"//xla/hlo/builder/lib:matrix\",\n         \"//xla/hlo/testlib:test\",\n-        \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/platform:test\",\n         \"@com_google_absl//absl/status:statusor\",\n     ],\n )"
        },
        {
            "sha": "0d0fbbc5dd630a257f27dc91f2c67666f82f5873",
            "filename": "third_party/xla/xla/tests/cholesky_test.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 25,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a341f521ba0fc1eae23facc764ccd92451d46cb2/third_party%2Fxla%2Fxla%2Ftests%2Fcholesky_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a341f521ba0fc1eae23facc764ccd92451d46cb2/third_party%2Fxla%2Fxla%2Ftests%2Fcholesky_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcholesky_test.cc?ref=a341f521ba0fc1eae23facc764ccd92451d46cb2",
            "patch": "@@ -13,27 +13,30 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include <cstdint>\n #include <limits>\n-#include <memory>\n-#include <numeric>\n+#include <tuple>\n #include <vector>\n \n-#include \"absl/status/statusor.h\"\n #include \"xla/array2d.h\"\n+#include \"xla/array3d.h\"\n+#include \"xla/error_spec.h\"\n #include \"xla/hlo/builder/lib/arithmetic.h\"\n #include \"xla/hlo/builder/lib/matrix.h\"\n #include \"xla/hlo/builder/xla_builder.h\"\n #include \"xla/hlo/testlib/test.h\"\n-#include \"xla/literal.h\"\n-#include \"xla/tests/client_library_test_base.h\"\n-#include \"xla/tests/literal_test_util.h\"\n-#include \"xla/tsl/lib/core/status_test_util.h\"\n-#include \"xla/types.h\"\n+#include \"xla/literal_util.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n+#include \"xla/tests/client_library_test_runner_mixin.h\"\n+#include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/platform/test.h\"\n \n namespace xla {\n namespace {\n \n-using CholeskyTest = ClientLibraryTestBase;\n+using CholeskyTest = ClientLibraryTestRunnerMixin<HloTestBase>;\n \n TEST_F(CholeskyTest, NonPSDInput) {\n   XlaBuilder builder(TestName());\n@@ -55,7 +58,7 @@ TEST_F(CholeskyTest, NonPSDInput) {\n       {nan, nan, nan},\n   });\n \n-  ComputeAndCompareR2<float>(&builder, expected, {a_data.get()},\n+  ComputeAndCompareR2<float>(&builder, expected, {&a_data},\n                              ErrorSpec(1e-4, 1e-4));\n }\n \n@@ -93,7 +96,7 @@ TEST_F(CholeskyTest, NonPSDBatched) {\n       },\n   });\n \n-  ComputeAndCompareR3<float>(&builder, expected, {a_data.get()},\n+  ComputeAndCompareR3<float>(&builder, expected, {&a_data},\n                              ErrorSpec(1e-4, 1e-4));\n }\n \n@@ -119,7 +122,7 @@ TEST_F(CholeskyTest, Lower) {\n       {5, 8, 10, 11},\n   });\n \n-  ComputeAndCompareR2<float>(&builder, expected, {a_data.get()},\n+  ComputeAndCompareR2<float>(&builder, expected, {&a_data},\n                              ErrorSpec(1e-4, 1e-4));\n }\n \n@@ -145,7 +148,7 @@ TEST_F(CholeskyTest, Upper) {\n       {0, 0, 0, 11},\n   });\n \n-  ComputeAndCompareR2<float>(&builder, expected, {a_data.get()},\n+  ComputeAndCompareR2<float>(&builder, expected, {&a_data},\n                              ErrorSpec(1e-4, 1e-4));\n }\n \n@@ -168,7 +171,7 @@ TEST_F(CholeskyTest, Simple2) {\n                            {2, 14, 16, 0},  //\n                            {3, 6, 1, 4}});\n \n-  ComputeAndCompareR2<float>(&builder, expected, {a_data.get()},\n+  ComputeAndCompareR2<float>(&builder, expected, {&a_data},\n                              ErrorSpec(1e-4, 1e-4));\n }\n \n@@ -207,14 +210,14 @@ TEST_F(CholeskyTest, SimpleBatched) {\n        {3, 6, 1, 4}},\n   });\n \n-  ComputeAndCompareR3<float>(&builder, expected, {a_data.get()},\n+  ComputeAndCompareR3<float>(&builder, expected, {&a_data},\n                              ErrorSpec(1e-4, 1e-4));\n }\n \n using CholeskyTestCase = std::tuple<int64_t, int64_t, bool>;\n \n class RandomCholeskyTest\n-    : public ClientLibraryTestBase,\n+    : public ClientLibraryTestRunnerMixin<HloTestBase>,\n       public ::testing::WithParamInterface<CholeskyTestCase> {};\n \n TEST_P(RandomCholeskyTest, Real) {\n@@ -249,9 +252,7 @@ TEST_P(RandomCholeskyTest, Real) {\n   Reduce(delta * delta, ConstantR0<float>(&builder, 0.0),\n          CreateScalarAddComputation(F32, &builder), {0, 1, 2});\n \n-  TF_ASSERT_OK_AND_ASSIGN(auto input_data, client_->TransferToServer(literal));\n-  ComputeAndCompareR0<float>(&builder, 0.0, {input_data.get()},\n-                             ErrorSpec(1e-4, 1e-4));\n+  ComputeAndCompareR0<float>(&builder, 0.0, {&literal}, ErrorSpec(1e-4, 1e-4));\n }\n \n TEST_P(RandomCholeskyTest, Complex) {\n@@ -292,12 +293,7 @@ TEST_P(RandomCholeskyTest, Complex) {\n   Reduce(Abs(delta * Conj(delta)), ConstantR0<float>(&builder, 0.0),\n          CreateScalarAddComputation(F32, &builder), {0, 1, 2});\n \n-  TF_ASSERT_OK_AND_ASSIGN(auto input_data_real,\n-                          client_->TransferToServer(literal_real));\n-  TF_ASSERT_OK_AND_ASSIGN(auto input_data_imag,\n-                          client_->TransferToServer(literal_imag));\n-  ComputeAndCompareR0<float>(&builder, 0.0,\n-                             {input_data_real.get(), input_data_imag.get()},\n+  ComputeAndCompareR0<float>(&builder, 0.0, {&literal_real, &literal_imag},\n                              ErrorSpec(1e-4, 1e-4));\n }\n "
        }
    ],
    "stats": {
        "total": 58,
        "additions": 29,
        "deletions": 29
    }
}