{
    "author": "akuegel",
    "message": "[XLA:GPU] Add another reproducer for a ScatterDeterminismExpander bug.\n\nThis is a case with unique scatter indices. Still, the expander seems to write\ntwice to the same indices.\n\nPiperOrigin-RevId: 811303016",
    "sha": "9a57f673d42be0331785edafce12b94e51f5118d",
    "files": [
        {
            "sha": "50d243db53d3d2cb5e40a3f3790ddcefe1626878",
            "filename": "third_party/xla/xla/tests/scatter_test.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a57f673d42be0331785edafce12b94e51f5118d/third_party%2Fxla%2Fxla%2Ftests%2Fscatter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a57f673d42be0331785edafce12b94e51f5118d/third_party%2Fxla%2Fxla%2Ftests%2Fscatter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fscatter_test.cc?ref=9a57f673d42be0331785edafce12b94e51f5118d",
            "patch": "@@ -1049,6 +1049,43 @@ ENTRY main {\n   RunTest(hlo_text, &operand, &scatter_indices, &updates);\n }\n \n+TEST_F(ScatterTest, Scatter_Add_F32) {\n+  if (GetDebugOptionsForTest().xla_gpu_enable_scatter_determinism_expander() &&\n+      GetDebugOptionsForTest().xla_gpu_deterministic_ops()) {\n+    // TODO(b/443204632): Re-enable this test.\n+    GTEST_SKIP() << \"Currently fails\";\n+  }\n+  const std::string hlo_text = R\"(\n+HloModule scatter_add\n+\n+region_0.1 {\n+  scatter-add.2 = f32[] parameter(0)\n+  scatter-add.3 = f32[] parameter(1)\n+  ROOT add.2 = f32[] add(scatter-add.2, scatter-add.3)\n+}\n+\n+ENTRY main.2 {\n+  constant.4 = f32[] constant(0)\n+  broadcast.4 = f32[2,2,4]{2,1,0} broadcast(constant.4), dimensions={}\n+  channel_idxs.1 = s32[2,2]{1,0} constant({{0,3}, {1,2}})\n+  constant.5 = s32[] constant(0)\n+  broadcast.5 = s32[2,2]{1,0} broadcast(constant.5), dimensions={}\n+  lt.1 = pred[2,2]{1,0} compare(channel_idxs.1, broadcast.5), direction=LT\n+  constant.3 = s32[] constant(4)\n+  broadcast.3 = s32[2,2]{1,0} broadcast(constant.3), dimensions={}\n+  add.3 = s32[2,2]{1,0} add(channel_idxs.1, broadcast.3)\n+  select_n.1 = s32[2,2]{1,0} select(lt.1, add.3, channel_idxs.1)\n+  broadcast_in_dim.1 = s32[2,2,1]{2,1,0} reshape(select_n.1)\n+  arr.1 = f32[2,2,2]{2,1,0} parameter(0)\n+  ROOT scatter-add.5 = f32[2,2,4]{2,1,0} scatter(broadcast.4, broadcast_in_dim.1, arr.1), update_window_dims={1}, inserted_window_dims={2}, scatter_dims_to_operand_dims={2}, input_batching_dims={0}, scatter_indices_batching_dims={0}, index_vector_dim=2, to_apply=region_0.1\n+}\n+)\";\n+  Literal updates = LiteralUtil::CreateR3<float>(\n+      {{{1.0, 1.1}, {2.0, 2.1}}, {{3.0, 3.1}, {4.0, 4.1}}});\n+\n+  RunTest(hlo_text, {&updates});\n+}\n+\n // Test min/max/add scatters with edge-case values.\n class ScatterEdgeCaseTestP\n     : public ScatterTest,"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 37,
        "deletions": 0
    }
}