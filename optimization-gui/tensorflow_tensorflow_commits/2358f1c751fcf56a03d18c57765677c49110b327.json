{
    "author": "vwbaker",
    "message": "[xla:gpu] Fix: Assign result of EmitConstant in EmitScope.\n\nPreviously, `EmitConstant` in `EmitScope` would return immediately, preventing subsequent instructions from being processed, leading to completing leaving out ops that should be emitted.\n\nPiperOrigin-RevId: 813769637",
    "sha": "2358f1c751fcf56a03d18c57765677c49110b327",
    "files": [
        {
            "sha": "6ada7b63e2c1a41bcc2235f651510c61466d9b7d",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2358f1c751fcf56a03d18c57765677c49110b327/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2358f1c751fcf56a03d18c57765677c49110b327/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter.cc?ref=2358f1c751fcf56a03d18c57765677c49110b327",
            "patch": "@@ -1617,7 +1617,7 @@ absl::StatusOr<ScalarOrTensor> EmitScope(\n       TF_RET_CHECK(values.contains(hlo)) << hlo->ToString();\n       continue;\n     } else if (hlo->opcode() == HloOpcode::kConstant) {\n-      return EmitConstant(b, *hlo);\n+      TF_ASSIGN_OR_RETURN(result, EmitConstant(b, *hlo));\n     } else if (hlo->opcode() == HloOpcode::kBroadcast) {\n       return absl::InvalidArgumentError(\n           \"Broadcast is not yet supported in EmitScope().\");"
        },
        {
            "sha": "1cbaa2344dea1d653bf7934b50cea2896584f243",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter_device_test.cc",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2358f1c751fcf56a03d18c57765677c49110b327/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2358f1c751fcf56a03d18c57765677c49110b327/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc?ref=2358f1c751fcf56a03d18c57765677c49110b327",
            "patch": "@@ -295,6 +295,46 @@ CHECK:  \"tt.reduce\"(%[[LOAD:.*]]) <{axis = 1 : i32}>\n   EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n }\n \n+// Regression test for b/448150702 - reduction with a constant inside returned\n+// early, not fully emitting the reduction.\n+TEST_F(TritonEmitterTest, ComplexReductionIsEmittedCorrectly) {\n+  constexpr absl::string_view kHloText = R\"(\n+HloModule m\n+\n+unusual {\n+  lhs = f32[] parameter(0)\n+  rhs = f32[] parameter(1)\n+  add = f32[] add(lhs, rhs)\n+  eight = f32[] constant(8)\n+  ROOT minimum = f32[] minimum(add, eight)\n+}\n+\n+fused_reduce {\n+  p0 = f32[2,2]{1,0} parameter(0)\n+  zero = f32[] constant(0)\n+  ROOT reduce = f32[2]{0} reduce(p0, zero), dimensions={1}, to_apply=unusual\n+}\n+\n+ENTRY entry_computation {\n+  p0 = f32[2,2]{1,0} parameter(0)\n+  ROOT input_reduce_fusion = f32[2]{0} fusion(p0),\n+    kind=kCustom, calls=fused_reduce,\n+    backend_config={\"fusion_backend_config\":{\"kind\":\"__triton\",\n+      \"block_level_fusion_config\":{\n+        \"num_warps\":\"1\",\"output_tiles\":[{\"sizes\":[\"1\"]}],\n+        \"num_ctas\":1,\"num_stages\":1,\"is_tma_allowed\":false}}}\n+}\n+)\";\n+  TF_EXPECT_OK(CreateTritonIrAndFileCheck(this, kHloText, \"fused_reduce\", R\"(\n+CHECK: \"tt.reduce\"\n+CHECK: ^bb0(%[[ARG0:.*]]: f32, %[[ARG1:.*]]: f32)\n+CHECK: %[[ADD:.*]] = arith.addf %[[ARG0]], %[[ARG1]]\n+CHECK: %[[MIN:.*]] = arith.minimumf %[[ADD]]\n+CHECK: tt.reduce.return %[[MIN]]\n+)\"));\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n+}\n+\n TEST_F(TritonEmitterTest,\n        ReductionOnMinormostAxisWithExtraOutputIsEmittedCorrectly) {\n   constexpr absl::string_view kHloText = R\"("
        }
    ],
    "stats": {
        "total": 42,
        "additions": 41,
        "deletions": 1
    }
}