{
    "author": "ezhulenev",
    "message": "[xla:cpu] Cleanup KernelSpec to use absl::string_view and absl::Span\n\nPiperOrigin-RevId: 825075908",
    "sha": "d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
    "files": [
        {
            "sha": "e43a0663e26e70105a43b382be34c6f44534c485",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -136,9 +136,9 @@ cc_library(\n     deps = [\n         \":kernel_c_api\",\n         \"//xla/tsl/lib/gtl:int_type\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n-        \"@local_tsl//tsl/platform:statusor\",\n     ],\n )\n "
        },
        {
            "sha": "3b2699642389be6762bb8a0adfa857ee528f2dd1",
            "filename": "third_party/xla/xla/backends/cpu/runtime/function_library.h",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ffunction_library.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ffunction_library.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ffunction_library.h?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -19,13 +19,12 @@ limitations under the License.\n #include <cstdint>\n #include <string>\n #include <type_traits>\n-#include <utility>\n \n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/backends/cpu/runtime/kernel_c_api.h\"\n #include \"xla/tsl/lib/gtl/int_type.h\"\n-#include \"tsl/platform/statusor.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n namespace xla::cpu {\n \n@@ -64,14 +63,14 @@ class FunctionLibrary {\n   };\n \n   template <typename F, std::enable_if_t<std::is_function_v<F>>* = nullptr>\n-  static Symbol Sym(std::string name) {\n-    return Symbol{GetTypeId<F>(), std::move(name)};\n+  static Symbol Sym(absl::string_view name) {\n+    return Symbol{GetTypeId<F>(), std::string(name)};\n   }\n \n   template <typename F, std::enable_if_t<std::is_function_v<F>>* = nullptr>\n   absl::StatusOr<F*> ResolveFunction(absl::string_view name) {\n     TF_ASSIGN_OR_RETURN(void* ptr, ResolveFunction(GetTypeId<F>(), name));\n-    return reinterpret_cast<F*>(ptr);\n+    return reinterpret_cast<F*>(ptr);  // NOLINT\n   }\n \n  protected:"
        },
        {
            "sha": "90fd1b74c3c6bd1fe576c736edc42ded5e1338b9",
            "filename": "third_party/xla/xla/backends/cpu/runtime/kernel_thunk.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fkernel_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fkernel_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fkernel_thunk.cc?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -35,6 +35,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_format.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/backends/cpu/runtime/buffer_allocations.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n@@ -46,7 +47,6 @@ limitations under the License.\n #include \"xla/runtime/work_group.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/stream_executor/device_memory.h\"\n-#include \"xla/stream_executor/launch_dim.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -64,7 +64,9 @@ namespace internal {\n static absl::Status CheckBufferAlignment(\n     const Thunk::Info& info, uint64_t min_alignment,\n     absl::Span<const XLA_CPU_KernelArg> kernel_args) {\n-  if (min_alignment == 0) return absl::OkStatus();\n+  if (min_alignment == 0) {\n+    return absl::OkStatus();\n+  }\n \n   for (int64_t i = 0; i < kernel_args.size(); ++i) {\n     auto ptr = reinterpret_cast<uintptr_t>(kernel_args[i].data);\n@@ -114,8 +116,9 @@ template <int64_t num_arguments, int64_t num_results>\n KernelThunk<num_arguments, num_results>::KernelThunk(\n     Info info, absl::Span<const BufferAllocation::Slice> arguments_buffers,\n     absl::Span<const BufferAllocation::Slice> results_buffers,\n-    absl::flat_hash_set<int64_t> invariant_arguments, std::string kernel_name,\n-    NumWorkGroups num_workgroups, std::optional<uint64_t> min_alignment)\n+    absl::flat_hash_set<int64_t> invariant_arguments,\n+    absl::string_view kernel_name, NumWorkGroups num_workgroups,\n+    std::optional<uint64_t> min_alignment)\n     : KernelThunkBase(Kind::kKernel, std::move(info)),\n       invariant_arguments_(std::move(invariant_arguments)),\n       num_kernel_args_(arguments_buffers.size() + results_buffers.size()),\n@@ -312,7 +315,7 @@ absl::StatusOr<std::unique_ptr<Thunk>> KernelThunk::Create(\n     Thunk::Info info,\n     absl::Span<const BufferAllocation::Slice> arguments_buffers,\n     absl::Span<const BufferAllocation::Slice> results_buffers,\n-    std::string kernel_name, NumWorkGroups num_workgroups,\n+    absl::string_view kernel_name, NumWorkGroups num_workgroups,\n     absl::flat_hash_set<int64_t> invariant_arguments,\n     std::optional<uint64_t> min_alignment) {\n   if (min_alignment.has_value() && !absl::has_single_bit(*min_alignment)) {\n@@ -324,8 +327,8 @@ absl::StatusOr<std::unique_ptr<Thunk>> KernelThunk::Create(\n     return absl::WrapUnique(\n         new SmallKernelThunk<num_arguments(), num_results()>(\n             std::move(info), arguments_buffers, results_buffers,\n-            std::move(invariant_arguments), std::move(kernel_name),\n-            num_workgroups, min_alignment));\n+            std::move(invariant_arguments), kernel_name, num_workgroups,\n+            min_alignment));\n   };\n \n   static constexpr auto _0 = std::integral_constant<size_t, 0>{};"
        },
        {
            "sha": "1a4500bbbfa4c1a52933e637c714a306098922df",
            "filename": "third_party/xla/xla/backends/cpu/runtime/kernel_thunk.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fkernel_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fkernel_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fkernel_thunk.h?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -137,7 +137,7 @@ class KernelThunk : public KernelThunkBase {\n               absl::Span<const BufferAllocation::Slice> arguments_buffers,\n               absl::Span<const BufferAllocation::Slice> results_buffers,\n               absl::flat_hash_set<int64_t> invariant_arguments,\n-              std::string kernel_name, NumWorkGroups num_workgroups,\n+              absl::string_view kernel_name, NumWorkGroups num_workgroups,\n               std::optional<uint64_t> min_alignment);\n \n   absl::Status CheckInvariantBuffersMemory(const KernelArgs& kernel_args) const;\n@@ -196,7 +196,7 @@ class KernelThunk final : public internal::KernelThunk<> {\n       Thunk::Info info,\n       absl::Span<const BufferAllocation::Slice> arguments_buffers,\n       absl::Span<const BufferAllocation::Slice> results_buffers,\n-      std::string kernel_name, NumWorkGroups num_workgroups,\n+      absl::string_view kernel_name, NumWorkGroups num_workgroups,\n       absl::flat_hash_set<int64_t> invariant_arguments,\n       std::optional<uint64_t> min_alignment = std::nullopt);\n "
        },
        {
            "sha": "4f36d7614c0a5e6c89f8f7e4ee26263a62800d30",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -62,7 +62,7 @@ absl::StatusOr<KernelRunner> KernelRunner::Create(\n \n   TF_RETURN_IF_ERROR(compiler.AddModule(std::move(thread_safe_module)));\n \n-  const std::string& kernel_name = spec.name();\n+  absl::string_view kernel_name = spec.name();\n   TF_ASSIGN_OR_RETURN(std::unique_ptr<FunctionLibrary> library,\n                       std::move(compiler).Compile(\n                           {FunctionLibrary::Sym<XLA_CPU_Kernel>(kernel_name)}));"
        },
        {
            "sha": "23e72d553edf8dbf239e93ef431f028f1f48d868",
            "filename": "third_party/xla/xla/codegen/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -81,6 +81,7 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_absl//absl/types:span\",\n     ],\n )\n "
        },
        {
            "sha": "5ca578767aacf0656121a3b5ef61b176d6cf95a1",
            "filename": "third_party/xla/xla/codegen/kernel_spec.h",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_spec.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_spec.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_spec.h?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/runtime/work_cluster.h\"\n #include \"xla/runtime/work_dimensions.h\"\n #include \"xla/runtime/work_group.h\"\n@@ -50,9 +51,9 @@ class KernelSpec {\n              absl::flat_hash_set<int64_t> invariant_arguments,\n              std::optional<size_t> scratch_bytes = std::nullopt);\n \n-  // Get the backend specific name of the kernel.\n-  // This may be used to identify the kernel in the backend specific runtime.\n-  const std::string& name() const { return name_; }\n+  // Get the backend specific name of the kernel. This may be used to identify\n+  // the kernel in the backend specific runtime.\n+  absl::string_view name() const { return name_; }\n \n   // Kernel work dimensions define how the kernel execution must be\n   // parallelized. The meaning of these dimensions is backend specific, i.e.\n@@ -66,12 +67,15 @@ class KernelSpec {\n   // on the exact meaning of these dimensions and how they are mapped to the\n   // underlying hardware, and how to use them for perfrormance optimization.\n   WorkDimensions work_dimensions() const { return work_dimensions_; }\n+\n   NumWorkClusters num_workclusters() const {\n     return work_dimensions_.num_work_clusters;\n   }\n+\n   NumWorkGroups num_workgroups() const {\n     return work_dimensions_.num_work_groups;\n   }\n+\n   NumWorkItems num_workitems() const { return work_dimensions_.num_work_items; }\n \n   // Requested amount of scratch bytes for the kernel (backed by backend\n@@ -80,9 +84,14 @@ class KernelSpec {\n   std::optional<size_t> scratch_bytes() const { return scratch_bytes_; }\n \n   // Argument buffers read by the kernel.\n-  const Buffers& argument_buffers() const { return argument_buffers_; }\n+  absl::Span<const BufferAllocation::Slice> argument_buffers() const {\n+    return argument_buffers_;\n+  }\n+\n   // Result buffers written to by the kernel.\n-  const Buffers& result_buffers() const { return result_buffers_; }\n+  absl::Span<const BufferAllocation::Slice> result_buffers() const {\n+    return result_buffers_;\n+  }\n \n   // Returns a set of invariant arguments (corresponding to the indices in the\n   // argument buffers list)."
        },
        {
            "sha": "bd4e88fae6fdfa39ce5bdc8e707822f545c25482",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d75ad2c4ff02b8a74098d01d61ebd123d99d8b02/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.h?ref=d75ad2c4ff02b8a74098d01d61ebd123d99d8b02",
            "patch": "@@ -20,11 +20,13 @@ limitations under the License.\n #include <memory>\n #include <optional>\n #include <string>\n+#include <utility>\n #include <vector>\n \n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ExecutionEngine/Orc/ThreadSafeModule.h\"\n #include \"mlir/IR/MLIRContext.h\"\n@@ -69,6 +71,9 @@ class ThunkEmitter {\n   };\n \n   struct EmittedKernel {\n+    EmittedKernel(absl::string_view name, llvm::orc::ThreadSafeModule module)\n+        : kernel_name(name), module(std::move(module)) {}\n+\n     std::string kernel_name;\n     llvm::orc::ThreadSafeModule module;\n   };"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 38,
        "deletions": 21
    }
}