{
    "author": "tensorflower-gardener",
    "message": "Slightly optimize CheckBatchSizeForAllValues and improve error message\n\nCaches the values() vector and prints out the shapes of all offending values, so that it's easier to find the corresponding nodes in graphs.\n\nPiperOrigin-RevId: 807285120",
    "sha": "e06bd897c1f6d4242d8cda8b2c7df5f185a7ce84",
    "files": [
        {
            "sha": "e7231909df791b4cb8e9da15e65e1195149db977",
            "filename": "tensorflow/lite/delegates/gpu/common/model.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 7,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e06bd897c1f6d4242d8cda8b2c7df5f185a7ce84/tensorflow%2Flite%2Fdelegates%2Fgpu%2Fcommon%2Fmodel.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e06bd897c1f6d4242d8cda8b2c7df5f185a7ce84/tensorflow%2Flite%2Fdelegates%2Fgpu%2Fcommon%2Fmodel.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fgpu%2Fcommon%2Fmodel.cc?ref=e06bd897c1f6d4242d8cda8b2c7df5f185a7ce84",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <algorithm>\n #include <map>\n #include <memory>\n+#include <string>\n #include <utility>\n #include <vector>\n \n@@ -530,16 +531,26 @@ absl::Status ConnectTwoNodes(GraphFloat32* graph, const Node* from_node,\n }\n \n absl::Status CheckBatchSizeForAllValues(const GraphFloat32& model) {\n-  if (model.values().empty()) return absl::OkStatus();\n-  const int32_t b = model.values()[0]->tensor.shape.b;\n-  for (auto value : model.values()) {\n+  std::vector<Value*> values = model.values();\n+  if (values.empty()) return absl::OkStatus();\n+  std::vector<Value*> offending_values;\n+  const int32_t b = values[0]->tensor.shape.b;\n+  for (auto value : values) {\n     if (value->tensor.shape.b != b) {\n-      return absl::InvalidArgumentError(\n-          absl::StrCat(\"Batch size mismatch, expected \", b, \" but got \",\n-                       value->tensor.shape.b));\n+      offending_values.push_back(value);\n     }\n   }\n-  return absl::OkStatus();\n+  if (offending_values.empty()) return absl::OkStatus();\n+\n+  std::string error_message = absl::StrCat(\n+      \"Batch size mismatch, expected \", b, \" but got \", offending_values.size(),\n+      \" values with divergent batch sizes: \");\n+  for (const Value* value : offending_values) {\n+    absl::StrAppend(&error_message, \"\\n  id:\", value->id, \" shape:[\",\n+                    value->tensor.shape.b, \", \", value->tensor.shape.h, \", \",\n+                    value->tensor.shape.w, \", \", value->tensor.shape.c, \"]\");\n+  }\n+  return absl::InvalidArgumentError(error_message);\n }\n \n }  // namespace gpu"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 18,
        "deletions": 7
    }
}