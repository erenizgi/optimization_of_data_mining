{
    "author": "subhankarshah",
    "message": "[XLA:MSA] Skip prefetching input/output aliased parameters when block prefetching.\n\nPiperOrigin-RevId: 802868473",
    "sha": "70ec97b2e67e52c2c9e14f90d0e678464dbe80a2",
    "files": [
        {
            "sha": "cfe9c434175aa2c3b7785f3d03a749ec6df36ac7",
            "filename": "third_party/xla/xla/service/memory_space_assignment/algorithm.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/70ec97b2e67e52c2c9e14f90d0e678464dbe80a2/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/70ec97b2e67e52c2c9e14f90d0e678464dbe80a2/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc?ref=70ec97b2e67e52c2c9e14f90d0e678464dbe80a2",
            "patch": "@@ -55,6 +55,7 @@ limitations under the License.\n #include \"xla/hlo/analysis/hlo_dataflow_analysis.h\"\n #include \"xla/hlo/analysis/hlo_operand_index.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n+#include \"xla/hlo/ir/hlo_input_output_alias_config.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/ir/hlo_schedule.h\"\n@@ -2064,17 +2065,46 @@ std::optional<int64_t> MsaAlgorithm::EarliestBlockPrefetchStartTime(\n   return std::nullopt;\n }\n \n+namespace {\n+\n+absl::flat_hash_set<HloPosition> GetParameterInstructionsAliasedToOutput(\n+    const HloInputOutputAliasConfig& alias_config,\n+    const HloInstruction* root_instruction) {\n+  absl::flat_hash_set<HloPosition> aliased_parameter_positions;\n+  alias_config.ForEachAlias([&](const ShapeIndex& output_index,\n+                                const HloInputOutputAliasConfig::Alias& alias) {\n+    HloInstruction* parameter_instruction =\n+        root_instruction->parent()->parameter_instruction(\n+            alias.parameter_number);\n+    aliased_parameter_positions.insert(\n+        {parameter_instruction, alias.parameter_index});\n+  });\n+  return aliased_parameter_positions;\n+}\n+\n+}  // namespace\n+\n void MsaAlgorithm::ProcessBlockPrefetches() {\n   if (options_.reserved_bytes_for_block_prefetches == 0) {\n     return;\n   }\n+  absl::flat_hash_set<HloPosition> aliased_parameter_positions =\n+      GetParameterInstructionsAliasedToOutput(\n+          module_->input_output_alias_config(),\n+          module_->entry_computation()->root_instruction());\n+\n   // List of all block prefetched values. If a block prefetched value is sliced,\n   // we also add the sliced value to block_prefetched_values. We will try\n   // to perform an async slice to prefetch for the slice's uses.\n   std::vector<const HloValue*> block_prefetched_values;\n   absl::flat_hash_map<const HloValue*, const HloValue*>\n       sliced_value_to_original_value;\n   for (const HloPosition& position : options_.block_prefetched_positions) {\n+    if (aliased_parameter_positions.contains(position)) {\n+      // TODO(b/441344194): Add support for block allocations for parameters\n+      // that are aliased to outputs.\n+      continue;\n+    }\n     const HloValue* value =\n         &alias_analysis_.dataflow_analysis().GetUniqueValueAt(\n             position.instruction, position.index);"
        },
        {
            "sha": "8c49cd35c22e513c8ee097c5d005271e24ad97a7",
            "filename": "third_party/xla/xla/service/memory_space_assignment/memory_space_assignment_test.cc",
            "status": "modified",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/70ec97b2e67e52c2c9e14f90d0e678464dbe80a2/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/70ec97b2e67e52c2c9e14f90d0e678464dbe80a2/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc?ref=70ec97b2e67e52c2c9e14f90d0e678464dbe80a2",
            "patch": "@@ -14749,6 +14749,83 @@ ENTRY entry {\n             kAlternateMemorySpace);\n }\n \n+TEST_F(MemorySpaceAssignmentTest,\n+       TestBlockPrefetchingWithInputOutputAliasConfig) {\n+  absl::string_view hlo_string = R\"(\n+HloModule module, is_scheduled=true\n+\n+ENTRY entry {\n+  p0 = f32[2,3]{1,0} parameter(0)\n+  p1 = f32[2,3]{1,0} parameter(1)\n+  p2 = f32[2,3]{1,0} parameter(2)\n+  p3 = f32[2,3]{1,0} parameter(3)\n+  p4 = f32[2,3]{1,0} parameter(4)\n+  p5 = f32[2,3]{1,0} parameter(5)\n+  negate0 = f32[2,3]{1,0} negate(p0)\n+  negate1 = f32[2,3]{1,0} negate(negate0)\n+  negate2 = f32[2,3]{1,0} negate(negate1)\n+  add3 = f32[2,3]{1,0} add(p1, negate2)\n+  negate4 = f32[2,3]{1,0} negate(add3)\n+  negate5 = f32[2,3]{1,0} negate(negate4)\n+  add6 = f32[2,3]{1,0} add(p2, negate5)\n+  negate7 = f32[2,3]{1,0} negate(add6)\n+  negate8 = f32[2,3]{1,0} negate(negate7)\n+  add9 = f32[2,3]{1,0} add(p3, negate8)\n+  negate10 = f32[2,3]{1,0} negate(add9)\n+  negate11 = f32[2,3]{1,0} negate(negate10)\n+  add12 = f32[2,3]{1,0} add(p4, negate11)\n+  negate13 = f32[2,3]{1,0} negate(add12)\n+  negate14 = f32[2,3]{1,0} negate(negate13)\n+  add15 = f32[2,3]{1,0} add(p5, negate14)\n+  ROOT tuple = (f32[2,3]{1,0}, f32[2,3]{1,0}) tuple(add15, p3)\n+})\";\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  TF_ASSERT_OK(module->input_output_alias_config().SetUpAlias({1}, 3, {}));\n+  Options memory_space_options = DefaultMemorySpaceOptions();\n+  memory_space_options.max_size_in_bytes = 24;\n+  memory_space_options.reserved_bytes_for_block_prefetches = 24;\n+\n+  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n+  HloPosition p0_position{p0, {}};\n+  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n+  HloPosition p1_position{p1, {}};\n+  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n+  HloPosition p2_position{p2, {}};\n+  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n+  HloPosition p3_position{p3, {}};\n+  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n+  HloPosition p4_position{p4, {}};\n+  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n+  HloPosition p5_position{p5, {}};\n+  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n+                                                     p3_position, p2_position,\n+                                                     p1_position, p0_position};\n+  memory_space_options.max_outstanding_block_prefetches = 10;\n+  XLA_LOG_LINES(INFO, \"Before MSA: \\n\" + module->ToString());\n+  AssignMemorySpaceUsingCostAnalysis(module.get(), memory_space_options);\n+  XLA_LOG_LINES(INFO, \"After MSA: \\n\" + module->ToString());\n+\n+  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n+  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n+  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n+  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n+  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n+            kDefaultMemorySpace);\n+  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n+  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n+  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+}\n+\n TEST_F(MemorySpaceAssignmentTest, TestBlockPrefetchingDoubleBuffered) {\n   absl::string_view hlo_string = R\"(\n HloModule module, is_scheduled=true"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 107,
        "deletions": 0
    }
}