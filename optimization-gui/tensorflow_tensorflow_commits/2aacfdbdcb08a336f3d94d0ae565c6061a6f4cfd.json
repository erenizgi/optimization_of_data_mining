{
    "author": "shawnwang18",
    "message": "PR #34657: [XLA:GPU] Fix the command_buffer_cmd vlog debug message to profile the memory allocation types.\n\nImported from GitHub PR https://github.com/openxla/xla/pull/34657\n\nğŸ“ Summary of Changes\n Fix the command_buffer_cmd vlog debug message to profile the memory allocation types.\n\nğŸš€ Kind of Contribution\nğŸ“š Documentation\n\nCopybara import of the project:\n\n--\n5a6ac3c39688575eaf70f71513e9ad2994cce64f by Shawn Wang <shawnw@nvidia.com>:\n\nfix allocation type fetching issue\n\n--\n78df3842aae24ccd2a89676e8df3dcdf1bf456e8 by Shawn Wang <shawnw@nvidia.com>:\n\nfix\n\nMerging this change closes #34657\n\nPiperOrigin-RevId: 840103038",
    "sha": "2aacfdbdcb08a336f3d94d0ae565c6061a6f4cfd",
    "files": [
        {
            "sha": "77355cce9efcf41a1b07ba003b90ad26ff6ccfb9",
            "filename": "third_party/xla/xla/backends/gpu/runtime/command_buffer_cmd.cc",
            "status": "modified",
            "additions": 43,
            "deletions": 12,
            "changes": 55,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2aacfdbdcb08a336f3d94d0ae565c6061a6f4cfd/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2aacfdbdcb08a336f3d94d0ae565c6061a6f4cfd/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc?ref=2aacfdbdcb08a336f3d94d0ae565c6061a6f4cfd",
            "patch": "@@ -496,65 +496,96 @@ absl::Status CommandBufferCmdExecutor::Record(\n         command_buffer->mode() == se::CommandBuffer::Mode::kPrimary) {\n       int64_t input_count = 0;\n       int64_t output_count = 0;\n+      int64_t temp_count = 0;\n       int64_t input_temp_count = 0;\n       int64_t output_temp_count = 0;\n       int64_t input_output_count = 0;\n       int64_t input_temp_output_count = 0;\n \n+      absl::flat_hash_map<std::string, int64_t> input_cmds;\n+      absl::flat_hash_map<std::string, int64_t> output_cmds;\n+      absl::flat_hash_map<std::string, int64_t> temp_cmds;\n+      absl::flat_hash_map<std::string, int64_t> input_temp_cmds;\n+      absl::flat_hash_map<std::string, int64_t> output_temp_cmds;\n+      absl::flat_hash_map<std::string, int64_t> input_output_cmds;\n+      absl::flat_hash_map<std::string, int64_t> input_temp_output_cmds;\n+\n       for (const auto& cmd : commands_) {\n         bool has_input = false;\n         bool has_output = false;\n         bool has_temp = false;\n \n         for (const auto& buffer : cmd->buffers()) {\n-          if (buffer.HasDefinedContentsOnInput()) {\n+          if (buffer.slice().allocation()->IsPreallocatedTempBuffer()) {\n+            has_temp = true;\n+          }\n+          if (buffer.slice().allocation()->is_entry_computation_parameter()) {\n             has_input = true;\n           }\n-          if (buffer.HasDefinedContentsOnOutput()) {\n+          if (buffer.slice().allocation()->maybe_live_out()) {\n             has_output = true;\n           }\n-          if (!buffer.HasDefinedContentsOnInput() &&\n-              !buffer.HasDefinedContentsOnOutput()) {\n-            has_temp = true;\n-          }\n         }\n \n+        std::string cmd_name = CommandBufferCmdString(cmd->command_type());\n+\n         if (has_input && !has_output && !has_temp) {\n           input_count++;\n+          input_cmds[cmd_name]++;\n         }\n         if (!has_input && has_output && !has_temp) {\n           output_count++;\n+          output_cmds[cmd_name]++;\n+        }\n+        if (!has_input && !has_output && has_temp) {\n+          temp_count++;\n+          temp_cmds[cmd_name]++;\n         }\n         if (has_input && !has_output && has_temp) {\n           input_temp_count++;\n+          input_temp_cmds[cmd_name]++;\n         }\n         if (!has_input && has_output && has_temp) {\n           output_temp_count++;\n+          output_temp_cmds[cmd_name]++;\n         }\n         if (has_input && has_output && !has_temp) {\n           input_output_count++;\n+          input_output_cmds[cmd_name]++;\n         }\n         if (has_input && has_output && has_temp) {\n           input_temp_output_count++;\n+          input_temp_output_cmds[cmd_name]++;\n         }\n       }\n \n+      auto print_cmds =\n+          [](const absl::flat_hash_map<std::string, int64_t>& cmds) {\n+            std::string s;\n+            for (const auto& [name, count] : cmds) {\n+              absl::StrAppend(&s, \"\\n    \", name, \": \", count);\n+            }\n+            return s;\n+          };\n+\n       VLOG(5) << \"CommandBufferCmdExecutor allocation summary:\\n\"\n               << \"  Total commands                                 : \"\n               << commands_.size() << \"\\n\"\n               << \"  ------------------------------------------------\\n\"\n               << \"  Commands consuming input buffer                : \"\n-              << input_count << \"\\n\"\n+              << input_count << print_cmds(input_cmds) << \"\\n\"\n               << \"  Commands consuming output buffer               : \"\n-              << output_count << \"\\n\"\n+              << output_count << print_cmds(output_cmds) << \"\\n\"\n+              << \"  Commands consuming temp buffer                 : \"\n+              << temp_count << print_cmds(temp_cmds) << \"\\n\"\n               << \"  Commands consuming input, temp buffers         : \"\n-              << input_temp_count << \"\\n\"\n+              << input_temp_count << print_cmds(input_temp_cmds) << \"\\n\"\n               << \"  Commands consuming output, temp buffers        : \"\n-              << output_temp_count << \"\\n\"\n+              << output_temp_count << print_cmds(output_temp_cmds) << \"\\n\"\n               << \"  Commands consuming input, output buffers       : \"\n-              << input_output_count << \"\\n\"\n+              << input_output_count << print_cmds(input_output_cmds) << \"\\n\"\n               << \"  Commands consuming input, temp, output buffers : \"\n-              << input_temp_output_count;\n+              << input_temp_output_count << print_cmds(input_temp_output_cmds);\n     }\n \n     TF_RETURN_IF_ERROR(RecordCreate(execute_params, record_params,"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 43,
        "deletions": 12
    }
}