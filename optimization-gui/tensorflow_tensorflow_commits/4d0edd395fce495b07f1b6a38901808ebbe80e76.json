{
    "author": "KanishAnand",
    "message": "Refactor `std::optional` comparison in `ReshapeSharding` tests\n\nPiperOrigin-RevId: 847749800",
    "sha": "4d0edd395fce495b07f1b6a38901808ebbe80e76",
    "files": [
        {
            "sha": "c6b95c58cf8b54f4ac377da4deb145b472b353d1",
            "filename": "third_party/xla/xla/hlo/utils/hlo_sharding_util_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 60,
            "changes": 92,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4d0edd395fce495b07f1b6a38901808ebbe80e76/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4d0edd395fce495b07f1b6a38901808ebbe80e76/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util_test.cc?ref=4d0edd395fce495b07f1b6a38901808ebbe80e76",
            "patch": "@@ -196,8 +196,7 @@ TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned1) {\n       HloSharding::PartialTile(TileAssignment({2, 2, 3}, {3, 2, 2}, {1, 2, 0}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned2) {\n@@ -208,8 +207,7 @@ TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned2) {\n       HloSharding::PartialTile(TileAssignment({2, 2, 3}, {2, 3, 2}, {0, 2, 1}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned3) {\n@@ -220,8 +218,7 @@ TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned3) {\n       HloSharding::PartialTile(TileAssignment({4, 3}, {2, 3, 2}, {0, 2, 1}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned4) {\n@@ -232,8 +229,7 @@ TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned4) {\n       HloSharding::PartialTile(TileAssignment({2, 2, 3}, {3, 4}, {1, 0}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned5) {\n@@ -243,8 +239,7 @@ TEST(HloShardingUtilTest, ReshapeShardingDimensionSizeOnePartitioned5) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 3, 2, 2});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingMaximal) {\n@@ -253,8 +248,7 @@ TEST(HloShardingUtilTest, ReshapeShardingMaximal) {\n   HloSharding sharding = HloSharding::AssignDevice(7);\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), sharding);\n+  EXPECT_EQ(result, sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledInvalid) {\n@@ -263,7 +257,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledInvalid) {\n   HloSharding sharding = HloSharding::IotaTile({1, 2, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, sharding);\n-  EXPECT_FALSE(result.has_value());\n+  ASSERT_FALSE(result.has_value());\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledMerge) {\n@@ -273,8 +267,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledMerge) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledSplit) {\n@@ -284,8 +277,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledSplit) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 1, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledSplit2) {\n@@ -295,8 +287,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledSplit2) {\n   HloSharding output_sharding = HloSharding::IotaTile({4, 4, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledSplit3) {\n@@ -307,8 +298,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledSplit3) {\n       HloSharding::PartialTile(TileAssignment({2, 1, 2}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledSplitThenMerge) {\n@@ -318,8 +308,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledSplitThenMerge) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 1, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledArbitraryMinorDimensions) {\n@@ -328,8 +317,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledArbitraryMinorDimensions) {\n   HloSharding sharding = HloSharding::IotaTile({2, 1, 1, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), sharding);\n+  EXPECT_EQ(result, sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTiledTrivialDimensions) {\n@@ -339,8 +327,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTiledTrivialDimensions) {\n   HloSharding output_sharding = HloSharding::IotaTile({1, 2, 1, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTrivialDimensionInsertedToEnd) {\n@@ -350,16 +337,14 @@ TEST(HloShardingUtilTest, ReshapeShardingTrivialDimensionInsertedToEnd) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 1, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, NoopReshapeShardingEmptyTile) {\n   Shape shape = ShapeUtil::MakeShape(F32, {7, 1, 1});\n   HloSharding sharding = HloSharding::IotaTile({2, 1, 1});\n   std::optional<HloSharding> result = ReshapeSharding(shape, shape, sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), sharding);\n+  EXPECT_EQ(result, sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingScalar) {\n@@ -368,7 +353,7 @@ TEST(HloShardingUtilTest, ReshapeShardingScalar) {\n   HloSharding sharding = HloSharding::IotaTile({2, 1, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, sharding);\n-  EXPECT_FALSE(result.has_value());\n+  ASSERT_FALSE(result.has_value());\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne1) {\n@@ -379,12 +364,10 @@ TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne1) {\n \n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n \n   result = ReshapeSharding(output_shape, input_shape, output_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), input_sharding);\n+  EXPECT_EQ(result, input_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne2) {\n@@ -395,8 +378,7 @@ TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne2) {\n       HloSharding::PartialTile(TileAssignment({4, 2, 8}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne3) {\n@@ -406,8 +388,7 @@ TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne3) {\n   HloSharding output_sharding = HloSharding::IotaTile({4, 2, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne4) {\n@@ -418,8 +399,7 @@ TEST(HloShardingUtilTest, ReshapeShardingSuffixShapeSizeOne4) {\n       HloSharding::PartialTile(TileAssignment({4, 2, 4}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingPrefixShapeSizeOne1) {\n@@ -429,12 +409,10 @@ TEST(HloShardingUtilTest, ReshapeShardingPrefixShapeSizeOne1) {\n   HloSharding output_sharding = HloSharding::IotaTile({1, 4});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n \n   result = ReshapeSharding(output_shape, input_shape, output_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), input_sharding);\n+  EXPECT_EQ(result, input_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingPrefixShapeSizeOne2) {\n@@ -444,12 +422,10 @@ TEST(HloShardingUtilTest, ReshapeShardingPrefixShapeSizeOne2) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 1});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n \n   result = ReshapeSharding(output_shape, input_shape, output_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), input_sharding);\n+  EXPECT_EQ(result, input_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTranspose1) {\n@@ -458,8 +434,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTranspose1) {\n   HloSharding sharding = HloSharding::IotaTile({2, 1, 5});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), sharding);\n+  EXPECT_EQ(result, sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTranspose2) {\n@@ -469,8 +444,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTranspose2) {\n   HloSharding output_sharding = HloSharding::IotaTile({2, 1, 13});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  ASSERT_TRUE(result.has_value());\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTranspose3) {\n@@ -479,7 +453,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTranspose3) {\n   HloSharding input_sharding = HloSharding::IotaTile({1, 1, 5});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_FALSE(result.has_value());\n+  ASSERT_FALSE(result.has_value());\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingTranspose4) {\n@@ -490,8 +464,7 @@ TEST(HloShardingUtilTest, ReshapeShardingTranspose4) {\n       HloSharding::PartialTile(TileAssignment({1, 1, 5, 1, 1, 1, 13}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingWithPadding1) {\n@@ -500,7 +473,7 @@ TEST(HloShardingUtilTest, ReshapeShardingWithPadding1) {\n   HloSharding input_sharding = HloSharding::IotaTile({8});\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_FALSE(result.has_value());\n+  ASSERT_FALSE(result.has_value());\n }\n \n TEST(HloShardingUtilTest, ReshapeShardingWithPadding2) {\n@@ -511,8 +484,7 @@ TEST(HloShardingUtilTest, ReshapeShardingWithPadding2) {\n       HloSharding::PartialTile(TileAssignment({4, 2}));\n   std::optional<HloSharding> result =\n       ReshapeSharding(input_shape, output_shape, input_sharding);\n-  EXPECT_TRUE(result.has_value());\n-  EXPECT_EQ(result.value(), output_sharding);\n+  EXPECT_EQ(result, output_sharding);\n }\n \n TEST(HloShardingUtilTest, PropagateReshapeShardingTranspose1) {"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 32,
        "deletions": 60
    }
}