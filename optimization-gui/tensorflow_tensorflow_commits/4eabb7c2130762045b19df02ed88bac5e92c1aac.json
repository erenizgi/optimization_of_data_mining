{
    "author": "hyeontaek",
    "message": "[Rollback] [IFRT] Remove `GetUserContext()` utility function\n\nReverts 4c99929df27ae7a6e0084942aae9e3aaa4ec572e\n\nPiperOrigin-RevId: 839019830",
    "sha": "4eabb7c2130762045b19df02ed88bac5e92c1aac",
    "files": [
        {
            "sha": "def13bbbdf5b80f35f84b797a3a0d27fd9761574",
            "filename": "third_party/xla/xla/python/ifrt/client_impl_util.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4eabb7c2130762045b19df02ed88bac5e92c1aac/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fclient_impl_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4eabb7c2130762045b19df02ed88bac5e92c1aac/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fclient_impl_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fclient_impl_util.cc?ref=4eabb7c2130762045b19df02ed88bac5e92c1aac",
            "patch": "@@ -92,6 +92,13 @@ bool CanUseMakeArrayFromHostBuffer(\n \n }  // namespace\n \n+UserContextRef GetUserContext(Client* client) {\n+  if (UserContextScope::current() != nullptr) {\n+    return UserContextScope::current();\n+  }\n+  return client->CreateUserContext();\n+}\n+\n absl::StatusOr<std::vector<ArrayRef>> ClientMakeArraysFromHostBufferShards(\n     Client* client,\n     absl::Span<Client::MakeArraysFromHostBufferShardsSpec> specs,"
        },
        {
            "sha": "5cf7290955ccbe131f92d1e316066e826654548f",
            "filename": "third_party/xla/xla/python/ifrt/client_impl_util.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4eabb7c2130762045b19df02ed88bac5e92c1aac/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fclient_impl_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4eabb7c2130762045b19df02ed88bac5e92c1aac/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fclient_impl_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fclient_impl_util.h?ref=4eabb7c2130762045b19df02ed88bac5e92c1aac",
            "patch": "@@ -28,6 +28,16 @@ limitations under the License.\n namespace xla {\n namespace ifrt {\n \n+// Convenient helper to choose the current `UserContextRef` in a uniform way.\n+//\n+// * If `UserContextScope::current() != nullptr`, `UserContextScope::current()`\n+//   is returned.\n+// * Otherwise, `client->CreateUserContext()` is returned.\n+//\n+// TODO(hyeontaek): Remove this helper and use `UserContextScope::current()`\n+// when there is no plural way of getting the current `UserContextRef`.\n+UserContextRef GetUserContext(Client* client);\n+\n // Portable adapter for `MakeArraysFromHostBufferShards`. It breaks downs\n // requests into `MakeArrayFromHostBuffer` calls followed by\n // `AssembleArrayFromSingleDeviceArrays`."
        },
        {
            "sha": "c63193d83c614688042c1d49222c93cbf891f7e2",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4eabb7c2130762045b19df02ed88bac5e92c1aac/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4eabb7c2130762045b19df02ed88bac5e92c1aac/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc?ref=4eabb7c2130762045b19df02ed88bac5e92c1aac",
            "patch": "@@ -950,6 +950,7 @@ IfrtBackend::HandleMakeArraysFromHostBufferShardsRequest(\n \n   std::move(cleanup).Invoke();\n \n+  UserContextScope user_context_scope(client_->CreateUserContext());\n   TF_ASSIGN_OR_RETURN(\n       std::vector<xla::ifrt::ArrayRef> arrays,\n       client_->MakeArraysFromHostBufferShards(\n@@ -1000,6 +1001,7 @@ IfrtBackend::HandleMakeErrorArraysRequest(\n     array_specs.push_back(std::move(array_spec));\n   }\n \n+  UserContextScope user_context_scope(client_->CreateUserContext());\n   TF_ASSIGN_OR_RETURN(std::vector<IfrtArrayRef> arrays,\n                       client_->MakeErrorArrays(error, array_specs));\n "
        }
    ],
    "stats": {
        "total": 19,
        "additions": 19,
        "deletions": 0
    }
}