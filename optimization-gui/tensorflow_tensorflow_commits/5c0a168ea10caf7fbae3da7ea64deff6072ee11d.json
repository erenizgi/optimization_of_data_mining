{
    "author": "nvgrw",
    "message": "Fix HloRunnerPjRt incorrectly not re-tupling results for replicated execution.\n\nPiperOrigin-RevId: 845936810",
    "sha": "5c0a168ea10caf7fbae3da7ea64deff6072ee11d",
    "files": [
        {
            "sha": "ab2d89586836830b652b801f746cc43dc4a64683",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5c0a168ea10caf7fbae3da7ea64deff6072ee11d/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5c0a168ea10caf7fbae3da7ea64deff6072ee11d/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc?ref=5c0a168ea10caf7fbae3da7ea64deff6072ee11d",
            "patch": "@@ -699,6 +699,7 @@ absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicatedImpl(\n   std::vector<PjRtDevice*> replica_devices(options.num_devices, nullptr);\n   std::vector<std::vector<std::unique_ptr<PjRtBuffer>>> argument_buffer_slices;\n   argument_buffer_slices.reserve(options.num_devices);\n+  std::vector<bool> is_tuple_result(options.num_devices, false);\n   for (int64_t i = 0; i < options.num_devices; ++i) {\n     // Amortize device lookup.\n     TF_ASSIGN_OR_RETURN(PjRtDevice* const device_ptr,\n@@ -711,6 +712,7 @@ absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicatedImpl(\n     TF_ASSIGN_OR_RETURN(const HloModule* const module,\n                         HloModuleFromWrapped(wrapped_executable));\n     const ComputationLayout& ecl = module->entry_computation_layout();\n+    is_tuple_result[i] = ecl.result_shape().IsTuple();\n \n     // Transfer literals to device.\n     const int64_t argument_count = argument_count_provider(i);\n@@ -807,9 +809,9 @@ absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicatedImpl(\n   std::vector<Literal> result_literals;\n   result_literals.reserve(options.num_devices);\n   for (int64_t i = 0; i < options.num_devices; ++i) {\n-    TF_ASSIGN_OR_RETURN(Literal literal,\n-                        TransferLiteralsFromDevice(\n-                            result_buffers[i], result_buffers[i].size() != 1));\n+    TF_ASSIGN_OR_RETURN(\n+        Literal literal,\n+        TransferLiteralsFromDevice(result_buffers[i], is_tuple_result[i]));\n     result_literals.push_back(std::move(literal));\n   }\n "
        }
    ],
    "stats": {
        "total": 8,
        "additions": 5,
        "deletions": 3
    }
}