{
    "author": "bmass02",
    "message": "Fix bug where device timing stats are not merged during grouping.\n\nPiperOrigin-RevId: 809165806",
    "sha": "86543e842e4f9f8aef2c1c259aeb1fd337f0182c",
    "files": [
        {
            "sha": "666f929e8e1a8596f8859a9afcab11a2e48995c3",
            "filename": "third_party/xla/xla/tsl/profiler/utils/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86543e842e4f9f8aef2c1c259aeb1fd337f0182c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86543e842e4f9f8aef2c1c259aeb1fd337f0182c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD?ref=86543e842e4f9f8aef2c1c259aeb1fd337f0182c",
            "patch": "@@ -341,10 +341,13 @@ tsl_cc_test(\n     srcs = [\"group_events_test.cc\"],\n     deps = [\n         \":group_events\",\n+        \":preprocess_xplane\",\n         \":tf_xplane_visitor\",\n+        \":timespan\",\n         \":xplane_builder\",\n         \":xplane_schema\",\n         \":xplane_test_utils\",\n+        \":xplane_utils\",\n         \":xplane_visitor\",\n         \"//xla/tsl/platform:env_impl\",\n         \"//xla/tsl/platform:test\","
        },
        {
            "sha": "e891231d807bbf7f85d6d8866402182454e366c8",
            "filename": "third_party/xla/xla/tsl/profiler/utils/group_events.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86543e842e4f9f8aef2c1c259aeb1fd337f0182c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fgroup_events.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86543e842e4f9f8aef2c1c259aeb1fd337f0182c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fgroup_events.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fgroup_events.cc?ref=86543e842e4f9f8aef2c1c259aeb1fd337f0182c",
            "patch": "@@ -824,7 +824,12 @@ class GroupQueue {\n void MergeHostSteps(const XStatMetadata& group_id_stat_metadata,\n                     const XPlaneVisitor& plane_visitor,\n                     XPlaneBuilder* plane_builder, XLine* step_line) {\n+  auto device_duration_stat_metadata = *plane_builder->GetOrCreateStatMetadata(\n+      GetStatTypeStr(StatType::kDeviceDurationPs));\n+  auto device_offset_stat_metadata = *plane_builder->GetOrCreateStatMetadata(\n+      GetStatTypeStr(StatType::kDeviceOffsetPs));\n   std::optional<int64_t> merged_group_id;\n+  std::optional<Timespan> merged_device_timespan;\n   std::optional<XEventBuilder> merged_step_builder;\n   absl::flat_hash_set<const XEvent*> events_to_remove;\n   for (XEvent& step_event : *step_line->mutable_events()) {\n@@ -840,10 +845,24 @@ void MergeHostSteps(const XStatMetadata& group_id_stat_metadata,\n     } else if (merged_group_id != group_id) {\n       // Start a new step with the current event.\n       merged_group_id = group_id;\n+      merged_device_timespan.reset();\n+      if (step_visitor.GetStat(StatType::kDeviceOffsetPs).has_value() &&\n+          step_visitor.GetStat(StatType::kDeviceDurationPs).has_value()) {\n+        merged_device_timespan = GetDeviceEventTimespan(step_visitor);\n+      }\n       merged_step_builder.emplace(step_line, plane_builder, &step_event);\n     } else {\n       // Multi-module step: extend the previous step until the end of the\n       // current event and discard the current event.\n+      if (merged_device_timespan.has_value()) {\n+        merged_device_timespan->ExpandToInclude(\n+            GetDeviceEventTimespan(step_visitor));\n+        merged_step_builder->SetOrAddStatValue(\n+            device_offset_stat_metadata, merged_device_timespan->begin_ps());\n+        merged_step_builder->SetOrAddStatValue(\n+            device_duration_stat_metadata,\n+            merged_device_timespan->duration_ps());\n+      }\n       merged_step_builder->SetEndTimestampPs(step_visitor.EndTimestampPs());\n       events_to_remove.insert(&step_event);\n     }"
        },
        {
            "sha": "9b882f71059566324352e361141f622977de3930",
            "filename": "third_party/xla/xla/tsl/profiler/utils/group_events_test.cc",
            "status": "modified",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86543e842e4f9f8aef2c1c259aeb1fd337f0182c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fgroup_events_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86543e842e4f9f8aef2c1c259aeb1fd337f0182c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fgroup_events_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fgroup_events_test.cc?ref=86543e842e4f9f8aef2c1c259aeb1fd337f0182c",
            "patch": "@@ -23,10 +23,13 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/tsl/platform/test.h\"\n #include \"xla/tsl/platform/types.h\"\n+#include \"xla/tsl/profiler/utils/preprocess_xplane.h\"\n #include \"xla/tsl/profiler/utils/tf_xplane_visitor.h\"\n+#include \"xla/tsl/profiler/utils/timespan.h\"\n #include \"xla/tsl/profiler/utils/xplane_builder.h\"\n #include \"xla/tsl/profiler/utils/xplane_schema.h\"\n #include \"xla/tsl/profiler/utils/xplane_test_utils.h\"\n+#include \"xla/tsl/profiler/utils/xplane_utils.h\"\n #include \"xla/tsl/profiler/utils/xplane_visitor.h\"\n #include \"tsl/profiler/protobuf/xplane.pb.h\"\n \n@@ -759,6 +762,84 @@ TEST(GroupTPUEventsTest, ModuleRootEventTest) {\n   });\n }\n \n+TEST(GroupTPUEventsTest, MergeHostStepsTest) {\n+  XSpace space;\n+  XPlaneBuilder host_plane_builder(GetOrCreateHostXPlane(&space));\n+  host_plane_builder.ReserveLines(1);\n+  auto main_thread = host_plane_builder.GetOrCreateLine(0);\n+  main_thread.SetName(\"main\");\n+  CreateXEvent(\n+      &host_plane_builder, &main_thread, \"train\", 100, 10,\n+      {{StatType::kStepNum, int64_t{1}}, {StatType::kIsRoot, int64_t{1}}});\n+  CreateXEvent(&host_plane_builder, &main_thread, \"DoEnqueueProgram\", 100, 1,\n+               {{StatType::kRunId, int64_t{2}},\n+                {StatType::kQueueId, int64_t{0}},\n+                {StatType::kDeviceOrdinal, int64_t{0}}});\n+  CreateXEvent(&host_plane_builder, &main_thread, \"DoEnqueueProgram\", 101, 2,\n+               {{StatType::kRunId, int64_t{3}},\n+                {StatType::kQueueId, int64_t{0}},\n+                {StatType::kDeviceOrdinal, int64_t{0}}});\n+  CreateXEvent(&host_plane_builder, &main_thread, \"DoEnqueueProgram\", 103, 2,\n+               {{StatType::kRunId, int64_t{4}},\n+                {StatType::kQueueId, int64_t{0}},\n+                {StatType::kDeviceOrdinal, int64_t{0}}});\n+  CreateXEvent(&host_plane_builder, &main_thread, \"DoEnqueueProgram\", 105, 4,\n+               {{StatType::kRunId, int64_t{5}},\n+                {StatType::kQueueId, int64_t{0}},\n+                {StatType::kDeviceOrdinal, int64_t{0}}});\n+  XPlane* device_plane = GetOrCreateTpuXPlane(&space, 0, \"TPUv4\", 0, 0);\n+  XPlaneBuilder device_plane_builder(device_plane);\n+  device_plane_builder.ReserveLines(1);\n+  auto module_line = device_plane_builder.GetOrCreateLine(0);\n+  module_line.SetName(tsl::profiler::kXlaModuleLineName);\n+  CreateXEvent(\n+      &device_plane_builder, &module_line, \"jit_something(1)\", 1000, 10,\n+      {{StatType::kRunId, int64_t{2}}, {StatType::kQueueId, int64_t{0}}});\n+  CreateXEvent(\n+      &device_plane_builder, &module_line, \"jit_something(2)\", 1015, 100,\n+      {{StatType::kRunId, int64_t{3}}, {StatType::kQueueId, int64_t{0}}});\n+  CreateXEvent(\n+      &device_plane_builder, &module_line, \"jit_something(3)\", 1125, 50,\n+      {{StatType::kRunId, int64_t{4}}, {StatType::kQueueId, int64_t{0}}});\n+  CreateXEvent(\n+      &device_plane_builder, &module_line, \"jit_something(4)\", 1180, 25,\n+      {{StatType::kRunId, int64_t{5}}, {StatType::kQueueId, int64_t{0}}});\n+  auto step_line = device_plane_builder.GetOrCreateLine(1);\n+  step_line.SetName(kStepLineName);\n+  CreateXEvent(&device_plane_builder, &step_line, \"0\", 1000, 10,\n+               {{StatType::kDeviceOffsetPs, int64_t{1000}},\n+                {StatType::kDeviceDurationPs, int64_t{10}}});\n+  CreateXEvent(&device_plane_builder, &step_line, \"1\", 1015, 100,\n+               {{StatType::kDeviceOffsetPs, int64_t{1015}},\n+                {StatType::kDeviceDurationPs, int64_t{100}}});\n+  CreateXEvent(&device_plane_builder, &step_line, \"2\", 1125, 50,\n+               {{StatType::kDeviceOffsetPs, int64_t{1125}},\n+                {StatType::kDeviceDurationPs, int64_t{50}}});\n+  CreateXEvent(&device_plane_builder, &step_line, \"3\", 1180, 25,\n+               {{StatType::kDeviceOffsetPs, int64_t{1180}},\n+                {StatType::kDeviceDurationPs, int64_t{25}}});\n+  // Make sure to preprocess so that the Runtime events have a Producer/Consumer\n+  // event set created.\n+  PreprocessXSpace(&space);\n+  EventForest event_forest;\n+  GroupTpuEventsOSS(&space, {device_plane}, &event_forest);\n+  auto visitor = CreateTfXPlaneVisitor(device_plane);\n+  bool step_line_found = false;\n+  visitor.ForEachLine([&](const XLineVisitor& line) {\n+    if (line.Name() != kStepLineName) {\n+      return;\n+    }\n+    step_line_found = true;\n+    EXPECT_EQ(line.NumEvents(), 1);\n+    auto step_event = line.GetFirstEvent();\n+    EXPECT_EQ(step_event.GetTimespan().begin_ps(), 1000);\n+    EXPECT_EQ(step_event.GetTimespan().end_ps(), 1205);\n+    EXPECT_EQ(GetDeviceEventTimespan(step_event).begin_ps(), 1000);\n+    EXPECT_EQ(GetDeviceEventTimespan(step_event).end_ps(), 1205);\n+  });\n+  EXPECT_TRUE(step_line_found);\n+}\n+\n }  // namespace\n }  // namespace profiler\n }  // namespace tsl"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 103,
        "deletions": 0
    }
}