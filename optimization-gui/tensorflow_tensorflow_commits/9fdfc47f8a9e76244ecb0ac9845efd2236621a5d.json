{
    "author": "hawkinsp",
    "message": "[XLA:Python] Release the GIL while starting or stopping the profiler.\n\nPiperOrigin-RevId: 834972320",
    "sha": "9fdfc47f8a9e76244ecb0ac9845efd2236621a5d",
    "files": [
        {
            "sha": "5b88793589d2e225284ea8621288cd7106491b7d",
            "filename": "third_party/xla/xla/python/profiler.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 32,
            "changes": 69,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9fdfc47f8a9e76244ecb0ac9845efd2236621a5d/third_party%2Fxla%2Fxla%2Fpython%2Fprofiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9fdfc47f8a9e76244ecb0ac9845efd2236621a5d/third_party%2Fxla%2Fxla%2Fpython%2Fprofiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fprofiler.cc?ref=9fdfc47f8a9e76244ecb0ac9845efd2236621a5d",
            "patch": "@@ -175,43 +175,48 @@ NB_MODULE(_profiler, m) {\n              new (wrapper)\n                  ProfilerSessionWrapper(tsl::ProfilerSession::Create(options));\n            })\n-      .def(\"stop_and_export\",\n-           [](ProfilerSessionWrapper* sess,\n-              const std::string& tensorboard_dir) -> void {\n-             tensorflow::profiler::XSpace xspace;\n-             // Disables the ProfilerSession\n-             xla::ThrowIfError(sess->session->CollectData(&xspace));\n-             xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n-                 xspace, tensorboard_dir, /* also_export_trace_json= */ true));\n-           })\n+      .def(\n+          \"stop_and_export\",\n+          [](ProfilerSessionWrapper* sess, const std::string& tensorboard_dir) {\n+            tensorflow::profiler::XSpace xspace;\n+            // Disables the ProfilerSession\n+            xla::ThrowIfError(sess->session->CollectData(&xspace));\n+            xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n+                xspace, tensorboard_dir, /* also_export_trace_json= */ true));\n+          },\n+          nb::call_guard<nb::gil_scoped_release>())\n       .def(\"stop\",\n            [](ProfilerSessionWrapper* sess) -> nb::bytes {\n-             tensorflow::profiler::XSpace xspace;\n+             std::string xspace_str;\n              // Disables the ProfilerSession\n-             xla::ThrowIfError(sess->session->CollectData(&xspace));\n-             std::string xspace_str = xspace.SerializeAsString();\n+             {\n+               nb::gil_scoped_release release;\n+               tensorflow::profiler::XSpace xspace;\n+               xla::ThrowIfError(sess->session->CollectData(&xspace));\n+               xspace_str = xspace.SerializeAsString();\n+             }\n              return nb::bytes(xspace_str.data(), xspace_str.size());\n            })\n-      .def(\"stop_and_get_profile_data\",\n-           [](ProfilerSessionWrapper* sess)\n-               -> tensorflow::profiler::python::ProfileData {\n-             auto xspace = std::make_shared<tensorflow::profiler::XSpace>();\n-             // Disables the ProfilerSession\n-             xla::ThrowIfError(sess->session->CollectData(xspace.get()));\n-             return tensorflow::profiler::python::ProfileData(xspace);\n-           })\n-      .def(\"export\",\n-           [](ProfilerSessionWrapper* sess, nb::bytes xspace,\n-              const std::string& tensorboard_dir) -> void {\n-             tensorflow::profiler::XSpace xspace_proto;\n-             // TODO(phawkins): change to absl::string_view when protobuf is\n-             // updated in XLA.\n-             xspace_proto.ParseFromString(\n-                 std::string(xspace.c_str(), xspace.size()));\n-             xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n-                 xspace_proto, tensorboard_dir,\n-                 /* also_export_trace_json= */ true));\n-           });\n+      .def(\n+          \"stop_and_get_profile_data\",\n+          [](ProfilerSessionWrapper* sess)\n+              -> tensorflow::profiler::python::ProfileData {\n+            auto xspace = std::make_shared<tensorflow::profiler::XSpace>();\n+            // Disables the ProfilerSession\n+            xla::ThrowIfError(sess->session->CollectData(xspace.get()));\n+            return tensorflow::profiler::python::ProfileData(xspace);\n+          },\n+          nb::call_guard<nb::gil_scoped_release>())\n+      .def(\"export\", [](ProfilerSessionWrapper* sess, nb::bytes xspace,\n+                        const std::string& tensorboard_dir) {\n+        tensorflow::profiler::XSpace xspace_proto;\n+        absl::string_view bytes(xspace.c_str(), xspace.size());\n+        nb::gil_scoped_release release;\n+        xspace_proto.ParseFromString(bytes);\n+        xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n+            xspace_proto, tensorboard_dir,\n+            /* also_export_trace_json= */ true));\n+      });\n \n   nb::class_<tensorflow::ProfileOptions> profile_options_class(\n       m, \"ProfileOptions\");"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 37,
        "deletions": 32
    }
}