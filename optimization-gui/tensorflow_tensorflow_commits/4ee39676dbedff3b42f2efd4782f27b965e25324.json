{
    "author": "sergachev",
    "message": "PR #30491: [GPU] Initialize cuDNN handles for all GPUs during cuDNN thunk init.\n\nImported from GitHub PR https://github.com/openxla/xla/pull/30491\n\nThis moves cuDNN handle initialization for GPUs with index > 0 from first thunk execution to executable initialization.\nCopybara import of the project:\n\n--\n424d001ccb30c9d073f361e0c7016751a82b5463 by Ilia Sergachev <isergachev@nvidia.com>:\n\n[GPU] Initialize cuDNN handles for all GPUs during cuDNN thunk init.\n\nMerging this change closes #30491\n\nPiperOrigin-RevId: 798170537",
    "sha": "4ee39676dbedff3b42f2efd4782f27b965e25324",
    "files": [
        {
            "sha": "11af99c8f8958ce171c9186d9289c3e412b37257",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cudnn_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4ee39676dbedff3b42f2efd4782f27b965e25324/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcudnn_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4ee39676dbedff3b42f2efd4782f27b965e25324/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcudnn_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcudnn_thunk.cc?ref=4ee39676dbedff3b42f2efd4782f27b965e25324",
            "patch": "@@ -52,8 +52,13 @@ CuDnnThunk::CuDnnThunk(std::string fingerprint, ThunkInfo thunk_info,\n \n absl::Status CuDnnThunk::Initialize(const InitializeParams& params) {\n   absl::Status ret = absl::OkStatus();\n+  // Calling AsDnn outside call_once ensures that cuDNN handles get created for\n+  // all GPUs in programs using cuDNN during the executable initialization\n+  // phase. It's sufficient to deserialize the graph once using just one of\n+  // them.\n+  se::dnn::DnnSupport* dnn = params.stream->parent()->AsDnn();\n   absl::call_once(once_flag_, [&] {\n-    auto result = params.stream->parent()->AsDnn()->DeserializeGraph(\n+    auto result = dnn->DeserializeGraph(\n         *params.stream, params.src.dnn_compiled_graphs.at(fingerprint_));\n     std::string().swap(fingerprint_);\n     if (result.ok()) {"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 6,
        "deletions": 1
    }
}