{
    "author": "tensorflower-gardener",
    "message": "Introduce a flag to allow h2h copies\n\nThis flag is to be used to xla_disable_automatic_host_compute_offload, so as to prevent any host compute that might cause numeric concerns.\n\nPiperOrigin-RevId: 842752710",
    "sha": "f76d332b684e2543598cf71066dea4a35a596072",
    "files": [
        {
            "sha": "2023cdbcba5ca177bc407ea04e0f7bad0c4775fd",
            "filename": "third_party/xla/xla/debug_options_flags.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc?ref=f76d332b684e2543598cf71066dea4a35a596072",
            "patch": "@@ -457,6 +457,8 @@ DebugOptions DefaultDebugOptionsIgnoringFlags() {\n   opts.set_xla_gpu_experimental_enable_heuristic_collective_combining(true);\n   opts.set_xla_unsupported_crash_on_hlo_pass_silent_hlo_change(false);\n   opts.set_xla_disable_automatic_host_compute_offload(false);\n+  opts.set_xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled(\n+      false);\n   opts.set_xla_enable_scoped_logging_timers(true);\n   opts.set_xla_unsupported_crash_on_hlo_pass_noop_change(false);\n   opts.set_xla_gpu_experimental_enable_split_k_rewrite(false);\n@@ -2602,6 +2604,16 @@ void MakeDebugOptionsFlags(std::vector<tsl::Flag>* flag_list,\n       debug_options->xla_disable_automatic_host_compute_offload(),\n       \"Return an error if HostOffloader would have automatically offloaded some\"\n       \" compute to the host.\"));\n+  flag_list->push_back(tsl::Flag(\n+      \"xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled\",\n+      bool_setter_for(\n+          &DebugOptions::\n+              set_xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled),  // NOLINT\n+      debug_options\n+          ->xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled(),\n+      \"Allow host-to-host copy when automatic host compute offload is \"\n+      \"disabled, i.e. when xla_disable_automatic_host_compute_offload is \"\n+      \"set.\"));\n   flag_list->push_back(tsl::Flag(\n       \"xla_enable_scoped_logging_timers\",\n       bool_setter_for(&DebugOptions::set_xla_enable_scoped_logging_timers),"
        },
        {
            "sha": "f72145b2e6392ac3a5453dd952c430b7dbf7ae1a",
            "filename": "third_party/xla/xla/hlo/transforms/host_offloader.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fhost_offloader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fhost_offloader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fhost_offloader.cc?ref=f76d332b684e2543598cf71066dea4a35a596072",
            "patch": "@@ -298,10 +298,17 @@ absl::StatusOr<bool> HostOffloader::WalkDownHostMemoryOffloadPaths(\n           \"to move the inputs to the device so that computation happens on the \"\n           \"device.\",\n           instruction->name());\n+      bool h2h_copy_allowed =\n+          instruction->opcode() == HloOpcode::kCopy &&\n+          instruction->GetModule()\n+              ->config()\n+              .debug_options()\n+              .xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled();  // NOLINT\n       if (instruction->GetModule()\n               ->config()\n               .debug_options()\n-              .xla_disable_automatic_host_compute_offload()) {\n+              .xla_disable_automatic_host_compute_offload() &&\n+          !h2h_copy_allowed) {\n         return absl::InvalidArgumentError(\n             \"Automatic host compute offloading is disabled.\");\n       }"
        },
        {
            "sha": "44f3f0fe4516a14d213a328223cb3c6be88fba0f",
            "filename": "third_party/xla/xla/hlo/transforms/host_offloader_test.cc",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fhost_offloader_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fhost_offloader_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fhost_offloader_test.cc?ref=f76d332b684e2543598cf71066dea4a35a596072",
            "patch": "@@ -95,6 +95,14 @@ class HostOffloaderTest : public HloHardwareIndependentTestBase {\n         .set_xla_disable_automatic_host_compute_offload(true);\n   }\n \n+  static void AllowH2hCopyWhenAutomaticHostComputeOffloadDisabled(\n+      HloModule* module) {\n+    module->mutable_config()\n+        .mutable_debug_options()\n+        .set_xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled(\n+            true);\n+  }\n+\n   AliasInfo alias_info_;\n };\n \n@@ -4650,6 +4658,49 @@ TEST_F(HostOffloaderTest, AutomaticHostComputeOffloadDisabled) {\n               absl_testing::StatusIs(absl::StatusCode::kInvalidArgument));\n }\n \n+TEST_F(HostOffloaderTest,\n+       H2hCopyDisallowedWhenAutomaticHostComputeOffloadDisabled) {\n+  const absl::string_view hlo_string = R\"(\n+    HloModule module, entry_computation_layout={(f32[1024]{0:T(128)S(5)})->f32[1024]{0:T(128)S(5)}}\n+\n+    ENTRY main {\n+      param = f32[1024]{0} parameter(0)\n+      ROOT a_copy = f32[1024]{0} copy(param)\n+    })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  DisableAutomaticHostComputeOffload(module.get());\n+  // A copy on host memory exists, but we have disabled automatic host compute\n+  // offloading and we haven't allowed H2H copies, so we expect an error.\n+  absl::StatusOr<bool> changed = RunHostOffloader(module.get());\n+  EXPECT_THAT(changed,\n+              absl_testing::StatusIs(absl::StatusCode::kInvalidArgument));\n+}\n+\n+TEST_F(HostOffloaderTest,\n+       H2hCopyAllowedWhenAutomaticHostComputeOffloadDisabled) {  // NOLINT\n+  const absl::string_view hlo_string = R\"(\n+    HloModule module, entry_computation_layout={(f32[1024]{0:T(128)S(5)})->f32[1024]{0:T(128)S(5)}}\n+\n+    ENTRY main {\n+      param = f32[1024]{0} parameter(0)\n+      ROOT a_copy = f32[1024]{0} copy(param)\n+    })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  DisableAutomaticHostComputeOffload(module.get());\n+  AllowH2hCopyWhenAutomaticHostComputeOffloadDisabled(module.get());\n+  // A copy on host memory exists, and we have disabled automatic host compute\n+  // offloading, but we have allowed H2H copies, so we expect success.\n+  TF_ASSERT_OK_AND_ASSIGN(bool changed, RunHostOffloader(module.get()));\n+  EXPECT_TRUE(changed);\n+  VLOG(1) << module->ToString();\n+  HloInstruction* a_copy = FindInstruction(module.get(), \"a_copy\");\n+  EXPECT_TRUE(host_offload_utils::ComputeTypeIsHost(a_copy));\n+}\n+\n }  // namespace\n \n }  // namespace xla"
        },
        {
            "sha": "a6ae112f4ef0e744df98efe1552423bc1851caa6",
            "filename": "third_party/xla/xla/xla.proto",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fxla.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f76d332b684e2543598cf71066dea4a35a596072/third_party%2Fxla%2Fxla%2Fxla.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fxla.proto?ref=f76d332b684e2543598cf71066dea4a35a596072",
            "patch": "@@ -145,6 +145,10 @@ message DebugOptions {\n   //--------------------------------------------------------------------------//\n   // go/keep-sorted start\n \n+  // Allow host-to-host copy even when automatic host compute offload is\n+  // disabled, i.e. when xla_disable_automatic_host_compute_offload is set.\n+  optional bool\n+      xla_allow_h2h_copy_when_automatic_host_compute_offload_disabled = 439;\n   // Return an error if HostOffloader would have automatically offloaded some\n   // compute to the host.\n   optional bool xla_disable_automatic_host_compute_offload = 408;\n@@ -1323,7 +1327,7 @@ message DebugOptions {\n   // Note: when adding a new flag, please add it to one of the hardware-specific\n   // or hardware-agnostic sections at the top of this proto message.\n \n-  // Next id: 439\n+  // Next id: 440\n \n   // Extra options to pass to the compilation backend (e.g. LLVM); specific\n   // interpretation of these values is left to the backend."
        }
    ],
    "stats": {
        "total": 78,
        "additions": 76,
        "deletions": 2
    }
}