{
    "author": "pschuh",
    "message": "[TransferServer]: Allow resetting all outstanding buffer awaits and requests for buffers (sets\nthem all as errors.\n\nPiperOrigin-RevId: 815954146",
    "sha": "20bed8ffc2511fe85992b1b835926bb8e1ec2afe",
    "files": [
        {
            "sha": "c7c439637371b8d7c30f0e513ded6fdc27fae32d",
            "filename": "third_party/xla/xla/python/transfer/socket-server.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket-server.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket-server.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket-server.h?ref=20bed8ffc2511fe85992b1b835926bb8e1ec2afe",
            "patch": "@@ -45,6 +45,9 @@ class SocketServer {\n     pull_table_->AwaitPull(uuid, std::move(handler));\n   }\n \n+  // Clears outstanding buffers and buffer requests.\n+  void Reset() { pull_table_->Reset(); }\n+\n   class SocketNetworkState;\n \n   // Connection state."
        },
        {
            "sha": "b024becf875bb84f17cc2ef57b4f197a77c0a16c",
            "filename": "third_party/xla/xla/python/transfer/streaming.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.cc?ref=20bed8ffc2511fe85992b1b835926bb8e1ec2afe",
            "patch": "@@ -323,6 +323,25 @@ void PullTable::Handle(tsl::RCReference<ConnectionState> state,\n   }\n }\n \n+void PullTable::Reset() {\n+  mu_.lock();\n+  auto entries = std::move(entries_);\n+  auto paused_fetches_by_uuid = std::move(paused_fetches_);\n+  mu_.unlock();\n+  // Drop entries without the lock held.\n+  for (const auto& paused_fetches : paused_fetches_by_uuid) {\n+    for (const auto& paused_fetch : paused_fetches.second) {\n+      size_t req_id = paused_fetch.base_req_id;\n+      for (uint64_t bid : paused_fetch.req.buffer_ids()) {\n+        (void)bid;\n+        paused_fetch.state->SendError(req_id, 0, 0, true,\n+                                      absl::InternalError(\"PullTable::Reset\"));\n+        ++req_id;\n+      }\n+    }\n+  }\n+}\n+\n class StringVectorPullTableEntry : public PullTable::Entry {\n  public:\n   explicit StringVectorPullTableEntry(std::vector<std::string> buffers)"
        },
        {
            "sha": "a724925692f01d957a001fe1c227f2115b8f2716",
            "filename": "third_party/xla/xla/python/transfer/streaming.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.h?ref=20bed8ffc2511fe85992b1b835926bb8e1ec2afe",
            "patch": "@@ -213,6 +213,9 @@ class PullTable {\n   static tsl::RCReference<PullTable::Entry> MakeStringEntry(\n       std::vector<std::string> buffers);\n \n+  // Clears all entries.\n+  void Reset();\n+\n  private:\n   absl::Mutex mu_;\n   absl::flat_hash_map<uint64_t, tsl::RCReference<Entry>> entries_;"
        },
        {
            "sha": "a7db6b82b4e6131ea905e88e095335b95f3a1087",
            "filename": "third_party/xla/xla/python/version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20bed8ffc2511fe85992b1b835926bb8e1ec2afe/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h?ref=20bed8ffc2511fe85992b1b835926bb8e1ec2afe",
            "patch": "@@ -18,6 +18,6 @@ limitations under the License.\n \n // An increasing version number to protect jax code against breaking changes.\n // In JAX, reference this via jax._src.lib.ifrt_version.\n-#define JAX_IFRT_VERSION_NUMBER 31\n+#define JAX_IFRT_VERSION_NUMBER 32\n \n #endif  // XLA_PYTHON_VERSION_H_"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 26,
        "deletions": 1
    }
}