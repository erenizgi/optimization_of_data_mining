{
    "author": "loislo",
    "message": "[XLA:GPU] Fix for Triton MLIR pass log dumping to the local dir.\n\nUpdate file extensions for Triton IR dumps from `.ttir` to `.ttir.txt`. Otherwise we cannot open them in the browser if we dumped them to sponge.\n\nRefine the logic for dumping Triton MLIR passes.\nAs of now if you specify xla_dump_to=/tmp/ttt then everything will be dumped to it except the triton log that would go to sponge. After the fix it will go to /tmp/ttt and only if 'sponge' was the value of xla_dump_to then it will go to sponge.\n\nPiperOrigin-RevId: 802137547",
    "sha": "e556e86dbf1e71355274cf9c9d46e1742508b781",
    "files": [
        {
            "sha": "1d36050dbb6b003fdd4a5c7d39859735322df2d4",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e556e86dbf1e71355274cf9c9d46e1742508b781/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e556e86dbf1e71355274cf9c9d46e1742508b781/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter.cc?ref=e556e86dbf1e71355274cf9c9d46e1742508b781",
            "patch": "@@ -1864,7 +1864,7 @@ absl::StatusOr<mlir::OwningOpRef<mlir::ModuleOp>> CreateTritonModule(\n   EmitReturnOp(b, fusion_kind);\n \n   if (DumpingEnabledForHloModule(*hlo_computation->parent())) {\n-    auto suffix = absl::StrCat(fusion->name(), \".before_validation.ttir\");\n+    auto suffix = absl::StrCat(fusion->name(), \".before_validation.ttir.txt\");\n     DumpToFileInDirOrStdout(\n         *hlo_computation->parent(), \"\", suffix,\n         DumpTritonIR(triton_module.get(),\n@@ -1897,10 +1897,8 @@ absl::StatusOr<mlir::OwningOpRef<mlir::ModuleOp>> CreateTritonModule(\n                               ->config()\n                               .debug_options()\n                               .xla_gpu_unsupported_annotate_with_emitter_loc());\n-  // TODO(loislo): Remove this dump once we have the Triton IR dump in\n-  // CompileTritonToLLVM after the Triton optimization passes.\n   if (DumpingEnabledForHloModule(*hlo_computation->parent())) {\n-    std::string suffix = absl::StrCat(fusion->name(), \".ttir\");\n+    std::string suffix = absl::StrCat(fusion->name(), \".ttir.txt\");\n     DumpToFileInDirOrStdout(\n         *hlo_computation->parent(), \"\", suffix,\n         DumpTritonIR(triton_module.get(),\n@@ -1983,9 +1981,13 @@ absl::StatusOr<TritonWrapperResult> CompileTritonToLLVM(\n \n   std::optional<llvm::raw_fd_ostream> log_stream;\n   if (should_dump_mlir_passes) {\n-    std::string outputs_dir;\n-    if (!tsl::io::GetTestUndeclaredOutputsDir(&outputs_dir)) {\n-      outputs_dir = hlo_config.debug_options().xla_dump_to();\n+    std::string outputs_dir = hlo_config.debug_options().xla_dump_to();\n+    if (outputs_dir == \"sponge\") {\n+      if (!tsl::io::GetTestUndeclaredOutputsDir(&outputs_dir)) {\n+        LOG(ERROR) << \"Failed to get test undeclared outputs dir. Lets skip \"\n+                      \"dumping triton passes.\";\n+        outputs_dir = \"\";\n+      }\n     }\n     if (!outputs_dir.empty()) {\n       const std::string basename ="
        }
    ],
    "stats": {
        "total": 16,
        "additions": 9,
        "deletions": 7
    }
}