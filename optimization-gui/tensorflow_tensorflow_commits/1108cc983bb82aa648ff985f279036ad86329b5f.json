{
    "author": "khasanovaa",
    "message": "Add proto [de]serialization for CholeskyThunk.\n\nThe only non-obvious part of the thunk is `solver_context_creator`, but we can retrieve it during the deserialization from `stream_executor::Platform`, which is available during runtime.\n\nPiperOrigin-RevId: 819863398",
    "sha": "1108cc983bb82aa648ff985f279036ad86329b5f",
    "files": [
        {
            "sha": "8b002a7fdfcb9a0242b8ed3942c132d8652202cb",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=1108cc983bb82aa648ff985f279036ad86329b5f",
            "patch": "@@ -309,19 +309,47 @@ cc_library(\n     deps = [\n         \":make_batch_pointers\",\n         \":thunk\",\n+        \":thunk_proto_cc\",\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/stream_executor:blas\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:gpu_solver_context\",\n+        \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:stream\",\n+        \"//xla/stream_executor/platform:platform_object_registry\",\n         \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:str_format\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)\n+\n+xla_test(\n+    name = \"cholesky_thunk_test\",\n+    srcs = [\"cholesky_thunk_test.cc\"],\n+    backends = [\"gpu\"],\n+    deps = [\n+        \":cholesky_thunk\",\n+        \":thunk\",\n+        \":thunk_proto_cc\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"//xla/service:buffer_assignment\",\n+        \"//xla/stream_executor:gpu_solver_context\",\n+        \"//xla/stream_executor:platform_manager\",\n+        \"//xla/stream_executor/platform:platform_object_registry\",\n+        \"//xla/tests:hlo_test_base\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:proto_matchers\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n "
        },
        {
            "sha": "44ee84dd5cd3ea960fe87d8abadf25899a41860e",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cholesky_thunk.cc",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.cc?ref=1108cc983bb82aa648ff985f279036ad86329b5f",
            "patch": "@@ -17,21 +17,26 @@ limitations under the License.\n \n #include <complex>\n #include <cstdint>\n+#include <functional>\n #include <memory>\n #include <utility>\n \n #include \"absl/functional/any_invocable.h\"\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_format.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/backends/gpu/runtime/make_batch_pointers.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/stream_executor/blas.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/gpu_solver_context.h\"\n+#include \"xla/stream_executor/platform.h\"\n+#include \"xla/stream_executor/platform/platform_object_registry.h\"\n #include \"xla/stream_executor/stream.h\"\n #include \"xla/tsl/platform/errors.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -171,5 +176,51 @@ absl::Status CholeskyThunk::ExecuteOnStream(const ExecuteParams& params) {\n   auto local_context = context.value().get();\n   return RunCholesky(type_, &cholesky_params, params.stream, local_context);\n }\n+\n+absl::StatusOr<ThunkProto> CholeskyThunk::ToProto() const {\n+  ThunkProto proto;\n+  *proto.mutable_thunk_info() = thunk_info().ToProto();\n+\n+  CholeskyThunkProto* cholesky_thunk_proto = proto.mutable_cholesky_thunk();\n+\n+  auto options = cholesky_thunk_proto->mutable_options();\n+  options->set_lower(uplo_ == se::blas::UpperLower::kLower);\n+\n+  TF_ASSIGN_OR_RETURN(*cholesky_thunk_proto->mutable_a_buffer(),\n+                      a_buffer_.ToProto());\n+  TF_ASSIGN_OR_RETURN(*cholesky_thunk_proto->mutable_workspace_buffer(),\n+                      workspace_buffer_.ToProto());\n+  TF_ASSIGN_OR_RETURN(*cholesky_thunk_proto->mutable_info_buffer(),\n+                      info_buffer_.ToProto());\n+  cholesky_thunk_proto->set_type(type_);\n+  cholesky_thunk_proto->set_batch_size(batch_size_);\n+  cholesky_thunk_proto->set_n(n_);\n+  return proto;\n+}\n+\n+absl::StatusOr<std::unique_ptr<CholeskyThunk>> CholeskyThunk::FromProto(\n+    ThunkInfo thunk_info, const CholeskyThunkProto& proto,\n+    absl::Span<const BufferAllocation> allocations,\n+    const stream_executor::Platform& platform) {\n+  TF_ASSIGN_OR_RETURN(\n+      BufferAllocation::Slice a_buffer,\n+      BufferAllocation::Slice::FromProto(proto.a_buffer(), allocations));\n+  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice workspace_buffer,\n+                      BufferAllocation::Slice::FromProto(\n+                          proto.workspace_buffer(), allocations));\n+  TF_ASSIGN_OR_RETURN(\n+      BufferAllocation::Slice info_buffer,\n+      BufferAllocation::Slice::FromProto(proto.info_buffer(), allocations));\n+  TF_ASSIGN_OR_RETURN(\n+      std::function<\n+          absl::StatusOr<std::unique_ptr<stream_executor::GpuSolverContext>>()>\n+          solver_creator,\n+      stream_executor::PlatformObjectRegistry::GetGlobalRegistry()\n+          .FindObject<stream_executor::GpuSolverContextFactory>(platform.id()));\n+  return std::make_unique<CholeskyThunk>(\n+      thunk_info, proto.options(), a_buffer, workspace_buffer, info_buffer,\n+      proto.type(), proto.batch_size(), proto.n(), solver_creator);\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "2f4cad73e349614321387f00e01adc5072730e3f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cholesky_thunk.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.h?ref=1108cc983bb82aa648ff985f279036ad86329b5f",
            "patch": "@@ -23,6 +23,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n+#include \"xla/backends/gpu/runtime/thunk.pb.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/stream_executor/blas.h\"\n #include \"xla/stream_executor/device_memory.h\"\n@@ -42,6 +43,11 @@ namespace gpu {\n // Thread-compatible.\n class CholeskyThunk : public Thunk {\n  public:\n+  static absl::StatusOr<std::unique_ptr<CholeskyThunk>> FromProto(\n+      ThunkInfo thunk_info, const CholeskyThunkProto& proto,\n+      absl::Span<const BufferAllocation> allocations,\n+      const stream_executor::Platform& platform);\n+\n   CholeskyThunk(\n       ThunkInfo thunk_info, const CholeskyOptions& options,\n       BufferAllocation::Slice a_buffer,\n@@ -55,6 +61,7 @@ class CholeskyThunk : public Thunk {\n   CholeskyThunk(const CholeskyThunk&) = delete;\n   CholeskyThunk& operator=(const CholeskyThunk&) = delete;\n \n+  absl::StatusOr<ThunkProto> ToProto() const override;\n   absl::Status ExecuteOnStream(const ExecuteParams& params) override;\n \n  private:"
        },
        {
            "sha": "0fc226577d249f4b9166f54941ea652560ac5820",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cholesky_thunk_test.cc",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk_test.cc?ref=1108cc983bb82aa648ff985f279036ad86329b5f",
            "patch": "@@ -0,0 +1,78 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/gpu/runtime/cholesky_thunk.h\"\n+\n+#include <cstdint>\n+#include <memory>\n+#include <vector>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/status/status_matchers.h\"\n+#include \"xla/backends/gpu/runtime/thunk.h\"\n+#include \"xla/backends/gpu/runtime/thunk.pb.h\"\n+#include \"xla/service/buffer_assignment.h\"\n+#include \"xla/stream_executor/gpu_solver_context.h\"\n+#include \"xla/stream_executor/platform/platform_object_registry.h\"\n+#include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/proto_matchers.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla::gpu {\n+namespace {\n+\n+using ::absl_testing::IsOkAndHolds;\n+using ::tsl::proto_testing::EqualsProto;\n+\n+class CholeskyThunkTest : public HloTestBase {};\n+\n+TEST_F(CholeskyThunkTest, ProtoRoundTrip) {\n+  Thunk::ThunkInfo thunk_info;\n+  thunk_info.profile_annotation = \"cholesky\";\n+  CholeskyOptions options;\n+  options.set_lower(true);\n+  std::vector<BufferAllocation> buffer_allocations = {\n+      BufferAllocation(0, 256, 0), BufferAllocation(1, 128, 0),\n+      BufferAllocation(2, 4, 0)};\n+  BufferAllocation::Slice a_buffer(&buffer_allocations[0], 0, 256);\n+  BufferAllocation::Slice workspace_buffer(&buffer_allocations[1], 0, 128);\n+  BufferAllocation::Slice info_buffer(&buffer_allocations[2], 0, 4);\n+  PrimitiveType type = F32;\n+  int64_t batch_size = 1;\n+  int64_t n = 16;\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto solver_creator,\n+      stream_executor::PlatformObjectRegistry::GetGlobalRegistry()\n+          .FindObject<stream_executor::GpuSolverContextFactory>(\n+              backend().platform()->id()));\n+\n+  CholeskyThunk thunk(thunk_info, options, a_buffer, workspace_buffer,\n+                      info_buffer, type, batch_size, n, solver_creator);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(ThunkProto proto, thunk.ToProto());\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<CholeskyThunk> round_trip_thunk,\n+      CholeskyThunk::FromProto(thunk.thunk_info(), proto.cholesky_thunk(),\n+                               buffer_allocations, *backend().platform()));\n+\n+  EXPECT_THAT(round_trip_thunk->ToProto(), IsOkAndHolds(EqualsProto(proto)));\n+}\n+\n+}  // namespace\n+}  // namespace xla::gpu"
        },
        {
            "sha": "5587e9ae85523c06df397d2c1500b3afe1049ebc",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk.proto",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1108cc983bb82aa648ff985f279036ad86329b5f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto?ref=1108cc983bb82aa648ff985f279036ad86329b5f",
            "patch": "@@ -116,6 +116,16 @@ message TriangularSolveThunkProto {\n   int64 b_batch_stride = 10;\n }\n \n+message CholeskyThunkProto {\n+  xla.CholeskyOptions options = 1;\n+  xla.buffer_assignment.BufferAllocationSliceProto a_buffer = 2;\n+  xla.buffer_assignment.BufferAllocationSliceProto workspace_buffer = 3;\n+  xla.buffer_assignment.BufferAllocationSliceProto info_buffer = 4;\n+  xla.PrimitiveType type = 5;\n+  int64 batch_size = 6;\n+  int64 n = 7;\n+}\n+\n message ReplicaIdThunkProto {\n   xla.buffer_assignment.BufferAllocationSliceProto dest_buffer = 1;\n }\n@@ -252,6 +262,7 @@ message ThunkProto {\n     ConvolutionThunkProto convolution_thunk = 25;\n     ConvolutionReorderThunkProto convolution_reorder_thunk = 26;\n     FftThunkProto fft_thunk = 27;\n+    CholeskyThunkProto cholesky_thunk = 28;\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 175,
        "additions": 175,
        "deletions": 0
    }
}