{
    "author": "thevilledev",
    "message": "PR #35048: fix: cap shape size in TextLiteralReader\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35048\n\nüìù Summary of Changes\n\nAdd size check in TextLiteralReader before allocation to avoid null-dereference crash when parsing shapes with extremely large dimensions.\n\nCap at `int32_t` maximum (around 2 GB), which should be sufficient for this text-based format.\n\nFixes OSS-Fuzz finding [#428771909](https://issues.oss-fuzz.com/issues/428771909)and probably [#429123948](https://issues.oss-fuzz.com/issues/429123948) from the Tensorflow fuzzer.\n\nüéØ Justification\n\nThis change prevents crashes from unbounded memory allocation triggered by malformed input files.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nNot relevant.\n\nüß™ Unit Tests:\n\nAdded a unit test from the OSS-Fuzz reproducer test case. Test command:\n\n```\ndocker exec xla bazel test \\\n  --spawn_strategy=sandboxed \\                                                                                                                                                           --test_output=all \\\n  //xla:text_literal_reader_test\n```\n\nOutput:\n\n```\n==================== Test output for //xla:text_literal_reader_test:\nNote: Randomizing tests' orders with a seed of 8787 .\n[==========] Running 4 tests from 1 test suite.\n[----------] Global test environment set-up.\n[----------] 4 tests from TextLiteralReaderTest\n[ RUN      ] TextLiteralReaderTest.MissingColonReturnsInvalidArgument\n[       OK ] TextLiteralReaderTest.MissingColonReturnsInvalidArgument (32 ms)\n[ RUN      ] TextLiteralReaderTest.ShapeTooLargeReturnsResourceExhausted\n[       OK ] TextLiteralReaderTest.ShapeTooLargeReturnsResourceExhausted (1 ms)\n[ RUN      ] TextLiteralReaderTest.WhitespaceOnlyLineAfterShapeDoesNotCrashAndYieldsScalarNaN\n[       OK ] TextLiteralReaderTest.WhitespaceOnlyLineAfterShapeDoesNotCrashAndYieldsScalarNaN (1 ms)\n[ RUN      ] TextLiteralReaderTest.ReadsR3File\n[       OK ] TextLiteralReaderTest.ReadsR3File (0 ms)\n[----------] 4 tests from TextLiteralReaderTest (36 ms total)\n\n[----------] Global test environment tear-down\n[==========] 4 tests from 1 test suite ran. (39 ms total)\n[  PASSED  ] 4 tests.\n================================================================================\n//xla:text_literal_reader_test                                  (cached) PASSED in 0.4s\n```\n\nüß™ Execution Tests:\nNot relevant.\n\nCopybara import of the project:\n\n--\n89453e789c7713423429070ad460670f0a6d7039 by Ville Vesilehto <ville@vesilehto.fi>:\n\nfix: cap shape size in TextLiteralReader\n\nAdd size check before allocation to avoid null-dereference crash when\nparsing shapes with extremely large dimensions. Cap at int32_t\nmaximum (around 2 GB), which should be sufficient for this\ntext-based format.\n\nFixes OSS-Fuzz finding 428771909.\n\nSigned-off-by: Ville Vesilehto <ville@vesilehto.fi>\n\nMerging this change closes #35048\n\nPiperOrigin-RevId: 842640535",
    "sha": "c8d46ebb0d75b83233fdb5905158ad726210d626",
    "files": [
        {
            "sha": "8acf1307c678eb41cafe1933f28b8863ebbfeac4",
            "filename": "third_party/xla/xla/text_literal_reader.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8d46ebb0d75b83233fdb5905158ad726210d626/third_party%2Fxla%2Fxla%2Ftext_literal_reader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8d46ebb0d75b83233fdb5905158ad726210d626/third_party%2Fxla%2Fxla%2Ftext_literal_reader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftext_literal_reader.cc?ref=c8d46ebb0d75b83233fdb5905158ad726210d626",
            "patch": "@@ -73,6 +73,17 @@ absl::StatusOr<Literal> TextLiteralReader::ReadAllLines() {\n \n   absl::StripAsciiWhitespace(&shape_string);\n   TF_ASSIGN_OR_RETURN(Shape shape, ParseShape(shape_string));\n+\n+  // Sanity check to reject shapes that are obviously too large. This doesn't\n+  // guarantee allocation will succeed, but prevents crashes from absurdly\n+  // large sizes (e.g., from fuzz testing).\n+  constexpr int64_t kMaxSupportedBytes = std::numeric_limits<int32_t>::max();\n+  int64_t byte_size = ShapeUtil::ByteSizeOf(shape);\n+  if (byte_size < 0 || byte_size > kMaxSupportedBytes) {\n+    return ResourceExhausted(\"Shape %s requires too much memory (%d bytes)\",\n+                             ShapeUtil::HumanString(shape), byte_size);\n+  }\n+\n   if (shape.element_type() != F32) {\n     return Unimplemented(\n         \"unsupported element type for text literal reading: %s\","
        },
        {
            "sha": "d57b9a06c2c8425bc7a30aa7eb09e75700ddb3ed",
            "filename": "third_party/xla/xla/text_literal_reader_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8d46ebb0d75b83233fdb5905158ad726210d626/third_party%2Fxla%2Fxla%2Ftext_literal_reader_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8d46ebb0d75b83233fdb5905158ad726210d626/third_party%2Fxla%2Fxla%2Ftext_literal_reader_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftext_literal_reader_test.cc?ref=c8d46ebb0d75b83233fdb5905158ad726210d626",
            "patch": "@@ -89,5 +89,16 @@ TEST(TextLiteralReaderTest, MissingColonReturnsInvalidArgument) {\n   EXPECT_THAT(literal, StatusIs(absl::StatusCode::kInvalidArgument));\n }\n \n+TEST(TextLiteralReaderTest, ShapeTooLargeReturnsResourceExhausted) {\n+  // Shape requires too much memory, should fail gracefully rather than crash.\n+  std::string contents = \"f32[272222222222222222]\\n\";\n+\n+  std::string fname = tsl::testing::TmpDir() + \"/ShapeTooLarge.data.txt\";\n+  ASSERT_THAT(tsl::WriteStringToFile(tsl::Env::Default(), fname, contents),\n+              IsOk());\n+  absl::StatusOr<Literal> literal = TextLiteralReader::ReadPath(fname);\n+  EXPECT_THAT(literal, StatusIs(absl::StatusCode::kResourceExhausted));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 22,
        "deletions": 0
    }
}