{
    "author": "Flamefire",
    "message": "PR #31886: Fix libdevice search\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31886\n\nüìù Summary of Changes\nThis enhances the search for the CUDA libdevice path:\n- Fix an invalid empty path added when `TF_CUDA_TOOLKIT_PATH` which may be empty\n- Fix invalid paths based on runtime folders: `runfiles_dir.substr(0, runfiles_ind + runfiles_suffix.length())` is not meaningful when `runfiles_ind` isn't valid, i.e. `std::string::npos`\n- Add `$CUDA_HOME` to the search paths. This is also used in TensorFlow already\n\nüéØ Justification\nWithout this the libdevice file won't be found if CUDA isn't installed in a standard location or e.g. an updated version is available in a different location.\nThis is the case for e.g. HPC systems where multiple CUDA versions are available side-by-side.\n\nüöÄ Kind of Contribution\nüêõ Bug Fix, ‚ôªÔ∏è Cleanup\n\nFixes #28590\n\nüß™ Unit Tests:\n\nSimple test that when `CandidateCudaRoots` returns anything it contains `$CUDA_HOME`\n\nCopybara import of the project:\n\n--\n01788b896900717ee916377a71d5c14963e0176d by Alexander Grund <alexander.grund@tu-dresden.de>:\n\nFix libdevice search when outside test environment\n\nWhen there is no `runfiles_suffix` the `rfind` returns\n`std::string::npos` which should be handled to not add meaningless paths.\n\n--\n900715a846102bacdfc7688f14713cbe6101506d by Alexander Grund <alexander.grund@tu-dresden.de>:\n\nUse `$CUDA_HOME` when searching for libdevice.\n\nWith a CUDA installed to a non-default location XLA/TF fails with:\n> gpu_backend_lib.cc:579] Can't find libdevice directory ${CUDA_DIR}/nvvm/libdevice. This may result in compilation or runtime failures, if the program we try to run uses routines from libdevice.\n> Searched for CUDA in the following directories:\n>   ./cuda_sdk_lib\n>   /builddir/TensorFlow/TensorFlow-2.x_mnist-test.py.runfiles/cuda_nvcc\n>   /buildi/cuda_nvcc\n>\n>   /usr/local/cuda\n>   /software/TensorFlow/lib/python3.12/site-packages/tensorflow/python/platform/../../../nvidia/cuda_nvcc\n>   /software/TensorFlow/lib/python3.12/site-packages/tensorflow/python/platform/../../../../nvidia/cuda_nvcc\n>   /software/TensorFlow/lib/python3.12/site-packages/tensorflow/python/platform/../../cuda\n\nConsider $CUDA_HOME as an additional location after the runfiles dirs (used for tests)\n\n--\n905d0596d199598036032f0f84b4487e9afd2bef by Alexander Grund <alexander.grund@tu-dresden.de>:\n\nDon't add empty TF_CUDA_TOOLKIT_PATH to libdevice search\n\nAt least in some environments that define is the empty string which\ndoesn't make sense to add to the search paths.\nAdd a check for that.\n\n--\n23eb59bfabd570caabf0b9ec3515233f46a4fae7 by Alexander Grund <alexander.grund@tu-dresden.de>:\n\nAdd test for $CUDA_HOME in CandidateCudaRoots\n\n--\na8c215bc222b4ba8581f2f44549613ebd59b9cbb by Alexander Grund <alexander.grund@tu-dresden.de>:\n\nAdd braces to loops/conditions\n\n--\n39efc67f8b1d44e131f993c8040b7eb69ff52f0c by Alexander Grund <alexander.grund@tu-dresden.de>:\n\nUse kIsOpenSource in skip condition\n\nMerging this change closes #31886\n\nPiperOrigin-RevId: 824450284",
    "sha": "9ec8d8ece3ad9e7f8379406d263330a5beb65d5b",
    "files": [
        {
            "sha": "2432b775fda6008a0ec36be94f3b04b98cd57b62",
            "filename": "third_party/xla/xla/stream_executor/cuda/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ec8d8ece3ad9e7f8379406d263330a5beb65d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ec8d8ece3ad9e7f8379406d263330a5beb65d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD?ref=9ec8d8ece3ad9e7f8379406d263330a5beb65d5b",
            "patch": "@@ -2142,10 +2142,12 @@ xla_cc_test(\n         \":cuda_platform\",\n         \":nvjitlink_support\",\n         \":ptx_compiler_support\",\n+        \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:status_matchers\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform\",\n         \"@local_tsl//tsl/platform:cuda_root_path\",\n         \"@local_tsl//tsl/platform:path\",\n     ],"
        },
        {
            "sha": "40c9e961bc0baef4fab9c297cce435f009dc14a6",
            "filename": "third_party/xla/xla/stream_executor/cuda/assemble_compilation_provider_test.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ec8d8ece3ad9e7f8379406d263330a5beb65d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fassemble_compilation_provider_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ec8d8ece3ad9e7f8379406d263330a5beb65d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fassemble_compilation_provider_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fassemble_compilation_provider_test.cc?ref=9ec8d8ece3ad9e7f8379406d263330a5beb65d5b",
            "patch": "@@ -25,10 +25,12 @@ limitations under the License.\n #include \"xla/stream_executor/cuda/compilation_provider_options.h\"\n #include \"xla/stream_executor/cuda/nvjitlink_support.h\"\n #include \"xla/stream_executor/cuda/ptx_compiler_support.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/status_matchers.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"tsl/platform/cuda_root_path.h\"\n #include \"tsl/platform/path.h\"\n+#include \"tsl/platform/platform.h\"\n \n namespace stream_executor::cuda {\n \n@@ -37,6 +39,16 @@ using ::testing::AllOf;\n using ::testing::HasSubstr;\n using ::tsl::testing::StatusIs;\n \n+TEST(AssembleCompilationProviderTest, CandidateCudaRootsConsidersCUDA_HOME) {\n+  const std::string cuda_home = \"/my/cuda/home\";\n+  tsl::setenv(\"CUDA_HOME\", cuda_home.c_str(), 1);\n+  if (!tsl::kIsOpenSource) {\n+    GTEST_SKIP()\n+        << \"CUDA_HOME is only being considered in the OSS build of XLA.\";\n+  }\n+  EXPECT_THAT(tsl::CandidateCudaRoots(), ::testing::Contains(cuda_home));\n+}\n+\n TEST(AssembleCompilationProviderTest,\n      ReturnsErrorIfNoCompilationProviderIsAvailable) {\n   if (!tsl::CandidateCudaRoots().empty()) {"
        },
        {
            "sha": "11462957d90fa3e8b1462a79f0ccda30fe4796fb",
            "filename": "third_party/xla/xla/tsl/platform/default/cuda_root_path.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 8,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ec8d8ece3ad9e7f8379406d263330a5beb65d5b/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fcuda_root_path.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ec8d8ece3ad9e7f8379406d263330a5beb65d5b/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fcuda_root_path.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fcuda_root_path.cc?ref=9ec8d8ece3ad9e7f8379406d263330a5beb65d5b",
            "patch": "@@ -56,14 +56,23 @@ std::vector<std::string> CandidateCudaRoots() {\n   // The CUDA candidate root for python targets.\n   std::string runfiles_dir = tsl::Env::Default()->GetRunfilesDir();\n   std::size_t runfiles_ind = runfiles_dir.rfind(runfiles_suffix);\n-  for (const std::string& cuda_dir_name : cuda_dir_names) {\n-    std::string cuda_dir = io::JoinPath(\n-        runfiles_dir.substr(0, runfiles_ind + runfiles_suffix.length()),\n-        cuda_dir_name);\n-    roots.push_back(cuda_dir);\n+  if (runfiles_ind != std::string::npos) {\n+    for (const std::string& cuda_dir_name : cuda_dir_names) {\n+      std::string cuda_dir = io::JoinPath(\n+          runfiles_dir.substr(0, runfiles_ind + runfiles_suffix.length()),\n+          cuda_dir_name);\n+      roots.push_back(cuda_dir);\n+    }\n   }\n \n-  roots.push_back(TF_CUDA_TOOLKIT_PATH);\n+  const char* cuda_home = getenv(\"CUDA_HOME\");\n+  if (cuda_home) {\n+    roots.emplace_back(cuda_home);\n+  }\n+  std::string cuda_toolkit_path = TF_CUDA_TOOLKIT_PATH;\n+  if (!cuda_toolkit_path.empty()) {\n+    roots.push_back(std::move(cuda_toolkit_path));\n+  }\n   roots.emplace_back(std::string(\"/usr/local/cuda\"));\n   roots.emplace_back(std::string(\"/opt/cuda\"));\n \n@@ -101,12 +110,15 @@ std::vector<std::string> CandidateCudaRoots() {\n     // $CONDA_PREFIX/lib/python3.12/site-packages/pkg_name, so if we want\n     // to add $CONDA_PREFIX to the candidate roots dirs we need to add\n     // ../../../..\n-    for (auto path : {\"../../../..\", \"../../../../..\"})\n+    for (auto path : {\"../../../..\", \"../../../../..\"}) {\n       roots.emplace_back(io::JoinPath(dir, path));\n+    }\n   }\n #endif  // defined(PLATFORM_POSIX) && !defined(__APPLE__)\n \n-  for (auto root : roots) VLOG(3) << \"CUDA root = \" << root;\n+  for (auto root : roots) {\n+    VLOG(3) << \"CUDA root = \" << root;\n+  }\n   return roots;\n #else   // !defined(PLATFORM_GOOGLE)\n   return {};"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 34,
        "deletions": 8
    }
}