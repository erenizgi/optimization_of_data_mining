{
    "author": "ZixuanJiang",
    "message": "Refactor spmd/shardy export_named_computations and import_func_calls.\n\nPiperOrigin-RevId: 825290126",
    "sha": "e3549cef96b6d932b16946fd6f756cbc658af047",
    "files": [
        {
            "sha": "2bfffd7b68a266024901c669511f5649ec7cf0ac",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e3549cef96b6d932b16946fd6f756cbc658af047/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e3549cef96b6d932b16946fd6f756cbc658af047/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2FBUILD?ref=e3549cef96b6d932b16946fd6f756cbc658af047",
            "patch": "@@ -58,7 +58,6 @@ cc_library(\n     srcs = [\"import_func_calls.cc\"],\n     hdrs = [\"import_func_calls.h\"],\n     deps = [\n-        \"//xla/service/spmd/shardy:constants\",\n         \"//xla/service/spmd/shardy:utils\",\n         \"@com_google_absl//absl/log:check\",\n         \"@llvm-project//llvm:Support\","
        },
        {
            "sha": "9fcac45b4451e1b793bc1eec0a1f7259798ff2e6",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/export_named_computations.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e3549cef96b6d932b16946fd6f756cbc658af047/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e3549cef96b6d932b16946fd6f756cbc658af047/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fexport_named_computations.cc?ref=e3549cef96b6d932b16946fd6f756cbc658af047",
            "patch": "@@ -54,12 +54,12 @@ namespace {\n using ::mlir::ArrayAttr;\n using ::mlir::ModuleOp;\n using ::mlir::NamedAttribute;\n+using ::mlir::StringAttr;\n using ::mlir::StringRef;\n using ::mlir::SymbolTable;\n using ::mlir::func::CallOp;\n using ::mlir::func::FuncOp;\n \n-using ::mlir::StringAttr;\n using ::mlir::sdy::kShardingAttr;\n using ::mlir::sdy::ManualAxesAttr;\n using ::mlir::sdy::NamedComputationOp;\n@@ -149,12 +149,11 @@ class ExportNamedComputationsPass\n     this->dedupFunctionsFully = other.dedupFunctionsFully;\n   }\n \n-  llvm::SmallDenseMap<ComputationKey, StringAttr> funcCache;\n-\n   void runOnOperation() final {\n     ModuleOp moduleOp = getOperation();\n     SymbolTable symbolTable(moduleOp);\n     mlir::Block& moduleBlock = moduleOp.getRegion().front();\n+    llvm::SmallDenseMap<ComputationKey, StringAttr> funcCache;\n \n     if (dedupFunctionsFully) {\n       using FuncNameKey = std::pair<StringRef, ManualAxesAttr>;"
        },
        {
            "sha": "99a6e6d167339b5732ba5a18c91d74c2a7718161",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/import_func_calls.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 16,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e3549cef96b6d932b16946fd6f756cbc658af047/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fimport_func_calls.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e3549cef96b6d932b16946fd6f756cbc658af047/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fimport_func_calls.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fimport_func_calls.cc?ref=e3549cef96b6d932b16946fd6f756cbc658af047",
            "patch": "@@ -25,7 +25,6 @@ limitations under the License.\n #include \"llvm/ADT/PostOrderIterator.h\"\n #include \"llvm/ADT/STLExtras.h\"\n #include \"llvm/ADT/StringRef.h\"\n-#include \"llvm/Support/CommandLine.h\"\n #include \"llvm/Support/FormatVariadic.h\"\n #include \"llvm/Support/Threading.h\"\n #include \"mlir/Analysis/CallGraph.h\"\n@@ -46,7 +45,6 @@ limitations under the License.\n #include \"shardy/dialect/sdy/ir/constants.h\"\n #include \"shardy/dialect/sdy/ir/dialect.h\"\n #include \"shardy/dialect/sdy/ir/utils.h\"\n-#include \"xla/service/spmd/shardy/constants.h\"\n #include \"xla/service/spmd/shardy/utils.h\"\n \n namespace xla {\n@@ -65,15 +63,6 @@ using ::mlir::sdy::NamedComputationOp;\n using ::mlir::sdy::TensorShardingAttr;\n using ::mlir::sdy::TensorShardingPerValueAttr;\n \n-bool isInlineableCallOp(CallOp callOp) {\n-  if (hasFrontendAttr(callOp, kXlaBackendConfigAttr)) {\n-    return false;\n-  }\n-  auto inlineableAttr =\n-      tryGetFrontendAttr<mlir::BoolAttr>(callOp, kXlaInlineableAttr);\n-  return !inlineableAttr || inlineableAttr->getValue();\n-}\n-\n // Returns the first non-maximal mesh on the argument shardings, if there is\n // one. Otherwise returns `std::nullopt`.\n // TODO(enver): Move to utils and potentially with a common helper that takes an\n@@ -130,11 +119,10 @@ void importCallOp(\n   rewriter.setInsertionPoint(callOp);\n   TensorShardingPerValueAttr callOpResultShardings =\n       mlir::sdy::getShardingPerValue(callOp);\n-  auto namedCompOp = rewriter.create<NamedComputationOp>(\n-      callOp->getLoc(), callOp->getResultTypes(), calleeName,\n+  auto namedCompOp = NamedComputationOp::create(\n+      rewriter, callOp->getLoc(), callOp->getResultTypes(), calleeName,\n       callOp.getOperands(),\n-      /*inShardings=*/\n-      getFuncArgShardings(callOp, funcOp, symbolTable),\n+      /*inShardings=*/getFuncArgShardings(callOp, funcOp, symbolTable),\n       // TODO(b/439018088): Take func result shardings if call op result\n       // shardings are empty.\n       /*outShardings=*/\n@@ -187,7 +175,9 @@ class ImportFuncCallsPass\n     mlir::CallGraph callGraph(moduleOp);\n     llvm::ReversePostOrderTraversal<const mlir::CallGraph*> rpo(&callGraph);\n     for (mlir::CallGraphNode* node : llvm::reverse(rpo)) {\n-      if (node->isExternal()) continue;\n+      if (node->isExternal()) {\n+        continue;\n+      }\n       node->getCallableRegion()->walk([&](CallOp op) {\n         importCallOp(op, calleeNameToMovedRegion, rewriter, symbolTable);\n       });"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 8,
        "deletions": 20
    }
}