{
    "author": "zacmustin",
    "message": "Add `ComputeTotalAllocationBytes` to `buffer_assignment`.\n\nLater, we'll add this metric to `CompiledMemoryStats`. This is based on the existing implementation in xprof (which will be updated to use this function in a follow-up change).\n\nPiperOrigin-RevId: 840855822",
    "sha": "0886e68ea702adf1bd5df465b8aa9d73c7ab96c2",
    "files": [
        {
            "sha": "5446e720cc2e815338a6bc1d7cb0c540298407c5",
            "filename": "third_party/xla/xla/service/buffer_assignment.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0886e68ea702adf1bd5df465b8aa9d73c7ab96c2/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0886e68ea702adf1bd5df465b8aa9d73c7ab96c2/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc?ref=0886e68ea702adf1bd5df465b8aa9d73c7ab96c2",
            "patch": "@@ -2445,6 +2445,17 @@ int64_t AllocateStaticBuffers(BufferMap& buffers,\n \n }  // namespace\n \n+int64_t ComputeTotalAllocationBytes(const BufferAssignmentProto& proto,\n+                                    int64_t memory_color) {\n+  int64_t total_allocation_bytes = 0;\n+  for (const auto& alloc : proto.buffer_allocations()) {\n+    if (alloc.color() == memory_color) {\n+      total_allocation_bytes += alloc.size();\n+    }\n+  }\n+  return total_allocation_bytes;\n+}\n+\n absl::StatusOr<int64_t> ComputePeakMemory(const BufferAssignmentProto& proto) {\n   BufferMap buffers(proto);\n "
        },
        {
            "sha": "709833efe983367415185f2d62b3f6fa5a406900",
            "filename": "third_party/xla/xla/service/buffer_assignment.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0886e68ea702adf1bd5df465b8aa9d73c7ab96c2/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0886e68ea702adf1bd5df465b8aa9d73c7ab96c2/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.h?ref=0886e68ea702adf1bd5df465b8aa9d73c7ab96c2",
            "patch": "@@ -879,6 +879,11 @@ class BufferAssigner {\n // Computes the peak memory usage through the proto's heap simulator traces.\n absl::StatusOr<int64_t> ComputePeakMemory(const BufferAssignmentProto& proto);\n \n+// Computes the total memory allocated by the buffer assignment for a given\n+// color.\n+int64_t ComputeTotalAllocationBytes(const BufferAssignmentProto& proto,\n+                                    int64_t memory_color);\n+\n }  // namespace xla\n \n #endif  // XLA_SERVICE_BUFFER_ASSIGNMENT_H_"
        },
        {
            "sha": "31a0cc1c4d5e32280b70b5d5f2c17aee45c0f516",
            "filename": "third_party/xla/xla/service/buffer_assignment_test.cc",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0886e68ea702adf1bd5df465b8aa9d73c7ab96c2/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0886e68ea702adf1bd5df465b8aa9d73c7ab96c2/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment_test.cc?ref=0886e68ea702adf1bd5df465b8aa9d73c7ab96c2",
            "patch": "@@ -4220,5 +4220,57 @@ TEST(ComputePeakMemoryTest, LargeResult) {\n   EXPECT_EQ(*ComputePeakMemory(proto), 1LL << 33);\n }\n \n+TEST(ComputeTotalAllocationBytesTest, EmptyProto) {\n+  BufferAssignmentProto proto;\n+  EXPECT_EQ(ComputeTotalAllocationBytes(proto, /*memory_color=*/0), 0);\n+}\n+\n+TEST(ComputeTotalAllocationBytesTest, NonMatchingColorAllocations) {\n+  BufferAssignmentProto proto;\n+  BufferAllocationProto* alloc1 = proto.add_buffer_allocations();\n+  alloc1->set_size(10);\n+  alloc1->set_color(1);\n+  BufferAllocationProto* alloc2 = proto.add_buffer_allocations();\n+  alloc2->set_size(20);\n+  alloc2->set_color(2);\n+  EXPECT_EQ(ComputeTotalAllocationBytes(proto, /*memory_color=*/0), 0);\n+}\n+\n+TEST(ComputeTotalAllocationBytesTest, OnlyMatchingColorAllocations) {\n+  BufferAssignmentProto proto;\n+  BufferAllocationProto* alloc1 = proto.add_buffer_allocations();\n+  alloc1->set_size(10);\n+  alloc1->set_color(0);\n+  BufferAllocationProto* alloc2 = proto.add_buffer_allocations();\n+  alloc2->set_size(20);\n+  alloc2->set_color(0);\n+  EXPECT_EQ(ComputeTotalAllocationBytes(proto, /*memory_color=*/0), 30);\n+}\n+\n+TEST(ComputeTotalAllocationBytesTest, MixedColorAllocations) {\n+  BufferAssignmentProto proto;\n+  BufferAllocationProto* alloc1 = proto.add_buffer_allocations();\n+  alloc1->set_size(10);\n+  alloc1->set_color(0);\n+  BufferAllocationProto* alloc2 = proto.add_buffer_allocations();\n+  alloc2->set_size(20);\n+  alloc2->set_color(1);\n+  BufferAllocationProto* alloc3 = proto.add_buffer_allocations();\n+  alloc3->set_size(30);\n+  alloc3->set_color(0);\n+  EXPECT_EQ(ComputeTotalAllocationBytes(proto, /*memory_color=*/0), 40);\n+}\n+\n+TEST(ComputeTotalAllocationBytesTest, LargeAllocations) {\n+  BufferAssignmentProto proto;\n+  BufferAllocationProto* alloc1 = proto.add_buffer_allocations();\n+  alloc1->set_size(1LL << 33);\n+  alloc1->set_color(0);\n+  BufferAllocationProto* alloc3 = proto.add_buffer_allocations();\n+  alloc3->set_size(1LL << 33);\n+  alloc3->set_color(0);\n+  EXPECT_EQ(ComputeTotalAllocationBytes(proto, /*memory_color=*/0), 1LL << 34);\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 68,
        "deletions": 0
    }
}