{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Move offset correction logic in a helper function.\n\nPiperOrigin-RevId: 822572708",
    "sha": "53499fe9d0cf31f72d8f108059f737d753ca0a97",
    "files": [
        {
            "sha": "ac384dd99f8fb389634c821b9eae8aa4f522baa0",
            "filename": "third_party/xla/xla/service/gpu/transforms/ragged_all_to_all_multi_host_decomposer.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 26,
            "changes": 59,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53499fe9d0cf31f72d8f108059f737d753ca0a97/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fragged_all_to_all_multi_host_decomposer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53499fe9d0cf31f72d8f108059f737d753ca0a97/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fragged_all_to_all_multi_host_decomposer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fragged_all_to_all_multi_host_decomposer.cc?ref=53499fe9d0cf31f72d8f108059f737d753ca0a97",
            "patch": "@@ -49,6 +49,38 @@ namespace xla {\n namespace gpu {\n using hlo_query::NextChannelId;\n \n+// Corrects the offsets in the local metadata to account for the number of input\n+// rows in the combined ragged tensor.\n+HloInstruction* CorrectOffsets(HloRaggedAllToAllInstruction* ragged_all_to_all,\n+                               HloInstruction* local_metadata,\n+                               HloComputation* computation) {\n+  const Shape& shape = local_metadata->shape();\n+\n+  HloInstruction* iota = computation->AddInstruction(\n+      HloInstruction::CreateIota(/*shape=*/shape, /*iota_dimension=*/0));\n+\n+  int64_t num_input_rows = ragged_all_to_all->operand(0)->shape().dimensions(0);\n+\n+  HloInstruction* num_input_rows_constant =\n+      computation->AddInstruction(HloInstruction::CreateConstant(\n+          LiteralUtil::CreateR0<int64_t>(num_input_rows)));\n+\n+  HloInstruction* num_input_rows_constant_broadcast =\n+      computation->AddInstruction(HloInstruction::CreateBroadcast(\n+          /*shape=*/shape, num_input_rows_constant,\n+          /*broadcast_dimensions=*/{}));\n+\n+  HloInstruction* input_offsets_offset =\n+      computation->AddInstruction(HloInstruction::CreateBinary(\n+          /*shape=*/shape, HloOpcode::kMultiply,\n+          /*lhs=*/iota, /*rhs=*/num_input_rows_constant_broadcast));\n+\n+  return computation->AddInstruction(HloInstruction::CreateBinary(\n+      /*shape=*/shape, HloOpcode::kAdd,\n+      /*lhs=*/local_metadata,\n+      /*rhs=*/input_offsets_offset));\n+}\n+\n // Exchanges the metadata between the hosts and computes the intra-host\n // metadata.\n //\n@@ -88,33 +120,8 @@ HloInstruction* GetIntraHostMetadata(\n           /*split_dimension=*/0));\n \n   if (correct_offsets) {\n-    HloInstruction* iota =\n-        computation->AddInstruction(HloInstruction::CreateIota(\n-            /*shape=*/new_metadata_shape,\n-            /*iota_dimension=*/0));\n-\n-    int64_t num_input_rows =\n-        ragged_all_to_all->operand(0)->shape().dimensions(0);\n-\n-    HloInstruction* num_input_rows_constant =\n-        computation->AddInstruction(HloInstruction::CreateConstant(\n-            LiteralUtil::CreateR0<int64_t>(num_input_rows)));\n-\n-    HloInstruction* num_input_rows_constant_broadcast =\n-        computation->AddInstruction(HloInstruction::CreateBroadcast(\n-            /*shape=*/new_metadata_shape, num_input_rows_constant,\n-            /*broadcast_dimensions=*/{}));\n-\n-    HloInstruction* input_offsets_offset =\n-        computation->AddInstruction(HloInstruction::CreateBinary(\n-            /*shape=*/new_metadata_shape, HloOpcode::kMultiply,\n-            /*lhs=*/iota, /*rhs=*/num_input_rows_constant_broadcast));\n-\n     new_local_metadata =\n-        computation->AddInstruction(HloInstruction::CreateBinary(\n-            /*shape=*/new_metadata_shape, HloOpcode::kAdd,\n-            /*lhs=*/new_local_metadata,\n-            /*rhs=*/input_offsets_offset));\n+        CorrectOffsets(ragged_all_to_all, new_local_metadata, computation);\n   }\n \n   HloInstruction* new_local_metadata_transposed ="
        }
    ],
    "stats": {
        "total": 59,
        "additions": 33,
        "deletions": 26
    }
}