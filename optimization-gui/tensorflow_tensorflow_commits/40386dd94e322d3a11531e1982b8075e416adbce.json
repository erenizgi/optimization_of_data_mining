{
    "author": "WillFroom",
    "message": "[XLA:CPU][XTile] Convert tensor.bitcast to arith.bitcast to enable bufferization.\n\nAlso remove the conversion of tensor.extract/insert lowering as these can be directly bufferized.\n\nPiperOrigin-RevId: 834206040",
    "sha": "40386dd94e322d3a11531e1982b8075e416adbce",
    "files": [
        {
            "sha": "1547aca1e3dc8e1ab5cf02bfc5e9404e5b9ea85b",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_compiler.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_compiler.cc?ref=40386dd94e322d3a11531e1982b8075e416adbce",
            "patch": "@@ -317,7 +317,7 @@ static void AddTiledOptimizationPasses(mlir::OpPassManager& pm) {\n   pm.addNestedPass<mlir::func::FuncOp>(\n       mlir::vector::createLowerVectorMultiReductionPass(\n           mlir::vector::VectorMultiReductionLowering::InnerParallel));\n-  pm.addPass(CreateTensorOpsToVectorPass());\n+  pm.addPass(CreateTensorOpsToBufferizablePass());\n \n   pm.addPass(mlir::createConvertElementwiseToLinalgPass());\n   pm.addPass(CreateFuseElementwisePass());"
        },
        {
            "sha": "dc8e309136bf7edb558fbb1c26c4997d0665381d",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2FBUILD?ref=40386dd94e322d3a11531e1982b8075e416adbce",
            "patch": "@@ -53,7 +53,7 @@ cc_library(\n         \"lower_xtile_entry.cc\",\n         \"memref_copy_to_loops.cc\",\n         \"shlo_to_vector.cc\",\n-        \"tensor_ops_to_vector.cc\",\n+        \"tensor_ops_to_bufferizable.cc\",\n     ],\n     hdrs = [\"passes.h\"],\n     deps = ["
        },
        {
            "sha": "bd6c8170a6e523f66af1471421222bbad5efb86f",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/passes.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fpasses.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fpasses.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fpasses.h?ref=40386dd94e322d3a11531e1982b8075e416adbce",
            "patch": "@@ -37,7 +37,7 @@ namespace xla::cpu {\n std::unique_ptr<mlir::Pass> CreateLinalgElementwiseToVectorPass();\n std::unique_ptr<mlir::Pass> CreateLowerXTileEntryPass();\n std::unique_ptr<mlir::Pass> CreateShloToVectorPass();\n-std::unique_ptr<mlir::Pass> CreateTensorOpsToVectorPass();\n+std::unique_ptr<mlir::Pass> CreateTensorOpsToBufferizablePass();\n std::unique_ptr<mlir::Pass> CreateMemrefCopyToLoopsPass();\n std::unique_ptr<mlir::Pass> CreateFuseElementwisePass();\n "
        },
        {
            "sha": "0ab6c15b37125cd737642797a684bdc46ed66450",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/passes.td",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fpasses.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fpasses.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fpasses.td?ref=40386dd94e322d3a11531e1982b8075e416adbce",
            "patch": "@@ -56,14 +56,19 @@ def LinalgElementwiseToVectorPass : Pass<\"xtile-cpu-linalg-elementwise-to-vector\n   ];\n }\n \n-def TensorOpsToVectorPass : Pass<\"xtile-cpu-tensor-ops-to-vector\",\n+def TensorOpsToBufferizablePass : Pass<\"xtile-cpu-tensor-ops-to-bufferizable\",\n                                  \"mlir::ModuleOp\"> {\n-  let summary = \"Lowering tensor dialect ops to vector ops\";\n+  let summary = \"Lowering tensor dialect ops to bufferizable ops\";\n \n-  let constructor = \"CreateTensorOpsToVectorPass()\";\n+  let description = [{\n+    Some tensor ops such as bitcast are not directly bufferizable. This pass\n+    lowers such ops to ops that have bufferization support.\n+  }];\n+\n+  let constructor = \"CreateTensorOpsToBufferizablePass()\";\n \n   let dependentDialects = [\n-    \"mlir::vector::VectorDialect\",\n+    \"mlir::arith::ArithDialect\",\n   ];\n }\n "
        },
        {
            "sha": "69c45ca69964d9c7a87ab901498092b6ae08fcd1",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/tensor_ops_to_bufferizable.cc",
            "status": "renamed",
            "additions": 13,
            "deletions": 39,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftensor_ops_to_bufferizable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftensor_ops_to_bufferizable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftensor_ops_to_bufferizable.cc?ref=40386dd94e322d3a11531e1982b8075e416adbce",
            "patch": "@@ -17,74 +17,48 @@ limitations under the License.\n #include <memory>\n #include <utility>\n \n-#include \"llvm/ADT/SmallVector.h\"\n #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n #include \"mlir/Dialect/LLVMIR/LLVMDialect.h\"  // IWYU pragma: keep\n #include \"mlir/Dialect/Tensor/IR/Tensor.h\"\n #include \"mlir/Dialect/Vector/IR/VectorOps.h\"\n #include \"mlir/IR/AffineExpr.h\"\n-#include \"mlir/IR/Builders.h\"\n-#include \"mlir/IR/BuiltinAttributes.h\"\n-#include \"mlir/IR/BuiltinOps.h\"\n-#include \"mlir/IR/BuiltinTypes.h\"\n #include \"mlir/IR/MLIRContext.h\"\n-#include \"mlir/IR/OpDefinition.h\"\n #include \"mlir/IR/PatternMatch.h\"\n-#include \"mlir/IR/Value.h\"\n-#include \"mlir/IR/Visitors.h\"\n #include \"mlir/Pass/Pass.h\"\n #include \"mlir/Support/LLVM.h\"\n #include \"mlir/Transforms/GreedyPatternRewriteDriver.h\"\n-#include \"xla/backends/cpu/codegen/tiled/transforms/lowering_utils.h\"\n #include \"xla/backends/cpu/codegen/tiled/transforms/passes.h\"\n \n namespace xla::cpu {\n \n-#define GEN_PASS_DECL_TENSOROPSTOVECTORPASS\n-#define GEN_PASS_DEF_TENSOROPSTOVECTORPASS\n+#define GEN_PASS_DECL_TENSOROPSTOBUFFERIZABLEPASS\n+#define GEN_PASS_DEF_TENSOROPSTOBUFFERIZABLEPASS\n #include \"xla/backends/cpu/codegen/tiled/transforms/passes.h.inc\"\n \n namespace {\n \n-struct LowerFromElements\n-    : mlir::OpRewritePattern<mlir::tensor::FromElementsOp> {\n+struct TensorToArithBitcast : mlir::OpRewritePattern<mlir::tensor::BitcastOp> {\n   using OpRewritePattern::OpRewritePattern;\n \n   mlir::LogicalResult matchAndRewrite(\n-      mlir::tensor::FromElementsOp op,\n+      mlir::tensor::BitcastOp op,\n       mlir::PatternRewriter& rewriter) const override {\n-    mlir::VectorType vector_type = GetVectorType(op.getType());\n-    mlir::Value vector_from_elements =\n-        rewriter.create<mlir::vector::FromElementsOp>(op.getLoc(), vector_type,\n-                                                      op->getOperands());\n-    rewriter.replaceOp(op, WriteVectorToTensor(rewriter, vector_from_elements));\n+    rewriter.replaceOpWithNewOp<mlir::arith::BitcastOp>(op, op.getType(),\n+                                                        op.getOperand());\n     return mlir::success();\n   }\n };\n \n-struct LowerExtract : mlir::OpRewritePattern<mlir::tensor::ExtractOp> {\n-  using OpRewritePattern::OpRewritePattern;\n-\n-  mlir::LogicalResult matchAndRewrite(\n-      mlir::tensor::ExtractOp op,\n-      mlir::PatternRewriter& rewriter) const override {\n-    mlir::Value vector_input = ReadTensorToVector(rewriter, op.getTensor());\n-    llvm::SmallVector<mlir::OpFoldResult> indices(op.getIndices());\n-    rewriter.replaceOpWithNewOp<mlir::vector::ExtractOp>(op, vector_input,\n-                                                         indices);\n-    return mlir::success();\n-  }\n-};\n-\n-class TensorOpsToVectorPass\n-    : public impl::TensorOpsToVectorPassBase<TensorOpsToVectorPass> {\n+class TensorOpsToBufferizablePass\n+    : public impl::TensorOpsToBufferizablePassBase<\n+          TensorOpsToBufferizablePass> {\n  public:\n-  using TensorOpsToVectorPassBase::TensorOpsToVectorPassBase;\n+  using TensorOpsToBufferizablePassBase::TensorOpsToBufferizablePassBase;\n \n   void runOnOperation() override {\n     mlir::MLIRContext* context = &getContext();\n     mlir::RewritePatternSet patterns(context);\n-    patterns.add<LowerFromElements, LowerExtract>(context);\n+    patterns.add<TensorToArithBitcast>(context);\n     if (mlir::failed(\n             mlir::applyPatternsGreedily(getOperation(), std::move(patterns)))) {\n       signalPassFailure();\n@@ -95,8 +69,8 @@ class TensorOpsToVectorPass\n \n }  // namespace\n \n-std::unique_ptr<mlir::Pass> CreateTensorOpsToVectorPass() {\n-  return std::make_unique<TensorOpsToVectorPass>();\n+std::unique_ptr<mlir::Pass> CreateTensorOpsToBufferizablePass() {\n+  return std::make_unique<TensorOpsToBufferizablePass>();\n }\n \n }  // namespace xla::cpu",
            "previous_filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/tensor_ops_to_vector.cc"
        },
        {
            "sha": "ea6c7d81a9003bde352e337f7cd697c3b10c0113",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/tests/tensor_ops_to_bufferizable.mlir",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Ftensor_ops_to_bufferizable.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40386dd94e322d3a11531e1982b8075e416adbce/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Ftensor_ops_to_bufferizable.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Ftensor_ops_to_bufferizable.mlir?ref=40386dd94e322d3a11531e1982b8075e416adbce",
            "patch": "@@ -0,0 +1,9 @@\n+// RUN: fusion_compiler_opt %s -xtile-cpu-tensor-ops-to-bufferizable -split-input-file | FileCheck %s\n+\n+\n+func.func @bitcast(%arg0 : tensor<8xf32>) -> tensor<8xi32> {\n+  // CHECK: %[[RESULT:.*]] = arith.bitcast %arg0 : tensor<8xf32> to tensor<8xi32>\n+  %result = arith.bitcast %arg0 : tensor<8xf32> to tensor<8xi32>\n+  // CHECK: return %[[RESULT]] : tensor<8xi32>\n+  return %result : tensor<8xi32>\n+}"
        },
        {
            "sha": "c091c0256fb38bad880ed2dfe88e81f2f4cfd5cd",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/tests/tensor_ops_to_vector.mlir",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e71ac2b3abcb4e6da677cda5a09caa7f9a0800ec/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Ftensor_ops_to_vector.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e71ac2b3abcb4e6da677cda5a09caa7f9a0800ec/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Ftensor_ops_to_vector.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Ftensor_ops_to_vector.mlir?ref=e71ac2b3abcb4e6da677cda5a09caa7f9a0800ec",
            "patch": "@@ -1,15 +0,0 @@\n-// RUN: fusion_compiler_opt %s -xtile-cpu-tensor-ops-to-vector -split-input-file | FileCheck %s\n-\n-func.func @from_elements(%input : f32) -> tensor<f32> {\n-  // CHECK: vector.from_elements %{{.*}} : vector<f32>\n-  %result = tensor.from_elements %input : tensor<f32>\n-  return %result : tensor<f32>\n-}\n-\n-// -----\n-\n-func.func @extract(%input : tensor<f32>) -> f32 {\n-  // CHECK: vector.extract %{{.*}}[] : f32 from vector<f32>\n-  %result = tensor.extract %input[] : tensor<f32>\n-  return %result : f32\n-}"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 34,
        "deletions": 61
    }
}