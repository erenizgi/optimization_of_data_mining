{
    "author": "GleasonK",
    "message": "[StableHLO Optim] Fix broadcast->transpose pattern to properly compute permutation\n\nPiperOrigin-RevId: 810902711",
    "sha": "7ddac23a24c52aec89b832429e3047fc8dbef792",
    "files": [
        {
            "sha": "b13930741d251d2690bcb9240cde87cdcc56edf7",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7ddac23a24c52aec89b832429e3047fc8dbef792/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7ddac23a24c52aec89b832429e3047fc8dbef792/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=7ddac23a24c52aec89b832429e3047fc8dbef792",
            "patch": "@@ -699,6 +699,24 @@ diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.ml\n  }\n  \n  // -----\n+diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir b/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir\n+--- stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir\n++++ stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir\n+@@ -98,6 +98,14 @@\n+ \n+   // CHECK-NEXT: return [[ARG0]], [[R4]]\n+   return %3, %4 : tensor<3x3xi32>, tensor<3x3xi32>\n++}\n++\n++// CHECK-LABEL: func.func @broadcast_in_dim_transpose_invert\n++// CHECK-SAME:   ([[ARG0:%.+]]: tensor<1x2x3x4xf32>)\n++func.func @broadcast_in_dim_transpose_invert(%arg0 : tensor<1x2x3x4xf32>) -> tensor<3x1x4x2xf32> {\n++  // stablehlo.transpose %arg0, dims = [2, 0, 3, 1] : (tensor<1x2x3x4xf32>) -> tensor<3x1x4x2xf32>\n++  %0 = stablehlo.broadcast_in_dim %arg0, dims = [1,3,0,2] : (tensor<1x2x3x4xf32>) -> tensor<3x1x4x2xf32>\n++  return %0 : tensor<3x1x4x2xf32>\n+ }\n+ \n+ // CHECK-LABEL: func.func @broadcast_in_dim_nested\n diff --ruN a/stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp b/stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp\n --- stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp\n +++ stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp\n@@ -1390,4 +1408,48 @@ diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFold\n                  FoldTransposeOpPattern,               //\n                  FoldWhileOpIfDeadAndPresumedPure,     //\n                  FoldWhileOpPattern,                   //\n+diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplification.cpp b/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplification.cpp\n+--- stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplification.cpp\n++++ stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplification.cpp\n+@@ -325,8 +325,18 @@\n+ //////////////////////////////////\n+ // BroadcastInDimOp\n+ /////////////////////////////////\n+-\n+ // Used in DRR file.\n++\n++// Convert broadcast dimensions into permutation for transpose.\n++DenseI64ArrayAttr getInvertedBroadcastDimensions(OpBuilder& b,\n++                                                 ArrayRef<int64_t> dims) {\n++  SmallVector<int64_t> permutation(dims.size());\n++  for (auto i = 0; i < dims.size(); ++i) {\n++    permutation[dims[i]] = i;\n++  }\n++  return b.getDenseI64ArrayAttr(permutation);\n++}\n++\n+ DenseI64ArrayAttr getMergedBroadcastDimensions(OpBuilder& b,\n+                                                ArrayRef<int64_t> dims,\n+                                                ArrayRef<int64_t> dimsParent) {\n+diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td b/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td\n+--- stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td\n++++ stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td\n+@@ -116,6 +116,8 @@\n+ \n+ def GetEmptyI64Array : NativeCodeCall<\"$_builder.getDenseI64ArrayAttr({})\">;\n+ \n++def InvertBroadcastDims : NativeCodeCall<\"getInvertedBroadcastDimensions($_builder, $0)\">;\n++\n+ def MergeBroadcastDims : NativeCodeCall<\"getMergedBroadcastDimensions($_builder, $0, $1)\">;\n+ \n+ def StableHLO_ConvertOpWithShape : NativeCodeCall<\n+@@ -193,7 +195,7 @@\n+ //          [if same numel & rank]\n+ def BroadcastInDimOp_ReplaceWithTranspose\n+   : Pat<(StableHLO_BroadcastInDimOp:$op $operand, $dims),\n+-        (StableHLO_TransposeOp $operand, $dims),\n++        (StableHLO_TransposeOp $operand, (InvertBroadcastDims $dims)),\n+         [(NumberOfElementsEqual $op, $operand), (RankEqual $op, $operand)]>;\n+ \n+ ////////\n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 62,
        "deletions": 0
    }
}