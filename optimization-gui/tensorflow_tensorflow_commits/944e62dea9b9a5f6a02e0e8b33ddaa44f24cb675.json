{
    "author": "allanrenucci",
    "message": "[NFC] Simplify mutex usages in `PluginRegistry`.\n\nPiperOrigin-RevId: 799918759",
    "sha": "944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675",
    "files": [
        {
            "sha": "471bb6c87f6f5fd79fe853cb3034eb58a8f299ed",
            "filename": "third_party/xla/xla/stream_executor/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD?ref=944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675",
            "patch": "@@ -652,7 +652,6 @@ cc_library(\n         \":dnn\",\n         \":fft\",\n         \":platform\",\n-        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\","
        },
        {
            "sha": "ffb263899f073c93e045c7c851777903f7c860c8",
            "filename": "third_party/xla/xla/stream_executor/plugin_registry.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 16,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675/third_party%2Fxla%2Fxla%2Fstream_executor%2Fplugin_registry.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675/third_party%2Fxla%2Fxla%2Fstream_executor%2Fplugin_registry.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fplugin_registry.cc?ref=944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675",
            "patch": "@@ -18,7 +18,6 @@ limitations under the License.\n #include <optional>\n #include <string>\n \n-#include \"absl/base/const_init.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n@@ -43,28 +42,16 @@ std::string PluginKindString(PluginKind plugin_kind) {\n   }\n }\n \n-static absl::Mutex& GetPluginRegistryMutex() {\n-  static absl::Mutex mu(absl::kConstInit);\n-  return mu;\n-}\n-\n-/* static */ PluginRegistry* PluginRegistry::instance_ = nullptr;\n-\n-PluginRegistry::PluginRegistry() {}\n-\n /* static */ PluginRegistry* PluginRegistry::Instance() {\n-  absl::MutexLock lock{&GetPluginRegistryMutex()};\n-  if (instance_ == nullptr) {\n-    instance_ = new PluginRegistry();\n-  }\n-  return instance_;\n+  static PluginRegistry* instance = new PluginRegistry();\n+  return instance;\n }\n \n template <typename FACTORY_TYPE>\n absl::Status PluginRegistry::RegisterFactoryInternal(\n     const std::string& plugin_name, FACTORY_TYPE factory,\n     std::optional<FACTORY_TYPE>* factories) {\n-  absl::MutexLock lock{&GetPluginRegistryMutex()};\n+  absl::MutexLock lock(&registry_mutex_);\n \n   if (factories->has_value()) {\n     return absl::AlreadyExistsError("
        },
        {
            "sha": "944aa0b1fb8467fec9bd78aaedb1f9a6576084d5",
            "filename": "third_party/xla/xla/stream_executor/plugin_registry.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675/third_party%2Fxla%2Fxla%2Fstream_executor%2Fplugin_registry.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675/third_party%2Fxla%2Fxla%2Fstream_executor%2Fplugin_registry.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fplugin_registry.h?ref=944e62dea9b9a5f6a02e0e8b33ddaa44f24cb675",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n \n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/synchronization/mutex.h\"\n #include \"xla/stream_executor/blas.h\"\n #include \"xla/stream_executor/dnn.h\"\n #include \"xla/stream_executor/fft.h\"\n@@ -85,7 +86,7 @@ class PluginRegistry {\n     std::optional<FftFactory> fft;\n   };\n \n-  PluginRegistry();\n+  PluginRegistry() = default;\n \n   // Actually performs the work of registration.\n   template <typename FactoryT>\n@@ -98,14 +99,13 @@ class PluginRegistry {\n   // not implicitly examine the default factory lists.\n   bool HasFactory(const Factories& factories, PluginKind plugin_kind) const;\n \n-  // The singleton itself.\n-  static PluginRegistry* instance_;\n-\n   // The set of registered factories, keyed by platform ID.\n   std::map<Platform::Id, Factories> factories_;\n \n   PluginRegistry(const PluginRegistry&) = delete;\n   void operator=(const PluginRegistry&) = delete;\n+\n+  absl::Mutex registry_mutex_;\n };\n \n // Explicit specializations are defined in plugin_registry.cc."
        }
    ],
    "stats": {
        "total": 28,
        "additions": 7,
        "deletions": 21
    }
}