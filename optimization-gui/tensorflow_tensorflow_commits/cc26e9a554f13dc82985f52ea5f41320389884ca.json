{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Keep explanation and location separate in FusionDecision.\n\nCurrent logic didn't work nicely for streaming operator (<<), because it was concatenating a new location at every call and resulted in unreadable error message.\n\nThis change also adds a SourceLocationHolder to limit `#if defined(PLATFORM_GOOGLE)` usage.\n\nPiperOrigin-RevId: 841764270",
    "sha": "cc26e9a554f13dc82985f52ea5f41320389884ca",
    "files": [
        {
            "sha": "b8b6a62ec06674f725b9ef990dbb103a2c6b814d",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cc26e9a554f13dc82985f52ea5f41320389884ca/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cc26e9a554f13dc82985f52ea5f41320389884ca/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=cc26e9a554f13dc82985f52ea5f41320389884ca",
            "patch": "@@ -1977,6 +1977,7 @@ cc_library(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\",\n         \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:macros\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\","
        },
        {
            "sha": "f4e84b7e5859699585157c92aff709b7b9d80a1a",
            "filename": "third_party/xla/xla/service/instruction_fusion.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cc26e9a554f13dc82985f52ea5f41320389884ca/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cc26e9a554f13dc82985f52ea5f41320389884ca/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.cc?ref=cc26e9a554f13dc82985f52ea5f41320389884ca",
            "patch": "@@ -56,18 +56,6 @@ limitations under the License.\n #include \"xla/util.h\"\n \n namespace xla {\n-\n-#if defined(PLATFORM_GOOGLE)\n-FusionDecision::FusionDecision(bool decision,\n-                               absl::SourceLocation source_location) {\n-  if (!decision) {\n-    explanation_ =\n-        absl::StrCat(\"Not fusing: due to \", source_location.file_name(), \":\",\n-                     source_location.line());\n-  }\n-}\n-#endif  // PLATFORM_GOOGLE\n-\n namespace {\n \n // These nodes can always be duplicated into consumers, even if"
        },
        {
            "sha": "d5ad1b7c17e1a6be72a9eca23661a7bb24620a0e",
            "filename": "third_party/xla/xla/service/instruction_fusion.h",
            "status": "modified",
            "additions": 43,
            "deletions": 47,
            "changes": 90,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cc26e9a554f13dc82985f52ea5f41320389884ca/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cc26e9a554f13dc82985f52ea5f41320389884ca/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.h?ref=cc26e9a554f13dc82985f52ea5f41320389884ca",
            "patch": "@@ -21,18 +21,14 @@ limitations under the License.\n #include <memory>\n #include <optional>\n #include <string>\n-#include <utility>\n #include <vector>\n \n-#include \"absl/container/flat_hash_map.h\"\n-#include \"absl/container/flat_hash_set.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/service/hlo_module_config.h\"\n-#include \"tsl/platform/macros.h\"\n // The source_location.h is not available in open source.\n #if defined(PLATFORM_GOOGLE)\n #include \"absl/types/source_location.h\"\n@@ -54,41 +50,59 @@ struct InPlaceFusionOptions {\n   bool relax_multiple_non_elementwise_ops = false;\n };\n \n+// A holder for the source location. absl::SourceLocation is not available in\n+// open source, so we have a stub implementation to limit\n+// #if define(PLATFORM_GOOGLE).\n+class SourceLocationHolder {\n+ public:\n+#if defined(PLATFORM_GOOGLE)\n+  explicit constexpr SourceLocationHolder(\n+      absl::SourceLocation source_location = absl::SourceLocation::current())\n+      : source_location_(source_location) {}\n+\n+  std::string ToString() const {\n+    return absl::StrCat(\" at: \", source_location_.file_name(), \":\",\n+                        source_location_.line());\n+  }\n+\n+ private:\n+  absl::SourceLocation source_location_;\n+#else\n+  SourceLocationHolder() = default;\n+  std::string ToString() const { return \"\"; }\n+#endif  // PLATFORM_GOOGLE\n+};\n+\n // Propagating explanation of fusion decisions: if something could not be fused,\n // explain the reason.\n class FusionDecision {\n  public:\n   static FusionDecision Allow() { return FusionDecision(); }\n   FusionDecision(const FusionDecision& decision) = default;\n \n-#if defined(PLATFORM_GOOGLE)\n-  static std::string LocToString(absl::SourceLocation source_location) {\n-    return absl::StrCat(\" at: \", source_location.file_name(), \":\",\n-                        source_location.line());\n-  }\n   static FusionDecision Forbid(\n       absl::string_view explanation,\n-      absl::SourceLocation source_location = absl::SourceLocation::current()) {\n-    return FusionDecision(\n-        absl::StrCat(explanation, LocToString(source_location)));\n+      SourceLocationHolder source_location = SourceLocationHolder()) {\n+    return FusionDecision(false, explanation, source_location);\n   }\n \n   // If condition is `true` means that we CAN fuse. In that case, explanation is\n   // discarded.\n   FusionDecision(\n       bool condition, absl::string_view explanation,\n-      absl::SourceLocation source_location = absl::SourceLocation::current()) {\n+      SourceLocationHolder source_location = SourceLocationHolder()) {\n     if (!condition) {\n-      explanation_ = absl::StrCat(explanation, LocToString(source_location));\n+      explanation_ = explanation;\n+      source_location_ = source_location;\n     }\n   }\n \n   explicit FusionDecision(\n       absl::Status status,\n-      absl::SourceLocation source_location = absl::SourceLocation::current()) {\n+      SourceLocationHolder source_location = SourceLocationHolder()) {\n     if (!status.ok()) {\n-      explanation_ =\n-          absl::StrCat(status.message(), LocToString(source_location));\n+      explanation_ = status.message();\n+      source_location_ = source_location;\n     }\n   }\n \n@@ -97,25 +111,8 @@ class FusionDecision {\n   // provide explicit explanation.\n   FusionDecision(  // NOLINT\n       bool decision,\n-      absl::SourceLocation source_location = absl::SourceLocation::current());\n-#else\n-  // If condition is `true` means that we CAN fuse. In that case, explanation is\n-  // discarded.\n-  FusionDecision(bool condition, absl::string_view explanation) {\n-    if (!condition) {\n-      explanation_ = std::string(explanation);\n-    }\n-  }\n-  static FusionDecision Forbid(absl::string_view explanation) {\n-    return FusionDecision(explanation);\n-  }\n-  explicit FusionDecision(absl::Status status) {\n-    if (!status.ok()) {\n-      explanation_ = status.message();\n-    }\n-  }\n-\n-#endif  // PLATFORM_GOOGLE\n+      SourceLocationHolder source_location = SourceLocationHolder())\n+      : FusionDecision(decision, \"Not fusing\", source_location) {}\n \n   // Returns whether it can be fused.\n   explicit operator bool() const { return CanFuse(); }\n@@ -130,8 +127,7 @@ class FusionDecision {\n     if (CanFuse() || decision.CanFuse()) {\n       return Allow();\n     }\n-    return Forbid(\n-        absl::StrCat(explanation_.value_or(\"\"), \" ; \", decision.Explain()));\n+    return Forbid(absl::StrCat(Explain(), \" ; \", decision.Explain()));\n   }\n \n   // Connects two fusion decision with a conjunction. Unlike disjunction,\n@@ -150,30 +146,30 @@ class FusionDecision {\n \n   // Appends to explanation, or turns the decision negative.\n   FusionDecision operator<<(absl::string_view explanation) const {\n-    return Forbid(absl::StrCat(explanation_.value_or(\"\"), explanation));\n+    return Forbid(absl::StrCat(explanation_.value_or(\"\"), explanation),\n+                  source_location_);\n   }\n \n   // Appends to explanation, or turns the decision negative.\n   FusionDecision operator<<(int64_t explanation) const {\n-    return Forbid(absl::StrCat(explanation_.value_or(\"\"), explanation));\n+    return Forbid(absl::StrCat(explanation_.value_or(\"\"), explanation),\n+                  source_location_);\n   }\n \n   // Explains why the fusion could not be performed, or that it can be.\n   std::string Explain() const {\n-    return explanation_.value_or(\"Actually, we can fuse it.\");\n+    if (explanation_.has_value()) {\n+      return absl::StrCat(explanation_.value(), source_location_.ToString());\n+    }\n+    return \"Actually, we can fuse it.\";\n   }\n \n  private:\n   // Empty IFF fusion is possible (explanation provided for negative cases).\n   std::optional<std::string> explanation_;\n+  SourceLocationHolder source_location_;\n \n   FusionDecision() = default;\n-\n-  explicit FusionDecision(absl::string_view explanation)\n-      : explanation_(explanation) {}\n-\n-  explicit FusionDecision(const char* explanation)\n-      : explanation_(explanation) {}\n };\n \n #define RETURN_IF_NOT_FUSIBLE(...)                   \\"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 44,
        "deletions": 59
    }
}