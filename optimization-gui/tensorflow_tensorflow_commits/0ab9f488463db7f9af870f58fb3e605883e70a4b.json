{
    "author": "khasanovaa",
    "message": "Refactor `SelectKThunk` to accept `ThunkInfo` instead of `HloInstruction` pointer.\n\nPiperOrigin-RevId: 819786719",
    "sha": "0ab9f488463db7f9af870f58fb3e605883e70a4b",
    "files": [
        {
            "sha": "0810f2e508124a981e6772f146f2c5e92580c244",
            "filename": "third_party/xla/xla/backends/gpu/runtime/select_k_thunk.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk.cc?ref=0ab9f488463db7f9af870f58fb3e605883e70a4b",
            "patch": "@@ -43,13 +43,11 @@ namespace xla::gpu {\n // SelectKThunk\n //===----------------------------------------------------------------------===//\n \n-SelectKThunk::SelectKThunk(const HloInstruction* inst, std::uint32_t batch_size,\n+SelectKThunk::SelectKThunk(ThunkInfo thunk_info, std::uint32_t batch_size,\n                            std::uint32_t num_elements, std::uint32_t k,\n                            xla::PrimitiveType dtype,\n-                           const emitters::KernelArguments& kernel_arguments,\n-                           ThunkId thunk_id)\n-    : Thunk(Kind::kSelectK,\n-            Thunk::ThunkInfo::WithProfileAnnotation(inst, thunk_id)),\n+                           const emitters::KernelArguments& kernel_arguments)\n+    : Thunk(Kind::kSelectK, thunk_info),\n       batch_size_(batch_size),\n       num_elements_(num_elements),\n       k_(k),"
        },
        {
            "sha": "69292582e2f6d3bc67d299ec1dba04a6059c8ded",
            "filename": "third_party/xla/xla/backends/gpu/runtime/select_k_thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk.h?ref=0ab9f488463db7f9af870f58fb3e605883e70a4b",
            "patch": "@@ -40,18 +40,17 @@ class SelectKThunk : public Thunk {\n  public:\n   // Constructor.\n   // Parameters:\n-  //   inst             - The HLO instruction that generated this thunk.\n+  //   thunk_info       - ThunkInfo contains profile annotation & thunk id.\n   //   batch_size       - Number of batches in the input tensor.\n   //   num_elements     - Number of elements in each batch.\n   //   k                - Number of top elements to select.\n   //   dtype            - Data type of elements (e.g., F32, BF16).\n   //   kernel_arguments - Kernel arguments holding buffer slices for\n   //                      inputs/outputs.\n-  SelectKThunk(const HloInstruction* inst, std::uint32_t batch_size,\n+  SelectKThunk(ThunkInfo thunk_info, std::uint32_t batch_size,\n                std::uint32_t num_elements, std::uint32_t k,\n                xla::PrimitiveType dtype,\n-               const emitters::KernelArguments& kernel_arguments,\n-               ThunkId thunk_id);\n+               const emitters::KernelArguments& kernel_arguments);\n \n   std::string ToString(int indent) const override;\n "
        },
        {
            "sha": "4ecf188d4c44b37faf3c79494c45e3ae04e69736",
            "filename": "third_party/xla/xla/backends/gpu/runtime/select_k_thunk_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 11,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_thunk_test.cc?ref=0ab9f488463db7f9af870f58fb3e605883e70a4b",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/select_k_thunk.h\"\n \n #include <memory>\n+#include <utility>\n #include <vector>\n \n #include <gmock/gmock.h>\n@@ -37,10 +38,13 @@ namespace {\n using ::tsl::proto_testing::EqualsProto;\n \n TEST(SelectKThunkTest, ToProto) {\n-  Thunk::ThunkInfo thunk_info;\n-  thunk_info.profile_annotation = \"profile_annotation\";\n-  thunk_info.execution_stream_id = 123;\n-  thunk_info.thunk_id = 456;\n+  auto c1 = HloInstruction::CreateConstant(\n+      LiteralUtil::CreateR2<float>({{.125f, 0.875f, .5f, .25f, 0.75f}}));\n+  auto topKInst = HloInstruction::CreateCustomCall(\n+      ShapeUtil::MakeShape(F32, {1, 5}), {c1.get()}, \"__gpu$TopK\");\n+\n+  Thunk::ThunkInfo thunk_info =\n+      Thunk::ThunkInfo::WithProfileAnnotation(topKInst.get(), ThunkId{456});\n \n   BufferAllocation alloc0(/*index=*/0, /*size=*/20, /*color=*/0);\n   BufferAllocation::Slice slice0(&alloc0, /*offset=*/0, /*size=*/20);\n@@ -60,13 +64,7 @@ TEST(SelectKThunkTest, ToProto) {\n \n   emitters::KernelArguments kernel_arguments({arg0, arg1, arg2});\n \n-  auto c1 = HloInstruction::CreateConstant(\n-      LiteralUtil::CreateR2<float>({{.125f, 0.875f, .5f, .25f, 0.75f}}));\n-  auto topKInst = HloInstruction::CreateCustomCall(\n-      ShapeUtil::MakeShape(F32, {1, 5}), {c1.get()}, \"__gpu$TopK\");\n-\n-  SelectKThunk thunk(topKInst.get(), 1, 5, 3, F32, kernel_arguments,\n-                     ThunkId(456));\n+  SelectKThunk thunk(std::move(thunk_info), 1, 5, 3, F32, kernel_arguments);\n   TF_ASSERT_OK_AND_ASSIGN(ThunkProto proto, thunk.ToProto());\n   EXPECT_THAT(proto, EqualsProto(R\"pb(\n                 thunk_info { profile_annotation: \"custom-call\" thunk_id: 456 }"
        },
        {
            "sha": "572e1f19c7db21ecd84a853941848ad48fbc4a4c",
            "filename": "third_party/xla/xla/service/gpu/ir_emitter_unnested.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ab9f488463db7f9af870f58fb3e605883e70a4b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc?ref=0ab9f488463db7f9af870f58fb3e605883e70a4b",
            "patch": "@@ -1423,10 +1423,11 @@ absl::Status IrEmitterUnnested::EmitTopKCustomCall(\n     VLOG(3) << \"EmitTopKCustomCall: dtype=\" << dtype << \", n=\" << n\n             << \", k=\" << k << \", use_raft_select_k=\" << use_raft_select_k;\n \n+    Thunk::ThunkInfo thunk_info = Thunk::ThunkInfo::WithProfileAnnotation(\n+        instr, ir_emitter_context_->GetNextThunkId());\n     if (use_raft_select_k) {\n       AddThunkToThunkSequence(std::make_unique<SelectKThunk>(\n-          instr, batch_size, n, k, dtype, kernel_arguments,\n-          ir_emitter_context_->GetNextThunkId()));\n+          std::move(thunk_info), batch_size, n, k, dtype, kernel_arguments));\n       return absl::OkStatus();\n     }\n   }"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 18,
        "deletions": 22
    }
}