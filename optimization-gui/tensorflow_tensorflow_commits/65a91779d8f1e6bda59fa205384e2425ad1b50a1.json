{
    "author": "zacmustin",
    "message": "Add `CompiledMemoryStats` `peak_memory` to more tests.\n\nAlso some very minor cleanups to assignment.\n\nPiperOrigin-RevId: 840383280",
    "sha": "65a91779d8f1e6bda59fa205384e2425ad1b50a1",
    "files": [
        {
            "sha": "9a2a4dcb42d319269a0fedc32a0ef6d55c0d5763",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=65a91779d8f1e6bda59fa205384e2425ad1b50a1",
            "patch": "@@ -975,8 +975,8 @@ absl::StatusOr<CompiledMemoryStats> PjRtCpuExecutable::GetCompiledMemoryStats()\n   memory_stats.serialized_buffer_assignment = proto.SerializeAsString();\n   memory_stats.PopulateBufferStatsFromAllocations(\n       cpu_executable_->GetAllocations());\n-  TF_ASSIGN_OR_RETURN(int64_t peak_memory, ComputePeakMemory(proto));\n-  memory_stats.peak_memory_in_bytes = peak_memory;\n+  TF_ASSIGN_OR_RETURN(memory_stats.peak_memory_in_bytes,\n+                      ComputePeakMemory(proto));\n   return memory_stats;\n }\n "
        },
        {
            "sha": "246fb166b12771deda3ed5dcb55928eea941ad8b",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_pjrt_compiler_aot_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_compiler_aot_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_compiler_aot_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_compiler_aot_test.cc?ref=65a91779d8f1e6bda59fa205384e2425ad1b50a1",
            "patch": "@@ -251,6 +251,7 @@ TEST(StreamExecutorGpuCompilerTest, UnloadedExecutableMemoryStats) {\n   EXPECT_GT(compiled_memory_stats.temp_size_in_bytes, 0);\n   EXPECT_EQ(compiled_memory_stats.host_temp_size_in_bytes, 0);\n   EXPECT_EQ(compiled_memory_stats.host_output_size_in_bytes, 16);\n+  EXPECT_GT(compiled_memory_stats.peak_memory_in_bytes, 0);\n }\n \n }  // namespace"
        },
        {
            "sha": "3e5fcc20deb231a328f03d1d4e8394160cddef97",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_client_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client_test.cc?ref=65a91779d8f1e6bda59fa205384e2425ad1b50a1",
            "patch": "@@ -1410,6 +1410,7 @@ TEST(TfrtGpuClientTest, ExecutePinnedHostOutputTest) {\n                           executable->GetCompiledMemoryStats());\n   EXPECT_EQ(memory_stats.output_size_in_bytes, 0);\n   EXPECT_EQ(memory_stats.host_output_size_in_bytes, 16);\n+  EXPECT_GT(memory_stats.peak_memory_in_bytes, 0);\n \n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> literal,\n                           result_buffers[0]->ToLiteralSync());"
        },
        {
            "sha": "7dacb707060297401b6ca7342ad5df8a0db7db28",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_executable.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc?ref=65a91779d8f1e6bda59fa205384e2425ad1b50a1",
            "patch": "@@ -1216,8 +1216,8 @@ absl::StatusOr<CompiledMemoryStats> TfrtGpuExecutable::GetCompiledMemoryStats()\n       executables_[0]->executable()->buffer_assignment_proto();\n   if (proto != nullptr) {\n     memory_stats.serialized_buffer_assignment = proto->SerializeAsString();\n-    TF_ASSIGN_OR_RETURN(int64_t peak_memory, ComputePeakMemory(*proto));\n-    memory_stats.peak_memory_in_bytes = peak_memory;\n+    TF_ASSIGN_OR_RETURN(memory_stats.peak_memory_in_bytes,\n+                        ComputePeakMemory(*proto));\n   }\n   memory_stats.PopulateBufferStatsFromAllocations(\n       executables_[0]->executable()->GetAllocations());"
        },
        {
            "sha": "3e543724c182aa33c46b39f476652fd65c6bdf97",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h?ref=65a91779d8f1e6bda59fa205384e2425ad1b50a1",
            "patch": "@@ -575,8 +575,8 @@ class PjRtStreamExecutorLoadedExecutable : public PjRtLoadedExecutable {\n         executables_[0]->executable()->buffer_assignment_proto();\n     if (proto != nullptr) {\n       memory_stats.serialized_buffer_assignment = proto->SerializeAsString();\n-      TF_ASSIGN_OR_RETURN(int64_t peak_memory, ComputePeakMemory(*proto));\n-      memory_stats.peak_memory_in_bytes = peak_memory;\n+      TF_ASSIGN_OR_RETURN(memory_stats.peak_memory_in_bytes,\n+                          ComputePeakMemory(*proto));\n     }\n     memory_stats.PopulateBufferStatsFromAllocations(\n         executables_[0]->executable()->GetAllocations());"
        },
        {
            "sha": "61210775a4461cc4957eed1ce512b896d3905d0c",
            "filename": "third_party/xla/xla/pjrt/stream_executor_executable.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fstream_executor_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65a91779d8f1e6bda59fa205384e2425ad1b50a1/third_party%2Fxla%2Fxla%2Fpjrt%2Fstream_executor_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fstream_executor_executable.cc?ref=65a91779d8f1e6bda59fa205384e2425ad1b50a1",
            "patch": "@@ -128,8 +128,8 @@ StreamExecutorExecutable::GetCompiledMemoryStats() const {\n       alloc_ptrs.push_back(&alloc);\n     }\n     memory_stats.PopulateBufferStatsFromAllocations(alloc_ptrs);\n-    TF_ASSIGN_OR_RETURN(int64_t peak_memory, ComputePeakMemory(proto));\n-    memory_stats.peak_memory_in_bytes = peak_memory;\n+    TF_ASSIGN_OR_RETURN(memory_stats.peak_memory_in_bytes,\n+                        ComputePeakMemory(proto));\n     return memory_stats;\n   }\n \n@@ -144,8 +144,8 @@ StreamExecutorExecutable::GetCompiledMemoryStats() const {\n       local_executables[0]->executable()->buffer_assignment_proto();\n   if (proto != nullptr) {\n     memory_stats.serialized_buffer_assignment = proto->SerializeAsString();\n-    TF_ASSIGN_OR_RETURN(int64_t peak_memory, ComputePeakMemory(*proto));\n-    memory_stats.peak_memory_in_bytes = peak_memory;\n+    TF_ASSIGN_OR_RETURN(memory_stats.peak_memory_in_bytes,\n+                        ComputePeakMemory(*proto));\n   }\n   memory_stats.PopulateBufferStatsFromAllocations(\n       local_executables[0]->executable()->GetAllocations());"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 12,
        "deletions": 10
    }
}