{
    "author": "bmass02",
    "message": "Add method for extracting timestamps from TaskEnv XPlane.\n\nPiperOrigin-RevId: 816399473",
    "sha": "c494b11641bd47bb26ed1f3c2e55b2dfde532ba6",
    "files": [
        {
            "sha": "8ad67789a1b914540bf7dfab02cb4f29e40eae47",
            "filename": "third_party/xla/xla/tsl/profiler/utils/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD?ref=c494b11641bd47bb26ed1f3c2e55b2dfde532ba6",
            "patch": "@@ -494,6 +494,7 @@ cc_library(\n         \":xplane_builder\",\n         \":xplane_schema\",\n         \":xplane_utils\",\n+        \":xplane_visitor\",\n         \"@com_google_absl//absl/log\",\n         \"@local_tsl//tsl/profiler/protobuf:xplane_proto_cc\",\n     ],\n@@ -504,8 +505,6 @@ tsl_cc_test(\n     srcs = [\"timestamp_utils_test.cc\"],\n     deps = [\n         \":timestamp_utils\",\n-        \":xplane_schema\",\n-        \":xplane_utils\",\n         \":xplane_visitor\",\n         \"//xla/tsl/platform:test\",\n         \"@com_google_googletest//:gtest_main\","
        },
        {
            "sha": "b2f8bd4c129fa366044343f53a091ffbf7e000b0",
            "filename": "third_party/xla/xla/tsl/profiler/utils/timestamp_utils.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils.cc?ref=c494b11641bd47bb26ed1f3c2e55b2dfde532ba6",
            "patch": "@@ -16,11 +16,14 @@ limitations under the License.\n #include \"xla/tsl/profiler/utils/timestamp_utils.h\"\n \n #include <cstdint>\n+#include <optional>\n+#include <utility>\n \n #include \"absl/log/log.h\"\n #include \"xla/tsl/profiler/utils/xplane_builder.h\"\n #include \"xla/tsl/profiler/utils/xplane_schema.h\"\n #include \"xla/tsl/profiler/utils/xplane_utils.h\"\n+#include \"xla/tsl/profiler/utils/xplane_visitor.h\"\n #include \"tsl/profiler/protobuf/xplane.pb.h\"\n \n namespace tsl {\n@@ -45,5 +48,26 @@ void SetSessionTimestamps(uint64_t start_walltime_ns, uint64_t stop_walltime_ns,\n   }\n }\n \n+std::optional<std::pair<uint64_t, uint64_t>> GetSessionTimestamps(\n+    const tensorflow::profiler::XSpace& space) {\n+  auto task_env_plane =\n+      tsl::profiler::FindPlaneWithName(space, tsl::profiler::kTaskEnvPlaneName);\n+  if (task_env_plane == nullptr) {\n+    LOG(WARNING) << \"No task env plane found. Skipping getting session \"\n+                    \"timestamps.\";\n+    return std::nullopt;\n+  }\n+  XPlaneVisitor visitor(task_env_plane, {}, {FindTaskEnvStatType});\n+  auto start_stat = visitor.GetStat(kEnvProfileStartTime);\n+  auto stop_stat = visitor.GetStat(kEnvProfileStopTime);\n+  if (!start_stat.has_value() || !stop_stat.has_value()) {\n+    LOG(WARNING) << \"No session timestamps found. Skipping getting session \"\n+                    \"timestamps.\";\n+    return std::nullopt;\n+  }\n+  return std::make_pair(start_stat->IntOrUintValue(),\n+                        stop_stat->IntOrUintValue());\n+}\n+\n }  // namespace profiler\n }  // namespace tsl"
        },
        {
            "sha": "4d49aa1dc88d90101623bbbb24a4432f27ec00b1",
            "filename": "third_party/xla/xla/tsl/profiler/utils/timestamp_utils.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils.h?ref=c494b11641bd47bb26ed1f3c2e55b2dfde532ba6",
            "patch": "@@ -17,6 +17,8 @@ limitations under the License.\n #define XLA_TSL_PROFILER_UTILS_TIMESTAMP_UTILS_H_\n \n #include <cstdint>\n+#include <optional>\n+#include <utility>\n \n #include \"tsl/profiler/protobuf/xplane.pb.h\"\n \n@@ -27,6 +29,12 @@ namespace profiler {\n // This function won't have an effect if either of the timestamps is zero.\n void SetSessionTimestamps(uint64_t start_walltime_ns, uint64_t stop_walltime_ns,\n                           tensorflow::profiler::XSpace& space);\n+\n+// Get the session timestamps from the task env plane. Returns nullopt if the\n+// timestamps are not found.\n+std::optional<std::pair<uint64_t, uint64_t>> GetSessionTimestamps(\n+    const tensorflow::profiler::XSpace& space);\n+\n }  // namespace profiler\n }  // namespace tsl\n "
        },
        {
            "sha": "592ac156194e04134f121073076ec6d19db768a3",
            "filename": "third_party/xla/xla/tsl/profiler/utils/timestamp_utils_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 10,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c494b11641bd47bb26ed1f3c2e55b2dfde532ba6/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Ftimestamp_utils_test.cc?ref=c494b11641bd47bb26ed1f3c2e55b2dfde532ba6",
            "patch": "@@ -15,9 +15,11 @@ limitations under the License.\n \n #include \"xla/tsl/profiler/utils/timestamp_utils.h\"\n \n+#include <cstdint>\n+#include <optional>\n+#include <utility>\n+\n #include \"xla/tsl/platform/test.h\"\n-#include \"xla/tsl/profiler/utils/xplane_schema.h\"\n-#include \"xla/tsl/profiler/utils/xplane_utils.h\"\n #include \"xla/tsl/profiler/utils/xplane_visitor.h\"\n \n namespace tsl {\n@@ -29,15 +31,12 @@ TEST(TimestampUtilsTest, StartAndStopTimestampAreAdded) {\n \n   SetSessionTimestamps(1000, 2000, xspace);\n \n-  const XPlane* xplane = FindPlaneWithName(xspace, kTaskEnvPlaneName);\n-\n-  XPlaneVisitor visitor(xplane, {}, {FindTaskEnvStatType});\n-\n-  auto start_time = visitor.GetStat(TaskEnvStatType::kEnvProfileStartTime);\n-  auto stop_time = visitor.GetStat(TaskEnvStatType::kEnvProfileStopTime);\n+  const std::optional<std::pair<uint64_t, uint64_t>> timestamps =\n+      GetSessionTimestamps(xspace);\n \n-  EXPECT_THAT(start_time->IntOrUintValue(), Eq(1000));\n-  EXPECT_THAT(stop_time->IntOrUintValue(), Eq(2000));\n+  ASSERT_TRUE(timestamps.has_value());\n+  EXPECT_THAT(timestamps->first, Eq(1000));\n+  EXPECT_THAT(timestamps->second, Eq(2000));\n }\n \n }  // namespace profiler"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 42,
        "deletions": 12
    }
}