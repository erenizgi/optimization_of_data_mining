{
    "author": "unknown",
    "message": "[XLA:GPU] Add Thunk::TransformAllNestedThunks\n\nA function similar to ForAllThunksMutable, but capable of wrapping or replacing nested thunks with new ones. In case the thunk has some specific requirements (e.g. assumes the directly nested thunk is a `SequentialThunk`), the implementation needs to ensure the assumptions still hold. The transform function must be infallible, but it may be a no-op and return the original `unique_ptr<Thunk>`.\n\nThe use for this is in buffer checksumming: to cover all thunks, we need to recursively insert pre-/post-execution checksum thunks around execution of nested thunks. Unfortunately, ForAllThunksMutable doesn't allow mutating the thunk's *container*, which would create the need to switch() over thunk kind, special-case any thunk that may contain nested thunks, and expose the internals to the caller to reimplement the recursion.\n\nPiperOrigin-RevId: 826014413",
    "sha": "689bf5ef28c74226758558afbea86915cd922fd0",
    "files": [
        {
            "sha": "500157c46f8d86668df68e8caaf919bf94cc2865",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -268,6 +268,7 @@ xla_test(\n         \":dynamic_slice_thunk\",\n         \":dynamic_slice_thunk_proto_cc\",\n         \":gemm_thunk\",\n+        \":sequential_thunk\",\n         \":thunk\",\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\","
        },
        {
            "sha": "ca7fc2537ee79e1f8af4cd059d2f9e3e746c375b",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_group_thunk.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -135,5 +135,13 @@ void CollectiveGroupThunk::ForAllThunksMutable(\n   }\n }\n \n+void CollectiveGroupThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+  for (std::unique_ptr<Thunk>& thunk : thunks_) {\n+    thunk->TransformAllNestedThunks(fn);\n+    thunk = fn(std::move(thunk));\n+  }\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "7934caba9df480c07c237024761d17df5374fdd5",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_group_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_group_thunk.h?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -45,6 +45,10 @@ class CollectiveGroupThunk : public Thunk {\n   absl::Status Initialize(const InitializeParams& params) override;\n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n+  void TransformAllNestedThunks(\n+      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n+      override;\n+\n   std::shared_ptr<CollectiveThunk::AsyncEvents> async_events() const {\n     return async_events_;\n   }"
        },
        {
            "sha": "eb37f849eca8e579240ee152a99e8a0fccdcb626",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -165,6 +165,14 @@ void ConditionalThunk::ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) {\n   }\n }\n \n+void ConditionalThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+  for (std::unique_ptr<SequentialThunk>& branch_thunk : branch_thunks_) {\n+    branch_thunk->TransformAllNestedThunks(fn);\n+    branch_thunk = SequentialThunk::FromThunk(fn(std::move(branch_thunk)));\n+  }\n+}\n+\n absl::StatusOr<ThunkProto> ConditionalThunk::ToProto() const {\n   ThunkProto proto;\n   *proto.mutable_thunk_info() = thunk_info().ToProto();"
        },
        {
            "sha": "0bedc6a1cae76383d7c1946bd78dae9a6c5f91a2",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -73,6 +73,10 @@ class ConditionalThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n+  void TransformAllNestedThunks(\n+      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n+      override;\n+\n   bool branch_index_is_bool() const { return branch_index_is_bool_; }\n \n   absl::StatusOr<ThunkProto> ToProto() const override;"
        },
        {
            "sha": "a705d3b00860cfebc720110978503e3a85a72169",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk_test.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -39,6 +39,7 @@ namespace {\n \n using ::testing::Pointee;\n using ::testing::Property;\n+using ::testing::SizeIs;\n using ::tsl::proto_testing::EqualsProto;\n using Kind = Thunk::Kind;\n \n@@ -288,5 +289,29 @@ TEST(ConditionalThunkTest, ToString) {\n             \"  000: kGemm\\t\\n\");\n }\n \n+TEST(ConditionalThunkTest, TransformAllNestedThunks) {\n+  BufferAllocation::Slice slice;\n+  std::vector<std::unique_ptr<SequentialThunk>> branch_thunks;\n+  branch_thunks.push_back(\n+      std::make_unique<SequentialThunk>(Thunk::ThunkInfo(), ThunkSequence()));\n+  branch_thunks.push_back(\n+      std::make_unique<SequentialThunk>(Thunk::ThunkInfo(), ThunkSequence()));\n+  auto conditional_thunk = std::make_unique<ConditionalThunk>(\n+      Thunk::ThunkInfo(), slice, std::move(branch_thunks),\n+      /*branch_index_is_bool=*/false);\n+\n+  conditional_thunk->TransformAllNestedThunks([](auto) {\n+    return std::make_unique<DummyThunk>(Kind::kCustomCall, Thunk::ThunkInfo());\n+  });\n+\n+  EXPECT_THAT(conditional_thunk->branch_thunks(), SizeIs(2));\n+  EXPECT_THAT(conditional_thunk->branch_thunks()[0]->thunks(), SizeIs(1));\n+  EXPECT_THAT(conditional_thunk->branch_thunks()[0]->thunks()[0]->kind(),\n+              Kind::kCustomCall);\n+  EXPECT_THAT(conditional_thunk->branch_thunks()[1]->thunks(), SizeIs(1));\n+  EXPECT_THAT(conditional_thunk->branch_thunks()[1]->thunks()[0]->kind(),\n+              Kind::kCustomCall);\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        },
        {
            "sha": "747e0ecd1513f12e54b587de7f84f9318cedd07c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -440,6 +440,12 @@ void DynamicSliceThunk::ForAllThunksMutable(\n   embedded_thunk_->ForAllThunksMutable(fn);\n }\n \n+void DynamicSliceThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+  embedded_thunk_->TransformAllNestedThunks(fn);\n+  embedded_thunk_ = SequentialThunk::FromThunk(fn(std::move(embedded_thunk_)));\n+}\n+\n absl::StatusOr<OptionalDynamicSliceOffsetsProto>\n SerializeOptionalDynamicSliceOffsetsToProto(\n     const std::optional<std::vector<DynamicSliceThunk::Offset>>& offsets_item,"
        },
        {
            "sha": "f6574b2927d8bd18be033f2524b472693eb6bf52",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk.h?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -173,6 +173,9 @@ class DynamicSliceThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n+  void TransformAllNestedThunks(\n+      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n+      override;\n \n   absl::StatusOr<ThunkProto> ToProto() const override;\n "
        },
        {
            "sha": "5e99413914b625056a0978323e906a32aa7b2134",
            "filename": "third_party/xla/xla/backends/gpu/runtime/dynamic_slice_thunk_test.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fdynamic_slice_thunk_test.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -33,6 +33,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/custom_call_thunk.h\"\n #include \"xla/backends/gpu/runtime/dynamic_slice_thunk.pb.h\"\n #include \"xla/backends/gpu/runtime/gemm_thunk.h\"\n+#include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/ffi/attribute_map.h\"\n #include \"xla/ffi/ffi.h\"\n@@ -65,7 +66,20 @@ limitations under the License.\n namespace xla::gpu {\n namespace {\n \n+class DummyThunk : public Thunk {\n+ public:\n+  explicit DummyThunk(Kind kind, const Thunk::ThunkInfo& info)\n+      : Thunk(kind, info) {}\n+  ~DummyThunk() override = default;\n+\n+  absl::Status ExecuteOnStream(const ExecuteParams& params) override {\n+    return absl::OkStatus();\n+  }\n+};\n+\n using DynamicSliceThunkTest = HloHardwareIndependentTestBase;\n+using ::testing::NotNull;\n+using ::testing::SizeIs;\n using ::tsl::proto_testing::EqualsProto;\n \n std::string GetPlatformName() {\n@@ -2100,5 +2114,29 @@ TEST_F(DynamicSliceThunkTest,\n   EXPECT_EQ(proto.offsets().offsets(0).hlo_module_offset_idx(), 0);\n }\n \n+TEST_F(DynamicSliceThunkTest, TransformAllNestedThunks) {\n+  auto seq = std::make_unique<ThunkSequence>();\n+  seq->emplace_back(\n+      std::make_unique<DummyThunk>(Thunk::Kind::kGemm, Thunk::ThunkInfo()));\n+  DynamicSliceThunk thunk(Thunk::ThunkInfo(),\n+                          /*embedded_thunk=*/std::move(seq),\n+                          /*arguments=*/{},\n+                          /*fake_allocations=*/{},\n+                          /*offsets=*/{},\n+                          /*orig_shapes=*/{},\n+                          /*sliced_shapes=*/{},\n+                          /*offset_byte_sizes=*/{});\n+\n+  thunk.TransformAllNestedThunks([](auto) {\n+    return std::make_unique<DummyThunk>(Thunk::Kind::kCustomCall,\n+                                        Thunk::ThunkInfo());\n+  });\n+\n+  EXPECT_THAT(thunk.get_embedded_thunk(), NotNull());\n+  EXPECT_THAT(thunk.get_embedded_thunk()->thunks(), SizeIs(1));\n+  EXPECT_THAT(thunk.get_embedded_thunk()->thunks()[0]->kind(),\n+              Thunk::Kind::kCustomCall);\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        },
        {
            "sha": "7482225ad5623252f05dd29097e5b7c6fd50f6c0",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <optional>\n #include <string>\n #include <utility>\n+#include <vector>\n \n #include \"absl/algorithm/container.h\"\n #include \"absl/functional/function_ref.h\"\n@@ -125,6 +126,14 @@ void SequentialThunk::ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) {\n   }\n }\n \n+void SequentialThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+  for (std::unique_ptr<Thunk>& thunk : thunks_) {\n+    thunk->TransformAllNestedThunks(fn);\n+    thunk = fn(std::move(thunk));\n+  }\n+}\n+\n absl::StatusOr<ThunkProto> SequentialThunk::ToProto() const {\n   ThunkProto proto;\n   *proto.mutable_thunk_info() = thunk_info().ToProto();\n@@ -152,5 +161,19 @@ absl::StatusOr<std::unique_ptr<SequentialThunk>> SequentialThunk::FromProto(\n   return std::make_unique<SequentialThunk>(std::move(thunk_info),\n                                            std::move(thunk_sequence));\n }\n+\n+std::unique_ptr<SequentialThunk> SequentialThunk::FromThunk(\n+    std::unique_ptr<Thunk> thunk) {\n+  if (thunk->kind() == Thunk::kSequential) {\n+    return std::unique_ptr<SequentialThunk>(\n+        static_cast<SequentialThunk*>(thunk.release()));\n+  }\n+\n+  std::vector<std::unique_ptr<Thunk>> thunks;\n+  thunks.push_back(std::move(thunk));\n+  return std::make_unique<SequentialThunk>(Thunk::ThunkInfo(),\n+                                           std::move(thunks));\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "cc2da511341f2f773124bbe18859b6456898ba62",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.h?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -48,13 +48,23 @@ class SequentialThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n+  void TransformAllNestedThunks(\n+      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n+      override;\n \n   absl::StatusOr<ThunkProto> ToProto() const override;\n \n   static absl::StatusOr<std::unique_ptr<SequentialThunk>> FromProto(\n       ThunkInfo thunk_info, const SequentialThunkProto& thunk_proto,\n       const Deserializer& deserializer);\n \n+  // Converts a Thunk into a SequentialThunk. If the input is already a\n+  // SequentialThunk, the returned value is the downcasted input.\n+  //\n+  // The new thunk, if created, will use a default-initialized ThunkInfo.\n+  static std::unique_ptr<SequentialThunk> FromThunk(\n+      std::unique_ptr<Thunk> thunk);\n+\n  private:\n   // The list of sub-thunks.\n   ThunkSequence thunks_;"
        },
        {
            "sha": "852972250767a1e550987c9aa02116b7357a8c2c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n \n+#include <cstdint>\n #include <memory>\n #include <string>\n #include <utility>\n@@ -156,5 +157,36 @@ TEST(SequentialThunkTest, ToString) {\n             \"  003: kGemm\\t\\n\");\n }\n \n+TEST(SequentialThunkTest, TransformAllNestedThunks) {\n+  auto make_info = [](uint64_t id) {\n+    Thunk::ThunkInfo info;\n+    info.thunk_id = ThunkId(id);\n+    return info;\n+  };\n+  ThunkSequence thunks;\n+  thunks.push_back(\n+      std::make_unique<DummyThunk>(Thunk::Kind::kGemm, make_info(1)));\n+  thunks.push_back(\n+      std::make_unique<DummyThunk>(Thunk::Kind::kGemm, make_info(2)));\n+  thunks.push_back(\n+      std::make_unique<DummyThunk>(Thunk::Kind::kGemm, make_info(3)));\n+  SequentialThunk sequential_thunk(Thunk::ThunkInfo(), std::move(thunks));\n+\n+  sequential_thunk.TransformAllNestedThunks(\n+      [&](std::unique_ptr<Thunk> thunk) -> std::unique_ptr<Thunk> {\n+        return std::make_unique<DummyThunk>(\n+            Thunk::Kind::kCopy,\n+            make_info(thunk->thunk_info().thunk_id.value() + 10));\n+      });\n+\n+  EXPECT_EQ(sequential_thunk.thunks().size(), 3);\n+  EXPECT_EQ(sequential_thunk.thunks()[0]->kind(), Thunk::Kind::kCopy);\n+  EXPECT_EQ(sequential_thunk.thunks()[0]->thunk_info().thunk_id, ThunkId(11));\n+  EXPECT_EQ(sequential_thunk.thunks()[1]->kind(), Thunk::Kind::kCopy);\n+  EXPECT_EQ(sequential_thunk.thunks()[1]->thunk_info().thunk_id, ThunkId(12));\n+  EXPECT_EQ(sequential_thunk.thunks()[2]->kind(), Thunk::Kind::kCopy);\n+  EXPECT_EQ(sequential_thunk.thunks()[2]->thunk_info().thunk_id, ThunkId(13));\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        },
        {
            "sha": "70e8c0947f6bac32ccc22f1b31c78bd9a413ae7e",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.h?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -538,6 +538,11 @@ class Thunk {\n   // Invokes `fn` with this thunk and all nested thunks.\n   virtual void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn);\n \n+  // Recursively replaces all nested thunks with the result of applying `fn` to\n+  // them.\n+  virtual void TransformAllNestedThunks(\n+      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {}\n+\n   // A helper function to get the `GpuCollectives*` pointer from the\n   // CollectiveExecuteParams.\n   static absl::StatusOr<GpuCollectives* absl_nonnull> GetGpuCollectives("
        },
        {
            "sha": "711a7798a0302b493754d2b56371ad9846f92876",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -199,6 +199,16 @@ void WhileThunk::ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) {\n   body_thunk_sequence_->ForAllThunksMutable(fn);\n }\n \n+void WhileThunk::TransformAllNestedThunks(\n+    absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn) {\n+  condition_thunk_sequence_->TransformAllNestedThunks(fn);\n+  condition_thunk_sequence_ =\n+      SequentialThunk::FromThunk(fn(std::move(condition_thunk_sequence_)));\n+  body_thunk_sequence_->TransformAllNestedThunks(fn);\n+  body_thunk_sequence_ =\n+      SequentialThunk::FromThunk(fn(std::move(body_thunk_sequence_)));\n+}\n+\n std::string WhileThunk::ToString(int indent) const {\n   std::string indent_str(indent * 2, ' ');\n   std::string result;"
        },
        {
            "sha": "ac78b42e3f9657121ad3673acab41f1a536bfa88",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -94,6 +94,9 @@ class WhileThunk : public Thunk {\n \n   void ForAllThunks(absl::FunctionRef<void(const Thunk*)> fn) const override;\n   void ForAllThunksMutable(absl::FunctionRef<void(Thunk*)> fn) override;\n+  void TransformAllNestedThunks(\n+      absl::FunctionRef<std::unique_ptr<Thunk>(std::unique_ptr<Thunk>)> fn)\n+      override;\n \n   std::string ToString(int indent) const override;\n "
        },
        {
            "sha": "a65e954190fb5b6b72cbd3e80213c81235313946",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689bf5ef28c74226758558afbea86915cd922fd0/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc?ref=689bf5ef28c74226758558afbea86915cd922fd0",
            "patch": "@@ -53,9 +53,10 @@ namespace xla::gpu {\n namespace {\n \n using ::testing::ElementsAre;\n+using ::testing::NotNull;\n+using ::testing::SizeIs;\n using ::tsl::proto_testing::EqualsProto;\n using ::tsl::proto_testing::ParseTextProtoOrDie;\n-using ::tsl::testing::IsOk;\n using Kind = Thunk::Kind;\n \n // A dummy `Thunk` that does nothing.\n@@ -379,5 +380,32 @@ TEST(WhileThunkTest, FromProto) {\n   EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n }\n \n+TEST(WhileThunkTest, TransformAllNestedThunks) {\n+  BufferAllocation::Slice slice;\n+  auto condition_thunk_sequence =\n+      std::make_unique<SequentialThunk>(Thunk::ThunkInfo(), ThunkSequence());\n+  auto body_thunk_sequence =\n+      std::make_unique<SequentialThunk>(Thunk::ThunkInfo(), ThunkSequence());\n+  auto while_thunk = std::make_unique<WhileThunk>(\n+      Thunk::ThunkInfo(), /*loop=*/nullptr,\n+      /*condition_result_buffer_index=*/slice,\n+      /*condition_thunk_sequence=*/std::move(condition_thunk_sequence),\n+      /*body_thunk_sequence_=*/std::move(body_thunk_sequence),\n+      /*trip_count=*/3);\n+\n+  while_thunk->TransformAllNestedThunks([](auto) {\n+    return std::make_unique<DummyThunk>(Kind::kCustomCall, Thunk::ThunkInfo());\n+  });\n+\n+  EXPECT_THAT(while_thunk->condition_thunk_sequence(), NotNull());\n+  EXPECT_THAT(while_thunk->condition_thunk_sequence()->thunks(), SizeIs(1));\n+  EXPECT_THAT(while_thunk->condition_thunk_sequence()->thunks()[0]->kind(),\n+              Kind::kCustomCall);\n+  EXPECT_THAT(while_thunk->body_thunk_sequence(), NotNull());\n+  EXPECT_THAT(while_thunk->body_thunk_sequence()->thunks(), SizeIs(1));\n+  EXPECT_THAT(while_thunk->body_thunk_sequence()->thunks()[0]->kind(),\n+              Kind::kCustomCall);\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        }
    ],
    "stats": {
        "total": 210,
        "additions": 209,
        "deletions": 1
    }
}