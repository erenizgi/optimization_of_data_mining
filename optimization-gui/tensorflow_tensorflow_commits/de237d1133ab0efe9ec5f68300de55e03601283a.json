{
    "author": "hanrach9",
    "message": "Move dlpack_support to xla and separate out stride functions from types.\n\nPiperOrigin-RevId: 831147246",
    "sha": "de237d1133ab0efe9ec5f68300de55e03601283a",
    "files": [
        {
            "sha": "aa069712fa3c49bb89d5c2e09cc1d1760fcd5062",
            "filename": "third_party/xla/MODULE.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2FMODULE.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2FMODULE.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2FMODULE.bazel?ref=de237d1133ab0efe9ec5f68300de55e03601283a",
            "patch": "@@ -84,6 +84,7 @@ use_repo(\n     \"XNNPACK\",\n     \"cpuinfo\",\n     \"cudnn_frontend_archive\",\n+    \"dlpack\",\n     \"ducc\",\n     \"eigen_archive\",\n     \"farmhash_archive\","
        },
        {
            "sha": "0d3671ff2e5ce2a3b55ffe07282853eab449543f",
            "filename": "third_party/xla/xla/python/BUILD",
            "status": "modified",
            "additions": 34,
            "deletions": 1,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2FBUILD?ref=de237d1133ab0efe9ec5f68300de55e03601283a",
            "patch": "@@ -12,7 +12,7 @@ load(\n     \"if_google\",\n     \"internal_visibility\",\n )\n-load(\"//xla/tsl:tsl.default.bzl\", \"get_compatible_with_portable\", \"tsl_pybind_extension\")\n+load(\"//xla/tsl:tsl.default.bzl\", \"get_compatible_with_libtpu_portable\", \"get_compatible_with_portable\", \"tsl_pybind_extension\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n \n package(\n@@ -88,6 +88,25 @@ py_strict_test(\n     ] + xla_py_test_deps(),\n )\n \n+cc_library(\n+    name = \"dlpack_types\",\n+    srcs = [\"dlpack_types.cc\"],\n+    hdrs = [\"dlpack_types.h\"],\n+    compatible_with = get_compatible_with_libtpu_portable(),\n+    copts = [\n+        \"-fexceptions\",\n+        \"-fno-strict-aliasing\",\n+    ],\n+    features = [\"-use_header_modules\"],\n+    visibility = internal_visibility([\":friends\"]),\n+    deps = [\n+        \"//xla:util\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@dlpack\",\n+    ],\n+)\n+\n cc_library(\n     name = \"types\",\n     srcs = [\"types.cc\"],\n@@ -126,6 +145,20 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"strides\",\n+    srcs = [\"strides.cc\"],\n+    hdrs = [\"strides.h\"],\n+    compatible_with = get_compatible_with_libtpu_portable(),\n+    visibility = internal_visibility([\":friends\"]),\n+    deps = [\n+        \"//xla:shape_util\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"//xla/tsl/platform:logging\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)\n+\n cc_library(\n     name = \"literal_type_casters\",\n     hdrs = [\"literal_type_casters.h\"],"
        },
        {
            "sha": "e3a37a8ae92c94ed44930ee26acb43ae9a59bac3",
            "filename": "third_party/xla/xla/python/dlpack_types.cc",
            "status": "added",
            "additions": 223,
            "deletions": 0,
            "changes": 223,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fdlpack_types.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fdlpack_types.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fdlpack_types.cc?ref=de237d1133ab0efe9ec5f68300de55e03601283a",
            "patch": "@@ -0,0 +1,223 @@\n+/* Copyright 2025 The JAX Authors\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/python/dlpack_types.h\"\n+\n+#include \"absl/status/statusor.h\"\n+#include \"include/dlpack/dlpack.h\"\n+#include \"xla/util.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+absl::StatusOr<DLDataType> PrimitiveTypeToDLDataType(PrimitiveType type) {\n+  switch (type) {\n+    case S8:\n+      return DLDataType{kDLInt, 8, 1};\n+    case S16:\n+      return DLDataType{kDLInt, 16, 1};\n+    case S32:\n+      return DLDataType{kDLInt, 32, 1};\n+    case S64:\n+      return DLDataType{kDLInt, 64, 1};\n+    case U8:\n+      return DLDataType{kDLUInt, 8, 1};\n+    case U16:\n+      return DLDataType{kDLUInt, 16, 1};\n+    case U32:\n+      return DLDataType{kDLUInt, 32, 1};\n+    case U64:\n+      return DLDataType{kDLUInt, 64, 1};\n+    case F4E2M1FN:\n+      return DLDataType{kDLFloat4_e2m1fn, 4, 1};\n+    case F8E3M4:\n+      return DLDataType{kDLFloat8_e3m4, 8, 1};\n+    case F8E4M3:\n+      return DLDataType{kDLFloat8_e4m3, 8, 1};\n+    case F8E4M3B11FNUZ:\n+      return DLDataType{kDLFloat8_e4m3b11fnuz, 8, 1};\n+    case F8E4M3FN:\n+      return DLDataType{kDLFloat8_e4m3fn, 8, 1};\n+    case F8E4M3FNUZ:\n+      return DLDataType{kDLFloat8_e4m3fnuz, 8, 1};\n+    case F8E5M2:\n+      return DLDataType{kDLFloat8_e5m2, 8, 1};\n+    case F8E5M2FNUZ:\n+      return DLDataType{kDLFloat8_e5m2fnuz, 8, 1};\n+    case F8E8M0FNU:\n+      return DLDataType{kDLFloat8_e8m0fnu, 8, 1};\n+    case BF16:\n+      return DLDataType{kDLBfloat, 16, 1};\n+    case F16:\n+      return DLDataType{kDLFloat, 16, 1};\n+    case F32:\n+      return DLDataType{kDLFloat, 32, 1};\n+    case F64:\n+      return DLDataType{kDLFloat, 64, 1};\n+    case PRED:\n+      return DLDataType{kDLBool, 8, 1};\n+    case C64:\n+      return DLDataType{kDLComplex, 64, 1};\n+    case C128:\n+      return DLDataType{kDLComplex, 128, 1};\n+    default:\n+      return Unimplemented(\"XLA type %s has no DLPack equivalent\",\n+                           PrimitiveType_Name(type));\n+  }\n+}\n+\n+absl::StatusOr<PrimitiveType> DLDataTypeToPrimitiveType(DLDataType type) {\n+  if (type.lanes != 1) {\n+    return Unimplemented(\"DLPack types with lanes != 1 not implemented, got %d\",\n+                         type.lanes);\n+  }\n+  switch (type.code) {\n+    case kDLBool:\n+      switch (type.bits) {\n+        case 8:\n+          return PRED;\n+        default:\n+          return Unimplemented(\n+              \"Only 8-bit DLPack booleans are supported, got %d bits\",\n+              type.bits);\n+      }\n+    case kDLInt:\n+      switch (type.bits) {\n+        case 8:\n+          return S8;\n+        case 16:\n+          return S16;\n+        case 32:\n+          return S32;\n+        case 64:\n+          return S64;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack integer width: %d bits\",\n+              type.bits);\n+      }\n+    case kDLUInt:\n+      switch (type.bits) {\n+        case 8:\n+          return U8;\n+        case 16:\n+          return U16;\n+        case 32:\n+          return U32;\n+        case 64:\n+          return U64;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack unsigned integer width: %d bits\",\n+              type.bits);\n+      }\n+    case kDLFloat4_e2m1fn:\n+      if (type.bits == 4) {\n+        return F4E2M1FN;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float4_e2m1fn width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e3m4:\n+      if (type.bits == 8) {\n+        return F8E3M4;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e3m4 width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3:\n+      if (type.bits == 8) {\n+        return F8E4M3;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3 width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3b11fnuz:\n+      if (type.bits == 8) {\n+        return F8E4M3B11FNUZ;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3b11fnuz width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3fn:\n+      if (type.bits == 8) {\n+        return F8E4M3FN;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3fn width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3fnuz:\n+      if (type.bits == 8) {\n+        return F8E4M3FNUZ;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3fnuz width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e5m2:\n+      if (type.bits == 8) {\n+        return F8E5M2;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e5m2 width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e5m2fnuz:\n+      if (type.bits == 8) {\n+        return F8E5M2FNUZ;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e5m2fnuz width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e8m0fnu:\n+      if (type.bits == 8) {\n+        return F8E8M0FNU;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e8m0fnu width: %d bits\",\n+          type.bits);\n+    case kDLBfloat:\n+      if (type.bits == 16) {\n+        return BF16;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack bfloat width: %d bits\", type.bits);\n+    case kDLFloat:\n+      switch (type.bits) {\n+        case 16:\n+          return F16;\n+        case 32:\n+          return F32;\n+        case 64:\n+          return F64;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack float width: %d bits\", type.bits);\n+      }\n+    case kDLComplex:\n+      switch (type.bits) {\n+        case 64:\n+          return C64;\n+        case 128:\n+          return C128;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack complex width: %d bits\",\n+              type.bits);\n+      }\n+    default:\n+      return Unimplemented(\"Unknown or invalid DLPack type code %d\", type.code);\n+  }\n+}\n+\n+}  // namespace xla"
        },
        {
            "sha": "df64c9baf3ad9901c57f14b791cbab475c20a698",
            "filename": "third_party/xla/xla/python/dlpack_types.h",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fdlpack_types.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fdlpack_types.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fdlpack_types.h?ref=de237d1133ab0efe9ec5f68300de55e03601283a",
            "patch": "@@ -0,0 +1,30 @@\n+/* Copyright 2025 The JAX Authors\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PYTHON_DLPACK_TYPES_H_\n+#define XLA_PYTHON_DLPACK_TYPES_H_\n+\n+#include \"absl/status/statusor.h\"\n+#include \"include/dlpack/dlpack.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+absl::StatusOr<DLDataType> PrimitiveTypeToDLDataType(PrimitiveType type);\n+absl::StatusOr<PrimitiveType> DLDataTypeToPrimitiveType(DLDataType type);\n+\n+}  // namespace xla\n+\n+#endif  // XLA_PYTHON_DLPACK_TYPES_H_"
        },
        {
            "sha": "a1048c0a8a8a5b4ce3858fac2ef3aa34a4ac53b5",
            "filename": "third_party/xla/xla/python/strides.cc",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fstrides.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fstrides.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fstrides.cc?ref=de237d1133ab0efe9ec5f68300de55e03601283a",
            "patch": "@@ -0,0 +1,68 @@\n+/* Copyright 2019 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/python/strides.h\"\n+\n+#include <cstdint>\n+#include <vector>\n+\n+#include \"absl/types/span.h\"\n+#include \"xla/layout.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n+#include \"xla/tsl/platform/logging.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+// Returns the strides for `shape`.\n+std::vector<int64_t> ByteStridesForShape(const Shape& shape) {\n+  std::vector<int64_t> strides;\n+  CHECK(shape.IsArray());\n+  CHECK(shape.has_layout());\n+  return ByteStridesForShape(shape.element_type(), shape.dimensions(),\n+                             shape.layout());\n+}\n+\n+static std::vector<int64_t> StridesForShapeHelper(\n+    PrimitiveType element_type, absl::Span<const int64_t> dimensions,\n+    const xla::Layout& layout, int64_t innermost_stride_size) {\n+  CHECK_EQ(dimensions.size(), layout.minor_to_major().size());\n+  std::vector<int64_t> strides;\n+  strides.resize(dimensions.size());\n+  int64_t stride = innermost_stride_size;\n+  for (int i : layout.minor_to_major()) {\n+    strides[i] = stride;\n+    stride *= dimensions[i];\n+  }\n+  return strides;\n+}\n+\n+std::vector<int64_t> ByteStridesForShape(PrimitiveType element_type,\n+                                         absl::Span<const int64_t> dimensions,\n+                                         const xla::Layout& layout) {\n+  return StridesForShapeHelper(\n+      element_type, dimensions, layout,\n+      ShapeUtil::ByteSizeOfPrimitiveType(element_type));\n+}\n+\n+std::vector<int64_t> StridesForShape(PrimitiveType element_type,\n+                                     absl::Span<const int64_t> dimensions,\n+                                     const xla::Layout& layout) {\n+  return StridesForShapeHelper(element_type, dimensions, layout,\n+                               /*innermost_stride_size=*/1);\n+}\n+\n+}  // namespace xla"
        },
        {
            "sha": "d86d6f2d5c3694fa8905823134ad4f8dacd3a937",
            "filename": "third_party/xla/xla/python/strides.h",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fstrides.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de237d1133ab0efe9ec5f68300de55e03601283a/third_party%2Fxla%2Fxla%2Fpython%2Fstrides.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fstrides.h?ref=de237d1133ab0efe9ec5f68300de55e03601283a",
            "patch": "@@ -0,0 +1,40 @@\n+/* Copyright 2019 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PYTHON_STRIDES_H_\n+#define XLA_PYTHON_STRIDES_H_\n+\n+#include <cstdint>\n+#include <vector>\n+\n+#include \"absl/types/span.h\"\n+#include \"xla/layout.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+// Returns the strides for `shape`.\n+std::vector<int64_t> ByteStridesForShape(const Shape& shape);\n+std::vector<int64_t> ByteStridesForShape(PrimitiveType element_type,\n+                                         absl::Span<const int64_t> dimensions,\n+                                         const xla::Layout& layout);\n+std::vector<int64_t> StridesForShape(PrimitiveType element_type,\n+                                     absl::Span<const int64_t> dimensions,\n+                                     const xla::Layout& layout);\n+\n+}  // namespace xla\n+\n+#endif  // XLA_PYTHON_STRIDES_H_"
        }
    ],
    "stats": {
        "total": 397,
        "additions": 396,
        "deletions": 1
    }
}