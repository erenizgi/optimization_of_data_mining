{
    "author": "bixia1",
    "message": "Tidy up the parser checks for AsyncStart/Update/Done.\n\nPreviously, we check that AsyncUpdate/Done have a single operand with a shape that conforms to the shape of AsyncStart, and the single operand is an Asynchronous op. This is now replaced by ensuring that AsyncUpdate/Done have a single operand which is an AsyncStart/Update.\n\nPreviously, we check that AsyncUpdate has a result shape that conforms to the shape of AsyncStart. This is now replaced by ensuring that the AsyncUpdate operand and result have the same shape, like the HloVerifier does.\n\nPiperOrigin-RevId: 843024671",
    "sha": "3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3",
    "files": [
        {
            "sha": "57d934e6437ea0ea3fc664840f8ce142bb82dc42",
            "filename": "third_party/xla/xla/hlo/parser/hlo_parser.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 27,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc?ref=3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3",
            "patch": "@@ -2070,27 +2070,11 @@ HloInstruction* HloParserImpl::CreateInstruction(  // NOLINT\n       if (!preset_operands && !ParseOperands(&operands, builder)) {\n         return nullptr;\n       }\n-      auto is_async_shape_correct = [](const Shape& shape) {\n-        return shape.IsTuple() && shape.tuple_shapes().size() >= 2 &&\n-               shape.tuple_shapes(0).IsTuple();\n-      };\n-      // Verify operand/resulting shapes\n-      if (opcode == HloOpcode::kAsyncUpdate ||\n-          opcode == HloOpcode::kAsyncDone) {\n-        if (operands.size() != 1 ||\n-            !is_async_shape_correct(operands[0]->shape())) {\n-          TokenError(\n-              \"AsyncUpdate and AsyncDone expect a single operand in the form \"\n-              \"of ((async-operands), async-outputs, state).\");\n-          return nullptr;\n-        }\n-      }\n-      if (opcode == HloOpcode::kAsyncStart ||\n-          opcode == HloOpcode::kAsyncUpdate) {\n-        if (!is_async_shape_correct(*shape)) {\n+      if (opcode == HloOpcode::kAsyncStart) {\n+        if (!shape->IsTuple() || shape->tuple_shapes().size() < 2 ||\n+            !shape->tuple_shapes(0).IsTuple()) {\n           TokenError(\n-              \"AsyncStart and AsyncUpdate expect the op shape to be in the \"\n-              \"form of \"\n+              \"AsyncStart expects the op shape to be in the form of \"\n               \"((async-operands), async-outputs, state).\");\n           return nullptr;\n         }\n@@ -2099,17 +2083,20 @@ HloInstruction* HloParserImpl::CreateInstruction(  // NOLINT\n       // previous async op.\n       if (opcode == HloOpcode::kAsyncUpdate ||\n           opcode == HloOpcode::kAsyncDone) {\n-        if (operands.size() != 1 ||\n-            !is_async_shape_correct(operands[0]->shape())) {\n+        if (operands.size() != 1 || !operands[0]->IsAsynchronous() ||\n+            operands[0]->opcode() == HloOpcode::kAsyncDone) {\n           TokenError(\n-              \"AsyncUpdate and AsyncDone expect a single operand in the form \"\n-              \"of ((async-operands), async-outputs, state).\");\n+              \"AsyncUpdate and AsyncDone expect a single async op as their \"\n+              \"operand.\");\n           return nullptr;\n         }\n-        if (!operands[0]->IsAsynchronous()) {\n+      }\n+      // For AsyncUpdate, the operand and the result should have the same shape.\n+      if (opcode == HloOpcode::kAsyncUpdate) {\n+        if (operands[0]->shape() != *shape) {\n           TokenError(\n-              \"AsyncUpdate and AsyncDone expect their operand to be the \"\n-              \"previous async op.\");\n+              \"AsyncUpdate expects the op shape to be the same as the operand \"\n+              \"shape.\");\n           return nullptr;\n         }\n       }"
        },
        {
            "sha": "2d2cbf31651e68e212aa48a8b2605e579449d852",
            "filename": "third_party/xla/xla/hlo/parser/hlo_parser_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc?ref=3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3",
            "patch": "@@ -5362,8 +5362,7 @@ ENTRY AsyncStartMissingOperandWrapper {\n       ParseAndReturnUnverifiedModule(hlo_string).status(),\n       absl_testing::StatusIs(\n           tsl::error::INVALID_ARGUMENT,\n-          HasSubstr(\"AsyncStart and AsyncUpdate expect the op shape to be \"\n-                    \"in the form of \"\n+          HasSubstr(\"AsyncStart expects the op shape to be in the form of \"\n                     \"((async-operands), async-outputs, state).\")));\n }\n \n@@ -5385,11 +5384,9 @@ ENTRY AsyncUpdateMissingOperandWrapper {\n   )\";\n   EXPECT_THAT(\n       ParseAndReturnUnverifiedModule(hlo_string).status(),\n-      absl_testing::StatusIs(\n-          tsl::error::INVALID_ARGUMENT,\n-          HasSubstr(\"AsyncStart and AsyncUpdate expect the op shape to be \"\n-                    \"in the form of \"\n-                    \"((async-operands), async-outputs, state).\")));\n+      absl_testing::StatusIs(tsl::error::INVALID_ARGUMENT,\n+                             HasSubstr(\"AsyncUpdate expects the op shape to be \"\n+                                       \"the same as the operand shape.\")));\n }\n \n TEST_F(HloParserTest, AsyncOpTupleWrongType) {\n@@ -5411,8 +5408,7 @@ ENTRY AsyncStartAndAsyncDone {\n       ParseAndReturnUnverifiedModule(hlo_string).status(),\n       absl_testing::StatusIs(\n           tsl::error::INVALID_ARGUMENT,\n-          HasSubstr(\"AsyncStart and AsyncUpdate expect the op shape to be \"\n-                    \"in the form of \"\n+          HasSubstr(\"AsyncStart expects the op shape to be in the form of \"\n                     \"((async-operands), async-outputs, state).\")));\n }\n \n@@ -5429,10 +5425,9 @@ ENTRY AsyncStartAndAsyncDone {\n   )\";\n   EXPECT_THAT(\n       ParseAndReturnUnverifiedModule(hlo_string).status(),\n-      absl_testing::StatusIs(\n-          tsl::error::INVALID_ARGUMENT,\n-          HasSubstr(\"AsyncUpdate and AsyncDone expect their operand to be \"\n-                    \"the previous async op.\")));\n+      absl_testing::StatusIs(tsl::error::INVALID_ARGUMENT,\n+                             HasSubstr(\"AsyncUpdate and AsyncDone expect a \"\n+                                       \"single async op as their operand.\")));\n }\n \n TEST_F(HloParserTest, AsyncUpdateAndAsyncDoneNoAsyncStart) {\n@@ -5449,10 +5444,9 @@ ENTRY AsyncStartAndAsyncDone {\n   )\";\n   EXPECT_THAT(\n       ParseAndReturnUnverifiedModule(hlo_string).status(),\n-      absl_testing::StatusIs(\n-          tsl::error::INVALID_ARGUMENT,\n-          HasSubstr(\"AsyncUpdate and AsyncDone expect their operand to be \"\n-                    \"the previous async op.\")));\n+      absl_testing::StatusIs(tsl::error::INVALID_ARGUMENT,\n+                             HasSubstr(\"AsyncUpdate and AsyncDone expect a \"\n+                                       \"single async op as their operand.\")));\n }\n \n TEST_F(HloParserTest, AsyncUpdateWithSyntaxSugarWrongOp) {"
        },
        {
            "sha": "99010d48c72fa713dd8e08b9b5fb79cfd6c786a4",
            "filename": "third_party/xla/xla/service/hlo_verifier_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 27,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc?ref=3c3712f6a0066643c17b9627cd2c54d6ce7fb9a3",
            "patch": "@@ -1431,33 +1431,6 @@ TEST_F(HloVerifierTest, AsyncDoneOutputWrongType) {\n                         \"async shape at index {1}\"));\n }\n \n-TEST_F(HloVerifierTest, AsyncUpdateWrongType) {\n-  const char* const hlo_string = R\"(\n-  HloModule Module\n-\n-  async_computation {\n-    p = f32[2,3] parameter(0)\n-    ROOT custom-call = f32[3,2] custom-call(p), custom_call_target=\"foo\"\n-  }\n-\n-  ENTRY AsyncStartAndAsyncDone {\n-    p0 = f32[2,3] parameter(0)\n-    async-start = ((f32[2,3]), f32[3,2], u32[]) async-start(p0), calls=async_computation\n-    async-update = ((f32[3,2]), f32[3,2], u32[]) async-update(async-start), calls=async_computation\n-    ROOT async-done = f32[3,2] async-done(async-update), calls=async_computation\n-  }\n-  )\";\n-  TF_ASSERT_OK_AND_ASSIGN(auto module,\n-                          ParseAndReturnUnverifiedModule(hlo_string));\n-\n-  auto status = verifier().Run(module.get()).status();\n-  ASSERT_FALSE(status.ok());\n-  EXPECT_THAT(\n-      status.message(),\n-      HasSubstr(\n-          \"async-update expects the shape of operand and output to match\"));\n-}\n-\n TEST_F(HloVerifierTest, AsyncOpComputationNotTrivial) {\n   const char* const hlo_string = R\"(\n   HloModule Module"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 25,
        "deletions": 71
    }
}