{
    "author": "beckerhe",
    "message": "Pin Docker images in XLA presubmit benchmarks\n\nA recent docker image upgrade broke the XLA presubmits, so let's pin them to working versions. This is the closest to a rollback that I could come up with.\n\nThere was a recent drop in image size (almost 2 GiB), so I suspect a bunch of things got removed including PyYAML which broke the benchmark scripts. Therefore this is pinning to the latest image before the size drop.\n\nPiperOrigin-RevId: 815643193",
    "sha": "40128c77c6f37aaacc4f4871372087e9b67384a7",
    "files": [
        {
            "sha": "c3434c0bdeadd2905acbb630adfe103c13efdc9a",
            "filename": "third_party/xla/xla/tools/benchmarks/utils/generate_benchmark_matrices.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40128c77c6f37aaacc4f4871372087e9b67384a7/third_party%2Fxla%2Fxla%2Ftools%2Fbenchmarks%2Futils%2Fgenerate_benchmark_matrices.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40128c77c6f37aaacc4f4871372087e9b67384a7/third_party%2Fxla%2Fxla%2Ftools%2Fbenchmarks%2Futils%2Fgenerate_benchmark_matrices.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fbenchmarks%2Futils%2Fgenerate_benchmark_matrices.cc?ref=40128c77c6f37aaacc4f4871372087e9b67384a7",
            "patch": "@@ -106,24 +106,24 @@ GetHardwareToRunnerLabelMap() {\n \n const absl::flat_hash_map<std::string, std::string>&\n GetHardwareToContainerImage() {\n-  static const auto* kHardwareToContainerImage =\n-      new absl::flat_hash_map<std::string, std::string>{\n-          {\"CPU_X86\",\n-           \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n-           \"ml-build:latest\"},\n-          {\"CPU_ARM64\",\n-           \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n-           \"ml-build-arm64:latest\"},\n-          {\"GPU_L4\",\n-           \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n-           \"ml-build-cuda12.8-cudnn9.8:latest\"},\n-          {\"GPU_B200\",\n-           \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n-           \"ml-build-cuda12.8-cudnn9.8:latest\"},\n-          {\"GPU_L4_1H_4D\",\n-           \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n-           \"ml-build-cuda12.8-cudnn9.8:latest\"},\n-      };\n+  static const auto* kHardwareToContainerImage = new absl::flat_hash_map<\n+      std::string, std::string>{\n+      {\"CPU_X86\",\n+       \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n+       \"ml-build:infrastructure-public-image-530371eedb7e\"},\n+      {\"CPU_ARM64\",\n+       \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n+       \"ml-build-arm64:latest\"},\n+      {\"GPU_L4\",\n+       \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n+       \"ml-build-cuda12.8-cudnn9.8:infrastructure-public-image-46c0fc3324bc\"},\n+      {\"GPU_B200\",\n+       \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n+       \"ml-build-cuda12.8-cudnn9.8:infrastructure-public-image-46c0fc3324bc\"},\n+      {\"GPU_L4_1H_4D\",\n+       \"us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/\"\n+       \"ml-build-cuda12.8-cudnn9.8:infrastructure-public-image-46c0fc3324bc\"},\n+  };\n   return *kHardwareToContainerImage;\n }\n "
        },
        {
            "sha": "9edf6d4410c5d50f64114d716ab4103d540edce9",
            "filename": "third_party/xla/xla/tools/benchmarks/utils/generate_benchmark_matrices_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40128c77c6f37aaacc4f4871372087e9b67384a7/third_party%2Fxla%2Fxla%2Ftools%2Fbenchmarks%2Futils%2Fgenerate_benchmark_matrices_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40128c77c6f37aaacc4f4871372087e9b67384a7/third_party%2Fxla%2Fxla%2Ftools%2Fbenchmarks%2Futils%2Fgenerate_benchmark_matrices_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fbenchmarks%2Futils%2Fgenerate_benchmark_matrices_test.cc?ref=40128c77c6f37aaacc4f4871372087e9b67384a7",
            "patch": "@@ -78,6 +78,10 @@ std::string CreateTempRegistryFile(const std::string& content,\n MATCHER_P(JsonStringEq, expected_str, \"\") {\n   return arg.isString() && arg.asString() == expected_str;\n }\n+MATCHER_P(JsonStringHasSubtr, expected_str, \"\") {\n+  return arg.isString() && ExplainMatchResult(HasSubstr(expected_str),\n+                                              arg.asString(), result_listener);\n+}\n MATCHER_P(JsonBoolEq, expected_bool, \"\") {\n   return arg.isBool() && arg.asBool() == expected_bool;\n }\n@@ -263,8 +267,8 @@ TEST_F(GenerateBenchmarkMatricesTest,\n   EXPECT_THAT(entry0[\"runner_label\"], JsonStringEq(\"linux-x86-g2-16-l4-1gpu\"));\n   EXPECT_THAT(\n       entry0[\"container_image\"],\n-      JsonStringEq(\"us-docker.pkg.dev/ml-oss-artifacts-published/\"\n-                   \"ml-public-container/ml-build-cuda12.8-cudnn9.8:latest\"));\n+      JsonStringHasSubtr(\"us-docker.pkg.dev/ml-oss-artifacts-published/\"\n+                         \"ml-public-container/ml-build-cuda12.8-cudnn9.8\"));\n   EXPECT_THAT(entry0[\"runtime_flags\"],\n               JsonArrayContainsString(\"--repeat_l4=5\"));\n   EXPECT_THAT(entry0[\"xla_compilation_flags\"],\n@@ -281,8 +285,8 @@ TEST_F(GenerateBenchmarkMatricesTest,\n               JsonStringEq(\"gemma_test_x86_1h2d_presubmit\"));\n   EXPECT_THAT(entry1[\"runner_label\"], JsonStringEq(\"linux-x86-n2-128\"));\n   EXPECT_THAT(entry1[\"container_image\"],\n-              JsonStringEq(\"us-docker.pkg.dev/ml-oss-artifacts-published/\"\n-                           \"ml-public-container/ml-build:latest\"));\n+              JsonStringHasSubtr(\"us-docker.pkg.dev/ml-oss-artifacts-published/\"\n+                                 \"ml-public-container/ml-build\"));\n   EXPECT_THAT(entry1[\"runtime_flags\"],\n               JsonArrayContainsString(\"--repeat_cpu=3\"));\n   EXPECT_THAT(entry1[\"xla_compilation_flags\"],"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 26,
        "deletions": 22
    }
}