{
    "author": "tensorflower-gardener",
    "message": "[XLA] Handle nested while loops in CollectivePipeliner.\n\nThis CL modifies the collective pipeliner to generate unique body and condition computations for newly generated while loop instructions.\n\nPiperOrigin-RevId: 822719229",
    "sha": "aeda5dabd40aff0e8561701522745fdc60e9ddae",
    "files": [
        {
            "sha": "df72e5d64b7c2df592ceb4d75f9020d6c8a12cdb",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aeda5dabd40aff0e8561701522745fdc60e9ddae/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aeda5dabd40aff0e8561701522745fdc60e9ddae/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=aeda5dabd40aff0e8561701522745fdc60e9ddae",
            "patch": "@@ -498,6 +498,7 @@ xla_cc_test(\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@local_tsl//tsl/platform:statusor\","
        },
        {
            "sha": "dbde9a833eee537f8d8144b656e5c0df52b5ad8a",
            "filename": "third_party/xla/xla/service/collective_pipeliner.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aeda5dabd40aff0e8561701522745fdc60e9ddae/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aeda5dabd40aff0e8561701522745fdc60e9ddae/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner.cc?ref=aeda5dabd40aff0e8561701522745fdc60e9ddae",
            "patch": "@@ -359,8 +359,8 @@ CheckStoreIntoSliceIsCompatible(\n                             HloOpcode::kAllReduce, HloOpcode::kTranspose,\n                             HloOpcode::kBroadcast, HloOpcode::kAllGather,\n                             HloOpcode::kReduce, HloOpcode::kGetTupleElement,\n-                            HloOpcode::kConcatenate, HloOpcode::kReduceScatter>(\n-               i) ||\n+                            HloOpcode::kConcatenate, HloOpcode::kReduceScatter,\n+                            HloOpcode::kBitcast>(i) ||\n            (multi_uses_pipelining && i->IsElementwise()) ||\n            (i->opcode() == HloOpcode::kCustomCall &&\n             !Cast<HloCustomCallInstruction>(i)\n@@ -1882,6 +1882,14 @@ absl::Status TransformLoopForward(\n         MapNewOperands(instr->operands(), while_body_to_peeled);\n     HloInstruction* cloned_instr = loop_computation->AddInstruction(\n         instr->CloneWithNewOperands(instr->shape(), new_operands));\n+    if (cloned_instr->opcode() == HloOpcode::kWhile) {\n+      cloned_instr->set_while_condition(\n+          loop_computation->parent()->AddEmbeddedComputation(\n+              instr->while_condition()->CloneWithReplacements(nullptr)));\n+      cloned_instr->set_while_body(\n+          loop_computation->parent()->AddEmbeddedComputation(\n+              instr->while_body()->CloneWithReplacements(nullptr)));\n+    }\n     TF_RETURN_IF_ERROR(\n         UpdateControlDependencies(instr, cloned_instr, while_body_to_peeled));\n     UpdateInstructionChannelId(cloned_instr, next_channel_id);\n@@ -3051,6 +3059,14 @@ static absl::Status TransformLoopBackward(\n           MapNewOperands(instr->operands(), while_body_replacement_map);\n       cloned_instr = body_builder.AddInstruction(\n           instr->CloneWithNewOperands(instr->shape(), new_operands));\n+      if (cloned_instr->opcode() == HloOpcode::kWhile) {\n+        cloned_instr->set_while_condition(\n+            while_loop->GetModule()->AddEmbeddedComputation(\n+                instr->while_condition()->CloneWithReplacements(nullptr)));\n+        cloned_instr->set_while_body(\n+            while_loop->GetModule()->AddEmbeddedComputation(\n+                instr->while_body()->CloneWithReplacements(nullptr)));\n+      }\n       TF_RETURN_IF_ERROR(UpdateControlDependencies(instr, cloned_instr,\n                                                    while_body_replacement_map));\n       UpdateInstructionChannelId(cloned_instr, next_channel_id);"
        },
        {
            "sha": "b3acea7dfa4d99c853639aca2545bcecbe8b257c",
            "filename": "third_party/xla/xla/service/collective_pipeliner_test.cc",
            "status": "modified",
            "additions": 99,
            "deletions": 0,
            "changes": 99,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aeda5dabd40aff0e8561701522745fdc60e9ddae/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aeda5dabd40aff0e8561701522745fdc60e9ddae/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc?ref=aeda5dabd40aff0e8561701522745fdc60e9ddae",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n@@ -3254,6 +3255,104 @@ ENTRY main.3813_spmd {\n   ASSERT_IS_OK(verifier.Run(module.get()).status());\n }\n \n+TEST_F(CollectivePipelinerTest, ClonedWhileLoopHasUniqueBodyAndCondition) {\n+  constexpr absl::string_view hlo_string = R\"(\n+HloModule module\n+\n+to_apply0 {\n+  Arg_0.732 = bf16[] parameter(0)\n+  Arg_1.733 = bf16[] parameter(1)\n+  ROOT add.734 = bf16[] add(Arg_0.732, Arg_1.733)\n+}\n+\n+body_inner {\n+ p2 = (s32[], bf16[3,4096,4096]{2,1,0}) parameter(0)\n+ gte1 = s32[] get-tuple-element(p2), index=0\n+  gte2 = bf16[3,4096,4096]{2,1,0} get-tuple-element(p2), index=1\n+  add = bf16[3,4096,4096]{2,1,0} add(gte2, gte2)\n+  ROOT tuple = (s32[], bf16[3,4096,4096]{2,1,0}) tuple(gte1, gte2)\n+\n+}\n+\n+condition_inner {\n+  cond_p1 = (s32[], bf16[3,4096,4096]{2,1,0}) parameter(0)\n+  gte1 = s32[] get-tuple-element(cond_p1), index=0\n+  c1 = s32[] constant(9)\n+  ROOT comp0 = pred[] compare(gte1, c1), direction=LT\n+}\n+\n+body {\n+  p2 = (s32[], bf16[3,4096,4096]{2,1,0}, bf16[10,512,3,4096]{3,2,1,0}) parameter(0)\n+  gte2 = bf16[3,4096,4096]{2,1,0} get-tuple-element(p2), index=1\n+  gte3 = bf16[10,512,3,4096]{3,2,1,0} get-tuple-element(p2), index=2\n+  c2 = s32[] constant(9)\n+  gte4 = s32[] get-tuple-element(p2), index=0\n+  sub0 = s32[] subtract(c2, gte4)\n+  c3 = s32[] constant(0)\n+  comp1 = pred[] compare(sub0, c3), direction=LT\n+  c4 = s32[] constant(19)\n+  sub2 = s32[] subtract(c4, gte4)\n+  sel0 = s32[] select(comp1, sub2, sub0)\n+\n+  rsp0 = bf16[3,4096,4096]{2,1,0} reshape(gte2)\n+  t = (s32[], bf16[3,4096,4096]{2,1,0}) tuple(c3, rsp0)\n+  w0 = (s32[], bf16[3,4096,4096]{2,1,0}) while(t), condition=condition_inner, body=body_inner\n+  rsp0_postwhile = bf16[3,4096,4096]{2,1,0} get-tuple-element(w0), index=1\n+  rs0 = bf16[3,4096,512]{2,1,0} reduce-scatter(rsp0_postwhile), channel_id=75, replica_groups={{0,1,2,3}}, dimensions={2}, to_apply=to_apply0\n+  tran0 = bf16[512,3,4096]{0,2,1} transpose(rs0), dimensions={2,0,1}\n+  rsp1 = bf16[1,512,3,4096]{3,2,1,0} bitcast(tran0)\n+  dus0 = bf16[10,512,3,4096]{3,2,1,0} dynamic-update-slice(gte3, rsp1, sel0, c3, c3, /*index=5*/c3)\n+  c5 = s32[] constant(1)\n+  add0 = s32[] add(gte4, c5)\n+  ROOT t1 = (s32[], bf16[3,4096,4096]{2,1,0}, bf16[10,512,3,4096]{3,2,1,0}) tuple(add0, rsp0, dus0)\n+} // body\n+\n+condition {\n+  cond_p1 = (s32[], bf16[3,4096,4096]{2,1,0}, bf16[10,512,3,4096]{3,2,1,0}) parameter(0)\n+  gte1 = s32[] get-tuple-element(cond_p1), index=0\n+  c1 = s32[] constant(9)\n+  ROOT comp0 = pred[] compare(gte1, c1), direction=LT\n+}\n+\n+ENTRY main.3813_spmd {\n+  p0 = bf16[3,4096,4096]{2,1,0} parameter(0)\n+  p1 = bf16[10,512,3,4096]{3,2,1,0} parameter(1)\n+  c0 = s32[] constant(0)\n+\n+  t0 = (s32[], bf16[3,4096,4096]{2,1,0}, bf16[10,512,3,4096]{3,2,1,0}) tuple(c0, p0, p1)\n+  w0 = (s32[], bf16[3,4096,4096]{2,1,0}, bf16[10,512,3,4096]{3,2,1,0}) while(t0), condition=condition, body=body\n+  ROOT gte0 = bf16[3,4096,4096]{2,1,0} get-tuple-element(w0), index=1\n+}\n+)\";\n+  auto module = ParseAndReturnUnverifiedModule(hlo_string, config_).value();\n+  XLA_VLOG_LINES(1, absl::StrCat(\"Before: \", module->ToString()));\n+  EXPECT_TRUE(\n+      RunOptimizer(module.get(), /*last_run=*/true, 0,\n+                   /*pipeline_use_tree=*/true,\n+                   /*process_different_sized_ops=*/true,\n+                   collective_pipeliner_utils::PipeliningDirection::kForward,\n+                   HloPredicateIsOp<HloOpcode::kReduceScatter>)\n+          .value());\n+  XLA_VLOG_LINES(1, absl::StrCat(\"After: \", module->ToString()));\n+  HloVerifier verifier(/*layout_sensitive=*/false,\n+                       /*allow_mixed_precision*/ true);\n+  ASSERT_IS_OK(verifier.Run(module.get()).status());\n+  absl::flat_hash_set<HloComputation*> body_computations_seen;\n+  absl::flat_hash_set<HloComputation*> condition_computations_seen;\n+  for (auto* computation : module->computations()) {\n+    for (auto* instruction : computation->instructions()) {\n+      if (instruction->opcode() == HloOpcode::kWhile) {\n+        ASSERT_TRUE(\n+            !body_computations_seen.contains(instruction->while_body()));\n+        ASSERT_TRUE(!condition_computations_seen.contains(\n+            instruction->while_condition()));\n+        body_computations_seen.insert(instruction->while_body());\n+        condition_computations_seen.insert(instruction->while_condition());\n+      }\n+    }\n+  }\n+}\n+\n TEST_F(CollectivePipelinerTest,\n        PipelineBackwardIncludeInvariantMultiConsumerInChain) {\n   constexpr absl::string_view hlo_string = R\"("
        }
    ],
    "stats": {
        "total": 120,
        "additions": 118,
        "deletions": 2
    }
}