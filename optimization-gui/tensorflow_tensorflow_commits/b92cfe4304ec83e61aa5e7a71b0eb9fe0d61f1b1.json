{
    "author": "thomasjoerg",
    "message": "[PjRt] Avoid race conditions in LocalDeviceState destructor.\n\nPiperOrigin-RevId: 837008057",
    "sha": "b92cfe4304ec83e61aa5e7a71b0eb9fe0d61f1b1",
    "files": [
        {
            "sha": "b3e16c8e8f20abc4ed207ef08faaf3ea9f957628",
            "filename": "third_party/xla/xla/pjrt/local_device_state.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b92cfe4304ec83e61aa5e7a71b0eb9fe0d61f1b1/third_party%2Fxla%2Fxla%2Fpjrt%2Flocal_device_state.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b92cfe4304ec83e61aa5e7a71b0eb9fe0d61f1b1/third_party%2Fxla%2Fxla%2Fpjrt%2Flocal_device_state.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Flocal_device_state.cc?ref=b92cfe4304ec83e61aa5e7a71b0eb9fe0d61f1b1",
            "patch": "@@ -139,15 +139,16 @@ LocalDeviceState::~LocalDeviceState() {\n     LOG(ERROR) << \"Error when closing device: \" << status;\n   }\n \n-  // Explicitly delete all the streams to ensure that their callbacks are\n-  // executed before the destruction of the LocalDeviceState and its callback\n-  // threads.\n+  // Explicitly delete all the streams and events to ensure that their callbacks\n+  // are executed before the destruction of the LocalDeviceState and its\n+  // callback threads.\n   external_ready_event_streams_.clear();\n   fixed_size_pool_usage_streams_.clear();\n   device_to_device_streams_.clear();\n   device_to_host_streams_.clear();\n   host_to_device_stream_.reset();\n   compute_stream_.reset();\n+  compute_events_.clear();\n }\n \n absl::Status LocalDeviceState::SynchronizeAllActivity() {"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 4,
        "deletions": 3
    }
}