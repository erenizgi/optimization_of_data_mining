{
    "author": "ezhulenev",
    "message": "[xla] Migrate to PjRtFuture<>::MakePromise() API\n\nPiperOrigin-RevId: 806421771",
    "sha": "0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
    "files": [
        {
            "sha": "c4ca1e8cd393f0228ad2eef120057fae05192ac3",
            "filename": "tensorflow/core/tfrt/ifrt/checkpoint_loader.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fcheckpoint_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fcheckpoint_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fcheckpoint_loader.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -245,8 +245,8 @@ absl::Status RunShard(RestoreVariableShard shard,\n       fallback_request_state.process_function_library_runtime());\n \n   for (int i = 0; i < num_outputs; ++i) {\n-    auto promise = xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-    auto future = xla::ifrt::Future<tensorflow::Tensor>(promise);\n+    auto [promise, future] =\n+        xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n     const ResourceHandle& var_handle =\n         shard.var_handles[i].tensor().scalar<tensorflow::ResourceHandle>()();\n "
        },
        {
            "sha": "6fad9166da6ebaf77e85f34364bcc58681a79325",
            "filename": "tensorflow/core/tfrt/ifrt/ifrt_loaded_variable_utils.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -110,10 +110,8 @@ absl::Status AsyncLoadRestoredTensorAsIfrtLoadedVariable(\n     return absl::InternalError(absl::StrCat(\n         \"LoadVariableOp: failed to fetch variable tensor: \", tensor_name));\n   }\n-  auto loaded_variable_promise =\n-      xla::ifrt::Future<xla::ifrt::ArrayRef>::CreatePromise();\n-  auto loaded_variable_future =\n-      xla::ifrt::Future<xla::ifrt::ArrayRef>(loaded_variable_promise);\n+  auto [loaded_variable_promise, loaded_variable_future] =\n+      xla::ifrt::Future<xla::ifrt::ArrayRef>::MakePromise();\n   TF_ASSIGN_OR_RETURN(\n       absl::StatusOr<ifrt_serving::DtypeAndShape> dtype_and_shape,\n       restore_tensor_registry.GetDtypeAndShape(tensor_name));"
        },
        {
            "sha": "49c407c4acf1b8a9461f6680b94009b0bb0a85ac",
            "filename": "tensorflow/core/tfrt/ifrt/ifrt_loaded_variable_utils_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils_test.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -83,8 +83,7 @@ TEST(ShardingUtilsTest, ShardTensorToIfrtLoadedVariableNotFoundWrongName) {\n       .hlo_sharding = xla::HloSharding::Replicate(),\n   };\n \n-  auto promise = xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-  auto future = xla::ifrt::Future<tensorflow::Tensor>(promise);\n+  auto [promise, future] = xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n \n   IfrtRestoreTensorRegistry::RestoredTensorInfo restored_tensor_info = {\n       false,\n@@ -128,8 +127,7 @@ TEST(ShardingUtilsTest, ShardTensorToIfrtLoadedVariableSucceed) {\n       .hlo_sharding = xla::HloSharding::Replicate(),\n   };\n \n-  auto promise = xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-  auto future = xla::ifrt::Future<tensorflow::Tensor>(promise);\n+  auto [promise, future] = xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n \n   IfrtRestoreTensorRegistry::RestoredTensorInfo restored_tensor_info = {\n       false,"
        },
        {
            "sha": "f4938693d5847252b46d5c2f98918e4992a1cc76",
            "filename": "tensorflow/core/tfrt/ifrt/ifrt_serving_executable.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_serving_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_serving_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_serving_executable.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <memory>\n #include <optional>\n #include <string>\n+#include <tuple>\n #include <utility>\n #include <variant>\n #include <vector>\n@@ -598,8 +599,8 @@ IfrtServingExecutable::LookUpOrCreateExecutable(\n     }\n \n     // Only create promise and future when cache missed.\n-    promise = xla::ifrt::Future<SharedCachedExecutableBundle>::CreatePromise();\n-    future = xla::ifrt::Future<SharedCachedExecutableBundle>(promise);\n+    std::tie(promise, future) =\n+        xla::ifrt::Future<SharedCachedExecutableBundle>::MakePromise();\n \n     executable_bundles_.emplace(key, future);\n     // Clone the module to avoid race condition between Freeze() and"
        },
        {
            "sha": "5bda41b0e1b451e83096ff520a13cac066f28825",
            "filename": "tensorflow/core/tfrt/ifrt/ifrt_serving_executable_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_serving_executable_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_serving_executable_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_serving_executable_test.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -299,10 +299,8 @@ TEST_P(VariableInputTest, InterleaveVariable) {\n   std::vector<int> loaded_variable_indices;\n   for (int i = 0; i < GetParam().in_tensors.size(); i++) {\n     if (GetParam().is_variable[i]) {\n-      auto input_tensor_promise =\n-          xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-      auto input_tensor_future =\n-          xla::ifrt::Future<tensorflow::Tensor>(input_tensor_promise);\n+      auto [input_tensor_promise, input_tensor_future] =\n+          xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n       IfrtRestoreTensorRegistry::RestoredTensorInfo restore_tensor_info = {\n           .dtype_and_shape{.dtype = GetParam().in_tensors[i].dtype(),\n                            .shape = GetParam().in_tensors[i].shape()},"
        },
        {
            "sha": "3d64a73d5f221097cb952b0614d74799ac943443",
            "filename": "tensorflow/core/tfrt/ifrt/sharding_utils.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fsharding_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fsharding_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fsharding_utils.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -476,9 +476,8 @@ absl::StatusOr<xla::ifrt::Future<tensorflow::Tensor>> MakeTensorFromArrayHelper(\n   VLOG(2) << \"Create tensor from array based on sharding: \"\n           << hlo_sharding.ToString();\n \n-  xla::ifrt::Promise<tensorflow::Tensor> promise =\n-      xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-  xla::ifrt::Future<tensorflow::Tensor> output_tensor_future(promise);\n+  auto [promise, output_tensor_future] =\n+      xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n \n   if (hlo_sharding.IsReplicated()) {\n     VLOG(1) << \"Fast path for replication\";\n@@ -629,12 +628,14 @@ absl::StatusOr<xla::ifrt::Future<tensorflow::Tensor>> MakeTensorFromArrayHelper(\n           std::move(promise).Set(status);\n           return;\n         }\n+        auto shared_promise =\n+            std::make_shared<decltype(promise)>(std::move(promise));\n         thread_pool.Schedule(\n-            [promise = std::move(promise), &ifrt_client,\n+            [promise = std::move(shared_promise), &ifrt_client,\n              input_tensors = std::move(input_tensors),\n              num_concats = std::move(num_concats), data_type = data_type,\n              tensor_shape = tensor_shape, &thread_pool]() mutable {\n-              std::move(promise).Set(MakeTensorFromDisassembledTensors(\n+              std::move(promise)->Set(MakeTensorFromDisassembledTensors(\n                   ifrt_client, absl::MakeSpan(input_tensors), num_concats,\n                   data_type, tensor_shape, thread_pool));\n             });"
        },
        {
            "sha": "eb9194fa79a3750c3e81a67538988a39c4542bfd",
            "filename": "tensorflow/core/tfrt/mlrt/kernel/ifrt_ops_kernel_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fmlrt%2Fkernel%2Fifrt_ops_kernel_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68/tensorflow%2Fcore%2Ftfrt%2Fmlrt%2Fkernel%2Fifrt_ops_kernel_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fmlrt%2Fkernel%2Fifrt_ops_kernel_test.cc?ref=0bc1fbe8b2a8b9c9c6b558318f789b4893f6df68",
            "patch": "@@ -504,10 +504,8 @@ TEST_P(KernelTest, IfrtLoadVariableOp) {\n   tensorflow::Tensor input_tensor;\n   TF_CHECK_OK(tensorflow::Tensor::BuildTensor(DT_INT32, {}, &input_tensor));\n   input_tensor.scalar<int32_t>()() = 1234;\n-  auto input_tensor_promise =\n-      xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-  auto input_tensor_future =\n-      xla::ifrt::Future<tensorflow::Tensor>(input_tensor_promise);\n+  auto [input_tensor_promise, input_tensor_future] =\n+      xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n   ifrt_serving::IfrtRestoreTensorRegistry::RestoredTensorInfo\n       restore_tensor_info{.dtype_and_shape = {.dtype = input_tensor.dtype(),\n                                               .shape = input_tensor.shape()},\n@@ -556,10 +554,8 @@ TEST_P(KernelTest, DuplicateIfrtLoadVariableOpShallSucceed) {\n   tensorflow::Tensor input_tensor;\n   TF_CHECK_OK(tensorflow::Tensor::BuildTensor(DT_INT32, {}, &input_tensor));\n   input_tensor.scalar<int32_t>()() = 1234;\n-  auto input_tensor_promise =\n-      xla::ifrt::Future<tensorflow::Tensor>::CreatePromise();\n-  auto input_tensor_future =\n-      xla::ifrt::Future<tensorflow::Tensor>(input_tensor_promise);\n+  auto [input_tensor_promise, input_tensor_future] =\n+      xla::ifrt::Future<tensorflow::Tensor>::MakePromise();\n   ifrt_serving::IfrtRestoreTensorRegistry::RestoredTensorInfo\n       restore_tensor_info{.dtype_and_shape = {.dtype = input_tensor.dtype(),\n                                               .shape = input_tensor.shape()},"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 21,
        "deletions": 29
    }
}