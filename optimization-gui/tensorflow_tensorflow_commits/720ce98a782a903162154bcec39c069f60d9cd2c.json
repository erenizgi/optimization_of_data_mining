{
    "author": "qukhan",
    "message": "Fix `CreateFileMappingA()` return value check in `mmap_handle.cc`\n\nThis also:\n- improves the log when a `HANDLE` cannot be converted to a file descriptor by\n  calling `strerror`;\n- simplifies the code that sanitizes the handle name.\n\nPiperOrigin-RevId: 817635442",
    "sha": "720ce98a782a903162154bcec39c069f60d9cd2c",
    "files": [
        {
            "sha": "c367638b2c4bec78717ff46f2e3cb3fade643424",
            "filename": "tensorflow/lite/delegates/xnnpack/mmap_handle.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 10,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/720ce98a782a903162154bcec39c069f60d9cd2c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/720ce98a782a903162154bcec39c069f60d9cd2c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc?ref=720ce98a782a903162154bcec39c069f60d9cd2c",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include <fcntl.h>\n #include <sys/stat.h>\n \n+#include <algorithm>\n #include <cerrno>\n #include <cstddef>\n #include <cstdint>\n@@ -103,28 +104,23 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n #elif defined(_MSC_VER)\n   HANDLE osf_handle = reinterpret_cast<HANDLE>(_get_osfhandle(fd.Value()));\n   XNNPACK_RETURN_CHECK(osf_handle != INVALID_HANDLE_VALUE,\n-                       \"could not convert file descriptor to file handle.\");\n+                       \"could not convert file descriptor to file handle: %s.\",\n+                       strerror(errno));\n \n   // Create the handle name, which is either NULL or the path with backslashes\n   // replaced by `_`.\n   std::string name;\n   const char* handle_name = nullptr;\n-  if (!path || path[0] == '\\0') {\n-    name.clear();\n-  } else {\n+  if (path && path[0] != '\\0') {\n     name = path;\n-    for (int i = 0; i < name.size(); ++i) {\n-      if (name[i] == '\\\\') {\n-        name[i] = '_';\n-      }\n-    }\n+    std::replace(name.begin(), name.end(), '\\\\', '_');\n     handle_name = name.c_str();\n   }\n   file_mapping_ =\n       CreateFileMappingA(osf_handle, /*lpFileMappingAttributes=*/nullptr,\n                          /*flProtect=*/PAGE_READONLY, /*dwMaximumSizeHigh=*/0,\n                          /*dwMaximumSizeLow=*/0, /*lpName=*/handle_name);\n-  XNNPACK_RETURN_CHECK(file_mapping_ != INVALID_HANDLE_VALUE,\n+  XNNPACK_RETURN_CHECK(file_mapping_ != NULL,\n                        \"could not create a file mapping: %s.\",\n                        GetLastErrorString().c_str());\n "
        }
    ],
    "stats": {
        "total": 16,
        "additions": 6,
        "deletions": 10
    }
}