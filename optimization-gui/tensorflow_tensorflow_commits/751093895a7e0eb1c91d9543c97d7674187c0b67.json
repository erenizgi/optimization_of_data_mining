{
    "author": "ermilovmaxim",
    "message": "Split :compilation_pipeline into 3 build targets\n\nPiperOrigin-RevId: 805920724",
    "sha": "751093895a7e0eb1c91d9543c97d7674187c0b67",
    "files": [
        {
            "sha": "761823e94eedbdfbd541ae7f21b59da6bece5086",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/BUILD",
            "status": "modified",
            "additions": 81,
            "deletions": 28,
            "changes": 109,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/751093895a7e0eb1c91d9543c97d7674187c0b67/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/751093895a7e0eb1c91d9543c97d7674187c0b67/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2FBUILD?ref=751093895a7e0eb1c91d9543c97d7674187c0b67",
            "patch": "@@ -129,33 +129,33 @@ cc_library(\n )\n \n cc_library(\n-    name = \"compilation_pipeline\",\n-    srcs = if_gpu_is_configured(\n-        [],\n-        [\"compilation_pipeline_stub.cc\"],\n-    ) + if_cuda_is_configured([\n+    name = \"compilation_pipeline_cuda\",\n+    srcs = [\n         \"compilation_pipeline_cuda.cc\",\n-    ]) + if_rocm_is_configured([\n-        \"compilation_pipeline_rocm.cc\",\n-    ]),\n+    ],\n     hdrs = [\"compilation_pipeline.h\"],\n+    tags = [\n+        \"cuda-only\",\n+        \"gpu\",\n+    ],\n     deps = [\n+        \"//xla/backends/gpu/codegen/triton/transforms:passes\",\n+        \"//xla/service:hlo_module_config\",\n+        \"//xla/service/gpu:matmul_utils\",\n+        \"//xla/service/gpu/llvm_gpu_backend:nvptx_backend\",\n+        \"//xla/service/gpu/llvm_gpu_backend:nvptx_libdevice_path\",\n+        \"//xla/stream_executor:device_description\",\n         \"//xla/stream_executor/cuda:cuda_compute_capability\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n-        \"@llvm-project//mlir:Pass\",\n-    ] + if_gpu_is_configured([\n-        \"//xla/backends/gpu/codegen/triton/transforms:passes\",\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@llvm-project//mlir:ArithToLLVM\",\n         \"@llvm-project//mlir:ControlFlowToLLVM\",\n         \"@llvm-project//mlir:IndexToLLVM\",\n         \"@llvm-project//mlir:NVVMToLLVM\",\n+        \"@llvm-project//mlir:Pass\",\n         \"@llvm-project//mlir:SCFToControlFlow\",\n         \"@llvm-project//mlir:Transforms\",\n-        \"//xla/service:hlo_module_config\",\n-        \"//xla/service/gpu:matmul_utils\",\n-        \"//xla/stream_executor:device_description\",\n         \"@triton//:TritonDialects\",\n         \"@triton//:TritonGPUToLLVM\",\n         \"@triton//:TritonGPUTransforms\",\n@@ -166,18 +166,65 @@ cc_library(\n         \"@triton//:TritonToTritonGPUPasses\",\n         \"@triton//:TritonTransforms\",\n         \"@triton//:WarpSpecialization\",\n-    ]) + if_cuda_is_configured([\n-        \"//xla/service/gpu/llvm_gpu_backend:nvptx_backend\",\n-        \"//xla/service/gpu/llvm_gpu_backend:nvptx_libdevice_path\",\n         \"@triton//third_party/nvidia:NVGPUToLLVM\",\n-        \"@triton//third_party/nvidia:TritonNVIDIAGPUToLLVM\",\n         \"@triton//third_party/nvidia:NVHopperTransforms\",\n-    ]) + if_rocm_is_configured([\n+        \"@triton//third_party/nvidia:TritonNVIDIAGPUToLLVM\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"compilation_pipeline_rocm\",\n+    srcs = [\n+        \"compilation_pipeline_rocm.cc\",\n+    ],\n+    hdrs = [\"compilation_pipeline.h\"],\n+    tags = [\n+        \"gpu\",\n+        \"rocm-only\",\n+    ],\n+    deps = [\n+        \"//xla/backends/gpu/codegen/triton/transforms:passes\",\n+        \"//xla/service:hlo_module_config\",\n+        \"//xla/service/gpu:matmul_utils\",\n         \"//xla/service/gpu/llvm_gpu_backend:amdgpu_backend\",\n+        \"//xla/stream_executor:device_description\",\n+        \"//xla/stream_executor/cuda:cuda_compute_capability\",\n         \"//xla/tsl/platform:rocm_rocdl_path\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/strings:str_format\",\n+        \"@llvm-project//mlir:ArithToLLVM\",\n+        \"@llvm-project//mlir:ControlFlowToLLVM\",\n+        \"@llvm-project//mlir:IndexToLLVM\",\n+        \"@llvm-project//mlir:NVVMToLLVM\",\n+        \"@llvm-project//mlir:Pass\",\n+        \"@llvm-project//mlir:SCFToControlFlow\",\n+        \"@llvm-project//mlir:Transforms\",\n+        \"@triton//:TritonDialects\",\n+        \"@triton//:TritonGPUToLLVM\",\n+        \"@triton//:TritonGPUTransforms\",\n+        \"@triton//:TritonInstrumentTransforms\",\n+        \"@triton//:TritonLLVMIR\",\n+        \"@triton//:TritonNvidiaGPUTransforms\",\n+        \"@triton//:TritonToTritonGPU\",\n+        \"@triton//:TritonToTritonGPUPasses\",\n+        \"@triton//:TritonTransforms\",\n+        \"@triton//:WarpSpecialization\",\n         \"@triton//third_party/amd:TritonAMDGPUToLLVM\",\n         \"@triton//third_party/amd:TritonAMDGPUTransforms\",\n-    ]),\n+    ],\n+)\n+\n+cc_library(\n+    name = \"compilation_pipeline_stub\",\n+    srcs = [\"compilation_pipeline_stub.cc\"],\n+    hdrs = [\"compilation_pipeline.h\"],\n+    deps = [\n+        \"//xla/stream_executor/cuda:cuda_compute_capability\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status\",\n+        \"@llvm-project//mlir:Pass\",\n+    ],\n )\n \n cc_library(\n@@ -189,7 +236,6 @@ cc_library(\n     ),\n     hdrs = [\"fusion_emitter.h\"],\n     deps = [\n-        \":compilation_pipeline\",\n         \":dot_algorithms\",\n         \":emitter_helpers\",\n         \":fusion_emitter_legacy_matmul\",\n@@ -279,18 +325,25 @@ cc_library(\n         \"@local_tsl//tsl/platform:statusor\",\n         \"@triton//:TritonDialects\",\n         \"@triton//:TritonTransforms\",\n-    ] + if_gpu_is_configured([\n-        \"@triton//:TritonNvidiaGPUTransforms\",\n-        \"@triton//:TritonGPUToLLVM\",\n-        \"@triton//:TritonToTritonGPU\",\n-        \"@triton//:TritonGPUTransforms\",\n-        \"@triton//:TritonLLVMIR\",\n-    ]) + if_cuda_is_configured([\n+    ] + if_gpu_is_configured(\n+        [\n+            \"@triton//:TritonNvidiaGPUTransforms\",\n+            \"@triton//:TritonGPUToLLVM\",\n+            \"@triton//:TritonToTritonGPU\",\n+            \"@triton//:TritonGPUTransforms\",\n+            \"@triton//:TritonLLVMIR\",\n+        ],\n+        [\n+            \":compilation_pipeline_stub\",\n+        ],\n+    ) + if_cuda_is_configured([\n+        \":compilation_pipeline_cuda\",\n         \"@triton//third_party/nvidia:NVGPUToLLVM\",\n         \"//xla/service/gpu/llvm_gpu_backend:nvptx_libdevice_path\",\n         \"//xla/service/gpu/llvm_gpu_backend:nvptx_backend\",\n         \"@triton//third_party/nvidia:TritonNVIDIAGPUToLLVM\",\n     ]) + if_rocm_is_configured([\n+        \":compilation_pipeline_rocm\",\n         \"//xla/tsl/platform:rocm_rocdl_path\",\n         \"//xla/service/gpu/llvm_gpu_backend:amdgpu_backend\",\n         \"@triton//third_party/amd:TritonAMDGPUToLLVM\","
        },
        {
            "sha": "dd120847b836b970a26799b461739a7d82f20c40",
            "filename": "third_party/xla/xla/pjrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/751093895a7e0eb1c91d9543c97d7674187c0b67/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/751093895a7e0eb1c91d9543c97d7674187c0b67/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD?ref=751093895a7e0eb1c91d9543c97d7674187c0b67",
            "patch": "@@ -1216,7 +1216,7 @@ cc_library(\n             \"@llvm-project//mlir:SCFToControlFlow\",\n             \"@llvm-project//mlir:ToLLVMIRTranslation\",\n             \"@llvm-project//mlir:Transforms\",\n-            \"//xla/backends/gpu/codegen/triton:compilation_pipeline\",\n+            \"//xla/backends/gpu/codegen/triton:compilation_pipeline_cuda\",\n             \"//xla/tsl/platform:errors\",\n             \"//xla/tsl/platform:statusor\",\n             \"@triton//:TritonDialects\","
        }
    ],
    "stats": {
        "total": 111,
        "additions": 82,
        "deletions": 29
    }
}