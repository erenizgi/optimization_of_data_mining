{
    "author": "unknown",
    "message": "[XLA] Fix legalize scheduling annotation verify to not be as aggressive.\n\nA lot of instructions we remove annotations from because we don't care.\nJax level is very imprecise in applying annotations so annotations endup on instructions that shouldn't\nhave them.\nThose are cleaned up later, so don't consider them during verification.\n\nPiperOrigin-RevId: 811441775",
    "sha": "a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b",
    "files": [
        {
            "sha": "4d8db8fec80f0677b3095d31f3d99ea163e8f3a9",
            "filename": "third_party/xla/xla/service/legalize_scheduling_annotations.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.cc?ref=a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b",
            "patch": "@@ -124,12 +124,21 @@ absl::Status AttachAnnotation(\n   return absl::OkStatus();\n }\n \n-bool IsSupportedAsyncOp(HloInstruction* instr, bool supports_async_start) {\n+bool IsSupportedAsyncOp(HloInstruction* instr, bool supports_async_start,\n+                        bool check_sync_versions) {\n   if (instr->opcode() == HloOpcode::kAsyncStart && !supports_async_start) {\n     VLOG(1) << \"Dropping annotation on async start operation: \"\n             << instr->name();\n     return false;\n   }\n+  if (check_sync_versions) {\n+    if (HloPredicateIsOp<HloOpcode::kAllGather, HloOpcode::kAllReduce,\n+                         HloOpcode::kCollectivePermute, HloOpcode::kSendDone,\n+                         HloOpcode::kSend, HloOpcode::kRecvDone,\n+                         HloOpcode::kRecv>(instr)) {\n+      return true;\n+    }\n+  }\n   return HloPredicateIsOp<\n       HloOpcode::kAllGatherDone, HloOpcode::kAllGatherStart,\n       HloOpcode::kAllReduceDone, HloOpcode::kAllReduceStart,\n@@ -358,7 +367,8 @@ bool LegalizeSchedulingAnnotations::KeepSchedulingAnnotation(\n     return false;\n   }\n \n-  return IsSupportedAsyncOp(instr, config_.keep_start_annotation) ||\n+  return IsSupportedAsyncOp(instr, config_.keep_start_annotation,\n+                            /*check_sync_versions=*/false) ||\n          config_.keep_sync_annotation(instr);\n }\n \n@@ -415,6 +425,11 @@ absl::Status LegalizeSchedulingAnnotations::Verify(HloModule* module) {\n         if (!scheduling_annotation_or.ok()) {\n           continue;\n         }\n+        if (!IsSupportedAsyncOp(instr, config_.keep_start_annotation,\n+                                /*check_sync_versions=*/true) &&\n+            !config_.keep_sync_annotation(instr)) {\n+          continue;\n+        }\n         std::optional<Annotation> scheduling_annotation =\n             scheduling_annotation_or.value();\n         if (scheduling_annotation.has_value()) {"
        },
        {
            "sha": "df3dfa47737f4635582fda9f9e000d055a34c7ef",
            "filename": "third_party/xla/xla/service/legalize_scheduling_annotations.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.h?ref=a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b",
            "patch": "@@ -64,7 +64,7 @@ class LegalizeSchedulingAnnotations : public HloModulePass {\n           annotation_to_instruction,\n       bool dry_run = false);\n \n-  static absl::Status Verify(HloModule* module);\n+  absl::Status Verify(HloModule* module);\n \n   using HloPassInterface::Run;\n   absl::StatusOr<bool> Run("
        },
        {
            "sha": "53689f40bb10fc8185f76e5035126d46c1d1ae7b",
            "filename": "third_party/xla/xla/service/legalize_scheduling_annotations_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations_test.cc?ref=a5e5e513f8d34fc86d49e313ae96e8adc1a0d71b",
            "patch": "@@ -830,7 +830,7 @@ ENTRY %entry (p0: bf16[5,8,128], p1: bf16[5,1,2,128]) -> bf16[5,8,128] {\n   EXPECT_FALSE(annotation->iteration_id);\n }\n \n-TEST_F(SchedulingAnnotationPropagationTest, VerifyCycle) {\n+TEST_F(SchedulingAnnotationPropagationTest, VerifyNoCycle) {\n   absl::string_view hlo_string = R\"(\n HloModule module, is_scheduled=true\n \n@@ -844,6 +844,31 @@ ENTRY entry {\n   a4 = f32[16]{0} add(p1, a3), frontend_attributes={_scheduling_group_id=\"1\"}\n   ROOT tuple = (f32[16]{0}, f32[16]{0}) tuple(a3, a4)\n }\n+)\";\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> hlo_module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  LegalizeSchedulingAnnotations::Config config;\n+  config.run_verification = true;\n+  config.keep_sync_annotation = HloPredicateFalse;\n+\n+  auto result = LegalizeSchedulingAnnotations(config).Run(hlo_module.get());\n+  EXPECT_IS_OK(result);\n+}\n+\n+TEST_F(SchedulingAnnotationPropagationTest, VerifyCycle) {\n+  absl::string_view hlo_string = R\"(\n+HloModule module, is_scheduled=true\n+\n+ENTRY entry {\n+  p0 = f32[16]{0} parameter(0)\n+  p1 = f32[16]{0} parameter(1)\n+  a0 = f32[16]{0} collective-permute(p0), source_target_pairs={{0,1},{1,2},{2,3},{3,0}}, frontend_attributes={_scheduling_group_id=\"1\"}\n+  a1 = f32[16]{0} collective-permute(a0), source_target_pairs={{0,1},{1,2},{2,3},{3,0}}, frontend_attributes={_scheduling_group_id=\"2\"}\n+  a2 = f32[16]{0} collective-permute(a1), source_target_pairs={{0,1},{1,2},{2,3},{3,0}}, frontend_attributes={_scheduling_group_id=\"3\"}\n+  a3 = f32[16]{0} collective-permute(a2), source_target_pairs={{0,1},{1,2},{2,3},{3,0}}, frontend_attributes={_scheduling_group_id=\"2\"}\n+  a4 = f32[16]{0} collective-permute(a3), source_target_pairs={{0,1},{1,2},{2,3},{3,0}}, frontend_attributes={_scheduling_group_id=\"1\"}\n+  ROOT tuple = (f32[16]{0}, f32[16]{0}) tuple(a3, a4)\n+}\n )\";\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> hlo_module,\n                           ParseAndReturnVerifiedModule(hlo_string));"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 44,
        "deletions": 4
    }
}