{
    "author": "mwhittaker",
    "message": "Added `--xla_cpu_collective_timeout_seconds` flag.\n\nPiperOrigin-RevId: 839432602",
    "sha": "d9ed979ea7beea09e6473b01878c2e3800040c5e",
    "files": [
        {
            "sha": "f6e986ae1aacd8fadcd1b67193837a461bdfd22e",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=d9ed979ea7beea09e6473b01878c2e3800040c5e",
            "patch": "@@ -600,6 +600,7 @@ cc_library(\n     hdrs = [\"collective_thunk.h\"],\n     deps = [\n         \":thunk\",\n+        \"//xla:debug_options_flags\",\n         \"//xla:future\",\n         \"//xla:shape_util\",\n         \"//xla:status_macros\",\n@@ -620,11 +621,9 @@ cc_library(\n         \"//xla/service:hlo_proto_cc\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/tsl/concurrency:async_value\",\n-        \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:logging\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n-        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "afeead47dda251961b13a96c0d5c5e17b692ce02",
            "filename": "third_party/xla/xla/backends/cpu/runtime/collective_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcollective_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcollective_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcollective_thunk.cc?ref=d9ed979ea7beea09e6473b01878c2e3800040c5e",
            "patch": "@@ -40,6 +40,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/core/collectives/communicator.h\"\n #include \"xla/core/collectives/rank_id.h\"\n+#include \"xla/debug_options_flags.h\"\n #include \"xla/future.h\"\n #include \"xla/hlo/ir/collective_op_group_mode.h\"\n #include \"xla/runtime/buffer_use.h\"\n@@ -153,6 +154,11 @@ CollectiveThunk::GetOpDeviceMemory(const ExecuteParams& params) {\n }\n \n absl::Duration CollectiveThunk::DefaultCollectiveTimeout() {\n+  static const int64_t timeout =\n+      xla::GetDebugOptionsFromFlags().xla_cpu_collective_timeout_seconds();\n+  if (timeout > 0) {\n+    return absl::Seconds(timeout);\n+  }\n   return absl::Minutes(30);\n }\n "
        },
        {
            "sha": "b2339dee3ef9de94b42ca1fc0a7901c9e483fc42",
            "filename": "third_party/xla/xla/debug_options_flags.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc?ref=d9ed979ea7beea09e6473b01878c2e3800040c5e",
            "patch": "@@ -469,6 +469,7 @@ DebugOptions DefaultDebugOptionsIgnoringFlags() {\n \n   opts.set_xla_cpu_collective_call_warn_stuck_seconds(20);\n   opts.set_xla_cpu_collective_call_terminate_timeout_seconds(40);\n+  opts.set_xla_cpu_collective_timeout_seconds(30 * 60);\n \n   opts.set_xla_keep_shardings_after_spmd(false);\n   opts.set_xla_gpu_experimental_enable_checksum_tracing_on_thunks(false);\n@@ -2698,6 +2699,11 @@ void MakeDebugOptionsFlags(std::vector<tsl::Flag>* flag_list,\n           &DebugOptions::set_xla_cpu_collective_call_terminate_timeout_seconds),\n       debug_options->xla_cpu_collective_call_terminate_timeout_seconds(),\n       \"Set timeout for Collective Call Rendezvous termination\"));\n+  flag_list->push_back(tsl::Flag(\n+      \"xla_cpu_collective_timeout_seconds\",\n+      int32_setter_for(&DebugOptions::set_xla_cpu_collective_timeout_seconds),\n+      debug_options->xla_cpu_collective_timeout_seconds(),\n+      \"Set timeout for CPU collectives\"));\n   flag_list->push_back(tsl::Flag(\n       \"xla_keep_shardings_after_spmd\",\n       bool_setter_for(&DebugOptions::set_xla_keep_shardings_after_spmd),"
        },
        {
            "sha": "0a7481d7af4238a8a51cd4f005b431555d8bab5d",
            "filename": "third_party/xla/xla/xla.proto",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fxla.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9ed979ea7beea09e6473b01878c2e3800040c5e/third_party%2Fxla%2Fxla%2Fxla.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fxla.proto?ref=d9ed979ea7beea09e6473b01878c2e3800040c5e",
            "patch": "@@ -192,6 +192,9 @@ message DebugOptions {\n   // has not yet timed out.\n   optional int32 xla_cpu_collective_call_warn_stuck_seconds = 418;\n \n+  // The number of seconds to wait before terminating a collective.\n+  optional int32 xla_cpu_collective_timeout_seconds = 438;\n+\n   // Use region analysis in copy insertion pass.\n   optional bool xla_cpu_copy_insertion_use_region_analysis = 337;\n \n@@ -1326,7 +1329,7 @@ message DebugOptions {\n   // Note: when adding a new flag, please add it to one of the hardware-specific\n   // or hardware-agnostic sections at the top of this proto message.\n \n-  // Next id: 438\n+  // Next id: 439\n \n   // Extra options to pass to the compilation backend (e.g. LLVM); specific\n   // interpretation of these values is left to the backend."
        }
    ],
    "stats": {
        "total": 20,
        "additions": 17,
        "deletions": 3
    }
}