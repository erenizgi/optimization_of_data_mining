{
    "author": "blakehechtman",
    "message": "[XLA:SCHEDULING] Defer scheduling of allocate buffer custom calls\n\nPiperOrigin-RevId: 813765200",
    "sha": "db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7",
    "files": [
        {
            "sha": "46e6ca5bcc5a4d669bee2488e5802313773e23d3",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/constant_deferring.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fconstant_deferring.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fconstant_deferring.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fconstant_deferring.cc?ref=db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7",
            "patch": "@@ -35,7 +35,8 @@ namespace {\n bool IsConstant(const HloInstruction* instr) {\n   return instr->opcode() == HloOpcode::kConstant ||\n          (instr->opcode() == HloOpcode::kBroadcast &&\n-          instr->operand(0)->opcode() == HloOpcode::kConstant);\n+          instr->operand(0)->opcode() == HloOpcode::kConstant) ||\n+         instr->IsCustomCall(\"AllocateBuffer\");\n }\n \n }  // namespace"
        },
        {
            "sha": "4c98fa846a6d6d1a048bca947d516f18ddca6abe",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7",
            "patch": "@@ -4973,6 +4973,7 @@ cc_library(\n     hdrs = [\"while_loop_fusible_sinking.h\"],\n     deps = [\n         \":pattern_matcher\",\n+        \":while_loop_simplifier\",\n         \":while_util\",\n         \"//xla:comparison_util\",\n         \"//xla:shape_util\",\n@@ -4981,6 +4982,7 @@ cc_library(\n         \"//xla/hlo/analysis:while_loop_analysis\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\",\n+        \"//xla/hlo/transforms/simplifiers:hlo_dce\",\n         \"//xla/hlo/utils:hlo_query\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:flat_hash_map\","
        },
        {
            "sha": "f9a0b61056668f1411d1d79fefe6ccb2e2f3217b",
            "filename": "third_party/xla/xla/service/while_loop_fusible_sinking.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking.cc?ref=db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7",
            "patch": "@@ -34,8 +34,10 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/hlo/transforms/simplifiers/hlo_dce.h\"\n #include \"xla/hlo/utils/hlo_query.h\"\n #include \"xla/service/pattern_matcher.h\"\n+#include \"xla/service/while_loop_simplifier.h\"\n #include \"xla/service/while_util.h\"\n #include \"xla/shape_util.h\"\n #include \"xla/util.h\"\n@@ -53,7 +55,8 @@ bool IsPurelyExpanding(const HloInstruction* instr) {\n   return instr->opcode() == HloOpcode::kBroadcast ||\n          (instr->opcode() == HloOpcode::kConstant &&\n           instr->shape().dimensions().empty()) ||\n-         instr->opcode() == HloOpcode::kIota;\n+         instr->opcode() == HloOpcode::kIota ||\n+         instr->IsCustomCall(\"AllocateBuffer\");\n }\n \n bool IsFusionCandidate(const HloInstruction* instr) {\n@@ -141,7 +144,8 @@ std::vector<int64_t> GetLoopShapeCoveringWriteIndices(\n     HloInstruction* arg_operand = tuple->mutable_operand(tuple_index);\n     // We're looking for an argument that is a broadcast(constant) feeds a while\n     // loop.\n-    if (!Match(arg_operand, match::Broadcast(match::ConstantScalar()))) {\n+    if (!Match(arg_operand, match::Broadcast(match::ConstantScalar())) &&\n+        !arg_operand->IsCustomCall(\"AllocateBuffer\")) {\n       continue;\n     }\n     HloInstruction* broadcast_gte = hlo_query::GetUniqueGteInstruction(\n@@ -539,6 +543,11 @@ absl::StatusOr<bool> WhileLoopFusibleSinking::Run(\n       }\n     }\n   }\n+  if (changed) {\n+    TF_ASSIGN_OR_RETURN(bool t, HloDCE().Run(module));\n+    TF_ASSIGN_OR_RETURN(bool t2, WhileLoopSimplifier().Run(module));\n+    changed |= t | t2;\n+  }\n   return changed;\n }\n }  // namespace xla"
        },
        {
            "sha": "dae045839800bc85e3cbf05b18537b97fafd955e",
            "filename": "third_party/xla/xla/service/while_loop_fusible_sinking_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking_test.cc?ref=db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7",
            "patch": "@@ -18,7 +18,6 @@ limitations under the License.\n #include <memory>\n #include <string>\n \n-#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/log/check.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -109,11 +108,11 @@ ENTRY entry {\n                           WhileLoopFusibleSinking{}.Run(module.get()));\n   ASSERT_TRUE(changed);\n \n-  auto* while_body = module->GetComputationWithName(\"body\");\n+  auto* while_body = module->GetComputationWithName(\"body.clone\");\n   EXPECT_THAT(while_body->root_instruction(),\n               op::Tuple(op::Add(_, op::Multiply(op::Add(op::Iota(), op::Iota()),\n                                                 op::Broadcast())),\n-                        _, _));\n+                        _));\n }\n \n TEST_F(WhileLoopFusibleSinkingTest, NoSinkSlicedMask) {\n@@ -283,8 +282,6 @@ TEST_F(WhileLoopFusibleSinkingTest,\n   TF_ASSERT_OK_AND_ASSIGN(bool changed,\n                           WhileLoopFusibleSinking{}.Run(module_before.get()));\n   EXPECT_TRUE(changed);\n-  EXPECT_THAT(FindInstruction(module_before.get(), \"while1\"),\n-              op::While(op::Tuple(_, op::CustomCall(), _, _)));\n   EXPECT_THAT(FindInstruction(module_before.get(), \"while2\"),\n               op::While(op::Tuple(_, op::CustomCall(), _, _)));\n }"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 17,
        "deletions": 8
    }
}