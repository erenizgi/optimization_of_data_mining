{
    "author": "tensorflower-gardener",
    "message": "Handle cupti hardware trace correctly. Flip to true only once.\n\nPiperOrigin-RevId: 845967897",
    "sha": "11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b",
    "files": [
        {
            "sha": "b7f90db95f1b9c895f30057de699ec19a9673065",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_tracer.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 26,
            "changes": 55,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc?ref=11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b",
            "patch": "@@ -1077,6 +1077,13 @@ const char* GetCuptiErrorString(CuptiInterface* cupti_interface,\n   return err_str;\n }\n \n+bool& IsCuptiHardwareEventSystemEnabled() {\n+  // This flag can not flip to true once per process. Once enabled, it will stay\n+  // enabled until the process is terminated.\n+  static bool is_enabled = false;\n+  return is_enabled;\n+}\n+\n }  // namespace\n \n CuptiTracer::CuptiTracer(CuptiInterface* cupti_interface)\n@@ -1447,19 +1454,31 @@ absl::Status CuptiTracer::EnableActivityTracing() {\n                    << err;\n     }\n     if (option_->enable_activity_hardware_tracing) {\n-      auto err = cupti_interface_->ActivityEnableHWTrace(true);\n-      if (err == CUPTI_ERROR_NOT_SUPPORTED) {\n-        LOG(INFO)\n-            << \"CUPTI activity HW trace not enabled due to not supported on \"\n-               \"this platform!\";\n-      } else if (err != CUPTI_SUCCESS) {\n-        LOG(WARNING)\n-            << \"Fail to enable CUPTI activity HW trace, CUPTI ERROR CODE:\"\n-            << err << \" (\" << GetCuptiErrorString(cupti_interface_, err) << \")\";\n+      if (IsCuptiHardwareEventSystemEnabled()) {\n+        LOG(INFO) << \"CUPTI activity HW trace already enabled.\";\n       } else {\n-        LOG(INFO) << \"CUPTI activity HW trace successfully enabled.\";\n+        auto err = cupti_interface_->ActivityEnableHWTrace(true);\n+        if (err == CUPTI_ERROR_NOT_SUPPORTED) {\n+          LOG(INFO)\n+              << \"CUPTI activity HW trace not enabled due to not supported on \"\n+                 \"this platform!\";\n+        } else if (err != CUPTI_SUCCESS) {\n+          LOG(WARNING)\n+              << \"Fail to enable CUPTI activity HW trace, CUPTI ERROR CODE:\"\n+              << err << \" (\" << GetCuptiErrorString(cupti_interface_, err)\n+              << \")\";\n+        } else {\n+          LOG(INFO) << \"CUPTI activity HW trace successfully enabled.\";\n+          IsCuptiHardwareEventSystemEnabled() = true;\n+        }\n+      }\n+    } else {\n+      if (IsCuptiHardwareEventSystemEnabled()) {\n+        LOG(INFO)\n+            << \"CUPTI activity HW trace already enabled, continue with it.\";\n       }\n     }\n+\n     RETURN_IF_CUPTI_ERROR(ActivityRegisterCallbacks(\n         RequestCuptiActivityBuffer, ProcessCuptiActivityBuffer));\n     VLOG(1) << \"Enabling activity tracing for \"\n@@ -1497,22 +1516,6 @@ absl::Status CuptiTracer::DisableActivityTracing() {\n     }\n     option_->activities_selected.clear();\n \n-    if (option_->enable_activity_hardware_tracing) {\n-      auto err = cupti_interface_->ActivityEnableHWTrace(false);\n-      // CUPTI_ERROR_NOT_SUPPORTED here is ok as it already handled/logged\n-      // in EnableActivityTracing.\n-      if (err == CUPTI_ERROR_NOT_SUPPORTED) {\n-        LOG(INFO) << \"CUPTI activity HW trace not disabled due to not \"\n-                     \"supported on this platform!\";\n-      } else if (err != CUPTI_SUCCESS) {\n-        LOG(WARNING)\n-            << \"Fail to disable CUPTI activity HW trace, CUPTI ERROR CODE:\"\n-            << err << \" (\" << GetCuptiErrorString(cupti_interface_, err) << \")\";\n-      } else {\n-        LOG(INFO) << \"CUPTI activity HW trace successfully disabled.\";\n-      }\n-    }\n-\n     VLOG(1) << \"Flushing CUPTI activity buffer\";\n     RETURN_IF_CUPTI_ERROR(ActivityFlushAll(CUPTI_ACTIVITY_FLAG_FLUSH_FORCED));\n     LOG(INFO) << \"CUPTI activity buffer flushed\";"
        },
        {
            "sha": "29b635c1b238876ad42415680de99142930e31fa",
            "filename": "third_party/xla/xla/backends/profiler/gpu/profile_with_cuda_kernels_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fprofile_with_cuda_kernels_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fprofile_with_cuda_kernels_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fprofile_with_cuda_kernels_test.cc?ref=11ec4073f6e6dd69d688130edf5f9b2ac0e3e06b",
            "patch": "@@ -187,6 +187,10 @@ void SimpleAddSubWithProfilerTest(bool enable_activity_hardware_tracing,\n   EXPECT_EQ(vec.size(), kNumElements);\n   EXPECT_THAT(vec, Each(DistanceFrom(0, Lt(0.001))));\n \n+  auto space = std::make_unique<tensorflow::profiler::XSpace>();\n+  collector->Export(space.get(), CuptiTracer::GetTimestamp());\n+  EXPECT_GE(space->planes_size(), 1);\n+\n   if (enable_pm_sampling) {\n     // Expect 4 * elems / (32 elemn / warp) +- 5% double instructions\n     // (if they were sampled)"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 33,
        "deletions": 26
    }
}