{
    "author": "tensorflower-gardener",
    "message": "[SymbolicMap] Add functions to compress by removing unused dimensions or symbols.\n\n`CompressDims` and `CompressSymbols` create new `SymbolicMap` instances with a reduced number of dimensions or symbols, respectively. The expressions within the map are updated to use the new indices for the remaining dimensions and symbols.\n\nPiperOrigin-RevId: 802485294",
    "sha": "ad47a1b3acc1f8ebb207de847751b85896a0e207",
    "files": [
        {
            "sha": "c36d26fe9df6045ccaa85e136cfe00cabd59d730",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad47a1b3acc1f8ebb207de847751b85896a0e207/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad47a1b3acc1f8ebb207de847751b85896a0e207/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=ad47a1b3acc1f8ebb207de847751b85896a0e207",
            "patch": "@@ -223,5 +223,75 @@ llvm::SmallBitVector GetUnusedSymbolsBitVector(const SymbolicMap& map) {\n   return unused_symbols;\n }\n \n+SymbolicMap CompressDims(const SymbolicMap& map,\n+                         const llvm::SmallBitVector& unused_dims) {\n+  CHECK_EQ(map.GetNumDims(), unused_dims.size());\n+\n+  if (unused_dims.none()) {\n+    return map;\n+  }\n+\n+  // Assert that all dimensions marked as unused are actually unused.\n+  llvm::SmallBitVector actual_unused_dims = GetUnusedDimensionsBitVector(map);\n+  for (int i = 0; i < map.GetNumDims(); ++i) {\n+    if (unused_dims[i]) {\n+      CHECK(actual_unused_dims[i])\n+          << \"Attempting to compress a used dimension: \" << i;\n+    }\n+  }\n+\n+  int64_t new_num_dims = map.GetNumDims() - unused_dims.count();\n+  llvm::SmallVector<SymbolicExpr> dim_replacements(map.GetNumDims());\n+\n+  int64_t current_new_dim_idx = 0;\n+  for (int i = 0; i < map.GetNumDims(); ++i) {\n+    if (!unused_dims[i]) {\n+      dim_replacements[i] =\n+          map.GetContext()->CreateVariable(current_new_dim_idx++);\n+    }\n+  }\n+  auto sym_replacements =\n+      CreateVariableRange(map.GetContext(), map.GetNumSymbols(), new_num_dims);\n+\n+  return map.ReplaceDimsAndSymbols(dim_replacements, sym_replacements,\n+                                   new_num_dims, map.GetNumSymbols());\n+}\n+\n+SymbolicMap CompressSymbols(const SymbolicMap& map,\n+                            const llvm::SmallBitVector& unused_symbols) {\n+  CHECK_EQ(map.GetNumSymbols(), unused_symbols.size());\n+\n+  if (unused_symbols.none()) {\n+    return map;\n+  }\n+\n+  // Assert that all symbols marked as unused are actually unused.\n+  llvm::SmallBitVector actual_unused_symbols = GetUnusedSymbolsBitVector(map);\n+  for (int i = 0; i < map.GetNumSymbols(); ++i) {\n+    if (unused_symbols[i]) {\n+      CHECK(actual_unused_symbols[i])\n+          << \"Attempting to compress a used symbol: \" << i;\n+    }\n+  }\n+\n+  int64_t num_dims = map.GetNumDims();\n+  int64_t new_num_symbols = map.GetNumSymbols() - unused_symbols.count();\n+\n+  auto dim_replacements = CreateVariableRange(map.GetContext(), num_dims);\n+\n+  llvm::SmallVector<SymbolicExpr> sym_replacements(map.GetNumSymbols());\n+  int64_t current_new_sym_idx = 0;\n+  for (int i = 0; i < map.GetNumSymbols(); ++i) {\n+    if (!unused_symbols[i]) {\n+      sym_replacements[i] =\n+          map.GetContext()->CreateVariable(num_dims + current_new_sym_idx++);\n+    }\n+  }\n+  CHECK_EQ(current_new_sym_idx, new_num_symbols);\n+\n+  return map.ReplaceDimsAndSymbols(dim_replacements, sym_replacements, num_dims,\n+                                   new_num_symbols);\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "da4ffc8740a64143623758cf152a5be21cbf28d7",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad47a1b3acc1f8ebb207de847751b85896a0e207/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad47a1b3acc1f8ebb207de847751b85896a0e207/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=ad47a1b3acc1f8ebb207de847751b85896a0e207",
            "patch": "@@ -110,6 +110,16 @@ llvm::SmallBitVector GetUnusedDimensionsBitVector(const SymbolicMap& map);\n // the map.\n llvm::SmallBitVector GetUnusedSymbolsBitVector(const SymbolicMap& map);\n \n+// Creates a new SymbolicMap with unused dimensions removed.\n+// Expressions are updated to use the new dimension indices.\n+SymbolicMap CompressDims(const SymbolicMap& map,\n+                         const llvm::SmallBitVector& unused_dims);\n+\n+// Creates a new SymbolicMap with unused symbols removed.\n+// Expressions are updated to use the new symbol indices.\n+SymbolicMap CompressSymbols(const SymbolicMap& map,\n+                            const llvm::SmallBitVector& unused_symbols);\n+\n }  // namespace gpu\n }  // namespace xla\n "
        },
        {
            "sha": "8e835fd1c7dfb9cbe5696cdcea1e0eee0881d39e",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ad47a1b3acc1f8ebb207de847751b85896a0e207/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ad47a1b3acc1f8ebb207de847751b85896a0e207/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=ad47a1b3acc1f8ebb207de847751b85896a0e207",
            "patch": "@@ -262,6 +262,66 @@ TEST(SymbolicMapTest, GetUnusedVariables) {\n   EXPECT_FALSE(no_dim_symbols[1]);\n }\n \n+TEST(SymbolicMapTest, CompressDims) {\n+  SymbolicExprContext ctx;\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  [[maybe_unused]] SymbolicExpr d1 = ctx.CreateVariable(1);  // Unused\n+  SymbolicExpr d2 = ctx.CreateVariable(2);\n+  SymbolicExpr s0 = ctx.CreateVariable(3);\n+\n+  // Map: (d0, d1, d2)[s0] -> {d0 + d2, s0 * 5}\n+  SymbolicMap map = SymbolicMap::Get(&ctx, 3, 1, {d0 + d2, s0 * 5});\n+\n+  // Remove d1\n+  llvm::SmallBitVector unused_dims = GetUnusedDimensionsBitVector(map);\n+  SymbolicMap compressed = CompressDims(map, unused_dims);\n+\n+  EXPECT_EQ(compressed.GetNumDims(), 2);\n+  EXPECT_EQ(compressed.GetNumSymbols(), 1);\n+\n+  SymbolicExpr new_d0 = ctx.CreateVariable(0);\n+  SymbolicExpr new_d1 = ctx.CreateVariable(1);\n+  SymbolicExpr new_s0 = ctx.CreateVariable(2);\n+  EXPECT_THAT(compressed.GetResults(),\n+              ElementsAre(new_d0 + new_d1, new_s0 * 5));\n+\n+  // Check that we can't remove used dimensions.\n+  unused_dims.reset();\n+  unused_dims[0] = true;\n+  EXPECT_DEATH(CompressDims(map, unused_dims),\n+               \"Attempting to compress a used dimension: 0\");\n+}\n+\n+TEST(SymbolicMapTest, CompressSymbols) {\n+  SymbolicExprContext ctx;\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr s0 = ctx.CreateVariable(1);\n+  [[maybe_unused]] SymbolicExpr s1 = ctx.CreateVariable(2);  // Unused\n+  SymbolicExpr s2 = ctx.CreateVariable(3);\n+\n+  // Map: (d0)[s0, s1, s2] -> {d0 + s2, s0 * 5}\n+  SymbolicMap map = SymbolicMap::Get(&ctx, 1, 3, {d0 + s2, s0 * 5});\n+\n+  // Remove s1 (the only unused symbol)\n+  llvm::SmallBitVector unused_symbols = GetUnusedSymbolsBitVector(map);\n+  SymbolicMap compressed = CompressSymbols(map, unused_symbols);\n+\n+  EXPECT_EQ(compressed.GetNumDims(), 1);\n+  EXPECT_EQ(compressed.GetNumSymbols(), 2);\n+\n+  SymbolicExpr new_d0 = ctx.CreateVariable(0);\n+  SymbolicExpr new_s0 = ctx.CreateVariable(1);\n+  SymbolicExpr new_s1 = ctx.CreateVariable(2);  // Original s2\n+  EXPECT_THAT(compressed.GetResults(),\n+              ElementsAre(new_d0 + new_s1, new_s0 * 5));\n+\n+  // Check that we can't remove used symbols.\n+  unused_symbols.reset();\n+  unused_symbols[2] = true;\n+  EXPECT_DEATH(CompressSymbols(map, unused_symbols),\n+               \"Attempting to compress a used symbol: 2\");\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 140,
        "deletions": 0
    }
}