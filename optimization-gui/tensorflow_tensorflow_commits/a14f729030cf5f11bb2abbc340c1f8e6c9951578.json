{
    "author": "akuegel",
    "message": "Move stablehlo input processing logic to hlo_module_loader.cc.\n\nThis allows to support stablehlo input format also for other tools than just\nrun_hlo_module.\n\nPiperOrigin-RevId: 836619811",
    "sha": "a14f729030cf5f11bb2abbc340c1f8e6c9951578",
    "files": [
        {
            "sha": "03450b44f482bd7c3dfb20597d81973b4d59065c",
            "filename": "third_party/xla/xla/tools/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2FBUILD?ref=a14f729030cf5f11bb2abbc340c1f8e6c9951578",
            "patch": "@@ -389,13 +389,16 @@ cc_library(\n         \"//xla:xla_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/parser:hlo_parser\",\n+        \"//xla/hlo/translate/mhlo_to_hlo:translate\",\n+        \"//xla/hlo/translate/stablehlo_to_hlo:translate\",\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service:hlo_proto_cc\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_protobuf//:protobuf\",\n         \"@com_googlesource_code_re2//:re2\",\n+        \"@llvm-project//llvm:Support\",\n         \"@local_tsl//tsl/platform:env\",\n         \"@local_tsl//tsl/platform:errors\",\n         \"@local_tsl//tsl/platform:logging\",\n@@ -546,8 +549,6 @@ xla_cc_binary(\n         \":run_hlo_module_lib\",\n         \":run_hlo_module_proto_cc\",\n         \"//xla:debug_options_flags\",\n-        \"//xla/hlo/translate/mhlo_to_hlo:translate\",\n-        \"//xla/hlo/translate/stablehlo_to_hlo:translate\",\n         \"//xla/service:cpu_plugin\",\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service:hlo_runner\",\n@@ -558,7 +559,6 @@ xla_cc_binary(\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n-        \"@llvm-project//llvm:Support\",\n         \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:platform_port\","
        },
        {
            "sha": "d805b45d9426eca2d81a87e09095752ce322f541",
            "filename": "third_party/xla/xla/tools/hlo_module_loader.cc",
            "status": "modified",
            "additions": 40,
            "deletions": 2,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_module_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_module_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_module_loader.cc?ref=a14f729030cf5f11bb2abbc340c1f8e6c9951578",
            "patch": "@@ -29,12 +29,17 @@ limitations under the License.\n #include \"absl/strings/str_join.h\"\n #include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"llvm/ADT/StringRef.h\"\n+#include \"llvm/Support/MemoryBuffer.h\"\n+#include \"llvm/Support/raw_ostream.h\"\n #include \"google/protobuf/text_format.h\"\n #include \"re2/re2.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/parser/hlo_parser.h\"\n+#include \"xla/hlo/translate/mhlo_to_hlo/translate.h\"\n+#include \"xla/hlo/translate/stablehlo_to_hlo/translate.h\"\n #include \"xla/service/hlo.pb.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/tools/run_hlo_module.pb.h\"\n@@ -84,6 +89,39 @@ absl::StatusOr<std::unique_ptr<HloModule>> LoadModuleFromData(\n     BufferAssignmentProto* buffer_assignment_proto, bool fill_missing_layouts) {\n   DebugOptions debug_options = GetDebugOptionsFromFlags();\n   std::unique_ptr<HloModule> module;\n+  std::string buffer;\n+  if (format == \"stablehlo\" || format == \"mhlo\") {\n+    llvm::StringRef llvm_data(data.data(), data.size());\n+    auto input = llvm::MemoryBuffer::getMemBuffer(\n+        llvm_data, /*BufferName=*/\"\", /*RequiresNullTerminator=*/false);\n+    llvm::raw_string_ostream output(buffer);\n+    auto status =\n+        format == \"mhlo\"\n+            ? xla::MlirHloToHloTextMain(\n+                  std::move(input), output,\n+                  /*emit_return_tuple=*/false,\n+                  /*emit_use_tuple_arg=*/false,\n+                  /*print_layouts=*/false,\n+                  /*print_large_constants=*/true, /*print_sugar=*/false,\n+                  /*via_builder=*/false, /*with_layouts=*/false)\n+            : xla::StablehloToHloTextMain(\n+                  std::move(input), output,\n+                  /*emit_return_tuple=*/false,\n+                  /*emit_use_tuple_arg=*/false,\n+                  /*print_layouts=*/false,\n+                  /*print_large_constants=*/true, /*print_sugar=*/false,\n+                  /*via_builder=*/false, /*with_layouts=*/false);\n+\n+    if (status.failed()) {\n+      LOG(QFATAL) << \"Failed to translate input \" << format\n+                  << \" program to HLO text\";\n+    }\n+\n+    VLOG(1) << \"Input \" << format << \" program translated to HLO text\";\n+    format = \"hlo\";\n+    data = buffer;\n+  }\n+\n   if (format == \"hlo\" || format == \"txt\") {\n     std::string hlo_string = StripLogHeaders(data);\n     HloModuleConfig config;\n@@ -122,8 +160,8 @@ absl::StatusOr<std::unique_ptr<HloModule>> LoadModuleFromData(\n       }\n     } else {\n       return InvalidArgument(\n-          \"Invalid format from file extension: '%s'. Expected: hlo, txt, pb, \"\n-          \"or pbtxt\",\n+          \"Invalid format from file extension: '%s'. Expected: hlo, txt, \"\n+          \"stablehlo, mhlo, pb, or pbtxt\",\n           format);\n     }\n     TF_ASSIGN_OR_RETURN(HloModuleConfig config,"
        },
        {
            "sha": "e51532b53968500fb5252559d002f29e03ffb0ac",
            "filename": "third_party/xla/xla/tools/hlo_module_loader_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_module_loader_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_module_loader_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_module_loader_test.cc?ref=a14f729030cf5f11bb2abbc340c1f8e6c9951578",
            "patch": "@@ -48,5 +48,31 @@ I0521 12:04:45.883483    1509 service.cc:186] }\n   EXPECT_NE(FindInstruction(hlo_module.get(), \"rooty\"), nullptr);\n }\n \n+TEST_F(HloModuleLoaderTest, SupportsStablehlo) {\n+  const std::string& stablehlo_string = R\"(\n+module @jit_slice_data attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {\n+  func.func public @main() -> (tensor<2x5xi32> {jax.result_info = \"result\"}) {\n+    %c = stablehlo.constant dense<[[0, 1, 2, 3, 4], [0, 1, 2, 3, 4]]> : tensor<2x5xi32>\n+    %0 = stablehlo.iota dim = 0 : tensor<5xi32>\n+    %c_0 = stablehlo.constant dense<0> : tensor<i32>\n+    %1 = stablehlo.broadcast_in_dim %c_0, dims = [] : (tensor<i32>) -> tensor<5xi32>\n+    %2 = stablehlo.compare  LT, %0, %1,  SIGNED : (tensor<5xi32>, tensor<5xi32>) -> tensor<5xi1>\n+    %c_1 = stablehlo.constant dense<5> : tensor<i32>\n+    %3 = stablehlo.broadcast_in_dim %c_1, dims = [] : (tensor<i32>) -> tensor<5xi32>\n+    %4 = stablehlo.add %0, %3 : tensor<5xi32>\n+    %5 = stablehlo.select %2, %4, %0 : tensor<5xi1>, tensor<5xi32>\n+    %6 = stablehlo.broadcast_in_dim %5, dims = [0] : (tensor<5xi32>) -> tensor<5x1xi32>\n+    %7 = \"stablehlo.gather\"(%c, %6) <{dimension_numbers = #stablehlo.gather<offset_dims = [0], collapsed_slice_dims = [1], start_index_map = [1], index_vector_dim = 1>, indices_are_sorted = false, slice_sizes = array<i64: 2, 1>}> : (tensor<2x5xi32>, tensor<5x1xi32>) -> tensor<2x5xi32>\n+    %c_2 = stablehlo.constant dense<1> : tensor<i32>\n+    %8 = stablehlo.broadcast_in_dim %c_2, dims = [] : (tensor<i32>) -> tensor<2x5xi32>\n+    %9 = stablehlo.add %7, %8 : tensor<2x5xi32>\n+    return %9 : tensor<2x5xi32>\n+  }\n+})\";\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> hlo_module,\n+                          LoadModuleFromData(stablehlo_string, \"stablehlo\"));\n+  EXPECT_EQ(hlo_module->result_shape().ToString(), \"s32[2,5]\");\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "3619695ad0183bf302aab69266973ed5ac37a02a",
            "filename": "third_party/xla/xla/tools/run_hlo_module_main.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 53,
            "changes": 53,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2Frun_hlo_module_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a14f729030cf5f11bb2abbc340c1f8e6c9951578/third_party%2Fxla%2Fxla%2Ftools%2Frun_hlo_module_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Frun_hlo_module_main.cc?ref=a14f729030cf5f11bb2abbc340c1f8e6c9951578",
            "patch": "@@ -32,12 +32,7 @@ limitations under the License.\n #include \"absl/strings/match.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n-#include \"llvm/Support/FileSystem.h\"\n-#include \"llvm/Support/MemoryBuffer.h\"\n-#include \"llvm/Support/ToolOutputFile.h\"\n #include \"xla/debug_options_flags.h\"\n-#include \"xla/hlo/translate/mhlo_to_hlo/translate.h\"\n-#include \"xla/hlo/translate/stablehlo_to_hlo/translate.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/service/hlo_runner.h\"\n #include \"xla/service/platform_util.h\"\n@@ -239,54 +234,6 @@ int main(int argc, char** argv) {\n     const char* hlo_filename = argv[c];\n     std::cout << \"\\n ** Running \" << hlo_filename << \"** \\n\";\n \n-    if (opts.input_format == \"stablehlo\" || opts.input_format == \"mhlo\") {\n-      auto input_filename = hlo_filename;\n-      hlo_filename = std::tmpnam(nullptr);\n-\n-      std::error_code error;\n-      auto output = std::make_unique<llvm::ToolOutputFile>(\n-          hlo_filename, error, llvm::sys::fs::OF_None);\n-      if (error) {\n-        LOG(QFATAL) << \"cannot open output file '\" << std::string(hlo_filename)\n-                    << \"': \" << error.message();\n-      }\n-\n-      auto input = llvm::MemoryBuffer::getFile(input_filename);\n-      error = input.getError();\n-      if (error) {\n-        LOG(QFATAL) << \"cannot open input file '\" << std::string(input_filename)\n-                    << \"': \" << error.message();\n-      }\n-\n-      auto status =\n-          opts.input_format == \"mhlo\"\n-              ? xla::MlirHloToHloTextMain(\n-                    std::move(*input), output->os(),\n-                    /*emit_return_tuple=*/false,\n-                    /*emit_use_tuple_arg=*/false,\n-                    /*print_layouts=*/false,\n-                    /*print_large_constants=*/true, /*print_sugar=*/false,\n-                    /*via_builder=*/false, /*with_layouts=*/false)\n-              : xla::StablehloToHloTextMain(\n-                    std::move(*input), output->os(),\n-                    /*emit_return_tuple=*/false,\n-                    /*emit_use_tuple_arg=*/false,\n-                    /*print_layouts=*/false,\n-                    /*print_large_constants=*/true, /*print_sugar=*/false,\n-                    /*via_builder=*/false, /*with_layouts=*/false);\n-\n-      if (status.failed()) {\n-        LOG(QFATAL) << \"Failed to translate input \" << opts.input_format\n-                    << \" program to HLO text\";\n-      }\n-\n-      VLOG(1) << \"Input \" << opts.input_format\n-              << \" program translated to HLO text at \" << hlo_filename << \"\\n\";\n-\n-      output->keep();\n-      opts.input_format = \"hlo\";\n-    }\n-\n     xla::RunHloModuleLiterals literals_proto;\n     std::unique_ptr<std::minstd_rand0> engine;\n     if (opts.random_init_input_literals) {"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 69,
        "deletions": 58
    }
}