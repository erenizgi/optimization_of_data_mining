{
    "author": "akuegel",
    "message": "[XLA:GPU] Simplify Copy Fusions.\n\nThey don't need a separate reference to BufferAssignment. It is available via\nIrEmitterContext.\n\nPiperOrigin-RevId: 845626420",
    "sha": "22f353e125fd0c625dfaaa7ea74b99a0d9cc788f",
    "files": [
        {
            "sha": "54d13fb70e059a5918b47751c69703b337276477",
            "filename": "third_party/xla/xla/backends/gpu/codegen/copy.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 11,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/22f353e125fd0c625dfaaa7ea74b99a0d9cc788f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Fcopy.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/22f353e125fd0c625dfaaa7ea74b99a0d9cc788f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Fcopy.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Fcopy.cc?ref=22f353e125fd0c625dfaaa7ea74b99a0d9cc788f",
            "patch": "@@ -70,8 +70,9 @@ absl::StatusOr<FusionEmissionResult> MemcpyFusion::Emit(\n     const HloInstruction* root = &root_adaptor.instruction();\n     const HloInstruction* src_instr =\n         fusion.operand(root->operand(0)->parameter_number());\n-    TF_ASSIGN_OR_RETURN(BufferAllocation::Slice slice,\n-                        buffer_assignment_->GetUniqueSlice(src_instr, {}));\n+    TF_ASSIGN_OR_RETURN(\n+        BufferAllocation::Slice slice,\n+        ir_emitter_context.buffer_assignment().GetUniqueSlice(src_instr, {}));\n     src_buffers.push_back(slice);\n     src_shapes.push_back(root->operand(0)->shape());\n   }\n@@ -82,8 +83,10 @@ absl::StatusOr<FusionEmissionResult> MemcpyFusion::Emit(\n         if (!subshape.IsArray()) {\n           return absl::OkStatus();\n         }\n-        TF_ASSIGN_OR_RETURN(BufferAllocation::Slice slice,\n-                            buffer_assignment_->GetUniqueSlice(&fusion, index));\n+        TF_ASSIGN_OR_RETURN(\n+            BufferAllocation::Slice slice,\n+            ir_emitter_context.buffer_assignment().GetUniqueSlice(&fusion,\n+                                                                  index));\n         dst_buffers.push_back(slice);\n         return absl::OkStatus();\n       }));\n@@ -122,10 +125,11 @@ absl::StatusOr<FusionEmissionResult> DynamicMemcpyFusion::Emit(\n     // implemented: we only support dynamic offsets, no dynamic sizes.\n     TF_ASSIGN_OR_RETURN(\n         BufferAllocation::Slice input_slice,\n-        buffer_assignment_->GetUniqueSlice(\n+        ir_emitter_context.buffer_assignment().GetUniqueSlice(\n             &SkipOptionalBitcast(root.GetOperand(0)).instruction(), {}));\n-    TF_ASSIGN_OR_RETURN(BufferAllocation::Slice dst_slice,\n-                        buffer_assignment_->GetUniqueSlice(&fusion, {}));\n+    TF_ASSIGN_OR_RETURN(\n+        BufferAllocation::Slice dst_slice,\n+        ir_emitter_context.buffer_assignment().GetUniqueSlice(&fusion, {}));\n     CHECK_EQ(input_slice, dst_slice);\n \n     source_operand_index = 1;\n@@ -138,10 +142,12 @@ absl::StatusOr<FusionEmissionResult> DynamicMemcpyFusion::Emit(\n \n   const auto* src_instr =\n       &SkipOptionalBitcast(root.GetOperand(source_operand_index)).instruction();\n-  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice src_buffer,\n-                      buffer_assignment_->GetUniqueSlice(src_instr, {}));\n-  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice dst_buffer,\n-                      buffer_assignment_->GetUniqueSlice(&fusion, {}));\n+  TF_ASSIGN_OR_RETURN(\n+      BufferAllocation::Slice src_buffer,\n+      ir_emitter_context.buffer_assignment().GetUniqueSlice(src_instr, {}));\n+  TF_ASSIGN_OR_RETURN(\n+      BufferAllocation::Slice dst_buffer,\n+      ir_emitter_context.buffer_assignment().GetUniqueSlice(&fusion, {}));\n \n   FusionEmissionResult result;\n "
        },
        {
            "sha": "7ea70ff9ef30725b8e3ab44580abf14eae91b637",
            "filename": "third_party/xla/xla/backends/gpu/codegen/copy.h",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/22f353e125fd0c625dfaaa7ea74b99a0d9cc788f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Fcopy.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/22f353e125fd0c625dfaaa7ea74b99a0d9cc788f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Fcopy.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Fcopy.h?ref=22f353e125fd0c625dfaaa7ea74b99a0d9cc788f",
            "patch": "@@ -22,7 +22,6 @@ limitations under the License.\n #include \"xla/backends/gpu/codegen/fusion_emitter.h\"\n #include \"xla/backends/gpu/runtime/copy_thunk.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n-#include \"xla/service/buffer_assignment.h\"\n #include \"xla/service/gpu/hlo_fusion_analysis.h\"\n #include \"xla/service/gpu/ir_emitter_context.h\"\n \n@@ -33,17 +32,15 @@ namespace gpu {\n // implemented using `memcpy`s.\n class MemcpyFusion : public FusionInterface {\n  public:\n-  MemcpyFusion(const HloFusionAnalysis& analysis,\n-               const BufferAssignment* buffer_assignment)\n-      : analysis_(analysis), buffer_assignment_(buffer_assignment) {}\n+  explicit MemcpyFusion(const HloFusionAnalysis& analysis)\n+      : analysis_(analysis) {}\n \n   absl::StatusOr<FusionEmissionResult> Emit(\n       IrEmitterContext& ir_emitter_context,\n       const HloFusionInstruction& fusion) const final;\n \n  private:\n   const HloFusionAnalysis& analysis_;\n-  const BufferAssignment* buffer_assignment_;\n };\n \n // Special case of a fusion consisting only of instructions that can be\n@@ -52,9 +49,8 @@ class MemcpyFusion : public FusionInterface {\n // (e.g. dynamic-slice in a while loop).\n class DynamicMemcpyFusion : public FusionInterface {\n  public:\n-  DynamicMemcpyFusion(const HloFusionAnalysis& analysis,\n-                      const BufferAssignment* buffer_assignment)\n-      : analysis_(analysis), buffer_assignment_(buffer_assignment) {}\n+  explicit DynamicMemcpyFusion(const HloFusionAnalysis& analysis)\n+      : analysis_(analysis) {}\n \n   absl::StatusOr<FusionEmissionResult> Emit(\n       IrEmitterContext& ir_emitter_context,\n@@ -70,7 +66,6 @@ class DynamicMemcpyFusion : public FusionInterface {\n \n  private:\n   const HloFusionAnalysis& analysis_;\n-  const BufferAssignment* buffer_assignment_;\n };\n \n }  // namespace gpu"
        },
        {
            "sha": "d5528bf9eb6d5d4d465662de9010f0246b473072",
            "filename": "third_party/xla/xla/backends/gpu/codegen/fusions.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/22f353e125fd0c625dfaaa7ea74b99a0d9cc788f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ffusions.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/22f353e125fd0c625dfaaa7ea74b99a0d9cc788f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ffusions.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ffusions.cc?ref=22f353e125fd0c625dfaaa7ea74b99a0d9cc788f",
            "patch": "@@ -53,8 +53,7 @@ std::optional<std::unique_ptr<FusionInterface>> HloFusionInfo::GetCopyFusion()\n       return std::nullopt;\n     }\n \n-    return std::make_unique<DynamicMemcpyFusion>(analysis(),\n-                                                 buffer_assignment_);\n+    return std::make_unique<DynamicMemcpyFusion>(analysis());\n   }\n \n   for (const HloInstructionAdaptor& root_adaptor : analysis().fusion_roots()) {\n@@ -67,7 +66,7 @@ std::optional<std::unique_ptr<FusionInterface>> HloFusionInfo::GetCopyFusion()\n     }\n   }\n \n-  return std::make_unique<MemcpyFusion>(analysis(), buffer_assignment_);\n+  return std::make_unique<MemcpyFusion>(analysis());\n }\n \n bool HloFusionInfo::CanEmitDynamicUpdateSliceInPlace() const {"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 23,
        "deletions": 23
    }
}