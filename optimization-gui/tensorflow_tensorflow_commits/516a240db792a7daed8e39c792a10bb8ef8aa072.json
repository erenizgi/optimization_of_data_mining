{
    "author": "tensorflower-gardener",
    "message": "Fix dangling pointer issue in RangeEvaluator::ComputeExpressionRange\n\nAn iterator was being created from the return of indexing_map_.GetConstraints(), and then compared against the end() of a possibly different temporary object from a second call to the same function. This was not leading to any issue because we are returning a to constraint reference, but in the refactor cl/802100018 we need to perform Symbolic <-> Affine conversions and this is not always possible and was producing many different unrelated issues (even precision bugs).\n\nSadly this was not catch in unit tests, so I am adding one.\n\nPiperOrigin-RevId: 834351643",
    "sha": "516a240db792a7daed8e39c792a10bb8ef8aa072",
    "files": [
        {
            "sha": "58f8b7a0122afaf9cda445b94da1d2db36156a30",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_map.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/516a240db792a7daed8e39c792a10bb8ef8aa072/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/516a240db792a7daed8e39c792a10bb8ef8aa072/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map.cc?ref=516a240db792a7daed8e39c792a10bb8ef8aa072",
            "patch": "@@ -1155,8 +1155,9 @@ Interval RangeEvaluator::ComputeExpressionRange(AffineExpr expr) {\n   }\n \n   if (use_constraints_) {\n-    auto constraint = indexing_map_.GetConstraints().find(expr);\n-    if (constraint != indexing_map_.GetConstraints().end()) {\n+    auto constraints_map = indexing_map_.GetConstraints();\n+    auto constraint = constraints_map.find(expr);\n+    if (constraint != constraints_map.end()) {\n       return result.Intersect(constraint->second);\n     }\n   }"
        },
        {
            "sha": "e0076f566774236aefc079424366b60e4471c625",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_map_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/516a240db792a7daed8e39c792a10bb8ef8aa072/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/516a240db792a7daed8e39c792a10bb8ef8aa072/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map_test.cc?ref=516a240db792a7daed8e39c792a10bb8ef8aa072",
            "patch": "@@ -1411,6 +1411,10 @@ TEST_F(IndexingMapTest, RangeEvaluatorTest) {\n   // d3 is always 0.\n   EXPECT_TRUE(range_evaluator.IsAlwaysPositiveOrZero(d3));\n   EXPECT_TRUE(range_evaluator.IsAlwaysNegativeOrZero(d3));\n+\n+  // d0 * 2 + d1 between [-10, 17].\n+  EXPECT_EQ(range_evaluator.ComputeExpressionRange(d0 * 2 + d1),\n+            (Interval{-10, 17}));\n }\n \n template <typename T>"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 7,
        "deletions": 2
    }
}