{
    "author": "seantalts",
    "message": "[XLA:CPU] Clamp tanh at +/- 20 rather than infinity.\n\nPiperOrigin-RevId: 798344886",
    "sha": "9c6995f1e7fd51737d55d9f774add0aec52b9813",
    "files": [
        {
            "sha": "8fbb39fa06448d31a2739b202dfacc0e7fb41d8e",
            "filename": "third_party/xla/xla/codegen/intrinsic/tanh.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9c6995f1e7fd51737d55d9f774add0aec52b9813/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2Ftanh.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9c6995f1e7fd51737d55d9f774add0aec52b9813/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2Ftanh.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2Ftanh.cc?ref=9c6995f1e7fd51737d55d9f774add0aec52b9813",
            "patch": "@@ -31,19 +31,17 @@ namespace xla::codegen::intrinsics {\n \n namespace {\n \n-// Handles +/- infinity cases for tanh, returning +/- 1.0 respectively.\n-// For any other input, returns the given `result`.\n-llvm::Value* HandleInfinity(llvm::IRBuilderBase* b, llvm::Value* input,\n-                            llvm::Value* result) {\n+llvm::Value* HandleLargeInputs(llvm::IRBuilderBase* b, llvm::Value* input,\n+                               llvm::Value* result) {\n   llvm::Type* type = input->getType();\n   llvm::Value* abs_input =\n       llvm_ir::EmitCallToIntrinsic(llvm::Intrinsic::fabs, {input}, {type}, b);\n-  llvm::Value* is_inf_mask =\n-      b->CreateFCmpOEQ(abs_input, llvm::ConstantFP::getInfinity(type, false));\n+  llvm::Value* is_large_mask =\n+      b->CreateFCmpOGE(abs_input, llvm::ConstantFP::get(type, 20.0));\n   llvm::Value* one = llvm::ConstantFP::get(type, 1.0);\n   llvm::Value* inf_result = llvm_ir::EmitCallToIntrinsic(\n       llvm::Intrinsic::copysign, {one, input}, {type}, b);\n-  return b->CreateSelect(is_inf_mask, inf_result, result);\n+  return b->CreateSelect(is_large_mask, inf_result, result);\n }\n \n llvm::Value* EmitFastTanh(llvm::IRBuilderBase* b, llvm::Value* input,\n@@ -103,7 +101,7 @@ llvm::Value* EmitFastTanh(llvm::IRBuilderBase* b, llvm::Value* input,\n   llvm::Value* result =\n       b->CreateSelect(use_aprox, input, b->CreateFDiv(numerator, denominator));\n \n-  return HandleInfinity(b, input, result);\n+  return HandleLargeInputs(b, input, result);\n }\n \n llvm::Value* EmitFastTanhF64(llvm::IRBuilderBase* b, llvm::Value* input,\n@@ -160,7 +158,7 @@ llvm::Value* EmitFastTanhF64(llvm::IRBuilderBase* b, llvm::Value* input,\n   // Divide the numerator by the denominator.\n   llvm::Value* result = b->CreateFDiv(numerator, denominator);\n \n-  return HandleInfinity(b, input, result);\n+  return HandleLargeInputs(b, input, result);\n }\n \n }  // namespace"
        },
        {
            "sha": "efa2b4fc0999698ae90d395295f73d9a25a050d1",
            "filename": "third_party/xla/xla/codegen/intrinsic/tanh_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9c6995f1e7fd51737d55d9f774add0aec52b9813/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2Ftanh_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9c6995f1e7fd51737d55d9f774add0aec52b9813/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2Ftanh_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2Ftanh_test.cc?ref=9c6995f1e7fd51737d55d9f774add0aec52b9813",
            "patch": "@@ -108,8 +108,11 @@ TEST(TanhTest, EmitTanhF64) {\n                    std::numeric_limits<double>::infinity(),\n                    std::numeric_limits<double>::quiet_NaN()};\n   auto* fn = jit.GetScalarFn<double(double)>(Tanh::Name(type));\n-  EXPECT_THAT(fn(std::numeric_limits<double>::infinity()),\n-              NearUlps<double>(1.0, 0));\n+  auto inf = std::numeric_limits<double>::infinity();\n+  EXPECT_THAT(fn(inf), NearUlps<double>(1.0, 0));\n+  EXPECT_THAT(fn(-inf), NearUlps<double>(-1.0, 0));\n+  EXPECT_THAT(fn(20), NearUlps<double>(1.0, 0));\n+  EXPECT_THAT(std::tanh(20), NearUlps<double>(1.0, 0));\n   for (double val : vals) {\n     double actual = fn(val);\n     double expected = std::tanh(val);"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 12,
        "deletions": 11
    }
}