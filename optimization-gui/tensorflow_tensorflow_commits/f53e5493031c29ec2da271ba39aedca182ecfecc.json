{
    "author": "shawnwang18",
    "message": "PR #35011: Use human readable string to display memory allocator sizes\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35011\n\nüìù Summary of Changes\nThis pull request updates the allocator statistics reporting across both `stream_executor` and `tsl/framework` to improve readability and consistency.\nCopybara import of the project:\n\n--\n29373821e0a897a93acf3faa24defcd444c1518f by Shawn Wang <shawnw@nvidia.com>:\n\nUse human readable string to display memory allocator sizes\n\n--\n3b496cd030c7fa450cb72bfc2513e654d32ef15e by Shawn Wang <shawnw@nvidia.com>:\n\nfix typos\n\n--\n66b17f17fbcc3a05e004f3c091abce0e7a8d96e4 by Shawn Wang <shawnw@nvidia.com>:\n\ntypos\n\nMerging this change closes #35011\n\nPiperOrigin-RevId: 842672995",
    "sha": "f53e5493031c29ec2da271ba39aedca182ecfecc",
    "files": [
        {
            "sha": "5e9db471bbb232e08adff098f59834d047ee3e6f",
            "filename": "third_party/xla/xla/stream_executor/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD?ref=f53e5493031c29ec2da271ba39aedca182ecfecc",
            "patch": "@@ -824,7 +824,10 @@ cc_library(\n     name = \"allocator_stats\",\n     srcs = [\"allocator_stats.cc\"],\n     hdrs = [\"allocator_stats.h\"],\n-    deps = [\"@com_google_absl//absl/strings:str_format\"],\n+    deps = [\n+        \"@com_google_absl//absl/strings:str_format\",\n+        \"@local_tsl//tsl/platform:numbers\",\n+    ],\n )\n \n cc_library("
        },
        {
            "sha": "1d10eba776da7b9f32f7d916a5e0f60c927456cb",
            "filename": "third_party/xla/xla/stream_executor/allocator_stats.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 11,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Fstream_executor%2Fallocator_stats.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Fstream_executor%2Fallocator_stats.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fallocator_stats.cc?ref=f53e5493031c29ec2da271ba39aedca182ecfecc",
            "patch": "@@ -18,23 +18,29 @@ limitations under the License.\n #include <string>\n \n #include \"absl/strings/str_format.h\"\n+#include \"tsl/platform/numbers.h\"\n \n namespace stream_executor {\n \n std::string AllocatorStats::DebugString() const {\n   return absl::StrFormat(\n-      \"Limit:            %20lld\\n\"\n-      \"InUse:            %20lld\\n\"\n-      \"MaxInUse:         %20lld\\n\"\n+      \"Limit:            %20s\\n\"\n+      \"InUse:            %20s\\n\"\n+      \"MaxInUse:         %20s\\n\"\n       \"NumAllocs:        %20lld\\n\"\n-      \"MaxAllocSize:     %20lld\\n\"\n-      \"Reserved:         %20lld\\n\"\n-      \"PeakReserved:     %20lld\\n\"\n-      \"LargestFreeBlock: %20lld\\n\",\n-      this->bytes_limit ? *this->bytes_limit : 0, this->bytes_in_use,\n-      this->peak_bytes_in_use, this->num_allocs, this->largest_alloc_size,\n-      this->bytes_reserved, this->peak_bytes_reserved,\n-      this->largest_free_block_bytes);\n+      \"MaxAllocSize:     %20s\\n\"\n+      \"Reserved:         %20s\\n\"\n+      \"PeakReserved:     %20s\\n\"\n+      \"LargestFreeBlock: %20s\\n\",\n+      tsl::strings::HumanReadableNumBytes(this->bytes_limit ? *this->bytes_limit\n+                                                            : 0),\n+      tsl::strings::HumanReadableNumBytes(this->bytes_in_use),\n+      tsl::strings::HumanReadableNumBytes(this->peak_bytes_in_use),\n+      this->num_allocs,\n+      tsl::strings::HumanReadableNumBytes(this->largest_alloc_size),\n+      tsl::strings::HumanReadableNumBytes(this->bytes_reserved),\n+      tsl::strings::HumanReadableNumBytes(this->peak_bytes_reserved),\n+      tsl::strings::HumanReadableNumBytes(this->largest_free_block_bytes));\n }\n \n }  // namespace stream_executor"
        },
        {
            "sha": "141d67cf93d5f8c6a7149dfb4104aeac75c9c3b0",
            "filename": "third_party/xla/xla/tsl/framework/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2FBUILD?ref=f53e5493031c29ec2da271ba39aedca182ecfecc",
            "patch": "@@ -120,6 +120,7 @@ cc_library(\n             \":allocator_registry_impl\",\n             \"@com_google_absl//absl/synchronization\",\n             \"//xla/tsl/lib/gtl:inlined_vector\",\n+            \"@local_tsl//tsl/platform:numbers\",\n             \"@local_tsl//tsl/platform:strcat\",\n             \"//xla/tsl/platform:env\",\n             \"//xla/tsl/platform:env_impl\",\n@@ -132,6 +133,7 @@ cc_library(\n         otherwise = [\n             \"//xla/tsl/lib/gtl:inlined_vector\",\n             \"//xla/tsl/platform:logging\",\n+            \"@local_tsl//tsl/platform:numbers\",\n             \"@local_tsl//tsl/platform:platform_port\",\n             \"@local_tsl//tsl/platform:strcat\",\n             \"//xla/tsl/platform:env\","
        },
        {
            "sha": "112f6555ef59027d68eeebf2a45092c8f7f260e3",
            "filename": "third_party/xla/xla/tsl/framework/allocator.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 18,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2Fallocator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2Fallocator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2Fallocator.cc?ref=f53e5493031c29ec2da271ba39aedca182ecfecc",
            "patch": "@@ -19,33 +19,35 @@ limitations under the License.\n #include <string>\n #include <vector>\n \n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"xla/tsl/framework/allocator_registry.h\"\n #include \"xla/tsl/framework/tracking_allocator.h\"\n #include \"xla/tsl/platform/types.h\"\n #include \"tsl/platform/mem.h\"\n-#include \"tsl/platform/strcat.h\"\n+#include \"tsl/platform/numbers.h\"\n \n namespace tsl {\n \n std::string AllocatorStats::DebugString() const {\n   return absl::StrFormat(\n-      \"Limit:            %20lld\\n\"\n-      \"InUse:            %20lld\\n\"\n-      \"MaxInUse:         %20lld\\n\"\n+      \"Limit:            %20s\\n\"\n+      \"InUse:            %20s\\n\"\n+      \"MaxInUse:         %20s\\n\"\n       \"NumAllocs:        %20lld\\n\"\n-      \"MaxAllocSize:     %20lld\\n\"\n-      \"Reserved:         %20lld\\n\"\n-      \"PeakReserved:     %20lld\\n\"\n-      \"LargestFreeBlock: %20lld\\n\",\n-      static_cast<long long>(this->bytes_limit ? *this->bytes_limit : 0),\n-      static_cast<long long>(this->bytes_in_use),\n-      static_cast<long long>(this->peak_bytes_in_use),\n+      \"MaxAllocSize:     %20s\\n\"\n+      \"Reserved:         %20s\\n\"\n+      \"PeakReserved:     %20s\\n\"\n+      \"LargestFreeBlock: %20s\\n\",\n+      strings::HumanReadableNumBytes(this->bytes_limit ? *this->bytes_limit\n+                                                       : 0),\n+      strings::HumanReadableNumBytes(this->bytes_in_use),\n+      strings::HumanReadableNumBytes(this->peak_bytes_in_use),\n       static_cast<long long>(this->num_allocs),\n-      static_cast<long long>(this->largest_alloc_size),\n-      static_cast<long long>(this->bytes_reserved),\n-      static_cast<long long>(this->peak_bytes_reserved),\n-      static_cast<long long>(this->largest_free_block_bytes));\n+      strings::HumanReadableNumBytes(this->largest_alloc_size),\n+      strings::HumanReadableNumBytes(this->bytes_reserved),\n+      strings::HumanReadableNumBytes(this->peak_bytes_reserved),\n+      strings::HumanReadableNumBytes(this->largest_free_block_bytes));\n }\n \n constexpr size_t Allocator::kAllocatorAlignment;\n@@ -59,9 +61,9 @@ void EnableCPUAllocatorFullStats() { cpu_allocator_collect_full_stats = true; }\n bool CPUAllocatorFullStatsEnabled() { return cpu_allocator_collect_full_stats; }\n \n std::string AllocatorAttributes::DebugString() const {\n-  return strings::StrCat(\"AllocatorAttributes(on_host=\", on_host(),\n-                         \" nic_compatible=\", nic_compatible(),\n-                         \" gpu_compatible=\", gpu_compatible(), \")\");\n+  return absl::StrCat(\"AllocatorAttributes(on_host=\", on_host(),\n+                      \" nic_compatible=\", nic_compatible(),\n+                      \" gpu_compatible=\", gpu_compatible(), \")\");\n }\n \n Allocator* cpu_allocator_base() {"
        },
        {
            "sha": "283df25cc17306efafbfb6da8620412e60c33247",
            "filename": "third_party/xla/xla/tsl/framework/bfc_allocator.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2Fbfc_allocator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f53e5493031c29ec2da271ba39aedca182ecfecc/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2Fbfc_allocator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2Fbfc_allocator.cc?ref=f53e5493031c29ec2da271ba39aedca182ecfecc",
            "patch": "@@ -1116,11 +1116,15 @@ void BFCAllocator::DumpMemoryLog(size_t num_bytes) {\n   }\n   LOG(INFO) << \"Sum Total of in-use chunks: \"\n             << strings::HumanReadableNumBytes(total_bytes);\n-  LOG(INFO) << \"Total bytes in pool: \" << *stats_.pool_bytes\n-            << \" memory_limit_: \" << memory_limit_\n-            << \" available bytes: \" << (memory_limit_ - *stats_.pool_bytes)\n+  LOG(INFO) << \"Total size in pool: \"\n+            << strings::HumanReadableNumBytes(*stats_.pool_bytes)\n+            << \" memory_limit_: \"\n+            << strings::HumanReadableNumBytes(memory_limit_)\n+            << \" available size: \"\n+            << strings::HumanReadableNumBytes(memory_limit_ -\n+                                              *stats_.pool_bytes)\n             << \" curr_region_allocation_bytes_: \"\n-            << curr_region_allocation_bytes_;\n+            << strings::HumanReadableNumBytes(curr_region_allocation_bytes_);\n   LOG(INFO) << \"Stats: \\n\" << stats_.DebugString();\n }\n "
        }
    ],
    "stats": {
        "total": 85,
        "additions": 51,
        "deletions": 34
    }
}