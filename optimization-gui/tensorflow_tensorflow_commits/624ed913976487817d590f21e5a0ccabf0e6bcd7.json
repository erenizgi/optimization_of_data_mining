{
    "author": "ZixuanJiang",
    "message": "Remove out-of bounds dimensions before `hlo_sharding_util::PartiallyReplicateTiledShardingOnDims`.\n\nA preparation for cl/842153305.\n\nPiperOrigin-RevId: 844858313",
    "sha": "624ed913976487817d590f21e5a0ccabf0e6bcd7",
    "files": [
        {
            "sha": "e9739de81ca05da2b375352c1af535ab5870176e",
            "filename": "third_party/xla/xla/service/spmd/dot_handler.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/624ed913976487817d590f21e5a0ccabf0e6bcd7/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fdot_handler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/624ed913976487817d590f21e5a0ccabf0e6bcd7/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fdot_handler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fdot_handler.cc?ref=624ed913976487817d590f21e5a0ccabf0e6bcd7",
            "patch": "@@ -2595,9 +2595,19 @@ absl::StatusOr<HloInstruction*> PartitionDotGroupOnNonContractingImpl(\n     if (!other.sharding().ReplicateOnLastTileDim() || !device_group_match) {\n       other = other.Reshard(target_sharding);\n     }\n+\n+    DimensionVector dims_to_replicate = other_grouped->group_dims;\n+    for (auto it = dims_to_replicate.begin(); it != dims_to_replicate.end();) {\n+      if (*it >= other.base_shape().dimensions().size()) {\n+        it = dims_to_replicate.erase(it);\n+      } else {\n+        ++it;\n+      }\n+    }\n+\n     partially_replicated_other =\n         other.Reshard(hlo_sharding_util::PartiallyReplicateTiledShardingOnDims(\n-            other.sharding(), other_grouped->group_dims));\n+            other.sharding(), dims_to_replicate));\n     top_level_sharding_to_reset.emplace_back(\n         partially_replicated_other, partially_replicated_other.sharding());\n     partially_replicated_other.set_sharding(other_grouped->sharding);"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 11,
        "deletions": 1
    }
}