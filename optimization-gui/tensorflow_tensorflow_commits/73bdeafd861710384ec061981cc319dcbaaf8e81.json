{
    "author": "tensorflower-gardener",
    "message": "[PJRT:GPU] Re-enable se_gpu_pjrt_client_test.\n\nPiperOrigin-RevId: 839397480",
    "sha": "73bdeafd861710384ec061981cc319dcbaaf8e81",
    "files": [
        {
            "sha": "b67f5a66906d402232425bc6fef11afb2068540d",
            "filename": "third_party/xla/xla/pjrt/gpu/BUILD",
            "status": "modified",
            "additions": 8,
            "deletions": 13,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/73bdeafd861710384ec061981cc319dcbaaf8e81/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/73bdeafd861710384ec061981cc319dcbaaf8e81/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2FBUILD?ref=73bdeafd861710384ec061981cc319dcbaaf8e81",
            "patch": "@@ -4,7 +4,7 @@ load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n load(\"//xla/pjrt/gpu:package_groups.bzl\", \"xla_gpu_internal_packages\")\n load(\"//xla/stream_executor:build_defs.bzl\", \"if_cuda_or_rocm\")\n load(\"//xla/tests:build_defs.bzl\", \"xla_test\")\n-load(\"//xla/tsl:tsl.bzl\", \"internal_visibility\")\n+load(\"//xla/tsl:tsl.bzl\", \"if_google\", \"internal_visibility\")\n load(\"//xla/tsl/platform:build_config.bzl\", \"tf_proto_library\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n \n@@ -188,24 +188,15 @@ cc_library(\n \n xla_test(\n     name = \"se_gpu_pjrt_client_test\",\n+    size = \"large\",\n     srcs = [\"se_gpu_pjrt_client_test.cc\"],\n     backend_tags = {\n         \"gpu\": [\n             \"multi_gpu\",\n-            \"no_oss\",\n             \"noasan\",\n             \"nomsan\",\n         ],\n-        \"b200\": [\n-            # TODO(b/452317320): Re-enable once fixed.\n-            \"broken\",\n-            \"no_oss\",\n-        ],\n-        \"h100\": [\n-            # TODO(b/452317320): Re-enable once fixed.\n-            \"broken\",\n-            \"no_oss\",\n-        ],\n+        # TODO(464116734): Re-enable once multi-device presubmits will be available in OSS.\n         \"nvgpu_any\": [\n             \"broken\",\n             \"no_oss\",\n@@ -285,7 +276,11 @@ xla_test(\n         \"@local_tsl//tsl/platform\",\n         \"@local_tsl//tsl/platform:casts\",\n         \"@local_tsl//tsl/platform:platform_port\",\n-    ],\n+    ] + if_google([\n+        # In OSS this dependency is added automatically for xla_test targets. See\n+        # third_party/tensorflow/compiler/xla/xla.default.bzl.\n+        \"//xla/tsl/framework:allocator\",\n+    ]),\n )\n \n xla_test("
        },
        {
            "sha": "0d8dfb02d2def10282d54ba1c939c9f910e25fd5",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_pjrt_client_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/73bdeafd861710384ec061981cc319dcbaaf8e81/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/73bdeafd861710384ec061981cc319dcbaaf8e81/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc?ref=73bdeafd861710384ec061981cc319dcbaaf8e81",
            "patch": "@@ -3025,6 +3025,8 @@ static std::string SuccessfulCrossHostTransferTestName(\n   return absl::StrFormat(\"num_arrays_%d\", info.param);\n }\n \n+static const char* test_binary_name;\n+\n class SuccessfulCrossHostTransferTest : public ::testing::TestWithParam<int> {};\n \n TEST_P(SuccessfulCrossHostTransferTest, SuccessfulCrossHostTransfer) {\n@@ -3034,22 +3036,24 @@ TEST_P(SuccessfulCrossHostTransferTest, SuccessfulCrossHostTransfer) {\n   tsl::SubProcess receiver;\n \n   std::vector<std::string> sender_argv;\n+  sender_argv.push_back(test_binary_name);\n   sender_argv.push_back(\"successful_cross_host_transfer_test\");\n   sender_argv.push_back(\"--test_to_run=SuccessfulCrossHostTransferHelper\");\n   sender_argv.push_back(\"--cross_host_test_role=sender\");\n   sender_argv.push_back(absl::StrFormat(\"--num_arrays=%d\", num_arrays));\n \n   std::vector<std::string> receiver_argv;\n+  receiver_argv.push_back(test_binary_name);\n   receiver_argv.push_back(\"successful_cross_host_transfer_test\");\n   receiver_argv.push_back(\"--test_to_run=SuccessfulCrossHostTransferHelper\");\n   receiver_argv.push_back(\"--cross_host_test_role=receiver\");\n   receiver_argv.push_back(absl::StrFormat(\"--num_arrays=%d\", num_arrays));\n \n-  sender.SetProgram(\"/proc/self/exe\", sender_argv);\n+  sender.SetProgram(test_binary_name, sender_argv);\n   sender.SetChannelAction(tsl::CHAN_STDOUT, tsl::ACTION_PIPE);\n   sender.SetChannelAction(tsl::CHAN_STDERR, tsl::ACTION_PIPE);\n \n-  receiver.SetProgram(\"/proc/self/exe\", receiver_argv);\n+  receiver.SetProgram(test_binary_name, receiver_argv);\n   receiver.SetChannelAction(tsl::CHAN_STDOUT, tsl::ACTION_PIPE);\n   receiver.SetChannelAction(tsl::CHAN_STDERR, tsl::ACTION_PIPE);\n \n@@ -3246,7 +3250,8 @@ TEST_P(ShardedAutotuningTest, ShardedAutotuningWorks) {\n     tsl::SubProcess child[kNumNodes];\n     for (int node_id = 0; node_id < kNumNodes; ++node_id) {\n       std::vector<std::string> argv;\n-      argv.reserve(6);\n+      argv.reserve(7);\n+      argv.push_back(test_binary_name);\n       argv.push_back(\"sharded_autotuning_test\");\n       argv.push_back(\"--test_to_run=ShardedAutotuningWorksHelper\");\n       argv.push_back(absl::StrFormat(\"--node_id=%d\", node_id));\n@@ -3262,7 +3267,7 @@ TEST_P(ShardedAutotuningTest, ShardedAutotuningWorks) {\n         argv.push_back(\"--vmodule=gemm_fusion_autotuner=1\");\n         argv.push_back(\"--logtostderr\");\n       }\n-      child[node_id].SetProgram(\"/proc/self/exe\", argv);\n+      child[node_id].SetProgram(test_binary_name, argv);\n       child[node_id].SetChannelAction(tsl::CHAN_STDOUT, tsl::ACTION_PIPE);\n       child[node_id].SetChannelAction(tsl::CHAN_STDERR, tsl::ACTION_PIPE);\n       ASSERT_TRUE(child[node_id].Start()) << \"node \" << node_id;\n@@ -3407,6 +3412,7 @@ int main(int argc, char* argv[]) {\n   // empty. If empty, all tests are run. Otherwise, the test body for\n   // 'ShardedAutotuningWorks' or 'SuccessfulCrossHostTransfer' will be run.\n   std::string test_to_run;\n+  xla::test_binary_name = argv[0];\n \n   // Variables used by ShardedAutotuningWorks.\n   int node_id = -1;"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 18,
        "deletions": 17
    }
}