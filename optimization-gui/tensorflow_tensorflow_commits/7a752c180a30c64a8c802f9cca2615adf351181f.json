{
    "author": "loislo",
    "message": "[XLA:GPU] Trigger a crash if nan_counter check was requested\n\nThe kernel could be unstable and produce NaN values.\nWhen one want to detect such cases they need to set the flag xla_gpu_experimental_enable_nan_counter_on_thunks to true.\nIn this case the counter for NaN values will be triggered\nand if there is any then the execution will be crashed.\n\nPiperOrigin-RevId: 828389430",
    "sha": "7a752c180a30c64a8c802f9cca2615adf351181f",
    "files": [
        {
            "sha": "95eaf72bcfd22ed123737395670d63f92ab19c31",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -3223,6 +3223,7 @@ cc_library(\n         \":thunk_id\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n     ],"
        },
        {
            "sha": "17ac836fbf15d20bcfa06b76c4ffb62b640cbeaf",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log.proto",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log.proto?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -40,6 +40,15 @@ message BufferDebugLogEntryProto {\n   // (thunk_id, execution_id) describe buffers used by a single execution of a\n   // thunk.\n   uint32 execution_id = 5;\n+\n+  // The type of check that produced this entry.\n+  enum CheckType {\n+    CHECK_TYPE_UNSPECIFIED = 0;\n+    CHECK_TYPE_CHECKSUM = 1;\n+    CHECK_TYPE_NAN_COUNT = 2;\n+  }\n+\n+  CheckType check_type = 6;\n }\n \n // A dump of a `BufferDebugLog` contents."
        },
        {
            "sha": "e68a6ae417e4da8e57c87e32c1aa411bd0a287e3",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -74,6 +74,7 @@ BufferDebugLogProto BufferDebugLogEntryMetadataStore::EntriesToProto(\n     entry_proto->set_execution_id(metadata->execution_id);\n     entry_proto->set_is_input_buffer(metadata->is_input);\n     entry_proto->set_checksum(entry.value);\n+    entry_proto->set_check_type(metadata->check_type);\n   }\n   return proto;\n }"
        },
        {
            "sha": "954cc1cef7e0d8dfcc931008c5b47e475ef0ff42",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.h",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.h?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -19,10 +19,12 @@ limitations under the License.\n #include <cstddef>\n #include <cstdint>\n #include <optional>\n+#include <string>\n #include <utility>\n #include <vector>\n \n #include \"absl/base/thread_annotations.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n #include \"xla/backends/gpu/runtime/buffer_debug_log.pb.h\"\n@@ -52,6 +54,17 @@ class BufferDebugLogEntryMetadataStore {\n     size_t execution_id;\n     // True if the entry represents a check made before the thunk executes.\n     bool is_input;\n+\n+    // The type of check that produced this entry.\n+    BufferDebugLogEntryProto::CheckType check_type;\n+\n+    std::string ToString() const {\n+      return absl::StrCat(\n+          \"thunk_id: \", thunk_id.value(), \", buffer_idx: \", buffer_idx,\n+          \", execution_id: \", execution_id,\n+          \", is_input: \", is_input ? \"true\" : \"false\", \", check_type: \",\n+          BufferDebugLogEntryProto::CheckType_Name(check_type));\n+    }\n   };\n \n   // Inserts `metadata` into the store and returns an ID that can be used to"
        },
        {
            "sha": "739bc2362c847eacc7e4fbbffcf78c564d5e8ed0",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store_test.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -66,12 +66,14 @@ TEST(BufferDebugLogEntryMetadataStoreTest, EntriesToProto) {\n       /*buffer_idx=*/4,\n       /*execution_id=*/5,\n       /*is_input=*/true,\n+      BufferDebugLogEntryProto::CHECK_TYPE_CHECKSUM,\n   });\n   const BufferDebugLogEntryId entry_id2 = store.AssignId({\n       /*thunk_id=*/ThunkId(567),\n       /*buffer_idx=*/8,\n       /*execution_id=*/9,\n       /*is_input=*/false,\n+      BufferDebugLogEntryProto::CHECK_TYPE_NAN_COUNT,\n   });\n   std::vector<BufferDebugLogEntry> entries = {\n       {\n@@ -93,13 +95,15 @@ TEST(BufferDebugLogEntryMetadataStoreTest, EntriesToProto) {\n                   execution_id: 5\n                   is_input_buffer: true\n                   checksum: 12341234\n+                  check_type: CHECK_TYPE_CHECKSUM\n                 }\n                 entries {\n                   thunk_id: 567\n                   buffer_idx: 8\n                   execution_id: 9\n                   is_input_buffer: false\n-                  checksum: 56785678\n+                  checksum: 56785678,\n+                  check_type: CHECK_TYPE_NAN_COUNT\n                 }\n               )pb\"));\n }"
        },
        {
            "sha": "b6b1322ad30ca7868a7c75cf8901a02c25512241",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffers_checksum_thunk.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_checksum_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_checksum_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_checksum_thunk.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.h\"\n #include \"xla/backends/gpu/runtime/buffer_debug_log_structs.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/stream_executor/cuda/cuda_compute_capability.h\"\n@@ -86,12 +87,15 @@ absl::Status BuffersDebugChecksumThunk::ExecuteOnStream(\n       se::gpu::BufferDebugLog::FromDeviceMemoryUnchecked(log_ptr);\n \n   for (const auto& [buffer_idx, buffer] : checked_thunk_buffers_) {\n-    const BufferDebugLogEntryId log_entry_id = metadata_store_->AssignId({\n-        checked_thunk_id_,\n-        buffer_idx,\n-        execution_id,\n-        /*is_input=*/runs_before_checked_thunk_,\n-    });\n+    BufferDebugLogEntryMetadataStore::Metadata metadata{\n+        /*thunk_id*/ checked_thunk_id_,\n+        /*buffer_idx*/ buffer_idx,\n+        /*execution_id*/ execution_id,\n+        /*is_input*/ runs_before_checked_thunk_,\n+        /*check_type*/ BufferDebugLogEntryProto::CHECK_TYPE_CHECKSUM,\n+    };\n+    const BufferDebugLogEntryId log_entry_id =\n+        metadata_store_->AssignId(metadata);\n \n     se::DeviceMemory<uint8_t> device_buffer(\n         params.buffer_allocations->GetDeviceAddress(buffer));"
        },
        {
            "sha": "16ec523b7430074447da0e27e99ef71acb97cfc6",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffers_checksum_thunk_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 14,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_checksum_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_checksum_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_checksum_thunk_test.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -171,21 +171,25 @@ TEST_F(BuffersDebugChecksumThunkTest, CalculatesChecksums) {\n   // complete in any order.\n   EXPECT_THAT(entries,\n               UnorderedElementsAre(\n-                  AllOf(IsEntryWithMetadata(metadata_store,\n-                                            Metadata{\n-                                                /*thunk_id=*/ThunkId(123),\n-                                                /*buffer_idx=*/0,\n-                                                /*execution_id=*/0,\n-                                                /*is_input=*/true,\n-                                            }),\n+                  AllOf(IsEntryWithMetadata(\n+                            metadata_store,\n+                            Metadata{\n+                                /*thunk_id=*/ThunkId(123),\n+                                /*buffer_idx=*/0,\n+                                /*execution_id=*/0,\n+                                /*is_input=*/true,\n+                                BufferDebugLogEntryProto::CHECK_TYPE_CHECKSUM,\n+                            }),\n                         Field(&BufferDebugLogEntry::value, 12341234)),\n-                  AllOf(IsEntryWithMetadata(metadata_store,\n-                                            Metadata{\n-                                                /*thunk_id=*/ThunkId(123),\n-                                                /*buffer_idx=*/1,\n-                                                /*execution_id=*/0,\n-                                                /*is_input=*/true,\n-                                            }),\n+                  AllOf(IsEntryWithMetadata(\n+                            metadata_store,\n+                            Metadata{\n+                                /*thunk_id=*/ThunkId(123),\n+                                /*buffer_idx=*/1,\n+                                /*execution_id=*/0,\n+                                /*is_input=*/true,\n+                                BufferDebugLogEntryProto::CHECK_TYPE_CHECKSUM,\n+                            }),\n                         Field(&BufferDebugLogEntry::value, 56785678))));\n }\n "
        },
        {
            "sha": "6001aa3fbf99264e0e2582536bc18eba3300ddcb",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffers_nan_count_thunk.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_nan_count_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_nan_count_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_nan_count_thunk.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.h\"\n #include \"xla/backends/gpu/runtime/buffer_debug_log_structs.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/stream_executor/cuda/cuda_compute_capability.h\"\n@@ -90,12 +91,14 @@ absl::Status BuffersDebugNanCountThunk::ExecuteOnStream(\n   const uint32_t execution_id = execution_count_.fetch_add(1);\n \n   for (const auto& [buffer_idx, buffer] : checked_thunk_buffers_) {\n-    const BufferDebugLogEntryId entry_id = metadata_store_->AssignId({\n+    BufferDebugLogEntryMetadataStore::Metadata metadata{\n         checked_thunk_id_,\n         buffer_idx,\n         execution_id,\n         /*is_input=*/runs_before_checked_thunk_,\n-    });\n+        BufferDebugLogEntryProto::CHECK_TYPE_NAN_COUNT,\n+    };\n+    const BufferDebugLogEntryId entry_id = metadata_store_->AssignId(metadata);\n \n     PrimitiveType buffer_type = buffer.element_type();\n     se::DeviceMemoryBase device_buffer ="
        },
        {
            "sha": "89f32c5ddd334853858066e719e79b668abc4e3f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffers_nan_count_thunk_test.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 15,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_nan_count_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_nan_count_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffers_nan_count_thunk_test.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -167,21 +167,26 @@ TEST_F(BuffersDebugNanCountThunkTest, CalculatesNanCounts) {\n \n   // BuffersDebugNanCountThunk launches a kernel for each input buffer, they may\n   // complete in any order.\n-  EXPECT_THAT(\n-      entries,\n-      UnorderedElementsAre(\n-          IsEntryWithMetadata(metadata_store, Metadata{\n-                                                  /*thunk_id=*/ThunkId(123),\n-                                                  /*buffer_idx=*/0,\n-                                                  /*execution_id=*/0,\n-                                                  /*is_input=*/true,\n-                                              }),\n-          IsEntryWithMetadata(metadata_store, Metadata{\n-                                                  /*thunk_id=*/ThunkId(123),\n-                                                  /*buffer_idx=*/1,\n-                                                  /*execution_id=*/0,\n-                                                  /*is_input=*/true,\n-                                              })));\n+  EXPECT_THAT(entries,\n+              UnorderedElementsAre(\n+                  IsEntryWithMetadata(\n+                      metadata_store,\n+                      Metadata{\n+                          /*thunk_id=*/ThunkId(123),\n+                          /*buffer_idx=*/0,\n+                          /*execution_id=*/0,\n+                          /*is_input=*/true,\n+                          BufferDebugLogEntryProto::CHECK_TYPE_NAN_COUNT,\n+                      }),\n+                  IsEntryWithMetadata(\n+                      metadata_store,\n+                      Metadata{\n+                          /*thunk_id=*/ThunkId(123),\n+                          /*buffer_idx=*/1,\n+                          /*execution_id=*/0,\n+                          /*is_input=*/true,\n+                          BufferDebugLogEntryProto::CHECK_TYPE_NAN_COUNT,\n+                      })));\n }\n \n }  // namespace"
        },
        {
            "sha": "b307754381af5237e3a5bcbc1bf3fed255cd1059",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_buffer_debug_pass.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_pass.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -229,6 +229,23 @@ absl::Status DumpBufferDebugLog(\n   VLOG(1) << \"read \" << buffer_debug_log_proto.entries_size() << \" entries\";\n   DumpPerExecutionProtobufToFile(*hlo_module, buffer_debug_log_proto,\n                                  debug_options, \"buffer_debug_log\", nullptr);\n+  int non_zero_nan_count_modules_count = 0;\n+  for (const auto& entry : buffer_debug_log_proto.entries()) {\n+    if (entry.check_type() == BufferDebugLogEntryProto::CHECK_TYPE_NAN_COUNT &&\n+        entry.checksum() > 0) {\n+      LOG(ERROR) << \"Found entry with non zero nan count \" << entry.checksum()\n+                 << \" for thunk \" << entry.thunk_id() << \" and execution \"\n+                 << entry.execution_id() << \" for module: \\n\"\n+                 << hlo_module->ToString();\n+      non_zero_nan_count_modules_count++;\n+    }\n+  }\n+  if (non_zero_nan_count_modules_count > 0 &&\n+      hlo_module->config().debug_options().xla_gpu_detect_nan() ==\n+          DebugOptions::NAN_CHECK_DETECTION_MODE_FAIL) {\n+    LOG(FATAL) << \"Found \" << non_zero_nan_count_modules_count\n+               << \" modules with non zero nan count\";\n+  }\n   return absl::OkStatus();\n }\n "
        },
        {
            "sha": "fe64275210d818203134bb1bbcfcaa0d95fdfd2c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_buffer_debug_pass_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_pass_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_pass_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_buffer_debug_pass_test.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -440,7 +440,8 @@ TEST_F(ThunkBufferDebugPassTest, RecursivelyInsertsBuffersDebugChecksumThunks) {\n TEST_F(ThunkBufferDebugPassTest, InsertsBuffersDebugNanCounterThunks) {\n   static constexpr ThunkId kTestThunkId = ThunkId(123);\n   DebugOptions debug_options;\n-  debug_options.set_xla_gpu_experimental_enable_nan_counter_on_thunks(true);\n+  debug_options.set_xla_gpu_detect_nan(\n+      DebugOptions::NAN_CHECK_DETECTION_MODE_WARNING);\n   se::DeviceDescription device_info;\n   FakeThunkPassBufferAllocator allocator;\n   // The callbacks created by ThunkBufferDebugPass require a HloModule with"
        },
        {
            "sha": "b15f5d010f055a1592b167ac63e223890183b03f",
            "filename": "third_party/xla/xla/debug_options_flags.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 8,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -475,7 +475,7 @@ DebugOptions DefaultDebugOptionsIgnoringFlags() {\n \n   opts.set_xla_keep_shardings_after_spmd(false);\n   opts.set_xla_gpu_experimental_enable_checksum_tracing_on_thunks(false);\n-  opts.set_xla_gpu_experimental_enable_nan_counter_on_thunks(false);\n+  opts.set_xla_gpu_detect_nan(DebugOptions::NAN_CHECK_DETECTION_MODE_NONE);\n   return opts;\n }\n \n@@ -2666,13 +2666,6 @@ void MakeDebugOptionsFlags(std::vector<tsl::Flag>* flag_list,\n       debug_options->xla_gpu_experimental_enable_checksum_tracing_on_thunks(),\n       \"Enables an experimental feature to record checksums of selected thunk \"\n       \"inputs/outputs.\"));\n-  flag_list->push_back(tsl::Flag(\n-      \"xla_gpu_experimental_enable_nan_counter_on_thunks\",\n-      bool_setter_for(\n-          &DebugOptions::set_xla_gpu_experimental_enable_nan_counter_on_thunks),\n-      debug_options->xla_gpu_experimental_enable_nan_counter_on_thunks(),\n-      \"Enables an experimental feature to record the number of nans in thunk \"\n-      \"outputs.\"));\n   flag_list->push_back(tsl::Flag(\n       \"xla_gpu_experimental_thunk_buffer_debug_filter_by_thunk_id_ranges\",\n       setter_for_thunk_buffer_debug_filter_by_thunk_id, \"(none)\",\n@@ -2685,6 +2678,31 @@ void MakeDebugOptionsFlags(std::vector<tsl::Flag>* flag_list,\n       \"Limits the thunk buffer debug instrumentation to thunks with profile \"\n       \"annotations matching one or more regexes passed as comma-separated \"\n       \"string.\"));\n+\n+  auto setter_for_xla_gpu_detect_nan =\n+      [debug_options](const std::string& value) {\n+        DebugOptions::NaNCheckDetectionMode detection_mode;\n+        if (value == \"none\") {\n+          detection_mode = DebugOptions::NAN_CHECK_DETECTION_MODE_NONE;\n+        } else if (value == \"warning\") {\n+          detection_mode = DebugOptions::NAN_CHECK_DETECTION_MODE_WARNING;\n+        } else if (value == \"fail\") {\n+          detection_mode = DebugOptions::NAN_CHECK_DETECTION_MODE_FAIL;\n+        } else {\n+          return false;\n+        }\n+        debug_options->set_xla_gpu_detect_nan(detection_mode);\n+        return true;\n+      };\n+  flag_list->push_back(tsl::Flag(\n+      \"xla_gpu_detect_nan\", setter_for_xla_gpu_detect_nan,\n+      DebugOptions::NaNCheckDetectionMode_Name(\n+          debug_options->xla_gpu_detect_nan()),\n+      \"Controls the behavior of the NaN detector pass that checks for presence \"\n+      \"of NaN values in kernel outputs. Acceptable values are: 'none', \"\n+      \"'warning', and 'fail'. 'none' is the default. If other than 'none' \"\n+      \"value is provided, additional thunks will be added to detect and \"\n+      \"warn or fail the execution if NaNs are detected.\"));\n }  // NOLINT(readability/fn_size)\n \n // Allocates flag_values and flag_objects; this function must not be called more"
        },
        {
            "sha": "693446949b8e85e55af1f85eaa0273b5180f9ff2",
            "filename": "third_party/xla/xla/service/gpu/gpu_executable.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_executable.cc?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -182,7 +182,8 @@ static absl::Status RunThunkPasses(const DebugOptions& debug_options,\n     pipeline.AddPass(std::make_unique<ThunkBufferDebugPass>(\n         ThunkBufferDebugPass::Mode::kChecksum));\n   }\n-  if (debug_options.xla_gpu_experimental_enable_nan_counter_on_thunks()) {\n+  if (debug_options.xla_gpu_detect_nan() !=\n+      DebugOptions::NAN_CHECK_DETECTION_MODE_NONE) {\n     pipeline.AddPass(std::make_unique<ThunkBufferDebugPass>(\n         ThunkBufferDebugPass::Mode::kNanCounter));\n   }"
        },
        {
            "sha": "d127d24f051ae7fc346bd4df035cc44b842a9aae",
            "filename": "third_party/xla/xla/xla.proto",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fxla.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7a752c180a30c64a8c802f9cca2615adf351181f/third_party%2Fxla%2Fxla%2Fxla.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fxla.proto?ref=7a752c180a30c64a8c802f9cca2615adf351181f",
            "patch": "@@ -664,9 +664,6 @@ message DebugOptions {\n   optional bool xla_gpu_experimental_enable_heuristic_collective_combining =\n       366;\n \n-  // If true, enable buffer nan counter on thunks.\n-  optional bool xla_gpu_experimental_enable_nan_counter_on_thunks = 423;\n-\n   // Enable NCCL symmetric buffers.\n   optional bool xla_gpu_experimental_enable_nccl_symmetric_buffers = 406;\n \n@@ -986,6 +983,7 @@ message DebugOptions {\n   reserved 385;  // xla_gpu_experimental_enable_dynamic_dot_search_space\n   reserved \"xla_gpu_unsupported_enable_generic_triton_emitter_for_gemms\";\n   reserved 367;\n+  reserved 423;  // xla_gpu_experimental_enable_checksum_tracing_on_thunks\n \n   //--------------------------------------------------------------------------//\n   // XLA:TPU options.\n@@ -1305,6 +1303,14 @@ message DebugOptions {\n   // Whether to enable checks for unstable reductions in computations.\n   optional UnstableReductionDetectionMode xla_detect_unstable_reductions = 403;\n \n+  enum NaNCheckDetectionMode {\n+    NAN_CHECK_DETECTION_MODE_NONE = 0;\n+    NAN_CHECK_DETECTION_MODE_WARNING = 1;\n+    NAN_CHECK_DETECTION_MODE_FAIL = 2;\n+  }\n+  // Whether to enable checks for NaN values in computations.\n+  optional NaNCheckDetectionMode xla_gpu_detect_nan = 426;\n+\n   reserved 275;  // was xla_gpu_enable_mlir_emitters\n   reserved 281;  // was xla_gpu_max_mlir_kernels\n   reserved 282;  // was xla_gpu_skip_mlir_kernels\n@@ -1398,7 +1404,7 @@ message DebugOptions {\n   // Note: when adding a new flag, please add it to one of the hardware-specific\n   // or hardware-agnostic sections at the top of this proto message.\n \n-  // Next id: 426\n+  // Next id: 427\n \n   // Extra options to pass to the compilation backend (e.g. LLVM); specific\n   // interpretation of these values is left to the backend."
        }
    ],
    "stats": {
        "total": 191,
        "additions": 139,
        "deletions": 52
    }
}