{
    "author": "charlesalaras",
    "message": "Add custom fields for HLO fingerprints\n\nPiperOrigin-RevId: 810974561",
    "sha": "060e1fc1b430be204cc33dd776c94443492000e5",
    "files": [
        {
            "sha": "8c2c5a96014aa116d0110b0a083c92b339828507",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=060e1fc1b430be204cc33dd776c94443492000e5",
            "patch": "@@ -110,6 +110,7 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/functional:function_ref\",\n+        \"@com_google_absl//absl/functional:overload\",\n         \"@com_google_absl//absl/hash\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n@@ -233,6 +234,7 @@ xla_cc_test(\n         \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/container:btree\",\n         \"@com_google_absl//absl/hash\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "3159a4117997ff1261626388324f34ea35319ea0",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 16,
            "changes": 58,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc?ref=060e1fc1b430be204cc33dd776c94443492000e5",
            "patch": "@@ -26,12 +26,14 @@ limitations under the License.\n #include <stack>\n #include <string>\n #include <utility>\n+#include <variant>\n #include <vector>\n \n #include \"absl/algorithm/container.h\"\n #include \"absl/container/btree_map.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/container/flat_hash_set.h\"\n+#include \"absl/functional/overload.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/cord.h\"\n #include \"absl/strings/escaping.h\"\n@@ -346,7 +348,9 @@ void HloModule::ReplaceComputations(\n       replacements, entry_computation_, entry_computation_);\n }\n \n-void HloModule::Print(Printer* printer, const HloPrintOptions& options) const {\n+void HloModule::Print(\n+    Printer* printer, const HloPrintOptions& options,\n+    const absl::btree_map<std::string, NumericOrString>& custom_fields) const {\n   printer->Append(\"HloModule \");\n   if (options.print_ids()) {\n     // When print_ids() is false, exclude module's name because it includes and\n@@ -369,7 +373,35 @@ void HloModule::Print(Printer* printer, const HloPrintOptions& options) const {\n     printer->Append(\" }\");\n   }\n \n-  const HloModuleConfig& config = this->config();\n+  PrintConfig(printer, this->config());\n+\n+  if (!frontend_attributes_.map().empty()) {\n+    AppendCat(printer, \", frontend_attributes=\",\n+              FrontendAttributesToString(frontend_attributes_));\n+  }\n+  if (!original_value_recovery_table_.empty()) {\n+    HloPrintOptions new_options = options;\n+    new_options.set_indent_amount(options.indent_amount() + 1);\n+    printer->Append(\", origin_recovery_table={\\n\");\n+    printer->Append(original_value_recovery_table_.ToString(new_options));\n+    printer->Append(\"}\\n\");\n+  }\n+  for (const auto& [key, value] : custom_fields) {\n+    printer->Append(absl::StrCat(\", \", key, \"=\"));\n+    std::visit(\n+        absl::Overload{\n+            [&printer](const std::string& data) { printer->Append(data); },\n+            [&printer](const int64_t data) { printer->Append(data); },\n+            [&printer](const double data) { printer->Append(data); },\n+        },\n+        value);\n+  }\n+  printer->Append(\"\\n\\n\");\n+  PrintComputations(printer, options);\n+}\n+\n+void HloModule::PrintConfig(Printer* printer,\n+                            const HloModuleConfig& config) const {\n   if (config.alias_passthrough_params()) {\n     printer->Append(\", alias_passthrough_params=true\");\n   }\n@@ -404,18 +436,10 @@ void HloModule::Print(Printer* printer, const HloPrintOptions& options) const {\n     printer->Append(\", num_partitions=\");\n     printer->Append(config.num_partitions());\n   }\n-  if (!frontend_attributes_.map().empty()) {\n-    AppendCat(printer, \", frontend_attributes=\",\n-              FrontendAttributesToString(frontend_attributes_));\n-  }\n-  if (!original_value_recovery_table_.empty()) {\n-    HloPrintOptions new_options = options;\n-    new_options.set_indent_amount(options.indent_amount() + 1);\n-    printer->Append(\", origin_recovery_table={\\n\");\n-    printer->Append(original_value_recovery_table_.ToString(new_options));\n-    printer->Append(\"}\\n\");\n-  }\n-  printer->Append(\"\\n\\n\");\n+}\n+\n+void HloModule::PrintComputations(Printer* printer,\n+                                  const HloPrintOptions& options) const {\n   // We use a DFS postorder traversal to ensure that computations are printed\n   // more consistently run to run. Even thet non-dfs postorder is deterministic,\n   // but exactly which topological ordering it yields depends on the order in\n@@ -509,9 +533,11 @@ class HighwayHashPrinter : public Printer {\n };\n }  // namespace\n \n-uint64_t HloModule::ToFingerprint(const HloPrintOptions& options) const {\n+uint64_t HloModule::ToFingerprint(\n+    const HloPrintOptions& options,\n+    const absl::btree_map<std::string, NumericOrString>& custom_fields) const {\n   HighwayHashPrinter printer;\n-  Print(&printer, options);\n+  Print(&printer, options, custom_fields);\n   return printer.ToFingerprint();\n }\n "
        },
        {
            "sha": "f55e2ef71b1eca871afbc4538e07b6b668683c52",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.h",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h?ref=060e1fc1b430be204cc33dd776c94443492000e5",
            "patch": "@@ -26,13 +26,16 @@ limitations under the License.\n #include <random>\n #include <string>\n #include <utility>\n+#include <variant>\n #include <vector>\n \n #include \"absl/base/thread_annotations.h\"\n+#include \"absl/container/btree_map.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/cord.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n@@ -69,6 +72,8 @@ using LayoutCanonicalizationCallback =\n     std::function<absl::StatusOr<std::pair<std::vector<Shape>, Shape>>(\n         const HloModule& module)>;\n \n+using NumericOrString = std::variant<std::string, int64_t, double>;\n+\n // Describes a compilation unit at the HLO level.\n //\n // HloModule is the top-level unit in the HLO IR.  It corresponds to a whole\n@@ -438,14 +443,25 @@ class HloModule {\n   bool is_dynamic() const { return is_dynamic_; }\n   void set_is_dynamic(bool is_dynamic) { is_dynamic_ = is_dynamic; }\n \n+ private:\n+  void PrintComputations(Printer* printer,\n+                         const HloPrintOptions& options) const;\n+  void PrintConfig(Printer* printer, const HloModuleConfig& config) const;\n+\n+ public:\n   // Prints a string representation of the module.\n   //\n   // (We express the default options using an overload rather than a default\n   // param because gdb ignores default params, but does resolve overloads.)\n   void Print(Printer* printer) const {\n-    return Print(printer, HloPrintOptions::Default());\n+    return Print(printer, HloPrintOptions::Default(), {});\n+  }\n+  void Print(Printer* printer, const HloPrintOptions& options) const {\n+    return Print(printer, options, {});\n   }\n-  void Print(Printer* printer, const HloPrintOptions& options) const;\n+  void Print(\n+      Printer* printer, const HloPrintOptions& options,\n+      const absl::btree_map<std::string, NumericOrString>& custom_fields) const;\n \n   // Return a string representation of the module.\n   //\n@@ -462,7 +478,15 @@ class HloModule {\n   absl::Cord ToCord(const HloPrintOptions& options) const;\n \n   // Returns a stable fingerprint of the module using the given print options.\n-  uint64_t ToFingerprint(const HloPrintOptions& options) const;\n+  //\n+  // (We express the default options using an overload rather than a default\n+  // param because gdb ignores default params, but does resolve overloads.)\n+  uint64_t ToFingerprint(const HloPrintOptions& options) const {\n+    return ToFingerprint(options, {});\n+  }\n+  uint64_t ToFingerprint(\n+      const HloPrintOptions& options,\n+      const absl::btree_map<std::string, NumericOrString>& custom_fields) const;\n \n   // Remaps the instruction ids in the proto to be consecutive. This is useful\n   // for loading a proto that had its ids manually created, created incorrectly"
        },
        {
            "sha": "51ea184146296d805e15d11740a232ea14f685c8",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 5,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/060e1fc1b430be204cc33dd776c94443492000e5/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module_test.cc?ref=060e1fc1b430be204cc33dd776c94443492000e5",
            "patch": "@@ -18,12 +18,14 @@ limitations under the License.\n #include <cstddef>\n #include <cstdint>\n #include <memory>\n+#include <optional>\n #include <string>\n #include <utility>\n #include <vector>\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"absl/container/btree_map.h\"\n #include \"absl/hash/hash.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n@@ -75,12 +77,17 @@ TEST(HloModuleTest, AbslHashValue) {\n }\n \n TEST(HloModuleTest, ToFingerprint) {\n-  auto fp = [](const HloModule& module) {\n-    return module.ToFingerprint(HloPrintOptions::ModuleFingerprint());\n+  auto fp = [](const HloModule& module,\n+               std::optional<absl::btree_map<std::string, NumericOrString>>\n+                   custom_fields) {\n+    return custom_fields.has_value()\n+               ? module.ToFingerprint(HloPrintOptions::ModuleFingerprint(),\n+                                      *custom_fields)\n+               : module.ToFingerprint(HloPrintOptions::ModuleFingerprint());\n   };\n   HloModule module1(\"m1\", HloModuleConfig());\n   HloModule module2(\"m2\", HloModuleConfig());\n-  EXPECT_EQ(fp(module1), fp(module2));\n+  EXPECT_EQ(fp(module1, std::nullopt), fp(module2, std::nullopt));\n \n   absl::string_view hlo = R\"(\n       HloModule m3\n@@ -93,8 +100,25 @@ TEST(HloModuleTest, ToFingerprint) {\n                           ParseAndReturnUnverifiedModule(hlo));\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module4,\n                           ParseAndReturnUnverifiedModule(hlo));\n-  EXPECT_EQ(fp(*module3), fp(*module4));\n-  EXPECT_NE(fp(module1), fp(*module4));\n+  EXPECT_EQ(fp(*module3, std::nullopt), fp(*module4, std::nullopt));\n+  EXPECT_NE(fp(module1, std::nullopt), fp(*module4, std::nullopt));\n+\n+  const absl::btree_map<std::string, NumericOrString> custom_fields = {\n+      {\"parameter_0\", int64_t{50}},\n+      {\"parameter_1\", \"string_value\"},\n+      {\"parameter_2\", 10.594},\n+  };\n+\n+  EXPECT_NE(fp(*module3, custom_fields), fp(*module3, std::nullopt));\n+  EXPECT_NE(fp(module1, custom_fields), fp(*module4, custom_fields));\n+\n+  EXPECT_EQ(fp(*module3, custom_fields), fp(*module4, custom_fields));\n+  EXPECT_EQ(fp(*module4, custom_fields), fp(*module4, custom_fields));\n+\n+  const absl::btree_map<std::string, NumericOrString> custom_fields2 = {\n+      {\"parameter_0\", int64_t{1}},\n+  };\n+  EXPECT_NE(fp(*module3, custom_fields), fp(*module3, custom_fields2));\n }\n \n TEST(HloModuleTest, MutableAndReadOnlyConfigEquals) {"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 100,
        "deletions": 24
    }
}