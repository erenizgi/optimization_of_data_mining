{
    "author": "penpornk",
    "message": "[xla:cpu] Do not expand convolution feature group if the convolution is supported by libraries.\n\nPiperOrigin-RevId: 846299624",
    "sha": "5db58f8f58a6ff49cabfacc7bc1c938099da4854",
    "files": [
        {
            "sha": "ff400cc58cf19849aa6909f1a8927e737fcffadf",
            "filename": "third_party/xla/xla/backends/cpu/transforms/BUILD",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5db58f8f58a6ff49cabfacc7bc1c938099da4854/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5db58f8f58a6ff49cabfacc7bc1c938099da4854/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD?ref=5db58f8f58a6ff49cabfacc7bc1c938099da4854",
            "patch": "@@ -113,3 +113,14 @@ cc_library(\n         \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n+\n+xla_cc_test(\n+    name = \"ynn_matcher_test\",\n+    srcs = [\"ynn_matcher_test.cc\"],\n+    deps = [\n+        \"//xla:xla_proto_cc\",\n+        \"//xla/service:cpu_plugin\",\n+        \"//xla/tests:hlo_test_base\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)"
        },
        {
            "sha": "d03d56c5a68f36ec6e5110d644ad92b6b3c62d25",
            "filename": "third_party/xla/xla/backends/cpu/transforms/ynn_matcher_test.cc",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5db58f8f58a6ff49cabfacc7bc1c938099da4854/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fynn_matcher_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5db58f8f58a6ff49cabfacc7bc1c938099da4854/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fynn_matcher_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fynn_matcher_test.cc?ref=5db58f8f58a6ff49cabfacc7bc1c938099da4854",
            "patch": "@@ -0,0 +1,54 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include <gtest/gtest.h>\n+#include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/xla.pb.h\"\n+\n+namespace xla::cpu {\n+namespace {\n+\n+class YnnE2eTest : public HloTestBase {\n+ protected:\n+  DebugOptions GetDebugOptionsForTest() const override {\n+    DebugOptions debug_options = HloTestBase::GetDebugOptionsForTest();\n+    debug_options.add_xla_cpu_experimental_ynn_fusion_type(\n+        DebugOptions::LIBRARY_FUSION_TYPE_INDIVIDUAL_CONVOLUTION);\n+    debug_options.clear_xla_cpu_experimental_ynn_fusion_type();\n+    return debug_options;\n+  }\n+};\n+\n+TEST_F(YnnE2eTest, DoNotDegroupConvolutionFeatures) {\n+  const char* matmul_module_str = R\"(\n+  HloModule convolution\n+\n+  ENTRY %main {\n+    %lhs = f32[1,7,8,9] parameter(0)\n+    %rhs = f32[1,5,3,9] parameter(1)\n+    ROOT %conv = f32[1,4,8,9] convolution(%lhs, %rhs),\n+        window={size=1x5 stride=2x1 pad=0_0x2_2}, dim_labels=b01f_01io->b01f,\n+        feature_group_count=3\n+  })\";\n+\n+  // If the convolution feature group is de-grouped, the shape will change to:\n+  //   f32[1,4,8,3,3]{4,3,2,1,0}\n+  // This convolution is supported by YNNPACK, so the shape should not change.\n+  MatchOptimizedHlo(matmul_module_str,\n+                    \"CHECK: f32[1,4,8,9]{3,2,1,0} convolution\");\n+}\n+\n+}  // namespace\n+}  // namespace xla::cpu"
        },
        {
            "sha": "8675446af52fc668685fef7ef11ec72d7bf6be88",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 10,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5db58f8f58a6ff49cabfacc7bc1c938099da4854/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5db58f8f58a6ff49cabfacc7bc1c938099da4854/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=5db58f8f58a6ff49cabfacc7bc1c938099da4854",
            "patch": "@@ -781,17 +781,25 @@ absl::Status CpuCompiler::RunHloPassesThroughLayoutAssn(\n     return false;\n   };\n   pipeline.AddPass<ConvolutionGroupConverter>(\n-      /*should_expand=*/[](HloInstruction* conv) { return true; }, cost_model,\n+      /*should_expand=*/\n+      [&library_supports_convolution](HloInstruction* conv) {\n+        return !library_supports_convolution(*conv);\n+      },\n+      cost_model,\n       /*convert_batch_groups_only=*/true);\n-  auto feature_group_should_expand = [](HloInstruction* conv) {\n-    switch (conv->shape().element_type()) {\n-      case F16:\n-      case F32:\n-        return false;\n-      default:\n-        return true;\n-    }\n-  };\n+  auto feature_group_should_expand =\n+      [&library_supports_convolution](HloInstruction* conv) {\n+        if (library_supports_convolution(*conv)) {\n+          return false;\n+        }\n+        switch (conv->shape().element_type()) {\n+          case F16:\n+          case F32:\n+            return false;\n+          default:\n+            return true;\n+        }\n+      };\n   pipeline.AddPass<ConvolutionGroupConverter>(\n       feature_group_should_expand, cost_model,\n       /*convert_batch_groups_only=*/false);"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 83,
        "deletions": 10
    }
}