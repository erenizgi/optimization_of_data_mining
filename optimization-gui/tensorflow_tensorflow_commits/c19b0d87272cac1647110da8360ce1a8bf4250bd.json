{
    "author": "bchetioui",
    "message": "[XLA]Â Relax restrictions on the `iteration_space` parameter in `Schedule`.\n\nWe're perfectly able to construct a schedule using only a subset of the\niteration space of a `tile_offsets_indexing`---and in fact need to when we are\nprocessing nested fusions.\n\nPiperOrigin-RevId: 820454010",
    "sha": "c19b0d87272cac1647110da8360ce1a8bf4250bd",
    "files": [
        {
            "sha": "8b123dff64114ccfe0f032754090039d6c7dcc2b",
            "filename": "third_party/xla/xla/codegen/tiling/tiled_hlo_schedule.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 16,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c19b0d87272cac1647110da8360ce1a8bf4250bd/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c19b0d87272cac1647110da8360ce1a8bf4250bd/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule.cc?ref=c19b0d87272cac1647110da8360ce1a8bf4250bd",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #include \"xla/codegen/tiling/tiled_hlo_schedule.h\"\n \n #include <cstdint>\n+#include <optional>\n #include <vector>\n \n #include \"absl/algorithm/container.h\"\n@@ -49,9 +50,9 @@ namespace {\n // indexing map.\n absl::Status ValidateIterationSpace(const IterationSpace& iteration_space,\n                                     const IndexingMap& tile_offsets_indexing) {\n-  if (iteration_space.size() != tile_offsets_indexing.GetDimVarsCount()) {\n+  if (tile_offsets_indexing.GetDimVarsCount() < iteration_space.size()) {\n     return absl::InvalidArgumentError(absl::StrFormat(\n-        \"Expected iteration space to have exactly as many dimensions as there \"\n+        \"Expected iteration space to have at most as many dimensions as there \"\n         \"are parameters in the tile offsets indexing map, but iteration space \"\n         \"has %d dimensions, and tile offsets indexing map has %d dimensions.\",\n         iteration_space.size(), tile_offsets_indexing.GetDimVarsCount()));\n@@ -197,28 +198,33 @@ TransposedDotTiledHloSchedule::Create(\n absl::StatusOr<IndexingMap> TransposedDotTiledHloSchedule::Schedule(\n     const IndexingMap& tile_offsets_indexing, IterationSpace iteration_space,\n     gpu::SymbolicExprContext* ctx) const {\n-  CHECK_EQ(iteration_space.size(), tiling_specification_.num_parameters());\n   TF_RETURN_IF_ERROR(\n       ValidateIterationSpace(iteration_space, tile_offsets_indexing));\n \n-  DimensionInfo m_dim_info = iteration_space[m_dim_id_];\n-  DimensionInfo n_dim_info = iteration_space[n_dim_id_];\n-\n-  if (m_dim_info.dimension_id != m_dim_id_) {\n-    return absl::InvalidArgumentError(absl::StrFormat(\n-        \"Expected dimension at offset %d to have id %d but got %d.\", m_dim_id_,\n-        m_dim_id_, m_dim_info.dimension_id));\n+  std::optional<int64_t> local_m_dim_index;\n+  std::optional<int64_t> local_n_dim_index;\n+  for (int64_t i = 0; i < iteration_space.size(); ++i) {\n+    if (iteration_space[i].dimension_id == m_dim_id_) {\n+      local_m_dim_index = i;\n+    } else if (iteration_space[i].dimension_id == n_dim_id_) {\n+      local_n_dim_index = i;\n+    }\n   }\n-  if (n_dim_info.dimension_id != n_dim_id_) {\n-    return absl::InvalidArgumentError(absl::StrFormat(\n-        \"Expected dimension at offset %d to have id %d but got %d.\", n_dim_id_,\n-        n_dim_id_, n_dim_info.dimension_id));\n+\n+  // Nothing to transpose if any of the dimensions is inactive. Just return the\n+  // major-to-minor schedule.\n+  if (!local_m_dim_index.has_value() || !local_n_dim_index.has_value()) {\n+    return MajorToMinorScheduleImpl(tile_offsets_indexing, iteration_space,\n+                                    ctx);\n   }\n \n+  DimensionInfo m_dim_info = iteration_space[*local_m_dim_index];\n+  DimensionInfo n_dim_info = iteration_space[*local_n_dim_index];\n+\n   std::vector<DimensionInfo> transposed_iteration_space(iteration_space.begin(),\n                                                         iteration_space.end());\n-  transposed_iteration_space[m_dim_id_] = n_dim_info;\n-  transposed_iteration_space[n_dim_id_] = m_dim_info;\n+  transposed_iteration_space[*local_m_dim_index] = n_dim_info;\n+  transposed_iteration_space[*local_n_dim_index] = m_dim_info;\n   return MajorToMinorScheduleImpl(tile_offsets_indexing,\n                                   transposed_iteration_space, ctx);\n }"
        },
        {
            "sha": "7544e8d8fba6e0395d62ecf0a607b19283dc2569",
            "filename": "third_party/xla/xla/codegen/tiling/tiled_hlo_schedule.h",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c19b0d87272cac1647110da8360ce1a8bf4250bd/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c19b0d87272cac1647110da8360ce1a8bf4250bd/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule.h?ref=c19b0d87272cac1647110da8360ce1a8bf4250bd",
            "patch": "@@ -49,10 +49,8 @@ class TiledHloSchedule {\n \n   // Returns a schedule for the given root instruction as an indexing map.\n   //\n-  // `iteration_space` must contain one entry for each dimension id in the\n-  // discrete range {0, ..., iteration_space.size() - 1}, and the number of\n-  // dimensions in `iteration_space` must match the number of dimension\n-  // parameters in `tile_offsets_indexing`.\n+  // `iteration_space` must contain at most one entry for each dimension id in\n+  // the discrete range {0, ..., tile_offsets_indexing.GetDimVarsCount() - 1}.\n   //\n   // We unfortunately can't pass a `TilingSpecification` here directly in order\n   // to handle assumption-breaking calls in the case of multi-output fusions.\n@@ -64,9 +62,9 @@ class TiledHloSchedule {\n   //     the iteration space (i.e. the product of `iteration_space`'s\n   //     `dimension_size`s);\n   // (2) the set of results generatable with the map must be equal to the set\n-  //     of results of `tile_offsets_indexing` (i.e. the map may only reorder\n-  //     how the results are generated, but may not change the results\n-  //     themselves);\n+  //     of results of `tile_offsets_indexing` on the subspace defined by the\n+  //     parameter iteration space (i.e. the map may only reorder how the\n+  //     results are generated, but may not change the results themselves);\n   virtual absl::StatusOr<IndexingMap> Schedule(\n       const IndexingMap& tile_offsets_indexing, IterationSpace iteration_space,\n       gpu::SymbolicExprContext* ctx) const = 0;"
        },
        {
            "sha": "390ff3e9cae8e88e0a1d5725ba58f79bea054fbc",
            "filename": "third_party/xla/xla/codegen/tiling/tiled_hlo_schedule_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c19b0d87272cac1647110da8360ce1a8bf4250bd/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c19b0d87272cac1647110da8360ce1a8bf4250bd/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Ftiled_hlo_schedule_test.cc?ref=c19b0d87272cac1647110da8360ce1a8bf4250bd",
            "patch": "@@ -69,7 +69,6 @@ TEST_F(MajorToMinorTiledHloScheduleTest,\n   };\n   std::vector<DimensionInfo> iteration_space = {\n       {/*dimension_id=*/2, /*dimension_size=*/bound(2)},\n-      {/*dimension_id=*/0, /*dimension_size=*/bound(0)},\n       {/*dimension_id=*/1, /*dimension_size=*/bound(1)},\n       {/*dimension_id=*/3, /*dimension_size=*/bound(3)},\n   };\n@@ -83,22 +82,22 @@ TEST_F(MajorToMinorTiledHloScheduleTest,\n   //     the iteration space (i.e. the product of `iteration_space`'s\n   //     `dimension_size`s);\n   EXPECT_EQ(scheduled_indexing.GetDimVarsCount(), 1);\n-  int64_t iteration_space_size = bound(0) * bound(1) * bound(2) * bound(3);\n+  int64_t iteration_space_size = bound(1) * bound(2) * bound(3);\n   Interval expected_parameter_interval{0, iteration_space_size - 1};\n   EXPECT_EQ(scheduled_indexing.GetDimensionBound(0),\n             expected_parameter_interval);\n \n   // (2) the set of results generatable with the map must be equal to the set\n-  //     of results of `tile_offsets_indexing` (i.e. the map may only reorder\n-  //     how the results are generated, but may not change the results\n-  //     themselves);\n+  //     of results of `tile_offsets_indexing` on the subspace defined by the\n+  //     parameter iteration space (i.e. the map may only reorder how the\n+  //     results are generated, but may not change the results themselves);\n   EXPECT_EQ(scheduled_indexing, *ParseIndexingMap(R\"(\n-    (pid_0) -> (pid_0 floordiv 42, pid_0 mod 7), domain: pid_0 in [0, 209]\n+    (pid_0) -> (pid_0 floordiv 21, pid_0 mod 7), domain: pid_0 in [0, 104]\n   )\",\n                                                   &symbolic_expr_context_));\n \n-  // `pid_0 floordiv 42` has the same upper bound as `d2`.\n-  EXPECT_EQ(iteration_space_size / 42, bound(2));\n+  // `pid_0 floordiv 21` has the same upper bound as `d2`.\n+  EXPECT_EQ(iteration_space_size / 21, bound(2));\n   // `pid_0 mod 7` has the same upper bound as `d3`.\n   EXPECT_EQ(7, bound(3));\n }\n@@ -110,14 +109,17 @@ TEST_F(MajorToMinorTiledHloScheduleTest,\n                         &symbolic_expr_context_);\n   MajorToMinorTiledHloSchedule scheduler;\n \n-  // The iteration space has the wrong number of dimensions.\n+  // The iteration space has too many dimensions.\n   EXPECT_THAT(\n-      scheduler.Schedule(offsets_indexing, /*iteration_space=*/{},\n+      scheduler.Schedule(offsets_indexing, /*iteration_space=*/\n+                         {{/*dimension_id=*/0, /*dimension_size=*/1},\n+                          {/*dimension_id=*/1, /*dimension_size=*/3},\n+                          {/*dimension_id=*/2, /*dimension_size=*/0}},\n                          &symbolic_expr_context_),\n       StatusIs(\n           absl::StatusCode::kInvalidArgument,\n           HasSubstr(\n-              \"Expected iteration space to have exactly as many dimensions\")));\n+              \"Expected iteration space to have at most as many dimensions\")));\n \n   // The iteration space has an out-of-bounds dimension ID.\n   EXPECT_THAT(scheduler.Schedule(offsets_indexing, /*iteration_space=*/"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 40,
        "deletions": 34
    }
}