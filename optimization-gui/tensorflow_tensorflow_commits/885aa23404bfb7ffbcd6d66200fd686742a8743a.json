{
    "author": "vsytch",
    "message": "[XLA] Remove expensive ReplaceOperandWith calls\n\nThese simply check that before and after shapes are the same and then delegate to ReplaceOperandWithDifferentShape. Simply call the later.\n\nPiperOrigin-RevId: 800172847",
    "sha": "885aa23404bfb7ffbcd6d66200fd686742a8743a",
    "files": [
        {
            "sha": "9bac9fcde4f1983af84e412321f3286b9ddddb6f",
            "filename": "third_party/xla/xla/hlo/transforms/collectives/infeed_token_propagation.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/885aa23404bfb7ffbcd6d66200fd686742a8743a/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Finfeed_token_propagation.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/885aa23404bfb7ffbcd6d66200fd686742a8743a/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Finfeed_token_propagation.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Finfeed_token_propagation.cc?ref=885aa23404bfb7ffbcd6d66200fd686742a8743a",
            "patch": "@@ -172,8 +172,10 @@ absl::StatusOr<HloInstruction*> InsertTokenIntoTuple(HloInstruction* tuple,\n   HloInstruction* original_tuple = TupleUtil::Duplicate(tuple);\n   for (HloInstruction* original_user : original_users) {\n     for (int64_t idx : original_user->operand_indices(tuple)) {\n+      // We expect the shape to be same, but checking that it is the same is\n+      // expensive.\n       TF_RETURN_IF_ERROR(\n-          original_user->ReplaceOperandWith(idx, original_tuple));\n+          original_user->ReplaceOperandWithDifferentShape(idx, original_tuple));\n     }\n   }\n \n@@ -231,8 +233,10 @@ absl::Status CanonicalizeConditionalInstruction(HloInstruction* conditional) {\n     // insert tokens into the input tuple.\n     if (branch_tuple->opcode() == HloOpcode::kParameter) {\n       branch_tuple = TupleUtil::Duplicate(branch_tuple);\n-      TF_RETURN_IF_ERROR(\n-          conditional->ReplaceOperandWith(branch_operand_idx, branch_tuple));\n+      // We expect the shape to be same, but checking that it is the same is\n+      // expensive.\n+      TF_RETURN_IF_ERROR(conditional->ReplaceOperandWithDifferentShape(\n+          branch_operand_idx, branch_tuple));\n     }\n \n     // Explicitly make the root of the branch a tuple.\n@@ -326,7 +330,9 @@ absl::Status CanonicalizeWhileInstruction(HloInstruction* loop) {\n   // insert tokens into the input tuple.\n   if (loop_tuple->opcode() == HloOpcode::kParameter) {\n     loop_tuple = TupleUtil::Duplicate(loop_tuple);\n-    TF_RETURN_IF_ERROR(loop->ReplaceOperandWith(0, loop_tuple));\n+    // We expect the shape to be same, but checking that it is the same is\n+    // expensive.\n+    TF_RETURN_IF_ERROR(loop->ReplaceOperandWithDifferentShape(0, loop_tuple));\n   }\n \n   // Explicitly make the root of the body a tuple.\n@@ -466,7 +472,10 @@ absl::Status InfeedTokenPropagation::PropagateToken(\n           // Parent outfeed happens after child infeed. Stitch via parent input\n           // token.\n           CHECK_EQ(begin->opcode(), HloOpcode::kOutfeed);\n-          TF_RETURN_IF_ERROR(begin->ReplaceOperandWith(1, output_token_));\n+          // We expect the shape to be same, but checking that it is the same\n+          // is expensive.\n+          TF_RETURN_IF_ERROR(\n+              begin->ReplaceOperandWithDifferentShape(1, output_token_));\n           output_token_ = end;\n         } else {\n           LOG(WARNING) << absl::StrFormat("
        }
    ],
    "stats": {
        "total": 19,
        "additions": 14,
        "deletions": 5
    }
}