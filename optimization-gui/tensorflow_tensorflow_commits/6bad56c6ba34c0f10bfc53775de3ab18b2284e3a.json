{
    "author": "pschuh",
    "message": "Update PjRtStreamExecutorClient::BufferFromHostLiteral to use\nPjRtStreamExecutorClient::LinearizeInto instead via CommonPjRtClient.\n\nPiperOrigin-RevId: 814342525",
    "sha": "6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
    "files": [
        {
            "sha": "542f1de001e90e677264a105ca26dd91a9c491b4",
            "filename": "third_party/xla/xla/pjrt/common_pjrt_client.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.cc?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -150,7 +150,7 @@ CommonPjRtClient::BufferFromHostLiteral(const LiteralSlice& literal,\n                                         /*allocate_after=*/{}));\n   TF_ASSIGN_OR_RETURN(\n       auto definition_event,\n-      LinearizeInto(literal, device_shape.layout(),\n+      LinearizeInto(literal, device_shape,\n                     HostBufferSemantics::kImmutableUntilTransferCompletes,\n                     raw_buffer));\n   return DefineBuffer(device_shape, std::move(raw_buffer),\n@@ -419,7 +419,7 @@ CommonPjRtBufferImpl::CopyToCpuMemorySpace(const xla::Shape& dst_shape,\n           status_or_h2d_transfer_event;\n       if (needs_second_copy) {\n         status_or_h2d_transfer_event = dst_client->LinearizeInto(\n-            *literal, dst_shape.layout(),\n+            *literal, dst_shape,\n             PjRtClient::HostBufferSemantics::kImmutableUntilTransferCompletes,\n             dst_raw_buffer);\n       } else {\n@@ -601,7 +601,7 @@ CommonPjRtBufferImpl::CopyFromCpuToMemorySpace(\n         definition_events_span,\n         [dst_raw_buffer = std::move(dst_raw_buffer),\n          src_raw_buffer = std::move(src_raw_buffer), dst_client = dst_client,\n-         src_shape = on_device_shape(), device_layout = dst_shape.layout(),\n+         src_shape = on_device_shape(), device_shape = dst_shape,\n          definition_events = std::move(definition_events),\n          definition_event_promise = std::move(definition_event_promise),\n          src_usage_event_promise = std::move(src_usage_event_promise),\n@@ -633,7 +633,7 @@ CommonPjRtBufferImpl::CopyFromCpuToMemorySpace(\n               std::make_unique<MutableBorrowingLiteral>(\n                   reinterpret_cast<char*>(base_ptr), src_shape);\n           auto status_or_h2d_transfer_event = dst_client->LinearizeInto(\n-              *literal, device_layout,\n+              *literal, device_shape,\n               PjRtClient::HostBufferSemantics::kImmutableUntilTransferCompletes,\n               std::move(dst_raw_buffer));\n           CHECK_OK(status_or_h2d_transfer_event);"
        },
        {
            "sha": "bb9f2b6f632f9ef271cb1d6b8415bced8b9866c5",
            "filename": "third_party/xla/xla/pjrt/common_pjrt_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.h?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -92,7 +92,7 @@ class CommonPjRtClient : public PjRtClient {\n   // Linearizes a literal into a raw buffer and returns a DeviceEvent\n   // for when the linearization is complete.\n   virtual absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>> LinearizeInto(\n-      const LiteralSlice& literal, const xla::Layout& layout,\n+      const LiteralSlice& literal, const xla::Shape& device_shape,\n       HostBufferSemantics host_buffer_semantics,\n       tsl::RCReference<CommonPjRtRawBuffer> raw_buffer) {\n     return absl::UnimplementedError(\"LinearizeInto is not supported\");"
        },
        {
            "sha": "79c62d22a90e17c025df686a5b3188787a287b1b",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -945,7 +945,7 @@ PjRtCpuClient::LinearizeHostBufferInto(\n }\n \n absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>> PjRtCpuClient::LinearizeInto(\n-    const LiteralSlice& literal, const xla::Layout& layout,\n+    const LiteralSlice& literal, const xla::Shape& device_shape,\n     HostBufferSemantics host_buffer_semantics,\n     tsl::RCReference<CommonPjRtRawBuffer> raw_buffer) {\n   if (host_buffer_semantics ==\n@@ -954,7 +954,7 @@ absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>> PjRtCpuClient::LinearizeInto(\n         \"ImmutableOnlyDuringCall semantics is not supported on CPU.\");\n   }\n   return tsl::down_cast<CpuRawBuffer*>(raw_buffer.get())\n-      ->CopyFromLiteral(literal, layout, async_work_runner());\n+      ->CopyFromLiteral(literal, device_shape.layout(), async_work_runner());\n }\n \n absl::StatusOr<CompiledMemoryStats> PjRtCpuExecutable::GetCompiledMemoryStats()"
        },
        {
            "sha": "bbe42478ef3c3955edef9d34865f76385d2e2cd0",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.h?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -234,7 +234,7 @@ class PjRtCpuClient final : public CommonPjRtClient {\n       tsl::RCReference<CommonPjRtRawBuffer> raw_buffer) override;\n \n   absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>> LinearizeInto(\n-      const LiteralSlice& literal, const xla::Layout& layout,\n+      const LiteralSlice& literal, const xla::Shape& device_shape,\n       HostBufferSemantics host_buffer_semantics,\n       tsl::RCReference<CommonPjRtRawBuffer> raw_buffer) override;\n "
        },
        {
            "sha": "88e385492ba8ffc939d86607932a9bfe9bfff75f",
            "filename": "third_party/xla/xla/pjrt/host_to_device_transfer_manager.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_to_device_transfer_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_to_device_transfer_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_to_device_transfer_manager.cc?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -251,7 +251,7 @@ class CommonAsyncHostToDeviceTransferManager\n     TF_ASSIGN_OR_RETURN(\n         auto h2d_transfer_event,\n         client_->LinearizeInto(\n-            literal, device_shapes_[buffer_index].layout(),\n+            literal, device_shapes_[buffer_index],\n             PjRtClient::HostBufferSemantics::kImmutableUntilTransferCompletes,\n             raw_buffer));\n     if (client_->event_tracking_enabled()) {"
        },
        {
            "sha": "5948e9c8b110848590d55c4b41c0564f93c5c13b",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 41,
            "changes": 63,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -1124,59 +1124,42 @@ PjRtStreamExecutorClient::CreateErrorBuffer(absl::Status error,\n       shape, std::move(dummy_device_buffer), this, device, memory);\n }\n \n-absl::StatusOr<std::unique_ptr<PjRtBuffer>>\n-PjRtStreamExecutorClient::BufferFromHostLiteral(const LiteralSlice& literal,\n-                                                PjRtMemorySpace* memory_space,\n-                                                const Layout* device_layout) {\n-  if (device_layout) {\n-    return absl::UnimplementedError(absl::StrCat(\n-        \"BufferFromHostLiteral with device_layout is not implemented on \"\n-        \"platform: \",\n-        platform_name()));\n-  }\n+absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>>\n+PjRtStreamExecutorClient::LinearizeInto(\n+    const LiteralSlice& literal, const xla::Shape& device_shape,\n+    HostBufferSemantics host_buffer_semantics,\n+    tsl::RCReference<CommonPjRtRawBuffer> raw_buffer) {\n+  auto* memory_space = raw_buffer->memory_space();\n+\n   CHECK_EQ(memory_space->devices().size(), 1);\n   PjRtDevice* device = memory_space->devices().front();\n-\n-  tsl::profiler::TraceMe traceme(\n-      \"PjRtStreamExecutorClient::BufferFromHostLiteral\");\n-  VLOG(1) << \"PjRtStreamExecutorClient::BufferFromHostLiteral: shape: \"\n-          << literal.shape().ToString() << \" device: \" << device->DebugString();\n-  TF_ASSIGN_OR_RETURN(LocalDeviceState * local_device,\n-                      tensorflow::down_cast<PjRtStreamExecutorDevice*>(device)\n-                          ->GetLocalDeviceState());\n+  auto* local_device =\n+      tensorflow::down_cast<PjRtStreamExecutorRawBuffer*>(raw_buffer.get())\n+          ->local_device();\n+  auto* copy_stream = local_device->host_to_device_stream();\n+  BufferSequencingEventRef event = BufferSequencingEvent::Create(thread_pool());\n+  WaitForAllocation(copy_stream, *raw_buffer);\n+  auto on_device_shape = device_shape;\n \n   TransferManager* transfer_manager = client()->backend().transfer_manager();\n-  TF_ASSIGN_OR_RETURN(\n-      Shape compact_shape,\n-      transfer_manager->ChooseCompactLayoutForShape(literal.shape()));\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<PjRtStreamExecutorBuffer> py_buffer,\n-      AllocateDestinationBuffer(compact_shape, device, local_device,\n-                                local_device->host_to_device_stream(),\n-                                /*is_uninitialized_create=*/false, this));\n-\n-  PjRtStreamExecutorBuffer::ScopedHold device_buffer(\n-      py_buffer->GetBufferWithUsageHold());\n-  CHECK(device_buffer.ok());\n-\n-  BufferSequencingEventRef event = device_buffer->definition_events()[0];\n \n   // The host to device transfer is performed on a thread pool, mostly because\n-  // it includes linearization that may be slow. It is OK to capture the\n-  // py_buffer pointer because the py_buffer can't be deleted until all the\n-  // usage holds have gone away.\n+  // it includes linearization that may be slow.\n   // TODO(misard) assess if it would be preferable to introduce a heuristic to\n   // put the transfer into the calling thread for small literals.\n   auto transfer_h2d =\n       [this, local_client = client(), transfer_manager, local_device,\n-       device_memory = device_buffer->device_memory(), device, event, literal,\n-       py_buffer{py_buffer.get()},\n-       on_device_shape{py_buffer->on_device_shape()}]() mutable {\n+       raw_buffer, device, event, literal,\n+       on_device_shape = std::move(on_device_shape)]() mutable {\n         // This function uses TF_CHECK_OK and value() since we have no way\n         // to report failures from a callback. However, the operations here are\n         // unlikely to fail and not recoverable even if we were to fail: DMAs to\n         // memory that has already been allocated, and a possible Event\n         // allocation.\n+        auto device_memory =\n+            tensorflow::down_cast<PjRtStreamExecutorRawBuffer*>(\n+                raw_buffer.get())\n+                ->device_buffer();\n \n         se::Stream* h2d_stream = local_device->host_to_device_stream();\n \n@@ -1197,9 +1180,7 @@ PjRtStreamExecutorClient::BufferFromHostLiteral(const LiteralSlice& literal,\n         QCHECK(h2d_stream->ok());\n       };\n   thread_pool()->Schedule(WrapClosureAsCopyable(std::move(transfer_h2d)));\n-  RecordUsage(std::move(device_buffer), local_device, local_device, event,\n-              local_device->host_to_device_stream());\n-  return std::unique_ptr<PjRtBuffer>(std::move(py_buffer));\n+  return tsl::MakeRef<PjRtStreamExecutorDeviceEvent>(event);\n }\n \n absl::StatusOr<std::unique_ptr<PjRtBuffer>>"
        },
        {
            "sha": "2f5ce6de19bf2aeed775c0414a9b6e242cb9e1e3",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.h",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -321,11 +321,6 @@ class PjRtStreamExecutorClient : public CommonPjRtClient {\n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> CreateErrorBuffer(\n       absl::Status error, const Shape& shape, PjRtMemorySpace* memory) override;\n \n-  using PjRtClient::BufferFromHostLiteral;\n-  absl::StatusOr<std::unique_ptr<PjRtBuffer>> BufferFromHostLiteral(\n-      const LiteralSlice& literal, PjRtMemorySpace* memory_space,\n-      const Layout* device_layout) override;\n-\n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> CreateViewOfDeviceBuffer(\n       void* device_ptr, const Shape& shape, PjRtMemorySpace* memory_space,\n       std::function<void()> on_delete_callback,\n@@ -404,6 +399,11 @@ class PjRtStreamExecutorClient : public CommonPjRtClient {\n           definition_device_events,\n       bool raw_buffer_is_mutable) override;\n \n+  absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>> LinearizeInto(\n+      const LiteralSlice& literal, const xla::Shape& device_shape,\n+      HostBufferSemantics host_buffer_semantics,\n+      tsl::RCReference<CommonPjRtRawBuffer> raw_buffer) override;\n+\n   absl::StatusOr<tsl::RCReference<PjRtDeviceEvent>> LinearizeHostBufferInto(\n       const void* data, PrimitiveType type, absl::Span<int64_t const> dims,\n       std::optional<absl::Span<int64_t const>> byte_strides,"
        },
        {
            "sha": "e0b2173fb27b75509c5e03c5f5b7bc0553d6c6d0",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bad56c6ba34c0f10bfc53775de3ab18b2284e3a/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client_test.cc?ref=6bad56c6ba34c0f10bfc53775de3ab18b2284e3a",
            "patch": "@@ -150,7 +150,8 @@ TEST(PjRtStreamExecutorClientTest, DonateWithControlDependency) {\n   auto literal = LiteralUtil::CreateR2({{1, 2, 3}, {4, 5, 6}});\n   TF_ASSERT_OK_AND_ASSIGN(\n       std::unique_ptr<PjRtBuffer> buffer,\n-      client->BufferFromHostLiteral(literal, client->memory_spaces()[0]));\n+      client->BufferFromHostLiteral(literal, client->memory_spaces()[0],\n+                                    /*device_layout=*/nullptr));\n \n   auto [promise, future] = Future<>::MakePromise();\n   auto blocked_buffer ="
        }
    ],
    "stats": {
        "total": 94,
        "additions": 38,
        "deletions": 56
    }
}