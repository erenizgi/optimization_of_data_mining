{
    "author": "tensorflower-gardener",
    "message": "Need this cost analysis fix for tuple tensor results, which is very basic for many perf analysis.\n\nPiperOrigin-RevId: 840195683",
    "sha": "b498e2a05321496466688d1c6ec967aafb1d94d6",
    "files": [
        {
            "sha": "cbc4f60dc7ae1a4ad8ae15eb1ab12a16f4674362",
            "filename": "third_party/xla/xla/service/hlo_cost_analysis.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b498e2a05321496466688d1c6ec967aafb1d94d6/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cost_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b498e2a05321496466688d1c6ec967aafb1d94d6/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cost_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cost_analysis.cc?ref=b498e2a05321496466688d1c6ec967aafb1d94d6",
            "patch": "@@ -62,8 +62,12 @@ absl::Status HloCostAnalysis::Preprocess(const HloInstruction* hlo) {\n   // The default number of bytes accessed for an instruction is the sum of the\n   // sizes of the inputs and outputs. The default ShapeUtil::ByteSizeOf does not\n   // handle opaque types.\n-  float bytes_accessed = GetShapeSize(hlo->shape());\n-  current_properties_.set_output_bytes_accessed(GetShapeSize(hlo->shape()));\n+  float bytes_accessed = 0;\n+  ShapeUtil::ForEachLeafShape(\n+      hlo->shape(), [&](const Shape& sub_shape, const ShapeIndex& index) {\n+        bytes_accessed += GetShapeSize(sub_shape);\n+      });\n+  current_properties_.set_output_bytes_accessed(bytes_accessed);\n   for (int64_t i = 0; i < hlo->operand_count(); ++i) {\n     const HloInstruction* operand = hlo->operand(i);\n     bytes_accessed += GetShapeSize(operand->shape());"
        },
        {
            "sha": "1b288ddc0a40bca55128e4f16c2d8d351ca4a8e6",
            "filename": "third_party/xla/xla/service/hlo_cost_analysis_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b498e2a05321496466688d1c6ec967aafb1d94d6/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cost_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b498e2a05321496466688d1c6ec967aafb1d94d6/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cost_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cost_analysis_test.cc?ref=b498e2a05321496466688d1c6ec967aafb1d94d6",
            "patch": "@@ -578,19 +578,46 @@ TEST_F(HloCostAnalysisTest, ReduceWindowVariadic) {\n \n   // Run HLO cost analysis.\n   auto hlo_module = BuildHloGraph(&builder);\n+\n+  /* The hlo text are below:\n+  HloModule reduce_window_variadic.21,\n+  entry_computation_layout={(f32[10,20]{1,0}, f32[10,20]{1,0})->(f32[2,4]{1,0},\n+  f32[2,4]{1,0})}\n+\n+  reduce_window_variadic.12 {\n+    x0.13 = f32[] parameter(0)\n+    y0.15 = f32[] parameter(2)\n+    minimum.17 = f32[] minimum(x0.13, y0.15)\n+    x1.14 = f32[] parameter(1)\n+    y1.16 = f32[] parameter(3)\n+    minimum.18 = f32[] minimum(x1.14, y1.16)\n+    ROOT tuple.19 = (f32[], f32[]) tuple(minimum.17, minimum.18)\n+  }\n+\n+  ENTRY reduce_window_variadic.21 {\n+    input1.9 = f32[10,20]{1,0} parameter(0)\n+    input2.10 = f32[10,20]{1,0} parameter(1)\n+    constant.11 = f32[] constant(0)\n+    ROOT reduce-window.20 = (f32[2,4]{1,0}, f32[2,4]{1,0})\n+  reduce-window(input1.9, input2.10, constant.11, constant.11), window={size=4x5\n+  stride=4x5}, to_apply=reduce_window_variadic.12\n+  }\n+  */\n+\n   HloCostAnalysis analysis;\n   ASSERT_IS_OK(\n       hlo_module->entry_computation()->root_instruction()->Accept(&analysis));\n \n   // Each of [2x4] output elements are generated from reducing [4x5] elements.\n   EXPECT_EQ(analysis.flop_count(), 2 * 4 * 2 * (4 * 5 - 1));\n \n-  EXPECT_EQ(analysis.bytes_accessed(), sizeof(float) * (10 * 20 * 2 + 2 * 3));\n+  // 2 array input + 2 scalar input + + 2 array output\n+  EXPECT_EQ(analysis.bytes_accessed(),\n+            sizeof(float) * (10 * 20 * 2 + 2 + 2 * 4 * 2));\n \n   HloInstruction* root = hlo_module->entry_computation()->root_instruction();\n   EXPECT_EQ(analysis.operand_bytes_accessed(*root, 1), sizeof(float) * 10 * 20);\n   EXPECT_EQ(analysis.operand_bytes_accessed(*root, 0), sizeof(float) * 10 * 20);\n-  EXPECT_EQ(analysis.output_bytes_accessed(*root), sizeof(float) * 4);\n }\n \n TEST_F(HloCostAnalysisTest, SelectAndScatter) {"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 35,
        "deletions": 4
    }
}