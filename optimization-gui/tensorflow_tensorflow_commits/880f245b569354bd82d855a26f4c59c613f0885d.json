{
    "author": "tensorflower-gardener",
    "message": "Allow TSL CellReader to work with lazy metrics.\n\nPiperOrigin-RevId: 822757884",
    "sha": "880f245b569354bd82d855a26f4c59c613f0885d",
    "files": [
        {
            "sha": "50bc965e7b2882f9438faa2f8bb068c5832c4b43",
            "filename": "tensorflow/core/lib/monitoring/cell_reader_test.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/880f245b569354bd82d855a26f4c59c613f0885d/tensorflow%2Fcore%2Flib%2Fmonitoring%2Fcell_reader_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/880f245b569354bd82d855a26f4c59c613f0885d/tensorflow%2Fcore%2Flib%2Fmonitoring%2Fcell_reader_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Flib%2Fmonitoring%2Fcell_reader_test.cc?ref=880f245b569354bd82d855a26f4c59c613f0885d",
            "patch": "@@ -85,6 +85,12 @@ auto* test_percentiles_with_labels = monitoring::PercentileSampler<2>::New(\n     GetDefaultPercentiles(), /*max_samples=*/1024,\n     monitoring::UnitOfMeasure::kTime);\n \n+void IncrementLazyCounter() {\n+  static auto* test_counter = monitoring::Counter<0>::New(\n+      \"/tensorflow/monitoring/test/lazy_counter\", \"Test lazy counter.\");\n+  test_counter->GetCell()->IncrementBy(1);\n+}\n+\n TEST(CellReaderTest, CounterDeltaNoLabels) {\n   CellReader<int64_t> cell_reader(\"/tensorflow/monitoring/test/counter\");\n   EXPECT_EQ(cell_reader.Delta(), 0);\n@@ -1249,7 +1255,7 @@ TEST(CellReaderTest, WrongNumberOfLabels) {\n                \"has 2 labels\");\n }\n \n-TEST(CellReaderTest, MetricIsNotFound) {\n+TEST(CellReaderTest, MetricIsNotFoundRead) {\n   CellReader<int64_t> cell_reader(\"/metric/does/not/exist\");\n   CellReader<int64_t> empty_cell_reader(\"\");\n   EXPECT_DEATH(cell_reader.Read(), \"Metric descriptor is not found\");\n@@ -1294,6 +1300,24 @@ TEST(CellReaderTest, InvalidType) {\n }\n #endif\n \n+TEST(CellReaderTest, MetricIsNotFoundDelta) {\n+  CellReader<int64_t> cell_reader(\"/metric/does/not/exist\");\n+  CellReader<int64_t> empty_cell_reader(\"\");\n+  EXPECT_EQ(cell_reader.Delta(), 0);\n+  EXPECT_EQ(empty_cell_reader.Delta(), 0);\n+}\n+\n+TEST(CellReaderTest, LazyInitializationDelta) {\n+  CellReader<int64_t> cell_reader(\"/tensorflow/monitoring/test/lazy_counter\");\n+  EXPECT_EQ(cell_reader.Delta(), 0);\n+}\n+\n+TEST(CellReaderTest, LazyInitializationDeltaAfterIncrement) {\n+  CellReader<int64_t> cell_reader(\"/tensorflow/monitoring/test/lazy_counter\");\n+  IncrementLazyCounter();\n+  EXPECT_EQ(cell_reader.Delta(), 1);\n+}\n+\n }  // namespace\n }  // namespace testing\n }  // namespace monitoring"
        },
        {
            "sha": "f0e1efdfcb00ca909883ea9640e728e36ec142f0",
            "filename": "third_party/xla/xla/tsl/lib/monitoring/cell_reader-inl.h",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/880f245b569354bd82d855a26f4c59c613f0885d/third_party%2Fxla%2Fxla%2Ftsl%2Flib%2Fmonitoring%2Fcell_reader-inl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/880f245b569354bd82d855a26f4c59c613f0885d/third_party%2Fxla%2Fxla%2Ftsl%2Flib%2Fmonitoring%2Fcell_reader-inl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Flib%2Fmonitoring%2Fcell_reader-inl.h?ref=880f245b569354bd82d855a26f4c59c613f0885d",
            "patch": "@@ -89,18 +89,23 @@ Percentiles GetValue(const Point& point);\n \n // Returns the latest value for `metric_name`, associated with the `labels`. If\n // the metric has not collected any data, it returns a default value appropriate\n-// for `ValueType`. If the metric does not exist, or the wrong number of labels\n-// is provided, it will crash.\n+// for `ValueType`. If a wrong number of labels is provided, it will crash. If\n+// the metric does not exist, it will crash if `return_default_on_not_found` is\n+// false, otherwise it will return a default value.\n template <typename ValueType>\n ValueType GetLatestValueOrDefault(const CollectedMetrics& metrics,\n                                   const std::string& metric_name,\n                                   const std::vector<std::string>& labels,\n-                                  const ValueType default_value = ValueType()) {\n+                                  bool return_default_on_not_found = false,\n+                                  ValueType default_value = ValueType()) {\n   absl::StatusOr<Point> latest_point =\n       GetLatestPoint(metrics, metric_name, labels);\n   if (absl::IsUnavailable(latest_point.status())) {\n     return std::move(default_value);\n   }\n+  if (return_default_on_not_found && absl::IsNotFound(latest_point.status())) {\n+    return std::move(default_value);\n+  }\n   if (!latest_point.ok()) {\n     LOG(FATAL) << \"Failed to read from tfstreamz: \" << latest_point.status();\n   }"
        },
        {
            "sha": "017cb0f868d54ce8fcac98fee591402a07a2c5a6",
            "filename": "third_party/xla/xla/tsl/lib/monitoring/cell_reader.h",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/880f245b569354bd82d855a26f4c59c613f0885d/third_party%2Fxla%2Fxla%2Ftsl%2Flib%2Fmonitoring%2Fcell_reader.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/880f245b569354bd82d855a26f4c59c613f0885d/third_party%2Fxla%2Fxla%2Ftsl%2Flib%2Fmonitoring%2Fcell_reader.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Flib%2Fmonitoring%2Fcell_reader.h?ref=880f245b569354bd82d855a26f4c59c613f0885d",
            "patch": "@@ -17,7 +17,6 @@ limitations under the License.\n \n #include <memory>\n #include <string>\n-#include <utility>\n #include <vector>\n \n #include \"absl/container/flat_hash_map.h\"\n@@ -81,9 +80,8 @@ class CellReader {\n  public:\n   // Constructs a `CellReader` that reads values exported for `metric_name`.\n   //\n-  // REQUIRES: a tfstreamz with `metric_name` exists. Otherwise, the\n-  // `CellReader` will construct without issue, but the `Read` and `Delta` calls\n-  // will CHECK-fail.\n+  // NOTE: if a tfstreamz with `metric_name` does not exists, the `CellReader`\n+  // will construct without issue, but the `Read` calls will CHECK-fail.\n   explicit CellReader(const std::string& metric_name);\n   virtual ~CellReader() = default;\n   CellReader(const CellReader&) = delete;\n@@ -100,13 +98,13 @@ class CellReader {\n \n   // Returns the difference in the value of this cell since the last time\n   // `Delta()` was called for this cell, or when the `CellReader` was created,\n-  // whichever was most recent. If the metric has not been modified, it returns\n-  // a default value appropriate for `ValueType`. `Delta` is not supported for\n-  // string and bool gauges.\n+  // whichever was most recent. If tfstreamz does not exist or the metric has\n+  // not been modified, it returns a default value appropriate for `ValueType`.\n+  // `Delta` is not supported for string and bool gauges.\n   //\n-  // REQUIRES: The tfstreamz exists, `labels` contains a correct number of\n-  // labels per tfstreamz definition, and the ValueType is not string or bool.\n-  // Otherwise, it will CHECK-fail.\n+  // REQUIRES: `labels` contains a correct number of labels per tfstreamz\n+  // definition, and the ValueType is not string or bool. Otherwise, it will\n+  // CHECK-fail.\n   template <typename... LabelType>\n   ValueType Delta(const LabelType&... labels);\n \n@@ -149,12 +147,14 @@ ValueType CellReader<ValueType>::Delta(const LabelType&... labels) {\n   std::vector<std::string> labels_list{labels...};\n   std::unique_ptr<CollectedMetrics> metrics = internal::CollectMetrics();\n   ValueType value = internal::GetLatestValueOrDefault<ValueType>(\n-      *metrics, metric_name_, labels_list);\n+      *metrics, metric_name_, labels_list,\n+      /*return_default_on_not_found=*/true);\n   auto it = delta_map_.find(labels_list);\n   ValueType initial_value;\n   if (it == delta_map_.end()) {\n     initial_value = internal::GetLatestValueOrDefault<ValueType>(\n-        *initial_metrics_, metric_name_, labels_list);\n+        *initial_metrics_, metric_name_, labels_list,\n+        /*return_default_on_not_found=*/true);\n     delta_map_[labels_list] = value;\n   } else {\n     initial_value = it->second;"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 45,
        "deletions": 16
    }
}