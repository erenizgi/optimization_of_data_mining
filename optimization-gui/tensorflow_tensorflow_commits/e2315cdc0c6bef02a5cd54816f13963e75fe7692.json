{
    "author": "tensorflower-gardener",
    "message": "Add a metric on enqueue request size\n\nPiperOrigin-RevId: 820227532",
    "sha": "e2315cdc0c6bef02a5cd54816f13963e75fe7692",
    "files": [
        {
            "sha": "57f0a0699efb17bb0d414b4b2453d4ff4cd37561",
            "filename": "tensorflow/core/distributed_runtime/eager/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2315cdc0c6bef02a5cd54816f13963e75fe7692/tensorflow%2Fcore%2Fdistributed_runtime%2Feager%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2315cdc0c6bef02a5cd54816f13963e75fe7692/tensorflow%2Fcore%2Fdistributed_runtime%2Feager%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fdistributed_runtime%2Feager%2FBUILD?ref=e2315cdc0c6bef02a5cd54816f13963e75fe7692",
            "patch": "@@ -37,6 +37,7 @@ cc_library(\n         \"//tensorflow/core:core_cpu_internal\",\n         \"//tensorflow/core:framework\",\n         \"//tensorflow/core:framework_internal\",\n+        \"//tensorflow/core:lib\",\n         \"//tensorflow/core:protos_all_cc\",\n         \"//tensorflow/core/common_runtime/eager:context\",\n         \"//tensorflow/core/common_runtime/eager:eager_operation\","
        },
        {
            "sha": "5688c30275eb2ee12f3d00c923019cd5f6ca653b",
            "filename": "tensorflow/core/distributed_runtime/eager/cluster_function_library_runtime.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2315cdc0c6bef02a5cd54816f13963e75fe7692/tensorflow%2Fcore%2Fdistributed_runtime%2Feager%2Fcluster_function_library_runtime.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2315cdc0c6bef02a5cd54816f13963e75fe7692/tensorflow%2Fcore%2Fdistributed_runtime%2Feager%2Fcluster_function_library_runtime.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fdistributed_runtime%2Feager%2Fcluster_function_library_runtime.cc?ref=e2315cdc0c6bef02a5cd54816f13963e75fe7692",
            "patch": "@@ -28,10 +28,19 @@ limitations under the License.\n #include \"tensorflow/core/framework/cancellation.h\"\n #include \"tensorflow/core/framework/function.h\"\n #include \"tensorflow/core/framework/graph_def_util.h\"\n+#include \"tensorflow/core/lib/monitoring/sampler.h\"\n \n namespace tensorflow {\n namespace eager {\n namespace {\n+\n+auto* enqueue_request_size_metric = ::tensorflow::monitoring::Sampler<1>::New(\n+    {\"/tensorflow/distributed_runtime/eager/enqueue_request_size\",\n+     \"The size of EnqueueRequest protos sent by \"\n+     \"EagerClusterFunctionLibraryRuntime in bytes.\",\n+     \"phase\"},\n+    ::tensorflow::monitoring::Buckets::Exponential(1, 1.12, 250));\n+\n void StripDefaultAttributesInRegisterFunctionOp(\n     RegisterFunctionOp* register_function) {\n   StripDefaultAttributes(\n@@ -112,6 +121,8 @@ void EagerClusterFunctionLibraryRuntime::Instantiate(\n   }\n \n   const absl::optional<std::vector<int>>& ret_indices = options.ret_indices;\n+  enqueue_request_size_metric->GetCell(\"instantiate\")\n+      ->Add(request->ByteSizeLong());\n   eager_client->EnqueueAsync(\n       /*call_opts=*/nullptr, request.get(), response.get(),\n       [this, request, response, handle, released_op = released_op.release(),\n@@ -294,6 +305,7 @@ void EagerClusterFunctionLibraryRuntime::CleanUp(\n   // StreamingEnqueueAsync could be blocking when streaming RPC is disabled.\n   // CleanUp() needs to be non-blocking since it would be invoked inside the\n   // enqueue done callback of Run(). So we don't use StreamingEnqueueAsync here.\n+  enqueue_request_size_metric->GetCell(\"cleanup\")->Add(request->ByteSizeLong());\n   eager_client->EnqueueAsync(\n       /*call_opts=*/nullptr, request.get(), response.get(),\n       [request, response, done](const absl::Status& status) { done(status); });"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 13,
        "deletions": 0
    }
}