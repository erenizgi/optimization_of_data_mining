{
    "author": "beckerhe",
    "message": "Fix dependencies in TSL\n\nThis fixes OSS dependencies in TSL such that they comply with Bazel's layering_check.\n\nPiperOrigin-RevId: 837796957",
    "sha": "5af893b16390d6f2860b0a9df66fbdac8092c32e",
    "files": [
        {
            "sha": "74832c4a417e4a7941a5ce86cc1410c440fd6c7f",
            "filename": "third_party/xla/xla/tsl/cuda/BUILD.bazel",
            "status": "modified",
            "additions": 25,
            "deletions": 12,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fcuda%2FBUILD.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fcuda%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fcuda%2FBUILD.bazel?ref=5af893b16390d6f2860b0a9df66fbdac8092c32e",
            "patch": "@@ -43,10 +43,11 @@ cc_library(\n     textual_hdrs = [\"cublas.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -74,9 +75,10 @@ cc_library(\n     textual_hdrs = [\"cublasLt.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -104,9 +106,10 @@ cc_library(\n     textual_hdrs = [\"cuda.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -138,12 +141,13 @@ cc_library(\n     visibility = [\"//visibility:public\"],\n     deps = select({\n         \"@local_xla//xla/tsl:is_cuda_enabled_and_oss\": [\n+            # keep sorted\n             \":cuda\",\n+            \"//xla/tsl/platform:logging\",\n             \"@com_google_absl//absl/container:flat_hash_set\",\n             \"@local_config_cuda//cuda:cuda_headers\",\n             \"@local_tsl//tsl/platform:dso_loader\",\n             \"@local_tsl//tsl/platform:load_library\",\n-            \"@local_tsl//tsl/platform:logging\",\n         ],\n         \"//conditions:default\": [],\n     }),\n@@ -173,10 +177,11 @@ cc_library(\n     textual_hdrs = [\"cudnn.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@local_config_cuda//cuda:cudnn_header\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -227,9 +232,10 @@ cc_library(\n     textual_hdrs = [\"cufft.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -263,10 +269,11 @@ cc_library(\n     textual_hdrs = [\"cupti.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_config_cuda//cuda:cupti_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -299,9 +306,10 @@ cc_library(\n     textual_hdrs = [\"cusolver.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -334,10 +342,11 @@ cc_library(\n     textual_hdrs = [\"cusparse.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -366,11 +375,12 @@ cc_library(\n     textual_hdrs = [\"nccl.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_config_nccl//:nccl_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -400,8 +410,9 @@ cc_library(\n     textual_hdrs = [\"nvshmem.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )\n@@ -429,8 +440,10 @@ cc_library(\n     textual_hdrs = [\"nvml.inc\"],\n     visibility = [\"//visibility:public\"],\n     deps = if_cuda_is_configured([\n+        # keep sorted\n+        \"//xla/tsl/platform:logging\",\n+        \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:dso_loader\",\n-        \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:load_library\",\n     ]),\n )"
        },
        {
            "sha": "a0fa4dcc92c9020a906885317b8f116c66e1a4c7",
            "filename": "third_party/xla/xla/tsl/cuda/nvshmem_stub.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fcuda%2Fnvshmem_stub.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fcuda%2Fnvshmem_stub.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fcuda%2Fnvshmem_stub.cc?ref=5af893b16390d6f2860b0a9df66fbdac8092c32e",
            "patch": "@@ -13,9 +13,9 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include \"xla/tsl/platform/logging.h\"\n #include \"tsl/platform/dso_loader.h\"\n #include \"tsl/platform/load_library.h\"\n-#include \"tsl/platform/logging.h\"\n \n // Implements the nvshmem API by forwarding to nvshmem loaded from a DSO.\n "
        },
        {
            "sha": "c18fc04b00b287ccc9827d7c4888550f8d9fa4eb",
            "filename": "third_party/xla/xla/tsl/framework/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fframework%2FBUILD?ref=5af893b16390d6f2860b0a9df66fbdac8092c32e",
            "patch": "@@ -396,7 +396,6 @@ cc_library(\n     name = \"serving_device_selector_policies\",\n     srcs = [\"serving_device_selector_policies.cc\"],\n     hdrs = [\"serving_device_selector_policies.h\"],\n-    features = [\"-layering_check\"],\n     deps = [\n         \":serving_device_selector\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "0f3e5834c2bcb53db606d50fff33372a2e2856d7",
            "filename": "third_party/xla/xla/tsl/platform/default/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD?ref=5af893b16390d6f2860b0a9df66fbdac8092c32e",
            "patch": "@@ -118,10 +118,13 @@ cc_library(\n         \"@local_tsl//tsl/platform:load_library\",\n         \"@local_tsl//tsl/platform:path\",\n     ] + if_oss([\n-        \"@nvshmem//:nvshmem_config\",\n+        # keep sorted\n         \"@local_config_nccl//:nccl_config\",\n         \"@local_config_tensorrt//:tensorrt_headers\",\n+        \"@local_tsl//tsl/platform\",\n+        \"@nvshmem//:nvshmem_config\",\n     ]) + if_rocm_is_configured([\n+        # keep sorted\n         \"@local_config_rocm//rocm:rocm_headers\",\n     ]),\n )"
        },
        {
            "sha": "5f16a68f7f70a66dc1f9c138f783a57bd5383180",
            "filename": "third_party/xla/xla/tsl/tsl.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Ftsl.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5af893b16390d6f2860b0a9df66fbdac8092c32e/third_party%2Fxla%2Fxla%2Ftsl%2Ftsl.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Ftsl.bzl?ref=5af893b16390d6f2860b0a9df66fbdac8092c32e",
            "patch": "@@ -839,7 +839,7 @@ def tsl_pybind_extension_opensource(\n     )\n \n def nvtx_headers():\n-    return if_oss([\"@nvtx_archive//:headers\"], [\"@local_config_cuda//cuda:cuda_headers\"])\n+    return if_oss([\"@nvtx_archive//:headers\"]) + [\"@local_config_cuda//cuda:cuda_headers\"]\n \n def tsl_google_bzl_deps():\n     return []"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 31,
        "deletions": 16
    }
}