{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Add utility functions to detect unused variables in SymbolicMap.\n\nAdds `GetUnusedDimensionsBitVector` and `GetUnusedSymbolsBitVector` to analyze the expressions within a `SymbolicMap` and determine which dimension or symbol variables are not used.\n\nThese functions are necessary for optimizing and simplifying `SymbolicMap` instances, similar to the utilities available for `AffineMap`.\n\nPiperOrigin-RevId: 801781213",
    "sha": "f813e62717d88f6866b3747fa41672d66428b159",
    "files": [
        {
            "sha": "021ce25d1a67dbe808fc40e6028d6e0d7c9f0895",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=f813e62717d88f6866b3747fa41672d66428b159",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"absl/strings/strip.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/DenseMap.h\"\n+#include \"llvm/ADT/DenseSet.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"llvm/Support/MathExtras.h\"\n #include \"mlir/Support/StorageUniquer.h\"\n@@ -715,6 +716,31 @@ SymbolicExpr SymbolicExpr::Replace(\n   return GetContext()->CreateBinaryOp(type, new_lhs, new_rhs);\n }\n \n+void SymbolicExpr::GetUsedVariables(\n+    llvm::DenseSet<VariableID>& used_vars) const {\n+  if (!*this) {\n+    return;\n+  }\n+\n+  switch (GetType()) {\n+    case SymbolicExprType::kConstant:\n+      return;\n+    case SymbolicExprType::kVariable:\n+      used_vars.insert(GetValue());\n+      return;\n+    case SymbolicExprType::kAdd:\n+    case SymbolicExprType::kMul:\n+    case SymbolicExprType::kFloorDiv:\n+    case SymbolicExprType::kCeilDiv:\n+    case SymbolicExprType::kMod:\n+    case SymbolicExprType::kMin:\n+    case SymbolicExprType::kMax:\n+      GetLHS().GetUsedVariables(used_vars);\n+      GetRHS().GetUsedVariables(used_vars);\n+      return;\n+  }\n+}\n+\n SymbolicExpr SymbolicExpr::Canonicalize() const {\n   if (!*this) {\n     return *this;"
        },
        {
            "sha": "db137b196e83c5d051409fafaa6476c1179fa147",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h?ref=f813e62717d88f6866b3747fa41672d66428b159",
            "patch": "@@ -23,6 +23,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/DenseMap.h\"\n #include \"llvm/ADT/DenseMapInfo.h\"\n+#include \"llvm/ADT/DenseSet.h\"\n #include \"llvm/ADT/Hashing.h\"\n #include \"mlir/Support/LLVM.h\"\n #include \"mlir/Support/StorageUniquer.h\"\n@@ -81,6 +82,8 @@ class SymbolicExpr {\n   SymbolicExpr Replace(\n       const llvm::DenseMap<SymbolicExpr, SymbolicExpr>& replacements) const;\n \n+  void GetUsedVariables(llvm::DenseSet<VariableID>& used_vars) const;\n+\n   SymbolicExpr operator+(int64_t v) const;\n   SymbolicExpr operator+(SymbolicExpr other) const;\n   SymbolicExpr operator-() const;"
        },
        {
            "sha": "45773db729eacee7a8f740d81bf155b198b5366c",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=f813e62717d88f6866b3747fa41672d66428b159",
            "patch": "@@ -25,6 +25,8 @@ limitations under the License.\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_join.h\"\n #include \"absl/types/span.h\"\n+#include \"llvm/ADT/DenseSet.h\"\n+#include \"llvm/ADT/SmallBitVector.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n@@ -44,6 +46,15 @@ llvm::SmallVector<SymbolicExpr> CreateVariableRange(SymbolicExprContext* ctx,\n   return replacements;\n }\n \n+llvm::DenseSet<VariableID> GetUsedVariablesFromExpressions(\n+    const SymbolicMap& map) {\n+  llvm::DenseSet<VariableID> used_vars;\n+  for (const auto& expr : map.GetResults()) {\n+    expr.GetUsedVariables(used_vars);\n+  }\n+  return used_vars;\n+}\n+\n }  // namespace\n \n SymbolicMap::SymbolicMap(SymbolicExprContext* ctx, int64_t num_dimensions,\n@@ -175,5 +186,36 @@ bool SymbolicMap::operator==(const SymbolicMap& other) const {\n          num_symbols_ == other.num_symbols_ && exprs_ == other.exprs_;\n }\n \n+llvm::SmallBitVector GetUnusedDimensionsBitVector(const SymbolicMap& map) {\n+  llvm::SmallBitVector unused_dims(map.GetNumDims(), true);\n+  if (map.IsEmpty() || map.GetNumDims() == 0) {\n+    return unused_dims;\n+  }\n+\n+  llvm::DenseSet<VariableID> used_vars = GetUsedVariablesFromExpressions(map);\n+  for (int i = 0; i < map.GetNumDims(); ++i) {\n+    if (used_vars.contains(i)) {\n+      unused_dims[i] = false;\n+    }\n+  }\n+  return unused_dims;\n+}\n+\n+llvm::SmallBitVector GetUnusedSymbolsBitVector(const SymbolicMap& map) {\n+  llvm::SmallBitVector unused_symbols(map.GetNumSymbols(), true);\n+  if (map.IsEmpty() || map.GetNumSymbols() == 0) {\n+    return unused_symbols;\n+  }\n+\n+  llvm::DenseSet<VariableID> used_vars = GetUsedVariablesFromExpressions(map);\n+  int64_t num_dims = map.GetNumDims();\n+  for (int i = 0; i < map.GetNumSymbols(); ++i) {\n+    if (used_vars.contains(num_dims + i)) {\n+      unused_symbols[i] = false;\n+    }\n+  }\n+  return unused_symbols;\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "8cf8fb52bea2f1edc0fa4790df6e24c1c78885c2",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=f813e62717d88f6866b3747fa41672d66428b159",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <string>\n \n #include \"absl/types/span.h\"\n+#include \"llvm/ADT/SmallBitVector.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n@@ -101,6 +102,14 @@ class SymbolicMap {\n   llvm::SmallVector<SymbolicExpr> exprs_;\n };\n \n+// Returns a bitvector marking dimensions that are not used in any expression in\n+// the map.\n+llvm::SmallBitVector GetUnusedDimensionsBitVector(const SymbolicMap& map);\n+\n+// Returns a bitvector marking symbols that are not used in any expression in\n+// the map.\n+llvm::SmallBitVector GetUnusedSymbolsBitVector(const SymbolicMap& map);\n+\n }  // namespace gpu\n }  // namespace xla\n "
        },
        {
            "sha": "62236fef9ad384813fa1f46463c1a33f3d7f0db0",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 56,
            "deletions": 2,
            "changes": 58,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f813e62717d88f6866b3747fa41672d66428b159/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=f813e62717d88f6866b3747fa41672d66428b159",
            "patch": "@@ -15,10 +15,9 @@ limitations under the License.\n \n #include \"xla/service/gpu/model/experimental/symbolic_map.h\"\n \n-#include <vector>\n-\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"llvm/ADT/SmallBitVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n namespace xla {\n@@ -198,6 +197,61 @@ TEST(SymbolicMapTest, Replace) {\n   EXPECT_EQ(no_replacement_map, map);\n }\n \n+TEST(SymbolicMapTest, GetUnusedVariables) {\n+  SymbolicExprContext ctx;\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+  // d2 is unused.\n+  SymbolicExpr s0 = ctx.CreateVariable(3);\n+  SymbolicExpr s1 = ctx.CreateVariable(4);\n+  SymbolicExpr c2 = ctx.CreateConstant(2);\n+\n+  // Map with used and unused dims and symbols.\n+  SymbolicMap map = SymbolicMap::Get(&ctx, 3, 2, {d0 + s1, d1 * c2});\n+\n+  llvm::SmallBitVector unused_dims = GetUnusedDimensionsBitVector(map);\n+  EXPECT_EQ(unused_dims.size(), 3);\n+  EXPECT_FALSE(unused_dims[0]);  // d0 is used\n+  EXPECT_FALSE(unused_dims[1]);  // d1 is used\n+  EXPECT_TRUE(unused_dims[2]);   // d2 is unused\n+\n+  llvm::SmallBitVector unused_symbols = GetUnusedSymbolsBitVector(map);\n+  EXPECT_EQ(unused_symbols.size(), 2);\n+  EXPECT_TRUE(unused_symbols[0]);   // s0 is unused\n+  EXPECT_FALSE(unused_symbols[1]);  // s1 is used\n+\n+  // Empty map\n+  SymbolicMap empty_map = SymbolicMap::Get(&ctx, 2, 1, {});\n+  llvm::SmallBitVector empty_dims = GetUnusedDimensionsBitVector(empty_map);\n+  EXPECT_EQ(empty_dims.size(), 2);\n+  EXPECT_TRUE(empty_dims.all());\n+  llvm::SmallBitVector empty_symbols = GetUnusedSymbolsBitVector(empty_map);\n+  EXPECT_EQ(empty_symbols.size(), 1);\n+  EXPECT_TRUE(empty_symbols.all());\n+\n+  // Map with only dims\n+  SymbolicMap no_symbols_map = SymbolicMap::Get(&ctx, 2, 0, {d0 - d1});\n+  llvm::SmallBitVector no_sym_dims =\n+      GetUnusedDimensionsBitVector(no_symbols_map);\n+  EXPECT_EQ(no_sym_dims.size(), 2);\n+  EXPECT_FALSE(no_sym_dims[0]);\n+  EXPECT_FALSE(no_sym_dims[1]);\n+  llvm::SmallBitVector no_sym_symbols =\n+      GetUnusedSymbolsBitVector(no_symbols_map);\n+  EXPECT_EQ(no_sym_symbols.size(), 0);\n+\n+  // Map with only symbols\n+  s0 = ctx.CreateVariable(0);\n+  s1 = ctx.CreateVariable(1);\n+  SymbolicMap no_dims_map = SymbolicMap::Get(&ctx, 0, 2, {s0 * s1});\n+  llvm::SmallBitVector no_dim_dims = GetUnusedDimensionsBitVector(no_dims_map);\n+  EXPECT_EQ(no_dim_dims.size(), 0);\n+  llvm::SmallBitVector no_dim_symbols = GetUnusedSymbolsBitVector(no_dims_map);\n+  EXPECT_EQ(no_dim_symbols.size(), 2);\n+  EXPECT_FALSE(no_dim_symbols[0]);\n+  EXPECT_FALSE(no_dim_symbols[1]);\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 136,
        "deletions": 2
    }
}