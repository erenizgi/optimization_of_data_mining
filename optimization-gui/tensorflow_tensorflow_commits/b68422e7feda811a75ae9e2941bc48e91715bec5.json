{
    "author": "tensorflower-gardener",
    "message": "Remove num_dims in SymbolicExpr::ReplaceDimsAndSymbols\n\nI needed this to be consistent to AffineMap::replaceDimsAndSymbols that allows Dimensions to be empty. This is easier to be handled there because Dimensions and Symbols are treated differently. In SymbolicMap we treat both of them as kVariable.\n\nSadly this made me introduce a bug during SymbolicMap refactoring (cl/802100018), because I was using new_dims instead of current_dims in ConvertRangeVariablesToDimensions and an extra dimension was being created introducing strange precision bugs.\n\nIn addition to fixing the bug I am doing 2 things:\n- Making the method less error prone (this CL)\n- Adding unit tests in IndexingMap to catch this issues (following CL)\n\nSo, here I am just removing num_dims in SymbolicExpr::ReplaceDimsAndSymbols() and only requering this when it's fully needed (SymbolicExpr::ReplaceSymbols()). Please note that we are still allowing SymbolicMap::ReplaceDimsAndSymbols() to have empty lists of dimensions but there we don't need to provide a old_num_dimensions since the class already have it.\n\nPiperOrigin-RevId: 839134748",
    "sha": "b68422e7feda811a75ae9e2941bc48e91715bec5",
    "files": [
        {
            "sha": "9a5015287d0643c01cb3f8f27014e5606167fccf",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_expr.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b68422e7feda811a75ae9e2941bc48e91715bec5/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b68422e7feda811a75ae9e2941bc48e91715bec5/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.cc?ref=b68422e7feda811a75ae9e2941bc48e91715bec5",
            "patch": "@@ -764,19 +764,19 @@ SymbolicExpr SymbolicExpr::ReplaceVariables(\n \n SymbolicExpr SymbolicExpr::ReplaceSymbols(\n     absl::Span<const SymbolicExpr> sym_replacements, int64_t num_dims) const {\n-  return ReplaceDimsAndSymbols({}, sym_replacements, num_dims);\n+  llvm::SmallVector<SymbolicExpr> dim_replacements;\n+  dim_replacements.reserve(num_dims);\n+  for (int64_t i = 0; i < num_dims; ++i) {\n+    dim_replacements.push_back(CreateSymbolicVariable(i, GetContext()));\n+  }\n+  return ReplaceDimsAndSymbols(dim_replacements, sym_replacements);\n }\n \n SymbolicExpr SymbolicExpr::ReplaceDimsAndSymbols(\n     absl::Span<const SymbolicExpr> dim_replacements,\n-    absl::Span<const SymbolicExpr> symbol_replacements,\n-    int64_t num_dims) const {\n+    absl::Span<const SymbolicExpr> symbol_replacements) const {\n   llvm::SmallVector<SymbolicExpr> replacements;\n   replacements.append(dim_replacements.begin(), dim_replacements.end());\n-  mlir::MLIRContext* ctx = GetContext();\n-  for (int64_t i = dim_replacements.size(); i < num_dims; ++i) {\n-    replacements.push_back(CreateSymbolicVariable(i, ctx));\n-  }\n   replacements.append(symbol_replacements.begin(), symbol_replacements.end());\n   return ReplaceVariables(replacements);\n }"
        },
        {
            "sha": "7badfecfd073a57d635b4e0b4b078da39630e164",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_expr.h",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b68422e7feda811a75ae9e2941bc48e91715bec5/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b68422e7feda811a75ae9e2941bc48e91715bec5/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.h?ref=b68422e7feda811a75ae9e2941bc48e91715bec5",
            "patch": "@@ -83,8 +83,7 @@ class SymbolicExpr {\n                               int64_t num_dims) const;\n   SymbolicExpr ReplaceDimsAndSymbols(\n       absl::Span<const SymbolicExpr> dim_replacements,\n-      absl::Span<const SymbolicExpr> symbol_replacements,\n-      int64_t num_dims) const;\n+      absl::Span<const SymbolicExpr> symbol_replacements) const;\n \n   SymbolicExpr Canonicalize() const;\n "
        },
        {
            "sha": "ddf69367c0fc55a072461c6809d58e430237da1b",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b68422e7feda811a75ae9e2941bc48e91715bec5/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b68422e7feda811a75ae9e2941bc48e91715bec5/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr_test.cc?ref=b68422e7feda811a75ae9e2941bc48e91715bec5",
            "patch": "@@ -164,17 +164,8 @@ TEST_F(SymbolicExprTest, ReplaceDimsAndSymbols) {\n   SymbolicExpr s1 = CreateSymbolicVariable(2, &ctx);\n   SymbolicExpr c7 = CreateSymbolicConstant(7, &ctx);\n   SymbolicExpr expr_to_sub = (d0 + s0 * 2) * s1;\n-  SymbolicExpr result =\n-      expr_to_sub.ReplaceDimsAndSymbols({s0}, {d0, c7}, /*num_dims=*/1);\n+  SymbolicExpr result = expr_to_sub.ReplaceDimsAndSymbols({s0}, {d0, c7});\n   EXPECT_EQ(result, ((s0 + (d0 * 2)) * c7));\n-\n-  SymbolicExpr replace_only_dims =\n-      expr_to_sub.ReplaceDimsAndSymbols({s0}, {}, /*num_dims=*/1);\n-  EXPECT_EQ(replace_only_dims, ((s0 + (s0 * 2)) * s1));\n-\n-  SymbolicExpr replace_only_symbols =\n-      expr_to_sub.ReplaceDimsAndSymbols({}, {d0, c7}, /*num_dims=*/1);\n-  EXPECT_EQ(replace_only_symbols, ((d0 + (d0 * 2)) * c7));\n }\n \n TEST_F(SymbolicExprTest, UniquingWorks) {"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 9,
        "deletions": 19
    }
}