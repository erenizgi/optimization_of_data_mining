{
    "author": "tensorflower-gardener",
    "message": "Use MLIRContext's affine uniquer for SymbolicExpr.\n\nThis change modifies `SymbolicExprContext` to use the `mlir::StorageUniquer` provided by `mlir::MLIRContext::getAffineUniquer()` instead of maintaining its own. This produces SymbolicExprContext creation to be very lightweight.\n\nPiperOrigin-RevId: 823052287",
    "sha": "c234838b70dd925b55ad4ced9f7d457110dc2774",
    "files": [
        {
            "sha": "8a61bdbd5bc4bdc53d257bb71756afd8b9c52513",
            "filename": "third_party/xla/xla/codegen/emitter_loc_op_builder_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fcodegen%2Femitter_loc_op_builder_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fcodegen%2Femitter_loc_op_builder_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitter_loc_op_builder_test.cc?ref=c234838b70dd925b55ad4ced9f7d457110dc2774",
            "patch": "@@ -47,8 +47,8 @@ class EmitterLocOpBuilderTest : public HloHardwareIndependentTestBase {\n  protected:\n   void SetUp() override { gpu::LoadMlirDialectsForTriton(mlir_context_); }\n \n-  gpu::SymbolicExprContext symbolic_expr_context_{&mlir_context_};\n   mlir::MLIRContext mlir_context_;\n+  gpu::SymbolicExprContext symbolic_expr_context_{&mlir_context_};\n };\n \n NameLoc NameLoc(mlir::MLIRContext& context, absl::string_view name) {"
        },
        {
            "sha": "7574e6a3be6ff7eb14ef0d89662104cc54b2ddf0",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD?ref=c234838b70dd925b55ad4ced9f7d457110dc2774",
            "patch": "@@ -234,6 +234,7 @@ xla_cc_test(\n         \":symbolic_map\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@llvm-project//llvm:Support\",\n+        \"@llvm-project//mlir:IR\",\n     ],\n )\n \n@@ -244,10 +245,11 @@ cc_library(\n     compatible_with = get_compatible_with_portable(),\n     deps = [\n         \"@com_google_absl//absl/algorithm:container\",\n+        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/strings:str_format\",\n+        \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:IR\",\n@@ -263,6 +265,7 @@ xla_cc_test(\n         \"//xla/hlo/analysis:indexing_test_utils\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@llvm-project//llvm:Support\",\n+        \"@llvm-project//mlir:IR\",\n     ],\n )\n "
        },
        {
            "sha": "6ce0a93b7b51c60f42d42e9ce3835d407896d5f8",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=c234838b70dd925b55ad4ced9f7d457110dc2774",
            "patch": "@@ -29,20 +29,23 @@ limitations under the License.\n #include <utility>\n \n #include \"absl/algorithm/container.h\"\n+#include \"absl/base/const_init.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/strings/ascii.h\"\n #include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/strings/strip.h\"\n+#include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/DenseMap.h\"\n #include \"llvm/ADT/DenseSet.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"llvm/Support/MathExtras.h\"\n #include \"mlir/IR/MLIRContext.h\"\n #include \"mlir/Support/StorageUniquer.h\"\n+#include \"mlir/Support/TypeID.h\"\n \n namespace xla {\n namespace gpu {\n@@ -886,9 +889,20 @@ SymbolicExpr SymbolicExpr::max(SymbolicExpr other) const {\n   return GetContext()->CreateBinaryOp(SymbolicExprType::kMax, *this, other);\n }\n \n+static absl::Mutex& getSymbolicExprStorageMutex() {\n+  static absl::Mutex m(absl::kConstInit);\n+  return m;\n+}\n+\n SymbolicExprContext::SymbolicExprContext(mlir::MLIRContext* mlir_context)\n     : mlir_context_(mlir_context) {\n-  uniquer_.registerParametricStorageType<SymbolicExprStorage>();\n+  CHECK(mlir_context != nullptr);\n+  absl::MutexLock lock(getSymbolicExprStorageMutex());\n+  auto* uniquer = &mlir_context_->getAffineUniquer();\n+  if (!uniquer->isParametricStorageInitialized(\n+          mlir::TypeID::get<SymbolicExprStorage>())) {\n+    uniquer->registerParametricStorageType<SymbolicExprStorage>();\n+  }\n }\n \n SymbolicExpr SymbolicExprContext::GetOrCreate(SymbolicExprType type,\n@@ -897,7 +911,8 @@ SymbolicExpr SymbolicExprContext::GetOrCreate(SymbolicExprType type,\n   auto initContext = [&](SymbolicExprStorage* storage) {\n     storage->ctx_ = this;\n   };\n-  return uniquer_.get<SymbolicExprStorage>(initContext, type, value, lhs, rhs);\n+  return mlir_context_->getAffineUniquer().get<SymbolicExprStorage>(\n+      initContext, type, value, lhs, rhs);\n }\n \n SymbolicExpr SymbolicExprContext::CreateConstant(int64_t value) {"
        },
        {
            "sha": "a1b5dc13055f53faeca392e6dfd6c130604bfcb4",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h?ref=c234838b70dd925b55ad4ced9f7d457110dc2774",
            "patch": "@@ -162,9 +162,9 @@ class SymbolicExprContext {\n  private:\n   SymbolicExpr GetOrCreate(SymbolicExprType type, int64_t value,\n                            SymbolicExpr lhs, SymbolicExpr rhs);\n-  mlir::StorageUniquer uniquer_;\n   // TODO(b/446856305): MLIRContext is only used here temporarily while we have\n-  // AffineMap <-> SymbolicMap convertors.\n+  // AffineMap <-> SymbolicMap convertors. In the future, we only will need a\n+  // StorageUniquer pointer.\n   mlir::MLIRContext* mlir_context_;\n };\n "
        },
        {
            "sha": "5979a96dfef98ea18a38cbcd0bd29988dd593d7c",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc?ref=c234838b70dd925b55ad4ced9f7d457110dc2774",
            "patch": "@@ -23,6 +23,8 @@ limitations under the License.\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"llvm/ADT/DenseMap.h\"\n+#include \"mlir/IR/AffineExpr.h\"\n+#include \"mlir/IR/MLIRContext.h\"\n #include \"xla/hlo/analysis/indexing_test_utils.h\"\n \n namespace xla {\n@@ -34,8 +36,8 @@ using ::testing::Values;\n // Test fixture to hold the context for all tests.\n struct SymbolicExprTest : public ::testing::Test {\n  protected:\n-  // There should not be any usage of MLIRContext in this test.\n-  SymbolicExprContext ctx{nullptr};\n+  mlir::MLIRContext mlir_context;\n+  SymbolicExprContext ctx{&mlir_context};\n   SymbolicExpr v0 = ctx.CreateVariable(0);\n   SymbolicExpr v1 = ctx.CreateVariable(1);\n   SymbolicExpr c2 = ctx.CreateConstant(2);\n@@ -167,6 +169,20 @@ TEST_F(SymbolicExprTest, UniquingWorks) {\n   EXPECT_NE(add1, add3);\n }\n \n+TEST_F(SymbolicExprTest, UniquingDoesNotCrashWithCombinedAffineExpr) {\n+  mlir::AffineExpr affine_expr = mlir::getAffineDimExpr(0, &mlir_context);\n+  SymbolicExpr c1 = ctx.CreateConstant(42);\n+  EXPECT_EQ(affine_expr, mlir::getAffineDimExpr(0, &mlir_context));\n+  EXPECT_EQ(c1, ctx.CreateConstant(42));\n+}\n+\n+TEST_F(SymbolicExprTest, UniquingWorksAcrossDifferentContexts) {\n+  SymbolicExprContext ctx2(&mlir_context);\n+\n+  EXPECT_EQ(ctx.CreateConstant(42), ctx2.CreateConstant(42));\n+  EXPECT_EQ(ctx.CreateVariable(0), ctx2.CreateVariable(0));\n+}\n+\n TEST_F(SymbolicExprTest, Replace) {\n   SymbolicExpr d0 = ctx.CreateVariable(0);\n   SymbolicExpr d1 = ctx.CreateVariable(1);"
        },
        {
            "sha": "8059e9f80cf4e3ab677599000119e76cbde602b1",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c234838b70dd925b55ad4ced9f7d457110dc2774/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=c234838b70dd925b55ad4ced9f7d457110dc2774",
            "patch": "@@ -18,6 +18,7 @@ limitations under the License.\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"llvm/ADT/SmallBitVector.h\"\n+#include \"mlir/IR/MLIRContext.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n namespace xla {\n@@ -27,8 +28,8 @@ namespace {\n using ::testing::ElementsAre;\n \n struct SymbolicMapTest : public ::testing::Test {\n-  // TODO(b/446856305): MLIRContext should not be used in this test.\n-  SymbolicExprContext ctx{nullptr};\n+  mlir::MLIRContext mlir_context;\n+  SymbolicExprContext ctx{&mlir_context};\n };\n \n TEST_F(SymbolicMapTest, GetSymbolAndDimExpressions) {"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 45,
        "deletions": 10
    }
}