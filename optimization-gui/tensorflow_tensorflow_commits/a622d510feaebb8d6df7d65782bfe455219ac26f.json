{
    "author": "Cjkkkk",
    "message": "PR #30664: fix collective permute clone\n\nImported from GitHub PR https://github.com/openxla/xla/pull/30664\n\nüìù Summary of Changes\nCollective permute instruction `CloneWithNewOperands` only clones first operand while Collective permute is variadic op. Fixed this by cloning whole operands list.\n\nüéØ Justification\nRequired whenever collective permute that needs to be cloned has more than 1 operand. It is common to have more than 1 operands with collective permute combiner pass enabled. Observed this bug in maxtext gradient accumulation.\n\nüöÄ Kind of Contribution\nüêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nNo performance improvements expected\n\nüß™ Unit Tests:\nAdd minimum hlo unit test that makes sure the cloned instruction has same number of operands.\n\nüß™ Execution Tests:\nNo execution tests added.\n\nCopybara import of the project:\n\n--\n3361b3dea24a42f356cf63b10445796122162204 by Cjkkkk <ske@nvidia.com>:\n\nfix collective permute clone\n\nMerging this change closes #30664\n\nPiperOrigin-RevId: 800037361",
    "sha": "a622d510feaebb8d6df7d65782bfe455219ac26f",
    "files": [
        {
            "sha": "b3bf81d16839de56a59a56b8ce432342fb9aa8aa",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a622d510feaebb8d6df7d65782bfe455219ac26f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a622d510feaebb8d6df7d65782bfe455219ac26f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction_test.cc?ref=a622d510feaebb8d6df7d65782bfe455219ac26f",
            "patch": "@@ -146,6 +146,24 @@ ENTRY main {\n   TF_EXPECT_OK(module->schedule().Verify());\n }\n \n+TEST_F(HloInstructionTest, CloneImplCollectivePermuteOp) {\n+  constexpr absl::string_view kHlo = R\"(\n+HloModule main\n+\n+ENTRY main {\n+  arg.0 = f32[32,32]{1,0} parameter(0)\n+  ROOT collective-permute.0 = (f32[32,32]{1,0}, f32[32,32]{1,0}) collective-permute(arg.0, arg.0), channel_id=388, source_target_pairs={{0,0},{4,1}}\n+})\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(kHlo));\n+\n+  HloInstruction* cp = module->entry_computation()->root_instruction();\n+  ASSERT_EQ(cp->opcode(), HloOpcode::kCollectivePermute);\n+  auto clone = cp->CloneWithNewOperands(cp->shape(), cp->operands());\n+  EXPECT_EQ(clone->operand_count(), 2);\n+}\n+\n TEST_F(HloInstructionTest, ComparatorWorksWith64BitUniqueIds) {\n   std::unique_ptr<HloInstruction> param1 =\n       HloInstruction::CreateParameter(0, Shape(F32, {4}), \"param1\");"
        },
        {
            "sha": "349570f337590853fde9fa265bc5b84c3994e8d4",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instructions.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a622d510feaebb8d6df7d65782bfe455219ac26f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a622d510feaebb8d6df7d65782bfe455219ac26f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc?ref=a622d510feaebb8d6df7d65782bfe455219ac26f",
            "patch": "@@ -1358,9 +1358,7 @@ HloCollectivePermuteInstruction::CloneWithNewOperandsImpl(\n     HloCloneContext* /*context*/) const {\n   if (dynamic_slice_sizes_list().empty()) {\n     return std::make_unique<HloCollectivePermuteInstruction>(\n-        opcode(), shape,\n-        absl::Span<HloInstruction* const>(new_operands.subspan(0, 1)),\n-        source_target_pairs(), channel_id());\n+        opcode(), shape, new_operands, source_target_pairs(), channel_id());\n   }\n   return std::make_unique<HloCollectivePermuteInstruction>(\n       opcode(), shape, new_operands[0], new_operands[1], new_operands[2],"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 19,
        "deletions": 3
    }
}