{
    "author": "seherellis",
    "message": "[XLA:CopyInsertion] Add a `should_skip_removal` function.\n\nPiperOrigin-RevId: 840421897",
    "sha": "8ff6970971d62429c4444da7a7593667775ae73f",
    "files": [
        {
            "sha": "1b56ce8ca53d905d3f90ebd5fcb5d0b678e251b5",
            "filename": "third_party/xla/xla/service/copy_insertion.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_insertion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_insertion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_insertion.cc?ref=8ff6970971d62429c4444da7a7593667775ae73f",
            "patch": "@@ -1477,7 +1477,8 @@ absl::Status CopyInsertion::RemoveUnnecessaryCopies(\n                            use_region_based_live_range_analysis_);\n         if (copy_remover.TryElideCopy(\n                 instruction, &region_analysis_cost_now,\n-                insert_post_scheduling_control_dependencies)) {\n+                insert_post_scheduling_control_dependencies,\n+                should_skip_removal_)) {\n           changed = true;\n           TF_RETURN_IF_ERROR(StripControlDependenciesFrom(instruction));\n           TF_RETURN_IF_ERROR("
        },
        {
            "sha": "14110cd2df80e3a90a8a54aaf32b59da1b08273a",
            "filename": "third_party/xla/xla/service/copy_insertion.h",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_insertion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_insertion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_insertion.h?ref=8ff6970971d62429c4444da7a7593667775ae73f",
            "patch": "@@ -65,8 +65,11 @@ class CopyInsertion : public HloModulePass {\n   // buffer.\n   explicit CopyInsertion(\n       const AliasInfo* alias_info,\n-      int64_t use_region_based_live_range_analysis = kUseRegionAnalysisLimit)\n+      int64_t use_region_based_live_range_analysis = kUseRegionAnalysisLimit,\n+      std::function<bool(const HloInstruction* copy)> should_skip_removal =\n+          nullptr)\n       : alias_info_(alias_info),\n+        should_skip_removal_(should_skip_removal),\n         use_region_based_live_range_analysis_(\n             use_region_based_live_range_analysis) {}\n \n@@ -119,6 +122,9 @@ class CopyInsertion : public HloModulePass {\n   // with its operand.\n   const AliasInfo* alias_info_;\n \n+  // Function to determine whether a copy should be skipped during removal.\n+  std::function<bool(const HloInstruction* copy)> should_skip_removal_;\n+\n   // Run the pass on the given module. Returns whether the module was changed\n   // (copies were inserted).\n   absl::StatusOr<bool> RunImpl("
        },
        {
            "sha": "6883336dfe47afe86b2e0427a3ee8990f342cda2",
            "filename": "third_party/xla/xla/service/copy_removal.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_removal.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_removal.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_removal.cc?ref=8ff6970971d62429c4444da7a7593667775ae73f",
            "patch": "@@ -857,7 +857,13 @@ LiveRangeRegions CopyRemover::ComputeLiveRangeRegions(const ValueNode* head) {\n // and true is returned. Returns false otherwise.\n bool CopyRemover::TryElideCopy(\n     const HloInstruction* copy, int64_t* region_analysis_limit,\n-    bool insert_post_scheduling_control_dependencies) {\n+    bool insert_post_scheduling_control_dependencies,\n+    std::function<bool(const HloInstruction* copy)> should_skip_removal) {\n+  if (should_skip_removal != nullptr && should_skip_removal(copy)) {\n+    VLOG(2) << copy->name()\n+            << \" is skipped due to should_skip_removal function.\";\n+    return false;\n+  }\n   VLOG(3) << \"TryElideCopy starting for: \" << copy->name();\n   CHECK_NE(region_analysis_limit, nullptr);\n "
        },
        {
            "sha": "64b9899a769ac70242a078b762f286c94c147801",
            "filename": "third_party/xla/xla/service/copy_removal.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_removal.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ff6970971d62429c4444da7a7593667775ae73f/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_removal.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcopy_removal.h?ref=8ff6970971d62429c4444da7a7593667775ae73f",
            "patch": "@@ -17,6 +17,7 @@ limitations under the License.\n #define XLA_SERVICE_COPY_REMOVAL_H_\n \n #include <cstdint>\n+#include <functional>\n #include <string>\n #include <utility>\n #include <vector>\n@@ -437,7 +438,9 @@ class CopyRemover {\n   // elision is possible, then the internal state (value lists) are updated,\n   // and true is returned. Returns false otherwise.\n   bool TryElideCopy(const HloInstruction* copy, int64_t* region_analysis_limit,\n-                    bool insert_post_scheduling_control_dependencies);\n+                    bool insert_post_scheduling_control_dependencies,\n+                    std::function<bool(const HloInstruction* copy)>\n+                        should_skip_removal = nullptr);\n \n   // Delete the given ValueNode associated with a elided kCopy\n   // instruction. This should be called after splicing the value lists of the"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 20,
        "deletions": 4
    }
}