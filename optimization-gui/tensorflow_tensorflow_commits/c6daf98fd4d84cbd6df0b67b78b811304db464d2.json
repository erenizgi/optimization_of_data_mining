{
    "author": "tensorflower-gardener",
    "message": "[XLA:GPU] Allow to extract settings from hlo config dump.\n\nPiperOrigin-RevId: 837386345",
    "sha": "c6daf98fd4d84cbd6df0b67b78b811304db464d2",
    "files": [
        {
            "sha": "306598ec942a14b61824e6da575a281a5f50d1f4",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c6daf98fd4d84cbd6df0b67b78b811304db464d2/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c6daf98fd4d84cbd6df0b67b78b811304db464d2/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc?ref=c6daf98fd4d84cbd6df0b67b78b811304db464d2",
            "patch": "@@ -979,11 +979,13 @@ CreateArgumentsOnDevice(PjRtClient& client,\n \n // Creates an ExecutableBuildOptions using the specified ExecutionOptions.\n ExecutableBuildOptions CreateExecutableBuildOptionsFromExecutionOptions(\n-    const ExecutionOptions& execution_options) {\n+    const ExecutionOptions& execution_options, bool preserve_xla_dump_to) {\n   ExecutableBuildOptions build_options;\n   if (execution_options.has_debug_options()) {\n     *build_options.mutable_debug_options() = execution_options.debug_options();\n-    build_options.mutable_debug_options()->set_xla_dump_to(\"\");\n+    if (!preserve_xla_dump_to) {\n+      build_options.mutable_debug_options()->set_xla_dump_to(\"\");\n+    }\n   }\n   if (execution_options.has_shape_with_output_layout()) {\n     absl::StatusOr<Shape> shape =\n@@ -1032,7 +1034,8 @@ absl::StatusOr<CompileOptions> CreateCompileOptions(\n   if (raw_options.execution_options.has_value()) {\n     compile_options.executable_build_options =\n         CreateExecutableBuildOptionsFromExecutionOptions(\n-            raw_options.execution_options.value());\n+            raw_options.execution_options.value(),\n+            raw_options.preserve_xla_dump_to);\n   }\n \n   ExecutableBuildOptions& build_options ="
        },
        {
            "sha": "6ff9496e4d8f6b0ed3dca99e79a892aa9551af45",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c6daf98fd4d84cbd6df0b67b78b811304db464d2/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c6daf98fd4d84cbd6df0b67b78b811304db464d2/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h?ref=c6daf98fd4d84cbd6df0b67b78b811304db464d2",
            "patch": "@@ -234,6 +234,9 @@ struct RawCompileOptions {\n   std::optional<int> num_slices = std::nullopt;\n   // A directory to dump xla debug data to.\n   std::string xla_dump_to = \"\";\n+  // When user runs HLO runner with hlo_config provided and\n+  // XLA_FLAGS=--xla_dump_to=dir we want to respect the xla_dump_to field.\n+  bool preserve_xla_dump_to = false;\n   XlaTextDumpMode xla_text_dump_mode = XlaTextDumpMode::kNotDumpAsText;\n   XlaProtoDumpMode xla_proto_dump_mode = XlaProtoDumpMode::kNotDumpAsProto;\n   // A directory to dump xspace data to (GPU profiler only)."
        },
        {
            "sha": "495d303bd847265eb608ef155e27ab2303a90fb1",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner_test.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c6daf98fd4d84cbd6df0b67b78b811304db464d2/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c6daf98fd4d84cbd6df0b67b78b811304db464d2/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc?ref=c6daf98fd4d84cbd6df0b67b78b811304db464d2",
            "patch": "@@ -914,6 +914,7 @@ TEST(FunctionalHloRunnerTest, TestDebugOptionsAreNotOverwrittenByRawOptions) {\n   // This test checks that we don't overwrite if we don't set xla_dump_to in the\n   // raw options.\n   xla::DebugOptions debug_options;\n+  debug_options.set_xla_dump_to(\"test_dump_to\");\n   debug_options.set_xla_dump_hlo_as_text(true);\n   FunctionalHloRunner::RawCompileOptions raw_compile_options;\n   raw_compile_options.execution_options = ExecutionOptions();\n@@ -930,6 +931,33 @@ TEST(FunctionalHloRunnerTest, TestDebugOptionsAreNotOverwrittenByRawOptions) {\n                                                 /*kv_store=*/nullptr));\n   EXPECT_TRUE(compile_options.executable_build_options.debug_options()\n                   .xla_dump_hlo_as_text());\n+  EXPECT_EQ(\n+      compile_options.executable_build_options.debug_options().xla_dump_to(),\n+      \"\");\n+}\n+\n+// Check that xla_dump_to is respected if preserve_xla_dump_to is true.\n+TEST(FunctionalHloRunnerTest, TestDebugOptionsDumpToIsRespected) {\n+  xla::DebugOptions debug_options;\n+  std::string xla_dump_to = \"test_dump_to\";\n+  debug_options.set_xla_dump_to(xla_dump_to);\n+  FunctionalHloRunner::RawCompileOptions raw_compile_options;\n+  raw_compile_options.preserve_xla_dump_to = true;\n+  raw_compile_options.execution_options = ExecutionOptions();\n+  *raw_compile_options.execution_options->mutable_debug_options() =\n+      debug_options;\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::PjRtClient> client,\n+                          GetPjRtClient());\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      CompileOptions compile_options,\n+      FunctionalHloRunner::CreateCompileOptions(*client, raw_compile_options,\n+                                                /*task_id=*/0, /*num_nodes=*/1,\n+                                                /*kv_store=*/nullptr));\n+  EXPECT_EQ(\n+      compile_options.executable_build_options.debug_options().xla_dump_to(),\n+      xla_dump_to);\n }\n \n TEST(FunctionalHloRunnerTest, RespectUseSpmdPartitioning) {"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 37,
        "deletions": 3
    }
}