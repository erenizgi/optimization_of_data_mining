{
    "author": "vwbaker",
    "message": "Return StatusOr rather than CHECK in SymbolicTilingAnalysis\n\nWe expect this to sometimes fail as we are autotuning & this should not crash the compiler, but rather fail gracefully in a way that allows the autotuning backend to simply dismiss the fusion.\n\nPiperOrigin-RevId: 803040775",
    "sha": "7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5",
    "files": [
        {
            "sha": "fb17d23a340bbff85f4c459b3d4f8a7195efdd17",
            "filename": "third_party/xla/xla/service/gpu/model/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD?ref=7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5",
            "patch": "@@ -787,7 +787,6 @@ cc_library(\n         \":symbolic_tiled_hlo_instruction\",\n         \":tiled_hlo_instruction_or_computation\",\n         \"//xla:shape_util\",\n-        \"//xla:status_macros\",\n         \"//xla:util\",\n         \"//xla/hlo/analysis:indexing_analysis\",\n         \"//xla/hlo/ir:hlo\",\n@@ -809,7 +808,6 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:IR\",\n@@ -835,7 +833,6 @@ xla_cc_test(\n         \"//xla/service:instruction_fusion\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:errors\",\n-        \"//xla/tsl/platform:status_matchers\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:flat_hash_map\","
        },
        {
            "sha": "b4a164698c9c7df0def886787c270eea463fd358",
            "filename": "third_party/xla/xla/service/gpu/model/symbolic_tile_analysis.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 8,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis.cc?ref=7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5",
            "patch": "@@ -1856,10 +1856,17 @@ std::string SymbolicTileAnalysis::ToString() const {\n namespace {\n \n // The possible tiles sizes for one dimension.\n-std::vector<int64_t> PossibleTileSizesForOneDimension(int64_t dim_size) {\n-  CHECK_GE(dim_size, 1);\n-\n+absl::StatusOr<std::vector<int64_t>> PossibleTileSizesForOneDimension(\n+    int64_t dim_size) {\n+  if (dim_size < 0) {\n+    return absl::InvalidArgumentError(\"Dimension size must be non-negative.\");\n+  }\n   std::vector<int64_t> result;\n+  if (dim_size == 0) {\n+    result.push_back(0);\n+    return result;\n+  }\n+\n   result.reserve(absl::bit_width(static_cast<uint64_t>(dim_size)));\n   for (int64_t tile_size = 1; tile_size < dim_size; tile_size *= 2) {\n     result.push_back(tile_size);\n@@ -1872,13 +1879,13 @@ std::vector<int64_t> PossibleTileSizesForOneDimension(int64_t dim_size) {\n \n namespace detail {\n \n-std::vector<FlatTiling> GetFlatTilingsForInputSpace(\n+absl::StatusOr<std::vector<FlatTiling>> GetFlatTilingsForInputSpace(\n     absl::Span<const int64_t> input_space) {\n   std::vector<FlatTiling> flat_tilings;\n   flat_tilings.push_back({});\n   for (int parameter_size : input_space) {\n-    std::vector<int64_t> possible_tile_sizes =\n-        PossibleTileSizesForOneDimension(parameter_size);\n+    TF_ASSIGN_OR_RETURN(std::vector<int64_t> possible_tile_sizes,\n+                        PossibleTileSizesForOneDimension(parameter_size));\n     std::vector<FlatTiling> extended_tilings;\n     extended_tilings.reserve(flat_tilings.size() * possible_tile_sizes.size());\n     for (const FlatTiling& flat_tile_sizes : flat_tilings) {\n@@ -1902,8 +1909,10 @@ absl::StatusOr<std::vector<Tiling>> SymbolicTileAnalysis::GetValidTilings()\n       tiling_specification_.parameter_mapping();\n \n   std::vector<Tiling> tilings;\n-  for (const FlatTiling& flat_tile_sizes : detail::GetFlatTilingsForInputSpace(\n-           InputSpaceForParameterMapping(parameter_mapping))) {\n+  TF_ASSIGN_OR_RETURN(std::vector<FlatTiling> flat_tilings,\n+                      detail::GetFlatTilingsForInputSpace(\n+                          InputSpaceForParameterMapping(parameter_mapping)));\n+  for (const FlatTiling& flat_tile_sizes : flat_tilings) {\n     TF_ASSIGN_OR_RETURN(\n         Tiling tiling,\n         Tiling::Unflatten(flat_tile_sizes, tiling_specification_));"
        },
        {
            "sha": "c5d6c171948cf108e917c7d37dff9237cf23613f",
            "filename": "third_party/xla/xla/service/gpu/model/symbolic_tile_analysis.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis.h?ref=7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5",
            "patch": "@@ -430,7 +430,7 @@ class SymbolicTileAnalysis {\n namespace detail {\n \n // Only exposed for testing.\n-std::vector<FlatTiling> GetFlatTilingsForInputSpace(\n+absl::StatusOr<std::vector<FlatTiling>> GetFlatTilingsForInputSpace(\n     absl::Span<const int64_t> input_space);\n \n }  // namespace detail"
        },
        {
            "sha": "02cfd70fccd4970468b7ee0fc4ffaa10b20cb8f7",
            "filename": "third_party/xla/xla/service/gpu/model/symbolic_tile_analysis_test.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 39,
            "changes": 83,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsymbolic_tile_analysis_test.cc?ref=7b13dec4cf443a3d391af7e8c6cf6ca220bfccb5",
            "patch": "@@ -50,23 +50,21 @@ limitations under the License.\n #include \"xla/service/instruction_fusion.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/errors.h\"\n-#include \"xla/tsl/platform/status_matchers.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n \n namespace xla {\n namespace gpu {\n namespace {\n \n+using absl_testing::IsOkAndHolds;\n using detail::GetFlatTilingsForInputSpace;\n using ::testing::ElementsAre;\n using ::testing::ElementsAreArray;\n using ::testing::ExplainMatchResult;\n using ::testing::IsEmpty;\n using ::testing::Matcher;\n using ::testing::Not;\n-using ::tsl::testing::IsOkAndHolds;\n-using ::tsl::testing::StatusIs;\n using TilingVector = std::vector<FlatTiling>;\n \n MATCHER_P3(MatchTiledHloInstructionImpl, tile_sizes, tile_strides,\n@@ -1142,51 +1140,58 @@ ENTRY main {\n }\n \n TEST(GetValidTilingsTest, ReturnsOneTilingWhenRankIsZero) {\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({}), TilingVector{FlatTiling{}});\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({}),\n+              IsOkAndHolds(TilingVector{FlatTiling{}}));\n }\n \n TEST(GetValidTilingsTest, ReturnsPowersOfTwoAndTheDimSizeForRankOne) {\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({1}), TilingVector{{1}});\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({2}), TilingVector({{1}, {2}}));\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({3}), TilingVector({{1}, {2}, {3}}));\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({4}), TilingVector({{1}, {2}, {4}}));\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({5}),\n-            TilingVector({{1}, {2}, {4}, {5}}));\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({11}),\n-            TilingVector({{1}, {2}, {4}, {8}, {11}}));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({1}),\n+              IsOkAndHolds(TilingVector{{1}}));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({2}),\n+              IsOkAndHolds(TilingVector({{1}, {2}})));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({3}),\n+              IsOkAndHolds(TilingVector({{1}, {2}, {3}})));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({4}),\n+              IsOkAndHolds(TilingVector({{1}, {2}, {4}})));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({5}),\n+              IsOkAndHolds(TilingVector({{1}, {2}, {4}, {5}})));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({11}),\n+              IsOkAndHolds(TilingVector({{1}, {2}, {4}, {8}, {11}})));\n }\n \n TEST(GetValidTilingsTest, CreatesCartesianProductForRankTwo) {\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({3, 4}), TilingVector({{1, 1},\n-                                                               {1, 2},\n-                                                               {1, 4},\n-                                                               {2, 1},\n-                                                               {2, 2},\n-                                                               {2, 4},\n-                                                               {3, 1},\n-                                                               {3, 2},\n-                                                               {3, 4}}));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({3, 4}),\n+              IsOkAndHolds(TilingVector({{1, 1},\n+                                         {1, 2},\n+                                         {1, 4},\n+                                         {2, 1},\n+                                         {2, 2},\n+                                         {2, 4},\n+                                         {3, 1},\n+                                         {3, 2},\n+                                         {3, 4}})));\n }\n \n TEST(GetValidTilingsTest, CreatesCartesianProductForRankThree) {\n-  EXPECT_EQ(GetFlatTilingsForInputSpace({3, 4, 2}), TilingVector({{1, 1, 1},\n-                                                                  {1, 1, 2},\n-                                                                  {1, 2, 1},\n-                                                                  {1, 2, 2},\n-                                                                  {1, 4, 1},\n-                                                                  {1, 4, 2},\n-                                                                  {2, 1, 1},\n-                                                                  {2, 1, 2},\n-                                                                  {2, 2, 1},\n-                                                                  {2, 2, 2},\n-                                                                  {2, 4, 1},\n-                                                                  {2, 4, 2},\n-                                                                  {3, 1, 1},\n-                                                                  {3, 1, 2},\n-                                                                  {3, 2, 1},\n-                                                                  {3, 2, 2},\n-                                                                  {3, 4, 1},\n-                                                                  {3, 4, 2}}));\n+  EXPECT_THAT(GetFlatTilingsForInputSpace({3, 4, 2}),\n+              IsOkAndHolds(TilingVector({{1, 1, 1},\n+                                         {1, 1, 2},\n+                                         {1, 2, 1},\n+                                         {1, 2, 2},\n+                                         {1, 4, 1},\n+                                         {1, 4, 2},\n+                                         {2, 1, 1},\n+                                         {2, 1, 2},\n+                                         {2, 2, 1},\n+                                         {2, 2, 2},\n+                                         {2, 4, 1},\n+                                         {2, 4, 2},\n+                                         {3, 1, 1},\n+                                         {3, 1, 2},\n+                                         {3, 2, 1},\n+                                         {3, 2, 2},\n+                                         {3, 4, 1},\n+                                         {3, 4, 2}})));\n }\n \n // Helper to transform a sequence of `Tiling`s into a sequence of equivalent"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 62,
        "deletions": 51
    }
}