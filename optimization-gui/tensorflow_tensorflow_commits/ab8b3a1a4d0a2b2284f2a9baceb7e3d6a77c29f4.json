{
    "author": "basioli-k",
    "message": "[XLA:GPU][host offloading] Bring back computation of `needs_layout_assignment`\n\nPiperOrigin-RevId: 813667863",
    "sha": "ab8b3a1a4d0a2b2284f2a9baceb7e3d6a77c29f4",
    "files": [
        {
            "sha": "0752fbc67d40c44629855f41831b1bb838885d73",
            "filename": "third_party/xla/xla/core/host_offloading/host_offloading_nanort_executable.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ab8b3a1a4d0a2b2284f2a9baceb7e3d6a77c29f4/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2Fhost_offloading_nanort_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ab8b3a1a4d0a2b2284f2a9baceb7e3d6a77c29f4/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2Fhost_offloading_nanort_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcore%2Fhost_offloading%2Fhost_offloading_nanort_executable.cc?ref=ab8b3a1a4d0a2b2284f2a9baceb7e3d6a77c29f4",
            "patch": "@@ -198,12 +198,20 @@ HostOffloadingNanoRtExecutable::LoadFromProto(\n       },\n       &num_replicas, &num_partitions, &device_assignment));\n \n+  TF_ASSIGN_OR_RETURN(std::unique_ptr<HloModule> hlo_module,\n+                      HloModule::CreateFromProto(\n+                          proto.hlo_module(), HloModuleConfig(program_shape)));\n+\n+  TF_ASSIGN_OR_RETURN(\n+      bool needs_layout_conversion,\n+      HostOffloadingLayoutAnalysis::NeedsLayoutConversion(hlo_module.get()));\n+\n   return absl::WrapUnique(new HostOffloadingNanoRtExecutable(\n       hlo_module_proto.name(),\n       executable->program_shape() ? *executable->program_shape()\n                                   : program_shape,\n-      std::move(alias_config), std::move(executable),\n-      /*needs_layout_conversion=*/false, std::move(device_assignment)));\n+      std::move(alias_config), std::move(executable), needs_layout_conversion,\n+      std::move(device_assignment)));\n }\n \n tsl::AsyncValueRef<HostOffloadingExecutable::ExecuteEvent>"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 10,
        "deletions": 2
    }
}