{
    "author": "tensorflower-gardener",
    "message": "Modify HLO name generation to better preserve debug information from Structs\n\nPiperOrigin-RevId: 798228160",
    "sha": "b3927bd7aefd58202673f4a0b99f6076292d2771",
    "files": [
        {
            "sha": "e702828f3f178a9823232eba57c9fe4f6e533933",
            "filename": "third_party/xla/xla/hlo/builder/xla_builder.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -4976,12 +4976,8 @@ absl::StatusOr<XlaOp> XlaBuilder::AddInstruction(\n       absl::string_view name = (last_slash_pos == absl::string_view::npos)\n                                    ? op_name\n                                    : op_name.substr(last_slash_pos + 1);\n-      // Further strip any numeric identifier suffixes.\n-      if (absl::StrContains(name, kNameSeparator)) {\n-        instr.set_name(GetBaseName(std::string(name), kNameSeparator));\n-      } else {\n-        instr.set_name(name);\n-      }\n+      instr.set_name(\n+          xla::SanitizeOpName(std::string(name), kNameSeparator, \"_\"));\n     } else {\n       instr.set_name(instr.opcode());\n     }"
        },
        {
            "sha": "0766070a142349442db770e624404d98bf07f9a2",
            "filename": "third_party/xla/xla/hlo/builder/xla_builder_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder_test.cc?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -4018,5 +4018,18 @@ TEST(XlaBuilderTest, InstructionNameFromMetadata) {\n             \"sin\");\n }\n \n+TEST(XlaBuilderTest, InstructionNameFromMetadataWithDot) {\n+  XlaBuilder b(TestName());\n+  OpMetadata metadata;\n+  metadata.set_op_name(\"inputs.x\");\n+  XlaScopedOpMetadataAssignment op_metadata(&b, metadata);\n+  ConstantR0<float>(&b, 1.0f);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module, BuildHloModule(b));\n+  HloInstruction* constant = module->entry_computation()->root_instruction();\n+  EXPECT_EQ(constant->name().substr(0, constant->name().find_first_of('.')),\n+            \"inputs_x\");\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "6aef931e0fa1d88371103b160e8b414b415d931d",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2FBUILD?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -176,6 +176,7 @@ cc_library(\n         \"//xla:shape_util\",\n         \"//xla:status_macros\",\n         \"//xla:types\",\n+        \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/hlo/builder:xla_builder\",\n         \"//xla/hlo/builder:xla_computation\","
        },
        {
            "sha": "0cea8d2cc804c2362d33ff7cd5d51b9c40cbb5fe",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/mlir_hlo_to_hlo.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -113,6 +113,7 @@ limitations under the License.\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/types.h\"\n+#include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n \n #define DEBUG_TYPE \"xla-translate\"\n@@ -6013,6 +6014,11 @@ xla::OpMetadata GetOpNameMetadataFromLocation(Value value) {\n   return m;\n }\n \n+std::string SanitizeOpName(std::string name) {\n+  name = llvm::sys::path::filename(name);\n+  return xla::SanitizeOpName(name, '.', \"_\");\n+}\n+\n }  // namespace\n \n LogicalResult ConvertToHloModule::LowerBasicBlockAsFunction(\n@@ -6114,7 +6120,7 @@ LogicalResult ConvertToHloModule::LowerBasicBlockAsFunction(\n         // otherwise use the default prefix.\n         std::string name = mhlo::GetDebugNameFromLocation(arg.getLoc());\n         if (!name.empty()) {\n-          name = llvm::sys::path::stem(name);\n+          name = SanitizeOpName(name);\n         } else {\n           name = kArgPrefix;\n         }\n@@ -6146,7 +6152,7 @@ LogicalResult ConvertToHloModule::LowerBasicBlockAsFunction(\n         // otherwise use the default prefix.\n         std::string name = mhlo::GetDebugNameFromLocation(arg.getLoc());\n         if (!name.empty()) {\n-          name = llvm::sys::path::stem(name);\n+          name = SanitizeOpName(name);\n         } else {\n           name = absl::StrCat(kArgPrefix, num);\n         }"
        },
        {
            "sha": "afab2d6fbde6e7afaa3089b3e5e52a678db02e5b",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/location_to_op_metadata.mlir",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_op_metadata.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_op_metadata.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_op_metadata.mlir?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -148,3 +148,23 @@ func.func @main(%arg0: tensor<1x2xf32>, %arg1: tensor<1x2xf32>) -> tensor<1x2xf3\n }\n \n // CHECK: my_add{{.*}}, metadata={op_name=\"my_add\"}\n+\n+// -----\n+\n+// CHECK-LABEL: %main\n+func.func @main(%arg0: tensor<2xf32> loc(\"inputs.x\"), %arg1: tensor<2xf32> loc(\"inputs.y\")) -> tensor<2xf32> {\n+  %0 = \"mhlo.add\"(%arg0, %arg1) : (tensor<2xf32>, tensor<2xf32>) -> tensor<2xf32> loc(\"my_add\")\n+  func.return %0 : tensor<2xf32>\n+}\n+\n+// CHECK: inputs_x{{.*}}, metadata={op_name=\"inputs.x\"}\n+\n+// -----\n+\n+// CHECK-LABEL: %main\n+func.func @main(%arg0: tensor<2xf32> loc(\"Arg_0.1\"), %arg1: tensor<2xf32> loc(\"Arg_1.1\")) -> tensor<2xf32> {\n+  %0 = \"mhlo.add\"(%arg0, %arg1) : (tensor<2xf32>, tensor<2xf32>) -> tensor<2xf32> loc(\"my_add\")\n+  func.return %0 : tensor<2xf32>\n+}\n+\n+// CHECK: Arg_0{{.*}}, metadata={op_name=\"Arg_0.1\"}"
        },
        {
            "sha": "6baa6235865b7240b493a01e05b60737bd7ea08d",
            "filename": "third_party/xla/xla/util.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Futil.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Futil.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil.cc?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -45,6 +45,7 @@ limitations under the License.\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/str_join.h\"\n+#include \"absl/strings/str_replace.h\"\n #include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n@@ -497,6 +498,19 @@ std::string SanitizeFileName(std::string file_name) {\n   return file_name;\n }\n \n+std::string SanitizeOpName(std::string op_name, char separator,\n+                           const std::string& replace_with) {\n+  auto pos = op_name.rfind(separator);\n+  if (pos > 0 && pos != std::string::npos) {\n+    std::string suffix = op_name.substr(pos + 1);\n+    if (std::all_of(suffix.begin(), suffix.end(), absl::ascii_isdigit)) {\n+      op_name = op_name.substr(0, pos);\n+    }\n+  }\n+  return absl::StrReplaceAll(op_name,\n+                             {{std::string(1, separator), replace_with}});\n+}\n+\n bool DistinctNumbersAreConsecutiveIfSorted(absl::Span<const int64_t> seq) {\n   return *absl::c_max_element(seq) - *absl::c_min_element(seq) ==\n          seq.size() - 1;"
        },
        {
            "sha": "2e3a720cbcf44c33a73438b27e91ae9fe059ba7f",
            "filename": "third_party/xla/xla/util.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Futil.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3927bd7aefd58202673f4a0b99f6076292d2771/third_party%2Fxla%2Fxla%2Futil.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil.h?ref=b3927bd7aefd58202673f4a0b99f6076292d2771",
            "patch": "@@ -802,6 +802,10 @@ DimensionVector GetNonContractingDims(\n // Removes illegal characters from filenames.\n std::string SanitizeFileName(std::string file_name);\n \n+// Removes numerical identifiers and replaces separators in op names.\n+std::string SanitizeOpName(std::string op_name, char separator,\n+                           const std::string& replace_with);\n+\n // Check that a sequence of distinct numbers can form a continuous interval.\n bool DistinctNumbersAreConsecutiveIfSorted(absl::Span<const int64_t>);\n "
        }
    ],
    "stats": {
        "total": 70,
        "additions": 62,
        "deletions": 8
    }
}