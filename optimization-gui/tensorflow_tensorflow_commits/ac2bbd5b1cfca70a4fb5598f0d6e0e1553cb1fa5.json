{
    "author": "vwbaker",
    "message": "Use `lookupOrDefault` for value mapping in TritonReduce lowering.\n\nThis just means it will use the original operand value if there is no mapping. This covers the odd case for when the return op is not within the reduction space - for example a constant:\n\n```\n%cst = arith.constant dense<true> : tensor<i1>\n...\n%12 = stablehlo.reduce(%11 init: %cst_0) across dimensions = [1] : (tensor<4x8xi1>, tensor<i1>) -> tensor<4xi1>\n     reducer(%arg3: tensor<i1>, %arg4: tensor<i1>)  {\n      stablehlo.return %cst : tensor<i1>\n    }\n...\n```\n\nPreviously, the code was crashing, but now it's working.\n\nPiperOrigin-RevId: 830916653",
    "sha": "ac2bbd5b1cfca70a4fb5598f0d6e0e1553cb1fa5",
    "files": [
        {
            "sha": "9ac3437c18e458a0a05ff410be93d6aa7d8aff31",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/stablehlo_lower_to_triton.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac2bbd5b1cfca70a4fb5598f0d6e0e1553cb1fa5/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fstablehlo_lower_to_triton.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac2bbd5b1cfca70a4fb5598f0d6e0e1553cb1fa5/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fstablehlo_lower_to_triton.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fstablehlo_lower_to_triton.cc?ref=ac2bbd5b1cfca70a4fb5598f0d6e0e1553cb1fa5",
            "patch": "@@ -205,7 +205,7 @@ class LowerReduce : public mlir::OpRewritePattern<stablehlo::ReduceOp> {\n     SmallVector<Value> return_operands;\n     for (Value operand : old_block.getTerminator()->getOperands()) {\n       return_operands.push_back(mlir::tensor::ExtractOp::create(\n-          rewriter, op->getLoc(), mapping.lookup(operand)));\n+          rewriter, op->getLoc(), mapping.lookupOrDefault(operand)));\n     }\n     ttir::ReduceReturnOp::create(rewriter, op.getLoc(), return_operands);\n "
        }
    ],
    "stats": {
        "total": 2,
        "additions": 1,
        "deletions": 1
    }
}