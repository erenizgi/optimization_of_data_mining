{
    "author": "jakeharmon8",
    "message": "Add a smoke test to PJRT wheel builds.\n\nIt dlopens the shared object and checks that the PJRT API loads.\n\nPiperOrigin-RevId: 833477289",
    "sha": "964cb72a15c23bceb108ab79d01ab7610f6e25a8",
    "files": [
        {
            "sha": "0dcb7eb6aa12ad369a6a3d60c6dd757889956580",
            "filename": "third_party/xla/build_tools/pjrt_wheels/BUILD.bazel",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/964cb72a15c23bceb108ab79d01ab7610f6e25a8/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/964cb72a15c23bceb108ab79d01ab7610f6e25a8/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel?ref=964cb72a15c23bceb108ab79d01ab7610f6e25a8",
            "patch": "@@ -109,3 +109,41 @@ py_wheel(\n         \":xla_plugins/xla_cpu_pjrt/xla_cpu_pjrt.so\",\n     ],\n )\n+\n+# Tests\n+cc_test(\n+    name = \"cpu_smoke_test\",\n+    srcs = [\"smoke_test.cc\"],\n+    data = [\":xla_plugins/xla_cpu_pjrt/xla_cpu_pjrt.so\"],\n+    env = {\n+        \"PJRT_PLUGIN_PATH\": \"build_tools/pjrt_wheels/xla_plugins/xla_cpu_pjrt/xla_cpu_pjrt.so\",\n+    },\n+    linkopts = [\"-ldl\"],\n+    deps = [\"//xla/pjrt/c:pjrt_c_api_hdrs\"],\n+)\n+\n+cc_test(\n+    name = cuda_label + \"_smoke_test\",\n+    srcs = [\"smoke_test.cc\"],\n+    data = [\":xla_plugins/xla_\" + cuda_label + \"_pjrt/xla_gpu_pjrt.so\"],\n+    env = {\n+        \"PJRT_PLUGIN_PATH\": \"build_tools/pjrt_wheels/xla_plugins/xla_\" + cuda_label + \"_pjrt/xla_gpu_pjrt.so\",\n+    },\n+    linkopts = [\"-ldl\"],\n+    deps = [\"//xla/pjrt/c:pjrt_c_api_hdrs\"],\n+)\n+\n+# The CPU and CUDA test suites are run in CI's build script\n+test_suite(\n+    name = \"cpu_test_suite\",\n+    tests = [\n+        \":cpu_smoke_test\",\n+    ],\n+)\n+\n+test_suite(\n+    name = \"cuda_test_suite\",\n+    tests = [\n+        \":\" + cuda_label + \"_smoke_test\",\n+    ],\n+)"
        },
        {
            "sha": "e00f439a363d6d5c0595b9b5e849798f02befb1e",
            "filename": "third_party/xla/build_tools/pjrt_wheels/smoke_test.cc",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/964cb72a15c23bceb108ab79d01ab7610f6e25a8/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Fsmoke_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/964cb72a15c23bceb108ab79d01ab7610f6e25a8/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Fsmoke_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2Fsmoke_test.cc?ref=964cb72a15c23bceb108ab79d01ab7610f6e25a8",
            "patch": "@@ -0,0 +1,57 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include <dlfcn.h>\n+\n+#include <iostream>\n+\n+#include \"xla/pjrt/c/pjrt_c_api.h\"\n+\n+typedef const PJRT_Api* (*GetPjrtApi_Func)();\n+\n+int main() {\n+  // 1. Open the shared object\n+  const char* so_path = std::getenv(\"PJRT_PLUGIN_PATH\");\n+  std::cout << \"so_path: \" << so_path << std::endl;\n+  void* handle = dlopen(so_path, RTLD_LAZY);\n+  if (!handle) {\n+    std::cerr << \"Error: Could not open shared object.\" << std::endl;\n+    std::cerr << \"Reason: \" << dlerror() << std::endl;\n+    return 1;\n+  }\n+\n+  // 2. Load the symbol (the function)\n+  GetPjrtApi_Func get_pjrt_api = (GetPjrtApi_Func)dlsym(handle, \"GetPjrtApi\");\n+  const char* dlsym_error = dlerror();\n+  if (dlsym_error) {\n+    std::cerr << \"Error: Could not find symbol 'GetPjrtApi'.\" << std::endl;\n+    std::cerr << \"Reason: \" << dlsym_error << std::endl;\n+    dlclose(handle);\n+    return 1;\n+  }\n+\n+  // 3. Call the function\n+  std::cout << \"Successfully loaded symbol. Calling GetPjrtApi()...\"\n+            << std::endl;\n+  const PJRT_Api* api = get_pjrt_api();\n+  if (api) {\n+    std::cout << \"Success! Received PjrtApi struct pointer.\" << std::endl;\n+  } else {\n+    std::cerr << \"Error: GetPjrtApi() returned a null pointer.\" << std::endl;\n+    return 1;\n+  }\n+\n+  return 0;\n+}"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 95,
        "deletions": 0
    }
}