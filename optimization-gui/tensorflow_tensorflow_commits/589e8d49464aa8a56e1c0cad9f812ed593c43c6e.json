{
    "author": "akuegel",
    "message": "Use GetInPlaceInputOutputPairs from AliasInfo instead of HloDataflowAnalysis.\n\nPiperOrigin-RevId: 837407555",
    "sha": "589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
    "files": [
        {
            "sha": "893ed8c26c29c64cf64ada38a8b429b0bc468b1b",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -2023,7 +2023,7 @@ cc_library(\n         \"//xla:debug_options_flags\",\n         \"//xla:shape_util\",\n         \"//xla:util\",\n-        \"//xla/hlo/analysis:hlo_dataflow_analysis\",\n+        \"//xla/hlo/analysis:alias_info\",\n         \"//xla/hlo/analysis:hlo_reachability\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\","
        },
        {
            "sha": "ef1c70ed5b76648d7785b5ebf0a1a5005856b972",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -1790,9 +1790,9 @@ cc_library(\n     deps = [\n         \"//xla:shape_util\",\n         \"//xla/codegen/emitters:elemental_hlo_to_mlir\",\n+        \"//xla/hlo/analysis:alias_info\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/service:multi_output_fusion\",\n-        \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/strings:string_view\",\n     ],\n@@ -1803,6 +1803,7 @@ xla_cc_test(\n     srcs = [\"cpu_multi_output_fusion_test.cc\"],\n     deps = [\n         \":cpu_multi_output_fusion\",\n+        \"//xla/hlo/analysis:alias_info\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/hlo/utils:hlo_matchers\","
        },
        {
            "sha": "3128fb1aed991d3ed6def111018ee0633f7066d0",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -1020,8 +1020,9 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n     pipeline.AddPass<FusionWrapper>(use_experimental_loop_fusion);\n   }\n \n+  AliasInfo alias_info;\n   if (use_multi_output_fusion) {\n-    pipeline.AddPass<CpuMultiOutputFusion>();\n+    pipeline.AddPass<CpuMultiOutputFusion>(&alias_info);\n     pipeline.AddPass<TupleSimplifier>();\n   }\n \n@@ -1084,7 +1085,6 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n   pipeline.AddPass<OptimizeInputOutputBufferAlias>(true);\n \n   // If enabled we'll use more precise region based analysis for copy removal.\n-  AliasInfo alias_info;\n   if (debug_options.xla_cpu_copy_insertion_use_region_analysis()) {\n     pipeline.AddPass<CopyInsertion>(\n         &alias_info,"
        },
        {
            "sha": "060f11bfc53aa8df6fe1fa918776f774cb2d4728",
            "filename": "third_party/xla/xla/service/cpu/cpu_multi_output_fusion.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_multi_output_fusion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_multi_output_fusion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_multi_output_fusion.h?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -19,14 +19,16 @@ limitations under the License.\n #include <cstdint>\n \n #include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/service/multi_output_fusion.h\"\n \n namespace xla::cpu {\n \n class CpuMultiOutputFusion final : public MultiOutputFusion {\n  public:\n-  CpuMultiOutputFusion() = default;\n+  explicit CpuMultiOutputFusion(const AliasInfo* alias_info)\n+      : MultiOutputFusion(alias_info) {}\n \n   absl::string_view name() const override { return \"cpu_multi_output_fusion\"; }\n "
        },
        {
            "sha": "ffc54e6bf347abc4a598d0f7949f7a715f95c37f",
            "filename": "third_party/xla/xla/service/cpu/cpu_multi_output_fusion_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_multi_output_fusion_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_multi_output_fusion_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_multi_output_fusion_test.cc?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -18,6 +18,7 @@ limitations under the License.\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/utils/hlo_matchers.h\"\n@@ -28,7 +29,10 @@ namespace op = xla::testing::opcode_matchers;\n namespace xla::cpu {\n namespace {\n \n-using MultiOutputFusionTest = HloHardwareIndependentTestBase;\n+class MultiOutputFusionTest : public HloHardwareIndependentTestBase {\n+ protected:\n+  AliasInfo alias_info_;\n+};\n \n TEST_F(MultiOutputFusionTest, TrivialReusedInput) {\n   // The current implementation of the multi-output fusion pass only fuses when\n@@ -55,8 +59,8 @@ TEST_F(MultiOutputFusionTest, TrivialReusedInput) {\n \n   TF_ASSERT_OK_AND_ASSIGN(auto hlo_module,\n                           ParseAndReturnVerifiedModule(kTrivialReusedInput));\n-  TF_ASSERT_OK_AND_ASSIGN(bool changed,\n-                          CpuMultiOutputFusion().Run(hlo_module.get()));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      bool changed, CpuMultiOutputFusion(&alias_info_).Run(hlo_module.get()));\n   EXPECT_TRUE(changed);\n   HloComputation* entry_computation = hlo_module->entry_computation();\n   EXPECT_THAT(entry_computation->instructions(),"
        },
        {
            "sha": "aea40ca4862541c7b477171e693d0daf804b0457",
            "filename": "third_party/xla/xla/service/multi_output_fusion.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fmulti_output_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fmulti_output_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmulti_output_fusion.cc?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -29,7 +29,6 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/debug_options_flags.h\"\n-#include \"xla/hlo/analysis/hlo_dataflow_analysis.h\"\n #include \"xla/hlo/analysis/hlo_reachability.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n@@ -292,11 +291,11 @@ bool MultiOutputFusion::LegalToFuseMainConstraints(HloInstruction* instr1,\n   // If both nodes are in-place operations and they use a common in-place\n   // operand, we can't fuse these two.\n   for (const auto& operand_and_output_index1 :\n-       HloDataflowAnalysis::GetInPlaceInputOutputPairs(instr1)) {\n+       alias_info_->GetInPlaceInputOutputPairs(instr1)) {\n     const HloInstruction* operand =\n         instr1->operand(operand_and_output_index1.first.operand_number);\n     for (const auto& operand_and_output_index2 :\n-         HloDataflowAnalysis::GetInPlaceInputOutputPairs(instr2)) {\n+         alias_info_->GetInPlaceInputOutputPairs(instr2)) {\n       if (operand ==\n           instr2->operand(operand_and_output_index2.first.operand_number)) {\n         return false;"
        },
        {
            "sha": "798cbeba0e5cb4bb6522a1aca499a05586f169b0",
            "filename": "third_party/xla/xla/service/multi_output_fusion.h",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fmulti_output_fusion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/589e8d49464aa8a56e1c0cad9f812ed593c43c6e/third_party%2Fxla%2Fxla%2Fservice%2Fmulti_output_fusion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmulti_output_fusion.h?ref=589e8d49464aa8a56e1c0cad9f812ed593c43c6e",
            "patch": "@@ -26,6 +26,7 @@ limitations under the License.\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/analysis/hlo_reachability.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -53,7 +54,8 @@ namespace xla {\n //  instruction fusion.\n class MultiOutputFusion : public HloModulePass {\n  public:\n-  MultiOutputFusion() = default;\n+  explicit MultiOutputFusion(const AliasInfo* alias_info)\n+      : alias_info_(alias_info) {}\n \n   absl::string_view name() const override { return \"multi_output_fusion\"; }\n \n@@ -163,6 +165,8 @@ class MultiOutputFusion : public HloModulePass {\n       HloModule* module,\n       const absl::flat_hash_set<absl::string_view>& execution_threads) override;\n \n+  const AliasInfo* alias_info_;\n+\n  private:\n   // The pair of candidates to be fused and the profit score.\n   struct ToBeFused {\n@@ -237,7 +241,7 @@ class MultiOutputFusion : public HloModulePass {\n       all_fusion_candidates_;\n \n   // Computation for the pass.\n-  HloComputation* computation_;\n+  HloComputation* computation_ = nullptr;\n };\n \n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 23,
        "deletions": 13
    }
}