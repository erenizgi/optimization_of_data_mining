{
    "author": "nvgrw",
    "message": "Add ExecuteReplicatedWithExecutable to HloRunnerInterface.\n\nWorks just like ExecuteReplicated but lets us avoid creating redundant\nexecutables and avoid using ExecuteReplicated with the `executable_provider` set\nto return the same executable for each device.\n\nPiperOrigin-RevId: 845840535",
    "sha": "722bf3e739ba2d6347f1b4e435cc79486a174113",
    "files": [
        {
            "sha": "d049724ae6fe9097d8632d4162627f9bc58d33d1",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=722bf3e739ba2d6347f1b4e435cc79486a174113",
            "patch": "@@ -4491,6 +4491,7 @@ cc_library(\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:logging\",\n+        \"//xla/tsl/platform:status_macros\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/base:nullability\",\n@@ -4531,6 +4532,7 @@ cc_library(\n         \"//xla/pjrt:pjrt_executable\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:status_macros\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/base:nullability\","
        },
        {
            "sha": "4d071600c4e4056e53712d7f78532e20c9b9e3ad",
            "filename": "third_party/xla/xla/service/hlo_runner.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner.cc?ref=722bf3e739ba2d6347f1b4e435cc79486a174113",
            "patch": "@@ -59,6 +59,7 @@ limitations under the License.\n #include \"xla/tsl/platform/logging.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n+#include \"xla/tsl/platform/status_macros.h\"\n \n namespace xla {\n \n@@ -474,7 +475,15 @@ absl::StatusOr<std::vector<Literal>> HloRunner::ExecuteReplicated(\n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<OpaqueExecutable> executable,\n       CreateExecutable(std::move(module), options.run_hlo_passes));\n-  return ExecuteReplicated(executable.get(), options, device_assignment,\n+  return ExecuteReplicatedWithExecutable(executable.get(), options,\n+                                         device_assignment);\n+}\n+\n+absl::StatusOr<std::vector<Literal>> HloRunner::ExecuteReplicatedWithExecutable(\n+    OpaqueExecutable* const absl_nonnull executable,\n+    const ReplicatedExecuteOptions& options,\n+    DeviceAssignment* device_assignment) {\n+  return ExecuteReplicated(executable, options, device_assignment,\n                            /*profile=*/nullptr);\n }\n \n@@ -620,6 +629,14 @@ absl::StatusOr<std::vector<Literal>> HloRunner::ExecuteReplicatedImpl(\n absl::StatusOr<std::vector<Literal>> HloRunner::ExecuteReplicated(\n     OpaqueExecutable* executable, const ReplicatedExecuteOptions& options,\n     DeviceAssignment* device_assignment, ExecutionProfile* profile) {\n+  DeviceAssignment computation_device_assignment;\n+  if (device_assignment == nullptr) {\n+    ASSIGN_OR_RETURN(\n+        computation_device_assignment,\n+        backend().computation_placer()->AssignDevices(options.num_devices, 1));\n+    device_assignment = &computation_device_assignment;\n+  }\n+  CHECK_NE(device_assignment, nullptr);\n   TF_ASSIGN_OR_RETURN(HloRunnerExecutable* const wrapped_executable,\n                       HloRunnerExecutable::TryUnwrap(*this, executable));\n   return ExecuteReplicatedImpl(\n@@ -736,6 +753,16 @@ absl::StatusOr<std::vector<Literal>> HloRunner::ExecuteReplicated(\n   return ExecuteReplicated(std::move(module), options, &device_assignment);\n }\n \n+absl::StatusOr<std::vector<Literal>> HloRunner::ExecuteReplicatedWithExecutable(\n+    OpaqueExecutable* const absl_nonnull executable,\n+    const ReplicatedExecuteOptions& options) {\n+  ASSIGN_OR_RETURN(\n+      DeviceAssignment device_assignment,\n+      backend().computation_placer()->AssignDevices(options.num_devices, 1));\n+  return ExecuteReplicatedWithExecutable(executable, options,\n+                                         &device_assignment);\n+}\n+\n absl::StatusOr<std::unique_ptr<OpaqueExecutable>> HloRunner::CreateExecutable(\n     std::unique_ptr<HloModule> module, bool run_hlo_passes) {\n   return CreateExecutableWithBufferAssignment("
        },
        {
            "sha": "122a4b6c76637681eea2d8af5e1a5d67ac1eaa50",
            "filename": "third_party/xla/xla/service/hlo_runner.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner.h?ref=722bf3e739ba2d6347f1b4e435cc79486a174113",
            "patch": "@@ -173,6 +173,16 @@ class HloRunner : public HloRunnerInterface {\n       const ReplicatedExecuteOptions& options,\n       DeviceAssignment* device_assignment) override;\n \n+  absl::StatusOr<std::vector<Literal>> ExecuteReplicatedWithExecutable(\n+      OpaqueExecutable* absl_nonnull executable,\n+      const ReplicatedExecuteOptions& options) override;\n+\n+  // Same as above, but with specified device assignment.\n+  absl::StatusOr<std::vector<Literal>> ExecuteReplicatedWithExecutable(\n+      OpaqueExecutable* absl_nonnull executable,\n+      const ReplicatedExecuteOptions& options,\n+      DeviceAssignment* device_assignment) override;\n+\n   // Same as above, but with a reusable Executable.  This may update the profile\n   // information in *executable.\n   //"
        },
        {
            "sha": "6956847ee83f72db6f30d501ca3623fd7edbf8f8",
            "filename": "third_party/xla/xla/service/hlo_runner_interface.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_interface.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_interface.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_interface.h?ref=722bf3e739ba2d6347f1b4e435cc79486a174113",
            "patch": "@@ -290,6 +290,16 @@ class HloRunnerInterface {\n       const ReplicatedExecuteOptions& options,\n       DeviceAssignment* device_assignment) = 0;\n \n+  virtual absl::StatusOr<std::vector<Literal>> ExecuteReplicatedWithExecutable(\n+      OpaqueExecutable* absl_nonnull executable,\n+      const ReplicatedExecuteOptions& options) = 0;\n+\n+  // Same as above, but with specified device assignment.\n+  virtual absl::StatusOr<std::vector<Literal>> ExecuteReplicatedWithExecutable(\n+      OpaqueExecutable* absl_nonnull executable,\n+      const ReplicatedExecuteOptions& options,\n+      DeviceAssignment* device_assignment) = 0;\n+\n   virtual absl::StatusOr<std::vector<Literal>> ExecuteReplicated(\n       absl::AnyInvocable<OpaqueExecutable*(int64_t)> executable_provider,\n       absl::AnyInvocable<int64_t(int64_t)> argument_count_provider,"
        },
        {
            "sha": "78404dade0960fe3f4a9f95d64a820a463c3ea2e",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc?ref=722bf3e739ba2d6347f1b4e435cc79486a174113",
            "patch": "@@ -63,6 +63,7 @@ limitations under the License.\n #include \"xla/util.h\"\n #include \"tsl/platform/fingerprint.h\"\n #include \"tsl/platform/path.h\"\n+#include \"xla/tsl/platform/status_macros.h\"\n \n namespace xla {\n \n@@ -551,13 +552,35 @@ absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicated(\n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<OpaqueExecutable> executable,\n       CreateExecutable(std::move(module), options.run_hlo_passes));\n-  return ExecuteReplicated(executable.get(), options, device_assignment);\n+  return ExecuteReplicatedWithExecutable(executable.get(), options,\n+                                         device_assignment);\n }\n \n-absl::StatusOr<std::vector<Literal>> HloRunnerPjRt::ExecuteReplicated(\n-    OpaqueExecutable* executable,\n+absl::StatusOr<std::vector<Literal>>\n+HloRunnerPjRt::ExecuteReplicatedWithExecutable(\n+    OpaqueExecutable* const absl_nonnull executable,\n+    const ReplicatedExecuteOptions& options) {\n+  ASSIGN_OR_RETURN(const HloModule* const module,\n+                   HloModuleFromWrapped(executable));\n+  ASSIGN_OR_RETURN(\n+      DeviceAssignment device_assignment,\n+      GetStaticDeviceAssignmentOrComputeDefault(*module, *pjrt_client_));\n+  return ExecuteReplicatedWithExecutable(executable, options,\n+                                         &device_assignment);\n+}\n+\n+absl::StatusOr<std::vector<Literal>>\n+HloRunnerPjRt::ExecuteReplicatedWithExecutable(\n+    OpaqueExecutable* const absl_nonnull executable,\n     const HloRunnerInterface::ReplicatedExecuteOptions& options,\n     DeviceAssignment* device_assignment) {\n+  std::optional<DeviceAssignment> default_device_assignment = std::nullopt;\n+  if (device_assignment == nullptr) {\n+    ASSIGN_OR_RETURN(default_device_assignment,\n+                     GetDefaultDeviceAssignment(options.num_devices, 1));\n+    device_assignment = &*default_device_assignment;\n+  }\n+  CHECK_NE(device_assignment, nullptr);\n   TF_ASSIGN_OR_RETURN(HloRunnerPjRtExecutable* const wrapped_executable,\n                       HloRunnerPjRtExecutable::TryUnwrap(*this, executable));\n "
        },
        {
            "sha": "08b4f4b12fa2279c384b07e74abf2dd98ba3b654",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.h",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/722bf3e739ba2d6347f1b4e435cc79486a174113/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.h?ref=722bf3e739ba2d6347f1b4e435cc79486a174113",
            "patch": "@@ -101,18 +101,23 @@ class HloRunnerPjRt : public HloRunnerInterface {\n       const ReplicatedExecuteOptions& options,\n       DeviceAssignment* device_assignment) override;\n \n+  absl::StatusOr<std::vector<Literal>> ExecuteReplicatedWithExecutable(\n+      OpaqueExecutable* absl_nonnull executable,\n+      const ReplicatedExecuteOptions& options) override;\n+\n+  // Same as above, but with specified device assignment.\n+  absl::StatusOr<std::vector<Literal>> ExecuteReplicatedWithExecutable(\n+      OpaqueExecutable* absl_nonnull executable,\n+      const ReplicatedExecuteOptions& options,\n+      DeviceAssignment* device_assignment) override;\n+\n   absl::StatusOr<std::vector<Literal>> ExecuteReplicated(\n       absl::AnyInvocable<OpaqueExecutable*(int64_t)> executable_provider,\n       absl::AnyInvocable<int64_t(int64_t)> argument_count_provider,\n       absl::AnyInvocable<const Literal*(int64_t, int64_t)> argument_provider,\n       const ReplicatedExecuteOptions& options,\n       DeviceAssignment* device_assignment) override;\n \n-  absl::StatusOr<std::vector<Literal>> ExecuteReplicated(\n-      OpaqueExecutable* executable,\n-      const HloRunnerInterface::ReplicatedExecuteOptions& options,\n-      DeviceAssignment* device_assignment);\n-\n   absl::string_view Name() const override;\n \n   int device_count() const override { return pjrt_client_->device_count(); }"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 86,
        "deletions": 9
    }
}