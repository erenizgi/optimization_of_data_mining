{
    "author": "GleasonK",
    "message": "[StableHLO optim] Fix issue in compare folder\n\nPiperOrigin-RevId: 843390028",
    "sha": "ccd3917bab768c842f017a131b222788f6b9c710",
    "files": [
        {
            "sha": "f87d4742f368783dea31dfcd2f98c428a5cf50cb",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ccd3917bab768c842f017a131b222788f6b9c710/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ccd3917bab768c842f017a131b222788f6b9c710/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=ccd3917bab768c842f017a131b222788f6b9c710",
            "patch": "@@ -703,6 +703,31 @@ diff --ruN a/stablehlo/stablehlo/tests/ops_stablehlo_roundtrip.mlir b/stablehlo/\n    func.return %0 : tensor<16x16xf32>\n  }\n  \n+diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir b/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n+--- stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n++++ stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n+@@ -218,6 +218,21 @@\n+   // CHECK-NEXT: return [[TRUE]], [[FALSE]], [[TRUE]], [[TRUE]], [[TRUE]], [[FALSE]], [[TRUE]], [[FALSE]]\n+   return %0, %1, %2, %3, %4, %5, %6, %7 :\n+          tensor<i1>, tensor<i1>, tensor<i1>, tensor<i1>, tensor<i1>, tensor<i1>, tensor<i1>, tensor<i1>\n++}\n++\n++// -----\n++\n++// CHECK-LABEL: func.func @compare_fold_with_implicit_comparison_type\n++func.func @compare_fold_with_implicit_comparison_type() -> (tensor<3xi1>, tensor<3xi1>) {\n++  %c_0 = stablehlo.constant dense<0> : tensor<3xi64>\n++  %c = stablehlo.constant dense<[-1, 0, 1]> : tensor<3xi64>\n++  %c_1 = stablehlo.constant dense<0.0> : tensor<3xf64>\n++  %c_2 = stablehlo.constant dense<[-1.0, 0.0, 1.0]> : tensor<3xf64>\n++  %0 = stablehlo.compare GE, %c, %c_0 : (tensor<3xi64>, tensor<3xi64>) -> tensor<3xi1>\n++  %1 = stablehlo.compare GE, %c_2, %c_1 : (tensor<3xf64>, tensor<3xf64>) -> tensor<3xi1>\n++  // CHECK-DAG:  [[RES:%.+]] = stablehlo.constant dense<[false, true, true]> : tensor<3xi1>\n++  // CHECK-NEXT: return [[RES]], [[RES]] : tensor<3xi1>, tensor<3xi1>\n++  return %0, %1 : tensor<3xi1>, tensor<3xi1>\n+ }\n+ \n+ // -----\n diff --ruN a/stablehlo/stablehlo/transforms/CMakeLists.txt b/stablehlo/stablehlo/transforms/CMakeLists.txt\n --- stablehlo/stablehlo/transforms/CMakeLists.txt\n +++ stablehlo/stablehlo/transforms/CMakeLists.txt\n@@ -961,4 +986,72 @@ diff --ruN a/stablehlo/stablehlo/transforms/StablehloBroadcastLowering.h b/stabl\n  // Returns the common shape these ops would broadcast to, or an error if the\n  // ops are not broadcastable.\n  FailureOr<Dimensions> getNumpyBroadcastShape(OpBuilder& builder,\n+diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp b/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp\n+--- stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp\n++++ stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp\n+@@ -701,22 +701,50 @@\n+     if (failed(validateShapeFoldDtype(rewriter, op, resultType)))\n+       return failure();\n+ \n++    ComparisonType comparisonType = getComparisonType(op);\n++    if (comparisonType == ComparisonType::NOTYPE)\n++      return rewriter.notifyMatchFailure(\n++          op, \"Could not determine comparison type.\");\n++\n++    LLVM_DEBUG(llvm::dbgs() << \"comparisonType: \" << comparisonType << \"\\n\");\n++\n+     auto res = foldBinaryOpIntOrFloat<FoldCompare, IntegerAttr, IntegerAttr>(\n+-        rewriter, op,\n+-        FoldCompare(op.getComparisonDirection(), op.getCompareType()));\n++        rewriter, op, FoldCompare(op.getComparisonDirection(), comparisonType));\n+     if (failed(res)) return failure();\n+     rewriter.replaceOpWithNewOp<mlir::stablehlo::ConstantOp>(op, res.value());\n+     return success();\n+   }\n+ \n++  // Return the comparison type if set, else return the assumed comparison type\n++  // according to the StableHLO spec.\n++  ComparisonType getComparisonType(CompareOp op) const {\n++    auto compareType = op.getCompareType();\n++    if (compareType.has_value() &&\n++        compareType.value() != ComparisonType::NOTYPE)\n++      return *compareType;\n++\n++    Type elementType = op.getLhs().getType().getElementType();\n++    if (elementType.isUnsignedInteger() || elementType.isSignlessInteger(1))\n++      return ComparisonType::UNSIGNED;\n++    if (elementType.isSignlessInteger())\n++      return ComparisonType::SIGNED;\n++    else if (elementType.isFloat() || mlir::isa<ComplexType>(elementType))\n++      return ComparisonType::FLOAT;\n++    else\n++      return ComparisonType::NOTYPE;\n++  }\n++\n+   struct FoldCompare {\n+     FoldCompare(ComparisonDirection direction,\n+-                std::optional<ComparisonType> kind)\n++                ComparisonType kind)\n+         : direction(direction), kind(kind) {}\n+     ComparisonDirection direction;\n+-    std::optional<ComparisonType> kind;\n++    ComparisonType kind;\n+ \n+     APInt operator()(APFloat lhs, APFloat rhs) {\n++      if (kind != ComparisonType::FLOAT && kind != ComparisonType::TOTALORDER)\n++        llvm::report_fatal_error(\"invalid float comparison\");\n++\n+       bool result = false;\n+       switch (direction) {\n+         case ComparisonDirection::EQ:\n+@@ -741,6 +769,9 @@\n+       return APInt(/*bitwidth=*/1, result);\n+     }\n+     APInt operator()(APInt lhs, APInt rhs) {\n++      if (kind != ComparisonType::UNSIGNED && kind != ComparisonType::SIGNED)\n++        llvm::report_fatal_error(\"invalid integer comparison\");\n++\n+       bool result = false;\n+       switch (direction) {\n+         case ComparisonDirection::EQ:\n "
        }
    ],
    "stats": {
        "total": 93,
        "additions": 93,
        "deletions": 0
    }
}