{
    "author": "tensorflower-gardener",
    "message": "[XLA:GPU] Use real profile for testing in HloOpProfilesTest\n\nPiperOrigin-RevId: 809077938",
    "sha": "0a3f7e4299fcfbbebdbbba3810c17fa613274a25",
    "files": [
        {
            "sha": "ffdc12ae65ff2b006288333e8b9b632da80d349f",
            "filename": "third_party/xla/xla/service/gpu/model/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0a3f7e4299fcfbbebdbbba3810c17fa613274a25/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0a3f7e4299fcfbbebdbbba3810c17fa613274a25/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD?ref=0a3f7e4299fcfbbebdbbba3810c17fa613274a25",
            "patch": "@@ -995,6 +995,7 @@ xla_cc_test(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/service/gpu:gpu_device_info_for_tests\",\n         \"//xla/stream_executor:device_description\",\n+        \"//xla/stream_executor/cuda:cuda_compute_capability\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "b3bd8bfd3c53950aa240855ff6d43d8265b9f01d",
            "filename": "third_party/xla/xla/service/gpu/model/hlo_op_profiler_run.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0a3f7e4299fcfbbebdbbba3810c17fa613274a25/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_run.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0a3f7e4299fcfbbebdbbba3810c17fa613274a25/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_run.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_run.cc?ref=0a3f7e4299fcfbbebdbbba3810c17fa613274a25",
            "patch": "@@ -28,6 +28,8 @@ limitations under the License.\n #include \"xla/service/hlo_runner.h\"\n #include \"xla/service/platform_util.h\"\n #include \"xla/stream_executor/device_description.h\"\n+#include \"xla/tsl/platform/env.h\"\n+#include \"xla/tsl/platform/status.h\"\n #include \"xla/tsl/util/command_line_flags.h\"\n #include \"xla/xla_data.pb.h\"\n #include \"tsl/platform/init_main.h\""
        },
        {
            "sha": "efeea0e6a0e4dff9d6b2b832bbdf2a2210e0a9a1",
            "filename": "third_party/xla/xla/service/gpu/model/hlo_op_profiles_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 3,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0a3f7e4299fcfbbebdbbba3810c17fa613274a25/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiles_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0a3f7e4299fcfbbebdbbba3810c17fa613274a25/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiles_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiles_test.cc?ref=0a3f7e4299fcfbbebdbbba3810c17fa613274a25",
            "patch": "@@ -20,14 +20,16 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/service/gpu/gpu_device_info_for_tests.h\"\n+#include \"xla/service/gpu/model/hlo_op_profiles_data.h\"\n+#include \"xla/stream_executor/cuda/cuda_compute_capability.h\"\n #include \"xla/stream_executor/device_description.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n namespace gpu {\n namespace {\n \n-constexpr char kDeviceHloOpProfiles[] = R\"pb(\n+constexpr char kDeviceHloOpProfilesTest[] = R\"pb(\n   entries {\n     key: \"sm_90\"\n     value {\n@@ -58,7 +60,7 @@ constexpr char kDeviceHloOpProfiles[] = R\"pb(\n using HloOpProfilesTest = ::testing::Test;\n \n TEST_F(HloOpProfilesTest, GetProfile) {\n-  auto hlo_op_profiles = HloOpProfiles::Load(kDeviceHloOpProfiles,\n+  auto hlo_op_profiles = HloOpProfiles::Load(kDeviceHloOpProfilesTest,\n                                              /*default_profile_name=*/\"sm_80\");\n   auto device_info_sm_90 = TestGpuDeviceInfo::RTXA6000DeviceInfo(\n       stream_executor::CudaComputeCapability(9, 0));\n@@ -72,7 +74,7 @@ TEST_F(HloOpProfilesTest, GetProfile) {\n }\n \n TEST_F(HloOpProfilesTest, GetProfileDefault) {\n-  auto hlo_op_profiles = HloOpProfiles::Load(kDeviceHloOpProfiles,\n+  auto hlo_op_profiles = HloOpProfiles::Load(kDeviceHloOpProfilesTest,\n                                              /*default_profile_name=*/\"sm_80\");\n   auto device_info_sm_85 = TestGpuDeviceInfo::RTXA6000DeviceInfo(\n       stream_executor::CudaComputeCapability(8, 5));\n@@ -86,6 +88,33 @@ TEST_F(HloOpProfilesTest, GetProfileDefault) {\n       64);\n }\n \n+TEST_F(HloOpProfilesTest, GetProfileA6000) {\n+  auto hlo_op_profiles = HloOpProfiles::Load(kDeviceHloOpProfiles,\n+                                             /*default_profile_name=*/\"sm_80\");\n+  auto device_info_sm_85 = TestGpuDeviceInfo::RTXA6000DeviceInfo(\n+      stream_executor::CudaComputeCapability(8, 5));\n+  const auto& op_profile = hlo_op_profiles->GetProfile(device_info_sm_85);\n+  ASSERT_TRUE(op_profile.contains(\n+      std::make_pair(HloOpcode::kDivide, PrimitiveType::F64)));\n+  EXPECT_EQ(\n+      op_profile.at(std::make_pair(HloOpcode::kDivide, PrimitiveType::F64)),\n+      831);\n+}\n+\n+TEST_F(HloOpProfilesTest, GetProfileH100) {\n+  auto hlo_op_profiles = HloOpProfiles::Load(kDeviceHloOpProfiles,\n+                                             /*default_profile_name=*/\"sm_100\");\n+  auto device_info_sm_85 = TestGpuDeviceInfo::RTXH100SXMDeviceInfo(\n+      stream_executor::CudaComputeCapability(9, 0));\n+\n+  const auto& op_profile = hlo_op_profiles->GetProfile(device_info_sm_85);\n+  ASSERT_TRUE(op_profile.contains(\n+      std::make_pair(HloOpcode::kMultiply, PrimitiveType::F32)));\n+  EXPECT_EQ(\n+      op_profile.at(std::make_pair(HloOpcode::kMultiply, PrimitiveType::F32)),\n+      3);\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 35,
        "deletions": 3
    }
}