{
    "author": "tensorflower-gardener",
    "message": "Merge pull request #94375 from ekalda:gatherop-folding\n\nPiperOrigin-RevId: 812780818",
    "sha": "72f8d3e26e325e669b0151d74afb3da71d50d23d",
    "files": [
        {
            "sha": "e12fc16c56a49e654f1180d6a1661452a9a6fb58",
            "filename": "tensorflow/compiler/mlir/lite/ir/tfl_ops.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72f8d3e26e325e669b0151d74afb3da71d50d23d/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72f8d3e26e325e669b0151d74afb3da71d50d23d/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.cc?ref=72f8d3e26e325e669b0151d74afb3da71d50d23d",
            "patch": "@@ -1353,6 +1353,13 @@ LogicalResult GatherOp::verify() {\n }\n \n OpFoldResult GatherOp::fold(GatherOp::FoldAdaptor adaptor) {\n+  // Don't fold when the tensor we gather from (params) has non-int/float/index\n+  // type. E.g. in case of quantized type, casting to DenseElementsAttr will\n+  // strip the quantization information and cause type mismatch problems.\n+  if (!getType().getElementType().isIntOrIndexOrFloat()) {\n+    return {};\n+  }\n+\n   // Get the params tensor type/shape/data\n   auto params = mlir::dyn_cast_or_null<DenseElementsAttr>(adaptor.getParams());\n   if (!params) {"
        },
        {
            "sha": "0b6dd410c57d9a13a589aaed1fdaf89784311df7",
            "filename": "tensorflow/compiler/mlir/tosa/tests/tfl-to-tosa-pipeline.mlir",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72f8d3e26e325e669b0151d74afb3da71d50d23d/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftests%2Ftfl-to-tosa-pipeline.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72f8d3e26e325e669b0151d74afb3da71d50d23d/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftests%2Ftfl-to-tosa-pipeline.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftests%2Ftfl-to-tosa-pipeline.mlir?ref=72f8d3e26e325e669b0151d74afb3da71d50d23d",
            "patch": "@@ -3416,7 +3416,16 @@ func.func @test_gather_cast(%arg0: tensor<13x21x3xf32>, %arg1: tensor<7x7xi64>)\n }\n \n // -----\n+// CHECK-LABEL: test_gather_dont_fold_quantized\n+// CHECK: tosa.gather\n+func.func @test_gather_dont_fold_quantized() -> tensor<4x4x4x!quant.uniform<i8:f32, 0.1026>> {\n+  %0 = \"tfl.pseudo_qconst\"() <{qtype = tensor<4x3x!quant.uniform<i8:f32, 0.1026>>, value = dense<[[1, 2, 3], [4, 5, 6], [7, 8, 9], [10, 11, 12]]> : tensor<4x3xi8>}> : () -> tensor<4x3x!quant.uniform<i8:f32, 0.1026>>\n+  %1 = \"tfl.pseudo_const\"() <{value = dense<[[0, 1, 2, 0], [2, 1, 0, 2], [1, 0, 2, 1], [0, 2, 1, 0]]> : tensor<4x4xi32>}> : () -> tensor<4x4xi32>\n+  %2 = \"tfl.gather\"(%0, %1) <{axis = 1 : i32, batch_dims = 0 : i32}> : (tensor<4x3x!quant.uniform<i8:f32, 0.1026>>, tensor<4x4xi32>) -> tensor<4x4x4x!quant.uniform<i8:f32, 0.1026>>\n+  func.return %2 : tensor<4x4x4x!quant.uniform<i8:f32, 0.1026>>\n+}\n \n+// -----\n // CHECK-LABEL: test_sparse_to_dense\n // CHECK-DAG: %[[CONST0:.*]] = tosa.const_shape {values = dense<[1, -1, 1]> : tensor<3xindex>} : () -> !tosa.shape<3>\n // CHECK-DAG: %[[CONST1:.*]] = tosa.const_shape {values = dense<[1, -1]> : tensor<2xindex>} : () -> !tosa.shape<2>"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 16,
        "deletions": 0
    }
}