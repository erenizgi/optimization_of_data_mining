{
    "author": "jimlinntu",
    "message": "Always copies `tstring` when in `tf.concat` to avoid use-after-free as the upstream `src` tstring can be of `view` type\n\nPiperOrigin-RevId: 814001901",
    "sha": "2635bb3c44a56a92d65aa070da8a07059a3a37d6",
    "files": [
        {
            "sha": "6cc8e464406ea7d5ffdef8ce5eea50fc60f12b11",
            "filename": "tensorflow/core/kernels/BUILD",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2635bb3c44a56a92d65aa070da8a07059a3a37d6/tensorflow%2Fcore%2Fkernels%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2635bb3c44a56a92d65aa070da8a07059a3a37d6/tensorflow%2Fcore%2Fkernels%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2FBUILD?ref=2635bb3c44a56a92d65aa070da8a07059a3a37d6",
            "patch": "@@ -276,6 +276,7 @@ tf_kernel_library(\n         \"//tensorflow/core:framework\",\n         \"//tensorflow/core:framework_internal\",\n         \"//tensorflow/core/framework:bounds_check\",\n+        \"//tensorflow/core/platform:tstring\",\n         \"@eigen_archive//:eigen3\",\n     ],\n     alwayslink = 0,\n@@ -1746,14 +1747,22 @@ tf_cc_test(\n         \":concat_op\",\n         \":ops_testutil\",\n         \":ops_util\",\n+        \"//tensorflow/cc:cc_ops\",\n+        \"//tensorflow/cc:client_session\",\n+        \"//tensorflow/cc:math_ops\",\n+        \"//tensorflow/cc:ops\",\n+        \"//tensorflow/cc:scope\",\n+        \"//tensorflow/cc:testutil\",\n         \"//tensorflow/core:core_cpu\",\n         \"//tensorflow/core:framework\",\n-        \"//tensorflow/core:lib\",\n+        \"//tensorflow/core:lib_headers_for_pybind\",\n         \"//tensorflow/core:protos_all_cc\",\n         \"//tensorflow/core:test\",\n         \"//tensorflow/core:test_main\",\n         \"//tensorflow/core:testlib\",\n+        \"//tensorflow/core/platform:tstring\",\n         \"@com_google_absl//absl/base:prefetch\",\n+        \"@com_google_googletest//:gtest\",\n     ],\n )\n "
        },
        {
            "sha": "81a928587dda2754f288b3fde33090d9e6d3d832",
            "filename": "tensorflow/core/kernels/concat_lib_cpu.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2635bb3c44a56a92d65aa070da8a07059a3a37d6/tensorflow%2Fcore%2Fkernels%2Fconcat_lib_cpu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2635bb3c44a56a92d65aa070da8a07059a3a37d6/tensorflow%2Fcore%2Fkernels%2Fconcat_lib_cpu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fconcat_lib_cpu.cc?ref=2635bb3c44a56a92d65aa070da8a07059a3a37d6",
            "patch": "@@ -17,10 +17,12 @@ limitations under the License.\n \n #include \"tensorflow/core/kernels/concat_lib_cpu.h\"\n \n+#include <cstddef>\n #include <vector>\n \n #include \"tensorflow/core/framework/register_types.h\"\n #include \"tensorflow/core/kernels/concat_lib.h\"\n+#include \"tensorflow/core/platform/tstring.h\"\n \n namespace tensorflow {\n \n@@ -37,6 +39,29 @@ struct MemCpyCopier {\n     }\n   }\n };\n+\n+// Specializes `tstring` copy is required here because `tstring` can be of\n+// view-type. This means that the underlying `tstring` lifetime cannot be\n+// controlled by this operation.\n+// For example, if `*src` is a view from a `Tensor` and we invoke\n+// the default copy constructor here to shallow copy `*src` to `*dst`, but later\n+// `Tensor` that owns `*src` is freed, we will be in use-after-free trouble.\n+// Therefore, we should always copy `tstring` here to avoid use-after-free\n+// due to `tstring` view type. This also matches the semantic of `MemCpyCopier`\n+// to always copy data from upstream.\n+template <>\n+struct MemCpyCopier<tstring> {\n+  inline void Copy(tstring* dst, const tstring* src, int input_index,\n+                   size_t n) {\n+    for (size_t k = 0; k < n; ++k) {\n+      // Copies `src` to `cpy` to decouple the lifetime from the original\n+      // `src` string which can be potentially a `view`.\n+      (*dst++).assign(src->data(), src->size());\n+      src++;\n+    }\n+  }\n+};\n+\n template <>\n struct MemCpyCopier<ResourceHandle> {\n   inline void Copy(ResourceHandle* dst, const ResourceHandle* src,"
        },
        {
            "sha": "5e70d7cb6bbb8921d19fb02295688fb0465a6822",
            "filename": "tensorflow/core/kernels/concat_op_test.cc",
            "status": "modified",
            "additions": 91,
            "deletions": 3,
            "changes": 94,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2635bb3c44a56a92d65aa070da8a07059a3a37d6/tensorflow%2Fcore%2Fkernels%2Fconcat_op_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2635bb3c44a56a92d65aa070da8a07059a3a37d6/tensorflow%2Fcore%2Fkernels%2Fconcat_op_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fconcat_op_test.cc?ref=2635bb3c44a56a92d65aa070da8a07059a3a37d6",
            "patch": "@@ -17,24 +17,31 @@ limitations under the License.\n #include <memory>\n #include <vector>\n \n+#include <gtest/gtest.h>\n #include \"absl/base/prefetch.h\"\n+#include \"tensorflow/cc/client/client_session.h\"\n+#include \"tensorflow/cc/framework/ops.h\"\n+#include \"tensorflow/cc/framework/scope.h\"\n+#include \"tensorflow/cc/ops/array_ops.h\"\n+#include \"tensorflow/cc/ops/const_op.h\"\n #include \"tensorflow/core/common_runtime/kernel_benchmark_testlib.h\"\n #include \"tensorflow/core/framework/allocator.h\"\n #include \"tensorflow/core/framework/op_kernel.h\"\n #include \"tensorflow/core/framework/tensor.h\"\n+#include \"tensorflow/core/framework/tensor_shape.h\"\n #include \"tensorflow/core/framework/types.h\"\n #include \"tensorflow/core/framework/types.pb.h\"\n #include \"tensorflow/core/graph/node_builder.h\"\n #include \"tensorflow/core/graph/testlib.h\"\n-#include \"tensorflow/core/kernels/ops_testutil.h\"\n-#include \"tensorflow/core/kernels/ops_util.h\"\n #include \"tensorflow/core/lib/core/status_test_util.h\"\n #include \"tensorflow/core/platform/test.h\"\n-#include \"tensorflow/core/platform/test_benchmark.h\"\n+#include \"tensorflow/core/platform/tstring.h\"\n \n namespace tensorflow {\n namespace {\n \n+using tensorflow::tstring;\n+\n template <typename T>\n void FillTensorWithRandomValues(Tensor* t, int string_length, int64_t* bytes) {\n   t->flat<T>().setRandom();\n@@ -184,6 +191,87 @@ static void ConcatManyHelper(::testing::benchmark::State& state,\n                           dim2 * kNumInputs * sizeof(T));\n }\n \n+TEST(ConcatOnTStringTest, TestTStringsAreDeepCopied) {\n+  // 1. Create a new graph scope.\n+  tensorflow::Scope root = tensorflow::Scope::NewRootScope();\n+\n+  // 2. Define input placeholders.\n+  auto input1 =\n+      tensorflow::ops::Placeholder(root.WithOpName(\"input1\"), DT_STRING,\n+                                   ops::Placeholder::Shape({\n+                                       2,\n+                                   }));\n+  auto input2 =\n+      tensorflow::ops::Placeholder(root.WithOpName(\"input2\"), DT_STRING,\n+                                   ops::Placeholder::Shape({\n+                                       2,\n+                                   }));\n+\n+  // 3. Define the axis for concatenation. Concatenates over the first dimension\n+  auto axis = ops::Const(root.WithOpName(\"axis\"), {0});\n+\n+  // 4. Add the ConcatV2 operation.\n+  std::vector<Output> inputs = {input1, input2};\n+  auto concat_op =\n+      tensorflow::ops::Concat(root.WithOpName(\"my_concat\"), inputs, axis);\n+\n+  // 5. Create a session and run the graph (example)\n+  ClientSession session(root);\n+  std::vector<tstring> owned_tstrings = {\"abc\", \"def\", \"ghi\", \"jkl\"};\n+\n+  // 6. Create view-typed `tstring` for checking data content are deep-copied.\n+  tstring first_element;\n+  first_element.assign_as_view(owned_tstrings[0]);\n+\n+  tstring second_element;\n+  second_element.assign_as_view(owned_tstrings[1]);\n+\n+  tstring third_element;\n+  third_element.assign_as_view(owned_tstrings[2]);\n+\n+  tstring fourth_element;\n+  fourth_element.assign_as_view(owned_tstrings[3]);\n+\n+  Tensor t1(DT_STRING, TensorShape({\n+                           2,\n+                       }));\n+\n+  t1.flat<tstring>().setValues({first_element, second_element});\n+  Tensor t2(DT_STRING, TensorShape({\n+                           2,\n+                       }));\n+  t2.flat<tstring>().setValues({third_element, fourth_element});\n+\n+  std::vector<Tensor> outputs;\n+\n+  TF_ASSERT_OK(\n+      session.Run({{input1, t1}, {input2, t2}}, {concat_op.output}, &outputs));\n+\n+  ASSERT_EQ(outputs.size(), 1);\n+\n+  Tensor& output = outputs[0];\n+\n+  EXPECT_EQ(output.flat<tstring>()(0), tstring(\"abc\"));\n+  EXPECT_EQ(output.flat<tstring>()(1), tstring(\"def\"));\n+  EXPECT_EQ(output.flat<tstring>()(2), tstring(\"ghi\"));\n+  EXPECT_EQ(output.flat<tstring>()(3), tstring(\"jkl\"));\n+\n+  // 7. Mutates the upstream `owned_tstrings` should not change the output\n+  //    because Concat should always deep copy the data content even when\n+  //    the input `tstring` are of view type. This is served as a guardrail to\n+  //    simulate use-after-free scenario when upstream `tstring` is freed but we\n+  //    still want to manipulate downstream output.\n+  owned_tstrings[0].mdata()[0] = 'q';\n+  owned_tstrings[1].mdata()[0] = 'z';\n+  owned_tstrings[2].mdata()[0] = 'x';\n+  owned_tstrings[3].mdata()[0] = 'y';\n+\n+  EXPECT_EQ(output.flat<tstring>()(0), tstring(\"abc\"));\n+  EXPECT_EQ(output.flat<tstring>()(1), tstring(\"def\"));\n+  EXPECT_EQ(output.flat<tstring>()(2), tstring(\"ghi\"));\n+  EXPECT_EQ(output.flat<tstring>()(3), tstring(\"jkl\"));\n+}\n+\n void BM_ConcatManyDim1bfloat16(::testing::benchmark::State& state) {\n   const int dim2 = state.range(0);\n "
        }
    ],
    "stats": {
        "total": 130,
        "additions": 126,
        "deletions": 4
    }
}