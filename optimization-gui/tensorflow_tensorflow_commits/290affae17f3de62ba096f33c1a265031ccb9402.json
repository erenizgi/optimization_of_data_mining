{
    "author": "tensorflower-gardener",
    "message": "[XLA:GPU]: Add triton_xla.get_rank operation.\n\nThis operation allows to determine the number of participant device on multi-device kernel. Under the hood it's a simple load operation which knows the structure living under the multi-device metadata pointer.\n\nPiperOrigin-RevId: 810025446",
    "sha": "290affae17f3de62ba096f33c1a265031ccb9402",
    "files": [
        {
            "sha": "04bf6d71e34f7e3a25c22b7f62bb0b707c535e94",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/ir/triton_xla_ops.td",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fir%2Ftriton_xla_ops.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fir%2Ftriton_xla_ops.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fir%2Ftriton_xla_ops.td?ref=290affae17f3de62ba096f33c1a265031ccb9402",
            "patch": "@@ -389,5 +389,15 @@ def TTXLA_BlockBarrierOp : TTXLA_Op<\"block_barrier\", []> {\n   }];\n }\n \n+def TTXLA_GetRankOp : TTXLA_Op<\"get_rank\", [Pure]> {\n+  let summary = \"Extract the device rank from the collectives metadata.\";\n+  let arguments = (ins\n+    Arg<TT_PtrLike, \"\",\n+      [MemRead<GlobalMemory>]>:$metadata);\n+  let results = (outs I64:$result);\n+  let assemblyFormat = \"$metadata attr-dict `:` type($metadata) `->` type($result)\";\n+}\n+\n+\n #endif // XLA_BACKENDS_GPU_CODEGEN_TRITON_IR_TRITON_XLA_OPS_TD_\n "
        },
        {
            "sha": "219a74aeca68bf147a03f583ebdeffcf171f915f",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2FBUILD?ref=290affae17f3de62ba096f33c1a265031ccb9402",
            "patch": "@@ -41,6 +41,7 @@ cc_library(\n         \"triton_xla_lower_atomics_pass.cc\",\n         \"triton_xla_lower_block_barrier_pass.cc\",\n         \"triton_xla_lower_get_tid_pass.cc\",\n+        \"triton_xla_lower_remote_access_pass.cc\",\n         \"triton_xla_squeeze_dims_pass.cc\",\n     ],\n     hdrs = [\"passes.h\"],"
        },
        {
            "sha": "32c3fc939779b43c9f2a72018faaca5b66c8a0a5",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/passes.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.h?ref=290affae17f3de62ba096f33c1a265031ccb9402",
            "patch": "@@ -43,6 +43,7 @@ std::unique_ptr<mlir::Pass> CreateTritonXLALowerGetTidPass();\n std::unique_ptr<mlir::Pass> CreateTritonXLALowerAtomicsPass();\n std::unique_ptr<mlir::Pass> CreateTritonXLALowerBlockBarrierPass();\n std::unique_ptr<mlir::Pass> CreateTritonXLAConvertUnsupportedTypesPass();\n+std::unique_ptr<mlir::Pass> CreateTritonXLALowerRemoteAccessPass();\n \n // Returns true if the `op` contains an operation in it's regions that satisfies\n // the `fn`."
        },
        {
            "sha": "b29e75cd26e10804fc4ac08c603ef4b33c3a7f21",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/passes.td",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.td?ref=290affae17f3de62ba096f33c1a265031ccb9402",
            "patch": "@@ -164,4 +164,13 @@ def TritonXLAConvertUnsupportedTypesPass\n   let constructor = \"CreateTritonXLAConvertUnsupportedTypesPass()\";\n }\n \n+def TritonXLALowerRemoteAccessPass\n+    : Pass<\"triton-xla-remote-access\", \"mlir::ModuleOp\"> {\n+  let summary = \"Lower triton_xla.get_rank/get_peer operations used to remote access kernels.\";\n+  let description = [{\n+    This pass lowers collective operations (get_rank, get_peer).\n+  }];\n+  let constructor = \"CreateTritonXLALowerRemoteAccessPass()\";\n+}\n+\n #endif  // XLA_BACKENDS_GPU_CODEGEN_TRITON_PASSES_TD_"
        },
        {
            "sha": "b861191196c9f3ef9f464172370342a756297b29",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/tests/triton_xla_remote_access.mlir",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftests%2Ftriton_xla_remote_access.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftests%2Ftriton_xla_remote_access.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftests%2Ftriton_xla_remote_access.mlir?ref=290affae17f3de62ba096f33c1a265031ccb9402",
            "patch": "@@ -0,0 +1,12 @@\n+// RUN: xla-opt %s --triton-xla-remote-access | FileCheck %s\n+\n+// CHECK-LABEL: module {\n+// CHECK-LABEL: tt.func @get_rank(%arg0: !tt.ptr<i64>) -> i64 {\n+tt.func @get_rank(\n+  %metadata: !tt.ptr<i64>\n+) -> (i64) {\n+  // CHECK-NOT: triton_xla.get_rank\n+  // CHECK: %0 = tt.load %arg0 : !tt.ptr<i64>\n+  %rank = triton_xla.get_rank %metadata : !tt.ptr<i64> -> i64\n+  tt.return %rank : i64\n+}"
        },
        {
            "sha": "c35f35b4bfa5097da69dcc82ca40b3ad4336416b",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/triton_xla_lower_remote_access_pass.cc",
            "status": "added",
            "additions": 91,
            "deletions": 0,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftriton_xla_lower_remote_access_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/290affae17f3de62ba096f33c1a265031ccb9402/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftriton_xla_lower_remote_access_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftriton_xla_lower_remote_access_pass.cc?ref=290affae17f3de62ba096f33c1a265031ccb9402",
            "patch": "@@ -0,0 +1,91 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include <memory>\n+#include <utility>\n+\n+#include \"mlir/IR/Builders.h\"\n+#include \"mlir/IR/PatternMatch.h\"\n+#include \"mlir/IR/Types.h\"\n+#include \"mlir/IR/Value.h\"\n+#include \"mlir/Pass/Pass.h\"\n+#include \"mlir/Support/LLVM.h\"\n+#include \"mlir/Support/LogicalResult.h\"\n+#include \"mlir/Transforms/GreedyPatternRewriteDriver.h\"\n+#include \"xla/backends/gpu/codegen/triton/ir/triton_xla_ops.h\"\n+#include \"triton/Dialect/Triton/IR/Dialect.h\"\n+#include \"triton/Dialect/Triton/IR/Types.h\"\n+\n+namespace mlir::triton::xla {\n+\n+#define GEN_PASS_DEF_TRITONXLALOWERREMOTEACCESSPASS\n+#include \"xla/backends/gpu/codegen/triton/transforms/passes.h.inc\"\n+\n+namespace {\n+LogicalResult LowerGetRankOp(GetRankOp get_rank, PatternRewriter& rewriter) {\n+  mlir::OpBuilder::InsertionGuard guard(rewriter);\n+  rewriter.setInsertionPoint(get_rank);\n+\n+  mlir::Value metadata = get_rank.getMetadata();\n+  auto metadata_type = dyn_cast<mlir::triton::PointerType>(metadata.getType());\n+  if (!metadata_type) {\n+    return rewriter.notifyMatchFailure(get_rank, \"Metadata is not a pointer\");\n+  }\n+\n+  mlir::Type expectedResultType = metadata_type.getPointeeType();\n+  if (get_rank->getResult(0).getType() != expectedResultType) {\n+    return rewriter.notifyMatchFailure(\n+        get_rank, \"Call result type must match the pointer's element type\");\n+  }\n+\n+  // The rank id is stored as a first element under the metadata pointer.\n+  // The structure of the metadata is defined in\n+  // `xla::gpu::CollectiveKernelMetadata`.\n+  mlir::Value loadOp = rewriter.create<mlir::triton::LoadOp>(\n+      get_rank.getLoc(), expectedResultType, metadata,\n+      /*mask=*/nullptr, /*other=*/nullptr, /*boundaryCheck=*/nullptr,\n+      /*padding=*/nullptr,\n+      mlir::triton::CacheModifierAttr::get(get_rank.getContext(),\n+                                           mlir::triton::CacheModifier::NONE),\n+      mlir::triton::EvictionPolicyAttr::get(\n+          get_rank.getContext(), mlir::triton::EvictionPolicy::NORMAL),\n+      /*isVolatile=*/rewriter.getBoolAttr(false));\n+  rewriter.replaceOp(get_rank, loadOp);\n+  return success();\n+}\n+\n+class TritonXLALowerRemoteAccessPass\n+    : public impl::TritonXLALowerRemoteAccessPassBase<\n+          TritonXLALowerRemoteAccessPass> {\n+ public:\n+  using Base::Base;\n+\n+ private:\n+  void runOnOperation() override {\n+    RewritePatternSet patterns(&getContext());\n+    patterns.add(LowerGetRankOp);\n+    if (failed(applyPatternsGreedily(getOperation(), std::move(patterns)))) {\n+      return signalPassFailure();\n+    }\n+  }\n+};\n+\n+}  // namespace\n+\n+std::unique_ptr<Pass> CreateTritonXLALowerRemoteAccessPass() {\n+  return std::make_unique<TritonXLALowerRemoteAccessPass>();\n+}\n+\n+}  // namespace mlir::triton::xla"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 124,
        "deletions": 0
    }
}