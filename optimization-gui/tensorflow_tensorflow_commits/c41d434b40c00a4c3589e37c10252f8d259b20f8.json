{
    "author": "ezhulenev",
    "message": "[xla:ffi] Relax the check for number of args and rets if handler doesn't bind any of them\n\nPiperOrigin-RevId: 839898404",
    "sha": "c41d434b40c00a4c3589e37c10252f8d259b20f8",
    "files": [
        {
            "sha": "68fdbb96ccc3755583fd5e77b500dae32476ee7b",
            "filename": "third_party/xla/xla/ffi/api/api.h",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c41d434b40c00a4c3589e37c10252f8d259b20f8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c41d434b40c00a4c3589e37c10252f8d259b20f8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h?ref=c41d434b40c00a4c3589e37c10252f8d259b20f8",
            "patch": "@@ -1719,7 +1719,11 @@ class Handler : public Ffi {\n                    call_frame->args.size));\n       }\n     } else {\n-      if (XLA_FFI_PREDICT_FALSE(call_frame->args.size != kNumArgs)) {\n+      // It is safe to not theck the number of arguments if we don't plan to\n+      // decode any of them, i.e. for prepare/initialize stages where the FFI\n+      // handler might be interested only in the attributes or context.\n+      if (XLA_FFI_PREDICT_FALSE(call_frame->args.size != kNumArgs &&\n+                                kNumArgs > 0)) {\n         return InvalidArgument(\n             call_frame->api,\n             StrCat(\"[\", call_frame->stage, \"] \",\n@@ -1749,7 +1753,11 @@ class Handler : public Ffi {\n                    call_frame->rets.size));\n       }\n     } else {\n-      if (XLA_FFI_PREDICT_FALSE(call_frame->rets.size != kNumRets)) {\n+      // It is safe to not theck the number of results if we don't plan to\n+      // decode any of them, i.e. for prepare/initialize stages where the FFI\n+      // handler might be interested only in the attributes or context.\n+      if (XLA_FFI_PREDICT_FALSE(call_frame->rets.size != kNumRets &&\n+                                kNumRets > 0)) {\n         return InvalidArgument(\n             call_frame->api,\n             StrCat(\"[\", call_frame->stage, \"] \","
        },
        {
            "sha": "62c74b0e325f8fed2bf561f4b2a3d0b74e1c7fee",
            "filename": "third_party/xla/xla/tests/collective_ops_ffi_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c41d434b40c00a4c3589e37c10252f8d259b20f8/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_ffi_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c41d434b40c00a4c3589e37c10252f8d259b20f8/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_ffi_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_ffi_test.cc?ref=c41d434b40c00a4c3589e37c10252f8d259b20f8",
            "patch": "@@ -60,7 +60,6 @@ static ReplicaGroup AllDevices() {\n // should be acquired before the execution starts. All collective operations\n // must let XLA:GPU runtime know what cliques they need ahead of time.\n static absl::Status PrepareAllReduce(\n-    ffi::RemainingArgs, ffi::RemainingRets,\n     const CollectiveParams* collective_params,\n     CollectiveCliqueRequests* clique_requests) {\n   TF_RET_CHECK(collective_params && clique_requests);\n@@ -109,8 +108,6 @@ static absl::Status AllReduce(se::Stream* stream, ffi::BufferR0<U32> src,\n \n XLA_FFI_DEFINE_HANDLER(kPrepareAllReduce, PrepareAllReduce,\n                        ffi::Ffi::BindPrepare()\n-                           .RemainingArgs()\n-                           .RemainingRets()\n                            .Ctx<ffi::CollectiveParams>()\n                            .Ctx<ffi::CollectiveCliqueRequests>());\n "
        }
    ],
    "stats": {
        "total": 15,
        "additions": 10,
        "deletions": 5
    }
}