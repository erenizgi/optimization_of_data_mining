{
    "author": "khasanovaa",
    "message": "Add support for missing thunks to `DeserializeThunkProto`.\n\nI looked through thunks that already have deserialization implemented but were forgotten and not added to `DeserializeThunkProto` (mostly by me!);\n\nAdded `kHostExecuteStartThunk`, `kHostExecuteDoneThunk`, `kOutfeedThunk`, `kCholeskyThunk`.\n\n* I introduced *Impl function to handle `async_events_map`. This map is used to match pairs of `HostExecute[Start/Done]Thunks` during the deserialization process. It is intended to be empty at the first entry of this function, and will be populated during reccursive calls.\n* I changed annotation of `CholeskyThunk` to get platform_name as an argument instead of Platform& to move the platform resolution inside the `CholeskyThunk::FromProto` method\n\nPiperOrigin-RevId: 830822275",
    "sha": "569574f52399dc560559d357e4d6139d62bc864f",
    "files": [
        {
            "sha": "f1ab60fc9db17fef8e22f3f43761fa7acb5ca749",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=569574f52399dc560559d357e4d6139d62bc864f",
            "patch": "@@ -321,6 +321,7 @@ cc_library(\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/service:buffer_assignment\",\n+        \"//xla/service:platform_util\",\n         \"//xla/stream_executor:blas\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:gpu_solver_context\",\n@@ -335,6 +336,7 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:str_format\",\n+        \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n     ],\n )\n@@ -2575,6 +2577,7 @@ cc_library(\n     srcs = [\"thunk_proto_deserialization.cc\"],\n     hdrs = [\"thunk_proto_deserialization.h\"],\n     deps = [\n+        \":cholesky_thunk\",\n         \":conditional_thunk\",\n         \":convolution_reorder_thunk\",\n         \":convolution_thunk\",\n@@ -2586,10 +2589,12 @@ cc_library(\n         \":fft_thunk\",\n         \":gemm_thunk\",\n         \":gpublas_lt_matmul_thunk\",\n+        \":host_execute_thunk\",\n         \":infeed_thunk\",\n         \":kernel_thunk\",\n         \":memset_thunk\",\n         \":norm_thunk\",\n+        \":outfeed_thunk\",\n         \":replica_id_thunk\",\n         \":sequential_thunk\",\n         \":thunk\",\n@@ -2617,6 +2622,7 @@ xla_cc_test(\n     deps = [\n         \":conditional_thunk\",\n         \":copy_thunk\",\n+        \":host_execute_thunk\",\n         \":sequential_thunk\",\n         \":thunk\",\n         \":thunk_proto_cc\","
        },
        {
            "sha": "0785a5a30969188a63303ba88e47b0d6cbe7afee",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cholesky_thunk.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.cc?ref=569574f52399dc560559d357e4d6139d62bc864f",
            "patch": "@@ -26,10 +26,12 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_format.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/backends/gpu/runtime/make_batch_pointers.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/service/platform_util.h\"\n #include \"xla/stream_executor/blas.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/gpu_solver_context.h\"\n@@ -202,7 +204,9 @@ absl::StatusOr<ThunkProto> CholeskyThunk::ToProto() const {\n absl::StatusOr<std::unique_ptr<CholeskyThunk>> CholeskyThunk::FromProto(\n     ThunkInfo thunk_info, const CholeskyThunkProto& proto,\n     absl::Span<const BufferAllocation> allocations,\n-    const stream_executor::Platform& platform) {\n+    absl::string_view platform_name) {\n+  TF_ASSIGN_OR_RETURN(se::Platform * platform,\n+                      PlatformUtil::GetPlatform(platform_name));\n   TF_ASSIGN_OR_RETURN(\n       BufferAllocation::Slice a_buffer,\n       BufferAllocation::Slice::FromProto(proto.a_buffer(), allocations));\n@@ -217,7 +221,8 @@ absl::StatusOr<std::unique_ptr<CholeskyThunk>> CholeskyThunk::FromProto(\n           absl::StatusOr<std::unique_ptr<stream_executor::GpuSolverContext>>()>\n           solver_creator,\n       stream_executor::PlatformObjectRegistry::GetGlobalRegistry()\n-          .FindObject<stream_executor::GpuSolverContextFactory>(platform.id()));\n+          .FindObject<stream_executor::GpuSolverContextFactory>(\n+              platform->id()));\n   return std::make_unique<CholeskyThunk>(\n       thunk_info, proto.options(), a_buffer, workspace_buffer, info_buffer,\n       proto.type(), proto.batch_size(), proto.n(), solver_creator);"
        },
        {
            "sha": "68a5426bfc9e39aa113303c564f474e6f895d3ff",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cholesky_thunk.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk.h?ref=569574f52399dc560559d357e4d6139d62bc864f",
            "patch": "@@ -22,14 +22,14 @@ limitations under the License.\n #include \"absl/functional/any_invocable.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/stream_executor/blas.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/gpu_solver_context.h\"\n-#include \"xla/stream_executor/platform.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -47,7 +47,7 @@ class CholeskyThunk : public Thunk {\n   static absl::StatusOr<std::unique_ptr<CholeskyThunk>> FromProto(\n       ThunkInfo thunk_info, const CholeskyThunkProto& proto,\n       absl::Span<const BufferAllocation> allocations,\n-      const stream_executor::Platform& platform);\n+      absl::string_view platform_name);\n \n   CholeskyThunk(\n       ThunkInfo thunk_info, const CholeskyOptions& options,"
        },
        {
            "sha": "283621cdfd883bc477825a133bda39429d9c3758",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cholesky_thunk_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcholesky_thunk_test.cc?ref=569574f52399dc560559d357e4d6139d62bc864f",
            "patch": "@@ -69,7 +69,8 @@ TEST_F(CholeskyThunkTest, ProtoRoundTrip) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       std::unique_ptr<CholeskyThunk> round_trip_thunk,\n       CholeskyThunk::FromProto(thunk.thunk_info(), proto.cholesky_thunk(),\n-                               buffer_allocations, *backend().platform()));\n+                               buffer_allocations,\n+                               backend().platform()->Name()));\n \n   EXPECT_THAT(round_trip_thunk->ToProto(), IsOkAndHolds(EqualsProto(proto)));\n }"
        },
        {
            "sha": "a436a66cb2eb73ee03af419f3b36eeacf3712292",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_proto_deserialization.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 11,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc?ref=569574f52399dc560559d357e4d6139d62bc864f",
            "patch": "@@ -28,6 +28,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"google/protobuf/descriptor.h\"\n #include \"google/protobuf/message.h\"\n+#include \"xla/backends/gpu/runtime/cholesky_thunk.h\"\n #include \"xla/backends/gpu/runtime/conditional_thunk.h\"\n #include \"xla/backends/gpu/runtime/convolution_reorder_thunk.h\"\n #include \"xla/backends/gpu/runtime/convolution_thunk.h\"\n@@ -39,10 +40,12 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/fft_thunk.h\"\n #include \"xla/backends/gpu/runtime/gemm_thunk.h\"\n #include \"xla/backends/gpu/runtime/gpublas_lt_matmul_thunk.h\"\n+#include \"xla/backends/gpu/runtime/host_execute_thunk.h\"\n #include \"xla/backends/gpu/runtime/infeed_thunk.h\"\n #include \"xla/backends/gpu/runtime/kernel_thunk.h\"\n #include \"xla/backends/gpu/runtime/memset_thunk.h\"\n #include \"xla/backends/gpu/runtime/norm_thunk.h\"\n+#include \"xla/backends/gpu/runtime/outfeed_thunk.h\"\n #include \"xla/backends/gpu/runtime/replica_id_thunk.h\"\n #include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n@@ -56,6 +59,8 @@ limitations under the License.\n \n namespace xla::gpu {\n \n+namespace {\n+\n static std::optional<absl::string_view> GetStoredThunkTypeName(\n     const ThunkProto& proto) {\n   const tsl::protobuf::Descriptor* descriptor = proto.GetDescriptor();\n@@ -74,18 +79,20 @@ static std::optional<absl::string_view> GetStoredThunkTypeName(\n   return field_descriptor->name();\n }\n \n-absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n+absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProtoImpl(\n     const ThunkProto& thunk_proto,\n     absl::Span<const BufferAllocation> buffer_allocations,\n-    const HloModule* absl_nullable hlo_module,\n-    absl::string_view platform_name) {\n+    const HloModule* absl_nullable hlo_module, absl::string_view platform_name,\n+    HostExecuteAsyncEventsMap& host_executable_async_events_map) {\n   TF_ASSIGN_OR_RETURN(Thunk::ThunkInfo thunk_info,\n                       Thunk::ThunkInfo::FromProto(thunk_proto.thunk_info()));\n-  auto deserializer = [&buffer_allocations, &hlo_module,\n-                       &platform_name](const ThunkProto& thunk_proto) {\n-    return DeserializeThunkProto(thunk_proto, buffer_allocations, hlo_module,\n-                                 platform_name);\n-  };\n+  auto deserializer =\n+      [&buffer_allocations, &hlo_module, &platform_name,\n+       &host_executable_async_events_map](const ThunkProto& thunk_proto) {\n+        return DeserializeThunkProtoImpl(thunk_proto, buffer_allocations,\n+                                         hlo_module, platform_name,\n+                                         host_executable_async_events_map);\n+      };\n \n   switch (thunk_proto.impl_case()) {\n     case ThunkProto::kSequentialThunk: {\n@@ -173,11 +180,12 @@ absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n           buffer_allocations);\n     case ThunkProto::kDynamicSliceThunk: {\n       auto deserializer =\n-          [hlo_module, platform_name](\n+          [hlo_module, platform_name, &host_executable_async_events_map](\n               const ThunkProto& thunk_proto,\n               absl::Span<const BufferAllocation> custom_allocations) {\n-            return DeserializeThunkProto(thunk_proto, custom_allocations,\n-                                         hlo_module, platform_name);\n+            return DeserializeThunkProtoImpl(thunk_proto, custom_allocations,\n+                                             hlo_module, platform_name,\n+                                             host_executable_async_events_map);\n           };\n       return DynamicSliceThunk::FromProto(std::move(thunk_info),\n                                           thunk_proto.dynamic_slice_thunk(),\n@@ -191,6 +199,23 @@ absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n       return CubSortThunk::FromProto(std::move(thunk_info),\n                                      thunk_proto.cub_sort_thunk(),\n                                      buffer_allocations, platform_name);\n+    case ThunkProto::kHostExecuteStartThunk:\n+      return HostExecuteStartThunk::FromProto(\n+          std::move(thunk_info), thunk_proto.host_execute_start_thunk(),\n+          buffer_allocations, host_executable_async_events_map);\n+    case ThunkProto::kHostExecuteDoneThunk:\n+      return HostExecuteDoneThunk::FromProto(\n+          std::move(thunk_info), thunk_proto.host_execute_done_thunk(),\n+          buffer_allocations, host_executable_async_events_map);\n+    case ThunkProto::kOutfeedThunk:\n+      return OutfeedThunk::FromProto(std::move(thunk_info),\n+                                     thunk_proto.outfeed_thunk(),\n+                                     buffer_allocations);\n+    case ThunkProto::kCholeskyThunk:\n+      return CholeskyThunk::FromProto(std::move(thunk_info),\n+                                      thunk_proto.cholesky_thunk(),\n+                                      buffer_allocations, platform_name);\n+\n     default:\n       std::optional<absl::string_view> unsupported_thunk_type =\n           GetStoredThunkTypeName(thunk_proto);\n@@ -208,4 +233,17 @@ absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n   }\n }\n \n+}  // namespace\n+\n+absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n+    const ThunkProto& thunk_proto,\n+    absl::Span<const BufferAllocation> buffer_allocations,\n+    const HloModule* absl_nullable hlo_module,\n+    absl::string_view platform_name) {\n+  HostExecuteAsyncEventsMap host_executable_async_events_map;\n+  return DeserializeThunkProtoImpl(thunk_proto, buffer_allocations, hlo_module,\n+                                   platform_name,\n+                                   host_executable_async_events_map);\n+}\n+\n }  // namespace xla::gpu"
        },
        {
            "sha": "3df2e3c4512f3b1a6ad56d27d38b89dbc1e0e475",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_proto_deserialization_test.cc",
            "status": "modified",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/569574f52399dc560559d357e4d6139d62bc864f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization_test.cc?ref=569574f52399dc560559d357e4d6139d62bc864f",
            "patch": "@@ -26,6 +26,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/backends/gpu/runtime/conditional_thunk.h\"\n #include \"xla/backends/gpu/runtime/copy_thunk.h\"\n+#include \"xla/backends/gpu/runtime/host_execute_thunk.h\"\n #include \"xla/backends/gpu/runtime/sequential_thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n@@ -592,5 +593,62 @@ TEST(ThunkProtoDeserializationTest, EmptyThunkImplReturnsAnError) {\n               absl_testing::StatusIs(absl::StatusCode::kInvalidArgument));\n }\n \n+TEST(ThunkProtoDeserializationTest, HostExecuteThunksRoundTrip) {\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n+      R\"pb(\n+        thunk_info { execution_stream_id: 7 }\n+        sequential_thunk {\n+          thunks {\n+            thunk_info { execution_stream_id: 7 }\n+            host_execute_start_thunk {\n+              executable_proto { executable_type: EXECUTABLE_TYPE_NANORT }\n+              async_events_unique_id: 123\n+            }\n+          }\n+          thunks {\n+            thunk_info { execution_stream_id: 7 }\n+            host_execute_done_thunk { async_events_unique_id: 123 }\n+          }\n+        }\n+      )pb\");\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Thunk> thunk,\n+      DeserializeThunkProto(proto, /*buffer_allocations=*/{},\n+                            /*hlo_module=*/nullptr, kTestPlatformName));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(ThunkProto round_trip_proto, thunk->ToProto());\n+\n+  // Check that start and done thunks share the same async event id.\n+  const auto* sequential_thunk = dynamic_cast<SequentialThunk*>(thunk.get());\n+  ASSERT_NE(sequential_thunk, nullptr);\n+  ASSERT_EQ(sequential_thunk->thunks().size(), 2);\n+\n+  const auto* start_thunk =\n+      dynamic_cast<HostExecuteStartThunk*>(sequential_thunk->thunks()[0].get());\n+  ASSERT_NE(start_thunk, nullptr);\n+\n+  const auto* done_thunk =\n+      dynamic_cast<HostExecuteDoneThunk*>(sequential_thunk->thunks()[1].get());\n+  ASSERT_NE(done_thunk, nullptr);\n+\n+  EXPECT_TRUE(start_thunk->GetAsyncEventsUniqueId().has_value());\n+  EXPECT_TRUE(done_thunk->GetAsyncEventsUniqueId().has_value());\n+  EXPECT_EQ(start_thunk->GetAsyncEventsUniqueId(),\n+            done_thunk->GetAsyncEventsUniqueId());\n+\n+  // The unique id is regenerated on deserialization. Overwrite it with the\n+  // original value for the purpose of the roundtrip test.\n+  round_trip_proto.mutable_sequential_thunk()\n+      ->mutable_thunks(0)\n+      ->mutable_host_execute_start_thunk()\n+      ->set_async_events_unique_id(123);\n+  round_trip_proto.mutable_sequential_thunk()\n+      ->mutable_thunks(1)\n+      ->mutable_host_execute_done_thunk()\n+      ->set_async_events_unique_id(123);\n+  EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 124,
        "deletions": 16
    }
}