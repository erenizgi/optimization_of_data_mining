{
    "author": "KanishAnand",
    "message": "Migrate `hlo_reduce_test` to PjRt\n\nPiperOrigin-RevId: 845329928",
    "sha": "6e338a3da3768588fe69705b46a06d6e8fb56211",
    "files": [
        {
            "sha": "77955f587ee64cb230d88269ca39d49f9776f200",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e338a3da3768588fe69705b46a06d6e8fb56211/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e338a3da3768588fe69705b46a06d6e8fb56211/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=6e338a3da3768588fe69705b46a06d6e8fb56211",
            "patch": "@@ -2212,20 +2212,22 @@ xla_test(\n         \"cpu\",\n         \"interpreter\",\n     ],\n+    tags = [\"test_migrated_to_hlo_runner_pjrt\"],\n     deps = [\n-        \":hlo_test_base\",\n-        \":test_utils\",\n+        \":hlo_pjrt_interpreter_reference_mixin\",\n+        \":hlo_pjrt_test_base\",\n         \":xla_internal_test_main\",\n         \"//xla:error_spec\",\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n+        \"//xla:shape_layout\",\n         \"//xla:shape_util\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n-        \"@local_tsl//tsl/platform:statusor\",\n-        \"@local_tsl//tsl/platform:test\",\n+        \"@com_google_googletest//:gtest\",\n     ],\n )\n "
        },
        {
            "sha": "f69438baa48268c7e90ae4da735ff2b2bc4f2dac",
            "filename": "third_party/xla/xla/tests/reduce_hlo_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e338a3da3768588fe69705b46a06d6e8fb56211/third_party%2Fxla%2Fxla%2Ftests%2Freduce_hlo_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e338a3da3768588fe69705b46a06d6e8fb56211/third_party%2Fxla%2Fxla%2Ftests%2Freduce_hlo_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Freduce_hlo_test.cc?ref=6e338a3da3768588fe69705b46a06d6e8fb56211",
            "patch": "@@ -16,11 +16,10 @@ limitations under the License.\n #include <array>\n #include <cstdint>\n #include <memory>\n-#include <ostream>\n #include <string>\n #include <utility>\n-#include <vector>\n \n+#include <gtest/gtest.h>\n #include \"absl/log/log.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_cat.h\"\n@@ -33,10 +32,10 @@ limitations under the License.\n #include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/shape.h\"\n-#include \"xla/tests/hlo_test_base.h\"\n-#include \"xla/tests/test_utils.h\"\n-#include \"tsl/platform/statusor.h\"\n-#include \"tsl/platform/test.h\"\n+#include \"xla/shape_layout.h\"\n+#include \"xla/tests/hlo_pjrt_interpreter_reference_mixin.h\"\n+#include \"xla/tests/hlo_pjrt_test_base.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n // Tests the Reduce HLO in ways that can't be done using the ComputationBuilder\n // API.\n@@ -59,12 +58,8 @@ std::string PrintReduceLayout(\n   return reduce_layout_param.param.ToString();\n }\n \n-void PrintTo(const ReduceLayout& reduce_layout, ::std::ostream* os) {\n-  *os << reduce_layout.ToString();\n-}\n-\n class ReduceWithLayoutTest\n-    : public HloTestBase,\n+    : public HloPjRtInterpreterReferenceMixin<HloPjRtTestBase>,\n       public ::testing::WithParamInterface<ReduceLayout> {\n  public:\n   absl::StatusOr<std::unique_ptr<HloModule>> GetParsedModule() {\n@@ -127,6 +122,11 @@ TEST_P(ReduceWithLayoutTest, Reduce) {\n \n   Literal reduce_input_relaid =\n       reduce_input.Relayout(reduce_input_shape->layout());\n+\n+  // Strict layout check in PjRt requires entry computation layout to match.\n+  *module->mutable_entry_computation_layout()->mutable_parameter_layout(0) =\n+      ShapeLayout(*reduce_input_shape);\n+\n   EXPECT_TRUE(RunAndCompareNoHloPasses(\n       std::move(module), {&reduce_input_relaid}, ErrorSpec(1e-5)));\n }"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 17,
        "deletions": 15
    }
}