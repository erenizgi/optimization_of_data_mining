{
    "author": "nvgrw",
    "message": "Migrate GPU simple_optimization_tests to PjRt.\n\nPiperOrigin-RevId: 805526285",
    "sha": "1fead74accb3e8c67f620b20685124dc838083e5",
    "files": [
        {
            "sha": "9e7052ca25be3c018fabbd9044c3ac1ba4b71c6d",
            "filename": "third_party/xla/xla/service/gpu/tests/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1fead74accb3e8c67f620b20685124dc838083e5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1fead74accb3e8c67f620b20685124dc838083e5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD?ref=1fead74accb3e8c67f620b20685124dc838083e5",
            "patch": "@@ -826,8 +826,11 @@ cc_library(\n     srcs = [\"simple_optimization_test.cc\"],\n     tags = tf_gpu_tests_tags(),\n     deps = [\n-        \"//xla/tests:hlo_test_base\",\n+        \"//xla/hlo/testlib:verified_hlo_module\",\n+        \"//xla/tests:hlo_pjrt_test_base\",\n         \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/platform:test\",\n         \"@com_google_absl//absl/strings\",\n     ],\n     alwayslink = True,  # This library registers test cases at static initialization time.\n@@ -845,6 +848,7 @@ xla_test(\n     data = [\"test_autotune_cache.textproto\"],\n     env = {\"XLA_FLAGS\": \"--xla_gpu_load_autotune_results_from=\" +\n                         \"$(execpath test_autotune_cache.textproto)\"},\n+    tags = [\"test_migrated_to_hlo_runner_pjrt\"],\n     deps = [\n         \":simple_optimization_test\",\n         \"//xla/tests:xla_internal_test_main\",\n@@ -867,6 +871,7 @@ xla_test(\n     env = {\"XLA_FLAGS\": \"--xla_gpu_load_autotune_results_from=TEST_WORKSPACE/\" +\n                         package_name() +\n                         \"/test_autotune_cache.textproto\"},\n+    tags = [\"test_migrated_to_hlo_runner_pjrt\"],\n     deps = [\n         \":simple_optimization_test\",\n         \"//xla/tests:xla_internal_test_main\",\n@@ -886,6 +891,7 @@ xla_test(\n                         \"TEST_UNDECLARED_OUTPUTS_DIR/autotune_cache.textproto\"},\n     # Sharding must be disabled to correctly dump the autotune cache for all test.\n     shard_count = 1,\n+    tags = [\"test_migrated_to_hlo_runner_pjrt\"],\n     deps = [\n         \":simple_optimization_test\",\n         \"//xla/tests:xla_internal_test_main\","
        },
        {
            "sha": "22c76718aa014ae917afbb9d0507c3dfba81ce9b",
            "filename": "third_party/xla/xla/service/gpu/tests/simple_optimization_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1fead74accb3e8c67f620b20685124dc838083e5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fsimple_optimization_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1fead74accb3e8c67f620b20685124dc838083e5/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fsimple_optimization_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fsimple_optimization_test.cc?ref=1fead74accb3e8c67f620b20685124dc838083e5",
            "patch": "@@ -13,15 +13,21 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include <memory>\n+#include <utility>\n+\n #include \"absl/strings/string_view.h\"\n-#include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/hlo/testlib/verified_hlo_module.h\"\n+#include \"xla/tests/hlo_pjrt_test_base.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/platform/test.h\"\n \n namespace xla {\n namespace gpu {\n namespace {\n \n-class SimpleOptimizationTest : public HloTestBase {};\n+using SimpleOptimizationTest = HloPjRtTestBase;\n \n TEST_F(SimpleOptimizationTest, OptimizeModule) {\n   constexpr absl::string_view kHloText = R\"(\n@@ -35,7 +41,11 @@ ENTRY e {\n     lhs_contracting_dims={2,3}, rhs_contracting_dims={1,2}\n })\";\n \n-  TF_EXPECT_OK(GetOptimizedModule(kHloText).status());\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n+                          ParseAndReturnVerifiedModule(kHloText));\n+  TF_EXPECT_OK(test_runner()\n+                   .CreateExecutable(std::move(module), /*run_hlo_passes=*/true)\n+                   .status());\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 20,
        "deletions": 4
    }
}