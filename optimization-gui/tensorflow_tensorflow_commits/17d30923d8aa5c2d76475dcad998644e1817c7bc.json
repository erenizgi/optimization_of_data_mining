{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Add ragged-all-to-all e2e test with s4 input.\n\nPiperOrigin-RevId: 837607043",
    "sha": "17d30923d8aa5c2d76475dcad998644e1817c7bc",
    "files": [
        {
            "sha": "33cd7bde535ecea7629259cc967c15aa6aec73ca",
            "filename": "third_party/xla/xla/tests/ragged_all_to_all_e2e_test.cc",
            "status": "modified",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17d30923d8aa5c2d76475dcad998644e1817c7bc/third_party%2Fxla%2Fxla%2Ftests%2Fragged_all_to_all_e2e_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17d30923d8aa5c2d76475dcad998644e1817c7bc/third_party%2Fxla%2Fxla%2Ftests%2Fragged_all_to_all_e2e_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fragged_all_to_all_e2e_test.cc?ref=17d30923d8aa5c2d76475dcad998644e1817c7bc",
            "patch": "@@ -45,6 +45,7 @@ limitations under the License.\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n+#include \"xla/types.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -362,6 +363,62 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs) {\n   EXPECT_TRUE(LiteralTestUtil::Equal(expected_outputs_[1], results[1]));\n }\n \n+TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_S4) {\n+  absl::string_view kModuleReplicatedStr = R\"(\n+  HloModule module, num_partitions=1\n+\n+  ENTRY entry {\n+    input = s4[4,2]{1,0:E(4)} parameter(0)\n+    output = s4[4,2]{1,0:E(4)} parameter(1)\n+    input_offsets = s32[2] parameter(2)\n+    send_sizes = s32[2] parameter(3)\n+    output_offsets = s32[2] parameter(4)\n+    recv_sizes = s32[2] parameter(5)\n+    ROOT ra2a = s4[4,2]{1,0:E(4)} ragged-all-to-all(input, output, \n+      input_offsets, send_sizes, output_offsets, recv_sizes), \n+      replica_groups={{0,1}}\n+  })\";\n+\n+  const int64_t kNumReplicas = 2;\n+  const int64_t kNumPartitions = 1;\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n+  HloModuleConfig config =\n+      GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto module, ParseAndReturnVerifiedModule(kModuleReplicatedStr, config));\n+\n+  TF_ASSERT_OK(CreateRandomTestData(module.get(),\n+                                    /*input_sizes=*/{/*replica_0=*/{1, 1},\n+                                                     /*replica_1=*/{3, 1}}));\n+\n+  // `CreateRandomTestData` calculates sizes and offsets metadata, but fill\n+  // input and expected output literals with random floats. We need to manually\n+  // override them with s4 values.\n+  inputs_[0] = LiteralUtil::CreateR2<s4>(\n+      {{s4(1), s4(1)}, {s4(2), s4(2)}, {s4(0), s4(0)}, {s4(0), s4(0)}});\n+  inputs_[1] = LiteralUtil::CreateR2<s4>(\n+      {{s4(3), s4(3)}, {s4(4), s4(4)}, {s4(5), s4(5)}, {s4(6), s4(6)}});\n+\n+  expected_outputs_[0] = LiteralUtil::CreateR2<s4>(\n+      {{s4(1), s4(1)}, {s4(3), s4(3)}, {s4(4), s4(4)}, {s4(5), s4(5)}});\n+  expected_outputs_[1] = LiteralUtil::CreateR2<s4>(\n+      {{s4(2), s4(2)}, {s4(6), s4(6)}, {s4(-1), s4(-1)}, {s4(-1), s4(-1)}});\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::vector<Literal> results,\n+      ExecuteReplicated(std::move(module), GetInputLiteralPtrs(),\n+                        /*device_assignment=*/nullptr,\n+                        /*num_replicas=*/kNumReplicas,\n+                        /*run_hlo_passes=*/true));\n+  ASSERT_EQ(results.size(), kNumReplicas);\n+  EXPECT_TRUE(LiteralTestUtil::Equal(expected_outputs_[0], results[0]));\n+  EXPECT_TRUE(LiteralTestUtil::Equal(expected_outputs_[1], results[1]));\n+}\n+\n TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_InputBufferLargerThanOutput) {\n   absl::string_view kModuleReplicatedStr = R\"(\n   HloModule module, num_partitions=1"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 57,
        "deletions": 0
    }
}