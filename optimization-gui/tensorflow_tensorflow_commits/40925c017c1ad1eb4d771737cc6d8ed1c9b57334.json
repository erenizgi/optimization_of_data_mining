{
    "author": "d4n1elchen",
    "message": "[HLO Diff] Optimize `ComputeTextDiff` to use O(N) space using Hirschberg's algorithm.\n\nThe `ComputeTextDiff` function is refactored to use a divide-and-conquer approach, reducing the space complexity from O(MN) to O(N), where N is the length of the shorter string. This is achieved by using a space-efficient method to find a point on the Longest Common Subsequence (LCS) and then recursively solving the subproblems.\n\nPiperOrigin-RevId: 809211132",
    "sha": "40925c017c1ad1eb4d771737cc6d8ed1c9b57334",
    "files": [
        {
            "sha": "964da59c0cabf0ebdfcf60496ab1f6c96c6c821c",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40925c017c1ad1eb4d771737cc6d8ed1c9b57334/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40925c017c1ad1eb4d771737cc6d8ed1c9b57334/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=40925c017c1ad1eb4d771737cc6d8ed1c9b57334",
            "patch": "@@ -977,13 +977,14 @@ std::string PrintHloComputationToHtml(\n // Prints a single HLO instruction in a text box.\n template <typename T>\n std::string PrintHloTextbox(\n-    const T* node, const absl::flat_hash_map<const HloInstruction*, Attributes>&\n-                       span_attributes) {\n+    const T* node, DiffSide side,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes) {\n   std::string title = \"None\", text;\n   if (node != nullptr) {\n     title = node->name();\n     if constexpr (std::is_same_v<T, HloComputation>) {\n-      text = PrintHloComputationToHtml(node, DiffSide::kLeft, span_attributes);\n+      text = PrintHloComputationToHtml(node, side, span_attributes);\n     } else {\n       text = node->ToString();\n     }\n@@ -1003,10 +1004,12 @@ std::string PrintHloTextboxPair(\n         span_attributes) {\n   std::string left_textbox, right_textbox;\n   for (const T* node : left_nodes) {\n-    absl::StrAppend(&left_textbox, PrintHloTextbox(node, span_attributes));\n+    absl::StrAppend(&left_textbox,\n+                    PrintHloTextbox(node, DiffSide::kLeft, span_attributes));\n   }\n   for (const T* node : right_nodes) {\n-    absl::StrAppend(&right_textbox, PrintHloTextbox(node, span_attributes));\n+    absl::StrAppend(&right_textbox,\n+                    PrintHloTextbox(node, DiffSide::kRight, span_attributes));\n   }\n   return PrintDiv(absl::StrCat(PrintDiv(left_textbox, {\"hlo-textboxes\"}),\n                                PrintDiv(right_textbox, {\"hlo-textboxes\"})),"
        },
        {
            "sha": "fe4421ffa763bbf2b0588bf3ddbb8f91f9b8b759",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/utils/text_diff.cc",
            "status": "modified",
            "additions": 114,
            "deletions": 45,
            "changes": 159,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/40925c017c1ad1eb4d771737cc6d8ed1c9b57334/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2Ftext_diff.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/40925c017c1ad1eb4d771737cc6d8ed1c9b57334/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2Ftext_diff.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2Ftext_diff.cc?ref=40925c017c1ad1eb4d771737cc6d8ed1c9b57334",
            "patch": "@@ -22,64 +22,133 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n namespace xla::hlo_diff {\n \n-std::vector<TextDiffChunk> ComputeTextDiff(absl::string_view left,\n-                                           absl::string_view right) {\n-  int m = left.size();\n-  int n = right.size();\n-\n-  // dp[i][j] stores the length of the LCS of left[0...i-1] and right[0...j-1]\n-  std::vector<std::vector<int>> dp(m + 1, std::vector<int>(n + 1, 0));\n+namespace {\n \n+// Computes LCS lengths row for s1 and s2 using O(s2.length()) space.\n+// If reverse == true, computes for reversed s1 and s2.\n+std::vector<int> GetLcsLengths(absl::string_view s1, absl::string_view s2,\n+                               bool reverse = false) {\n+  int m = s1.length();\n+  int n = s2.length();\n+  std::vector<int> prev(n + 1, 0);\n+  std::vector<int> curr(n + 1, 0);\n   for (int i = 1; i <= m; ++i) {\n     for (int j = 1; j <= n; ++j) {\n-      if (left[i - 1] == right[j - 1]) {\n-        dp[i][j] = dp[i - 1][j - 1] + 1;\n+      char c1 = reverse ? s1[m - i] : s1[i - 1];\n+      char c2 = reverse ? s2[n - j] : s2[j - 1];\n+      if (c1 == c2) {\n+        curr[j] = prev[j - 1] + 1;\n       } else {\n-        dp[i][j] = std::max(dp[i - 1][j], dp[i][j - 1]);\n+        curr[j] = std::max(prev[j], curr[j - 1]);\n       }\n     }\n+    prev = curr;\n   }\n+  return curr;\n+}\n \n-  std::vector<TextDiffChunk> diff_chunks;\n-  int i = m, j = n;\n-  while (i > 0 || j > 0) {\n-    if (i > 0 && j > 0 && left[i - 1] == right[j - 1]) {\n-      // Unchanged character\n-      if (!diff_chunks.empty() &&\n-          diff_chunks.back().type == TextDiffType::kUnchanged) {\n-        diff_chunks.back().text.insert(0, 1, left[i - 1]);\n-      } else {\n-        diff_chunks.push_back(\n-            {TextDiffType::kUnchanged, std::string(1, left[i - 1])});\n-      }\n-      i--;\n-      j--;\n-    } else if (i > 0 && (j == 0 || dp[i - 1][j] > dp[i][j - 1])) {\n-      // Character removed from left. This path is chosen if skipping left[i-1]\n-      // results in a strictly longer LCS than skipping right[j-1].\n-      if (!diff_chunks.empty() &&\n-          diff_chunks.back().type == TextDiffType::kRemoved) {\n-        diff_chunks.back().text.insert(0, 1, left[i - 1]);\n-      } else {\n-        diff_chunks.push_back(\n-            {TextDiffType::kRemoved, std::string(1, left[i - 1])});\n+void MergeOrPushChunk(TextDiffType type, absl::string_view text,\n+                      std::vector<TextDiffChunk>& chunks) {\n+  if (text.empty()) {\n+    return;\n+  }\n+  if (!chunks.empty() && chunks.back().type == type) {\n+    chunks.back().text.append(text);\n+  } else {\n+    chunks.push_back({type, std::string(text)});\n+  }\n+}\n+\n+void ComputeDiffRecursive(absl::string_view left, absl::string_view right,\n+                          std::vector<TextDiffChunk>& chunks) {\n+  int m = left.length();\n+  int n = right.length();\n+\n+  if (m == 0) {\n+    MergeOrPushChunk(TextDiffType::kAdded, right, chunks);\n+    return;\n+  }\n+  if (n == 0) {\n+    MergeOrPushChunk(TextDiffType::kRemoved, left, chunks);\n+    return;\n+  }\n+\n+  if (m == 1 || n == 1) {\n+    // Fallback to O(MN) DP for small inputs to simplify base cases.\n+    // With M=1 or N=1, this is efficient enough space-wise.\n+    std::vector<std::vector<int>> dp(m + 1, std::vector<int>(n + 1, 0));\n+    for (int i = 1; i <= m; ++i) {\n+      for (int j = 1; j <= n; ++j) {\n+        if (left[i - 1] == right[j - 1]) {\n+          dp[i][j] = dp[i - 1][j - 1] + 1;\n+        } else {\n+          dp[i][j] = std::max(dp[i - 1][j], dp[i][j - 1]);\n+        }\n       }\n-      i--;\n-    } else {  // j > 0, implies dp[i][j - 1] >= dp[i - 1][j] or i == 0.\n-      // Character added to right. This includes the tie-breaking case\n-      // dp[i][j - 1] == dp[i - 1][j], ensuring Added comes after Removed\n-      // in the final reversed list.\n-      if (!diff_chunks.empty() &&\n-          diff_chunks.back().type == TextDiffType::kAdded) {\n-        diff_chunks.back().text.insert(0, 1, right[j - 1]);\n+    }\n+    std::vector<TextDiffChunk> reversed_chunks;\n+    int i = m, j = n;\n+    while (i > 0 || j > 0) {\n+      if (i > 0 && j > 0 && left[i - 1] == right[j - 1]) {\n+        if (!reversed_chunks.empty() &&\n+            reversed_chunks.back().type == TextDiffType::kUnchanged) {\n+          reversed_chunks.back().text.insert(0, 1, left[i - 1]);\n+        } else {\n+          reversed_chunks.push_back(\n+              {TextDiffType::kUnchanged, std::string(1, left[i - 1])});\n+        }\n+        i--;\n+        j--;\n+      } else if (i > 0 && (j == 0 || dp[i - 1][j] > dp[i][j - 1])) {\n+        if (!reversed_chunks.empty() &&\n+            reversed_chunks.back().type == TextDiffType::kRemoved) {\n+          reversed_chunks.back().text.insert(0, 1, left[i - 1]);\n+        } else {\n+          reversed_chunks.push_back(\n+              {TextDiffType::kRemoved, std::string(1, left[i - 1])});\n+        }\n+        i--;\n       } else {\n-        diff_chunks.push_back(\n-            {TextDiffType::kAdded, std::string(1, right[j - 1])});\n+        if (!reversed_chunks.empty() &&\n+            reversed_chunks.back().type == TextDiffType::kAdded) {\n+          reversed_chunks.back().text.insert(0, 1, right[j - 1]);\n+        } else {\n+          reversed_chunks.push_back(\n+              {TextDiffType::kAdded, std::string(1, right[j - 1])});\n+        }\n+        j--;\n       }\n-      j--;\n+    }\n+    std::reverse(reversed_chunks.begin(), reversed_chunks.end());\n+    for (const auto& chunk : reversed_chunks) {\n+      MergeOrPushChunk(chunk.type, chunk.text, chunks);\n+    }\n+    return;\n+  }\n+\n+  int mid = m / 2;\n+  std::vector<int> l1 = GetLcsLengths(left.substr(0, mid), right, false);\n+  std::vector<int> l2 = GetLcsLengths(left.substr(mid), right, true);\n+\n+  int partition = 0;\n+  int max_lcs = -1;\n+  for (int j = 0; j <= n; ++j) {\n+    if (l1[j] + l2[n - j] > max_lcs) {\n+      max_lcs = l1[j] + l2[n - j];\n+      partition = j;\n     }\n   }\n-  std::reverse(diff_chunks.begin(), diff_chunks.end());\n+\n+  ComputeDiffRecursive(left.substr(0, mid), right.substr(0, partition), chunks);\n+  ComputeDiffRecursive(left.substr(mid), right.substr(partition), chunks);\n+}\n+\n+}  // namespace\n+\n+std::vector<TextDiffChunk> ComputeTextDiff(absl::string_view left,\n+                                           absl::string_view right) {\n+  std::vector<TextDiffChunk> diff_chunks;\n+  ComputeDiffRecursive(left, right, diff_chunks);\n   return diff_chunks;\n }\n "
        }
    ],
    "stats": {
        "total": 172,
        "additions": 122,
        "deletions": 50
    }
}