{
    "author": "cota",
    "message": "[xla:cpu] hlo_benchmark_runner: add RunHloBenchmarkOnce\n\nThis will allow users to unit-test their benchmarks.\n\nPiperOrigin-RevId: 845598230",
    "sha": "3ac2cb42d80f2bd4f675460e32fd1977020ff53f",
    "files": [
        {
            "sha": "418a5e3e9027d215091f6a77d25ba5a930296acb",
            "filename": "third_party/xla/xla/backends/cpu/benchmarks/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ac2cb42d80f2bd4f675460e32fd1977020ff53f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ac2cb42d80f2bd4f675460e32fd1977020ff53f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2FBUILD?ref=3ac2cb42d80f2bd4f675460e32fd1977020ff53f",
            "patch": "@@ -70,6 +70,7 @@ cc_library(\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test_benchmark\",\n+        \"@com_google_absl//absl/base:nullability\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "97708cacc365c5132de5786099092577b8afbd44",
            "filename": "third_party/xla/xla/backends/cpu/benchmarks/hlo_benchmark_runner.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 7,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ac2cb42d80f2bd4f675460e32fd1977020ff53f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2Fhlo_benchmark_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ac2cb42d80f2bd4f675460e32fd1977020ff53f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2Fhlo_benchmark_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2Fhlo_benchmark_runner.cc?ref=3ac2cb42d80f2bd4f675460e32fd1977020ff53f",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"absl/base/nullability.h\"\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n@@ -152,10 +153,10 @@ absl::Status RunHloBenchmark(benchmark::State& state,\n }\n \n // NOLINTNEXTLINE(readability-function-cognitive-complexity)\n-absl::Status RunHloBenchmark(benchmark::State& state,\n-                             std::unique_ptr<HloModule> module,\n-                             absl::Span<const Literal* const> args,\n-                             const HloBenchmarkOptions& benchmark_options) {\n+absl::Status RunHloBenchmarkImpl(benchmark::State* absl_nullable state,\n+                                 std::unique_ptr<HloModule> module,\n+                                 absl::Span<const Literal* const> args,\n+                                 const HloBenchmarkOptions& benchmark_options) {\n   xla::CpuClientOptions client_options;\n   TF_ASSIGN_OR_RETURN(std::unique_ptr<PjRtClient> client,\n                       xla::GetXlaPjrtCpuClient(client_options));\n@@ -290,17 +291,35 @@ absl::Status RunHloBenchmark(benchmark::State& state,\n     return absl::OkStatus();\n   };\n \n-  // Warm up executable.\n+  // Run once. For a regular benchmark this will serve as a warm-up;\n+  // for RunHloBenchmarkOnce this will be the only run.\n   TF_RETURN_IF_ERROR(run_benchmark_once());\n \n   // Benchmark executable.\n-  for (auto _ : state) {\n-    TF_RETURN_IF_ERROR(run_benchmark_once());\n+  if (state) {\n+    for (auto _ : *state) {\n+      TF_RETURN_IF_ERROR(run_benchmark_once());\n+    }\n   }\n \n   return absl::OkStatus();\n }\n \n+absl::Status RunHloBenchmark(benchmark::State& state,\n+                             std::unique_ptr<HloModule> module,\n+                             absl::Span<const Literal* const> args,\n+                             const HloBenchmarkOptions& benchmark_options) {\n+  return RunHloBenchmarkImpl(&state, std::move(module), args,\n+                             benchmark_options);\n+}\n+\n+absl::Status RunHloBenchmarkOnce(std::unique_ptr<HloModule> module,\n+                                 absl::Span<const Literal* const> args,\n+                                 const HloBenchmarkOptions& benchmark_options) {\n+  return RunHloBenchmarkImpl(nullptr, std::move(module), args,\n+                             benchmark_options);\n+}\n+\n absl::Status CompileHloBenchmark(benchmark::State& state,\n                                  absl::string_view hlo_module,\n                                  StrToStrMapping replacements,"
        },
        {
            "sha": "562853d29e9c2b34f71121af27aec56f9b1aebd9",
            "filename": "third_party/xla/xla/backends/cpu/benchmarks/hlo_benchmark_runner.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ac2cb42d80f2bd4f675460e32fd1977020ff53f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2Fhlo_benchmark_runner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ac2cb42d80f2bd4f675460e32fd1977020ff53f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2Fhlo_benchmark_runner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fbenchmarks%2Fhlo_benchmark_runner.h?ref=3ac2cb42d80f2bd4f675460e32fd1977020ff53f",
            "patch": "@@ -70,6 +70,13 @@ absl::Status RunHloBenchmark(benchmark::State& state,\n                              absl::Span<const Literal* const> args,\n                              const HloBenchmarkOptions& benchmark_options = {});\n \n+// Same as above, except that it runs the module exactly once and does not\n+// have a benchmark::State parameter, which makes it suitable for unit tests.\n+absl::Status RunHloBenchmarkOnce(\n+    std::unique_ptr<HloModule> hlo_module,\n+    absl::Span<const Literal* const> args,\n+    const HloBenchmarkOptions& benchmark_options = {});\n+\n // Benchmarks the given HLO's compilation time.\n //\n // Takes the same options as RunHloBenchmark, except no arguments since the"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 34,
        "deletions": 7
    }
}