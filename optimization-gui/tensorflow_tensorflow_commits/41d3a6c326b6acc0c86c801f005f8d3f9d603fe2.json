{
    "author": "ezhulenev",
    "message": "[xla] Migrate to PjRtFuture<>::MakePromise() API\n\nPiperOrigin-RevId: 806465165",
    "sha": "41d3a6c326b6acc0c86c801f005f8d3f9d603fe2",
    "files": [
        {
            "sha": "81e13773d2152393ed56e3c98eb91414d4366f99",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc?ref=41d3a6c326b6acc0c86c801f005f8d3f9d603fe2",
            "patch": "@@ -174,12 +174,11 @@ PjRtFuture<> TfrtGpuBuffer::GetReadyFuture() {\n     return PjRtFuture<>(InvalidArgument(\n         \"GetReadyFuture() called on deleted or donated buffer\"));\n   }\n-  if (!ready_promise_) {\n-    ready_promise_ =\n-        CreatePromiseForEvent(tracked_device_buffer_->ready_event());\n+  if (!ready_future_) {\n+    ready_future_ = CreateFutureForEvent(tracked_device_buffer_->ready_event());\n   }\n-  return PjRtFuture<>(\n-      ready_promise_,\n+  return PjRtFutureHelpers::WithProfiling(\n+      ready_future_,\n       /*on_block_start=*/\n       []() {\n         tsl::profiler::TraceMeProducer traceme(\"TfrtGpuBuffer::Await\");"
        },
        {
            "sha": "c246da32576b49773ca4f4c463c7e1a9e22c8b1f",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.h?ref=41d3a6c326b6acc0c86c801f005f8d3f9d603fe2",
            "patch": "@@ -216,7 +216,7 @@ class TfrtGpuBuffer final : public PjRtBuffer {\n   // might fail. Note that concurrent calls to AcquireUsage() and\n   // AcquireDonation() might fail even if the pending donation is aborted later.\n   tsl::AsyncValueRef<bool> donation_event_ ABSL_GUARDED_BY(mu_);\n-  PjRtFuture<>::Promise ready_promise_ ABSL_GUARDED_BY(mu_);\n+  PjRtFuture<> ready_future_ ABSL_GUARDED_BY(mu_);\n \n   // This event is triggered when the last external reference is released.\n   // It is used to make sure that the buffer is not deleted before all external"
        },
        {
            "sha": "b2db6453fee28aad52dacda2ce3077c8f80e9420",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_executable.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc?ref=41d3a6c326b6acc0c86c801f005f8d3f9d603fe2",
            "patch": "@@ -865,9 +865,7 @@ absl::StatusOr<PjRtLoadedExecutable::Result> TfrtGpuExecutable::ExecuteHelper(\n   // Create output TFRT buffers.\n   std::optional<PjRtFuture<>> future;\n   if (fill_future) {\n-    PjRtFuture<>::Promise complete_promise =\n-        CreatePromiseForEvent(complete_event);\n-    future = PjRtFuture<>(complete_promise);\n+    future = CreateFutureForEvent(complete_event);\n   }\n   return Result({/*future=*/std::move(future),\n                  /*buffers=*/std::move(outputs)});"
        },
        {
            "sha": "52b053f93d92e0e774ca6a51d174d5f0fa80492b",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/utils.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc?ref=41d3a6c326b6acc0c86c801f005f8d3f9d603fe2",
            "patch": "@@ -108,10 +108,9 @@ limitations under the License.\n \n namespace xla {\n \n-PjRtFuture<>::Promise CreatePromiseForEvent(\n-    tsl::AsyncValueRef<xla::GpuEvent> event) {\n-  PjRtFuture<>::Promise promise = PjRtFuture<>::CreatePromise();\n-  auto done_fn = [promise, event]() mutable {\n+PjRtFuture<> CreateFutureForEvent(tsl::AsyncValueRef<xla::GpuEvent> event) {\n+  auto [promise, future] = PjRtFuture<>::MakePromise();\n+  auto done_fn = [promise = std::move(promise), event]() mutable {\n     if (const absl::Status* error = event.GetErrorIfPresent()) {\n       VLOG(3) << \"Setting future: \" << *error;\n       promise.Set(*error);\n@@ -126,7 +125,7 @@ PjRtFuture<>::Promise CreatePromiseForEvent(\n   } else {\n     event.AndThen(std::move(done_fn));\n   }\n-  return promise;\n+  return future;\n }\n \n absl::StatusOr<Shape> GetDestinationDeviceShape(const Shape& host_shape,"
        },
        {
            "sha": "18f1b1810f1483187d9ee6c34e1507f4e81625a9",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/utils.h",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/41d3a6c326b6acc0c86c801f005f8d3f9d603fe2/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.h?ref=41d3a6c326b6acc0c86c801f005f8d3f9d603fe2",
            "patch": "@@ -65,8 +65,7 @@ limitations under the License.\n \n namespace xla {\n \n-PjRtFuture<>::Promise CreatePromiseForEvent(\n-    tsl::AsyncValueRef<xla::GpuEvent> event);\n+PjRtFuture<> CreateFutureForEvent(tsl::AsyncValueRef<xla::GpuEvent> event);\n \n absl::StatusOr<Shape> GetDestinationDeviceShape(const Shape& host_shape,\n                                                 TfrtGpuDevice* device,"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 11,
        "deletions": 16
    }
}