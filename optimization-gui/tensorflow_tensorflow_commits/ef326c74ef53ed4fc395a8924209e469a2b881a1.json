{
    "author": "ezhulenev",
    "message": "[xla:cpu] Add benchmarks for SlinkyThreadPool\n\n```\nBM_ParallelFor/8/1      364687 ns       228963 ns         2974 items_per_second=43.6752M/s #threads=8, #threadpools=1\nBM_ParallelFor/8/2      226687 ns       176171 ns         2877 items_per_second=56.763M/s #threads=8, #threadpools=2\nBM_ParallelFor/8/4      211589 ns       184345 ns         5816 items_per_second=54.2462M/s #threads=8, #threadpools=4\nBM_ParallelFor/8/8      177793 ns       162265 ns         3788 items_per_second=61.6275M/s #threads=8, #threadpools=8\nBM_ParallelFor/8/16     206898 ns       192792 ns         3339 items_per_second=51.8693M/s #threads=8, #threadpools=16\n```\n\nPiperOrigin-RevId: 823321692",
    "sha": "ef326c74ef53ed4fc395a8924209e469a2b881a1",
    "files": [
        {
            "sha": "6358a9110d1d81a19fb04c6c4f027fc9038d2716",
            "filename": "third_party/xla/xla/backends/cpu/runtime/ynnpack/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2FBUILD?ref=ef326c74ef53ed4fc395a8924209e469a2b881a1",
            "patch": "@@ -38,7 +38,10 @@ ynn_cc_test(\n     deps = [\n         \":slinky_threadpool\",\n         \"//xla/tsl/platform:env\",\n-        \"@com_google_googletest//:gtest_main\",\n+        \"//xla/tsl/platform:test\",\n+        \"//xla/tsl/platform:test_benchmark\",\n+        \"//xla/tsl/platform:test_main\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@slinky//slinky/base:thread_pool\",\n     ],\n )"
        },
        {
            "sha": "33caa4f1fdda32c07270696af986ceb82c8107b2",
            "filename": "third_party/xla/xla/backends/cpu/runtime/ynnpack/slinky_threadpool.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool.cc?ref=ef326c74ef53ed4fc395a8924209e469a2b881a1",
            "patch": "@@ -360,6 +360,9 @@ SlinkyThreadPool::SlinkyThreadPool(Eigen::ThreadPoolDevice* device)\n SlinkyThreadPool::SlinkyThreadPool(Eigen::ThreadPoolInterface* threadpool)\n     : impl_(new Impl(threadpool)) {}\n \n+SlinkyThreadPool::SlinkyThreadPool(SlinkyThreadPool&&) = default;\n+SlinkyThreadPool& SlinkyThreadPool::operator=(SlinkyThreadPool&&) = default;\n+\n SlinkyThreadPool::~SlinkyThreadPool() = default;\n \n slinky::ref_count<SlinkyThreadPool::task> SlinkyThreadPool::enqueue("
        },
        {
            "sha": "b27cb29d4c7b463b88cb51696c65949fca7ae88c",
            "filename": "third_party/xla/xla/backends/cpu/runtime/ynnpack/slinky_threadpool.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool.h?ref=ef326c74ef53ed4fc395a8924209e469a2b881a1",
            "patch": "@@ -38,8 +38,8 @@ class SlinkyThreadPool final : public slinky::thread_pool {\n   explicit SlinkyThreadPool(Eigen::ThreadPoolInterface* threadpool);\n   ~SlinkyThreadPool() final;\n \n-  SlinkyThreadPool(SlinkyThreadPool&&) = default;\n-  SlinkyThreadPool& operator=(SlinkyThreadPool&&) = default;\n+  SlinkyThreadPool(SlinkyThreadPool&&);\n+  SlinkyThreadPool& operator=(SlinkyThreadPool&&);\n \n   slinky::ref_count<task> enqueue(size_t n, task_body t,\n                                   int32_t max_workers) final;"
        },
        {
            "sha": "438e4976f8d46cd68a8c913344b55359b6e8cf2a",
            "filename": "third_party/xla/xla/backends/cpu/runtime/ynnpack/slinky_threadpool_test.cc",
            "status": "modified",
            "additions": 59,
            "deletions": 1,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ef326c74ef53ed4fc395a8924209e469a2b881a1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fslinky_threadpool_test.cc?ref=ef326c74ef53ed4fc395a8924209e469a2b881a1",
            "patch": "@@ -19,11 +19,15 @@ limitations under the License.\n #include <atomic>\n #include <cstddef>\n #include <cstdint>\n+#include <limits>\n #include <vector>\n \n-#include <gtest/gtest.h>\n+#include \"absl/strings/str_format.h\"\n+#include \"slinky/base/ref_count.h\"\n #include \"slinky/base/thread_pool.h\"\n #include \"xla/tsl/platform/env.h\"\n+#include \"xla/tsl/platform/test.h\"\n+#include \"xla/tsl/platform/test_benchmark.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n \n namespace xla::cpu {\n@@ -94,4 +98,58 @@ TEST(SlinkyThreadPoolTest, NestedLoops) {\n   }\n }\n \n+//===----------------------------------------------------------------------===//\n+// Performance benchmarks below.\n+//===----------------------------------------------------------------------===//\n+\n+static void BM_ParallelFor(benchmark::State& state) {\n+  int64_t num_threads = state.range(0);\n+  int64_t num_threadpools = state.range(1);\n+\n+  tsl::thread::ThreadPool threads(tsl::Env::Default(), \"bench\", num_threads);\n+  std::vector<SlinkyThreadPool> thread_pools;\n+  for (size_t i = 0; i < num_threadpools; ++i) {\n+    thread_pools.emplace_back(threads.AsEigenThreadPool());\n+  }\n+\n+  static constexpr size_t kNumLoops = 100;\n+  static constexpr size_t kLoopSize = 100;\n+\n+  for (auto _ : state) {\n+    std::vector<slinky::ref_count<slinky::thread_pool::task>> tasks;\n+\n+    for (size_t i = 0; i < kNumLoops; ++i) {\n+      SlinkyThreadPool& thread_pool = thread_pools[i % num_threadpools];\n+      tasks.push_back(thread_pool.enqueue(\n+          kLoopSize, [](int64_t) {}, std::numeric_limits<int32_t>::max()));\n+    }\n+\n+    for (size_t i = 0; i < kNumLoops; ++i) {\n+      SlinkyThreadPool& thread_pool = thread_pools[i % num_threadpools];\n+      thread_pool.wait_for(&*tasks[i]);\n+    }\n+  }\n+\n+  state.SetItemsProcessed(kLoopSize * kNumLoops * state.iterations());\n+  state.SetLabel(absl::StrFormat(\"#threads=%d, #threadpools=%d\", num_threads,\n+                                 num_threadpools));\n+}\n+\n+BENCHMARK(BM_ParallelFor)\n+    ->ArgPair(8, 1)\n+    ->ArgPair(8, 2)\n+    ->ArgPair(8, 4)\n+    ->ArgPair(8, 8)\n+    ->ArgPair(8, 16)\n+    ->ArgPair(16, 1)\n+    ->ArgPair(16, 2)\n+    ->ArgPair(16, 4)\n+    ->ArgPair(16, 8)\n+    ->ArgPair(16, 16)\n+    ->ArgPair(32, 1)\n+    ->ArgPair(32, 2)\n+    ->ArgPair(32, 4)\n+    ->ArgPair(32, 8)\n+    ->ArgPair(32, 16);\n+\n }  // namespace xla::cpu"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 68,
        "deletions": 4
    }
}