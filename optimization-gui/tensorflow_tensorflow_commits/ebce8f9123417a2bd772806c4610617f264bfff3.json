{
    "author": "metaflow",
    "message": "[XLA:GPU] ignore tiling errors from generic triton emitter in autotuner\n\nWe see cases when tiling errors are showing up as various status codes. That should be addressed later by having a more specific error type for the cases when it's not possible to tile.\n\nNote that legacy emitter also uses this strategy - kResourceExhausted status is ignored in AutotunerCompileUtil::Compile for that reason.\n\nPiperOrigin-RevId: 811470079",
    "sha": "ebce8f9123417a2bd772806c4610617f264bfff3",
    "files": [
        {
            "sha": "6d3843e21bcd6b2251e64bea471a581d89fd2224",
            "filename": "third_party/xla/xla/service/gpu/autotuning/autotuner_compile_util.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebce8f9123417a2bd772806c4610617f264bfff3/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fautotuner_compile_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebce8f9123417a2bd772806c4610617f264bfff3/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fautotuner_compile_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fautotuner_compile_util.cc?ref=ebce8f9123417a2bd772806c4610617f264bfff3",
            "patch": "@@ -144,8 +144,7 @@ absl::StatusOr<std::unique_ptr<Executable>> AutotunerCompileUtil::Compile(\n                                /*layout_canonicalization_callback=*/{},\n                                /*is_autotuning_compilation=*/true});\n   if (out.status().code() == absl::StatusCode::kResourceExhausted ||\n-      out.status().code() == absl::StatusCode::kCancelled ||\n-      out.status().code() == absl::StatusCode::kInvalidArgument) {\n+      out.status().code() == absl::StatusCode::kCancelled) {\n     // Being out of shared memory budget or registers is an expected failure.\n     // Cancelling upon register spilling is also an expected failure.\n     VLOG(5) << \"Compilation failed with status \" << out.status()"
        },
        {
            "sha": "948acd28930baaadba188012ab6323432d2c6e4a",
            "filename": "third_party/xla/xla/service/gpu/autotuning/gemm_fusion_autotuner.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebce8f9123417a2bd772806c4610617f264bfff3/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebce8f9123417a2bd772806c4610617f264bfff3/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc?ref=ebce8f9123417a2bd772806c4610617f264bfff3",
            "patch": "@@ -1064,6 +1064,27 @@ GemmFusionAutotunerImpl::CompileAll(AutotunerCompileUtil& compile_util,\n             fusion, opts, mlir_context_,\n             allow_filtering_kernels_spilling_registers);\n       });\n+      if (absl::c_contains(\n+              debug_options_\n+                  .xla_gpu_unsupported_generic_triton_emitter_features(),\n+              DebugOptions::\n+                  GENERIC_TRITON_EMITTER_MUST_ACCEPT_ALL_AUTOTUNER_CONFIGS)) {\n+        return executable_or;\n+      }\n+      absl::StatusCode code = executable_or.status().code();\n+      // TODO(b/447113513): we should not silently ignore that wide range of\n+      // errors as we might hide real regressions and drop the optimal\n+      // configuration. One idea might be to use a specific error type when\n+      // tiling is not possible and we should skip the config.\n+      if (code == absl::StatusCode::kInternal ||\n+          code == absl::StatusCode::kFailedPrecondition ||\n+          code == absl::StatusCode::kUnimplemented ||\n+          (debug_options_.xla_gpu_exhaustive_tiling_search() &&\n+           code == absl::StatusCode::kInvalidArgument)) {\n+        VLOG(5) << \"Compilation failed with status \" << executable_or.status()\n+                << \" that is ignored\";\n+        return nullptr;\n+      }\n       return executable_or;\n     }\n "
        }
    ],
    "stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
    }
}