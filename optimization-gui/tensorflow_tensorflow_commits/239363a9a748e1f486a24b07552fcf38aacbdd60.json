{
    "author": "ezhulenev",
    "message": "[xla:ffi] Relax the check for the number of attributes\n\nPiperOrigin-RevId: 837167941",
    "sha": "239363a9a748e1f486a24b07552fcf38aacbdd60",
    "files": [
        {
            "sha": "658234289befeecf3f2136d7b265b44deccb2097",
            "filename": "third_party/xla/xla/ffi/api/api.h",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/239363a9a748e1f486a24b07552fcf38aacbdd60/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/239363a9a748e1f486a24b07552fcf38aacbdd60/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h?ref=239363a9a748e1f486a24b07552fcf38aacbdd60",
            "patch": "@@ -1745,11 +1745,19 @@ class Handler : public Ffi {\n     }\n \n     // Check that the number of passed attributes matches the signature. Each\n-    // individual attribute decoding will check the actual type. If we decode\n-    // attributes into a dictionary (or a custom struct decoded from a\n-    // dictionary), then there is no need to check attributes, as the FFI\n-    // handler (or a struct decoding) should be responsible for it.\n-    if (XLA_FFI_PREDICT_FALSE(kNumDictAttrs == 0 &&\n+    // individual attribute decoding will check the actual type.\n+    //\n+    // If we decode attributes into a dictionary (or a custom struct decoded\n+    // from a dictionary), then there is no need to check the number of\n+    // attributes, as the FFI handler (or a struct decoding) should be\n+    // responsible for it.\n+    //\n+    // If the number of bound attributes is zero, then we also don't care about\n+    // the number of attributes in the call frame. FFI handler can safely choose\n+    // to ignore attributes in this case. We only need to check the number of\n+    // attributes if we plan to decode them, as we build a mapping from the\n+    // attribute name to its index in the call frame attributes.\n+    if (XLA_FFI_PREDICT_FALSE(kNumDictAttrs == 0 && kNumAttrs > 0 &&\n                               call_frame->attrs.size != kNumAttrs)) {\n       std::stringstream msg;\n       msg << \"[\" << call_frame->stage << \"] \""
        },
        {
            "sha": "8bfc2e311339330dca601282e49486ba61d4054c",
            "filename": "third_party/xla/xla/ffi/ffi_test.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/239363a9a748e1f486a24b07552fcf38aacbdd60/third_party%2Fxla%2Fxla%2Fffi%2Fffi_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/239363a9a748e1f486a24b07552fcf38aacbdd60/third_party%2Fxla%2Fxla%2Fffi%2Fffi_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fffi_test.cc?ref=239363a9a748e1f486a24b07552fcf38aacbdd60",
            "patch": "@@ -215,6 +215,22 @@ TEST(FfiTest, WrongNumAttrs) {\n               \"[execute] Wrong number of attributes: expected 1 but got 2\")));\n }\n \n+TEST(FfiTest, IgnoreAttrs) {\n+  CallFrameBuilder::AttributesBuilder attrs;\n+  attrs.Insert(\"i32\", 42);\n+  attrs.Insert(\"f32\", 42.0f);\n+\n+  CallFrameBuilder builder(/*num_args=*/0, /*num_rets=*/0);\n+  builder.AddAttributes(attrs.Build());\n+  auto call_frame = builder.Build();\n+\n+  // If signature doesn't have attributes, then we can safely ignore them.\n+  auto handler = Ffi::Bind().To([]() { return absl::OkStatus(); });\n+\n+  auto status = Call(*handler, call_frame);\n+  TF_ASSERT_OK(status);\n+}\n+\n TEST(FfiTest, RunId) {\n   CallFrameBuilder builder(/*num_args=*/0, /*num_rets=*/0);\n   auto call_frame = builder.Build();\n@@ -231,7 +247,6 @@ TEST(FfiTest, RunId) {\n   options.run_id = RunId{42};\n \n   auto status = Call(*handler, call_frame, options);\n-\n   TF_ASSERT_OK(status);\n }\n "
        }
    ],
    "stats": {
        "total": 35,
        "additions": 29,
        "deletions": 6
    }
}