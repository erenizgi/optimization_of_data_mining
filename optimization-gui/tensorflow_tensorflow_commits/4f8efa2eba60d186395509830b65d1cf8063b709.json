{
    "author": "tensorflower-gardener",
    "message": "#HLODiff Add DiffSummary to the HLO diff API proto output.\n\nPiperOrigin-RevId: 805625899",
    "sha": "4f8efa2eba60d186395509830b65d1cf8063b709",
    "files": [
        {
            "sha": "ea0bba4fb7e8e13615fb42ff581a05e97b139180",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2FBUILD?ref=4f8efa2eba60d186395509830b65d1cf8063b709",
            "patch": "@@ -75,6 +75,7 @@ cc_library(\n         \"//xla/hlo/tools/hlo_diff/graph:hlo_gumgraph\",\n         \"//xla/hlo/tools/hlo_diff/graph:hlo_gumgraph_node\",\n         \"//xla/hlo/tools/hlo_diff/graph/utils:hlo_gumgraph_dfs\",\n+        \"//xla/hlo/tools/hlo_diff/proto:diff_result_proto_cc\",\n         \"//xla/hlo/tools/hlo_diff/utils:bidirectional_map\",\n         \"//xla/hlo/tools/hlo_diff/utils:connected_components\",\n         \"//xla/tsl/platform:statusor\","
        },
        {
            "sha": "854c0d02e06ab167cc65a8fbf115d070d412c3bb",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc?ref=4f8efa2eba60d186395509830b65d1cf8063b709",
            "patch": "@@ -42,6 +42,7 @@\n #include \"xla/hlo/tools/hlo_diff/graph/utils/hlo_gumgraph_dfs.h\"\n #include \"xla/hlo/tools/hlo_diff/hlo_diff_result.h\"\n #include \"xla/hlo/tools/hlo_diff/hlo_gumgraph_mappings.h\"\n+#include \"xla/hlo/tools/hlo_diff/proto/diff_result.pb.h\"\n #include \"xla/hlo/tools/hlo_diff/utils/bidirectional_map.h\"\n #include \"xla/hlo/tools/hlo_diff/utils/connected_components.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -453,5 +454,43 @@ void PrintTo(const ComputationDiffPattern& diff_pattern, std::ostream* os) {\n   *os << \" }\";\n }\n \n+DiffSummaryProto DiffSummary::ToProto() const {\n+  DiffSummaryProto proto;\n+  for (const auto& diff_pattern : computation_diff_patterns) {\n+    ComputationDiffPatternProto* diff_pattern_proto =\n+        proto.add_computation_diff_patterns();\n+    diff_pattern_proto->set_fingerprint(diff_pattern.fingerprint);\n+    diff_pattern_proto->set_changed_instruction_count(\n+        diff_pattern.diff_metrics.changed_instruction_count);\n+    diff_pattern_proto->set_left_unmatched_instruction_count(\n+        diff_pattern.diff_metrics.left_unmatched_instruction_count);\n+    diff_pattern_proto->set_right_unmatched_instruction_count(\n+        diff_pattern.diff_metrics.right_unmatched_instruction_count);\n+    for (const auto& computation_group : diff_pattern.computation_groups) {\n+      ComputationGroupProto* group_proto =\n+          diff_pattern_proto->add_computation_group();\n+      for (const HloComputation* computation :\n+           computation_group.left_computations) {\n+        ComputationDetailsProto* details_proto =\n+            group_proto->add_left_computations();\n+        details_proto->set_name(computation->name());\n+        for (const HloInstruction* instruction : computation->instructions()) {\n+          details_proto->add_instructions(instruction->name());\n+        }\n+      }\n+      for (const HloComputation* computation :\n+           computation_group.right_computations) {\n+        ComputationDetailsProto* details_proto =\n+            group_proto->add_right_computations();\n+        details_proto->set_name(computation->name());\n+        for (const HloInstruction* instruction : computation->instructions()) {\n+          details_proto->add_instructions(instruction->name());\n+        }\n+      }\n+    }\n+  }\n+  return proto;\n+}\n+\n }  // namespace hlo_diff\n }  // namespace xla"
        },
        {
            "sha": "901d1dc1291f75cc55dab7164a63724b643ca1da",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h?ref=4f8efa2eba60d186395509830b65d1cf8063b709",
            "patch": "@@ -28,6 +28,7 @@\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/tools/hlo_diff/graph/hlo_gumgraph.h\"\n #include \"xla/hlo/tools/hlo_diff/hlo_diff_result.h\"\n+#include \"xla/hlo/tools/hlo_diff/proto/diff_result.pb.h\"\n \n namespace xla {\n namespace hlo_diff {\n@@ -101,6 +102,9 @@ struct DiffSummary {\n \n   // Summary of each instruction.\n   InstructionSummaryMap instruction_summary;\n+\n+  // Converts the diff summary to a proto.\n+  DiffSummaryProto ToProto() const;\n };\n \n // Constructs the diff summary from the diff result."
        },
        {
            "sha": "a8ca7d1f1d68f31aab52cd8b3e890532808ff96b",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary_test.cc",
            "status": "modified",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc?ref=4f8efa2eba60d186395509830b65d1cf8063b709",
            "patch": "@@ -35,6 +35,8 @@ namespace xla {\n namespace hlo_diff {\n namespace {\n \n+using ::testing::AllOf;\n+using ::testing::ElementsAre;\n using ::testing::ExplainMatchResult;\n using ::testing::FieldsAre;\n using ::testing::IsEmpty;\n@@ -620,6 +622,74 @@ TEST_F(HloDiffTest, DiffSummaryFromDiffResultProtoWorks) {\n                          expected_diff_summary->computation_diff_patterns));\n }\n \n+TEST_F(HloDiffTest, DiffSummaryToProtoWorks) {\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::VerifiedHloModule> module_l,\n+                          ParseAndReturnVerifiedModule(R\"(\n+  HloModule module, is_scheduled=true\n+\n+  ENTRY entry {\n+    parameter.0 = f32[] parameter(0)\n+    parameter.1 = f32[] parameter(1)\n+    add.0 = f32[] add(parameter.0, parameter.1)\n+  }\n+  )\"));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<const HloGumgraph> graph_l,\n+                          HloGumgraph::Create(module_l.get()));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::VerifiedHloModule> module_r,\n+                          ParseAndReturnVerifiedModule(R\"(\n+  HloModule module, is_scheduled=true\n+\n+  ENTRY entry {\n+    parameter.0 = f32[] parameter(0)\n+    parameter.1 = f32[] parameter(1)\n+    add.0 = f32[] add(parameter.1, parameter.0)\n+  }\n+  )\"));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<const HloGumgraph> graph_r,\n+                          HloGumgraph::Create(module_r.get()));\n+  HloGumgraphMappings mappings;\n+  ASSERT_NO_FATAL_FAILURE(OverwriteMapInstructions(\n+      GetNodeByName(*graph_l, \"add.0\"), GetNodeByName(*graph_r, \"add.0\"),\n+      mappings, true));\n+  std::unique_ptr<const DiffResult> diff_result =\n+      ConstructDiffResult(*graph_l, *graph_r, mappings);\n+  std::unique_ptr<const DiffSummary> diff_summary =\n+      ConstructDiffSummary(*graph_l, *graph_r, *diff_result);\n+\n+  DiffSummaryProto proto = diff_summary->ToProto();\n+\n+  EXPECT_THAT(\n+      proto.computation_diff_patterns(),\n+      ElementsAre(AllOf(\n+          Property(&ComputationDiffPatternProto::fingerprint,\n+                   12418933386714070753U),\n+          Property(\n+              &ComputationDiffPatternProto::computation_group,\n+              ElementsAre(AllOf(\n+                  Property(\n+                      &ComputationGroupProto::left_computations,\n+                      ElementsAre(AllOf(\n+                          Property(&ComputationDetailsProto::name, \"entry\"),\n+                          Property(&ComputationDetailsProto::instructions,\n+                                   ElementsAre(\"parameter.0\", \"parameter.1\",\n+                                               \"add.0\"))))),\n+                  Property(\n+                      &ComputationGroupProto::right_computations,\n+                      ElementsAre(AllOf(\n+                          Property(&ComputationDetailsProto::name, \"entry\"),\n+                          Property(&ComputationDetailsProto::instructions,\n+                                   ElementsAre(\"parameter.0\", \"parameter.1\",\n+                                               \"add.0\")))))))),\n+          Property(&ComputationDiffPatternProto::changed_instruction_count, 0),\n+          Property(\n+              &ComputationDiffPatternProto::left_unmatched_instruction_count,\n+              2),\n+          Property(\n+              &ComputationDiffPatternProto::right_unmatched_instruction_count,\n+              2))));\n+}\n+\n }  // namespace\n }  // namespace hlo_diff\n }  // namespace xla"
        },
        {
            "sha": "4ca08ecc98c9014385417f77c55aff8b6b1eb30b",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/proto/diff_result.proto",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fproto%2Fdiff_result.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4f8efa2eba60d186395509830b65d1cf8063b709/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fproto%2Fdiff_result.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fproto%2Fdiff_result.proto?ref=4f8efa2eba60d186395509830b65d1cf8063b709",
            "patch": "@@ -16,9 +16,36 @@ message DiffResultProto {\n   repeated MatchedInstructionPairProto changed_instructions = 4;\n }\n \n+// Represents details about a computation, including its name and instructions.\n+message ComputationDetailsProto {\n+  string name = 1;\n+  repeated string instructions = 2;\n+}\n+\n+// Represents a group of matched computations from the left and right modules.\n+message ComputationGroupProto {\n+  repeated ComputationDetailsProto left_computations = 1;\n+  repeated ComputationDetailsProto right_computations = 2;\n+}\n+\n+message ComputationDiffPatternProto {\n+  // The fingerprint of the computation group.\n+  uint64 fingerprint = 1;\n+  repeated ComputationGroupProto computation_group = 2;\n+  uint64 changed_instruction_count = 3;\n+  uint64 left_unmatched_instruction_count = 4;\n+  uint64 right_unmatched_instruction_count = 5;\n+}\n+\n+// Represents the summary of the diff between two HLO modules.\n+message DiffSummaryProto {\n+  repeated ComputationDiffPatternProto computation_diff_patterns = 1;\n+}\n+\n // Represents the result or error of computing the diff between two HLO modules.\n message DiffResultOrErrorProto {\n   DiffResultProto diff_result = 1;\n   int32 status = 2;\n   string error = 3;\n+  DiffSummaryProto diff_summary = 4;\n }"
        }
    ],
    "stats": {
        "total": 141,
        "additions": 141,
        "deletions": 0
    }
}