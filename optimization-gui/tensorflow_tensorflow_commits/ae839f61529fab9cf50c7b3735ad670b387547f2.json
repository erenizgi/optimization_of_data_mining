{
    "author": "krishnaharidasan",
    "message": "Migrate callsites from ifrt::AttributeMap::map to ifrt::AttributeMap::Get\n\nPiperOrigin-RevId: 839946155",
    "sha": "ae839f61529fab9cf50c7b3735ad670b387547f2",
    "files": [
        {
            "sha": "4533b3c2e102dec37acbe38da04d401feb9652ec",
            "filename": "tensorflow/core/tfrt/ifrt/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/tensorflow%2Fcore%2Ftfrt%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/tensorflow%2Fcore%2Ftfrt%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2FBUILD?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -80,9 +80,6 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n-        \"@llvm-project//llvm:Support\",\n-        \"@llvm-project//mlir:IR\",\n-        \"@llvm-project//mlir:Support\",\n         \"@local_xla//xla:xla_data_proto_cc\",\n         \"@local_xla//xla/python/ifrt\",\n         \"@local_xla//xla/python/ifrt:attribute_map\","
        },
        {
            "sha": "dd18d5e90cfc59f1665ebdb0af586ae16529b83e",
            "filename": "tensorflow/core/tfrt/ifrt/ifrt_device_utils.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 17,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_device_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_device_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_device_utils.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"tensorflow/core/tfrt/ifrt/ifrt_device_utils.h\"\n \n+#include <cstdint>\n #include <optional>\n #include <vector>\n \n@@ -61,8 +62,9 @@ absl::StatusOr<std::vector<xla::ifrt::Device*>> GetAssignedIfrtDevices(\n   // device assignment attribute to ifrt devices.\n   bool no_device_coordinates = false;\n   for (auto* device : ifrt_client.devices()) {\n-    if (!device->Attributes().map().contains(\"coords\") ||\n-        !device->Attributes().map().contains(\"core_on_chip\")) {\n+    auto coords_attr = device->Attributes().Get<std::vector<int64_t>>(\"coords\");\n+    auto core_on_chip_attr = device->Attributes().Get<int64_t>(\"core_on_chip\");\n+    if (!coords_attr.ok() || !core_on_chip_attr.ok()) {\n       no_device_coordinates = true;\n       break;\n     }\n@@ -133,24 +135,20 @@ absl::StatusOr<std::vector<xla::ifrt::Device*>> GetAssignedIfrtDevices(\n \n   for (auto* device : ifrt_client.devices()) {\n     GridCoords grid;\n-    auto coords_it = device->Attributes().map().find(\"coords\");\n-    auto core_on_chip_it = device->Attributes().map().find(\"core_on_chip\");\n-    if (coords_it != device->Attributes().map().end() &&\n-        core_on_chip_it != device->Attributes().map().end()) {\n+    auto coords_attr = device->Attributes().Get<std::vector<int64_t>>(\"coords\");\n+    auto core_on_chip_attr = device->Attributes().Get<int64_t>(\"core_on_chip\");\n+    if (coords_attr.ok() && core_on_chip_attr.ok()) {\n       VLOG(3) << \"Adding coords and core_on_chip attributes:\"\n               << device->DebugString();\n-      auto coords_list =\n-          std::get<xla::ifrt::AttributeMap::Int64ListValue>(coords_it->second);\n-      auto core_on_chip = std::get<xla::ifrt::AttributeMap::Int64Value>(\n-          core_on_chip_it->second);\n-\n-      if (coords_list.value.size() != 3) {\n-        return absl::InternalError(absl::StrCat(\n-            \"Expected coords to be of size 3, but got \",\n-            coords_list.value.size(), \" for device \", device->DebugString()));\n+      auto coords = *coords_attr;\n+      auto core_on_chip = *core_on_chip_attr;\n+\n+      if (coords.size() != 3) {\n+        return absl::InternalError(\n+            absl::StrCat(\"Expected coords to be of size 3, but got \",\n+                         coords.size(), \" for device \", device->DebugString()));\n       }\n-      grid = GridCoords(coords_list.value[0], coords_list.value[1],\n-                        coords_list.value[2], core_on_chip.value);\n+      grid = GridCoords(coords[0], coords[1], coords[2], core_on_chip);\n     } else {\n       return absl::InternalError(\n           absl::StrCat(\"Device \", device->DebugString(),"
        },
        {
            "sha": "e8971d920c6998ae2b8c74df8e8e6baffa7b4d27",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -230,6 +230,7 @@ xla_cc_test(\n         \":serdes_version\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "64608b4f4c5c02e95a1d495223489bd5e70d17f2",
            "filename": "third_party/xla/xla/python/ifrt/executable_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable_test.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -15,8 +15,11 @@ limitations under the License.\n \n #include \"xla/python/ifrt/executable.h\"\n \n+#include <string>\n+\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"absl/status/status_matchers.h\"\n #include \"xla/python/ifrt/attribute_map.h\"\n #include \"xla/python/ifrt/execute_options.pb.h\"\n #include \"xla/python/ifrt/serdes_test_util.h\"\n@@ -27,6 +30,7 @@ limitations under the License.\n namespace xla {\n namespace ifrt {\n \n+using ::absl_testing::IsOkAndHolds;\n using ::testing::Pair;\n using ::testing::UnorderedElementsAre;\n \n@@ -58,9 +62,8 @@ TEST_P(ExecuteOptionsSerDesTest, RoundTrip) {\n               UnorderedElementsAre(0, 3));\n   EXPECT_TRUE(deserialized.fill_status);\n   ASSERT_TRUE(deserialized.custom_options.has_value());\n-  EXPECT_THAT(\n-      deserialized.custom_options->map(),\n-      UnorderedElementsAre(Pair(\"foo\", AttributeMap::StringValue(\"bar\"))));\n+  EXPECT_THAT(deserialized.custom_options->Get<std::string>(\"foo\"),\n+              IsOkAndHolds(\"bar\"));\n }\n \n INSTANTIATE_TEST_SUITE_P("
        },
        {
            "sha": "b3ec80c3d6f3e96741a25158f621d5965fabbb17",
            "filename": "third_party/xla/xla/python/ifrt/ir/compiled_ifrt_ir_program.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -383,15 +383,10 @@ absl::StatusOr<CompiledIfrtIrProgram> CompiledIfrtIrProgram::Create(\n     compile_pipeline_options.propagate_shardings =\n         compile_options->propagate_shardings;\n     for (const auto device : devices) {\n-      const auto it = device->Attributes().map().find(\"platform_name\");\n-      if (it != device->Attributes().map().end()) {\n-        if (auto* const str = std::get_if<xla::ifrt::AttributeMap::StringValue>(\n-                &it->second)) {\n-          compile_pipeline_options.platform_names.push_back(str->value);\n-        } else {\n-          return absl::FailedPreconditionError(\n-              \"Device platform name is not a string\");\n-        }\n+      auto platform_name =\n+          device->Attributes().Get<std::string>(\"platform_name\");\n+      if (platform_name.ok()) {\n+        compile_pipeline_options.platform_names.push_back(*platform_name);\n       } else {\n         compile_pipeline_options.platform_names.push_back(\n             std::string(client->platform_name()));"
        },
        {
            "sha": "c390916b320389ac983ca2c942d3662525d4efe1",
            "filename": "third_party/xla/xla/python/ifrt/ir/transforms/ifrt_to_dot_pass.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_to_dot_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_to_dot_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_to_dot_pass.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -246,12 +246,9 @@ class IfrtToDotPass : public impl::IfrtToDotPassBase<IfrtToDotPass> {\n     // Get flops from the cost analysis.\n     if (auto cost_analysis = executable->GetCostAnalysis();\n         cost_analysis.ok()) {\n-      if (auto it = cost_analysis->map().find(\"flops\");\n-          it != cost_analysis->map().end()) {\n-        if (auto flops_ptr =\n-                std::get_if<xla::ifrt::AttributeMap::FloatValue>(&it->second)) {\n-          stats.flops = flops_ptr->value;\n-        }\n+      auto flops = cost_analysis->Get<float>(\"flops\");\n+      if (flops.ok()) {\n+        stats.flops = *flops;\n       } else {\n         LOG(WARNING) << \"Cost analysis of executable \" << executable->name()\n                      << \" does not contain flops\";"
        },
        {
            "sha": "03c92861e6560f50cc4f323484185bee53ad18bc",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/client.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -72,12 +72,11 @@ namespace proxy {\n namespace {\n \n std::string device_summary(Device* device) {\n-  auto it = device->Attributes().map().find(\"slice_index\");\n-  int slice_index =\n-      (it != device->Attributes().map().end() &&\n-       std::holds_alternative<AttributeMap::Int64Value>(it->second))\n-          ? std::get<AttributeMap::Int64Value>(it->second).value\n-          : 0;\n+  int64_t slice_index = 0;\n+  auto slice_index_attr = device->Attributes().Get<int64_t>(\"slice_index\");\n+  if (slice_index_attr.ok()) {\n+    slice_index = *slice_index_attr;\n+  }\n   return absl::StrCat(device->Kind(), \"s\", slice_index);\n }\n "
        },
        {
            "sha": "e2d4c86d856e680f915871f782f1e22369704e6f",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/client_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient_test.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -268,9 +268,8 @@ TEST_P(ClientTest, Init) {\n   EXPECT_EQ(client_->platform_id(), 42);\n   EXPECT_EQ(client_->process_index(), 1);\n   EXPECT_EQ(client_->runtime_type(), \"proxy/ifrt-service\");\n-  EXPECT_THAT(\n-      client_->Attributes().map(),\n-      ElementsAre(Pair(\"test_key\", AttributeMap::StringValue(\"test_value\"))));\n+  EXPECT_THAT(client_->Attributes().Get<std::string>(\"test_key\"),\n+              absl_testing::IsOkAndHolds(\"test_value\"));\n \n   ASSERT_EQ(client_->device_count(), 2);\n   ASSERT_EQ(client_->addressable_device_count(), 1);\n@@ -279,8 +278,8 @@ TEST_P(ClientTest, Init) {\n                           client_->LookupDevice(DeviceId(0)));\n   EXPECT_EQ(device0->Id(), DeviceId(0));\n   EXPECT_EQ(device0->Kind(), \"mock\");\n-  EXPECT_THAT(device0->Attributes().map(),\n-              ElementsAre(Pair(\"name\", AttributeMap::StringValue(\"device0\"))));\n+  EXPECT_THAT(device0->Attributes().Get<std::string>(\"name\"),\n+              absl_testing::IsOkAndHolds(\"device0\"));\n \n   ASSERT_THAT(device0->Memories(), SizeIs(1));\n   auto* const memory0 = device0->Memories()[0];\n@@ -293,8 +292,8 @@ TEST_P(ClientTest, Init) {\n                           client_->LookupDevice(DeviceId(1)));\n   EXPECT_EQ(device1->Id(), 1);\n   EXPECT_EQ(device1->Kind(), \"mock\");\n-  EXPECT_THAT(device1->Attributes().map(),\n-              ElementsAre(Pair(\"name\", AttributeMap::StringValue(\"device1\"))));\n+  EXPECT_THAT(device1->Attributes().Get<std::string>(\"name\"),\n+              absl_testing::IsOkAndHolds(\"device1\"));\n \n   ASSERT_THAT(device1->Memories(), SizeIs(1));\n   auto* const memory1 = device1->Memories()[0];"
        },
        {
            "sha": "6636b7bfac72d880a3f8942b92c734568007bd76",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae839f61529fab9cf50c7b3735ad670b387547f2/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc?ref=ae839f61529fab9cf50c7b3735ad670b387547f2",
            "patch": "@@ -727,16 +727,10 @@ PjRtLoadedExecutable::Execute(absl::Span<ArrayRef> args,\n   }\n \n   if (options.custom_options.has_value()) {\n-    const auto& attributes = options.custom_options->map();\n-    // Check if the custom options contain a call location key.\n-    if (auto it = attributes.find(\n-            xla::ifrt::PjRtCompatibleLoadedExecutable::kCallLocation);\n-        it != attributes.end()) {\n-      const xla::ifrt::AttributeMap::Value& value = it->second;\n-      if (const auto* call_location =\n-              std::get_if<xla::ifrt::AttributeMap::StringValue>(&value)) {\n-        opts.call_location = call_location->value;\n-      }\n+    auto call_location = options.custom_options->Get<std::string>(\n+        std::string(xla::ifrt::PjRtCompatibleLoadedExecutable::kCallLocation));\n+    if (call_location.ok()) {\n+      opts.call_location = *call_location;\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 105,
        "additions": 44,
        "deletions": 61
    }
}