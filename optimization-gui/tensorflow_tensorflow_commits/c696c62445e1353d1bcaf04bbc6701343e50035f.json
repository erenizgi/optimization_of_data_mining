{
    "author": "tensorflower-gardener",
    "message": "Plumb priority into RunHandlerPool\n\nPiperOrigin-RevId: 804617443",
    "sha": "c696c62445e1353d1bcaf04bbc6701343e50035f",
    "files": [
        {
            "sha": "dd56183438284e9ceab91d931d849eb79eeb1194",
            "filename": "tensorflow/core/tfrt/graph_executor/graph_executor.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fgraph_executor%2Fgraph_executor.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fgraph_executor%2Fgraph_executor.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fgraph_executor%2Fgraph_executor.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -252,8 +252,9 @@ absl::StatusOr<std::unique_ptr<RequestInfo>> CreateRequestInfo(\n   } else {\n     request_id = GetNextStepId().id;\n     // Otherwise we use the global queue in `runtime`.\n-    TF_ASSIGN_OR_RETURN(request_info->request_queue_owner,\n-                        runtime.CreateRequestQueue(request_id));\n+    TF_ASSIGN_OR_RETURN(\n+        request_info->request_queue_owner,\n+        runtime.CreateRequestQueue(request_id, run_options.priority));\n     request_info->request_queue = request_info->request_queue_owner.get();\n   }\n   auto* request_queue = request_info->request_queue;"
        },
        {
            "sha": "83ca5b1aa7e11253843b1bdc2c0d245b8d852688",
            "filename": "tensorflow/core/tfrt/run_handler_thread_pool/run_handler_concurrent_work_queue.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -65,8 +65,12 @@ RunHandlerThreadWorkQueue::RunHandlerThreadWorkQueue(const Options& options)\n }\n \n absl::StatusOr<std::unique_ptr<tensorflow::tfrt_stub::WorkQueueInterface>>\n-RunHandlerThreadWorkQueue::InitializeRequest(int64_t request_id) const {\n+RunHandlerThreadWorkQueue::InitializeRequest(int64_t request_id,\n+                                             int priority) const {\n   RunHandlerOptions options;\n+  if (options_.enable_priority_based_queuing) {\n+    options.priority = priority;\n+  }\n   std::unique_ptr<RunHandler> handler =\n       handler_pool_->Get(request_id, options_.init_timeout_ms, options);\n   if (!handler) {\n@@ -131,7 +135,9 @@ std::ostream& operator<<(std::ostream& strm,\n               << options.use_adaptive_waiting_time\n               << \", wait_if_no_active_request = \"\n               << options.wait_if_no_active_request\n-              << \", enable_wake_up = \" << options.enable_wake_up << \"}\";\n+              << \", enable_wake_up = \" << options.enable_wake_up\n+              << \", enable_priority_based_queuing = \"\n+              << options.enable_priority_based_queuing << \" }\";\n }\n \n }  // namespace tf"
        },
        {
            "sha": "bfef743d110635251d43a3f00620d178400162df",
            "filename": "tensorflow/core/tfrt/run_handler_thread_pool/run_handler_concurrent_work_queue.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue.h?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -81,6 +81,9 @@ class RunHandlerThreadWorkQueue\n \n     // If true, threads will be waken up by new tasks.\n     bool enable_wake_up = true;\n+\n+    // If true, enables priority based queuing of requests.\n+    bool enable_priority_based_queuing = false;\n   };\n \n   explicit RunHandlerThreadWorkQueue(const Options& options);\n@@ -94,7 +97,7 @@ class RunHandlerThreadWorkQueue\n   }\n \n   absl::StatusOr<std::unique_ptr<tensorflow::tfrt_stub::WorkQueueInterface>>\n-  InitializeRequest(int64_t request_id) const override;\n+  InitializeRequest(int64_t request_id, int priority) const override;\n \n   int GetParallelismLevel() const override {\n     return options_.num_main_threads + options_.num_complementary_threads;"
        },
        {
            "sha": "383a229f984cf0cd3e4e66fefaa6a602a444626b",
            "filename": "tensorflow/core/tfrt/run_handler_thread_pool/run_handler_concurrent_work_queue_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Frun_handler_thread_pool%2Frun_handler_concurrent_work_queue_test.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -61,7 +61,7 @@ class RunHandlerThreadWorkQueueTest : public ::testing::Test {\n                                           std::move(work_queue));\n     RequestContextBuilder req_ctx_builder{host_.get(),\n                                           /*resource_context=*/nullptr};\n-    auto queue = pool_->InitializeRequest(/*request_id=*/100);\n+    auto queue = pool_->InitializeRequest(/*request_id=*/100, /*priority=*/0);\n     TF_CHECK_OK(queue.status());\n     queue_ = std::move(*queue);\n     auto req_ctx = std::move(req_ctx_builder).build();\n@@ -183,7 +183,7 @@ TEST_F(RunHandlerThreadWorkQueueTest, NoHandlerReturnsError) {\n   auto queue = std::make_unique<RunHandlerThreadWorkQueue>(options);\n   tfrt::RequestContextBuilder ctx_builder(nullptr, nullptr);\n   EXPECT_THAT(\n-      queue->InitializeRequest(/*request_id=*/100),\n+      queue->InitializeRequest(/*request_id=*/100, /*priority=*/0),\n       absl_testing::StatusIs(\n           absl::StatusCode::kDeadlineExceeded,\n           \"Could not obtain RunHandler for request after waiting for 1 ms.\"));"
        },
        {
            "sha": "208363a315f6ce42a8cfd3c228ec7179250f49e7",
            "filename": "tensorflow/core/tfrt/runtime/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2FBUILD?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -115,7 +115,6 @@ cc_library(\n         \"//tensorflow/core/tfrt/utils:thread_pool\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/status:statusor\",\n-        \"@llvm-project//llvm:Support\",\n         \"@tf_runtime//:hostcontext\",\n         \"@tf_runtime//:support\",\n     ],\n@@ -189,14 +188,11 @@ tf_cc_test(\n     deps = [\n         \":tf_threadpool_concurrent_work_queue\",\n         \"//tensorflow/core:framework_internal\",\n-        \"//tensorflow/core:lib\",\n         \"//tensorflow/core:test\",\n         \"//tensorflow/core:test_main\",\n         \"//tensorflow/core/platform:errors\",\n         \"//tensorflow/core/platform:status_matchers\",\n         \"//tensorflow/core/tfrt/utils:thread_pool\",\n-        \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/time\",\n         \"@com_google_googletest//:gtest\",\n         \"@tf_runtime//:hostcontext\",\n         \"@tf_runtime//:support\","
        },
        {
            "sha": "19c8ecbd31e58b7277b7830cf5bfdb6907984d2b",
            "filename": "tensorflow/core/tfrt/runtime/runtime.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fruntime.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fruntime.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fruntime.h?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -218,12 +218,12 @@ class Runtime {\n \n   // Creates a work queue for a request.\n   absl::StatusOr<std::unique_ptr<WorkQueueInterface>> CreateRequestQueue(\n-      int64_t request_id) const {\n+      int64_t request_id, int priority) const {\n     if (create_request_queue_fn_) {\n       return create_request_queue_fn_(request_id);\n     }\n \n-    return work_queue_->InitializeRequest(request_id);\n+    return work_queue_->InitializeRequest(request_id, priority);\n   }\n \n  private:"
        },
        {
            "sha": "4659006f649fa9782776eacba0d93da4315941f3",
            "filename": "tensorflow/core/tfrt/runtime/tf_threadpool_concurrent_work_queue.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -37,7 +37,8 @@ namespace tfrt_stub {\n using ::tensorflow::thread::ThreadPoolInterface;\n \n absl::StatusOr<std::unique_ptr<WorkQueueInterface>>\n-TfThreadPoolWorkQueue::InitializeRequest(int64_t request_id) const {\n+TfThreadPoolWorkQueue::InitializeRequest(int64_t request_id,\n+                                         int priority) const {\n   return {std::make_unique<TfThreadPoolWorkQueue>(\n       request_id, intra_op_threadpool_, inter_op_threadpool_)};\n }"
        },
        {
            "sha": "6d04169aea8cfe530461017222c55614bfe9e82b",
            "filename": "tensorflow/core/tfrt/runtime/tf_threadpool_concurrent_work_queue.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue.h?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -53,7 +53,7 @@ class TfThreadPoolWorkQueue : public WorkQueueInterface {\n         inter_op_threadpool_(inter_op_threadpool) {}\n \n   absl::StatusOr<std::unique_ptr<WorkQueueInterface>> InitializeRequest(\n-      int64_t request_id) const override;\n+      int64_t request_id, int priority) const override;\n \n   int GetParallelismLevel() const override {\n     return inter_op_threadpool_->NumThreads();"
        },
        {
            "sha": "bc7f37654ea1a94830ef567e99057bd406f42581",
            "filename": "tensorflow/core/tfrt/runtime/tf_threadpool_concurrent_work_queue_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Ftf_threadpool_concurrent_work_queue_test.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -52,7 +52,8 @@ TEST_F(TfThreadpoolWorkQueueTest, GetNameOk) {\n TEST_F(TfThreadpoolWorkQueueTest, InitializeRequestOk) {\n   tfrt::RequestContextBuilder ctx_builder(/*host=*/nullptr,\n                                           /*resource_context=*/nullptr);\n-  auto queue = tf_threadpool_cwq_->InitializeRequest(/*request_id=*/0);\n+  auto queue =\n+      tf_threadpool_cwq_->InitializeRequest(/*request_id=*/0, /*priority=*/0);\n   TF_ASSERT_OK(queue.status());\n   EXPECT_NE(*queue, nullptr);\n   EXPECT_NE((*queue)->GetIntraOpThreadPool(), nullptr);"
        },
        {
            "sha": "40f15e4e97ffd0b43fb6c9cc949ce26e755ca459",
            "filename": "tensorflow/core/tfrt/runtime/work_queue_interface.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -78,7 +78,7 @@ class DefaultWorkQueueWrapper : public WorkQueueInterface {\n   }\n \n   absl::StatusOr<std::unique_ptr<WorkQueueInterface>> InitializeRequest(\n-      int64_t request_id) const override {\n+      int64_t request_id, int priority) const override {\n     return {std::make_unique<DefaultWorkQueueWrapper>(request_id, work_queue_,\n                                                       GetIntraOpThreadPool())};\n   }"
        },
        {
            "sha": "11e09d622c3354122f01bc17262c4ac689d13a36",
            "filename": "tensorflow/core/tfrt/runtime/work_queue_interface.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface.h?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -61,7 +61,7 @@ class WorkQueueInterface : public tfrt::ConcurrentWorkQueue {\n   // should be handled separately.\n   ABSL_DEPRECATED(\"Create the instance directly instead.\")\n   virtual absl::StatusOr<std::unique_ptr<WorkQueueInterface>> InitializeRequest(\n-      int64_t request_id) const {\n+      int64_t request_id, int priority) const {\n     return {nullptr};\n   }\n "
        },
        {
            "sha": "408475eb054bf6197f011ad04fb40852ba025e20",
            "filename": "tensorflow/core/tfrt/runtime/work_queue_interface_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c696c62445e1353d1bcaf04bbc6701343e50035f/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fruntime%2Fwork_queue_interface_test.cc?ref=c696c62445e1353d1bcaf04bbc6701343e50035f",
            "patch": "@@ -86,7 +86,7 @@ TEST(DefaultWorkQueueWrapperTest, IntraOpThreadPool) {\n       WrapDefaultWorkQueue(std::move(work_queue), &intra_op_thread_pool);\n \n   TF_ASSERT_OK_AND_ASSIGN(auto queue, work_queue_wrapper->InitializeRequest(\n-                                          /*request_id=*/0));\n+                                          /*request_id=*/0, /*priority=*/0));\n   EXPECT_NE(queue, nullptr);\n   EXPECT_EQ(queue->GetIntraOpThreadPool(), &intra_op_thread_pool);\n }"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 27,
        "deletions": 19
    }
}