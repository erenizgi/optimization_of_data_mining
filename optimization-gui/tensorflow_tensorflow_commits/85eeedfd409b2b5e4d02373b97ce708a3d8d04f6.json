{
    "author": "bmass02",
    "message": "Fix heap-use-after-free errors in subprocess profiler by cancelling gRPC after failures.\n\nPiperOrigin-RevId: 809113783",
    "sha": "85eeedfd409b2b5e4d02373b97ce708a3d8d04f6",
    "files": [
        {
            "sha": "f447c86ce7cdd8162826f9b612bc00559b8ab9c7",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/85eeedfd409b2b5e4d02373b97ce708a3d8d04f6/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/85eeedfd409b2b5e4d02373b97ce708a3d8d04f6/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2FBUILD?ref=85eeedfd409b2b5e4d02373b97ce708a3d8d04f6",
            "patch": "@@ -54,6 +54,7 @@ cc_library(\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/profiler/utils:xplane_schema\",\n+        \"@com_google_absl//absl/cleanup\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "171193cf3083b490dd7bdf1c0d5fdd85d18a348d",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/subprocess_profiling_session.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/85eeedfd409b2b5e4d02373b97ce708a3d8d04f6/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/85eeedfd409b2b5e4d02373b97ce708a3d8d04f6/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session.cc?ref=85eeedfd409b2b5e4d02373b97ce708a3d8d04f6",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"absl/cleanup/cleanup.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_cat.h\"\n@@ -124,6 +125,9 @@ absl::Status SubprocessProfilingSession::Stop() {\n     return absl::FailedPreconditionError(\n         \"Subprocess profiling session not started.\");\n   }\n+  // If there is an error, make sure to cancel the context to avoid\n+  // heap-use-after-free inside the gRPC library.\n+  absl::Cleanup cleanup = [&]() { context_.TryCancel(); };\n   tensorflow::TerminateRequest terminate_request;\n   terminate_request.set_session_id(request_.session_id());\n   tensorflow::TerminateResponse terminate_response;"
        },
        {
            "sha": "270d445c1007c20710125a5cb205471e77384c84",
            "filename": "third_party/xla/xla/backends/profiler/subprocess/subprocess_profiling_session_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/85eeedfd409b2b5e4d02373b97ce708a3d8d04f6/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/85eeedfd409b2b5e4d02373b97ce708a3d8d04f6/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fsubprocess%2Fsubprocess_profiling_session_test.cc?ref=85eeedfd409b2b5e4d02373b97ce708a3d8d04f6",
            "patch": "@@ -92,7 +92,7 @@ class SubprocessProfilingSessionTest : public ::testing::Test {\n           IsOk());\n     }\n     // Wait for connections to be established.\n-    absl::SleepFor(absl::Seconds(1));\n+    absl::SleepFor(absl::Seconds(num_subprocesses + 1));\n   }\n \n   void TearDown() override {"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 6,
        "deletions": 1
    }
}