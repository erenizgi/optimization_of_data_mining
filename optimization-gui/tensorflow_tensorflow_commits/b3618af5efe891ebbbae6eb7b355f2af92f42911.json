{
    "author": "matthiaskramm",
    "message": "Implement GetDefaultLayout (on topologies) in PJRT C API and wrapper+client.\n\nPiperOrigin-RevId: 800708329",
    "sha": "b3618af5efe891ebbbae6eb7b355f2af92f42911",
    "files": [
        {
            "sha": "0797b06e1524e75452111e849b954573f77626d8",
            "filename": "third_party/xla/xla/pjrt/c/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FBUILD?ref=b3618af5efe891ebbbae6eb7b355f2af92f42911",
            "patch": "@@ -530,6 +530,7 @@ xla_test(\n         \":pjrt_c_api_gpu_internal\",\n         \":pjrt_c_api_hdrs\",\n         \":pjrt_c_api_helpers\",\n+        \":pjrt_c_api_layouts_extension_hdrs\",\n         \":pjrt_c_api_test_base\",\n         \":pjrt_c_api_test_common\",\n         \":pjrt_c_api_triton_extension_hdrs\",\n@@ -557,8 +558,10 @@ xla_test(\n         \"//xla/tsl/platform:status_matchers\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n+        \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "34c6a056931368517bac991fc1d336919ba45ac7",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_layouts_extension.h",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_layouts_extension.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_layouts_extension.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_layouts_extension.h?ref=b3618af5efe891ebbbae6eb7b355f2af92f42911",
            "patch": "@@ -36,7 +36,7 @@ extern \"C\" {\n // https://github.com/openxla/xla/blob/main/xla/pjrt/layout_mode.h for more\n // details.\n \n-#define PJRT_API_LAYOUTS_EXTENSION_VERSION 1\n+#define PJRT_API_LAYOUTS_EXTENSION_VERSION 2\n \n // -------------------------------- Data types ---------------------------------\n \n@@ -108,21 +108,37 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Layouts_PJRT_Client_GetDefaultLayout_Args,\n typedef PJRT_Error* PJRT_Layouts_PJRT_Client_GetDefaultLayout(\n     PJRT_Layouts_PJRT_Client_GetDefaultLayout_Args* args);\n \n+struct PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args {\n+  size_t struct_size;\n+  PJRT_Extension_Base* extension_start;\n+  PJRT_TopologyDescription* topology_description;\n+  PJRT_Buffer_Type type;\n+  const int64_t* dims;\n+  size_t num_dims;\n+  PJRT_Layouts_MemoryLayout* layout;  // out\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args,\n+                          layout);\n+\n+// Returns the default memory layout for a topology.\n+typedef PJRT_Error* PJRT_Layouts_PJRT_Topology_GetDefaultLayout(\n+    PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args* args);\n+\n // --------------------------- Extension entrypoint ----------------------------\n \n typedef struct PJRT_Layouts_Extension {\n   PJRT_Extension_Base base;\n \n   PJRT_Layouts_MemoryLayout_Destroy* PJRT_Layouts_MemoryLayout_Destroy;\n   PJRT_Layouts_MemoryLayout_Serialize* PJRT_Layouts_MemoryLayout_Serialize;\n-\n   PJRT_Layouts_PJRT_Client_GetDefaultLayout*\n       PJRT_Layouts_PJRT_Client_GetDefaultLayout;\n-\n   PJRT_Layouts_PJRT_Buffer_MemoryLayout* PJRT_Layouts_PJRT_Buffer_MemoryLayout;\n+  PJRT_Layouts_PJRT_Topology_GetDefaultLayout*\n+      PJRT_Layouts_PJRT_Topology_GetDefaultLayout;\n } PJRT_Layouts_Extension;\n PJRT_DEFINE_STRUCT_TRAITS(PJRT_Layouts_Extension,\n-                          PJRT_Layouts_PJRT_Buffer_MemoryLayout);\n+                          PJRT_Layouts_PJRT_Topology_GetDefaultLayout);\n \n #ifdef __cplusplus\n }"
        },
        {
            "sha": "e96d853334cba13a0469714b3569595f39a256a1",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=b3618af5efe891ebbbae6eb7b355f2af92f42911",
            "patch": "@@ -48,6 +48,7 @@ limitations under the License.\n #include \"xla/pjrt/c/pjrt_c_api.h\"\n #include \"xla/pjrt/c/pjrt_c_api_helpers.h\"\n #include \"xla/pjrt/c/pjrt_c_api_layouts_extension.h\"\n+#include \"xla/pjrt/c/pjrt_c_api_memory_descriptions_extension.h\"\n #include \"xla/pjrt/distributed/key_value_store_interface.h\"\n #include \"xla/pjrt/mlir_to_hlo.h\"\n #include \"xla/pjrt/pjrt_client.h\"\n@@ -70,7 +71,6 @@ limitations under the License.\n #include \"xla/util.h\"\n #include \"xla/xla.pb.h\"\n #include \"xla/xla_data.pb.h\"\n-#include \"tsl/platform/casts.h\"\n #include \"tsl/profiler/lib/connected_traceme.h\"\n #include \"tsl/profiler/lib/context_types.h\"\n \n@@ -2509,6 +2509,8 @@ PJRT_Error* PJRT_TopologyDescription_Deserialize(\n   return nullptr;\n }\n \n+// ---------------------------------- Layouts ----------------------------------\n+\n PJRT_Error* PJRT_Layouts_MemoryLayout_Destroy(\n     PJRT_Layouts_MemoryLayout_Destroy_Args* args) {\n   PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n@@ -2561,6 +2563,23 @@ PJRT_Error* PJRT_Layouts_PJRT_Buffer_MemoryLayout(\n   return nullptr;\n }\n \n+PJRT_Error* PJRT_Layouts_PJRT_Topology_GetDefaultLayout(\n+    PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args* args) {\n+  PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n+      \"PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args\",\n+      PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args_STRUCT_SIZE,\n+      args->struct_size));\n+\n+  PJRT_ASSIGN_OR_RETURN(xla::Layout xla_layout,\n+                        args->topology_description->topology->GetDefaultLayout(\n+                            ConvertFromPjRtBufferType(args->type),\n+                            absl::MakeSpan(args->dims, args->num_dims)));\n+\n+  auto pjrt_xla_layout = std::make_shared<xla::PjRtLayout>(xla_layout);\n+  args->layout = new PJRT_Layouts_MemoryLayout{std::move(pjrt_xla_layout)};\n+  return nullptr;\n+}\n+\n static std::vector<PJRT_NamedValue> PopulatePjrtAttributes(\n     const absl::flat_hash_map<std::string, xla::PjRtDeviceAttribute>&\n         attributes) {\n@@ -2967,6 +2986,8 @@ PJRT_Layouts_Extension CreateLayoutsExtension(PJRT_Extension_Base* next) {\n       pjrt::PJRT_Layouts_PJRT_Client_GetDefaultLayout,\n       /*PJRT_Layouts_PJRT_Buffer_MemoryLayout=*/\n       pjrt::PJRT_Layouts_PJRT_Buffer_MemoryLayout,\n+      /*PJRT_Layouts_PJRT_Topology_GetDefaultLayout=*/\n+      &PJRT_Layouts_PJRT_Topology_GetDefaultLayout,\n   };\n }\n "
        },
        {
            "sha": "d1412e13ecb48029252c43fd37653ce1f78009ba",
            "filename": "third_party/xla/xla/pjrt/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc?ref=b3618af5efe891ebbbae6eb7b355f2af92f42911",
            "patch": "@@ -2799,6 +2799,64 @@ absl::StatusOr<std::string> PjRtCApiTopologyDescription::Serialize() const {\n   return out;\n }\n \n+absl::StatusOr<Layout> PjRtCApiTopologyDescription::GetDefaultLayout(\n+    PrimitiveType element_type, absl::Span<const int64_t> dims) const {\n+  const PJRT_Api* c_api = c_api_;\n+  PJRT_Layouts_Extension* extension =\n+      pjrt::FindExtension<PJRT_Layouts_Extension>(\n+          c_api, PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n+  if (extension == nullptr ||\n+      extension->PJRT_Layouts_PJRT_Topology_GetDefaultLayout == nullptr) {\n+    return Unimplemented(\n+        \"PJRT C API does not implement \"\n+        \"PJRT_Layouts_PJRT_Topology_GetDefaultLayout.\");\n+  }\n+  PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args args;\n+  args.struct_size =\n+      PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args_STRUCT_SIZE;\n+  args.extension_start = nullptr;\n+  args.topology_description = c_topology_;\n+  args.type = pjrt::ConvertToPjRtBufferType(element_type);\n+  args.dims = dims.data();\n+  args.num_dims = dims.size();\n+  RETURN_STATUS_IF_PJRT_ERROR(\n+      extension->PJRT_Layouts_PJRT_Topology_GetDefaultLayout(&args), c_api);\n+\n+  // Clean up `PJRT_Layouts_MemoryLayout`.\n+  std::unique_ptr<PJRT_Layouts_MemoryLayout,\n+                  pjrt::PJRT_Layouts_MemoryLayoutDeleter>\n+      layout_destroyer(args.layout, pjrt::MakeMemoryLayoutDeleter(c_api));\n+\n+  if (extension->PJRT_Layouts_MemoryLayout_Serialize == nullptr) {\n+    return Unimplemented(\n+        \"PJRT_Layouts_MemoryLayout_Serialize is not implemented.\");\n+  }\n+\n+  // TODO(b/338478940): Wrap `args.layout` into a subclass of `PjRtLayout`.\n+  PJRT_Layouts_MemoryLayout_Serialize_Args serialize_args;\n+  serialize_args.struct_size =\n+      PJRT_Layouts_MemoryLayout_Serialize_Args_STRUCT_SIZE;\n+  serialize_args.extension_start = nullptr;\n+  serialize_args.layout = args.layout;\n+  RETURN_STATUS_IF_PJRT_ERROR(\n+      extension->PJRT_Layouts_MemoryLayout_Serialize(&serialize_args), c_api);\n+\n+  // Clean up `PJRT_Layouts_SerializedLayout`.\n+  absl::Cleanup cleanup = [&serialize_args] {\n+    if (serialize_args.serialized_layout_deleter) {\n+      serialize_args.serialized_layout_deleter(\n+          serialize_args.serialized_layout);\n+    }\n+  };\n+\n+  std::string serialized_layout(serialize_args.serialized_bytes,\n+                                serialize_args.serialized_bytes_size);\n+  TF_ASSIGN_OR_RETURN(std::shared_ptr<const PjRtLayout> pjrt_layout,\n+                      PjRtLayout::Deserialize(serialized_layout));\n+\n+  return pjrt_layout->xla_layout();\n+}\n+\n void PjRtCApiTopologyDescription::InitAttributes() {\n   PJRT_TopologyDescription_Attributes_Args args;\n   args.struct_size = PJRT_TopologyDescription_Attributes_Args_STRUCT_SIZE;"
        },
        {
            "sha": "8f008893fc36c5a9423c5d38aa0f947a87c26951",
            "filename": "third_party/xla/xla/pjrt/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.h?ref=b3618af5efe891ebbbae6eb7b355f2af92f42911",
            "patch": "@@ -249,9 +249,7 @@ class PjRtCApiTopologyDescription : public PjRtTopologyDescription {\n \n   absl::StatusOr<Layout> GetDefaultLayout(\n       PrimitiveType element_type,\n-      absl::Span<const int64_t> dims) const override {\n-    return Unimplemented(\"PJRT C API does not support GetDefaultLayout\");\n-  }\n+      absl::Span<const int64_t> dims) const override;\n \n  private:\n   std::unique_ptr<PjRtCApiCompiler> compiler_;"
        },
        {
            "sha": "8dbb2f4099c0fe7303dce3e9ecda99771774b48b",
            "filename": "third_party/xla/xla/pjrt/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3618af5efe891ebbbae6eb7b355f2af92f42911/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client_test.cc?ref=b3618af5efe891ebbbae6eb7b355f2af92f42911",
            "patch": "@@ -38,6 +38,8 @@ limitations under the License.\n #include \"xla/hlo/builder/xla_builder.h\"\n #include \"xla/hlo/builder/xla_computation.h\"\n #include \"xla/hlo/parser/hlo_parser.h\"\n+#include \"xla/layout.h\"\n+#include \"xla/layout_util.h\"\n #include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/pjrt/c/pjrt_c_api.h\"\n@@ -159,6 +161,23 @@ TEST(PjRtCApiClientTest, TopologyPlatformIdAndName) {\n   EXPECT_EQ(topology->platform_id(), xla::CpuId());\n }\n \n+TEST(PjRtCApiClientTest, TopologyGetDefaultLayout) {\n+  SetUpCpuPjRtApi();\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                          GetCApiClient(\"cpu\"));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(const PjRtTopologyDescription* topology,\n+                          client->GetTopologyDescription());\n+  ASSERT_NE(topology, nullptr);\n+\n+  std::vector<int64_t> dims = {2, 3, 4};\n+  TF_ASSERT_OK_AND_ASSIGN(Layout layout,\n+                          topology->GetDefaultLayout(PrimitiveType::F32, dims));\n+\n+  Layout expected_layout = LayoutUtil::MakeDescendingLayout(dims.size());\n+  EXPECT_EQ(layout, expected_layout);\n+}\n+\n TEST(PjRtCApiClientTest, NonEmptyExecutableFingerprint) {\n   SetUpCpuPjRtApi();\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 123,
        "deletions": 8
    }
}