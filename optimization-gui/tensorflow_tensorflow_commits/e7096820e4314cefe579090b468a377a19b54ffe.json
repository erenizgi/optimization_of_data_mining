{
    "author": "majnemer",
    "message": "[XLA] Use absl::StatusCode in MakeErrorStream\n\nMigrate away from older types.\n\nPiperOrigin-RevId: 810574017",
    "sha": "e7096820e4314cefe579090b468a377a19b54ffe",
    "files": [
        {
            "sha": "afcd59b667a4182e4fc450bd1d88036b6d7fa5f5",
            "filename": "tensorflow/python/_pywrap_tensorflow.def",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7096820e4314cefe579090b468a377a19b54ffe/tensorflow%2Fpython%2F_pywrap_tensorflow.def",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7096820e4314cefe579090b468a377a19b54ffe/tensorflow%2Fpython%2F_pywrap_tensorflow.def",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2F_pywrap_tensorflow.def?ref=e7096820e4314cefe579090b468a377a19b54ffe",
            "patch": "@@ -69,13 +69,13 @@ EXPORTS\n   ??0GraphDef@tensorflow@@IEAA@PEAVArena@protobuf@google@@@Z\n   ??0GraphDef@tensorflow@@IEAA@PEAVArena@protobuf@google@@AEBV01@@Z\n   ??0HistogramProto@tensorflow@@IEAA@PEAVArena@protobuf@google@@@Z\n-  ??0Impl@MakeErrorStream@status_macros@xla@@QEAA@PEBDHW4Code@error@tensorflow@@PEAV123@_N@Z\n   ??0LayoutProto@dtensor@tensorflow@@IEAA@PEAVArena@protobuf@google@@@Z\n   ??0LayoutProto@dtensor@tensorflow@@IEAA@PEAVArena@protobuf@google@@AEBV012@@Z\n   ??0LogMessage@log_internal@lts_20250814@absl@@QEAA@PEBDHUInfoTag@0123@@Z\n   ??0LogMessageFatal@log_internal@lts_20250814@absl@@QEAA@PEBDH0@Z\n   ??0LogMessageFatal@log_internal@lts_20250814@absl@@QEAA@PEBDH@Z\n   ??0MLIRContext@mlir@@QEAA@AEBVDialectRegistry@1@W4Threading@01@@Z\n+  ??0MakeErrorStream@status_macros@xla@@QEAA@PEBDHW4StatusCode@lts_20250814@absl@@@Z\n   ??0MeasuringCostEstimator@grappler@tensorflow@@QEAA@PEAVCluster@12@HH@Z\n   ??0MeshProto@dtensor@tensorflow@@IEAA@PEAVArena@protobuf@google@@@Z\n   ??0MeshProto@dtensor@tensorflow@@IEAA@PEAVArena@protobuf@google@@AEBV012@@Z"
        },
        {
            "sha": "000ea350b90f26273353376c222100cbd3280d5b",
            "filename": "third_party/xla/xla/status_macros.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 23,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7096820e4314cefe579090b468a377a19b54ffe/third_party%2Fxla%2Fxla%2Fstatus_macros.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7096820e4314cefe579090b468a377a19b54ffe/third_party%2Fxla%2Fxla%2Fstatus_macros.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstatus_macros.cc?ref=e7096820e4314cefe579090b468a377a19b54ffe",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/status_macros.h\"\n \n+#include <memory>\n #include <string>\n \n #include \"absl/base/attributes.h\"\n@@ -84,6 +85,10 @@ static absl::Status MakeError(const char* filename, int line,\n   return status;\n }\n \n+MakeErrorStream::MakeErrorStream(const char* file, int line,\n+                                 absl::StatusCode code)\n+    : impl_(std::make_unique<Impl>(file, line, code, this)) {}\n+\n MakeErrorStream::MakeErrorStreamWithOutput&\n MakeErrorStream::add_ret_check_failure(const char* condition) {\n   return *this << \"RET_CHECK failure (\" << impl_->file_ << \":\" << impl_->line_\n@@ -94,36 +99,16 @@ MakeErrorStream::add_ret_check_failure(const char* condition) {\n // generating a lot of inline code for error cases in all callers.\n void MakeErrorStream::CheckNotDone() const { impl_->CheckNotDone(); }\n \n-MakeErrorStream::Impl::Impl(const char* file, int line, tsl::error::Code code,\n-                            MakeErrorStream* error_stream,\n-                            bool is_logged_by_default)\n-    : file_(file),\n-      line_(line),\n-      code_(static_cast<absl::StatusCode>(code)),\n-      is_done_(false),\n-      should_log_(is_logged_by_default),\n-      log_severity_(absl::LogSeverity::kError),\n-      should_log_stack_trace_(false),\n-      make_error_stream_with_output_wrapper_(error_stream) {}\n-\n-MakeErrorStream::Impl::Impl(const absl::Status& status,\n-                            PriorMessageHandling prior_message_handling,\n-                            const char* file, int line,\n+MakeErrorStream::Impl::Impl(const char* file, int line, absl::StatusCode code,\n                             MakeErrorStream* error_stream)\n     : file_(file),\n       line_(line),\n-      // Make sure we show some error, even if the call is incorrect.\n-      code_(!status.ok() ? static_cast<absl::StatusCode>(status.code())\n-                         : absl::StatusCode::kUnknown),\n-      prior_message_handling_(prior_message_handling),\n-      prior_message_(status.message()),\n+      code_(code),\n       is_done_(false),\n       should_log_(true),\n       log_severity_(absl::LogSeverity::kError),\n       should_log_stack_trace_(false),\n-      make_error_stream_with_output_wrapper_(error_stream) {\n-  DCHECK(!status.ok()) << \"Attempted to append/prepend error text to status OK\";\n-}\n+      make_error_stream_with_output_wrapper_(error_stream) {}\n \n MakeErrorStream::Impl::~Impl() {\n   // Note: error messages refer to the public MakeErrorStream class."
        },
        {
            "sha": "8b4672ebb67dbd0264afb174ee72c42da36fc101",
            "filename": "third_party/xla/xla/status_macros.h",
            "status": "modified",
            "additions": 12,
            "deletions": 22,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7096820e4314cefe579090b468a377a19b54ffe/third_party%2Fxla%2Fxla%2Fstatus_macros.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7096820e4314cefe579090b468a377a19b54ffe/third_party%2Fxla%2Fxla%2Fstatus_macros.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstatus_macros.h?ref=e7096820e4314cefe579090b468a377a19b54ffe",
            "patch": "@@ -172,8 +172,7 @@ class MakeErrorStream {\n   enum PriorMessageHandling { kAppendToPriorMessage, kPrependToPriorMessage };\n \n   // Make an error with the given code.\n-  template <typename ERROR_CODE_TYPE>\n-  MakeErrorStream(const char* file, int line, ERROR_CODE_TYPE code);\n+  MakeErrorStream(const char* file, int line, absl::StatusCode code);\n \n   // Returns a MakeErrorStreamWithOutput as we don't require more calls to\n   // operator<< on the result.\n@@ -215,11 +214,8 @@ class MakeErrorStream {\n  private:\n   class Impl {\n    public:\n-    Impl(const char* file, int line, tsl::error::Code code,\n-         MakeErrorStream* error_stream, bool is_logged_by_default = true);\n-    Impl(const absl::Status& status,\n-         PriorMessageHandling prior_message_handling, const char* file,\n-         int line, MakeErrorStream* error_stream);\n+    Impl(const char* file, int line, absl::StatusCode code,\n+         MakeErrorStream* error_stream);\n \n     ~Impl();\n \n@@ -266,12 +262,6 @@ class MakeErrorStream {\n   MakeErrorStream& operator=(const MakeErrorStream&) = delete;\n };\n \n-template <typename ERROR_CODE_TYPE>\n-TF_ATTRIBUTE_NOINLINE MakeErrorStream::MakeErrorStream(const char* file,\n-                                                       int line,\n-                                                       ERROR_CODE_TYPE code)\n-    : impl_(new Impl(file, line, code, this, true)) {}\n-\n // Provides a conversion to bool so that it can be used inside an if statement\n // that declares a variable.\n class StatusAdaptorForMacros {\n@@ -296,19 +286,19 @@ class StatusAdaptorForMacros {\n // Returns a Status error if the condition is false. The condition text is\n // included in the error message. The caller can optionally stream more error\n // messages after the macro.\n-#define TF_RET_CHECK(condition)                                      \\\n-  /* NOLINTNEXTLINE(readability-simplify-boolean-expr) */            \\\n-  while (ABSL_PREDICT_FALSE(!(condition)))                           \\\n-  return xla::status_macros::MakeErrorStream(__FILE__, __LINE__,     \\\n-                                             ::tsl::error::INTERNAL) \\\n-      .with_log_stack_trace()                                        \\\n+#define TF_RET_CHECK(condition)                                           \\\n+  /* NOLINTNEXTLINE(readability-simplify-boolean-expr) */                 \\\n+  while (ABSL_PREDICT_FALSE(!(condition)))                                \\\n+  return xla::status_macros::MakeErrorStream(__FILE__, __LINE__,          \\\n+                                             absl::StatusCode::kInternal) \\\n+      .with_log_stack_trace()                                             \\\n       .add_ret_check_failure(#condition)\n \n // Returns a Status error. The caller must stream at least one error message\n // after the macro.\n-#define XLA_RET_CHECK_FAIL()                                         \\\n-  return xla::status_macros::MakeErrorStream(__FILE__, __LINE__,     \\\n-                                             ::tsl::error::INTERNAL) \\\n+#define XLA_RET_CHECK_FAIL()                                              \\\n+  return xla::status_macros::MakeErrorStream(__FILE__, __LINE__,          \\\n+                                             absl::StatusCode::kInternal) \\\n       .with_log_stack_trace()\n \n #endif  // XLA_STATUS_MACROS_H_"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 21,
        "deletions": 46
    }
}