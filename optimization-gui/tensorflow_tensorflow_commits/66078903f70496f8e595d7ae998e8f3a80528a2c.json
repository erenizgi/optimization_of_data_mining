{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Original Value] Support original values for some cases in while loop simplifier pass\n\nThis updates the original value of a while loop if any unused parameters are removed.\n\nPiperOrigin-RevId: 825221785",
    "sha": "66078903f70496f8e595d7ae998e8f3a80528a2c",
    "files": [
        {
            "sha": "f2e2f9676277dfd3b38cbe2aa1aa3dd4214c7889",
            "filename": "third_party/xla/xla/service/while_loop_simplifier.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/66078903f70496f8e595d7ae998e8f3a80528a2c/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/66078903f70496f8e595d7ae998e8f3a80528a2c/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier.cc?ref=66078903f70496f8e595d7ae998e8f3a80528a2c",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/hlo/ir/hlo_original_value.h\"\n #include \"xla/hlo/ir/hlo_print_options.h\"\n #include \"xla/hlo/transforms/simplifiers/hlo_dce.h\"\n #include \"xla/hlo/utils/hlo_query.h\"\n@@ -150,6 +151,35 @@ static absl::StatusOr<HloInstruction*> RemoveDeadTupleIndices(\n     HloInstruction* while_op, absl::flat_hash_set<int64_t>& used_tuple_indices,\n     std::optional<absl::flat_hash_map<int32_t, int32_t>>\n         dead_to_surviving_index = std::nullopt) {\n+  auto copy_original_value =\n+      [&](const HloInstruction* src_instruction,\n+          HloInstruction* dest_instruction,\n+          const absl::flat_hash_map<int64_t, int64_t>& old_to_new_tuple_idx) {\n+        std::shared_ptr<OriginalValue> original_value =\n+            src_instruction->original_value();\n+        if (!original_value) {\n+          return;\n+        }\n+\n+        const int64_t src_tuple_size =\n+                          src_instruction->shape().tuple_shapes().size(),\n+                      dest_tuple_size =\n+                          dest_instruction->shape().tuple_shapes().size();\n+        std::shared_ptr<OriginalValue> old_original_value =\n+            src_instruction->original_value();\n+        std::shared_ptr<xla::OriginalValue> new_original_value =\n+            std::make_shared<xla::OriginalValue>(dest_instruction->shape());\n+        for (const auto& [old_idx, new_idx] : old_to_new_tuple_idx) {\n+          if (old_idx < 0 || old_idx >= src_tuple_size || new_idx < 0 ||\n+              new_idx >= dest_tuple_size) {\n+            return;\n+          }\n+          new_original_value->mutable_tree()->CopySubtreeFrom(\n+              old_original_value->tree(), {old_idx}, {new_idx});\n+        }\n+        dest_instruction->set_original_value(new_original_value);\n+      };\n+\n   // Build up maps from the old/new to the new/old tuple indices.\n   std::vector<int64_t> new_to_old_tuple_idx(used_tuple_indices.begin(),\n                                             used_tuple_indices.end());\n@@ -275,6 +305,9 @@ static absl::StatusOr<HloInstruction*> RemoveDeadTupleIndices(\n   CopyFrontendAttributes(while_op, new_while_op);\n   CopyMetadata(while_op, new_while_op);\n \n+  copy_original_value(while_init, new_while_init, old_to_new_tuple_idx);\n+  copy_original_value(while_op, new_while_op, old_to_new_tuple_idx);\n+\n   // Create a tuple op that recreates the output of the old while op.  That is,\n   // we transform to\n   //"
        },
        {
            "sha": "53b701ec86294c9778c061a90e20b7b72765023e",
            "filename": "third_party/xla/xla/service/while_loop_simplifier_test.cc",
            "status": "modified",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/66078903f70496f8e595d7ae998e8f3a80528a2c/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/66078903f70496f8e595d7ae998e8f3a80528a2c/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier_test.cc?ref=66078903f70496f8e595d7ae998e8f3a80528a2c",
            "patch": "@@ -1481,5 +1481,59 @@ ENTRY %main (arg.0: f32[3], arg.1: f32[2]) -> (f32[3], f32[2], f32[2], f32[3]) {\n                         op::GetTupleElement(op::While(), 0)));\n }\n \n+TEST_F(WhileLoopSimplifierTest, RemoveDeadTupleIndicesWithOriginalValue) {\n+  const std::string hlo_string = R\"(\n+  HloModule dus\n+\n+%while.body (arg_tuple: (f32[3], f32[2], f32[2], f32[3], s32[])) -> (f32[3], f32[2], f32[2], f32[3], s32[]) {\n+  %arg_tuple = (f32[3], f32[2], f32[2], f32[3], s32[]) parameter(0)\n+  %get-tuple-element.0 = f32[3] get-tuple-element(%arg_tuple), index=0\n+  %get-tuple-element.1 = f32[2] get-tuple-element(%arg_tuple), index=1\n+  %get-tuple-element.2 = f32[2] get-tuple-element(%arg_tuple), index=2\n+  %get-tuple-element.3 = f32[3] get-tuple-element(%arg_tuple), index=3\n+  %get-tuple-element.4 = s32[] get-tuple-element(%arg_tuple), index=4\n+  %constant.1 = s32[] constant(1)\n+  %constant.v0 = f32[1] constant({0.0})\n+  %constant.v1 = f32[1] constant({1.0})\n+  %dynamic-update-slice.0 = f32[3] dynamic-update-slice(%get-tuple-element.0, %constant.v0, s32[] %constant.1)\n+  %dynamic-update-slice.3 = f32[3] dynamic-update-slice(%get-tuple-element.3, %constant.v0, s32[] %constant.1)\n+  %add = add(s32[] %get-tuple-element.4, s32[] %constant.1)\n+  ROOT %tuple = tuple(%dynamic-update-slice.0, %get-tuple-element.1, %get-tuple-element.2, %dynamic-update-slice.3, %add)\n+}\n+\n+%while.condition (arg_tuple.cond:(f32[3], f32[2], f32[2], f32[3], s32[])) -> pred[] {\n+  %arg_tuple.cond = (f32[3], f32[2], f32[2], f32[3], s32[]) parameter(0)\n+  %get-tuple-element.cond = s32[] get-tuple-element(%arg_tuple.cond), index=4\n+  %constant.3 = s32[] constant(3)\n+  ROOT %compare = pred[] compare(s32[] %get-tuple-element.cond, s32[] %constant.3), direction=LT\n+}\n+\n+ENTRY %main (arg.0: f32[3], arg.1: f32[2]) -> (f32[3], f32[2], f32[2], f32[3]) {\n+  %constant.0 = s32[] constant(0)\n+  %arg.0 = f32[3] parameter(0)\n+  %arg.1 = f32[2] parameter(1)\n+  %input = tuple(%arg.0, %arg.1, %arg.1, %arg.0, %constant.0), origin={({\"arg.0\"}, {\"arg.1\"}, {\"arg.1\"}, {\"arg.0\"}, {\"constant.0\"})}\n+  %while = while(%input), condition=%while.condition, body=%while.body, origin={({\"while.116\" {0}}, {\"while.116\" {1}}, {\"while.116\" {2}}, {\"while.116\" {3}}, {\"while.116\" {4}})}\n+  %get-tuple-element.out0 = f32[3] get-tuple-element(%while), index=0\n+  %get-tuple-element.out1 = f32[2] get-tuple-element(%while), index=1\n+  %get-tuple-element.out2 = f32[2] get-tuple-element(%while), index=2\n+  %get-tuple-element.out3 = f32[3] get-tuple-element(%while), index=3\n+  ROOT %root = tuple(%get-tuple-element.out0, %get-tuple-element.out1, %get-tuple-element.out2, %get-tuple-element.out3)\n+}\n+)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  ASSERT_TRUE(WhileLoopSimplifier().Run(module.get()).value());\n+  HloInstruction* while_instr = FindFirstWhile(module.get());\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_EQ(while_instr->original_value()->ToString(),\n+            R\"(({\"while.116\" {0}}, {\"while.116\" {1}}, {\"while.116\" {4}}))\");\n+  HloInstruction* while_init = while_instr->while_init();\n+  ASSERT_NE(while_init->original_value(), nullptr);\n+  EXPECT_EQ(while_init->original_value()->ToString(),\n+            R\"(({\"arg.0\"}, {\"arg.1\"}, {\"constant.0\"}))\");\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 87,
        "deletions": 0
    }
}