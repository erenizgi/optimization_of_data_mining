{
    "author": "tensorflower-gardener",
    "message": "Merge pull request #100570 from kadirb4rut:fix/savedmodel-trim-and-validate\n\nPiperOrigin-RevId: 810046848",
    "sha": "d84def35861f843d508f69082756e5798e25ab8d",
    "files": [
        {
            "sha": "1104863acea37c151c0e36e277a7465c7f5bf90c",
            "filename": "tensorflow/python/tools/BUILD",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d84def35861f843d508f69082756e5798e25ab8d/tensorflow%2Fpython%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d84def35861f843d508f69082756e5798e25ab8d/tensorflow%2Fpython%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftools%2FBUILD?ref=d84def35861f843d508f69082756e5798e25ab8d",
            "patch": "@@ -3,7 +3,7 @@\n \n load(\"@rules_shell//shell:sh_test.bzl\", \"sh_test\")\n load(\"//tensorflow:strict.default.bzl\", \"py_strict_binary\", \"py_strict_library\", \"py_strict_test\")\n-load(\"//tensorflow:tensorflow.bzl\", \"if_google\", \"if_xla_available\", \"tf_cc_test\")\n+load(\"//tensorflow:tensorflow.bzl\", \"if_google\", \"if_xla_available\", \"tf_cc_test\", \"tf_py_test\")\n load(\"//tensorflow/core/platform:build_config_root.bzl\", \"if_pywrap\")\n load(\"//tensorflow/python/tools:tools.bzl\", \"saved_model_compile_aot\")\n \n@@ -590,6 +590,18 @@ tf_cc_test(\n     ]),\n )\n \n+tf_py_test(\n+    name = \"saved_model_cli_sanitize_list_test\",\n+    size = \"small\",\n+    srcs = [\"saved_model_cli_sanitize_list_test.py\"],\n+    python_version = \"PY3\",\n+    deps = [\n+        \":saved_model_cli\",\n+        \"//tensorflow/python/platform:client_testlib\",\n+        \"@absl_py//absl/testing:parameterized\",  # testte kullanılmıyorsa kaldırabilirsin\n+    ],\n+)\n+\n # copybara:uncomment_begin(google-only)\n # gensignature(\n #     name = \"inspect_checkpoint.par_sig\","
        },
        {
            "sha": "b271b8145e3c982f5afcabc71a154d77e5388b85",
            "filename": "tensorflow/python/tools/saved_model_cli.py",
            "status": "modified",
            "additions": 75,
            "deletions": 25,
            "changes": 100,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d84def35861f843d508f69082756e5798e25ab8d/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d84def35861f843d508f69082756e5798e25ab8d/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli.py?ref=d84def35861f843d508f69082756e5798e25ab8d",
            "patch": "@@ -234,6 +234,20 @@\n }\n \n \n+def _sanitize_nonempty_str_list(xs, name: str):\n+  \"\"\"Trim items, drop empties/None, require at least one non-empty string.\"\"\"\n+  out = []\n+  for x in xs:\n+    if x is None:\n+      continue\n+    s = str(x).strip()\n+    if s:\n+      out.append(s)\n+  if not out:\n+    raise ValueError(f'{name} must contain at least one non-empty item.')\n+  return out\n+\n+\n def _show_tag_sets(saved_model_dir):\n   \"\"\"Prints the tag-sets stored in SavedModel directory.\n \n@@ -283,8 +297,10 @@ def _show_ops_in_metagraph(saved_model_dir, tag_set):\n     tag_set: Group of tag(s) of the MetaGraphDef in string format, separated by\n       ','. For tag-set contains multiple tags, all tags must be passed in.\n   \"\"\"\n-  meta_graph_def = saved_model_utils.get_meta_graph_def(saved_model_dir,\n-                                                        tag_set)\n+  tags = _sanitize_nonempty_str_list(tag_set.split(','), 'tag_set')\n+  meta_graph_def = saved_model_utils.get_meta_graph_def(\n+      saved_model_dir, ','.join(tags)\n+  )\n   _show_ops_in_metagraph_mgd(meta_graph_def)\n \n \n@@ -342,8 +358,6 @@ def _get_outputs_tensor_info_from_meta_graph_def(meta_graph_def,\n   Args:\n     meta_graph_def: MetaGraphDef protocol buffer with the SignatureDefmap to\n     look up signature_def_key.\n-    signature_def_key: A SignatureDef key string.\n-\n   Returns:\n     A dictionary that maps output tensor keys to TensorInfos.\n   \"\"\"\n@@ -399,8 +413,9 @@ def _show_inputs_outputs(saved_model_dir, tag_set, signature_def_key, indent=0):\n     signature_def_key: A SignatureDef key string.\n     indent: How far (in increments of 2 spaces) to indent each line of output.\n   \"\"\"\n+  tags = _sanitize_nonempty_str_list(tag_set.split(','), 'tag_set')\n   meta_graph_def = saved_model_utils.get_meta_graph_def(\n-      saved_model_dir, tag_set\n+      saved_model_dir, ','.join(tags)\n   )\n   _show_inputs_outputs_mgd(meta_graph_def, signature_def_key, indent)\n \n@@ -601,7 +616,9 @@ def get_signature_def_map(saved_model_dir, tag_set):\n \n def _get_op_denylist_set(op_denylist):\n   # Note: Discard empty ops so that \"\" can mean the empty denylist set.\n-  set_of_denylisted_ops = set([op for op in op_denylist.split(',') if op])\n+  set_of_denylisted_ops = {\n+      op.strip() for op in op_denylist.split(',') if op and op.strip()\n+  }\n   return set_of_denylisted_ops\n \n \n@@ -671,8 +688,10 @@ def run_saved_model_with_feed_dict(saved_model_dir,\n     enabled.\n   \"\"\"\n   # Get a list of output tensor names.\n-  meta_graph_def = saved_model_utils.get_meta_graph_def(saved_model_dir,\n-                                                        tag_set)\n+  tags = _sanitize_nonempty_str_list(tag_set.split(','), 'tag_set')\n+  meta_graph_def = saved_model_utils.get_meta_graph_def(\n+      saved_model_dir, ','.join(tags)\n+  )\n \n   # Re-create feed_dict based on input tensor name instead of key as session.run\n   # uses tensor name.\n@@ -713,7 +732,7 @@ def run_saved_model_with_feed_dict(saved_model_dir,\n       # restarts after a preemption.\n       sess.run(tpu.initialize_system())\n \n-    loader.load(sess, tag_set.split(','), saved_model_dir)\n+    loader.load(sess, tags, saved_model_dir)\n \n     if tf_debug:\n       sess = local_cli_wrapper.LocalCLIDebugWrapperSession(sess)\n@@ -1049,15 +1068,21 @@ def run():\n def scan():\n   \"\"\"Function triggered by scan command.\"\"\"\n   if _SMCLI_TAG_SET.value and _SMCLI_OP_DENYLIST.value:\n+    tags = ','.join(\n+        _sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set')\n+    )\n     scan_meta_graph_def(\n-        saved_model_utils.get_meta_graph_def(\n-            _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n-        _get_op_denylist_set(_SMCLI_OP_DENYLIST.value))\n+        saved_model_utils.get_meta_graph_def(_SMCLI_DIR.value, tags),\n+        _get_op_denylist_set(_SMCLI_OP_DENYLIST.value),\n+    )\n   elif _SMCLI_TAG_SET.value:\n+    tags = ','.join(\n+        _sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set')\n+    )\n     scan_meta_graph_def(\n-        saved_model_utils.get_meta_graph_def(\n-            _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n-        _OP_DENYLIST)\n+        saved_model_utils.get_meta_graph_def(_SMCLI_DIR.value, tags),\n+        _OP_DENYLIST,\n+    )\n   else:\n     saved_model = saved_model_utils.read_saved_model(_SMCLI_DIR.value)\n     if _SMCLI_OP_DENYLIST.value:\n@@ -1083,8 +1108,11 @@ def convert_with_tensorrt():\n     try:\n       converter = trt.TrtGraphConverterV2(\n           input_saved_model_dir=_SMCLI_DIR.value,\n-          input_saved_model_tags=_SMCLI_TAG_SET.value.split(','),\n-          **params._asdict())\n+          input_saved_model_tags=_sanitize_nonempty_str_list(\n+              _SMCLI_TAG_SET.value.split(','), 'tag_set'\n+          ),\n+          **params._asdict(),\n+      )\n       converter.convert()\n     except Exception as exc:\n       raise RuntimeError(\n@@ -1100,8 +1128,11 @@ def convert_with_tensorrt():\n         minimum_segment_size=_SMCLI_MINIMUM_SEGMENT_SIZE.value,\n         is_dynamic_op=True,\n         input_saved_model_dir=_SMCLI_DIR.value,\n-        input_saved_model_tags=_SMCLI_TAG_SET.value.split(','),\n-        output_saved_model_dir=_SMCLI_OUTPUT_DIR.value)\n+        input_saved_model_tags=_sanitize_nonempty_str_list(\n+            _SMCLI_TAG_SET.value.split(','), 'tag_set'\n+        ),\n+        output_saved_model_dir=_SMCLI_OUTPUT_DIR.value,\n+    )\n \n \n def freeze_model():\n@@ -1114,15 +1145,24 @@ def freeze_model():\n   elif _SMCLI_VARIABLES_TO_FEED.value.lower() == 'all':\n     variables_to_feed = None  # We will identify them after.\n   else:\n-    variables_to_feed = _SMCLI_VARIABLES_TO_FEED.value.split(',')\n+    variables_to_feed = _sanitize_nonempty_str_list(\n+        _SMCLI_VARIABLES_TO_FEED.value.split(','), 'variables_to_feed'\n+    )\n \n   saved_model_aot_compile.freeze_model(\n       checkpoint_path=checkpoint_path,\n       meta_graph_def=saved_model_utils.get_meta_graph_def(\n-          _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n+          _SMCLI_DIR.value,\n+          ','.join(\n+              _sanitize_nonempty_str_list(\n+                  _SMCLI_TAG_SET.value.split(','), 'tag_set'\n+              )\n+          ),\n+      ),\n       signature_def_key=_SMCLI_SIGNATURE_DEF_KEY.value,\n       variables_to_feed=variables_to_feed,\n-      output_prefix=_SMCLI_OUTPUT_PREFIX.value)\n+      output_prefix=_SMCLI_OUTPUT_PREFIX.value,\n+  )\n \n \n def aot_compile_cpu():\n@@ -1135,20 +1175,30 @@ def aot_compile_cpu():\n   elif _SMCLI_VARIABLES_TO_FEED.value.lower() == 'all':\n     variables_to_feed = None  # We will identify them after.\n   else:\n-    variables_to_feed = _SMCLI_VARIABLES_TO_FEED.value.split(',')\n+    variables_to_feed = _sanitize_nonempty_str_list(\n+        _SMCLI_VARIABLES_TO_FEED.value.split(','), 'variables_to_feed'\n+    )\n \n   saved_model_aot_compile.aot_compile_cpu_meta_graph_def(\n       checkpoint_path=checkpoint_path,\n       meta_graph_def=saved_model_utils.get_meta_graph_def(\n-          _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n+          _SMCLI_DIR.value,\n+          ','.join(\n+              _sanitize_nonempty_str_list(\n+                  _SMCLI_TAG_SET.value.split(','), 'tag_set'\n+              )\n+          ),\n+      ),\n       signature_def_key=_SMCLI_SIGNATURE_DEF_KEY.value,\n       variables_to_feed=variables_to_feed,\n       output_prefix=_SMCLI_OUTPUT_PREFIX.value,\n       target_triple=_SMCLI_TARGET_TRIPLE.value,\n       target_cpu=_SMCLI_TARGET_CPU.value,\n       cpp_class=_SMCLI_CPP_CLASS.value,\n       multithreading=(\n-          _SMCLI_MULTITHREADING.value.lower() not in ('f', 'false', '0')))\n+          _SMCLI_MULTITHREADING.value.lower() not in ('f', 'false', '0')\n+      ),\n+  )\n \n \n def add_show_subparser(subparsers):"
        },
        {
            "sha": "708c3f40aff9910020b483c66c804effc0d86ade",
            "filename": "tensorflow/python/tools/saved_model_cli_sanitize_list_test.py",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d84def35861f843d508f69082756e5798e25ab8d/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli_sanitize_list_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d84def35861f843d508f69082756e5798e25ab8d/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli_sanitize_list_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli_sanitize_list_test.py?ref=d84def35861f843d508f69082756e5798e25ab8d",
            "patch": "@@ -0,0 +1,41 @@\n+# tensorflow/python/tools/saved_model_cli_sanitize_list_test.py\n+# Copyright 2025 The TensorFlow Authors.\n+# Licensed under the Apache License, Version 2.0\n+# pylint: disable=line-too-long\n+\n+\"\"\"Unit tests for trim & validation helpers in saved_model_cli.\"\"\"\n+\n+from absl.testing import parameterized\n+from tensorflow.python.platform import test\n+from tensorflow.python.tools import saved_model_cli as smcli\n+\n+\n+class SanitizeNonEmptyStrListTest(test.TestCase, parameterized.TestCase):\n+\n+  def test_trims_and_drops_empty_and_none(self):\n+    self.assertEqual(\n+        smcli._sanitize_nonempty_str_list(\n+            [' a ', '', '\\t', None, 'b '], 'field'\n+        ),\n+        ['a', 'b'],\n+    )\n+\n+  def test_raises_on_all_empty_like_inputs(self):\n+    with self.assertRaisesRegex(ValueError, 'field.*at least one non-empty'):\n+      smcli._sanitize_nonempty_str_list(['  ', '\\n', '', None], 'field')\n+\n+\n+class DenylistParsingTest(test.TestCase, parameterized.TestCase):\n+\n+  @parameterized.parameters(\n+      ('OpA, OpB, , ,,OpC', {'OpA', 'OpB', 'OpC'}),\n+      ('  , , ', set()),\n+      ('', set()),\n+      (' ReadFile ,WriteFile , PrintV2', {'ReadFile', 'WriteFile', 'PrintV2'}),\n+  )\n+  def test_get_op_denylist_set_trims_and_ignores_empties(self, raw, expected):\n+    self.assertEqual(smcli._get_op_denylist_set(raw), expected)\n+\n+\n+if __name__ == '__main__':\n+  test.main()"
        }
    ],
    "stats": {
        "total": 155,
        "additions": 129,
        "deletions": 26
    }
}