{
    "author": "MatthiasKreileder",
    "message": "Improve check for opaque delegates.\n\nThis change introduces `TfLiteDelegateIsOpaque` to more strictly identify well-formed opaque delegates by ensuring that all classic `TfLiteDelegate` fields are not set, in addition to checking for a valid `opaque_delegate_builder`. The previous `TfLiteDelegateHasValidOpaqueDelegateBuilder` is replaced by this new function.\n\nPiperOrigin-RevId: 821983869",
    "sha": "e67891f30a9e3316c0271ad9cd4f570f68c2ebdd",
    "files": [
        {
            "sha": "d67f3af3e652d106f9d2b3e04bfd6b3534081152",
            "filename": "tensorflow/lite/c/common_internal.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e67891f30a9e3316c0271ad9cd4f570f68c2ebdd/tensorflow%2Flite%2Fc%2Fcommon_internal.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e67891f30a9e3316c0271ad9cd4f570f68c2ebdd/tensorflow%2Flite%2Fc%2Fcommon_internal.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fc%2Fcommon_internal.cc?ref=e67891f30a9e3316c0271ad9cd4f570f68c2ebdd",
            "patch": "@@ -20,14 +20,21 @@ limitations under the License.\n #include \"tensorflow/lite/core/c/c_api_types.h\"\n #include \"tensorflow/lite/core/c/common.h\"\n \n+bool TfLiteDelegateIsOpaque(const TfLiteDelegate* delegate) {\n+  return delegate != nullptr && delegate->Prepare == nullptr &&\n+         delegate->CopyFromBufferHandle == nullptr &&\n+         delegate->FreeBufferHandle == nullptr &&\n+         delegate->opaque_delegate_builder != nullptr;\n+}\n+\n TfLiteStatus TfLiteDelegatePrepareInternal(TfLiteContext* context,\n                                            TfLiteDelegate* delegate) {\n   TfLiteStatus status = kTfLiteOk;\n   // The following casts are safe only because this code is part of the\n   // TF Lite runtime implementation.  Apps using TF Lite should not rely on\n   // TfLiteOpaqueContext and TfLiteContext being equivalent, or on\n   // TfLiteOpaqueDelegate and TfLiteDelegate being equivalent.\n-  if (TfLiteDelegateHasValidOpaqueDelegateBuilder(delegate) &&\n+  if (TfLiteDelegateIsOpaque(delegate) &&\n       delegate->opaque_delegate_builder->Prepare) {\n     status = delegate->opaque_delegate_builder->Prepare(\n         reinterpret_cast<TfLiteOpaqueContext*>(context),\n@@ -46,7 +53,7 @@ TfLiteStatus TfLiteDelegateCopyFromBufferHandleInternal(\n   // TF Lite runtime implementation.  Apps using TF Lite should not rely on\n   // TfLiteOpaqueContext and TfLiteContext being equivalent, or on\n   // TfLiteOpaqueDelegate and TfLiteDelegate being equivalent.\n-  if (TfLiteDelegateHasValidOpaqueDelegateBuilder(delegate) &&\n+  if (TfLiteDelegateIsOpaque(delegate) &&\n       delegate->opaque_delegate_builder->CopyFromBufferHandle) {\n     return delegate->opaque_delegate_builder->CopyFromBufferHandle(\n         reinterpret_cast<TfLiteOpaqueContext*>(context),\n@@ -67,7 +74,7 @@ TfLiteStatus TfLiteDelegateFreeBufferHandleInternal(\n   // TF Lite runtime implementation.  Apps using TF Lite should not rely on\n   // TfLiteOpaqueContext and TfLiteContext being equivalent, or on\n   // TfLiteOpaqueDelegate and TfLiteDelegate being equivalent.\n-  if (TfLiteDelegateHasValidOpaqueDelegateBuilder(delegate) &&\n+  if (TfLiteDelegateIsOpaque(delegate) &&\n       delegate->opaque_delegate_builder->FreeBufferHandle) {\n     delegate->opaque_delegate_builder->FreeBufferHandle(\n         reinterpret_cast<TfLiteOpaqueContext*>(context),\n@@ -84,7 +91,7 @@ TfLiteStatus TfLiteDelegateFreeBufferHandleInternal(\n }\n \n int64_t TfLiteDelegateGetFlagsInternal(TfLiteDelegate* delegate) {\n-  if (TfLiteDelegateHasValidOpaqueDelegateBuilder(delegate)) {\n+  if (TfLiteDelegateIsOpaque(delegate)) {\n     return delegate->opaque_delegate_builder->flags;\n   }\n   return delegate->flags;"
        },
        {
            "sha": "ccf0489d6805a2227102a74df0a8893926e62154",
            "filename": "tensorflow/lite/c/common_internal.h",
            "status": "modified",
            "additions": 3,
            "deletions": 23,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e67891f30a9e3316c0271ad9cd4f570f68c2ebdd/tensorflow%2Flite%2Fc%2Fcommon_internal.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e67891f30a9e3316c0271ad9cd4f570f68c2ebdd/tensorflow%2Flite%2Fc%2Fcommon_internal.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fc%2Fcommon_internal.h?ref=e67891f30a9e3316c0271ad9cd4f570f68c2ebdd",
            "patch": "@@ -112,29 +112,9 @@ typedef struct TfLiteOperator {\n       void* user_data, TfLiteOpaqueContext* context, TfLiteOpaqueNode* node);\n } TfLiteOperator;\n \n-// Returns true iff it's safe to dereference\n-// 'delegate->opaque_delegate_builder'.\n-inline bool TfLiteDelegateHasValidOpaqueDelegateBuilder(\n-    const TfLiteDelegate* delegate) {\n-  // We want to give precedence to the delegate's `opaque_delegate_builder`\n-  // field when it is available.  In an ideal setting, where all client code\n-  // properly initializes the delegate, we could simply check if the\n-  // `opaque_delegate_builder` contains a non-zero address.  However, in\n-  // practice this breaks code that doesn't adhere to these best practices.\n-  //\n-  // We can avoid this problem by checking the `Prepare` field contained in the\n-  // `TfliteDelegate` (not to be confused with the `Prepare` field contained in\n-  // `TfLiteOpaqueDelegateBuilder` struct). In order to tell if we should use\n-  // the `opaque_delegate_builder` field we check that the `TfLiteDelegate`'s\n-  // `Prepare` member is null.  This should be true for every delegate that\n-  // adopts the `TfLiteOpaqueDelegateBuilder` interface and should not be true\n-  // for any delegate implementation that is using `TfLiteDelegate` directly.\n-  //\n-  // TODO(b/245730811): Consider signalling to clients if the delegate is not\n-  // initialized cleanly.\n-  return delegate != nullptr && delegate->Prepare == nullptr &&\n-         delegate->opaque_delegate_builder != nullptr;\n-}\n+// Returns true iff the delegate is a well-formed opaque delegate, i.e. none of\n+// the fields that are part of the legacy 'TfLiteDelegate' interface are set.\n+bool TfLiteDelegateIsOpaque(const TfLiteDelegate* delegate);\n \n // Invokes 'Prepare' on the provided 'delegate', giving the 'delegate' a view\n // of the current graph through the provided 'context'.  Returns the delegate's"
        },
        {
            "sha": "9a0f2e0f2d7e00ea6d217fd540582f685b6175b9",
            "filename": "tensorflow/lite/core/subgraph.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e67891f30a9e3316c0271ad9cd4f570f68c2ebdd/tensorflow%2Flite%2Fcore%2Fsubgraph.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e67891f30a9e3316c0271ad9cd4f570f68c2ebdd/tensorflow%2Flite%2Fcore%2Fsubgraph.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fcore%2Fsubgraph.cc?ref=e67891f30a9e3316c0271ad9cd4f570f68c2ebdd",
            "patch": "@@ -524,7 +524,7 @@ TfLiteStatus Subgraph::ReplaceNodeSubsetsWithDelegateKernels(\n \n   // The subgraph is taking ownership of the external registration, in case the\n   // user has supplied an opaque delegate.\n-  if (TfLiteDelegateHasValidOpaqueDelegateBuilder(delegate)) {\n+  if (TfLiteDelegateIsOpaque(delegate)) {\n     // If the user has supplied an opaque delegate, then they _must_ also use\n     // TfLiteOperator.\n     if (!registration.registration_external) {\n@@ -595,7 +595,7 @@ TfLiteStatus Subgraph::ReplaceNodeSubsetsWithDelegateKernels(\n         int node_index;\n \n         void* delegate_params = nullptr;\n-        if (TfLiteDelegateHasValidOpaqueDelegateBuilder(delegate)) {\n+        if (TfLiteDelegateIsOpaque(delegate)) {\n           TfLiteOpaqueDelegateParams* opaque_params =\n               CreateOpaqueDelegateParams(delegate, node_subset);\n           delegate_params = opaque_params;"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 16,
        "deletions": 29
    }
}