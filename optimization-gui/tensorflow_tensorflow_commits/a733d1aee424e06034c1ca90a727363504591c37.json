{
    "author": "subhankarshah",
    "message": "[XLA:MSA] Add a field to MSA options that allows scheduling custom call prefetches in MSA. If the field is specified return 'not implemented' error for now.\n\nPiperOrigin-RevId: 816415912",
    "sha": "a733d1aee424e06034c1ca90a727363504591c37",
    "files": [
        {
            "sha": "a213fb8a1ff96bfd914b33031804a9b093863583",
            "filename": "third_party/xla/xla/service/memory_space_assignment/algorithm.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a733d1aee424e06034c1ca90a727363504591c37/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a733d1aee424e06034c1ca90a727363504591c37/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc?ref=a733d1aee424e06034c1ca90a727363504591c37",
            "patch": "@@ -2106,9 +2106,14 @@ absl::flat_hash_set<HloPosition> GetParameterInstructionsAliasedToOutput(\n \n }  // namespace\n \n-void MsaAlgorithm::ProcessBlockPrefetches() {\n+absl::Status MsaAlgorithm::ProcessBlockPrefetches() {\n+  if (!options_.hlo_position_to_custom_call_prefetch_details.empty()) {\n+    return absl::UnimplementedError(\n+        \"Block prefetching for custom call prefetches is not yet implemented \"\n+        \"in MSA.\");\n+  }\n   if (options_.reserved_bytes_for_block_prefetches <= 0) {\n-    return;\n+    return absl::OkStatus();\n   }\n   absl::flat_hash_set<HloPosition> aliased_parameter_positions =\n       GetParameterInstructionsAliasedToOutput(\n@@ -2335,6 +2340,7 @@ void MsaAlgorithm::ProcessBlockPrefetches() {\n   }\n   // Clear the pending chunks.\n   ClearPendingChunks();\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<HeapSimulator::Result<HloValue>> MsaAlgorithm::Finish() {\n@@ -2350,7 +2356,8 @@ absl::StatusOr<HeapSimulator::Result<HloValue>> MsaAlgorithm::Finish() {\n                                                                  : \"disabled\");\n \n   AllocateReservedScopedAllocations();\n-  ProcessBlockPrefetches();\n+  TF_RETURN_IF_ERROR(ProcessBlockPrefetches());\n+\n   std::vector<MsaBufferInterval> sorted_buffer_intervals =\n       GetSortedBufferIntervals();\n "
        },
        {
            "sha": "4c1f26d4285716605d21d72f15198955f3f97dd1",
            "filename": "third_party/xla/xla/service/memory_space_assignment/algorithm.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a733d1aee424e06034c1ca90a727363504591c37/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a733d1aee424e06034c1ca90a727363504591c37/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.h?ref=a733d1aee424e06034c1ca90a727363504591c37",
            "patch": "@@ -335,7 +335,7 @@ class MsaAlgorithm : public GlobalDecreasingSizeBestFitHeap<HloValue> {\n   absl::StatusOr<HeapSimulator::Result<HloValue>> Finish() override;\n \n   // Processes all block prefetches.\n-  void ProcessBlockPrefetches();\n+  absl::Status ProcessBlockPrefetches();\n \n   // Returns the maximum amount of scoped memory that is reserved at any time in\n   // the program."
        },
        {
            "sha": "279914dc3a03b4597c01a6f339de2d8222820a33",
            "filename": "third_party/xla/xla/service/memory_space_assignment/options.h",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a733d1aee424e06034c1ca90a727363504591c37/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Foptions.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a733d1aee424e06034c1ca90a727363504591c37/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Foptions.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Foptions.h?ref=a733d1aee424e06034c1ca90a727363504591c37",
            "patch": "@@ -113,6 +113,17 @@ struct BufferColoring {\n   int64_t memory_space;                     // How to color the buffer.\n };\n \n+// A struct to hold the details of a custom call prefetch.\n+struct CustomCallPrefetchDetails {\n+  // Async custom call prefetch start instruction.\n+  HloInstruction* prefetch_start;\n+  // Async custom call prefetch done instruction.\n+  HloInstruction* prefetch_done;\n+  // Intermediate instructions associated with the prefetch like\n+  // get-tuple-element etc.\n+  std::vector<HloInstruction*> intermediate_instructions;\n+};\n+\n // The different options to be passed to the Run() API.\n struct Options {\n   // The backend-specific integer value that describes the default memory.\n@@ -424,6 +435,14 @@ struct Options {\n       async_instruction_bw_adjustment_factor_fn =\n           [](const HloInstruction*) { return std::nullopt; };\n \n+  // One HloPosition can have multiple custom call prefetches associated with\n+  // it. For every custom-call prefetched HloPosition, this map stores the\n+  // details of all the custom-call prefetches associated with it. This is used\n+  // to schedule the custom-call prefetches as part of the memory space\n+  // assignment algorithm.\n+  absl::flat_hash_map<HloPosition, std::vector<CustomCallPrefetchDetails>>\n+      hlo_position_to_custom_call_prefetch_details;\n+\n   std::string ToString() const;\n };\n "
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}