{
    "author": "pschuh",
    "message": "Avoid deadlock in code that may return buffers from inside the copy_fn\ndtor.\n\nPiperOrigin-RevId: 827569118",
    "sha": "59714248574156b5db9b4f01a04f22e36782bf45",
    "files": [
        {
            "sha": "789a1c0dca6ef925697ac989769da02a2af96ed0",
            "filename": "third_party/xla/xla/python/transfer/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2FBUILD?ref=59714248574156b5db9b4f01a04f22e36782bf45",
            "patch": "@@ -153,6 +153,7 @@ xla_cc_test(\n         \":streaming\",\n         \":streaming_ifrt\",\n         \":test_pattern\",\n+        \"//xla:future\",\n         \"//xla:shape_util\",\n         \"//xla/pjrt:pjrt_compiler\",\n         \"//xla/pjrt:raw_buffer\",\n@@ -164,7 +165,9 @@ xla_cc_test(\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\","
        },
        {
            "sha": "d9f0f54a8d9a1e2c3a133602a5d91dc8707293ac",
            "filename": "third_party/xla/xla/python/transfer/streaming_ifrt.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.cc?ref=59714248574156b5db9b4f01a04f22e36782bf45",
            "patch": "@@ -170,7 +170,8 @@ PremappedCopierState::WorkList PremappedCopierState::FindWorkLocked() {\n void PremappedCopierState::StartWorkUnlocked(const WorkList& work_list) {\n   for (WorkQueueItem* work_item : work_list) {\n     auto& wu = work_item->work;\n-    wu.copy_fn(work_item->dest_buffer, wu.offset, wu.size)\n+    auto copy_fn = std::move(wu.copy_fn);\n+    std::move(copy_fn)(work_item->dest_buffer, wu.offset, wu.size)\n         .OnReady([this, this_shared = shared_from_this(),\n                   work_item](absl::Status s) {\n           WorkList work_list2;"
        },
        {
            "sha": "6c4821ec98aad6cbe0006a73b0cda49acbf0489a",
            "filename": "third_party/xla/xla/python/transfer/streaming_ifrt.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.h?ref=59714248574156b5db9b4f01a04f22e36782bf45",
            "patch": "@@ -53,7 +53,7 @@ absl::StatusOr<std::shared_ptr<absl::Span<uint8_t>>> AllocateAndMapPjrtMemory(\n // with an assigned 'buffer_id'.\n struct DmaCopyChunk {\n   absl::AnyInvocable<xla::Future<>(void* dst, int64_t offset,\n-                                   int64_t transfer_size)>\n+                                   int64_t transfer_size) &&>\n       copy_fn;\n   size_t buffer_id;\n   size_t offset;"
        },
        {
            "sha": "aa873dd740933211a23b8bd95ae13335c4d1afaf",
            "filename": "third_party/xla/xla/python/transfer/streaming_ifrt_test.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/59714248574156b5db9b4f01a04f22e36782bf45/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt_test.cc?ref=59714248574156b5db9b4f01a04f22e36782bf45",
            "patch": "@@ -24,11 +24,13 @@ limitations under the License.\n #include <vector>\n \n #include <gtest/gtest.h>\n+#include \"absl/functional/any_invocable.h\"\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/synchronization/notification.h\"\n+#include \"xla/future.h\"\n #include \"xla/pjrt/pjrt_compiler.h\"\n #include \"xla/pjrt/raw_buffer.h\"\n #include \"xla/python/ifrt/array.h\"\n@@ -44,6 +46,7 @@ limitations under the License.\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/errors.h\"\n+#include \"xla/tsl/platform/status.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"tsl/platform/casts.h\"\n \n@@ -154,6 +157,52 @@ absl::StatusOr<std::vector<int32_t>> FetchResult(\n   return result;\n }\n \n+TEST(PremappedCopierState, FreeCycle) {\n+  TF_ASSERT_OK_AND_ASSIGN(auto client, xla::ifrt::test_util::GetClient());\n+  std::shared_ptr<xla::PjRtClient> pjrt_client =\n+      tensorflow::down_cast<xla::ifrt::PjRtClient*>(client.get())\n+          ->shared_ptr_pjrt_client();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto scratch, AllocateAndMapPjrtMemory(pjrt_client, 1024 * 1024 * 16));\n+  auto cstate = std::make_shared<PremappedCopierState>(scratch, 4, 4096);\n+  void* buffer_to_return = nullptr;\n+  cstate->ScheduleCopy({/*copy_fn=*/[](void* dst, int64_t offset,\n+                                       int64_t transfer_size) -> xla::Future<> {\n+                          return xla::Future<>(absl::OkStatus());\n+                        },\n+                        /*buffer_id=*/0,\n+                        /*offset=*/100,\n+                        /*size=*/100},\n+                       [&buffer_to_return](PremappedCopierState* state,\n+                                           absl::StatusOr<void*> buf,\n+                                           const DmaCopyChunk& chunk) {\n+                         TF_CHECK_OK(buf.status());\n+                         buffer_to_return = buf.value();\n+                       });\n+  class BufferReturner {\n+   public:\n+    explicit BufferReturner(absl::AnyInvocable<void() &&> on_done)\n+        : on_done_(std::move(on_done)) {}\n+    ~BufferReturner() { std::move(on_done_)(); }\n+\n+   private:\n+    absl::AnyInvocable<void() &&> on_done_;\n+  };\n+  cstate->ScheduleCopy(\n+      {/*copy_fn=*/[](void* dst, int64_t offset,\n+                      int64_t transfer_size) -> xla::Future<> {\n+         return xla::Future<>(absl::OkStatus());\n+       },\n+       /*buffer_id=*/0,\n+       /*offset=*/100,\n+       /*size=*/100},\n+      [](PremappedCopierState* state, absl::StatusOr<void*> buf,\n+         const DmaCopyChunk& chunk) {\n+        TF_CHECK_OK(buf.status());\n+        state->ReturnBuffer(buf.value());\n+      });\n+}\n+\n TEST(PremappedCopierState, RoundTrip) {\n   TF_ASSERT_OK_AND_ASSIGN(auto client, xla::ifrt::test_util::GetClient());\n   size_t xfer_size = 1024 * 1024;"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 55,
        "deletions": 2
    }
}