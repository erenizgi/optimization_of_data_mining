{
    "author": "tensorflower-gardener",
    "message": "[XLA:Original Value] Skip adding recovery computation for manual sharding in SPMD partitioner.\n\nManual sharding is currently not supported by comparison tool, so we skip adding it to the recovery table. Without this CL, tracking original values would crash when manual sharding is used. For example,  http://sponge2/7f0ec09f-60cd-43c7-accf-10cf12d20cd6\n\nPiperOrigin-RevId: 807796077",
    "sha": "7ce54ed8c53f3bb4bd0dab6ccad0456f27b723e4",
    "files": [
        {
            "sha": "00420e10dd2ac8f7b297210b11fe4ba890bafdb9",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7ce54ed8c53f3bb4bd0dab6ccad0456f27b723e4/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7ce54ed8c53f3bb4bd0dab6ccad0456f27b723e4/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc?ref=7ce54ed8c53f3bb4bd0dab6ccad0456f27b723e4",
            "patch": "@@ -6164,7 +6164,12 @@ absl::StatusOr<bool> SpmdPartitioner::PreprocessCallSites(\n void SpmdPartitioningVisitor::SetPartitionedHlo(\n     const HloInstruction* hlo, PartitionedHlo&& partitioned_hlo) {\n   CHECK_EQ(partitioned_instructions_.count(hlo), 0);\n-  if (!partitioned_hlo.sharding().IsReplicated()) {\n+  const HloSharding& sharding = partitioned_hlo.sharding();\n+  if (sharding.IsManual()) {\n+    // Skip manual sharding because our toolings currently don't support it.\n+    // TODO(b/444750067): handle manual sharding.\n+    partitioned_hlo.hlo()->set_original_value(nullptr);\n+  } else if (!sharding.IsReplicated()) {\n     // Adds recovery computation to the original value recovery table.\n     auto* module = const_cast<HloModule*>(hlo->parent()->parent());\n     module->mutable_original_value_recovery_table().AddRecoveryComputation(\n@@ -6177,11 +6182,10 @@ void SpmdPartitioningVisitor::SetPartitionedHlo(\n           auto* param =\n               builder.AddInstruction(xla::HloInstruction::CreateParameter(\n                   0, replacing_array_shape, \"param\"));\n-          if (partitioned_hlo.sharding().IsTuple()) {\n-            param->set_sharding(\n-                partitioned_hlo.sharding().GetSubSharding(hlo->shape(), index));\n+          if (sharding.IsTuple()) {\n+            param->set_sharding(sharding.GetSubSharding(hlo->shape(), index));\n           } else {\n-            param->set_sharding(partitioned_hlo.sharding());\n+            param->set_sharding(sharding);\n           }\n           xla::HloModuleConfig config;\n           auto recovery_module ="
        }
    ],
    "stats": {
        "total": 14,
        "additions": 9,
        "deletions": 5
    }
}