{
    "author": "draganmladjenovic",
    "message": "PR #33906: [ROCm] upgrade bitcode library to fcc50fb091b7c75d8f6c9a6554d0b004bc0‚Ä¶\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33906\n\n‚Ä¶cd474\n\nüìù Summary of Changes\nUpgrade bitcode library. Small cleanup of build rules.\n\nüéØ Justification\nPull in the changes for the new gfx archs.\n\nüöÄ Kind of Contribution\n‚ôªÔ∏è Cleanup\n\nüìä Benchmark (for Performance Improvements)\nN\\A\n\nüß™ Unit Tests:\nN\\A\n\nüß™ Execution Tests:\nN\\A\n\nCopybara import of the project:\n\n--\n688346550b3733693459bbcef4e6d3a754bb2746 by Dragan Mladjenovic <Dragan.Mladjenovic@amd.com>:\n\n[ROCm] upgrade bitcode library to fcc50fb091b7c75d8f6c9a6554d0b004bc0cd474\n\nMerging this change closes #33906\n\nPiperOrigin-RevId: 833312610",
    "sha": "e14921bb0817ec755c6047e35e2377da2de1c1c0",
    "files": [
        {
            "sha": "5b9aee4f085e34b913d1463f202a47e59144b917",
            "filename": "third_party/xla/third_party/rocm_device_libs/build_defs.bzl",
            "status": "modified",
            "additions": 15,
            "deletions": 16,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e14921bb0817ec755c6047e35e2377da2de1c1c0/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e14921bb0817ec755c6047e35e2377da2de1c1c0/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl?ref=e14921bb0817ec755c6047e35e2377da2de1c1c0",
            "patch": "@@ -2,8 +2,6 @@\n \n load(\"@bazel_skylib//lib:paths.bzl\", \"paths\")\n \n-BitcodeLibraryInfo = provider(fields = [\"bc_file\"])\n-\n def _bitcode_library_impl(ctx):\n     \"\"\"Implements a bitcode library rule.\"\"\"\n     srcs = ctx.files.srcs\n@@ -19,20 +17,21 @@ def _bitcode_library_impl(ctx):\n             out = ctx.actions.declare_file(src.basename + \".bc\")\n             bc_outputs.append(out)\n \n-            extra_flags = ctx.attr.file_specific_flags.get(src.basename, \"\")\n+            extra_flags = ctx.attr.file_specific_flags.get(src.basename, [])\n             include_flags = [\"-I{}\".format(dir) for dir in include_dirs]\n             include_flags += [\"-I{}\".format(ctx.files._clang_header[0].dirname)]\n             include_flags += [\"-I{}\".format(ctx.files._clang_includes[0].dirname)]\n+\n+            # https://github.com/ROCm/llvm-project/blob/679865ee84553d564ad0551d878196e58c9d03f3/amd/device-libs/cmake/OCL.cmake#L33\n             args = [\n-                \"-x\",\n-                \"cl\",\n-                \"--target=amdgcn-amd-amdhsa\",\n-                \"-emit-llvm\",\n                 \"-fcolor-diagnostics\",\n                 \"-Werror\",\n                 \"-Wno-error=atomic-alignment\",\n+                \"-x\",\n+                \"cl\",\n                 \"-Xclang\",\n                 \"-cl-std=CL2.0\",\n+                \"--target=amdgcn-amd-amdhsa\",\n                 \"-fvisibility=hidden\",\n                 \"-fomit-frame-pointer\",\n                 \"-Xclang\",\n@@ -47,16 +46,17 @@ def _bitcode_library_impl(ctx):\n                 \"-cl-no-stdinc\",\n                 \"-Xclang\",\n                 \"-mcode-object-version=none\",\n+                \"-emit-llvm\",\n                 \"-c\",\n-            ] + include_flags + [src.path, \"-o\", out.path] + extra_flags.split(\" \")\n+            ] + include_flags + [src.path, \"-o\", out.path] + extra_flags\n \n             ctx.actions.run(\n                 executable = ctx.executable._clang,\n                 inputs = [src] + hdrs + ctx.files._clang_includes + ctx.files._clang_header,\n                 outputs = [out],\n                 arguments = args,\n-                progress_message = \"Compiling {} ‚Üí bitcode\".format(src.basename),\n-                mnemonic = \"RocmBitCodeCompile\",\n+                progress_message = \"Compiling {} to bitcode\".format(src.basename),\n+                mnemonic = \"BitcodeCompile\",\n             )\n \n         elif src.path.endswith(\".ll\"):\n@@ -71,7 +71,7 @@ def _bitcode_library_impl(ctx):\n         outputs = [prelink_out],\n         arguments = [f.path for f in bc_outputs] + [\"-o\", prelink_out.path],\n         progress_message = \"Linking {} bitcode files\".format(ctx.label.name),\n-        mnemonic = \"RocmBitCodeLink\",\n+        mnemonic = \"BitcodeLink\",\n     )\n \n     # Internalize symbols (llvm-link + -internalize)\n@@ -82,7 +82,7 @@ def _bitcode_library_impl(ctx):\n         outputs = [internalize_out],\n         arguments = [\"-internalize\", \"-only-needed\", prelink_out.path, \"-o\", internalize_out.path],\n         progress_message = \"Internalizing symbols for {}\".format(ctx.label.name),\n-        mnemonic = \"RocmBitCodeInternalizingSymbols\",\n+        mnemonic = \"BitcodeInternalizeSymbols\",\n     )\n \n     # Strip unnecessary metadata\n@@ -93,7 +93,7 @@ def _bitcode_library_impl(ctx):\n         outputs = [strip_out],\n         arguments = [\"-passes=strip\", \"-o\", strip_out.path, internalize_out.path],\n         progress_message = \"Stripping {}\".format(ctx.label.name),\n-        mnemonic = \"RocmBitCodeStripping\",\n+        mnemonic = \"BitcodeStrip\",\n     )\n \n     # Final preparation of bitcode (custom prepare_builtins tool)\n@@ -104,20 +104,19 @@ def _bitcode_library_impl(ctx):\n         outputs = [final_bc],\n         arguments = [strip_out.path, \"-o\", final_bc.path],\n         progress_message = \"Preparing final bitcode for {}\".format(ctx.label.name),\n-        mnemonic = \"RocmBitCodeFinalize\",\n+        mnemonic = \"BitcodeFinalize\",\n     )\n \n     return [\n         DefaultInfo(files = depset([final_bc])),\n-        BitcodeLibraryInfo(bc_file = final_bc),\n     ]\n \n bitcode_library = rule(\n     implementation = _bitcode_library_impl,\n     attrs = {\n         \"srcs\": attr.label_list(allow_files = [\".cl\", \".ll\"]),\n         \"hdrs\": attr.label_list(allow_files = [\".h\"]),\n-        \"file_specific_flags\": attr.string_dict(),\n+        \"file_specific_flags\": attr.string_list_dict(),\n         \"_clang\": attr.label(\n             default = Label(\"@llvm-project//clang:clang\"),\n             executable = True,"
        },
        {
            "sha": "11795b3537e7a974f34041ccce9f06e310716be6",
            "filename": "third_party/xla/third_party/rocm_device_libs/rocm_device_libs.BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e14921bb0817ec755c6047e35e2377da2de1c1c0/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e14921bb0817ec755c6047e35e2377da2de1c1c0/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD?ref=e14921bb0817ec755c6047e35e2377da2de1c1c0",
            "patch": "@@ -39,9 +39,9 @@ bitcode_library(\n         \"oclc/inc/*.h\",\n     ]),\n     file_specific_flags = {\n-        \"native_logF.cl\": \"-fapprox-func\",\n-        \"native_expF.cl\": \"-fapprox-func\",\n-        \"sqrtF.cl\": \"-cl-fp32-correctly-rounded-divide-sqrt\",\n+        \"native_logF.cl\": [\"-fapprox-func\"],\n+        \"native_expF.cl\": [\"-fapprox-func\"],\n+        \"sqrtF.cl\": [\"-cl-fp32-correctly-rounded-divide-sqrt\"],\n     },\n )\n \n@@ -57,6 +57,6 @@ bitcode_library(\n         \"oclc/inc/*.h\",\n     ]),\n     file_specific_flags = {\n-        \"gaaf.cl\": \"-munsafe-fp-atomics\",\n+        \"gaaf.cl\": [\"-munsafe-fp-atomics\"],\n     },\n )"
        },
        {
            "sha": "2958b33b670cf8044cf417c0544e59c04832a605",
            "filename": "third_party/xla/third_party/rocm_device_libs/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e14921bb0817ec755c6047e35e2377da2de1c1c0/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e14921bb0817ec755c6047e35e2377da2de1c1c0/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fworkspace.bzl?ref=e14921bb0817ec755c6047e35e2377da2de1c1c0",
            "patch": "@@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\", \"tf_mirror_urls\")\n \n def repo():\n     \"\"\"Imports Rocm-Device-Libs.\"\"\"\n-    LLVM_COMMIT = \"c93c6e5451544e9ead12f2d2b15e1969b9a1bd04\"\n-    LLVM_SHA256 = \"f715a0a9c3c1a2b09a79939016ed53a0cbd454f7b0ea4ef32878433275c7b16c\"\n+    LLVM_COMMIT = \"fcc50fb091b7c75d8f6c9a6554d0b004bc0cd474\"\n+    LLVM_SHA256 = \"fa9089d3134bd32d2b05a141006b9261e441c1d80b75782db0dcb154b6a60561\"\n \n     tf_http_archive(\n         name = \"rocm_device_libs\","
        }
    ],
    "stats": {
        "total": 43,
        "additions": 21,
        "deletions": 22
    }
}