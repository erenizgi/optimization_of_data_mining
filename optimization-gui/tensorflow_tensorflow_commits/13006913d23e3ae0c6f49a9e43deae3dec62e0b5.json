{
    "author": "nvgrw",
    "message": "Migrate sample_file_test to HloRunnerPjRt.\n\nPiperOrigin-RevId: 820803579",
    "sha": "13006913d23e3ae0c6f49a9e43deae3dec62e0b5",
    "files": [
        {
            "sha": "ac817dc86d89621015cfed1e40fa76cd3c3f0d56",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/13006913d23e3ae0c6f49a9e43deae3dec62e0b5/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/13006913d23e3ae0c6f49a9e43deae3dec62e0b5/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=13006913d23e3ae0c6f49a9e43deae3dec62e0b5",
            "patch": "@@ -3384,14 +3384,26 @@ xla_test(\n     srcs = [\"sample_file_test.cc\"],\n     backends = [\"gpu\"],\n     data = [\"isolated_convolution.hlo\"],\n+    tags = [\n+        \"test_migrated_to_hlo_runner_pjrt\",\n+    ],\n     deps = [\n-        \":hlo_test_base\",\n+        \":hlo_pjrt_test_base\",\n+        \":hlo_runner_agnostic_reference_mixin\",\n         \":xla_internal_test_main\",  # fixdeps: keep\n+        \"//xla:error_spec\",\n+        \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/testlib:test\",\n-        \"//xla/service:cpu_plugin\",  # reference backend\n-        \"//xla/service:platform_util\",\n+        \"//xla/pjrt:pjrt_client\",\n+        \"//xla/pjrt/plugin/xla_cpu:xla_cpu_pjrt_client\",\n+        \"//xla/service:hlo_module_util\",\n+        \"//xla/service:hlo_runner_interface\",\n+        \"//xla/service:hlo_runner_pjrt\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@local_tsl//tsl/platform:path\",\n-        \"@local_tsl//tsl/platform:test\",\n     ],\n )\n "
        },
        {
            "sha": "a568a6dbe97f5e0304328e624c869a5dcc5cd5eb",
            "filename": "third_party/xla/xla/tests/sample_file_test.cc",
            "status": "modified",
            "additions": 36,
            "deletions": 12,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/13006913d23e3ae0c6f49a9e43deae3dec62e0b5/third_party%2Fxla%2Fxla%2Ftests%2Fsample_file_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/13006913d23e3ae0c6f49a9e43deae3dec62e0b5/third_party%2Fxla%2Fxla%2Ftests%2Fsample_file_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fsample_file_test.cc?ref=13006913d23e3ae0c6f49a9e43deae3dec62e0b5",
            "patch": "@@ -13,33 +13,57 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-// This demonstrates how to use hlo_test_base to create a file based testcase\n-// and compare results on gpu and cpu.\n+// This demonstrates how to create a file-based test case and compare results\n+// between gpu and cpu.\n \n+#include <memory>\n #include <string>\n-#include <vector>\n+#include <utility>\n \n+#include \"absl/log/log.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"xla/error_spec.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/testlib/test.h\"\n-#include \"xla/service/platform_util.h\"\n-#include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/pjrt/pjrt_client.h\"\n+#include \"xla/pjrt/plugin/xla_cpu/xla_cpu_pjrt_client.h\"\n+#include \"xla/service/hlo_module_util.h\"\n+#include \"xla/service/hlo_runner_interface.h\"\n+#include \"xla/service/hlo_runner_pjrt.h\"\n+#include \"xla/tests/hlo_pjrt_test_base.h\"\n+#include \"xla/tests/hlo_runner_agnostic_reference_mixin.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/platform/test.h\"\n #include \"tsl/platform/path.h\"\n-#include \"tsl/platform/test.h\"\n \n namespace xla {\n namespace {\n \n-class SampleFileTest : public HloTestBase {\n+std::unique_ptr<HloRunnerInterface> GetReferenceRunner() {\n+  absl::StatusOr<std::unique_ptr<PjRtClient>> client = GetXlaPjrtCpuClient({});\n+  if (!client.ok()) {\n+    LOG(FATAL) << \"Failed to create XLA:CPU PjRtClient: \" << client.status();\n+  }\n+  return std::make_unique<HloRunnerPjRt>(*std::move(client));\n+}\n+\n+class SampleFileTest : public HloRunnerAgnosticReferenceMixin<HloPjRtTestBase> {\n  protected:\n   SampleFileTest()\n-      : HloTestBase(\n-            /*test_platform=*/PlatformUtil::GetPlatform(\"gpu\").value(),\n-            /*reference_platform=*/PlatformUtil::GetPlatform(\"cpu\").value()) {}\n+      : HloRunnerAgnosticReferenceMixin<HloPjRtTestBase>(\n+            /*reference_runner=*/GetReferenceRunner()) {}\n };\n \n TEST_F(SampleFileTest, Convolution) {\n-  const std::string& filename = tsl::io::JoinPath(\n+  const std::string filename = tsl::io::JoinPath(\n       tsl::testing::XlaSrcRoot(), \"tests\", \"isolated_convolution.hlo\");\n-  EXPECT_TRUE(RunAndCompareFromFile(filename, ErrorSpec{0.01}));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ReadModuleFromHloTextFile(filename));\n+  module->mutable_config()\n+      .mutable_debug_options()\n+      .set_xla_cpu_parallel_codegen_split_count(1);\n+\n+  EXPECT_TRUE(RunAndCompare(std::move(module), ErrorSpec{0.01}));\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 52,
        "deletions": 16
    }
}