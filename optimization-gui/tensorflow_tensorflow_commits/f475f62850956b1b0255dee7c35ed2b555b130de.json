{
    "author": "tensorflower-gardener",
    "message": "#HLODiff Highlight diffed instructions within HLO text in the HTML renderer.\n\nPiperOrigin-RevId: 797493474",
    "sha": "f475f62850956b1b0255dee7c35ed2b555b130de",
    "files": [
        {
            "sha": "b4af77365f407ca60e2f05ea9c9d522231446c54",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 96,
            "deletions": 32,
            "changes": 128,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f475f62850956b1b0255dee7c35ed2b555b130de/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f475f62850956b1b0255dee7c35ed2b555b130de/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=f475f62850956b1b0255dee7c35ed2b555b130de",
            "patch": "@@ -216,6 +216,16 @@ std::string PrintCss() {\n       border: 1px solid #4285F4;\n     }\n \n+    span.red-highlight {\n+      background-color: #fad2cf;\n+    }\n+    span.green-highlight {\n+      background-color: #ceead6;\n+    }\n+    span.yellow-highlight {\n+      background-color: #feefc3;\n+    }\n+\n     </style>\n   )html\";\n }\n@@ -369,8 +379,35 @@ std::string PrintTextbox(absl::string_view title, absl::string_view content,\n \n /*** Summary logic ***/\n \n+// The attributes of an instruction that will be applied to the corresponding\n+// span element in the HTML output.\n+struct Attributes {\n+  std::string highlight;\n+};\n+\n+// Generate span attributes for all instructions given diff result.\n+absl::flat_hash_map<const HloInstruction*, Attributes> GenerateSpanAttributes(\n+    const DiffResult& diff_result) {\n+  absl::flat_hash_map<const HloInstruction*, Attributes> span_attributes;\n+  for (auto& instruction : diff_result.left_module_unmatched_instructions) {\n+    span_attributes[instruction] = {\"red-highlight\"};\n+  }\n+  for (auto& instruction : diff_result.right_module_unmatched_instructions) {\n+    span_attributes[instruction] = {\"green-highlight\"};\n+  }\n+  for (const auto& [l_instruction, r_instruction] :\n+       diff_result.changed_instructions) {\n+    span_attributes[l_instruction] = {\"yellow-highlight\"};\n+    span_attributes[r_instruction] = {\"yellow-highlight\"};\n+  }\n+  return span_attributes;\n+};\n+\n // Generates HTML for a single HloComputation with diff highlights.\n-std::string PrintHloComputationToHtml(const HloComputation* comp) {\n+std::string PrintHloComputationToHtml(\n+    const HloComputation* comp,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes) {\n   if (comp == nullptr) {\n     return \"\";\n   }\n@@ -403,7 +440,13 @@ std::string PrintHloComputationToHtml(const HloComputation* comp) {\n       DCHECK_EQ(comp, instruction->parent());\n       printer.Append(\"  \");  // Instruction indentation (2 spaces)\n \n-      printer.Append(\"<span class=\\\"hlo-instruction\\\">\");\n+      auto it = span_attributes.find(instruction);\n+      std::string highlight_class =\n+          it != span_attributes.end() && !it->second.highlight.empty()\n+              ? std::string(it->second.highlight)\n+              : \"\";\n+      printer.Append(absl::StrCat(\"<span class=\\\"hlo-instruction \",\n+                                  highlight_class, \"\\\" >\"));\n \n       if (instruction == comp->root_instruction()) {\n         printer.Append(\"ROOT \");\n@@ -428,20 +471,23 @@ std::string PrintHloComputationToHtml(const HloComputation* comp) {\n \n // Prints a pair of instructions or computations in a text box.\n template <typename T>\n-std::string PrintHloTextboxPair(const T* left_node, const T* right_node) {\n+std::string PrintHloTextboxPair(\n+    const T* left_node, const T* right_node,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes) {\n   std::string left_title = \"None\", right_title = \"None\", left_text, right_text;\n   if (left_node != nullptr) {\n     left_title = left_node->name();\n     if constexpr (std::is_same_v<T, HloComputation>) {\n-      left_text = PrintHloComputationToHtml(left_node);\n+      left_text = PrintHloComputationToHtml(left_node, span_attributes);\n     } else {\n       left_text = left_node->ToString();\n     }\n   }\n   if (right_node != nullptr) {\n     right_title = right_node->name();\n     if constexpr (std::is_same_v<T, HloComputation>) {\n-      right_text = PrintHloComputationToHtml(right_node);\n+      right_text = PrintHloComputationToHtml(right_node, span_attributes);\n     } else {\n       right_text = right_node->ToString();\n     }\n@@ -466,26 +512,33 @@ template <typename T>\n using DecorationPrinter = std::string(const T*, const T*);\n \n template <typename T>\n-std::string PrintNodePairContent(const T* left_node, const T* right_node,\n-                                 GraphUrlGenerator* url_generator) {\n+std::string PrintNodePairContent(\n+    const T* left_node, const T* right_node,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes,\n+    GraphUrlGenerator* url_generator) {\n   std::string url;\n   if (url_generator != nullptr) {\n     url = url_generator->GenerateWithSelectedNodes(left_node, right_node);\n   }\n-  return absl::StrCat(PrintHloTextboxPair(left_node, right_node),\n-                      url.empty() ? \"\"\n-                                  : PrintDiv(PrintLink(\"Model Explorer\", url),\n-                                             {\"model-explorer-url\"}));\n+  return absl::StrCat(\n+      PrintHloTextboxPair(left_node, right_node, span_attributes),\n+      url.empty()\n+          ? \"\"\n+          : PrintDiv(PrintLink(\"Model Explorer\", url), {\"model-explorer-url\"}));\n }\n \n // Prints a pair of instructions or computations. If url_generator is not\n // null, a link to the pair of instructions or computations in model\n // explorer will be printed.\n template <typename T>\n-std::string PrintNodePair(const T* left_node, const T* right_node,\n-                          GraphUrlGenerator* url_generator,\n-                          std::optional<absl::FunctionRef<DecorationPrinter<T>>>\n-                              decoration_printer = std::nullopt) {\n+std::string PrintNodePair(\n+    const T* left_node, const T* right_node,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes,\n+    GraphUrlGenerator* url_generator,\n+    std::optional<absl::FunctionRef<DecorationPrinter<T>>> decoration_printer =\n+        std::nullopt) {\n   std::vector<std::string> nodes;\n   if (left_node != nullptr) {\n     nodes.push_back(std::string(left_node->name()));\n@@ -499,9 +552,9 @@ std::string PrintNodePair(const T* left_node, const T* right_node,\n     decoration =\n         PrintSpan((*decoration_printer)(left_node, right_node), {\"decoration\"});\n   }\n-  return PrintDetails(\n-      absl::StrCat(text, \" \", decoration),\n-      PrintNodePairContent<T>(left_node, right_node, url_generator));\n+  return PrintDetails(absl::StrCat(text, \" \", decoration),\n+                      PrintNodePairContent<T>(left_node, right_node,\n+                                              span_attributes, url_generator));\n }\n \n // The location of the instruction in the diff result.\n@@ -516,11 +569,12 @@ std::string PrintInstructionsAsList(\n   for (const HloInstruction* inst : instructions) {\n     std::string link;\n     if (location == InstructionLocation::kLeft) {\n-      link = PrintNodePair<HloInstruction>(inst, /*right_node=*/nullptr,\n-                                           url_generator);\n+      link =\n+          PrintNodePair<HloInstruction>(inst, /*right_node=*/nullptr,\n+                                        /*span_attributes=*/{}, url_generator);\n     } else {\n       link = PrintNodePair<HloInstruction>(\n-          /*left_node=*/nullptr, inst, url_generator);\n+          /*left_node=*/nullptr, inst, /*span_attributes=*/{}, url_generator);\n     }\n     instructions_list.push_back(link);\n   }\n@@ -535,7 +589,8 @@ std::string PrintNodePairsAsList(\n     std::optional<absl::FunctionRef<DecorationPrinter<T>>> decoration_printer) {\n   std::vector<std::string> pair_list;\n   for (const auto& pair : node_pairs) {\n-    pair_list.push_back(PrintNodePair(pair.first, pair.second, url_generator,\n+    pair_list.push_back(PrintNodePair(pair.first, pair.second,\n+                                      /*span_attributes=*/{}, url_generator,\n                                       decoration_printer));\n   }\n   return PrintList(pair_list);\n@@ -714,7 +769,7 @@ std::string PrintUnmatchedMetricsDiff(\n       right_inst = inst;\n     }\n     metrics_diff_list.push_back(PrintNodePair<HloInstruction>(\n-        left_inst, right_inst, url_generator,\n+        left_inst, right_inst, /*span_attributes=*/{}, url_generator,\n         [&metrics_diff](const HloInstruction* inst,\n                         const HloInstruction*) -> std::string {\n           return absl::StrFormat(\"%.2f (us)\", metrics_diff / 1e6);\n@@ -753,7 +808,7 @@ std::string PrintMatchedMetricsDiff(\n     const HloInstruction* right_inst = entry.first.second;\n     double metrics_diff = entry.second;\n     metrics_diff_list.push_back(PrintNodePair<HloInstruction>(\n-        left_inst, right_inst, url_generator,\n+        left_inst, right_inst, /*span_attributes=*/{}, url_generator,\n         [&metrics_diff](const HloInstruction* left_inst,\n                         const HloInstruction* right_inst) -> std::string {\n           return absl::StrFormat(\"%+.2f (us)\", metrics_diff / 1e6);\n@@ -821,8 +876,11 @@ std::string PrintDiffMetrics(const DiffMetrics& diff_metrics) {\n }\n \n // Prints the computation summary\n-std::string PrintComputationSummary(const ComputationDiffPattern& diff_pattern,\n-                                    GraphUrlGenerator* url_generator) {\n+std::string PrintComputationSummary(\n+    const ComputationDiffPattern& diff_pattern,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes,\n+    GraphUrlGenerator* url_generator) {\n   const ComputationGroup& sample = diff_pattern.computation_groups[0];\n   // We only support unmatched computation and one-to-one computation pairs.\n   if (sample.left_computations.size() > 1 ||\n@@ -843,16 +901,16 @@ std::string PrintComputationSummary(const ComputationDiffPattern& diff_pattern,\n             ? nullptr\n             : computation_group.right_computations[0];\n     computation_pair_list[i - 1] = PrintNodePair<HloComputation>(\n-        left_computation, right_computation, url_generator);\n+        left_computation, right_computation, span_attributes, url_generator);\n   }\n   const HloComputation* left_computation =\n       sample.left_computations.empty() ? nullptr : sample.left_computations[0];\n   const HloComputation* right_computation = sample.right_computations.empty()\n                                                 ? nullptr\n                                                 : sample.right_computations[0];\n   std::vector<std::string> contents;\n-  contents.push_back(\n-      PrintNodePairContent(left_computation, right_computation, url_generator));\n+  contents.push_back(PrintNodePairContent(left_computation, right_computation,\n+                                          span_attributes, url_generator));\n   if (!computation_pair_list.empty()) {\n     contents.push_back(\n         PrintDetails(absl::StrFormat(\"%d other similar computations\",\n@@ -875,6 +933,8 @@ std::string PrintComputationSummary(const ComputationDiffPattern& diff_pattern,\n // Prints the summary of the repetitive diff patterns.\n std::string PrintRepetitiveDiffPatterns(\n     absl::Span<const ComputationDiffPattern> diff_patterns,\n+    const absl::flat_hash_map<const HloInstruction*, Attributes>&\n+        span_attributes,\n     GraphUrlGenerator* url_generator) {\n   // Sort the diff patterns by the number of computations in each group in\n   // descending order.\n@@ -900,8 +960,9 @@ std::string PrintRepetitiveDiffPatterns(\n       });\n   std::string computation_group_list;\n   for (const ComputationDiffPattern& diff_pattern : sorted_diff_patterns) {\n-    absl::StrAppend(&computation_group_list,\n-                    PrintComputationSummary(diff_pattern, url_generator));\n+    absl::StrAppend(\n+        &computation_group_list,\n+        PrintComputationSummary(diff_pattern, span_attributes, url_generator));\n   }\n   return computation_group_list;\n }\n@@ -919,6 +980,9 @@ void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n   DiffResult filtered_diff_result =\n       FilterDiffResultByOpcode(diff_result, ignored_opcodes);\n \n+  absl::flat_hash_map<const HloInstruction*, Attributes> span_attributes =\n+      GenerateSpanAttributes(diff_result);\n+\n   out << PrintCss() << PrintJavascript();\n \n   // Print profile metrics diff\n@@ -955,7 +1019,7 @@ void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n   out << PrintSectionWithHeader(\n       \"Diffs grouped by computation (Ordered by # of different instructions)\",\n       PrintRepetitiveDiffPatterns(diff_summary.computation_diff_patterns,\n-                                  url_generator));\n+                                  span_attributes, url_generator));\n \n   // Print full diff results\n   out << PrintSectionWithHeader("
        }
    ],
    "stats": {
        "total": 128,
        "additions": 96,
        "deletions": 32
    }
}