{
    "author": "subhankarshah",
    "message": "Allow prefetching an hlo value if its use is colored in alternate memory even if if loop optimizer has decided otherwise.\n\nPiperOrigin-RevId: 847872344",
    "sha": "69ea2a930865c3ed5f916a832ca602cc9808ed1a",
    "files": [
        {
            "sha": "323cbe0e08c2de6164dbed7a8e10a3ec2f252d0b",
            "filename": "third_party/xla/xla/service/memory_space_assignment/algorithm.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69ea2a930865c3ed5f916a832ca602cc9808ed1a/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69ea2a930865c3ed5f916a832ca602cc9808ed1a/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc?ref=69ea2a930865c3ed5f916a832ca602cc9808ed1a",
            "patch": "@@ -6415,7 +6415,8 @@ AllocationResult MsaAlgorithm::AllocateSegment(AllocationRequest& request) {\n   }\n \n   // Finally, try to prefetch the buffer into alternate memory.\n-  if (request.allow_prefetch &&\n+  if ((request.allow_prefetch ||\n+       request.require_end_colored_in_alternate_memory) &&\n       !request.allocation_value->requires_contiguous_allocation() &&\n       !request.only_extend_existing_allocation &&\n       required_memory_space_at_end != MemorySpace::kDefault &&\n@@ -6490,7 +6491,18 @@ AllocationResult MsaAlgorithm::AllocateSegment(AllocationRequest& request) {\n     result_mark(prefetch_result, allocation_result);\n   }\n \n-  CHECK(!request.require_end_colored_in_alternate_memory);\n+  CHECK(!request.require_end_colored_in_alternate_memory)\n+      << \"Failed to allocate end in alternate memory, even though its \"\n+         \"required. \"\n+         \"requires_contiguous_allocation: \"\n+      << request.allocation_value->requires_contiguous_allocation()\n+      << \" only_extend_existing_allocation: \"\n+      << request.only_extend_existing_allocation\n+      << \" require_end_colored_in_default_memory: \"\n+      << request.require_end_colored_in_default_memory\n+      << \" required_memory_space_at_end: \"\n+      << (required_memory_space_at_end == MemorySpace::kDefault ? \"default\"\n+                                                                : \"alternate\");\n \n   // If the end assignment was required to be in alternate memory but that\n   // wasn't possible, then this allocation is invalid."
        },
        {
            "sha": "9f9ad74fe726dc4bdefdb6db1181d3d5d65013d6",
            "filename": "third_party/xla/xla/service/memory_space_assignment/memory_space_assignment_test.cc",
            "status": "modified",
            "additions": 161,
            "deletions": 0,
            "changes": 161,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69ea2a930865c3ed5f916a832ca602cc9808ed1a/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69ea2a930865c3ed5f916a832ca602cc9808ed1a/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc?ref=69ea2a930865c3ed5f916a832ca602cc9808ed1a",
            "patch": "@@ -14773,6 +14773,167 @@ TEST_F(MemorySpaceAssignmentTest, TestColoringMultipleOperands) {\n             kAlternateMemorySpace);\n }\n \n+TEST_F(MemorySpaceAssignmentTest, TestColoringWithLoopOptimization) {\n+  absl::string_view hlo_string = R\"hlo(\n+HloModule UnrolledLoop, is_scheduled=true\n+\n+ENTRY %main {\n+  %param.0 = (f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4],\n+              f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4], f32[2,4]) parameter(0)\n+\n+  %gte.0 = f32[2,4] get-tuple-element(%param.0), index=0\n+  %gte.1 = f32[2,4] get-tuple-element(%param.0), index=1\n+  %add.common = f32[2,4] add(%gte.0, %gte.1)\n+  %tanh.common = f32[2,4] tanh(%add.common)\n+\n+  // loop idx0\n+  %neg.0.idx0 = f32[2,4] negate(%tanh.common)\n+  %neg.1.idx0 = f32[2,4] negate(%neg.0.idx0)\n+  %neg.2.idx0 = f32[2,4] negate(%neg.1.idx0)\n+\n+  %gte.0.idx0 = f32[2,4] get-tuple-element(%param.0), index=2\n+  %add.0.idx0 = f32[2,4] add(%neg.2.idx0, %gte.0.idx0)\n+\n+  %gte.1.idx0 = f32[2,4] get-tuple-element(%param.0), index=3\n+  %add.1.idx0 = f32[2,4] add(%add.0.idx0, %gte.1.idx0)\n+\n+  %tanh.idx0 = f32[2,4] tanh(%add.1.idx0)\n+\n+  // loop idx1\n+  %neg.0.idx1 = f32[2,4] negate(%tanh.idx0)\n+  %neg.1.idx1 = f32[2,4] negate(%neg.0.idx1)\n+  %neg.2.idx1 = f32[2,4] negate(%neg.1.idx1)\n+\n+  %gte.0.idx1 = f32[2,4] get-tuple-element(%param.0), index=4\n+  %add.0.idx1 = f32[2,4] add(%neg.2.idx1, %gte.0.idx1)\n+\n+  %gte.1.idx1 = f32[2,4] get-tuple-element(%param.0), index=5\n+  %add.1.idx1 = f32[2,4] add(%add.0.idx1, %gte.1.idx1)\n+\n+  %tanh.idx1 = f32[2,4] tanh(%add.1.idx1)\n+\n+  // loop idx2\n+  %neg.0.idx2 = f32[2,4] negate(%tanh.idx1)\n+  %neg.1.idx2 = f32[2,4] negate(%neg.0.idx2)\n+  %neg.2.idx2 = f32[2,4] negate(%neg.1.idx2)\n+\n+  %gte.0.idx2 = f32[2,4] get-tuple-element(%param.0), index=6\n+  %add.0.idx2 = f32[2,4] add(%neg.2.idx2, %gte.0.idx2)\n+\n+  %gte.1.idx2 = f32[2,4] get-tuple-element(%param.0), index=7\n+  %add.1.idx2 = f32[2,4] add(%add.0.idx2, %gte.1.idx2)\n+\n+  %tanh.idx2 = f32[2,4] tanh(%add.1.idx2)\n+\n+  // loop idx3\n+  %neg.0.idx3 = f32[2,4] negate(%tanh.idx2)\n+  %neg.1.idx3 = f32[2,4] negate(%neg.0.idx3)\n+  %neg.2.idx3 = f32[2,4] negate(%neg.1.idx3)\n+\n+  %gte.0.idx3 = f32[2,4] get-tuple-element(%param.0), index=8\n+  %add.0.idx3 = f32[2,4] add(%neg.2.idx3, %gte.0.idx3)\n+\n+  %gte.1.idx3 = f32[2,4] get-tuple-element(%param.0), index=9\n+  %add.1.idx3 = f32[2,4] add(%add.0.idx3, %gte.1.idx3)\n+\n+  %tanh.idx3 = f32[2,4] tanh(%add.1.idx3)\n+\n+  // loop idx4\n+  %neg.0.idx4 = f32[2,4] negate(%tanh.idx3)\n+  %neg.1.idx4 = f32[2,4] negate(%neg.0.idx4)\n+  %neg.2.idx4 = f32[2,4] negate(%neg.1.idx4)\n+\n+  %gte.0.idx4 = f32[2,4] get-tuple-element(%param.0), index=10\n+  %add.0.idx4 = f32[2,4] add(%neg.2.idx4, %gte.0.idx4)\n+\n+  %gte.1.idx4 = f32[2,4] get-tuple-element(%param.0), index=11\n+  %add.1.idx4 = f32[2,4] add(%add.0.idx4, %gte.1.idx4)\n+\n+  %tanh.idx4 = f32[2,4] tanh(%add.1.idx4)\n+\n+  // loop idx5\n+  %neg.0.idx5 = f32[2,4] negate(%tanh.idx4)\n+  %neg.1.idx5 = f32[2,4] negate(%neg.0.idx5)\n+  %neg.2.idx5 = f32[2,4] negate(%neg.1.idx5)\n+\n+  %gte.0.idx5 = f32[2,4] get-tuple-element(%param.0), index=12\n+  %add.0.idx5 = f32[2,4] add(%neg.2.idx5, %gte.0.idx5)\n+\n+  %gte.1.idx5 = f32[2,4] get-tuple-element(%param.0), index=13\n+  %add.1.idx5 = f32[2,4] add(%add.0.idx5, %gte.1.idx5)\n+\n+  %tanh.idx5 = f32[2,4] tanh(%add.1.idx5)\n+\n+  // loop idx6\n+  %neg.0.idx6 = f32[2,4] negate(%tanh.idx5)\n+  %neg.1.idx6 = f32[2,4] negate(%neg.0.idx6)\n+  %neg.2.idx6 = f32[2,4] negate(%neg.1.idx6)\n+\n+  %gte.0.idx6 = f32[2,4] get-tuple-element(%param.0), index=14\n+  %add.0.idx6 = f32[2,4] add(%neg.2.idx6, %gte.0.idx6)\n+\n+  %gte.1.idx6 = f32[2,4] get-tuple-element(%param.0), index=15\n+  %add.1.idx6 = f32[2,4] add(%add.0.idx6, %gte.1.idx6)\n+\n+  %tanh.idx6 = f32[2,4] tanh(%add.1.idx6)\n+\n+  ROOT %negate.common = f32[2,4] negate(%tanh.idx6)\n+})hlo\";\n+  ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n+                       ParseAndReturnVerifiedModule(hlo_string));\n+  Options memory_space_options = DefaultMemorySpaceOptions();\n+  memory_space_options.max_size_in_bytes = 48;\n+  memory_space_options.memory_bound_loop_optimizer_options.set_enabled(true);\n+  memory_space_options.memory_bound_loop_optimizer_options\n+      .set_desired_copy_ratio(0.1);\n+  memory_space_options.memory_bound_loop_optimizer_options\n+      .set_allow_unsatisfied_fully_pipelined_prefetch(true);\n+  memory_space_options.memory_bound_loop_optimizer_options\n+      .set_min_num_iterations(4);\n+  HloUse add_0_idx0_use{FindInstruction(module.get(), \"add.0.idx0\"), 1, {}};\n+  HloUse add_1_idx0_use{FindInstruction(module.get(), \"add.1.idx0\"), 1, {}};\n+  HloUse add_0_idx1_use{FindInstruction(module.get(), \"add.0.idx1\"), 1, {}};\n+  HloUse add_1_idx1_use{FindInstruction(module.get(), \"add.1.idx1\"), 1, {}};\n+  HloUse add_0_idx2_use{FindInstruction(module.get(), \"add.0.idx2\"), 1, {}};\n+  HloUse add_1_idx2_use{FindInstruction(module.get(), \"add.1.idx2\"), 1, {}};\n+  HloUse add_0_idx3_use{FindInstruction(module.get(), \"add.0.idx3\"), 1, {}};\n+  HloUse add_1_idx3_use{FindInstruction(module.get(), \"add.1.idx3\"), 1, {}};\n+  HloUse add_0_idx4_use{FindInstruction(module.get(), \"add.0.idx4\"), 1, {}};\n+  HloUse add_1_idx4_use{FindInstruction(module.get(), \"add.1.idx4\"), 1, {}};\n+  HloUse add_0_idx5_use{FindInstruction(module.get(), \"add.0.idx5\"), 1, {}};\n+  HloUse add_1_idx5_use{FindInstruction(module.get(), \"add.1.idx5\"), 1, {}};\n+  HloUse add_0_idx6_use{FindInstruction(module.get(), \"add.0.idx6\"), 1, {}};\n+  HloUse add_1_idx6_use{FindInstruction(module.get(), \"add.1.idx6\"), 1, {}};\n+  memory_space_options.buffer_colorings = {\n+      {add_0_idx0_use, kAlternateMemorySpace},\n+      {add_1_idx0_use, kAlternateMemorySpace},\n+      {add_0_idx1_use, kAlternateMemorySpace},\n+      {add_1_idx1_use, kAlternateMemorySpace},\n+      {add_0_idx2_use, kAlternateMemorySpace},\n+      {add_1_idx2_use, kAlternateMemorySpace},\n+      {add_0_idx3_use, kAlternateMemorySpace},\n+      {add_1_idx3_use, kAlternateMemorySpace},\n+      {add_0_idx4_use, kAlternateMemorySpace},\n+      {add_1_idx4_use, kAlternateMemorySpace},\n+      {add_0_idx5_use, kAlternateMemorySpace},\n+      {add_1_idx5_use, kAlternateMemorySpace},\n+      {add_0_idx6_use, kAlternateMemorySpace},\n+      {add_1_idx6_use, kAlternateMemorySpace}};\n+  XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n+\n+  AssignMemorySpaceUsingCostAnalysis(module.get(),\n+                                     std::move(memory_space_options));\n+  XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n+  std::vector<std::string> alternate_memory_uses = {\n+      \"add.0.idx0\", \"add.1.idx0\", \"add.0.idx1\", \"add.1.idx1\", \"add.0.idx2\",\n+      \"add.1.idx2\", \"add.0.idx3\", \"add.1.idx3\", \"add.0.idx4\", \"add.1.idx4\",\n+      \"add.0.idx5\", \"add.1.idx5\", \"add.0.idx6\", \"add.1.idx6\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/alternate_memory_uses,\n+      /*operand_index=*/1, /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n+}\n+\n TEST_F(MemorySpaceAssignmentTest,\n        ScopedAllocationAccountingWhenInstructionsAreRemoved) {\n   absl::string_view hlo_string = R\"("
        }
    ],
    "stats": {
        "total": 177,
        "additions": 175,
        "deletions": 2
    }
}