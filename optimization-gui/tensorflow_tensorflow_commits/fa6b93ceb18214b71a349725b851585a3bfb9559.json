{
    "author": "basioli-k",
    "message": "[XLA:CPU] Log a warning instead of returning an error when target machine features for compilation and execution don't match.\n\nPiperOrigin-RevId: 827873264",
    "sha": "fa6b93ceb18214b71a349725b851585a3bfb9559",
    "files": [
        {
            "sha": "14210f44ead3be0942db58762f384d06cb7f099c",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 15,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa6b93ceb18214b71a349725b851585a3bfb9559/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa6b93ceb18214b71a349725b851585a3bfb9559/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc?ref=fa6b93ceb18214b71a349725b851585a3bfb9559",
            "patch": "@@ -190,25 +190,28 @@ CpuAotLoader::LoadAotCompilationResult(\n   llvm::StringMap<bool> host_machine_features = llvm::sys::getHostCPUFeatures();\n   auto compile_machine_features =\n       absl::StrSplit(aot_result_proto.target_machine_options().features(), ',');\n+  // Convert the supported features to a vector of strings.\n+  std::vector<std::string> host_machine_features_vector;\n+  for (const auto& [feature, supported] : host_machine_features) {\n+    if (supported) {\n+      host_machine_features_vector.push_back(feature.str());\n+    }\n+  }\n \n   for (const absl::string_view feature : compile_machine_features) {\n     if (!host_machine_features.contains(feature) ||\n         !host_machine_features[feature]) {\n-      // Convert the supported features to a vector of strings.\n-      std::vector<std::string> host_machine_features_vector;\n-      for (const auto& [feature, supported] : host_machine_features) {\n-        if (supported) {\n-          host_machine_features_vector.push_back(feature.str());\n-        }\n-      }\n-\n-      return Internal(\n-          \"Cannot load XLA:CPU AOT result. Target machine feature %s is not \"\n-          \"supported on the host machine. Machine type used for XLA:CPU \"\n-          \"compilation doesn't match the machine type for execution. Compile \"\n-          \"machine features: [%s] vs host machine features: [%s]\",\n-          feature, absl::StrJoin(compile_machine_features, \",\"),\n-          absl::StrJoin(host_machine_features_vector, \",\"));\n+      // TODO: b/457415427 - Turn this warning into an error once a mechanism\n+      // for passing target machine features to the CPU compiler is implemented.\n+      LOG(ERROR)\n+          << \"Loading XLA:CPU AOT result. Target machine feature \" << feature\n+          << \" is not  supported on the host machine. Machine type used for \"\n+             \"XLA:CPU compilation doesn't match the machine type for \"\n+             \"execution. Compile machine features: [\"\n+          << absl::StrJoin(compile_machine_features, \",\")\n+          << \"] vs host machine features: [\"\n+          << absl::StrJoin(host_machine_features_vector, \",\") << \"]\"\n+          << \". This could lead to execution errors such as SIGILL.\";\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 33,
        "additions": 18,
        "deletions": 15
    }
}