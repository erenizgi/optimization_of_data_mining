{
    "author": "tensorflower-gardener",
    "message": "Fix nontrivial-memcall MemCpyCopier w/ constexpr\n\nAt present, invoking ConcatCPU with a nontrivial datatype T is\nundefined behavior. This is caught by -Wnontrivial-memcall correctly,\nwhich has been expanded to identify such cases. However, we actually\nhave checks at runtime already to verify no UB is actually being\nexercised.\n\nThis commit replaces the runtime check with a compile-time evaluation\nwith constexpr.\n\nPiperOrigin-RevId: 814852949",
    "sha": "b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91",
    "files": [
        {
            "sha": "c6939faff56176e5f8f29607f87e477ea01182db",
            "filename": "tensorflow/core/framework/types.h",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91/tensorflow%2Fcore%2Fframework%2Ftypes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91/tensorflow%2Fcore%2Fframework%2Ftypes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fframework%2Ftypes.h?ref=b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91",
            "patch": "@@ -310,7 +310,7 @@ struct EnumToDataType {};  // Specializations below\n #define MATCH_TYPE_AND_ENUM(TYPE, ENUM)                 \\\n   template <>                                           \\\n   struct DataTypeToEnum<TYPE> {                         \\\n-    static DataType v() { return ENUM; }                \\\n+    static constexpr DataType v() { return ENUM; }      \\\n     static DataType ref() { return MakeRefType(ENUM); } \\\n     static constexpr DataType value = ENUM;             \\\n   };                                                    \\\n@@ -356,7 +356,7 @@ MATCH_TYPE_AND_ENUM(Variant, DT_VARIANT);\n \n template <>\n struct DataTypeToEnum<long> {\n-  static DataType v() { return value; }\n+  static constexpr DataType v() { return value; }\n   static DataType ref() { return MakeRefType(value); }\n   static constexpr DataType value = sizeof(long) == 4 ? DT_INT32 : DT_INT64;\n };\n@@ -371,7 +371,7 @@ struct EnumToDataType<DT_INT64> {\n \n template <>\n struct DataTypeToEnum<unsigned long> {\n-  static DataType v() { return value; }\n+  static constexpr DataType v() { return value; }\n   static DataType ref() { return MakeRefType(value); }\n   static constexpr DataType value =\n       sizeof(unsigned long) == 4 ? DT_UINT32 : DT_UINT64;\n@@ -387,7 +387,7 @@ struct EnumToDataType<DT_UINT64> {\n \n template <>\n struct DataTypeToEnum<long long> {\n-  static DataType v() { return DT_INT64; }\n+  static constexpr DataType v() { return DT_INT64; }\n   static DataType ref() { return MakeRefType(DT_INT64); }\n   static constexpr DataType value = DT_INT64;\n };\n@@ -398,7 +398,7 @@ struct IsValidDataType<long long> {\n \n template <>\n struct DataTypeToEnum<unsigned long long> {\n-  static DataType v() { return DT_UINT64; }\n+  static constexpr DataType v() { return DT_UINT64; }\n   static DataType ref() { return MakeRefType(DT_UINT64); }\n   static constexpr DataType value = DT_UINT64;\n };\n@@ -432,7 +432,7 @@ constexpr DataTypeSet kDataTypesCanUseMemcpy =\n     ToSet(DT_FLOAT8_E4M3B11FNUZ) | ToSet(DT_FLOAT8_E5M2FNUZ) | ToSet(DT_INT4) |\n     ToSet(DT_UINT4) | ToSet(DT_INT2) | ToSet(DT_UINT2);\n \n-inline bool DataTypeCanUseMemcpy(DataType dt) {\n+constexpr bool DataTypeCanUseMemcpy(DataType dt) {\n   return kDataTypesCanUseMemcpy.Contains(dt);\n }\n "
        },
        {
            "sha": "993177a532d029de5b001d823d9b46137d24a5df",
            "filename": "tensorflow/core/kernels/concat_lib_cpu.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91/tensorflow%2Fcore%2Fkernels%2Fconcat_lib_cpu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91/tensorflow%2Fcore%2Fkernels%2Fconcat_lib_cpu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Fconcat_lib_cpu.cc?ref=b7c3c0a6034c2e1b72d622e0dd8c792d26e7cc91",
            "patch": "@@ -30,7 +30,7 @@ namespace {\n template <typename T>\n struct MemCpyCopier {\n   inline void Copy(T* dst, const T* src, int input_index, size_t n) {\n-    if (DataTypeCanUseMemcpy(DataTypeToEnum<T>::v())) {\n+    if constexpr (DataTypeCanUseMemcpy(DataTypeToEnum<T>::v())) {\n       memcpy(dst, src, n * sizeof(T));\n     } else {\n       for (size_t k = 0; k < n; ++k) {"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 7,
        "deletions": 7
    }
}