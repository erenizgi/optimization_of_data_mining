{
    "author": "amd-songpiao",
    "message": "PR #32002: [ROCm] fix rocm build xla tools hlo runner\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32002\n\nüìù Summary of Changes\n\n1. avoid using hardcoded so versions in rocm.\n2. fixed the build error of multihost_hlo_runner on rocm.\n\n@xla-rotation could you review my PR, please?\nCopybara import of the project:\n\n--\ne6aab9f14d14c852235970928979af1df5cca762 by Songlin <Songlin.Piao@amd.com>:\n\ncorrected build configurations for rocm\n\n--\nf39a0eb142b46e07f1e68526bbd326482a06823b by Songlin <Songlin.Piao@amd.com>:\n\navoid hardcoding soversions\n\n--\n14f39cfcaa60c3719d320bf42ff6be4ddaa55e37 by Songlin <Songlin.Piao@amd.com>:\n\nrestore the change which is unrelated to the rest (would create a separate PR)\n\nMerging this change closes #32002\n\nPiperOrigin-RevId: 816649161",
    "sha": "1e073581ce2079f806491b00ca096ea5d71662ca",
    "files": [
        {
            "sha": "53e5fd35f1034d55b81e47c7f5eb789f2215c083",
            "filename": "third_party/xla/third_party/gpus/rocm/rocm_config.h.tpl",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1e073581ce2079f806491b00ca096ea5d71662ca/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_config.h.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1e073581ce2079f806491b00ca096ea5d71662ca/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_config.h.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_config.h.tpl?ref=1e073581ce2079f806491b00ca096ea5d71662ca",
            "patch": "@@ -24,5 +24,13 @@ limitations under the License.\n #define TF_HIPBLASLT %{hipblaslt_flag}\n #define TF_HIPRUNTIME_SOVERSION \"%{hip_soversion_number}\"\n #define TF_ROCBLAS_SOVERSION \"%{rocblas_soversion_number}\"\n+#define TF_HIPBLASLT_SOVERSION \"%{hipblaslt_soversion_number}\"\n+#define TF_MIOPEN_SOVERSION \"%{miopen_soversion_number}\"\n+#define TF_HIPFFT_SOVERSION \"%{hipfft_soversion_number}\"\n+#define TF_ROCSOLVER_SOVERSION \"%{rocsolver_soversion_number}\"\n+#define TF_HIPSPARSE_SOVERSION \"%{hipsparse_soversion_number}\"\n+#define TF_ROCTRACER_SOVERSION \"%{roctracer_soversion_number}\"\n+#define TF_HIPSOLVER_SOVERSION \"%{hipsolver_soversion_number}\"\n+#define TF_ROCRAND_SOVERSION \"%{rocrand_soversion_number}\"\n \n #endif  // ROCM_ROCM_CONFIG_H_"
        },
        {
            "sha": "43212efeab1203ebf1a0b71e878d38c11b754eef",
            "filename": "third_party/xla/third_party/gpus/rocm_configure.bzl",
            "status": "modified",
            "additions": 56,
            "deletions": 5,
            "changes": 61,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1e073581ce2079f806491b00ca096ea5d71662ca/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1e073581ce2079f806491b00ca096ea5d71662ca/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl?ref=1e073581ce2079f806491b00ca096ea5d71662ca",
            "patch": "@@ -246,6 +246,35 @@ def _batch_files_exist(repository_ctx, libs_paths, bash_bin):\n             all_paths.append(lib_path)\n     return files_exist(repository_ctx, all_paths, bash_bin)\n \n+def _soversion(repository_ctx, path, bash_bin = None):\n+    \"\"\"Returns the soversion of a given library.\n+\n+    Args:\n+      repository_ctx: the repository_ctx\n+      path: a path on the file system\n+      bash_bin: path to the bash interpreter\n+\n+    Returns:\n+      Parsed soversion string form the SONAME dtag of the library\n+    \"\"\"\n+    if bash_bin == None:\n+        bash_bin = get_bash_bin(repository_ctx)\n+\n+    exec_result = execute(repository_ctx, [bash_bin, \"-c\", \"readelf --dynamic \\\"%s\\\"\" % path])\n+\n+    if exec_result.return_code:\n+        auto_configure_fail(\"Failed to run readelf to find soversion: %s\" % err_out(exec_result))\n+\n+    soversion = \"\"\n+    for row in exec_result.stdout.strip().split(\"\\n\"):\n+        match = row.find(\"SONAME\")\n+        if match >= 0:\n+            match = row.find(\".so.\", match)\n+            if match >= 0:\n+                soversion = row[match + 4:-1]\n+                break\n+    return soversion\n+\n def _select_rocm_lib_paths(repository_ctx, libs_paths, bash_bin):\n     test_results = _batch_files_exist(repository_ctx, libs_paths, bash_bin)\n \n@@ -268,7 +297,11 @@ def _select_rocm_lib_paths(repository_ctx, libs_paths, bash_bin):\n             else:\n                 auto_configure_fail(\"Cannot find rocm library %s\" % name)\n \n-        libs[name] = struct(file_name = selected_path.basename, path = realpath(repository_ctx, selected_path, bash_bin))\n+        libs[name] = struct(\n+            file_name = selected_path.basename,\n+            path = realpath(repository_ctx, selected_path, bash_bin),\n+            soversion = _soversion(repository_ctx, selected_path, bash_bin),\n+        )\n \n     return libs\n \n@@ -294,6 +327,8 @@ def _find_libs(repository_ctx, rocm_config, miopen_path, rccl_path, bash_bin):\n             (\"hipsparse\", rocm_config.rocm_toolkit_path),\n             (\"roctracer64\", rocm_config.rocm_toolkit_path),\n             (\"rocsolver\", rocm_config.rocm_toolkit_path),\n+            (\"hipfft\", rocm_config.rocm_toolkit_path),\n+            (\"rocrand\", rocm_config.rocm_toolkit_path),\n         ]\n     ]\n     if int(rocm_config.rocm_version_number) >= 40500:\n@@ -715,8 +750,16 @@ def _create_local_rocm_repository(repository_ctx):\n             \"%{miopen_version_number}\": rocm_config.miopen_version_number,\n             \"%{hipruntime_version_number}\": rocm_config.hipruntime_version_number,\n             \"%{hipblaslt_flag}\": have_hipblaslt,\n-            \"%{hip_soversion_number}\": \"6\" if int(rocm_config.rocm_version_number) >= 60000 else \"5\",\n-            \"%{rocblas_soversion_number}\": \"5\" if int(rocm_config.rocm_version_number) >= 70000 else \"4\",\n+            \"%{hip_soversion_number}\": rocm_libs[\"amdhip64\"].soversion,\n+            \"%{rocblas_soversion_number}\": rocm_libs[\"rocblas\"].soversion,\n+            \"%{hipblaslt_soversion_number}\": rocm_libs[\"hipblaslt\"].soversion if rocm_libs[\"hipblaslt\"] != None else \"\",\n+            \"%{miopen_soversion_number}\": rocm_libs[\"MIOpen\"].soversion,\n+            \"%{hipfft_soversion_number}\": rocm_libs[\"hipfft\"].soversion,\n+            \"%{rocsolver_soversion_number}\": rocm_libs[\"rocsolver\"].soversion if rocm_libs[\"rocsolver\"] != None else \"\",\n+            \"%{hipsolver_soversion_number}\": rocm_libs[\"hipsolver\"].soversion if rocm_libs[\"hipsolver\"] != None else \"\",\n+            \"%{hipsparse_soversion_number}\": rocm_libs[\"hipsparse\"].soversion,\n+            \"%{roctracer_soversion_number}\": rocm_libs[\"roctracer64\"].soversion,\n+            \"%{rocrand_soversion_number}\": rocm_libs[\"rocrand\"].soversion,\n         },\n     )\n \n@@ -734,8 +777,16 @@ def _create_local_rocm_repository(repository_ctx):\n             \"%{miopen_version_number}\": rocm_config.miopen_version_number,\n             \"%{hipruntime_version_number}\": rocm_config.hipruntime_version_number,\n             \"%{hipblaslt_flag}\": have_hipblaslt,\n-            \"%{hip_soversion_number}\": \"6\" if int(rocm_config.rocm_version_number) >= 60000 else \"5\",\n-            \"%{rocblas_soversion_number}\": \"5\" if int(rocm_config.rocm_version_number) >= 70000 else \"4\",\n+            \"%{hip_soversion_number}\": rocm_libs[\"amdhip64\"].soversion,\n+            \"%{rocblas_soversion_number}\": rocm_libs[\"rocblas\"].soversion,\n+            \"%{hipblaslt_soversion_number}\": rocm_libs[\"hipblaslt\"].soversion if rocm_libs[\"hipblaslt\"] != None else \"\",\n+            \"%{miopen_soversion_number}\": rocm_libs[\"MIOpen\"].soversion,\n+            \"%{hipfft_soversion_number}\": rocm_libs[\"hipfft\"].soversion,\n+            \"%{rocsolver_soversion_number}\": rocm_libs[\"rocsolver\"].soversion if rocm_libs[\"rocsolver\"] != None else \"\",\n+            \"%{hipsolver_soversion_number}\": rocm_libs[\"hipsolver\"].soversion if rocm_libs[\"hipsolver\"] != None else \"\",\n+            \"%{hipsparse_soversion_number}\": rocm_libs[\"hipsparse\"].soversion,\n+            \"%{roctracer_soversion_number}\": rocm_libs[\"roctracer64\"].soversion,\n+            \"%{rocrand_soversion_number}\": rocm_libs[\"rocrand\"].soversion,\n         },\n     )\n "
        },
        {
            "sha": "1a05bcd1e673390bfa6603fedb442fbd8a7806e8",
            "filename": "third_party/xla/xla/tsl/platform/default/dso_loader.cc",
            "status": "modified",
            "additions": 67,
            "deletions": 10,
            "changes": 77,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1e073581ce2079f806491b00ca096ea5d71662ca/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fdso_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1e073581ce2079f806491b00ca096ea5d71662ca/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fdso_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fdso_loader.cc?ref=1e073581ce2079f806491b00ca096ea5d71662ca",
            "patch": "@@ -57,14 +57,71 @@ absl::string_view GetHipVersion() {\n   return \"\";\n #endif  // TENSORFLOW_USE_ROCM\n }\n-absl::string_view GetRocBlasVersion() {\n+absl::string_view GetRocblasVersion() {\n #if TENSORFLOW_USE_ROCM\n   return TF_ROCBLAS_SOVERSION;\n #else   // TENSORFLOW_USE_ROCM\n   return \"\";\n #endif  // TENSORFLOW_USE_ROCM\n }\n \n+std::string GetHipblasltVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_HIPBLASLT_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetMiopenVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_MIOPEN_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetHipfftVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_HIPFFT_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetRocsolverVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_ROCSOLVER_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetHipsparseVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_HIPSPARSE_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetRoctracerVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_ROCTRACER_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetHipsolverVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_HIPSOLVER_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+std::string GetRocrandVersion() {\n+#if TENSORFLOW_USE_ROCM\n+  return TF_ROCRAND_SOVERSION;\n+#else   // TENSORFLOW_USE_ROCM\n+  return \"\";\n+#endif  // TENSORFLOW_USE_ROCM\n+}\n+\n absl::StatusOr<void*> GetDsoHandle(const std::string& name,\n                                    absl::string_view version) {\n   auto filename =\n@@ -165,41 +222,41 @@ absl::StatusOr<void*> GetNvInferPluginDsoHandle() {\n }\n \n absl::StatusOr<void*> GetRocblasDsoHandle() {\n-  return GetDsoHandle(\"rocblas\", GetRocBlasVersion());\n+  return GetDsoHandle(\"rocblas\", GetRocblasVersion());\n }\n \n absl::StatusOr<void*> GetMiopenDsoHandle() {\n-  return GetDsoHandle(\"MIOpen\", \"\");\n+  return GetDsoHandle(\"MIOpen\", GetMiopenVersion());\n }\n \n absl::StatusOr<void*> GetHipfftDsoHandle() {\n-  return GetDsoHandle(\"hipfft\", \"\");\n+  return GetDsoHandle(\"hipfft\", GetHipfftVersion());\n }\n \n absl::StatusOr<void*> GetRocrandDsoHandle() {\n-  return GetDsoHandle(\"rocrand\", \"\");\n+  return GetDsoHandle(\"rocrand\", GetRocrandVersion());\n }\n \n absl::StatusOr<void*> GetRocsolverDsoHandle() {\n-  return GetDsoHandle(\"rocsolver\", \"\");\n+  return GetDsoHandle(\"rocsolver\", GetRocsolverVersion());\n }\n \n #if TF_ROCM_VERSION >= 40500\n absl::StatusOr<void*> GetHipsolverDsoHandle() {\n-  return GetDsoHandle(\"hipsolver\", \"\");\n+  return GetDsoHandle(\"hipsolver\", GetHipsolverVersion());\n }\n #endif\n \n absl::StatusOr<void*> GetRoctracerDsoHandle() {\n-  return GetDsoHandle(\"roctracer64\", \"\");\n+  return GetDsoHandle(\"roctracer64\", GetRoctracerVersion());\n }\n \n absl::StatusOr<void*> GetHipsparseDsoHandle() {\n-  return GetDsoHandle(\"hipsparse\", \"\");\n+  return GetDsoHandle(\"hipsparse\", GetHipsparseVersion());\n }\n \n absl::StatusOr<void*> GetHipblasltDsoHandle() {\n-  return GetDsoHandle(\"hipblaslt\", \"\");\n+  return GetDsoHandle(\"hipblaslt\", GetHipblasltVersion());\n }\n \n absl::StatusOr<void*> GetHipDsoHandle() {"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 131,
        "deletions": 15
    }
}