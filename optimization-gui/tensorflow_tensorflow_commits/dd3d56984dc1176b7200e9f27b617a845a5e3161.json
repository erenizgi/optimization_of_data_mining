{
    "author": "bchetioui",
    "message": "[XLA:GPU] Re-establish support test invariants.\n\nSome opcodes had been added to the set of tested opcodes without corresponding\ntests, voiding the warranty on the generic Triton emitter.\n\nPiperOrigin-RevId: 802907424",
    "sha": "dd3d56984dc1176b7200e9f27b617a845a5e3161",
    "files": [
        {
            "sha": "fde640c5e840acd3ec75ab404f651e9aed54ad8a",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/support.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dd3d56984dc1176b7200e9f27b617a845a5e3161/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fsupport.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dd3d56984dc1176b7200e9f27b617a845a5e3161/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fsupport.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fsupport.cc?ref=dd3d56984dc1176b7200e9f27b617a845a5e3161",
            "patch": "@@ -688,10 +688,12 @@ namespace internal {\n bool IsTritonUnsupportedOpcode(HloOpcode opcode) {\n   switch (opcode) {\n     case HloOpcode::kDynamicReshape:\n+    case HloOpcode::kDynamicSlice:\n     case HloOpcode::kDynamicUpdateSlice:\n     case HloOpcode::kGather:\n     case HloOpcode::kRaggedDot:\n     case HloOpcode::kReduceWindow:\n+    case HloOpcode::kScaledDot:\n     case HloOpcode::kScatter:\n     case HloOpcode::kSelectAndScatter:\n     case HloOpcode::kSetDimensionSize:"
        },
        {
            "sha": "d33d39c278e29959f26066928906588b802fc3c8",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/support_test.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dd3d56984dc1176b7200e9f27b617a845a5e3161/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fsupport_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dd3d56984dc1176b7200e9f27b617a845a5e3161/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fsupport_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fsupport_test.cc?ref=dd3d56984dc1176b7200e9f27b617a845a5e3161",
            "patch": "@@ -3407,21 +3407,36 @@ INSTANTIATE_TEST_SUITE_P(ConvolutionTestSuiteCcOnly, ConvolutionTestCcOnly,\n                          ::testing::ValuesIn(AllDevicesToTest()),\n                          TritonSupportTestDeviceToString);\n \n+// This denotes opcodes that are explicitly not supported by the generic Triton\n+// emitter, and have also not been tested at all in the support test. If you\n+// are adding a new opcode that can't be easily added to other parametrized\n+// tests (e.g. adding tests to unary elementwise ops should be simple enough\n+// that adding them here is probably not necessary), add it here to ensure that\n+// the support test invariants are preserved.\n constexpr std::array kUnsupportedOps = {\n     // clang-format off\n     // go/keep-sorted start\n     HloOpcode::kDynamicReshape,\n+    HloOpcode::kDynamicSlice,\n     HloOpcode::kDynamicUpdateSlice,\n     HloOpcode::kGather,\n     HloOpcode::kRaggedDot,\n     HloOpcode::kReduceWindow,\n+    HloOpcode::kScaledDot,\n     HloOpcode::kScatter,\n     HloOpcode::kSelectAndScatter,\n     HloOpcode::kSetDimensionSize,\n     // go/keep-sorted end\n     // clang-format on\n };\n \n+// This function returns the set of opcodes that have explicit corresponding\n+// tests in this file. *DO NOT* add opcodes here unless you're also adding\n+// sufficiently exhaustive tests for them.\n+//\n+// Also prefer to create `kTestedOps*` constants capturing each opcode group,\n+// in order to help ascertain that opcodes are not mistakenly added here and\n+// left untested.\n absl::flat_hash_set<HloOpcode> AllTestedOpcodes() {\n   absl::flat_hash_set<HloOpcode> ret;\n   ret.insert(kTestedOpsBitcastReshape.begin(), kTestedOpsBitcastReshape.end());\n@@ -3462,7 +3477,6 @@ absl::flat_hash_set<HloOpcode> AllTestedOpcodes() {\n   ret.emplace(HloOpcode::kCustomCall);\n   ret.emplace(HloOpcode::kDomain);\n   ret.emplace(HloOpcode::kDot);\n-  ret.emplace(HloOpcode::kDynamicSlice);  // TODO(b/417172838): add tests.\n   ret.emplace(HloOpcode::kFft);\n   ret.emplace(HloOpcode::kFusion);\n   ret.emplace(HloOpcode::kGetDimensionSize);\n@@ -3473,7 +3487,6 @@ absl::flat_hash_set<HloOpcode> AllTestedOpcodes() {\n   ret.emplace(HloOpcode::kReverse);\n   ret.emplace(HloOpcode::kRngBitGenerator);\n   ret.emplace(HloOpcode::kRngGetAndUpdateState);\n-  ret.emplace(HloOpcode::kScaledDot);\n   ret.emplace(HloOpcode::kSort);\n   ret.emplace(HloOpcode::kStochasticConvert);\n   ret.emplace(HloOpcode::kTopK);"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 17,
        "deletions": 2
    }
}