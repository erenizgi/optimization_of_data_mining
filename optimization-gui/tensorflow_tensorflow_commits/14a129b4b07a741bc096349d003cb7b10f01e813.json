{
    "author": "beckerhe",
    "message": "Fix indent handling in SequentialThunk::ToString\n\nThe thunk ID used to be inserted before the indentation whitespaces.\n\nThis change fixes that.\n\nPiperOrigin-RevId: 811328867",
    "sha": "14a129b4b07a741bc096349d003cb7b10f01e813",
    "files": [
        {
            "sha": "46d50b00aa4cd2b5683a68c5aed6809fb0196fdc",
            "filename": "third_party/xla/xla/backends/gpu/runtime/command_buffer_thunk_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_thunk_test.cc?ref=14a129b4b07a741bc096349d003cb7b10f01e813",
            "patch": "@@ -26,6 +26,7 @@ limitations under the License.\n #include <variant>\n #include <vector>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/ascii.h\"\n@@ -75,6 +76,7 @@ limitations under the License.\n #include \"tsl/profiler/lib/profiler_lock.h\"\n \n namespace xla::gpu {\n+using ::testing::HasSubstr;\n \n using MemoryAccess = BufferUse::MemoryAccess;\n using KernelArgsPacking = se::KernelLoaderSpec::KernelArgsPacking;\n@@ -1581,8 +1583,8 @@ TEST(CommandBufferThunkTest, ToStringPrintsNestedThunks) {\n   CommandBufferThunk thunk(\n       std::move(executor), Thunk::ThunkInfo(),\n       std::make_unique<SequentialThunk>(Thunk::ThunkInfo(), std::move(thunks)));\n-  EXPECT_TRUE(\n-      absl::StrContains(thunk.ToString(/*indent=*/1), \"    kMemset32BitValue\"));\n+  EXPECT_THAT(thunk.ToString(/*indent=*/1),\n+              HasSubstr(\"    000: kMemset32BitValue\"));\n }\n \n }  // namespace xla::gpu"
        },
        {
            "sha": "96437e5dad8fe3a5e42e359a8e1ba4c238c2fb18",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc?ref=14a129b4b07a741bc096349d003cb7b10f01e813",
            "patch": "@@ -267,25 +267,25 @@ TEST(ConditionalThunkTest, ToString) {\n                              /*kBranchIndexIsBool=*/true));\n   auto sequential_thunk =\n       std::make_unique<SequentialThunk>(thunk_info, std::move(thunk_sequence));\n-  EXPECT_EQ(sequential_thunk->ToString(0),\n+  EXPECT_EQ(sequential_thunk->ToString(/*indent=*/0),\n             \"000: kConditional\\t  \\n\"\n             \"  false_branch:\\n\"\n-            \"000:     kGemm\\t\\n\"\n+            \"    000: kGemm\\t\\n\"\n             \"  true_branch:\\n\"\n-            \"000:     kGemm\\t\\n\"\n-            \"000:     kGemm\\t\\n\\n\");\n+            \"    000: kGemm\\t\\n\"\n+            \"    000: kGemm\\t\\n\\n\");\n \n   std::unique_ptr<ConditionalThunk> thunk =\n       CreateConditionalThunk(thunk_info, slice, create_branch_thunk_sequences(),\n                              /*kBranchIndexIsBool=*/false);\n \n-  EXPECT_EQ(thunk->ToString(0),\n+  EXPECT_EQ(thunk->ToString(/*indent=*/0),\n             \"\\n\"\n             \"branch_0:\\n\"\n-            \"000:   kGemm\\t\\n\"\n+            \"  000: kGemm\\t\\n\"\n             \"branch_1:\\n\"\n-            \"000:   kGemm\\t\\n\"\n-            \"000:   kGemm\\t\\n\");\n+            \"  000: kGemm\\t\\n\"\n+            \"  000: kGemm\\t\\n\");\n }\n \n }  // namespace"
        },
        {
            "sha": "a69ada3e678c44b89e03e5fcb585c6a63d21b31e",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk.cc?ref=14a129b4b07a741bc096349d003cb7b10f01e813",
            "patch": "@@ -58,11 +58,12 @@ std::string SequentialThunk::ToString(int indent) const {\n       Thunk::KindToString(thunk_with_longest_kind->get()->kind()).length();\n   std::string result;\n   for (const std::unique_ptr<Thunk>& thunk : thunks_) {\n+    absl::StrAppend(&result, indent_str);\n     absl::StrAppendFormat(&result,\n                           \"%03d: \", thunk->thunk_info().thunk_id.value());\n     // Write out the thunk kind, padded out to max_thunk_kind_len.\n     absl::string_view kind_str = Thunk::KindToString(thunk->kind());\n-    absl::StrAppend(&result, indent_str, kind_str,\n+    absl::StrAppend(&result, kind_str,\n                     std::string(max_thunk_kind_len - kind_str.length(), ' '),\n                     \"\\t\");\n     absl::StrAppend(&result, thunk->ToString(indent + 1));"
        },
        {
            "sha": "9f9a426f97ce07174bcce4d20dd3494cb2e31041",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sequential_thunk_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/14a129b4b07a741bc096349d003cb7b10f01e813/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsequential_thunk_test.cc?ref=14a129b4b07a741bc096349d003cb7b10f01e813",
            "patch": "@@ -150,6 +150,10 @@ TEST(SequentialThunkTest, ToString) {\n             \"001: kGemm\\t\\n\"\n             \"002: kGemm\\t\\n\"\n             \"003: kGemm\\t\\n\");\n+  EXPECT_EQ(sequential_thunk.ToString(/*indent=*/1),\n+            \"  001: kGemm\\t\\n\"\n+            \"  002: kGemm\\t\\n\"\n+            \"  003: kGemm\\t\\n\");\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 18,
        "deletions": 11
    }
}