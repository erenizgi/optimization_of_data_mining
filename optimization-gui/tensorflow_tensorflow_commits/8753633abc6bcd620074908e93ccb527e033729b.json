{
    "author": "tensorflower-gardener",
    "message": "Automated Code Change\n\nPiperOrigin-RevId: 849587601",
    "sha": "8753633abc6bcd620074908e93ccb527e033729b",
    "files": [
        {
            "sha": "9ea5d9bcdc58d71ab02ec3c46ca8cc014845ef91",
            "filename": "tensorflow/core/tpu/kernels/tpu_functional_ops.h",
            "status": "modified",
            "additions": 55,
            "deletions": 11,
            "changes": 66,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8753633abc6bcd620074908e93ccb527e033729b/tensorflow%2Fcore%2Ftpu%2Fkernels%2Ftpu_functional_ops.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8753633abc6bcd620074908e93ccb527e033729b/tensorflow%2Fcore%2Ftpu%2Fkernels%2Ftpu_functional_ops.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftpu%2Fkernels%2Ftpu_functional_ops.h?ref=8753633abc6bcd620074908e93ccb527e033729b",
            "patch": "@@ -56,36 +56,72 @@ limitations under the License.\n \n namespace tensorflow {\n // Holds node's shape information for Concat/Split.\n-using EdgeShapes = absl::flat_hash_map<const Edge*, std::vector<int>>;\n-using GroupedEdges =\n-    absl::flat_hash_map<std::string, std::vector<const Edge*>>;\n+using EdgeShapes = absl::linked_hash_map<\n+    const Edge*, std::vector<int>,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<const Edge*>>::hasher,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<const Edge*>>::key_equal,\n+    std::allocator<std::pair<const Edge* const, std::vector<int>>>>;\n+using GroupedEdges = absl::linked_hash_map<\n+    std::string, std::vector<const Edge*>,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<std::string>>::hasher,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<std::string>>::key_equal,\n+    std::allocator<std::pair<const std::string, std::vector<const Edge*>>>>;\n \n // Contains attrs \"T\", \"sharding\", \"_tpu_replicate\" for each XlaSharding op that\n // we find as part of searching for inputs to models that are replicated.\n-using XlaShardingInfoMap = absl::flat_hash_map<\n-    std::string, std::tuple<tensorflow::DataType, std::string, std::string>>;\n+using XlaShardingInfoMap = absl::linked_hash_map<\n+    std::string, std::tuple<DataType, std::string, std::string>,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<std::string>>::hasher,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<std::string>>::key_equal,\n+    std::allocator<std::pair<const std::string,\n+                             std::tuple<DataType, std::string, std::string>>>>;\n \n // Contains attrs \"T\", and a pointer to tpu_replicated_metadata for ctrl dep\n // for each TpuReplicatedInput op that we find as part of searching for inputs\n // to models that are replicated.\n-using TpuReplicatedInputInfoMap =\n-    absl::flat_hash_map<std::string,\n-                           std::tuple<tensorflow::DataType, Node*>>;\n+using TpuReplicatedInputInfoMap = absl::linked_hash_map<\n+    std::string, std::tuple<DataType, Node*>,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<std::string>>::hasher,\n+    typename absl::container_internal::raw_hash_set<\n+        absl::container_internal::FlatHashSetPolicy<std::string>>::key_equal,\n+    std::allocator<std::pair<const std::string, std::tuple<DataType, Node*>>>>;\n \n namespace tpu_functional_internal {\n \n // Helper functions for graph rewrites.\n GroupedEdges GroupTensorsForInputPacking(\n     const EdgeShapes& tpu_input_shapes,\n-    const absl::flat_hash_map<const Edge*, DataType>& tpu_input_dtypes,\n+    const absl::linked_hash_map<\n+        const Edge*, DataType,\n+        typename absl::container_internal::raw_hash_set<\n+            absl::container_internal::FlatHashSetPolicy<const Edge*>>::hasher,\n+        typename absl::container_internal::raw_hash_set<\n+            absl::container_internal::FlatHashSetPolicy<const Edge*>>::\n+            key_equal,\n+        std::allocator<std::pair<const Edge* const, DataType>>>&\n+        tpu_input_dtypes,\n     bool input_shape_opt, bool group_tensors_for_packing);\n GroupedEdges GroupTensorsForOutputPacking(Graph* graph,\n                                           EdgeShapes& tpu_output_shapes,\n                                           GraphShapeInfo* shape_info);\n \n absl::Status CreateConcatAndSplitNodesForInputTensor(\n     Graph* graph, const std::string& cluster_name, EdgeShapes* tpu_input_shapes,\n-    const absl::flat_hash_map<std::string, std::vector<const Edge*>>&\n+    const absl::linked_hash_map<\n+        std::string, std::vector<const Edge*>,\n+        typename absl::container_internal::raw_hash_set<\n+            absl::container_internal::FlatHashSetPolicy<std::string>>::hasher,\n+        typename absl::container_internal::raw_hash_set<\n+            absl::container_internal::FlatHashSetPolicy<std::string>>::\n+            key_equal,\n+        std::allocator<std::pair<const std::string, std::vector<const Edge*>>>>&\n         grouped_input_edges,\n     int32_t minimum_input_tensors_packing, bool xla_spmd_input_sharded,\n     const XlaShardingInfoMap& xla_sharding_info,\n@@ -371,7 +407,15 @@ class TPUPartitionedCallOp : public AsyncOpKernel {\n   std::shared_ptr<tpu::TPUOrdinalSelector> ordinal_selector_;\n \n   // Maps input hash to TF fingerprint.\n-  absl::flat_hash_map<uint64_t, uint64_t> inputs_to_fingerprint_;\n+  absl::linked_hash_map<\n+      uint64_t, uint64_t,\n+      typename absl::container_internal::raw_hash_set<\n+          absl::container_internal::FlatHashSetPolicy<unsigned long>>::hasher,\n+      typename absl::container_internal::raw_hash_set<\n+          absl::container_internal::FlatHashSetPolicy<unsigned long>>::\n+          key_equal,\n+      std::allocator<std::pair<const uint64_t, uint64_t>>>\n+      inputs_to_fingerprint_;\n \n   // List of TPU devices\n   std::vector<Device*> tpu_devices_;"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 55,
        "deletions": 11
    }
}