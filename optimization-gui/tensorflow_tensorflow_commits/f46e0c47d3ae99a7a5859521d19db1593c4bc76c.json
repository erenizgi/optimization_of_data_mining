{
    "author": "qukhan",
    "message": "Check a weight cache file size before trying to load it.\n\nThis avoid an error message when trying to load a file that is empty because it\nneeds to be built.\n\nThis also adds a `Size()` member to `tflite::xnnpack::FileDescriptorView`\n\nPiperOrigin-RevId: 845209923",
    "sha": "f46e0c47d3ae99a7a5859521d19db1593c4bc76c",
    "files": [
        {
            "sha": "8a24eb9568b884c32e93e941b37b137846e5f565",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f46e0c47d3ae99a7a5859521d19db1593c4bc76c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f46e0c47d3ae99a7a5859521d19db1593c4bc76c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc?ref=f46e0c47d3ae99a7a5859521d19db1593c4bc76c",
            "patch": "@@ -57,7 +57,7 @@ FileDescriptor FileDescriptor::Duplicate() const {\n   if (!IsValid()) {\n     return FileDescriptor(-1);\n   }\n-  return FileDescriptor(dup(fd_));\n+  return FileDescriptor::Duplicate(fd_);\n }\n \n void FileDescriptor::Reset(int new_fd) {"
        },
        {
            "sha": "113a378007506bc44d6893c63ffc501d6e6c0715",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f46e0c47d3ae99a7a5859521d19db1593c4bc76c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f46e0c47d3ae99a7a5859521d19db1593c4bc76c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h?ref=f46e0c47d3ae99a7a5859521d19db1593c4bc76c",
            "patch": "@@ -76,6 +76,14 @@ class FileDescriptorView {\n   // WARNING: the file descriptor must be valid and the file must be opened.\n   Offset MovePos(Offset offset) const;\n \n+  // Returns the size of the file.\n+  Offset Size() const {\n+    Offset pos = GetPos();\n+    Offset size = SetPosFromEnd(0);\n+    SetPos(pos);\n+    return size;\n+  }\n+\n   // Reads `count` bytes from the file at the current position to `dst`.\n   //\n   // Returns true if all the data available in the file was read to the buffer"
        },
        {
            "sha": "cbd3ac2ca29e2ec5e97e51c84dc071c6611e6a64",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f46e0c47d3ae99a7a5859521d19db1593c4bc76c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f46e0c47d3ae99a7a5859521d19db1593c4bc76c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=f46e0c47d3ae99a7a5859521d19db1593c4bc76c",
            "patch": "@@ -325,7 +325,8 @@ bool MMapWeightCacheProvider::LoadOrStartBuild(const char* path,\n   }\n   const char* const safe_path = Sanitize(path);\n   FileDescriptor build_fd = fd.Duplicate();\n-  if (!IsInMemoryCachePath(safe_path) && Load(safe_path, std::move(fd))) {\n+  if (!IsInMemoryCachePath(safe_path) && fd.Size() &&\n+      Load(safe_path, std::move(fd))) {\n     TFLITE_LOG_PROD(tflite::TFLITE_LOG_VERBOSE,\n                     \"XNNPack weight cache loaded from '%s'.\", safe_path);\n     return true;"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 11,
        "deletions": 2
    }
}