{
    "author": "junwhanahn",
    "message": "Fix a bug where PjRt CPU/GPU uses a wrong memory space for `CreateErrorBuffer`\n\nPiperOrigin-RevId: 800281986",
    "sha": "8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79",
    "files": [
        {
            "sha": "3d79837b0b954b086eb36073582a1b799f734da3",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79",
            "patch": "@@ -854,7 +854,7 @@ absl::StatusOr<std::unique_ptr<PjRtBuffer>> PjRtCpuClient::CreateErrorBuffer(\n           absl::InlinedVector<tsl::AsyncValueRef<CpuEvent>, 4>{\n               tsl::AsyncValueRef<CpuEvent>(\n                   tsl::MakeErrorAsyncValueRef(std::move(error)))}),\n-      *device->default_memory_space());\n+      memory_space);\n }\n \n absl::StatusOr<std::unique_ptr<PjRtClient::AsyncHostToDeviceTransferManager>>"
        },
        {
            "sha": "30f95fb9b0e72d4a47daa002bab16552ba2a3cf3",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc?ref=8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79",
            "patch": "@@ -536,12 +536,15 @@ TEST(PjRtCpuClientTest, AsyncTransferSetBufferError) {\n TEST(PjRtCpuClientTest, CreateErrorBuffer) {\n   TF_ASSERT_OK_AND_ASSIGN(auto client, GetPjRtCpuClient(CpuClientOptions()));\n   xla::Shape shape = ShapeUtil::MakeShape(U32, {3, 2});\n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto buffer, client->CreateErrorBuffer(Internal(\"foobar\"), shape,\n-                                             client->memory_spaces()[0]));\n-  EXPECT_THAT(\n-      buffer->ToLiteralSync(),\n-      absl_testing::StatusIs(tsl::error::INTERNAL, HasSubstr(\"foobar\")));\n+  for (PjRtMemorySpace* memory_space : client->memory_spaces()) {\n+    TF_ASSERT_OK_AND_ASSIGN(\n+        auto buffer,\n+        client->CreateErrorBuffer(Internal(\"foobar\"), shape, memory_space));\n+    EXPECT_THAT(\n+        buffer->ToLiteralSync(),\n+        absl_testing::StatusIs(tsl::error::INTERNAL, HasSubstr(\"foobar\")));\n+    EXPECT_EQ(buffer->memory_space(), memory_space);\n+  }\n }\n \n TEST(PjRtCpuClientTest, AsyncTransferRawDataToSubBuffer) {"
        },
        {
            "sha": "0d722443000de26cab80a825af1b2bd230295983",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_pjrt_client_test.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc?ref=8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79",
            "patch": "@@ -264,9 +264,26 @@ ENTRY main.5 {\n }\n #endif  // defined(GOOGLE_CUDA) || defined(TENSORFLOW_USE_ROCM)\n \n+TEST(StreamExecutorGpuClientTest, CreateErrorBuffer) {\n+  TF_ASSERT_OK_AND_ASSIGN(auto client,\n+                          GetStreamExecutorGpuClient(DefaultOptions()));\n+\n+  xla::Shape shape = ShapeUtil::MakeShape(U32, {3, 2});\n+  for (PjRtMemorySpace* memory_space : client->memory_spaces()) {\n+    TF_ASSERT_OK_AND_ASSIGN(\n+        auto buffer,\n+        client->CreateErrorBuffer(Internal(\"foobar\"), shape, memory_space));\n+    EXPECT_THAT(\n+        buffer->ToLiteralSync(),\n+        absl_testing::StatusIs(tsl::error::INTERNAL, HasSubstr(\"foobar\")));\n+    EXPECT_EQ(buffer->memory_space(), memory_space);\n+  }\n+}\n+\n TEST(StreamExecutorGpuClientTest, PropagateError) {\n   TF_ASSERT_OK_AND_ASSIGN(auto client,\n                           GetStreamExecutorGpuClient(DefaultOptions()));\n+\n   auto shape = xla::ShapeUtil::MakeScalarShape(xla::F32);\n   absl::Status input_error = absl::InvalidArgumentError(\"input error\");\n   TF_ASSERT_OK_AND_ASSIGN("
        },
        {
            "sha": "992998f60fdcc28b93901dd42c5b464cb1abf604",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc?ref=8d2fc0ad9062667e34d65ac7a19a1c06bb60ec79",
            "patch": "@@ -1359,10 +1359,8 @@ PjRtStreamExecutorClient::CreateErrorBuffer(absl::Status error,\n       device, tsl::RCReference<RawSEDeviceMemory>(),\n       absl::MakeSpan(&definition_event, 1));\n \n-  auto py_buffer = std::make_unique<PjRtStreamExecutorBuffer>(\n-      shape, std::move(dummy_device_buffer), this, device,\n-      device->default_memory_space().value_or(nullptr));\n-  return py_buffer;\n+  return std::make_unique<PjRtStreamExecutorBuffer>(\n+      shape, std::move(dummy_device_buffer), this, device, memory);\n }\n \n absl::StatusOr<std::unique_ptr<PjRtBuffer>>"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 29,
        "deletions": 11
    }
}