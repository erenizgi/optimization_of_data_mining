{
    "author": "akuegel",
    "message": "[XLA:GPU] Add support for S32 keys for SortPairs.\n\nReverts d9f02c1e55d338684275a1bced3a45cce1db75f2\n\nPiperOrigin-RevId: 839740290",
    "sha": "3f293f334c85bbd281133e58feea5418742d28b8",
    "files": [
        {
            "sha": "849b8d21dc94aa11d6ffb4acbfd9f2238c9b4e29",
            "filename": "third_party/xla/xla/service/gpu/build_defs.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fbuild_defs.bzl?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -27,6 +27,7 @@ def get_cub_sort_kernel_types(name = \"\"):\n         \"u16_b32\",\n         \"u16_b64\",\n         \"u32_b16\",\n+        \"s32_b32\",\n         \"u32_b32\",\n         \"u32_b64\",\n         \"u64_b16\","
        },
        {
            "sha": "4c24ef9b24eb4ac2a85b7698415ab3c498b6eb11",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -709,10 +709,17 @@ absl::Status RunOptimizationPasses(\n \n   // DynamicPadder creates a stable KeyValue sort for dynamic reshapes.\n   pipeline.AddPass<DynamicPadder>(dynamic_padder_options);\n-\n-  // TODO(b/407909195): Add SortRewriter here once it supports S32 keys for\n-  // KeyValueSort. It needs to run before StableSortExpander, otherwise we will\n-  // not match the comparison computation.\n+  // SortRewriter needs to run before StableSortExpander.\n+  if (debug_options.xla_gpu_enable_cub_radix_sort()) {\n+    if (stream_exec != nullptr) {\n+      pipeline.AddPass<SortRewriter>(gpu_target_config.device_description,\n+                                     gpu_target_config.platform_name);\n+    } else {\n+      LOG(WARNING) << \"Using fallback sort algorithm rather than SortRewriter, \"\n+                      \"which will be slower at runtime. To avoid this, \"\n+                      \"compile with a GPU present.\";\n+    }\n+  }\n \n   // Expand the sort op to support stable sorting if required.\n   pipeline.AddPass<StableSortExpander>();"
        },
        {
            "sha": "b682d27e9dee077d6cc7c7cebca065cfc64f390e",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -1710,8 +1710,9 @@ TEST_F(PassOrderTest,\n        SortRewriterRunsBeforeStableSortExpanderAndComparisonExpander) {\n   VerifyPassOrder(/*first_pass_regex=*/\"sort-rewriter\",\n                   /*last_pass_regex=*/\"stable-sort-expander\");\n-  VerifyPassOrder(/*first_pass_regex=*/\"sort-rewriter\",\n-                  /*last_pass_regex=*/\"comparison-expander\");\n+  VerifyPassRunsAtLeastOnceBefore(\n+      /*first_pass_regex=*/\"sort-rewriter\",\n+      /*other_pass_regex=*/\"comparison-expander\");\n }\n \n TEST_F(PassOrderTest,\n@@ -2054,7 +2055,8 @@ ENTRY %main {\n   absl::ScopedMockLog mock_log(absl::MockLogDefault::kIgnoreUnexpected);\n   EXPECT_CALL(mock_log,\n               Log(absl::LogSeverity::kWarning, EndsWith(\"/gpu_compiler.cc\"),\n-                  StartsWith(\"Using fallback sort algorithm\")));\n+                  StartsWith(\"Using fallback sort algorithm\")))\n+      .Times(2);\n \n   // StartCapturingLogs has to be called even if we expect not to capture any\n   // logs."
        },
        {
            "sha": "b2b7382e5d8fa884691c0b2e3bcb70b717083887",
            "filename": "third_party/xla/xla/service/gpu/transforms/sort_rewriter_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -190,6 +190,33 @@ ENTRY %main {\n                                   m::GetTupleElement(m::CustomCall(), 1))));\n }\n \n+// Sort a pair of S32 tensors, keys go first.\n+TEST_F(SortRewriterTest, SortS32Pairs) {\n+  constexpr char kHlo[] = R\"(\n+HloModule TestModule\n+\n+%compare {\n+  %lhs_key = s32[] parameter(0)\n+  %rhs_key = s32[] parameter(1)\n+  %lhs_value = s32[] parameter(2)\n+  %rhs_value = s32[] parameter(3)\n+  ROOT %lt = pred[] compare(%lhs_key, %rhs_key), direction=LT\n+}\n+\n+ENTRY %main {\n+  %input_keys = s32[1000] parameter(0)\n+  %input_values = s32[1000] parameter(1)\n+  ROOT %sort = (s32[1000], s32[1000]) sort(%input_keys, %input_values),\n+      dimensions={0}, is_stable=true, to_apply=%compare\n+})\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module, ParseAndReturnVerifiedModule(kHlo));\n+  EXPECT_TRUE(RunModuleAndPass(module.get()));\n+  EXPECT_THAT(module->entry_computation()->root_instruction(),\n+              GmockMatch(m::Tuple(m::GetTupleElement(m::CustomCall(), 0),\n+                                  m::GetTupleElement(m::CustomCall(), 1))));\n+}\n+\n // Sort a pair of tensors, keys go last.\n TEST_F(SortRewriterTest, SortPairsSwapped) {\n   constexpr char kHlo[] = R\"("
        },
        {
            "sha": "7092abe764e51efc04b2191571d10b7035e42096",
            "filename": "third_party/xla/xla/stream_executor/cuda/cub_sort_kernel_cuda.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda.cc?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -186,6 +186,9 @@ XLA_CUB_DEFINE_SORT_PAIRS(u16_b64, uint16_t, uint64_t)\n #endif\n \n // Pairs with 32-bit key.\n+#ifdef CUB_TYPE_S32_B32\n+XLA_CUB_DEFINE_SORT_PAIRS(s32_b32, int32_t, uint32_t)\n+#endif\n #ifdef CUB_TYPE_U32_B16\n XLA_CUB_DEFINE_SORT_PAIRS(u32_b16, uint32_t, uint16_t)\n #endif"
        },
        {
            "sha": "d4bb577f13cb009c60d3180518ad4e742cee92e3",
            "filename": "third_party/xla/xla/stream_executor/cuda/cub_sort_kernel_cuda_impl.cu.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda_impl.cu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda_impl.cu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda_impl.cu.cc?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -198,6 +198,9 @@ XLA_CUB_DEFINE_SORT_PAIRS(uint16_t, uint64_t)\n #endif\n \n // Pairs with 32-bit key.\n+#ifdef CUB_TYPE_S32_B32\n+XLA_CUB_DEFINE_SORT_PAIRS(int32_t, uint32_t)\n+#endif\n #ifdef CUB_TYPE_U32_B16\n XLA_CUB_DEFINE_SORT_PAIRS(uint32_t, uint16_t)\n #endif"
        },
        {
            "sha": "7b7d43ab3e460dc6e857e4dbe89c6d1871179116",
            "filename": "third_party/xla/xla/stream_executor/rocm/cub_sort_kernel_rocm.cu.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3f293f334c85bbd281133e58feea5418742d28b8/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc?ref=3f293f334c85bbd281133e58feea5418742d28b8",
            "patch": "@@ -348,6 +348,9 @@ XLA_CUB_DEFINE_SORT_PAIRS(u16_b64, uint16_t, uint64_t)\n #endif\n \n // Pairs with 32-bit key.\n+#ifdef CUB_TYPE_S32_B32\n+XLA_CUB_DEFINE_SORT_PAIRS(s32_b32, int32_t, uint32_t)\n+#endif\n #ifdef CUB_TYPE_U32_B16\n XLA_CUB_DEFINE_SORT_PAIRS(u32_b16, uint32_t, uint16_t)\n #endif"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 53,
        "deletions": 7
    }
}