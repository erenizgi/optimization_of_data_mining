{
    "author": "KanishAnand",
    "message": "Add constructor to `NamedSharding` accepting axis names.\n\nThis provides a more intuitive way to create `NamedSharding` objects, especially in tests, as it's easier to work with human-readable axis names than with `AxisRef` indices.\n\nPiperOrigin-RevId: 842148670",
    "sha": "aa202263bdaa236f07f01c6a95aafb72a0c65251",
    "files": [
        {
            "sha": "07b2e615d624797d476a2a831073589bb8ef65d5",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=aa202263bdaa236f07f01c6a95aafb72a0c65251",
            "patch": "@@ -203,12 +203,14 @@ cc_library(\n \n cc_library(\n     name = \"named_sharding\",\n+    srcs = [\"named_sharding.cc\"],\n     hdrs = [\"named_sharding.h\"],\n     deps = [\n         \":mesh_and_axis\",\n         \":tile_assignment\",\n         \"//xla:xla_data_proto_cc\",\n         \"@com_google_absl//absl/algorithm:container\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/types:span\",\n     ],\n )"
        },
        {
            "sha": "0db5d8e916aa53c0ac1bc440bcf9e60939847eef",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding.cc",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.cc?ref=aa202263bdaa236f07f01c6a95aafb72a0c65251",
            "patch": "@@ -0,0 +1,81 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/hlo/ir/named_sharding.h\"\n+\n+#include <cstdint>\n+#include <map>\n+#include <string>\n+#include <utility>\n+#include <vector>\n+\n+#include \"absl/log/check.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/hlo/ir/mesh_and_axis.h\"\n+\n+namespace xla {\n+\n+namespace test_utils {\n+// Construct sharding with given mesh. 'dim_shardings', 'replicated_axes',\n+// 'unreduced_axes' refer to axis names in the mesh.\n+// This is a test only helper function.\n+NamedSharding FromAxisNames(\n+    Mesh mesh, absl::Span<const std::vector<std::string>> dim_shardings,\n+    absl::Span<const std::string> replicated_axes,\n+    absl::Span<const std::string> unreduced_axes,\n+    absl::Span<const OpMetadata> metadata) {\n+  std::map<std::string, int64_t> mesh_axis_to_index;\n+  for (int64_t i = 0; i < mesh.axis_names().size(); ++i) {\n+    mesh_axis_to_index[mesh.axis_names()[i]] = i;\n+  }\n+\n+  std::vector<NamedSharding::DimensionSharding> dim_shardings_;\n+  dim_shardings_.reserve(dim_shardings.size());\n+  for (const auto& axes_for_dim : dim_shardings) {\n+    std::vector<AxisRef> axis_refs;\n+    axis_refs.reserve(axes_for_dim.size());\n+    for (const std::string& axis_name : axes_for_dim) {\n+      auto it = mesh_axis_to_index.find(axis_name);\n+      CHECK(it != mesh_axis_to_index.end())\n+          << \"Axis \" << axis_name << \" not found in mesh \" << mesh.ToString();\n+      axis_refs.push_back(AxisRef(it->second));\n+    }\n+    dim_shardings_.push_back(NamedSharding::DimensionSharding(\n+        std::move(axis_refs), /*is_closed=*/true));\n+  }\n+\n+  std::vector<AxisRef> replicated_axes_;\n+  replicated_axes_.reserve(replicated_axes.size());\n+  for (const std::string& axis_name : replicated_axes) {\n+    auto it = mesh_axis_to_index.find(axis_name);\n+    CHECK(it != mesh_axis_to_index.end())\n+        << \"Axis \" << axis_name << \" not found in mesh \" << mesh.ToString();\n+    replicated_axes_.push_back(AxisRef(it->second));\n+  }\n+\n+  std::vector<AxisRef> unreduced_axes_;\n+  unreduced_axes_.reserve(unreduced_axes.size());\n+  for (const std::string& axis_name : unreduced_axes) {\n+    auto it = mesh_axis_to_index.find(axis_name);\n+    CHECK(it != mesh_axis_to_index.end())\n+        << \"Axis \" << axis_name << \" not found in mesh \" << mesh.ToString();\n+    unreduced_axes_.push_back(AxisRef(it->second));\n+  }\n+\n+  return NamedSharding(mesh, dim_shardings_, replicated_axes_, unreduced_axes_,\n+                       metadata);\n+}\n+}  // namespace test_utils\n+}  // namespace xla"
        },
        {
            "sha": "bfdc9966c0b15d2e97d90a13ee9f92d677ff04c4",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding.h",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h?ref=aa202263bdaa236f07f01c6a95aafb72a0c65251",
            "patch": "@@ -17,6 +17,7 @@ limitations under the License.\n #define XLA_HLO_IR_NAMED_SHARDING_H_\n \n #include <cstdint>\n+#include <string>\n #include <utility>\n #include <vector>\n \n@@ -38,8 +39,11 @@ class NamedSharding {\n       return axes_ == other.axes_ && is_closed_ == other.is_closed_;\n     }\n \n-    explicit DimensionSharding(std::vector<AxisRef> axes, bool is_closed)\n-        : axes_(std::move(axes)), is_closed_(is_closed) {}\n+    // Note that by default we assume closed sharding.\n+    explicit DimensionSharding() : is_closed_(true) {};\n+\n+    explicit DimensionSharding(absl::Span<const AxisRef> axes, bool is_closed)\n+        : axes_(axes.begin(), axes.end()), is_closed_(is_closed) {}\n \n     absl::Span<const AxisRef> axes() const { return axes_; }\n \n@@ -118,6 +122,17 @@ class NamedSharding {\n   std::vector<OpMetadata> metadata_;\n };\n \n+// Contains test only helper functions.\n+namespace test_utils {\n+// Construct sharding with given mesh. 'dim_shardings', 'replicated_axes',\n+// 'unreduced_axes' refer to axis names in the mesh.\n+NamedSharding FromAxisNames(\n+    Mesh mesh, absl::Span<const std::vector<std::string>> dim_shardings,\n+    absl::Span<const std::string> replicated_axes = {},\n+    absl::Span<const std::string> unreduced_axes = {},\n+    absl::Span<const OpMetadata> metadata = {});\n+}  // namespace test_utils\n+\n }  // namespace xla\n \n #endif  // XLA_HLO_IR_NAMED_SHARDING_H_"
        },
        {
            "sha": "78e3b3e3b08095d95e9b7e65002a02d4d1ecd84c",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aa202263bdaa236f07f01c6a95aafb72a0c65251/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc?ref=aa202263bdaa236f07f01c6a95aafb72a0c65251",
            "patch": "@@ -24,6 +24,32 @@ namespace {\n \n using DimensionSharding = NamedSharding::DimensionSharding;\n \n+TEST(NamedShardingTest, AxisNameCtor) {\n+  Mesh mesh_abcd({2, 4, 3, 8}, {\"a\", \"b\", \"c\", \"d\"});\n+  AxisRef axis_a(0);\n+  AxisRef axis_b(1);\n+  AxisRef axis_c(2);\n+  AxisRef axis_d(3);\n+\n+  NamedSharding sharding =\n+      test_utils::FromAxisNames(mesh_abcd, /*dim_shardings=*/{{\"c\"}, {\"b\"}},\n+                                /*replicated_axes=*/{\"a\"},\n+                                /*unreduced_axes=*/{\"d\"});\n+  DimensionSharding ds_c({axis_c}, /*is_closed=*/true);\n+  DimensionSharding ds_b({axis_b}, /*is_closed=*/true);\n+  EXPECT_EQ(sharding,\n+            NamedSharding(mesh_abcd, {ds_c, ds_b}, {axis_a}, {axis_d}));\n+\n+  NamedSharding sharding2 = test_utils::FromAxisNames(\n+      mesh_abcd,\n+      /*dim_shardings=*/{{\"c\", \"a\"}, {}, {\"b\"}},\n+      /*replicated_axes=*/{\"d\"}, /*unreduced_axes=*/{});\n+  DimensionSharding ds_ca({axis_c, axis_a}, /*is_closed=*/true);\n+  EXPECT_EQ(sharding2,\n+            NamedSharding(mesh_abcd, {ds_ca, DimensionSharding(), ds_b},\n+                          {axis_d}, {}));\n+}\n+\n TEST(NamedShardingTest, Equality) {\n   Mesh mesh_abcd({2, 4, 3, 8}, {\"a\", \"b\", \"c\", \"d\"});\n "
        }
    ],
    "stats": {
        "total": 128,
        "additions": 126,
        "deletions": 2
    }
}