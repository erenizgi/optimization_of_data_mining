{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Value Tracking] Support HLO original value in CopyFusion pass\n\nThis updates the HLO orignal value of a fusion accordingly if its shape is updated in the pass.\n\nPiperOrigin-RevId: 846927675",
    "sha": "8f784b11c3dc5106065bc9b9089eb80f004ea747",
    "files": [
        {
            "sha": "ce9bf49de7ae16a3d6374d2be0ccbcfcbb7a977b",
            "filename": "third_party/xla/xla/service/gpu/transforms/copy_fusion.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f784b11c3dc5106065bc9b9089eb80f004ea747/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcopy_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f784b11c3dc5106065bc9b9089eb80f004ea747/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcopy_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcopy_fusion.cc?ref=8f784b11c3dc5106065bc9b9089eb80f004ea747",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n #include \"xla/codegen/ir_emission_utils.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/hlo/ir/hlo_original_value.h\"\n #include \"xla/hlo/utils/hlo_traversal.h\"\n #include \"xla/service/call_graph.h\"\n #include \"xla/service/gpu/gpu_fusible.h\"\n@@ -176,6 +177,14 @@ absl::StatusOr<bool> CopyFusion::DoCopyFusion(\n         HloInstruction::CreateTuple(tuple_elements));\n     fused_computation->set_root_instruction(new_root,\n                                             /*accept_different_shape=*/true);\n+    // Creates a new original value for the fusion instruction and the new root\n+    // of the fused computation.\n+    if (hlo->original_value() != nullptr) {\n+      std::shared_ptr<xla::OriginalValue> new_original_value =\n+          xla::OriginalValue::CreateFromInstruction(new_root);\n+      new_root->set_original_value(new_original_value);\n+      hlo->set_original_value(new_original_value);\n+    }\n     *hlo->mutable_shape() = new_root->shape();\n     for (HloInstruction* caller :\n          call_graph->GetComputationCallers(fused_computation)) {"
        },
        {
            "sha": "fc38dc4920b9bf377f4eec49ad44c35aa808faf3",
            "filename": "third_party/xla/xla/service/gpu/transforms/copy_fusion_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f784b11c3dc5106065bc9b9089eb80f004ea747/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcopy_fusion_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f784b11c3dc5106065bc9b9089eb80f004ea747/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcopy_fusion_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcopy_fusion_test.cc?ref=8f784b11c3dc5106065bc9b9089eb80f004ea747",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #include \"xla/service/gpu/transforms/copy_fusion.h\"\n \n #include <cstdint>\n+#include <memory>\n #include <vector>\n \n #include <gmock/gmock.h>\n@@ -649,5 +650,31 @@ TEST_F(CopyFusionTest, CopyFusionWithMoreThanMaxCopies) {\n   EXPECT_FALSE(CreateFusionWithNumCopies(max_copies));\n }\n \n+TEST_F(CopyFusionTest, PropagateOriginalValue) {\n+  ASSERT_OK_AND_ASSIGN(\n+      auto module, ParseAndReturnVerifiedModule(absl::StrCat(kModulePrefix, R\"(\n+    fused_computation {\n+      two = f32[] constant(2.0)\n+      broadcast = f32[16,32]{1,0} broadcast(two), dimensions={}\n+      s.1 = f32[16,32]{1,0} sqrt(broadcast)\n+      ROOT c.1 = f32[32,16]{1,0} transpose(s.1), dimensions={1,0}, origin={{\"transpose\"}}\n+    }\n+\n+    ENTRY main {\n+      fusion = f32[32,16]{1,0} fusion(), kind=kInput, calls=fused_computation, origin={{\"transpose\"}}\n+      copy.1 = f32[32,16]{1,0} copy(fusion)\n+      copy.2 = f32[32,16]{1,0} copy(fusion)\n+      ROOT t = (f32[32,16]{1,0}, f32[32,16]{1,0}) tuple(copy.2, copy.1)\n+    })\")));\n+\n+  ASSERT_OK_AND_ASSIGN(auto changed, cf_.Run(module.get()));\n+  ASSERT_TRUE(changed);\n+  const HloInstruction* fusion =\n+      *module->entry_computation()->instructions().begin();\n+\n+  EXPECT_TRUE(fusion != nullptr);\n+  EXPECT_EQ(fusion->original_value()->ToString(), R\"(({\"transpose\"}, {}, {}))\");\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 36,
        "deletions": 0
    }
}