{
    "author": "tensorflower-gardener",
    "message": "Create OSS equivalent of ParseTextProtoOrDie\n\nPiperOrigin-RevId: 815712863",
    "sha": "2eb2840e7a58173a33d7f32348ce71dced1c7d50",
    "files": [
        {
            "sha": "14b4fd395c33c7402ef5d4449e5f1a33dcdd4c95",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -551,10 +551,9 @@ xla_cc_test(\n         \":thunk_proto_cc\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n-        \"@com_google_absl//absl/log:check\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n \n@@ -714,10 +713,10 @@ xla_cc_test(\n         \"//xla/service:buffer_assignment\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n \n@@ -901,6 +900,7 @@ xla_test(\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n@@ -1053,10 +1053,9 @@ xla_cc_test(\n         \":thunk_proto_cc\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n-        \"@com_google_absl//absl/log:check\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n \n@@ -1835,6 +1834,7 @@ xla_test(\n         \"//xla/tsl/platform:status_matchers\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n@@ -2284,12 +2284,11 @@ xla_cc_test(\n         \"//xla/service:buffer_assignment\",\n         \"//xla/tsl/platform:status_matchers\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n-        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n "
        },
        {
            "sha": "0be4c722ce265efb9252ded1703800c5898b1803",
            "filename": "third_party/xla/xla/backends/gpu/runtime/copy_thunk_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 18,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcopy_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcopy_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcopy_thunk_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -20,18 +20,18 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n-#include \"absl/log/check.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n-#include \"tsl/platform/protobuf.h\"\n \n namespace xla::gpu {\n namespace {\n \n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n \n TEST(CopyThunkTest, ToProto) {\n   Thunk::ThunkInfo thunk_info;\n@@ -60,8 +60,7 @@ TEST(CopyThunkTest, ToProto) {\n }\n \n TEST(CopyThunkTest, FromProto) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -72,8 +71,7 @@ TEST(CopyThunkTest, FromProto) {\n           destination_buffer { offset: 0 size: 256 buffer_allocation_index: 1 }\n           mem_size: 256\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   Thunk::ThunkInfo thunk_info;\n   thunk_info.profile_annotation = \"profile_annotation\";\n@@ -128,8 +126,7 @@ TEST(DeviceToHostCopyThunkProtoTest, ToProto) {\n }\n \n TEST(DeviceToHostCopyThunkProtoTest, FromProto) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -146,8 +143,7 @@ TEST(DeviceToHostCopyThunkProtoTest, FromProto) {\n             mem_size: 256\n           }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   Thunk::ThunkInfo thunk_info;\n   thunk_info.profile_annotation = \"profile_annotation\";\n@@ -205,8 +201,7 @@ TEST(HostToDeviceCopyThunkProtoTest, ToProto) {\n }\n \n TEST(HostToDeviceCopyThunkProtoTest, FromProto) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -223,8 +218,7 @@ TEST(HostToDeviceCopyThunkProtoTest, FromProto) {\n             mem_size: 256\n           }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   Thunk::ThunkInfo thunk_info;\n   thunk_info.profile_annotation = \"profile_annotation\";\n@@ -280,8 +274,7 @@ TEST(DeviceToDeviceCopyThunkProtoTest, ToProto) {\n }\n \n TEST(DeviceToDeviceCopyThunkProtoTest, FromProto) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -298,8 +291,7 @@ TEST(DeviceToDeviceCopyThunkProtoTest, FromProto) {\n             mem_size: 256\n           }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   Thunk::ThunkInfo thunk_info;\n   thunk_info.profile_annotation = \"profile_annotation\";"
        },
        {
            "sha": "d59734a9483ffd0cb75f1cc8570503908a9b6319",
            "filename": "third_party/xla/xla/backends/gpu/runtime/gemm_thunk_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fgemm_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fgemm_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fgemm_thunk_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -27,10 +27,11 @@ limitations under the License.\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n-#include \"tsl/platform/protobuf.h\"\n \n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n \n namespace xla::gpu {\n namespace {\n@@ -93,11 +94,7 @@ TEST(GemmThunkTest, ProtoRoundTrip) {\n     }\n   )pb\";\n \n-  ThunkProto original_thunk_proto;\n-  ASSERT_TRUE(tsl::protobuf::TextFormat::ParseFromString(\n-      std::string(kProtoText),  // NOLINT -- openxla protobuf version requires\n-                                // it to be a string\n-      &original_thunk_proto));\n+  ThunkProto original_thunk_proto = ParseTextProtoOrDie<ThunkProto>(kProtoText);\n \n   std::vector<BufferAllocation> buffer_allocations;\n   buffer_allocations.emplace_back(/*index=*/0, /*size=*/100, /*color=*/10);"
        },
        {
            "sha": "589af3d27b165a9ec87aec8b29d5bfc30b5396c8",
            "filename": "third_party/xla/xla/backends/gpu/runtime/kernel_thunk_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fkernel_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fkernel_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fkernel_thunk_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -56,13 +56,15 @@ limitations under the License.\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla::gpu {\n namespace {\n \n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n using Kind = Thunk::Kind;\n \n TEST(KernelThunkTest, CreateWithDefaultValues) {\n@@ -421,9 +423,8 @@ class KernelThunkTmaPTXTest : public ::testing::TestWithParam<bool> {\n       }\n     )pb\";\n \n-    ThunkProto tma_kernel_thunk_proto;\n-    tsl::protobuf::TextFormat::ParseFromString(tma_kernel_thunk,\n-                                               &tma_kernel_thunk_proto);\n+    ThunkProto tma_kernel_thunk_proto =\n+        ParseTextProtoOrDie<ThunkProto>(tma_kernel_thunk);\n \n     const size_t total_byte_size =\n         tma_kernel_thunk_proto.kernel_thunk().args(0).size() +"
        },
        {
            "sha": "a5394937a4d24062acf575cb8630783127a5861d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -20,22 +20,21 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n-#include \"absl/log/check.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/backends/gpu/runtime/thunk.pb.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n-#include \"tsl/platform/protobuf.h\"\n \n namespace xla::gpu {\n namespace {\n \n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n \n TEST(MemzeroThunkTest, ProtoRoundTrip) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"partition_id_profile_annotation\"\n@@ -44,8 +43,7 @@ TEST(MemzeroThunkTest, ProtoRoundTrip) {\n         memzero_thunk {\n           dest_buffer { offset: 0 size: 4 buffer_allocation_index: 0 }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/4, /*color=*/0)};\n "
        },
        {
            "sha": "e929e64e1466a4d054295aa42ca6ea2f34a45f17",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_proto_deserialization_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 42,
            "changes": 64,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -21,7 +21,6 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n-#include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/backends/gpu/runtime/conditional_thunk.h\"\n@@ -33,8 +32,8 @@ limitations under the License.\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/tsl/platform/status_matchers.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n-#include \"tsl/platform/protobuf.h\"\n \n namespace xla::gpu {\n namespace {\n@@ -44,6 +43,7 @@ using ::testing::Pointer;\n using ::testing::Property;\n using ::testing::WhenDynamicCastTo;\n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n using Kind = Thunk::Kind;\n \n TEST(ThunkProtoDeserializationTest, SequentialThunkChain) {\n@@ -74,8 +74,7 @@ TEST(ThunkProtoDeserializationTest, SequentialThunkChain) {\n }\n \n TEST(ThunkProtoDeserializationTest, CopyThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -86,8 +85,7 @@ TEST(ThunkProtoDeserializationTest, CopyThunk) {\n           destination_buffer { offset: 0 size: 256 buffer_allocation_index: 1 }\n           mem_size: 256\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n@@ -102,8 +100,7 @@ TEST(ThunkProtoDeserializationTest, CopyThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, DeviceToHostCopyThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -120,8 +117,7 @@ TEST(ThunkProtoDeserializationTest, DeviceToHostCopyThunk) {\n             mem_size: 256\n           }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n@@ -136,8 +132,7 @@ TEST(ThunkProtoDeserializationTest, DeviceToHostCopyThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, HostToDeviceCopyThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -154,8 +149,7 @@ TEST(ThunkProtoDeserializationTest, HostToDeviceCopyThunk) {\n             mem_size: 256\n           }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n@@ -170,8 +164,7 @@ TEST(ThunkProtoDeserializationTest, HostToDeviceCopyThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, DeviceToDeviceCopyThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -188,8 +181,7 @@ TEST(ThunkProtoDeserializationTest, DeviceToDeviceCopyThunk) {\n             mem_size: 256\n           }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n@@ -204,8 +196,7 @@ TEST(ThunkProtoDeserializationTest, DeviceToDeviceCopyThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, WhileThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -263,8 +254,7 @@ TEST(ThunkProtoDeserializationTest, WhileThunk) {\n           }\n           trip_count: 10\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n@@ -283,8 +273,7 @@ TEST(ThunkProtoDeserializationTest, WhileThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, ConditionalThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -354,8 +343,7 @@ TEST(ThunkProtoDeserializationTest, ConditionalThunk) {\n           }\n           branch_index_is_bool: true\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n@@ -374,13 +362,11 @@ TEST(ThunkProtoDeserializationTest, ConditionalThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, WaitForStreamsThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info { execution_stream_id: 7 }\n         wait_for_streams_thunk { stream_id: 1 wait_for_stream_id: 2 }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       std::unique_ptr<Thunk> thunk,\n@@ -391,17 +377,15 @@ TEST(ThunkProtoDeserializationTest, WaitForStreamsThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, CudnnThunk) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info { execution_stream_id: 7 }\n         cudnn_thunk {\n           fingerprint: \"fingerprint\"\n           args { buffer_allocation_index: 0 }\n           args { buffer_allocation_index: 1 }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n   std::vector<BufferAllocation> buffer_allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/1024, /*color=*/0),\n       BufferAllocation(/*index=*/1, /*size=*/1024, /*color=*/0),\n@@ -415,8 +399,7 @@ TEST(ThunkProtoDeserializationTest, CudnnThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, CublasLtMatmulThunk) {\n-  ThunkProto proto;\n-  ASSERT_TRUE(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info { profile_annotation: \"custom-call.4\" }\n         cublas_lt_matmul_thunk {\n@@ -463,8 +446,7 @@ TEST(ThunkProtoDeserializationTest, CublasLtMatmulThunk) {\n           c { size: 161600 buffer_allocation_index: 5 }\n           d { size: 161600 buffer_allocation_index: 5 }\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   std::vector<BufferAllocation> allocations = {\n       BufferAllocation(/*index=*/0, /*size=*/4, /*color=*/0),  // UNUSED\n@@ -482,12 +464,10 @@ TEST(ThunkProtoDeserializationTest, CublasLtMatmulThunk) {\n }\n \n TEST(ThunkProtoDeserializationTest, EmptyThunkImplReturnsAnError) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info { execution_stream_id: 7 }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   EXPECT_THAT(DeserializeThunkProto(proto, /*buffer_allocations=*/{}),\n               absl_testing::StatusIs(absl::StatusCode::kInvalidArgument));"
        },
        {
            "sha": "bdaa3484d9bef56e7f05226ce9e894161192d704",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -45,6 +45,7 @@ limitations under the License.\n #include \"xla/tsl/platform/status_matchers.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"tsl/platform/protobuf.h\"\n \n@@ -53,6 +54,7 @@ namespace {\n \n using ::testing::ElementsAre;\n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n using ::tsl::testing::IsOk;\n using Kind = Thunk::Kind;\n \n@@ -313,8 +315,7 @@ TEST(WhileThunkTest, ToProto) {\n }\n \n TEST(WhileThunkTest, FromProto) {\n-  ThunkProto proto;\n-  CHECK(tsl::protobuf::TextFormat::ParseFromString(\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n           profile_annotation: \"profile_annotation\"\n@@ -356,8 +357,7 @@ TEST(WhileThunkTest, FromProto) {\n           }\n           trip_count: 10\n         }\n-      )pb\",\n-      &proto));\n+      )pb\");\n \n   Thunk::ThunkInfo thunk_info;\n   thunk_info.profile_annotation = \"profile_annotation\";"
        },
        {
            "sha": "ce6a593cebe7efded33c1e73b3068bd39ebf82ff",
            "filename": "third_party/xla/xla/tsl/util/proto/BUILD",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2FBUILD?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -59,3 +59,24 @@ tsl_cc_test(\n         \"@local_tsl//tsl/platform:protobuf\",\n     ],\n )\n+\n+cc_library(\n+    name = \"parse_text_proto\",\n+    testonly = True,\n+    hdrs = [\"parse_text_proto.h\"],\n+    deps = [\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_protobuf//:protobuf\",\n+    ],\n+)\n+\n+tsl_cc_test(\n+    name = \"parse_text_proto_test\",\n+    srcs = [\"parse_text_proto_test.cc\"],\n+    deps = [\n+        \":parse_text_proto\",\n+        \":proto_matchers_test_protos_cc\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)"
        },
        {
            "sha": "c111d34c89dc415436ac25e2d42653776054f747",
            "filename": "third_party/xla/xla/tsl/util/proto/parse_text_proto.h",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2Fparse_text_proto.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2Fparse_text_proto.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2Fparse_text_proto.h?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -0,0 +1,46 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_TSL_UTIL_PROTO_PARSE_TEXT_PROTO_H_\n+#define XLA_TSL_UTIL_PROTO_PARSE_TEXT_PROTO_H_\n+\n+#include \"absl/log/check.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"google/protobuf/message.h\"\n+#include \"google/protobuf/text_format.h\"\n+\n+namespace tsl::proto_testing {\n+\n+// Parses the given `text_proto` into a protobuf message of type `T`.\n+//\n+// `T` must be a protobuf message type.\n+//\n+// This is a test-only utility that is equivalent to the Google internal\n+// `ParseTextProtoOrDie`, but works in OSS. Note that you must explicitly\n+// specify the template argument, unlike in the internal version, where the type\n+// can be inferred.\n+//\n+// Usage: auto proto = ParseTextProtoOrDie<MyProto>(R\"pb(...)pb\");\n+template <typename T>\n+inline T ParseTextProtoOrDie(absl::string_view text_proto) {\n+  T proto;\n+  CHECK(google::protobuf::TextFormat::ParseFromString(text_proto, &proto))\n+      << \"Failed to parse text proto\";\n+  return proto;\n+}\n+\n+}  // namespace tsl::proto_testing\n+\n+#endif  // XLA_TSL_UTIL_PROTO_PARSE_TEXT_PROTO_H_"
        },
        {
            "sha": "bc92613f19c2867e2e7f0f5472718a161ef4e1e2",
            "filename": "third_party/xla/xla/tsl/util/proto/parse_text_proto_test.cc",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2Fparse_text_proto_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2eb2840e7a58173a33d7f32348ce71dced1c7d50/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2Fparse_text_proto_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fproto%2Fparse_text_proto_test.cc?ref=2eb2840e7a58173a33d7f32348ce71dced1c7d50",
            "patch": "@@ -0,0 +1,43 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tsl/util/proto/parse_text_proto.h\"\n+\n+#include <gtest/gtest.h>\n+#include \"xla/tsl/util/proto/proto_matchers_test_protos.pb.h\"\n+\n+namespace tsl::proto_testing {\n+namespace {\n+\n+TEST(ParseTextProtoOrDieTest, ParsesValidTextProto) {\n+  Foo foo = ParseTextProtoOrDie<Foo>(R\"pb(\n+    s1: \"hello\" i2: 42 r3: \"a\" r3: \"b\"\n+  )pb\");\n+  EXPECT_EQ(foo.s1(), \"hello\");\n+  EXPECT_EQ(foo.i2(), 42);\n+  ASSERT_EQ(foo.r3_size(), 2);\n+  EXPECT_EQ(foo.r3(0), \"a\");\n+  EXPECT_EQ(foo.r3(1), \"b\");\n+}\n+\n+TEST(ParseTextProtoOrDieDeathTest, DiesOnInvalidTextProto) {\n+  EXPECT_DEATH(ParseTextProtoOrDie<Foo>(R\"pb(\n+                 invalid_field: \"hello\"\n+               )pb\"),\n+               \"Failed to parse text proto\");\n+}\n+\n+}  // namespace\n+}  // namespace tsl::proto_testing"
        }
    ],
    "stats": {
        "total": 249,
        "additions": 163,
        "deletions": 86
    }
}