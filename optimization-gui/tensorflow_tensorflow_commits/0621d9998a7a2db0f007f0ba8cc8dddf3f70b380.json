{
    "author": "emilyfertig",
    "message": "[PJRT-IFRT] Give `xla::ifrt::PjRtClient` a work queue and make KV-store lookup for cross-host transfers async.\n\nPiperOrigin-RevId: 801082773",
    "sha": "0621d9998a7a2db0f007f0ba8cc8dddf3f70b380",
    "files": [
        {
            "sha": "19fcedd4fbfff345598b9a5bcbe2e5ea4386220d",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0621d9998a7a2db0f007f0ba8cc8dddf3f70b380/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0621d9998a7a2db0f007f0ba8cc8dddf3f70b380/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2FBUILD?ref=0621d9998a7a2db0f007f0ba8cc8dddf3f70b380",
            "patch": "@@ -331,6 +331,7 @@ cc_library(\n         \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:IR\",\n         \"@local_tsl//tsl/platform:casts\",\n+        \"@local_tsl//tsl/platform:unbounded_work_queue\",\n     ],\n )\n "
        },
        {
            "sha": "9f2a5862719339b246cb31c06b56aaff2b60b108",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_client.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0621d9998a7a2db0f007f0ba8cc8dddf3f70b380/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0621d9998a7a2db0f007f0ba8cc8dddf3f70b380/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.cc?ref=0621d9998a7a2db0f007f0ba8cc8dddf3f70b380",
            "patch": "@@ -98,6 +98,7 @@ limitations under the License.\n #include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n #include \"tsl/platform/casts.h\"\n+#include \"tsl/platform/unbounded_work_queue.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -871,6 +872,9 @@ absl::StatusOr<std::unique_ptr<PjRtClient>> PjRtClient::Create(\n     }\n   }\n \n+  client->work_queue_ = std::make_unique<tsl::UnboundedWorkQueue>(\n+      tsl::Env::Default(), \"ifrt_pjrt_client_work_queue\");\n+\n   LogDeviceSummary(client.get());\n   return client;\n }\n@@ -1499,13 +1503,21 @@ absl::Status PjRtClient::CrossHostSendBuffers(\n     return absl::InternalError(\n         \"CrossHostSendBuffers: keys must be the same size as buffers.\");\n   }\n+  // TODO(emilyaf): Use an async version of KeyValueStore::Get or query batched\n+  // keys together to reduce the number of threads used.\n   for (int i = 0; i < keys.size(); ++i) {\n     auto promise = PjRtFuture<std::string>::CreatePromise();\n     PjRtFuture<std::string> descriptor_future(promise);\n-    std::string key = absl::StrCat(kKeyPrefix, keys[i]);\n-    TF_ASSIGN_OR_RETURN(std::string descriptor,\n-                        kv_store_->Get(key, cross_host_transfer_timeout_));\n-    promise.Set(std::move(descriptor));\n+    work_queue_->Schedule([this, &promise, k = keys[i]] {\n+      std::string key = absl::StrCat(kKeyPrefix, k);\n+      absl::StatusOr<std::string> descriptor =\n+          kv_store_->Get(key, cross_host_transfer_timeout_);\n+      if (!descriptor.ok()) {\n+        LOG(FATAL) << \"Failed to get descriptor for key \" << key << \": \"\n+                   << descriptor.status();\n+      }\n+      promise.Set(std::move(*descriptor));\n+    });\n     auto on_done = [](absl::Status status, bool sends_were_enqueued) {\n       CHECK_OK(status);\n     };"
        },
        {
            "sha": "2812a15a2b610483253798f124e4c42992ab966e",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_client.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0621d9998a7a2db0f007f0ba8cc8dddf3f70b380/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0621d9998a7a2db0f007f0ba8cc8dddf3f70b380/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.h?ref=0621d9998a7a2db0f007f0ba8cc8dddf3f70b380",
            "patch": "@@ -67,6 +67,7 @@ limitations under the License.\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/logging.h\"\n #include \"xla/xla_data.pb.h\"\n+#include \"tsl/platform/unbounded_work_queue.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -404,6 +405,10 @@ class PjRtClient final\n   bool shutting_down_ ABSL_GUARDED_BY(shutting_down_mu_) = false;\n   std::unique_ptr<tsl::Thread> global_process_info_thread_;\n \n+  // A work queue for dispatching background work. Enqueued work items can\n+  // access the members of this class, so work_queue_ should be built last.\n+  std::unique_ptr<tsl::UnboundedWorkQueue> work_queue_;\n+\n   friend class PjRtClientPeer;\n };\n "
        }
    ],
    "stats": {
        "total": 26,
        "additions": 22,
        "deletions": 4
    }
}