{
    "author": "qukhan",
    "message": "Don't name the handle when mapping the XNNPack cache on Windows.\n\nWhen specifying a mapping name to `CreateFileMappingA()`, that function returns\nprevious mappings that match the same name disregarding the newly requested\nmapping size. This doesn't work well with the weight cache that is built (and\nmapped) incrementally.\n\nBy making the mapping objects anonymous, we ensure that the mapping returned\nwill have the requested size.\n\nNote: this doesn't increase the totally memory used by the process but the\naccounting by the Windows system is different. Compared to a fix that allocates\nmemory instead of mapping the file, less memory is committed, and private and\nmore is shareable.\n\nTesting `litert_llm_main` on [Gemma3-1B-IT] on Windows 11.\n\n| Fix        | Commit (KB) | Working Set (KB) | Shareable (KB) | Private (KB) |\n| ---------: | -----------:| ----------------:| --------------:| ------------:|\n| Anon. map  |   1 208 416 |        1 678 396 |      1 079 620 |      599 096 |\n| Mem. alloc |   1 705 620 |        1 678 572 |        582 428 |    1 096 144 |\n|            |             |                  |                |              |\n| diff.      |    +497 204 |              176 |       -497 192 |     +497 048 |\n\n[Gemma3-1B-IT]: https://huggingface.co/litert-community/Gemma3-1B-IT/blob/main/gemma3-1b-it-int4.litertlm\n\nPiperOrigin-RevId: 821807004",
    "sha": "dc12ec45566c0fc15599f1e37cd8e346d0409f72",
    "files": [
        {
            "sha": "169e284de47f4640f6be93304a2e66d396d0d700",
            "filename": "tensorflow/lite/delegates/xnnpack/mmap_handle.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc12ec45566c0fc15599f1e37cd8e346d0409f72/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc12ec45566c0fc15599f1e37cd8e346d0409f72/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc?ref=dc12ec45566c0fc15599f1e37cd8e346d0409f72",
            "patch": "@@ -121,19 +121,10 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n                        \"could not convert file descriptor to file handle: %s.\",\n                        strerror(errno));\n \n-  // Create the handle name, which is either NULL or the path with backslashes\n-  // replaced by `_`.\n-  std::string name;\n-  const char* handle_name = nullptr;\n-  if (path && path[0] != '\\0') {\n-    name = path;\n-    std::replace(name.begin(), name.end(), '\\\\', '_');\n-    handle_name = name.c_str();\n-  }\n   file_mapping_ =\n       CreateFileMappingA(osf_handle, /*lpFileMappingAttributes=*/nullptr,\n                          /*flProtect=*/PAGE_READONLY, /*dwMaximumSizeHigh=*/0,\n-                         /*dwMaximumSizeLow=*/0, /*lpName=*/handle_name);\n+                         /*dwMaximumSizeLow=*/0, /*lpName=*/nullptr);\n   XNNPACK_RETURN_CHECK(file_mapping_ != NULL,\n                        \"could not create a file mapping: %s\",\n                        GetLastErrorString().c_str());"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 1,
        "deletions": 10
    }
}