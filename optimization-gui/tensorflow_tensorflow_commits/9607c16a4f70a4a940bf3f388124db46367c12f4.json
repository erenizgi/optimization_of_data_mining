{
    "author": "tf-marissaw",
    "message": "Support Windows memory info\n\nMemory info is a useful class for recording memory usage across\na variety of devices. Add Windows support to it.\n\nPiperOrigin-RevId: 820360533",
    "sha": "9607c16a4f70a4a940bf3f388124db46367c12f4",
    "files": [
        {
            "sha": "0782b943dcc6d461c7b82af89da08a79b90cea86",
            "filename": "tensorflow/lite/profiling/memory_info.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9607c16a4f70a4a940bf3f388124db46367c12f4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9607c16a4f70a4a940bf3f388124db46367c12f4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info.cc?ref=9607c16a4f70a4a940bf3f388124db46367c12f4",
            "patch": "@@ -25,6 +25,10 @@ limitations under the License.\n #elif defined(__APPLE__)\n #include <mach/mach.h>\n #include <malloc/malloc.h>\n+#elif defined(_WIN32)\n+#include <windows.h>\n+// psapi must be included after windows.h.\n+#include <psapi.h>\n #endif\n \n namespace tflite {\n@@ -34,7 +38,7 @@ namespace memory {\n const size_t MemoryUsage::kValueNotSet = 0;\n \n bool MemoryUsage::IsSupported() {\n-#if defined(__linux__) || defined(__APPLE__)\n+#if defined(__linux__) || defined(__APPLE__) || defined(_WIN32)\n   return true;\n #endif\n   return false;\n@@ -71,6 +75,30 @@ MemoryUsage GetMemoryUsage() {\n   struct mstats stats = mstats();\n   result.total_allocated_bytes = stats.bytes_total;\n   result.in_use_allocated_bytes = stats.bytes_used;\n+#elif defined(_WIN32)\n+  PROCESS_MEMORY_COUNTERS process_memory_counters;\n+  HANDLE process_handle = GetCurrentProcess();\n+  if (process_handle != nullptr &&\n+      GetProcessMemoryInfo(process_handle, &process_memory_counters,\n+                           sizeof(process_memory_counters))) {\n+    result.mem_footprint_kb = process_memory_counters.WorkingSetSize / 1024;\n+  } else {\n+    result.mem_footprint_kb = -1;\n+  }\n+  CloseHandle(process_handle);\n+  HANDLE process_heap = GetProcessHeap();\n+  if (process_heap != nullptr && HeapLock(process_heap)) {\n+    HEAP_SUMMARY heap_summary;\n+    heap_summary.cb = sizeof(heap_summary);\n+    if (HeapSummary(process_heap, 0, &heap_summary)) {\n+      result.total_allocated_bytes = heap_summary.cbCommitted;\n+      result.in_use_allocated_bytes = heap_summary.cbAllocated;\n+    } else {\n+      result.total_allocated_bytes = -1;\n+      result.in_use_allocated_bytes = -1;\n+    }\n+    HeapUnlock(process_heap);\n+  }\n #endif  // __linux__\n   return result;\n }"
        },
        {
            "sha": "9663d8ffccaba115c9deff2122c184f5d7e832a4",
            "filename": "tensorflow/lite/profiling/memory_info.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9607c16a4f70a4a940bf3f388124db46367c12f4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9607c16a4f70a4a940bf3f388124db46367c12f4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info.h?ref=9607c16a4f70a4a940bf3f388124db46367c12f4",
            "patch": "@@ -55,11 +55,19 @@ struct MemoryUsage {\n   //    + purgeable_nonvolatile\n   //    + purgeable_nonvolatile_compressed\n   //    + page_table\n+  //\n+  // For Windows:\n+  // This is the current memory size (in kilobytes) occupied by the OS process\n+  // that is held in main memory (RAM). This is generally referred to as the\n+  // working set size. This is an alias to\n+  // PROCESS_MEMORY_COUNTERS::WorkingSetSize.\n   int64_t mem_footprint_kb;\n \n   // Total non-mmapped heap space allocated from system in bytes.\n   // For Linux, this is an alias to mallinfo::arena.\n   // For Mac, this is an alias to mstats::bytes_total\n+  // For Windows, this is an alias to HEAP_SUMMARY::cbCommitted\n+  // for the default process heap.\n   //\n   // This does not count mmapped heap space, nor does it count non-heap\n   // uses of memory such as other mmapped space, thread stacks, globals,\n@@ -70,6 +78,8 @@ struct MemoryUsage {\n   // (i.e. excluding those have been freed).\n   // For Linux, this is an alias to mallinfo::uordblks.\n   // For Mac, this is an alias to mstats::bytes_used\n+  // For Windows, this is an alias to HEAP_SUMMARY::cbAllocated\n+  // for the default process heap.\n   //\n   // This does not count non-heap uses of mmap, nor does it count other\n   // non-heap uses of memory such as thread stacks, globals, code, etc."
        },
        {
            "sha": "fcb87d5fd2deacab1aa55f813969d4206d140faa",
            "filename": "tensorflow/lite/profiling/memory_info_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9607c16a4f70a4a940bf3f388124db46367c12f4/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9607c16a4f70a4a940bf3f388124db46367c12f4/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc?ref=9607c16a4f70a4a940bf3f388124db46367c12f4",
            "patch": "@@ -52,7 +52,7 @@ TEST(MemoryUsage, GetMemoryUsage) {\n   EXPECT_EQ(MemoryUsage::kValueNotSet, result.total_allocated_bytes);\n   EXPECT_EQ(MemoryUsage::kValueNotSet, result.in_use_allocated_bytes);\n \n-#if defined(__linux__) || defined(__APPLE__)\n+#if defined(__linux__) || defined(__APPLE__) || defined(_WIN32)\n   // Just allocate some space in heap so that we have some meaningful\n   // memory usage to report.\n   constexpr int size = 10 * 1024 * 1024;\n@@ -89,7 +89,7 @@ TEST(MemoryUsage, OutputMemoryUsageToStream) {\n }\n \n TEST(MemoryUsage, IsSupported) {\n-#if defined(__linux__) || defined(__APPLE__)\n+#if defined(__linux__) || defined(__APPLE__) || defined(_WIN32)\n   EXPECT_TRUE(MemoryUsage::IsSupported());\n #else\n   EXPECT_FALSE(MemoryUsage::IsSupported());"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 41,
        "deletions": 3
    }
}