{
    "author": "ZixuanJiang",
    "message": "Use `absl::Span` and `absl::InlinedVector` for `allow_spmd_sharding_propagation_to_parameter / output`.\n\nPiperOrigin-RevId: 831678768",
    "sha": "f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
    "files": [
        {
            "sha": "681ade850f5c396017703b90fd293a0719daba3c",
            "filename": "third_party/xla/xla/hlo/experimental/auto_sharding/auto_sharding.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fauto_sharding.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fauto_sharding.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fauto_sharding.cc?ref=f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
            "patch": "@@ -3566,7 +3566,7 @@ absl::StatusOr<bool> AutoShardingImplementation::RunAutoSharding(\n           /*instruction_to_shard_group_id=*/nullptr,\n           /*shard_group_id_to_shard_as_group=*/nullptr,\n           /*shard_group_id_to_shard_like_group=*/nullptr,\n-          /*allow_spmd_sharding_propagation_to_parameters_vector=*/nullptr,\n+          /*allow_spmd_sharding_propagation_to_parameters_vector=*/{},\n           /*remove_unknown_shardings=*/true));\n \n   DumpHloModuleIfEnabled(*module, \"after_spmd_calls\");"
        },
        {
            "sha": "56db86ab617b02b085d509f0d645f8731252fd19",
            "filename": "third_party/xla/xla/hlo/utils/hlo_sharding_util.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.cc?ref=f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
            "patch": "@@ -3057,8 +3057,8 @@ Shape TileLeafShape(const HloSharding& sharding, const Shape& shape) {\n }\n \n absl::Status CanonicalizeLayoutAfterShardingPropagation(\n-    HloModule* module, const std::vector<bool>& update_output_layout,\n-    const std::vector<bool>& update_parameters_layout) {\n+    HloModule* module, absl::Span<const bool> update_output_layout,\n+    absl::Span<const bool> update_parameters_layout) {\n   if (!module->layout_canonicalization_callback()) {\n     VLOG(4) << \"There is no registered layout_canonicalization_callback.\";\n     return absl::OkStatus();"
        },
        {
            "sha": "8e0f0768c932ef19729d84b1fda33e86ed818e2d",
            "filename": "third_party/xla/xla/hlo/utils/hlo_sharding_util.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.h?ref=f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
            "patch": "@@ -574,8 +574,8 @@ Shape TileLeafShape(const HloSharding& sharding, const Shape& shape);\n // DetermineArgumentLayoutsFromCompileOptions() in\n // tensorflow/compiler/xla/pjrt/utils.h.\n absl::Status CanonicalizeLayoutAfterShardingPropagation(\n-    HloModule* module, const std::vector<bool>& update_output_layout,\n-    const std::vector<bool>& update_parameters_layout);\n+    HloModule* module, absl::Span<const bool> update_output_layout,\n+    absl::Span<const bool> update_parameters_layout);\n \n // Returns true iff the specified hlo or sharding has a spatially partitioned\n // sharding (tiled or replicated) that can be propagated by sharding"
        },
        {
            "sha": "47f6cf421802d6194a3ff0eb4e5a729c7721e40d",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
            "patch": "@@ -670,6 +670,7 @@ cc_library(\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n+        \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "2638f829a4fd5b0cc5e90adcb7c086d146469df6",
            "filename": "third_party/xla/xla/service/sharding_propagation.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_propagation.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_propagation.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_propagation.cc?ref=f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
            "patch": "@@ -1393,8 +1393,7 @@ absl::StatusOr<bool> ProcessShardingInstruction(\n         shard_group_id_to_shard_as_group,\n     absl::flat_hash_map<int64_t, std::vector<HloInstruction*>>*\n         shard_group_id_to_shard_like_group,\n-    const std::vector<bool>*\n-        allow_spmd_sharding_propagation_to_parameters_vector,\n+    absl::Span<const bool> allow_spmd_sharding_propagation_to_parameters_vector,\n     bool remove_unknown_shardings) {\n   bool changed = false;\n \n@@ -1412,11 +1411,10 @@ absl::StatusOr<bool> ProcessShardingInstruction(\n           instruction->sharding().IsShardGroup()) {\n         if (instruction->IsCustomCall(\"Sharding\")) {\n           CHECK(instruction->operand(0)->opcode() != HloOpcode::kParameter ||\n-                (allow_spmd_sharding_propagation_to_parameters_vector &&\n-                 allow_spmd_sharding_propagation_to_parameters_vector->size() ==\n+                (allow_spmd_sharding_propagation_to_parameters_vector.size() ==\n                      module->entry_computation()->num_parameters() &&\n-                 allow_spmd_sharding_propagation_to_parameters_vector->at(\n-                     instruction->operand(0)->parameter_number())));\n+                 allow_spmd_sharding_propagation_to_parameters_vector\n+                     [instruction->operand(0)->parameter_number()]));\n         }\n         if (instruction->IsCustomCall(\"Sharding\") && !replaced_with_copy) {\n           // Pass shard group to operand sharding custom-call if it's not\n@@ -3190,7 +3188,7 @@ absl::StatusOr<bool> ShardingPropagation::RunImpl(\n               : nullptr,\n           &instruction_to_shard_group_id, &shard_group_id_to_shard_as_group,\n           &shard_group_id_to_shard_like_group,\n-          &allow_spmd_sharding_propagation_to_parameters_vector_));\n+          allow_spmd_sharding_propagation_to_parameters_vector_));\n   any_changed |= changed;\n \n   for (const auto& [shard_group_id, shard_as_group] :"
        },
        {
            "sha": "21d77783b699897c3945a770c4ff10533963ee6b",
            "filename": "third_party/xla/xla/service/sharding_propagation.h",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_propagation.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4b2b4c353b83deb23f7f49e699dd1f0fefeec05/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_propagation.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_propagation.h?ref=f4b2b4c353b83deb23f7f49e699dd1f0fefeec05",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include \"absl/algorithm/container.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/container/flat_hash_set.h\"\n+#include \"absl/container/inlined_vector.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n@@ -79,8 +80,8 @@ absl::StatusOr<bool> ProcessShardingInstruction(\n         shard_group_id_to_shard_as_group = nullptr,\n     absl::flat_hash_map<int64_t, std::vector<HloInstruction*>>*\n         shard_group_id_to_shard_like_group = nullptr,\n-    const std::vector<bool>*\n-        allow_spmd_sharding_propagation_to_parameters_vector = nullptr,\n+    absl::Span<const bool>\n+        allow_spmd_sharding_propagation_to_parameters_vector = {},\n     bool remove_unknown_shardings = false);\n \n int64_t ComputeNonRootUsers(const HloInstruction* instr);\n@@ -198,8 +199,10 @@ class ShardingPropagation : public HloModulePass {\n   bool propagate_metadata_;\n   bool allow_spmd_sharding_propagation_to_output_;\n   bool allow_spmd_sharding_propagation_to_parameters_;\n-  std::vector<bool> allow_spmd_sharding_propagation_to_output_vector_;\n-  std::vector<bool> allow_spmd_sharding_propagation_to_parameters_vector_;\n+  absl::InlinedVector<bool, 1>\n+      allow_spmd_sharding_propagation_to_output_vector_;\n+  absl::InlinedVector<bool, 1>\n+      allow_spmd_sharding_propagation_to_parameters_vector_;\n   // If true, the pass keeps the propagation results only on selected\n   // instructions to prevent CSE across unrelated subgraphs. (A common case is\n   // scalar broadcasts)."
        }
    ],
    "stats": {
        "total": 34,
        "additions": 18,
        "deletions": 16
    }
}