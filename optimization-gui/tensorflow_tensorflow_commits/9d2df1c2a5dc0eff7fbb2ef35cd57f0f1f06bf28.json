{
    "author": "Moerafaat",
    "message": "[Triton] Fixing getLastInductionValue utility to also accept Index type. This would otherwise crash when warp specialization is enabled.\n\nPiperOrigin-RevId: 820159796",
    "sha": "9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28",
    "files": [
        {
            "sha": "ba274ebbd2581a64d271965ece3774dd7c5e64c7",
            "filename": "third_party/xla/third_party/triton/temporary/series.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28/third_party%2Fxla%2Fthird_party%2Ftriton%2Ftemporary%2Fseries.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28/third_party%2Fxla%2Fthird_party%2Ftriton%2Ftemporary%2Fseries.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftriton%2Ftemporary%2Fseries.bzl?ref=9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28",
            "patch": "@@ -14,5 +14,6 @@ those to this list.\n \"\"\"\n \n temporary_patch_list = [\n+    \"//third_party/triton:temporary/utility-fix.patch\",\n     # Add new patches just above this line\n ]"
        },
        {
            "sha": "f8cc5d0821f098213f91b9ee67002910896fbee0",
            "filename": "third_party/xla/third_party/triton/temporary/utility-fix.patch",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28/third_party%2Fxla%2Fthird_party%2Ftriton%2Ftemporary%2Futility-fix.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28/third_party%2Fxla%2Fthird_party%2Ftriton%2Ftemporary%2Futility-fix.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftriton%2Ftemporary%2Futility-fix.patch?ref=9d2df1c2a5dc0eff7fbb2ef35cd57f0f1f06bf28",
            "patch": "@@ -0,0 +1,22 @@\n+This patch would probably not be accepted upstream because our infrastructure\n+uses Index type for indexing, while they use Integer type. Triton frontend\n+wouldn't generate a situation that would run into this issue.\n+\n+diff --git a/lib/Dialect/Triton/IR/Utility.cpp b/lib/Dialect/Triton/IR/Utility.cpp\n+--- a/lib/Dialect/Triton/IR/Utility.cpp\n++++ b/lib/Dialect/Triton/IR/Utility.cpp\n+@@ -97,8 +97,12 @@ Value tt::getLastInductionValue(OpBuilde\n+   // (ub - lb -1) // step * step + lb\n+   Value diff =\n+       b.create<arith::SubIOp>(loc, loop.getUpperBound(), loop.getLowerBound());\n+-  diff = b.create<arith::SubIOp>(\n+-      loc, diff, b.create<arith::ConstantOp>(loc, b.getI32IntegerAttr(1)));\n++  Value one;\n++  if (diff.getType().isIndex())\n++    one = b.create<arith::ConstantIndexOp>(loc, 1);\n++  else\n++    one = b.create<arith::ConstantOp>(loc, b.getIntegerAttr(diff.getType(), 1));\n++  diff = b.create<arith::SubIOp>(loc, diff, one);\n+   Value ceilStep = b.create<arith::MulIOp>(\n+       loc, b.create<arith::DivSIOp>(loc, diff, loop.getStep()), loop.getStep());\n+   return b.create<arith::AddIOp>(loc, ceilStep, loop.getLowerBound());"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 23,
        "deletions": 0
    }
}