{
    "author": "sharadmv",
    "message": "Allow DCE side-effecting custom calls\n\nPiperOrigin-RevId: 829639173",
    "sha": "c66648c3bb8d1c3cada83c02d2310abc35171436",
    "files": [
        {
            "sha": "943b821883740e914e7bd65c506212d3189776b6",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/hlo_dce.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c66648c3bb8d1c3cada83c02d2310abc35171436/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c66648c3bb8d1c3cada83c02d2310abc35171436/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce.cc?ref=c66648c3bb8d1c3cada83c02d2310abc35171436",
            "patch": "@@ -51,6 +51,9 @@ namespace xla {\n \n namespace {\n \n+const absl::string_view kDceSideEffectFrontendAttribute =\n+    \"xla_allow_dce_side_effecting_op\";\n+\n // Checks if the instruction is a removable while given\n // remove_cross_partition_collective_ops\n bool IsRemovableWhile(const HloInstruction* instruction,\n@@ -208,7 +211,12 @@ bool CanRemoveInstruction(\n                             !maybe_collective_op->constrain_layout();\n     bool allow_while =\n         IsRemovableWhile(instruction, remove_cross_partition_collective_ops);\n-    if (!allow_collective && !allow_while) {\n+    bool allow_custom_call = instruction->IsCustomCall(\"tpu_custom_call\") &&\n+                             instruction->frontend_attributes().map().contains(\n+                                 kDceSideEffectFrontendAttribute) &&\n+                             instruction->frontend_attributes().map().at(\n+                                 kDceSideEffectFrontendAttribute) == \"true\";\n+    if (!allow_collective && !allow_while && !allow_custom_call) {\n       return false;\n     }\n   }"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}