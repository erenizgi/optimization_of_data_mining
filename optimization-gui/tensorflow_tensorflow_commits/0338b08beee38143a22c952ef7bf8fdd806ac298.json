{
    "author": "tensorflower-gardener",
    "message": "Add mechanism to prioritize ForceDelay custom calls\n\nPiperOrigin-RevId: 823973702",
    "sha": "0338b08beee38143a22c952ef7bf8fdd806ac298",
    "files": [
        {
            "sha": "688a7a4690b3d889b1f8bf58141b1433a9c08263",
            "filename": "third_party/xla/xla/service/latency_hiding_scheduler.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0338b08beee38143a22c952ef7bf8fdd806ac298/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0338b08beee38143a22c952ef7bf8fdd806ac298/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc?ref=0338b08beee38143a22c952ef7bf8fdd806ac298",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n+#include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/str_join.h\"\n@@ -151,6 +152,18 @@ bool IsCustomCallWithForceDelayAttribute(const HloInstruction* instr) {\n          attr.value() == \"force_delay\";\n }\n \n+int GetCustomCallForceDelayPriority(const HloInstruction* instr) {\n+  auto attr = instr->get_frontend_attribute(\"scheduler_delay_priority\");\n+  if (instr->opcode() == HloOpcode::kCustomCall && attr.has_value()) {\n+    int out;\n+    CHECK(absl::SimpleAtoi(attr.value(), &out))\n+        << \"Failed to parse scheduler_delay_priority attribute: \"\n+        << attr.value();\n+    return out;\n+  }\n+  return 0;\n+}\n+\n absl::flat_hash_map<int64_t, int64_t>\n GetNumResourcesNeededForAnnotationWithKeepOriginalOrderAttrs(\n     const DefaultSchedulerCore::SchedulingState& sched_state,\n@@ -1258,7 +1271,9 @@ class ReadySetLt {\n     HloGraphNode* bn = b.node;\n     // Schedule according to ForceEarly.\n     CMP_PROPERTY(GetForceEarly(), \"kForceEarly\");\n-    // Schedule according to ForceDelay first.\n+    // Schedule according to highest ForceDelay first.\n+    CMP_EXPLICIT(-an->GetForceDelayPriority(), -bn->GetForceDelayPriority(),\n+                 \"kForceDelayPriority\");\n     CMP_EXPLICIT(!an->GetForceDelay(), !bn->GetForceDelay(), \"kForceDelay\");\n     // Use the preference value (comes from a heuristic) to choose between\n     // the two candidates. If two preferences are the same regular LHS logic\n@@ -2591,6 +2606,7 @@ HloScheduleGraph::HloScheduleGraph(\n     }\n     if (IsCustomCallWithForceDelayAttribute(instr)) {\n       n->SetForceDelay(true);\n+      n->SetForceDelayPriority(GetCustomCallForceDelayPriority(instr));\n     }\n   }\n "
        },
        {
            "sha": "4662d01768f50f91e9e12365a52f2ee607cc2621",
            "filename": "third_party/xla/xla/service/latency_hiding_scheduler.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0338b08beee38143a22c952ef7bf8fdd806ac298/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0338b08beee38143a22c952ef7bf8fdd806ac298/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.h?ref=0338b08beee38143a22c952ef7bf8fdd806ac298",
            "patch": "@@ -705,6 +705,10 @@ class HloGraphNode {\n   void SetGraphDepth(TimeCost graph_depth) { graph_depth_ = graph_depth; }\n   bool GetForceDelay() const { return force_delay_; }\n   void SetForceDelay(bool force_delay) { force_delay_ = force_delay; }\n+  int GetForceDelayPriority() const { return force_delay_priority_; }\n+  void SetForceDelayPriority(int force_delay_priority) {\n+    force_delay_priority_ = force_delay_priority;\n+  }\n   bool GetForceEarly() const { return force_early_; }\n   void SetForceEarly(bool force_early) { force_early_ = force_early; }\n   bool GetForceDelayAfterTarget() const { return force_delay_after_target_; }\n@@ -947,6 +951,9 @@ class HloGraphNode {\n   // bitfields\n   // Force the scheduling of the nodes with attribute set as late as possible.\n   bool force_delay_ = false;\n+  // If multiple nodes are there with force_delay_ = true, the one with the\n+  // lowest delay priority will be scheduled first.\n+  int force_delay_priority_ = 0;\n   // Force the scheduling of the nodes with attribute set as early as possible.\n   bool force_early_ = false;\n   // If has_rare_ is false, then all the fields in rare can assumed to be"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 24,
        "deletions": 1
    }
}