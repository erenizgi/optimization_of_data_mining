{
    "author": "tensorflower-gardener",
    "message": "Propagates mosaic_fusion_group frontend attribute from the call to the inlined instructions. Adds unit tests for frontend attribute propagation.\n\nPiperOrigin-RevId: 830646104",
    "sha": "6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a",
    "files": [
        {
            "sha": "216d15d48df8f64578e40ba56a5afa8127ad4799",
            "filename": "third_party/xla/xla/service/call_inliner.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc?ref=6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a",
            "patch": "@@ -294,18 +294,26 @@ CallInliner::Inline(HloInstruction* call) {\n   // inlined instructions.\n   if (call->has_frontend_attributes()) {\n     const FrontendAttributes& call_attributes = call->frontend_attributes();\n-    std::string has_fuse =\n-        call_attributes.map().contains(\"MUST_FUSE\")      ? \"MUST_FUSE\"\n-        : call_attributes.map().contains(\"MAXIMAL_FUSE\") ? \"MAXIMAL_FUSE\"\n-                                                         : \"\";\n-    if (!has_fuse.empty()) {\n+    for (auto maybe_attribute :\n+         {call_attributes.map().contains(\"MUST_FUSE\")\n+              ? std::make_optional(\"MUST_FUSE\")\n+          : call_attributes.map().contains(\"MAXIMAL_FUSE\")\n+              ? std::make_optional(\"MAXIMAL_FUSE\")\n+              : std::nullopt,\n+          call_attributes.map().contains(\"mosaic_fusion_group\")\n+              ? std::make_optional(\"mosaic_fusion_group\")\n+              : std::nullopt}) {\n+      if (!maybe_attribute.has_value()) {\n+        continue;\n+      }\n+      const auto attribute = *maybe_attribute;\n       for (auto instruction : callee->instructions()) {\n         // Do so for only fusible instructions.\n         if (instruction->IsFusible()) {\n           FrontendAttributes frontend_attributes =\n               instruction->frontend_attributes();\n           frontend_attributes.mutable_map()->insert(\n-              {has_fuse, call_attributes.map().at(has_fuse)});\n+              {attribute, call_attributes.map().at(attribute)});\n           instruction->set_frontend_attributes(frontend_attributes);\n         }\n       }"
        },
        {
            "sha": "3c2863a3f745e3c0775a230f2565bcedd440fc2d",
            "filename": "third_party/xla/xla/service/call_inliner_test.cc",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner_test.cc?ref=6cea8e390f199145d419bfe3d06c3dbd0a1b0a1a",
            "patch": "@@ -359,6 +359,41 @@ ENTRY %main_outer (p0: u32[]) -> u32[] {\n   }\n }\n \n+TEST_F(CallInlinerTest, PropagateFrontendAttributes) {\n+  const absl::string_view hlo_string = R\"(\n+    HloModule inliner_fe_attr_prop\n+\n+    %add_one (p: f32[]) -> f32[] {\n+      %p = f32[] parameter(0)\n+      %one = f32[] constant(1)\n+      ROOT %add = f32[] add(%p, %one)\n+    }\n+\n+    ENTRY %main () -> f32[] {\n+      %c = f32[] constant(10)\n+      ROOT %call = f32[] call(%c), to_apply=%add_one, frontend_attributes={mosaic_fusion_group=\"1\"}\n+    })\";\n+\n+  auto module = ParseAndReturnVerifiedModule(hlo_string).value();\n+  CallInliner call_inliner;\n+  TF_ASSERT_OK_AND_ASSIGN(bool mutated, call_inliner.Run(module.get()));\n+  ASSERT_TRUE(mutated);\n+\n+  HloInstruction* root = module->entry_computation()->root_instruction();\n+  EXPECT_THAT(root, op::Add());\n+  ASSERT_TRUE(root->has_frontend_attributes());\n+  EXPECT_EQ(root->frontend_attributes().map().at(\"mosaic_fusion_group\"), \"1\");\n+\n+  const HloInstruction* c = root->operand(0);\n+  EXPECT_THAT(c, op::Constant());\n+  EXPECT_FALSE(c->frontend_attributes().map().contains(\"mosaic_fusion_group\"));\n+\n+  const HloInstruction* one = root->operand(1);\n+  EXPECT_THAT(one, op::Constant());\n+  ASSERT_TRUE(one->has_frontend_attributes());\n+  EXPECT_EQ(one->frontend_attributes().map().at(\"mosaic_fusion_group\"), \"1\");\n+}\n+\n TEST_F(CallInlinerTest, InlineCompositeCall) {\n   const absl::string_view hlo_string = R\"(\n   HloModule composite"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 49,
        "deletions": 6
    }
}