{
    "author": "mrguenther",
    "message": "Allow `stablehlo.reshape` ops with complex element types to be folded.\n\nPiperOrigin-RevId: 829597850",
    "sha": "c4ff7887a3a6937e731d0c55356903751045ad37",
    "files": [
        {
            "sha": "0778daf9420e0ecbd02f7864166818f23fdc7704",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c4ff7887a3a6937e731d0c55356903751045ad37/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c4ff7887a3a6937e731d0c55356903751045ad37/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=c4ff7887a3a6937e731d0c55356903751045ad37",
            "patch": "@@ -509,6 +509,37 @@ diff --ruN a/stablehlo/stablehlo/tests/ops_broadcasting.mlir b/stablehlo/stableh\n +  return %0 : !stablehlo.token\n +}\n +\n+diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir b/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n+--- stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n++++ stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n+@@ -576,16 +576,19 @@\n+ // ReshapeOp\n+ \n+ // CHECK-LABEL: func @reshape_fold\n+-func.func @reshape_fold() -> (tensor<1xi32>, tensor<2x2xi32>) {\n+-  %c0 = stablehlo.constant dense<2> : tensor<i32>\n++func.func @reshape_fold() -> (tensor<1xf32>, tensor<2x2xi32>, tensor<3x2xcomplex<f32>>) {\n++  %c0 = stablehlo.constant dense<2.0> : tensor<f32>\n+   %c1 = stablehlo.constant dense<[1, 2, 3, 4]> : tensor<4xi32>\n+-  %0 = stablehlo.reshape %c0 : (tensor<i32>) -> tensor<1xi32>\n++  %c2 = stablehlo.constant dense<(1.0,2.0)> : tensor<2x3xcomplex<f32>>\n++  %0 = stablehlo.reshape %c0 : (tensor<f32>) -> tensor<1xf32>\n+   %1 = stablehlo.reshape %c1 : (tensor<4xi32>) -> tensor<2x2xi32>\n+-\n+-  // CHECK-DAG:  [[CST1:%.+]] = stablehlo.constant dense<2> : tensor<1xi32>\n+-  // CHECK-DAG:  [[CST2:%.+]] = stablehlo.constant dense<{{\\[\\[1, 2\\], \\[3, 4\\]\\]}}> : tensor<2x2xi32>\n+-  // CHECK-NEXT: return [[CST1]], [[CST2]]\n+-  return %0, %1 : tensor<1xi32>, tensor<2x2xi32>\n++  %2 = stablehlo.reshape %c2 : (tensor<2x3xcomplex<f32>>) -> tensor<3x2xcomplex<f32>>\n++\n++  // CHECK-DAG:  [[RESULT0:%.+]] = stablehlo.constant dense<2.0{{.*}}> : tensor<1xf32>\n++  // CHECK-DAG:  [[RESULT1:%.+]] = stablehlo.constant dense<{{\\[\\[1, 2\\], \\[3, 4\\]\\]}}> : tensor<2x2xi32>\n++  // CHECK-DAG:  [[RESULT2:%.+]] = stablehlo.constant dense<(1.0{{.*}},2.0{{.*}})> : tensor<3x2xcomplex<f32>>\n++  // CHECK-NEXT: return [[RESULT0]], [[RESULT1]], [[RESULT2]]\n++  return %0, %1, %2 : tensor<1xf32>, tensor<2x2xi32>, tensor<3x2xcomplex<f32>>\n+ }\n+ \n+ // -----\n diff --ruN a/stablehlo/stablehlo/transforms/StablehloBroadcastLowering.cpp b/stablehlo/stablehlo/transforms/StablehloBroadcastLowering.cpp\n --- stablehlo/stablehlo/transforms/StablehloBroadcastLowering.cpp\n +++ stablehlo/stablehlo/transforms/StablehloBroadcastLowering.cpp\n@@ -878,4 +909,17 @@ diff --ruN a/stablehlo/stablehlo/transforms/StablehloBroadcastLowering.h b/stabl\n +}  // namespace mlir\n +\n +#endif  // STABLEHLO_TRANSFORMS_OPBROADCASTUTILS_H_\n+diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp b/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp\n+--- stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp\n++++ stablehlo/stablehlo/transforms/optimization/StablehloAggressiveFolder.cpp\n+@@ -1108,7 +1108,8 @@\n+                                 PatternRewriter& rewriter) const override {\n+     auto resultType = op.getType();\n+     if (failed(validateStaticShapeResult(rewriter, op, resultType)) ||\n+-        failed(validateShapeFoldDtype(rewriter, op, resultType)))\n++        failed(validateShapeFoldDtype(rewriter, op, resultType,\n++                                      /*allowComplex=*/true)))\n+       return failure();\n+ \n+     DenseElementsAttr attr;\n "
        }
    ],
    "stats": {
        "total": 44,
        "additions": 44,
        "deletions": 0
    }
}