{
    "author": "tensorflower-gardener",
    "message": "Add support for CustomKernelFusion in the legacy autotuner cache.\n\nPiperOrigin-RevId: 834254685",
    "sha": "fc23688e8243f67ecf8531c9a0354d17ab70db1d",
    "files": [
        {
            "sha": "536e39cc9339b2022febd0b77f7d28d639f16333",
            "filename": "third_party/xla/xla/backends/gpu/autotuner/legacy_cache.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fc23688e8243f67ecf8531c9a0354d17ab70db1d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Flegacy_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fc23688e8243f67ecf8531c9a0354d17ab70db1d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Flegacy_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Flegacy_cache.cc?ref=fc23688e8243f67ecf8531c9a0354d17ab70db1d",
            "patch": "@@ -117,6 +117,9 @@ std::optional<LegacyCache::Config> LegacyCache::GetConfig(\n   } else if (result.has_other()) {\n     config.codegen_backend_name = result.other().name();\n     config.backend_config = result.other().config();\n+  } else if (result.has_custom_kernel_fusion()) {\n+    config.codegen_backend_name = \"CustomKernel\";\n+    config.backend_config.PackFrom(result.custom_kernel_fusion());\n   } else {\n     return std::nullopt;\n   }\n@@ -133,6 +136,8 @@ std::optional<AutotuneResult> LegacyCache::GetAutotuneResult(\n     config.backend_config.UnpackTo(result.mutable_gemm());\n   } else if (config.codegen_backend_name == \"Cudnn\") {\n     config.backend_config.UnpackTo(result.mutable_algorithm());\n+  } else if (config.codegen_backend_name == \"CustomKernel\") {\n+    config.backend_config.UnpackTo(result.mutable_custom_kernel_fusion());\n   } else {\n     result.mutable_other()->set_name(config.codegen_backend_name);\n     *result.mutable_other()->mutable_config() = config.backend_config;"
        },
        {
            "sha": "86097bc05e7b63a4f749122655fcfb31a57bf546",
            "filename": "third_party/xla/xla/backends/gpu/autotuner/legacy_cache_test.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fc23688e8243f67ecf8531c9a0354d17ab70db1d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Flegacy_cache_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fc23688e8243f67ecf8531c9a0354d17ab70db1d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Flegacy_cache_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Flegacy_cache_test.cc?ref=fc23688e8243f67ecf8531c9a0354d17ab70db1d",
            "patch": "@@ -115,6 +115,13 @@ class LegacyCacheTest : public ::testing::Test {\n     return config;\n   }\n \n+  Config CreateDummyCustomKernelConfig() {\n+    Config config;\n+    config.codegen_backend_name = \"CustomKernel\";\n+    config.backend_config.PackFrom(AutotuneResult::CustomKernelFusionKey());\n+    return config;\n+  }\n+\n   Config CreateDummyBackendConfig() {\n     using DummyOtherConfig = AutotuneResult::CustomKernelFusionKey;\n     Config config;\n@@ -208,9 +215,17 @@ TEST_F(LegacyCacheTest, InsertAndLookupCudnn) {\n   EXPECT_THAT(cache.Lookup(instr.get()), Optional(ConfigEq(config)));\n }\n \n-TEST_F(LegacyCacheTest, InsertAndLookupOther) {\n+TEST_F(LegacyCacheTest, InsertAndLookupCustomKernel) {\n   auto cache = LegacyCache(test_dir_, mode_, device_desc_);\n   auto instr = CreateDummyInstr(\"hlo4\");\n+  Config config = CreateDummyCustomKernelConfig();\n+  TF_ASSERT_OK(cache.Insert(instr.get(), config));\n+  EXPECT_THAT(cache.Lookup(instr.get()), Optional(ConfigEq(config)));\n+}\n+\n+TEST_F(LegacyCacheTest, InsertAndLookupOther) {\n+  auto cache = LegacyCache(test_dir_, mode_, device_desc_);\n+  auto instr = CreateDummyInstr(\"hlo5\");\n   Config config = CreateDummyBackendConfig();\n \n   TF_ASSERT_OK(cache.Insert(instr.get(), config));"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 21,
        "deletions": 1
    }
}