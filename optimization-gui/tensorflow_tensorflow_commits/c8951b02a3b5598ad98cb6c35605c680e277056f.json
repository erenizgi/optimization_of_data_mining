{
    "author": "qukhan",
    "message": "Factorize XNNPack delegate macros in a common header.\n\nPiperOrigin-RevId: 845195313",
    "sha": "c8951b02a3b5598ad98cb6c35605c680e277056f",
    "files": [
        {
            "sha": "10d401078d0fae29a23b93e15dc2498c1036e057",
            "filename": "tensorflow/lite/delegates/xnnpack/BUILD",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD?ref=c8951b02a3b5598ad98cb6c35605c680e277056f",
            "patch": "@@ -333,6 +333,16 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"macros\",\n+    hdrs = [\"macros.h\"],\n+    compatible_with = get_compatible_with_portable(),\n+    copts = tflite_copts(),\n+    deps = [\n+        \"//tensorflow/lite:minimal_logging\",\n+    ],\n+)\n+\n flatbuffer_cc_library(\n     name = \"weight_cache_schema\",\n     srcs = [\"weight_cache_schema.fbs\"],\n@@ -350,8 +360,10 @@ cc_library(\n     compatible_with = get_compatible_with_portable(),\n     deps = [\n         \":file_util\",\n+        \":macros\",\n         \":mmap_handle\",\n         \":weight_cache_schema\",\n+        \"//tensorflow/lite:logger\",\n         \"//tensorflow/lite:minimal_logging\",\n         \"//tensorflow/lite/c:common\",\n         \"@XNNPACK\",\n@@ -387,8 +399,8 @@ cc_library(\n     compatible_with = get_compatible_with_portable(),\n     deps = [\n         \":file_util\",\n+        \":macros\",\n         \":windows_util\",\n-        \"//tensorflow/lite:minimal_logging\",\n     ],\n )\n "
        },
        {
            "sha": "ef2218ec621107e7cde481a7e58116e3a4b2f492",
            "filename": "tensorflow/lite/delegates/xnnpack/macros.h",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmacros.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmacros.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmacros.h?ref=c8951b02a3b5598ad98cb6c35605c680e277056f",
            "patch": "@@ -0,0 +1,48 @@\n+/* Copyright 2025 The TensorFlow Authors. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+#ifndef TENSORFLOW_LITE_DELEGATES_XNNPACK_MACROS_H_\n+#define TENSORFLOW_LITE_DELEGATES_XNNPACK_MACROS_H_\n+\n+#include <cstdio>\n+\n+#include \"tensorflow/lite/minimal_logging.h\"\n+\n+#define XNNPACK_LOG_LIMIT 4048\n+\n+#define XNNPACK_ABORT_CHECK(TEST, ...)                                   \\\n+  if (!(TEST)) {                                                         \\\n+    char msg[XNNPACK_LOG_LIMIT] = {0};                                   \\\n+    int bytes =                                                          \\\n+        snprintf(msg, XNNPACK_LOG_LIMIT, \"%s:%d: \", __FILE__, __LINE__); \\\n+    snprintf(msg + bytes, XNNPACK_LOG_LIMIT - bytes, \"\" __VA_ARGS__);    \\\n+    TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR, msg);                      \\\n+    std::abort();                                                        \\\n+  }\n+\n+#define XNNPACK_VAR_ARG_HEAD(FIRST, ...) FIRST\n+\n+#define XNNPACK_RETURN_CHECK(TEST, ...)                                    \\\n+  if (!(TEST)) {                                                           \\\n+    if (sizeof(XNNPACK_VAR_ARG_HEAD(\"\" __VA_ARGS__)) > sizeof(\"\")) {       \\\n+      char msg[XNNPACK_LOG_LIMIT] = {0};                                   \\\n+      int bytes =                                                          \\\n+          snprintf(msg, XNNPACK_LOG_LIMIT, \"%s:%d: \", __FILE__, __LINE__); \\\n+      snprintf(msg + bytes, XNNPACK_LOG_LIMIT - bytes, \"\" __VA_ARGS__);    \\\n+      TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR, msg);                      \\\n+    }                                                                      \\\n+    return false;                                                          \\\n+  }\n+\n+#endif  // TENSORFLOW_LITE_DELEGATES_XNNPACK_MACROS_H_"
        },
        {
            "sha": "92caf07fac811eacd1bc3a339a2709db4f999c47",
            "filename": "tensorflow/lite/delegates/xnnpack/mmap_handle.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 18,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc?ref=c8951b02a3b5598ad98cb6c35605c680e277056f",
            "patch": "@@ -32,20 +32,8 @@ limitations under the License.\n #include <cstring>\n \n #include \"tensorflow/lite/delegates/xnnpack/file_util.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/macros.h\"\n #include \"tensorflow/lite/delegates/xnnpack/windows_util.h\"\n-#include \"tensorflow/lite/logger.h\"\n-#include \"tensorflow/lite/minimal_logging.h\"\n-\n-#define XNNPACK_VAR_ARG_HEAD(FIRST, ...) FIRST\n-\n-#define XNNPACK_RETURN_CHECK(TEST, ...)                              \\\n-  if (!(TEST)) {                                                     \\\n-    if (sizeof(XNNPACK_VAR_ARG_HEAD(\"\" __VA_ARGS__)) > sizeof(\"\")) { \\\n-      TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR,                      \\\n-                      \"XNNPack weight cache: \" __VA_ARGS__);         \\\n-    }                                                                \\\n-    return false;                                                    \\\n-  }\n \n namespace tflite::xnnpack {\n \n@@ -100,9 +88,10 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n                        safe_path, strerror(errno));\n #else\n   struct stat file_stats;\n-  XNNPACK_RETURN_CHECK(fstat(fd.Value(), &file_stats) == 0,\n-                       \"could not access file stats to get size ('%s'): %s.\",\n-                       safe_path, strerror(errno));\n+  XNNPACK_RETURN_CHECK(\n+      fstat(fd.Value(), &file_stats) == 0,\n+      \"could not access file descriptor %d stats to get size ('%s'): %s.\",\n+      fd.Value(), safe_path, strerror(errno));\n #endif\n \n   // This will reset data_ and size_ on return until it is deactivated.\n@@ -149,8 +138,9 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n   data_ = static_cast<uint8_t*>(\n       mmap(/*addr=*/nullptr, size_ + offset_page_adjustment_, PROT_READ,\n            MAP_SHARED, fd.Value(), offset_ - offset_page_adjustment_));\n-  XNNPACK_RETURN_CHECK(data_ != MAP_FAILED, \"could not mmap file (%s): %s.\",\n-                       safe_path, strerror(errno));\n+  XNNPACK_RETURN_CHECK(data_ != MAP_FAILED,\n+                       \"could not mmap file descriptor %d (%s): %s.\",\n+                       fd.Value(), safe_path, strerror(errno));\n #endif\n   unmap_on_error.Deactivate();\n   return true;"
        },
        {
            "sha": "516a2ebbdeda9f37fb58982e778dcd52f51e5995",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 25,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8951b02a3b5598ad98cb6c35605c680e277056f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=c8951b02a3b5598ad98cb6c35605c680e277056f",
            "patch": "@@ -15,6 +15,9 @@ limitations under the License.\n #include \"tensorflow/lite/delegates/xnnpack/weight_cache.h\"\n \n #include <fcntl.h>\n+\n+#include \"tensorflow/lite/logger.h\"\n+#include \"tensorflow/lite/minimal_logging.h\"\n #if defined(_MSC_VER)\n #include <io.h>\n #define F_OK 0\n@@ -23,6 +26,7 @@ limitations under the License.\n #endif\n \n #include <cerrno>  // IWYU pragma: keep\n+#include <cinttypes>\n #include <cstddef>\n #include <cstdint>\n #include <cstdio>\n@@ -38,27 +42,9 @@ limitations under the License.\n #include \"flatbuffers/verifier.h\"  // from @flatbuffers\n #include \"tensorflow/lite/c/common.h\"\n #include \"tensorflow/lite/delegates/xnnpack/file_util.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/macros.h\"\n #include \"tensorflow/lite/delegates/xnnpack/mmap_handle.h\"\n #include \"tensorflow/lite/delegates/xnnpack/weight_cache_schema_generated.h\"\n-#include \"tensorflow/lite/logger.h\"\n-#include \"tensorflow/lite/minimal_logging.h\"\n-\n-#define XNNPACK_ABORT_CHECK(TEST, ...)                      \\\n-  if (!(TEST)) {                                            \\\n-    TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR, __VA_ARGS__); \\\n-    std::abort();                                           \\\n-  }\n-\n-#define XNNPACK_VAR_ARG_HEAD(FIRST, ...) FIRST\n-\n-#define XNNPACK_RETURN_CHECK(TEST, ...)                              \\\n-  if (!(TEST)) {                                                     \\\n-    if (sizeof(XNNPACK_VAR_ARG_HEAD(\"\" __VA_ARGS__)) > sizeof(\"\")) { \\\n-      TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR,                      \\\n-                      \"XNNPack weight cache: \" __VA_ARGS__);         \\\n-    }                                                                \\\n-    return false;                                                    \\\n-  }\n \n namespace tflite::xnnpack {\n \n@@ -409,8 +395,8 @@ bool MMapWeightCacheProvider::Load() {\n   }();\n \n   XNNPACK_RETURN_CHECK(header.version == XNNPackCacheHeader::kVersion,\n-                       \"incompatible header version. Got %zd, expected %zd. \"\n-                       \"Cache needs to be built again.\",\n+                       \"incompatible header version. Got %\" PRIu64\n+                       \", expected %\" PRIu64 \". Cache needs to be built again.\",\n                        header.version, XNNPackCacheHeader::kVersion);\n \n   XNNPACK_RETURN_CHECK(xnn_experimental_check_build_identifier(\n@@ -695,10 +681,10 @@ bool IsCompatibleCacheFile(const FileDescriptor& fd) {\n   XNNPackCacheHeader header;\n   XNNPACK_RETURN_CHECK(fd.Read(&header, sizeof(header)),\n                        \"Couldn't read file header.\");\n-  XNNPACK_RETURN_CHECK(\n-      header.version == XNNPackCacheHeader::kVersion,\n-      \"Cache header version is incompatible. Expected %llu, got %llu.\",\n-      XNNPackCacheHeader::kVersion, header.version);\n+  XNNPACK_RETURN_CHECK(header.version == XNNPackCacheHeader::kVersion,\n+                       \"Cache header version is incompatible. Expected %\" PRIu64\n+                       \", got %\" PRIu64 \".\",\n+                       XNNPackCacheHeader::kVersion, header.version);\n   XNNPACK_RETURN_CHECK(xnn_experimental_check_build_identifier(\n                            header.xnnpack_build_identifier,\n                            sizeof(header.xnnpack_build_identifier)),"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 80,
        "deletions": 44
    }
}