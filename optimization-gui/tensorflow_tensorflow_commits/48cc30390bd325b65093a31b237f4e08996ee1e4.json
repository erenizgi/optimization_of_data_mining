{
    "author": "bixia1",
    "message": "Avoid crash when a pairing Send Op for a Recv Op is not in the same computation.\n\nPiperOrigin-RevId: 811088442",
    "sha": "48cc30390bd325b65093a31b237f4e08996ee1e4",
    "files": [
        {
            "sha": "b6b7692137ff0f7eb1380c92c90317f39ab38bf3",
            "filename": "third_party/xla/xla/hlo/analysis/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/48cc30390bd325b65093a31b237f4e08996ee1e4/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/48cc30390bd325b65093a31b237f4e08996ee1e4/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD?ref=48cc30390bd325b65093a31b237f4e08996ee1e4",
            "patch": "@@ -316,6 +316,7 @@ xla_cc_test(\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_googletest//:gtest\",\n         \"@com_google_googletest//:gtest_main\","
        },
        {
            "sha": "6df1712d9d25dccadee7f057b85b3a6a58a00c23",
            "filename": "third_party/xla/xla/hlo/analysis/hlo_value_semantics_analysis.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/48cc30390bd325b65093a31b237f4e08996ee1e4/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_value_semantics_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/48cc30390bd325b65093a31b237f4e08996ee1e4/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_value_semantics_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_value_semantics_analysis.cc?ref=48cc30390bd325b65093a31b237f4e08996ee1e4",
            "patch": "@@ -534,8 +534,10 @@ absl::Status EinsumDepthAnalysis::HandleRecv(HloInstruction* recv) {\n   const ShapeTree<int>& depth_tree = GetDepthTreeOrDie(recv);\n   TF_ASSIGN_OR_RETURN(HloInstruction * send,\n                       send_recv_group_map_->GetMatchingSendOrRecv(recv));\n-  CHECK(send) << \"recv: \" << recv->name()\n-              << \" not found in send_recv_group_map: \" << recv->ToString();\n+  if (send == nullptr) {\n+    return absl::NotFoundError(\n+        absl::StrCat(\"Send pairing with Recv not found: \", recv->name()));\n+  }\n   ShapeTree<int>& send_depth = GetOrCreateDepthTree(send);\n   int max_depth = GetMaxDepth(depth_tree);\n   send_depth.ForEachMutableElement([&depth_tree, &send_depth, max_depth]("
        },
        {
            "sha": "c1ee35210fe12809da469ccf155fb7858eafb3f0",
            "filename": "third_party/xla/xla/hlo/analysis/hlo_value_semantics_analysis_test.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/48cc30390bd325b65093a31b237f4e08996ee1e4/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_value_semantics_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/48cc30390bd325b65093a31b237f4e08996ee1e4/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_value_semantics_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_value_semantics_analysis_test.cc?ref=48cc30390bd325b65093a31b237f4e08996ee1e4",
            "patch": "@@ -18,8 +18,10 @@ limitations under the License.\n #include <memory>\n #include <string>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n@@ -818,6 +820,34 @@ TEST_F(EinsumDepthAnalysisTest, SendWithRecv) {\n             0);\n }\n \n+TEST_F(EinsumDepthAnalysisTest, SendRecvNotPair) {\n+  const std::string module_str = R\"(\n+    HloModule foobar\n+\n+    ENTRY entry {\n+      arg_0 = s32[] parameter(0)\n+      arg_1 = token[] parameter(1)\n+\n+      send.0 = (s32[], u32[], token[]) send(s32[] arg_0, token[] arg_1), channel_id=3, is_host_transfer=true, sharding={{maximal device=0}, {maximal device=0}, {maximal device=0}}, frontend_attributes={_xla_host_transfer_handler_name=\"tf_rendezvous\", _xla_host_transfer_rendezvous=\"host_compute_channel_0_args_dtoh_0\"}\n+      send-done.1 = token[] send-done((s32[], u32[], token[]) send.0), channel_id=3, is_host_transfer=true, sharding={maximal device=0}, frontend_attributes={_xla_host_transfer_handler_name=\"tf_rendezvous\", _xla_host_transfer_rendezvous=\"host_compute_channel_0_args_dtoh_0\"}\n+\n+      recv.2 = (s32[], u32[], token[]) recv(token[] send-done.1), channel_id=4, is_host_transfer=true, sharding={{maximal device=0}, {maximal device=0}, {maximal device=0}}, frontend_attributes={_xla_host_transfer_handler_name=\"tf_rendezvous\", _xla_host_transfer_rendezvous=\"host_compute_channel_1_retvals_htod_0\"}\n+      recv-done.3 = (s32[], token[]) recv-done((s32[], u32[], token[]) recv.2), channel_id=4, is_host_transfer=true, sharding={{maximal device=0}, {maximal device=0}}, frontend_attributes={_xla_host_transfer_handler_name=\"tf_rendezvous\", _xla_host_transfer_rendezvous=\"host_compute_channel_1_retvals_htod_0\"}\n+\n+      get-tuple-element.4 = token[] get-tuple-element((s32[], token[]) recv-done.3), index=1, sharding={maximal device=0}\n+      ROOT %after-all.2 = token[] after-all(get-tuple-element.4), frontend_attributes={_xla_host_transfer_handler_name=\"tf_rendezvous\",_xla_host_transfer_rendezvous=\"host_compute_channel_1_retvals_htod_0\"}\n+    }\n+  )\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(module_str));\n+  auto status = EinsumDepthAnalysis::Run(*module->entry_computation(),\n+                                         SendRecvGroupMap(*module))\n+                    .status();\n+  EXPECT_FALSE(status.ok());\n+  EXPECT_THAT(status.message(),\n+              testing::HasSubstr(\"Send pairing with Recv not found\"));\n+}\n+\n TEST_F(EinsumDepthAnalysisTest, SparseDenseMatmulDepth) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kSparseDenseMatmulHlo,"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 35,
        "deletions": 2
    }
}