{
    "author": "chsigg",
    "message": "[xla:gpu] Skip autotuner configs if we fail to nest gemm fusion.\n\nWe do not want to route anything to the legacy emitter anymore.\n\nThe autotuner now verifies that `NestGemmFusion` successfully rewrites the HLO module and that the resulting fusion is of the expected Triton nested GEMM kind.\n\nPiperOrigin-RevId: 829425902",
    "sha": "f684f93c33a5c0ba7521ca45f27109f1d6ef7995",
    "files": [
        {
            "sha": "6d9577d558dcf1cf84f322b43b5b429358cba216",
            "filename": "third_party/xla/xla/service/gpu/autotuning/gemm_fusion_autotuner.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f684f93c33a5c0ba7521ca45f27109f1d6ef7995/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f684f93c33a5c0ba7521ca45f27109f1d6ef7995/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc?ref=f684f93c33a5c0ba7521ca45f27109f1d6ef7995",
            "patch": "@@ -343,6 +343,17 @@ absl::StatusOr<std::unique_ptr<HloModule>> TritonGemmAutotuneExtractor(\n \n   NestGemmFusion nest_gemm_fusion(gpu_device_info, symbolic_expr_context);\n   TF_RETURN_IF_ERROR(nest_gemm_fusion.Run(new_module.get()).status());\n+  bool is_legacy_gemm_disabled = absl::c_contains(\n+      debug_opts.xla_gpu_unsupported_generic_triton_emitter_features(),\n+      DebugOptions::GENERIC_TRITON_EMITTER_DISABLE_LEGACY_GEMM);\n+  bool is_triton_gemm_fusion =\n+      IsGpuFusionKind(*new_module->entry_computation()->root_instruction(),\n+                      kTritonGemmFusionKind);\n+  if (is_legacy_gemm_disabled && is_triton_gemm_fusion) {\n+    return absl::InternalError(\n+        absl::StrCat(\"Unexpected \", kTritonGemmFusionKind,\n+                     \" fusion: \", new_module->ToString()));\n+  }\n   return new_module;\n }\n "
        }
    ],
    "stats": {
        "total": 11,
        "additions": 11,
        "deletions": 0
    }
}