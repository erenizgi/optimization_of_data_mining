{
    "author": "tensorflower-gardener",
    "message": "Allow op cost analysis to be customizable for TFRT session\n\nPiperOrigin-RevId: 831125137",
    "sha": "d85da0bac3fb80b7b298b54a5298d0380848bd55",
    "files": [
        {
            "sha": "52a69150cae3fbe365c9e74dd7c6b3370d5cf4c9",
            "filename": "tensorflow/core/protobuf/config.proto",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Fcore%2Fprotobuf%2Fconfig.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Fcore%2Fprotobuf%2Fconfig.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fprotobuf%2Fconfig.proto?ref=d85da0bac3fb80b7b298b54a5298d0380848bd55",
            "patch": "@@ -791,7 +791,14 @@ message ConfigProto {\n     // directory.\n     string tf2xla_dump_dir = 35;\n \n-    // Next: 36\n+    // When set to true, the online op cost analysis will be enabled. This\n+    // will run the cost analysis once for the first model execution and\n+    // use the obtained cost to optimize subsequent executions.\n+    // Typically `stream_merge_threshold` should be tuned to set to a non-zero\n+    // value when this option is enabled.\n+    bool online_cost_analysis = 36;\n+\n+    // Next: 37\n   }\n \n   Experimental experimental = 16;"
        },
        {
            "sha": "0fc8f06b2b5e53ceb8b8faa71573eb98dec70c9f",
            "filename": "tensorflow/core/tfrt/tfrt_session/tfrt_session.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Fcore%2Ftfrt%2Ftfrt_session%2Ftfrt_session.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Fcore%2Ftfrt%2Ftfrt_session%2Ftfrt_session.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Ftfrt_session%2Ftfrt_session.cc?ref=d85da0bac3fb80b7b298b54a5298d0380848bd55",
            "patch": "@@ -80,6 +80,9 @@ limitations under the License.\n namespace tensorflow {\n namespace {\n \n+using CostAnalysisOptions =\n+    tensorflow::tfrt_stub::GraphExecutionOptions::CostAnalysisOptions;\n+\n // Wraps an `Eigen::ThreadPoolInterface` as a\n // `tensorflow::thread::ThreadPoolInterface`.\n class ThreadPoolInterfaceWrapper : public thread::ThreadPoolInterface {\n@@ -504,7 +507,12 @@ class TfrtSession : public tensorflow::Session {\n     compile_options.tpu_fuse_ops = tpu_use_tpu_runner_;\n     compile_options.hoist_invariant_ops = true;\n     compile_options.sink_in_invariant_ops = true;\n+\n     compile_options.cost_threshold = 1024;\n+    if (options_.config.experimental().stream_merge_threshold() > 0) {\n+      compile_options.cost_threshold =\n+          options_.config.experimental().stream_merge_threshold();\n+    }\n \n     if (use_gpu_) {\n       options.enable_tfrt_gpu = true;\n@@ -518,6 +526,10 @@ class TfrtSession : public tensorflow::Session {\n \n     options.model_metadata = options_.config.experimental().session_metadata();\n     options.enable_mlrt = enable_mlrt_;\n+    if (options_.config.experimental().online_cost_analysis()) {\n+      options.cost_analysis_options.version =\n+          CostAnalysisOptions::CostAnalysisVersion::kOnce;\n+    }\n \n     return options;\n   }"
        },
        {
            "sha": "2d357c24349ff5f278f22e15e3ff64237dc108e2",
            "filename": "tensorflow/tools/api/golden/v1/tensorflow.-config-proto.-experimental.pbtxt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Ftools%2Fapi%2Fgolden%2Fv1%2Ftensorflow.-config-proto.-experimental.pbtxt",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Ftools%2Fapi%2Fgolden%2Fv1%2Ftensorflow.-config-proto.-experimental.pbtxt",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Ftools%2Fapi%2Fgolden%2Fv1%2Ftensorflow.-config-proto.-experimental.pbtxt?ref=d85da0bac3fb80b7b298b54a5298d0380848bd55",
            "patch": "@@ -191,6 +191,12 @@ tf_proto {\n       label: LABEL_OPTIONAL\n       type: TYPE_STRING\n     }\n+    field {\n+      name: \"online_cost_analysis\"\n+      number: 36\n+      label: LABEL_OPTIONAL\n+      type: TYPE_BOOL\n+    }\n     enum_type {\n       name: \"MlirBridgeRollout\"\n       value {"
        },
        {
            "sha": "c94a936fb441e920cf0813c780950ff6ef274ce0",
            "filename": "tensorflow/tools/api/golden/v1/tensorflow.-config-proto.pbtxt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Ftools%2Fapi%2Fgolden%2Fv1%2Ftensorflow.-config-proto.pbtxt",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d85da0bac3fb80b7b298b54a5298d0380848bd55/tensorflow%2Ftools%2Fapi%2Fgolden%2Fv1%2Ftensorflow.-config-proto.pbtxt",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Ftools%2Fapi%2Fgolden%2Fv1%2Ftensorflow.-config-proto.pbtxt?ref=d85da0bac3fb80b7b298b54a5298d0380848bd55",
            "patch": "@@ -327,6 +327,12 @@ tf_proto {\n         label: LABEL_OPTIONAL\n         type: TYPE_STRING\n       }\n+      field {\n+        name: \"online_cost_analysis\"\n+        number: 36\n+        label: LABEL_OPTIONAL\n+        type: TYPE_BOOL\n+      }\n       enum_type {\n         name: \"MlirBridgeRollout\"\n         value {"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 32,
        "deletions": 1
    }
}