{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Remove FP8 datatype replacements in collective ops tests.\n\nPlaceholders were removed from HLO text in Sep 2024 and string replacement in no-op since then: https://github.com/openxla/xla/pull/16893. Doesn't look like it's causing any issues, so we can simply removed the replacement logic.\n\nPiperOrigin-RevId: 839253071",
    "sha": "43bfda6d370245780b99a80597c24341f28d1a38",
    "files": [
        {
            "sha": "e923f0334cf6e8fe0e881f5277bd297bb98a65a2",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 25,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/43bfda6d370245780b99a80597c24341f28d1a38/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/43bfda6d370245780b99a80597c24341f28d1a38/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc?ref=43bfda6d370245780b99a80597c24341f28d1a38",
            "patch": "@@ -13,7 +13,6 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include <array>\n #include <cmath>\n #include <cstdint>\n #include <memory>\n@@ -22,16 +21,13 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n-#include \"absl/container/flat_hash_map.h\"\n-#include \"absl/functional/any_invocable.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/match.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n-#include \"absl/strings/str_replace.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/array.h\"\n@@ -81,13 +77,6 @@ bool IsAsync(const HloInstruction* inst) {\n \n class CollectiveOpsTestE2E : public CollectiveOpsE2ETestBase {\n  public:\n-  CollectiveOpsTestE2E() {\n-    replacements_[kF8E4M3DatatypePlaceholder] =\n-        Capability().IsCuda() ? \"f8e4m3fn\" : \"f8e4m3fnuz\";\n-    replacements_[kF8E5M2DatatypePlaceholder] =\n-        Capability().IsCuda() ? \"f8e5m2\" : \"f8e5m2fnuz\";\n-  }\n-\n   bool HasFp8Support() {\n     if (Capability().IsCuda()) {\n       return Capability().cuda_compute_capability()->IsAtLeast(8, 9);\n@@ -123,13 +112,6 @@ class CollectiveOpsTestE2E : public CollectiveOpsE2ETestBase {\n       EXPECT_EQ(gemm_op->custom_call_target(), \"__cublas$lt$matmul$f8\");\n     }\n   }\n-\n- protected:\n-  absl::flat_hash_map<absl::string_view, absl::string_view> replacements_;\n-\n- private:\n-  static constexpr const char* kF8E4M3DatatypePlaceholder{\"<<F8E4M3>>\"};\n-  static constexpr const char* kF8E5M2DatatypePlaceholder{\"<<F8E5M2>>\"};\n };\n \n class AsyncCollectiveOps : public CollectiveOpsWithFlagsBase,\n@@ -1439,9 +1421,8 @@ ENTRY main {\n \n   // Disable the dot merger pass which can prevent the creation of FP8 GEMM\n   // Custom Calls.\n-  CollectiveOpsCompareWindowedNonWindowed(\n-      absl::StrReplaceAll(kModuleReplicatedStr, replacements_),\n-      /*disable_dot_merger=*/true);\n+  CollectiveOpsCompareWindowedNonWindowed(kModuleReplicatedStr,\n+                                          /*disable_dot_merger=*/true);\n \n   // Verify the creation of FP8 GEMM Custom Calls on Hopper and newer\n   // architectures.\n@@ -1451,8 +1432,7 @@ ENTRY main {\n   opts.set_xla_gpu_graph_min_graph_size(200);\n   opts.set_xla_gpu_enable_triton_gemm(false);\n   opts.add_xla_disable_hlo_passes(\"dot-merger\");\n-  CollectiveOpsVerifyF8Matmul(\n-      absl::StrReplaceAll(kModuleReplicatedStr, replacements_), opts);\n+  CollectiveOpsVerifyF8Matmul(kModuleReplicatedStr, opts);\n }\n \n TEST_F(CollectiveOpsTestE2EWindowedNonWindowed,\n@@ -1693,8 +1673,7 @@ ENTRY entry {\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n   auto opts = GetDebugOptionsForTest();\n   opts.set_xla_gpu_enable_triton_gemm(false);\n-  CollectiveOpsVerifyF8Matmul(\n-      absl::StrReplaceAll(kModuleReplicatedStr, replacements_), opts);\n+  CollectiveOpsVerifyF8Matmul(kModuleReplicatedStr, opts);\n }\n \n // E2E tests comparing the results with and without pipelining of collectives."
        }
    ],
    "stats": {
        "total": 29,
        "additions": 4,
        "deletions": 25
    }
}