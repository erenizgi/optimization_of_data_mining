{
    "author": "metaflow",
    "message": "[XLA:GPU] do not fuse dynamic slice\n\nDynamic slice op is not supported by the new emitter and that seems to\nbe the only reason why we still sometimes switch bac to the legacy\nemitter. While it is a regression we expect that performance loss will\nbe acceptable and we are actively working on adding support of the\ndynamic slice op to the new emitter.\n\nPiperOrigin-RevId: 832958154",
    "sha": "d5d074c4e81e063b8bcc617f42e4adda005899af",
    "files": [
        {
            "sha": "5d09574131c0e7975fc7fc6ddeef188334b6480c",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter_device_legacy_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5d074c4e81e063b8bcc617f42e4adda005899af/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_legacy_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5d074c4e81e063b8bcc617f42e4adda005899af/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_legacy_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_legacy_test.cc?ref=d5d074c4e81e063b8bcc617f42e4adda005899af",
            "patch": "@@ -17,7 +17,6 @@ limitations under the License.\n #include <memory>\n #include <string>\n #include <utility>\n-#include <variant>\n #include <vector>\n \n #include <gmock/gmock.h>\n@@ -1566,7 +1565,9 @@ ENTRY e {\n   EXPECT_TRUE(RunAndCompare(hlo_text, ErrorSpec{/*aabs=*/1e-6, /*arel=*/1e-6}));\n }\n \n-TEST_F(TritonGemmTest, DynamicSliceIsSupportedInLhsEndToEnd) {\n+// Dynamic slice is not supported by the generic Triton emitter yet and disabled\n+// in the triton gemm fusion pass.\n+TEST_F(TritonGemmTest, DISABLED_DynamicSliceIsSupportedInLhsEndToEnd) {\n   // The select is used to restrict the start index to values that make sense.\n   // If it was constant, then the dynamic-slice would be optimized to slice. It\n   // is not strictly needed, because we also support clamping the indices."
        },
        {
            "sha": "a37fdb77e97be36799f5ee6a205199e89b92e19e",
            "filename": "third_party/xla/xla/service/gpu/transforms/gemm_fusion.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5d074c4e81e063b8bcc617f42e4adda005899af/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5d074c4e81e063b8bcc617f42e4adda005899af/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_fusion.cc?ref=d5d074c4e81e063b8bcc617f42e4adda005899af",
            "patch": "@@ -408,6 +408,18 @@ FusionPlanAndRequirements BuildFusionPlanTowardOperands(\n       continue;\n     }\n \n+    // TODO(b/393299275): this check cannot be replaced by a\n+    // `IsTritonSupportedComputation` because we will do some rewrites\n+    // later that might change the decision. For example 'scaled-dot-rewriter'\n+    // replaces unsupported F8E8M0FNU with u8. We should have a more principled\n+    // way check if we will be able to emit the triton code for the fusion.\n+    if (original_hlo.opcode() == HloOpcode::kDynamicSlice) {\n+      // TODO(b/417172838): support dynamic slice op.\n+      fusion_builder.SetShouldFuseNode(node_id, false);\n+      LOG(INFO) << \"Not fusing dynamic slice: \" << original_hlo.ToString();\n+      continue;\n+    }\n+\n     auto opt_result = GetOperandDimOrdersAndCombinedReqsIfProfitable(\n         original_hlo, dim_order, properties, gpu_version, combined_reqs);\n     if (!opt_result.has_value()) {"
        },
        {
            "sha": "a0a0e9f759e5920e413a1e71caf2e8811398b89c",
            "filename": "third_party/xla/xla/service/gpu/transforms/gemm_fusion_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5d074c4e81e063b8bcc617f42e4adda005899af/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_fusion_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5d074c4e81e063b8bcc617f42e4adda005899af/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_fusion_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_fusion_test.cc?ref=d5d074c4e81e063b8bcc617f42e4adda005899af",
            "patch": "@@ -264,7 +264,8 @@ ENTRY e {\n   EXPECT_FALSE(GemmFusion(cc).Run(module.get()).value());\n }\n \n-TEST_F(GemmFusionTest, DynamicSliceIsFused) {\n+// TODO(b/417172838): support dynamic slice op.\n+TEST_F(GemmFusionTest, DISABLED_DynamicSliceIsFused) {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n                           ParseAndReturnVerifiedModule(R\"(\n ENTRY e {\n@@ -288,7 +289,8 @@ ENTRY e {\n                                     m::Parameter(), m::Constant()))));\n }\n \n-TEST_F(GemmFusionTest, DynamicSlicesAreFusedEvenIfTheyShareIndices) {\n+// TODO(b/417172838): support dynamic slice op.\n+TEST_F(GemmFusionTest, DISABLED_DynamicSlicesAreFusedEvenIfTheyShareIndices) {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n                           ParseAndReturnVerifiedModule(R\"(\n ENTRY e {\n@@ -319,7 +321,8 @@ ENTRY e {\n                             m::Parameter(), m::Parameter()))));\n }\n \n-TEST_F(GemmFusionTest, DoNotFuseDynamicSliceOfNonMajorFragments) {\n+// TODO(b/417172838): support dynamic slice op.\n+TEST_F(GemmFusionTest, DISABLED_DoNotFuseDynamicSliceOfNonMajorFragments) {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n                           ParseAndReturnVerifiedModule(R\"(\n ENTRY e {\n@@ -338,7 +341,9 @@ ENTRY e {\n   EXPECT_FALSE(GemmFusion(cc).Run(module.get()).value());\n }\n \n-TEST_F(GemmFusionTest, CanFuseDynamicSliceOfContractingDimIfItIsMajor) {\n+// TODO(b/417172838): support dynamic slice op.\n+TEST_F(GemmFusionTest,\n+       DISABLED_CanFuseDynamicSliceOfContractingDimIfItIsMajor) {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n                           ParseAndReturnVerifiedModule(R\"(\n ENTRY e {"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 24,
        "deletions": 6
    }
}