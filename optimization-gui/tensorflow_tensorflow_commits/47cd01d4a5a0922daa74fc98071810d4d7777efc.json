{
    "author": "mmakevic-amd",
    "message": "PR #32960: [ROCm] Refactor testing scripts\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32960\n\nüìù Summary of Changes\n(Partially) upstreaming changes from: https://github.com/ROCm/xla/pull/323, https://github.com/ROCm/xla/commit/9d358b9b26961309349dbcc228b4dda2f56d885f, and https://github.com/ROCm/xla/pull/385. It skips some asan/tsan changes for now.\n\nüéØ Justification\nThese changes are ROCm specific and helps with rocm internal CI validation pipelines.\n\nüöÄ Kind of Contribution\nüêõ Bug Fix, ‚ôªÔ∏è Cleanup, üß™ Tests\n\nüìä Benchmark (for Performance Improvements)\n/\n\nüß™ Unit Tests:\n/\n\nüß™ Execution Tests:\n/\n\nCopybara import of the project:\n\n--\n804ff1b6a6fbba86a3e0a09d739179a4eb4f197d by Milica Makevic <Milica.Makevic@amd.com>:\n\nAdd missing cuda-only tag to cuda test\n\n--\n44ce7a2d56c9f0c80405447f431ae1e5a33f42e1 by Milica Makevic <Milica.Makevic@amd.com>:\n\nRefactor test scripts\n\n--\nfb783c968e9d2ff5d92357908d99e4952235c2bc by Milica Makevic <Milica.Makevic@amd.com>:\n\nCover more mgpu tests\n\n--\n1f53712274f76202241bd3631dbf065826c0b960 by Milica Makevic <Milica.Makevic@amd.com>:\n\nSwitch from rocm_gcc to rocm_ci for sgpu tests\n\n--\n00e0c8ee2a763680f5a3665dab62202ab230731d by Milica Makevic <Milica.Makevic@amd.com>:\n\nChanging file permissions\n\n--\n003c062a8900c12b73c0972e8d406f2661a27aba by Milica Makevic <Milica.Makevic@amd.com>:\n\nRemove unnecessary import\n\n--\n214599355f40f1b65e0540daf0b9829d2c950115 by Harsha HS <Harsha.HavanurShamsundara@amd.com>:\n\nAdd license header\n\nMerging this change closes #32960\n\nPiperOrigin-RevId: 822245565",
    "sha": "47cd01d4a5a0922daa74fc98071810d4d7777efc",
    "files": [
        {
            "sha": "ed03b599377c4da9c86eea051174d2f836c1b73a",
            "filename": "third_party/xla/build_tools/rocm/rocm_tag_filters.sh",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_tag_filters.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_tag_filters.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_tag_filters.sh?ref=47cd01d4a5a0922daa74fc98071810d4d7777efc",
            "patch": "@@ -0,0 +1,39 @@\n+#!/usr/bin/env bash\n+# Copyright 2024 The TensorFlow Authors. All Rights Reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+# ==============================================================================\n+\n+\n+TAG_FILTERS=(\n+    -no_gpu\n+    -requires-gpu-intel\n+    -requires-gpu-nvidia\n+    -cuda-only\n+    -oneapi-only\n+    -requires-gpu-sm60\n+    -requires-gpu-sm60-only\n+    -requires-gpu-sm70\n+    -requires-gpu-sm70-only\n+    -requires-gpu-sm80\n+    -requires-gpu-sm80-only\n+    -requires-gpu-sm86\n+    -requires-gpu-sm86-only\n+    -requires-gpu-sm89\n+    -requires-gpu-sm89-only\n+    -requires-gpu-sm90\n+    -requires-gpu-sm90-only\n+)\n+\n+echo $(IFS=, ; echo \"${TAG_FILTERS[*]}\")"
        },
        {
            "sha": "1dbcb154219de22333f2a775bd4b034807283f0e",
            "filename": "third_party/xla/build_tools/rocm/rocm_xla.bazelrc",
            "status": "modified",
            "additions": 45,
            "deletions": 1,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc?ref=47cd01d4a5a0922daa74fc98071810d4d7777efc",
            "patch": "@@ -1,5 +1,4 @@\n # Test-related settings.\n-try-import /usertools/rocm.bazelrc\n \n build:rocm_dev --remote_upload_local_results=false\n build:rocm_dev --remote_cache=\"https://wardite.cluster.engflow.com\"\n@@ -30,3 +29,48 @@ build:tsan --//build_tools/rocm:sanitizer=tsan\n build:asan --test_env=ASAN_OPTIONS=suppressions=build_tools/rocm/asan_ignore_list.txt:use_sigaltstack=0\n build:asan --test_env=LSAN_OPTIONS=suppressions=build_tools/rocm/lsan_ignore_list.txt:use_sigaltstack=0\n build:asan --//build_tools/rocm:sanitizer=asan\n+\n+test:xla_sgpu -- \\\n+//xla/... \\\n+-//xla/backends/gpu/collectives:gpu_clique_key_test \\\n+-//xla/backends/gpu/collectives:nccl_communicator_test \\\n+-//xla/service:collective_ops_utils_test \\\n+-//xla/service:collective_pipeliner_test \\\n+-//xla/service:collective_permute_cycle_test \\\n+-//xla/service:batched_gather_scatter_normalizer_test \\\n+-//xla/service:all_reduce_simplifier_test \\\n+-//xla/service:all_gather_simplifier_test \\\n+-//xla/service:reduce_scatter_decomposer_test \\\n+-//xla/service:reduce_scatter_reassociate_test \\\n+-//xla/service:reduce_scatter_combiner_test \\\n+-//xla/service:scatter_simplifier_test \\\n+-//xla/service:sharding_propagation_test \\\n+-//xla/service:sharding_remover_test \\\n+-//xla/service:p2p_schedule_preparation_test \\\n+-//xla/pjrt/distributed:topology_util_test \\\n+-//xla/pjrt/distributed:client_server_test\n+\n+test:xla_mgpu -- \\\n+//xla/tests:collective_ops_e2e_test \\\n+//xla/tests:collective_ops_test \\\n+//xla/tests:collective_pipeline_parallelism_test \\\n+//xla/tests:replicated_io_feed_test \\\n+//xla/backends/gpu/collectives:gpu_clique_key_test \\\n+//xla/backends/gpu/collectives:nccl_communicator_test \\\n+//xla/backends/gpu/runtime:all_reduce_test \\\n+//xla/service:collective_ops_utils_test \\\n+//xla/service:collective_pipeliner_test \\\n+//xla/service:collective_permute_cycle_test \\\n+//xla/service:batched_gather_scatter_normalizer_test \\\n+//xla/service:all_reduce_simplifier_test \\\n+//xla/service:all_gather_simplifier_test \\\n+//xla/service:reduce_scatter_decomposer_test \\\n+//xla/service:reduce_scatter_reassociate_test \\\n+//xla/service:reduce_scatter_combiner_test \\\n+//xla/service:scatter_simplifier_test \\\n+//xla/service:sharding_propagation_test \\\n+//xla/service:sharding_remover_test \\\n+//xla/service:p2p_schedule_preparation_test \\\n+//xla/tools/multihost_hlo_runner:functional_hlo_runner_test \\\n+//xla/pjrt/distributed:topology_util_test \\\n+//xla/pjrt/distributed:client_server_test \n\\ No newline at end of file"
        },
        {
            "sha": "8df56376d92a52f780b7d34586d829527ab52821",
            "filename": "third_party/xla/build_tools/rocm/run_xla.sh",
            "status": "modified",
            "additions": 16,
            "deletions": 25,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla.sh?ref=47cd01d4a5a0922daa74fc98071810d4d7777efc",
            "patch": "@@ -37,30 +37,23 @@ echo \"\"\n echo \"Bazel will use ${N_BUILD_JOBS} concurrent build job(s) and ${N_TEST_JOBS} concurrent test job(s) for gpu ${AMD_GPU_GFX_ID}.\"\n echo \"\"\n \n-# First positional argument (if any) specifies the ROCM_INSTALL_DIR\n-if [[ -n $1 ]]; then\n-    ROCM_INSTALL_DIR=$1\n-else\n-    if [[ -z \"${ROCM_PATH}\" ]]; then\n-        ROCM_INSTALL_DIR=/opt/rocm/\n-    else\n-        ROCM_INSTALL_DIR=$ROCM_PATH\n-    fi\n-fi\n-\n export PYTHON_BIN_PATH=`which python3`\n export TF_NEED_ROCM=1\n-export ROCM_PATH=$ROCM_INSTALL_DIR\n-TAGS_FILTER=\"gpu,requires-gpu-amd,-multi_gpu,-requires-gpu-nvidia,-requires-gpu-intel,-no_oss,-oss_excluded,-oss_serial,-no_gpu,-cuda-only,-oneapi-only\"\n-UNSUPPORTED_GPU_TAGS=\"$(echo -requires-gpu-sm{60,70,80,86,89,90}{,-only})\"\n-TAGS_FILTER=\"${TAGS_FILTER},${UNSUPPORTED_GPU_TAGS// /,}\"\n+export ROCM_PATH=/opt/rocm\n+\n+SCRIPT_DIR=$(realpath $(dirname $0))\n+TAG_FILTERS=$($SCRIPT_DIR/rocm_tag_filters.sh),gpu,-multi_gpu,-multi_gpu_h100,requires-gpu-amd,,-skip_rocprofiler_sdk,-no_oss,-oss_excluded,-oss_serial\n+\n+if [ ! -d /tf/pkg ]; then\n+\tmkdir -p /tf/pkg\n+fi\n \n-bazel \\\n-    test \\\n-    --define xnn_enable_avxvnniint8=false --define xnn_enable_avx512fp16=false \\\n-    --config=rocm_gcc \\\n-    --build_tag_filters=${TAGS_FILTER} \\\n-    --test_tag_filters=${TAGS_FILTER} \\\n+bazel --bazelrc=build_tools/rocm/rocm_xla.bazelrc test \\\n+    --config=rocm_ci \\\n+    --config=xla_sgpu \\\n+    --build_tag_filters=$TAG_FILTERS \\\n+    --test_tag_filters=$TAG_FILTERS \\\n+    --profile=/tf/pkg/profile.json.gz \\\n     --test_timeout=920,2400,7200,9600 \\\n     --test_sharding_strategy=disabled \\\n     --test_output=errors \\\n@@ -70,8 +63,6 @@ bazel \\\n     --test_env=TF_TESTS_PER_GPU=$TF_TESTS_PER_GPU \\\n     --test_env=TF_GPU_COUNT=$TF_GPU_COUNT \\\n     --action_env=TF_ROCM_AMDGPU_TARGETS=${AMD_GPU_GFX_ID} \\\n-    --action_env=XLA_FLAGS=--xla_gpu_force_compilation_parallelism=16 \\\n-    --action_env=XLA_FLAGS=--xla_gpu_enable_llvm_module_compilation_parallelism=true \\\n+    --action_env=XLA_FLAGS=\"--xla_gpu_enable_llvm_module_compilation_parallelism=true --xla_gpu_force_compilation_parallelism=16\" \\\n     --repo_env=\"ROCM_PATH=$ROCM_PATH\" \\\n-    --run_under=//build_tools/ci:parallel_gpu_execute \\\n-    -- //xla/...\n+    --run_under=//build_tools/ci:parallel_gpu_execute"
        },
        {
            "sha": "3a02426e2140be440553d7e538708cdd1e956321",
            "filename": "third_party/xla/build_tools/rocm/run_xla_ci_build.sh",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh?ref=47cd01d4a5a0922daa74fc98071810d4d7777efc",
            "patch": "@@ -18,16 +18,22 @@\n set -e\n set -x\n \n+SCRIPT_DIR=$(realpath $(dirname $0))\n+TAG_FILTERS=$($SCRIPT_DIR/rocm_tag_filters.sh),gpu,-multi_gpu,-multi_gpu_h100,requires-gpu-amd,,-skip_rocprofiler_sdk,-no_oss,-oss_excluded,-oss_serial\n+\n+if [ ! -d /tf/pkg ]; then\n+\tmkdir -p /tf/pkg\n+fi\n+\n SCRIPT_DIR=$(dirname $0)\n bazel --bazelrc=\"$SCRIPT_DIR/rocm_xla.bazelrc\" test \\\n \t\"$@\" \\\n-\t--test_tag_filters=gpu,requires-gpu-amd,-requires-gpu-nvidia,-requires-gpu-intel,-no_oss,-oss_excluded,-oss_serial,-no_gpu,-no_rocm,-requires-gpu-sm60,-requires-gpu-sm60-only,-requires-gpu-sm70,-requires-gpu-sm70-only,-requires-gpu-sm80,-requires-gpu-sm80-only,-requires-gpu-sm86,-requires-gpu-sm86-only,-requires-gpu-sm89,-requires-gpu-sm89-only,-requires-gpu-sm90,-requires-gpu-sm90-only \\\n-\t--build_tag_filters=gpu,requires-gpu-amd,-requires-gpu-nvidia,-requires-gpu-intel,-no_oss,-oss_excluded,-oss_serial,-no_gpu,-no_rocm,-requires-gpu-sm60,-requires-gpu-sm60-only,-requires-gpu-sm70,-requires-gpu-sm70-only,-requires-gpu-sm80,-requires-gpu-sm80-only,-requires-gpu-sm86,-requires-gpu-sm86-only,-requires-gpu-sm89,-requires-gpu-sm89-only,-requires-gpu-sm90,-requires-gpu-sm90-only \\\n+\t--build_tag_filters=$TAG_FILTERS \\\n+    --test_tag_filters=$TAG_FILTERS \\\n \t--profile=/tf/pkg/profile.json.gz \\\n \t--keep_going \\\n \t--test_env=TF_TESTS_PER_GPU=1 \\\n-\t--action_env=XLA_FLAGS=--xla_gpu_force_compilation_parallelism=16 \\\n-\t--action_env=XLA_FLAGS=--xla_gpu_enable_llvm_module_compilation_parallelism=true \\\n+\t--action_env=XLA_FLAGS=\"--xla_gpu_enable_llvm_module_compilation_parallelism=true --xla_gpu_force_compilation_parallelism=16\" \\\n \t--test_output=errors \\\n \t--local_test_jobs=2 \\\n \t--run_under=//build_tools/rocm:parallel_gpu_execute"
        },
        {
            "sha": "1ecf94167bee04bfcbc75496e7b59bc8a337bece",
            "filename": "third_party/xla/build_tools/rocm/run_xla_multi_gpu.sh",
            "status": "modified",
            "additions": 15,
            "deletions": 31,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_multi_gpu.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_multi_gpu.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_multi_gpu.sh?ref=47cd01d4a5a0922daa74fc98071810d4d7777efc",
            "patch": "@@ -53,31 +53,23 @@ echo \"\"\n echo \"Bazel will use ${N_BUILD_JOBS} concurrent build job(s) and ${N_TEST_JOBS} concurrent test job(s) for gpu ${AMD_GPU_GFX_ID}.\"\n echo \"\"\n \n-# First positional argument (if any) specifies the ROCM_INSTALL_DIR\n-if [[ -n $1 ]]; then\n-    ROCM_INSTALL_DIR=$1\n-else\n-    if [[ -z \"${ROCM_PATH}\" ]]; then\n-        ROCM_INSTALL_DIR=/opt/rocm/\n-    else\n-        ROCM_INSTALL_DIR=$ROCM_PATH\n-    fi\n-fi\n-\n export PYTHON_BIN_PATH=`which python3`\n export TF_NEED_ROCM=1\n-export ROCM_PATH=$ROCM_INSTALL_DIR\n-TAGS_FILTER=\"-requires-gpu-nvidia,-oss_excluded,-oss_serial\"\n-UNSUPPORTED_GPU_TAGS=\"$(echo -requires-gpu-sm{60,70,80,86,89,90}{,-only})\"\n-TAGS_FILTER=\"${TAGS_FILTER},${UNSUPPORTED_GPU_TAGS// /,}\"\n+export ROCM_PATH=/opt/rocm/\n+\n+SCRIPT_DIR=$(realpath $(dirname $0))\n+TAG_FILTERS=\"$($SCRIPT_DIR/rocm_tag_filters.sh)\"\n+\n+if [ ! -d /tf/pkg ]; then\n+\tmkdir -p /tf/pkg\n+fi\n \n-bazel \\\n-    test \\\n-    --define xnn_enable_avxvnniint8=false \\\n-    --define xnn_enable_avx512fp16=false \\\n-    --config=rocm_gcc \\\n-    --build_tag_filters=${TAGS_FILTER} \\\n-    --test_tag_filters=${TAGS_FILTER} \\\n+bazel --bazelrc=build_tools/rocm/rocm_xla.bazelrc test \\\n+    --config=rocm_ci \\\n+    --config=xla_mgpu \\\n+    --build_tag_filters=${TAG_FILTERS} \\\n+    --test_tag_filters=${TAG_FILTERS} \\\n+    --profile=/tf/pkg/profile.json.gz \\\n     --test_timeout=920,2400,7200,9600 \\\n     --test_sharding_strategy=disabled \\\n     --test_output=errors \\\n@@ -90,12 +82,4 @@ bazel \\\n     --action_env=XLA_FLAGS=--xla_gpu_force_compilation_parallelism=16 \\\n     --action_env=XLA_FLAGS=--xla_gpu_enable_llvm_module_compilation_parallelism=true \\\n     --action_env=NCCL_MAX_NCHANNELS=1 \\\n-    --repo_env=\"ROCM_PATH=$ROCM_PATH\" \\\n-    -- //xla/tests:collective_ops_e2e_test \\\n-       //xla/tests:collective_ops_test \\\n-       //xla/tests:collective_pipeline_parallelism_test \\\n-       //xla/tests:replicated_io_feed_test \\\n-       //xla/tools/multihost_hlo_runner:functional_hlo_runner_test \\\n-       //xla/pjrt/distributed:topology_util_test \\\n-       //xla/pjrt/distributed:client_server_test \\\n-       //xla/backends/gpu/runtime:all_reduce_test\n+    --repo_env=\"ROCM_PATH=$ROCM_PATH\""
        },
        {
            "sha": "f787303b517ff6f9dba3078e887058051f1a3518",
            "filename": "third_party/xla/xla/backends/profiler/gpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/47cd01d4a5a0922daa74fc98071810d4d7777efc/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD?ref=47cd01d4a5a0922daa74fc98071810d4d7777efc",
            "patch": "@@ -166,6 +166,7 @@ cuda_library(\n     testonly = 1,\n     srcs = [\"cuda_test.cu.cc\"],\n     hdrs = [\"cuda_test.h\"],\n+    tags = [\"cuda-only\"],\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \"@com_google_googletest//:gtest_for_library\","
        }
    ],
    "stats": {
        "total": 187,
        "additions": 126,
        "deletions": 61
    }
}