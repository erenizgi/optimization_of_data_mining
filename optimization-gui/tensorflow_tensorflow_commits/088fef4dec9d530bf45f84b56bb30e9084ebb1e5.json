{
    "author": "tensorflower-gardener",
    "message": "Return error if trying to transfer a poisoned buffer\n\nPiperOrigin-RevId: 834483629",
    "sha": "088fef4dec9d530bf45f84b56bb30e9084ebb1e5",
    "files": [
        {
            "sha": "006e166bbaee83c233778e530da8640ec4d3ac6a",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/088fef4dec9d530bf45f84b56bb30e9084ebb1e5/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/088fef4dec9d530bf45f84b56bb30e9084ebb1e5/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2FBUILD?ref=088fef4dec9d530bf45f84b56bb30e9084ebb1e5",
            "patch": "@@ -349,6 +349,7 @@ xla_cc_test(\n         \"//xla/tsl/concurrency:async_value\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/time\",\n         \"@com_google_absl//absl/types:span\","
        },
        {
            "sha": "57c55532710cb99f83bbe2cd033707bdc0662334",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 17,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/088fef4dec9d530bf45f84b56bb30e9084ebb1e5/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/088fef4dec9d530bf45f84b56bb30e9084ebb1e5/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc?ref=088fef4dec9d530bf45f84b56bb30e9084ebb1e5",
            "patch": "@@ -795,11 +795,23 @@ absl::StatusOr<std::unique_ptr<PjRtBuffer>> TfrtGpuBuffer::CopyToMemorySpace(\n        src_device(gpu_src_device), dst_device(gpu_dst_device),\n        src_usage_event(src_usage_event.CopyRef()),\n        dst_usage_event(dst_usage_event.CopyRef())]() {\n+        MarkGpuEventReadyOnExit ready_on_exit_src(std::move(src_usage_event));\n+        MarkGpuEventReadyOnExit ready_on_exit_dst(std::move(dst_usage_event));\n+\n+        // If the source buffer has an error, propagate it to the destination\n+        // buffer.\n+        if (const absl::Status* error =\n+                src_definition_event.GetErrorIfPresent()) {\n+          dst_definition_event.SetError(*error);\n+          return;\n+        }\n+\n         VLOG(3) << \"Request to transfer D2D from \"\n                 << src_buffer->buffer().opaque() << \" on device \"\n                 << src_device->id() << \" to \"\n                 << allocated_dst_buffer->buffer().opaque() << \" on device \"\n                 << dst_device->id();\n+\n         tsl::profiler::TraceMe trace([&] {\n           return tsl::profiler::TraceMeEncode(\n               \"CopyToMemorySpace::D2D_copy\",\n@@ -810,23 +822,6 @@ absl::StatusOr<std::unique_ptr<PjRtBuffer>> TfrtGpuBuffer::CopyToMemorySpace(\n               });\n         });\n \n-        MarkGpuEventReadyOnExit ready_on_exit_src(std::move(src_usage_event));\n-        MarkGpuEventReadyOnExit ready_on_exit_dst(std::move(dst_usage_event));\n-\n-        if (const absl::Status* error =\n-                dst_definition_event.GetErrorIfPresent()) {\n-          allocated_dst_buffer.SetError(*error);\n-          dst_definition_event.SetError(*error);\n-          return;\n-        }\n-\n-        if (const absl::Status* error =\n-                src_definition_event.GetErrorIfPresent()) {\n-          allocated_dst_buffer.SetError(*error);\n-          dst_definition_event.SetError(*error);\n-          return;\n-        }\n-\n         auto stream = dst_device->stream();\n \n         se::DeviceMemoryBase dst(allocated_dst_buffer->buffer());"
        },
        {
            "sha": "174709b911731667e98488c64d1555f4b80b36b8",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/088fef4dec9d530bf45f84b56bb30e9084ebb1e5/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/088fef4dec9d530bf45f84b56bb30e9084ebb1e5/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer_test.cc?ref=088fef4dec9d530bf45f84b56bb30e9084ebb1e5",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n@@ -309,6 +310,27 @@ TEST(TfrtGpuBufferTest, IsDeviceShapeWhenStaticShape) {\n   }\n }\n \n+TEST(TfrtGpuBufferTest, CopyPoisonedBuffer) {\n+  TF_ASSERT_OK_AND_ASSIGN(auto client, GetTfrtGpuClient(GpuClientOptions()));\n+  Shape shape = ShapeUtil::MakeShape(F32, {8});\n+  const char* errmsg = \"injected error\";\n+\n+  for (auto src_memory_space : client->memory_spaces()) {\n+    for (auto dst_memory_space : client->memory_spaces()) {\n+      TF_ASSERT_OK_AND_ASSIGN(auto src_buffer, client->CreateErrorBuffer(\n+                                                   absl::InternalError(errmsg),\n+                                                   shape, src_memory_space));\n+\n+      TF_ASSERT_OK_AND_ASSIGN(auto dst_buffer,\n+                              src_buffer->CopyToMemorySpace(dst_memory_space));\n+\n+      EXPECT_THAT(\n+          dst_buffer->GetReadyFuture().Await(),\n+          testing::status::StatusIs(absl::StatusCode::kInternal, errmsg));\n+    }\n+  }\n+}\n+\n // TODO: b/382117736 - Add test for logical shape when shape is dynamic after\n // TfrtGpuClient::Execute() is ready.\n "
        }
    ],
    "stats": {
        "total": 52,
        "additions": 35,
        "deletions": 17
    }
}