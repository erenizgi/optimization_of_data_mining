{
    "author": "bhavani-subramanian",
    "message": "PR #30507: [XLA:GPU][oneAPI]: Added support for sycl_event and corresponding test\n\nImported from GitHub PR https://github.com/openxla/xla/pull/30507\n\nCo-author: @kanvi-nervana\n\nThis PR adds the sycl event component and test. It has no dependencies.\n\nIt also updates the `sycl_library` wrapper to include SYCL specific build and linking options. This makes it easier to maintain/add SYCL targets.\n\nSince SYCL reports synchronous (host-side) errors via exceptions, we catch them and return an error status.\nCopybara import of the project:\n\n--\n5be9693f3d5e7c72266426db2a4c4318a39e2ea6 by Bhavani Subramanian <bhavani1.subramanian@intel.com>:\n\nAdded support for sycl_event and corresponding test\n\n--\nf852fdcf2a8f2bcbd5aa253bc331775758ecb964 by Bhavani Subramanian <bhavani1.subramanian@intel.com>:\n\nUsed sycl_library instead of cc_library for sycl_kernel target\n\nMerging this change closes #30507\n\nPiperOrigin-RevId: 802077898",
    "sha": "f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
    "files": [
        {
            "sha": "a6f7c652795c78af2b02c3e7173f457dbfe9cd29",
            "filename": "third_party/xla/build_tools/sycl/ci_test_xla.sh",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fbuild_tools%2Fsycl%2Fci_test_xla.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fbuild_tools%2Fsycl%2Fci_test_xla.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fsycl%2Fci_test_xla.sh?ref=f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
            "patch": "@@ -14,7 +14,7 @@\n # limitations under the License.\n # ==============================================================================\n \n-# This script builds and executes tests. It can be run only on a system that \n+# This script builds and executes tests. It can be run only on a system that\n # has an Intel GPU with the appropriate driver and oneAPI tools installed.\n # Hermetic build is not currently fully supported for executing tests.\n ./configure.py --backend=SYCL --host_compiler=CLANG --sycl_compiler=ICPX\n@@ -23,4 +23,5 @@ bazel test \\\n       --build_tag_filters=gpu,oneapi-only,requires-gpu-intel,-requires-gpu-amd,-requires-gpu-nvidia,-no_oss,-cuda-only,-rocm-only,-no-oneapi \\\n       --test_tag_filters=gpu,oneapi-only,requires-gpu-intel,-requires-gpu-amd,-requires-gpu-nvidia,-no_oss,-cuda-only,-rocm-only,-no-oneapi \\\n       //xla/stream_executor/sycl:sycl_status_test \\\n+      //xla/stream_executor/sycl:sycl_event_test_intelgpu_any \\\n       //xla/stream_executor/sycl:sycl_kernel_test_intelgpu_any"
        },
        {
            "sha": "8b4324dcc8c9daff37549a9316b0af612ee68f99",
            "filename": "third_party/xla/third_party/gpus/sycl/build_defs.bzl.tpl",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fthird_party%2Fgpus%2Fsycl%2Fbuild_defs.bzl.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fthird_party%2Fgpus%2Fsycl%2Fbuild_defs.bzl.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Fsycl%2Fbuild_defs.bzl.tpl?ref=f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
            "patch": "@@ -13,7 +13,11 @@ def if_sycl(if_true, if_false = []):\n \n def sycl_default_copts():\n     \"\"\"Default options for all SYCL compilations.\"\"\"\n-    return if_sycl([\"-x\", \"sycl\"])\n+    return if_sycl([\"-sycl_compile\"])\n+\n+def sycl_default_linkopts():\n+    \"\"\"Default options for all SYCL compilations.\"\"\"\n+    return if_sycl([\"-link_stage\", \"-lirc\"])\n \n def sycl_build_is_configured():\n     \"\"\"Returns true if SYCL compiler was enabled during the configure process.\"\"\"\n@@ -34,6 +38,13 @@ def if_sycl_build_is_configured(x, y):\n       return x\n     return y\n \n-def sycl_library(copts = [], **kwargs):\n+def sycl_library(copts = [], linkopts = [], tags = [], deps = [], **kwargs):\n     \"\"\"Wrapper over cc_library which adds default SYCL options.\"\"\"\n-    native.cc_library(copts = sycl_default_copts() + copts, **kwargs)\n+    native.cc_library(copts = sycl_default_copts() + copts,\n+                      linkopts = sycl_default_linkopts() + linkopts,\n+                      tags = tags + [\"gpu\"],\n+                      deps = deps + if_sycl_is_configured([\n+                        \"@local_config_sycl//sycl:sycl_headers\",\n+                        \"@local_config_sycl//sycl:level_zero\",\n+                      ]),\n+                      **kwargs)"
        },
        {
            "sha": "874e15c43949e94aafe37ff190368e7cc44169ad",
            "filename": "third_party/xla/xla/stream_executor/sycl/BUILD",
            "status": "modified",
            "additions": 35,
            "deletions": 3,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2FBUILD?ref=f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
            "patch": "@@ -4,6 +4,7 @@\n load(\n     \"@local_config_sycl//sycl:build_defs.bzl\",\n     \"if_sycl_is_configured\",\n+    \"sycl_library\",\n )\n load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n load(\n@@ -149,7 +150,7 @@ cc_library(\n     alwayslink = 1,\n )\n \n-cc_library(\n+sycl_library(\n     name = \"sycl_kernel\",\n     srcs = [\"sycl_kernel.cc\"],\n     hdrs = [\"sycl_kernel.h\"],\n@@ -160,7 +161,6 @@ cc_library(\n     deps = [\n         \"//xla/stream_executor:stream_executor_h\",\n         \"@com_google_absl//absl/status:statusor\",\n-        \"@local_config_sycl//sycl:sycl_headers\",\n         \"@local_tsl//tsl/platform:logging\",\n     ],\n )\n@@ -183,6 +183,38 @@ xla_test(\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_config_sycl//sycl:sycl_headers\",\n+    ],\n+)\n+\n+sycl_library(\n+    name = \"sycl_event\",\n+    srcs = [\"sycl_event.cc\"],\n+    hdrs = [\"sycl_event.h\"],\n+    tags = [\n+        \"gpu\",\n+        \"oneapi-only\",\n+    ],\n+    deps = [\n+        \"//xla/stream_executor:activate_context\",\n+        \"//xla/stream_executor:event\",\n+        \"//xla/stream_executor:stream_executor_h\",\n+        \"@com_google_absl//absl/base\",\n+        \"@com_google_absl//absl/status:statusor\",\n+    ],\n+)\n+\n+xla_test(\n+    name = \"sycl_event_test\",\n+    srcs = [\"sycl_event_test.cc\"],\n+    backends = [\"gpu\"],\n+    tags = [\n+        \"gpu\",\n+        \"oneapi-only\",\n+    ],\n+    deps = [\n+        \":sycl_event\",\n+        \"//xla/stream_executor:platform_manager\",\n+        \"//xla/stream_executor/sycl:sycl_platform_id\",\n+        \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "7f413e99eb5186c1087476d59bf2daaf633aec73",
            "filename": "third_party/xla/xla/stream_executor/sycl/sycl_event.cc",
            "status": "added",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event.cc?ref=f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
            "patch": "@@ -0,0 +1,111 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/stream_executor/sycl/sycl_event.h\"\n+\n+#include \"absl/base/casts.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"xla/stream_executor/activate_context.h\"\n+#include \"xla/stream_executor/event.h\"\n+\n+namespace stream_executor {\n+namespace gpu {\n+\n+Event::Status SyclEvent::PollForStatus() {\n+  try {\n+    auto event_status =\n+        event_.get_info<sycl::info::event::command_execution_status>();\n+    switch (event_status) {\n+      case sycl::info::event_command_status::submitted: {\n+        VLOG(2)\n+            << \"Command is submitted to the queue but not yet running on the \"\n+               \"device.\";\n+        return Event::Status::kPending;\n+      }\n+      case sycl::info::event_command_status::running: {\n+        VLOG(2) << \"Command has started running on the device but has not yet \"\n+                   \"completed.\";\n+        return Event::Status::kPending;\n+      }\n+      case sycl::info::event_command_status::complete: {\n+        VLOG(2) << \"Command has finished running on the device.\";\n+        return Event::Status::kComplete;\n+      }\n+      default: {\n+        LOG(ERROR) << \"Event status is unknown: \"\n+                   << static_cast<int>(event_status);\n+        return Event::Status::kUnknown;\n+      }\n+    }\n+  } catch (const sycl::exception& e) {\n+    LOG(ERROR) << \"SYCL exception while polling event status: \" << e.what()\n+               << \" (error code: \" << e.code() << \")\";\n+    return Event::Status::kError;\n+  }\n+}\n+\n+absl::Status SyclEvent::WaitStreamOnEvent(StreamExecutor* executor,\n+                                          sycl::queue* stream_handle,\n+                                          const sycl::event& event) {\n+  // No need to call executor->Activate() since the SYCL context need not\n+  // be activated explicitly.\n+  if (stream_handle == nullptr) {\n+    return absl::InternalError(\n+        \"WaitStreamOnEvent: Stream handle is not initialized.\");\n+  }\n+  std::vector<sycl::event> event_list{event};\n+  stream_handle->submit([&](sycl::handler& cgh) {\n+    cgh.depends_on(event_list);\n+    cgh.host_task([=]() {});\n+  });\n+  return absl::OkStatus();\n+}\n+\n+absl::Status SyclEvent::WaitForEventOnExternalStream(std::intptr_t stream) {\n+  sycl::queue* queue_ptr = absl::bit_cast<sycl::queue*>(stream);\n+  return WaitStreamOnEvent(executor_, queue_ptr, event_);\n+}\n+\n+absl::StatusOr<SyclEvent> SyclEvent::Create(StreamExecutor* executor) {\n+  // SYCL reports synchronous (host-side) errors via exceptions, so we catch\n+  // them and return an error status.\n+  try {\n+    // Initialize with a default-constructed sycl::event.\n+    return SyclEvent(executor, sycl::event());\n+  } catch (const sycl::exception& e) {\n+    LOG(ERROR) << \"SYCL exception while creating event: \" << e.what()\n+               << \" (error code: \" << e.code() << \")\";\n+    return absl::InternalError(\n+        absl::StrCat(\"Failed to create SYCL event: \", e.what()));\n+  }\n+}\n+\n+SyclEvent::SyclEvent(SyclEvent&& other) noexcept\n+    : executor_(other.executor_), event_(other.event_) {\n+  other.executor_ = nullptr;\n+}\n+\n+SyclEvent& SyclEvent::operator=(SyclEvent&& other) noexcept {\n+  if (this == &other) {\n+    return *this;\n+  }\n+  executor_ = other.executor_;\n+  event_ = other.event_;\n+  other.executor_ = nullptr;\n+  return *this;\n+}\n+\n+}  // namespace gpu\n+}  // namespace stream_executor"
        },
        {
            "sha": "a3b526c601f5006e126949321d2fb7ddc7197673",
            "filename": "third_party/xla/xla/stream_executor/sycl/sycl_event.h",
            "status": "added",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event.h?ref=f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
            "patch": "@@ -0,0 +1,71 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_STREAM_EXECUTOR_SYCL_SYCL_EVENT_H_\n+#define XLA_STREAM_EXECUTOR_SYCL_SYCL_EVENT_H_\n+\n+#include <sycl/sycl.hpp>\n+\n+#include \"absl/status/statusor.h\"\n+#include \"xla/stream_executor/event.h\"\n+#include \"xla/stream_executor/stream_executor.h\"\n+\n+namespace stream_executor {\n+namespace gpu {\n+\n+// This class implements the Event class for SYCL devices.\n+class SyclEvent : public Event {\n+ public:\n+  Event::Status PollForStatus() override;\n+\n+  // Waits for the event to complete on the specified stream.\n+  static absl::Status WaitStreamOnEvent(StreamExecutor* executor,\n+                                        sycl::queue* stream_handle,\n+                                        const sycl::event& event);\n+\n+  // Waits for the event to complete on an external stream.\n+  absl::Status WaitForEventOnExternalStream(std::intptr_t stream) override;\n+\n+  // Creates a SyclEvent instance and initializes it with a default\n+  // constructed sycl::event that has no dependencies and associated commands.\n+  static absl::StatusOr<SyclEvent> Create(StreamExecutor* executor);\n+\n+  sycl::event GetEvent() const { return event_; }\n+\n+  // We don't need a destructor for sycl::event since it is handled by the SYCL\n+  // runtime.\n+  ~SyclEvent() = default;\n+\n+  // Ensure SyclEvent is moveable but not copyable.\n+  SyclEvent(const SyclEvent&) = delete;\n+  SyclEvent& operator=(const SyclEvent&) = delete;\n+  SyclEvent(SyclEvent&& other) noexcept;\n+  SyclEvent& operator=(SyclEvent&& other) noexcept;\n+\n+ private:\n+  explicit SyclEvent(StreamExecutor* executor, const sycl::event& event)\n+      : executor_(executor), event_(event) {}\n+\n+  // The Executor used to which this object and sycl::event are bound.\n+  StreamExecutor* executor_;\n+\n+  // The underlying SYCL event.\n+  sycl::event event_;\n+};\n+\n+}  // namespace gpu\n+}  // namespace stream_executor\n+\n+#endif  // XLA_STREAM_EXECUTOR_SYCL_SYCL_EVENT_H_"
        },
        {
            "sha": "f0497f5dd07390afb2905a53557e51c56cdaefb5",
            "filename": "third_party/xla/xla/stream_executor/sycl/sycl_event_test.cc",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f533e1fb28aa9bdc1d325fe492da89b577b8ae20/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fsycl%2Fsycl_event_test.cc?ref=f533e1fb28aa9bdc1d325fe492da89b577b8ae20",
            "patch": "@@ -0,0 +1,69 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/stream_executor/sycl/sycl_event.h\"\n+\n+#include <gtest/gtest.h>\n+#include \"xla/stream_executor/platform_manager.h\"\n+#include \"xla/stream_executor/sycl/sycl_platform_id.h\"\n+\n+namespace stream_executor::gpu {\n+namespace {\n+\n+const int kDefaultDeviceOrdinal = 0;\n+\n+class SyclEventTest : public ::testing::Test {\n+ protected:\n+  void SetUp() override {\n+    TF_ASSERT_OK_AND_ASSIGN(Platform * platform,\n+                            stream_executor::PlatformManager::PlatformWithId(\n+                                stream_executor::sycl::kSyclPlatformId));\n+    TF_ASSERT_OK_AND_ASSIGN(executor_,\n+                            platform->ExecutorForDevice(kDefaultDeviceOrdinal));\n+  }\n+\n+  StreamExecutor* executor_;\n+};\n+\n+// TODO (intel-tf): Add a test for events with dependencies once SyclStream\n+// class is supported.\n+TEST_F(SyclEventTest, CreateEvent) {\n+  TF_ASSERT_OK_AND_ASSIGN(SyclEvent event, SyclEvent::Create(executor_));\n+\n+  ::sycl::event sycl_event = event.GetEvent();\n+\n+  // Expect the event to be complete immediately after creation\n+  // since it has no dependencies.\n+  EXPECT_EQ(event.PollForStatus(), Event::Status::kComplete);\n+}\n+\n+TEST_F(SyclEventTest, MoveEvent) {\n+  TF_ASSERT_OK_AND_ASSIGN(SyclEvent orig_sycl_event,\n+                          SyclEvent::Create(executor_));\n+\n+  // Make a copy of the event wrapper handle to check after move.\n+  ::sycl::event orig_event = orig_sycl_event.GetEvent();\n+\n+  // Move the event to a new SyclEvent instance.\n+  SyclEvent moved_sycl_event = std::move(orig_sycl_event);\n+\n+  // The moved event should still be valid.\n+  ::sycl::event moved_event = moved_sycl_event.GetEvent();\n+  EXPECT_EQ(moved_event, orig_event);\n+}\n+\n+}  // namespace\n+\n+}  // namespace stream_executor::gpu"
        }
    ],
    "stats": {
        "total": 309,
        "additions": 302,
        "deletions": 7
    }
}