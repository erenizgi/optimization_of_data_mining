{
    "author": "tensorflower-gardener",
    "message": "Add 1D array test case for SPMD DUS (both to verify the HLO transformation and the overall correctness)\n\nPiperOrigin-RevId: 825222307",
    "sha": "24abec31c7e148c14027aa4b0e6f7997c168a0e6",
    "files": [
        {
            "sha": "860c8d3b28d53da247972dfee64c77c2a6c6f038",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/24abec31c7e148c14027aa4b0e6f7997c168a0e6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/24abec31c7e148c14027aa4b0e6f7997c168a0e6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc?ref=24abec31c7e148c14027aa4b0e6f7997c168a0e6",
            "patch": "@@ -8083,6 +8083,33 @@ ENTRY entry {\n                     op::Shape(\"s32[64,32]\")));\n }\n \n+TEST_P(SpmdPartitioningTest, DynamicUpdateSliceSingleDimension) {\n+  absl::string_view hlo_string = R\"(\n+    HloModule module\n+\n+    ENTRY entry {\n+      %input = s32[16] parameter(0), sharding={devices=[4]<=[4]}\n+      %update = s32[8] parameter(1), sharding={devices=[4]<=[4]}\n+      %c3 = s32[] constant(3)\n+      ROOT %dynamic-update-slice = s32[16]\n+        dynamic-update-slice(%input, %update, %c3),\n+        sharding={devices=[4]<=[4]}\n+    })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          PartitionComputation(hlo_string, /*num_devices=*/4));\n+  const auto root = module->entry_computation()->root_instruction();\n+  auto sharded_input = AllOf(op::Parameter(0), op::Shape(\"s32[4]\"));\n+  auto sharded_update = AllOf(op::Parameter(1), op::Shape(\"s32[2]\"));\n+  auto c3 = AllOf(op::Constant(), op::Shape(\"s32[]\"));\n+  EXPECT_THAT(root,\n+              AllOf(op::DynamicSlice((op::DynamicUpdateSlice(\n+                                         op::AllGather(sharded_input),\n+                                         op::AllGather(sharded_update), c3)),\n+                                     op::Reshape(_)),\n+                    op::Shape(\"s32[4]\")));\n+}\n+\n TEST_P(SpmdPartitioningTest, UnpartitionedGather) {\n   absl::string_view hlo_string = R\"(\n HloModule module\n@@ -14754,6 +14781,8 @@ ENTRY entry {\n                                _, _, _, _));\n }\n \n+// TODO: fix this test; right now it breaks in collective_ops_e2e_test.cc, even\n+// though it passes the SPMD partitioner unit test.\n TEST_P(SpmdPartitioningTest,\n        KeepPartitionedNonSlicedDimensionWithConstantIndices) {\n   const char* const hlo_string = R\"("
        },
        {
            "sha": "4761af16f6e56c8c07664b6751a8fa1d95e1441a",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/24abec31c7e148c14027aa4b0e6f7997c168a0e6/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/24abec31c7e148c14027aa4b0e6f7997c168a0e6/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc?ref=24abec31c7e148c14027aa4b0e6f7997c168a0e6",
            "patch": "@@ -1711,6 +1711,22 @@ ENTRY entry {\n   CollectiveOpsCompareShardedUnsharded(hlo_text);\n }\n \n+// This is an execution test for the example in Option 2 in go/dus-spmd. This\n+// test should pass regardless of which DUS SPMD implementation option is used.\n+TEST_F(CollectiveOpsTestE2EShardedUnsharded,\n+       DusSingleDimensionInPartitionMode) {\n+  const std::string hlo_text = R\"(\n+    HloModule module, entry_computation_layout={(s32[16]{0}, s32[8]{0})->s32[16]{0}}, num_partitions=4\n+\n+    ENTRY entry {\n+      %input = s32[16] parameter(0), sharding={devices=[4]<=[4]}\n+      %update = s32[8] parameter(1), sharding={devices=[4]<=[4]}\n+      %c3 = s32[] constant(3)\n+      ROOT %dynamic-update-slice = s32[16] dynamic-update-slice(%input, %update, %c3), sharding={devices=[4]<=[4]}\n+    })\";\n+  CollectiveOpsCompareShardedUnsharded(hlo_text, /*num_partitions=*/4);\n+}\n+\n TEST_F(CollectiveOpsTestE2EShardedUnsharded, DotBatchAndNonContracting) {\n   const std::string hlo_text = R\"(\n HloModule module, entry_computation_layout={(f32[4,16,8]{2,1,0}, f32[4,4,8]{2,1,0})->f32[4,16,4]{2,1,0}}, num_partitions=2"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 45,
        "deletions": 0
    }
}