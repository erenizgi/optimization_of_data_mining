{
    "author": "draganmladjenovic",
    "message": "Register rocm_device_libs repo in TF and XLA workspaces\n\nThis has originally been part of https://github.com/openxla/xla/pull/26704 and had to be merged separately since we need to update the TF WORKSPACE first\nbefore we can start using it.\n\nPiperOrigin-RevId: 815731667",
    "sha": "f32e33752499f5e9ab31970081c6a2e4b024892d",
    "files": [
        {
            "sha": "46e8fc1481d928f43cfc6b512c1e4a0cd7e37820",
            "filename": "tensorflow/workspace2.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/tensorflow%2Fworkspace2.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/tensorflow%2Fworkspace2.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fworkspace2.bzl?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -30,6 +30,7 @@ load(\"@local_xla//third_party/raft:workspace.bzl\", raft = \"repo\")\n load(\"@local_xla//third_party/rapids_logger:workspace.bzl\", rapids_logger = \"repo\")\n load(\"@local_xla//third_party/rmm:workspace.bzl\", rmm = \"repo\")\n load(\"@local_xla//third_party/robin_map:workspace.bzl\", robin_map = \"repo\")\n+load(\"@local_xla//third_party/rocm_device_libs:workspace.bzl\", rocm_device_libs = \"repo\")\n load(\"@local_xla//third_party/shardy:workspace.bzl\", shardy = \"repo\")\n load(\"@local_xla//third_party/spdlog:workspace.bzl\", spdlog = \"repo\")\n load(\"@local_xla//third_party/stablehlo:workspace.bzl\", stablehlo = \"repo\")\n@@ -95,6 +96,7 @@ def _initialize_third_party():\n     rapids_logger()\n     rmm()\n     robin_map()\n+    rocm_device_libs()\n     ruy()\n     shardy()\n     spdlog()"
        },
        {
            "sha": "cc558415f2b3d22e6e29586e495b47e8efc9be5a",
            "filename": "third_party/xla/third_party/rocm_device_libs/BUILD",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2FBUILD?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -0,0 +1 @@\n+# copybara:uncomment package(default_applicable_licenses = [\"//third_party/tensorflow:license\"])"
        },
        {
            "sha": "3df0d6f2e25cab7827a8d434d9bb4b413b59285e",
            "filename": "third_party/xla/third_party/rocm_device_libs/build_defs.bzl",
            "status": "added",
            "additions": 108,
            "deletions": 0,
            "changes": 108,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -0,0 +1,108 @@\n+\"\"\"Build rules for ROCm-Device-Libs bitcode libraries.\"\"\"\n+\n+load(\"@bazel_skylib//lib:paths.bzl\", \"paths\")\n+\n+def bitcode_library(\n+        name,\n+        srcs = [],\n+        hdrs = [],\n+        file_specific_flags = {}):\n+    \"\"\"Builds a bitcode library\n+\n+    Args:\n+        name: Unique name of the build rule.\n+        srcs: List of source files (*.cl, *.ll).\n+        hdrs: List of header files (*.h).\n+        file_specific_flags: Per-file dict of flags to be passed to clang.\n+    \"\"\"\n+    # Takes the CL sources and compiles them into bitcode files.\n+    # Merges those bitcode files together with any given .ll files into a single bitcode file.\n+    # Strips unnecessary metadata and forces linkonce local visibility for symbols.\n+    # Adapted from:\n+    #   https://github.com/ROCm/llvm-project/blob/22ee53fa53edc3a5f25feb08dc840f5b0fc362da/amd/device-libs/cmake/OCL.cmake#L73\n+\n+    clang_tool = \"@llvm-project//clang:clang\"\n+    llvm_link_tool = \"@llvm-project//llvm:llvm-link\"\n+    opt_tool = \"@llvm-project//llvm:opt\"\n+    prepare_builtins_tool = \":prepare_builtins\"\n+\n+    include_paths = dict([(paths.dirname(h), None) for h in hdrs]).keys()\n+\n+    #TODO(rocm): Maybe compute this in cmd not to pass dirs as srcs\n+    includes = \" \".join([\"-I$(location {})\".format(inc) for inc in include_paths])\n+    flags = (\"-fcolor-diagnostics -Werror -Wno-error=atomic-alignment -x cl -Xclang \" +\n+             \"-cl-std=CL2.0 --target=amdgcn-amd-amdhsa -fvisibility=hidden -fomit-frame-pointer \" +\n+             \"-Xclang -finclude-default-header -Xclang -fexperimental-strict-floating-point \" +\n+             \"-Xclang -fdenormal-fp-math=dynamic -Xclang -Qn \" +\n+             \"-nogpulib -cl-no-stdinc -Xclang -mcode-object-version=none\")\n+\n+    link_inputs = []\n+\n+    for src in srcs:\n+        filename = paths.basename(src)\n+        (basename, _, ext) = filename.partition(\".\")\n+\n+        if (ext == \"ll\"):\n+            link_inputs.append(src)\n+            continue\n+\n+        out = basename + \".bc\"\n+        link_inputs.append(out)\n+        extra_flags = \" \".join(file_specific_flags.get(filename, []))\n+        native.genrule(\n+            name = \"compile_\" + basename,\n+            srcs = [src] + hdrs + include_paths,\n+            outs = [out],\n+            #TODO(rocm): Ugly hack to access bultin clang includes.\n+            cmd = \"$(location {}) -I$(execpath {}).runfiles/llvm-project/clang/staging/include/  {} {} {} -emit-llvm -c $(location {}) -o $@\".format(\n+                clang_tool,\n+                clang_tool,\n+                includes,\n+                flags,\n+                extra_flags,\n+                src,\n+            ),\n+            tools = [clang_tool],\n+            message = \"Compiling {} ...\".format(filename),\n+        )\n+\n+    link_message = \"Linking {}.bc ...\".format(name)\n+\n+    prelink_out = name + \".link0.lib.bc\"\n+    native.genrule(\n+        name = \"prelink_\" + name,\n+        srcs = link_inputs,\n+        outs = [prelink_out],\n+        cmd = \"$(location {}) $(SRCS) -o $@\".format(llvm_link_tool),\n+        tools = [llvm_link_tool],\n+        message = link_message,\n+    )\n+\n+    internalize_out = name + \".lib.bc\"\n+    native.genrule(\n+        name = \"internalize_\" + name,\n+        srcs = [prelink_out],\n+        outs = [internalize_out],\n+        cmd = \"$(location {}) -internalize -only-needed $< -o $@\".format(llvm_link_tool),\n+        tools = [llvm_link_tool],\n+        message = link_message,\n+    )\n+\n+    strip_out = name + \".strip.bc\"\n+    native.genrule(\n+        name = \"strip_\" + name,\n+        srcs = [internalize_out],\n+        outs = [strip_out],\n+        cmd = \"$(location {}) -passes=strip -o $@ $<\".format(opt_tool),\n+        tools = [opt_tool],\n+        message = link_message,\n+    )\n+\n+    native.genrule(\n+        name = name,\n+        srcs = [strip_out],\n+        outs = [name + \".bc\"],\n+        cmd = \"$(location {}) -o $@ $<\".format(prepare_builtins_tool),\n+        tools = [prepare_builtins_tool],\n+        message = link_message,\n+    )"
        },
        {
            "sha": "c24b38a910ba72efcb40946a124903fdef966c7a",
            "filename": "third_party/xla/third_party/rocm_device_libs/prepare_builtins.patch",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fprepare_builtins.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fprepare_builtins.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fprepare_builtins.patch?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -0,0 +1,18 @@\n+diff --git a/utils/prepare-builtins/prepare-builtins.cpp b/utils/prepare-builtins/prepare-builtins.cpp\n+index 7fc9d06dab7d..2a93638c3f8f 100644\n+--- a/utils/prepare-builtins/prepare-builtins.cpp\n++++ b/utils/prepare-builtins/prepare-builtins.cpp\n+@@ -73,6 +73,13 @@ int main(int argc, char **argv) {\n+     return 1;\n+   }\n+\n++  // Strip the OpenCL version metadata. There are a lot of linked\n++  // modules in the library build, each spamming the same\n++  // version. This may also report a different version than the user\n++  // program is using. This should probably be uniqued when linking.\n++  if (NamedMDNode *OCLVersion = M->getNamedMetadata(\"opencl.ocl.version\"))\n++      M->eraseNamedMetadata(OCLVersion);\n++\n+   // Set linkage of every external definition to linkonce_odr.\n+   for (Module::iterator i = M->begin(), e = M->end(); i != e; ++i) {\n+     if (!i->isDeclaration() && i->getLinkage() == GlobalValue::ExternalLinkage) {"
        },
        {
            "sha": "11795b3537e7a974f34041ccce9f06e310716be6",
            "filename": "third_party/xla/third_party/rocm_device_libs/rocm_device_libs.BUILD",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -0,0 +1,62 @@\n+load(\"build_defs.bzl\", \"bitcode_library\")\n+\n+licenses([\"notice\"])\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+exports_files([\n+    \"LICENSE.TXT\",\n+])\n+\n+cc_binary(\n+    name = \"prepare_builtins\",\n+    srcs = glob([\n+        \"utils/prepare-builtins/*.cpp\",\n+        \"utils/prepare-builtins/*.h\",\n+    ]),\n+    copts = [\n+        \"-fno-rtti -fno-exceptions\",\n+    ],\n+    visibility = [\"//visibility:private\"],\n+    deps = [\n+        \"@llvm-project//llvm:BitReader\",\n+        \"@llvm-project//llvm:BitWriter\",\n+        \"@llvm-project//llvm:Core\",\n+        \"@llvm-project//llvm:IRReader\",\n+        \"@llvm-project//llvm:Support\",\n+    ],\n+)\n+\n+bitcode_library(\n+    name = \"ocml\",\n+    srcs = glob([\n+        \"ocml/src/*.cl\",\n+    ]),\n+    hdrs = glob([\n+        \"ocml/src/*.h\",\n+        \"ocml/inc/*.h\",\n+        \"irif/inc/*.h\",\n+        \"oclc/inc/*.h\",\n+    ]),\n+    file_specific_flags = {\n+        \"native_logF.cl\": [\"-fapprox-func\"],\n+        \"native_expF.cl\": [\"-fapprox-func\"],\n+        \"sqrtF.cl\": [\"-cl-fp32-correctly-rounded-divide-sqrt\"],\n+    },\n+)\n+\n+bitcode_library(\n+    name = \"ockl\",\n+    srcs = glob([\n+        \"ockl/src/*.cl\",\n+        \"ockl/src/*.ll\",\n+    ]),\n+    hdrs = glob([\n+        \"ockl/inc/*.h\",\n+        \"irif/inc/*.h\",\n+        \"oclc/inc/*.h\",\n+    ]),\n+    file_specific_flags = {\n+        \"gaaf.cl\": [\"-munsafe-fp-atomics\"],\n+    },\n+)"
        },
        {
            "sha": "e05ba8de4fe1bf87354051cfd845e8f825e3a357",
            "filename": "third_party/xla/third_party/rocm_device_libs/workspace.bzl",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fworkspace.bzl?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -0,0 +1,22 @@\n+\"\"\"Provides the repository macro to import Rocm-Device-Libs\"\"\"\n+\n+load(\"//third_party:repo.bzl\", \"tf_http_archive\", \"tf_mirror_urls\")\n+\n+def repo():\n+    \"\"\"Imports Rocm-Device-Libs.\"\"\"\n+    LLVM_COMMIT = \"c93c6e5451544e9ead12f2d2b15e1969b9a1bd04\"\n+    LLVM_SHA256 = \"f715a0a9c3c1a2b09a79939016ed53a0cbd454f7b0ea4ef32878433275c7b16c\"\n+\n+    tf_http_archive(\n+        name = \"rocm_device_libs\",\n+        sha256 = LLVM_SHA256,\n+        strip_prefix = \"llvm-project-{commit}/amd/device-libs\".format(commit = LLVM_COMMIT),\n+        urls = tf_mirror_urls(\"https://github.com/ROCm/llvm-project/archive/{commit}.tar.gz\".format(commit = LLVM_COMMIT)),\n+        build_file = \"//third_party/rocm_device_libs:rocm_device_libs.BUILD\",\n+        patch_file = [\n+            \"//third_party/rocm_device_libs:prepare_builtins.patch\",\n+        ],\n+        link_files = {\n+            \"//third_party/rocm_device_libs:build_defs.bzl\": \"build_defs.bzl\",\n+        },\n+    )"
        },
        {
            "sha": "dc9f92086c014ff7be0ff75d7ae25402315612e1",
            "filename": "third_party/xla/workspace2.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fworkspace2.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f32e33752499f5e9ab31970081c6a2e4b024892d/third_party%2Fxla%2Fworkspace2.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fworkspace2.bzl?ref=f32e33752499f5e9ab31970081c6a2e4b024892d",
            "patch": "@@ -43,6 +43,7 @@ load(\"//third_party/raft:workspace.bzl\", raft = \"repo\")\n load(\"//third_party/rapids_logger:workspace.bzl\", rapids_logger = \"repo\")\n load(\"//third_party/rmm:workspace.bzl\", rmm = \"repo\")\n load(\"//third_party/robin_map:workspace.bzl\", robin_map = \"repo\")\n+load(\"//third_party/rocm_device_libs:workspace.bzl\", rocm_device_libs = \"repo\")\n load(\"//third_party/shardy:workspace.bzl\", shardy = \"repo\")\n load(\"//third_party/spdlog:workspace.bzl\", spdlog = \"repo\")\n load(\"//third_party/stablehlo:workspace.bzl\", stablehlo = \"repo\")\n@@ -91,6 +92,7 @@ def _initialize_third_party():\n     rapids_logger()\n     rmm()\n     robin_map()\n+    rocm_device_libs()\n     shardy()\n     spdlog()\n     stablehlo()"
        }
    ],
    "stats": {
        "total": 215,
        "additions": 215,
        "deletions": 0
    }
}