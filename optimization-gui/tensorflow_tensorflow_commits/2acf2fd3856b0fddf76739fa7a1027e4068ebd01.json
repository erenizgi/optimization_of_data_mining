{
    "author": "ermilovmaxim",
    "message": "Add optional shape to BufferUse\n\nPiperOrigin-RevId: 832498576",
    "sha": "2acf2fd3856b0fddf76739fa7a1027e4068ebd01",
    "files": [
        {
            "sha": "9551dd8de8776a8f2359ddd3f83ad793f30e95fa",
            "filename": "third_party/xla/xla/runtime/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2acf2fd3856b0fddf76739fa7a1027e4068ebd01/third_party%2Fxla%2Fxla%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2acf2fd3856b0fddf76739fa7a1027e4068ebd01/third_party%2Fxla%2Fxla%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fruntime%2FBUILD?ref=2acf2fd3856b0fddf76739fa7a1027e4068ebd01",
            "patch": "@@ -19,8 +19,10 @@ cc_library(\n     srcs = [\"buffer_use.cc\"],\n     hdrs = [\"buffer_use.h\"],\n     deps = [\n+        \"//xla:shape_util\",\n         \"//xla/service:buffer_assignment\",\n         \"@com_google_absl//absl/algorithm:container\",\n+        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/types:span\",\n     ],"
        },
        {
            "sha": "3b283ab41982de5d31ee6fa6e02178545ca81729",
            "filename": "third_party/xla/xla/runtime/buffer_use.h",
            "status": "modified",
            "additions": 32,
            "deletions": 1,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2acf2fd3856b0fddf76739fa7a1027e4068ebd01/third_party%2Fxla%2Fxla%2Fruntime%2Fbuffer_use.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2acf2fd3856b0fddf76739fa7a1027e4068ebd01/third_party%2Fxla%2Fxla%2Fruntime%2Fbuffer_use.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fruntime%2Fbuffer_use.h?ref=2acf2fd3856b0fddf76739fa7a1027e4068ebd01",
            "patch": "@@ -17,11 +17,14 @@ limitations under the License.\n #define XLA_RUNTIME_BUFFER_USE_H_\n \n #include <cstdint>\n+#include <optional>\n #include <tuple>\n \n+#include \"absl/base/attributes.h\"\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/types/span.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n \n namespace xla {\n \n@@ -31,6 +34,8 @@ namespace xla {\n //   conflicts. Synchronization primitives are specific to the target backend.\n // - Determine whether a buffer has defined contents before/after we execute a\n //   thunk. This is used to detect non-deterministic behavior via checksumming.\n+// - We also use shape to know how the bytes in the slice are reinterpreted by\n+//   thunks. Shape can be used by rewriters in ThunkPassPipeline.\n class BufferUse {\n  public:\n   enum class MemoryAccess {\n@@ -63,28 +68,53 @@ class BufferUse {\n                       : ContentValidity::kDefinedOnOutput) {}\n \n   BufferUse(BufferAllocation::Slice slice, MemoryAccess access,\n-            ContentValidity content_validity)\n+            ContentValidity content_validity,\n+            std::optional<Shape> shape = std::nullopt)\n       : slice_(slice), access_(access), content_validity_(content_validity) {}\n \n+  ABSL_DEPRECATED(\"Please provide shape as well.\")\n   static BufferUse Read(BufferAllocation::Slice slice) {\n     return BufferUse(slice, MemoryAccess::kRead,\n                      ContentValidity::kDefinedOnInputAndOutput);\n   }\n \n+  ABSL_DEPRECATED(\"Please provide shape as well.\")\n   static BufferUse Write(BufferAllocation::Slice slice) {\n     return BufferUse(slice, MemoryAccess::kWrite,\n                      ContentValidity::kDefinedOnOutput);\n   }\n \n+  ABSL_DEPRECATED(\"Please provide shape as well.\")\n   static BufferUse Scratch(BufferAllocation::Slice slice) {\n     return BufferUse(slice, MemoryAccess::kWrite, ContentValidity::kUndefined);\n   }\n \n+  ABSL_DEPRECATED(\"Please provide shape as well.\")\n   static BufferUse Consume(BufferAllocation::Slice slice) {\n     return BufferUse(slice, MemoryAccess::kWrite,\n                      ContentValidity::kDefinedOnInput);\n   }\n \n+  static BufferUse Read(BufferAllocation::Slice slice, Shape shape) {\n+    return BufferUse(slice, MemoryAccess::kRead,\n+                     ContentValidity::kDefinedOnInputAndOutput, shape);\n+  }\n+\n+  static BufferUse Write(BufferAllocation::Slice slice, Shape shape) {\n+    return BufferUse(slice, MemoryAccess::kWrite,\n+                     ContentValidity::kDefinedOnOutput, shape);\n+  }\n+\n+  static BufferUse Scratch(BufferAllocation::Slice slice, Shape shape) {\n+    return BufferUse(slice, MemoryAccess::kWrite, ContentValidity::kUndefined,\n+                     shape);\n+  }\n+\n+  static BufferUse Consume(BufferAllocation::Slice slice, Shape shape) {\n+    return BufferUse(slice, MemoryAccess::kWrite,\n+                     ContentValidity::kDefinedOnInput, shape);\n+  }\n+\n   // Returns true if the buffer contains initialized data when thunk starts\n   // execution.\n   bool HasDefinedContentsOnInput() const {\n@@ -146,6 +176,7 @@ class BufferUse {\n \n  private:\n   BufferAllocation::Slice slice_;\n+  std::optional<Shape> shape_;\n   MemoryAccess access_;\n   ContentValidity content_validity_;\n };"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 34,
        "deletions": 1
    }
}