{
    "author": "junwhanahn",
    "message": "Avoid changing the MLIR context of an IFRT IR program during compilation if the program does not exclusively own the context\n\nPiperOrigin-RevId: 817763225",
    "sha": "2dafd2aff3b7cafeda522fb0bdea40bd05a1e271",
    "files": [
        {
            "sha": "3c904e92b963075d460e597263a61e7da2e7a8de",
            "filename": "third_party/xla/xla/python/ifrt/ir/compiled_ifrt_ir_program.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2dafd2aff3b7cafeda522fb0bdea40bd05a1e271/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2dafd2aff3b7cafeda522fb0bdea40bd05a1e271/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc?ref=2dafd2aff3b7cafeda522fb0bdea40bd05a1e271",
            "patch": "@@ -333,25 +333,32 @@ absl::StatusOr<CompiledIfrtIrProgram> CompiledIfrtIrProgram::Create(\n \n   // Run lowering passes.\n   {\n-    mlir::PassManager pm(context);\n-    InitPassManager(pm, \"ifrt.compile\", compile_options->mlir_dump_to,\n-                    compile_options->mlir_dump_pass_re,\n-                    compile_options->mlir_dump_func_re,\n-                    compile_options->mlir_enable_timing);\n     // We need to ensure that Multithreading is enabled in order to be able\n     // to dispatch compilations from multiple threads. Otherwise, we would\n     // trigger data races while printing the ModuleOps for creating the\n     // compilation cache keys\n     // (see llvm/llvm-project/mlir/lib/Support/StorageUniquer.cpp).\n     // JAX currently disables Multithreading for all contexts, but temporarily\n-    // enabling multithreading here is safe because the context is not shared\n-    // across JAX ModuleOps.\n-    bool wasMultithreaded = context->isMultithreadingEnabled();\n-    context->enableMultithreading(true);\n+    // enabling multithreading here is safe as long as the IfrtIRProgram\n+    // exclusively owns the context because the context is not shared across JAX\n+    // ModuleOps.\n+    std::optional<bool> was_multithreading_enabled;\n+    if (ifrt_ir_program->OwnsMlirContext()) {\n+      was_multithreading_enabled = context->isMultithreadingEnabled();\n+      context->enableMultithreading(true);\n+    }\n     absl::Cleanup reset_multithreading = [&]() {\n-      context->enableMultithreading(wasMultithreaded);\n+      if (was_multithreading_enabled.has_value()) {\n+        context->enableMultithreading(*was_multithreading_enabled);\n+      }\n     };\n \n+    mlir::PassManager pm(context);\n+    InitPassManager(pm, \"ifrt.compile\", compile_options->mlir_dump_to,\n+                    compile_options->mlir_dump_pass_re,\n+                    compile_options->mlir_dump_func_re,\n+                    compile_options->mlir_enable_timing);\n+\n     xla::ifrt::IfrtToOutlinedAtomProgramsPipelineOptions\n         outline_pipeline_options;\n     outline_pipeline_options.propagate_shardings ="
        },
        {
            "sha": "6b40c024e4e6b1807b3ccd6e4b81aedc9bfa84bd",
            "filename": "third_party/xla/xla/python/ifrt/ir/ifrt_ir_program.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2dafd2aff3b7cafeda522fb0bdea40bd05a1e271/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2dafd2aff3b7cafeda522fb0bdea40bd05a1e271/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.h?ref=2dafd2aff3b7cafeda522fb0bdea40bd05a1e271",
            "patch": "@@ -59,6 +59,9 @@ struct IfrtIRProgram : llvm::RTTIExtends<IfrtIRProgram, Program> {\n \n   mlir::ModuleOp mlir_module;\n \n+  // Returns true if the program exclusively owns the MLIR context.\n+  bool OwnsMlirContext() const { return mlir_context != nullptr; }\n+\n   static char ID;  // NOLINT\n \n  private:"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 20,
        "deletions": 10
    }
}