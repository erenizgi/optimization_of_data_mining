{
    "author": "ezhulenev",
    "message": "[xla:ffi] Make XLA_FFI_TypeInfo a versioned struct with size and extension\n\nPiperOrigin-RevId: 825311188",
    "sha": "f2ecdb670bbebac14aadb5da4b0abae4dc546e1d",
    "files": [
        {
            "sha": "fdadd21c3bfd8a4118fa5bbc0777f254b7aaa5e4",
            "filename": "third_party/xla/xla/ffi/api/api.h",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h?ref=f2ecdb670bbebac14aadb5da4b0abae4dc546e1d",
            "patch": "@@ -321,8 +321,13 @@ class Ffi {\n   // `type_id`.\n   static XLA_FFI_Error* RegisterTypeId(const XLA_FFI_Api* api,\n                                        std::string_view name,\n-                                       XLA_FFI_TypeId* type_id,\n-                                       XLA_FFI_TypeInfo type_info = {nullptr});\n+                                       XLA_FFI_TypeId* type_id,  // in-out\n+                                       XLA_FFI_TypeInfo type_info);\n+\n+  static XLA_FFI_Error* RegisterTypeId(const XLA_FFI_Api* api,\n+                                       std::string_view name,\n+                                       XLA_FFI_TypeId* type_id,  // in-out\n+                                       const XLA_FFI_TypeInfo* type_info);\n \n   // This is a helper template that allows to convert function pointers from\n   // the run time values to compile time values (template arguments) with\n@@ -393,13 +398,20 @@ inline XLA_FFI_Error* Ffi::RegisterTypeId(const XLA_FFI_Api* api,\n                                           std::string_view name,\n                                           XLA_FFI_TypeId* type_id,\n                                           XLA_FFI_TypeInfo type_info) {\n+  return RegisterTypeId(api, name, type_id, &type_info);\n+}\n+\n+inline XLA_FFI_Error* Ffi::RegisterTypeId(const XLA_FFI_Api* api,\n+                                          std::string_view name,\n+                                          XLA_FFI_TypeId* type_id,\n+                                          const XLA_FFI_TypeInfo* type_info) {\n   assert(type_id && \"type_id must not be null\");\n   XLA_FFI_Type_Register_Args args;\n   args.struct_size = XLA_FFI_Type_Register_Args_STRUCT_SIZE;\n   args.extension_start = nullptr;\n   args.name = XLA_FFI_ByteSpan{name.data(), name.size()};\n   args.type_id = type_id;\n-  args.type_info = &type_info;\n+  args.type_info = type_info;\n   return api->XLA_FFI_Type_Register(&args);\n }\n "
        },
        {
            "sha": "bc430abd948503e66bb72c52fb67cedc05840275",
            "filename": "third_party/xla/xla/ffi/api/c_api.h",
            "status": "modified",
            "additions": 21,
            "deletions": 15,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h?ref=f2ecdb670bbebac14aadb5da4b0abae4dc546e1d",
            "patch": "@@ -271,20 +271,6 @@ typedef struct XLA_FFI_ExecutionContext XLA_FFI_ExecutionContext;\n // Primitives\n //===----------------------------------------------------------------------===//\n \n-// TypeId uniquely identifies a user-defined type in a given XLA FFI instance.\n-typedef struct XLA_FFI_TypeId {\n-  int64_t type_id;\n-} XLA_FFI_TypeId;\n-\n-// TypeInfo contains function pointers required by XLA runtime to manipulate\n-// user-defined types. For example stateful handlers must tell XLA runtime how\n-// to destroy their state when executable is being destroyed.\n-typedef struct XLA_FFI_TypeInfo {\n-  void (*deleter)(void* object);\n-  void (*serialize)();    // placeholder for future use\n-  void (*deserialize)();  // placeholder for future use\n-} XLA_FFI_TypeInfo;\n-\n // We use byte spans to pass strings to handlers because strings might not be\n // null terminated, and even if they are, looking for a null terminator can\n // become very expensive in tight loops.\n@@ -306,6 +292,26 @@ typedef struct XLA_FFI_Array {\n   void* data;\n } XLA_FFI_Array;\n \n+//===----------------------------------------------------------------------===//\n+// Type registry\n+//===----------------------------------------------------------------------===//\n+\n+// TypeId uniquely identifies a user-defined type in a given XLA FFI instance.\n+typedef struct XLA_FFI_TypeId {\n+  int64_t type_id;\n+} XLA_FFI_TypeId;\n+\n+// TypeInfo contains function pointers required by XLA runtime to manipulate\n+// user-defined types. For example stateful handlers must tell XLA runtime how\n+// to destroy their state when executable is being destroyed.\n+typedef struct XLA_FFI_TypeInfo {\n+  size_t struct_size;\n+  XLA_FFI_Extension_Base* extension_start;\n+  void (*deleter)(void* object);\n+} XLA_FFI_TypeInfo;\n+\n+XLA_FFI_DEFINE_STRUCT_TRAITS(XLA_FFI_TypeInfo, deleter);\n+\n //===----------------------------------------------------------------------===//\n // Future\n //===----------------------------------------------------------------------===//\n@@ -500,7 +506,7 @@ struct XLA_FFI_Type_Register_Args {\n \n   XLA_FFI_ByteSpan name;\n   XLA_FFI_TypeId* type_id;  // in-out\n-  XLA_FFI_TypeInfo* type_info;\n+  const XLA_FFI_TypeInfo* type_info;\n };\n \n XLA_FFI_DEFINE_STRUCT_TRAITS(XLA_FFI_Type_Register_Args, type_id);"
        },
        {
            "sha": "d5dc0b26e128bee31eb5b6c27c67eddee258cce9",
            "filename": "third_party/xla/xla/ffi/api/ffi.h",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h?ref=f2ecdb670bbebac14aadb5da4b0abae4dc546e1d",
            "patch": "@@ -1503,15 +1503,19 @@ inline ThreadPool::ThreadPool(const XLA_FFI_Api* api,\n // Type Registration\n //===----------------------------------------------------------------------===//\n \n-// TODO(ezhulenev): Remove this once everyone migrates to MakeTypeInfo.\n template <typename T>\n-constexpr XLA_FFI_TypeInfo TypeInfo() {\n-  return XLA_FFI_TypeInfo{[](void* ptr) { delete static_cast<T*>(ptr); }};\n+inline constexpr XLA_FFI_TypeInfo MakeTypeInfo() {\n+  return XLA_FFI_TypeInfo{\n+      XLA_FFI_TypeInfo_STRUCT_SIZE,\n+      /*extension_start=*/nullptr,\n+      /*deleter=*/[](void* ptr) { delete static_cast<T*>(ptr); },\n+  };\n }\n \n+// TODO(ezhulenev): Remove this once everyone migrates to MakeTypeInfo.\n template <typename T>\n-constexpr XLA_FFI_TypeInfo MakeTypeInfo() {\n-  return XLA_FFI_TypeInfo{[](void* ptr) { delete static_cast<T*>(ptr); }};\n+inline constexpr XLA_FFI_TypeInfo TypeInfo() {\n+  return MakeTypeInfo<T>();\n }\n \n #define XLA_FFI_REGISTER_TYPE(API, NAME, TYPE_ID, TYPE_INFO) \\"
        },
        {
            "sha": "ad9d9515823d1590486bd457cb7df9cd327af2a8",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/python_hlo_runner.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Fpython_hlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f2ecdb670bbebac14aadb5da4b0abae4dc546e1d/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Fpython_hlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Fpython_hlo_runner.cc?ref=f2ecdb670bbebac14aadb5da4b0abae4dc546e1d",
            "patch": "@@ -331,8 +331,9 @@ absl::Status RegisterCustomTypeId(absl::string_view type_name,\n   }\n   XLA_FFI_TypeId* type_id_ptr =\n       reinterpret_cast<XLA_FFI_TypeId*>(static_cast<void*>(capsule.data()));\n-  return ffi::TakeStatus(ffi::Ffi::RegisterTypeId(xla::ffi::GetXlaFfiApi(),\n-                                                  type_name, type_id_ptr));\n+  XLA_FFI_TypeInfo* type_info_ptr = nullptr;\n+  return ffi::TakeStatus(ffi::Ffi::RegisterTypeId(\n+      xla::ffi::GetXlaFfiApi(), type_name, type_id_ptr, type_info_ptr));\n }\n \n NB_MODULE(py_hlo_multihost_runner, m) {"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 48,
        "deletions": 25
    }
}