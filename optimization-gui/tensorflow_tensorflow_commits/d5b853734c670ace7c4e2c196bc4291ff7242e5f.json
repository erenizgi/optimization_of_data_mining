{
    "author": "abhigunj",
    "message": "Phase Compiler: Add `program_name` field to `PjRtPartialProgramProto`.\n\nPiperOrigin-RevId: 799129193",
    "sha": "d5b853734c670ace7c4e2c196bc4291ff7242e5f",
    "files": [
        {
            "sha": "d6a81823dc92e87ff699dd8719b8f8426f995b26",
            "filename": "third_party/xla/xla/pjrt/pjrt_phase_compile_extension_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compile_extension_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compile_extension_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compile_extension_test.cc?ref=d5b853734c670ace7c4e2c196bc4291ff7242e5f",
            "patch": "@@ -63,10 +63,11 @@ constexpr absl::string_view kStablehloModuleStr = R\"(\n   }\n   )\";\n \n+constexpr absl::string_view kStablehloBytecodeFormat = \"bytecode\";\n constexpr absl::string_view kPhaseName = \"stablehlo_to_optimized_stablehlo\";\n \n std::vector<xla::PjRtPartialProgramProto> PrepareInputPartialPrograms(\n-    const std::string& next_phase, size_t program_format) {\n+    const std::string& next_phase, const absl::string_view program_format) {\n   std::string program_code{kStablehloModuleStr};\n \n   mlir::MLIRContext context;\n@@ -210,8 +211,7 @@ TEST_F(PhaseCompileExtensionTest, RunPhases) {\n   // Prepare the input programs.\n   auto partial_programs_in = PrepareInputPartialPrograms(\n       /*next_phase=*/std::string(kPhaseName),\n-      /*program_format=*/0);  // 0 expresses StableHLO bytecode per the\n-                              // sample plugin used in this test.\n+      /*program_format=*/kStablehloBytecodeFormat);\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {std::string(kPhaseName)};\n@@ -237,7 +237,7 @@ TEST_F(PhaseCompileExtensionTest,\n   // Prepare the input programs.\n   auto partial_programs_in =\n       PrepareInputPartialPrograms(/*next_phase=*/std::string(kPhaseName),\n-                                  /*program_format=*/0);\n+                                  /*program_format=*/kStablehloBytecodeFormat);\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {};\n@@ -257,7 +257,7 @@ TEST_F(PhaseCompileExtensionTest,\n   // Prepare the input programs.\n   auto partial_programs_in =\n       PrepareInputPartialPrograms(/*next_phase=*/std::string(kPhaseName),\n-                                  /*program_format=*/0);\n+                                  /*program_format=*/kStablehloBytecodeFormat);\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {\"IllegalPhaseName\"};"
        },
        {
            "sha": "66bf9a3748fffaddee8fc4b104ba85a13ffb5612",
            "filename": "third_party/xla/xla/pjrt/pjrt_phase_compile_sample_plugin.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compile_sample_plugin.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compile_sample_plugin.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compile_sample_plugin.cc?ref=d5b853734c670ace7c4e2c196bc4291ff7242e5f",
            "patch": "@@ -88,7 +88,7 @@ absl::StatusOr<std::string> StablehloTypeSerialization::Serialize(\n \n namespace {\n \n-enum SamplePartialProgramFormat { kStablehloBytecode = 0, kUnknown = -1 };\n+constexpr absl::string_view kStablehloBytecodeFormat = \"bytecode\";\n \n constexpr absl::string_view kNextPhaseName = \"some_next_phase\";\n \n@@ -99,8 +99,7 @@ absl::Status PhaseValidator(\n   }\n \n   for (const auto& input_program : input_programs) {\n-    if (input_program.program_format() !=\n-        SamplePartialProgramFormat::kStablehloBytecode) {\n+    if (input_program.program_format() != kStablehloBytecodeFormat) {\n       return absl::InvalidArgumentError(\n           \"Input programs are not in expected format.\");\n     }\n@@ -151,8 +150,7 @@ absl::StatusOr<std::vector<xla::PjRtPartialProgramProto>> PhaseCompiler(\n \n     xla::PjRtPartialProgramProto serialized_output_object;\n     serialized_output_object.set_program(serialized_output_status.value());\n-    serialized_output_object.set_program_format(\n-        static_cast<size_t>(SamplePartialProgramFormat::kStablehloBytecode));\n+    serialized_output_object.set_program_format(kStablehloBytecodeFormat);\n     serialized_output_object.set_generating_phase(kPhaseName);\n     serialized_output_object.add_next_phases({std::string(kNextPhaseName)});\n     serialized_output_object.set_version(\"1.0\");"
        },
        {
            "sha": "cc701a3b3f6ff98414f0246099ce81ad98a681c5",
            "filename": "third_party/xla/xla/pjrt/pjrt_phase_compiler_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_phase_compiler_test.cc?ref=d5b853734c670ace7c4e2c196bc4291ff7242e5f",
            "patch": "@@ -60,8 +60,10 @@ constexpr absl::string_view kStablehloModuleStr = R\"(\n   }\n   )\";\n \n+constexpr absl::string_view kStablehloBytecodeFormat = \"bytecode\";\n+\n std::vector<xla::PjRtPartialProgramProto> PrepareInputPartialPrograms(\n-    const std::string& next_phase, size_t program_format) {\n+    const std::string& next_phase, absl::string_view program_format) {\n   std::string program_code{kStablehloModuleStr};\n \n   mlir::MLIRContext context;\n@@ -136,7 +138,7 @@ TEST_F(SamplePhaseCompilerTest, TestSamplePhaseCompilerRunPhases) {\n   // Prepare the input programs.\n   auto partial_programs_in = PrepareInputPartialPrograms(\n       /*next_phase=*/std::string(phase_compile_sample_plugin::kPhaseName),\n-      /*program_format=*/0);\n+      /*program_format=*/kStablehloBytecodeFormat);\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {\n@@ -165,7 +167,7 @@ TEST_F(SamplePhaseCompilerTest,\n   std::vector<xla::PjRtPartialProgramProto> partial_programs_in =\n       PrepareInputPartialPrograms(\n           /*next_phase=*/std::string(phase_compile_sample_plugin::kPhaseName),\n-          /*program_format=*/0);\n+          /*program_format=*/kStablehloBytecodeFormat);\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {};\n@@ -189,7 +191,7 @@ TEST_F(SamplePhaseCompilerTest,\n   std::vector<xla::PjRtPartialProgramProto> partial_programs_in =\n       PrepareInputPartialPrograms(\n           /*next_phase=*/std::string(phase_compile_sample_plugin::kPhaseName),\n-          /*program_format=*/0);\n+          /*program_format=*/kStablehloBytecodeFormat);\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {\"unregistered_phase_name\"};\n@@ -226,10 +228,7 @@ TEST_F(SamplePhaseCompilerTest, PluginSpecificValidationWithUnexpectedFormat) {\n   std::vector<xla::PjRtPartialProgramProto> partial_programs_in =\n       PrepareInputPartialPrograms(\n           /*next_phase=*/std::string(phase_compile_sample_plugin::kPhaseName),\n-          /*program_format=*/1  // 1 expresses some format which is not expected\n-                                // by the sample plugin for the kPhaseName\n-                                // phase.\n-      );\n+          /*program_format=*/\"unexpected_format\");\n \n   // Run the partial compile phase.\n   std::vector<std::string> phases_to_run = {"
        },
        {
            "sha": "0da21ef7d37e8471b379a5d66416b394f3063e67",
            "filename": "third_party/xla/xla/pjrt/proto/pjrt_partial_program.proto",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fpjrt_partial_program.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5b853734c670ace7c4e2c196bc4291ff7242e5f/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fpjrt_partial_program.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fpjrt_partial_program.proto?ref=d5b853734c670ace7c4e2c196bc4291ff7242e5f",
            "patch": "@@ -11,11 +11,11 @@ message PjRtPartialProgramProto {\n   // The serialized program data. This field holds the actual program content\n   // in a specific format (e.g., StableHLO bytecode, HLOProto).\n   bytes program = 1;\n-  // An integer identifying the format of the `program` data.\n-  // This format is interpreted by the plugin (e.g., 0 for StableHLO Bytecode,\n-  // or a custom value for HLOProto). It assists in plugin-specific validation\n-  // to ensure a phase consumes compatible inputs.\n-  int32 program_format = 2;\n+  // A string identifying the format of the `program` data.\n+  // This format is interpreted by the plugin. It assists in plugin-specific\n+  // validation to ensure a phase consumes compatible inputs. It can be used\n+  // along with `program_name` to identify the program.\n+  string program_format = 2;\n   // The name of the compilation phase that generated this partial program\n   // artifact.\n   string generating_phase = 3;\n@@ -27,4 +27,9 @@ message PjRtPartialProgramProto {\n   // The version of the program format. This can be used for compatibility\n   // checks if program formats evolve over time.\n   string version = 5;\n+  // Optional. if it is set, it must be set for all output programs of that\n+  // phase, and {`program_name`, `program_format`} must be unique.\n+  // Example use case: `program_name` can be used to tie together two programs\n+  // with different `program_format` during the next phase compilation.\n+  string program_name = 6;\n }"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 25,
        "deletions": 23
    }
}