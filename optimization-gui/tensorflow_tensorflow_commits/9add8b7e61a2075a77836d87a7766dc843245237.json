{
    "author": "junwhanahn",
    "message": "Fix a bug where `S2`/`U2` dtypes were missing proto conversion\n\nAlso fixed the round trip test to not ignore `kInvalid` returned from proto conversion, which is why we didn't catch this bug.\n\nPiperOrigin-RevId: 824419619",
    "sha": "9add8b7e61a2075a77836d87a7766dc843245237",
    "files": [
        {
            "sha": "5552b0cd75ea85ffe55446e059a1c43b5564a670",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9add8b7e61a2075a77836d87a7766dc843245237/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9add8b7e61a2075a77836d87a7766dc843245237/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=9add8b7e61a2075a77836d87a7766dc843245237",
            "patch": "@@ -884,6 +884,7 @@ xla_cc_test(\n         \":serdes_version\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "729cdeda6f87a06c710883011b4622a88b763588",
            "filename": "third_party/xla/xla/python/ifrt/dtype.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9add8b7e61a2075a77836d87a7766dc843245237/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9add8b7e61a2075a77836d87a7766dc843245237/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.cc?ref=9add8b7e61a2075a77836d87a7766dc843245237",
            "patch": "@@ -138,11 +138,13 @@ absl::StatusOr<DType> DType::FromProto(const DTypeProto& dtype_proto) {\n #define CASE(X)              \\\n   case DTypeProto::KIND_##X: \\\n     return DType(DType::Kind::k##X);\n+      CASE(S2);\n       CASE(S4);\n       CASE(S8);\n       CASE(S16);\n       CASE(S32);\n       CASE(S64);\n+      CASE(U2);\n       CASE(U4);\n       CASE(U8);\n       CASE(U16);\n@@ -154,15 +156,15 @@ absl::StatusOr<DType> DType::FromProto(const DTypeProto& dtype_proto) {\n       CASE(BF16);\n       CASE(C64);\n       CASE(C128);\n-      CASE(F4E2M1FN);\n       CASE(F8E3M4);\n       CASE(F8E4M3);\n-      CASE(F8E8M0FNU);\n       CASE(F8E4M3FN);\n       CASE(F8E4M3B11FNUZ);\n       CASE(F8E4M3FNUZ);\n       CASE(F8E5M2);\n       CASE(F8E5M2FNUZ);\n+      CASE(F8E8M0FNU);\n+      CASE(F4E2M1FN);\n #undef CASE\n     case DTypeProto::KIND_STRING:\n       return DType(DType::Kind::kString);\n@@ -195,11 +197,13 @@ DTypeProto DType::ToProto(SerDesVersion version) const {\n   case DType::Kind::k##X:                       \\\n     dtype_proto.set_kind(DTypeProto::KIND_##X); \\\n     break;\n+      CASE(S2);\n       CASE(S4);\n       CASE(S8);\n       CASE(S16);\n       CASE(S32);\n       CASE(S64);\n+      CASE(U2);\n       CASE(U4);\n       CASE(U8);\n       CASE(U16);\n@@ -211,15 +215,15 @@ DTypeProto DType::ToProto(SerDesVersion version) const {\n       CASE(BF16);\n       CASE(C64);\n       CASE(C128);\n-      CASE(F4E2M1FN);\n       CASE(F8E3M4);\n       CASE(F8E4M3);\n-      CASE(F8E8M0FNU);\n       CASE(F8E4M3FN);\n       CASE(F8E4M3B11FNUZ);\n       CASE(F8E4M3FNUZ);\n       CASE(F8E5M2);\n       CASE(F8E5M2FNUZ);\n+      CASE(F8E8M0FNU);\n+      CASE(F4E2M1FN);\n #undef CASE\n     case DType::Kind::kString:\n       dtype_proto.set_kind(DTypeProto::KIND_STRING);"
        },
        {
            "sha": "d92985bacd02ae80f04d4363615ff9ceb777d83d",
            "filename": "third_party/xla/xla/python/ifrt/dtype_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9add8b7e61a2075a77836d87a7766dc843245237/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9add8b7e61a2075a77836d87a7766dc843245237/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype_test.cc?ref=9add8b7e61a2075a77836d87a7766dc843245237",
            "patch": "@@ -19,6 +19,7 @@\n #include <vector>\n \n #include <gtest/gtest.h>\n+#include \"absl/status/status_matchers.h\"\n #include \"xla/python/ifrt/dtype.pb.h\"\n #include \"xla/python/ifrt/serdes_test_util.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n@@ -39,16 +40,24 @@ class DTypeSerDesTest : public testing::TestWithParam<SerDesVersion> {\n   SerDesVersion version_;\n };\n \n+TEST_P(DTypeSerDesTest, Invalid) {\n+  DType dtype(DType::kInvalid);\n+  EXPECT_THAT(DType::FromProto(dtype.ToProto(version())),\n+              absl_testing::IsOkAndHolds(dtype));\n+}\n+\n TEST_P(DTypeSerDesTest, FromToFromProto) {\n   // Unlike other round-trip tests, this test starts from a proto because it is\n   // easier to enumerate `DTypeProto::Kind`. This is not a fundamental\n   // restriction, and this test may be rewritten as `ToFromToProto` if needed.\n-  for (int i = 0; i < DTypeProto::Kind_descriptor()->value_count(); ++i) {\n+  for (int i = 1; i < DTypeProto::Kind_descriptor()->value_count(); ++i) {\n+    SCOPED_TRACE(DTypeProto::Kind_descriptor()->value(i)->name());\n     DTypeProto proto;\n     proto.set_version_number(version().version_number().value());\n     proto.set_kind(static_cast<DTypeProto::Kind>(\n         DTypeProto::Kind_descriptor()->value(i)->number()));\n     TF_ASSERT_OK_AND_ASSIGN(DType dtype, DType::FromProto(proto));\n+    EXPECT_NE(dtype.kind(), DType::kInvalid);\n     TF_ASSERT_OK_AND_ASSIGN(DType dtype_copy,\n                             DType::FromProto(dtype.ToProto(version())));\n     EXPECT_EQ(dtype_copy, dtype);"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 19,
        "deletions": 5
    }
}