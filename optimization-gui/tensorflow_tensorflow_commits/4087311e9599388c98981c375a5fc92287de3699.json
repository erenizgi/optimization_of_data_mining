{
    "author": "tensorflower-gardener",
    "message": "Propagate `tensorflow::Context` in IFRT load sequence.\n\nPiperOrigin-RevId: 797074655",
    "sha": "4087311e9599388c98981c375a5fc92287de3699",
    "files": [
        {
            "sha": "8d82d658549591f2286c5aba6d863fee88bb0c2f",
            "filename": "tensorflow/core/tfrt/ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4087311e9599388c98981c375a5fc92287de3699/tensorflow%2Fcore%2Ftfrt%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4087311e9599388c98981c375a5fc92287de3699/tensorflow%2Fcore%2Ftfrt%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2FBUILD?ref=4087311e9599388c98981c375a5fc92287de3699",
            "patch": "@@ -364,6 +364,7 @@ cc_library(\n         \":sharding_utils\",\n         \"//tensorflow/compiler/mlir/tfrt/transforms/ifrt:ifrt_types\",\n         \"//tensorflow/core:framework\",\n+        \"//tensorflow/core/platform:context\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\","
        },
        {
            "sha": "84179adb366e50236bf06cba23f14fa622a573e4",
            "filename": "tensorflow/core/tfrt/ifrt/ifrt_loaded_variable_utils.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4087311e9599388c98981c375a5fc92287de3699/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4087311e9599388c98981c375a5fc92287de3699/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Ftfrt%2Fifrt%2Fifrt_loaded_variable_utils.cc?ref=4087311e9599388c98981c375a5fc92287de3699",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"tensorflow/core/framework/resource_handle.h\"\n #include \"tensorflow/core/framework/tensor.h\"\n #include \"tensorflow/core/framework/tensor_shape.h\"\n+#include \"tensorflow/core/platform/context.h\"\n #include \"tensorflow/core/tfrt/ifrt/ifrt_loaded_variable_registry.h\"\n #include \"tensorflow/core/tfrt/ifrt/ifrt_restore_tensor_registry.h\"\n #include \"tensorflow/core/tfrt/ifrt/sharding_utils.h\"\n@@ -124,11 +125,13 @@ absl::Status AsyncLoadRestoredTensorAsIfrtLoadedVariable(\n             {.array = loaded_variable_future});\n       }));\n \n+  tensorflow::Context bg_context(tensorflow::ContextKind::kThread);\n   restored_tensor_future.OnReady(\n       [ifrt_client = std::move(ifrt_client), &thread_pool = thread_pool,\n        checkpoint_loader_queue = checkpoint_loader_queue,\n        sharding_config = sharding_config,\n-       loaded_variable_promise = std::move(loaded_variable_promise)](\n+       loaded_variable_promise = std::move(loaded_variable_promise),\n+       bg_context = std::move(bg_context)](\n           absl::StatusOr<tensorflow::Tensor> restored_tensor) mutable {\n         if (!restored_tensor.ok()) {\n           loaded_variable_promise.Set(restored_tensor.status());\n@@ -140,8 +143,9 @@ absl::Status AsyncLoadRestoredTensorAsIfrtLoadedVariable(\n             [ifrt_client = ifrt_client, &thread_pool = thread_pool,\n              sharding_config = std::move(sharding_config),\n              restored_tensor = std::move(*restored_tensor),\n-             loaded_variable_promise =\n-                 std::move(loaded_variable_promise)]() mutable {\n+             loaded_variable_promise = std::move(loaded_variable_promise),\n+             bg_context = std::move(bg_context)]() mutable {\n+              tensorflow::WithContext wc(bg_context);\n               absl::StatusOr<xla::ifrt::ArrayRef> variable_array =\n                   LoadIfrtVariable(ifrt_client, thread_pool, restored_tensor,\n                                    sharding_config);"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 8,
        "deletions": 3
    }
}