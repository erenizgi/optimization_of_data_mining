{
    "author": "tensorflower-gardener",
    "message": "[XLA] Support passing a random engine to `LoadAndRunAndDump`\n\nBy passing a random engine the user can run HLOs with deterministic\nrandom inputs.\n\nPiperOrigin-RevId: 823184431",
    "sha": "512b85961fb0a522441a352a981a8198bab751b7",
    "files": [
        {
            "sha": "75adcfb923747dbbee877af24ad38637ecc0ba79",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc?ref=512b85961fb0a522441a352a981a8198bab751b7",
            "patch": "@@ -1223,16 +1223,17 @@ absl::Status LoadAndRunAndDump(\n     const xla::FunctionalHloRunner::RunningOptions& running_options,\n     absl::string_view hlo_file, InputFormat input_format,\n     std::string dump_output_to, int task_id, int num_nodes,\n-    std::shared_ptr<xla::KeyValueStoreInterface> kv_store) {\n+    std::shared_ptr<xla::KeyValueStoreInterface> kv_store,\n+    std::minstd_rand0* engine) {\n   TF_ASSIGN_OR_RETURN(\n       CompileOptions compile_options,\n       FunctionalHloRunner::CreateCompileOptions(client, raw_compile_options,\n                                                 task_id, num_nodes, kv_store));\n   TF_ASSIGN_OR_RETURN(\n       FunctionalHloRunner::PerDeviceLiteralVecType output,\n-      FunctionalHloRunner::LoadAndRun(client, debug_options, preproc_options,\n-                                      compile_options, running_options,\n-                                      hlo_file, input_format));\n+      FunctionalHloRunner::LoadAndRun(\n+          client, debug_options, preproc_options, compile_options,\n+          running_options, hlo_file, input_format, /*arguments=*/{}, engine));\n   return dump_output_to.empty()\n              ? absl::OkStatus()\n              : FunctionalHloRunner::DumpOutput(output, dump_output_to, task_id);"
        },
        {
            "sha": "1a878ed87d4de905d74ca2e3e64d4357414e319d",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h?ref=512b85961fb0a522441a352a981a8198bab751b7",
            "patch": "@@ -314,7 +314,8 @@ absl::Status LoadAndRunAndDump(\n     const xla::FunctionalHloRunner::RunningOptions& running_options,\n     absl::string_view hlo_file, InputFormat input_format,\n     std::string dump_output_to = \"\", int task_id = 0, int num_nodes = 1,\n-    std::shared_ptr<xla::KeyValueStoreInterface> kv_store = nullptr);\n+    std::shared_ptr<xla::KeyValueStoreInterface> kv_store = nullptr,\n+    std::minstd_rand0* engine = nullptr);\n \n // Loads an HLO module from hlo_file according to input_format and run it.\n // The HLO module is run with the provided arguments if the arguments map is"
        },
        {
            "sha": "e813ec3aa69c890da36486b3d71a286fdccc48a6",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner_test.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc?ref=512b85961fb0a522441a352a981a8198bab751b7",
            "patch": "@@ -98,6 +98,26 @@ TEST_F(FunctionalHloRunnerTest, SingleDeviceHlo) {\n       running_options, {GetHloPath(\"single_device.hlo\")}, InputFormat::kText));\n }\n \n+TEST_F(FunctionalHloRunnerTest, SingleDeviceHloWithRandomEngine) {\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::PjRtClient> client,\n+                          GetPjRtClient());\n+\n+  // Options corresponding to --num_replicas=1 --num_partitions=1\n+  xla::DebugOptions debug_options;\n+  FunctionalHloRunner::PreprocessingOptions preproc_options;\n+  FunctionalHloRunner::RawCompileOptions raw_compile_options;\n+  raw_compile_options.num_replicas = 1;\n+  raw_compile_options.num_partitions = 1;\n+  FunctionalHloRunner::RunningOptions running_options;\n+  std::minstd_rand0 engine(42);\n+\n+  TF_EXPECT_OK(FunctionalHloRunner::LoadAndRunAndDump(\n+      *client, debug_options, preproc_options, raw_compile_options,\n+      running_options, {GetHloPath(\"single_device.hlo\")}, InputFormat::kText,\n+      /*dump_output_to=*/\"\", /*task_id=*/0, /*num_nodes=*/1,\n+      /*kv_store=*/nullptr, /*engine=*/&engine));\n+}\n+\n TEST_F(FunctionalHloRunnerTest, SingleDeviceHloThroughStableHlo) {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::PjRtClient> client,\n                           GetPjRtClient());"
        },
        {
            "sha": "7b8d8a18487f56d26f9acca5fd7c1600d5fa48ea",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/hlo_runner_main.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Fhlo_runner_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/512b85961fb0a522441a352a981a8198bab751b7/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Fhlo_runner_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Fhlo_runner_main.cc?ref=512b85961fb0a522441a352a981a8198bab751b7",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <iostream>\n #include <memory>\n #include <optional>\n+#include <random>\n #include <string>\n #include <vector>\n \n@@ -98,6 +99,7 @@ struct HloRunnerConfig {\n   bool xla_dump_as_text = false;\n   bool xla_dump_as_proto = false;\n   std::string hlo_argument_mode = \"use_random_inputs\";\n+  int random_seed = -1;\n   int32_t while_execution_count = -1;\n   bool remove_infeed_outfeed = true;\n   bool compile_as_stablehlo = false;\n@@ -244,6 +246,11 @@ static absl::Status RunMultihostHloRunner(int argc, char** argv,\n   QCHECK(opts.dump_output_literal_to.empty() || argc == 2)\n       << \"Can only dump output literal when single input file is specified\";\n \n+  std::unique_ptr<std::minstd_rand0> engine = nullptr;\n+  if (opts.random_seed != -1) {\n+    engine = std::make_unique<std::minstd_rand0>(opts.random_seed);\n+  }\n+\n   QCHECK_GT(opts.gpu_client_mem_fraction, 0.0);\n   QCHECK_LT(opts.gpu_client_mem_fraction, 1.0);\n \n@@ -295,7 +302,8 @@ static absl::Status RunMultihostHloRunner(int argc, char** argv,\n       TF_RETURN_IF_ERROR(xla::FunctionalHloRunner::LoadAndRunAndDump(\n           *env.client, GetDebugOptionsFromFlags(), preproc_options,\n           raw_compile_options, running_options, hlo_file, opts.input_format,\n-          opts.dump_output_literal_to, opts.task_id));\n+          opts.dump_output_literal_to, opts.task_id, opts.num_nodes,\n+          env.kv_store, engine.get()));\n     } else {\n       std::cout << \"\\n** Compiling \" << hlo_file << \" **\\n\";\n       TF_RETURN_IF_ERROR(FunctionalHloRunner::LoadAndCompile(\n@@ -393,6 +401,10 @@ int main(int argc, char** argv) {\n                 \"use_device_id_as_input, use_random_inputs, \"\n                 \"use_shared_random_inputs, \"\n                 \"use_zeros_as_input or uninitialized.\"),\n+      tsl::Flag(\"random_seed\", &opts.random_seed,\n+                \"Seed to be used for generating random inputs when \"\n+                \"`hlo_argument_mode` is set to use_random_inputs or \"\n+                \"use_shared_random_inputs.\"),\n       tsl::Flag(\"while_execution_count\", &opts.while_execution_count,\n                 \"If set to a positive number, flatten all while loops to \"\n                 \"a certain number of iterations.\"),"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 40,
        "deletions": 6
    }
}