{
    "author": "SandSnip3r",
    "message": "Introduce DebugMeContext.\n\nDebugMeContext is a thread-local, RAII-based context manager for debugging.\n\nPiperOrigin-RevId: 805565504",
    "sha": "f291a2e7b91ae11648d30cb2c1965c30f772af71",
    "files": [
        {
            "sha": "0a0096527cef973c3f86cbd15fe6e722c79c627f",
            "filename": "third_party/xla/xla/BUILD",
            "status": "modified",
            "additions": 28,
            "deletions": 15,
            "changes": 43,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2FBUILD?ref=f291a2e7b91ae11648d30cb2c1965c30f772af71",
            "patch": "@@ -98,7 +98,6 @@ xla_cc_test(\n         \":bit_cast\",\n         \"//xla/hlo/testlib:test\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n         \"@eigen_archive//:eigen3\",\n         \"@local_tsl//tsl/platform:bfloat16\",\n     ],\n@@ -373,7 +372,6 @@ cc_library(\n     srcs = [\"permutation_util.cc\"],\n     hdrs = [\"permutation_util.h\"],\n     deps = [\n-        \":types\",\n         \"//xla/tsl/platform:logging\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log:check\",\n@@ -417,7 +415,6 @@ xla_cc_test(\n         \":util\",\n         \"//xla/hlo/testlib:test\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n     ],\n )\n \n@@ -495,13 +492,11 @@ xla_cc_test(\n     name = \"shape_pool_test\",\n     srcs = [\"shape_pool_test.cc\"],\n     deps = [\n-        \":literal_util\",\n         \":shape_pool\",\n-        \"//xla:shape_util\",\n+        \":shape_util\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/platform:test_benchmark\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n     ],\n )\n \n@@ -632,7 +627,6 @@ xla_cc_test(\n         \"//xla/hlo/testlib:test\",\n         \"//xla/tsl/platform:test_main\",\n         \"@com_google_absl//absl/types:span\",\n-        \"@com_google_googletest//:gtest\",\n     ],\n )\n \n@@ -737,7 +731,6 @@ xla_cc_test(\n         \":literal_util\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n     ],\n )\n \n@@ -869,10 +862,8 @@ cc_library(\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \":array\",\n-        \":types\",\n         \":util\",\n         \"@com_google_absl//absl/functional:function_ref\",\n-        \"@com_google_absl//absl/strings\",\n     ],\n )\n \n@@ -883,7 +874,6 @@ xla_cc_test(\n         \":array2d\",\n         \"//xla/hlo/testlib:test\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n         \"@eigen_archive//:eigen3\",\n         \"@local_tsl//tsl/platform:ml_dtypes\",\n     ],\n@@ -907,7 +897,6 @@ xla_cc_test(\n         \":types\",\n         \"//xla/hlo/testlib:test\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n     ],\n )\n \n@@ -935,7 +924,6 @@ xla_cc_test(\n         \"//xla/tsl/platform:test_main\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/types:span\",\n-        \"@com_google_googletest//:gtest\",\n         \"@eigen_archive//:eigen3\",\n     ],\n )\n@@ -1266,7 +1254,6 @@ cc_library(\n     visibility = internal_visibility([\":friends\"]),\n     deps = [\n         \"//xla/backends/cpu:alignment\",\n-        \"//xla/tsl/util:safe_reinterpret_cast\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/base:dynamic_annotations\",\n     ],\n@@ -1377,7 +1364,6 @@ xla_cc_test(\n         \"//xla/hlo/testlib:test_helpers\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test_main\",\n-        \"@com_google_googletest//:gtest\",\n     ],\n )\n \n@@ -1484,6 +1470,33 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"debug_me_context_util\",\n+    srcs = [\"debug_me_context_util.cc\"],\n+    hdrs = [\"debug_me_context_util.h\"],\n+    deps = [\n+        \"//xla/hlo/pass:hlo_pass\",\n+        \"//xla/tsl/platform:debug_me_context\",\n+        \"@com_google_absl//absl/strings\",\n+    ],\n+)\n+\n+xla_cc_test(\n+    name = \"debug_me_context_util_test\",\n+    srcs = [\"debug_me_context_util_test.cc\"],\n+    deps = [\n+        \":debug_me_context_util\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/ir:hlo_module_group\",\n+        \"//xla/hlo/pass:hlo_pass\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n xla_cc_test(\n     name = \"tuple_tree_test\",\n     srcs = [\"tuple_tree_test.cc\"],"
        },
        {
            "sha": "0d6a90425933c5b9ea290b68c4d2a6e35bef952f",
            "filename": "third_party/xla/xla/debug_me_context_util.cc",
            "status": "added",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Fdebug_me_context_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Fdebug_me_context_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_me_context_util.cc?ref=f291a2e7b91ae11648d30cb2c1965c30f772af71",
            "patch": "@@ -0,0 +1,60 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/debug_me_context_util.h\"\n+\n+#include <string>\n+#include <vector>\n+\n+#include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_join.h\"\n+#include \"xla/hlo/pass/hlo_pass_interface.h\"\n+#include \"xla/tsl/platform/debug_me_context.h\"\n+\n+namespace xla {\n+namespace debug_me_context_util {\n+\n+std::string DebugMeContextToErrorMessageString() {\n+  std::string error_message = \"DebugMeContext:\\n\";\n+  {\n+    const std::vector<std::string> compiler_values =\n+        tsl::DebugMeContext<DebugMeContextKey>::GetValues(\n+            DebugMeContextKey::kCompiler);\n+    absl::StrAppend(&error_message,\n+                    \"Compiler: \", absl::StrJoin(compiler_values, \"/\"), \"\\n\");\n+  }\n+  {\n+    const std::vector<std::string> hlo_pass_values =\n+        tsl::DebugMeContext<DebugMeContextKey>::GetValues(\n+            DebugMeContextKey::kHloPass);\n+    absl::StrAppend(&error_message,\n+                    \"HLO Passes: \", absl::StrJoin(hlo_pass_values, \"/\"), \"\\n\");\n+  }\n+  {\n+    const std::vector<std::string> hlo_instruction_values =\n+        tsl::DebugMeContext<DebugMeContextKey>::GetValues(\n+            DebugMeContextKey::kHloInstruction);\n+    absl::StrAppend(&error_message, \"HLO Instructions: \",\n+                    absl::StrJoin(hlo_instruction_values, \"/\"), \"\\n\");\n+  }\n+  return error_message;\n+}\n+\n+HloPassDebugMeContext::HloPassDebugMeContext(const HloPassInterface* pass)\n+    : tsl::DebugMeContext<DebugMeContextKey>(DebugMeContextKey::kHloPass,\n+                                             std::string(pass->name())) {}\n+\n+}  // namespace debug_me_context_util\n+}  // namespace xla"
        },
        {
            "sha": "02089332a1689b1eede8dc64ae62c1226f6d7483",
            "filename": "third_party/xla/xla/debug_me_context_util.h",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Fdebug_me_context_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Fdebug_me_context_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_me_context_util.h?ref=f291a2e7b91ae11648d30cb2c1965c30f772af71",
            "patch": "@@ -0,0 +1,62 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_DEBUG_ME_CONTEXT_UTIL_H_\n+#define XLA_DEBUG_ME_CONTEXT_UTIL_H_\n+\n+#include <string>\n+\n+#include \"xla/tsl/platform/debug_me_context.h\"\n+\n+// This file provides XLA-specific specializations and utilities for the\n+// thread-local debugging context system.\n+//\n+// The primary goal is to capture the XLA compiler's state (e.g., which HLO\n+// pass is running) to provide more insightful diagnostic and error messages.\n+//\n+// This system is built on the generic `tsl::DebugMeContext` class. For a\n+// detailed explanation of the underlying RAII mechanism and thread-local\n+// behavior, please see the comment on that class.\n+\n+namespace xla {\n+\n+// Foward declaration\n+class HloPassInterface;\n+\n+namespace debug_me_context_util {\n+\n+enum class DebugMeContextKey {\n+  kCompiler,\n+  kHloPass,\n+  kHloInstruction,\n+};\n+\n+// This function extracts all relevant context from the DebugMeContext and\n+// formats it in a way which is meant to be used when creating error messages in\n+// XLA.\n+std::string DebugMeContextToErrorMessageString();\n+\n+// This class is a specialization of the RAII DebugMeContext specifically for\n+// HloPasses. The details of its constructor dictate what information from the\n+// HloPass is stored in the context.\n+class HloPassDebugMeContext : public tsl::DebugMeContext<DebugMeContextKey> {\n+ public:\n+  explicit HloPassDebugMeContext(const HloPassInterface* pass);\n+};\n+\n+}  // namespace debug_me_context_util\n+}  // namespace xla\n+\n+#endif  // XLA_DEBUG_ME_CONTEXT_UTIL_H_"
        },
        {
            "sha": "33f805b126e3ce286b893d464a7b4ecf1a310867",
            "filename": "third_party/xla/xla/debug_me_context_util_test.cc",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Fdebug_me_context_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Fdebug_me_context_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_me_context_util_test.cc?ref=f291a2e7b91ae11648d30cb2c1965c30f772af71",
            "patch": "@@ -0,0 +1,59 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/debug_me_context_util.h\"\n+\n+#include <string>\n+\n+#include <gtest/gtest.h>\n+#include \"absl/container/flat_hash_set.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/match.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n+#include \"xla/hlo/ir/hlo_module_group.h\"\n+#include \"xla/hlo/pass/hlo_pass_interface.h\"\n+\n+namespace xla {\n+namespace {\n+\n+TEST(DebugMeContextUtil, BasicHloPass) {\n+  // Define a custom HLO pass.\n+  class TestPass : public HloPassInterface {\n+   public:\n+    absl::string_view name() const override { return \"hello123123\"; }\n+    absl::StatusOr<bool> Run(HloModule* module,\n+                             const absl::flat_hash_set<absl::string_view>&\n+                                 execution_threads) override {\n+      return false;\n+    }\n+    absl::StatusOr<bool> RunOnModuleGroup(\n+        HloModuleGroup* module_group,\n+        const absl::flat_hash_set<absl::string_view>& execution_threads)\n+        override {\n+      return false;\n+    }\n+  };\n+\n+  TestPass test_pass;\n+  debug_me_context_util::HloPassDebugMeContext ctx(&test_pass);\n+  const std::string error_message =\n+      debug_me_context_util::DebugMeContextToErrorMessageString();\n+\n+  EXPECT_TRUE(absl::StrContains(error_message, test_pass.name()));\n+}\n+\n+}  // namespace\n+}  // namespace xla"
        },
        {
            "sha": "c38aee9cbd918a914d4a2dce5eec3fc3d32cd616",
            "filename": "third_party/xla/xla/tsl/platform/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD?ref=f291a2e7b91ae11648d30cb2c1965c30f772af71",
            "patch": "@@ -868,3 +868,9 @@ cc_library(\n     textual_hdrs = [\"recordphase.h\"],\n     deps = tf_platform_deps(\"recordphase\") + [\"@com_google_absl//absl/strings:string_view\"],\n )\n+\n+cc_library(\n+    name = \"debug_me_context\",\n+    hdrs = [\"debug_me_context.h\"],\n+    deps = [\"@com_google_absl//absl/container:flat_hash_map\"],\n+)"
        },
        {
            "sha": "46e82810e0b92f2814a37b2304f8fe712adbde3d",
            "filename": "third_party/xla/xla/tsl/platform/debug_me_context.h",
            "status": "added",
            "additions": 116,
            "deletions": 0,
            "changes": 116,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdebug_me_context.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f291a2e7b91ae11648d30cb2c1965c30f772af71/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdebug_me_context.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdebug_me_context.h?ref=f291a2e7b91ae11648d30cb2c1965c30f772af71",
            "patch": "@@ -0,0 +1,116 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_TSL_PLATFORM_DEBUG_ME_CONTEXT_H_\n+#define XLA_TSL_PLATFORM_DEBUG_ME_CONTEXT_H_\n+\n+#include <string>\n+#include <type_traits>\n+#include <vector>\n+\n+#include \"absl/container/flat_hash_map.h\"\n+\n+namespace tsl {\n+\n+// DebugMeContext: A thread-local, RAII-based context manager for debugging.\n+//\n+// This class provides a mechanism to associate contextual string information\n+// with specific keys within a given scope. It is designed to be used with the\n+// RAII (Resource Acquisition Is Initialization) pattern: creating an object on\n+// the stack pushes a context string, and the context is automatically popped\n+// when the object goes out of scope.\n+//\n+// Typical usage involves creating an instance of `DebugMeContext` at the\n+// beginning of a scope (e.g., a function, a loop, or a compiler pass) to \"tag\"\n+// that scope with some information. Deeper in the call stack, other code can\n+// then retreive the current context.\n+//\n+//\n+// Note: The entire context is thread-local, meaning each thread maintains its\n+// own independent set of key-value stacks. If you are spawning new threads and\n+// want the context to carry forward, it is your responsibility to shuttle the\n+// context over the boundary between threads.\n+//\n+//\n+// Example usage:\n+//\n+//   // 1. Define the types of context you want to track.\n+//   enum class DebugContextKey { kCompilerPass, kModuleName };\n+//\n+//   void RunMyCompilerPass() {\n+//     // 2. At the start of the pass, push the pass name onto the context\n+//     stack. DebugMeContext<DebugContextKey>\n+//     ctx(DebugContextKey::kCompilerPass, \"MyPass\");\n+//\n+//     // 3. Now, any code executed before `ctx` goes out of scope, when\n+//     querying the context, will see \"MyPass\" on the kCompilerPass context\n+//     stack. GenerateError(\"Something went wrong\");\n+//\n+//   } // <-- `ctx` is destroyed here, and \"MyPass\" is popped from the stack.\n+//\n+//   void GenerateError(const std::string& msg) {\n+//     // 4. Retrieve the current compiler pass stack.\n+//     std::vector<std::string> pass_stack =\n+//         DebugMeContext<DebugContextKey>::GetValues(DebugContextKey::kCompilerPass);\n+//     if (!pass_stack.empty()) {\n+//       // pass_stack.back() will be \"MyPass\"\n+//       LOG(ERROR) << \"Error in pass '\" << pass_stack.back() << \"': \" << msg;\n+//     }\n+//   }\n+//\n+//\n+// Template Parameters:\n+//   KeyType: An enum used to identify different context stacks.\n+template <typename KeyType,\n+          typename = std::enable_if_t<std::is_enum_v<KeyType>>>\n+class DebugMeContext {\n+ public:\n+  DebugMeContext(KeyType key, const std::string& value) : key_(key) {\n+    std::vector<std::string>& value_stack = context_.key_value_stack_map[key];\n+    value_stack.push_back(value);\n+  }\n+  ~DebugMeContext() {\n+    std::vector<std::string>& value_stack = context_.key_value_stack_map[key_];\n+    value_stack.pop_back();\n+  }\n+  static std::vector<std::string> GetValues(KeyType key) {\n+    // Here we use a const reference of `context_` to try to minimize the chance\n+    // of this function modifying `context_`.\n+    const Context& const_context = context_;\n+    auto it = const_context.key_value_stack_map.find(key);\n+    if (it == const_context.key_value_stack_map.end()) {\n+      // Key does not exist in map.\n+      return {};\n+    }\n+    return it->second;\n+  }\n+\n+ private:\n+  struct Context {\n+    absl::flat_hash_map<KeyType, std::vector<std::string>> key_value_stack_map;\n+  };\n+\n+  // We disable linting here to avoid complaints about global (static) variables\n+  // with non-trivial destructors (\"static deinitialization order fiasco\").\n+  // thread_locals are not subject to this potential problem because only the\n+  // owning thread is calling the destructors, which, by definition, means that\n+  // the thread is not also using the object.\n+  inline static thread_local Context context_;  // NOLINT\n+  const KeyType key_;\n+};\n+\n+}  // namespace tsl\n+\n+#endif  // XLA_TSL_PLATFORM_DEBUG_ME_CONTEXT_H_"
        }
    ],
    "stats": {
        "total": 346,
        "additions": 331,
        "deletions": 15
    }
}