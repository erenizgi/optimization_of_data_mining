{
    "author": "hhb",
    "message": "Refactor PjRtTopologyDescription serialization/deserialization.\n\nMove platform-specific `ToProto` and `FromProto` logic from `pjrt_topology_utils.cc` into the respective `PjRtTopologyDescription` subclasses.\n\nPiperOrigin-RevId: 816488071",
    "sha": "54554cbfd16f6e90dd7859545a315da80481c75c",
    "files": [
        {
            "sha": "3a71ee97753b31b434288f28fd58fe3865f70436",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_topology_description.cc",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.cc?ref=54554cbfd16f6e90dd7859545a315da80481c75c",
            "patch": "@@ -27,6 +27,8 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"xla/layout.h\"\n #include \"xla/layout_util.h\"\n+#include \"xla/pjrt/gpu/gpu_topology.h\"\n+#include \"xla/pjrt/pjrt_compiler.h\"\n #include \"xla/pjrt/pjrt_device_description.h\"\n #include \"xla/pjrt/pjrt_stream_executor_device_description.h\"\n #include \"xla/primitive_util.h\"\n@@ -152,4 +154,38 @@ absl::StatusOr<Layout> StreamExecutorGpuTopologyDescription::GetDefaultLayout(\n   return layout;\n }\n \n+absl::StatusOr<xla::PjRtTopologyDescriptionProto>\n+StreamExecutorGpuTopologyDescription::ToProto() const {\n+  PjRtTopologyDescriptionProto proto;\n+  proto.set_platform_id(platform_id());\n+  proto.set_platform_name(platform_name());\n+  proto.set_platform_version(platform_version());\n+  proto.set_is_subslice_topology(is_subslice_topology());\n+\n+  GpuTopologyProto gpu_topology_proto = gpu_topology_->ToProto();\n+  proto.mutable_platform_specific_topology()->PackFrom(gpu_topology_proto);\n+  return proto;\n+}\n+\n+absl::StatusOr<std::unique_ptr<StreamExecutorGpuTopologyDescription>>\n+StreamExecutorGpuTopologyDescription::FromProto(\n+    const xla::PjRtTopologyDescriptionProto& proto) {\n+  if (proto.platform_id() != xla::CudaId() &&\n+      proto.platform_id() != xla::RocmId()) {\n+    return absl::InvalidArgumentError(\n+        absl::StrCat(\"The platform_id is not a GPU platform. platform_id: \",\n+                     proto.platform_id()));\n+  }\n+  if (!proto.platform_specific_topology().Is<GpuTopologyProto>()) {\n+    return absl::InvalidArgumentError(\n+        \"The platform_specific_topology is not a GpuTopologyProto.\");\n+  }\n+  GpuTopologyProto gpu_topology_proto;\n+  proto.platform_specific_topology().UnpackTo(&gpu_topology_proto);\n+  auto gpu_topology = std::shared_ptr<const GpuTopology>(\n+      GpuTopology::FromProto(gpu_topology_proto));\n+  return std::make_unique<StreamExecutorGpuTopologyDescription>(\n+      proto.platform_id(), proto.platform_name(), std::move(gpu_topology));\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "33bbc77797ebdda2fb912abba40b360f92124007",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_topology_description.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.h?ref=54554cbfd16f6e90dd7859545a315da80481c75c",
            "patch": "@@ -117,6 +117,11 @@ class StreamExecutorGpuTopologyDescription : public PjRtTopologyDescription {\n       PrimitiveType element_type,\n       absl::Span<const int64_t> dims) const override;\n \n+  absl::StatusOr<xla::PjRtTopologyDescriptionProto> ToProto() const override;\n+\n+  static absl::StatusOr<std::unique_ptr<StreamExecutorGpuTopologyDescription>>\n+  FromProto(const xla::PjRtTopologyDescriptionProto& proto);\n+\n  private:\n   const PjRtPlatformId platform_id_;\n   const std::string platform_name_;"
        },
        {
            "sha": "71b48b4150adf4d50ea5128e7a34f893064246c0",
            "filename": "third_party/xla/xla/pjrt/plugin/xla_cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2FBUILD?ref=54554cbfd16f6e90dd7859545a315da80481c75c",
            "patch": "@@ -87,6 +87,7 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n     ],"
        },
        {
            "sha": "bc6e2840642fe7c89b112635a0f527e8b90ecc33",
            "filename": "third_party/xla/xla/pjrt/plugin/xla_cpu/cpu_topology_description.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.cc?ref=54554cbfd16f6e90dd7859545a315da80481c75c",
            "patch": "@@ -22,11 +22,11 @@ limitations under the License.\n \n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/layout.h\"\n #include \"xla/layout_util.h\"\n-#include \"xla/pjrt/pjrt_client.h\"\n #include \"xla/pjrt/pjrt_compiler.h\"\n #include \"xla/pjrt/pjrt_device_description.h\"\n #include \"xla/pjrt/plugin/xla_cpu/cpu_device_description.h\"\n@@ -62,4 +62,42 @@ CpuTopologyDescription::DeviceDescriptions() const {\n   return devices;\n }\n \n+absl::StatusOr<xla::PjRtTopologyDescriptionProto>\n+CpuTopologyDescription::ToProto() const {\n+  PjRtTopologyDescriptionProto proto;\n+  proto.set_platform_id(platform_id());\n+  proto.set_platform_name(platform_name());\n+  proto.set_platform_version(platform_version());\n+  proto.set_is_subslice_topology(is_subslice_topology());\n+\n+  CpuTopologyProto cpu_topology_proto = cpu_topology_.ToProto();\n+  proto.mutable_platform_specific_topology()->PackFrom(cpu_topology_proto);\n+  return proto;\n+}\n+\n+absl::StatusOr<std::unique_ptr<CpuTopologyDescription>>\n+CpuTopologyDescription::FromProto(\n+    const xla::PjRtTopologyDescriptionProto& proto) {\n+  if (proto.platform_id() != xla::CpuId()) {\n+    return absl::InvalidArgumentError(\n+        absl::StrCat(\"The platform_id is not a CPU platform. platform_id: \",\n+                     proto.platform_id()));\n+  }\n+\n+  if (!proto.platform_specific_topology().Is<CpuTopologyProto>()) {\n+    return absl::InvalidArgumentError(\n+        \"The platform_specific_topology is not a CpuTopologyProto.\");\n+  }\n+  CpuTopologyProto cpu_topology_proto;\n+  proto.platform_specific_topology().UnpackTo(&cpu_topology_proto);\n+  auto cpu_topology = std::shared_ptr<const CpuTopology>(\n+      CpuTopology::FromProto(cpu_topology_proto));\n+  std::vector<xla::CpuTopology::CpuDevice> cpu_devices;\n+  cpu_devices.assign(cpu_topology->devices().begin(),\n+                     cpu_topology->devices().end());\n+  return std::make_unique<CpuTopologyDescription>(\n+      proto.platform_id(), proto.platform_name(), proto.platform_version(),\n+      cpu_devices, cpu_topology->machine_attributes());\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "c445227616b5b8dd372adc98592a51f141322fb0",
            "filename": "third_party/xla/xla/pjrt/plugin/xla_cpu/cpu_topology_description.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/54554cbfd16f6e90dd7859545a315da80481c75c/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.h?ref=54554cbfd16f6e90dd7859545a315da80481c75c",
            "patch": "@@ -107,6 +107,11 @@ class CpuTopologyDescription : public PjRtTopologyDescription {\n       PrimitiveType element_type,\n       absl::Span<const int64_t> dims) const override;\n \n+  absl::StatusOr<xla::PjRtTopologyDescriptionProto> ToProto() const override;\n+\n+  static absl::StatusOr<std::unique_ptr<CpuTopologyDescription>> FromProto(\n+      const xla::PjRtTopologyDescriptionProto& proto);\n+\n  private:\n   const PjRtPlatformId platform_id_;\n   const std::string platform_name_;"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 86,
        "deletions": 1
    }
}