{
    "author": "Becker-ZH",
    "message": "Expose system memory buffer size for PM Sampling\n\nPiperOrigin-RevId: 816827286",
    "sha": "0e19549ccf3ff4c3724ecf07e8db54e40bd6e173",
    "files": [
        {
            "sha": "8d43b3cb04171b16ea942f2b9fc9c41e19209769",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_pm_sampler.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0e19549ccf3ff4c3724ecf07e8db54e40bd6e173/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_pm_sampler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0e19549ccf3ff4c3724ecf07e8db54e40bd6e173/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_pm_sampler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_pm_sampler.h?ref=0e19549ccf3ff4c3724ecf07e8db54e40bd6e173",
            "patch": "@@ -40,7 +40,8 @@ struct CuptiPmSamplerOptions {\n   bool enable = false;\n   // List of metrics to enable\n   std::vector<std::string> metrics{};\n-  // 64MB hardware buffer (on device)\n+  // Pinned system memory buffer size in bytes to process PM counters\n+  // Default: 64MB, Max: 4GB\n   size_t hw_buf_size = 64 * 1024 * 1024;\n   // Sample interval of 500,000ns = 2khz\n   size_t sample_interval_ns = 500'000;"
        },
        {
            "sha": "1f7de88ad55802b3f0076210b8fbcbb81cc84a72",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_tracer_options_utils.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0e19549ccf3ff4c3724ecf07e8db54e40bd6e173/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer_options_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0e19549ccf3ff4c3724ecf07e8db54e40bd6e173/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer_options_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer_options_utils.cc?ref=0e19549ccf3ff4c3724ecf07e8db54e40bd6e173",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/backends/profiler/gpu/cupti_tracer_options_utils.h\"\n \n+#include <algorithm>\n #include <cstdint>\n #include <functional>\n #include <string>\n@@ -38,6 +39,9 @@ namespace xla {\n namespace profiler {\n using tsl::profiler::SetValue;\n \n+constexpr int64_t kMinBufferSize = 64;    // 64MB\n+constexpr int64_t kMaxBufferSize = 4096;  // 4GB\n+\n absl::Status UpdateCuptiTracerOptionsFromProfilerOptions(\n     const tensorflow::ProfileOptions& profile_options,\n     CuptiTracerOptions& tracer_options,\n@@ -100,6 +104,14 @@ absl::Status UpdateCuptiTracerOptionsFromProfilerOptions(\n         tracer_options.pm_sampler_options.sample_interval_ns = value * 1000;\n       }));\n \n+  TF_RETURN_IF_ERROR(SetValue<int64_t>(\n+      profile_options, \"gpu_pm_sample_buffer_size_per_gpu_mb\", input_keys,\n+      [&](int64_t value) {\n+        tracer_options.pm_sampler_options.hw_buf_size =\n+            std::clamp(value, kMinBufferSize, kMaxBufferSize) * 1024ULL *\n+            1024ULL;\n+      }));\n+\n   if (!input_keys.empty()) {\n     return absl::InvalidArgumentError(absl::StrCat(\n         \"Parsing advanced_configuration failed for CUPTI tracer. The following \""
        }
    ],
    "stats": {
        "total": 15,
        "additions": 14,
        "deletions": 1
    }
}