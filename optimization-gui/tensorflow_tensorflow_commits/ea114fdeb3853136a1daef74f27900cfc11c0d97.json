{
    "author": "ICGog",
    "message": "[XLA:CPU] Add run_id to XLA:CPU ExecuteHelper and ThunkExecutor::Execute (wait for completion).\n\nPiperOrigin-RevId: 801009210",
    "sha": "ea114fdeb3853136a1daef74f27900cfc11c0d97",
    "files": [
        {
            "sha": "97e8d24746408116e25cc12769b61dba765a98c8",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 14,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ea114fdeb3853136a1daef74f27900cfc11c0d97/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ea114fdeb3853136a1daef74f27900cfc11c0d97/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=ea114fdeb3853136a1daef74f27900cfc11c0d97",
            "patch": "@@ -1262,7 +1262,14 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n     const RunId& run_id, const ExecuteOptions& options,\n     PjRtCpuClient::CollectiveLaunchEvent last_collective_launch_event,\n     bool fill_future, PjRtCpuDevice* device) const {\n-  tsl::profiler::TraceMe traceme(\"PjRtCpuExecutable::ExecuteHelper\");\n+  tsl::profiler::TraceMe traceme([&]() {\n+    return tsl::profiler::TraceMeEncode(\"PjRtCpuExecutable::ExecuteHelper\",\n+                                        {\n+                                            {\"run_id\", run_id.ToInt()},\n+                                            {\"replica\", replica},\n+                                            {\"partition\", partition},\n+                                        });\n+  });\n \n   std::shared_ptr<DeviceAssignment> device_assignment;\n   if (device == nullptr) {\n@@ -1572,8 +1579,12 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n \n       thunks_execute_event = cpu_executable->thunks().Execute(execute_params);\n \n-      tsl::profiler::TraceMe trace(\n-          \"ThunkExecutor::Execute (wait for completion)\");\n+      tsl::profiler::TraceMe trace([&] {\n+        return tsl::profiler::TraceMeEncode(\n+            \"ThunkExecutor::Execute (wait for completion)\",\n+            {{\"run_id\", run_options.run_id().ToInt()},\n+             {\"device_ordinal\", run_options.device_ordinal()}});\n+      });\n       tsl::BlockUntilReady(thunks_execute_event);\n \n     } else {\n@@ -1704,8 +1715,12 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n               auto thunks_execute_event =\n                   cpu_executable->thunks().Execute(execute_params);\n \n-              tsl::profiler::TraceMe trace(\n-                  \"ThunkExecutor::Execute (wait for completion)\");\n+              tsl::profiler::TraceMe trace([&] {\n+                return tsl::profiler::TraceMeEncode(\n+                    \"ThunkExecutor::Execute (wait for completion)\",\n+                    {{\"run_id\", run_options.run_id().ToInt()},\n+                     {\"device_ordinal\", run_options.device_ordinal()}});\n+              });\n               tsl::BlockUntilReady(thunks_execute_event);\n               status = thunks_execute_event.IsError()\n                            ? thunks_execute_event.GetError()\n@@ -1823,9 +1838,7 @@ PjRtCpuExecutable::Execute(\n     const ExecuteOptions& options,\n     std::optional<std::vector<PjRtFuture<>>>& returned_futures) const {\n   RunId run_id(options.launch_id);\n-  tsl::profiler::TraceMeProducer activity(\"PjRtCpuExecutable::Execute\",\n-                                          tsl::profiler::ContextType::kPjRt,\n-                                          run_id.ToInt());\n+  tsl::profiler::TraceMe trace_me(\"PjRtCpuExecutable::Execute\");\n   if (!options.untuple_result && cpu_executable_->module()\n                                      .config()\n                                      .entry_computation_layout()\n@@ -1963,9 +1976,7 @@ PjRtCpuExecutable::ExecuteSharded(\n     const ExecuteOptions& options, std::optional<PjRtFuture<>>& returned_future,\n     bool fill_future) const {\n   RunId run_id(options.launch_id);\n-  tsl::profiler::TraceMeProducer activity(\"PjRtCpuExecutable::ExecuteSharded\",\n-                                          tsl::profiler::ContextType::kPjRt,\n-                                          run_id.ToInt());\n+  tsl::profiler::TraceMe trace_me(\"PjRtCpuExecutable::ExecuteSharded\");\n   if (device_assignment_ == nullptr) {\n     return InvalidArgument(\"ExecuteShard expects a non-null device_assignment\");\n   }\n@@ -2004,9 +2015,7 @@ PjRtCpuExecutable::ExecutePortable(\n     const ExecuteOptions& options, std::optional<PjRtFuture<>>& returned_future,\n     bool fill_future) const {\n   RunId run_id(options.launch_id);\n-  tsl::profiler::TraceMeProducer activity(\"PjRtCpuExecutable::ExecutePortable\",\n-                                          tsl::profiler::ContextType::kPjRt,\n-                                          run_id.ToInt());\n+  tsl::profiler::TraceMe trace_me(\"PjRtCpuExecutable::ExecutePortable\");\n   if (device_assignment_ != nullptr) {\n     return InvalidArgument(\"ExecutePortable gets a non-portable executable\");\n   }"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 23,
        "deletions": 14
    }
}