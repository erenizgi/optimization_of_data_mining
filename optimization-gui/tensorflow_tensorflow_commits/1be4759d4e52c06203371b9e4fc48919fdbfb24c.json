{
    "author": "qukhan",
    "message": "Detect potential race conditions in the XNNPack weight cache provider usage.\n\nPiperOrigin-RevId: 827946950",
    "sha": "1be4759d4e52c06203371b9e4fc48919fdbfb24c",
    "files": [
        {
            "sha": "e9ccdbfd8eedd9f0312e5cc7e8cc34449ffde553",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1be4759d4e52c06203371b9e4fc48919fdbfb24c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1be4759d4e52c06203371b9e4fc48919fdbfb24c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=1be4759d4e52c06203371b9e4fc48919fdbfb24c",
            "patch": "@@ -144,7 +144,11 @@ bool WeightCacheBuilder::Start(const char* path, const FileDescriptor& fd) {\n }\n \n bool WeightCacheBuilder::StartBuildStep() {\n-  XNNPACK_RETURN_CHECK(IsStarted());\n+  XNNPACK_RETURN_CHECK(IsStarted(),\n+                       \"Trying to start a build step in an invalid builder.\")\n+  XNNPACK_RETURN_CHECK(!is_build_step_.exchange(true),\n+                       \"Failed to start build step: already started. This may \"\n+                       \"be a concurrency issue.\");\n \n   // Reload flatbuffer data.\n   XNNPackCacheHeader header;\n@@ -169,7 +173,6 @@ bool WeightCacheBuilder::StartBuildStep() {\n   build_segment_start_ = fd_.SetPos(header.buffer_list_offset);\n   XNNPACK_RETURN_CHECK(build_segment_start_ != -1);\n \n-  is_build_step_ = true;\n   return true;\n }\n \n@@ -216,14 +219,12 @@ BufferLocation WeightCacheBuilder::Append(PackIdentifier pack_id,\n }\n \n bool WeightCacheBuilder::StopBuildStep() {\n-  if (!is_build_step_) {\n-    return true;\n-  }\n-  XNNPACK_RETURN_CHECK(fd_.IsValid(),\n-                       \"cache file ('%s') is not open for writing: %s.\",\n-                       file_path_.c_str(), strerror(errno));\n+  XNNPACK_RETURN_CHECK(is_build_step_,\n+                       \"Attempting to stop a non existing build step. This may \"\n+                       \"be a concurrency issue.\");\n+  XNNPACK_RETURN_CHECK(fd_.IsValid(), \"cache file ('%s') is not open.\",\n+                       file_path_.c_str());\n \n-  is_build_step_ = false;\n   if (fd_.GetPos() == build_segment_start_ && first_write_done_) {\n     // Nothing was written to the file, we can exit early.\n     return true;\n@@ -271,6 +272,7 @@ bool WeightCacheBuilder::StopBuildStep() {\n   TFLITE_LOG_PROD(tflite::TFLITE_LOG_VERBOSE,\n                   \"XNNPack weight cache: written to '%s'.\", file_path_.c_str());\n   first_write_done_ = true;\n+  is_build_step_ = false;\n   return true;\n }\n "
        },
        {
            "sha": "7dd04a20f2095f66ce727498b1b0bbacc87e90b8",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1be4759d4e52c06203371b9e4fc48919fdbfb24c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1be4759d4e52c06203371b9e4fc48919fdbfb24c/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h?ref=1be4759d4e52c06203371b9e4fc48919fdbfb24c",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n #ifndef TENSORFLOW_LITE_DELEGATES_XNNPACK_WEIGHT_CACHE_H_\n #define TENSORFLOW_LITE_DELEGATES_XNNPACK_WEIGHT_CACHE_H_\n \n+#include <atomic>\n #include <cstddef>\n #include <cstdint>\n #include <functional>\n@@ -205,7 +206,7 @@ class WeightCacheBuilder {\n   FileDescriptorView fd_;\n   std::string file_path_;\n \n-  bool is_build_step_ = false;\n+  std::atomic<bool> is_build_step_ = false;\n };\n \n // Allows XNNPack to directly load packed weights from disk instead of having to"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 13,
        "deletions": 10
    }
}