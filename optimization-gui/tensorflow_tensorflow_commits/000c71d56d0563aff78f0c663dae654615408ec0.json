{
    "author": "WillFroom",
    "message": "[XLA:CPU] Don't run the full optimization pipeline in the tree reduction test.\n\nPiperOrigin-RevId: 803171404",
    "sha": "000c71d56d0563aff78f0c663dae654615408ec0",
    "files": [
        {
            "sha": "7eb7a0e441e84942eff2085e3b863a03bbf47bc5",
            "filename": "third_party/xla/xla/service/cpu/tests/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/000c71d56d0563aff78f0c663dae654615408ec0/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/000c71d56d0563aff78f0c663dae654615408ec0/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD?ref=000c71d56d0563aff78f0c663dae654615408ec0",
            "patch": "@@ -183,8 +183,15 @@ xla_cc_test(\n     srcs = [\"tree_reduction_rewriter_test.cc\"],\n     deps = [\n         \":cpu_codegen_test_main\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/testlib:filecheck\",\n+        \"//xla/hlo/transforms/simplifiers:tree_reduction_rewriter\",\n         \"//xla/service/cpu:cpu_compiler\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings:string_view\",\n     ],\n )\n "
        },
        {
            "sha": "3f62aa6ac503ed0db0589169bbc4a23f330ff5ff",
            "filename": "third_party/xla/xla/service/cpu/tests/tree_reduction_rewriter_test.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 9,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/000c71d56d0563aff78f0c663dae654615408ec0/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Ftree_reduction_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/000c71d56d0563aff78f0c663dae654615408ec0/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Ftree_reduction_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Ftree_reduction_rewriter_test.cc?ref=000c71d56d0563aff78f0c663dae654615408ec0",
            "patch": "@@ -13,15 +13,39 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include \"xla/hlo/transforms/simplifiers/tree_reduction_rewriter.h\"\n+\n+#include <memory>\n+\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n+#include \"xla/hlo/testlib/filecheck.h\"\n #include \"xla/service/cpu/tests/cpu_codegen_test.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n \n namespace xla {\n namespace cpu {\n \n namespace {\n \n-class TreeReductionRewriterTest : public CpuCodegenTest {};\n+class TreeReductionRewriterTest : public CpuCodegenTest {\n+ public:\n+  void MatchTreeReducedHlo(absl::string_view hlo, absl::string_view pattern) {\n+    TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> optimized_module,\n+                            ParseAndReturnVerifiedModule(hlo));\n+\n+    TreeReductionRewriter tree_reduction_rewriter;\n+    TF_ASSERT_OK(tree_reduction_rewriter.Run(optimized_module.get()));\n+\n+    absl::StatusOr<bool> filecheck_result =\n+        RunFileCheck(optimized_module->ToString(), pattern);\n+    TF_ASSERT_OK(filecheck_result.status());\n+    EXPECT_TRUE(filecheck_result.value());\n+  }\n+};\n \n TEST_F(TreeReductionRewriterTest, SimpleRewrite) {\n   const char* hlo_text = R\"(\n@@ -40,8 +64,8 @@ ENTRY main {\n }\n   )\";\n \n-  MatchOptimizedHlo(hlo_text,\n-                    R\"(\n+  MatchTreeReducedHlo(hlo_text,\n+                      R\"(\n ; CHECK-LABEL: ENTRY %main (input: f32[1000]) -> f32[] {\n ; CHECK-NEXT:    [[INSTR_0:%[^ ]+]] = f32[1000]{0} parameter(0)\n ; CHECK-NEXT:    [[INSTR_1:%[^ ]+]] = f32[] constant(0)\n@@ -67,8 +91,8 @@ ENTRY main {\n }\n   )\";\n \n-  MatchOptimizedHlo(hlo_text,\n-                    R\"(\n+  MatchTreeReducedHlo(hlo_text,\n+                      R\"(\n ; CHECK:    [[INSTR_0:%[^ ]+]] = f32[4,4]{1,0} reduce-window([[INSTR_1:%[^ ]+]], [[INSTR_2:%[^ ]+]]), window={size=32x32 stride=32x32 pad=14_14x14_14}, to_apply=[[INSTR_3:%[^ ]+]]\n ; CHECK-NEXT: ROOT [[INSTR_4:%[^ ]+]] = f32[] reduce([[INSTR_0]], [[INSTR_2]]), dimensions={0,1}, to_apply=[[INSTR_3]]\n       )\");\n@@ -91,8 +115,8 @@ ENTRY main {\n }\n   )\";\n \n-  MatchOptimizedHlo(hlo_text,\n-                    R\"(\n+  MatchTreeReducedHlo(hlo_text,\n+                      R\"(\n ; CHECK:    [[INSTR_0:%[^ ]+]] = f32[32,1]{1,0} reduce-window([[INSTR_1:%[^ ]+]], [[INSTR_2:%[^ ]+]]), window={size=32x31 stride=32x31 pad=12_12x0_0}, to_apply=[[INSTR_3:%[^ ]+]]\n ; CHECK-NEXT: ROOT [[INSTR_4:%[^ ]+]] = f32[] reduce([[INSTR_0]], [[INSTR_2]]), dimensions={0,1}, to_apply=[[INSTR_3]]\n       )\");\n@@ -115,8 +139,8 @@ ENTRY main {\n }\n   )\";\n \n-  MatchOptimizedHlo(hlo_text,\n-                    R\"(\n+  MatchTreeReducedHlo(hlo_text,\n+                      R\"(\n // CHECK: ROOT [[INSTR_0:%[^ ]+]] = f32[] reduce([[INSTR_1:%[^ ]+]], [[INSTR_2:%[^ ]+]]), dimensions={0,1}, to_apply=[[INSTR_3:%[^ ]+]]\n       )\");\n }"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 40,
        "deletions": 9
    }
}