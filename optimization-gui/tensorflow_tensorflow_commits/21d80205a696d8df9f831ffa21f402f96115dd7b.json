{
    "author": "hhb",
    "message": "Add PJRT_Buffer_DonateWithControlDependency to the PJRT C API.\n\nPiperOrigin-RevId: 847868215",
    "sha": "21d80205a696d8df9f831ffa21f402f96115dd7b",
    "files": [
        {
            "sha": "2818e8ea62f00f2de1bef75cd570e1eecc6b9c68",
            "filename": "third_party/xla/xla/pjrt/c/CHANGELOG.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -1,5 +1,9 @@\n # PJRT C API changelog\n \n+## 0.88\n+\n+* Add `PJRT_Buffer_DonateWithControlDependency`.\n+\n ## 0.87\n \n * Add `PJRT_Executable_GetCompileOptions`."
        },
        {
            "sha": "dd3bf0f8cc9a003a25a9a78800b7fb3dd8953ee4",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api.h",
            "status": "modified",
            "additions": 30,
            "deletions": 2,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -104,7 +104,7 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Extension_Base, next);\n // Changes include:\n // * Adding a new field to the PJRT_Api or argument structs\n // * Renaming a method or argument (doesn't affect ABI)\n-#define PJRT_API_MINOR 87\n+#define PJRT_API_MINOR 88\n \n // The plugin should set the major_version and minor_version of\n // PJRT_Api.pjrt_api_version to be the `PJRT_API_MAJOR` and `PJRT_API_MINOR` in\n@@ -2464,6 +2464,33 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Buffer_OpaqueDeviceMemoryDataPointer_Args,\n typedef PJRT_Error* PJRT_Buffer_OpaqueDeviceMemoryDataPointer(\n     PJRT_Buffer_OpaqueDeviceMemoryDataPointer_Args* args);\n \n+struct PJRT_Buffer_DonateWithControlDependency_Callback_Args {\n+  size_t struct_size;\n+  void* callback_data;\n+  PJRT_Error_Code error_code;\n+  const char* error_message;\n+  size_t error_message_size;\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Buffer_DonateWithControlDependency_Callback_Args,\n+                          error_message_size);\n+\n+struct PJRT_Buffer_DonateWithControlDependency_Args {\n+  size_t struct_size;\n+  PJRT_Extension_Base* extension_start;\n+  PJRT_Buffer* buffer;\n+\n+  void* callback_data;  // out\n+  void (*dependency_ready_callback)(\n+      PJRT_Buffer_DonateWithControlDependency_Callback_Args* args);  // out\n+\n+  PJRT_Buffer* out_buffer;  // out\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Buffer_DonateWithControlDependency_Args,\n+                          out_buffer);\n+\n+typedef PJRT_Error* PJRT_Buffer_DonateWithControlDependency(\n+    PJRT_Buffer_DonateWithControlDependency_Args* args);\n+\n // ---------------------------- CopyToDeviceStream -----------------------------\n \n struct PJRT_CopyToDeviceStream_Destroy_Args {\n@@ -2852,11 +2879,12 @@ typedef struct PJRT_Api {\n   _PJRT_API_STRUCT_FIELD(PJRT_Device_CreateAsyncTrackingEvent);\n   _PJRT_API_STRUCT_FIELD(PJRT_AsyncTrackingEvent_Destroy);\n   _PJRT_API_STRUCT_FIELD(PJRT_Executable_GetCompileOptions);\n+  _PJRT_API_STRUCT_FIELD(PJRT_Buffer_DonateWithControlDependency);\n } PJRT_Api;\n \n enum {\n   PJRT_Api_STRUCT_SIZE =\n-      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_Executable_GetCompileOptions)\n+      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_Buffer_DonateWithControlDependency)\n };\n \n #undef _PJRT_API_STRUCT_FIELD"
        },
        {
            "sha": "a0faa37ccbf6d6c0859f9ee7cb46132dc29751e5",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -963,6 +963,9 @@ FieldOffsetsAndSizesForVersion(int major_version, int minor_version) {\n     if (minor_version >= 87) {\n       add_field(\"PJRT_Executable_GetCompileOptions\", kFnPtrSize);\n     }\n+    if (minor_version >= 88) {\n+      add_field(\"PJRT_Buffer_DonateWithControlDependency\", kFnPtrSize);\n+    }\n     return version_offsets_and_sizes;\n   }\n   LOG(FATAL) << \"Unsupported API version: \" << major_version << \".\"\n@@ -1377,6 +1380,9 @@ TEST_F(PjrtCAbiTestBase, FieldOffsetsAndSizes) {\n           {\"PJRT_Executable_GetCompileOptions\",\n            {offsetof(PJRT_Api, PJRT_Executable_GetCompileOptions),\n             sizeof(PJRT_Api::PJRT_Executable_GetCompileOptions)}},\n+          {\"PJRT_Buffer_DonateWithControlDependency\",\n+           {offsetof(PJRT_Api, PJRT_Buffer_DonateWithControlDependency),\n+            sizeof(PJRT_Api::PJRT_Buffer_DonateWithControlDependency)}},\n       };\n   ASSERT_EQ(api_->pjrt_api_version.major_version, PJRT_API_MAJOR);\n   ASSERT_EQ(api_->pjrt_api_version.minor_version, PJRT_API_MINOR);"
        },
        {
            "sha": "81dff12b5e6d96bcf9e9d04f6fc460418676695f",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -2512,6 +2512,40 @@ PJRT_Error* PJRT_Buffer_OpaqueDeviceMemoryDataPointer(\n   return nullptr;\n }\n \n+PJRT_Error* PJRT_Buffer_DonateWithControlDependency(\n+    PJRT_Buffer_DonateWithControlDependency_Args* args) {\n+  PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n+      \"PJRT_Buffer_DonateWithControlDependency_Args\",\n+      PJRT_Buffer_DonateWithControlDependency_Args_STRUCT_SIZE,\n+      args->struct_size));\n+\n+  auto [promise, future] = xla::Future<>::MakePromise();\n+  PJRT_ASSIGN_OR_RETURN(\n+      std::unique_ptr<xla::PjRtBuffer> out_buffer,\n+      args->buffer->buffer->DonateWithControlDependency(std::move(future)));\n+\n+  struct CallbackData {\n+    xla::Promise<> promise;\n+  };\n+  args->out_buffer =\n+      new PJRT_Buffer{std::move(out_buffer), args->buffer->client};\n+  args->callback_data = new CallbackData{std::move(promise)};\n+  args->dependency_ready_callback =\n+      [](PJRT_Buffer_DonateWithControlDependency_Callback_Args* args) {\n+        auto* data = static_cast<CallbackData*>(args->callback_data);\n+        if (args->error_code == PJRT_Error_Code_OK) {\n+          data->promise.Set();\n+        } else {\n+          absl::Status status(\n+              pjrt::PjrtErrorCodeToStatusCode(args->error_code),\n+              absl::string_view(args->error_message, args->error_message_size));\n+          data->promise.Set(std::move(status));\n+        }\n+        delete data;\n+      };\n+  return nullptr;\n+}\n+\n // ---------------------------- CopyToDeviceStream -----------------------------\n \n PJRT_Error* PJRT_CopyToDeviceStream_Destroy(\n@@ -3300,6 +3334,8 @@ PJRT_Api CreatePjrtApi(PJRT_Client_Create* create_fn,\n       pjrt::PJRT_AsyncTrackingEvent_Destroy,\n       /*PJRT_Executable_GetCompileOptions=*/\n       pjrt::PJRT_Executable_GetCompileOptions,\n+      /*PJRT_Buffer_DonateWithControlDependency=*/\n+      pjrt::PJRT_Buffer_DonateWithControlDependency,\n   };\n }\n "
        },
        {
            "sha": "9339e05931ea8a710d3331bc121c66d37078e5e4",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -434,6 +434,9 @@ PJRT_Error* PJRT_Buffer_DecreaseExternalReferenceCount(\n PJRT_Error* PJRT_Buffer_OpaqueDeviceMemoryDataPointer(\n     PJRT_Buffer_OpaqueDeviceMemoryDataPointer_Args* args);\n \n+PJRT_Error* PJRT_Buffer_DonateWithControlDependency(\n+    PJRT_Buffer_DonateWithControlDependency_Args* args);\n+\n PJRT_Error* PJRT_CopyToDeviceStream_Destroy(\n     PJRT_CopyToDeviceStream_Destroy_Args* args);\n PJRT_Error* PJRT_CopyToDeviceStream_AddChunk("
        },
        {
            "sha": "d09986db09030ebc0ef749b3e190149198bd4bc6",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -3382,6 +3382,43 @@ PjRtCApiBuffer::AcquireExternalReference() {\n                                                      device_memory_ptr);\n }\n \n+absl::StatusOr<std::unique_ptr<PjRtBuffer>>\n+PjRtCApiBuffer::DonateWithControlDependency(Future<> dependency) {\n+  if (client_->pjrt_c_api()->pjrt_api_version.major_version == 0 &&\n+      client_->pjrt_c_api()->pjrt_api_version.minor_version < 88) {\n+    return Unimplemented(\n+        \"PJRT_Buffer_DonateWithControlDependency requires PJRT C API version \"\n+        \"0.88 or higher.\");\n+  }\n+  PJRT_Buffer_DonateWithControlDependency_Args args;\n+  args.struct_size = PJRT_Buffer_DonateWithControlDependency_Args_STRUCT_SIZE;\n+  args.extension_start = nullptr;\n+  args.buffer = c_buffer();\n+  const PJRT_Api* api = pjrt_c_api();\n+  RETURN_STATUS_IF_PJRT_ERROR(\n+      api->PJRT_Buffer_DonateWithControlDependency(&args), api);\n+\n+  dependency.OnReady([callback = args.dependency_ready_callback,\n+                      data = args.callback_data](absl::Status s) {\n+    PJRT_Buffer_DonateWithControlDependency_Callback_Args cb_args;\n+    cb_args.struct_size =\n+        PJRT_Buffer_DonateWithControlDependency_Callback_Args_STRUCT_SIZE;\n+    cb_args.callback_data = data;\n+    if (s.ok()) {\n+      cb_args.error_code = PJRT_Error_Code_OK;\n+      cb_args.error_message = nullptr;\n+      cb_args.error_message_size = 0;\n+    } else {\n+      cb_args.error_code = pjrt::StatusCodeToPjrtErrorCode(s.code());\n+      cb_args.error_message = s.message().data();\n+      cb_args.error_message_size = s.message().size();\n+    }\n+    callback(&cb_args);\n+  });\n+  return std::unique_ptr<PjRtBuffer>(\n+      std::make_unique<PjRtCApiBuffer>(client_, args.out_buffer));\n+}\n+\n void PjRtCApiBuffer::CopyToRemoteDevice(\n     Future<std::string> serialized_descriptor, RemoteSendCallback on_done) {\n   PJRT_CrossHostTransfers_Extension* extension ="
        },
        {
            "sha": "5386b1230050b8f56c46a4c80b25c1c7ff8df22a",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/21d80205a696d8df9f831ffa21f402f96115dd7b/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h?ref=21d80205a696d8df9f831ffa21f402f96115dd7b",
            "patch": "@@ -574,6 +574,9 @@ class PjRtCApiBuffer : public PjRtBuffer {\n         \"PJRT C API does not support ReleaseDeviceMemoryOwnership\");\n   }\n \n+  absl::StatusOr<std::unique_ptr<PjRtBuffer>> DonateWithControlDependency(\n+      Future<> dependency) override;\n+\n   bool IsDeleted() const override;\n \n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> CopyToMemorySpace("
        }
    ],
    "stats": {
        "total": 121,
        "additions": 119,
        "deletions": 2
    }
}