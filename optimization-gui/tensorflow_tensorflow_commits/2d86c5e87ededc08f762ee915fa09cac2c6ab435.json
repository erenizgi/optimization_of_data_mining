{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Make `ReplaceDimsAndSymbols` more flexible by allowing partial dimension replacements.\n\nThe `ReplaceDimsAndSymbols` function now takes a `num_dims` argument. If `dim_replacements` does not cover all dimensions from 0 to `num_dims - 1`, the unreplaced dimensions are kept as their original symbolic variables.\n\nPiperOrigin-RevId: 804862612",
    "sha": "2d86c5e87ededc08f762ee915fa09cac2c6ab435",
    "files": [
        {
            "sha": "0910c608f2cc3eef87b5dd6b92e15426355f1f14",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2d86c5e87ededc08f762ee915fa09cac2c6ab435/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2d86c5e87ededc08f762ee915fa09cac2c6ab435/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=2d86c5e87ededc08f762ee915fa09cac2c6ab435",
            "patch": "@@ -68,17 +68,6 @@ std::string GetBinaryOpString(SymbolicExprType type) {\n   }\n }\n \n-llvm::SmallVector<SymbolicExpr> CreateVariableRange(SymbolicExprContext* ctx,\n-                                                    int64_t n,\n-                                                    int64_t offset = 0) {\n-  llvm::SmallVector<SymbolicExpr> replacements;\n-  replacements.reserve(n);\n-  for (int64_t i = 0; i < n; ++i) {\n-    replacements.push_back(ctx->CreateVariable(offset + i));\n-  }\n-  return replacements;\n-}\n-\n // Helper class to manage the state of the parser.\n class Parser {\n  public:\n@@ -710,15 +699,18 @@ SymbolicExpr SymbolicExpr::ReplaceVariables(\n \n SymbolicExpr SymbolicExpr::ReplaceSymbols(\n     absl::Span<const SymbolicExpr> sym_replacements, int64_t num_dims) const {\n-  auto dim_replacements = CreateVariableRange(GetContext(), num_dims);\n-  return ReplaceDimsAndSymbols(dim_replacements, sym_replacements);\n+  return ReplaceDimsAndSymbols({}, sym_replacements, num_dims);\n }\n \n SymbolicExpr SymbolicExpr::ReplaceDimsAndSymbols(\n     absl::Span<const SymbolicExpr> dim_replacements,\n-    absl::Span<const SymbolicExpr> symbol_replacements) const {\n+    absl::Span<const SymbolicExpr> symbol_replacements,\n+    int64_t num_dims) const {\n   llvm::SmallVector<SymbolicExpr> replacements;\n   replacements.append(dim_replacements.begin(), dim_replacements.end());\n+  for (int64_t i = dim_replacements.size(); i < num_dims; ++i) {\n+    replacements.push_back(GetContext()->CreateVariable(i));\n+  }\n   replacements.append(symbol_replacements.begin(), symbol_replacements.end());\n   return ReplaceVariables(replacements);\n }"
        },
        {
            "sha": "cb8436f05ec594387756dda30533fb52f96b99a2",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.h",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2d86c5e87ededc08f762ee915fa09cac2c6ab435/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2d86c5e87ededc08f762ee915fa09cac2c6ab435/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h?ref=2d86c5e87ededc08f762ee915fa09cac2c6ab435",
            "patch": "@@ -80,12 +80,10 @@ class SymbolicExpr {\n   // rest.\n   SymbolicExpr ReplaceSymbols(absl::Span<const SymbolicExpr> replacements,\n                               int64_t num_dims) const;\n-  // ReplaceDimsAndSymbols assumes the total number of dimensions and symbols in\n-  // the expression is the same the size of dim_replacements and\n-  // symbol_replacements.\n   SymbolicExpr ReplaceDimsAndSymbols(\n       absl::Span<const SymbolicExpr> dim_replacements,\n-      absl::Span<const SymbolicExpr> symbol_replacements) const;\n+      absl::Span<const SymbolicExpr> symbol_replacements,\n+      int64_t num_dims) const;\n \n   SymbolicExpr Canonicalize() const;\n "
        },
        {
            "sha": "e64b470ed772ee4e6cbac3b6f0474d5ebd9c85ec",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2d86c5e87ededc08f762ee915fa09cac2c6ab435/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2d86c5e87ededc08f762ee915fa09cac2c6ab435/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc?ref=2d86c5e87ededc08f762ee915fa09cac2c6ab435",
            "patch": "@@ -129,7 +129,7 @@ TEST_F(SymbolicExprTest, ReplaceSymbols) {\n   SymbolicExpr s1 = ctx.CreateVariable(2);\n   SymbolicExpr c7 = ctx.CreateConstant(7);\n   SymbolicExpr expr_to_sub = (d0 + s0 * 2) * s1;\n-  SymbolicExpr result = expr_to_sub.ReplaceSymbols({d0, c7}, 1);\n+  SymbolicExpr result = expr_to_sub.ReplaceSymbols({d0, c7}, /*num_dims=*/1);\n   EXPECT_EQ(result, ((d0 + (d0 * 2)) * c7));\n }\n \n@@ -139,8 +139,17 @@ TEST_F(SymbolicExprTest, ReplaceDimsAndSymbols) {\n   SymbolicExpr s1 = ctx.CreateVariable(2);\n   SymbolicExpr c7 = ctx.CreateConstant(7);\n   SymbolicExpr expr_to_sub = (d0 + s0 * 2) * s1;\n-  SymbolicExpr result = expr_to_sub.ReplaceDimsAndSymbols({s0}, {d0, c7});\n+  SymbolicExpr result =\n+      expr_to_sub.ReplaceDimsAndSymbols({s0}, {d0, c7}, /*num_dims=*/1);\n   EXPECT_EQ(result, ((s0 + (d0 * 2)) * c7));\n+\n+  SymbolicExpr replace_only_dims =\n+      expr_to_sub.ReplaceDimsAndSymbols({s0}, {}, /*num_dims=*/1);\n+  EXPECT_EQ(replace_only_dims, ((s0 + (s0 * 2)) * s1));\n+\n+  SymbolicExpr replace_only_symbols =\n+      expr_to_sub.ReplaceDimsAndSymbols({}, {d0, c7}, /*num_dims=*/1);\n+  EXPECT_EQ(replace_only_symbols, ((d0 + (d0 * 2)) * c7));\n }\n \n TEST_F(SymbolicExprTest, UniquingWorks) {"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 19,
        "deletions": 20
    }
}