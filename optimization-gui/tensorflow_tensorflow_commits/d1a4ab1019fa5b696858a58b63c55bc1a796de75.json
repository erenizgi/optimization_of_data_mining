{
    "author": "alekstheod",
    "message": "PR #33413: [ROCm] Unify definition of the local libs rpath for hermetic builds\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33413\n\nüìù Summary of Changes\nClean-up rocm libs rpath\n\nüéØ Justification\nRemove code duplication for the rocm rpath definition in rocm repo BUILD file\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: ‚ôªÔ∏è Cleanup\n\nüìä Benchmark (for Performance Improvements)\nNot relevant/CI\n\nüß™ Unit Tests:\nNot relevant/CI\n\nüß™ Execution Tests:\nNot relevant/CI\n\nCopybara import of the project:\n\n--\n7678106084429cf9a6256de0928ee4083e8e439f by Alexandros Theodoridis <atheodor@amd.com>:\n\nUnify definition of the local libs rpath for hermetic builds\n\nMerging this change closes #33413\n\nPiperOrigin-RevId: 831835843",
    "sha": "d1a4ab1019fa5b696858a58b63c55bc1a796de75",
    "files": [
        {
            "sha": "ec1edae410899c8050dd8b50309cd520068d00fb",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 19,
            "deletions": 14,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1a4ab1019fa5b696858a58b63c55bc1a796de75/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1a4ab1019fa5b696858a58b63c55bc1a796de75/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=d1a4ab1019fa5b696858a58b63c55bc1a796de75",
            "patch": "@@ -136,6 +136,9 @@ cc_library(\n     deps = [\":rocm_config\"],\n )\n \n+# workaround to bring data to the same fs layout as expected in the rocm libs\n+# rocblas assumes that miopen db files are located in ../share/miopen/db directory\n+# hibplatslt assumes that tensile files are located in ../hipblaslt/library directory\n cc_library(\n     name = \"rocm_rpath\",\n     linkopts = select({\n@@ -220,15 +223,13 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include\",\n     ],\n-    # workaround to  bring tensile files to the same fs layout as expected in the lib\n-    # rocblas assumes that tensile files are located in ../roblas/libraries directory\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \":hipblaslt\",\n         \":rocm_config\",\n         \":roctracer\",\n+        \":rocm_rpath\",\n     ],\n )\n \n@@ -242,7 +243,10 @@ cc_library(\n     linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     linkstatic = 1,\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":rocm_rpath\",\n+    ],\n )\n \n cc_library(\n@@ -255,7 +259,10 @@ cc_library(\n     linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     linkstatic = 1,\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":rocm_rpath\",\n+    ],\n )\n \n cc_library(\n@@ -284,14 +291,12 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include\",\n     ],\n-    # workaround to  bring miopen db files to the same fs layout as expected in the lib\n-    # rocblas assumes that miopen db files are located in ../share/miopen/db directory\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \":rocm-core\",\n         \":rocm_config\",\n+        \":rocm_rpath\",\n     ],\n )\n \n@@ -393,10 +398,12 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":rocm_rpath\",\n+    ],\n )\n \n cc_library(\n@@ -432,12 +439,12 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \":hipblas-common\",\n         \":rocm_config\",\n+        \":rocm_rpath\",\n     ],\n )\n \n@@ -473,14 +480,12 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/hipblaslt\",\n     ],\n-    # workaround to  bring tensile files to the same fs layout as expected in the lib\n-    # hibplatslt assumes that tensile files are located in ../hipblaslt/library directory\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \":hip_runtime\",\n         \":rocm_config\",\n+        \":rocm_rpath\",\n     ],\n )\n "
        }
    ],
    "stats": {
        "total": 33,
        "additions": 19,
        "deletions": 14
    }
}