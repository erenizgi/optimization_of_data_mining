{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Add `AbslStringify` support for `SymbolicExpr` and `SymbolicMap`\n\nPiperOrigin-RevId: 801760914",
    "sha": "6caa1dda599f6da9ea455a1a5d3b2575a1566fa2",
    "files": [
        {
            "sha": "2c1a704622692150edb7a9b686c357f607933cec",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD?ref=6caa1dda599f6da9ea455a1a5d3b2575a1566fa2",
            "patch": "@@ -218,6 +218,8 @@ cc_library(\n         \":symbolic_expr\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n     ],\n@@ -240,11 +242,10 @@ cc_library(\n     hdrs = [\"symbolic_expr.h\"],\n     deps = [\n         \"@com_google_absl//absl/algorithm:container\",\n-        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/synchronization\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:Support\","
        },
        {
            "sha": "33cb8b76f9634dce7e429ad01efe64e79e23381c",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h?ref=6caa1dda599f6da9ea455a1a5d3b2575a1566fa2",
            "patch": "@@ -18,7 +18,6 @@ limitations under the License.\n \n #include <cstdint>\n #include <string>\n-#include <vector>\n \n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n@@ -106,6 +105,11 @@ class SymbolicExpr {\n \n   const ImplType* GetImpl() const { return impl_; }\n \n+  template <typename Sink>\n+  friend void AbslStringify(Sink& sink, const SymbolicExpr expr) {\n+    sink.Append(expr.ToString());\n+  }\n+\n  private:\n   const ImplType* impl_ = nullptr;\n };"
        },
        {
            "sha": "74165feb59e3f7d4ad23fd8a6d20fd0ae046c07b",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=6caa1dda599f6da9ea455a1a5d3b2575a1566fa2",
            "patch": "@@ -17,10 +17,13 @@ limitations under the License.\n \n #include <cstdint>\n #include <iterator>\n+#include <string>\n #include <utility>\n \n #include \"absl/algorithm/container.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_join.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n@@ -58,6 +61,20 @@ SymbolicMap::SymbolicMap(SymbolicExprContext* ctx, int64_t num_dimensions,\n   return SymbolicMap(ctx, num_dimensions, num_symbols, std::move(exprs));\n }\n \n+std::string SymbolicMap::ToString() const {\n+  std::string str = absl::StrCat(\"SymbolicMap(dims=\", num_dimensions_,\n+                                 \", symbols=\", num_symbols_, \", results=[\");\n+  absl::StrAppend(&str, absl::StrJoin(exprs_, \",\\\\n\",\n+                                      [](std::string* out, const auto& expr) {\n+                                        absl::StrAppend(out, \"  \", expr);\n+                                      }));\n+  if (!IsEmpty()) {\n+    absl::StrAppend(&str, \"\\\\n\");\n+  }\n+  absl::StrAppend(&str, \"])\");\n+  return str;\n+}\n+\n bool SymbolicMap::IsIdentity() const {\n   if (num_dimensions_ != GetNumResults()) {\n     return false;"
        },
        {
            "sha": "65635b60ea084ded9ab13beb3ba12fd369fb5159",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=6caa1dda599f6da9ea455a1a5d3b2575a1566fa2",
            "patch": "@@ -17,6 +17,7 @@ limitations under the License.\n #define XLA_SERVICE_GPU_MODEL_EXPERIMENTAL_SYMBOLIC_MAP_H_\n \n #include <cstdint>\n+#include <string>\n \n #include \"absl/types/span.h\"\n #include \"llvm/ADT/SmallVector.h\"\n@@ -40,6 +41,7 @@ class SymbolicMap {\n   int64_t GetNumResults() const { return exprs_.size(); }\n   const llvm::SmallVector<SymbolicExpr>& GetResults() const { return exprs_; }\n   SymbolicExpr GetResult(unsigned idx) const { return exprs_[idx]; }\n+  std::string ToString() const;\n \n   bool IsEmpty() const { return exprs_.empty(); }\n \n@@ -84,6 +86,11 @@ class SymbolicMap {\n   bool operator==(const SymbolicMap& other) const;\n   bool operator!=(const SymbolicMap& other) const { return !(*this == other); }\n \n+  template <typename Sink>\n+  friend void AbslStringify(Sink& sink, const SymbolicMap& map) {\n+    sink.Append(map.ToString());\n+  }\n+\n  private:\n   SymbolicMap(SymbolicExprContext* ctx, int64_t num_dimensions,\n               int64_t num_symbols, llvm::SmallVector<SymbolicExpr> exprs);"
        },
        {
            "sha": "d5727d4ab97e68bcee404ae9e5a084b63c2a3eb8",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6caa1dda599f6da9ea455a1a5d3b2575a1566fa2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=6caa1dda599f6da9ea455a1a5d3b2575a1566fa2",
            "patch": "@@ -27,6 +27,19 @@ namespace {\n \n using ::testing::ElementsAre;\n \n+// TODO(karupayun): Make ToString print similarly to AffineMap. It should be\n+// aware of the dimension and symbol names.\n+TEST(SymbolicMapTest, ToString) {\n+  SymbolicExprContext ctx;\n+  SymbolicMap map =\n+      SymbolicMap::Get(&ctx, 2, 1,\n+                       {ctx.CreateVariable(0) + ctx.CreateVariable(2),\n+                        ctx.CreateVariable(1) * ctx.CreateVariable(3)});\n+  EXPECT_EQ(map.ToString(),\n+            \"SymbolicMap(dims=2, symbols=1, results=[  (v0 + v2),\\\\n  (v1 * \"\n+            \"v3)\\\\n])\");\n+}\n+\n TEST(SymbolicMapTest, IsEmpty) {\n   SymbolicExprContext ctx;\n   EXPECT_TRUE(SymbolicMap::Get(&ctx, 0, 0, {}).IsEmpty());"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 45,
        "deletions": 3
    }
}