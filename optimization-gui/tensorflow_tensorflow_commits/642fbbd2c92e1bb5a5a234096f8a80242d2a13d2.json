{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Value Tracking] Copy the original value when replacing all the uses of an instruction\n\nPiperOrigin-RevId: 814532532",
    "sha": "642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
    "files": [
        {
            "sha": "243997a7ed109369a9f18c7f0f76c2823f4fd97d",
            "filename": "third_party/xla/xla/hlo/ir/hlo_computation.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -1790,7 +1790,7 @@ absl::StatusOr<bool> HloComputation::ReplaceInstructionWithDifferentShape(\n         old_instruction->frontend_attributes());\n   }\n \n-  new_instruction->CopyOriginalValue(old_instruction, /*clone=*/false);\n+  new_instruction->CopyOriginalValue(old_instruction);\n \n   // Like the metadata above, if the user didn't specify any sharding\n   // information on the new instruction we should copy the old sharding"
        },
        {
            "sha": "66ebc4d04103ef546276408ba517705333cc7808",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -2869,9 +2869,9 @@ std::unique_ptr<HloInstruction> HloInstruction::CloneWithNewOperands(\n   if (!suffix.empty()) {\n     clone->AddSuffixToInstructionName(suffix);\n   }\n-  if (shape == this->shape()) {\n-    clone->CopyOriginalValue(this, /*clone=*/false);\n-  }\n+  // Copy the original value of the instruction if its shape is compatible with\n+  // the clone.\n+  clone->CopyOriginalValue(this);\n   return clone;\n }\n \n@@ -3601,6 +3601,9 @@ absl::Status HloInstruction::ReplaceAllUsesWithDifferentShape(\n     parent_->set_root_instruction(new_producer,\n                                   /*accept_different_shape=*/true);\n   }\n+  // Copy the original value recovery table from this instruction to the new\n+  // producer instruction if their shapes are compatible.\n+  new_producer->CopyOriginalValue(/*instruction=*/this);\n \n   return absl::OkStatus();\n }\n@@ -6039,9 +6042,9 @@ void HloInstruction::set_original_value(\n }\n \n void HloInstruction::CopyOriginalValue(const HloInstruction* instruction,\n-                                       bool clone) {\n+                                       bool clone, bool issue_warning) {\n   ::xla::CopyOriginalValue(/*src_instruction=*/instruction,\n-                           /*dest_instruction=*/this, clone);\n+                           /*dest_instruction=*/this, clone, issue_warning);\n }\n \n }  // namespace xla"
        },
        {
            "sha": "b8692fd49573a7c0ab24cdf15827b3df37460979",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction.h",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.h?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -2449,9 +2449,12 @@ class alignas(kInstructionTypeMask + 1) HloInstruction {\n   std::shared_ptr<OriginalValue> original_value() const;\n   void set_original_value(std::shared_ptr<OriginalValue> original_value);\n \n-  // Copy original value from the input instruction. This performs a deep copy\n-  // if clone is set to true. Otherwise, it performs a shallow copy.\n-  void CopyOriginalValue(const HloInstruction* instruction, bool clone);\n+  // Copy original value from the input instruction if the source and\n+  // destination shapes are compatible. This performs a deep copy if clone is\n+  // set to true. Otherwise, it performs a shallow copy. Print a warning if the\n+  // shapes are not compatible and issue_warning is set to true.\n+  void CopyOriginalValue(const HloInstruction* instruction, bool clone = false,\n+                         bool issue_warning = false);\n \n  protected:\n   // Internal constructor for a given opcode/shape, other fields must be filled"
        },
        {
            "sha": "dfbff12b0d986e910af7accc1b4299e1b35b5cbe",
            "filename": "third_party/xla/xla/hlo/ir/hlo_original_value.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -246,13 +246,16 @@ std::shared_ptr<OriginalValue> OriginalValue::CreateFromInstruction(\n }\n \n void CopyOriginalValue(const HloInstruction* src_instruction,\n-                       HloInstruction* dest_instruction, bool clone) {\n-  // This is not expected to happen in practice.\n+                       HloInstruction* dest_instruction, bool clone,\n+                       bool issue_warning) {\n   if (!src_instruction || !dest_instruction ||\n       !ShapeUtil::Compatible(src_instruction->shape(),\n                              dest_instruction->shape())) {\n-    VLOG(1) << \"Expect the new instruction to have the same shape with the old \"\n-               \"instruction when moving over original_value\";\n+    if (issue_warning) {\n+      LOG(WARNING)\n+          << \"Expect the new instruction to have the same shape with the old \"\n+             \"instruction when moving over original_value\";\n+    }\n     return;\n   }\n "
        },
        {
            "sha": "ea74485206b915d225ac586bc91b0ce3269f5b38",
            "filename": "third_party/xla/xla/hlo/ir/hlo_original_value.h",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value.h?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -159,11 +159,13 @@ class OriginalValue {\n       data_;\n };\n \n-// Copies the original value of the source to the destination instruction. This\n-// performs a deep copy if clone is set to true. Otherwise, it performs a\n-// shallow copy.\n+// Copies the original value of the source to the destination instruction if the\n+// shapes of the source and destination are compatible. This performs a deep\n+// copy if clone is set to true. Otherwise, it performs a shallow copy. Print a\n+// warning if the shapes are not compatible and issue_warning is set to true.\n void CopyOriginalValue(const HloInstruction* src_instruction,\n-                       HloInstruction* dest_instruction, bool clone);\n+                       HloInstruction* dest_instruction, bool clone,\n+                       bool issue_warning);\n \n // Removes duplicates of original value objects referenced in the module to save\n // memory storage."
        },
        {
            "sha": "b1387ad14971bb8d54fd7af0a9c9b5da4091eef6",
            "filename": "third_party/xla/xla/hlo/ir/hlo_original_value_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value_test.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -330,10 +330,10 @@ ENTRY main {\n \n   std::unique_ptr<HloInstruction> clone = p0->Clone();\n \n-  CopyOriginalValue(p0, clone.get(), /*clone=*/false);\n+  CopyOriginalValue(p0, clone.get(), /*clone=*/false, /*issue_warning=*/false);\n   EXPECT_EQ(p0->original_value(), clone->original_value());\n \n-  CopyOriginalValue(p0, clone.get(), /*clone=*/true);\n+  CopyOriginalValue(p0, clone.get(), /*clone=*/true, /*issue_warning=*/false);\n   EXPECT_NE(p0->original_value(), clone->original_value());\n   EXPECT_EQ(*p0->original_value(), *clone->original_value());\n }\n@@ -354,10 +354,10 @@ ENTRY main {\n \n   std::unique_ptr<HloInstruction> clone = p0->Clone();\n \n-  CopyOriginalValue(p0, clone.get(), /*clone=*/false);\n+  CopyOriginalValue(p0, clone.get(), /*clone=*/false, /*issue_warning=*/false);\n   EXPECT_EQ(p0->original_value(), clone->original_value());\n \n-  CopyOriginalValue(p0, clone.get(), /*clone=*/true);\n+  CopyOriginalValue(p0, clone.get(), /*clone=*/true, /*issue_warning=*/false);\n   EXPECT_EQ(p0->original_value(), clone->original_value());\n }\n "
        },
        {
            "sha": "a5d6d812db23a7a97efeaa912b170a567b1c015d",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -6031,9 +6031,14 @@ xla_cc_test(\n     deps = [\n         \":call_inliner\",\n         \":instruction_fusion\",\n+        \"//xla:literal_util\",\n+        \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/parser:hlo_parser\",\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/hlo/transforms/simplifiers:algebraic_simplifier\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\","
        },
        {
            "sha": "cfbd4e562555fcf7f0add1a75a9c7c723dd0d9f3",
            "filename": "third_party/xla/xla/service/call_inliner.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -214,7 +214,8 @@ class SubcomputationInsertionVisitor : public DfsHloVisitorWithDefault {\n       new_hlo_pointer->set_original_value(nullptr);\n       return;\n     }\n-    new_hlo_pointer->CopyOriginalValue(hlo, /*clone=*/true);\n+    new_hlo_pointer->CopyOriginalValue(hlo, /*clone=*/true,\n+                                       /*issue_warning=*/true);\n     if (call_original_value->is_synthetic_call()) {\n       return;\n     }"
        },
        {
            "sha": "93515e48b3cbf38ee6df86908da2b40d27594a1f",
            "filename": "third_party/xla/xla/service/hlo_instruction_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -38,7 +38,6 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n-#include \"xla/hlo/ir/hlo_original_value.h\"\n #include \"xla/hlo/ir/hlo_sharding.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/testlib/pattern_matcher_gmock.h\"\n@@ -3382,28 +3381,5 @@ TEST_F(HloInstructionTest, DifferentResultAccuracy) {\n   EXPECT_FALSE(exp1->equal_result_accuracy(exp2));\n }\n \n-TEST_F(HloInstructionTest, PreserveOriginalValueThroughClone) {\n-  HloComputation::Builder builder(TestName());\n-  auto* constant = builder.AddInstruction(\n-      HloInstruction::CreateConstant(LiteralUtil::CreateR2<float>({\n-          {1, 2},\n-          {3, 4},\n-      })));\n-  constant->set_original_value(OriginalValue::CreateFromInstruction(constant));\n-  auto* tuple =\n-      builder.AddInstruction(HloInstruction::CreateTuple({constant, constant}));\n-  tuple->set_original_value(OriginalValue::CreateFromInstruction(constant));\n-  auto clone_shape = ShapeUtil::MakeShape(F32, {2, 2});\n-  auto tuple_clone_same_shape = tuple->CloneWithNewOperands(\n-      ShapeUtil::MakeTupleShape({clone_shape, clone_shape}), {});\n-  clone_shape = ShapeUtil::MakeShape(F32, {3, 3});\n-  auto tuple_clone_different_shape = tuple->CloneWithNewOperands(\n-      ShapeUtil::MakeTupleShape({clone_shape, clone_shape}), {});\n-  // Only the tuple clone with the same shape as the original tuple should\n-  // preserve the original value.\n-  EXPECT_TRUE(tuple_clone_same_shape->original_value());\n-  EXPECT_FALSE(tuple_clone_different_shape->original_value());\n-}\n-\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "139c1b9fd96dec7b19aeeb8d260e01d1cca95104",
            "filename": "third_party/xla/xla/service/propagate_original_value_test.cc",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2Fpropagate_original_value_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/642fbbd2c92e1bb5a5a234096f8a80242d2a13d2/third_party%2Fxla%2Fxla%2Fservice%2Fpropagate_original_value_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fpropagate_original_value_test.cc?ref=642fbbd2c92e1bb5a5a234096f8a80242d2a13d2",
            "patch": "@@ -15,10 +15,17 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_computation.h\"\n+#include \"xla/hlo/ir/hlo_instruction.h\"\n+#include \"xla/hlo/ir/hlo_original_value.h\"\n+#include \"xla/hlo/parser/hlo_parser.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/transforms/simplifiers/algebraic_simplifier.h\"\n+#include \"xla/literal_util.h\"\n #include \"xla/service/call_inliner.h\"\n #include \"xla/service/instruction_fusion.h\"\n+#include \"xla/shape_util.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -28,6 +35,51 @@ namespace {\n using PropagateOriginalValueTest = HloHardwareIndependentTestBase;\n using OriginalValueRecoveryTableTest = HloHardwareIndependentTestBase;\n \n+TEST_F(PropagateOriginalValueTest, Clone) {\n+  HloComputation::Builder builder(TestName());\n+  auto* constant = builder.AddInstruction(\n+      HloInstruction::CreateConstant(LiteralUtil::CreateR2<float>({\n+          {1, 2},\n+          {3, 4},\n+      })));\n+  constant->set_original_value(OriginalValue::CreateFromInstruction(constant));\n+  auto* tuple =\n+      builder.AddInstruction(HloInstruction::CreateTuple({constant, constant}));\n+  tuple->set_original_value(OriginalValue::CreateFromInstruction(constant));\n+  auto clone_shape = ShapeUtil::MakeShape(F32, {2, 2});\n+  auto tuple_clone_same_shape = tuple->CloneWithNewOperands(\n+      ShapeUtil::MakeTupleShape({clone_shape, clone_shape}), {});\n+  clone_shape = ShapeUtil::MakeShape(F32, {3, 3});\n+  auto tuple_clone_different_shape = tuple->CloneWithNewOperands(\n+      ShapeUtil::MakeTupleShape({clone_shape, clone_shape}), {});\n+  // Only the tuple clone with the same shape as the original tuple should\n+  // preserve the original value.\n+  EXPECT_TRUE(tuple_clone_same_shape->original_value());\n+  EXPECT_FALSE(tuple_clone_different_shape->original_value());\n+}\n+\n+TEST_F(PropagateOriginalValueTest, ReplaceAllUses) {\n+  const absl::string_view hlo_string = R\"(\n+HloModule test\n+\n+ENTRY %main (param: s32[2,8], param.1: s32[8,8]) -> s32[2,8] {\n+  %param = s32[2,8]{1,0:T(2,128)} parameter(0)\n+  %param.1 = s32[8,8]{1,0:T(8,128)} parameter(1)\n+  ROOT %convolution = s32[2,8]{1,0:T(2,128)} convolution(%param, %param.1), dim_labels=bf_io->bf, origin={{\"dot_general.1__ovp0\"}}\n+}\n+  )\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  HloComputation* entry_computation = module->entry_computation();\n+  HloInstruction* root = entry_computation->root_instruction();\n+  HloInstruction* new_root = entry_computation->AddInstruction(root->Clone());\n+  new_root->set_original_value(nullptr);\n+\n+  TF_ASSERT_OK(root->ReplaceAllUsesWith(new_root));\n+  EXPECT_NE(new_root->original_value(), nullptr);\n+}\n+\n TEST_F(PropagateOriginalValueTest, InstructionFusion) {\n   constexpr absl::string_view hlo_string = R\"(\n HloModule test, entry_computation_layout={(s32[]{:T(256)})->u32[2]{0:T(256)}}"
        }
    ],
    "stats": {
        "total": 137,
        "additions": 91,
        "deletions": 46
    }
}