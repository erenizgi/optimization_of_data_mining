{
    "author": "tensorflower-gardener",
    "message": "[Autotuner] Use a Config struct in AutotunerCacheInterface.\n\n-This is temporary to avoid tying the interface to any particular proto during transition.\n\nPiperOrigin-RevId: 803496881",
    "sha": "a4bc75a4685a9559250ed1a753e89222e9e158bf",
    "files": [
        {
            "sha": "78185cf9e2169b6038d47e96de96bb49fe658ff7",
            "filename": "third_party/xla/xla/backends/autotuner/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2FBUILD?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -113,6 +113,7 @@ cc_library(\n         \":autotuner_cache_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/strings:string_view\",\n     ],\n )\n \n@@ -149,6 +150,7 @@ xla_cc_test(\n     name = \"file_based_autotuner_cache_test\",\n     srcs = [\"file_based_autotuner_cache_test.cc\"],\n     deps = [\n+        \":autotuner_cache_interface\",\n         \":autotuner_cache_proto_cc\",\n         \":file_based_autotuner_cache\",\n         \"//xla:literal_util\","
        },
        {
            "sha": "08caf3e190a38454759297c92bf068673f7fe763",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -77,13 +77,13 @@ absl::Status Autotuner::Autotune(HloInstruction* instr) {\n absl::StatusOr<Autotuner::Config> Autotuner::GetBestConfig(\n     HloInstruction* instr) {\n   if (cache_) {\n-    auto cached_entry = cache_->Lookup(instr);\n-    if (cached_entry.has_value()) {\n-      VLOG(1) << \"Found cached entry for HLO: \" << instr->ToString();\n+    auto cached_config = cache_->Lookup(instr);\n+    if (cached_config.has_value()) {\n+      VLOG(1) << \"Found cached config for HLO: \" << instr->ToString();\n       for (auto& codegen_backend : codegen_backends_) {\n-        if (codegen_backend->name() == cached_entry->codegen_backend()) {\n+        if (codegen_backend->name() == cached_config->codegen_backend_name) {\n           auto backend_config = std::make_unique<google::protobuf::Any>(\n-              cached_entry->backend_config());\n+              cached_config->backend_config);\n           return Config{codegen_backend.get(), std::move(backend_config)};\n         }\n       }\n@@ -278,11 +278,11 @@ absl::StatusOr<Autotuner::Config> Autotuner::ProfileAndPickBest(\n   VLOG(1) << \"Picked config: \" << best_config->codegen_backend->name() << \" \"\n           << best_config->backend_config->ShortDebugString();\n \n-  AutotunerCacheEntry cache_entry;\n-  cache_entry.set_codegen_backend(min_duration_config->codegen_backend->name());\n-  *cache_entry.mutable_backend_config() = *best_config->backend_config;\n+  AutotunerCacheInterface::Config config;\n+  config.codegen_backend_name = (best_config->codegen_backend->name());\n+  config.backend_config = *best_config->backend_config;\n   if (cache_) {\n-    TF_RETURN_IF_ERROR(cache_->Insert(instr, cache_entry));\n+    TF_RETURN_IF_ERROR(cache_->Insert(instr, config));\n   }\n   return std::move(*best_config);\n }"
        },
        {
            "sha": "763c8a3acc130b3f6a82221448b52bfcd5cab6d9",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner_cache_interface.h",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_cache_interface.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_cache_interface.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_cache_interface.h?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <optional>\n \n #include \"absl/status/status.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"xla/backends/autotuner/autotuner_cache.pb.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n \n@@ -29,13 +30,18 @@ namespace xla {\n // AutotunerCacheInterface implementations may have different cache keys.\n class AutotunerCacheInterface {\n  public:\n+  // Serializable config. Will be changed to a proto in the future.\n+  struct Config {\n+    absl::string_view codegen_backend_name;\n+    google::protobuf::Any backend_config;\n+  };\n+\n   virtual ~AutotunerCacheInterface() = default;\n \n-  virtual std::optional<AutotunerCacheEntry> Lookup(\n-      const HloInstruction* instr) = 0;\n+  virtual std::optional<Config> Lookup(const HloInstruction* instr) = 0;\n \n   virtual absl::Status Insert(const HloInstruction* instr,\n-                              AutotunerCacheEntry& entry) = 0;\n+                              Config& best_config) = 0;\n };\n \n }  // namespace xla"
        },
        {
            "sha": "3b8750909092c33cffc8dc563e04b23a52335a33",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -112,10 +112,11 @@ class MockProfiler : public Profiler {\n \n class MockAutotunerCache : public AutotunerCacheInterface {\n  public:\n-  MOCK_METHOD(std::optional<AutotunerCacheEntry>, Lookup,\n+  MOCK_METHOD(std::optional<AutotunerCacheInterface::Config>, Lookup,\n               (const HloInstruction* instr), (override));\n   MOCK_METHOD(absl::Status, Insert,\n-              (const HloInstruction* instr, AutotunerCacheEntry& entry),\n+              (const HloInstruction* instr,\n+               AutotunerCacheInterface::Config& best_config),\n               (override));\n };\n \n@@ -384,13 +385,13 @@ TEST_F(AutotunerTest, AutotuneModuleWithDuplicateInstructions) {\n \n TEST_F(AutotunerTest, CacheHit) {\n   auto cache_manager = std::make_unique<MockAutotunerCache>();\n-  AutotunerCacheEntry entry;\n-  entry.set_codegen_backend(\"mock_backend\");\n+  AutotunerCacheInterface::Config config;\n+  config.codegen_backend_name = \"mock_backend\";\n   TestConfig test_config;\n   GetTestConfig(\"test_config_2\")->UnpackTo(&test_config);\n-  entry.mutable_backend_config()->PackFrom(test_config);\n+  config.backend_config.PackFrom(test_config);\n \n-  EXPECT_CALL(*cache_manager, Lookup(_)).WillOnce(Return(entry));\n+  EXPECT_CALL(*cache_manager, Lookup(_)).WillOnce(Return(config));\n \n   auto backend = std::make_unique<MockCodegenBackend>();\n   EXPECT_CALL(*backend, name()).WillRepeatedly(Return(\"mock_backend\"));"
        },
        {
            "sha": "1c6f1923871e34bc5561ab38488cf01378cc92e9",
            "filename": "third_party/xla/xla/backends/autotuner/file_based_autotuner_cache.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache.cc?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -128,7 +128,7 @@ absl::StatusOr<AutotunerCacheKey> FileBasedAutotunerCache::GetProtoKey(\n   return key;\n }\n \n-std::optional<AutotunerCacheEntry> FileBasedAutotunerCache::Lookup(\n+std::optional<AutotunerCacheInterface::Config> FileBasedAutotunerCache::Lookup(\n     const HloInstruction* instr) {\n   absl::StatusOr<std::string> map_key = GetMapKey(instr);\n   if (!map_key.ok()) {\n@@ -140,19 +140,25 @@ std::optional<AutotunerCacheEntry> FileBasedAutotunerCache::Lookup(\n   if (it == in_memory_cache_.end()) {\n     return std::nullopt;\n   }\n-  return it->second;\n+  AutotunerCacheInterface::Config config;\n+  config.codegen_backend_name = it->second.codegen_backend();\n+  config.backend_config = it->second.backend_config();\n+  return config;\n }\n \n-absl::Status FileBasedAutotunerCache::Insert(const HloInstruction* instr,\n-                                             AutotunerCacheEntry& entry) {\n+absl::Status FileBasedAutotunerCache::Insert(\n+    const HloInstruction* instr, AutotunerCacheInterface::Config& best_config) {\n   if (cache_config_.autotune_cache_mode ==\n       FileBasedCacheConfig::CacheMode::READ) {\n     return absl::OkStatus();\n   }\n   TF_ASSIGN_OR_RETURN(const std::string map_key, GetMapKey(instr));\n   TF_ASSIGN_OR_RETURN(AutotunerCacheKey proto_key, GetProtoKey(instr));\n   absl::MutexLock lock(&mutex_);\n+  AutotunerCacheEntry entry;\n   *entry.mutable_key() = proto_key;\n+  entry.set_codegen_backend(best_config.codegen_backend_name);\n+  *entry.mutable_backend_config() = best_config.backend_config;\n   in_memory_cache_[map_key] = entry;\n   if (!cache_config_.autotune_cache_dir.empty()) {\n     return Save(map_key, entry);"
        },
        {
            "sha": "42066e9c584750442da63a57b532c409a8d7b260",
            "filename": "third_party/xla/xla/backends/autotuner/file_based_autotuner_cache.h",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache.h?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -79,11 +79,10 @@ class FileBasedAutotunerCache : public AutotunerCacheInterface {\n   static absl::StatusOr<std::unique_ptr<AutotunerCacheInterface>> Create(\n       const FileBasedCacheConfig& cache_config);\n \n-  std::optional<AutotunerCacheEntry> Lookup(\n-      const HloInstruction* instr) override ABSL_LOCKS_EXCLUDED(mutex_);\n+  std::optional<Config> Lookup(const HloInstruction* instr) override\n+      ABSL_LOCKS_EXCLUDED(mutex_);\n \n-  absl::Status Insert(const HloInstruction* instr,\n-                      AutotunerCacheEntry& entry) override\n+  absl::Status Insert(const HloInstruction* instr, Config& best_config) override\n       ABSL_LOCKS_EXCLUDED(mutex_);\n \n  private:"
        },
        {
            "sha": "4f3b09544c28b7ccc07b1344708d1cca20959a58",
            "filename": "third_party/xla/xla/backends/autotuner/file_based_autotuner_cache_test.cc",
            "status": "modified",
            "additions": 71,
            "deletions": 45,
            "changes": 116,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a4bc75a4685a9559250ed1a753e89222e9e158bf/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Ffile_based_autotuner_cache_test.cc?ref=a4bc75a4685a9559250ed1a753e89222e9e158bf",
            "patch": "@@ -26,22 +26,22 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"absl/status/status.h\"\n #include \"xla/backends/autotuner/autotuner_cache.pb.h\"\n+#include \"xla/backends/autotuner/autotuner_cache_interface.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/stream_executor/cuda/cuda_compute_capability.h\"\n #include \"xla/stream_executor/device_description.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/statusor.h\"\n-#include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"tsl/platform/path.h\"\n \n namespace xla {\n namespace {\n \n+using Config = ::xla::AutotunerCacheInterface::Config;\n using ::testing::Eq;\n using ::testing::Optional;\n-using ::tsl::proto_testing::EqualsProto;\n \n // Helper to create a dummy DeviceDescription.\n se::DeviceDescription CreateDummyDeviceDescription(\n@@ -103,6 +103,32 @@ class FileBasedAutotunerCacheTest : public ::testing::Test {\n   }\n };\n \n+// Matcher for Config.\n+MATCHER_P(ConfigEq, expected_config, \"\") {\n+  const Config& actual_config = arg;\n+  if (actual_config.codegen_backend_name !=\n+      expected_config.codegen_backend_name) {\n+    *result_listener << \"codegen_backend mismatch: expected \"\n+                     << expected_config.codegen_backend_name << \", got \"\n+                     << actual_config.codegen_backend_name;\n+    return false;\n+  }\n+  // Compare backend_config (google::protobuf::Any)\n+  if (actual_config.backend_config.type_url() !=\n+      expected_config.backend_config.type_url()) {\n+    *result_listener << \"backend_config type_url mismatch: expected \"\n+                     << expected_config.backend_config.type_url() << \", got \"\n+                     << actual_config.backend_config.type_url();\n+    return false;\n+  }\n+  if (actual_config.backend_config.value() !=\n+      expected_config.backend_config.value()) {\n+    *result_listener << \"backend_config value mismatch\";\n+    return false;\n+  }\n+  return true;\n+}\n+\n TEST_F(FileBasedAutotunerCacheTest, CreateEmpty) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto cache, FileBasedAutotunerCache::Create(\n@@ -118,27 +144,27 @@ TEST_F(FileBasedAutotunerCacheTest, InsertAndLookup) {\n                       GetConfig(CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n   auto instr = CreateDummyInstr(\"hlo1\");\n-  AutotunerCacheEntry entry;\n-  entry.set_codegen_backend(\"TestBackend\");\n-  *entry.mutable_backend_config() = CreateDummyBackendConfig();\n+  Config config;\n+  config.codegen_backend_name = \"TestBackend\";\n+  config.backend_config = CreateDummyBackendConfig();\n \n-  TF_ASSERT_OK(cache->Insert(instr.get(), entry));\n-  EXPECT_THAT(cache->Lookup(instr.get()), Optional(EqualsProto(entry)));\n+  TF_ASSERT_OK(cache->Insert(instr.get(), config));\n+  EXPECT_THAT(cache->Lookup(instr.get()), Optional(ConfigEq(config)));\n }\n \n TEST_F(FileBasedAutotunerCacheTest, SaveAndLoad) {\n   auto instr = CreateDummyInstr(\"hlo2\");\n-  AutotunerCacheEntry entry;\n-  entry.set_codegen_backend(\"TestBackend\");\n-  *entry.mutable_backend_config() = CreateDummyBackendConfig();\n+  Config config;\n+  config.codegen_backend_name = \"TestBackend\";\n+  config.backend_config = CreateDummyBackendConfig();\n \n   // Create cache, insert, and let it save.\n   {\n     TF_ASSERT_OK_AND_ASSIGN(auto cache,\n                             FileBasedAutotunerCache::Create(GetConfig(\n                                 CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n-    TF_ASSERT_OK(cache->Insert(instr.get(), entry));\n+    TF_ASSERT_OK(cache->Insert(instr.get(), config));\n   }\n \n   // Create a new cache, which should load from disk.\n@@ -147,23 +173,23 @@ TEST_F(FileBasedAutotunerCacheTest, SaveAndLoad) {\n                             FileBasedAutotunerCache::Create(GetConfig(\n                                 CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n-    EXPECT_THAT(cache->Lookup(instr.get()), Optional(EqualsProto(entry)));\n+    EXPECT_THAT(cache->Lookup(instr.get()), Optional(ConfigEq(config)));\n   }\n }\n \n TEST_F(FileBasedAutotunerCacheTest, LoadWithDifferentDevice) {\n   auto instr = CreateDummyInstr(\"hlo2\");\n-  AutotunerCacheEntry entry;\n-  entry.set_codegen_backend(\"TestBackend\");\n-  *entry.mutable_backend_config() = CreateDummyBackendConfig();\n+  Config config;\n+  config.codegen_backend_name = \"TestBackend\";\n+  config.backend_config = CreateDummyBackendConfig();\n \n   // Create cache, insert, and let it save.\n   {\n     TF_ASSERT_OK_AND_ASSIGN(auto cache,\n                             FileBasedAutotunerCache::Create(GetConfig(\n                                 CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n-    TF_ASSERT_OK(cache->Insert(instr.get(), entry));\n+    TF_ASSERT_OK(cache->Insert(instr.get(), config));\n   }\n \n   // Create a new cache with different device, should not load the entry.\n@@ -178,43 +204,43 @@ TEST_F(FileBasedAutotunerCacheTest, LoadWithDifferentDevice) {\n \n TEST_F(FileBasedAutotunerCacheTest, LoadWithDifferentVersion) {\n   auto instr = CreateDummyInstr(\"hlo2\");\n-  AutotunerCacheEntry entry;\n-  entry.set_codegen_backend(\"TestBackend\");\n-  *entry.mutable_backend_config() = CreateDummyBackendConfig();\n+  Config config;\n+  config.codegen_backend_name = \"TestBackend\";\n+  config.backend_config = CreateDummyBackendConfig();\n \n   // Create cache, insert, and let it save.\n   {\n     TF_ASSERT_OK_AND_ASSIGN(auto cache,\n                             FileBasedAutotunerCache::Create(GetConfig(\n                                 CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n-    TF_ASSERT_OK(cache->Insert(instr.get(), entry));\n+    TF_ASSERT_OK(cache->Insert(instr.get(), config));\n   }\n \n   // Create a new cache with different version, should not load the entry.\n   {\n-    auto config = GetConfig(CreateDummyDeviceDescription(),\n-                            FileBasedCacheConfig::CacheMode::READ_WRITE);\n-    config.cache_version = \"2\";\n+    auto cache_config = GetConfig(CreateDummyDeviceDescription(),\n+                                  FileBasedCacheConfig::CacheMode::READ_WRITE);\n+    cache_config.cache_version = \"2\";\n     TF_ASSERT_OK_AND_ASSIGN(auto cache,\n-                            FileBasedAutotunerCache::Create(config));\n+                            FileBasedAutotunerCache::Create(cache_config));\n     EXPECT_THAT(cache->Lookup(instr.get()), Eq(std::nullopt));\n   }\n }\n \n TEST_F(FileBasedAutotunerCacheTest, ReadOnlyMode) {\n   auto instr = CreateDummyInstr(\"hlo3\");\n-  AutotunerCacheEntry entry;\n-  entry.set_codegen_backend(\"TestBackend\");\n-  *entry.mutable_backend_config() = CreateDummyBackendConfig();\n+  Config config;\n+  config.codegen_backend_name = \"TestBackend\";\n+  config.backend_config = CreateDummyBackendConfig();\n \n   // Create in READ_WRITE mode to pre-populate the cache file.\n   {\n     TF_ASSERT_OK_AND_ASSIGN(auto cache,\n                             FileBasedAutotunerCache::Create(GetConfig(\n                                 CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n-    TF_ASSERT_OK(cache->Insert(instr.get(), entry));\n+    TF_ASSERT_OK(cache->Insert(instr.get(), config));\n   }\n \n   // Create in READ mode.\n@@ -223,14 +249,14 @@ TEST_F(FileBasedAutotunerCacheTest, ReadOnlyMode) {\n                       GetConfig(CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ)));\n   // Lookup should work.\n-  EXPECT_THAT(cache->Lookup(instr.get()), Optional(EqualsProto(entry)));\n+  EXPECT_THAT(cache->Lookup(instr.get()), Optional(ConfigEq(config)));\n \n   // Insert a new entry.\n   auto instr2 = CreateDummyInstr(\"hlo4\");\n-  AutotunerCacheEntry entry2;\n-  entry2.set_codegen_backend(\"AnotherBackend\");\n-  *entry2.mutable_backend_config() = CreateDummyBackendConfig();\n-  TF_ASSERT_OK(cache->Insert(instr2.get(), entry2));\n+  Config config2;\n+  config2.codegen_backend_name = \"AnotherBackend\";\n+  config2.backend_config = CreateDummyBackendConfig();\n+  TF_ASSERT_OK(cache->Insert(instr2.get(), config2));\n   EXPECT_THAT(cache->Lookup(instr2.get()), Eq(std::nullopt));\n \n   // Create a new cache, key2 should not be present as it wasn't saved.\n@@ -239,7 +265,7 @@ TEST_F(FileBasedAutotunerCacheTest, ReadOnlyMode) {\n                             FileBasedAutotunerCache::Create(GetConfig(\n                                 CreateDummyDeviceDescription(),\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n-    EXPECT_THAT(cache2->Lookup(instr.get()), Optional(EqualsProto(entry)));\n+    EXPECT_THAT(cache2->Lookup(instr.get()), Optional(ConfigEq(config)));\n     EXPECT_THAT(cache2->Lookup(instr2.get()), Eq(std::nullopt));\n   }\n }\n@@ -251,17 +277,17 @@ TEST_F(FileBasedAutotunerCacheTest, OverwriteEntry) {\n                                 FileBasedCacheConfig::CacheMode::READ_WRITE)));\n   auto instr = CreateDummyInstr(\"hlo5\");\n \n-  AutotunerCacheEntry entry1;\n-  entry1.set_codegen_backend(\"BackendV1\");\n-  *entry1.mutable_backend_config() = CreateDummyBackendConfig();\n-  TF_ASSERT_OK(cache->Insert(instr.get(), entry1));\n-  EXPECT_THAT(cache->Lookup(instr.get()), Optional(EqualsProto(entry1)));\n-\n-  AutotunerCacheEntry entry2;\n-  entry2.set_codegen_backend(\"BackendV2\");\n-  *entry2.mutable_backend_config() = CreateDummyBackendConfig();\n-  TF_ASSERT_OK(cache->Insert(instr.get(), entry2));\n-  EXPECT_THAT(cache->Lookup(instr.get()), Optional(EqualsProto(entry2)));\n+  Config config1;\n+  config1.codegen_backend_name = \"BackendV1\";\n+  config1.backend_config = CreateDummyBackendConfig();\n+  TF_ASSERT_OK(cache->Insert(instr.get(), config1));\n+  EXPECT_THAT(cache->Lookup(instr.get()), Optional(ConfigEq(config1)));\n+\n+  Config config2;\n+  config2.codegen_backend_name = \"BackendV2\";\n+  config2.backend_config = CreateDummyBackendConfig();\n+  TF_ASSERT_OK(cache->Insert(instr.get(), config2));\n+  EXPECT_THAT(cache->Lookup(instr.get()), Optional(ConfigEq(config2)));\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 111,
        "deletions": 71
    }
}