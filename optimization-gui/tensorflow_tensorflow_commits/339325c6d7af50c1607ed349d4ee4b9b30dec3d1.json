{
    "author": "ezhulenev",
    "message": "[xla:ffi] Add XLA_FFI_TypeInfo in preparation for adding it to TypeRegistry\n\nPiperOrigin-RevId: 819715434",
    "sha": "339325c6d7af50c1607ed349d4ee4b9b30dec3d1",
    "files": [
        {
            "sha": "81e0166ded9468aa8bfd9706aae9553980229e18",
            "filename": "third_party/xla/xla/ffi/api/api.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/339325c6d7af50c1607ed349d4ee4b9b30dec3d1/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/339325c6d7af50c1607ed349d4ee4b9b30dec3d1/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h?ref=339325c6d7af50c1607ed349d4ee4b9b30dec3d1",
            "patch": "@@ -279,7 +279,8 @@ class Ffi {\n   // `type_id`.\n   static XLA_FFI_Error* RegisterTypeId(const XLA_FFI_Api* api,\n                                        std::string_view name,\n-                                       XLA_FFI_TypeId* type_id);\n+                                       XLA_FFI_TypeId* type_id,\n+                                       XLA_FFI_TypeInfo type_info = {nullptr});\n \n   // This is a helper template that allows to convert function pointers from\n   // the run time values to compile time values (template arguments) with\n@@ -345,7 +346,8 @@ inline XLA_FFI_Error* Ffi::RegisterStaticHandler(\n \n inline XLA_FFI_Error* Ffi::RegisterTypeId(const XLA_FFI_Api* api,\n                                           std::string_view name,\n-                                          XLA_FFI_TypeId* type_id) {\n+                                          XLA_FFI_TypeId* type_id,\n+                                          XLA_FFI_TypeInfo type_info) {\n   XLA_FFI_TypeId_Register_Args args;\n   args.struct_size = XLA_FFI_TypeId_Register_Args_STRUCT_SIZE;\n   args.extension_start = nullptr;"
        },
        {
            "sha": "124970c3ae7129bc480f003550ccb659f7024c34",
            "filename": "third_party/xla/xla/ffi/api/c_api.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/339325c6d7af50c1607ed349d4ee4b9b30dec3d1/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/339325c6d7af50c1607ed349d4ee4b9b30dec3d1/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h?ref=339325c6d7af50c1607ed349d4ee4b9b30dec3d1",
            "patch": "@@ -267,6 +267,13 @@ typedef struct XLA_FFI_TypeId {\n   int64_t type_id;\n } XLA_FFI_TypeId;\n \n+// TypeInfo contains function pointers required by XLA runtime to manipulate\n+// user-defined types. For example stateful handlers must tell XLA runtime how\n+// to destroy their state when executable is being destroyed.\n+typedef struct XLA_FFI_TypeInfo {\n+  void (*deleter)(void* object);\n+} XLA_FFI_TypeInfo;\n+\n // We use byte spans to pass strings to handlers because strings might not be\n // null terminated, and even if they are, looking for a null terminator can\n // become very expensive in tight loops."
        },
        {
            "sha": "f586ee4b3465f6e60323eb632713aebf1297217f",
            "filename": "third_party/xla/xla/ffi/api/ffi.h",
            "status": "modified",
            "additions": 27,
            "deletions": 8,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/339325c6d7af50c1607ed349d4ee4b9b30dec3d1/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/339325c6d7af50c1607ed349d4ee4b9b30dec3d1/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h?ref=339325c6d7af50c1607ed349d4ee4b9b30dec3d1",
            "patch": "@@ -1465,14 +1465,33 @@ struct CtxDecoding<FfiExecutionContext> {\n // Type Registration\n //===----------------------------------------------------------------------===//\n \n-#define XLA_FFI_REGISTER_TYPE(API, NAME, TYPE_ID) \\\n-  XLA_FFI_REGISTER_TYPE_(API, NAME, TYPE_ID, __COUNTER__)\n-#define XLA_FFI_REGISTER_TYPE_(API, NAME, TYPE_ID, N) \\\n-  XLA_FFI_REGISTER_TYPE__(API, NAME, TYPE_ID, N)\n-#define XLA_FFI_REGISTER_TYPE__(API, NAME, TYPE_ID, N) \\\n-  XLA_FFI_ATTRIBUTE_UNUSED static const XLA_FFI_Error* \\\n-      xla_ffi_type_##N##_registered_ =                 \\\n-          [] { return ::xla::ffi::Ffi::RegisterTypeId(API, NAME, TYPE_ID); }()\n+template <typename T>\n+XLA_FFI_TypeInfo TypeInfo() {\n+  return XLA_FFI_TypeInfo{[](void* ptr) { delete static_cast<T*>(ptr); }};\n+}\n+\n+#define XLA_FFI_REGISTER_TYPE_WITH_INFO(API, NAME, TYPE_ID, TYPE_INFO) \\\n+  XLA_FFI_REGISTER_TYPE_WITH_INFO_(API, NAME, TYPE_ID, TYPE_INFO, __COUNTER__)\n+#define XLA_FFI_REGISTER_TYPE_WITH_INFO_(API, NAME, TYPE_ID, TYPE_INFO, N) \\\n+  XLA_FFI_REGISTER_TYPE_WITH_INFO__(API, NAME, TYPE_ID, TYPE_INFO, N)\n+#define XLA_FFI_REGISTER_TYPE_WITH_INFO__(API, NAME, TYPE_ID, TYPE_INFO, N)    \\\n+  XLA_FFI_ATTRIBUTE_UNUSED static const XLA_FFI_Error*                         \\\n+      xla_ffi_type_##N##_registered_ = [] {                                    \\\n+        return ::xla::ffi::Ffi::RegisterTypeId(API, NAME, TYPE_ID, TYPE_INFO); \\\n+      }()\n+\n+#define XLA_FFI_REGISTER_TYPE_X(x, API, NAME, TYPE_ID, TYPE_INFO, FUNC, ...) \\\n+  FUNC\n+\n+// Registers external type with XLA runtime and assigns it a unique type id.\n+//\n+// This is a trick to define macro with optional parameters.\n+// Source: https://stackoverflow.com/a/8814003\n+#define XLA_FFI_REGISTER_TYPE(API, NAME, TYPE_ID, ...)                  \\\n+  XLA_FFI_REGISTER_TYPE_X(                                              \\\n+      , API, NAME, TYPE_ID, ##__VA_ARGS__,                              \\\n+      XLA_FFI_REGISTER_TYPE_WITH_INFO(API, NAME, TYPE_ID, __VA_ARGS__), \\\n+      XLA_FFI_REGISTER_TYPE_WITH_INFO(API, NAME, TYPE_ID, {nullptr}))\n \n //===----------------------------------------------------------------------===//\n // UserData"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 38,
        "deletions": 10
    }
}