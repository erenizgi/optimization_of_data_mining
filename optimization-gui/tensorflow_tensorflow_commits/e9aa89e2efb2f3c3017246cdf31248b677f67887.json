{
    "author": "nvgrw",
    "message": "Add basic replicated execution support to ClientLibraryTestRunnerMixin<T>.\n\nPiperOrigin-RevId: 846326488",
    "sha": "e9aa89e2efb2f3c3017246cdf31248b677f67887",
    "files": [
        {
            "sha": "5a26f9cb53eaab5a392b6f406bf65759318b7b70",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e9aa89e2efb2f3c3017246cdf31248b677f67887/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e9aa89e2efb2f3c3017246cdf31248b677f67887/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=e9aa89e2efb2f3c3017246cdf31248b677f67887",
            "patch": "@@ -369,12 +369,14 @@ cc_library(\n         \"//xla/hlo/builder:xla_builder\",\n         \"//xla/hlo/builder:xla_computation\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/service:computation_placer_hdr\",\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service:hlo_module_util\",\n         \"//xla/tsl/lib/core:bitmap\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:logging\",\n+        \"//xla/tsl/platform:status_macros\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "a5ffb096084524b2be21d19e707ae5f9f43d5b1e",
            "filename": "third_party/xla/xla/tests/client_library_test_runner_mixin.h",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e9aa89e2efb2f3c3017246cdf31248b677f67887/third_party%2Fxla%2Fxla%2Ftests%2Fclient_library_test_runner_mixin.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e9aa89e2efb2f3c3017246cdf31248b677f67887/third_party%2Fxla%2Fxla%2Ftests%2Fclient_library_test_runner_mixin.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fclient_library_test_runner_mixin.h?ref=e9aa89e2efb2f3c3017246cdf31248b677f67887",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #ifndef XLA_TESTS_CLIENT_LIBRARY_TEST_RUNNER_MIXIN_H_\n #define XLA_TESTS_CLIENT_LIBRARY_TEST_RUNNER_MIXIN_H_\n \n+#include <algorithm>\n #include <cstdint>\n #include <memory>\n #include <optional>\n@@ -32,9 +33,12 @@ limitations under the License.\n #include \"xla/execution_options_util.h\"\n #include \"xla/hlo/builder/xla_builder.h\"\n #include \"xla/hlo/builder/xla_computation.h\"\n+#include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n+#include \"xla/hlo/ir/hlo_schedule.h\"\n #include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n+#include \"xla/service/computation_placer.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/service/hlo_module_util.h\"\n #include \"xla/shape.h\"\n@@ -51,6 +55,7 @@ limitations under the License.\n #include \"xla/types.h\"\n #include \"xla/xla.pb.h\"\n #include \"xla/xla_data.pb.h\"\n+#include \"xla/tsl/platform/status_macros.h\"\n \n namespace xla {\n \n@@ -113,6 +118,24 @@ class ClientLibraryTestRunnerMixin : public T {\n     TF_ASSIGN_OR_RETURN(std::unique_ptr<HloModule> module,\n                         BuildAndVerifyHloModule(computation, argument_shapes,\n                                                 &execution_options));\n+    const int64_t num_partitions =\n+        std::max(1, execution_options.num_partitions());\n+    if (const int64_t num_devices =\n+            execution_options.num_replicas() * num_partitions;\n+        num_devices > 1) {\n+      std::optional<DeviceAssignment> device_assignment;\n+      DeviceAssignment* device_assignment_ptr = nullptr;\n+      if (execution_options.has_device_assignment()) {\n+        device_assignment = module->config().static_device_assignment();\n+        device_assignment_ptr = &*device_assignment;\n+      }\n+      ASSIGN_OR_RETURN(std::vector<Literal> results,\n+                       this->ExecuteReplicated(\n+                           std::move(module), arguments, num_devices,\n+                           device_assignment_ptr, /*run_hlo_passes=*/true,\n+                           /*use_threads=*/true));\n+      return std::move(results.front());\n+    }\n     return this->Execute(std::move(module), arguments);\n   }\n "
        }
    ],
    "stats": {
        "total": 25,
        "additions": 25,
        "deletions": 0
    }
}