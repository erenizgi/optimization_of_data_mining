{
    "author": "penpornk",
    "message": "[xla:cpu] Rename `DotLibraryRewriter` to just `LibraryRewriter`.\n\nThe pass now handles `reduce` fusion in additional to `dot`. (`convolution` will also be supported soon.)\n\nPiperOrigin-RevId: 811781420",
    "sha": "93b7da30805b466a79106844d017ba34131c5f2b",
    "files": [
        {
            "sha": "8399bcbae98bd2c4479a20023ab8e81ec7087c4a",
            "filename": "third_party/xla/xla/backends/cpu/transforms/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD?ref=93b7da30805b466a79106844d017ba34131c5f2b",
            "patch": "@@ -18,9 +18,9 @@ package_group(\n )\n \n cc_library(\n-    name = \"dot_library_rewriter\",\n-    srcs = [\"dot_library_rewriter.cc\"],\n-    hdrs = [\"dot_library_rewriter.h\"],\n+    name = \"library_rewriter\",\n+    srcs = [\"library_rewriter.cc\"],\n+    hdrs = [\"library_rewriter.h\"],\n     local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":library_matcher\",\n@@ -46,11 +46,11 @@ cc_library(\n )\n \n xla_cc_test(\n-    name = \"dot_library_rewriter_test\",\n-    srcs = [\"dot_library_rewriter_test.cc\"],\n+    name = \"library_rewriter_test\",\n+    srcs = [\"library_rewriter_test.cc\"],\n     local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n-        \":dot_library_rewriter\",\n+        \":library_rewriter\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla:xla_proto_cc\",\n         \"//xla/backends/cpu:xnn_gemm_config\","
        },
        {
            "sha": "0faebfbd42e6fa97e30a93ed5a0a8ebeebecb076",
            "filename": "third_party/xla/xla/backends/cpu/transforms/library_rewriter.cc",
            "status": "renamed",
            "additions": 11,
            "deletions": 12,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.cc?ref=93b7da30805b466a79106844d017ba34131c5f2b",
            "patch": "@@ -13,7 +13,7 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/backends/cpu/transforms/dot_library_rewriter.h\"\n+#include \"xla/backends/cpu/transforms/library_rewriter.h\"\n \n #include <memory>\n #include <queue>\n@@ -162,7 +162,7 @@ inline absl::Status InsertConvertIfNecessary(\n \n }  // namespace\n \n-absl::StatusOr<LibraryMatcher*> DotLibraryRewriter::ChooseLibrary(\n+absl::StatusOr<LibraryMatcher*> LibraryRewriter::ChooseLibrary(\n     HloInstruction* instr) {\n   for (std::unique_ptr<LibraryMatcher>& lib : libs_) {\n     TF_ASSIGN_OR_RETURN(bool op_supported, lib->IsOpSupported(instr));\n@@ -173,7 +173,7 @@ absl::StatusOr<LibraryMatcher*> DotLibraryRewriter::ChooseLibrary(\n   return nullptr;\n }\n \n-void DotLibraryRewriter::AddFusionCandidates(\n+void LibraryRewriter::AddFusionCandidates(\n     HloInstruction* fusion, HloInstruction* instr, FusionDirection dir,\n     std::queue<std::pair<HloInstruction*, FusionDirection>>& queue) {\n   // Don't add anything that has already been fused or require multi-output\n@@ -199,10 +199,9 @@ void DotLibraryRewriter::AddFusionCandidates(\n   }\n }\n \n-absl::StatusOr<HloFusionInstruction*>\n-DotLibraryRewriter::MergeFusionInstructions(HloFusionInstruction* main,\n-                                            HloFusionInstruction* neighbor,\n-                                            FusionDirection dir) {\n+absl::StatusOr<HloFusionInstruction*> LibraryRewriter::MergeFusionInstructions(\n+    HloFusionInstruction* main, HloFusionInstruction* neighbor,\n+    FusionDirection dir) {\n   VLOG(3) << \"  \" << FusionDirectionToString(dir)\n           << \": Fusing with: \" << neighbor->ToString();\n   if (dir == FusionDirection::kUp) {\n@@ -219,7 +218,7 @@ DotLibraryRewriter::MergeFusionInstructions(HloFusionInstruction* main,\n                          FusionDirectionToString(dir));\n }\n \n-absl::StatusOr<HloInstruction*> DotLibraryRewriter::GrowFusion(\n+absl::StatusOr<HloInstruction*> LibraryRewriter::GrowFusion(\n     HloFusionInstruction* fusion, HloInstruction* to_fuse,\n     FusionDirection dir) {\n   HloInstruction* new_instr = nullptr;\n@@ -236,8 +235,8 @@ absl::StatusOr<HloInstruction*> DotLibraryRewriter::GrowFusion(\n   return new_instr;\n }\n \n-absl::Status DotLibraryRewriter::FuseNeighbors(HloFusionInstruction* fusion,\n-                                               LibraryMatcher* lib) {\n+absl::Status LibraryRewriter::FuseNeighbors(HloFusionInstruction* fusion,\n+                                            LibraryMatcher* lib) {\n   // A queue storing potential candidates for fusion: Each item is a pair of\n   //   - Pointer to immediate neighbors of the current fusion node.\n   //   - Travel direction: up (parents) and down (children).\n@@ -285,7 +284,7 @@ absl::Status DotLibraryRewriter::FuseNeighbors(HloFusionInstruction* fusion,\n   return absl::OkStatus();\n }\n \n-absl::StatusOr<bool> DotLibraryRewriter::ProcessComputation(\n+absl::StatusOr<bool> LibraryRewriter::ProcessComputation(\n     HloComputation* computation) {\n   // Construct a list of instructions that can start a library fusion, starting\n   // from the root up to the top. Prioritize dot and reduce ops over\n@@ -335,7 +334,7 @@ absl::StatusOr<bool> DotLibraryRewriter::ProcessComputation(\n   return !fused_.empty();\n }\n \n-absl::StatusOr<bool> DotLibraryRewriter::Run(\n+absl::StatusOr<bool> LibraryRewriter::Run(\n     HloModule* module,\n     const absl::flat_hash_set<absl::string_view>& execution_threads) {\n   bool module_changed = false;",
            "previous_filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter.cc"
        },
        {
            "sha": "fc03585abfdd7135aff40a3417c6723e89ecf538",
            "filename": "third_party/xla/xla/backends/cpu/transforms/library_rewriter.h",
            "status": "renamed",
            "additions": 9,
            "deletions": 10,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.h?ref=93b7da30805b466a79106844d017ba34131c5f2b",
            "patch": "@@ -13,8 +13,8 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#ifndef XLA_BACKENDS_CPU_TRANSFORMS_DOT_LIBRARY_REWRITER_H_\n-#define XLA_BACKENDS_CPU_TRANSFORMS_DOT_LIBRARY_REWRITER_H_\n+#ifndef XLA_BACKENDS_CPU_TRANSFORMS_LIBRARY_REWRITER_H_\n+#define XLA_BACKENDS_CPU_TRANSFORMS_LIBRARY_REWRITER_H_\n \n #include <memory>\n #include <queue>\n@@ -47,19 +47,18 @@ enum class FusionDirection {\n   kBoth,  // Traverse both up and down.\n };\n \n-struct DotLibraryRewriterOptions {\n+struct LibraryRewriterOptions {\n   bool use_onednn = false;\n   bool use_xnnpack = false;\n   const tsl::protobuf::RepeatedField<int>* onednn_fusion_types = nullptr;\n   const tsl::protobuf::RepeatedField<int>* xnn_fusion_types = nullptr;\n };\n \n // Rewrites suitable Dot operations into library fusions.\n-class DotLibraryRewriter : public HloModulePass {\n+class LibraryRewriter : public HloModulePass {\n  public:\n-  explicit DotLibraryRewriter(\n-      const TargetMachineFeatures* target_machine_features,\n-      const DotLibraryRewriterOptions& options)\n+  explicit LibraryRewriter(const TargetMachineFeatures* target_machine_features,\n+                           const LibraryRewriterOptions& options)\n       : target_machine_features_(target_machine_features),\n         options_(std::move(options)) {\n     // Initialize library matchers.\n@@ -87,7 +86,7 @@ class DotLibraryRewriter : public HloModulePass {\n     fuse_eltwise_ = absl::c_any_of(\n         libs_, [](const auto& lib) { return lib->fuse_eltwise(); });\n   }\n-  ~DotLibraryRewriter() override = default;\n+  ~LibraryRewriter() override = default;\n \n   // Returns the first library matcher that supports the given instruction.\n   absl::StatusOr<LibraryMatcher*> ChooseLibrary(HloInstruction* instr);\n@@ -127,7 +126,7 @@ class DotLibraryRewriter : public HloModulePass {\n \n  private:\n   const TargetMachineFeatures* target_machine_features_;\n-  const DotLibraryRewriterOptions options_;\n+  const LibraryRewriterOptions options_;\n   std::vector<std::unique_ptr<LibraryMatcher>> libs_;\n   absl::flat_hash_set<HloOpcode> supported_ops_;\n   absl::flat_hash_set<HloInstruction*> fused_;\n@@ -138,4 +137,4 @@ class DotLibraryRewriter : public HloModulePass {\n \n }  // namespace xla::cpu\n \n-#endif  // XLA_BACKENDS_CPU_TRANSFORMS_DOT_LIBRARY_REWRITER_H_\n+#endif  // XLA_BACKENDS_CPU_TRANSFORMS_LIBRARY_REWRITER_H_",
            "previous_filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter.h"
        },
        {
            "sha": "022407dbf9ce750e1511ff9bb474686beb2df5be",
            "filename": "third_party/xla/xla/backends/cpu/transforms/library_rewriter_test.cc",
            "status": "renamed",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter_test.cc?ref=93b7da30805b466a79106844d017ba34131c5f2b",
            "patch": "@@ -13,7 +13,7 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/backends/cpu/transforms/dot_library_rewriter.h\"\n+#include \"xla/backends/cpu/transforms/library_rewriter.h\"\n \n #include <memory>\n #include <string>\n@@ -101,12 +101,12 @@ class CpuLibraryTest : public TargetMachineTestBase {\n     tsl::protobuf::RepeatedField<int> empty_fusion_types;\n     bool use_onednn = spec.lib == \"onednn\";\n     bool use_xnnpack = spec.lib == \"xnn\";\n-    DotLibraryRewriterOptions options = {\n+    LibraryRewriterOptions options = {\n         use_onednn, use_xnnpack,\n         /*onednn_fusion_types=*/\n         use_onednn ? &fusion_types : &empty_fusion_types,\n         /*xnn_fusion_types=*/use_xnnpack ? &fusion_types : &empty_fusion_types};\n-    DotLibraryRewriter rewriter(features.get(), options);\n+    LibraryRewriter rewriter(features.get(), options);\n     EXPECT_EQ(expected.changed, rewriter.Run(module.get()).value());\n     if (!expected.changed) {\n       return;  // No further checks if the module was not changed.",
            "previous_filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter_test.cc"
        },
        {
            "sha": "265698c703d905102b33a3560f909916d6f819d6",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=93b7da30805b466a79106844d017ba34131c5f2b",
            "patch": "@@ -236,7 +236,7 @@ cc_library(\n         \"//xla/backends/cpu/runtime:thunk\",\n         \"//xla/backends/cpu/runtime:thunk_proto_cc_impl\",\n         \"//xla/backends/cpu/runtime:thunk_proto_serdes\",\n-        \"//xla/backends/cpu/transforms:dot_library_rewriter\",\n+        \"//xla/backends/cpu/transforms:library_rewriter\",\n         \"//xla/backends/cpu/transforms:xnn_graph_fusion\",\n         \"//xla/backends/cpu/transforms/collectives:all_reduce_combiner\",\n         \"//xla/hlo/analysis:alias_info\","
        },
        {
            "sha": "37a58abef88b44700bad364985a2be2eda8d97a9",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b7da30805b466a79106844d017ba34131c5f2b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=93b7da30805b466a79106844d017ba34131c5f2b",
            "patch": "@@ -100,7 +100,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n #include \"xla/backends/cpu/runtime/thunk_proto_serdes.h\"\n #include \"xla/backends/cpu/transforms/collectives/all_reduce_combiner.h\"\n-#include \"xla/backends/cpu/transforms/dot_library_rewriter.h\"\n+#include \"xla/backends/cpu/transforms/library_rewriter.h\"\n #include \"xla/backends/cpu/transforms/xnn_graph_fusion.h\"\n #include \"xla/backends/cpu/xnn_support.h\"\n #include \"xla/cpu_function_runtime.h\"\n@@ -931,7 +931,7 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n   // XNNPACK ops availability checks depend on the layout information,\n   // so until another solution is developed the passes creating XNNPACK fusions\n   // have to run after layout assignment.\n-  DotLibraryRewriterOptions options = {\n+  LibraryRewriterOptions options = {\n       /*use_onednn=*/module->config().debug_options().xla_cpu_use_onednn(),\n       /*use_xnnpack=*/module->config().debug_options().xla_cpu_use_xnnpack(),\n       /*onednn_fusion_types=*/\n@@ -943,7 +943,7 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n   if (options.use_onednn || options.use_xnnpack) {\n     HloPassPipeline lib_pipeline(\"dot-library-passes\");\n     lib_pipeline.AddPass<DotDecomposer>();\n-    lib_pipeline.AddPass<DotLibraryRewriter>(target_machine_features, options);\n+    lib_pipeline.AddPass<LibraryRewriter>(target_machine_features, options);\n     TF_RETURN_IF_ERROR(lib_pipeline.Run(module).status());\n   }\n "
        }
    ],
    "stats": {
        "total": 68,
        "additions": 33,
        "deletions": 35
    }
}