{
    "author": "qukhan",
    "message": "Add TFLITE_XNNPACK_DELEGATE_FLAG_DISABLE_DYNAMICALLY_QUANTIZED_OPS flag\n\nPiperOrigin-RevId: 804955722",
    "sha": "50427ae17a266ca6fb959426e59356a9fd9597ef",
    "files": [
        {
            "sha": "6db9c6e5077c22f6385a26cd9bc9086fde925270",
            "filename": "tensorflow/lite/delegates/xnnpack/xnnpack_delegate.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/50427ae17a266ca6fb959426e59356a9fd9597ef/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fxnnpack_delegate.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/50427ae17a266ca6fb959426e59356a9fd9597ef/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fxnnpack_delegate.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fxnnpack_delegate.cc?ref=50427ae17a266ca6fb959426e59356a9fd9597ef",
            "patch": "@@ -691,6 +691,12 @@ class Delegate {\n #endif\n   }\n \n+  bool disable_dynamically_quantized_ops() const {\n+    return (options_.flags &\n+            TFLITE_XNNPACK_DELEGATE_FLAG_DISABLE_DYNAMICALLY_QUANTIZED_OPS) !=\n+           0;\n+  }\n+\n   bool enable_latest_operators() const {\n #ifdef XNNPACK_DELEGATE_USE_LATEST_OPS\n     return true;\n@@ -3611,8 +3617,10 @@ class Subgraph {\n         logging_context, output_tensor, 4, node->outputs->data[0],\n         BuiltinOperator_CONV_2D, node_index));\n \n-    bool dynamically_quantized = ((input_tensor.type == kTfLiteFloat32 &&\n-                                   filter_tensor.type == kTfLiteInt8));\n+    bool dynamically_quantized =\n+        (!delegate.disable_dynamically_quantized_ops() &&\n+         (input_tensor.type == kTfLiteFloat32 &&\n+          filter_tensor.type == kTfLiteInt8));\n     if (input_tensor.type != output_tensor.type ||\n         ((input_tensor.type != filter_tensor.type) && !dynamically_quantized)) {\n       TF_LITE_MAYBE_KERNEL_LOG(\n@@ -4532,9 +4540,11 @@ class Subgraph {\n         CheckTensorFloat32OrQUInt8Type(delegate, logging_context, output_tensor,\n                                        node->outputs->data[0], node_index));\n \n-    bool dynamically_quantized = ((input_tensor.type == kTfLiteFloat32 &&\n-                                   (filter_tensor.type == kTfLiteInt4 ||\n-                                    filter_tensor.type == kTfLiteInt8)));\n+    bool dynamically_quantized =\n+        (!delegate.disable_dynamically_quantized_ops() &&\n+         (input_tensor.type == kTfLiteFloat32 &&\n+          (filter_tensor.type == kTfLiteInt4 ||\n+           filter_tensor.type == kTfLiteInt8)));\n     bool supported_srq = (input_tensor.type == kTfLiteInt8 &&\n                           (filter_tensor.type == kTfLiteInt4 ||\n                            filter_tensor.type == kTfLiteInt8));"
        },
        {
            "sha": "34d42bcebdaced0b0c8772e70546eadc4095ab63",
            "filename": "tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/50427ae17a266ca6fb959426e59356a9fd9597ef/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fxnnpack_delegate.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/50427ae17a266ca6fb959426e59356a9fd9597ef/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fxnnpack_delegate.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fxnnpack_delegate.h?ref=50427ae17a266ca6fb959426e59356a9fd9597ef",
            "patch": "@@ -56,6 +56,9 @@ extern \"C\" {\n // Disable XNNPack subgraph reshaping. This means that models with dynamic\n // tensors are not supported.\n #define TFLITE_XNNPACK_DELEGATE_FLAG_DISABLE_SUBGRAPH_RESHAPING 0x00000400\n+// Disable delegation of dynamically quantized ops.\n+#define TFLITE_XNNPACK_DELEGATE_FLAG_DISABLE_DYNAMICALLY_QUANTIZED_OPS \\\n+  0x00000800\n \n struct TfLiteXNNPackDelegateWeightsCache;\n \n@@ -74,6 +77,7 @@ typedef struct {\n   // - TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER\n   // - TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS\n   // - TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_SUBGRAPH_RESHAPING\n+  // - TFLITE_XNNPACK_DELEGATE_FLAG_DISABLE_DYNAMICALLY_QUANTIZED_OPS\n   // - TFLITE_XNNPACK_DELEGATE_FLAG_DISABLE_SUBGRAPH_RESHAPING\n   // - TFLITE_XNNPACK_DELEGATE_FLAG_SLOW_CONSISTENT_ARITHMETIC\n   uint32_t flags;"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 19,
        "deletions": 5
    }
}