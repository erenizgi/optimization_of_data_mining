{
    "author": "alekstheod",
    "message": "PR #33261: [ROCm] make rbe docker image parametrized move to local config rocm\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33261\n\nüìù Summary of Changes\nMove rbe platform to local_config_rocm and make the docker image configurable\n\nüéØ Justification\nROCm ci requires rocm rbe build image to be configurable to match with what is used by the CI worker node\n\nüöÄ Kind of Contribution\nPlease remove what does not apply:\n‚ú® New Feature\n\nüìä Benchmark (for Performance Improvements)\nNot relevant, CI config\n\nüß™ Unit Tests:\nNot relevant, CI config\n\nüß™ Execution Tests:\nNot relevant, CI config.\n\nCopybara import of the project:\n\n--\n3054eedc59a3d6333bf8390d5af5ea27339186d3 by Alexandros Theodoridis <atheodor@amd.com>:\n\nMake rocm rbe docker image parametrized\n\n--\nfc63fa14135f45a0e73f47d1740db36295d15e59 by Alexandros Theodoridis <atheodor@amd.com>:\n\nPut additional arguments to the end of the build command to be able to override args\n\n--\n1948a89ad0180745c2888921d9c4fa4f04dbf8ef by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd env var dependency\n\n--\nbafafddd42dd8edf8713c980f68a4e4e512df345 by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd image description\n\n--\n10984dacaa66cc3435f44249977bde2cb6252dfb by Alexandros Theodoridis <atheodor@amd.com>:\n\nRestore invalid change\n\nMerging this change closes #33261\n\nPiperOrigin-RevId: 827874222",
    "sha": "02184150999bdd0953d2f4b7025b11cbd0b60959",
    "files": [
        {
            "sha": "94e73c9f54263852d111d86cf10db8bda604c972",
            "filename": "third_party/xla/build_tools/rocm/platform/BUILD",
            "status": "removed",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa6b93ceb18214b71a349725b851585a3bfb9559/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa6b93ceb18214b71a349725b851585a3bfb9559/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fplatform%2FBUILD?ref=fa6b93ceb18214b71a349725b851585a3bfb9559",
            "patch": "@@ -1,19 +0,0 @@\n-# Copyright 2025 The OpenXLA Authors.\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-# ============================================================================\n-\n-package(\n-    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n-    default_visibility = [\"//visibility:public\"],\n-)"
        },
        {
            "sha": "6464787c427ac564726c3e9529a4194421c0a2b2",
            "filename": "third_party/xla/build_tools/rocm/platform/linux_x64/BUILD",
            "status": "removed",
            "additions": 0,
            "deletions": 32,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa6b93ceb18214b71a349725b851585a3bfb9559/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fplatform%2Flinux_x64%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa6b93ceb18214b71a349725b851585a3bfb9559/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fplatform%2Flinux_x64%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fplatform%2Flinux_x64%2FBUILD?ref=fa6b93ceb18214b71a349725b851585a3bfb9559",
            "patch": "@@ -1,32 +0,0 @@\n-# Copyright 2025 The OpenXLA Authors.\n-#\n-# Licensed under the Apache License, Version 2.0 (the \"License\");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-# ============================================================================\n-\n-package(\n-    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n-    default_visibility = [\"//visibility:public\"],\n-)\n-\n-platform(\n-    name = \"linux_x64\",\n-    constraint_values = [\n-        \"@platforms//os:linux\",\n-        \"@platforms//cpu:x86_64\",\n-        \"@bazel_tools//tools/cpp:clang\",\n-    ],\n-    exec_properties = {\n-        \"container-image\": \"docker://rocm/tensorflow-build@sha256:7cd444ac48657fee2f5087fbda7766266704d3f8fb2299f681952ae4eabed060\",\n-        \"OSFamily\": \"Linux\",\n-    },\n-)"
        },
        {
            "sha": "4ff916d1f30f304128f74804701342fd749b73e3",
            "filename": "third_party/xla/build_tools/rocm/rocm_xla.bazelrc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc?ref=02184150999bdd0953d2f4b7025b11cbd0b60959",
            "patch": "@@ -5,9 +5,9 @@ build:rocm_dev --remote_cache=\"https://wardite.cluster.engflow.com\"\n \n build:rocm_rbe --bes_backend=\"grpcs://wardite.cluster.engflow.com\"\n build:rocm_rbe --bes_results_url=\"https://wardite.cluster.engflow.com/invocation/\"\n-build:rocm_rbe --host_platform=\"//build_tools/rocm/platform/linux_x64\"\n-build:rocm_rbe --extra_execution_platforms=\"//build_tools/rocm/platform/linux_x64\"\n-build:rocm_rbe --platforms=\"//build_tools/rocm/platform/linux_x64\"\n+build:rocm_rbe --host_platform=\"@local_config_rocm//rocm:linux_x64\"\n+build:rocm_rbe --extra_execution_platforms=\"@local_config_rocm//rocm:linux_x64\"\n+build:rocm_rbe --platforms=\"@local_config_rocm//rocm:linux_x64\"\n build:rocm_rbe --bes_timeout=600s\n build:rocm_rbe --tls_client_certificate=\"/tf/certificates/ci-cert.crt\"\n build:rocm_rbe --tls_client_key=\"/tf/certificates/ci-cert.key\""
        },
        {
            "sha": "e175651140ba14571651ef5fc4c1c68e2c6ebe99",
            "filename": "third_party/xla/build_tools/rocm/run_xla_ci_build.sh",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh?ref=02184150999bdd0953d2f4b7025b11cbd0b60959",
            "patch": "@@ -27,7 +27,6 @@ fi\n \n SCRIPT_DIR=$(dirname $0)\n bazel --bazelrc=\"$SCRIPT_DIR/rocm_xla_ci.bazelrc\" test \\\n-\t\"$@\" \\\n \t--build_tag_filters=$TAG_FILTERS \\\n     --test_tag_filters=$TAG_FILTERS \\\n \t--profile=/tf/pkg/profile.json.gz \\\n@@ -36,4 +35,5 @@ bazel --bazelrc=\"$SCRIPT_DIR/rocm_xla_ci.bazelrc\" test \\\n \t--action_env=XLA_FLAGS=\"--xla_gpu_enable_llvm_module_compilation_parallelism=true --xla_gpu_force_compilation_parallelism=16\" \\\n \t--test_output=errors \\\n \t--local_test_jobs=2 \\\n-\t--run_under=//build_tools/rocm:parallel_gpu_execute\n+\t--run_under=//build_tools/rocm:parallel_gpu_execute \\\n+\t\"$@\""
        },
        {
            "sha": "3f8617428bc5d66f4c1015d276d6040a6f296378",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=02184150999bdd0953d2f4b7025b11cbd0b60959",
            "patch": "@@ -562,3 +562,16 @@ filegroup(\n     srcs = glob([\"%{rocm_root}/**\"]),\n     visibility = [\"//visibility:public\"],\n )\n+\n+platform(\n+    name = \"linux_x64\",\n+    constraint_values = [\n+        \"@platforms//os:linux\",\n+        \"@platforms//cpu:x86_64\",\n+        \"@bazel_tools//tools/cpp:clang\",\n+    ],\n+    exec_properties = {\n+        \"container-image\": \"docker://%{rocm_rbe_docker_image}\",\n+        \"OSFamily\": \"Linux\",\n+    },\n+)"
        },
        {
            "sha": "4beb04b06d7f122abec80f24d5e044f2784d7ae9",
            "filename": "third_party/xla/third_party/gpus/rocm_configure.bzl",
            "status": "modified",
            "additions": 7,
            "deletions": 18,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/02184150999bdd0953d2f4b7025b11cbd0b60959/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl?ref=02184150999bdd0953d2f4b7025b11cbd0b60959",
            "patch": "@@ -54,6 +54,10 @@ _ROCM_VERSION = \"ROCM_VERSION\"\n \n _DEFAULT_ROCM_TOOLKIT_PATH = \"/opt/rocm\"\n _TF_ROCM_MULTIPLE_PATHS = \"TF_ROCM_MULTIPLE_PATHS\"\n+_TF_ROCM_RBE_DOCKER_IMAGE = \"TF_ROCM_RBE_DOCKER_IMAGE\"\n+\n+# rocm/tensorflow-build:latest-jammy-python3.11-rocm7.0.2\n+_DEFAULT_TF_ROCM_RBE_DOCKER_IMAGE = \"rocm/tensorflow-build@sha256:a2672ff2510b369b4a5f034272a518dc93c2e492894e3befaeef19649632ccaa\"\n _LLVM_PATH = \"LLVM_PATH\"\n \n def verify_build_defines(params):\n@@ -481,24 +485,6 @@ def _norm_path(path):\n         path = path[:-1]\n     return path\n \n-def _genrule(src_dir, genrule_name, command, outs):\n-    \"\"\"Returns a string with a genrule.\n-\n-    Genrule executes the given command and produces the given outputs.\n-    \"\"\"\n-    return (\n-        \"genrule(\\n\" +\n-        '    name = \"' +\n-        genrule_name + '\",\\n' +\n-        \"    outs = [\\n\" +\n-        outs +\n-        \"\\n    ],\\n\" +\n-        '    cmd = \"\"\"\\n' +\n-        command +\n-        '\\n   \"\"\",\\n' +\n-        \")\\n\"\n-    )\n-\n def _flag_enabled(repository_ctx, flag_name):\n     return get_host_environ(repository_ctx, flag_name) == \"1\"\n \n@@ -633,6 +619,7 @@ def _create_local_rocm_repository(repository_ctx):\n     repository_dict = {\n         \"%{rocm_root}\": rocm_toolkit_path,\n         \"%{rocm_toolkit_path}\": str(repository_ctx.path(rocm_config.rocm_toolkit_path)),\n+        \"%{rocm_rbe_docker_image}\": repository_ctx.os.environ.get(_TF_ROCM_RBE_DOCKER_IMAGE, _DEFAULT_TF_ROCM_RBE_DOCKER_IMAGE),\n     }\n \n     is_rocm_clang = _use_rocm_clang(repository_ctx)\n@@ -851,6 +838,8 @@ _ENVIRONS = [\n     _TF_ROCM_AMDGPU_TARGETS,\n     _OS,\n     _ROCM_VERSION,\n+    _TF_ROCM_RBE_DOCKER_IMAGE,\n+    _TF_ROCM_MULTIPLE_PATHS,\n ]\n \n remote_rocm_configure = repository_rule("
        }
    ],
    "stats": {
        "total": 99,
        "additions": 25,
        "deletions": 74
    }
}