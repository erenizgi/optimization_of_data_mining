{
    "author": "tensorflower-gardener",
    "message": "Truncate weight cache file before building\n\nPiperOrigin-RevId: 810517192",
    "sha": "cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb",
    "files": [
        {
            "sha": "82472f4462c2ef1127e68fce1e6c233074e8f4a2",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc?ref=cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #if defined(_MSC_VER)\n #include <io.h>\n #define F_OK 0\n+#define ftruncate _chsize_s\n #else\n #include <unistd.h>\n #endif  // defined(_MSC_VER)\n@@ -118,6 +119,10 @@ bool FileDescriptorView::Write(const void* src, size_t count) const {\n   return true;\n }\n \n+bool FileDescriptorView::Truncate(size_t size) const {\n+  return ftruncate(fd_, size) == 0;\n+}\n+\n bool InMemoryFileDescriptorAvailable() {\n #if TFLITE_XNNPACK_IN_MEMORY_FILE_ENABLED\n   // Test if the syscall memfd_create is available."
        },
        {
            "sha": "501b5fd40a92c8768e03f2e19b8b6d6d13538568",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h?ref=cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb",
            "patch": "@@ -85,6 +85,12 @@ class FileDescriptorView {\n   [[nodiscard /*Reading from a file may fail.*/]]\n   bool Write(const void* src, size_t count) const;\n \n+  // Truncates the file to the given size.\n+  //\n+  // Returns true if the file was truncated successfully.\n+  [[nodiscard /*Reading from a file may fail.*/]]\n+  bool Truncate(size_t size) const;\n+\n  protected:\n   int fd_ = -1;\n };"
        },
        {
            "sha": "97f3f795b2b6cb2bd964cbf75cf09cbab8cf97d3",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb",
            "patch": "@@ -134,6 +134,7 @@ bool WeightCacheBuilder::Start(const char* path, const FileDescriptor& fd) {\n   XNNPackCacheHeader header{XNNPackCacheHeader::kInvalidHeader};\n   header.buffer_list_offset = sizeof(header);\n \n+  XNNPACK_RETURN_CHECK(fd_.Truncate(0), \"could not truncate weight cache\");\n   XNNPACK_RETURN_CHECK(fd_.Write(&header, sizeof(header)),\n                        \"could not write initial cache header in %s: %s.\",\n                        file_path_.c_str(), strerror(errno));"
        },
        {
            "sha": "a74e40018e1eba627ed8316c82e84e7d8f103cc2",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc?ref=cb018b2dac4e454fcecff4b68f6ec8355ec1b6bb",
            "patch": "@@ -945,6 +945,33 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n   }\n }\n \n+TEST_P(MMapWeightCacheProviderTest, XnnpackRebuildOnVersionMismatch) {\n+  TempFileDesc temp_fd;\n+  const char* temp_fd_cpath = explicit_fd_path;\n+  FileDescriptor temp_fd_value = temp_fd.Duplicate();\n+\n+  {  // Set bad build identifier\n+    XNNPackCacheHeader header{.version = XNNPackCacheHeader::kVersion};\n+    header.xnnpack_build_identifier[0] += 1;\n+    ASSERT_TRUE(temp_fd_value.Write(&header, sizeof(header)));\n+  }\n+\n+  if (!use_explicit_fd) {\n+    temp_fd.Close();\n+    temp_fd_cpath = temp_fd.GetCPath();\n+    temp_fd_value.Close();\n+    if (use_in_memory_cache) {\n+      temp_fd_cpath = kInMemoryCachePath;\n+    }\n+  }\n+\n+  auto build_cache_provider = std::make_unique<MMapWeightCacheProvider>();\n+  MMapWeightCacheProvider& cache_provider = *build_cache_provider;\n+  ASSERT_TRUE(cache_provider.LoadOrStartBuild(temp_fd_cpath,\n+                                              temp_fd_value.Duplicate()));\n+  ASSERT_TRUE(cache_provider.StartBuildStep());\n+}\n+\n class IsCompatibleCacheFileTest : public testing::Test {\n  public:\n   void SetUp() override {"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 39,
        "deletions": 0
    }
}