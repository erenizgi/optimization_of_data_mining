{
    "author": "liepieshov",
    "message": "Fix parameter replication handling when using tuple arguments in MLIR HLO to HLO translation.\n\nWhen `options_.use_tuple_args` is true, all parameter replication information from individual function arguments is now correctly aggregated and associated with the single tuple parameter at index 0. Additionally, the `SetParameterReplication` function in `xla_builder.cc` is updated to only apply replication to instructions with the `kParameter` opcode.\n\nPiperOrigin-RevId: 801806193",
    "sha": "6c6bd9f6b72aba4720c5b0018c795c36557a14d2",
    "files": [
        {
            "sha": "82ebc2f4f2c08e2cd0fda27d68b63b587cc59d04",
            "filename": "third_party/xla/xla/hlo/builder/xla_builder.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Fxla_builder.cc?ref=6c6bd9f6b72aba4720c5b0018c795c36557a14d2",
            "patch": "@@ -447,6 +447,9 @@ absl::Status XlaBuilderFriend::SetParameterReplication(\n   TF_ASSIGN_OR_RETURN(HloComputationProto * computation_proto,\n                       builder->GetSubcomputation(computation));\n   for (auto& instr : *computation_proto->mutable_instructions()) {\n+    if (instr.opcode() != HloOpcodeString(HloOpcode::kParameter)) {\n+      continue;\n+    }\n     auto it = replication.find(instr.parameter_number());\n     if (it != replication.end()) {\n       instr.mutable_parameter_replication()"
        },
        {
            "sha": "dc7288b879f8b4f5232a7c75b2015c9aa75c8ba7",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/mlir_hlo_to_hlo.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc?ref=6c6bd9f6b72aba4720c5b0018c795c36557a14d2",
            "patch": "@@ -5941,6 +5941,21 @@ LogicalResult ConvertToHloModule::RunOnFunction(mlir::func::FuncOp f) {\n     }\n   }\n   if (!parameter_replication.empty()) {\n+    if (options_.use_tuple_args) {\n+      parameter_replication.clear();\n+      auto& replicated_at_leaf_buffers = parameter_replication[0];\n+      for (int i = 0; i < f.getNumArguments(); ++i) {\n+        if (auto pr = f.getArgAttrOfType<mlir::ArrayAttr>(\n+                i, kParameterReplicationAttr)) {\n+          for (auto b : pr.getValue()) {\n+            replicated_at_leaf_buffers.push_back(\n+                cast<mlir::BoolAttr>(b).getValue());\n+          }\n+        } else {\n+          replicated_at_leaf_buffers.push_back(false);\n+        }\n+      }\n+    }\n     absl::Status status =\n         xla::internal::XlaBuilderFriend::SetParameterReplication(\n             &module_builder_, computation, parameter_replication);"
        },
        {
            "sha": "51044b2b22819e0bade7f4a59ea90b2470170931",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2FBUILD?ref=6c6bd9f6b72aba4720c5b0018c795c36557a14d2",
            "patch": "@@ -23,6 +23,7 @@ lit_test_suite(\n             \"export_bounded_dynamism.mlir\",\n             \"export_entry_computation_layout.mlir\",\n             \"export_large_constants.mlir\",\n+            \"export_tuple_args_parameter_replication.mlir\",\n             \"export_replicas.mlir\",\n             \"frontend_attributes.mlir\",\n             \"function.mlir\","
        },
        {
            "sha": "9018a262182a6e4ceba140a4fd47f2f10e4ff44e",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/export_tuple_args_parameter_replication.mlir",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport_tuple_args_parameter_replication.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6c6bd9f6b72aba4720c5b0018c795c36557a14d2/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport_tuple_args_parameter_replication.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport_tuple_args_parameter_replication.mlir?ref=6c6bd9f6b72aba4720c5b0018c795c36557a14d2",
            "patch": "@@ -0,0 +1,15 @@\n+// RUN: xla-translate --print-sugar=false -split-input-file -mlir-hlo-to-hlo-text -emit-use-tuple-args -verify-diagnostics %s | FileCheck %s\n+\n+// CHECK: ENTRY\n+// CHECK:  [[VAL_1:%.*]] = (f32[], (f32[2,4], (f32[2,4]))) parameter(0), parameter_replication={true,false,true}\n+func.func @main(%arg0: tensor<f32> {mhlo.parameter_replication = [true]}, %arg1: tuple<tensor<2x4xf32>, tuple<tensor<2x4xf32>>> {mhlo.parameter_replication = [false, true]}) -> tensor<f32> {\n+  return %arg0 : tensor<f32>\n+}\n+\n+// -----\n+\n+// CHECK: ENTRY\n+// CHECK:  [[VAL_1:%.*]] = (f32[], (f32[2,4], (f32[2,4]))) parameter(0), parameter_replication={false,false,true}\n+func.func @main(%arg0: tensor<f32>, %arg1: tuple<tensor<2x4xf32>, tuple<tensor<2x4xf32>>> {mhlo.parameter_replication = [false, true]}) -> tensor<f32> {\n+  return %arg0 : tensor<f32>\n+}"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 34,
        "deletions": 0
    }
}