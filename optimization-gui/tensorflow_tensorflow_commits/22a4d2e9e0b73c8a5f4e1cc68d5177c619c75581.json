{
    "author": "sohaibiftikhar",
    "message": "[XLA:GPU] Switch collective_ops_e2e_test to run on h100\n\nTests are currently running on P100 instances which don't have P2P access. Which means that a few of them are skipped in the CI which can lead to breakages as found in cl/815605398.\n\nForcing the test test to run on an h100 ensures that this does not happen anymore.\n\nPiperOrigin-RevId: 816147788",
    "sha": "22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581",
    "files": [
        {
            "sha": "64295b6176325754232c0eee38853899b30255c3",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581",
            "patch": "@@ -2771,7 +2771,7 @@ xla_test(\n     srcs = [\"collective_ops_e2e_test.cc\"],\n     backend_tags = {\n         \"gpu\": [\n-            \"multi_gpu\",\n+            \"multi_gpu_h100\",\n             \"no_oss\",\n         ],\n     },"
        },
        {
            "sha": "a22b574ae82329f4c6831ea4fe30084f57df881d",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test.cc",
            "status": "modified",
            "additions": 109,
            "deletions": 145,
            "changes": 254,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc?ref=22a4d2e9e0b73c8a5f4e1cc68d5177c619c75581",
            "patch": "@@ -47,7 +47,6 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_sharding.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/testlib/pattern_matcher_gmock.h\"\n-#include \"xla/hlo/testlib/verified_hlo_module.h\"\n #include \"xla/hlo/utils/hlo_matchers.h\"\n #include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n@@ -406,10 +405,10 @@ TEST_P(AsyncCollectiveOps, AsyncAllReduce) {\n     )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_all_reduce = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -447,10 +446,10 @@ TEST_P(AsyncCollectiveOps, AsyncAllGather) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_all_gather = GetParam();\n \n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n@@ -493,10 +492,10 @@ TEST_P(AsyncCollectiveOps, AsyncAllGatherMixedTypes) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_all_gather = GetParam();\n \n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n@@ -536,10 +535,10 @@ TEST_P(AsyncCollectiveOps, AsyncCollectiveBroadcast) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_collective_broadcast = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -573,10 +572,10 @@ TEST_P(AsyncCollectiveOps, AsyncCollectivePermute) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_collective_permute = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -718,10 +717,10 @@ TEST_P(AsyncCollectiveOps, AsyncReduceScatter) {\n   )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_reduce_scatter = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -756,10 +755,10 @@ TEST_P(AsyncCollectiveOps, AsyncAllToAllWithSplitDim) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_all_to_all = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -844,10 +843,10 @@ TEST_P(AsyncCollectiveOps, AsyncAllToAllWithoutSplitDim) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_all_to_all = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -924,10 +923,10 @@ TEST_P(AsyncCollectiveOps, AsyncAllToAllNumberOfElementsLargerThanInt32Max) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n   const bool enable_async_all_to_all = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -977,10 +976,9 @@ ENTRY entry {\n )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           CreateExecutable(kModuleStr, kNumReplicas));\n@@ -1064,10 +1062,9 @@ TEST_P(AsyncMemcpyCollectiveOps, AsyncAllToAllDegenerateWithSplitDim) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -1099,10 +1096,9 @@ TEST_P(AsyncMemcpyCollectiveOps, AsyncAllToAllDegenerateWithoutSplitDim) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -1331,10 +1327,9 @@ TEST_F(CollectiveOpsTestE2E, WhileLoopReduceScatterCodeMotion) {\n   )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   DebugOptions debug_options = GetDebugOptionsForTest();\n   debug_options.set_xla_gpu_enable_while_loop_reduce_scatter_code_motion(true);\n@@ -1389,10 +1384,9 @@ TEST_F(CollectiveOpsTestE2E, NoAllToAllDecomposition) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -1437,10 +1431,9 @@ TEST_F(CollectiveOpsTestE2E, NoAsyncCollectives) {\n   }\n   )\";\n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -2313,10 +2306,9 @@ ENTRY entry {\n )\";\n \n   const int64_t kNumReplicas = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -2332,11 +2324,9 @@ class CollectiveOpsTestE2EPipelinedNonPipelined : public CollectiveOpsTestE2E {\n   void CollectiveOpsComparePipelinedNonPipelined(absl::string_view hlo_string) {\n     const int64_t kNumReplicas = 1;\n     const int64_t kNumPartitions = 2;\n-    if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-      GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                   << \" devices (\" << hlo_runner_->device_count()\n-                   << \" available)\";\n-    }\n+    ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+        << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+        << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n     HloModuleConfig config =\n         GetModuleConfigForTest(kNumReplicas, kNumPartitions);\n@@ -2578,11 +2568,9 @@ ENTRY entry {\n \n   const int64_t kNumReplicas = 1;\n   const int64_t kNumPartitions = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -2635,11 +2623,9 @@ ENTRY entry {\n \n   const int64_t kNumReplicas = 1;\n   const int64_t kNumPartitions = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -2737,10 +2723,10 @@ ENTRY entry {\n )\";\n \n   const int64_t kNumReplicas = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n   const int64_t kNumPartitions = 4;\n \n   HloModuleConfig config =\n@@ -3050,11 +3036,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3094,11 +3078,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_InputBufferLargerThanOutput) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3138,11 +3120,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_OutputBufferLargerThanInput) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3182,11 +3162,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_MultipleUpdates) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3227,11 +3205,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_MultiDimData) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3272,11 +3248,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_Degenerate) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3317,11 +3291,9 @@ TEST_P(RaggedAllToAllTest, RaggedAllToAll_2GPUs_NonDefaultLayout) {\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3367,11 +3339,9 @@ TEST_P(RaggedAllToAllTest,\n \n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -3612,11 +3582,9 @@ TEST_F(RaggedAllToAllMultiHostDecomposerTest, RaggedAllToAll_2GPUs_SliceSize1) {\n   const int64_t kNumReplicas = 2;\n   const int64_t kNumPartitions = 1;\n   const int64_t kNumUpdatesPerReplica = 16;\n-  if (hlo_runner_->device_count() < kNumReplicas * kNumPartitions) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas * kNumPartitions\n-                 << \" devices (\" << hlo_runner_->device_count()\n-                 << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas * kNumPartitions)\n+      << \"Test requires at least \" << kNumReplicas * kNumPartitions\n+      << \" devices (\" << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas * kNumPartitions);\n@@ -4104,10 +4072,9 @@ TEST_P(AllReduceTest, AsyncAllReduce_F32_2GPUs) {\n   )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -4185,10 +4152,9 @@ TEST_P(AllReduceTest, AsyncAllReduceInsideWhile_F32_2GPUs) {\n       kNumIterations, kNumElements, kReplicaGroups);\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -4242,10 +4208,9 @@ TEST_P(AllReduceTest, AsyncAllReduce_BF16_2GPUs) {\n   )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);\n@@ -4298,10 +4263,9 @@ TEST_P(AllReduceTest, AsyncAllReduce_PRED_2GPUs) {\n   )\";\n \n   const int64_t kNumReplicas = 2;\n-  if (hlo_runner_->device_count() < kNumReplicas) {\n-    GTEST_SKIP() << \"Test requires at least \" << kNumReplicas << \" devices (\"\n-                 << hlo_runner_->device_count() << \" available)\";\n-  }\n+  ASSERT_GE(hlo_runner_->device_count(), kNumReplicas)\n+      << \"Test requires at least \" << kNumReplicas << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n \n   HloModuleConfig config =\n       GetModuleConfigForTest(/*replica_count=*/kNumReplicas);"
        }
    ],
    "stats": {
        "total": 256,
        "additions": 110,
        "deletions": 146
    }
}