{
    "author": "alekstheod",
    "message": "PR #33656: [ROCm] Fix rocm device lib failure due to clash in include dirs\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33656\n\nüìù Summary of Changes\nFix build error reported here: https://github.com/openxla/xla/issues/33589\n\nüéØ Justification\nhttps://github.com/openxla/xla/issues/33589\nThe issue happens because we add the same directory twice once with the headr the second on as a directory itself\nto the sources of the genrule\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix,\n\nüìä Benchmark (for Performance Improvements)\nNot relevant, build fix.\n\nüß™ Unit Tests:\nNot relevant build fix.\n\nüß™ Execution Tests:\nNot relevant build fix.\n\nCopybara import of the project:\n\n--\n7b05237a5003a39c4ef1e27cd455651c12aa7b60 by Alexandros Theodoridis <atheodor@amd.com>:\n\nFix rocm device lib failure due to clash in include dirs\n\n--\ndcc33693d2ec741321025eb6546546cdd445f6f3 by Alexandros Theodoridis <atheodor@amd.com>:\n\nUse paths to extract the include paths from the hdrs\n\n--\n588ef972239cda0a9216fb3bb89ed98ec8da65b0 by Alexandros Theodoridis <atheodor@amd.com>:\n\nTranform to custom bazel rule\n\n--\nea5d79de1c8dcddab8b8b12a01b812efcc208240 by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd missing unique mnemonic\n\nMerging this change closes #33656\n\nPiperOrigin-RevId: 830362369",
    "sha": "8d416731843034c6917bcefed05962a07f851ee7",
    "files": [
        {
            "sha": "207102de8c1d8a1eeb13fa3ef7af7d70151bab19",
            "filename": "third_party/xla/third_party/rocm_device_libs/build_defs.bzl",
            "status": "modified",
            "additions": 134,
            "deletions": 95,
            "changes": 229,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d416731843034c6917bcefed05962a07f851ee7/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d416731843034c6917bcefed05962a07f851ee7/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl?ref=8d416731843034c6917bcefed05962a07f851ee7",
            "patch": "@@ -2,110 +2,149 @@\n \n load(\"@bazel_skylib//lib:paths.bzl\", \"paths\")\n \n-def bitcode_library(\n-        name,\n-        srcs = [],\n-        hdrs = [],\n-        file_specific_flags = {}):\n-    \"\"\"Builds a bitcode library\n+BitcodeLibraryInfo = provider(fields = [\"bc_file\"])\n \n-    Args:\n-        name: Unique name of the build rule.\n-        srcs: List of source files (*.cl, *.ll).\n-        hdrs: List of header files (*.h).\n-        file_specific_flags: Per-file dict of flags to be passed to clang.\n-    \"\"\"\n-    # Takes the CL sources and compiles them into bitcode files.\n-    # Merges those bitcode files together with any given .ll files into a single bitcode file.\n-    # Strips unnecessary metadata and forces linkonce local visibility for symbols.\n-    # Adapted from:\n-    #   https://github.com/ROCm/llvm-project/blob/22ee53fa53edc3a5f25feb08dc840f5b0fc362da/amd/device-libs/cmake/OCL.cmake#L73\n+def _bitcode_library_impl(ctx):\n+    \"\"\"Implements a bitcode library rule.\"\"\"\n+    srcs = ctx.files.srcs\n+    hdrs = ctx.files.hdrs\n \n-    clang_tool = \"@llvm-project//clang:clang\"\n-    llvm_link_tool = \"@llvm-project//llvm:llvm-link\"\n-    opt_tool = \"@llvm-project//llvm:opt\"\n-    prepare_builtins_tool = \":prepare_builtins\"\n-    clang_includes = \"@llvm-project//clang:builtin_headers_gen\"\n+    bc_outputs = []\n \n-    # Just for calculating the include path.\n-    clang_header = \"@llvm-project//clang:staging/include/opencl-c.h\"\n-\n-    include_paths = dict([(paths.dirname(h), None) for h in hdrs]).keys()\n-\n-    #TODO(rocm): Maybe compute this in cmd not to pass dirs as srcs\n-    includes = \" \".join([\"-I$(location {})\".format(inc) for inc in include_paths])\n-    flags = (\"-fcolor-diagnostics -Werror -Wno-error=atomic-alignment -x cl -Xclang \" +\n-             \"-cl-std=CL2.0 --target=amdgcn-amd-amdhsa -fvisibility=hidden -fomit-frame-pointer \" +\n-             \"-Xclang -finclude-default-header -Xclang -fexperimental-strict-floating-point \" +\n-             \"-Xclang -fdenormal-fp-math=dynamic -Xclang -Qn \" +\n-             \"-nogpulib -cl-no-stdinc -Xclang -mcode-object-version=none\")\n-\n-    link_inputs = []\n+    include_dirs = dict([(paths.dirname(h.path), None) for h in ctx.files.hdrs]).keys()\n \n+    # Compile .cl files to .bc\n     for src in srcs:\n-        filename = paths.basename(src)\n-        (basename, _, ext) = filename.partition(\".\")\n-\n-        if (ext == \"ll\"):\n-            link_inputs.append(src)\n-            continue\n-\n-        out = basename + \".bc\"\n-        link_inputs.append(out)\n-        extra_flags = \" \".join(file_specific_flags.get(filename, []))\n-        native.genrule(\n-            name = \"compile_\" + basename,\n-            srcs = [src] + hdrs + include_paths + [clang_includes, clang_header],\n-            outs = [out],\n-            cmd = \"$(location {}) -I$$(dirname $(location {}))  {} {} {} -emit-llvm -c $(location {}) -o $@\".format(\n-                clang_tool,\n-                clang_header,\n-                includes,\n-                flags,\n-                extra_flags,\n-                src,\n-            ),\n-            tools = [clang_tool],\n-            message = \"Compiling {} ...\".format(filename),\n-        )\n-\n-    link_message = \"Linking {}.bc ...\".format(name)\n-\n-    prelink_out = name + \".link0.lib.bc\"\n-    native.genrule(\n-        name = \"prelink_\" + name,\n-        srcs = link_inputs,\n-        outs = [prelink_out],\n-        cmd = \"$(location {}) $(SRCS) -o $@\".format(llvm_link_tool),\n-        tools = [llvm_link_tool],\n-        message = link_message,\n+        if src.path.endswith(\".cl\"):\n+            out = ctx.actions.declare_file(src.basename + \".bc\")\n+            bc_outputs.append(out)\n+\n+            extra_flags = ctx.attr.file_specific_flags.get(src.basename, \"\")\n+            include_flags = [\"-I{}\".format(dir) for dir in include_dirs]\n+            include_flags += [\"-I{}\".format(ctx.files._clang_header[0].dirname)]\n+            include_flags += [\"-I{}\".format(ctx.files._clang_includes[0].dirname)]\n+            args = [\n+                \"-x\",\n+                \"cl\",\n+                \"--target=amdgcn-amd-amdhsa\",\n+                \"-emit-llvm\",\n+                \"-fcolor-diagnostics\",\n+                \"-Werror\",\n+                \"-Wno-error=atomic-alignment\",\n+                \"-Xclang\",\n+                \"-cl-std=CL2.0\",\n+                \"-fvisibility=hidden\",\n+                \"-fomit-frame-pointer\",\n+                \"-Xclang\",\n+                \"-finclude-default-header\",\n+                \"-Xclang\",\n+                \"-fexperimental-strict-floating-point\",\n+                \"-Xclang\",\n+                \"-fdenormal-fp-math=dynamic\",\n+                \"-Xclang\",\n+                \"-Qn\",\n+                \"-nogpulib\",\n+                \"-cl-no-stdinc\",\n+                \"-Xclang\",\n+                \"-mcode-object-version=none\",\n+                \"-c\",\n+            ] + include_flags + [src.path, \"-o\", out.path] + extra_flags.split(\" \")\n+\n+            ctx.actions.run(\n+                executable = ctx.executable._clang,\n+                inputs = [src] + hdrs + ctx.files._clang_includes + ctx.files._clang_header,\n+                outputs = [out],\n+                arguments = args,\n+                progress_message = \"Compiling {} ‚Üí bitcode\".format(src.basename),\n+                mnemonic = \"RocmBitCodeCompile\",\n+            )\n+\n+        elif src.path.endswith(\".ll\"):\n+            # Directly include .ll files in linking\n+            bc_outputs.append(src)\n+\n+    # Link all .bc files into one prelinked .bc\n+    prelink_out = ctx.actions.declare_file(ctx.label.name + \".link0.lib.bc\")\n+    ctx.actions.run(\n+        executable = ctx.executable._llvm_link,\n+        inputs = bc_outputs,\n+        outputs = [prelink_out],\n+        arguments = [f.path for f in bc_outputs] + [\"-o\", prelink_out.path],\n+        progress_message = \"Linking {} bitcode files\".format(ctx.label.name),\n+        mnemonic = \"RocmBitCodeLink\",\n     )\n \n-    internalize_out = name + \".lib.bc\"\n-    native.genrule(\n-        name = \"internalize_\" + name,\n-        srcs = [prelink_out],\n-        outs = [internalize_out],\n-        cmd = \"$(location {}) -internalize -only-needed $< -o $@\".format(llvm_link_tool),\n-        tools = [llvm_link_tool],\n-        message = link_message,\n+    # Internalize symbols (llvm-link + -internalize)\n+    internalize_out = ctx.actions.declare_file(ctx.label.name + \".lib.bc\")\n+    ctx.actions.run(\n+        executable = ctx.executable._llvm_link,\n+        inputs = [prelink_out],\n+        outputs = [internalize_out],\n+        arguments = [\"-internalize\", \"-only-needed\", prelink_out.path, \"-o\", internalize_out.path],\n+        progress_message = \"Internalizing symbols for {}\".format(ctx.label.name),\n+        mnemonic = \"RocmBitCodeInternalizingSymbols\",\n     )\n \n-    strip_out = name + \".strip.bc\"\n-    native.genrule(\n-        name = \"strip_\" + name,\n-        srcs = [internalize_out],\n-        outs = [strip_out],\n-        cmd = \"$(location {}) -passes=strip -o $@ $<\".format(opt_tool),\n-        tools = [opt_tool],\n-        message = link_message,\n+    # Strip unnecessary metadata\n+    strip_out = ctx.actions.declare_file(ctx.label.name + \".strip.bc\")\n+    ctx.actions.run(\n+        executable = ctx.executable._opt,\n+        inputs = [internalize_out],\n+        outputs = [strip_out],\n+        arguments = [\"-passes=strip\", \"-o\", strip_out.path, internalize_out.path],\n+        progress_message = \"Stripping {}\".format(ctx.label.name),\n+        mnemonic = \"RocmBitCodeStripping\",\n     )\n \n-    native.genrule(\n-        name = name,\n-        srcs = [strip_out],\n-        outs = [name + \".bc\"],\n-        cmd = \"$(location {}) -o $@ $<\".format(prepare_builtins_tool),\n-        tools = [prepare_builtins_tool],\n-        message = link_message,\n+    # Final preparation of bitcode (custom prepare_builtins tool)\n+    final_bc = ctx.actions.declare_file(ctx.label.name + \".bc\")\n+    ctx.actions.run(\n+        executable = ctx.executable._prepare_builtins,\n+        inputs = [strip_out],\n+        outputs = [final_bc],\n+        arguments = [strip_out.path, \"-o\", final_bc.path],\n+        progress_message = \"Preparing final bitcode for {}\".format(ctx.label.name),\n+        mnemonic = \"RocmBitCodeFinalize\",\n     )\n+\n+    return [\n+        DefaultInfo(files = depset([final_bc])),\n+        BitcodeLibraryInfo(bc_file = final_bc),\n+    ]\n+\n+bitcode_library = rule(\n+    implementation = _bitcode_library_impl,\n+    attrs = {\n+        \"srcs\": attr.label_list(allow_files = [\".cl\", \".ll\"]),\n+        \"hdrs\": attr.label_list(allow_files = [\".h\"]),\n+        \"file_specific_flags\": attr.string_dict(),\n+        \"_clang\": attr.label(\n+            default = Label(\"@llvm-project//clang:clang\"),\n+            executable = True,\n+            cfg = \"exec\",\n+        ),\n+        \"_llvm_link\": attr.label(\n+            default = Label(\"@llvm-project//llvm:llvm-link\"),\n+            executable = True,\n+            cfg = \"exec\",\n+        ),\n+        \"_opt\": attr.label(\n+            default = Label(\"@llvm-project//llvm:opt\"),\n+            executable = True,\n+            cfg = \"exec\",\n+        ),\n+        \"_prepare_builtins\": attr.label(\n+            default = Label(\":prepare_builtins\"),\n+            executable = True,\n+            cfg = \"exec\",\n+        ),\n+        \"_clang_includes\": attr.label(\n+            default = Label(\"@llvm-project//clang:builtin_headers_gen\"),\n+            allow_files = True,\n+        ),\n+        \"_clang_header\": attr.label(\n+            default = Label(\"@llvm-project//clang:staging/include/opencl-c.h\"),\n+            allow_files = True,\n+        ),\n+    },\n+)"
        },
        {
            "sha": "966c3605ce49f965971e0cea4a58d6848f1f2f24",
            "filename": "third_party/xla/third_party/rocm_device_libs/rocm_device_libs.BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d416731843034c6917bcefed05962a07f851ee7/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d416731843034c6917bcefed05962a07f851ee7/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Frocm_device_libs.BUILD?ref=8d416731843034c6917bcefed05962a07f851ee7",
            "patch": "@@ -39,9 +39,9 @@ bitcode_library(\n         \"oclc/inc/*.h\",\n     ]),\n     file_specific_flags = {\n-        \"native_logF.cl\": [\"-fapprox-func\"],\n-        \"native_expF.cl\": [\"-fapprox-func\"],\n-        \"sqrtF.cl\": [\"-cl-fp32-correctly-rounded-divide-sqrt\"],\n+        \"native_logF.cl\": \"-fapprox-func\",\n+        \"native_expF.cl\": \"-fapprox-func\",\n+        \"sqrtF.cl\": \"-cl-fp32-correctly-rounded-divide-sqrt\",\n     },\n )\n \n@@ -57,6 +57,6 @@ bitcode_library(\n         \"oclc/inc/*.h\",\n     ]),\n     file_specific_flags = {\n-        \"gaaf.cl\": [\"-munsafe-fp-atomics\"],\n+        \"gaaf.cl\": \"-munsafe-fp-atomics\",\n     },\n )"
        }
    ],
    "stats": {
        "total": 237,
        "additions": 138,
        "deletions": 99
    }
}