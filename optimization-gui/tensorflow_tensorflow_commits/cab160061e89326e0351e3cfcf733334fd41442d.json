{
    "author": "draganmladjenovic",
    "message": "PR #32504: [ROCm] Remove rocm_diagnostics\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32504\n\nüìù Summary of Changes\nRemove rocm_diagnostics.cc\n\nüéØ Justification\n RocmDiagnostics module never worked and provides no meaningful information to the user.\n\nüöÄ Kind of Contribution\n‚ôªÔ∏è Cleanup\n\nüìä Benchmark (for Performance Improvements)\nN\\A\n\nüß™ Unit Tests:\nNone\n\nüß™ Execution Tests:\nNone\n\nCopybara import of the project:\n\n--\n73c4357ea80c720e2e46ddc0f91c8943e571b1ca by Dragan Mladjenovic <Dragan.Mladjenovic@amd.com>:\n\n[ROCm] Remove rocm_diagnostics\n\nMerging this change closes #32504\n\nPiperOrigin-RevId: 818581529",
    "sha": "cab160061e89326e0351e3cfcf733334fd41442d",
    "files": [
        {
            "sha": "2fe702a3bd03dd3e80367e43289a346c64a884a9",
            "filename": "third_party/xla/xla/stream_executor/rocm/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cab160061e89326e0351e3cfcf733334fd41442d/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cab160061e89326e0351e3cfcf733334fd41442d/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2FBUILD?ref=cab160061e89326e0351e3cfcf733334fd41442d",
            "patch": "@@ -39,24 +39,6 @@ cc_library(\n     ],\n )\n \n-cc_library(\n-    name = \"rocm_diagnostics\",\n-    srcs = [\"rocm_diagnostics.cc\"],\n-    hdrs = [\"rocm_diagnostics.h\"],\n-    tags = [\n-        \"gpu\",\n-        \"rocm-only\",\n-    ],\n-    deps = [\n-        \"//xla/tsl/platform:logging\",\n-        \"@com_google_absl//absl/status\",\n-        \"@com_google_absl//absl/status:statusor\",\n-        \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/strings:str_format\",\n-        \"@local_tsl//tsl/platform:platform_port\",\n-    ],\n-)\n-\n cc_library(\n     name = \"rocm_context\",\n     srcs = [\"rocm_context.cc\"],\n@@ -307,7 +289,6 @@ cc_library(\n     ],\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":rocm_diagnostics\",\n         \":rocm_driver_wrapper\",\n         \":rocm_executor\",\n         \":rocm_platform_id\",\n@@ -518,7 +499,6 @@ cc_library(\n     visibility = [\"//visibility:public\"],\n     deps = [\n         \":miopen_if_static\",  # build_cleaner: keep\n-        \":rocm_diagnostics\",\n         \":rocm_executor\",\n         \":rocm_helpers\",\n         \":rocm_platform_id\","
        },
        {
            "sha": "123e69bd075ee44afb4e58b494ad3a9d6d8ebe81",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_diagnostics.cc",
            "status": "removed",
            "additions": 0,
            "deletions": 231,
            "changes": 231,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aae796c51f3eb808a9c0f1d86a5f75f87f72d824/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_diagnostics.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aae796c51f3eb808a9c0f1d86a5f75f87f72d824/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_diagnostics.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_diagnostics.cc?ref=aae796c51f3eb808a9c0f1d86a5f75f87f72d824",
            "patch": "@@ -1,231 +0,0 @@\n-/* Copyright 2018 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#include \"xla/stream_executor/rocm/rocm_diagnostics.h\"\n-\n-#include <dirent.h>\n-#include <limits.h>\n-#include <link.h>\n-#include <stddef.h>\n-#include <stdio.h>\n-#include <stdlib.h>\n-#include <string.h>\n-#include <sys/sysmacros.h>\n-#include <unistd.h>\n-\n-#include <string>\n-#include <vector>\n-\n-#include \"absl/status/status.h\"\n-#include \"absl/strings/numbers.h\"\n-#include \"absl/strings/str_cat.h\"\n-#include \"absl/strings/str_format.h\"\n-#include \"absl/strings/str_split.h\"\n-#include \"absl/strings/strip.h\"\n-#include \"xla/tsl/platform/logging.h\"\n-#include \"tsl/platform/host_info.h\"\n-\n-namespace stream_executor {\n-namespace rocm {\n-\n-std::string DriverVersionToString(DriverVersion version) {\n-  return absl::StrFormat(\"%d.%d.%d\", std::get<0>(version), std::get<1>(version),\n-                         std::get<2>(version));\n-}\n-\n-std::string DriverVersionStatusToString(absl::StatusOr<DriverVersion> version) {\n-  if (!version.ok()) {\n-    return version.status().ToString();\n-  }\n-\n-  return DriverVersionToString(version.value());\n-}\n-\n-absl::StatusOr<DriverVersion> StringToDriverVersion(const std::string& value) {\n-  std::vector<std::string> pieces = absl::StrSplit(value, '.');\n-  if (pieces.size() != 2 && pieces.size() != 3) {\n-    return absl::Status{absl::StatusCode::kInvalidArgument,\n-                        absl::StrFormat(\"expected %%d.%%d or %%d.%%d.%%d form \"\n-                                        \"for driver version; got \\\"%s\\\"\",\n-                                        value.c_str())};\n-  }\n-\n-  int major;\n-  int minor;\n-  int patch = 0;\n-  if (!absl::SimpleAtoi(pieces[0], &major)) {\n-    return absl::Status{\n-        absl::StatusCode::kInvalidArgument,\n-        absl::StrFormat(\"could not parse major version number \\\"%s\\\" as an \"\n-                        \"integer from string \\\"%s\\\"\",\n-                        pieces[0].c_str(), value.c_str())};\n-  }\n-  if (!absl::SimpleAtoi(pieces[1], &minor)) {\n-    return absl::Status{\n-        absl::StatusCode::kInvalidArgument,\n-        absl::StrFormat(\"could not parse minor version number \\\"%s\\\" as an \"\n-                        \"integer from string \\\"%s\\\"\",\n-                        pieces[1].c_str(), value.c_str())};\n-  }\n-  if (pieces.size() == 3 && !absl::SimpleAtoi(pieces[2], &patch)) {\n-    return absl::Status{\n-        absl::StatusCode::kInvalidArgument,\n-        absl::StrFormat(\"could not parse patch version number \\\"%s\\\" as an \"\n-                        \"integer from string \\\"%s\\\"\",\n-                        pieces[2].c_str(), value.c_str())};\n-  }\n-\n-  DriverVersion result{major, minor, patch};\n-  VLOG(2) << \"version string \\\"\" << value << \"\\\" made value \"\n-          << DriverVersionToString(result);\n-  return result;\n-}\n-\n-// -- class Diagnostician\n-\n-std::string Diagnostician::GetDevNodePath(int dev_node_ordinal) {\n-  return absl::StrCat(\"/dev/kfd\", dev_node_ordinal);\n-}\n-\n-void Diagnostician::LogDiagnosticInformation() {\n-  LOG(INFO) << \"retrieving ROCM diagnostic information for host: \"\n-            << tsl::port::Hostname();\n-\n-  LogDriverVersionInformation();\n-}\n-\n-/* static */ void Diagnostician::LogDriverVersionInformation() {\n-  LOG(INFO) << \"hostname: \" << tsl::port::Hostname();\n-  if (VLOG_IS_ON(1)) {\n-    const char* value = getenv(\"LD_LIBRARY_PATH\");\n-    std::string library_path = value == nullptr ? \"\" : value;\n-    VLOG(1) << \"LD_LIBRARY_PATH is: \\\"\" << library_path << \"\\\"\";\n-\n-    std::vector<std::string> pieces = absl::StrSplit(library_path, ':');\n-    for (const auto& piece : pieces) {\n-      if (piece.empty()) {\n-        continue;\n-      }\n-      DIR* dir = opendir(piece.c_str());\n-      if (dir == nullptr) {\n-        VLOG(1) << \"could not open \\\"\" << piece << \"\\\"\";\n-        continue;\n-      }\n-      while (dirent* entity = readdir(dir)) {\n-        VLOG(1) << piece << \" :: \" << entity->d_name;\n-      }\n-      closedir(dir);\n-    }\n-  }\n-  absl::StatusOr<DriverVersion> dso_version = FindDsoVersion();\n-  LOG(INFO) << \"librocm reported version is: \"\n-            << rocm::DriverVersionStatusToString(dso_version);\n-\n-  absl::StatusOr<DriverVersion> kernel_version = FindKernelDriverVersion();\n-  LOG(INFO) << \"kernel reported version is: \"\n-            << rocm::DriverVersionStatusToString(kernel_version);\n-\n-  if (kernel_version.ok() && dso_version.ok()) {\n-    WarnOnDsoKernelMismatch(dso_version, kernel_version);\n-  }\n-}\n-\n-// Iterates through loaded DSOs with DlIteratePhdrCallback to find the\n-// driver-interfacing DSO version number. Returns it as a string.\n-absl::StatusOr<DriverVersion> Diagnostician::FindDsoVersion() {\n-  absl::StatusOr<DriverVersion> result{absl::Status{\n-      absl::StatusCode::kNotFound,\n-      \"was unable to find librocm.so DSO loaded into this program\"}};\n-\n-  // Callback used when iterating through DSOs. Looks for the driver-interfacing\n-  // DSO and yields its version number into the callback data, when found.\n-  auto iterate_phdr = [](struct dl_phdr_info* info, size_t size,\n-                         void* data) -> int {\n-    if (strstr(info->dlpi_name, \"librocm.so.1\")) {\n-      VLOG(1) << \"found DLL info with name: \" << info->dlpi_name;\n-      char resolved_path[PATH_MAX] = {0};\n-      if (realpath(info->dlpi_name, resolved_path) == nullptr) {\n-        return 0;\n-      }\n-      VLOG(1) << \"found DLL info with resolved path: \" << resolved_path;\n-      const char* slash = rindex(resolved_path, '/');\n-      if (slash == nullptr) {\n-        return 0;\n-      }\n-      const char* so_suffix = \".so.\";\n-      const char* dot = strstr(slash, so_suffix);\n-      if (dot == nullptr) {\n-        return 0;\n-      }\n-      std::string dso_version = dot + strlen(so_suffix);\n-      // TODO(b/22689637): Eliminate the explicit namespace if possible.\n-      auto stripped_dso_version = absl::StripSuffix(dso_version, \".ld64\");\n-      auto result = static_cast<absl::StatusOr<DriverVersion>*>(data);\n-      *result = rocm::StringToDriverVersion(std::string(stripped_dso_version));\n-      return 1;\n-    }\n-    return 0;\n-  };\n-\n-  dl_iterate_phdr(iterate_phdr, &result);\n-\n-  return result;\n-}\n-\n-absl::StatusOr<DriverVersion> Diagnostician::FindKernelModuleVersion(\n-    const std::string& driver_version_file_contents) {\n-  static const char* kDriverFilePrelude = \"Kernel Module  \";\n-  size_t offset = driver_version_file_contents.find(kDriverFilePrelude);\n-  if (offset == std::string::npos) {\n-    return absl::Status{\n-        absl::StatusCode::kNotFound,\n-        absl::StrCat(\"could not find kernel module information in \"\n-                     \"driver version file contents: \\\"\",\n-                     driver_version_file_contents, \"\\\"\")};\n-  }\n-\n-  std::string version_and_rest = driver_version_file_contents.substr(\n-      offset + strlen(kDriverFilePrelude), std::string::npos);\n-  size_t space_index = version_and_rest.find(' ');\n-  auto kernel_version = version_and_rest.substr(0, space_index);\n-  // TODO(b/22689637): Eliminate the explicit namespace if possible.\n-  auto stripped_kernel_version = absl::StripSuffix(kernel_version, \".ld64\");\n-  return rocm::StringToDriverVersion(std::string(stripped_kernel_version));\n-}\n-\n-void Diagnostician::WarnOnDsoKernelMismatch(\n-    absl::StatusOr<DriverVersion> dso_version,\n-    absl::StatusOr<DriverVersion> kernel_version) {\n-  if (kernel_version.ok() && dso_version.ok() &&\n-      dso_version.value() == kernel_version.value()) {\n-    LOG(INFO) << \"kernel version seems to match DSO: \"\n-              << rocm::DriverVersionToString(kernel_version.value());\n-  } else {\n-    LOG(ERROR) << \"kernel version \"\n-               << rocm::DriverVersionStatusToString(kernel_version)\n-               << \" does not match DSO version \"\n-               << rocm::DriverVersionStatusToString(dso_version)\n-               << \" -- cannot find working devices in this configuration\";\n-  }\n-}\n-\n-absl::StatusOr<DriverVersion> Diagnostician::FindKernelDriverVersion() {\n-  auto status = absl::Status{absl::StatusCode::kUnimplemented,\n-                             \"kernel reported driver version not implemented\"};\n-  return status;\n-}\n-\n-}  // namespace rocm\n-}  // namespace stream_executor"
        },
        {
            "sha": "edd9247db05cedc92bc0cfa703ac3a6c9667d48a",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_diagnostics.h",
            "status": "removed",
            "additions": 0,
            "deletions": 92,
            "changes": 92,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aae796c51f3eb808a9c0f1d86a5f75f87f72d824/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_diagnostics.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aae796c51f3eb808a9c0f1d86a5f75f87f72d824/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_diagnostics.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_diagnostics.h?ref=aae796c51f3eb808a9c0f1d86a5f75f87f72d824",
            "patch": "@@ -1,92 +0,0 @@\n-/* Copyright 2015 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#ifndef XLA_STREAM_EXECUTOR_ROCM_ROCM_DIAGNOSTICS_H_\n-#define XLA_STREAM_EXECUTOR_ROCM_ROCM_DIAGNOSTICS_H_\n-\n-#include <string>\n-#include <tuple>\n-\n-#include \"absl/status/statusor.h\"\n-\n-namespace stream_executor {\n-namespace rocm {\n-\n-// e.g. DriverVersion{346, 3, 4}\n-using DriverVersion = std::tuple<int, int, int>;\n-\n-// Converts a parsed driver version to string form.\n-std::string DriverVersionToString(DriverVersion version);\n-\n-// Converts a parsed driver version or status value to natural string form.\n-std::string DriverVersionStatusToString(absl::StatusOr<DriverVersion> version);\n-\n-// Converts a string of a form like \"331.79\" to a DriverVersion{331, 79}.\n-absl::StatusOr<DriverVersion> StringToDriverVersion(const std::string& value);\n-\n-class Diagnostician {\n- public:\n-  // Logs diagnostic information when CUDA appears to be misconfigured (e.g. is\n-  // not initializing).\n-  //\n-  // Note: if we're running on a machine that has no GPUs, we don't want to\n-  // produce very much log spew beyond saying, \"looks like there's no CUDA\n-  // kernel\n-  // module running\".\n-  //\n-  // Note: we use non-Google-File:: API here because we may be called before\n-  // InitGoogle has completed.\n-  static void LogDiagnosticInformation();\n-\n-  // Given the driver version file contents, finds the kernel module version and\n-  // returns it as a string.\n-  //\n-  // This is solely used for more informative log messages when the user is\n-  // running on a machine that happens to have a libcuda/kernel driver mismatch.\n-  static absl::StatusOr<DriverVersion> FindKernelModuleVersion(\n-      const std::string& driver_version_file_contents);\n-\n-  // Extracts the kernel driver version from the current host.\n-  static absl::StatusOr<DriverVersion> FindKernelDriverVersion();\n-\n-  // Iterates through loaded DSOs with DlIteratePhdrCallback to find the\n-  // driver-interfacing DSO version number. Returns it as a string.\n-  static absl::StatusOr<DriverVersion> FindDsoVersion();\n-\n-  // Logs information about the kernel driver version and userspace driver\n-  // library version.\n-  static void LogDriverVersionInformation();\n-\n- private:\n-  // Given the DSO version number and the driver version file contents, extracts\n-  // the driver version and compares, warning the user in the case of\n-  // incompatibility.\n-  //\n-  // This is solely used for more informative log messages when the user is\n-  // running on a machine that happens to have a libcuda/kernel driver mismatch.\n-  static void WarnOnDsoKernelMismatch(\n-      absl::StatusOr<DriverVersion> dso_version,\n-      absl::StatusOr<DriverVersion> kernel_version);\n-\n-  static std::string GetDevNodePath(int dev_node_ordinal);\n-\n-  Diagnostician(const Diagnostician&) = delete;\n-  void operator=(const Diagnostician&) = delete;\n-};\n-\n-}  // namespace rocm\n-}  // namespace stream_executor\n-\n-#endif  // XLA_STREAM_EXECUTOR_ROCM_ROCM_DIAGNOSTICS_H_"
        },
        {
            "sha": "8d91a13c65bf0c8ba821d68303cf66e7669370a5",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_dnn.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cab160061e89326e0351e3cfcf733334fd41442d/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_dnn.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cab160061e89326e0351e3cfcf733334fd41442d/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_dnn.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_dnn.cc?ref=cab160061e89326e0351e3cfcf733334fd41442d",
            "patch": "@@ -56,7 +56,6 @@ limitations under the License.\n #include \"xla/stream_executor/numeric_options.h\"\n #include \"xla/stream_executor/platform/initialize.h\"\n #include \"xla/stream_executor/plugin_registry.h\"\n-#include \"xla/stream_executor/rocm/rocm_diagnostics.h\"\n #include \"xla/stream_executor/rocm/rocm_platform_id.h\"\n #include \"xla/stream_executor/scratch_allocator.h\"\n #include \"xla/stream_executor/stream.h\"\n@@ -819,18 +818,6 @@ absl::Status MIOpenSupport::Init() {\n \n   CHECK_EQ(miopen_handle, nullptr);\n   LOG(ERROR) << \"could not create miopen handle: \" << ToString(status);\n-  if (status == miopenStatusNotInitialized) {\n-    auto result = rocm::Diagnostician::FindKernelDriverVersion();\n-    if (!result.ok()) {\n-      LOG(ERROR) << \"error retrieving driver version: \"\n-                 << rocm::DriverVersionStatusToString(result);\n-    } else {\n-      const auto& version = result.value();\n-      LOG(INFO) << \"possibly insufficient driver version: \"\n-                << rocm::DriverVersionToString(version);\n-    }\n-  }\n-\n   return absl::Status{absl::StatusCode::kInternal,\n                       absl::StrCat(\"miopen library could not create a handle: \",\n                                    ToString(status))};"
        },
        {
            "sha": "cf2def95771ed6ca7d876ff60ef7f1d83f3b1193",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_platform.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cab160061e89326e0351e3cfcf733334fd41442d/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_platform.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cab160061e89326e0351e3cfcf733334fd41442d/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_platform.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_platform.cc?ref=cab160061e89326e0351e3cfcf733334fd41442d",
            "patch": "@@ -27,7 +27,6 @@ limitations under the License.\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/platform/initialize.h\"\n #include \"xla/stream_executor/platform_manager.h\"\n-#include \"xla/stream_executor/rocm/rocm_diagnostics.h\"\n #include \"xla/stream_executor/rocm/rocm_driver_wrapper.h\"\n #include \"xla/stream_executor/rocm/rocm_executor.h\"\n #include \"xla/stream_executor/rocm/rocm_platform_id.h\"\n@@ -49,7 +48,6 @@ static absl::Status InternalInitialize() {\n   }\n \n   LOG(ERROR) << \"failed call to hipInit: \" << ToString(res);\n-  rocm::Diagnostician::LogDiagnosticInformation();\n   return absl::AbortedError(\n       absl::StrCat(\"failed call to hipInit: \", ToString(res)));\n }"
        }
    ],
    "stats": {
        "total": 358,
        "additions": 0,
        "deletions": 358
    }
}