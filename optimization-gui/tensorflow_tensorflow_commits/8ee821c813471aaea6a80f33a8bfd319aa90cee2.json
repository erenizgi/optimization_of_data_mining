{
    "author": "WillFroom",
    "message": "[XLA:CPU] Use loop emitter rather than copy thunk for sub-byte types.\n\nConfirmed that the test fails before this change.\n\nPiperOrigin-RevId: 841683617",
    "sha": "8ee821c813471aaea6a80f33a8bfd319aa90cee2",
    "files": [
        {
            "sha": "dd27f5eb8a38e900a8d3b2eb7bd86bd0d39b2f6f",
            "filename": "third_party/xla/xla/service/cpu/tests/BUILD",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ee821c813471aaea6a80f33a8bfd319aa90cee2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ee821c813471aaea6a80f33a8bfd319aa90cee2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD?ref=8ee821c813471aaea6a80f33a8bfd319aa90cee2",
            "patch": "@@ -442,3 +442,19 @@ xla_cc_test(\n         \"@local_tsl//tsl/platform:platform_port\",\n     ],\n )\n+\n+xla_cc_test(\n+    name = \"cpu_copy_test\",\n+    srcs = [\"cpu_copy_test.cc\"],\n+    deps = [\n+        \":cpu_codegen_test_main\",\n+        \"//xla:literal\",\n+        \"//xla:literal_util\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/tests:literal_test_util\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)"
        },
        {
            "sha": "20de31fc7be8fdebdaf49ea746855437ae175166",
            "filename": "third_party/xla/xla/service/cpu/tests/cpu_copy_test.cc",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ee821c813471aaea6a80f33a8bfd319aa90cee2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_copy_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ee821c813471aaea6a80f33a8bfd319aa90cee2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_copy_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_copy_test.cc?ref=8ee821c813471aaea6a80f33a8bfd319aa90cee2",
            "patch": "@@ -0,0 +1,54 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+#include <cstdint>\n+#include <memory>\n+#include <string>\n+#include <utility>\n+\n+#include \"absl/types/span.h\"\n+#include \"xla/literal.h\"\n+#include \"xla/service/cpu/tests/cpu_codegen_test.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+\n+namespace xla::cpu {\n+namespace {\n+\n+TEST_F(CpuCodegenTest, SubByteCopy) {\n+  const std::string hlo_text = R\"hlo(\n+HloModule module\n+\n+ENTRY entry {\n+  in = u2[20,20]{1,0:E(2)} iota(), iota_dimension=1\n+  transpose = u2[20,20]{0,1:E(2)} transpose(in), dimensions={1,0}\n+  copy = u2[20,20]{1,0:E(2)} copy(transpose)\n+  ROOT out = u8[20,20]{1,0} convert(copy)\n+}\n+)hlo\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module, ParseAndReturnVerifiedModule(hlo_text));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      const Literal result,\n+      Execute(std::move(module), {}, /*run_hlo_passes=*/false));\n+\n+  absl::Span<const uint8_t> result_data = result.data<uint8_t>();\n+  for (int64_t row = 0; row < 20; ++row) {\n+    for (int64_t col = 0; col < 20; ++col) {\n+      EXPECT_EQ(result_data[row * 20 + col], row % 4);\n+    }\n+  }\n+}\n+\n+}  // namespace\n+}  // namespace xla::cpu"
        },
        {
            "sha": "0506620c3bb7a6a5236512d556c3045d1deeb920",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8ee821c813471aaea6a80f33a8bfd319aa90cee2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8ee821c813471aaea6a80f33a8bfd319aa90cee2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc?ref=8ee821c813471aaea6a80f33a8bfd319aa90cee2",
            "patch": "@@ -486,7 +486,10 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitHloInstruction(\n       return EmitConvolutionThunk(instruction);\n \n     case HloOpcode::kCopy: {\n-      if (options_.compile_copy_as_llvm_kernel) {\n+      // The copy thunk does not support sub-byte data types.\n+      bool has_byte_strides =\n+          ShapeUtil::ByteStrides(instruction->shape()).has_value();\n+      if (!has_byte_strides || options_.compile_copy_as_llvm_kernel) {\n         return EmitElementalKernelThunk(instruction);\n       }\n       return EmitCopyThunk(instruction);"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 74,
        "deletions": 1
    }
}