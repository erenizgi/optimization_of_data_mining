{
    "author": "KanishAnand",
    "message": "Canonicalize `dim_shardings` in case of all empty vectors\n\nPiperOrigin-RevId: 842706792",
    "sha": "dbcd8d5545cb813a255af5bc5b481781e7d7ef73",
    "files": [
        {
            "sha": "53134af857dc5d5db1752b92df6ceb30114db7b2",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding.h",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dbcd8d5545cb813a255af5bc5b481781e7d7ef73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dbcd8d5545cb813a255af5bc5b481781e7d7ef73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h?ref=dbcd8d5545cb813a255af5bc5b481781e7d7ef73",
            "patch": "@@ -71,7 +71,7 @@ class NamedSharding {\n                          absl::Span<const AxisRef> unreduced_axes = {},\n                          absl::Span<const OpMetadata> metadata = {})\n       : mesh_(std::move(mesh)),\n-        dim_shardings_(dim_shardings.begin(), dim_shardings.end()),\n+        dim_shardings_(CanonicalizedDimShardings(dim_shardings)),\n         replicated_axes_(replicated_axes.begin(), replicated_axes.end()),\n         unreduced_axes_(unreduced_axes.begin(), unreduced_axes.end()),\n         metadata_(metadata.begin(), metadata.end()) {}\n@@ -87,6 +87,19 @@ class NamedSharding {\n  private:\n   friend class HloSharding;\n \n+  std::vector<DimensionSharding> CanonicalizedDimShardings(\n+      absl::Span<const DimensionSharding> dim_shardings) const {\n+    bool all_dims_empty = absl::c_all_of(\n+        dim_shardings,\n+        [](const DimensionSharding& ds) { return ds.axes().empty(); });\n+\n+    if (all_dims_empty) {\n+      return {};\n+    }\n+    return std::vector<DimensionSharding>(dim_shardings.begin(),\n+                                          dim_shardings.end());\n+  }\n+\n   // Creates a sharding with empty mesh and no sharding axes depicting it is\n   // replicated across all devices.\n   static NamedSharding Replicate(absl::Span<const OpMetadata> metadata = {}) {"
        },
        {
            "sha": "611ade960943f3805f1e2846b3d17ed402149f71",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding_test.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dbcd8d5545cb813a255af5bc5b481781e7d7ef73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dbcd8d5545cb813a255af5bc5b481781e7d7ef73/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc?ref=dbcd8d5545cb813a255af5bc5b481781e7d7ef73",
            "patch": "@@ -24,6 +24,18 @@ namespace {\n \n using DimensionSharding = NamedSharding::DimensionSharding;\n \n+TEST(NamedShardingTest, CanonicalizedDimShardings) {\n+  Mesh mesh_abcd({2, 4}, {\"a\", \"b\"});\n+\n+  DimensionSharding empty_ds;\n+  NamedSharding sharding1(mesh_abcd, {empty_ds, empty_ds});\n+  EXPECT_TRUE(sharding1.dim_shardings().empty());\n+\n+  DimensionSharding ds_a({AxisRef(0)}, /*is_closed=*/true);\n+  NamedSharding sharding2(mesh_abcd, {ds_a, empty_ds});\n+  EXPECT_FALSE(sharding2.dim_shardings().empty());\n+}\n+\n TEST(NamedShardingTest, AxisNameCtor) {\n   Mesh mesh_abcd({2, 4, 3, 8}, {\"a\", \"b\", \"c\", \"d\"});\n   AxisRef axis_a(0);"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 26,
        "deletions": 1
    }
}