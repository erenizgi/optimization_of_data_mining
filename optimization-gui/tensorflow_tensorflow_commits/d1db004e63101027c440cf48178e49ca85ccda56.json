{
    "author": "majiddadashi",
    "message": "Add legalization for mhlo.case to tfl.if.\n\nConverts mhlo.case ops with two branches to tfl.if. The tfl.if predicate is true if the index is not 0, with the then_region corresponding to branch 1 and the else_region to branch 0.\n\nPiperOrigin-RevId: 828672857",
    "sha": "d1db004e63101027c440cf48178e49ca85ccda56",
    "files": [
        {
            "sha": "cd553040786c72b85e739f45653c7c5e69e4c7d2",
            "filename": "tensorflow/compiler/mlir/lite/stablehlo/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2FBUILD?ref=d1db004e63101027c440cf48178e49ca85ccda56",
            "patch": "@@ -539,6 +539,7 @@ cc_library(\n         \":passes_inc_gen\",\n         \":unfold_splat_constant_pass\",\n         \"//tensorflow/compiler/mlir/lite:tensorflow_lite\",\n+        \"//tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions:case\",\n         \"//tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions:conv\",\n         \"//tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions:custom_call\",\n         \"//tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions:dot_general\","
        },
        {
            "sha": "1d8a63130ac1d9caf0c9a020b7768087ad9f0761",
            "filename": "tensorflow/compiler/mlir/lite/stablehlo/tests/tfl_legalize_hlo.mlir",
            "status": "modified",
            "additions": 31,
            "deletions": 2,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftests%2Ftfl_legalize_hlo.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftests%2Ftfl_legalize_hlo.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftests%2Ftfl_legalize_hlo.mlir?ref=d1db004e63101027c440cf48178e49ca85ccda56",
            "patch": "@@ -3721,14 +3721,43 @@ func.func @dynamic_broadcast_in_dim_general_case_expand_back_dims(%arg0: tensor<\n // CHECK: %2 = \"tfl.broadcast_to\"(%1, %arg1) : (tensor<?x3000x1x1xf32>, tensor<4xi32>) -> tensor<?x3000x2x4xf32>\n \n \n+// -----\n+\n+//===----------------------------------------------------------------------===//\n+// mhlo.case\n+//===----------------------------------------------------------------------===//\n+\n+// CHECK-LABEL: case_func\n+func.func @case_func(%arg0: tensor<i32>, %arg1: tensor<i32>, %arg2: tensor<i32>) -> (tensor<i32>) {\n+  %0 = \"mhlo.case\"(%arg0) ({\n+    %2 = mhlo.add %arg1, %arg2 : tensor<i32>\n+    \"mhlo.return\"(%2) : (tensor<i32>) -> ()\n+  }, {\n+    %2 = mhlo.multiply %arg1, %arg1 : tensor<i32>\n+    \"mhlo.return\"(%2) : (tensor<i32>) -> ()\n+  }) : (tensor<i32>) -> tensor<i32>\n+  func.return %0: tensor<i32>\n+}\n+\n+// CHECK: %[[CST:.*]] = arith.constant dense<0> : tensor<i32>\n+// CHECK: %[[PRED:.*]] = tfl.not_equal(%arg0, %[[CST]]) : (tensor<i32>, tensor<i32>) -> tensor<i1>\n+// CHECK: %[[IF:.*]] = \"tfl.if\"(%[[PRED]]) ({\n+// CHECK:   %[[MUL:.*]] = tfl.mul %arg1, %arg1 {fused_activation_function = \"NONE\"} : tensor<i32>\n+// CHECK:   \"tfl.yield\"(%[[MUL]]) : (tensor<i32>) -> ()\n+// CHECK: }, {\n+// CHECK:   %[[ADD:.*]] = tfl.add %arg1, %arg2 {fused_activation_function = \"NONE\"} : tensor<i32>\n+// CHECK:   \"tfl.yield\"(%[[ADD]]) : (tensor<i32>) -> ()\n+// CHECK: }) : (tensor<i1>) -> tensor<i32>\n+// CHECK: return %[[IF]] : tensor<i32>\n+\n // -----\n \n //===----------------------------------------------------------------------===//\n // mhlo.if\n //===----------------------------------------------------------------------===//\n \n-// CHECK-LABEL: if\n-func.func @if(%arg0: tensor<i1>, %arg1: tensor<i32>, %arg2: tensor<i32>) -> (tensor<i32>) {\n+// CHECK-LABEL: if_label\n+func.func @if_label(%arg0: tensor<i1>, %arg1: tensor<i32>, %arg2: tensor<i32>) -> (tensor<i32>) {\n   %0 = mhlo.add %arg1, %arg2 : tensor<i32>\n   %1 = \"mhlo.if\"(%arg0) ({\n     \"mhlo.return\"(%0) : (tensor<i32>) -> ()"
        },
        {
            "sha": "16c194df28f591e8c97f8de160e2c8c705700a3a",
            "filename": "tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/BUILD",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2FBUILD?ref=d1db004e63101027c440cf48178e49ca85ccda56",
            "patch": "@@ -320,6 +320,21 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"case\",\n+    srcs = [\"case.cc\"],\n+    hdrs = [\"case.h\"],\n+    deps = [\n+        \":util\",\n+        \"//tensorflow/compiler/mlir/lite:tensorflow_lite\",\n+        \"@llvm-project//mlir:ArithDialect\",\n+        \"@llvm-project//mlir:IR\",\n+        \"@llvm-project//mlir:Support\",\n+        \"@llvm-project//mlir:TransformUtils\",\n+        \"@local_xla//xla/mlir_hlo\",\n+    ],\n+)\n+\n cc_library(\n     name = \"if\",\n     srcs = [\"if.cc\"],"
        },
        {
            "sha": "b50a5e7fd83195ce2aa901c3b014479de1b20b98",
            "filename": "tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/case.cc",
            "status": "added",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2Fcase.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2Fcase.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2Fcase.cc?ref=d1db004e63101027c440cf48178e49ca85ccda56",
            "patch": "@@ -0,0 +1,100 @@\n+/* Copyright 2025 The TensorFlow Authors. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/case.h\"\n+\n+#include \"mlir/Dialect/Arith/IR/Arith.h\"  // from @llvm-project\n+#include \"mlir/IR/BuiltinTypeInterfaces.h\"  // from @llvm-project\n+#include \"mlir/IR/PatternMatch.h\"  // from @llvm-project\n+#include \"mlir/Support/LLVM.h\"  // from @llvm-project\n+#include \"mlir/Transforms/DialectConversion.h\"  // from @llvm-project\n+#include \"tensorflow/compiler/mlir/lite/ir/tfl_ops.h\"\n+#include \"tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/util.h\"\n+#include \"xla/mlir_hlo/mhlo/IR/hlo_ops.h\"\n+\n+namespace mlir::odml {\n+namespace {\n+\n+// Legalizes mhlo.case op to tfl.if op.\n+// This pattern only supports mhlo.case ops with exactly two branches.\n+class LegalizeCaseOp : public OpConversionPattern<mhlo::CaseOp> {\n+ public:\n+  using OpConversionPattern<mhlo::CaseOp>::OpConversionPattern;\n+\n+  LogicalResult matchAndRewrite(\n+      mhlo::CaseOp case_op, OpAdaptor adaptor,\n+      ConversionPatternRewriter& rewriter) const final {\n+    // mhlo.case can have N branches, but tfl.if only supports two.\n+    if (case_op.getBranches().size() != 2) {\n+      return rewriter.notifyMatchFailure(\n+          case_op, \"can only convert mhlo.case with 2 branches\");\n+    }\n+\n+    // `mhlo.case` takes an index, `tfl.if` takes a boolean predicate.\n+    // For a 2-branch `mhlo.case` (branch 0 and branch 1), we need to map\n+    // the index to a boolean.\n+    // According to the mhlo.case spec, an out-of-bounds index defaults to the\n+    // index of the last branch, which is 1 in this case.\n+    // So, index 0 maps to branch 0, and any other index (1, or out of bounds)\n+    // maps to branch 1.\n+    // This can be expressed as a predicate `index != 0` for branch 1.\n+\n+    auto loc = case_op->getLoc();\n+    auto index = case_op.getIndex();\n+    auto index_type = mlir::cast<ShapedType>(index.getType());\n+\n+    // Create a constant tensor of the same shape as the index, filled with\n+    // zeros.\n+    auto const_zero = arith::ConstantOp::create(\n+        rewriter, loc, rewriter.getZeroAttr(index_type));\n+\n+    // Create the predicate `index != 0`.\n+    auto pred_type = index_type.clone(rewriter.getI1Type());\n+    auto pred = mhlo::CompareOp::create(\n+        rewriter, loc, pred_type, index, const_zero,\n+        mhlo::ComparisonDirectionAttr::get(rewriter.getContext(),\n+                                           mhlo::ComparisonDirection::NE),\n+        mhlo::ComparisonTypeAttr{});  // Default comparison type is fine for\n+                                      // integers.\n+\n+    // Create the tfl.if op.\n+    auto tfl_if =\n+        TFL::IfOp::create(rewriter, loc, case_op.getResultTypes(), pred);\n+\n+    // Branch 1 of mhlo.case becomes the `then_region` of tfl.if.\n+    tfl_if.getThenRegion().takeBody(case_op.getBranches()[1]);\n+    ReplaceTerminatorWithYield(tfl_if.getThenRegion(), rewriter);\n+\n+    // Branch 0 of mhlo.case becomes the `else_region` of tfl.if.\n+    tfl_if.getElseRegion().takeBody(case_op.getBranches()[0]);\n+    ReplaceTerminatorWithYield(tfl_if.getElseRegion(), rewriter);\n+\n+    rewriter.replaceOp(case_op, tfl_if.getResults());\n+    return success();\n+  }\n+};\n+\n+}  // namespace\n+\n+void PopulateCasePatterns(MLIRContext* context, RewritePatternSet& patterns,\n+                          ConversionTarget& target) {\n+  patterns.add<LegalizeCaseOp>(context);\n+  // Mark mhlo.case as dynamically legal: it's legal if it does NOT have\n+  // exactly 2 branches, as those are the ones we want to convert.\n+  target.addDynamicallyLegalOp<mhlo::CaseOp>(\n+      [](mhlo::CaseOp op) { return op.getBranches().size() != 2; });\n+}\n+\n+}  // namespace mlir::odml"
        },
        {
            "sha": "11c470a1492630cb108b644e63238dba6e7c5f54",
            "filename": "tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/case.h",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2Fcase.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2Fcase.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Flegalize_hlo_conversions%2Fcase.h?ref=d1db004e63101027c440cf48178e49ca85ccda56",
            "patch": "@@ -0,0 +1,31 @@\n+/* Copyright 2025 The TensorFlow Authors. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef TENSORFLOW_COMPILER_MLIR_LITE_STABLEHLO_TRANSFORMS_LEGALIZE_HLO_CONVERSIONS_CASE_H_\n+#define TENSORFLOW_COMPILER_MLIR_LITE_STABLEHLO_TRANSFORMS_LEGALIZE_HLO_CONVERSIONS_CASE_H_\n+\n+#include \"mlir/IR/PatternMatch.h\"  // from @llvm-project\n+#include \"mlir/Transforms/DialectConversion.h\"  // from @llvm-project\n+\n+namespace mlir {\n+namespace odml {\n+\n+void PopulateCasePatterns(MLIRContext* context, RewritePatternSet& patterns,\n+                          ConversionTarget& target);\n+\n+}  // namespace odml\n+}  // namespace mlir\n+\n+#endif  // TENSORFLOW_COMPILER_MLIR_LITE_STABLEHLO_TRANSFORMS_LEGALIZE_HLO_CONVERSIONS_CASE_H_"
        },
        {
            "sha": "0c43a5c4047a64da273c368249620bc61d684741",
            "filename": "tensorflow/compiler/mlir/lite/stablehlo/transforms/tflite_legalize_hlo.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Ftflite_legalize_hlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1db004e63101027c440cf48178e49ca85ccda56/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Ftflite_legalize_hlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fstablehlo%2Ftransforms%2Ftflite_legalize_hlo.cc?ref=d1db004e63101027c440cf48178e49ca85ccda56",
            "patch": "@@ -38,6 +38,7 @@ limitations under the License.\n #include \"mlir/Transforms/DialectConversion.h\"  // from @llvm-project\n #include \"mlir/Transforms/GreedyPatternRewriteDriver.h\"  // from @llvm-project\n #include \"tensorflow/compiler/mlir/lite/ir/tfl_ops.h\"  // IWYU pragma: keep\n+#include \"tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/case.h\"\n #include \"tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/conv.h\"  // IWYU pragma: keep\n #include \"tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/custom_call.h\"\n #include \"tensorflow/compiler/mlir/lite/stablehlo/transforms/legalize_hlo_conversions/dot_general.h\"  // IWYU pragma: keep\n@@ -479,6 +480,7 @@ void LegalizeHloToTfLitePass::runOnOperation() {\n   PopulateWhilePatterns(context, patterns, target);\n   PopulateGetDimensionSizePatterns(context, patterns, target);\n   PopulateIfPatterns(context, patterns, target);\n+  PopulateCasePatterns(context, patterns, target);\n   PopulateLegalizeFftPatterns(context, patterns, target);\n   PopulateCustomCallPatterns(context, patterns, target);\n \n@@ -493,7 +495,6 @@ void LegalizeHloToTfLitePass::runOnOperation() {\n \n }  // namespace\n \n-\n // Creates an instance of the pass.\n std::unique_ptr<OperationPass<ModuleOp>> CreateLegalizeHloToTfLitePass() {\n   return std::make_unique<LegalizeHloToTfLitePass>();"
        }
    ],
    "stats": {
        "total": 183,
        "additions": 180,
        "deletions": 3
    }
}