{
    "author": "blakehechtman",
    "message": "[XLA] AllGather cancellation with Dynamic slice was too permissive if the\ndynamic slice size did not match the input size of the all-gather.\n\nPiperOrigin-RevId: 844826833",
    "sha": "29f16c487d4f1a4d6732dd7e91519cf3ac7a6867",
    "files": [
        {
            "sha": "52716071f9a4ec3e7f9fa4b78b4436a82d5f8f33",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/29f16c487d4f1a4d6732dd7e91519cf3ac7a6867/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/29f16c487d4f1a4d6732dd7e91519cf3ac7a6867/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=29f16c487d4f1a4d6732dd7e91519cf3ac7a6867",
            "patch": "@@ -2489,6 +2489,7 @@ cc_library(\n         \":collective_opt_utils\",\n         \":hlo_module_config\",\n         \"//xla:shape_util\",\n+        \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\","
        },
        {
            "sha": "479784ee969a9d05419552bd0cc0c3f4bf2dd5f9",
            "filename": "third_party/xla/xla/service/all_gather_simplifier.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/29f16c487d4f1a4d6732dd7e91519cf3ac7a6867/third_party%2Fxla%2Fxla%2Fservice%2Fall_gather_simplifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/29f16c487d4f1a4d6732dd7e91519cf3ac7a6867/third_party%2Fxla%2Fxla%2Fservice%2Fall_gather_simplifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fall_gather_simplifier.cc?ref=29f16c487d4f1a4d6732dd7e91519cf3ac7a6867",
            "patch": "@@ -31,6 +31,7 @@ limitations under the License.\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/shape_util.h\"\n #include \"xla/tsl/platform/errors.h\"\n+#include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -61,11 +62,18 @@ absl::StatusOr<bool> AllGatherSimplifier::RunImpl(\n                 HloPredicateIsOp<HloOpcode::kReplicaId>);\n         if (spec.has_value() &&\n             spec->split_dim == all_gather->all_gather_dimension()) {\n-          changed = true;\n           CHECK_EQ(all_gather->users().size(), 1);\n           HloInstruction* ds = all_gather->users().front();\n-          TF_RETURN_IF_ERROR(\n-              ds->ReplaceAllUsesWith(all_gather->mutable_operand(0)));\n+          HloInstruction* ag_operand = all_gather->mutable_operand(0);\n+          if (!ShapeUtil::Compatible(ds->shape(), ag_operand->shape())) {\n+            ag_operand = ag_operand->AddInstruction(HloInstruction::CreateSlice(\n+                ds->shape(), ag_operand,\n+                DimensionVector(ds->shape().dimensions().size(), 0),\n+                ds->shape().dimensions(),\n+                DimensionVector(ds->shape().dimensions().size(), 1)));\n+          }\n+          changed = true;\n+          TF_RETURN_IF_ERROR(ds->ReplaceAllUsesWith(ag_operand));\n           TF_RETURN_IF_ERROR(\n               computation->RemoveInstructionAndUnusedOperands(ds));\n         }"
        },
        {
            "sha": "928b749d9b2ba448db24dad4a418b1df8dba2d94",
            "filename": "third_party/xla/xla/service/all_gather_simplifier_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/29f16c487d4f1a4d6732dd7e91519cf3ac7a6867/third_party%2Fxla%2Fxla%2Fservice%2Fall_gather_simplifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/29f16c487d4f1a4d6732dd7e91519cf3ac7a6867/third_party%2Fxla%2Fxla%2Fservice%2Fall_gather_simplifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fall_gather_simplifier_test.cc?ref=29f16c487d4f1a4d6732dd7e91519cf3ac7a6867",
            "patch": "@@ -59,5 +59,31 @@ test {\n               GmockMatch(m::Add(m::Parameter(0), m::Parameter(1))));\n }\n \n+TEST_F(AllGatherSimplifierTest, DoesNotReplaceIfInputShapeMismatch) {\n+  const absl::string_view kModuleStr = R\"(\n+HloModule m\n+\n+test {\n+  p0 = f32[1, 5920, 4, 2304] parameter(0)\n+  all-gather = f32[1, 23680, 4, 2304] all-gather(p0), replica_groups={{0, 1, 2, 3}}, dimensions={1}, use_global_device_ids=true, channel_id=1\n+  replica-id = u32[] replica-id()\n+  table = s32[4] constant({0, 5520, 11040, 16560})\n+  ds_index = s32[1] dynamic-slice(table, replica-id), dynamic_slice_sizes={1}\n+  reshape = s32[] reshape(ds_index)\n+  zero = s32[] constant(0)\n+  ROOT dynamic-slice = f32[1, 5520, 4, 2304] dynamic-slice(all-gather, zero, reshape, zero, zero), dynamic_slice_sizes={1, 5520, 4, 2304}\n+}\n+)\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module, ParseAndReturnVerifiedModule(\n+                                           kModuleStr, /*replica_count=*/4));\n+  module->mutable_config().set_use_spmd_partitioning(true);\n+  AllGatherSimplifier ag_simplifier;\n+  auto result = ag_simplifier.Run(module.get());\n+  ASSERT_TRUE(result.ok()) << result.status();\n+  ASSERT_TRUE(result.value());\n+  EXPECT_THAT(module->entry_computation()->root_instruction(),\n+              GmockMatch(m::Slice(m::Parameter(0))));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 38,
        "deletions": 3
    }
}