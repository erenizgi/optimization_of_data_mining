{
    "author": "tensorflower-gardener",
    "message": "Allow hlo_diff to load HLO protos from text proto files.\n\nPiperOrigin-RevId: 802744031",
    "sha": "e8ca1ea499061f5504c28115d828f1490ed30d25",
    "files": [
        {
            "sha": "fd8bb74e39895dc2e9b09babfa374d1610a9a9fb",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_main.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8ca1ea499061f5504c28115d828f1490ed30d25/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8ca1ea499061f5504c28115d828f1490ed30d25/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_main.cc?ref=e8ca1ea499061f5504c28115d828f1490ed30d25",
            "patch": "@@ -128,12 +128,28 @@ absl::StatusOr<std::unique_ptr<HloModule>> LoadHLOModule(\n     return BuildHloModule(snapshot.hlo().hlo_module());\n   }\n   if (!hlo_path.hlo_proto.empty()) {\n-    return ReadModuleFromBinaryProtoFile(hlo_path.hlo_proto,\n-                                         xla::GetDebugOptionsFromFlags());\n+    absl::StatusOr<std::unique_ptr<HloModule>> module =\n+        ReadModuleFromBinaryProtoFile(hlo_path.hlo_proto,\n+                                      xla::GetDebugOptionsFromFlags());\n+    if (module.ok()) {\n+      return module;\n+    }\n+    LOG(INFO) << \"Failed to read \" << hlo_path.hlo_proto\n+              << \" as a binary proto, attempting to read as text proto.\";\n+    return ReadModuleFromTextProtoFile(hlo_path.hlo_proto,\n+                                       xla::GetDebugOptionsFromFlags());\n   }\n   if (!hlo_path.hlo_module_proto.empty()) {\n-    return ReadModuleFromModuleBinaryProtofile(hlo_path.hlo_module_proto,\n-                                               xla::GetDebugOptionsFromFlags());\n+    absl::StatusOr<std::unique_ptr<HloModule>> module =\n+        ReadModuleFromModuleBinaryProtofile(hlo_path.hlo_module_proto,\n+                                            xla::GetDebugOptionsFromFlags());\n+    if (module.ok()) {\n+      return module;\n+    }\n+    LOG(INFO) << \"Failed to read \" << hlo_path.hlo_module_proto\n+              << \" as a binary proto, attempting to read as text proto.\";\n+    return ReadModuleFromModuleTextProtoFile(hlo_path.hlo_module_proto,\n+                                             xla::GetDebugOptionsFromFlags());\n   }\n   if (!hlo_path.hlo_text.empty()) {\n     return ReadModuleFromHloTextFile("
        },
        {
            "sha": "892d340fb8e581444800df409ca417b0df1439ed",
            "filename": "third_party/xla/xla/service/hlo_module_util.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8ca1ea499061f5504c28115d828f1490ed30d25/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_module_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8ca1ea499061f5504c28115d828f1490ed30d25/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_module_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_module_util.cc?ref=e8ca1ea499061f5504c28115d828f1490ed30d25",
            "patch": "@@ -130,6 +130,19 @@ absl::StatusOr<std::unique_ptr<HloModule>> ReadModuleFromModuleBinaryProtofile(\n   return HloModule::CreateFromProto(module_proto, module_config);\n }\n \n+absl::StatusOr<std::unique_ptr<HloModule>> ReadModuleFromModuleTextProtoFile(\n+    absl::string_view hlo_file, const DebugOptions& debug_options) {\n+  HloModuleProto module_proto;\n+  TF_RETURN_IF_ERROR(tsl::ReadTextProto(tsl::Env::Default(),\n+                                        std::string(hlo_file), &module_proto));\n+\n+  TF_ASSIGN_OR_RETURN(\n+      HloModuleConfig module_config,\n+      HloModule::CreateModuleConfigFromProto(module_proto, debug_options));\n+\n+  return HloModule::CreateFromProto(module_proto, module_config);\n+}\n+\n absl::StatusOr<std::unique_ptr<HloModuleConfig>> CreateModuleConfig(\n     const ProgramShape& program_shape,\n     absl::Span<const Shape* const> argument_shapes,"
        },
        {
            "sha": "79cfa7582680e4b60b7e0e1282e3a7f869878bdd",
            "filename": "third_party/xla/xla/service/hlo_module_util.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8ca1ea499061f5504c28115d828f1490ed30d25/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_module_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8ca1ea499061f5504c28115d828f1490ed30d25/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_module_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_module_util.h?ref=e8ca1ea499061f5504c28115d828f1490ed30d25",
            "patch": "@@ -80,6 +80,12 @@ absl::StatusOr<std::unique_ptr<HloModule>> ReadModuleFromTextProtoFile(\n     absl::string_view hlo_file,\n     const DebugOptions& debug_options = DebugOptions::default_instance());\n \n+// Reads the proto file in xla.HloModuleProto format, creates and returns the\n+// HloModule.\n+absl::StatusOr<std::unique_ptr<HloModule>> ReadModuleFromModuleTextProtoFile(\n+    absl::string_view hlo_file,\n+    const DebugOptions& debug_options = DebugOptions::default_instance());\n+\n // Creates an HloModuleConfig for a given program shape and arguments.\n // If execution_options does not set num_replicas, default_num_replicas is used.\n // num_threads is optional; if not given, intra_op_parallelism_threads not set."
        }
    ],
    "stats": {
        "total": 43,
        "additions": 39,
        "deletions": 4
    }
}