{
    "author": "hyeontaek",
    "message": "[IFRT] Define `UserContext::Id()`\n\n`xla::ifrt::UserContext::Id()` is a new user context identifier that will\nsupersede `xla::ifrt::UserContext::Fingerprint()`. `Id()` accepts any globally\nunique ID for a certain context, which is more loose than `Fingerprint()`.\n\nThe main benefit is that `UserContext` subclasses will no longer be required to\ncompute a fingerprint, which is often very expensive (e.g., computing\n`PyUserContext`'s fingerprint requires holding GIL).\n\nThe downside is that any existing user code that expected the number of\nfingerprints to remain finite and small will be obsolete (e.g., a global\nregistry that permanently keeps `UserContext` based on their fingerprint).\nHowever, such user code will be be migrated with subsequent changes so that it\nis unnecessary to rely on that property and can instead use\n`xla::ifrt::UserContextRegistry`.\n\nPiperOrigin-RevId: 805416360",
    "sha": "6e612160ca7b9bc1da28f20c0e075df015170fe5",
    "files": [
        {
            "sha": "447757bb9441a007c70df8c4578138f69c5d0d1b",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -1110,6 +1110,7 @@ cc_library(\n     ]),\n     deps = [\n         \"//xla/tsl/concurrency:ref_count\",\n+        \"//xla/tsl/lib/gtl:int_type\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/base:no_destructor\",\n         \"@com_google_absl//absl/log:check\","
        },
        {
            "sha": "e24be82404faeeb75195950a5618c9de6b5003f5",
            "filename": "third_party/xla/xla/python/ifrt/test_util.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -129,24 +129,25 @@ namespace {\n \n class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n  public:\n-  explicit TestUserContext(uint64_t id) : id_(id) {}\n+  explicit TestUserContext(UserContextId id) : id_(id) {}\n \n-  uint64_t Fingerprint() const override { return id_; }\n+  uint64_t Fingerprint() const override { return id_.value(); }\n+  UserContextId Id() const override { return id_; }\n \n   std::string DebugString() const override {\n-    return absl::StrCat(\"TestUserContext(\", id_, \")\");\n+    return absl::StrCat(\"TestUserContext(\", id_.value(), \")\");\n   }\n \n   // No new `ID` is not defined because tests below do not exercise RTTI.\n \n  private:\n-  uint64_t id_;\n+  UserContextId id_;\n };\n \n }  // namespace\n \n UserContextRef MakeUserContext(uint64_t id) {\n-  return tsl::MakeRef<TestUserContext>(id);\n+  return tsl::MakeRef<TestUserContext>(UserContextId(id));\n }\n \n }  // namespace test_util"
        },
        {
            "sha": "226240c50d14618afb467a00058f23b10e351f0d",
            "filename": "third_party/xla/xla/python/ifrt/user_context.h",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -21,10 +21,14 @@ limitations under the License.\n \n #include \"llvm/Support/ExtensibleRTTI.h\"\n #include \"xla/tsl/concurrency/ref_count.h\"\n+#include \"xla/tsl/lib/gtl/int_type.h\"\n \n namespace xla {\n namespace ifrt {\n \n+// Globally unique ID for a `UserContext`.\n+TSL_LIB_GTL_DEFINE_INT_TYPE(UserContextId, uint64_t);\n+\n // UserContext is an interface that must be implemented by any object that the\n // user would like to be associated with the runtime operations triggered by an\n // IFRT call. For example, a UserContext can be based on a stack trace for\n@@ -42,11 +46,17 @@ class UserContext : public tsl::ReferenceCounted<UserContext>,\n   // may also use this as a key for holding the UserContexts in a container, and\n   // so this should be efficient enough to called multiple times.\n   //\n-  // TODO(hyeontaek): Remove this method once we migrate the UserContext to\n-  // a unique id scheme, where the id can be chosen without fingerprinting the\n-  // content of the UserContext.\n+  // TODO(hyeontaek): Remove this method once we migrate all users of\n+  // `Fingerprint()` to `Id()`. This will require the users to stop expecting to\n+  // see a small finite set of unique IDs over the lifetime of a process because\n+  // `Id()` semantics allows an indefinite set of IDs.\n   virtual uint64_t Fingerprint() const = 0;\n \n+  // Returns the unique ID of the UserContext. This ID is expected to be\n+  // globally unique for a certain context. For instance, both a global random\n+  // ID and the fingerprint of the UserContext content may be used as the ID.\n+  virtual UserContextId Id() const = 0;\n+\n   // Returns a human readable string. Meant for debugging, logging, and for\n   // putting together statusz-like pages.\n   //"
        },
        {
            "sha": "075b32914bb51f7a10221c2d8125654847ade988",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -15,7 +15,6 @@ limitations under the License.\n \n #include \"xla/python/ifrt/user_context_registry.h\"\n \n-#include <cstdint>\n #include <memory>\n #include <utility>\n #include <vector>\n@@ -35,7 +34,7 @@ UserContextRegistry& UserContextRegistry::Get() {\n \n TrackedUserContextRef UserContextRegistry::Register(\n     UserContextRef user_context) {\n-  const uint64_t id = user_context->Fingerprint();\n+  const UserContextId id = user_context->Id();\n   absl::MutexLock lock(&mu_);\n   auto it = registry_.find(id);\n   if (it != registry_.end()) {\n@@ -54,7 +53,7 @@ TrackedUserContextRef UserContextRegistry::Register(\n   return tracked_user_context;\n }\n \n-TrackedUserContextRef UserContextRegistry::Lookup(uint64_t id) const {\n+TrackedUserContextRef UserContextRegistry::Lookup(UserContextId id) const {\n   absl::MutexLock lock(&mu_);\n   auto it = registry_.find(id);\n   if (it != registry_.end()) {\n@@ -79,7 +78,7 @@ std::vector<TrackedUserContextRef> UserContextRegistry::LookupAll() const {\n   return tracked_user_contexts;\n }\n \n-void UserContextRegistry::Unregister(uint64_t id) {\n+void UserContextRegistry::Unregister(UserContextId id) {\n   absl::MutexLock lock(&mu_);\n   CHECK_EQ(registry_.erase(id), 1);\n }"
        },
        {
            "sha": "f21b1d3070d12f2871e15746c8b105b31d3bb49d",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry.h",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -16,7 +16,6 @@ limitations under the License.\n #ifndef XLA_PYTHON_IFRT_USER_CONTEXT_REGISTRY_H_\n #define XLA_PYTHON_IFRT_USER_CONTEXT_REGISTRY_H_\n \n-#include <cstdint>\n #include <memory>\n #include <utility>\n #include <vector>\n@@ -70,7 +69,7 @@ class UserContextRegistry {\n \n   // Returns `TrackedUserContextRef` for `id`.\n   // If no such `id` is found, returns `nullptr`.\n-  TrackedUserContextRef Lookup(uint64_t id) const;\n+  TrackedUserContextRef Lookup(UserContextId id) const;\n \n   // Returns all `TrackedUserContextRef`s in the registry. Note that since the\n   // registry is process-wide, the result will contain `TrackedUserContextRef`s\n@@ -82,13 +81,13 @@ class UserContextRegistry {\n \n   // Removes a `TrackedUserContext` entry identified by `id` from the\n   // registry.\n-  void Unregister(uint64_t id);\n+  void Unregister(UserContextId id);\n \n   mutable absl::Mutex mu_;\n   // A map from `UserContext::Fingerprint()` to a weak reference of\n   // `TrackedUserContext`.\n-  absl::flat_hash_map<uint64_t, std::weak_ptr<TrackedUserContext>> registry_\n-      ABSL_GUARDED_BY(mu_);\n+  absl::flat_hash_map<UserContextId, std::weak_ptr<TrackedUserContext>>\n+      registry_ ABSL_GUARDED_BY(mu_);\n };\n \n // RAII wrapper around `UserContextRef` to allow querying them via the registry\n@@ -106,10 +105,10 @@ class TrackedUserContext {\n  private:\n   friend UserContextRegistry;\n \n-  explicit TrackedUserContext(uint64_t id, UserContextRef user_context)\n+  explicit TrackedUserContext(UserContextId id, UserContextRef user_context)\n       : id_(id), user_context_(std::move(user_context)) {}\n \n-  const uint64_t id_;\n+  const UserContextId id_;\n   const UserContextRef user_context_;\n };\n "
        },
        {
            "sha": "27cae8fc90dfe069fe025a9ffbd69a26bdd14992",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 17,
            "changes": 43,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -31,45 +31,52 @@ namespace {\n \n class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n  public:\n-  static UserContextRef Create(uint64_t id) {\n+  static UserContextRef Create(UserContextId id) {\n     return tsl::TakeRef<TestUserContext>(new TestUserContext(id));\n   }\n \n-  uint64_t Fingerprint() const override { return id_; }\n+  uint64_t Fingerprint() const override { return id_.value(); }\n+  UserContextId Id() const override { return UserContextId(id_); }\n \n   std::string DebugString() const override {\n-    return absl::StrCat(\"user context \", id_);\n+    return absl::StrCat(\"user context \", id_.value());\n   }\n \n   // No new `ID` is not defined because tests below do not exercise RTTI.\n \n  private:\n-  explicit TestUserContext(uint64_t id) : id_(id) {}\n+  explicit TestUserContext(UserContextId id) : id_(id) {}\n \n-  uint64_t id_;\n+  const UserContextId id_;\n };\n \n TEST(UserContextRegistryTest, GetAndLookup) {\n-  UserContextRef user_context1 = TestUserContext::Create(100);\n+  const UserContextId kUserContextId1(100);\n+  UserContextRef user_context1 = TestUserContext::Create(kUserContextId1);\n   TrackedUserContextRef tracked_user_context1 =\n       UserContextRegistry::Get().Register(user_context1);\n-  ASSERT_EQ(UserContextRegistry::Get().Lookup(100), tracked_user_context1);\n-  EXPECT_EQ(UserContextRegistry::Get().Lookup(100)->user_context(),\n+  ASSERT_EQ(UserContextRegistry::Get().Lookup(kUserContextId1),\n+            tracked_user_context1);\n+  EXPECT_EQ(UserContextRegistry::Get().Lookup(kUserContextId1)->user_context(),\n             user_context1);\n \n-  UserContextRef user_context2 = TestUserContext::Create(200);\n+  const UserContextId kUserContextId2(200);\n+  UserContextRef user_context2 = TestUserContext::Create(kUserContextId2);\n   TrackedUserContextRef tracked_user_context2 =\n       UserContextRegistry::Get().Register(user_context2);\n-  ASSERT_EQ(UserContextRegistry::Get().Lookup(200), tracked_user_context2);\n-  EXPECT_EQ(UserContextRegistry::Get().Lookup(200)->user_context(),\n+  ASSERT_EQ(UserContextRegistry::Get().Lookup(kUserContextId2),\n+            tracked_user_context2);\n+  EXPECT_EQ(UserContextRegistry::Get().Lookup(kUserContextId2)->user_context(),\n             user_context2);\n }\n \n TEST(UserContextRegistryTest, LookupAll) {\n-  UserContextRef user_context1 = TestUserContext::Create(100);\n+  const UserContextId kUserContextId1(100);\n+  UserContextRef user_context1 = TestUserContext::Create(kUserContextId1);\n   TrackedUserContextRef tracked_user_context1 =\n       UserContextRegistry::Get().Register(user_context1);\n-  UserContextRef user_context2 = TestUserContext::Create(200);\n+  const UserContextId kUserContextId2(200);\n+  UserContextRef user_context2 = TestUserContext::Create(kUserContextId2);\n   TrackedUserContextRef tracked_user_context2 =\n       UserContextRegistry::Get().Register(user_context2);\n \n@@ -79,13 +86,15 @@ TEST(UserContextRegistryTest, LookupAll) {\n }\n \n TEST(UserContextRegistryTest, Unregister) {\n-  EXPECT_EQ(UserContextRegistry::Get().Lookup(100), nullptr);\n+  const UserContextId kUserContextId(100);\n+  EXPECT_EQ(UserContextRegistry::Get().Lookup(kUserContextId), nullptr);\n   {\n     TrackedUserContextRef tracked_user_context =\n-        UserContextRegistry::Get().Register(TestUserContext::Create(100));\n-    EXPECT_NE(UserContextRegistry::Get().Lookup(100), nullptr);\n+        UserContextRegistry::Get().Register(\n+            TestUserContext::Create(kUserContextId));\n+    EXPECT_NE(UserContextRegistry::Get().Lookup(kUserContextId), nullptr);\n   }\n-  EXPECT_EQ(UserContextRegistry::Get().Lookup(100), nullptr);\n+  EXPECT_EQ(UserContextRegistry::Get().Lookup(kUserContextId), nullptr);\n }\n \n }  // namespace"
        },
        {
            "sha": "f1c8304efd3976dea4c486cd60eabad32d742620",
            "filename": "third_party/xla/xla/python/ifrt/user_context_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -36,6 +36,7 @@ class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n   static UserContextRef Create() { return tsl::MakeRef<TestUserContext>(); }\n \n   uint64_t Fingerprint() const override { return 1; }\n+  UserContextId Id() const override { return UserContextId(1); }\n \n   std::string DebugString() const override { return \"\"; }\n \n@@ -55,6 +56,7 @@ TEST(UserContextScopeTest, SingleScope) {\n TEST(UserContextScopeTest, SingleScopeWithInlineContextCreation) {\n   UserContextScope scope(TestUserContext::Create());\n   EXPECT_EQ(UserContextScope::current()->Fingerprint(), 1);\n+  EXPECT_EQ(UserContextScope::current()->Id(), UserContextId(1));\n }\n \n TEST(UserContextScopeTest, NestedScopes) {"
        },
        {
            "sha": "893f52e3f73da325fda5aa9ff787895ddc64acc1",
            "filename": "third_party/xla/xla/python/version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e612160ca7b9bc1da28f20c0e075df015170fe5/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h?ref=6e612160ca7b9bc1da28f20c0e075df015170fe5",
            "patch": "@@ -18,6 +18,6 @@ limitations under the License.\n \n // An increasing version number to protect jax code against breaking changes.\n // In JAX, reference this via jax._src.lib.ifrt_version.\n-#define JAX_IFRT_VERSION_NUMBER 24\n+#define JAX_IFRT_VERSION_NUMBER 25\n \n #endif  // XLA_PYTHON_VERSION_H_"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 58,
        "deletions": 37
    }
}