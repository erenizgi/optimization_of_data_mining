{
    "author": "beckerhe",
    "message": "Remove HloProfilePrinterData and HloProfileIndexMap from CpuAotCompilationResult\n\nThis change removes the HloProfilePrinterData members from CpuAotCompilationResult,\nas well as removes it from XlaJitCompiledCpuFunction.\n\nWe still need to keep the old factory function overload since we can't\ndo cross cutting changes with TF. Therefore the overload will get\nremoved in a subsequent change.\n\nPiperOrigin-RevId: 840241356",
    "sha": "d3465ed6dc3b051f04c0760a695a4dc9feaaf747",
    "files": [
        {
            "sha": "990ef109f451bb087a06c3ff1a3255e4f7ba1d89",
            "filename": "tensorflow/compiler/tf2xla/xla_jit_compiled_cpu_function.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/tensorflow%2Fcompiler%2Ftf2xla%2Fxla_jit_compiled_cpu_function.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/tensorflow%2Fcompiler%2Ftf2xla%2Fxla_jit_compiled_cpu_function.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Ftf2xla%2Fxla_jit_compiled_cpu_function.cc?ref=d3465ed6dc3b051f04c0760a695a4dc9feaaf747",
            "patch": "@@ -267,14 +267,6 @@ XlaJitCompiledCpuFunction::Compile(\n   XlaCompiledCpuFunction::set_static_data_program_shape(\n       &jit->static_data_, jit->program_shape_.get());\n \n-  if (cpu_executable->hlo_profiling_enabled()) {\n-    XlaCompiledCpuFunction::set_static_data_hlo_profile_printer_data(\n-        &jit->static_data_, &cpu_executable->hlo_profile_printer_data());\n-    XlaCompiledCpuFunction::set_static_data_profile_counters_size(\n-        &jit->static_data_,\n-        cpu_executable->hlo_profile_printer_data().profile_counters_size());\n-  }\n-\n   return std::move(jit_unique_ptr);\n }\n "
        },
        {
            "sha": "5cbba6512890749546d8e6c22f984707bc4a62d4",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=d3465ed6dc3b051f04c0760a695a4dc9feaaf747",
            "patch": "@@ -395,6 +395,7 @@ cc_library(\n         \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_absl//absl/types:span\",\n     ],\n )\n "
        },
        {
            "sha": "e422891c24ec3486490ed5b335ae990eddde0d29",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compilation_result.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc?ref=d3465ed6dc3b051f04c0760a695a4dc9feaaf747",
            "patch": "@@ -49,7 +49,6 @@ limitations under the License.\n #include \"xla/service/hlo.pb.h\"\n #include \"xla/service/hlo_cost_analysis.h\"\n #include \"xla/service/hlo_module_config.h\"\n-#include \"xla/service/hlo_profile_printer_data.pb.h\"\n #include \"xla/stream_executor/host/host_platform_id.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -80,7 +79,6 @@ CpuAotCompilationResult::Create(\n     absl::string_view function_name, std::vector<ObjFileProto> obj_files,\n     std::vector<SymbolProto> symbols, const ThunkSequence& thunks,\n     std::unique_ptr<FunctionLibrary> function_library,\n-    std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     TargetMachineOptionsProto target_machine_options) {\n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n       hlo_module, &buffer_assignment->Allocations());\n@@ -110,7 +108,7 @@ CpuAotCompilationResult::Create(\n       hlo_module, buffer_assignment, function_name, std::move(obj_files),\n       std::move(symbols), thunk_proto, std::move(temp_allocation_index),\n       std::move(buffer_allocation_infos), std::move(function_library),\n-      std::move(hlo_profile_printer_data), std::move(target_machine_options)));\n+      std::move(target_machine_options)));\n }\n \n CpuAotCompilationResult::CpuAotCompilationResult(\n@@ -120,12 +118,10 @@ CpuAotCompilationResult::CpuAotCompilationResult(\n     std::optional<size_t> temp_allocation_index,\n     std::vector<BufferAllocationInfo> buffer_allocation_infos,\n     std::unique_ptr<FunctionLibrary> function_library,\n-    std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     TargetMachineOptionsProto target_machine_options)\n     : temp_allocation_index_(temp_allocation_index),\n       buffer_allocation_infos_(std::move(buffer_allocation_infos)),\n-      function_library_(std::move(function_library)),\n-      hlo_profile_printer_data_(std::move(hlo_profile_printer_data)) {\n+      function_library_(std::move(function_library)) {\n   *proto_.mutable_hlo_module()->mutable_hlo_module() = hlo_module->ToProto();\n   *proto_.mutable_hlo_module()->mutable_config() =\n       hlo_module->config().ToProto();"
        },
        {
            "sha": "e6589fb1787da5afa6a7c75a2c943822354108b8",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compilation_result.h",
            "status": "modified",
            "additions": 19,
            "deletions": 10,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d3465ed6dc3b051f04c0760a695a4dc9feaaf747/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.h?ref=d3465ed6dc3b051f04c0760a695a4dc9feaaf747",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n \n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/backends/cpu/buffer_allocation_info.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n #include \"xla/backends/cpu/runtime/thunk.h\"\n@@ -106,10 +107,27 @@ class CpuAotCompilationResult : public AotCompilationResult {\n       absl::string_view function_name, std::vector<ObjFileProto> obj_files,\n       std::vector<SymbolProto> symbols, const ThunkSequence& thunks,\n       std::unique_ptr<FunctionLibrary> function_library,\n-      std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n       TargetMachineOptionsProto target_machine_options =\n           TargetMachineOptionsProto());\n \n+  [[deprecated(\n+      \"HloProfilePrinterData is not used anymore. Use the other Create \"\n+      \"method instead.\")]] static absl::\n+      StatusOr<std::unique_ptr<CpuAotCompilationResult>>\n+      Create(const HloModule* hlo_module,\n+             const BufferAssignment* buffer_assignment,\n+             absl::string_view function_name,\n+             std::vector<ObjFileProto> obj_files,\n+             std::vector<SymbolProto> symbols, const ThunkSequence& thunks,\n+             std::unique_ptr<FunctionLibrary> function_library,\n+             std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n+             TargetMachineOptionsProto target_machine_options =\n+                 TargetMachineOptionsProto()) {\n+    return Create(hlo_module, buffer_assignment, function_name,\n+                  std::move(obj_files), std::move(symbols), thunks,\n+                  std::move(function_library), target_machine_options);\n+  }\n+\n   ~CpuAotCompilationResult() override = default;\n \n   absl::StatusOr<std::string> SerializeAsString() const override {\n@@ -153,10 +171,6 @@ class CpuAotCompilationResult : public AotCompilationResult {\n     return buffer_allocation_infos_;\n   }\n \n-  const HloProfilePrinterData* hlo_profile_printer_data() const {\n-    return hlo_profile_printer_data_.get();\n-  }\n-\n   static absl::StatusOr<std::unique_ptr<CpuAotCompilationResult>> FromProto(\n       CompilationResultProto proto,\n       std::unique_ptr<FunctionLibrary> function_library) {\n@@ -187,7 +201,6 @@ class CpuAotCompilationResult : public AotCompilationResult {\n       std::optional<size_t> temp_allocation_index,\n       std::vector<BufferAllocationInfo> buffer_allocation_infos,\n       std::unique_ptr<FunctionLibrary> function_library,\n-      std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n       TargetMachineOptionsProto target_machine_options);\n \n   explicit CpuAotCompilationResult(\n@@ -203,10 +216,6 @@ class CpuAotCompilationResult : public AotCompilationResult {\n   std::vector<BufferAllocationInfo> buffer_allocation_infos_;\n \n   std::unique_ptr<FunctionLibrary> function_library_;\n-\n-  // Contains an instance of HloProfilePrinterData if HLO profiling is enabled,\n-  // otherwise is nullptr.\n-  std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data_;\n };\n \n }  // namespace xla::cpu"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 22,
        "deletions": 24
    }
}