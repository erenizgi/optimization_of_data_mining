{
    "author": "hhb",
    "message": "Unify topology in PjRtTopologyDescription\n\nThe topology on pjrt layer can be seen as:\n\n(process, chip, logical device) or (process, chip, core)\n\nFor cpu, it is (1, num device, 1)\n\nFor gpu, it is (num host, gpu per host, 1)\n\nPiperOrigin-RevId: 826581627",
    "sha": "8572aaa4e9ecca9493babcf028bef97aad1f7388",
    "files": [
        {
            "sha": "8bfc6a903e08b7c97de28110ec7d9a243f5c1adc",
            "filename": "third_party/xla/xla/pjrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD?ref=8572aaa4e9ecca9493babcf028bef97aad1f7388",
            "patch": "@@ -479,6 +479,7 @@ cc_library(\n         \"//xla/hlo/builder:xla_computation\",\n         \"//xla/pjrt/proto:pjrt_partial_program_proto_cc\",\n         \"//xla/pjrt/proto:topology_description_proto_cc\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\","
        },
        {
            "sha": "e4ea32f8e28491735e94119221f06c7803b5a226",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_topology_description.h",
            "status": "modified",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_topology_description.h?ref=8572aaa4e9ecca9493babcf028bef97aad1f7388",
            "patch": "@@ -86,19 +86,15 @@ class StreamExecutorGpuTopologyDescription : public PjRtTopologyDescription {\n     return gpu_topology_->number_of_hosts();\n   }\n \n-  absl::StatusOr<int> CoreCountOfDefaultType() const override {\n-    return gpu_topology_->number_of_devices();\n+  absl::StatusOr<int> ChipsPerProcess() const override {\n+    return gpu_topology_->num_devices_per_host();\n   }\n \n-  absl::StatusOr<int> LogicalDeviceCountOfDefaultType() const override {\n-    return gpu_topology_->number_of_devices();\n-  }\n-\n-  absl::StatusOr<int> CoreCountOfDefaultTypePerProcess() const override {\n-    return gpu_topology_->number_of_devices();\n+  absl::StatusOr<int> CoreCountOfDefaultTypePerChip() const override {\n+    return 1;\n   }\n \n-  absl::StatusOr<int> CoreCountOfDefaultTypePerChip() const override {\n+  absl::StatusOr<int> LogicalDeviceCountOfDefaultTypePerChip() const override {\n     return 1;\n   }\n "
        },
        {
            "sha": "4fa47194162081ce060efe95f062d89464daed7f",
            "filename": "third_party/xla/xla/pjrt/pjrt_compiler.h",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_compiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_compiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_compiler.h?ref=8572aaa4e9ecca9493babcf028bef97aad1f7388",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"xla/pjrt/pjrt_executable.h\"\n #include \"xla/pjrt/proto/pjrt_partial_program.pb.h\"\n #include \"xla/pjrt/proto/topology_description.pb.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"tsl/platform/fingerprint.h\"\n \n namespace xla {\n@@ -121,20 +122,41 @@ class PjRtTopologyDescription {\n     return absl::UnimplementedError(\"ProcessCount is unsupported.\");\n   }\n \n+  // Returns the number of chips per process.\n+  virtual absl::StatusOr<int> ChipsPerProcess() const {\n+    return absl::UnimplementedError(\"ChipsPerProcess is unsupported.\");\n+  }\n+\n   // Returns the number of chips.\n   virtual absl::StatusOr<int> ChipCount() const {\n-    return absl::UnimplementedError(\"ChipCount is unsupported.\");\n+    TF_ASSIGN_OR_RETURN(int process_count, ProcessCount());\n+    TF_ASSIGN_OR_RETURN(int chips_per_process, ChipsPerProcess());\n+    return process_count * chips_per_process;\n   }\n \n   // Returns the total number of cores of the default type.\n   virtual absl::StatusOr<int> CoreCountOfDefaultType() const {\n-    return absl::UnimplementedError(\"CoreCountOfDefaultType is unsupported.\");\n+    TF_ASSIGN_OR_RETURN(int process_count, ProcessCount());\n+    TF_ASSIGN_OR_RETURN(int cores_per_process,\n+                        CoreCountOfDefaultTypePerProcess());\n+    return process_count * cores_per_process;\n+  }\n+\n+  // As above, but returns the number of logical devices per host.\n+  virtual absl::StatusOr<int> LogicalDeviceCountOfDefaultTypePerProcess()\n+      const {\n+    TF_ASSIGN_OR_RETURN(int logical_devices_per_chip,\n+                        LogicalDeviceCountOfDefaultTypePerChip());\n+    TF_ASSIGN_OR_RETURN(int chips_per_process, ChipsPerProcess());\n+    return chips_per_process * logical_devices_per_chip;\n   }\n \n   // Returns the total number of logical devices of the default type.\n   virtual absl::StatusOr<int> LogicalDeviceCountOfDefaultType() const {\n-    return absl::UnimplementedError(\n-        \"LogicalDeviceCountOfDefaultType is unsupported.\");\n+    TF_ASSIGN_OR_RETURN(int process_count, ProcessCount());\n+    TF_ASSIGN_OR_RETURN(int logical_devices_per_process,\n+                        LogicalDeviceCountOfDefaultTypePerProcess());\n+    return process_count * logical_devices_per_process;\n   }\n \n   // Returns the number of logical devices of the default type per chip.\n@@ -145,8 +167,9 @@ class PjRtTopologyDescription {\n \n   // Returns the number of cores of the default type per process.\n   virtual absl::StatusOr<int> CoreCountOfDefaultTypePerProcess() const {\n-    return absl::UnimplementedError(\n-        \"CoreCountOfDefaultTypePerProcess is unsupported.\");\n+    TF_ASSIGN_OR_RETURN(int cores_per_chip, CoreCountOfDefaultTypePerChip());\n+    TF_ASSIGN_OR_RETURN(int chips_per_process, ChipsPerProcess());\n+    return cores_per_chip * chips_per_process;\n   }\n \n   // Returns the number of cores per chip for the default type.\n@@ -178,6 +201,8 @@ class PjRtTopologyDescription {\n   }\n \n   // Returns the total bounds of all chips in the topology.\n+  // Usually this equals to the product of `ChipsPerHostBounds()` and\n+  // `HostBounds()`.\n   virtual absl::StatusOr<PjRtDeviceDimensions> ChipBounds() const {\n     return absl::UnimplementedError(\"ChipBounds is unsupported.\");\n   }"
        },
        {
            "sha": "1c9deefdb0a3a6f9e53fc911a7648ee7fecb85c2",
            "filename": "third_party/xla/xla/pjrt/plugin/xla_cpu/cpu_topology_description.h",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8572aaa4e9ecca9493babcf028bef97aad1f7388/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description.h?ref=8572aaa4e9ecca9493babcf028bef97aad1f7388",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"xla/layout.h\"\n #include \"xla/pjrt/pjrt_client.h\"\n+#include \"xla/pjrt/pjrt_common.h\"\n #include \"xla/pjrt/pjrt_compiler.h\"\n #include \"xla/pjrt/pjrt_device_description.h\"\n #include \"xla/pjrt/pjrt_device_dimensions.h\"\n@@ -80,16 +81,12 @@ class CpuTopologyDescription : public PjRtTopologyDescription {\n   // correctly report process count.\n   absl::StatusOr<int> ProcessCount() const override { return 1; }\n \n-  absl::StatusOr<int> CoreCountOfDefaultType() const override {\n+  absl::StatusOr<int> ChipsPerProcess() const override {\n     return cpu_topology_.number_of_devices();\n   }\n \n-  absl::StatusOr<int> LogicalDeviceCountOfDefaultType() const override {\n-    return cpu_topology_.number_of_devices();\n-  }\n-\n-  absl::StatusOr<int> CoreCountOfDefaultTypePerProcess() const override {\n-    return cpu_topology_.number_of_devices();\n+  absl::StatusOr<int> LogicalDeviceCountOfDefaultTypePerChip() const override {\n+    return 1;\n   }\n \n   absl::StatusOr<int> CoreCountOfDefaultTypePerChip() const override {"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 41,
        "deletions": 22
    }
}