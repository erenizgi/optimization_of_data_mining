{
    "author": "hyeontaek",
    "message": "[IFRT] Deduplicate `TestUserContext`\n\nDefine `TestUserContext` in a common place and share it across tests.\n\nPiperOrigin-RevId: 814395588",
    "sha": "d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
    "files": [
        {
            "sha": "25bf81cef7653bca0d690714634cef601980e655",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -414,6 +414,7 @@ cc_library(\n     deps = [\n         \":ifrt\",\n         \":user_context\",\n+        \":user_context_test_util\",\n         \"//xla/tsl/concurrency:ref_count\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n@@ -426,7 +427,6 @@ cc_library(\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n-        \"@llvm-project//llvm:Support\",\n     ],\n )\n \n@@ -453,6 +453,18 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"user_context_test_util\",\n+    testonly = True,\n+    hdrs = [\"user_context_test_util.h\"],\n+    deps = [\n+        \":user_context\",\n+        \"//xla/tsl/concurrency:ref_count\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@llvm-project//llvm:Support\",\n+    ],\n+)\n+\n cc_library(\n     name = \"array_impl_test_lib\",\n     testonly = True,\n@@ -1119,12 +1131,11 @@ xla_cc_test(\n     srcs = [\"user_context_test.cc\"],\n     deps = [\n         \":user_context\",\n+        \":user_context_test_util\",\n         \"//xla/tsl/concurrency:ref_count\",\n         \"//xla/tsl/platform:env\",\n-        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/time\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@llvm-project//llvm:Support\",\n     ],\n )\n \n@@ -1152,14 +1163,13 @@ xla_cc_test(\n     deps = [\n         \":user_context\",\n         \":user_context_registry\",\n+        \":user_context_test_util\",\n         \"//xla/tsl/concurrency:ref_count\",\n         \"//xla/tsl/platform:env\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/memory\",\n-        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@llvm-project//llvm:Support\",\n     ],\n )\n \n@@ -1192,14 +1202,13 @@ xla_cc_test(\n         \":user_context\",\n         \":user_context_registry\",\n         \":user_context_status_util\",\n-        \"//xla/tsl/concurrency:ref_count\",\n+        \":user_context_test_util\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:status_to_from_proto\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:cord\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@llvm-project//llvm:Support\",\n     ],\n )\n "
        },
        {
            "sha": "ce3bbee8157fc42febe845556216c7464b55f237",
            "filename": "third_party/xla/xla/python/ifrt/test_util.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 24,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -18,7 +18,6 @@ limitations under the License.\n #include <cstdint>\n #include <functional>\n #include <memory>\n-#include <string>\n #include <utility>\n \n #include \"absl/base/thread_annotations.h\"\n@@ -30,12 +29,11 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n-#include \"llvm/Support/ExtensibleRTTI.h\"\n #include \"xla/python/ifrt/client.h\"\n #include \"xla/python/ifrt/device.h\"\n #include \"xla/python/ifrt/device_list.h\"\n #include \"xla/python/ifrt/user_context.h\"\n-#include \"xla/tsl/concurrency/ref_count.h\"\n+#include \"xla/python/ifrt/user_context_test_util.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -125,28 +123,8 @@ absl::StatusOr<DeviceListRef> GetAddressableDevices(\n   return client->MakeDeviceList(std::move(devices));\n }\n \n-namespace {\n-\n-class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n- public:\n-  explicit TestUserContext(UserContextId id) : id_(id) {}\n-\n-  UserContextId Id() const override { return id_; }\n-\n-  std::string DebugString() const override {\n-    return absl::StrCat(\"TestUserContext(\", id_.value(), \")\");\n-  }\n-\n-  // No new `ID` is not defined because tests below do not exercise RTTI.\n-\n- private:\n-  UserContextId id_;\n-};\n-\n-}  // namespace\n-\n UserContextRef MakeUserContext(uint64_t id) {\n-  return tsl::MakeRef<TestUserContext>(UserContextId(id));\n+  return TestUserContext::Create(UserContextId(id));\n }\n \n }  // namespace test_util"
        },
        {
            "sha": "65cd5cc8785db916b14790402470bca7151a686c",
            "filename": "third_party/xla/xla/python/ifrt/test_util.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.h?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -96,8 +96,8 @@ absl::StatusOr<DeviceListRef> GetDevices(Client* client,\n absl::StatusOr<DeviceListRef> GetAddressableDevices(\n     Client* client, absl::Span<const int> device_indices);\n \n-// Returns a new `UserContext` for testing. The created `UserContext` has a\n-// fingerprint equal to `id`.\n+// Returns a new `UserContext` for testing. The created `UserContext` has an\n+// ID equal to `id`.\n UserContextRef MakeUserContext(uint64_t id);\n \n }  // namespace test_util"
        },
        {
            "sha": "8d442e524e3801b503b31382f09e474efa6ff324",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 22,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -23,37 +23,16 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"absl/log/check.h\"\n #include \"absl/memory/memory.h\"\n-#include \"absl/strings/str_cat.h\"\n #include \"absl/synchronization/barrier.h\"\n-#include \"llvm/Support/ExtensibleRTTI.h\"\n #include \"xla/python/ifrt/user_context.h\"\n+#include \"xla/python/ifrt/user_context_test_util.h\"\n #include \"xla/tsl/concurrency/ref_count.h\"\n #include \"xla/tsl/platform/env.h\"\n \n namespace xla {\n namespace ifrt {\n namespace {\n \n-class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n- public:\n-  static UserContextRef Create(UserContextId id) {\n-    return tsl::TakeRef<TestUserContext>(new TestUserContext(id));\n-  }\n-\n-  UserContextId Id() const override { return UserContextId(id_); }\n-\n-  std::string DebugString() const override {\n-    return absl::StrCat(\"user context \", id_.value());\n-  }\n-\n-  // No new `ID` is not defined because tests below do not exercise RTTI.\n-\n- private:\n-  explicit TestUserContext(UserContextId id) : id_(id) {}\n-\n-  const UserContextId id_;\n-};\n-\n TEST(UserContextRegistryTest, NullptrUserContext) {\n   TrackedUserContextRef tracked_user_context =\n       UserContextRegistry::Get().Register(UserContextRef());"
        },
        {
            "sha": "eccf4e5e4012296d92fe1e0b30dc5d84f5bb9db1",
            "filename": "third_party/xla/xla/python/ifrt/user_context_status_util_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 26,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_status_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_status_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_status_util_test.cc?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -16,18 +16,16 @@ limitations under the License.\n #include \"xla/python/ifrt/user_context_status_util.h\"\n \n #include <optional>\n-#include <string>\n #include <utility>\n \n #include <gtest/gtest.h>\n #include \"absl/status/status.h\"\n #include \"absl/strings/cord.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n-#include \"llvm/Support/ExtensibleRTTI.h\"\n #include \"xla/python/ifrt/user_context.h\"\n #include \"xla/python/ifrt/user_context_registry.h\"\n-#include \"xla/tsl/concurrency/ref_count.h\"\n+#include \"xla/python/ifrt/user_context_test_util.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/status_to_from_proto.h\"\n \n@@ -38,26 +36,6 @@ namespace {\n constexpr absl::string_view kIfrtUserContextPayloadUrl =\n     \"type.googleapis.com/ifrt.UserContext\";\n \n-class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n- public:\n-  static UserContextRef Create(UserContextId id) {\n-    return tsl::TakeRef<TestUserContext>(new TestUserContext(id));\n-  }\n-\n-  UserContextId Id() const override { return id_; }\n-\n-  std::string DebugString() const override {\n-    return absl::StrCat(\"user context \", id_.value());\n-  }\n-\n-  // No new `ID` is not defined because tests below do not exercise RTTI.\n-\n- private:\n-  explicit TestUserContext(UserContextId id) : id_(id) {}\n-\n-  UserContextId id_;\n-};\n-\n TEST(UserContextStatusUtilTest, AttachUserContextId) {\n   absl::Status status = absl::InvalidArgumentError(\"test\");\n   const UserContextId kUserContextId(100);\n@@ -226,7 +204,7 @@ TEST(UserContextStatusUtilTest, ExpandUserContexts) {\n   }\n   {\n     absl::Status expanded_status = ExpandUserContexts(status);\n-    EXPECT_EQ(expanded_status.message(), \"test\\n\\t\\nuser context 100\");\n+    EXPECT_EQ(expanded_status.message(), \"test\\n\\t\\nTestUserContext(100)\");\n     std::optional<absl::Cord> payload =\n         expanded_status.GetPayload(kIfrtUserContextPayloadUrl);\n     EXPECT_FALSE(payload.has_value());\n@@ -240,7 +218,7 @@ TEST(UserContextStatusUtilTest, RoundtripPreserveUserContextIds) {\n                                 TestUserContext::Create(kUserContextId));\n   {\n     absl::Status expanded_status = ExpandUserContexts(status);\n-    EXPECT_EQ(expanded_status.message(), \"test\\n\\t\\nuser context 100\");\n+    EXPECT_EQ(expanded_status.message(), \"test\\n\\t\\nTestUserContext(100)\");\n   }\n \n   tensorflow::StatusProto status_proto = tsl::StatusToProto(status);\n@@ -256,7 +234,7 @@ TEST(UserContextStatusUtilTest, RoundtripPreserveUserContextIds) {\n             TestUserContext::Create(kUserContextId));\n     absl::Status expanded_status =\n         ExpandUserContexts(ReattachUserContextRefs(std::move(status)));\n-    EXPECT_EQ(expanded_status.message(), \"test\\n\\t\\nuser context 100\");\n+    EXPECT_EQ(expanded_status.message(), \"test\\n\\t\\nTestUserContext(100)\");\n   }\n }\n "
        },
        {
            "sha": "7771698eeddbc6098ff82243c89d54b2d4d5270d",
            "filename": "third_party/xla/xla/python/ifrt/user_context_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 27,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -18,10 +18,9 @@ limitations under the License.\n #include <string>\n \n #include <gtest/gtest.h>\n-#include \"absl/strings/str_cat.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n-#include \"llvm/Support/ExtensibleRTTI.h\"\n+#include \"xla/python/ifrt/user_context_test_util.h\"\n #include \"xla/tsl/concurrency/ref_count.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n@@ -31,26 +30,6 @@ namespace ifrt {\n \n namespace {\n \n-class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n- public:\n-  static UserContextRef Create(UserContextId id) {\n-    return tsl::TakeRef<TestUserContext>(new TestUserContext(id));\n-  }\n-\n-  UserContextId Id() const override { return id_; }\n-\n-  std::string DebugString() const override {\n-    return absl::StrCat(\"user context \", id_.value());\n-  }\n-\n-  // No new `ID` is not defined because tests below do not exercise RTTI.\n-\n- private:\n-  explicit TestUserContext(UserContextId id) : id_(id) {}\n-\n-  UserContextId id_;\n-};\n-\n TEST(AnnotatedUserContextTest, Id) {\n   const UserContextId kUserContextId(100);\n   UserContextRef context = TestUserContext::Create(kUserContextId);\n@@ -75,7 +54,7 @@ TEST(AnnotatedUserContextTest, DebugString) {\n     UserContextRef annotated_context =\n         AnnotatedUserContext::Create(context, \"test annotation\");\n     EXPECT_EQ(annotated_context->DebugString(),\n-              \"user context 100; test annotation\");\n+              \"TestUserContext(100); test annotation\");\n   }\n   {\n     UserContextRef annotated_context =\n@@ -104,8 +83,8 @@ TEST(ChainedUserContextTest, DebugString) {\n   UserContextRef chained_context =\n       ChainedUserContext::Create({context1, UserContextRef(), context2});\n   EXPECT_EQ(chained_context->DebugString(),\n-            \"user context 100\\n\\n ->\\n\\n(nullptr user context)\\n\\n ->\\n\\nuser \"\n-            \"context 200\");\n+            \"TestUserContext(100)\\n\\n ->\\n\\n(nullptr user context)\\n\\n \"\n+            \"->\\n\\nTestUserContext(200)\");\n }\n \n TEST(FusedUserContextTest, Id) {\n@@ -127,8 +106,8 @@ TEST(FusedUserContextTest, DebugString) {\n   UserContextRef fused_context =\n       FusedUserContext::Create({context1, UserContextRef(), context2});\n   EXPECT_EQ(fused_context->DebugString(),\n-            \"Fused user context: {\\n\\nuser context 100\\n\\n(nullptr user \"\n-            \"context)\\n\\nuser context 200\\n\\n}\");\n+            \"Fused user context: {\\n\\nTestUserContext(100)\\n\\n(nullptr user \"\n+            \"context)\\n\\nTestUserContext(200)\\n\\n}\");\n }\n \n TEST(UserContextScopeTest, NullContext) {"
        },
        {
            "sha": "e2b02b74cce21b14feb630fcbfda2b89120bf86c",
            "filename": "third_party/xla/xla/python/ifrt/user_context_test_util.h",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d7915b51e056f1cb72b6fc66a670f6d3db5578c5/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test_util.h?ref=d7915b51e056f1cb72b6fc66a670f6d3db5578c5",
            "patch": "@@ -0,0 +1,52 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PYTHON_IFRT_USER_CONTEXT_TEST_UTIL_H_\n+#define XLA_PYTHON_IFRT_USER_CONTEXT_TEST_UTIL_H_\n+\n+#include <string>\n+\n+#include \"absl/strings/str_cat.h\"\n+#include \"llvm/Support/ExtensibleRTTI.h\"\n+#include \"xla/python/ifrt/user_context.h\"\n+#include \"xla/tsl/concurrency/ref_count.h\"\n+\n+namespace xla {\n+namespace ifrt {\n+\n+class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n+ public:\n+  static UserContextRef Create(UserContextId id) {\n+    return tsl::TakeRef<TestUserContext>(new TestUserContext(id));\n+  }\n+\n+  UserContextId Id() const override { return id_; }\n+\n+  std::string DebugString() const override {\n+    return absl::StrCat(\"TestUserContext(\", id_.value(), \")\");\n+  }\n+\n+  // No new `ID` is not defined because tests below do not exercise RTTI.\n+\n+ private:\n+  explicit TestUserContext(UserContextId id) : id_(id) {}\n+\n+  UserContextId id_;\n+};\n+\n+}  // namespace ifrt\n+}  // namespace xla\n+\n+#endif  // XLA_PYTHON_IFRT_USER_CONTEXT_TEST_UTIL_H_"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 83,
        "deletions": 108
    }
}