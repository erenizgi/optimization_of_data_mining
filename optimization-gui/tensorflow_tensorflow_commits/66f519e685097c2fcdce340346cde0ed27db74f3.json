{
    "author": "d4n1elchen",
    "message": "[HLO Diff] Cache results in `ComputeTextDiff` and fix side parameter in HLO rendering.\n\nPiperOrigin-RevId: 809237676",
    "sha": "66f519e685097c2fcdce340346cde0ed27db74f3",
    "files": [
        {
            "sha": "3f1976382eee8be78e6dac2e2d5244004ea3c197",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/utils/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/66f519e685097c2fcdce340346cde0ed27db74f3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/66f519e685097c2fcdce340346cde0ed27db74f3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2FBUILD?ref=66f519e685097c2fcdce340346cde0ed27db74f3",
            "patch": "@@ -77,7 +77,8 @@ cc_library(\n     srcs = [\"text_diff.cc\"],\n     hdrs = [\"text_diff.h\"],\n     deps = [\n-        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/strings:string_view\",\n     ],\n )"
        },
        {
            "sha": "d5432f7067800c7e197455dffdbf227bedc4674b",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/utils/text_diff.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/66f519e685097c2fcdce340346cde0ed27db74f3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2Ftext_diff.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/66f519e685097c2fcdce340346cde0ed27db74f3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2Ftext_diff.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Futils%2Ftext_diff.cc?ref=66f519e685097c2fcdce340346cde0ed27db74f3",
            "patch": "@@ -17,8 +17,11 @@ limitations under the License.\n \n #include <algorithm>\n #include <string>\n+#include <utility>\n #include <vector>\n \n+#include \"absl/base/no_destructor.h\"\n+#include \"absl/container/flat_hash_map.h\"\n #include \"absl/strings/string_view.h\"\n namespace xla::hlo_diff {\n \n@@ -147,9 +150,18 @@ void ComputeDiffRecursive(absl::string_view left, absl::string_view right,\n \n std::vector<TextDiffChunk> ComputeTextDiff(absl::string_view left,\n                                            absl::string_view right) {\n+  static absl::NoDestructor<absl::flat_hash_map<\n+      std::pair<std::string, std::string>, std::vector<TextDiffChunk>>>\n+      cache;\n+  std::pair<std::string, std::string> key{std::string(left),\n+                                          std::string(right)};\n+  auto it = cache->find(key);\n+  if (it != cache->end()) {\n+    return it->second;\n+  }\n   std::vector<TextDiffChunk> diff_chunks;\n   ComputeDiffRecursive(left, right, diff_chunks);\n-  return diff_chunks;\n+  return cache->emplace(key, diff_chunks).first->second;\n }\n \n }  // namespace xla::hlo_diff"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 15,
        "deletions": 2
    }
}