{
    "author": "tensorflower-gardener",
    "message": "gRPC host-buffer transfers in IFRT Proxy: allow users to limit maximum number of ongoing transfers.\n\nPiperOrigin-RevId: 798291255",
    "sha": "07e15e553104ec393e468623f5a528f3b4f85505",
    "files": [
        {
            "sha": "bb0d8afb3463700fce3a3d406e935e034de3ff2b",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD?ref=07e15e553104ec393e468623f5a528f3b4f85505",
            "patch": "@@ -485,7 +485,9 @@ cc_library(\n     srcs = [\"grpc_host_buffer.cc\"],\n     hdrs = [\"grpc_host_buffer.h\"],\n     deps = [\n+        \":global_flags\",\n         \":host_buffer\",\n+        \"//xla/pjrt:semaphore\",\n         \"//xla/pjrt/distributed:util\",\n         \"//xla/python/ifrt\",\n         \"//xla/python/ifrt_proxy/common:grpc_ifrt_service_cc_grpc_proto\","
        },
        {
            "sha": "6b68f40d910e42a768fb98f78bd179afb96ef07e",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/global_flags.h",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags.h?ref=07e15e553104ec393e468623f5a528f3b4f85505",
            "patch": "@@ -36,6 +36,10 @@ struct GlobalClientFlags {\n \n   // TODO(b/393445969): Implement faster is_delete without needing a hack.\n   bool array_is_deleted_hack;\n+\n+  // Zero or negative values are interpreted as no maximum.\n+  int grpc_max_ongoing_host_buffer_stores;\n+  int grpc_max_ongoing_host_buffer_lookups;\n };\n \n GlobalClientFlags* GetGlobalClientFlags();\n@@ -44,7 +48,11 @@ inline std::ostream& operator<<(std::ostream& os, GlobalClientFlags flags) {\n   return os << \"xla::ifrt::proxy::GlobalClientFlags{\"\n             << \"synchronous_host_buffer_store=\"\n             << flags.synchronous_host_buffer_store << \",\"\n-            << \"array_is_deleted_hack=\" << flags.array_is_deleted_hack << \"}\";\n+            << \"array_is_deleted_hack=\" << flags.array_is_deleted_hack << \",\"\n+            << \"grpc_max_ongoing_host_buffer_stores=\"\n+            << flags.grpc_max_ongoing_host_buffer_stores << \",\"\n+            << \"grpc_max_ongoing_host_buffer_lookups=\"\n+            << flags.grpc_max_ongoing_host_buffer_lookups << \"}\";\n }\n \n }  // namespace proxy"
        },
        {
            "sha": "537fc8441705030b815955a61348aca28dec7fb3",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/global_flags_oss.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags_oss.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags_oss.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags_oss.cc?ref=07e15e553104ec393e468623f5a528f3b4f85505",
            "patch": "@@ -37,13 +37,27 @@ bool GetBoolFromEnv(const char* key) {\n   return false;\n }\n \n+int GetIntFromEnv(const char* key) {\n+  if (const char* valptr = std::getenv(key)) {\n+    std::string val(valptr);\n+    int result;\n+    QCHECK(absl::SimpleAtoi(val, &result)) << \" \" << key << \": '\" << val << \"'\";\n+    return result;\n+  }\n+  return false;\n+}\n+\n }  // namespace\n \n static GlobalClientFlags DefaultGlobalClientFlags() {\n   GlobalClientFlags result;\n   result.synchronous_host_buffer_store = false;\n   result.array_is_deleted_hack =\n       GetBoolFromEnv(\"IFRT_PROXY_ARRAY_IS_DELETED_HACK\");\n+  result.grpc_max_ongoing_host_buffer_stores =\n+      GetIntFromEnv(\"IFRT_PROXY_GRPC_MAX_ONGOING_HOST_BUFFER_STORES\");\n+  result.grpc_max_ongoing_host_buffer_lookups =\n+      GetIntFromEnv(\"IFRT_PROXY_GRPC_MAX_ONGOING_HOST_BUFFER_LOOKUPS\");\n   return result;\n };\n "
        },
        {
            "sha": "0f5daeadde358eda0bd92991dfe9387fa7481382",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/grpc_host_buffer.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 3,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc?ref=07e15e553104ec393e468623f5a528f3b4f85505",
            "patch": "@@ -16,6 +16,7 @@\n \n #include <cstdint>\n #include <memory>\n+#include <optional>\n #include <string>\n #include <utility>\n \n@@ -30,7 +31,9 @@\n #include \"grpcpp/support/status.h\"\n #include \"grpcpp/support/sync_stream.h\"\n #include \"xla/pjrt/distributed/util.h\"\n+#include \"xla/pjrt/semaphore.h\"\n #include \"xla/python/ifrt/future.h\"\n+#include \"xla/python/ifrt_proxy/client/global_flags.h\"\n #include \"xla/python/ifrt_proxy/common/grpc_ifrt_service.grpc.pb.h\"\n #include \"xla/python/ifrt_proxy/common/grpc_ifrt_service.pb.h\"\n #include \"xla/python/ifrt_proxy/common/prof_util.h\"\n@@ -54,14 +57,33 @@ static void SetDataFromStringView(GrpcHostBufferStoreRequest& req,\n #endif\n }\n \n+static std::shared_ptr<xla::Semaphore::ScopedReservation>\n+ScopedAcquireSemaphore(std::optional<xla::Semaphore>& semaphore) {\n+  if (!semaphore.has_value()) {\n+    return nullptr;\n+  }\n+  auto reservation = semaphore->ScopedAcquire(1);\n+  return std::make_shared<xla::Semaphore::ScopedReservation>(\n+      std::move(reservation));\n+}\n+\n GrpcClientHostBufferStore::GrpcClientHostBufferStore(\n     std::shared_ptr<grpc::GrpcIfrtService::StubInterface> stub,\n     IfrtProxyVersion version, uint64_t session_id)\n     : stub_(std::move(stub)),\n       version_(std::move(version)),\n       session_id_(session_id),\n       work_queue_(std::make_unique<tsl::UnboundedWorkQueue>(\n-          tsl::Env::Default(), \"HostBufferStoreLookupsWorkQueue\")) {}\n+          tsl::Env::Default(), \"HostBufferStoreLookupsWorkQueue\")) {\n+  if (GetGlobalClientFlags()->grpc_max_ongoing_host_buffer_stores > 0) {\n+    store_throttler_.emplace(\n+        GetGlobalClientFlags()->grpc_max_ongoing_host_buffer_stores);\n+  }\n+  if (GetGlobalClientFlags()->grpc_max_ongoing_host_buffer_lookups > 0) {\n+    lookup_throttler_.emplace(\n+        GetGlobalClientFlags()->grpc_max_ongoing_host_buffer_lookups);\n+  }\n+}\n \n GrpcClientHostBufferStore::~GrpcClientHostBufferStore() {\n   LOG(INFO) << \"Waiting for destruction of HostBufferStoreLookupsWorkQueue...\";\n@@ -78,7 +100,9 @@ Future<> GrpcClientHostBufferStore::Store(uint64_t handle,\n \n   std::unique_ptr<std::string> buffered_data;\n \n-  work_queue_->Schedule([this, handle, promise, data, flow]() mutable -> void {\n+  auto reservation = ScopedAcquireSemaphore(store_throttler_);\n+  work_queue_->Schedule([this, reservation = std::move(reservation), handle,\n+                         promise, data, flow]() mutable -> void {\n     auto span = flow.Span<XFlowHelper::kRecv>();\n     GrpcHostBufferStoreMetadata metadata;\n     metadata.set_session_id(session_id_);\n@@ -138,6 +162,8 @@ Future<> GrpcClientHostBufferStore::Store(uint64_t handle,\n   context.AddMetadata(\"ifrt-proxy-grpc-host-buffer-store-metadata-bin\",\n                       metadata.SerializeAsString());\n \n+  auto reservation = ScopedAcquireSemaphore(store_throttler_);\n+\n   GrpcHostBufferStoreResponse response;\n   auto writer = stub_->HostBufferStore(&context, &response);\n \n@@ -172,7 +198,9 @@ Future<absl::Cord> GrpcClientHostBufferStore::Lookup(uint64_t handle) {\n   XFlowHelper flow(\"GrpcClientHostBufferStore::Lookup\");\n   flow.InstantActivity<XFlowHelper::kSend>();\n \n-  work_queue_->Schedule([this, handle, promise, flow]() mutable -> void {\n+  auto reservation = ScopedAcquireSemaphore(lookup_throttler_);\n+  work_queue_->Schedule([this, reservation = std::move(reservation), handle,\n+                         promise, flow]() mutable -> void {\n     auto span = flow.Span<XFlowHelper::kRecv>();\n     GrpcHostBufferLookupRequest request;\n     request.set_handle(handle);"
        },
        {
            "sha": "fa89a8a9191d3ec6b623277c63ef650d22915263",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/grpc_host_buffer.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07e15e553104ec393e468623f5a528f3b4f85505/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.h?ref=07e15e553104ec393e468623f5a528f3b4f85505",
            "patch": "@@ -19,9 +19,11 @@\n \n #include <cstdint>\n #include <memory>\n+#include <optional>\n \n #include \"absl/strings/cord.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"xla/pjrt/semaphore.h\"\n #include \"xla/python/ifrt/future.h\"\n #include \"xla/python/ifrt_proxy/client/host_buffer.h\"\n #include \"xla/python/ifrt_proxy/common/grpc_ifrt_service.grpc.pb.h\"\n@@ -58,6 +60,9 @@ class GrpcClientHostBufferStore : public ClientHostBufferStore {\n   // RPC reads or writes, and then to do `promise.Set()` for the Future returned\n   // to the caller.\n   std::unique_ptr<tsl::UnboundedWorkQueue> work_queue_;\n+\n+  std::optional<xla::Semaphore> store_throttler_;\n+  std::optional<xla::Semaphore> lookup_throttler_;\n };\n \n }  // namespace proxy"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 61,
        "deletions": 4
    }
}