{
    "author": "jaro-sevcik",
    "message": "PR #32905: Allow mixed precision operands for async collective permute\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32905\n\nüìù Summary of Changes\nAllow mixed precision asynchronous collective-permute in the verifier.\n\nüéØ Justification\nFixes https://github.com/openxla/xla/issues/32845\n\nüöÄ Kind of Contribution\nüêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nN/A\n\nüß™ Unit Tests:\nTests that verifier passes on mixed precision collective-permute-start and collective-permute-done.\n\nüß™ Execution Tests:\nManually testes the JAX repro from https://github.com/openxla/xla/issues/32845\nCopybara import of the project:\n\n--\nf44faa7ce7ecfbd810983cae170a118bb19a8bb3 by Jaroslav Sevcik <jsevcik@nvidia.com>:\n\nAllow mixed precision operands for async collective permute\n\nMerging this change closes #32905\n\nPiperOrigin-RevId: 822023349",
    "sha": "735f4bb631f9dfb5ca09f922679b00deb4e80d14",
    "files": [
        {
            "sha": "25a3c8e24c3c156bc779f3595188e36175c7af5c",
            "filename": "third_party/xla/xla/service/hlo_verifier.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/735f4bb631f9dfb5ca09f922679b00deb4e80d14/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/735f4bb631f9dfb5ca09f922679b00deb4e80d14/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc?ref=735f4bb631f9dfb5ca09f922679b00deb4e80d14",
            "patch": "@@ -1915,6 +1915,8 @@ absl::Status CheckMixedPrecisionOperands(const HloInstruction* instruction) {\n     case HloOpcode::kAsyncDone:\n     case HloOpcode::kAsyncUpdate:\n     case HloOpcode::kAsyncStart:\n+    case HloOpcode::kCollectivePermuteStart:\n+    case HloOpcode::kCollectivePermuteDone:\n     case HloOpcode::kCopyDone:\n     case HloOpcode::kCopyStart:\n     case HloOpcode::kCustomCall:"
        },
        {
            "sha": "546fdc7105a1a785798b0cafe64fe79924cada46",
            "filename": "third_party/xla/xla/service/hlo_verifier_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/735f4bb631f9dfb5ca09f922679b00deb4e80d14/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/735f4bb631f9dfb5ca09f922679b00deb4e80d14/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc?ref=735f4bb631f9dfb5ca09f922679b00deb4e80d14",
            "patch": "@@ -2242,6 +2242,25 @@ TEST_F(HloVerifierTest, CollectivePermuteCrossPartitionTargetOOR) {\n   EXPECT_THAT(error_message, HasSubstr(\"must be < 3\"));\n }\n \n+TEST_F(HloVerifierTest, CollectivePermuteAsyncMixedPrecisionOperandsAllowed) {\n+  const char* const kModuleStr = R\"(\n+    HloModule test\n+    ENTRY entry {\n+      p0 = f32[128] parameter(0)\n+      p1 = bf16[128] parameter(1)\n+      permute-start = ((f32[128], bf16[128]), (f32[128], bf16[128])) collective-permute-start(p0, p1),\n+        source_target_pairs={{0,1}, {1,0}}, channel_id=1\n+      ROOT permute-done = (f32[128], bf16[128]) collective-permute-done(permute-start)\n+    }\n+    )\";\n+  HloModuleConfig config;\n+  config.set_num_partitions(2);\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnUnverifiedModule(kModuleStr, config));\n+  auto status = verifier().Run(module.get()).status();\n+  ASSERT_TRUE(status.ok());\n+}\n+\n TEST_F(HloVerifierTest, FusionMoreOperandsThanParameters) {\n   const char* const kModuleStr = R\"(\n   HloModule test"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 21,
        "deletions": 0
    }
}