{
    "author": "ezhulenev",
    "message": "[xla:cpu] Wait for all scheduled kernels to be ready before destroying ParallelFusionEmitter\n\nPiperOrigin-RevId: 816213030",
    "sha": "672d82fde5a05841aae09c651eb9a1e2e65a664f",
    "files": [
        {
            "sha": "71291804f37e311e1d5bb221956e3a06906391f7",
            "filename": "third_party/xla/xla/service/cpu/parallel_fusion_emitter.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/672d82fde5a05841aae09c651eb9a1e2e65a664f/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/672d82fde5a05841aae09c651eb9a1e2e65a664f/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc?ref=672d82fde5a05841aae09c651eb9a1e2e65a664f",
            "patch": "@@ -149,7 +149,12 @@ ParallelFusionEmitter::ParallelFusionEmitter(\n       buffer_assignment_(buffer_assignment),\n       use_unique_c_name_(use_unique_c_name) {}\n \n-ParallelFusionEmitter::~ParallelFusionEmitter() = default;\n+ParallelFusionEmitter::~ParallelFusionEmitter() {\n+  absl::MutexLock lock(kernels_mutex_);\n+  kernels_mutex_.Await(absl::Condition(\n+      +[](int64_t* outstanding_kernels) { return *outstanding_kernels == 0; },\n+      &outstanding_kernels_));\n+}\n \n absl::StatusOr<KernelSpec> ParallelFusionEmitter::AddFusion(\n     const HloFusionInstruction* fusion) {"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 6,
        "deletions": 1
    }
}