{
    "author": "bmass02",
    "message": "Add a DenormalizeTimestamps method to denormalize subprocess' xplanes so they can be normalized with parent xplanes.\n\nPiperOrigin-RevId: 816451159",
    "sha": "f687e762d71000a1e4b5e69060d6f471604fca63",
    "files": [
        {
            "sha": "4c18933e50fc020e14db4fe940e067685fa20e95",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_utils.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f687e762d71000a1e4b5e69060d6f471604fca63/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f687e762d71000a1e4b5e69060d6f471604fca63/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.cc?ref=f687e762d71000a1e4b5e69060d6f471604fca63",
            "patch": "@@ -330,6 +330,20 @@ void NormalizeTimestamps(XSpace* space, uint64 start_time_ns) {\n   }\n }\n \n+void DenormalizeTimestamps(XPlane* plane, uint64 start_time_ns) {\n+  for (XLine& line : *plane->mutable_lines()) {\n+    if (line.timestamp_ns() < static_cast<int64_t>(start_time_ns)) {\n+      line.set_timestamp_ns(line.timestamp_ns() + start_time_ns);\n+    }\n+  }\n+}\n+\n+void DenormalizeTimestamps(XSpace* space, uint64 start_time_ns) {\n+  for (XPlane& plane : *space->mutable_planes()) {\n+    DenormalizeTimestamps(&plane, start_time_ns);\n+  }\n+}\n+\n void MergePlanes(const XPlane& src_plane, XPlane* dst_plane) {\n   RemoveEmptyLines(dst_plane);\n   XPlaneVisitor src(&src_plane);"
        },
        {
            "sha": "d1eb817305fd9f1ce4e85f636576249c9252163e",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_utils.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f687e762d71000a1e4b5e69060d6f471604fca63/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f687e762d71000a1e4b5e69060d6f471604fca63/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils.h?ref=f687e762d71000a1e4b5e69060d6f471604fca63",
            "patch": "@@ -156,6 +156,10 @@ std::vector<Event> GetSortedEvents(Plane& plane,\n void NormalizeTimestamps(XPlane* plane, uint64 start_time_ns);\n void NormalizeTimestamps(XSpace* space, uint64 start_time_ns);\n \n+// Denormalize timestamps by time-shifting to 0 as origin.\n+void DenormalizeTimestamps(XPlane* plane, uint64 start_time_ns);\n+void DenormalizeTimestamps(XSpace* space, uint64 start_time_ns);\n+\n // Merges src_plane into dst_plane. Both plane level stats, lines, events and\n // event level stats are merged. If src_plane and dst_plane both have the same\n // line, which have different start timestamps, we will normalize the events"
        },
        {
            "sha": "a283f8e78143ca6e9cf3e986f92db03b5c8d9449",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_utils_test.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f687e762d71000a1e4b5e69060d6f471604fca63/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f687e762d71000a1e4b5e69060d6f471604fca63/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_utils_test.cc?ref=f687e762d71000a1e4b5e69060d6f471604fca63",
            "patch": "@@ -884,6 +884,37 @@ TEST(XplaneUtilsTest, XPlaneGroupingPropagatesGroupId) {\n   });\n }\n \n+TEST(XplaneUtilsTest, TestNormalizeTimestamps) {\n+  XSpace xspace;\n+  XPlaneBuilder host(xspace.add_planes());\n+  host.SetName(\"/host:CPU\");\n+  auto l1 = CreateXLine(&host, \"l1\", \"d1\", 1, 100);\n+  auto e1 = CreateXEvent(&host, l1, \"event1\", \"display1\", 1, 2);\n+  CreateXStats(&host, &e1, \"non_group_id\", 2.0);\n+  auto l2 = CreateXLine(&host, \"l2\", \"d2\", 1, 100);\n+  auto e2 = CreateXEvent(&host, l2, \"event2\", \"display2\", 1, 2);\n+  CreateXStats(&host, &e2, \"non_group_id\", 2.0);\n+  NormalizeTimestamps(&xspace, 90);\n+  EXPECT_EQ(l1.TimestampNs(), 10);\n+  EXPECT_EQ(l2.TimestampNs(), 10);\n+}\n+\n+TEST(XplaneUtilsTest, TestDenormalizeTimestamps) {\n+  XSpace xspace;\n+  XPlaneBuilder host(xspace.add_planes());\n+  host.SetName(\"/host:CPU\");\n+  auto l1 = CreateXLine(&host, \"l1\", \"d1\", 1, 100);\n+  auto e1 = CreateXEvent(&host, l1, \"event1\", \"display1\", 1, 2);\n+  CreateXStats(&host, &e1, \"non_group_id\", 2.0);\n+  auto l2 = CreateXLine(&host, \"l2\", \"d2\", 1, 100);\n+  auto e2 = CreateXEvent(&host, l2, \"event2\", \"display2\", 1, 2);\n+  CreateXStats(&host, &e2, \"non_group_id\", 2.0);\n+  NormalizeTimestamps(&xspace, 90);\n+  DenormalizeTimestamps(&xspace, 90);\n+  EXPECT_EQ(l1.TimestampNs(), 100);\n+  EXPECT_EQ(l2.TimestampNs(), 100);\n+}\n+\n }  // namespace\n }  // namespace profiler\n }  // namespace tsl"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 49,
        "deletions": 0
    }
}