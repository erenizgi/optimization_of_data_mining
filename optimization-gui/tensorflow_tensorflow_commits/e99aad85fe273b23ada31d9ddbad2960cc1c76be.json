{
    "author": "ezhulenev",
    "message": "[xla:codegen] Cleanup MlirKernelSource APIs\n\nPiperOrigin-RevId: 825795569",
    "sha": "e99aad85fe273b23ada31d9ddbad2960cc1c76be",
    "files": [
        {
            "sha": "b2554f7ad28023c51eac8a58c68e21c05c3b6bd3",
            "filename": "third_party/xla/xla/backends/gpu/codegen/emitters/concatenate.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fconcatenate.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fconcatenate.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fconcatenate.cc?ref=e99aad85fe273b23ada31d9ddbad2960cc1c76be",
            "patch": "@@ -87,7 +87,7 @@ ConcatenateFusion::CreateMLIRModule(\n       BackendKind::kGpu);\n \n   TF_ASSIGN_OR_RETURN(auto kernel_definition, emitter.EmitKernelDefinition());\n-  return std::move(kernel_definition).TakeSource().ReleaseStorage().module;\n+  return std::move(kernel_definition).TakeSource().TakeModule();\n }\n \n absl::Status ConcatenateFusion::EmitEntryFunction("
        },
        {
            "sha": "18e4c35e5693624b38e73db142d6990f69a3862e",
            "filename": "third_party/xla/xla/backends/gpu/codegen/emitters/in_place_dynamic_update_slice.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fin_place_dynamic_update_slice.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fin_place_dynamic_update_slice.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fin_place_dynamic_update_slice.cc?ref=e99aad85fe273b23ada31d9ddbad2960cc1c76be",
            "patch": "@@ -105,7 +105,7 @@ InPlaceDynamicUpdateSliceFusion::CreateMLIRModule(\n       BackendKind::kGpu);\n \n   TF_ASSIGN_OR_RETURN(auto kernel_definition, emitter.EmitKernelDefinition());\n-  return std::move(kernel_definition).TakeSource().ReleaseStorage().module;\n+  return std::move(kernel_definition).TakeSource().TakeModule();\n }\n \n absl::Status InPlaceDynamicUpdateSliceFusion::EmitEntryFunction("
        },
        {
            "sha": "bdc71d02127a91a8ac11537f27e1e3419a70951c",
            "filename": "third_party/xla/xla/backends/gpu/codegen/emitters/loop.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Floop.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Floop.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Floop.cc?ref=e99aad85fe273b23ada31d9ddbad2960cc1c76be",
            "patch": "@@ -116,7 +116,7 @@ absl::StatusOr<mlir::OwningOpRef<mlir::ModuleOp>> LoopFusion::CreateMLIRModule(\n       BackendKind::kGpu);\n \n   TF_ASSIGN_OR_RETURN(auto kernel_definition, emitter.EmitKernelDefinition());\n-  return std::move(kernel_definition).TakeSource().ReleaseStorage().module;\n+  return std::move(kernel_definition).TakeSource().TakeModule();\n }\n \n absl::Status LoopFusion::EmitEntryFunction("
        },
        {
            "sha": "b32acf7e45a5a16bb85cd96614e372cc460feea7",
            "filename": "third_party/xla/xla/codegen/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD?ref=e99aad85fe273b23ada31d9ddbad2960cc1c76be",
            "patch": "@@ -126,6 +126,7 @@ cc_library(\n         \":kernel_source\",\n         \"//xla:util\",\n         \"//xla/hlo/analysis:symbolic_expr\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@llvm-project//llvm:Support\","
        },
        {
            "sha": "20501ff9306c17785800135acd5f7b65c0e4ba55",
            "filename": "third_party/xla/xla/codegen/mlir_kernel_source.h",
            "status": "modified",
            "additions": 18,
            "deletions": 17,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fcodegen%2Fmlir_kernel_source.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e99aad85fe273b23ada31d9ddbad2960cc1c76be/third_party%2Fxla%2Fxla%2Fcodegen%2Fmlir_kernel_source.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fmlir_kernel_source.h?ref=e99aad85fe273b23ada31d9ddbad2960cc1c76be",
            "patch": "@@ -20,13 +20,13 @@ limitations under the License.\n #include <string>\n #include <utility>\n \n+#include \"absl/log/check.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"mlir/IR/BuiltinOps.h\"\n #include \"mlir/IR/MLIRContext.h\"\n #include \"mlir/IR/OwningOpRef.h\"\n #include \"mlir/Support/DebugStringHelper.h\"\n-#include \"xla/codegen/kernel_definition.h\"\n #include \"xla/codegen/kernel_source.h\"\n #include \"xla/hlo/analysis/symbolic_expr.h\"\n \n@@ -41,44 +41,45 @@ namespace xla {\n // compiler.\n class MlirKernelSource final : public KernelSource {\n  public:\n-  struct Storage {\n-    std::unique_ptr<mlir::MLIRContext> mlir_context;\n-    std::unique_ptr<SymbolicExprContext> symbolic_expr_context;\n-    mlir::OwningOpRef<mlir::ModuleOp> module;\n-  };\n-\n   // Construct a MLIR kernel source from a module and take ownership of its MLIR\n   // context.\n   MlirKernelSource(std::unique_ptr<mlir::MLIRContext> mlir_context,\n                    std::unique_ptr<SymbolicExprContext> symbolic_expr_context,\n                    mlir::OwningOpRef<mlir::ModuleOp> module)\n-      : storage_{std::move(mlir_context), std::move(symbolic_expr_context),\n-                 std::move(module)} {}\n+      : mlir_context_(std::move(mlir_context)),\n+        symbolic_expr_context_(std::move(symbolic_expr_context)),\n+        module_(std::move(module)) {}\n \n   // Construct a MLIR kernel source from a module but don't take any ownership\n   // of the MLIR context.\n   explicit MlirKernelSource(mlir::OwningOpRef<mlir::ModuleOp> module)\n-      : storage_{nullptr, nullptr, std::move(module)} {}\n+      : MlirKernelSource(nullptr, nullptr, std::move(module)) {}\n \n   MlirKernelSource(MlirKernelSource&& other) noexcept = default;\n   MlirKernelSource& operator=(MlirKernelSource&& other) noexcept = default;\n \n   static absl::StatusOr<MlirKernelSource> ParseFromString(\n       absl::string_view ir, std::unique_ptr<mlir::MLIRContext> context);\n \n-  mlir::ModuleOp module() { return *storage_.module; }\n+  mlir::ModuleOp module() { return *module_; }\n+\n   SymbolicExprContext* symbolic_expr_context() {\n-    return storage_.symbolic_expr_context.get();\n+    return symbolic_expr_context_.get();\n   }\n \n-  Storage ReleaseStorage() && { return std::move(storage_); }\n-\n-  std::string ToString() const final {\n-    return mlir::debugString(*storage_.module);\n+  // Moves ownership of the module to the caller.\n+  mlir::OwningOpRef<mlir::ModuleOp> TakeModule() && {\n+    DCHECK(mlir_context_ == nullptr && symbolic_expr_context_ == nullptr)\n+        << \"Can't move ownership of the module owned by the MlirKernelSource\";\n+    return std::move(module_);\n   }\n \n+  std::string ToString() const final { return mlir::debugString(*module_); }\n+\n  private:\n-  Storage storage_;\n+  std::unique_ptr<mlir::MLIRContext> mlir_context_;\n+  std::unique_ptr<SymbolicExprContext> symbolic_expr_context_;\n+  mlir::OwningOpRef<mlir::ModuleOp> module_;\n };\n \n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 22,
        "deletions": 20
    }
}