{
    "author": "Varcho",
    "message": "[ReplicaGroupV3][Validation] add overlap check for axes in v3 replica group.\n\nPiperOrigin-RevId: 828200504",
    "sha": "892d5b29669de5603cbb2ca3656bf8ef5cdbf825",
    "files": [
        {
            "sha": "50b3409b8513a169d00d611e536aec688b9c7b98",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.cc?ref=892d5b29669de5603cbb2ca3656bf8ef5cdbf825",
            "patch": "@@ -232,4 +232,32 @@ bool AxisRef::CanCoexist(const AxisRef& other) const {\n                            max_next_pre_size);\n }\n \n+bool AxisRef::Overlaps(const AxisRef& other) const {\n+  if (mesh_axis_index() != other.mesh_axis_index()) {\n+    return false;\n+  }\n+\n+  // If one is a full axis then they must overlap.\n+  if (!sub_axis_info_.has_value() || !other.sub_axis_info_.has_value()) {\n+    return true;\n+  }\n+\n+  const SubAxis& this_sub_axis = sub_axis_info_.value();\n+  const SubAxis& other_sub_axis = other.sub_axis_info_.value();\n+\n+  return this_sub_axis.pre_size < other_sub_axis.next_pre_size() &&\n+         other_sub_axis.pre_size < this_sub_axis.next_pre_size();\n+}\n+\n+bool ValidateSpanOfAxes(absl::Span<const AxisRef> axes) {\n+  for (int64_t i = 0; i < axes.size() - 1; ++i) {\n+    for (int64_t j = i + 1; j < axes.size(); ++j) {\n+      if (!axes[i].CanCoexist(axes[j]) || axes[i].Overlaps(axes[j])) {\n+        return false;\n+      }\n+    }\n+  }\n+  return true;\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "ea0350975822eb84f8cb92c3371cdb759ef5b2a5",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h?ref=892d5b29669de5603cbb2ca3656bf8ef5cdbf825",
            "patch": "@@ -177,6 +177,8 @@ class AxisRef {\n \n   bool CanCoexist(const AxisRef& other) const;\n \n+  bool Overlaps(const AxisRef& other) const;\n+\n   // Validates that the given mesh is compatible for this axis ref.\n   absl::Status Validate(const Mesh& mesh) const;\n   int64_t mesh_axis_index() const { return mesh_axis_index_; }\n@@ -186,6 +188,8 @@ class AxisRef {\n   absl::Status ValidateAxisRef();\n };\n \n+bool ValidateSpanOfAxes(absl::Span<const AxisRef> axes);\n+\n }  // namespace xla\n \n #endif  // XLA_HLO_IR_MESH_AND_AXIS_H_"
        },
        {
            "sha": "3df9ccbc03554353bb8539611cf6db1f5b13ba9f",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis_test.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc?ref=892d5b29669de5603cbb2ca3656bf8ef5cdbf825",
            "patch": "@@ -246,4 +246,46 @@ TEST(MeshAndAxisTest, ValidateAxisForMesh) {\n       \"Sub-axis size must be strictly less than the full axis size\");\n }\n \n+TEST(MeshAndAxisTest, AxisRefCanCoexist) {\n+  auto canCoexist = [](AxisRef a, AxisRef b, bool expected) {\n+    EXPECT_EQ(a.CanCoexist(b), expected);\n+    EXPECT_EQ(b.CanCoexist(a), expected);\n+  };\n+\n+  canCoexist(AxisRef(0), AxisRef(1), true);\n+  canCoexist(AxisRef(0), AxisRef(1, {2, 2}), true);\n+  canCoexist(AxisRef(0), AxisRef(0), true);\n+  canCoexist(AxisRef(0), AxisRef(0, {2, 2}), true);\n+  canCoexist(AxisRef(0, {2, 2}), AxisRef(0, {2, 2}), true);\n+  canCoexist(AxisRef(0, {1, 2}), AxisRef(0, {1, 4}), true);\n+  canCoexist(AxisRef(0, {1, 2}), AxisRef(0, {2, 4}), true);\n+  canCoexist(AxisRef(0, {1, 2}), AxisRef(0, {6, 2}), true);\n+  canCoexist(AxisRef(0, {1, 4}), AxisRef(0, {2, 2}), true);\n+  canCoexist(AxisRef(0, {1, 4}), AxisRef(0, {2, 4}), true);\n+\n+  canCoexist(AxisRef(0, {1, 2}), AxisRef(0, {1, 3}), false);\n+  canCoexist(AxisRef(0, {1, 2}), AxisRef(0, {3, 2}), false);\n+  canCoexist(AxisRef(0, {1, 3}), AxisRef(0, {2, 3}), false);\n+}\n+\n+TEST(MeshAndAxisTest, AxisRefOverlaps) {\n+  auto overlaps = [](AxisRef a, AxisRef b, bool expected) {\n+    EXPECT_EQ(a.Overlaps(b), expected);\n+    EXPECT_EQ(b.Overlaps(a), expected);\n+  };\n+\n+  overlaps(AxisRef(0), AxisRef(0), true);\n+  overlaps(AxisRef(0, {2, 4}), AxisRef(0), true);\n+  overlaps(AxisRef(0, {2, 2}), AxisRef(0, {2, 2}), true);\n+  overlaps(AxisRef(0, {1, 4}), AxisRef(0, {2, 4}), true);\n+  overlaps(AxisRef(0, {2, 8}), AxisRef(0, {4, 2}), true);\n+  overlaps(AxisRef(2, {1, 4}), AxisRef(2, {1, 2}), true);\n+\n+  overlaps(AxisRef(0), AxisRef(1), false);\n+  overlaps(AxisRef(0), AxisRef(1, {1, 2}), false);\n+  overlaps(AxisRef(0, {1, 4}), AxisRef(0, {4, 2}), false);\n+  overlaps(AxisRef(0, {1, 4}), AxisRef(0, {8, 2}), false);\n+  overlaps(AxisRef(0, {4, 2}), AxisRef(0, {1, 2}), false);\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "ba32722829edd066c4eb5664bafb04de0872a461",
            "filename": "third_party/xla/xla/hlo/ir/replica_group.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/892d5b29669de5603cbb2ca3656bf8ef5cdbf825/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group.cc?ref=892d5b29669de5603cbb2ca3656bf8ef5cdbf825",
            "patch": "@@ -153,15 +153,13 @@ bool ValidateSingleDimensionAxes(int64_t dim, std::vector<AxisRef>& axes,\n   // --- Step 2: Overlap Check ---\n   // At this point, all remaining axes MUST have sub_axis_info().\n   // Verify that the remaining multiple sub-axes do not overlap.\n-  for (int64_t i = 0; i < axes.size() - 1; ++i) {\n-    for (int64_t j = i + 1; j < axes.size(); ++j) {\n-      // CHECK will terminate the program on failure, matching original\n-      // behavior.\n-      CHECK(axes[i].CanCoexist(axes[j]))\n-          << \"Overlapping sub-axes detected: \" << axes[i].ToString(mesh_)\n-          << \" and \" << axes[j].ToString(mesh_);\n-    }\n-  }\n+  CHECK(ValidateSpanOfAxes(axes))\n+      << \"Overlapping sub-axes detected in set of axes: \"\n+      << absl::StrJoin(axes, \",\",\n+                       [&mesh_](std::string* out, const AxisRef& axis) {\n+                         absl::StrAppend(out, axis.ToString(mesh_));\n+                       });\n+\n   return true;  // Passed all checks for this dimension.\n }\n "
        }
    ],
    "stats": {
        "total": 90,
        "additions": 81,
        "deletions": 9
    }
}