{
    "author": "tensorflower-gardener",
    "message": "[SymbolicMap] Implement Compose method using ReplaceDimAndSymbols\n\nPiperOrigin-RevId: 800047384",
    "sha": "09e02d34cd26fe27e59baa6022c34debb50b17e0",
    "files": [
        {
            "sha": "7094e31c3f6e32de7e7e0b1a30c4b1bf417586e9",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09e02d34cd26fe27e59baa6022c34debb50b17e0/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09e02d34cd26fe27e59baa6022c34debb50b17e0/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=09e02d34cd26fe27e59baa6022c34debb50b17e0",
            "patch": "@@ -29,6 +29,20 @@ limitations under the License.\n namespace xla {\n namespace gpu {\n \n+namespace {\n+\n+std::vector<SymbolicExpr> CreateVariableRange(SymbolicExprContext* ctx,\n+                                              int64_t n, int64_t offset = 0) {\n+  std::vector<SymbolicExpr> replacements;\n+  replacements.reserve(n);\n+  for (int64_t i = 0; i < n; ++i) {\n+    replacements.push_back(ctx->CreateVariable(offset + i));\n+  }\n+  return replacements;\n+}\n+\n+}  // namespace\n+\n SymbolicMap::SymbolicMap(SymbolicExprContext* ctx, int64_t num_dimensions,\n                          int64_t num_symbols, std::vector<SymbolicExpr> exprs)\n     : ctx_(ctx),\n@@ -96,6 +110,31 @@ SymbolicMap SymbolicMap::ReplaceDimsAndSymbols(\n                      std::move(new_exprs));\n }\n \n+SymbolicMap SymbolicMap::Compose(const SymbolicMap& other) const {\n+  CHECK_EQ(GetNumDims(), other.GetNumResults())\n+      << \"Number of dimensions of this map must match number of results of \"\n+         \"other map\";\n+  int64_t new_dims = other.GetNumDims();\n+  int64_t new_syms = GetNumSymbols() + other.GetNumSymbols();\n+\n+  // We need to reindex the dimensions of the other map.\n+  auto other_dim_replacements = CreateVariableRange(ctx_, other.GetNumDims());\n+  int64_t offset = new_dims;\n+  auto this_symbol_replacements =\n+      CreateVariableRange(ctx_, GetNumSymbols(), offset);\n+  offset += GetNumSymbols();\n+  auto other_sym_replacements =\n+      CreateVariableRange(ctx_, other.GetNumSymbols(), offset);\n+\n+  // First we reindex other map symbols.\n+  SymbolicMap updated_other = other.ReplaceDimsAndSymbols(\n+      other_dim_replacements, other_sym_replacements, new_dims, new_syms);\n+\n+  // Then we compose the maps.\n+  return ReplaceDimsAndSymbols(updated_other.GetResults(),\n+                               this_symbol_replacements, new_dims, new_syms);\n+}\n+\n bool SymbolicMap::operator==(const SymbolicMap& other) const {\n   return ctx_ == other.ctx_ && num_dimensions_ == other.num_dimensions_ &&\n          num_symbols_ == other.num_symbols_ && exprs_ == other.exprs_;"
        },
        {
            "sha": "8faea32df95f470efc4b5f3d508952bce5f38b9b",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09e02d34cd26fe27e59baa6022c34debb50b17e0/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09e02d34cd26fe27e59baa6022c34debb50b17e0/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=09e02d34cd26fe27e59baa6022c34debb50b17e0",
            "patch": "@@ -63,6 +63,22 @@ class SymbolicMap {\n       absl::Span<const SymbolicExpr> sym_replacements, int64_t num_result_dims,\n       int64_t num_result_symbols) const;\n \n+  // Composes this map with another map. The number of dimensions of this map\n+  // must match the number of results of the other map. The resulting map will\n+  // have the same number of dimensions as the other map, and the number of\n+  // symbols will be the sum of the number of symbols in both maps.\n+  //\n+  // The variables in the composed map are ordered as follows:\n+  // * dimensions of the other map\n+  // * symbols of this map\n+  // * symbols of the other map\n+  //\n+  // Example:\n+  // this: (d0, d1, s0) -> (d0 + s0, d1)\n+  // other: (d0, s0, s1) -> (d0 * 2 + 3 * s0, d0 + s1)\n+  // this.compose(other): (d0, s0, s1, s2) -> (d0 * 2 + 3 * s1 + s0, d0 + s2)\n+  SymbolicMap Compose(const SymbolicMap& other) const;\n+\n   bool operator==(const SymbolicMap& other) const;\n   bool operator!=(const SymbolicMap& other) const { return !(*this == other); }\n "
        },
        {
            "sha": "e99e96ad193c77bf9691abf72959c99c11726dce",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09e02d34cd26fe27e59baa6022c34debb50b17e0/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09e02d34cd26fe27e59baa6022c34debb50b17e0/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=09e02d34cd26fe27e59baa6022c34debb50b17e0",
            "patch": "@@ -113,6 +113,56 @@ TEST(SymbolicMapTest, ReplaceDimsAndSymbols) {\n               ElementsAre((new_d0 * c1 + new_d1) + new_s0 * c2));\n }\n \n+TEST(SymbolicMapTest, Compose) {\n+  SymbolicExprContext ctx;\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+\n+  // Composition without Symbols\n+  SymbolicMap map1_no_symbols = SymbolicMap::Get(&ctx, 1, 0, {d0 * 2});\n+  SymbolicMap map2_no_symbols = SymbolicMap::Get(&ctx, 1, 0, {d0 + 5});\n+  SymbolicMap composed_no_symbols = map1_no_symbols.Compose(map2_no_symbols);\n+  EXPECT_THAT(composed_no_symbols.GetResults(), ElementsAre((d0 + 5) * 2));\n+\n+  // Composition with Symbols\n+  SymbolicExpr s0_map1 = ctx.CreateVariable(/*map1_dims*/ 2);\n+  SymbolicExpr s0_map2 = ctx.CreateVariable(/*map2_dims*/ 1);\n+  SymbolicMap map1_symbols =\n+      SymbolicMap::Get(&ctx, 2, 1, {d0 + s0_map1, d1 * 2});\n+  SymbolicMap map2_symbols =\n+      SymbolicMap::Get(&ctx, 1, 1, {d0 - 10, d0 + s0_map2});\n+  SymbolicMap compose_with_symbols = map1_symbols.Compose(map2_symbols);\n+  EXPECT_EQ(compose_with_symbols.GetNumDims(), 1);\n+  EXPECT_EQ(compose_with_symbols.GetNumSymbols(), 2);\n+  SymbolicExpr new_d0 = d0;\n+  SymbolicExpr new_s0_map1 = ctx.CreateVariable(/*compose_dims*/ 1);\n+  SymbolicExpr new_s0_map2 =\n+      ctx.CreateVariable(/*compose_dims + map1_symbols.GetNumSymbols()*/ 2);\n+  EXPECT_THAT(\n+      compose_with_symbols.GetResults(),\n+      ElementsAre((new_d0 - 10) + new_s0_map1, (new_d0 + new_s0_map2) * 2));\n+\n+  // Composition with identity\n+  SymbolicMap id_2dim = SymbolicMap::Get(&ctx, 2, 0, {d0, d1});\n+  EXPECT_EQ(map1_symbols, map1_symbols.Compose(id_2dim));\n+\n+  SymbolicMap id_2dim_1sym = SymbolicMap::Get(&ctx, 2, 1, {d0, d1});\n+  SymbolicMap compose_with_id2dim_1sym = map1_symbols.Compose(id_2dim_1sym);\n+  EXPECT_EQ(compose_with_id2dim_1sym.GetNumSymbols(), 2);\n+  EXPECT_EQ(compose_with_id2dim_1sym.GetNumDims(), map1_symbols.GetNumDims());\n+  EXPECT_EQ(compose_with_id2dim_1sym.GetResults(), map1_symbols.GetResults());\n+\n+  SymbolicMap compose_left_with_id2dim_1sym =\n+      id_2dim_1sym.Compose(map1_symbols);\n+  EXPECT_EQ(compose_left_with_id2dim_1sym.GetNumDims(), 2);\n+  EXPECT_EQ(compose_left_with_id2dim_1sym.GetNumSymbols(), 2);\n+  SymbolicExpr reindexed_map1_s0 =\n+      ctx.CreateVariable(compose_left_with_id2dim_1sym.GetNumDims() +\n+                         id_2dim_1sym.GetNumSymbols());\n+  EXPECT_THAT(compose_left_with_id2dim_1sym.GetResults(),\n+              ElementsAre(d0 + reindexed_map1_s0, d1 * 2));\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 105,
        "deletions": 0
    }
}