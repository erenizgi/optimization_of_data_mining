{
    "author": "meteorcloudy",
    "message": "PR #32416: Fix a hack in rocm_device_libs that will break with Bzlmod\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32416\n\nWith the upcoming [Bzlmod](https://github.com/openxla/xla/pull/32055) build, `foo.runfiles/llvm-project/` becomes `foo.runfiles/_main~third_party~llvm-project/` due to the use of [canonical repo name](https://bazel.build/external/module#repository_names_and_strict_deps). Manually crafting such a path is strongly discouraged in Bzlmod.\n\nThis PR introduces clang headers in the genrule with a better way which works both for WORKSPACE and Bzlmod (also it properly specify those headers as inputs).\n\nRelated: https://github.com/openxla/xla/pull/26704\nCopybara import of the project:\n\n--\nb87f0786f094bf91e54359a05e345bcba1189036 by Yun Peng <pcloudy@google.com>:\n\nfix rocm\n\nMerging this change closes #32416\n\nPiperOrigin-RevId: 817165571",
    "sha": "0942d5ce4b32972584588cc2316158228b67ede6",
    "files": [
        {
            "sha": "845618bd9c4fa20555c110c73ad1d38ae7be6dbd",
            "filename": "third_party/xla/third_party/rocm_device_libs/build_defs.bzl",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0942d5ce4b32972584588cc2316158228b67ede6/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0942d5ce4b32972584588cc2316158228b67ede6/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Frocm_device_libs%2Fbuild_defs.bzl?ref=0942d5ce4b32972584588cc2316158228b67ede6",
            "patch": "@@ -25,6 +25,10 @@ def bitcode_library(\n     llvm_link_tool = \"@llvm-project//llvm:llvm-link\"\n     opt_tool = \"@llvm-project//llvm:opt\"\n     prepare_builtins_tool = \":prepare_builtins\"\n+    clang_includes = \"@llvm-project//clang:builtin_headers_gen\"\n+\n+    # Just for calculating the include path.\n+    clang_header = \"@llvm-project//clang:staging/include/opencl-c.h\"\n \n     include_paths = dict([(paths.dirname(h), None) for h in hdrs]).keys()\n \n@@ -51,12 +55,11 @@ def bitcode_library(\n         extra_flags = \" \".join(file_specific_flags.get(filename, []))\n         native.genrule(\n             name = \"compile_\" + basename,\n-            srcs = [src] + hdrs + include_paths,\n+            srcs = [src] + hdrs + include_paths + [clang_includes, clang_header],\n             outs = [out],\n-            #TODO(rocm): Ugly hack to access bultin clang includes.\n-            cmd = \"$(location {}) -I$(execpath {}).runfiles/llvm-project/clang/staging/include/  {} {} {} -emit-llvm -c $(location {}) -o $@\".format(\n-                clang_tool,\n+            cmd = \"$(location {}) -I$$(dirname $(location {}))  {} {} {} -emit-llvm -c $(location {}) -o $@\".format(\n                 clang_tool,\n+                clang_header,\n                 includes,\n                 flags,\n                 extra_flags,"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 7,
        "deletions": 4
    }
}