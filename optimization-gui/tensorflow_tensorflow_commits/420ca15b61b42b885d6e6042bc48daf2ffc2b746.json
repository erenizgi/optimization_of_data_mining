{
    "author": "pschuh",
    "message": "Promote check to connection close.\n\nPiperOrigin-RevId: 822746430",
    "sha": "420ca15b61b42b885d6e6042bc48daf2ffc2b746",
    "files": [
        {
            "sha": "a5397b8c0ad1b09fc8be660772cce89ca940e15f",
            "filename": "third_party/xla/xla/python/transfer/socket-server.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 5,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/420ca15b61b42b885d6e6042bc48daf2ffc2b746/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket-server.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/420ca15b61b42b885d6e6042bc48daf2ffc2b746/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket-server.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket-server.cc?ref=420ca15b61b42b885d6e6042bc48daf2ffc2b746",
            "patch": "@@ -114,13 +114,22 @@ class SocketServer::SocketNetworkState : public SocketFdPacketState {\n     return SendRawFrame(std::move(opacket));\n   }\n \n-  tsl::RCReference<ChunkDestination> GetNextDest(size_t req_id, size_t offset,\n-                                                 size_t size, bool is_largest) {\n+  std::optional<tsl::RCReference<ChunkDestination>> GetNextDest(\n+      size_t req_id, size_t offset, size_t size, bool is_largest) {\n     tsl::RCReference<ChunkDestination> dest;\n     {\n       absl::MutexLock l(mu_);\n+      if (is_poisoned_) {\n+        return std::nullopt;\n+      }\n       auto it = dests_.find(req_id);\n-      CHECK(it != dests_.end());\n+      if (it == dests_.end()) {\n+        Shutdown(SHUT_RDWR);\n+        is_poisoned_ = true;\n+        poison_status_ =\n+            absl::InternalError(\"SocketServer: it != dests_.end()\");\n+        return std::nullopt;\n+      }\n       if (is_largest) {\n         it->second.transferred_size += offset;\n       } else {\n@@ -273,7 +282,10 @@ class SocketServer::SocketNetworkState : public SocketFdPacketState {\n   void HandlePacket(const SocketTransferPacketErrorHeader& packet) {\n     auto dest = GetNextDest(packet.req_id(), packet.offset(), packet.size(),\n                             packet.is_largest());\n-    dest->Poison(absl::InternalError(\n+    if (!dest.has_value()) {\n+      return;\n+    }\n+    (*dest)->Poison(absl::InternalError(\n         absl::StrCat(\"Error while transferring: \", packet.error_message())));\n   }\n \n@@ -293,9 +305,12 @@ class SocketServer::SocketNetworkState : public SocketFdPacketState {\n   void HandlePacket(const SocketTransferPacketHeader& packet) {\n     auto dest = GetNextDest(packet.req_id(), packet.offset(), packet.size(),\n                             packet.is_largest());\n+    if (!dest.has_value()) {\n+      return;\n+    }\n     bulk_transport_->Recv(\n         packet.size(), packet.bulk_transport_id(),\n-        [offset = packet.offset(), dest = std::move(dest)](\n+        [offset = packet.offset(), dest = *std::move(dest)](\n             absl::StatusOr<BulkTransportInterface::Message> msgor) {\n           if (!msgor.ok()) {\n             dest->Poison(msgor.status());"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 20,
        "deletions": 5
    }
}