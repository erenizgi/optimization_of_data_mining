{
    "author": "akuegel",
    "message": "[XLA:GPU] Avoid double-counting of module outputs for rematerialization.\n\nThe pass accounts for module outputs itself, so the caller should not do this.\nHowever, we currently reuse the scheduling memory limit which accounts for\nmodule outputs itself. So before passing this limit to HloRematerialization, we\nshould add the size of module outputs back.\nAlso update and correct a comment what kind of limit the pass expects.\n\nPiperOrigin-RevId: 802029287",
    "sha": "f7b552be9afb2344353570a56e0d3960ff9701c2",
    "files": [
        {
            "sha": "c3912fe0e7852f92d3cf6916ddefc8a0aaf654e2",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/hlo_rematerialization.h",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f7b552be9afb2344353570a56e0d3960ff9701c2/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_rematerialization.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f7b552be9afb2344353570a56e0d3960ff9701c2/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_rematerialization.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_rematerialization.h?ref=f7b552be9afb2344353570a56e0d3960ff9701c2",
            "patch": "@@ -155,8 +155,11 @@ class HloRematerialization : public HloModulePass {\n     const ShapeSizeFunction size_function;\n \n     // The threshold number of bytes to reduce memory use to via\n-    // rematerialization. Size of aliased outputs should be subtracted\n-    // from this.\n+    // rematerialization. This limit is adjusted in the pass by subtracting the\n+    // size of all module outputs. Callers should consider reducing the amount\n+    // of available memory by also subtracting the size of module parameters,\n+    // and to add the size of aliased outputs to avoid subtracting twice for\n+    // parameter and output.\n     int64_t memory_limit_bytes;\n \n     // Maximum number of consecutive instructions to consider for"
        },
        {
            "sha": "2d6375690cefdcb3d4691f16acecf96ec4af4596",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f7b552be9afb2344353570a56e0d3960ff9701c2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f7b552be9afb2344353570a56e0d3960ff9701c2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=f7b552be9afb2344353570a56e0d3960ff9701c2",
            "patch": "@@ -2927,8 +2927,18 @@ absl::Status GpuCompiler::RunPostSchedulingPipelines(\n       CreateHloAnalysisOpts(*module, gpu_device_info, ShapeSizeBytesFunction());\n   HloCostAnalysis hlo_cost_analysis(hlo_cost_analysis_opts);\n   // `HloRematerialization` options initialization.\n+  // `scheduler_mem_limit` cannot directly be reused for HloRematerialization.\n+  // It reduces the memory limit by the size of the output, which is done again\n+  // in HloRematerialization. So to account for that, add back the size of the\n+  // output.\n+  int64_t remat_mem_limit = scheduler_mem_limit;\n+  ShapeUtil::ForEachSubshape(\n+      module->result_shape(),\n+      [&](const Shape& subshape, const ShapeIndex& /*index*/) {\n+        remat_mem_limit += ShapeSizeBytesFunction()(subshape);\n+      });\n   HloRematerialization::Options remat_opts = CreateRematOpts(\n-      *module, gpu_device_info, hlo_cost_analysis, scheduler_mem_limit);\n+      *module, gpu_device_info, hlo_cost_analysis, remat_mem_limit);\n   {\n     HloPassPipeline& pipeline =\n         main_pipeline.AddPass<HloPassPipeline>(\"remat-pipeline\");"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 16,
        "deletions": 3
    }
}