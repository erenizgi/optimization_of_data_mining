{
    "author": "nurmukhametov",
    "message": "PR #35353: [WIP ROCm] Fix flaky PersistedAutotuningTest.SingleOperationGetsAutotuned\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35353\n\nClear the shared autotune cache in PersistedAutotuningTest::SetUp.\n\nThe test was randomly passing or failing depending on test execution order due to a shared global autotune_cache that persists across test executions.\n\nWith this fix, the test now consistently fails for ROCm/AMDGPU, which is the expected behavior since transpose autotuning (implemented in #35098) is not yet supported on ROCm/AMDGPU. The test was occasionally and incorrectly passing when it inherited autotune results from other tests via the shared cache.\n\nCopybara import of the project:\n\n--\nb993d4130398474ac6d30b94a73f2e78ac26119c by Aleksei Nurmukhametov <anurmukh@amd.com>:\n\n[ROCm] Fix flaky PersistedAutotuningTest.SingleOperationGetsAutotuned\n\nClear the shared autotune cache in PersistedAutotuningTest::SetUp.\n\nThe test was randomly passing or failing depending on test execution\norder due to a shared global autotune_cache that persists across test\nexecutions.\n\nWith this fix, the test now consistently fails for ROCm/AMDGPU, which is\nthe expected behavior since transpose autotuning (implemented in #35098)\nis not yet supported on ROCm/AMDGPU. The test was occasionally and\nincorrectly passing when it inherited autotune results from other tests\nvia the shared cache.\n\nMerging this change closes #35353\n\nPiperOrigin-RevId: 846146297",
    "sha": "3d8a8b3367d27329e37d983c2ce9242b6cfae15d",
    "files": [
        {
            "sha": "855267bd792c9a37aace5c27fb109360f44730c3",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3d8a8b3367d27329e37d983c2ce9242b6cfae15d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3d8a8b3367d27329e37d983c2ce9242b6cfae15d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc?ref=3d8a8b3367d27329e37d983c2ce9242b6cfae15d",
            "patch": "@@ -395,6 +395,13 @@ ENTRY e {\n \n class PersistedAutotuningTest : public HloTestBase {\n  protected:\n+  void SetUp() override {\n+    AutotunerUtil::ClearAutotuneResults();\n+    xla_gpu_dump_autotune_results_to_ = GetUniqueTempFilePath(\".txt\");\n+  }\n+\n+  void TearDown() override { AutotunerUtil::ClearAutotuneResults(); }\n+\n   static constexpr absl::string_view kHloText = R\"(\n HloModule t\n \n@@ -428,7 +435,6 @@ ENTRY e {\n \n TEST_F(PersistedAutotuningTest, WriteResultsOnEachCompilation) {\n   constexpr absl::string_view kInvalidTextProto = \"Invalid!\";\n-  xla_gpu_dump_autotune_results_to_ = GetUniqueTempFilePath(\".txt\");\n \n   // Check that it writes the results on the first compilation.\n   TF_EXPECT_OK(GetOptimizedModule(kHloText).status());\n@@ -459,8 +465,6 @@ TEST_F(PersistedAutotuningTest, WriteResultsOnEachCompilation) {\n }\n \n TEST_F(PersistedAutotuningTest, SingleOperationGetsAutotuned) {\n-  xla_gpu_dump_autotune_results_to_ = GetUniqueTempFilePath(\".txt\");\n-\n   TF_EXPECT_OK(GetOptimizedModule(R\"(\n e {\n   a = f32[64,128] parameter(0)"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 7,
        "deletions": 3
    }
}