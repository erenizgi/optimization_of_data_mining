{
    "author": "tensorflower-gardener",
    "message": "Reverts 455247163f0fc1f0141ddb3a6d556933d5753ebb\n\nPiperOrigin-RevId: 839253089",
    "sha": "d9f02c1e55d338684275a1bced3a45cce1db75f2",
    "files": [
        {
            "sha": "086142041b3088b130749726093c61c7cad4d3eb",
            "filename": "third_party/xla/xla/service/gpu/build_defs.bzl",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fbuild_defs.bzl?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -27,7 +27,6 @@ def get_cub_sort_kernel_types(name = \"\"):\n         \"u16_b32\",\n         \"u16_b64\",\n         \"u32_b16\",\n-        \"s32_b32\",\n         \"u32_b32\",\n         \"u32_b64\",\n         \"u64_b16\","
        },
        {
            "sha": "74c8995ea43e8a3c6be04f2ed821a23b85a0ad54",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -709,9 +709,10 @@ absl::Status RunOptimizationPasses(\n \n   // DynamicPadder creates a stable KeyValue sort for dynamic reshapes.\n   pipeline.AddPass<DynamicPadder>(dynamic_padder_options);\n-  // SortRewriter needs to run before StableSortExpander.\n-  pipeline.AddPass<SortRewriter>(gpu_target_config.device_description,\n-                                 gpu_target_config.platform_name);\n+\n+  // TODO(b/407909195): Add SortRewriter here once it supports S32 keys for\n+  // KeyValueSort. It needs to run before StableSortExpander, otherwise we will\n+  // not match the comparison computation.\n \n   // Expand the sort op to support stable sorting if required.\n   pipeline.AddPass<StableSortExpander>();"
        },
        {
            "sha": "eb40243ac48c0565d186f984abc9b2c6aa040875",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -1710,9 +1710,8 @@ TEST_F(PassOrderTest,\n        SortRewriterRunsBeforeStableSortExpanderAndComparisonExpander) {\n   VerifyPassOrder(/*first_pass_regex=*/\"sort-rewriter\",\n                   /*last_pass_regex=*/\"stable-sort-expander\");\n-  VerifyPassRunsAtLeastOnceBefore(\n-      /*first_pass_regex=*/\"sort-rewriter\",\n-      /*other_pass_regex=*/\"comparison-expander\");\n+  VerifyPassOrder(/*first_pass_regex=*/\"sort-rewriter\",\n+                  /*last_pass_regex=*/\"comparison-expander\");\n }\n \n TEST_F(PassOrderTest,"
        },
        {
            "sha": "4adeb40cf5a0e49edbd0f45aec8703b9ad3d0a4a",
            "filename": "third_party/xla/xla/service/gpu/transforms/sort_rewriter_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 27,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -190,33 +190,6 @@ ENTRY %main {\n                                   m::GetTupleElement(m::CustomCall(), 1))));\n }\n \n-// Sort a pair of S32 tensors, keys go first.\n-TEST_F(SortRewriterTest, SortS32Pairs) {\n-  constexpr char kHlo[] = R\"(\n-HloModule TestModule\n-\n-%compare {\n-  %lhs_key = s32[] parameter(0)\n-  %rhs_key = s32[] parameter(1)\n-  %lhs_value = s32[] parameter(2)\n-  %rhs_value = s32[] parameter(3)\n-  ROOT %lt = pred[] compare(%lhs_key, %rhs_key), direction=LT\n-}\n-\n-ENTRY %main {\n-  %input_keys = s32[1000] parameter(0)\n-  %input_values = s32[1000] parameter(1)\n-  ROOT %sort = (s32[1000], s32[1000]) sort(%input_keys, %input_values),\n-      dimensions={0}, is_stable=true, to_apply=%compare\n-})\";\n-\n-  TF_ASSERT_OK_AND_ASSIGN(auto module, ParseAndReturnVerifiedModule(kHlo));\n-  EXPECT_TRUE(RunModuleAndPass(module.get()));\n-  EXPECT_THAT(module->entry_computation()->root_instruction(),\n-              GmockMatch(m::Tuple(m::GetTupleElement(m::CustomCall(), 0),\n-                                  m::GetTupleElement(m::CustomCall(), 1))));\n-}\n-\n // Sort a pair of tensors, keys go last.\n TEST_F(SortRewriterTest, SortPairsSwapped) {\n   constexpr char kHlo[] = R\"("
        },
        {
            "sha": "28cbf55076784e8eff1acd41a96db726871e7890",
            "filename": "third_party/xla/xla/stream_executor/cuda/cub_sort_kernel_cuda.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda.cc?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -186,9 +186,6 @@ XLA_CUB_DEFINE_SORT_PAIRS(u16_b64, uint16_t, uint64_t)\n #endif\n \n // Pairs with 32-bit key.\n-#ifdef CUB_TYPE_S32_B32\n-XLA_CUB_DEFINE_SORT_PAIRS(s32_b32, int32_t, uint32_t)\n-#endif\n #ifdef CUB_TYPE_U32_B16\n XLA_CUB_DEFINE_SORT_PAIRS(u32_b16, uint32_t, uint16_t)\n #endif"
        },
        {
            "sha": "70e5d9553092e89d086e54d5316d02782ef0edba",
            "filename": "third_party/xla/xla/stream_executor/cuda/cub_sort_kernel_cuda_impl.cu.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda_impl.cu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda_impl.cu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcub_sort_kernel_cuda_impl.cu.cc?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -198,9 +198,6 @@ XLA_CUB_DEFINE_SORT_PAIRS(uint16_t, uint64_t)\n #endif\n \n // Pairs with 32-bit key.\n-#ifdef CUB_TYPE_S32_B32\n-XLA_CUB_DEFINE_SORT_PAIRS(int32_t, uint32_t)\n-#endif\n #ifdef CUB_TYPE_U32_B16\n XLA_CUB_DEFINE_SORT_PAIRS(uint32_t, uint16_t)\n #endif"
        },
        {
            "sha": "30baa5d6ce286accedc02f6ce35306aee42f4351",
            "filename": "third_party/xla/xla/stream_executor/rocm/cub_sort_kernel_rocm.cu.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9f02c1e55d338684275a1bced3a45cce1db75f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc?ref=d9f02c1e55d338684275a1bced3a45cce1db75f2",
            "patch": "@@ -348,9 +348,6 @@ XLA_CUB_DEFINE_SORT_PAIRS(u16_b64, uint16_t, uint64_t)\n #endif\n \n // Pairs with 32-bit key.\n-#ifdef CUB_TYPE_S32_B32\n-XLA_CUB_DEFINE_SORT_PAIRS(s32_b32, int32_t, uint32_t)\n-#endif\n #ifdef CUB_TYPE_U32_B16\n XLA_CUB_DEFINE_SORT_PAIRS(u32_b16, uint32_t, uint16_t)\n #endif"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 6,
        "deletions": 43
    }
}