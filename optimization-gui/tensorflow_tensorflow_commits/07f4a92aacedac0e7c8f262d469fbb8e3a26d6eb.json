{
    "author": "khasanovaa",
    "message": "Update clang-format check to use clang-format-diff.\n\nThe clang-format GitHub Actions workflow now uses `clang-format-diff` to check only the modified lines in C++ files against the clang-format style. This avoids failures caused by pre-existing formatting issues in unchanged code.\n\nPiperOrigin-RevId: 837799495",
    "sha": "07f4a92aacedac0e7c8f262d469fbb8e3a26d6eb",
    "files": [
        {
            "sha": "198d0dd5df3a83215cffe9e5135f8c06fa56f7cf",
            "filename": "third_party/xla/.github/workflows/clang_format.yml",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07f4a92aacedac0e7c8f262d469fbb8e3a26d6eb/third_party%2Fxla%2F.github%2Fworkflows%2Fclang_format.yml",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07f4a92aacedac0e7c8f262d469fbb8e3a26d6eb/third_party%2Fxla%2F.github%2Fworkflows%2Fclang_format.yml",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2F.github%2Fworkflows%2Fclang_format.yml?ref=07f4a92aacedac0e7c8f262d469fbb8e3a26d6eb",
            "patch": "@@ -35,7 +35,24 @@ jobs:\n     steps:\n       - name: \"Checking out repository\"\n         uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0\n+        with:\n+          fetch-depth: '0'\n       - name: \"Fetch HEAD of main branch\"\n         run: git fetch origin main --depth=1\n-      - name: \"Run clang-format\" # Use pipx to get version that apt doesn't have by default\n-        run: pipx run clang-format==17.0.6 --dry-run --Werror --verbose $(git diff --name-only origin/main HEAD -- '*.cc' '*.h')\n+      - name: \"Install clang-format\"\n+        run: pipx install clang-format==17.0.6\n+      - name: \"Run clang-format-diff\"\n+        run: |\n+          # Run diff against origin/main.\n+          # -U0: Context of 0 lines (ignore surrounding code)\n+          # clang-format-diff: Checks only lines present in the diff\n+\n+          REFERENCE=\"origin/${GITHUB_BASE_REF:-main}\"\n+          MERGE_BASE=\"$(git merge-base $REFERENCE HEAD)\" # Merge base is the commit on main this PR was branched from.\n+          CLANG_FORMAT_BIN=\"$(pipx environment --value PIPX_BIN_DIR)/clang-format\"\n+          DIFF=$(git diff -U0 --no-color $MERGE_BASE -- '*.cc' '*.h' | clang-format-diff.py -binary $CLANG_FORMAT_BIN -p1 -style=file)\n+          if [ -n \"$DIFF\" ]; then\n+            echo \"Clang-format failed on the following changes:\"\n+            echo \"$DIFF\"\n+            exit 1\n+          fi\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 19,
        "deletions": 2
    }
}