{
    "author": "dubstack",
    "message": "Add static registration build rule for FatalErrorSink.\n\nA user can depend on this library to automatically get XLA DebugMeContext populated on FATAL errors/crashes.\n\nPiperOrigin-RevId: 813930430",
    "sha": "e9c802af2162e903698f2bf3396879f0b330035f",
    "files": [
        {
            "sha": "5d0cbb5c58a1602e88cc85d5f36f8956ac5b5263",
            "filename": "third_party/xla/xla/error/BUILD",
            "status": "modified",
            "additions": 22,
            "deletions": 11,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2FBUILD?ref=e9c802af2162e903698f2bf3396879f0b330035f",
            "patch": "@@ -41,17 +41,6 @@ cc_library(\n     ],\n )\n \n-cc_library(\n-    name = \"fatal_error_sink\",\n-    hdrs = [\"fatal_error_sink.h\"],\n-    deps = [\n-        \":debug_me_context_util\",\n-        \"@com_google_absl//absl/base:log_severity\",\n-        \"@com_google_absl//absl/log:log_entry\",\n-        \"@com_google_absl//absl/log:log_sink\",\n-    ],\n-)\n-\n xla_cc_test(\n     name = \"debug_me_context_util_test\",\n     srcs = [\"debug_me_context_util_test.cc\"],\n@@ -63,6 +52,21 @@ xla_cc_test(\n     ],\n )\n \n+cc_library(\n+    name = \"fatal_error_sink\",\n+    srcs = [\"fatal_error_sink.cc\"],\n+    hdrs = [\"fatal_error_sink.h\"],\n+    deps = [\n+        \":debug_me_context_util\",\n+        \"@com_google_absl//absl/base\",\n+        \"@com_google_absl//absl/base:log_severity\",\n+        \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/log:log_entry\",\n+        \"@com_google_absl//absl/log:log_sink\",\n+        \"@com_google_absl//absl/log:log_sink_registry\",\n+    ],\n+)\n+\n xla_cc_test(\n     name = \"fatal_error_sink_test\",\n     srcs = [\"fatal_error_sink_test.cc\"],\n@@ -76,3 +80,10 @@ xla_cc_test(\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )\n+\n+cc_library(\n+    name = \"fatal_error_sink_registration\",\n+    srcs = [\"fatal_error_sink_registration.cc\"],\n+    deps = [\":fatal_error_sink\"],\n+    alwayslink = True,\n+)"
        },
        {
            "sha": "8681b7f19fafb4c681f1e8f16aaffb284d66a147",
            "filename": "third_party/xla/xla/error/fatal_error_sink.cc",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.cc?ref=e9c802af2162e903698f2bf3396879f0b330035f",
            "patch": "@@ -0,0 +1,56 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/error/fatal_error_sink.h\"\n+\n+#include <iostream>\n+\n+#include \"absl/base/call_once.h\"\n+#include \"absl/base/log_severity.h\"\n+#include \"absl/base/no_destructor.h\"\n+#include \"absl/log/log_entry.h\"\n+#include \"absl/log/log_sink_registry.h\"\n+#include \"xla/error/debug_me_context_util.h\"\n+\n+namespace xla::error {\n+\n+FatalErrorSink::~FatalErrorSink() = default;\n+\n+void FatalErrorSink::Send(const absl::LogEntry& entry) {\n+  if (entry.log_severity() != absl::LogSeverity::kFatal) {\n+    return;\n+  }\n+\n+  // A LogSink receives two copies of each FATAL message: one without a\n+  // stacktrace, and then one with. We only want to inject the context once,\n+  // hence we only do it on the first message.\n+  if (entry.stacktrace().empty()) {\n+    auto debug_me_context = DebugMeContextToErrorMessageString();\n+    if (!debug_me_context.empty()) {\n+      std::cerr << debug_me_context << std::endl;\n+    }\n+  }\n+}\n+\n+void AddFatalErrorSink() {\n+  static absl::once_flag install_once;\n+\n+  absl::call_once(install_once, []() {\n+    static absl::NoDestructor<FatalErrorSink> fatal_error_sink;\n+    absl::AddLogSink(fatal_error_sink.get());\n+  });\n+}\n+\n+}  // namespace xla::error"
        },
        {
            "sha": "7b4bc7a541ccbc1c0ceaf69b84cf433a77a95f6c",
            "filename": "third_party/xla/xla/error/fatal_error_sink.h",
            "status": "modified",
            "additions": 7,
            "deletions": 19,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.h?ref=e9c802af2162e903698f2bf3396879f0b330035f",
            "patch": "@@ -16,36 +16,24 @@ limitations under the License.\n #ifndef XLA_ERROR_FATAL_ERROR_SINK_H_\n #define XLA_ERROR_FATAL_ERROR_SINK_H_\n \n-#include <iostream>\n-\n-#include \"absl/base/log_severity.h\"\n #include \"absl/log/log_entry.h\"\n #include \"absl/log/log_sink.h\"\n-#include \"xla/error/debug_me_context_util.h\"\n \n namespace xla::error {\n \n // An absl::LogSink that selectively handles FATAL errors to add additional\n // XLA-specific debugging context.\n class FatalErrorSink : public absl::LogSink {\n  public:\n-  void Send(const absl::LogEntry& entry) override {\n-    if (entry.log_severity() != absl::LogSeverity::kFatal) {\n-      return;\n-    }\n-\n-    // A LogSink receives two copies of each FATAL message: one without a\n-    // stacktrace, and then one with. We only want to inject the context once,\n-    // hence we only do it on the first message.\n-    if (entry.stacktrace().empty()) {\n-      auto debug_me_context = DebugMeContextToErrorMessageString();\n-      if (!debug_me_context.empty()) {\n-        std::cerr << debug_me_context << std::endl;\n-      }\n-    }\n-  }\n+  ~FatalErrorSink() override;\n+\n+  void Send(const absl::LogEntry& entry) override;\n };\n \n+// Adds the FatalErrorSink as an Absl::LogSink.\n+// This is thread-safe and idempotent - can be called multiple times.\n+void AddFatalErrorSink();\n+\n }  // namespace xla::error\n \n #endif  // XLA_ERROR_FATAL_ERROR_SINK_H_"
        },
        {
            "sha": "4ca5217501cfc91810fba2545b65d60ff51eefaf",
            "filename": "third_party/xla/xla/error/fatal_error_sink_registration.cc",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink_registration.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e9c802af2162e903698f2bf3396879f0b330035f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink_registration.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink_registration.cc?ref=e9c802af2162e903698f2bf3396879f0b330035f",
            "patch": "@@ -0,0 +1,21 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/error/fatal_error_sink.h\"\n+\n+[[maybe_unused]] static bool register_fatal_error_sink = []() -> bool {\n+  xla::error::AddFatalErrorSink();\n+  return true;\n+}();"
        }
    ],
    "stats": {
        "total": 136,
        "additions": 106,
        "deletions": 30
    }
}