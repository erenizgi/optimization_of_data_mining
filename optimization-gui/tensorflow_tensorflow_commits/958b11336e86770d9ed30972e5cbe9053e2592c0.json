{
    "author": "jakeharmon8",
    "message": "Create xla_cuda_pjrt\n\nBuilding xla_cuda_pjrt.dist will build the appropriate wheel, as determined by the HERMETIC_CUDA_VERSION.\n\nPiperOrigin-RevId: 809156302",
    "sha": "958b11336e86770d9ed30972e5cbe9053e2592c0",
    "files": [
        {
            "sha": "e7fe2b59f3fdf515088bc585118536cd89ab275d",
            "filename": "third_party/xla/build_tools/pjrt_wheels/BUILD.bazel",
            "status": "modified",
            "additions": 83,
            "deletions": 92,
            "changes": 175,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/958b11336e86770d9ed30972e5cbe9053e2592c0/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/958b11336e86770d9ed30972e5cbe9053e2592c0/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Fpjrt_wheels%2FBUILD.bazel?ref=958b11336e86770d9ed30972e5cbe9053e2592c0",
            "patch": "@@ -1,105 +1,96 @@\n+load(\"@cuda_cudart//:version.bzl\", cuda_major_version = \"VERSION\")\n load(\"@rules_python//python:packaging.bzl\", \"py_wheel\")\n \n-cuda_wheels = [\n-    \"cuda12\",\n-    \"cuda13\",\n-]\n-\n-cpu_wheel = [\"cpu\"]\n+# This ensures we can only build plugins for selected CUDA versions.\n+cuda_label = \"cuda\" + cuda_major_version if cuda_major_version else \"null\"\n \n # Aliases and filegroups don't move files within bazel-out, so we need to use genrules to place them\n # in the correct directory structure for the wheel.\n-[\n-    genrule(\n-        name = \"init_file_\" + arch,\n-        srcs = [\"__init__.py\"],\n-        outs = [\"xla_plugins/xla_\" + arch + \"_pjrt/__init__.py\"],\n-        cmd = \"cp $< $@\",\n-    )\n-    for arch in cuda_wheels + cpu_wheel\n-]\n+genrule(\n+    name = \"init_file_\" + cuda_label,\n+    srcs = [\"__init__.py\"],\n+    outs = [\"xla_plugins/xla_\" + cuda_label + \"_pjrt/__init__.py\"],\n+    cmd = \"cp $< $@\",\n+)\n+\n+genrule(\n+    name = \"init_file_cpu\",\n+    srcs = [\"__init__.py\"],\n+    outs = [\"xla_plugins/xla_cpu_pjrt/__init__.py\"],\n+    cmd = \"cp $< $@\",\n+)\n \n # GPU-specific files\n-[\n-    cc_binary(\n-        name = \"xla_plugins/xla_\" + arch + \"_pjrt/xla_gpu_pjrt.so\",\n-        linkopts = [\n-            \"-Wl,--version-script,$(location :pjrt_symbols.lds)\",\n-            \"-Wl,--no-undefined\",\n-        ],\n-        linkshared = True,\n-        deps = [\n-            \":pjrt_symbols.lds\",\n-            \"//xla/pjrt/c:pjrt_c_api_gpu\",\n-        ],\n-    )\n-    for arch in cuda_wheels\n-]\n+cc_binary(\n+    name = \"xla_plugins/xla_\" + cuda_label + \"_pjrt/xla_gpu_pjrt.so\",\n+    linkopts = [\n+        \"-Wl,--version-script,$(location :pjrt_symbols.lds)\",\n+        \"-Wl,--no-undefined\",\n+    ],\n+    linkshared = True,\n+    deps = [\n+        \":pjrt_symbols.lds\",\n+        \"//xla/pjrt/c:pjrt_c_api_gpu\",\n+    ],\n+)\n \n-# GPU wheels\n-[\n-    py_wheel(\n-        name = \"xla_\" + arch + \"_pjrt\",\n-        author = \"The OpenXLA Authors\",\n-        classifiers = [\"Development Status :: 1 - Planning\"],\n-        distribution = \"xla_\" + arch + \"_pjrt\",\n-        entry_points = {\n-            \"xla_plugins\": [\n-                \"xla_\" + arch + \"_pjrt = xla_plugins.xla_\" + arch + \"_pjrt\\n\",\n-            ],\n-        },\n-        platform = \"manylinux2014_x86_64\",\n-        python_tag = \"py3\",\n-        strip_path_prefixes = [\"build_tools/pjrt_wheels\"],\n-        summary = \"XLA PJRT Plugin\",\n-        version = \"0.0.0.dev0\",\n-        deps = [\n-            \":xla_plugins/xla_\" + arch + \"_pjrt/xla_gpu_pjrt.so\",\n-            \":init_file_\" + arch,\n+py_wheel(\n+    name = \"xla_\" + cuda_label + \"_pjrt\",\n+    author = \"The OpenXLA Authors\",\n+    classifiers = [\"Development Status :: 1 - Planning\"],\n+    distribution = \"xla_\" + cuda_label + \"_pjrt\",\n+    entry_points = {\n+        \"xla_plugins\": [\n+            \"xla_\" + cuda_label + \"_pjrt = xla_plugins.xla_\" + cuda_label + \"_pjrt\\n\",\n         ],\n-    )\n-    for arch in cuda_wheels\n-]\n+    },\n+    platform = \"manylinux2014_x86_64\",\n+    python_tag = \"py3\",\n+    strip_path_prefixes = [\"build_tools/pjrt_wheels\"],\n+    summary = \"XLA PJRT Plugin\",\n+    version = \"0.0.0.dev0\",\n+    deps = [\n+        \":xla_plugins/xla_\" + cuda_label + \"_pjrt/xla_gpu_pjrt.so\",\n+        \":init_file_\" + cuda_label,\n+    ],\n+)\n+\n+alias(\n+    name = \"xla_cuda_pjrt.dist\",\n+    actual = \":xla_\" + cuda_label + \"_pjrt.dist\",\n+)\n \n # CPU-specific files\n-[\n-    # TODO: Replace this with alias to .so found in xla/pjrt/c/BUILD\n-    cc_binary(\n-        name = \"xla_plugins/xla_\" + arch + \"_pjrt/xla_cpu_pjrt.so\",\n-        linkopts = [\n-            \"-Wl,--version-script,$(location :pjrt_symbols.lds)\",\n-            \"-Wl,--no-undefined\",\n-        ],\n-        linkshared = True,\n-        deps = [\n-            \":pjrt_symbols.lds\",\n-            \"//xla/pjrt/c:pjrt_c_api_cpu\",\n-        ],\n-    )\n-    for arch in cpu_wheel\n-]\n+cc_binary(\n+    name = \"xla_plugins/xla_cpu_pjrt/xla_cpu_pjrt.so\",\n+    linkopts = [\n+        \"-Wl,--version-script,$(location :pjrt_symbols.lds)\",\n+        \"-Wl,--no-undefined\",\n+    ],\n+    linkshared = True,\n+    deps = [\n+        \":pjrt_symbols.lds\",\n+        \"//xla/pjrt/c:pjrt_c_api_cpu\",\n+    ],\n+)\n \n-# CPU wheel\n-[\n-    py_wheel(\n-        name = \"xla_\" + arch + \"_pjrt\",\n-        author = \"The OpenXLA Authors\",\n-        classifiers = [\"Development Status :: 1 - Planning\"],\n-        distribution = \"xla_\" + arch + \"_pjrt\",\n-        entry_points = {\n-            \"xla_plugins\": [\n-                \"xla_\" + arch + \"_pjrt = xla_plugins.xla_\" + arch + \"_pjrt\\n\",\n-            ],\n-        },\n-        platform = \"manylinux2014_x86_64\",\n-        python_tag = \"py3\",\n-        strip_path_prefixes = [\"build_tools/pjrt_wheels\"],\n-        summary = \"XLA PJRT Plugin\",\n-        version = \"0.0.0.dev0\",\n-        deps = [\n-            \":xla_plugins/xla_\" + arch + \"_pjrt/xla_cpu_pjrt.so\",\n-            \":init_file_\" + arch,\n+py_wheel(\n+    name = \"xla_cpu_pjrt\",\n+    author = \"The OpenXLA Authors\",\n+    classifiers = [\"Development Status :: 1 - Planning\"],\n+    distribution = \"xla_cpu_pjrt\",\n+    entry_points = {\n+        \"xla_plugins\": [\n+            \"xla_cpu_pjrt = xla_plugins.xla_cpu_pjrt\\n\",\n         ],\n-    )\n-    for arch in cpu_wheel\n-]\n+    },\n+    platform = \"manylinux2014_x86_64\",\n+    python_tag = \"py3\",\n+    strip_path_prefixes = [\"build_tools/pjrt_wheels\"],\n+    summary = \"XLA PJRT Plugin\",\n+    version = \"0.0.0.dev0\",\n+    deps = [\n+        \":init_file_cpu\",\n+        \":xla_plugins/xla_cpu_pjrt/xla_cpu_pjrt.so\",\n+    ],\n+)"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 83,
        "deletions": 92
    }
}