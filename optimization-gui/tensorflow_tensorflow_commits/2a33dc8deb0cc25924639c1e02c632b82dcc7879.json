{
    "author": "ZixuanJiang",
    "message": "Simplify sharding computation in `PatternMatchMergeOrSplitSharding`.\n\nThe computation of `new_sharding` is simplified by directly using `hlo_sharding_util::SplitShardingDimension` on the `target` sharding, instead of reshaping and swapping dimensions of the tile assignment.\n\nPiperOrigin-RevId: 799419945",
    "sha": "2a33dc8deb0cc25924639c1e02c632b82dcc7879",
    "files": [
        {
            "sha": "be7b37b3e7ab0ef3fcbd1f18b5cac885067b1434",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 20,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2a33dc8deb0cc25924639c1e02c632b82dcc7879/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2a33dc8deb0cc25924639c1e02c632b82dcc7879/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc?ref=2a33dc8deb0cc25924639c1e02c632b82dcc7879",
            "patch": "@@ -2118,21 +2118,10 @@ PatternMatchMergeOrSplitSharding(const Shape& shape, const Shape& base_shape,\n           continue;\n       }\n \n-      auto reshaped_sharding =\n+      HloSharding reshaped_sharding =\n           hlo_sharding_util::SplitShardingDimension(source, i, new_dim_size);\n-      std::vector<int64_t> dimensions(\n-          reshaped_sharding.tile_assignment().dimensions().begin(),\n-          reshaped_sharding.tile_assignment().dimensions().end());\n-      std::swap(dimensions[i + 1], dimensions[j + (j > i ? 1 : 0)]);\n-      auto target_tile_assignment =\n-          target.tile_assignment().Reshape(dimensions);\n-      auto new_sharding =\n-          source.HasPartialReplication()\n-              ? HloSharding::PartialTile(target_tile_assignment,\n-                                         source.metadata())\n-              : HloSharding::Tile(target_tile_assignment, source.metadata());\n-      VLOG(10) << \"Reshaped sharding before: \" << reshaped_sharding.ToString();\n-      VLOG(10) << \"Reshaped sharding: \" << new_sharding.ToString();\n+      HloSharding new_sharding =\n+          hlo_sharding_util::SplitShardingDimension(target, i, new_dim_size);\n       return std::make_tuple(std::move(reshaped_sharding),\n                              std::move(new_sharding), i);\n     }\n@@ -2232,12 +2221,6 @@ std::optional<PartitionedHlo> PartitionedHlo::TryComplexReshardHandling(\n   if (auto reshape = PatternMatchMergeOrSplitSharding(\n           this->hlo()->shape(), this->base_shape(), sharding(), target)) {\n     auto& [before_sharding, new_reshaped_sharding, source_dim] = *reshape;\n-    VLOG(10) << \"Matched \\\"pattern_match_reshape()\\\": \"\n-             << std::get<0>(*reshape).ToString();\n-    VLOG(10) << \"Original shape: \" << hlo()->shape().ToString();\n-    VLOG(10) << \"Dim to split: \" << std::get<1>(*reshape) << \" size \"\n-             << sharding().tile_assignment().dim(source_dim);\n-    VLOG(10) << \"Before sharding: \" << before_sharding.ToString();\n     PartitionedHlo reshaped = SplitReshapeHelper(\n         *this, source_dim, this->hlo()->shape().dimensions(source_dim),\n         before_sharding);"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 3,
        "deletions": 20
    }
}