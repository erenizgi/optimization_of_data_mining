{
    "author": "lhutton1",
    "message": "[mlir][tosa] Use `getTosaConstShape` implementation from MLIR (#106002)\n\nMLIR `ConversionUtils.h` defines an implementation of\n`getTosaConstShape`. In some cases here, but not all,\nthe implementation in `legalization_utils` was being used\ninstead. This commit removes the implementation in\n`legalization_utils` and updates the relevant call sites\nto use the MLIR version.\n\nChange-Id: I4595c5294e26f1d67b398446025c624d88e0ce18",
    "sha": "a05dfbfc3226832f26f24daecaf46412aac182ce",
    "files": [
        {
            "sha": "a2aaa3b905f87f6c018266725518ec49687abbd0",
            "filename": "tensorflow/compiler/mlir/tosa/transforms/legalize_common.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_common.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_common.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_common.cc?ref=a05dfbfc3226832f26f24daecaf46412aac182ce",
            "patch": "@@ -4774,7 +4774,7 @@ std::optional<Value> convertOneHotOp(PatternRewriter& rewriter, Operation* op,\n       tensorflow::GetTypeFromTFTensorShape({N, W, C},\n                                            on_value_type.getElementType()),\n       op1_reshape_on_value.getResult(),\n-      getTosaConstShape(rewriter, op, {N, W, C}));\n+      getTosaConstShape(rewriter, op->getLoc(), {N, W, C}));\n \n   // Reshape off_value to [1, 1, 1]\n   auto op3_reshape_off_value = CreateOpAndInfer<tosa::ReshapeOp>(\n@@ -4789,7 +4789,7 @@ std::optional<Value> convertOneHotOp(PatternRewriter& rewriter, Operation* op,\n       tensorflow::GetTypeFromTFTensorShape({N, K, C},\n                                            on_value_type.getElementType()),\n       op3_reshape_off_value.getResult(),\n-      getTosaConstShape(rewriter, op, {N, K, C}));\n+      getTosaConstShape(rewriter, op->getLoc(), {N, K, C}));\n \n   // Reshape indices to [N, W]\n   shape_value ="
        },
        {
            "sha": "43a22266bcb0c625dded8659dbca19cb29086a35",
            "filename": "tensorflow/compiler/mlir/tosa/transforms/legalize_tf.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tf.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tf.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tf.cc?ref=a05dfbfc3226832f26f24daecaf46412aac182ce",
            "patch": "@@ -1558,7 +1558,7 @@ LogicalResult ConvertTFTileOp::matchAndRewrite(\n     multiples_vals.push_back(\n         multiples_elems.getValues<IntegerAttr>()[i].getInt());\n \n-  auto multiples = getTosaConstShape(rewriter, op, multiples_vals);\n+  auto multiples = getTosaConstShape(rewriter, op->getLoc(), multiples_vals);\n \n   CreateReplaceOpAndInfer<tosa::TileOp>(rewriter, op, output_type,\n                                         tf_tile_op.getInput(), multiples);"
        },
        {
            "sha": "d9c20cb9ab67b711db56a086bf624fc4145a9d5f",
            "filename": "tensorflow/compiler/mlir/tosa/transforms/legalize_tfl.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tfl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tfl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tfl.cc?ref=a05dfbfc3226832f26f24daecaf46412aac182ce",
            "patch": "@@ -3009,7 +3009,7 @@ LogicalResult ConvertTFLTileOp::matchAndRewrite(\n     multiples_vals.push_back(\n         multiples_elems.getValues<APInt>()[i].getSExtValue());\n \n-  auto multiples = getTosaConstShape(rewriter, op, multiples_vals);\n+  auto multiples = getTosaConstShape(rewriter, op->getLoc(), multiples_vals);\n \n   CreateReplaceOpAndInfer<tosa::TileOp>(rewriter, op, output_type,\n                                         tfl_tile_op.getInput(), multiples);"
        },
        {
            "sha": "dcfff41af1f1d7cce95692f0b084c61373dbf01c",
            "filename": "tensorflow/compiler/mlir/tosa/transforms/legalize_utils.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_utils.cc?ref=a05dfbfc3226832f26f24daecaf46412aac182ce",
            "patch": "@@ -991,15 +991,6 @@ Value getTosaConstTensorScalarInt(ImplicitLocOpBuilder& builder, Type type,\n   return const_op.getResult();\n }\n \n-Value getTosaConstShape(PatternRewriter& rewriter, Operation* op,\n-                        llvm::ArrayRef<int64_t> values) {\n-  auto attr = rewriter.getIndexTensorAttr(values);\n-  auto type =\n-      tosa::shapeType::get(rewriter.getContext(), /* rank = */ values.size());\n-  return CreateOpAndInfer<tosa::ConstShapeOp>(rewriter, op->getLoc(), type,\n-                                              attr);\n-}\n-\n // Create a vector from a 32-bit value tensor.  Returns the size of\n // the new vector or -1 on error.\n // Populate a int32_t vector from a val tensor"
        },
        {
            "sha": "b22db1b0963278b753212b222f1b723ad294be47",
            "filename": "tensorflow/compiler/mlir/tosa/transforms/legalize_utils.h",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_utils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a05dfbfc3226832f26f24daecaf46412aac182ce/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_utils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_utils.h?ref=a05dfbfc3226832f26f24daecaf46412aac182ce",
            "patch": "@@ -144,11 +144,6 @@ Value getTosaConstTensorSingleI32(PatternRewriter& rewriter, Operation* op,\n Value getTosaConstTensorScalarInt(ImplicitLocOpBuilder& builder, Type type,\n                                   int64_t val, int rank);\n \n-// Create a tosa::ConstShape based on the specified values\n-Value getTosaConstShape(PatternRewriter& rewriter, Operation* op,\n-                        llvm::ArrayRef<int64_t> values);\n-\n-\n // Populate a int32_t vector from a val tensor\n // return failure if val is not a constant value\n // return success otherwise"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 4,
        "deletions": 18
    }
}