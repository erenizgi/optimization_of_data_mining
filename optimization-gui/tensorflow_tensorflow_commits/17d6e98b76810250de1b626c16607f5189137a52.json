{
    "author": "tensorflower-gardener",
    "message": "[XLA:Original Value] Propagate OriginalValue in WhileLoopSimplifier when removing constant loop-carried values.\n\nWhen constant tuple elements are removed from a while loop's loop-carried values, update the `OriginalValue` trees for the modified tuples (init, body root, cond root) and the new while instruction to reflect the shape changes. This ensures that debugging information remains accurate after simplification.\n\nPiperOrigin-RevId: 843355843",
    "sha": "17d6e98b76810250de1b626c16607f5189137a52",
    "files": [
        {
            "sha": "2bf42ac92b32a265e9218b44ab7ffc356ad6ca9e",
            "filename": "third_party/xla/xla/service/while_loop_simplifier.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 3,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17d6e98b76810250de1b626c16607f5189137a52/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17d6e98b76810250de1b626c16607f5189137a52/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier.cc?ref=17d6e98b76810250de1b626c16607f5189137a52",
            "patch": "@@ -875,7 +875,8 @@ static absl::StatusOr<bool> TryRemoveConstantParams(HloInstruction* while_op) {\n   };\n \n   // Returns a new tuple without the elements of constant_tuple_indices.\n-  auto remove_constant_elems = [&](HloInstruction* instr) {\n+  auto remove_constant_elems =\n+      [&](HloInstruction* instr) -> std::unique_ptr<HloInstruction> {\n     CHECK(ShapeUtil::Compatible(instr->shape(), while_shape));\n \n     std::vector<HloInstruction*> tuple_elems;\n@@ -886,10 +887,24 @@ static absl::StatusOr<bool> TryRemoveConstantParams(HloInstruction* while_op) {\n                 while_shape.tuple_shapes(i), instr, i)));\n       }\n     }\n-    return HloInstruction::CreateTuple(tuple_elems);\n+    std::unique_ptr<HloInstruction> new_tuple =\n+        HloInstruction::CreateTuple(tuple_elems);\n+    if (instr->original_value()) {\n+      auto new_ov = std::make_shared<OriginalValue>(new_tuple->shape());\n+      int64_t new_i = 0;\n+      for (int i = 0; i < while_shape.tuple_shapes().size(); ++i) {\n+        if (!constant_tuple_indices.count(i)) {\n+          CHECK_OK(new_ov->mutable_tree()->CopyCompatibleSubtreeFrom(\n+              instr->original_value()->tree(), {i}, {new_i++}));\n+        }\n+      }\n+      new_tuple->set_original_value(new_ov);\n+    }\n+    return new_tuple;\n   };\n \n-  auto add_constant_elems = [&](HloInstruction* instr) {\n+  auto add_constant_elems =\n+      [&](HloInstruction* instr) -> std::unique_ptr<HloInstruction> {\n     CHECK(ShapeUtil::Compatible(instr->shape(), new_while_shape));\n \n     std::vector<HloInstruction*> tuple_elems;\n@@ -952,6 +967,17 @@ static absl::StatusOr<bool> TryRemoveConstantParams(HloInstruction* while_op) {\n       module->AddEmbeddedComputation(std::move(new_while_cond)),\n       module->AddEmbeddedComputation(std::move(new_while_body)),\n       add_new_instr(remove_constant_elems(while_init))));\n+  if (while_op->original_value()) {\n+    auto new_ov = std::make_shared<OriginalValue>(new_while_op->shape());\n+    int64_t new_i = 0;\n+    for (int i = 0; i < while_shape.tuple_shapes().size(); ++i) {\n+      if (!constant_tuple_indices.count(i)) {\n+        CHECK_OK(new_ov->mutable_tree()->CopyCompatibleSubtreeFrom(\n+            while_op->original_value()->tree(), {i}, {new_i++}));\n+      }\n+    }\n+    new_while_op->set_original_value(new_ov);\n+  }\n   new_while_op->CopyBackendConfigFrom(while_op);\n   CopyFrontendAttributes(while_op, new_while_op);\n   CopyMetadata(while_op, new_while_op);"
        },
        {
            "sha": "9ee413ca8b655cfa66964047f641efcb7a38ae3a",
            "filename": "third_party/xla/xla/service/while_loop_simplifier_test.cc",
            "status": "modified",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17d6e98b76810250de1b626c16607f5189137a52/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17d6e98b76810250de1b626c16607f5189137a52/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_simplifier_test.cc?ref=17d6e98b76810250de1b626c16607f5189137a52",
            "patch": "@@ -819,6 +819,35 @@ TEST_F(WhileLoopSimplifierTest, OnlyConstantsInLoopCarry) {\n               op::Tuple(op::Constant()));\n }\n \n+TEST_F(WhileLoopSimplifierTest, OnlyConstantsInLoopCarryWithOriginalValue) {\n+  const std::string hlo_string = R\"(\n+  HloModule Test\n+  Body {\n+    param = (s32[1]) parameter(0)\n+    a = s32[1] constant({0})\n+    ROOT tuple = (s32[1]) tuple(a)\n+  }\n+  Cond {\n+    param = (s32[1]) parameter(0)\n+    ROOT cond = pred[] constant(true)\n+  }\n+  ENTRY Loop {\n+    a = s32[1] constant({0})\n+    init = (s32[1]) tuple(a), origin={({\"a\"})}\n+    ROOT while = (s32[1]) while(init), condition=Cond, body=Body, origin={({\"w\"})}\n+  })\";\n+\n+  auto m = ParseAndReturnVerifiedModule(hlo_string).value();\n+  EXPECT_TRUE(WhileLoopSimplifier().Run(m.get()).value());\n+  EXPECT_TRUE(HloDCE().Run(m.get()).ok());\n+  EXPECT_TRUE(TupleSimplifier().Run(m.get()).ok());\n+  EXPECT_THAT(m->entry_computation()->root_instruction(),\n+              op::Tuple(op::Constant()));\n+  HloInstruction* root_instr = m->entry_computation()->root_instruction();\n+  ASSERT_NE(root_instr->original_value(), nullptr);\n+  EXPECT_EQ(root_instr->original_value()->ToString(), R\"(({\"w\"}))\");\n+}\n+\n TEST_F(WhileLoopSimplifierTest, RemoveConstantFromLoopCarry) {\n   const std::string hlo_string = R\"(\n   HloModule Test\n@@ -1481,6 +1510,88 @@ ENTRY %main (arg.0: f32[3], arg.1: f32[2]) -> (f32[3], f32[2], f32[2], f32[3]) {\n                         op::GetTupleElement(op::While(), 0)));\n }\n \n+TEST_F(WhileLoopSimplifierTest, RemoveConstantFromLoopCarryWithOriginalValue) {\n+  const std::string hlo_string = R\"(\n+  HloModule Test\n+  Body {\n+    param = (s32[1], s32[2], s32[3]) parameter(0)\n+    a = s32[1] get-tuple-element(param), index=0\n+    a.1 = s32[1] add(a, a)\n+    b = s32[2] constant({1,1})\n+    c = s32[3] constant({10,10,10})\n+    ROOT tuple = (s32[1], s32[2], s32[3]) tuple(a.1, b, c)\n+  }\n+  Cond {\n+    param = (s32[1], s32[2], s32[3]) parameter(0)\n+    a = s32[1] get-tuple-element(param), index=0\n+    b = s32[2] get-tuple-element(param), index=1\n+    c = s32[3] get-tuple-element(param), index=2\n+    ROOT cond = pred[] constant(true)\n+  }\n+  ENTRY Loop {\n+    a = s32[1] constant({0})\n+    b = s32[2] constant({1,1})\n+    c = s32[3] constant({2,2,2})\n+    init = (s32[1], s32[2], s32[3]) tuple(a,b,c), origin={({\"a\"},{\"b\"},{\"c\"})}\n+    ROOT while = (s32[1], s32[2], s32[3]) while(init),\n+      condition=Cond, body=Body, origin={({\"w0\"},{\"w1\"},{\"w2\"})}\n+  })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto m, ParseAndReturnVerifiedModule(hlo_string));\n+  EXPECT_TRUE(WhileLoopSimplifier().Run(m.get()).value());\n+  HloInstruction* while_instr = FindFirstWhile(m.get());\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_EQ(while_instr->original_value()->ToString(), R\"(({\"w0\"}, {\"w2\"}))\");\n+  HloInstruction* while_init = while_instr->while_init();\n+  ASSERT_NE(while_init->original_value(), nullptr);\n+  EXPECT_EQ(while_init->original_value()->ToString(), R\"(({\"a\"}, {\"c\"}))\");\n+  HloInstruction* root_instr = m->entry_computation()->root_instruction();\n+  ASSERT_NE(root_instr->original_value(), nullptr);\n+  EXPECT_EQ(root_instr->original_value()->ToString(),\n+            R\"(({\"w0\"}, {\"w1\"}, {\"w2\"}))\");\n+}\n+\n+TEST_F(WhileLoopSimplifierTest, RemoveConstantFromLoopCarryWithOriginalValue2) {\n+  const std::string hlo_string = R\"(\n+  HloModule Test\n+  Body {\n+    param = (s32[1], s32[2], s32[3]) parameter(0)\n+    a = s32[1] constant({1})\n+    b = s32[2] get-tuple-element(param), index=1\n+    b.1 = s32[2] add(b, b)\n+    c = s32[3] constant({10,10,10})\n+    ROOT tuple = (s32[1], s32[2], s32[3]) tuple(a, b.1, c)\n+  }\n+  Cond {\n+    param = (s32[1], s32[2], s32[3]) parameter(0)\n+    a = s32[1] get-tuple-element(param), index=0\n+    b = s32[2] get-tuple-element(param), index=1\n+    c = s32[3] get-tuple-element(param), index=2\n+    ROOT cond = pred[] constant(true)\n+  }\n+  ENTRY Loop {\n+    a = s32[1] constant({1})\n+    b = s32[2] constant({1,1})\n+    c = s32[3] constant({10,10,10})\n+    init = (s32[1], s32[2], s32[3]) tuple(a,b,c), origin={({\"a\"},{\"b\"},{\"c\"})}\n+    ROOT while = (s32[1], s32[2], s32[3]) while(init),\n+      condition=Cond, body=Body, origin={({\"w0\"},{\"w1\"},{\"w2\"})}\n+  })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto m, ParseAndReturnVerifiedModule(hlo_string));\n+  EXPECT_TRUE(WhileLoopSimplifier().Run(m.get()).value());\n+  HloInstruction* while_instr = FindFirstWhile(m.get());\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_EQ(while_instr->original_value()->ToString(), R\"(({\"w1\"}))\");\n+  HloInstruction* while_init = while_instr->while_init();\n+  ASSERT_NE(while_init->original_value(), nullptr);\n+  EXPECT_EQ(while_init->original_value()->ToString(), R\"(({\"b\"}))\");\n+  HloInstruction* root_instr = m->entry_computation()->root_instruction();\n+  ASSERT_NE(root_instr->original_value(), nullptr);\n+  EXPECT_EQ(root_instr->original_value()->ToString(),\n+            R\"(({\"w0\"}, {\"w1\"}, {\"w2\"}))\");\n+}\n+\n TEST_F(WhileLoopSimplifierTest, RemoveDeadTupleIndicesWithOriginalValue) {\n   const std::string hlo_string = R\"(\n   HloModule dus"
        }
    ],
    "stats": {
        "total": 143,
        "additions": 140,
        "deletions": 3
    }
}