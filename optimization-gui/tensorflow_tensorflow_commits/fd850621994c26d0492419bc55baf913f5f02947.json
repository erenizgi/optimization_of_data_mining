{
    "author": "tensorflower-gardener",
    "message": "Add hashing support for SymbolicMap\n\nThis change implements AbslHashValue and llvm::hash_value for xla::gpu::SymbolicMap.\n\nThis is a prerequisite for correctly implementing AbslHashValue for xla::IndexingMap after its internal migration to use SymbolicMap. Specifically, it needs be used in IndexingMap::AbslHashValue.\n\nPiperOrigin-RevId: 826038011",
    "sha": "fd850621994c26d0492419bc55baf913f5f02947",
    "files": [
        {
            "sha": "730a6e2896deed3b3909de3d59ec0ff57f1d2244",
            "filename": "third_party/xla/xla/hlo/analysis/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD?ref=fd850621994c26d0492419bc55baf913f5f02947",
            "patch": "@@ -748,6 +748,7 @@ xla_cc_test(\n     deps = [\n         \":symbolic_expr\",\n         \":symbolic_map\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:IR\",\n@@ -776,8 +777,9 @@ xla_cc_test(\n     name = \"symbolic_expr_test\",\n     srcs = [\"symbolic_expr_test.cc\"],\n     deps = [\n+        \":indexing_test_utils\",\n         \":symbolic_expr\",\n-        \"//xla/hlo/analysis:indexing_test_utils\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:IR\","
        },
        {
            "sha": "1f9a9ea27bf0fa54dc641540a3a26b6aba07ee94",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_expr.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr.h?ref=fd850621994c26d0492419bc55baf913f5f02947",
            "patch": "@@ -147,6 +147,11 @@ inline ::llvm::hash_code hash_value(SymbolicExpr expr) {\n   return ::llvm::hash_value(expr.GetImpl());\n }\n \n+template <typename H>\n+H AbslHashValue(H h, const SymbolicExpr& expr) {\n+  return H::combine(std::move(h), hash_value(expr));\n+}\n+\n class SymbolicExprContext {\n  public:\n   explicit SymbolicExprContext(mlir::MLIRContext* mlir_context);"
        },
        {
            "sha": "de928456263ba890396b5714b31825454c201475",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_expr_test.cc?ref=fd850621994c26d0492419bc55baf913f5f02947",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"absl/container/flat_hash_set.h\"\n #include \"llvm/ADT/DenseMap.h\"\n #include \"mlir/IR/AffineExpr.h\"\n #include \"mlir/IR/MLIRContext.h\"\n@@ -320,5 +321,36 @@ TEST_F(SymbolicExprTest, Walk) {\n                                                     \"v1\", \"((v0 + 42) * v1)\"));\n }\n \n+TEST_F(SymbolicExprTest, Hashing) {\n+  absl::flat_hash_set<SymbolicExpr> set;\n+\n+  SymbolicExpr c42_1 = ctx.CreateConstant(42);\n+  SymbolicExpr c42_2 = ctx.CreateConstant(42);\n+  SymbolicExpr c3 = ctx.CreateConstant(3);\n+\n+  set.insert(c42_1);\n+  set.insert(c42_2);\n+  set.insert(c3);\n+  EXPECT_EQ(set.size(), 2);\n+\n+  SymbolicExpr v0_1 = ctx.CreateVariable(0);\n+  SymbolicExpr v0_2 = ctx.CreateVariable(0);\n+  SymbolicExpr v1 = ctx.CreateVariable(1);\n+\n+  set.insert(v0_1);\n+  set.insert(v0_2);\n+  set.insert(v1);\n+  EXPECT_EQ(set.size(), 4);\n+\n+  SymbolicExpr add1 = v0_1 + c42_1;\n+  SymbolicExpr add2 = v0_2 + c42_2;\n+  SymbolicExpr add3 = v1 + c3;\n+\n+  set.insert(add1);\n+  set.insert(add2);\n+  set.insert(add3);\n+  EXPECT_EQ(set.size(), 6);\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "4e708811bc822f5e0329b503e186b3cb65504c2a",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_map.h",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map.h?ref=fd850621994c26d0492419bc55baf913f5f02947",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n #include <string>\n \n #include \"absl/types/span.h\"\n+#include \"llvm/ADT/Hashing.h\"\n #include \"llvm/ADT/SmallBitVector.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"xla/hlo/analysis/symbolic_expr.h\"\n@@ -95,6 +96,18 @@ class SymbolicMap {\n   bool operator==(const SymbolicMap& other) const;\n   bool operator!=(const SymbolicMap& other) const { return !(*this == other); }\n \n+  template <typename H>\n+  friend H AbslHashValue(H h, const SymbolicMap& map) {\n+    return H::combine(std::move(h), map.num_dimensions_, map.num_symbols_,\n+                      map.exprs_);\n+  }\n+\n+  friend ::llvm::hash_code hash_value(const SymbolicMap& map) {\n+    return ::llvm::hash_combine(\n+        map.num_dimensions_, map.num_symbols_,\n+        ::llvm::hash_combine_range(map.exprs_.begin(), map.exprs_.end()));\n+  }\n+\n   template <typename Sink>\n   friend void AbslStringify(Sink& sink, const SymbolicMap& map) {\n     sink.Append(map.ToString());\n@@ -128,6 +141,11 @@ SymbolicMap CompressDims(const SymbolicMap& map,\n SymbolicMap CompressSymbols(const SymbolicMap& map,\n                             const llvm::SmallBitVector& unused_symbols);\n \n+template <typename H>\n+H AbslHashValue(H h, const llvm::SmallVector<SymbolicExpr>& vec) {\n+  return H::combine(std::move(h), absl::MakeSpan(vec));\n+}\n+\n }  // namespace xla\n \n #endif  // XLA_HLO_ANALYSIS_SYMBOLIC_MAP_H_"
        },
        {
            "sha": "a317b03c7a6221e6e03b9326ba76e74087804376",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_map_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fd850621994c26d0492419bc55baf913f5f02947/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map_test.cc?ref=fd850621994c26d0492419bc55baf913f5f02947",
            "patch": "@@ -17,6 +17,7 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"absl/container/flat_hash_set.h\"\n #include \"llvm/ADT/SmallBitVector.h\"\n #include \"mlir/IR/MLIRContext.h\"\n #include \"xla/hlo/analysis/symbolic_expr.h\"\n@@ -328,6 +329,27 @@ TEST_F(SymbolicMapTest, CompressSymbols) {\n                \"Attempting to compress a used symbol: 2\");\n }\n \n+TEST_F(SymbolicMapTest, Hashing) {\n+  absl::flat_hash_set<SymbolicMap> set;\n+\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+  SymbolicExpr s0 = ctx.CreateVariable(2);\n+  SymbolicExpr c42 = ctx.CreateConstant(42);\n+  SymbolicExpr c99 = ctx.CreateConstant(99);\n+\n+  SymbolicMap map1 = SymbolicMap::Get(&ctx, 2, 1, {d0 + s0, d1 * c42});\n+  SymbolicMap map2 = SymbolicMap::Get(&ctx, 2, 1, {d0 + s0, d1 * c42});\n+  SymbolicMap map3 = SymbolicMap::Get(&ctx, 2, 1, {d0 + s0, d1 * c99});\n+\n+  set.insert(map1);\n+  EXPECT_EQ(set.size(), 1);\n+  set.insert(map2);\n+  EXPECT_EQ(set.size(), 1);\n+  set.insert(map3);\n+  EXPECT_EQ(set.size(), 2);\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 80,
        "deletions": 1
    }
}