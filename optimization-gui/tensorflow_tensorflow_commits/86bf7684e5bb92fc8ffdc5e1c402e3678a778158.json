{
    "author": "tensorflower-gardener",
    "message": "Pathways status_annotator_util: Group by stack traces and sort.\n\nPiperOrigin-RevId: 828161945",
    "sha": "86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
    "files": [
        {
            "sha": "5e2f317119c0f6707355fa87a8104faa75425184",
            "filename": "third_party/xla/xla/python/ifrt/test_util.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.cc?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -18,6 +18,8 @@ limitations under the License.\n #include <cstdint>\n #include <functional>\n #include <memory>\n+#include <optional>\n+#include <string>\n #include <utility>\n \n #include \"absl/base/thread_annotations.h\"\n@@ -123,7 +125,11 @@ absl::StatusOr<DeviceListRef> GetAddressableDevices(\n   return client->MakeDeviceList(std::move(devices));\n }\n \n-UserContextRef MakeUserContext(uint64_t id) {\n+UserContextRef MakeUserContext(uint64_t id,\n+                               std::optional<std::string> debug_string) {\n+  if (debug_string.has_value()) {\n+    return TestUserContext::Create(UserContextId(id), *std::move(debug_string));\n+  }\n   return TestUserContext::Create(UserContextId(id));\n }\n "
        },
        {
            "sha": "efd122a7d92950c74114bcd9974d414a1d1ed4e6",
            "filename": "third_party/xla/xla/python/ifrt/test_util.h",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Ftest_util.h?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <functional>\n #include <memory>\n #include <optional>\n+#include <string>\n #include <vector>\n \n #include \"absl/status/statusor.h\"\n@@ -97,8 +98,11 @@ absl::StatusOr<DeviceListRef> GetAddressableDevices(\n     Client* client, absl::Span<const int> device_indices);\n \n // Returns a new `UserContext` for testing. The created `UserContext` has an\n-// ID equal to `id`.\n-UserContextRef MakeUserContext(uint64_t id);\n+// ID equal to `id`. `debug_string` defaults to `TestUserContext(id)`. This can\n+// be overridden with a custom debug string for the tests that must use\n+// multiple `UserContext`s with the same debug string.\n+UserContextRef MakeUserContext(\n+    uint64_t id, std::optional<std::string> debug_string = std::nullopt);\n \n }  // namespace test_util\n }  // namespace ifrt"
        },
        {
            "sha": "35b79f86459ed62bb1b3bad733901c583bac7e58",
            "filename": "third_party/xla/xla/python/ifrt/user_context_test_util.h",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test_util.h?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -17,6 +17,7 @@ limitations under the License.\n #define XLA_PYTHON_IFRT_USER_CONTEXT_TEST_UTIL_H_\n \n #include <string>\n+#include <utility>\n \n #include \"absl/strings/str_cat.h\"\n #include \"llvm/Support/ExtensibleRTTI.h\"\n@@ -29,21 +30,26 @@ namespace ifrt {\n class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n  public:\n   static UserContextRef Create(UserContextId id) {\n-    return tsl::TakeRef<TestUserContext>(new TestUserContext(id));\n+    return Create(id, absl::StrCat(\"TestUserContext(\", id.value(), \")\"));\n+  }\n+\n+  static UserContextRef Create(UserContextId id, std::string debug_string) {\n+    return tsl::TakeRef<TestUserContext>(\n+        new TestUserContext(id, std::move(debug_string)));\n   }\n \n   UserContextId Id() const override { return id_; }\n \n-  std::string DebugString() const override {\n-    return absl::StrCat(\"TestUserContext(\", id_.value(), \")\");\n-  }\n+  std::string DebugString() const override { return debug_string_; }\n \n   // No new `ID` is not defined because tests below do not exercise RTTI.\n \n  private:\n-  explicit TestUserContext(UserContextId id) : id_(id) {}\n+  explicit TestUserContext(UserContextId id, std::string debug_string)\n+      : id_(id), debug_string_(std::move(debug_string)) {}\n \n   UserContextId id_;\n+  std::string debug_string_;\n };\n \n }  // namespace ifrt"
        },
        {
            "sha": "ed69558c0c0665ece559731b7d6dbe852e1d83bd",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2FBUILD?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -29,6 +29,7 @@ cc_library(\n         \"//xla/python/ifrt:user_context_registry\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:status_to_from_proto\",\n+        \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n@@ -37,6 +38,7 @@ cc_library(\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/time\",\n+        \"@local_tsl//tsl/platform:fingerprint\",\n     ],\n     alwayslink = 1,\n )"
        },
        {
            "sha": "e4e85af6ead7c93120772f57643aebbd1ba16e0f",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator.proto",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator.proto?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -40,10 +40,18 @@ message ObjectStoreDumpProto {\n     repeated PerCreator per_creator = 2;\n   }\n \n+  message Dump {\n+    repeated PerErrorContext per_error_context = 1;\n+    string warning = 2;\n+  }\n+\n   string device = 1;\n   fixed64 dump_timestamp_ns = 2;\n \n-  // One of 'dump_failed' or 'per_error_context' is filled.\n-  tensorflow.StatusProto dump_failed = 3;\n-  repeated PerErrorContext per_error_context = 4;\n+  oneof result_statusor {\n+    tensorflow.StatusProto dump_failed = 5;\n+    Dump dump = 6;\n+  }\n+\n+  reserved 3, 4;\n }"
        },
        {
            "sha": "5d0af1a5399102b598d5e23a02a410959a97715d",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.cc",
            "status": "modified",
            "additions": 96,
            "deletions": 19,
            "changes": 115,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.cc?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -15,11 +15,15 @@ limitations under the License.\n \n #include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.h\"\n \n+#include <algorithm>\n+#include <cstdint>\n #include <memory>\n #include <optional>\n #include <string>\n+#include <utility>\n #include <vector>\n \n+#include \"absl/container/flat_hash_map.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n@@ -34,12 +38,74 @@ limitations under the License.\n #include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator.pb.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/status_to_from_proto.h\"\n+#include \"tsl/platform/fingerprint.h\"\n \n namespace ifrt_proxy_contrib_pathways {\n \n static constexpr absl::string_view kObjectStoreDumpPayloadUrl =\n     \"type.googleapis.com/ifrt_proxy_contrib_pathways.ObjectStoreDumpProto\";\n \n+static constexpr int kMaxCitedTraces = 20;\n+\n+struct PerStackTrace {\n+  struct PerCreator {\n+    int64_t ready_obj_count = 0;\n+    int64_t ready_total_size = 0;\n+    int64_t not_ready_obj_count = 0;\n+    int64_t not_ready_total_size = 0;\n+  };\n+  std::string stack_trace;\n+  absl::flat_hash_map<std::string, PerCreator> per_creator;\n+  int64_t total_size = 0;\n+};\n+\n+std::vector<std::unique_ptr<PerStackTrace>> SortedPerStackTrace(\n+    const ObjectStoreDumpProto& object_store_dump) {\n+  std::vector<std::unique_ptr<PerStackTrace>> result;\n+  absl::flat_hash_map<uint64_t, PerStackTrace*> per_stack_trace;\n+  for (const auto& per_error_context :\n+       object_store_dump.dump().per_error_context()) {\n+    xla::ifrt::TrackedUserContextRef tracked_user_context =\n+        xla::ifrt::UserContextRegistry::Get().Lookup(\n+            xla::ifrt::UserContextId(per_error_context.error_context_id()));\n+    std::string stack_trace = \"unknown\";\n+    if (tracked_user_context != nullptr) {\n+      stack_trace = tracked_user_context->user_context()->DebugString();\n+    }\n+    uint64_t stack_trace_fprint = tsl::Fingerprint64(stack_trace);\n+\n+    PerStackTrace* entry = nullptr;\n+    if (auto it = per_stack_trace.find(stack_trace_fprint);\n+        it != per_stack_trace.end()) {\n+      entry = it->second;\n+    } else {\n+      entry = result.emplace_back(std::make_unique<PerStackTrace>()).get();\n+      entry->stack_trace = stack_trace;\n+      per_stack_trace.insert(it, {stack_trace_fprint, entry});\n+    }\n+\n+    for (const auto& per_creator : per_error_context.per_creator()) {\n+      PerStackTrace::PerCreator& creator =\n+          entry->per_creator[per_creator.creator()];\n+      creator.ready_obj_count += per_creator.ready_obj_count();\n+      creator.ready_total_size += per_creator.ready_total_size();\n+      creator.not_ready_obj_count += per_creator.not_ready_obj_count();\n+      creator.not_ready_total_size += per_creator.not_ready_total_size();\n+      entry->total_size +=\n+          per_creator.ready_total_size() + per_creator.not_ready_total_size();\n+    }\n+  }\n+\n+  auto is_bigger = [](const std::unique_ptr<PerStackTrace>& a,\n+                      const std::unique_ptr<PerStackTrace>& b) {\n+    return (a->total_size > b->total_size);\n+  };\n+\n+  std::sort(result.begin(), result.end(), is_bigger);\n+\n+  return result;\n+}\n+\n static void ExpandObjectStoreDump(absl::Status& status) {\n   std::optional<absl::Cord> payload =\n       status.GetPayload(kObjectStoreDumpPayloadUrl);\n@@ -61,24 +127,33 @@ static void ExpandObjectStoreDump(absl::Status& status) {\n   std::string header = absl::StrCat(\n       \"Pathways object-store summary for device \", object_store_dump.device(),\n       \" at \", absl::FromUnixNanos(object_store_dump.dump_timestamp_ns()));\n-  absl::Status error = tsl::StatusFromProto(object_store_dump.dump_failed());\n-  if (!error.ok()) {\n+\n+  if (object_store_dump.has_dump_failed()) {\n+    absl::Status error = tsl::StatusFromProto(object_store_dump.dump_failed());\n     tsl::errors::AppendToMessage(\n         &status, \"\\n\", header, \" got error while dumping: \", error.ToString());\n     return;\n   }\n \n+  auto sorted_per_stack_trace = SortedPerStackTrace(object_store_dump);\n+  absl::StrAppend(&header, \" (showing \",\n+                  std::min(kMaxCitedTraces,\n+                           static_cast<int>(sorted_per_stack_trace.size())),\n+                  \" of \", sorted_per_stack_trace.size(), \" entries)\");\n+\n+  if (!object_store_dump.dump().warning().empty()) {\n+    absl::StrAppend(&header, \" (warning: \", object_store_dump.dump().warning(),\n+                    \")\");\n+  }\n+\n   std::vector<std::string> cited_traces;\n   tsl::errors::AppendToMessage(&status, \"\\n\", header, \":\");\n-  for (const auto& per_error_context : object_store_dump.per_error_context()) {\n-    xla::ifrt::TrackedUserContextRef tracked_user_context =\n-        xla::ifrt::UserContextRegistry::Get().Lookup(\n-            xla::ifrt::UserContextId(per_error_context.error_context_id()));\n-    if (tracked_user_context != nullptr) {\n-      std::string trace = tracked_user_context->user_context()->DebugString();\n-      absl::StrReplaceAll({{\"\\n\", \"\\t\"}}, &trace);\n-      absl::StrReplaceAll({{\"\\t\", \"\\n                \"}}, &trace);\n-      cited_traces.push_back(trace);\n+  for (const auto& per_error_context : sorted_per_stack_trace) {\n+    std::string stack_trace = std::move(per_error_context->stack_trace);\n+    if (stack_trace != \"unknown\") {\n+      absl::StrReplaceAll({{\"\\n\", \"\\t\"}}, &stack_trace);\n+      absl::StrReplaceAll({{\"\\t\", \"\\n                \"}}, &stack_trace);\n+      cited_traces.push_back(stack_trace);\n       tsl::errors::AppendToMessage(\n           &status, \"  - The following entries arise from user stack [\",\n           cited_traces.size(), \"]:\");\n@@ -87,14 +162,16 @@ static void ExpandObjectStoreDump(absl::Status& status) {\n           &status,\n           \"  - The following entries arise from an unknown user stack:\");\n     }\n-    for (const auto& per_creator : per_error_context.per_creator()) {\n-      tsl::errors::AppendToMessage(&status, \"      + \", per_creator.creator(),\n-                                   \" with \", per_creator.ready_obj_count(),\n-                                   \" 'ready' buffers of total size \",\n-                                   per_creator.ready_total_size(), \" and \",\n-                                   per_creator.not_ready_obj_count(),\n-                                   \" 'not ready' buffers of total size \",\n-                                   per_creator.not_ready_total_size());\n+    for (const auto& [creator, per_creator] : per_error_context->per_creator) {\n+      tsl::errors::AppendToMessage(\n+          &status, \"      + \", creator, \" with \", per_creator.ready_obj_count,\n+          \" 'ready' buffers of total size \", per_creator.ready_total_size,\n+          \" and \", per_creator.not_ready_obj_count,\n+          \" 'not ready' buffers of total size \",\n+          per_creator.not_ready_total_size);\n+    }\n+    if (cited_traces.size() >= kMaxCitedTraces) {\n+      break;\n     }\n   }\n   for (int i = 0; i < cited_traces.size(); ++i) {"
        },
        {
            "sha": "4ffffa6694395aa2c92d697b080cef0151085b7e",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator_util_test.cc",
            "status": "modified",
            "additions": 83,
            "deletions": 4,
            "changes": 87,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86bf7684e5bb92fc8ffdc5e1c402e3678a778158/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util_test.cc?ref=86bf7684e5bb92fc8ffdc5e1c402e3678a778158",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.h\"\n \n+#include <optional>\n #include <string>\n #include <vector>\n \n@@ -32,6 +33,8 @@ namespace ifrt_proxy_contrib_pathways {\n namespace {\n \n using ::testing::HasSubstr;\n+using ::testing::Not;\n+using ::xla::ifrt::TrackedUserContextRef;\n \n TEST(StatusAnnotatorUtilTest, SimpleAnnotateAndExpand) {\n   ObjectStoreDumpProto object_store_dump;\n@@ -59,17 +62,23 @@ TEST(StatusAnnotatorUtilTest, ExpandFailedDump) {\n               HasSubstr(\"dump failed\"));\n }\n \n+static TrackedUserContextRef RegisterNewContext(\n+    int context, std::optional<std::string> debug_string = std::nullopt) {\n+  return xla::ifrt::UserContextRegistry::Get().Register(\n+      xla::ifrt::test_util::MakeUserContext(context, debug_string));\n+}\n+\n TEST(StatusAnnotatorUtilTest, DumpWithManyContentsExpandsToAllDetails) {\n   ObjectStoreDumpProto object_store_dump;\n   object_store_dump.set_device(\"tpu:0\");\n \n-  std::vector<xla::ifrt::TrackedUserContextRef> user_context_refs;\n+  std::vector<TrackedUserContextRef> user_context_refs;\n \n   for (int context : {1000, 2000, 3000}) {\n-    user_context_refs.push_back(xla::ifrt::UserContextRegistry::Get().Register(\n-        xla::ifrt::test_util::MakeUserContext(context)));\n+    user_context_refs.push_back(RegisterNewContext(context));\n \n-    auto* per_error_context = object_store_dump.add_per_error_context();\n+    auto* per_error_context =\n+        object_store_dump.mutable_dump()->add_per_error_context();\n     per_error_context->set_error_context_id(context);\n \n     for (int creator : {100, 200}) {\n@@ -104,5 +113,75 @@ TEST(StatusAnnotatorUtilTest, DumpWithManyContentsExpandsToAllDetails) {\n   }\n }\n \n+TEST(StatusAnnotatorUtilTest, DumpWithDuplicateStackTraces) {\n+  ObjectStoreDumpProto object_store_dump;\n+  object_store_dump.set_device(\"tpu:0\");\n+\n+  std::vector<TrackedUserContextRef> user_context_refs;\n+\n+  for (int context : {1000, 2000}) {\n+    user_context_refs.push_back(\n+        RegisterNewContext(context, /*debug_string=*/\"foobar\"));\n+\n+    auto* per_error_context =\n+        object_store_dump.mutable_dump()->add_per_error_context();\n+    per_error_context->set_error_context_id(context);\n+\n+    auto* per_creator = per_error_context->add_per_creator();\n+    *per_creator->mutable_creator() = \"creator1\";\n+    per_creator->set_ready_obj_count(1);\n+    per_creator->set_ready_total_size(1);\n+    per_creator->set_not_ready_obj_count(1);\n+    per_creator->set_not_ready_total_size(1);\n+  }\n+\n+  absl::Status status = absl::InternalError(\"test error\");\n+  AnnotateIfrtUserStatusWithObjectStoreDump(status, object_store_dump);\n+\n+  std::string expanded(xla::ifrt::ExpandUserContexts(status).message());\n+\n+  EXPECT_THAT(expanded, HasSubstr(\"foobar\"));\n+  EXPECT_THAT(expanded, HasSubstr(\"2 'ready' buffers of total size 2\"));\n+  EXPECT_THAT(expanded, HasSubstr(\"2 'not ready' buffers of total size 2\"));\n+\n+  EXPECT_EQ(expanded.find(\"foobar\"), expanded.rfind(\"foobar\"));\n+  EXPECT_EQ(expanded.find(\"'ready' buffers\"),\n+            expanded.rfind(\"'ready' buffers\"));\n+}\n+\n+TEST(StatusAnnotatorUtilTest, CitationsWithUnknownStackTraces) {\n+  ObjectStoreDumpProto object_store_dump;\n+  object_store_dump.set_device(\"tpu:0\");\n+\n+  std::vector<TrackedUserContextRef> user_context_refs;\n+\n+  for (int context : {1000, 2000, 3000}) {\n+    if (context != 2000) {\n+      user_context_refs.push_back(RegisterNewContext(context));\n+    }\n+\n+    auto* per_error_context =\n+        object_store_dump.mutable_dump()->add_per_error_context();\n+    per_error_context->set_error_context_id(context);\n+\n+    auto* per_creator = per_error_context->add_per_creator();\n+    *per_creator->mutable_creator() = absl::StrCat(\"creator\", context);\n+    per_creator->set_ready_obj_count(context + 1);\n+    per_creator->set_ready_total_size(context + 2);\n+    per_creator->set_not_ready_obj_count(context + 3);\n+    per_creator->set_not_ready_total_size(context + 4);\n+  }\n+\n+  absl::Status status = absl::InternalError(\"test error\");\n+  AnnotateIfrtUserStatusWithObjectStoreDump(status, object_store_dump);\n+\n+  std::string expanded(xla::ifrt::ExpandUserContexts(status).message());\n+  EXPECT_THAT(expanded, HasSubstr(\"unknown user stack\"));\n+  EXPECT_THAT(expanded, HasSubstr(\"[  1]   TestUserContext(3000)\"));\n+  EXPECT_THAT(expanded, HasSubstr(\"[  2]   TestUserContext(1000)\"));\n+  EXPECT_THAT(expanded, Not(HasSubstr(\"[  3]\")));\n+  EXPECT_THAT(expanded, Not(HasSubstr(\"[3]\")));\n+}\n+\n }  // namespace\n }  // namespace ifrt_proxy_contrib_pathways"
        }
    ],
    "stats": {
        "total": 250,
        "additions": 216,
        "deletions": 34
    }
}