{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Refactor Canonicalize to handle constants early.\n\nPiperOrigin-RevId: 797670575",
    "sha": "20e4988f030fd6bef5b6977c4c932fa1427fe7ff",
    "files": [
        {
            "sha": "a38c5d0f2224a00bbd60fc2aaae88469d5103176",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 20,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20e4988f030fd6bef5b6977c4c932fa1427fe7ff/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20e4988f030fd6bef5b6977c4c932fa1427fe7ff/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=20e4988f030fd6bef5b6977c4c932fa1427fe7ff",
            "patch": "@@ -222,11 +222,6 @@ void ExtractTerms(SymbolicExpr expr,\n SymbolicExpr CanonicalizeAdd(SymbolicExpr lhs, SymbolicExpr rhs) {\n   SymbolicExprContext* ctx = lhs.GetContext();\n \n-  // Constant folding\n-  if (lhs.GetType() == SymbolicExprType::kConstant &&\n-      rhs.GetType() == SymbolicExprType::kConstant) {\n-    return ctx->CreateConstant(lhs.GetValue() + rhs.GetValue());\n-  }\n   // Neutral element\n   if (lhs.GetType() == SymbolicExprType::kConstant && lhs.GetValue() == 0) {\n     return rhs;\n@@ -286,11 +281,6 @@ SymbolicExpr CanonicalizeAdd(SymbolicExpr lhs, SymbolicExpr rhs) {\n SymbolicExpr CanonicalizeMul(SymbolicExpr lhs, SymbolicExpr rhs) {\n   SymbolicExprContext* ctx = lhs.GetContext();\n \n-  if (lhs.GetType() == SymbolicExprType::kConstant &&\n-      rhs.GetType() == SymbolicExprType::kConstant) {\n-    return ctx->CreateConstant(lhs.GetValue() * rhs.GetValue());\n-  }\n-\n   // Commutativity: C * X => X * C\n   if (lhs.GetType() == SymbolicExprType::kConstant) {\n     std::swap(lhs, rhs);\n@@ -552,25 +542,37 @@ SymbolicExpr SymbolicExpr::Canonicalize() const {\n     return *this;\n   }\n \n-  switch (GetType()) {\n+  SymbolicExprType type = GetType();\n+  if (type == SymbolicExprType::kConstant ||\n+      type == SymbolicExprType::kVariable) {\n+    return *this;\n+  }\n+\n+  SymbolicExpr lhs = this->GetLHS().Canonicalize();\n+  SymbolicExpr rhs = this->GetRHS().Canonicalize();\n+\n+  if (lhs.GetType() == SymbolicExprType::kConstant &&\n+      rhs.GetType() == SymbolicExprType::kConstant) {\n+    return GetContext()->CreateConstant(\n+        SymbolicExpr(GetContext()->CreateBinaryOp(type, lhs, rhs))\n+            .Evaluate({}));\n+  }\n+\n+  switch (type) {\n     case SymbolicExprType::kConstant:\n     case SymbolicExprType::kVariable:\n       return *this;\n     case SymbolicExprType::kAdd:\n-      return CanonicalizeAdd(this->GetLHS().Canonicalize(),\n-                             this->GetRHS().Canonicalize());\n+      return CanonicalizeAdd(lhs, rhs);\n     case SymbolicExprType::kMul:\n-      return CanonicalizeMul(this->GetLHS().Canonicalize(),\n-                             this->GetRHS().Canonicalize());\n+      return CanonicalizeMul(lhs, rhs);\n     case SymbolicExprType::kMin:\n-      return CanonicalizeMin(this->GetLHS().Canonicalize(),\n-                             this->GetRHS().Canonicalize());\n+      return CanonicalizeMin(lhs, rhs);\n     case SymbolicExprType::kMax:\n-      return CanonicalizeMax(this->GetLHS().Canonicalize(),\n-                             this->GetRHS().Canonicalize());\n+      return CanonicalizeMax(lhs, rhs);\n     default:\n       // TODO(b/433693793): Implement canonicalization for other types.\n-      return *this;\n+      return GetContext()->CreateBinaryOp(type, lhs, rhs);\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 42,
        "additions": 22,
        "deletions": 20
    }
}