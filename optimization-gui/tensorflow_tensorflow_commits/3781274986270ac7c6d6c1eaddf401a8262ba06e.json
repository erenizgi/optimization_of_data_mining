{
    "author": "junwhanahn",
    "message": "Fix a bug where PjRt CPU does not respect `non_donatable_input_indices`\n\nPiperOrigin-RevId: 800116340",
    "sha": "3781274986270ac7c6d6c1eaddf401a8262ba06e",
    "files": [
        {
            "sha": "c799239c24324aa11aedfb994c7aad40dcfcfbfe",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3781274986270ac7c6d6c1eaddf401a8262ba06e/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3781274986270ac7c6d6c1eaddf401a8262ba06e/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=3781274986270ac7c6d6c1eaddf401a8262ba06e",
            "patch": "@@ -1324,7 +1324,8 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n     TrackedCpuDeviceBuffer* tracked_buffer;\n     auto get_buffer = [&](int i) -> absl::Status {\n       bool must_donate = donate_it != parameters_that_must_be_donated_.end() &&\n-                         *donate_it == i;\n+                         *donate_it == i &&\n+                         !options.non_donatable_input_indices.contains(i);\n       TF_RETURN_IF_ERROR(TestBufferDonationClashes(\n           cpu_buffer, donation_clashes, must_donate, i, replica, partition));\n       if (must_donate) {"
        },
        {
            "sha": "b8876b552fa708b7ffffc7ed4ecba6038055ae31",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client_test.cc",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3781274986270ac7c6d6c1eaddf401a8262ba06e/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3781274986270ac7c6d6c1eaddf401a8262ba06e/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc?ref=3781274986270ac7c6d6c1eaddf401a8262ba06e",
            "patch": "@@ -166,6 +166,58 @@ ENTRY DonationWithExecutionError() -> f32[2, 2] {\n               HasSubstr(\"buffer has been deleted or donated.\"));\n }\n \n+TEST(PjRtCpuClientTest, RuntimeDonationDenial) {\n+  static constexpr char kProgram[] =\n+      R\"(\n+HloModule RuntimeDonationDenial,\n+          input_output_alias={ {}: (0, {}, must-alias) }\n+\n+ENTRY RuntimeDonationDenial() -> f32[2, 2] {\n+    ROOT %param = f32[2, 2] parameter(0)\n+})\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto client, GetPjRtCpuClient(CpuClientOptions()));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto hlo_module,\n+                          ParseAndReturnUnverifiedModule(kProgram, {}));\n+  XlaComputation xla_computation(hlo_module->ToProto());\n+  TF_ASSERT_OK_AND_ASSIGN(auto pjrt_executable,\n+                          client->CompileAndLoad(xla_computation, {}));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto fingerprint,\n+                          pjrt_executable->FingerprintExecutable());\n+  ASSERT_TRUE(!fingerprint.empty());\n+\n+  std::vector<float> data(4, 0);\n+  Shape shape = ShapeUtil::MakeShape(F32, {2, 2});\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto buffer,\n+      client->BufferFromHostBuffer(\n+          data.data(), shape.element_type(), shape.dimensions(),\n+          /*byte_strides=*/std::nullopt,\n+          PjRtClient::HostBufferSemantics::kImmutableOnlyDuringCall, nullptr,\n+          client->memory_spaces()[0], /*device_layout=*/nullptr));\n+\n+  {\n+    ExecuteOptions options;\n+    options.non_donatable_input_indices.insert(0);\n+    auto result = pjrt_executable->Execute(\n+        /*argument_handles=*/{{buffer.get()}}, options);\n+    TF_ASSERT_OK(result);\n+\n+    EXPECT_FALSE(buffer->IsDeleted());\n+  }\n+\n+  {\n+    ExecuteOptions options;\n+    auto result = pjrt_executable->Execute(\n+        /*argument_handles=*/{{buffer.get()}}, options);\n+    TF_ASSERT_OK(result);\n+\n+    EXPECT_TRUE(buffer->IsDeleted());\n+  }\n+}\n+\n TEST(PjRtCpuClientTest, HloSnapshot) {\n   static constexpr char kProgram[] = R\"(\n     HloModule add"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 54,
        "deletions": 1
    }
}