{
    "author": "vwbaker",
    "message": "Use arith::OrIOp op for predicate add\n\nWhen using arith::AddIOp for predicate add, we get different semantics from what XLA specifies https://github.com/openxla/stablehlo/blob/main/docs/spec.md#add (namely pred(1)+pred(1) should equal pred(1), but arith implements this as pred(0)).\n\nPiperOrigin-RevId: 813728257",
    "sha": "84f86202b33b0d5a374b65477afccd4f48c37e08",
    "files": [
        {
            "sha": "dc0773781aa07eecb2fbb2e203c15f8fe52483f6",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/emitter_helpers.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84f86202b33b0d5a374b65477afccd4f48c37e08/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Femitter_helpers.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84f86202b33b0d5a374b65477afccd4f48c37e08/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Femitter_helpers.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Femitter_helpers.cc?ref=84f86202b33b0d5a374b65477afccd4f48c37e08",
            "patch": "@@ -441,6 +441,11 @@ absl::StatusOr<Value> EmitElementwise(EmitterLocOpBuilder& b,\n     }\n     case HloOpcode::kAdd:\n       if (is_integer) {\n+        // XLA add semantics for predicates is equal to bitwise OR, while Arith\n+        // defines it differently. Replace add with or in this case.\n+        if (inputs[0].getType().isInteger(1)) {\n+          return b.create<ma::OrIOp>(inputs[0], inputs[1]);\n+        }\n         return b.create<ma::AddIOp>(inputs[0], inputs[1]);\n       }\n       return b.create<ma::AddFOp>(inputs[0], inputs[1]);"
        },
        {
            "sha": "37ccb44090e1ba20c14433293f095ff35ac3be2a",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter_device_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84f86202b33b0d5a374b65477afccd4f48c37e08/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84f86202b33b0d5a374b65477afccd4f48c37e08/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc?ref=84f86202b33b0d5a374b65477afccd4f48c37e08",
            "patch": "@@ -203,6 +203,33 @@ ENTRY entry {\n       hlo_text, ErrorSpec{/*aabs=*/1e-4, /*arel=*/1e-6}));\n }\n \n+TEST_F(TritonEmitterTest, PredicateAddIsEmittedCorrectly) {\n+  constexpr absl::string_view kHloText = R\"(\n+HloModule m\n+\n+fused_add {\n+  param_0 = pred[] parameter(0)\n+  param_1 = pred[] parameter(1)\n+  ROOT add = pred[] add(param_0, param_1)\n+}\n+\n+ENTRY main {\n+  c0 = pred[] constant(1)\n+  c1 = pred[] constant(1)\n+  ROOT add = pred[] fusion(c0, c1), kind=kCustom, calls=fused_add,\n+    backend_config={\"fusion_backend_config\":{\n+      \"kind\":\"__triton\",\n+      \"block_level_fusion_config\":{\n+        \"num_warps\":\"1\",\"output_tiles\":[{\"sizes\":[]}],\n+        \"num_ctas\":1,\"num_stages\":1,\"is_tma_allowed\":false}}}\n+}\n+)\";\n+  TF_EXPECT_OK(CreateTritonIrAndFileCheck(this, kHloText, \"fused_add\", R\"(\n+CHECK: arith.ori {{.*}} : i1\n+)\"));\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n+}\n+\n // TODO(bchetioui): turn this into a general binary elementwise test.\n TEST_F(TritonEmitterTest, MinimumIsEmittedCorrectly) {\n   constexpr absl::string_view kHloText = R\"("
        }
    ],
    "stats": {
        "total": 32,
        "additions": 32,
        "deletions": 0
    }
}