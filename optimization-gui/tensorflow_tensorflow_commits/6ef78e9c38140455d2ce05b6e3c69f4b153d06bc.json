{
    "author": "ezhulenev",
    "message": "[xla:codegen] Parametrize KernelEmitter by kernel source type\n\nRemove one level of template indirection by always parametrizing by a kernel source type.\n\nPiperOrigin-RevId: 825295806",
    "sha": "6ef78e9c38140455d2ce05b6e3c69f4b153d06bc",
    "files": [
        {
            "sha": "daef8650044d06f7d5f1af847085619458f2b15c",
            "filename": "third_party/xla/xla/codegen/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2FBUILD?ref=6ef78e9c38140455d2ce05b6e3c69f4b153d06bc",
            "patch": "@@ -63,6 +63,7 @@ cc_library(\n     hdrs = [\"kernel_emitter.h\"],\n     deps = [\n         \":kernel_definition\",\n+        \":kernel_source\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "1900f84a85dccee61d53ed956792bcd80340866a",
            "filename": "third_party/xla/xla/codegen/kernel_emitter.h",
            "status": "modified",
            "additions": 24,
            "deletions": 8,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_emitter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_emitter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_emitter.h?ref=6ef78e9c38140455d2ce05b6e3c69f4b153d06bc",
            "patch": "@@ -21,35 +21,51 @@ limitations under the License.\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/codegen/kernel_definition.h\"\n+#include \"xla/codegen/kernel_source.h\"\n #include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n \n+//===----------------------------------------------------------------------===//\n+// KernelEmitterBase.\n+//===----------------------------------------------------------------------===//\n+\n+// A base class for emitting XLA kernels.\n class KernelEmitterBase {\n  public:\n+  KernelEmitterBase() = default;\n   virtual ~KernelEmitterBase() = default;\n \n   virtual absl::string_view name() const = 0;\n \n   virtual absl::StatusOr<std::unique_ptr<KernelDefinitionBase>>\n-  EmitBaseKernelDefinition() = 0;\n+  EmitKernelDefinitionBase() = 0;\n+\n+ protected:\n+  KernelEmitterBase(KernelEmitterBase&&) = default;\n+  KernelEmitterBase& operator=(KernelEmitterBase&&) = default;\n };\n \n+//===----------------------------------------------------------------------===//\n+// KernelEmitter.\n+//===----------------------------------------------------------------------===//\n+\n // KernelEmitter is an API that emits kernel definition from a given input\n // (i.e. it emits kernels compiled from HLO fusions).\n-template <typename KernelDefinitionType>\n+template <typename Source>\n class KernelEmitter : public KernelEmitterBase {\n  public:\n-  virtual ~KernelEmitter() = default;\n+  static_assert(std::is_base_of_v<KernelSource, Source>,\n+                \"Source must be a subclass of KernelSource\");\n \n-  virtual absl::StatusOr<KernelDefinitionType> EmitKernelDefinition() = 0;\n+  virtual absl::StatusOr<KernelDefinition<Source>> EmitKernelDefinition() = 0;\n \n  private:\n   absl::StatusOr<std::unique_ptr<KernelDefinitionBase>>\n-  EmitBaseKernelDefinition() final {\n-    TF_ASSIGN_OR_RETURN(KernelDefinitionType kernel_definition,\n-                        EmitKernelDefinition());\n-    return std::make_unique<KernelDefinitionType>(std::move(kernel_definition));\n+  EmitKernelDefinitionBase() final {\n+    TF_ASSIGN_OR_RETURN(auto kernel_definition, EmitKernelDefinition());\n+    return std::make_unique<KernelDefinition<Source>>(\n+        std::move(kernel_definition));\n   }\n };\n "
        },
        {
            "sha": "f2e9a94acf8590f2c7e47a26a6f5bab6ae3bbcee",
            "filename": "third_party/xla/xla/codegen/llvm_kernel_source.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Fllvm_kernel_source.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Fllvm_kernel_source.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fllvm_kernel_source.h?ref=6ef78e9c38140455d2ce05b6e3c69f4b153d06bc",
            "patch": "@@ -53,7 +53,7 @@ class LlvmKernelSource final : public KernelSource {\n };\n \n using LlvmKernelDefinition = KernelDefinition<LlvmKernelSource>;  // NOLINT\n-using LlvmKernelEmitter = KernelEmitter<LlvmKernelDefinition>;    // NOLINT\n+using LlvmKernelEmitter = KernelEmitter<LlvmKernelSource>;        // NOLINT\n \n }  // namespace xla\n "
        },
        {
            "sha": "c069dbd7c0bcc72bb698d74620da73ea2300b51b",
            "filename": "third_party/xla/xla/codegen/mlir_kernel_source.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Fmlir_kernel_source.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Fmlir_kernel_source.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fmlir_kernel_source.h?ref=6ef78e9c38140455d2ce05b6e3c69f4b153d06bc",
            "patch": "@@ -84,7 +84,7 @@ class MlirKernelSource final : public KernelSource {\n };\n \n using MlirKernelDefinition = KernelDefinition<MlirKernelSource>;  // NOLINT\n-using MlirKernelEmitter = KernelEmitter<MlirKernelDefinition>;    // NOLINT\n+using MlirKernelEmitter = KernelEmitter<MlirKernelSource>;        // NOLINT\n \n }  // namespace xla\n "
        },
        {
            "sha": "8d894c13c1f4fd7f89f27b27a84436c6f06281b1",
            "filename": "third_party/xla/xla/codegen/testlib/kernel_runner_extension.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Ftestlib%2Fkernel_runner_extension.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6ef78e9c38140455d2ce05b6e3c69f4b153d06bc/third_party%2Fxla%2Fxla%2Fcodegen%2Ftestlib%2Fkernel_runner_extension.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftestlib%2Fkernel_runner_extension.cc?ref=6ef78e9c38140455d2ce05b6e3c69f4b153d06bc",
            "patch": "@@ -214,7 +214,7 @@ NB_MODULE(_extension, kernel_runner_module) {\n   nb::class_<KernelEmitterBase>(kernel_runner_module, \"KernelEmitterBase\")\n       .def(\"emit_kernel_definition\", [](KernelEmitterBase* self) {\n         absl::StatusOr<std::unique_ptr<KernelDefinitionBase>> definition =\n-            self->EmitBaseKernelDefinition();\n+            self->EmitKernelDefinitionBase();\n         if (!definition.ok()) {\n           throw std::runtime_error(std::string(definition.status().message()));\n         }"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 28,
        "deletions": 11
    }
}