{
    "author": "akuegel",
    "message": "Make sure to produce a deterministic Memory usage report.\n\nPiperOrigin-RevId: 824403476",
    "sha": "5d42d914670427a01ba3b1495014d5a82f0fcd05",
    "files": [
        {
            "sha": "00bbf5f40a685082888ff109dfe5c100d7c4eab2",
            "filename": "third_party/xla/xla/service/buffer_assignment.cc",
            "status": "modified",
            "additions": 34,
            "deletions": 13,
            "changes": 47,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d42d914670427a01ba3b1495014d5a82f0fcd05/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d42d914670427a01ba3b1495014d5a82f0fcd05/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc?ref=5d42d914670427a01ba3b1495014d5a82f0fcd05",
            "patch": "@@ -990,13 +990,21 @@ std::string BufferAllocation::MemoryUsageReport(const std::string& prefix,\n \n   // Group the values by their offset in the allocation.\n   absl::flat_hash_map<int64_t, OffsetInfo> offset_to_buffers;\n+  std::vector<const HloValue*> sorted_hlo_values;\n+  sorted_hlo_values.reserve(assigned_buffers_.size());\n   for (const auto& element : assigned_buffers_) {\n-    const HloValue* value = element.first;\n-    OffsetInfo& offset_info = offset_to_buffers[element.second.offset];\n+    sorted_hlo_values.push_back(element.first);\n+  }\n+  absl::c_sort(sorted_hlo_values, [](const HloValue* a, const HloValue* b) {\n+    return a->id() < b->id();\n+  });\n+  for (const HloValue* value : sorted_hlo_values) {\n+    const OffsetSize& offset_size = assigned_buffers_.find(value)->second;\n+    OffsetInfo& offset_info = offset_to_buffers[offset_size.offset];\n     offset_info.values.push_back(value);\n-    offset_info.offset_size.offset = element.second.offset;\n+    offset_info.offset_size.offset = offset_size.offset;\n     offset_info.offset_size.size =\n-        std::max(offset_info.offset_size.size, element.second.size);\n+        std::max(offset_info.offset_size.size, offset_size.size);\n   }\n \n   // Sort the offset infos by the max size of the values in the group.\n@@ -1008,7 +1016,14 @@ std::string BufferAllocation::MemoryUsageReport(const std::string& prefix,\n   }\n   absl::c_sort(sorted_offset_infos,\n                [](const OffsetInfo& a, const OffsetInfo& b) {\n-                 return a.offset_size.size > b.offset_size.size;\n+                 if (a.offset_size.size != b.offset_size.size) {\n+                   return a.offset_size.size > b.offset_size.size;\n+                 }\n+                 // Each HloValue appears in just one OffsetInfo `values`\n+                 // vector. Therefore we can use the id of any element of the\n+                 // `values` vector as tie breaker, as long as the `values`\n+                 // vector has a deterministic order.\n+                 return a.values.back()->id() < b.values.back()->id();\n                });\n \n   StrAppend(&output, prefix,\n@@ -1030,15 +1045,21 @@ std::string BufferAllocation::MemoryUsageReport(const std::string& prefix,\n     // of the line.\n     absl::flat_hash_map<std::string, int64_t> shapes;\n     for (auto& value : offset_info.values) shapes[value->shape().ToString()]++;\n+    std::vector<std::pair<int64_t, std::string>> sorted_shapes;\n+    sorted_shapes.reserve(shapes.size());\n+    for (const auto& entry : shapes) {\n+      sorted_shapes.emplace_back(entry.second, entry.first);\n+    }\n+    absl::c_sort(sorted_shapes);\n \n-    StrAppend(\n-        &output,\n-        absl::StrJoin(shapes, \", \", [](std::string* out, const auto& pair) {\n-          if (pair.second == 1) {\n-            return absl::StrAppend(out, pair.first);\n-          }\n-          return absl::StrAppend(out, pair.second, \"×\", pair.first);\n-        }));\n+    StrAppend(&output,\n+              absl::StrJoin(\n+                  sorted_shapes, \", \", [](std::string* out, const auto& pair) {\n+                    if (pair.first == 1) {\n+                      return absl::StrAppend(out, pair.second);\n+                    }\n+                    return absl::StrAppend(out, pair.first, \"×\", pair.second);\n+                  }));\n \n     StrAppend(&output, \"\\n\");\n "
        },
        {
            "sha": "728d4d32ca3c3cc6132b5788bba2cb1913f1f341",
            "filename": "third_party/xla/xla/service/buffer_assignment_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d42d914670427a01ba3b1495014d5a82f0fcd05/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d42d914670427a01ba3b1495014d5a82f0fcd05/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment_test.cc?ref=5d42d914670427a01ba3b1495014d5a82f0fcd05",
            "patch": "@@ -2215,6 +2215,14 @@ TEST_F(BufferAssignmentTest, PeakBuffers) {\n   EXPECT_FALSE(buffer.IsInputOrOutput());\n   EXPECT_TRUE(buffer.IsPreallocatedTempBuffer());\n   ASSERT_EQ(buffer.assigned_buffers().size(), 4);\n+  const char* const kExpectedMemoryUsageReport =\n+      R\"(cumulative_size;       size;       offset; used_by_n_values; shapes_list\n+------------------------------------------------------------\n+     800B( 50%);       800B;            0;                2; f32[100], f32[200]\n+   1.2KiB( 75%);       400B;          800;                1; f32[100]\n+   1.6KiB(100%);       400B;         1200;                1; f32[100]\n+)\";\n+  EXPECT_EQ(buffer.MemoryUsageReport(\"\"), kExpectedMemoryUsageReport);\n \n   const std::vector<const HloValue*>& peak_buffers =\n       buffer.PeakMemoryLogicalBuffers();"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 42,
        "deletions": 13
    }
}