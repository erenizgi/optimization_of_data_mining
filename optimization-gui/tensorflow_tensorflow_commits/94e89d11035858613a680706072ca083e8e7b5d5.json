{
    "author": "tensorflower-gardener",
    "message": "Fix freethreaded builds by passing `HERMETIC_PYTHON_VERSION_KIND` in repository rules.\n\nThe problem was that `@python_<>_host` repository wasn't aware of the python type (controlled by the build flag `@rules_python//python/config_settings:py_freethreaded`) and selected the first candidate, e.g. GIL version of the python.\n\nPiperOrigin-RevId: 808825370",
    "sha": "94e89d11035858613a680706072ca083e8e7b5d5",
    "files": [
        {
            "sha": "860fc08ceda2a876adee8f50496381c2d261f112",
            "filename": "third_party/py/python_init_toolchains.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fpy%2Fpython_init_toolchains.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fpy%2Fpython_init_toolchains.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fpy%2Fpython_init_toolchains.bzl?ref=94e89d11035858613a680706072ca083e8e7b5d5",
            "patch": "@@ -6,6 +6,7 @@ load(\n     \"HERMETIC_PYTHON_SHA256\",\n     \"HERMETIC_PYTHON_URL\",\n     \"HERMETIC_PYTHON_VERSION\",\n+    \"HERMETIC_PYTHON_VERSION_KIND\",\n )\n load(\"@rules_python//python:repositories.bzl\", \"python_register_toolchains\")\n load(\"@rules_python//python:versions.bzl\", \"MINOR_MAPPING\", \"PLATFORMS\")\n@@ -67,4 +68,5 @@ def python_init_toolchains(name = \"python\", python_version = None, **kwargs):\n             name = get_toolchain_name_per_python_version(name),\n             ignore_root_user_error = True,\n             python_version = HERMETIC_PYTHON_VERSION,\n+            python_version_kind = HERMETIC_PYTHON_VERSION_KIND,\n         )"
        },
        {
            "sha": "b562822c4cd12771eb46f0f27cf524c0751e9bf5",
            "filename": "third_party/py/rules_python_freethreaded.patch",
            "status": "modified",
            "additions": 43,
            "deletions": 2,
            "changes": 45,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fpy%2Frules_python_freethreaded.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fpy%2Frules_python_freethreaded.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fpy%2Frules_python_freethreaded.patch?ref=94e89d11035858613a680706072ca083e8e7b5d5",
            "patch": "@@ -1,5 +1,25 @@\n+diff --git a/python/private/python_register_toolchains.bzl b/python/private/python_register_toolchains.bzl\n+index 2e0748de..42223d51 100644\n+--- a/python/private/python_register_toolchains.bzl\n++++ b/python/private/python_register_toolchains.bzl\n+@@ -94,6 +94,7 @@ def python_register_toolchains(\n+     minor_mapping = minor_mapping or MINOR_MAPPING\n+ \n+     python_version = full_version(version = python_version, minor_mapping = minor_mapping)\n++    python_version_kind = kwargs.pop(\"python_version_kind\", \"\")\n+ \n+     toolchain_repo_name = \"{name}_toolchains\".format(name = name)\n+ \n+@@ -189,6 +190,7 @@ def python_register_toolchains(\n+         name = name + \"_host\",\n+         platforms = loaded_platforms,\n+         python_version = python_version,\n++        python_version_kind = python_version_kind,\n+     )\n+ \n+     toolchains_repo(\n diff --git a/python/private/toolchains_repo.bzl b/python/private/toolchains_repo.bzl\n-index 93bbb521..f7ff19c3 100644\n+index 93bbb521..ad9cd7fd 100644\n --- a/python/private/toolchains_repo.bzl\n +++ b/python/private/toolchains_repo.bzl\n @@ -214,7 +214,7 @@ def python_toolchain_build_file_content(\n@@ -10,4 +30,25 @@ index 93bbb521..f7ff19c3 100644\n +            target_settings = meta.target_settings,\n          ))\n      return \"\\n\\n\".join(entries)\n- \n\\ No newline at end of file\n+ \n+@@ -445,6 +445,10 @@ Full python version, Major.Minor.Micro.\n+ Only set in workspace calls.\n+ \"\"\",\n+         ),\n++        \"python_version_kind\": attr.string(\n++            doc = \"Python version kind, e.g. ft (free-threaded)\",\n++            default = \"\"\n++        ),\n+         \"python_versions\": attr.string_dict(\n+             doc = \"\"\"\n+ If set, the Python version for the corresponding selected platform. Values in\n+@@ -603,6 +609,9 @@ def _get_host_impl_repo_name(*, rctx, logger, python_version, os_name, cpu_name,\n+         else:\n+             candidates = [preference]\n+ \n++        if rctx.attr.python_version_kind == \"ft\":\n++            candidates = [c for c in candidates if c[0].endswith(\"freethreaded\")]\n++\n+     if candidates:\n+         platform_name, meta = candidates[0]\n+         suffix = meta.impl_repo_name\n\\ No newline at end of file"
        },
        {
            "sha": "860fc08ceda2a876adee8f50496381c2d261f112",
            "filename": "third_party/xla/third_party/py/python_init_toolchains.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_init_toolchains.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_init_toolchains.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_init_toolchains.bzl?ref=94e89d11035858613a680706072ca083e8e7b5d5",
            "patch": "@@ -6,6 +6,7 @@ load(\n     \"HERMETIC_PYTHON_SHA256\",\n     \"HERMETIC_PYTHON_URL\",\n     \"HERMETIC_PYTHON_VERSION\",\n+    \"HERMETIC_PYTHON_VERSION_KIND\",\n )\n load(\"@rules_python//python:repositories.bzl\", \"python_register_toolchains\")\n load(\"@rules_python//python:versions.bzl\", \"MINOR_MAPPING\", \"PLATFORMS\")\n@@ -67,4 +68,5 @@ def python_init_toolchains(name = \"python\", python_version = None, **kwargs):\n             name = get_toolchain_name_per_python_version(name),\n             ignore_root_user_error = True,\n             python_version = HERMETIC_PYTHON_VERSION,\n+            python_version_kind = HERMETIC_PYTHON_VERSION_KIND,\n         )"
        },
        {
            "sha": "b562822c4cd12771eb46f0f27cf524c0751e9bf5",
            "filename": "third_party/xla/third_party/py/rules_python_freethreaded.patch",
            "status": "modified",
            "additions": 43,
            "deletions": 2,
            "changes": 45,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fxla%2Fthird_party%2Fpy%2Frules_python_freethreaded.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/94e89d11035858613a680706072ca083e8e7b5d5/third_party%2Fxla%2Fthird_party%2Fpy%2Frules_python_freethreaded.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fpy%2Frules_python_freethreaded.patch?ref=94e89d11035858613a680706072ca083e8e7b5d5",
            "patch": "@@ -1,5 +1,25 @@\n+diff --git a/python/private/python_register_toolchains.bzl b/python/private/python_register_toolchains.bzl\n+index 2e0748de..42223d51 100644\n+--- a/python/private/python_register_toolchains.bzl\n++++ b/python/private/python_register_toolchains.bzl\n+@@ -94,6 +94,7 @@ def python_register_toolchains(\n+     minor_mapping = minor_mapping or MINOR_MAPPING\n+ \n+     python_version = full_version(version = python_version, minor_mapping = minor_mapping)\n++    python_version_kind = kwargs.pop(\"python_version_kind\", \"\")\n+ \n+     toolchain_repo_name = \"{name}_toolchains\".format(name = name)\n+ \n+@@ -189,6 +190,7 @@ def python_register_toolchains(\n+         name = name + \"_host\",\n+         platforms = loaded_platforms,\n+         python_version = python_version,\n++        python_version_kind = python_version_kind,\n+     )\n+ \n+     toolchains_repo(\n diff --git a/python/private/toolchains_repo.bzl b/python/private/toolchains_repo.bzl\n-index 93bbb521..f7ff19c3 100644\n+index 93bbb521..ad9cd7fd 100644\n --- a/python/private/toolchains_repo.bzl\n +++ b/python/private/toolchains_repo.bzl\n @@ -214,7 +214,7 @@ def python_toolchain_build_file_content(\n@@ -10,4 +30,25 @@ index 93bbb521..f7ff19c3 100644\n +            target_settings = meta.target_settings,\n          ))\n      return \"\\n\\n\".join(entries)\n- \n\\ No newline at end of file\n+ \n+@@ -445,6 +445,10 @@ Full python version, Major.Minor.Micro.\n+ Only set in workspace calls.\n+ \"\"\",\n+         ),\n++        \"python_version_kind\": attr.string(\n++            doc = \"Python version kind, e.g. ft (free-threaded)\",\n++            default = \"\"\n++        ),\n+         \"python_versions\": attr.string_dict(\n+             doc = \"\"\"\n+ If set, the Python version for the corresponding selected platform. Values in\n+@@ -603,6 +609,9 @@ def _get_host_impl_repo_name(*, rctx, logger, python_version, os_name, cpu_name,\n+         else:\n+             candidates = [preference]\n+ \n++        if rctx.attr.python_version_kind == \"ft\":\n++            candidates = [c for c in candidates if c[0].endswith(\"freethreaded\")]\n++\n+     if candidates:\n+         platform_name, meta = candidates[0]\n+         suffix = meta.impl_repo_name\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 90,
        "deletions": 4
    }
}