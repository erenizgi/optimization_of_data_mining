{
    "author": "matthiaskramm",
    "message": "Assume that CompileAndLoad can change the MLIR.\n\nTo make that more obvious, also use std::move when passing MLIR module from IFRT.\n\nPiperOrigin-RevId: 817336720",
    "sha": "8d16a78b7dd8d4bd79593a99d4eb08ca492f7ca8",
    "files": [
        {
            "sha": "4623b9be25aeae6447c54e4f3664c19cf0d5c57a",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8d16a78b7dd8d4bd79593a99d4eb08ca492f7ca8/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8d16a78b7dd8d4bd79593a99d4eb08ca492f7ca8/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc?ref=8d16a78b7dd8d4bd79593a99d4eb08ca492f7ca8",
            "patch": "@@ -266,9 +266,14 @@ absl::StatusOr<LoadedExecutableRef> PjRtLoadedExecutable::Create(\n       (build_options.use_auto_spmd_partitioning() ||\n        build_options.any_allow_spmd_sharding_propagation_to_parameters() ||\n        build_options.any_allow_spmd_sharding_propagation_to_output());\n+\n+  // We have to do process the MLIR before the compile call, since the latter\n+  // will use the MLIR as scratch space, or possibly even deallocate it.\n+  TF_ASSIGN_OR_RETURN(auto result_shapes, ResultShapesOfModule(module));\n+\n   TF_ASSIGN_OR_RETURN(auto pjrt_loaded_executable,\n                       client->pjrt_client()->CompileAndLoad(\n-                          module, std::move(compile_options)));\n+                          std::move(module), std::move(compile_options)));\n \n   if (auto_spmd_partitioning) {\n     // TODO(hyeontaek): Use a full shape and a sharding rather than a per-shard\n@@ -292,7 +297,6 @@ absl::StatusOr<LoadedExecutableRef> PjRtLoadedExecutable::Create(\n     VLOG(3) << \"Using full shape\";\n     // TODO(yueshengys): Consider getting element types and dimensions directly\n     // from module.\n-    TF_ASSIGN_OR_RETURN(auto result_shapes, ResultShapesOfModule(module));\n     bool tuple_output = result_shapes.size() != 1;\n     xla::Shape result_shape;\n     std::vector<xla::Shape> output_shapes;"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 6,
        "deletions": 2
    }
}