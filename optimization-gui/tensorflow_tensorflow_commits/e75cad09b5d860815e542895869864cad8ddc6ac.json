{
    "author": "penpornk",
    "message": "[xla:cpu:onednn] Remove ifdef INTEL_MKL guards for `onednn_threadpool`, `onednn_util`, and `onednn_pattern_utils`.\n\n+ Add rule `onednn_cc_library` that has empty srcs/hdrs/deps when not building with oneDNN.\n+ Fix ClangTidy/Linter errors/warnings.\n\nPiperOrigin-RevId: 810797255",
    "sha": "e75cad09b5d860815e542895869864cad8ddc6ac",
    "files": [
        {
            "sha": "dc6e5e4647c828f01549e40b5f486239f3fb744d",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=e75cad09b5d860815e542895869864cad8ddc6ac",
            "patch": "@@ -13,7 +13,12 @@ load(\n load(\"//xla/tests:build_defs.bzl\", \"xla_test\")\n load(\"//xla/tsl:tsl.bzl\", \"internal_visibility\", \"tsl_copts\")\n load(\"//xla/tsl:tsl.default.bzl\", \"filegroup\", \"get_compatible_with_portable\")\n-load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\", \"if_onednn\")\n+load(\n+    \"//xla/tsl/mkl:build_defs.bzl\",\n+    \"if_graph_api\",\n+    \"if_onednn\",\n+    \"onednn_cc_library\",\n+)\n load(\"//xla/tsl/platform:build_config.bzl\", \"tf_proto_library\")\n load(\n     \"//xla/tsl/platform:build_config_root.bzl\",\n@@ -1702,7 +1707,7 @@ tf_proto_library(\n     ],\n )\n \n-cc_library(\n+onednn_cc_library(\n     name = \"onednn_util\",\n     srcs = [\"onednn_util.cc\"],\n     hdrs = [\n@@ -1718,9 +1723,10 @@ cc_library(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/tsl/mkl:onednn\",\n         \"//xla/tsl/platform:env\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@eigen_archive//:eigen3\",\n-        \"@local_tsl//tsl/platform:env\",\n         \"@local_tsl//tsl/platform:platform_port\",\n     ],\n )\n@@ -1860,7 +1866,7 @@ cc_library(\n     ],\n )\n \n-cc_library(\n+onednn_cc_library(\n     name = \"onednn_pattern_utils\",\n     hdrs = [\"onednn_pattern_utils.h\"],\n     visibility = [\"//visibility:public\"],"
        },
        {
            "sha": "02823be4a5f68596aa83ba0048a213b550f3b85f",
            "filename": "third_party/xla/xla/service/cpu/onednn_pattern_utils.h",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_pattern_utils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_pattern_utils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_pattern_utils.h?ref=e75cad09b5d860815e542895869864cad8ddc6ac",
            "patch": "@@ -15,10 +15,8 @@ limitations under the License.\n \n #ifndef XLA_SERVICE_CPU_ONEDNN_PATTERN_UTILS_H_\n #define XLA_SERVICE_CPU_ONEDNN_PATTERN_UTILS_H_\n-#if defined(INTEL_MKL)\n \n #include \"xla/hlo/ir/hlo_instruction.h\"\n-#include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/service/cpu/onednn_util.h\"\n #include \"xla/service/pattern_matcher.h\"\n \n@@ -61,5 +59,4 @@ inline auto SupportedConvert(HloInstruction** convert, Pattern pattern) {\n }  // namespace cpu\n }  // namespace xla\n \n-#endif  // INTEL_MKL\n #endif  // XLA_SERVICE_CPU_ONEDNN_PATTERN_UTILS_H_"
        },
        {
            "sha": "f78bedb94aa487a77af997efbe0533aec8b0c9b3",
            "filename": "third_party/xla/xla/service/cpu/onednn_util.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_util.cc?ref=e75cad09b5d860815e542895869864cad8ddc6ac",
            "patch": "@@ -12,10 +12,21 @@ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n-#if defined(INTEL_MKL)\n \n #include \"xla/service/cpu/onednn_util.h\"\n \n+#include <cstdint>\n+#include <memory>\n+#include <vector>\n+\n+#include \"absl/log/log.h\"\n+#include \"oneapi/dnnl/dnnl.hpp\"\n+#include \"oneapi/dnnl/dnnl_common.hpp\"\n+#include \"oneapi/dnnl/dnnl_threadpool.hpp\"\n+#include \"oneapi/dnnl/dnnl_threadpool_iface.hpp\"\n+#include \"oneapi/dnnl/dnnl_types.h\"\n+#include \"xla/tsl/util/onednn_threadpool.h\"\n+\n #define EIGEN_USE_THREADS\n \n namespace xla {\n@@ -122,5 +133,3 @@ dnnl::post_ops PopulateOneDnnPostOps(\n \n }  // namespace cpu\n }  // namespace xla\n-\n-#endif  // INTEL_MKL"
        },
        {
            "sha": "a8ce340705c75478ecc411aa3ef7291e27b17ab0",
            "filename": "third_party/xla/xla/service/cpu/onednn_util.h",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_util.h?ref=e75cad09b5d860815e542895869864cad8ddc6ac",
            "patch": "@@ -16,12 +16,17 @@ limitations under the License.\n #ifndef XLA_SERVICE_CPU_ONEDNN_UTIL_H_\n #define XLA_SERVICE_CPU_ONEDNN_UTIL_H_\n \n-#if defined(INTEL_MKL)\n-\n #define EIGEN_USE_THREADS\n \n+#include <memory>\n+#include <utility>\n+#include <vector>\n+\n+#include \"absl/status/statusor.h\"\n #include \"unsupported/Eigen/CXX11/Tensor\"\n-#include \"dnnl.hpp\"\n+#include \"oneapi/dnnl/dnnl.hpp\"\n+#include \"oneapi/dnnl/dnnl_common.hpp\"\n+#include \"oneapi/dnnl/dnnl_threadpool_iface.hpp\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n #include \"xla/service/cpu/onednn_config.pb.h\"\n@@ -93,5 +98,4 @@ dnnl::post_ops PopulateOneDnnPostOps(\n }  // namespace cpu\n }  // namespace xla\n \n-#endif  // INTEL_MKL\n #endif  // XLA_SERVICE_CPU_ONEDNN_UTIL_H_"
        },
        {
            "sha": "df2419e7793c29f204dad6cdca9ae43ed3bd07ea",
            "filename": "third_party/xla/xla/tsl/mkl/build_defs.bzl",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl?ref=e75cad09b5d860815e542895869864cad8ddc6ac",
            "patch": "@@ -15,6 +15,8 @@ mkl_repository depends on the following environment variables:\n   * `TF_MKL_ROOT`: The root folder where a copy of libmkl is located.\n \"\"\"\n \n+load(\"@rules_cc//cc:cc_library.bzl\", \"cc_library\")\n+\n _TF_MKL_ROOT = \"TF_MKL_ROOT\"\n \n def if_mkl(if_true, if_false = []):\n@@ -45,6 +47,15 @@ def if_mkl(if_true, if_false = []):\n # XLA in the future.\n if_onednn = if_mkl\n \n+def onednn_cc_library(srcs = [], hdrs = [], deps = [], **kwargs):\n+    \"\"\"cc_library rule with empty src/hdrs/deps if not building with oneDNN.\"\"\"\n+    cc_library(\n+        srcs = if_onednn(srcs),\n+        hdrs = if_onednn(hdrs),\n+        deps = if_onednn(deps),\n+        **kwargs\n+    )\n+\n def if_mkl_ml(if_true, if_false = []):\n     \"\"\"Shorthand for select()'ing on whether we're building with MKL-ML.\n "
        },
        {
            "sha": "f3fe49da71182f23dbc3e37e3404f91b58607701",
            "filename": "third_party/xla/xla/tsl/util/onednn_threadpool.h",
            "status": "modified",
            "additions": 13,
            "deletions": 17,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fonednn_threadpool.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e75cad09b5d860815e542895869864cad8ddc6ac/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fonednn_threadpool.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Futil%2Fonednn_threadpool.h?ref=e75cad09b5d860815e542895869864cad8ddc6ac",
            "patch": "@@ -1,4 +1,3 @@\n-\n /* Copyright 2020 The TensorFlow Authors. All Rights Reserved.\n \n Licensed under the Apache License, Version 2.0 (the \"License\");\n@@ -16,20 +15,17 @@ limitations under the License.\n \n #ifndef XLA_TSL_UTIL_ONEDNN_THREADPOOL_H_\n #define XLA_TSL_UTIL_ONEDNN_THREADPOOL_H_\n-#ifdef INTEL_MKL\n \n-#include <list>\n-#include <memory>\n-#include <string>\n-#include <unordered_map>\n-#include <utility>\n-#include <vector>\n+#include <algorithm>\n+#include <cstdint>\n+#include <functional>\n \n #define EIGEN_USE_THREADS\n \n #include \"absl/synchronization/blocking_counter.h\"\n-#include \"dnnl.hpp\"\n-#include \"oneapi/dnnl/dnnl_threadpool.hpp\"\n+#include \"oneapi/dnnl/dnnl_threadpool.h\"\n+#include \"oneapi/dnnl/dnnl_threadpool_iface.hpp\"\n+#include \"oneapi/dnnl/dnnl_version.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n #include \"tsl/platform/cpu_info.h\"\n \n@@ -88,22 +84,23 @@ class OneDnnThreadPool : public threadpool_iface {\n         can_use_caller_thread_(can_use_caller_thread) {\n     set_num_and_max_threads(num_threads);\n   }\n-  virtual int get_num_threads() const override { return num_threads_; }\n-  virtual bool get_in_parallel() const override {\n+  int get_num_threads() const override { return num_threads_; }\n+  bool get_in_parallel() const override {\n     return (eigen_interface_->CurrentThreadId() != -1) ? true : false;\n   }\n-  virtual uint64_t get_flags() const override { return ASYNCHRONOUS; }\n+  uint64_t get_flags() const override { return ASYNCHRONOUS; }\n #ifdef ENABLE_ONEDNN_ASYNC\n   // wait() method for synchronous execution is basically a no-op.\n   // But we need to implement it to satisfy the interface.\n   // This is the requirement of the new experimental async runtime support\n   // in oneDNN.\n   virtual void wait() override {}\n #endif  // ENABLE_ONEDNN_ASYNC\n-  virtual void parallel_for(int n,\n-                            const std::function<void(int, int)>& fn) override {\n+  void parallel_for(int n, const std::function<void(int, int)>& fn) override {\n     // Should never happen (handled by DNNL)\n-    if (n == 0) return;\n+    if (n == 0) {\n+      return;\n+    }\n \n     // Should never happen (handled by DNNL)\n     if (n == 1) {\n@@ -194,5 +191,4 @@ class OneDnnThreadPool {\n \n }  // namespace tsl\n \n-#endif  // INTEL_MKL\n #endif  // XLA_TSL_UTIL_ONEDNN_THREADPOOL_H_"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 54,
        "deletions": 31
    }
}