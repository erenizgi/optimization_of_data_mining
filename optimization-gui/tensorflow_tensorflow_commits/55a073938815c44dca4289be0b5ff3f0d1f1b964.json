{
    "author": "alekstheod",
    "message": "PR #35191: [ROCm] Fix jax build with rocm\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35191\n\nüìù Summary of Changes\nWhile building jax and running its test it complaints about missing hipsolver_potrf_ffi\nFFI handler. This change ensures that libs located in data are linked against the targets\nwhere they are set as a dependency.\n\nüéØ Justification\nFixing this issue:\n```\njax.errors.JaxRuntimeError: NOT_FOUND: No FFI handler registered for hipsolver_potrf_ffi on a platform ROCM (canonical rocm)\n--------------------\nFor simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.\n```\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nCI U-Tests\n\nüß™ Execution Tests:\nNot relevant\n\nCopybara import of the project:\n\n--\n1cf513b957650bc7e1510cf8bef6bc0285b9d8c9 by Alexandros Theodoridis <atheodor@amd.com>:\n\nFix jax build with rocm\n\n--\n3c7dee35701d8fc1e7fe040389c4ec8fcc1fe475 by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd more libs to data\n\n--\n90192b07dd5d0a8ba6acd9f51b3110db70095db4 by Alexandros Theodoridis <atheodor@amd.com>:\n\nPut everhting to data\n\n--\ncfa46dd5ce30181b268d0338c901834699988838 by Alexandros Theodoridis <atheodor@amd.com>:\n\nSwitch hermetic build to release version of rocm\n\nMerging this change closes #35191\n\nPiperOrigin-RevId: 845610364",
    "sha": "55a073938815c44dca4289be0b5ff3f0d1f1b964",
    "files": [
        {
            "sha": "f14780e2b4a194eef75312865197e95ee41774bd",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 20,
            "deletions": 6,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55a073938815c44dca4289be0b5ff3f0d1f1b964/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55a073938815c44dca4289be0b5ff3f0d1f1b964/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=55a073938815c44dca4289be0b5ff3f0d1f1b964",
            "patch": "@@ -105,6 +105,7 @@ cc_library(\n         \":hip\",\n         \":hipblas\",\n         \":hipblaslt\",\n+        \":hipfft\",\n         \":hiprand\",\n         \":hipsolver\",\n         \":hipsparse\",\n@@ -116,7 +117,6 @@ cc_library(\n         \":rocsolver\",\n         \":rocsparse\",\n         \":roctracer\",\n-        \":hipfft\",\n     ],\n )\n \n@@ -408,11 +408,15 @@ cc_library(\n cc_library(\n     name = \"rocsolver\",\n     hdrs = glob([\"%{rocm_root}/include/rocsolver/**\"]),\n-    data = glob([\"%{rocm_root}/lib/librocsolver*.so*\"]),\n+    data = glob([\n+        \"%{rocm_root}/lib/librocsolver*.so*\",\n+        \"%{rocm_root}/lib/host-math/lib/*.so*\",\n+    ]),\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n+    linkopts = [\"-lrocsolver\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n@@ -423,14 +427,18 @@ cc_library(\n \n cc_library(\n     name = \"rocsparse\",\n-    srcs = glob([\"%{rocm_root}/lib/librocsparse*.so*\"]),\n+    data = glob([\"%{rocm_root}/lib/librocsparse*.so*\"]),\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n+    linkopts = [\"-lrocsparse\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":rocm_rpath\",\n+    ],\n )\n \n cc_library(\n@@ -441,9 +449,14 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n+    linkopts = [\"-lhipsolver\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":rocm_rpath\",\n+        \":rocsparse\",\n+    ],\n )\n \n cc_library(\n@@ -454,6 +467,7 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n+    linkopts = [\"-lhipblas\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n@@ -532,8 +546,8 @@ cc_library(\n \n cc_library(\n     name = \"amd_comgr_dynamic\",\n-    hdrs = glob([\"%{rocm_root}/include/amd_comgr/**\"]),\n     srcs = [\"%{rocm_root}/lib/libamd_comgr_stub.a\"],\n+    hdrs = glob([\"%{rocm_root}/include/amd_comgr/**\"]),\n     data = glob([\n         \"%{rocm_root}/lib/libamd_comgr_loader.so*\",\n         \"%{rocm_root}/lib/libamd_comgr.so*\","
        },
        {
            "sha": "2b54d5fdcfe495fa1c5e18a30f153dc78d92952c",
            "filename": "third_party/xla/xla/backends/gpu/collectives/rccl_communicator.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55a073938815c44dca4289be0b5ff3f0d1f1b964/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Frccl_communicator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55a073938815c44dca4289be0b5ff3f0d1f1b964/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Frccl_communicator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Frccl_communicator.cc?ref=55a073938815c44dca4289be0b5ff3f0d1f1b964",
            "patch": "@@ -401,7 +401,7 @@ RcclCommunicator::RegisterBuffer(stream_executor::DeviceAddressBase buffer,\n           XLA_RCCL_RETURN_IF_ERROR(ncclGroupStart());\n           XLA_RCCL_RETURN_IF_ERROR(ncclCommWindowRegister(\n               comm_, buffer.opaque(), buffer.size(), (ncclWindow_t*)&handle,\n-              RCCL_WIN_COLL_SYMMETRIC));\n+              NCCL_WIN_COLL_SYMMETRIC));\n           XLA_RCCL_RETURN_IF_ERROR(ncclGroupEnd());\n           if (group_nesting_level_ == 0) {\n             TF_RETURN_IF_ERROR(PollUntilDone());"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 21,
        "deletions": 7
    }
}