{
    "author": "metaflow",
    "message": "[XLA:GPU] ignore dim=1 sizes when swapping broadcast and bitcast\n\nPreviously rewrite would fail if brodcast introduced a 1 between\ndimenstions that would collapse in the following reshape, for example:\n\np0 = f32[2,3] parameter(0)\nt1 = f32[2,1,3,5] broadcast(p0), dimensions={0,2}\nt2 = f32[6,5] reshape(t1)\n\nBut we can safely ignore dimensions of size 1 as they do not change the physical layout.\n\nWill follow up with a symmetrical case for the reshape <-> broadcast.\n\nPiperOrigin-RevId: 843210080",
    "sha": "5d1d09eeac829964d196ac97dd6c0362999a272a",
    "files": [
        {
            "sha": "28a31ba41a8d5008bd65d95f0c10a4eab9500a63",
            "filename": "third_party/xla/xla/service/gpu/transforms/nest_gemm_fusion.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d1d09eeac829964d196ac97dd6c0362999a272a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d1d09eeac829964d196ac97dd6c0362999a272a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion.cc?ref=5d1d09eeac829964d196ac97dd6c0362999a272a",
            "patch": "@@ -468,19 +468,26 @@ absl::StatusOr<BitcastParams> CalculateBitcastOfBroadcast(\n \n   // Dimensions of the new broadcast.\n   llvm::SmallVector<int64_t> new_dims;\n+  llvm::SmallVector<int64_t> broadcast_physical_dims =\n+      GetPhysicalDimensions(broadcast_shape);\n   auto factors = CommonFactors(GetPhysicalDimensions(result_shape),\n-                               GetPhysicalDimensions(broadcast_shape));\n+                               broadcast_physical_dims);\n   for (int64_t i = 1; i < factors.size(); ++i) {\n     auto [result_from, broadcast_from] = factors[i - 1];\n     auto [result_to, broadcast_to] = factors[i];\n \n     bool all_operands = true, any_operands = false;\n     for (int64_t j = broadcast_from; j < broadcast_to; ++j) {\n+      if (broadcast_physical_dims[j] == 1) {\n+        // If dimension size is 1 then we can ignore it: it's either immediately\n+        // dropped by old reshape or it's coming from the operand and then the\n+        // new reshape will handle it.\n+        continue;\n+      }\n       bool value = is_operand_dim[broadcast_shape.layout().minor_to_major(j)];\n       all_operands &= value;\n       any_operands |= value;\n     }\n-\n     if (!any_operands) {\n       continue;  // All dimensions in this group are broadcast dimensions.\n     }"
        },
        {
            "sha": "bab6311f57991e1d12ff388a9be2471162c27d98",
            "filename": "third_party/xla/xla/service/gpu/transforms/nest_gemm_fusion_test.cc",
            "status": "modified",
            "additions": 85,
            "deletions": 2,
            "changes": 87,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d1d09eeac829964d196ac97dd6c0362999a272a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d1d09eeac829964d196ac97dd6c0362999a272a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion_test.cc?ref=5d1d09eeac829964d196ac97dd6c0362999a272a",
            "patch": "@@ -670,6 +670,50 @@ CHECK: {{.*}} = f32[264]{0} bitcast([[entry_p0]])\n       IsOkAndHolds(true));\n }\n \n+TEST_P(NestGemmFusionReshapeTest,\n+       BitcastsAreHoistedUpThroughBroadcastsWithTrivialDimensions) {\n+  HloOpcode opcode = GetParam();\n+  absl::string_view hlo = R\"(\n+HloModule t\n+\n+triton_dot {\n+  p0 = f32[11,24,1] parameter(0)\n+  p0_broadcast = f32[11,1,24,1,128] broadcast(p0), dimensions={0,2,3}\n+  p0_reshape = f32[264,128] $0(p0_broadcast)\n+  p1 = f32[128,8]{1,0} parameter(1)\n+  ROOT result = f32[264,8]{1,0} dot(p0_reshape, p1),\n+    lhs_contracting_dims={1}, rhs_contracting_dims={0}\n+}\n+\n+ENTRY e {\n+  p0 = f32[11,24,1] parameter(0)\n+  p1 = f32[128,8] parameter(1)\n+  ROOT result = f32[264,8] fusion(p0, p1), kind=kCustom, calls=triton_dot,\n+    backend_config={\"fusion_backend_config\": {kind: \"__triton_gemm\",\n+    triton_gemm_config: {\"block_m\":32,\"block_n\":16,\"block_k\":8,\n+    \"split_k\":1,\"num_stages\":1,\"num_warps\":4,\"num_ctas\":1}}}}\n+)\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(\n+                              absl::Substitute(hlo, HloOpcodeString(opcode))));\n+  ASSERT_THAT(\n+      NestGemmFusion(device_description_, &mlir_context_).Run(module.get()),\n+      IsOkAndHolds(true));\n+  ASSERT_OK(verifier().Run(module.get()).status());\n+  EXPECT_THAT(\n+      RunFileCheck(module->ToString(HloPrintOptions::ShortParsable()), R\"(\n+// Broadcast fusion:\n+CHECK: {{.*}} {\n+CHECK-NEXT: [[broadcast_p0:[^ ]+]] = f32[264]{0} parameter(0)\n+CHECK-NEXT: ROOT {{.*}} = f32[264,128]{1,0} broadcast([[broadcast_p0]]), dimensions={0}\n+CHECK-NEXT: }\n+CHECK: ENTRY {{.*}} {\n+CHECK: [[entry_p0:[^ ]+]] = f32[11,24,1]{{.*}} parameter(0)\n+CHECK: {{.*}} = f32[264]{0} bitcast([[entry_p0]])\n+)\"),\n+      IsOkAndHolds(true));\n+}\n+\n TEST_P(NestGemmFusionReshapeTest,\n        BitcastOfOperandAndBroadcastDimsIsNotHoistedUp) {\n   HloOpcode opcode = GetParam();\n@@ -899,8 +943,8 @@ ENTRY entry {\n       ParseAndRunNestGemmFusion(absl::Substitute(hlo, HloOpcodeString(opcode)));\n   EXPECT_THAT(\n       RunFileCheck(module->ToString(HloPrintOptions::ShortParsable()), R\"(\n-CHECK: bf16[1,2,4,8]{{.*}} broadcast({{.*}}), dimensions={0,3}\n-CHECK: bf16[1,2,4,8]{{.*}} broadcast({{.*}}), dimensions={0,3}\n+CHECK: bf16[1,2,4,8]{{.*}} broadcast({{.*}}), dimensions={3}\n+CHECK: bf16[1,2,4,8]{{.*}} broadcast({{.*}}), dimensions={3}\n )\"),\n       IsOkAndHolds(true));\n }\n@@ -1133,6 +1177,45 @@ CHECK-SAME: dimensions={0,1}\n       IsOkAndHolds(true));\n }\n \n+// TODO(b/467306121): handle the case when we need to sink the reshape through\n+// broadcast.\n+TEST_P(NestGemmFusionReshapeTest,\n+       DISABLED_BitcastsAreHoistedDownThroughBroadcastsWithTrivialDimensions) {\n+  HloOpcode opcode = GetParam();\n+  absl::string_view hlo = R\"(\n+triton_dot {\n+  p0 = f32[3,7] parameter(0)\n+  p1 = f32[6,7] parameter(1)\n+  dot = f32[3,6] dot(p0, p1),\n+    lhs_contracting_dims={1}, rhs_contracting_dims={1}\n+  bitcast = f32[3,2,3] $0(dot)\n+  ROOT broadcast = f32[3,2,1,3,7] broadcast(bitcast), dimensions={0,1,3}\n+}\n+\n+ENTRY e {\n+  p0 = f32[3,7] parameter(0)\n+  p1 = f32[6,7] parameter(1)\n+  ROOT result = f32[3,2,1,3,7] fusion(p0, p1), kind=kCustom, calls=triton_dot,\n+    backend_config={\"fusion_backend_config\": {kind: \"__triton_gemm\",\n+    triton_gemm_config: {\"block_m\":16,\"block_n\":16,\"block_k\":8,\n+    \"split_k\":1,\"num_stages\":1,\"num_warps\":1,\"num_ctas\":1}}}}\n+)\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(\n+                              absl::Substitute(hlo, HloOpcodeString(opcode))));\n+  ASSERT_THAT(\n+      NestGemmFusion(device_description_, &mlir_context_).Run(module.get()),\n+      IsOkAndHolds(true));\n+  ASSERT_OK(verifier().Run(module.get()).status());\n+  EXPECT_THAT(\n+      RunFileCheck(module->ToString(HloPrintOptions::ShortParsable()), R\"(\n+CHECK:      ROOT broadcast\n+CHECK-SAME: f32[3,5,6,2]{2,1,0,3} broadcast\n+CHECK-SAME: dimensions={0,1}\n+)\"),\n+      IsOkAndHolds(true));\n+}\n+\n TEST_P(NestGemmFusionReshapeTest,\n        BitcastsAreHoistedDownThroughBroadcastsWithNonDefaultLayout) {\n   HloOpcode opcode = GetParam();"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 94,
        "deletions": 4
    }
}