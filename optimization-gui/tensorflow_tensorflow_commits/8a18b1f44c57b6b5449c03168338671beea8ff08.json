{
    "author": "tensorflower-gardener",
    "message": "Fix shared TableConfig processing in compute_sparse_core_stats.\n\nPiperOrigin-RevId: 834997967",
    "sha": "8a18b1f44c57b6b5449c03168338671beea8ff08",
    "files": [
        {
            "sha": "d6762a7b15300234c40c4a927648ce8c300b6df1",
            "filename": "tensorflow/python/tpu/tpu_embedding_v3.py",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8a18b1f44c57b6b5449c03168338671beea8ff08/tensorflow%2Fpython%2Ftpu%2Ftpu_embedding_v3.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8a18b1f44c57b6b5449c03168338671beea8ff08/tensorflow%2Fpython%2Ftpu%2Ftpu_embedding_v3.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftpu%2Ftpu_embedding_v3.py?ref=8a18b1f44c57b6b5449c03168338671beea8ff08",
            "patch": "@@ -1388,18 +1388,18 @@ def compute_sparse_core_stats(\n   ) -> Tuple[Any, Any]:\n     \"\"\"Computes the max_ids/unique ids settings from the input features.\"\"\"\n     copy_feature_config = _clone_feature_config(feature_config)\n-    table_config = []\n-    for feature in nest.flatten(copy_feature_config):\n-      table_config.append(feature.table)\n+    table_config_list = list(\n+        {feature.table for feature in nest.flatten(copy_feature_config)}\n+    )\n \n-    for table in table_config:\n+    for table in table_config_list:\n       if table.optimizer is None:\n         table.optimizer = optimizer\n \n     flat_features = nest.flatten_with_joined_string_paths(copy_feature_config)\n \n     s = _stack_tables_with_same_table_dim_and_optimizer(\n-        table_config,\n+        table_config_list,\n         flat_features,\n         num_tpu_chips,\n         num_sc_per_chip,"
        },
        {
            "sha": "67ca374d0ff7e50b9291697a91461a5cef12ad56",
            "filename": "tensorflow/python/tpu/tpu_embedding_v3_test.py",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8a18b1f44c57b6b5449c03168338671beea8ff08/tensorflow%2Fpython%2Ftpu%2Ftpu_embedding_v3_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8a18b1f44c57b6b5449c03168338671beea8ff08/tensorflow%2Fpython%2Ftpu%2Ftpu_embedding_v3_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftpu%2Ftpu_embedding_v3_test.py?ref=8a18b1f44c57b6b5449c03168338671beea8ff08",
            "patch": "@@ -171,6 +171,7 @@ def setUp(self):\n         combiner='sum',\n         name='user',\n     )\n+    self.rng = np.random.default_rng(0)\n \n   def test_single_feature_single_table_lookup_with_static_buffer_size(self):\n     feature_config = tpu_embedding_v2_utils.FeatureConfig(\n@@ -864,6 +865,46 @@ def step(data):\n     ):\n       self.assertAllEqual(per_feature_result, per_feature_result_cpu)\n \n+  def test_compute_sparse_core_stats_shared_table(self):\n+    resolver = tpu_cluster_resolver.TPUClusterResolver(tpu='')\n+    remote.connect_to_cluster(resolver)\n+    tpu_cluster_resolver.initialize_tpu_system(resolver)\n+    strategy = tpu_strategy.TPUStrategy(resolver)\n+\n+    batch_size = 16\n+    num_tpu_chips = strategy.num_replicas_in_sync\n+\n+    shared_table = tpu_embedding_v2_utils.TableConfig(\n+        vocabulary_size=self.vocabulary_size,\n+        dim=self.embedding_dim,\n+        initializer=init_ops_v2.Constant(1.0),\n+        combiner='sum',\n+        name='shared_table',\n+    )\n+\n+    features = ['feature_a', 'feature_b']\n+    feature_config = {\n+        feature: tpu_embedding_v2_utils.FeatureConfig(\n+            table=shared_table, name=feature, output_shape=[batch_size]\n+        )\n+        for feature in features\n+    }\n+\n+    data = {\n+        feature: math_ops.cast(\n+            math_ops.range(batch_size * num_tpu_chips) % self.vocabulary_size,\n+            dtypes.float32,\n+        )\n+        for feature in features\n+    }\n+\n+    tpu_embedding_v3.TPUEmbeddingV2.compute_sparse_core_stats(\n+        features=data,\n+        feature_config=feature_config,\n+        num_tpu_chips=num_tpu_chips,\n+        optimizer=tpu_embedding_v2_utils.SGD(learning_rate=1.0),\n+    )\n+\n   def test_raise_error_when_weight_decay_is_set(self):\n     feature_config = tpu_embedding_v2_utils.FeatureConfig(\n         table=self.table_video, name='watched', output_shape=[16]"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 46,
        "deletions": 5
    }
}