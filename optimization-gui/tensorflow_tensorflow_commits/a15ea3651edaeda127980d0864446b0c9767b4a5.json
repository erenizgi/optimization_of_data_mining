{
    "author": "thomasjoerg",
    "message": "[XLA:GPU] Pre-factor ReduceDecomposer: Exit early for better readability\n\nPiperOrigin-RevId: 839167368",
    "sha": "a15ea3651edaeda127980d0864446b0c9767b4a5",
    "files": [
        {
            "sha": "1630ead3826091e3f18522431d15afc78c345a31",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/reduce_decomposer.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 20,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a15ea3651edaeda127980d0864446b0c9767b4a5/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Freduce_decomposer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a15ea3651edaeda127980d0864446b0c9767b4a5/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Freduce_decomposer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Freduce_decomposer.cc?ref=a15ea3651edaeda127980d0864446b0c9767b4a5",
            "patch": "@@ -103,28 +103,30 @@ class ReduceDecomposerVisitor : public DfsHloRewriteVisitor {\n         ShapeUtil::MakeValidatedMaybeTupleShape(expected_shapes));\n     TF_ASSIGN_OR_RETURN(auto expected_output_shape,\n                         ShapeUtil::MakeValidatedMaybeTupleShape(output_shapes));\n-    if (expected_tuple_shape != expected_output_shape) {\n-      TF_ASSIGN_OR_RETURN(auto r_prime,\n-                          MakeReduceHlo(reduce->inputs(), reduce->init_values(),\n-                                        reduce->dimensions(),\n-                                        reduce->called_computations()[0]));\n-      TF_RET_CHECK(r_prime->shape() == expected_tuple_shape);\n-\n-      if (!shape.IsTuple()) {\n-        auto copy = MakeCopyHlo(r_prime, shape);\n-        TF_RETURN_IF_ERROR(ReplaceInstruction(reduce, copy));\n-        return absl::OkStatus();\n-      }\n+    if (expected_tuple_shape == expected_output_shape) {\n+      return absl::OkStatus();\n+    }\n \n-      std::vector<HloInstruction*> copies;\n-      for (int i = 0; i < reduce->input_count(); i++) {\n-        TF_ASSIGN_OR_RETURN(auto from, GetOutput(r_prime, i));\n-        auto copy = MakeCopyHlo(from, output_shapes[i]);\n-        copies.push_back(copy);\n-      }\n-      auto out = MaybeMakeTuple(copies);\n-      TF_RETURN_IF_ERROR(ReplaceInstruction(reduce, out));\n+    TF_ASSIGN_OR_RETURN(\n+        auto r_prime,\n+        MakeReduceHlo(reduce->inputs(), reduce->init_values(),\n+                      reduce->dimensions(), reduce->called_computations()[0]));\n+    TF_RET_CHECK(r_prime->shape() == expected_tuple_shape);\n+\n+    if (!shape.IsTuple()) {\n+      auto copy = MakeCopyHlo(r_prime, shape);\n+      TF_RETURN_IF_ERROR(ReplaceInstruction(reduce, copy));\n+      return absl::OkStatus();\n+    }\n+\n+    std::vector<HloInstruction*> copies;\n+    for (int i = 0; i < reduce->input_count(); i++) {\n+      TF_ASSIGN_OR_RETURN(auto from, GetOutput(r_prime, i));\n+      auto copy = MakeCopyHlo(from, output_shapes[i]);\n+      copies.push_back(copy);\n     }\n+    auto out = MaybeMakeTuple(copies);\n+    TF_RETURN_IF_ERROR(ReplaceInstruction(reduce, out));\n     return absl::OkStatus();\n   }\n "
        }
    ],
    "stats": {
        "total": 42,
        "additions": 22,
        "deletions": 20
    }
}