{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Get TritonGemmConfig inside MakeNestedFusionFromGemmFusion.\n\nWe only call `MakeNestedFusionFromGemmFusion` once and the first thing we do is DCHECK that config is correct.\n\nPiperOrigin-RevId: 804555916",
    "sha": "b4984e8393c68b8338c3e72cf9a99f83a5b6ee9e",
    "files": [
        {
            "sha": "3b6b8d549295daf89a9089167148d8227ddee0e8",
            "filename": "third_party/xla/xla/service/gpu/transforms/nest_gemm_fusion.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b4984e8393c68b8338c3e72cf9a99f83a5b6ee9e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b4984e8393c68b8338c3e72cf9a99f83a5b6ee9e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fnest_gemm_fusion.cc?ref=b4984e8393c68b8338c3e72cf9a99f83a5b6ee9e",
            "patch": "@@ -253,10 +253,9 @@ absl::Status FuseAndAnnotateConcatOperands(HloComputation* computation) {\n // Transforms a fusion into an equivalent nested fusion if it has a single dot.\n // Returns ok if the transformation was successful.\n absl::Status MakeNestedFusionFromGemmFusion(HloFusionInstruction* fusion,\n-                                            const TritonGemmConfig& config,\n                                             HloDotInstruction* dot,\n                                             mlir::MLIRContext* ctx) {\n-  DCHECK(GetTritonGemmConfig(*fusion).value() == config);\n+  TF_ASSIGN_OR_RETURN(TritonGemmConfig config, GetTritonGemmConfig(*fusion));\n \n   HloComputation* computation = fusion->called_computation();\n \n@@ -1189,7 +1188,6 @@ class NestGemmFusionVisitor : public DfsHloRewriteVisitor {\n   absl::Status RewriteFusion(HloFusionInstruction* fusion,\n                              CallGraph* call_graph) {\n     HloComputation* computation = fusion->called_computation();\n-    TF_ASSIGN_OR_RETURN(TritonGemmConfig config, GetTritonGemmConfig(*fusion));\n     HloInstruction* instr =\n         hlo_query::GetFirstInstructionWithOpcode(*computation, HloOpcode::kDot);\n     if (instr == nullptr) {\n@@ -1200,8 +1198,7 @@ class NestGemmFusionVisitor : public DfsHloRewriteVisitor {\n     TF_RETURN_IF_ERROR(\n         TryHoistBitcastsInComputationToCallers(instr, call_graph));\n     HloDotInstruction* dot = Cast<HloDotInstruction>(instr);\n-    TF_RETURN_IF_ERROR(\n-        MakeNestedFusionFromGemmFusion(fusion, config, dot, ctx_));\n+    TF_RETURN_IF_ERROR(MakeNestedFusionFromGemmFusion(fusion, dot, ctx_));\n \n     MarkAsChanged();\n "
        }
    ],
    "stats": {
        "total": 7,
        "additions": 2,
        "deletions": 5
    }
}