{
    "author": "basioli-k",
    "message": "[XLA:CPU] Switch the use of TargetMachineOptionsProto with TargetMachineOptions\n\nPiperOrigin-RevId: 833928988",
    "sha": "966c58ef2fe77eca2b84c17977395d3537bb8357",
    "files": [
        {
            "sha": "201124b2c66190bfa4319c8ff55324117b685613",
            "filename": "third_party/xla/xla/backends/cpu/codegen/BUILD",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -101,6 +101,7 @@ cc_library(\n         \":polynomial_approximations\",\n         \"//xla:util\",\n         \"//xla:xla_proto_cc\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/codegen:intrinsic_lib\",\n         \"//xla/codegen/intrinsic\",\n         \"//xla/codegen/intrinsic:intrinsic_compiler_lib\",\n@@ -144,7 +145,9 @@ xla_cc_test(\n     deps = [\n         \":ir_compiler\",\n         \":kernel_api_ir_builder\",\n+        \"//xla:debug_options_flags\",\n         \"//xla:util\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/service/cpu:backend_config_proto_cc\",\n         \"//xla/service/cpu:cpu_compiler_pure\",\n         \"//xla/service/cpu:test_header_helper\",\n@@ -318,7 +321,9 @@ xla_cc_test(\n         \":ir_compiler\",\n         \":jit_compiler\",\n         \":kernel_api_ir_builder\",\n+        \"//xla:debug_options_flags\",\n         \"//xla:util\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/runtime:function_library\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:env\",\n@@ -635,10 +640,12 @@ xla_cc_test(\n         \":execution_engine\",\n         \":ir_compiler\",\n         \":jit_compiler\",\n+        \":kernel_api_ir_builder\",\n         \":object_loader\",\n+        \"//xla:debug_options_flags\",\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n-        \"//xla/backends/cpu/codegen:kernel_api_ir_builder\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/runtime:function_library\",\n         \"//xla/service:cpu_plugin\",\n         \"//xla/service/cpu:executable_proto_cc\","
        },
        {
            "sha": "a532b353ce2f2b5aa5d694db6be0cb1d657690ac",
            "filename": "third_party/xla/xla/backends/cpu/codegen/ir_compiler.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 16,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -28,7 +28,6 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n-#include \"absl/strings/match.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/str_join.h\"\n@@ -63,9 +62,9 @@ limitations under the License.\n #include \"llvm/TargetParser/Triple.h\"\n #include \"llvm/Transforms/IPO/AlwaysInliner.h\"\n #include \"llvm/Transforms/Instrumentation/DataFlowSanitizer.h\"\n-#include \"xla/backends/cpu/codegen/cpu_features.h\"\n #include \"xla/backends/cpu/codegen/kernel_api_ir_builder.h\"\n #include \"xla/backends/cpu/codegen/polynomial_approximations.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/codegen/intrinsic/intrinsic.h\"\n #include \"xla/codegen/intrinsic/intrinsic_compiler_lib.h\"\n #include \"xla/codegen/intrinsic_lib.h\"\n@@ -76,7 +75,6 @@ limitations under the License.\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n #include \"xla/xla.pb.h\"\n-#include \"tsl/platform/cpu_info.h\"\n \n namespace xla::cpu {\n \n@@ -192,9 +190,9 @@ std::unique_ptr<IrCompiler> IrCompiler::Create(\n     llvm::TargetOptions target_options, Options options,\n     CompilationHooks hooks) {\n   TargetMachineBuilder target_machine_builder =\n-      IrCompiler::InferTargetMachineBuilder(\n-          std::move(target_options), options.opt_level,\n-          options.target_machine_options_proto);\n+      IrCompiler::InferTargetMachineBuilder(std::move(target_options),\n+                                            options.opt_level,\n+                                            options.target_machine_options);\n \n   return std::make_unique<IrCompiler>(target_machine_builder,\n                                       std::move(options), std::move(hooks));\n@@ -218,36 +216,35 @@ absl::once_flag initialize_llvm_flag;\n absl::StatusOr<std::unique_ptr<llvm::TargetMachine>>\n IrCompiler::InferTargetMachine(\n     const llvm::TargetOptions& target_options, llvm::CodeGenOptLevel opt_level,\n-    const TargetMachineOptionsProto& target_machine_options_proto) {\n-  llvm::SmallVector<std::string> attrs =\n-      absl::StrSplit(target_machine_options_proto.features(), ',');\n+    const TargetMachineOptions& target_machine_options) {\n+  auto attrs_vec = target_machine_options.GetTargetMachineFeaturesVector();\n+  llvm::SmallVector<std::string> attrs(attrs_vec.begin(), attrs_vec.end());\n \n   absl::call_once(initialize_llvm_flag, InitializeLLVMTarget);\n   std::unique_ptr<llvm::TargetMachine> target_machine(\n       llvm::EngineBuilder()\n           .setTargetOptions(target_options)\n           .setOptLevel(opt_level)\n           .selectTarget(\n-              /*TargetTriple=*/llvm::Triple(\n-                  target_machine_options_proto.triple()),\n+              /*TargetTriple=*/llvm::Triple(target_machine_options.triple()),\n               /*MArch=*/\"\",\n-              /*MCPU=*/target_machine_options_proto.cpu(),\n+              /*MCPU=*/target_machine_options.cpu(),\n               /*MAttrs=*/attrs));\n \n   if (target_machine == nullptr) {\n     return Internal(\"Failed to create target machine for CPU %s\",\n-                    target_machine_options_proto.cpu());\n+                    target_machine_options.cpu());\n   }\n \n   return std::move(target_machine);\n }\n \n IrCompiler::TargetMachineBuilder IrCompiler::InferTargetMachineBuilder(\n     const llvm::TargetOptions& target_options, llvm::CodeGenOptLevel opt_level,\n-    const TargetMachineOptionsProto& target_machine_options_proto) {\n-  return [target_options, opt_level, target_machine_options_proto] {\n+    const TargetMachineOptions& target_machine_options) {\n+  return [target_options, opt_level, target_machine_options] {\n     return InferTargetMachine(target_options, opt_level,\n-                              target_machine_options_proto);\n+                              target_machine_options);\n   };\n }\n "
        },
        {
            "sha": "c170bc0755f9c7f081ab72199fb0963c27bab2b7",
            "filename": "third_party/xla/xla/backends/cpu/codegen/ir_compiler.h",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.h?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -35,10 +35,10 @@ limitations under the License.\n #include \"llvm/Support/Error.h\"\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/Target/TargetOptions.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n #include \"xla/service/cpu/executable.pb.h\"\n #include \"xla/service/hlo_module_config.h\"\n-#include \"tsl/platform/cpu_info.h\"\n \n namespace xla::cpu {\n \n@@ -65,7 +65,7 @@ class IrCompiler : public llvm::orc::IRCompileLayer::IRCompiler {\n     llvm::CodeGenOptLevel opt_level = llvm::CodeGenOptLevel::None;\n     bool optimize_for_size = false;\n \n-    TargetMachineOptionsProto target_machine_options_proto;\n+    TargetMachineOptions target_machine_options;\n \n     llvm::FastMathFlags fast_math_flags;\n \n@@ -96,17 +96,16 @@ class IrCompiler : public llvm::orc::IRCompileLayer::IRCompiler {\n \n   // Infers the `llvm::TargetMachine` for the targeted host.\n   static absl::StatusOr<std::unique_ptr<llvm::TargetMachine>>\n-  InferTargetMachine(\n-      const llvm::TargetOptions& target_options,\n-      llvm::CodeGenOptLevel opt_level,\n-      const TargetMachineOptionsProto& target_machine_options_proto);\n+  InferTargetMachine(const llvm::TargetOptions& target_options,\n+                     llvm::CodeGenOptLevel opt_level,\n+                     const TargetMachineOptions& target_machine_options);\n \n   // Returns a target machine builder that uses `InferTargetMachine` defined\n   // above to infer the target machine for the given options.\n   static TargetMachineBuilder InferTargetMachineBuilder(\n       const llvm::TargetOptions& target_options,\n       llvm::CodeGenOptLevel opt_level,\n-      const TargetMachineOptionsProto& target_machine_options_proto);\n+      const TargetMachineOptions& target_machine_options);\n \n   // Compiles a `module` to an ObjectFile.\n   llvm::Expected<std::unique_ptr<llvm::MemoryBuffer>> operator()("
        },
        {
            "sha": "4cd49d46fce01db71e67a8abd00bcf06c9a8453a",
            "filename": "third_party/xla/xla/backends/cpu/codegen/ir_compiler_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler_test.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -39,6 +39,8 @@ limitations under the License.\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/TargetParser/Triple.h\"\n #include \"xla/backends/cpu/codegen/kernel_api_ir_builder.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n+#include \"xla/debug_options_flags.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n #include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/service/cpu/test_target_triple_helper.h\"\n@@ -107,7 +109,9 @@ TEST(IrCompilerTest, OverrideIrCompilerCompileOptions) {\n \n   std::unique_ptr<IrCompiler> ir_compiler = IrCompiler::Create(\n       llvm::TargetOptions(),\n-      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::Aggressive},\n+      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::Aggressive,\n+                          /*optimize_for_size=*/false,\n+                          TargetMachineOptions(GetDebugOptionsFromFlags())},\n       compilation_hooks);\n \n   std::vector<std::unique_ptr<llvm::Module>> modules;\n@@ -191,23 +195,22 @@ TEST(IrCompilerTest, TestAdditionalFeatures) {\n       return absl::InternalError(\"Failed to lookup target: \" + error);\n     }\n \n-    TargetMachineOptionsProto target_machine_options_proto;\n-    target_machine_options_proto.set_cpu(cpu_name);\n-    target_machine_options_proto.set_triple(triple);\n-    target_machine_options_proto.set_features(features);\n-\n-    cpu::AddAdditionalFeaturesIfAVX512(target_machine_options_proto);\n+    TargetMachineOptions target_machine_options(triple, cpu_name, features);\n \n     llvm::TargetOptions target_options;\n     return absl::WrapUnique(target->createTargetMachine(\n-        llvm::Triple(target_machine_options_proto.triple()),\n-        target_machine_options_proto.cpu(),\n-        target_machine_options_proto.features(), target_options,\n+        llvm::Triple(target_machine_options.triple()),\n+        target_machine_options.cpu(),\n+        target_machine_options.GetTargetMachineFeatures(), target_options,\n         /*RM=*/std::nullopt));\n   };\n \n-  IrCompiler ir_compiler(std::move(builder), IrCompiler::Options(),\n-                         IrCompiler::CompilationHooks());\n+  IrCompiler ir_compiler(\n+      std::move(builder),\n+      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::None,\n+                          /*optimize_for_size=*/false,\n+                          TargetMachineOptions(GetDebugOptionsFromFlags())},\n+      IrCompiler::CompilationHooks());\n \n   {\n     has_avx512 = true;\n@@ -234,16 +237,13 @@ TEST(IrCompilerTest, TargetMachineOptionsAreCorrectlySet) {\n   auto context = std::make_unique<llvm::LLVMContext>();\n   IrCompiler::CompilationHooks compilation_hooks;\n \n-  TargetMachineOptionsProto target_machine_options_proto;\n-  target_machine_options_proto.set_cpu(kTargetCpuForHost);\n-  target_machine_options_proto.set_triple(kTargetTripleForHost);\n-  target_machine_options_proto.set_features(\"+foo-feature,-bar-feature\");\n+  TargetMachineOptions target_machine_options(\n+      kTargetTripleForHost, kTargetCpuForHost, \"+foo-feature,-bar-feature\");\n \n   std::unique_ptr<IrCompiler> ir_compiler = IrCompiler::Create(\n       llvm::TargetOptions(),\n       IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::Aggressive,\n-                          /*optimize_for_size=*/false,\n-                          target_machine_options_proto},\n+                          /*optimize_for_size=*/false, target_machine_options},\n       compilation_hooks);\n \n   TF_ASSERT_OK_AND_ASSIGN(auto target_machine,"
        },
        {
            "sha": "dfb4110e82f839c9861730e410b31910a216e311",
            "filename": "third_party/xla/xla/backends/cpu/codegen/jit_compiler_test.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_compiler_test.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -38,13 +38,16 @@ limitations under the License.\n #include \"llvm/ExecutionEngine/Orc/ThreadSafeModule.h\"\n #include \"llvm/IR/DataLayout.h\"\n #include \"llvm/IR/LLVMContext.h\"\n+#include \"llvm/Support/CodeGen.h\"\n #include \"llvm/Support/Error.h\"\n #include \"llvm/Support/SourceMgr.h\"\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/Target/TargetOptions.h\"\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n #include \"xla/backends/cpu/codegen/kernel_api_ir_builder.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n+#include \"xla/debug_options_flags.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/errors.h\"\n@@ -97,9 +100,12 @@ TEST(JitCompilerTest, Compile) {\n     thread_pool.Schedule(std::move(task));\n   };\n \n-  std::unique_ptr<IrCompiler> ir_compiler =\n-      IrCompiler::Create(llvm::TargetOptions(), IrCompiler::Options(),\n-                         IrCompiler::CompilationHooks());\n+  std::unique_ptr<IrCompiler> ir_compiler = IrCompiler::Create(\n+      llvm::TargetOptions(),\n+      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::None,\n+                          /*optimize_for_size=*/false,\n+                          TargetMachineOptions(GetDebugOptionsFromFlags())},\n+      IrCompiler::CompilationHooks());\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto compiler,\n@@ -193,9 +199,12 @@ TEST(JitCompilerTest, ExternalDefinitionGenerator) {\n     return std::make_unique<ExternalDefinitionGenerator>();\n   };\n \n-  std::unique_ptr<IrCompiler> ir_compiler =\n-      IrCompiler::Create(llvm::TargetOptions(), IrCompiler::Options(),\n-                         IrCompiler::CompilationHooks());\n+  std::unique_ptr<IrCompiler> ir_compiler = IrCompiler::Create(\n+      llvm::TargetOptions(),\n+      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::None,\n+                          /*optimize_for_size=*/false,\n+                          TargetMachineOptions(GetDebugOptionsFromFlags())},\n+      IrCompiler::CompilationHooks());\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto compiler,"
        },
        {
            "sha": "5c86bdffd7de5f0ebed585460929a41af5b1f682",
            "filename": "third_party/xla/xla/backends/cpu/codegen/object_loader_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fobject_loader_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fobject_loader_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fobject_loader_test.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -42,6 +42,7 @@ limitations under the License.\n #include \"llvm/IR/DataLayout.h\"\n #include \"llvm/IR/LLVMContext.h\"\n #include \"llvm/Object/ObjectFile.h\"\n+#include \"llvm/Support/CodeGen.h\"\n #include \"llvm/Support/Error.h\"\n #include \"llvm/Support/SourceMgr.h\"\n #include \"llvm/Target/TargetMachine.h\"\n@@ -51,6 +52,8 @@ limitations under the License.\n #include \"xla/backends/cpu/codegen/jit_compiler.h\"\n #include \"xla/backends/cpu/codegen/kernel_api_ir_builder.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n+#include \"xla/debug_options_flags.h\"\n #include \"xla/service/cpu/executable.pb.h\"\n #include \"xla/service/llvm_ir/llvm_util.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n@@ -114,7 +117,11 @@ TEST_P(ObjectLoaderTest, Load) {\n   ir_compiler_hooks.post_codegen = object_files_saver;\n \n   std::unique_ptr<IrCompiler> ir_compiler = IrCompiler::Create(\n-      llvm::TargetOptions(), IrCompiler::Options(), ir_compiler_hooks);\n+      llvm::TargetOptions(),\n+      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::None,\n+                          /*optimize_for_size=*/false,\n+                          TargetMachineOptions(GetDebugOptionsFromFlags())},\n+      ir_compiler_hooks);\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto compiler,"
        },
        {
            "sha": "c455737533765d79da73d3f3cab8426f1474e9ca",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tools/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -21,6 +21,7 @@ cc_library(\n     srcs = [\"ir_compiler_opt_main.cc\"],\n     deps = [\n         \"//xla:debug_options_flags\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:ir_compiler\",\n         \"//xla/service/cpu:cpu_compiler_pure\",\n         \"//xla/tsl/platform:env\","
        },
        {
            "sha": "03c71381010e3ac51a671f19e79660fc593c30cb",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tools/ir_compiler_opt_main.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Fir_compiler_opt_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Fir_compiler_opt_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Fir_compiler_opt_main.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -40,6 +40,7 @@ limitations under the License.\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/Target/TargetOptions.h\"\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/tsl/platform/env.h\"\n@@ -116,11 +117,12 @@ absl::StatusOr<std::unique_ptr<llvm::Module>> ParseLlvmIr(\n absl::StatusOr<std::string> RunIrCompilerPasses(const IrCompilerOptConfig& opts,\n                                                 int argc, char** argv) {\n   llvm::TargetOptions target_options;\n-  IrCompiler::Options ir_compiler_options;\n   CHECK(opts.opt_level >= 0 && opts.opt_level <= 3)\n       << \"Optimization level must be between 0 and 3\";\n-  ir_compiler_options.opt_level =\n-      static_cast<llvm::CodeGenOptLevel>(opts.opt_level);\n+  IrCompiler::Options ir_compiler_options{\n+      /*opt_level=*/static_cast<llvm::CodeGenOptLevel>(opts.opt_level),\n+      /*optimize_for_size=*/false,\n+      TargetMachineOptions(GetDebugOptionsFromFlags())};\n   auto ir_compiler = IrCompiler::Create(target_options, ir_compiler_options,\n                                         IrCompiler::CompilationHooks());\n \n@@ -135,7 +137,7 @@ absl::StatusOr<std::string> RunIrCompilerPasses(const IrCompilerOptConfig& opts,\n       std::unique_ptr<llvm::TargetMachine> target_machine,\n       ir_compiler->InferTargetMachine(\n           target_options, static_cast<llvm::CodeGenOptLevel>(opts.opt_level),\n-          GetDefaultHostTargetMachineOptions(GetDebugOptionsFromFlags())));\n+          ir_compiler_options.target_machine_options));\n \n   llvm::Error error = ir_compiler->RunIrPasses(*module, target_machine.get());\n   if (error) {"
        },
        {
            "sha": "e4d57e372c0ef0ee63257c79f2f2c060a7caf9ac",
            "filename": "third_party/xla/xla/backends/cpu/testlib/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -24,6 +24,7 @@ cc_library(\n     hdrs = [\"kernel_runner.h\"],\n     deps = [\n         \"//xla:xla_proto_cc\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:builtin_definition_generator\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/backends/cpu/codegen:execution_engine\","
        },
        {
            "sha": "e1597dc72dcde019de3d6f3f4b76d0d0847e9e58",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -36,6 +36,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/function_library.h\"\n #include \"xla/backends/cpu/runtime/kernel.h\"\n #include \"xla/backends/cpu/runtime/kernel_c_api.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/codegen/kernel_definition.h\"\n #include \"xla/codegen/kernel_spec.h\"\n #include \"xla/codegen/llvm_kernel_source.h\"\n@@ -104,8 +105,8 @@ absl::StatusOr<JitCompiler> KernelRunner::CreateJitCompiler(\n   IrCompiler::Options ir_compiler_options{\n       /*optimization_level=*/IrCompiler::GetCodeGenOptLevel(config),\n       /*optimize_for_size=*/options::OptimizeForSizeRequested(config),\n-      /*target_machine_options_proto=*/\n-      GetDefaultHostTargetMachineOptions(debug_options),\n+      /*target_machine_options=*/\n+      TargetMachineOptions(debug_options),\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(config),\n       /*disable_expensive_passes=*/\n       debug_options.xla_llvm_disable_expensive_passes(),"
        },
        {
            "sha": "5a35e516120cb5003f028cf6313fe0228552a406",
            "filename": "third_party/xla/xla/pjrt/cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -153,6 +153,7 @@ cc_library(\n         \"//xla:xla_proto_cc\",\n         \"//xla/backends/cpu:alignment\",\n         \"//xla/backends/cpu:constant_allocation\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/backends/cpu/collectives:cpu_collectives\",\n         \"//xla/backends/cpu/runtime:buffer_allocations\",\n@@ -226,7 +227,6 @@ cc_library(\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n         \"@eigen_archive//:eigen3\",  # TODO(zhangqiaorjc): Remove if use TFRT threadpool.\n-        \"@llvm-project//llvm:TargetParser\",\n         \"@llvm-project//mlir:IR\",\n         \"@local_tsl//tsl/platform:casts\",\n         \"@local_tsl//tsl/platform:denormal\","
        },
        {
            "sha": "01a4e220bedab14d1fb85f93fb0798b8e59983d9",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -55,6 +55,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n #include \"xla/backends/cpu/runtime/xfeed_manager.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/client/executable_build_options.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/executable_run_options.h\"\n@@ -808,16 +809,14 @@ PjRtCpuClient::CompileInternal(\n       compile_options.thread_pool = pjrt_client_thread_pool();\n     }\n \n-    cpu::TargetMachineOptionsProto target_machine_options =\n-        cpu::GetDefaultHostTargetMachineOptions(\n-            hlo_module->config().debug_options());\n+    cpu::TargetMachineOptions target_machine_options(\n+        hlo_module->config().debug_options());\n     // Overwrite the features with the machine attributes from the topology.\n-    target_machine_options.set_features(\n-        absl::StrJoin(topology_.cpu_topology().machine_attributes(), \",\"));\n \n-    compile_options.cpu_target_config.emplace(target_machine_options);\n+    TF_RETURN_IF_ERROR(target_machine_options.SetFeatures(\n+        absl::StrJoin(topology_.cpu_topology().machine_attributes(), \",\")));\n \n-    cpu::AddAdditionalFeaturesIfAVX512(target_machine_options);\n+    compile_options.cpu_target_config.emplace(target_machine_options);\n \n     TF_ASSIGN_OR_RETURN(cpu_executable,\n                         JitCompile(std::move(hlo_module), build_options,"
        },
        {
            "sha": "8f4cd95e797da937dad230dc363df0ecfb74c9bc",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -1578,9 +1578,9 @@ cc_library(\n         \"//xla:debug_options_flags\",\n         \"//xla:shape_util\",\n         \"//xla:util\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/pjrt/distributed:key_value_store_interface\",\n-        \"//xla/service/cpu:executable_proto_cc\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/stream_executor:device_memory_allocator\",\n         \"//xla/stream_executor:dnn\","
        },
        {
            "sha": "6037561a66ad39259b6d38293f80a5294731dca8",
            "filename": "third_party/xla/xla/service/compiler.h",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcompiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcompiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcompiler.h?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -35,14 +35,14 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"google/protobuf/message.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/pjrt/distributed/key_value_store_interface.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/service/buffer_value.h\"\n #include \"xla/service/computation_placer.h\"\n-#include \"xla/service/cpu/executable.pb.h\"\n #include \"xla/service/executable.h\"\n #include \"xla/service/hlo_cost_analysis.h\"\n #include \"xla/service/hlo_module_config.h\"\n@@ -161,12 +161,12 @@ class Compiler {\n   // Description of a target CPU for compilation.\n   struct CpuTargetConfig {\n     explicit CpuTargetConfig(\n-        const cpu::TargetMachineOptionsProto& target_machine_options_proto)\n-        : cpu_target_machine_options_proto(target_machine_options_proto) {};\n+        const cpu::TargetMachineOptions& target_machine_options)\n+        : cpu_target_machine_options(target_machine_options) {};\n \n     // If not set, we default to the options inferred from the host machine.\n-    std::optional<cpu::TargetMachineOptionsProto>\n-        cpu_target_machine_options_proto = std::nullopt;\n+    std::optional<cpu::TargetMachineOptions> cpu_target_machine_options =\n+        std::nullopt;\n   };\n \n   struct CompileOptions {"
        },
        {
            "sha": "cc608c3575e58e4ba5604ab75ef4087a42202b57",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -184,6 +184,7 @@ cc_library(\n         \"//xla:xla_proto_cc\",\n         \"//xla/backends/cpu:alignment\",\n         \"//xla/backends/cpu:constant_allocation\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu:xnn_support\",\n         \"//xla/backends/cpu/codegen:builtin_definition_generator\",\n         \"//xla/backends/cpu/codegen:compiled_function_library\",\n@@ -398,6 +399,7 @@ cc_library(\n         \"//xla/backends/cpu:buffer_allocation_info\",\n         \"//xla/backends/cpu:buffer_allocation_info_util\",\n         \"//xla/backends/cpu:constant_allocation\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/runtime:function_library\",\n         \"//xla/backends/cpu/runtime:thunk\",\n         \"//xla/backends/cpu/runtime:thunk_proto_cc\",\n@@ -515,6 +517,7 @@ xla_test(\n         \"//xla:debug_options_flags\",\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/service:compiler\",\n@@ -558,7 +561,6 @@ cc_library(\n     srcs = [\"cpu_executable.cc\"],\n     hdrs = [\"cpu_executable.h\"],\n     deps = [\n-        \":cpu_runtime\",\n         \":executable_proto_cc\",\n         \"//xla:executable_run_options\",\n         \"//xla:shape_tree\",\n@@ -567,6 +569,7 @@ cc_library(\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/backends/cpu:constant_allocation\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/runtime:buffer_allocations\",\n         \"//xla/backends/cpu/runtime:function_library\",\n         \"//xla/backends/cpu/runtime:thread_pool_task_runner\",\n@@ -683,6 +686,7 @@ xla_cc_test(\n         \":target_machine_features_stub\",\n         \"//xla:shape_util\",\n         \"//xla/backends/cpu:alignment\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:builtin_definition_generator\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/backends/cpu/codegen:execution_engine\",\n@@ -1936,6 +1940,7 @@ cc_library(\n         \":cpu_aot_compilation_result\",\n         \":executable_proto_cc\",\n         \"//xla:util\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:builtin_definition_generator\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/backends/cpu/codegen:execution_engine\","
        },
        {
            "sha": "3efb1518106fbdc0a703275eb4200d8c171f8184",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compilation_result.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -36,6 +36,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n #include \"xla/backends/cpu/runtime/thunk_proto_serdes.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_schedule.h\"\n@@ -191,12 +192,16 @@ CpuAotCompilationResult::LoadExecutable(\n   TF_ASSIGN_OR_RETURN(std::vector<ConstantAllocation> constants,\n                       CreateConstantAllocations(*buffer_assignment));\n \n+  TF_ASSIGN_OR_RETURN(\n+      TargetMachineOptions target_machine_options,\n+      TargetMachineOptions::FromProto(proto_.target_machine_options()));\n+\n   TF_ASSIGN_OR_RETURN(\n       cpu_executable,\n       CpuExecutable::Create(std::move(function_library_),\n                             std::move(buffer_assignment), std::move(module),\n                             std::move(*thunks), std::move(constants), nullptr,\n-                            nullptr, proto_.target_machine_options()));\n+                            nullptr, target_machine_options));\n \n   // Dump computation proto state and buffer assignment for\n   // GetCompiledMemoryStats results."
        },
        {
            "sha": "b3544407d615469af3f0cc740297746946ea5439",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compiler_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include \"llvm/TargetParser/Host.h\"\n #include \"llvm/TargetParser/Triple.h\"\n #include \"xla/backends/cpu/codegen/cpu_features.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/literal.h\"\n@@ -227,11 +228,9 @@ ENTRY main {\n                           ParseAndReturnVerifiedModule(module_string));\n \n   xla::Compiler::CompileOptions compile_options;\n-  TargetMachineOptionsProto target_machine_options_proto;\n-  target_machine_options_proto.set_triple(kTargetTripleForHost);\n-  target_machine_options_proto.set_cpu(kTargetCpuForHost);\n-  target_machine_options_proto.set_features(\"+foo-feature,-bar-feature\");\n-  compile_options.cpu_target_config.emplace(target_machine_options_proto);\n+  TargetMachineOptions target_machine_options(\n+      kTargetTripleForHost, kTargetCpuForHost, \"+foo-feature,-bar-feature\");\n+  compile_options.cpu_target_config.emplace(target_machine_options);\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       hlo_module, compiler->RunHloPasses(std::move(hlo_module), stream_exec,"
        },
        {
            "sha": "21ebdebf6730f2cac8dcbd9fce9532312163d080",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 11,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -38,6 +38,7 @@ limitations under the License.\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n #include \"xla/backends/cpu/codegen/object_loader.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/service/compiler.h\"\n #include \"xla/service/cpu/cpu_aot_compilation_result.h\"\n #include \"xla/service/cpu/executable.pb.h\"\n@@ -90,7 +91,7 @@ GetCompiledSymbolsFromProto(\n absl::StatusOr<std::unique_ptr<FunctionLibrary>> LoadFunctionLibrary(\n     const std::vector<FunctionLibrary::Symbol>& compiled_symbols,\n     absl::Span<const ObjFileProto> obj_files, const HloModule* hlo_module,\n-    const TargetMachineOptionsProto& target_machine_options_proto) {\n+    const TargetMachineOptions& target_machine_options) {\n   const HloModuleConfig& config = hlo_module->config();\n \n   auto llvm_options = llvm_ir::ExtractXlaBackendExtraOptions(\n@@ -101,8 +102,7 @@ absl::StatusOr<std::unique_ptr<FunctionLibrary>> LoadFunctionLibrary(\n       std::unique_ptr<llvm::TargetMachine> target_machine,\n       IrCompiler::InferTargetMachine(\n           std::move(CompilerTargetOptions(hlo_module->config())),\n-          IrCompiler::GetCodeGenOptLevel(config),\n-          target_machine_options_proto));\n+          IrCompiler::GetCodeGenOptLevel(config), target_machine_options));\n \n   // Definition generator to link with XLA:CPU host runtime symbols.\n   ExecutionEngine::DefinitionGenerator definition_generator =\n@@ -172,26 +172,27 @@ CpuAotLoader::LoadAotCompilationResult(\n       hlo_module->config().debug_options().xla_backend_extra_options());\n   llvm_ir::LLVMCommandLineOptionsLock llvm_lock(llvm_options);\n \n+  TF_ASSIGN_OR_RETURN(TargetMachineOptions target_machine_options,\n+                      TargetMachineOptions::FromProto(\n+                          aot_result_proto.target_machine_options()));\n+\n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<llvm::TargetMachine> target_machine,\n       IrCompiler::InferTargetMachine(\n           std::move(CompilerTargetOptions(hlo_module->config())),\n           IrCompiler::GetCodeGenOptLevel(hlo_module->config()),\n-          aot_result_proto.target_machine_options()));\n+          target_machine_options));\n \n-  llvm::Triple triple(aot_result_proto.target_machine_options().triple());\n+  llvm::Triple triple(target_machine_options.triple());\n   llvm::Triple expected_triple(target_machine->getTargetTriple());\n   if (triple.getArchName() != expected_triple.getArchName()) {\n     return Internal(\"Target arch mismatch expected %s got %s.\",\n                     expected_triple.getArchName(), triple.getArchName());\n   }\n \n   llvm::StringMap<bool> host_machine_features = llvm::sys::getHostCPUFeatures();\n-  std::vector<absl::string_view> compile_machine_features =\n-      aot_result_proto.target_machine_options().features().empty()\n-          ? std::vector<absl::string_view>()\n-          : absl::StrSplit(aot_result_proto.target_machine_options().features(),\n-                           ',');\n+  std::vector<std::string> compile_machine_features =\n+      target_machine_options.GetTargetMachineFeaturesVector();\n   // Convert the supported features to a vector of strings.\n   std::vector<std::string> host_machine_features_vector;\n   for (const auto& [feature, supported] : host_machine_features) {\n@@ -234,7 +235,7 @@ CpuAotLoader::LoadAotCompilationResult(\n   TF_ASSIGN_OR_RETURN(\n       auto function_library,\n       LoadFunctionLibrary(compiled_symbols, obj_files, hlo_module.get(),\n-                          aot_result_proto.target_machine_options()));\n+                          target_machine_options));\n \n   return CpuAotCompilationResult::FromProto(aot_result_proto,\n                                             std::move(function_library));"
        },
        {
            "sha": "1f8e8def43db4017c73bc3021fbdc3c80c42f39b",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.h?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"llvm/Target/TargetOptions.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/service/compiler.h\"\n #include \"xla/service/cpu/executable.pb.h\"\n@@ -37,7 +38,7 @@ llvm::TargetOptions CompilerTargetOptions(const HloModuleConfig& module_config);\n absl::StatusOr<std::unique_ptr<FunctionLibrary>> LoadFunctionLibrary(\n     const std::vector<FunctionLibrary::Symbol>& compiled_symbols,\n     absl::Span<const ObjFileProto> obj_files, const HloModule* hlo_module,\n-    const TargetMachineOptionsProto& target_machine_options_proto);\n+    const TargetMachineOptions& target_machine_options);\n \n absl::StatusOr<std::vector<FunctionLibrary::Symbol>>\n GetCompiledSymbolsFromProto("
        },
        {
            "sha": "a7c46c581dd26e0194975fab87ad38f37e7f5b0c",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 69,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -100,6 +100,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n #include \"xla/backends/cpu/runtime/thunk_proto_serdes.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/backends/cpu/transforms/collectives/all_reduce_combiner.h\"\n #include \"xla/backends/cpu/transforms/library_rewriter.h\"\n #include \"xla/backends/cpu/transforms/xnn_graph_fusion.h\"\n@@ -370,47 +371,6 @@ absl::StatusOr<std::vector<std::unique_ptr<Executable>>> CpuCompiler::Compile(\n   llvm::InitializeNativeTargetAsmPrinter();\n }\n \n-void AddAdditionalFeaturesIfAVX512(\n-    TargetMachineOptionsProto& target_machine_options_proto) {\n-  if (absl::StrContains(target_machine_options_proto.features(), \"+avx512\")) {\n-    std::string new_features = target_machine_options_proto.features();\n-\n-    constexpr absl::string_view kPreferNoScatter = \"+prefer-no-scatter\";\n-    constexpr absl::string_view kPreferNoGather = \"+prefer-no-gather\";\n-    if (new_features.find(kPreferNoScatter) == std::string::npos) {\n-      new_features = absl::StrJoin({new_features, kPreferNoScatter}, \",\");\n-    }\n-    if (new_features.find(kPreferNoGather) == std::string::npos) {\n-      new_features = absl::StrJoin({new_features, kPreferNoGather}, \",\");\n-    }\n-    target_machine_options_proto.set_features(new_features);\n-  }\n-}\n-\n-TargetMachineOptionsProto GetDefaultHostTargetMachineOptions(\n-    const DebugOptions& debug_options) {\n-  TargetMachineOptionsProto target_machine_options_proto;\n-  // Fallback to the default target machine options.\n-  target_machine_options_proto.set_triple(llvm::sys::getDefaultTargetTriple());\n-\n-  auto xla_cpu_max_isa = CpuFeatureFromString(debug_options.xla_cpu_max_isa());\n-  auto detected_machine_attributes = DetectMachineAttributes(xla_cpu_max_isa);\n-  target_machine_options_proto.set_features(\n-      absl::StrJoin(detected_machine_attributes.features, \",\"));\n-\n-  // If `max_cpu_feature` is newer than the host CPU, we should keep the host\n-  // CPU name, e.g., we don't want to set the target CPU to Skylake when we\n-  // are on a Broadwell host.\n-  auto cpu_host_name = detected_machine_attributes.num_filtered_features\n-                           ? CpuTargetFromMaxFeature(*xla_cpu_max_isa)\n-                           : absl::string_view(llvm::sys::getHostCPUName());\n-  target_machine_options_proto.set_cpu(cpu_host_name);\n-\n-  AddAdditionalFeaturesIfAVX512(target_machine_options_proto);\n-\n-  return target_machine_options_proto;\n-}\n-\n namespace {\n \n // This visitor records which HLO instructions should have profiling information\n@@ -1267,19 +1227,19 @@ absl::StatusOr<std::unique_ptr<HloModule>> CpuCompiler::RunHloPasses(\n     llvm_ir::LLVMCommandLineOptionsLock llvm_lock(llvm_options);\n \n     // Use default target machine options if not specified in the target config.\n-    auto target_machine_options_proto =\n-        GetDefaultHostTargetMachineOptions(module->config().debug_options());\n+    TargetMachineOptions target_machine_options(\n+        module->config().debug_options());\n     if (options.cpu_target_config &&\n-        options.cpu_target_config->cpu_target_machine_options_proto) {\n-      target_machine_options_proto =\n-          options.cpu_target_config->cpu_target_machine_options_proto.value();\n+        options.cpu_target_config->cpu_target_machine_options) {\n+      target_machine_options =\n+          options.cpu_target_config->cpu_target_machine_options.value();\n     }\n \n     TF_ASSIGN_OR_RETURN(\n         jit_target_machine,\n         IrCompiler::InferTargetMachine(CompilerTargetOptions(config),\n                                        IrCompiler::GetCodeGenOptLevel(config),\n-                                       target_machine_options_proto));\n+                                       target_machine_options));\n   }\n \n   TF_RETURN_IF_ERROR(RunHloPasses(module.get(), /*is_aot_compile=*/false,\n@@ -2059,20 +2019,17 @@ CpuCompiler::CompileCpuExecutable(\n   // CompileOptions::target_config field as we consider TargetMachine to be the\n   // source of truth at this point. This is because the AOT path might set its\n   // own target machine options.\n-  TargetMachineOptionsProto target_machine_options_proto;\n-  target_machine_options_proto.set_triple(\n-      target_machine->getTargetTriple().normalize());\n-  target_machine_options_proto.set_cpu(target_machine->getTargetCPU());\n-  target_machine_options_proto.set_features(\n-      target_machine->getTargetFeatureString());\n+  TargetMachineOptions target_machine_options(\n+      target_machine->getTargetTriple().normalize(),\n+      target_machine->getTargetCPU(), target_machine->getTargetFeatureString());\n \n   TF_ASSIGN_OR_RETURN(\n       auto cpu_executable,\n       CpuExecutable::Create(\n           std::move(function_library), std::move(assignment), std::move(module),\n           std::move(thunks), std::move(constants),\n           std::move(hlo_profile_printer_data), std::move(hlo_profile_index_map),\n-          std::move(target_machine_options_proto)));\n+          std::move(target_machine_options)));\n \n   // Save object files to be able to export them to AOT compilation\n   // result.\n@@ -2113,20 +2070,19 @@ absl::StatusOr<std::unique_ptr<Executable>> CpuCompiler::RunBackend(\n       module->config().debug_options().xla_backend_extra_options());\n   llvm_ir::LLVMCommandLineOptionsLock llvm_lock(llvm_options);\n \n-  auto target_machine_options_proto =\n-      GetDefaultHostTargetMachineOptions(module->config().debug_options());\n+  TargetMachineOptions target_machine_options(module->config().debug_options());\n   if (options.cpu_target_config &&\n-      options.cpu_target_config->cpu_target_machine_options_proto) {\n-    target_machine_options_proto =\n-        options.cpu_target_config->cpu_target_machine_options_proto.value();\n+      options.cpu_target_config->cpu_target_machine_options) {\n+    target_machine_options =\n+        options.cpu_target_config->cpu_target_machine_options.value();\n   }\n \n   // Options for compiling LLVM IR to machine code.\n   IrCompiler::Options ir_compiler_options{\n       /*optimization_level=*/IrCompiler::GetCodeGenOptLevel(module->config()),\n       /*optimize_for_size=*/options::OptimizeForSizeRequested(module->config()),\n-      /*target_machine_options_proto=*/\n-      target_machine_options_proto,\n+      /*target_machine_options=*/\n+      target_machine_options,\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(module->config()),\n       /*disable_expensive_passes=*/\n       module->config().debug_options().xla_llvm_disable_expensive_passes(),\n@@ -2264,18 +2220,15 @@ CpuCompiler::CompileAheadOfTimeThunks(\n       /*compile_copy_as_llvm_kernel=*/aot_options.compile_copy_as_llvm_kernel(),\n       /*is_aot_compilation=*/true};\n \n-  TargetMachineOptionsProto target_machine_options_proto;\n-  target_machine_options_proto.set_triple(\n-      target_machine->getTargetTriple().normalize());\n-  target_machine_options_proto.set_cpu(target_machine->getTargetCPU());\n-  target_machine_options_proto.set_features(\n+  TargetMachineOptions target_machine_options(\n+      triple.normalize(), target_machine->getTargetCPU(),\n       target_machine->getTargetFeatureString());\n \n   IrCompiler::Options ir_compiler_options = {\n       /*optimization_level=*/target_machine->getOptLevel(),\n       /*optimize_for_size=*/\n       options::OptimizeForSizeRequested(module->config()),\n-      /*target_machine_options_proto=*/target_machine_options_proto,\n+      /*target_machine_options=*/target_machine_options,\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(module->config()),\n       /*disable_expensive_passes=*/\n       module->config().debug_options().xla_llvm_disable_expensive_passes(),\n@@ -2324,7 +2277,7 @@ CpuCompiler::CompileAheadOfTimeThunks(\n       cpu_executable->get_compiled_symbols_proto(), thunk_sequence,\n       std::move(*cpu_executable).consume_function_library(),\n       std::move(executable_hlo_profile_printer_data),\n-      cpu_executable->target_machine_options());\n+      cpu_executable->target_machine_options().ToProto());\n }\n \n se::Platform::Id CpuCompiler::PlatformId() const {\n@@ -2377,7 +2330,7 @@ absl::StatusOr<std::unique_ptr<AotCompilationResult>> CpuCompiler::Export(\n       std::move(compiled_symbols_proto), *thunk_sequence,\n       std::move(function_library),\n       std::move(executable_hlo_profile_printer_data),\n-      cpu_executable->target_machine_options());\n+      cpu_executable->target_machine_options().ToProto());\n }\n \n absl::StatusOr<std::unique_ptr<AotCompilationResult>>"
        },
        {
            "sha": "0816a51979f7d2cef9bd137c65ae0f973f3210be",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.h",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.h?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -50,12 +50,6 @@ class DialectRegistry;\n namespace xla {\n namespace cpu {\n \n-void AddAdditionalFeaturesIfAVX512(\n-    TargetMachineOptionsProto& target_machine_options_proto);\n-\n-TargetMachineOptionsProto GetDefaultHostTargetMachineOptions(\n-    const DebugOptions& debug_options);\n-\n // CPU-targeting implementation of the XLA Compiler interface.\n //\n // The compiler translates XLA HLO code into LLVM IR and uses LLVM's JIT"
        },
        {
            "sha": "e2a4e81f899eb66bd6bfe6ce26a11e375dd4c0c4",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -45,6 +45,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n #include \"xla/backends/cpu/runtime/xfeed_manager.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_input_output_alias_config.h\"\n@@ -89,7 +90,7 @@ absl::StatusOr<std::unique_ptr<CpuExecutable>> CpuExecutable::Create(\n     std::vector<ConstantAllocation> constants,\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     std::unique_ptr<HloProfileIndexMap> hlo_profile_index_map,\n-    TargetMachineOptionsProto target_machine_options) {\n+    TargetMachineOptions target_machine_options) {\n   VLOG(2) << \"Create CpuExecutable from a thunk sequence; module=\"\n           << hlo_module->name() << \", constants=\" << constants.size();\n \n@@ -133,7 +134,7 @@ CpuExecutable::CpuExecutable(\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     std::unique_ptr<HloProfileIndexMap> hlo_profile_index_map,\n     std::unique_ptr<BufferAssignment> assignment,\n-    TargetMachineOptionsProto target_machine_options)\n+    TargetMachineOptions target_machine_options)\n     : Executable(std::move(hlo_module), std::move(hlo_profile_printer_data),\n                  std::move(hlo_profile_index_map)),\n       assignment_(std::move(assignment)),"
        },
        {
            "sha": "c71dc382544f6f5aecc858710838106a791c8224",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.h",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.h?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -32,6 +32,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/function_library.h\"\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -63,7 +64,7 @@ class CpuExecutable : public Executable {\n       std::vector<ConstantAllocation> constants,\n       std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n       std::unique_ptr<HloProfileIndexMap> hlo_profile_index_map,\n-      TargetMachineOptionsProto target_machine_options);\n+      TargetMachineOptions target_machine_options);\n \n   ~CpuExecutable() override;\n \n@@ -151,7 +152,7 @@ class CpuExecutable : public Executable {\n   // structures that might have been used at compile time.\n   void Finalize();\n \n-  const TargetMachineOptionsProto& target_machine_options() const {\n+  const TargetMachineOptions& target_machine_options() const {\n     return target_machine_options_;\n   }\n \n@@ -239,7 +240,7 @@ class CpuExecutable : public Executable {\n   // Whether the thunk executor contains any YNN fusion thunks.\n   bool has_ynn_fusions_ = false;\n \n-  TargetMachineOptionsProto target_machine_options_;\n+  TargetMachineOptions target_machine_options_;\n \n   // Entry function name for the computation.\n   std::string entry_function_name_;\n@@ -248,7 +249,7 @@ class CpuExecutable : public Executable {\n                 std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n                 std::unique_ptr<HloProfileIndexMap> hlo_profile_index_map,\n                 std::unique_ptr<BufferAssignment> assignment,\n-                TargetMachineOptionsProto target_machine_options);\n+                TargetMachineOptions target_machine_options);\n   CpuExecutable(const CpuExecutable&) = delete;\n   CpuExecutable& operator=(const CpuExecutable&) = delete;\n };"
        },
        {
            "sha": "bd87c2ad04ace4dbfb94657befc3c93c88e09dc0",
            "filename": "third_party/xla/xla/service/cpu/ir_emitter_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fir_emitter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fir_emitter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fir_emitter_test.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -46,6 +46,7 @@ limitations under the License.\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n #include \"xla/backends/cpu/codegen/jit_compiler.h\"\n #include \"xla/backends/cpu/codegen/target_machine_features.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/analysis/hlo_ordering.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n@@ -232,8 +233,8 @@ CreateIrEmitterForConstantEmissionTests(HloModule& module,\n   IrCompiler::Options ir_compiler_options{\n       /*optimization_level=*/llvm::CodeGenOptLevel::Default,\n       /*optimize_for_size=*/options::OptimizeForSizeRequested(config),\n-      /*target_machine_options_proto=*/\n-      GetDefaultHostTargetMachineOptions(module.config().debug_options()),\n+      /*target_machine_options=*/\n+      TargetMachineOptions(module.config().debug_options()),\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(config),\n       /*disable_expensive_passes=*/\n       debug_options.xla_llvm_disable_expensive_passes(),"
        },
        {
            "sha": "5cc6765420d4106139ecdb92c7cd30c0fe09829b",
            "filename": "third_party/xla/xla/tools/hlo_opt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2FBUILD?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -163,6 +163,7 @@ cc_library(\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla:xla_proto_cc\",\n+        \"//xla/backends/cpu:target_machine_options\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/backends/cpu/codegen:ir_compiler\",\n         \"//xla/backends/cpu/codegen:target_machine_features\",\n@@ -187,7 +188,6 @@ cc_library(\n         \"//xla/service:sharding_propagation\",\n         \"//xla/service:transpose_folding\",\n         \"//xla/service/cpu:conv_canonicalization\",\n-        \"//xla/service/cpu:cpu_compiler\",\n         \"//xla/service/cpu:cpu_executable\",\n         \"//xla/service/cpu:cpu_instruction_fusion\",\n         \"//xla/service/cpu:cpu_layout_assignment\","
        },
        {
            "sha": "4f336f9d7c2aace6963f04b597345edd6f1d9710",
            "filename": "third_party/xla/xla/tools/hlo_opt/cpu_opt.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2Fcpu_opt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/966c58ef2fe77eca2b84c17977395d3537bb8357/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2Fcpu_opt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2Fcpu_opt.cc?ref=966c58ef2fe77eca2b84c17977395d3537bb8357",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n #include \"xla/backends/cpu/codegen/cpu_features.h\"\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n #include \"xla/backends/cpu/codegen/target_machine_features.h\"\n+#include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n@@ -44,7 +45,6 @@ limitations under the License.\n #include \"xla/service/change_op_data_type.h\"\n #include \"xla/service/copy_insertion.h\"\n #include \"xla/service/cpu/conv_canonicalization.h\"\n-#include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/service/cpu/cpu_executable.h\"\n #include \"xla/service/cpu/cpu_instruction_fusion.h\"\n #include \"xla/service/cpu/cpu_layout_assignment.h\"\n@@ -126,8 +126,7 @@ class CpuOptProvider : public CompiledOptProvider {\n         cpu::IrCompiler::InferTargetMachine(\n             CompilerTargetOptions(module_config),\n             CodeGenOptLevel(module_config),\n-            cpu::GetDefaultHostTargetMachineOptions(\n-                module_config.debug_options()));\n+            cpu::TargetMachineOptions(module_config.debug_options()));\n     if (!jit_target_machine.ok()) {\n       LOG(ERROR) << \"Failed to infer target machine: \"\n                  << jit_target_machine.status();"
        }
    ],
    "stats": {
        "total": 333,
        "additions": 158,
        "deletions": 175
    }
}