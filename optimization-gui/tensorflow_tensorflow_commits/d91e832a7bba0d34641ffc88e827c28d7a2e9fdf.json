{
    "author": "emilyfertig",
    "message": "[PJRT C API] Add on_done callback to CopyToRemoteDevice in the cross-host transfer extension.\n\nPiperOrigin-RevId: 835038444",
    "sha": "d91e832a7bba0d34641ffc88e827c28d7a2e9fdf",
    "files": [
        {
            "sha": "45cd1e9cb18ba760f48443373a59c0fd6a9b681e",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_helpers.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_helpers.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_helpers.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_helpers.cc?ref=d91e832a7bba0d34641ffc88e827c28d7a2e9fdf",
            "patch": "@@ -210,6 +210,7 @@ absl::StatusCode PjrtErrorCodeToStatusCode(PJRT_Error_Code code) {\n \n PJRT_Error_Code StatusCodeToPjrtErrorCode(absl::StatusCode code) {\n   switch (static_cast<tsl::error::Code>(code)) {\n+    case tsl::error::OK:\n     case tsl::error::CANCELLED:\n     case tsl::error::UNKNOWN:\n     case tsl::error::INVALID_ARGUMENT:\n@@ -227,9 +228,6 @@ PJRT_Error_Code StatusCodeToPjrtErrorCode(absl::StatusCode code) {\n     case tsl::error::UNAVAILABLE:\n     case tsl::error::DATA_LOSS:\n       return static_cast<PJRT_Error_Code>(code);\n-    case tsl::error::OK:\n-      CHECK(false) << \"Status::OK() cannot be converted to PJRT_Error code, \"\n-                      \"use nullptr instead\";\n     case tensorflow::error::\n         DO_NOT_USE_RESERVED_FOR_FUTURE_EXPANSION_USE_DEFAULT_IN_SWITCH_INSTEAD_:\n       CHECK(false) << \"got DO_NOT_USE_RESERVED_FOR_FUTURE_EXPANSION_\""
        },
        {
            "sha": "5c5ca4ad6f8c928a8b5e429dede1bf259161216c",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=d91e832a7bba0d34641ffc88e827c28d7a2e9fdf",
            "patch": "@@ -3115,6 +3115,9 @@ void PjRtCApiBuffer::CopyToRemoteDevice(\n                        << descriptor.status();\n   args.serialized_descriptor = descriptor->c_str();\n   args.serialized_descriptor_size = descriptor->size();\n+  PJRT_Transfers_CrossHostRemoteSendCallbackInfo on_done_info =\n+      pjrt::CppCrossHostRemoteSendCallbackToC(pjrt_c_api(), std::move(on_done));\n+  args.on_done = on_done_info;\n   extension->PJRT_Transfers_PJRT_Buffer_CopyToRemoteDevice(&args);\n }\n "
        },
        {
            "sha": "5b70b483d15dcd33498a58bd5cad38175b66f010",
            "filename": "third_party/xla/xla/pjrt/extensions/cross_host_transfers/pjrt_c_api_cross_host_transfers_extension.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 5,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fextensions%2Fcross_host_transfers%2Fpjrt_c_api_cross_host_transfers_extension.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fextensions%2Fcross_host_transfers%2Fpjrt_c_api_cross_host_transfers_extension.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fextensions%2Fcross_host_transfers%2Fpjrt_c_api_cross_host_transfers_extension.cc?ref=d91e832a7bba0d34641ffc88e827c28d7a2e9fdf",
            "patch": "@@ -113,7 +113,8 @@ static xla::PjRtCrossHostRecvNotifier CCrossHostRecvNotifierToCpp(\n              absl::StatusOr<xla::PjRtCrossHostRecvState> recv_state) {\n     if (!recv_state.ok()) {\n       auto error = new PJRT_Error{recv_state.status()};\n-      return notifier(error, nullptr, nullptr, 0, user_arg);\n+      notifier(error, nullptr, nullptr, 0, user_arg);\n+      return;\n     }\n     auto& descriptors = recv_state->descriptors;\n     std::vector<size_t> descriptors_sizes;\n@@ -126,8 +127,8 @@ static xla::PjRtCrossHostRecvNotifier CCrossHostRecvNotifierToCpp(\n       descriptors_sizes.push_back(\n           descriptors[i].serialized_descriptors.front().size());\n     }\n-    return notifier(nullptr, serialized_descriptors.data(),\n-                    descriptors_sizes.data(), descriptors.size(), user_arg);\n+    notifier(nullptr, serialized_descriptors.data(), descriptors_sizes.data(),\n+             descriptors.size(), user_arg);\n   };\n }\n }  // namespace\n@@ -176,6 +177,28 @@ PJRT_Transfers_CrossHostRecvNotifierInfo CppCrossHostRecvNotifierToC(\n       }};\n }\n \n+PJRT_Transfers_CrossHostRemoteSendCallbackInfo\n+CppCrossHostRemoteSendCallbackToC(\n+    const PJRT_Api* c_api, xla::PjRtBuffer::RemoteSendCallback cpp_callback) {\n+  using RemoteSendCallbackFunction =\n+      std::function<void(PJRT_Error * error, bool sends_were_enqueued)>;\n+  auto on_done_function = new RemoteSendCallbackFunction(\n+      [cpp_callback = std::move(cpp_callback), c_api](\n+          PJRT_Error* error, bool sends_were_enqueued) {\n+        absl::Status status = ::pjrt::PjrtErrorToStatus(error, c_api);\n+        cpp_callback(status, sends_were_enqueued);\n+      });\n+  return PJRT_Transfers_CrossHostRemoteSendCallbackInfo{\n+      /*user_arg=*/on_done_function,\n+      /*on_done=*/\n+      [](PJRT_Error* error, bool sends_were_enqueued, void* user_arg) {\n+        RemoteSendCallbackFunction* on_done_fn =\n+            reinterpret_cast<RemoteSendCallbackFunction*>(user_arg);\n+        (*on_done_fn)(error, sends_were_enqueued);\n+        delete on_done_fn;\n+      }};\n+}\n+\n PJRT_Error* PJRT_Transfers_PJRT_Client_MakeCrossHostReceiveBuffers(\n     PJRT_Transfers_PJRT_Client_MakeCrossHostReceiveBuffers_Args* args) {\n   PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n@@ -210,9 +233,14 @@ void PJRT_Transfers_PJRT_Buffer_CopyToRemoteDevice(\n       args->serialized_descriptor, args->serialized_descriptor_size);\n   xla::Future<std::string> descriptor_future(std::move(serialized_descriptor));\n \n-  // TODO(emilyaf): Support on_done callback.\n   xla::PjRtBuffer::RemoteSendCallback on_done =\n-      [](absl::Status status, bool sends_were_enqueued) { CHECK_OK(status); };\n+      [user_arg = args->on_done.user_arg, on_done = args->on_done.on_done](\n+          absl::Status status, bool sends_were_enqueued) {\n+        auto error = new PJRT_Error{status};\n+        on_done(error, sends_were_enqueued, user_arg);\n+        delete error;\n+      };\n+\n   args->buffer->buffer->CopyToRemoteDevice(descriptor_future, on_done);\n }\n "
        },
        {
            "sha": "160a5f4771498b913023c4d4924f6eb443b78ccc",
            "filename": "third_party/xla/xla/pjrt/extensions/cross_host_transfers/pjrt_c_api_cross_host_transfers_extension.h",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fextensions%2Fcross_host_transfers%2Fpjrt_c_api_cross_host_transfers_extension.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d91e832a7bba0d34641ffc88e827c28d7a2e9fdf/third_party%2Fxla%2Fxla%2Fpjrt%2Fextensions%2Fcross_host_transfers%2Fpjrt_c_api_cross_host_transfers_extension.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fextensions%2Fcross_host_transfers%2Fpjrt_c_api_cross_host_transfers_extension.h?ref=d91e832a7bba0d34641ffc88e827c28d7a2e9fdf",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n \n #include \"xla/pjrt/c/pjrt_c_api.h\"\n #include \"xla/pjrt/pjrt_client.h\"\n+#include \"xla/pjrt/pjrt_common.h\"\n \n #ifdef __cplusplus\n extern \"C\" {\n@@ -34,7 +35,7 @@ extern \"C\" {\n // CrossHostSendBuffers and CrossHostReceiveBuffers. These methods allow PjRt\n // clients to implement various optimizations for cross-host transfers.\n \n-#define PJRT_API_CROSS_HOST_TRANSFERS_EXTENSION_VERSION 2\n+#define PJRT_API_CROSS_HOST_TRANSFERS_EXTENSION_VERSION 3\n \n // ---------------------------------- Methods ----------------------------------\n \n@@ -112,15 +113,26 @@ PJRT_DEFINE_STRUCT_TRAITS(\n typedef PJRT_Error* PJRT_Transfers_PJRT_Client_MakeCrossHostReceiveBuffers(\n     PJRT_Transfers_PJRT_Client_MakeCrossHostReceiveBuffers_Args* args);\n \n+typedef void (*PJRT_Transfers_CrossHostRemoteSendCallback)(\n+    PJRT_Error* error, bool sends_were_enqueued, void* user_arg);\n+\n+struct PJRT_Transfers_CrossHostRemoteSendCallbackInfo {\n+  void* user_arg;\n+  PJRT_Transfers_CrossHostRemoteSendCallback on_done;\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Transfers_CrossHostRemoteSendCallbackInfo,\n+                          on_done);\n+\n struct PJRT_Transfers_PJRT_Buffer_CopyToRemoteDevice_Args {\n   size_t struct_size;\n   PJRT_Extension_Base* extension_start;\n   PJRT_Buffer* buffer;\n   const char* serialized_descriptor;\n   size_t serialized_descriptor_size;\n+  PJRT_Transfers_CrossHostRemoteSendCallbackInfo on_done;\n };\n PJRT_DEFINE_STRUCT_TRAITS(PJRT_Transfers_PJRT_Buffer_CopyToRemoteDevice_Args,\n-                          serialized_descriptor_size);\n+                          on_done);\n \n typedef void PJRT_Buffer_CopyToRemoteDevice(\n     PJRT_Transfers_PJRT_Buffer_CopyToRemoteDevice_Args* args);\n@@ -153,6 +165,9 @@ PJRT_CrossHostTransfers_Extension CreateCrossHostTransfersExtension(\n     PJRT_Extension_Base* next = nullptr);\n PJRT_Transfers_CrossHostRecvNotifierInfo CppCrossHostRecvNotifierToC(\n     const PJRT_Api* c_api, xla::PjRtCrossHostRecvNotifier cpp_notifier);\n+PJRT_Transfers_CrossHostRemoteSendCallbackInfo\n+CppCrossHostRemoteSendCallbackToC(\n+    const PJRT_Api* c_api, xla::PjRtBuffer::RemoteSendCallback cpp_callback);\n }  // namespace pjrt\n \n #endif  // XLA_PJRT_EXTENSIONS_CROSS_HOST_TRANSFERS_PJRT_C_API_CROSS_HOST_TRANSFERS_EXTENSION_H_"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 54,
        "deletions": 10
    }
}