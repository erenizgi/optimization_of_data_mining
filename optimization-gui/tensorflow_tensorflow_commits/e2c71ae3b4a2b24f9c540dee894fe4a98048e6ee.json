{
    "author": "hyeontaek",
    "message": "[IFRT] Handle `nullptr` to `UserContextRegistry::Register()` gracefully\n\n`UserContextRegistry::Register()` now returns a `nullptr` if the argument was\n`nullptr`. This makes it slightly more convenient to use the method because the\n`UserContextRef` argument is commonly `nullptr` and the callsites would have\nhad to check it if `Register()` does not handle it.\n\nNullability annotations have also added to user context class methods.\n\nPiperOrigin-RevId: 806520171",
    "sha": "e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
    "files": [
        {
            "sha": "3df913d816c92547f2e5455ce6cee03767d6924b",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
            "patch": "@@ -1112,6 +1112,7 @@ cc_library(\n         \"//xla/tsl/lib/gtl:int_type\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/base:nullability\",\n         \"@com_google_absl//absl/log:check\",\n         \"@llvm-project//llvm:Support\",\n     ],\n@@ -1142,6 +1143,7 @@ cc_library(\n         \":user_context\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/base:nullability\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/synchronization\",\n     ],"
        },
        {
            "sha": "180824b080dacbae887f9b6356bf53214455425f",
            "filename": "third_party/xla/xla/python/ifrt/user_context.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.cc?ref=e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n \n #include \"absl/base/attributes.h\"\n #include \"absl/base/no_destructor.h\"\n+#include \"absl/base/nullability.h\"\n #include \"absl/log/check.h\"\n \n namespace xla {\n@@ -30,11 +31,12 @@ namespace {\n \n const auto kNullContext = absl::NoDestructor<UserContextRef>(UserContextRef());\n \n-ABSL_CONST_INIT thread_local const UserContextRef* current_context = nullptr;\n+ABSL_CONST_INIT thread_local\n+    absl_nullable const UserContextRef* current_context = nullptr;\n \n }  // namespace\n \n-UserContextScope::UserContextScope(UserContextRef context)\n+UserContextScope::UserContextScope(absl_nullable UserContextRef context)\n     : outer_context_(current_context), context_(std::move(context)) {\n   current_context = &context_;\n }\n@@ -44,7 +46,7 @@ UserContextScope::~UserContextScope() {\n   current_context = outer_context_;\n }\n \n-const UserContextRef& UserContextScope::current() {\n+absl_nullable const UserContextRef& UserContextScope::current() {\n   if (current_context == nullptr) {\n     return *kNullContext;\n   }"
        },
        {
            "sha": "5f614bf5a70cb934106489b5b202f948b14e1313",
            "filename": "third_party/xla/xla/python/ifrt/user_context.h",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h?ref=e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <cstdint>\n #include <string>\n \n+#include \"absl/base/nullability.h\"\n #include \"llvm/Support/ExtensibleRTTI.h\"\n #include \"xla/tsl/concurrency/ref_count.h\"\n #include \"xla/tsl/lib/gtl/int_type.h\"\n@@ -81,7 +82,7 @@ class UserContextScope {\n  public:\n   // Sets up the current thread's `UserContextRef` to the given `context`.\n   // `context` must be valid throughout the lifetime of the scope.\n-  explicit UserContextScope(UserContextRef context);\n+  explicit UserContextScope(absl_nullable UserContextRef context);\n \n   // Restores the current thread's `UserContextRef` to the state before this\n   // scope was created.\n@@ -100,14 +101,14 @@ class UserContextScope {\n   // `UserContextRef`.\n   //\n   // Returns `nullptr` if there is no `UserContextRef` in the scope.\n-  static const UserContextRef& current();\n+  static absl_nullable const UserContextRef& current();\n \n  private:\n   // The outer scope's `UserContext`. When this scope is destroyed, the current\n   // scope's `UserContext` will be restored to it.\n-  const UserContextRef* const outer_context_;  // Not owned.\n+  absl_nullable const UserContextRef* const outer_context_;  // Not owned.\n   // The current scope's `UserContext`.\n-  const UserContextRef context_;\n+  absl_nullable const UserContextRef context_;\n };\n \n }  // namespace ifrt"
        },
        {
            "sha": "8a5d8ae5f021fd7db1b87de13e76d587f5de68e0",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc?ref=e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/base/no_destructor.h\"\n+#include \"absl/base/nullability.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"xla/python/ifrt/user_context.h\"\n \n@@ -31,8 +32,11 @@ UserContextRegistry& UserContextRegistry::Get() {\n   return *registry;\n }\n \n-TrackedUserContextRef UserContextRegistry::Register(\n-    UserContextRef user_context) {\n+absl_nullable TrackedUserContextRef\n+UserContextRegistry::Register(absl_nullable UserContextRef user_context) {\n+  if (user_context == nullptr) {\n+    return nullptr;\n+  }\n   const UserContextId id = user_context->Id();\n   absl::MutexLock lock(&mu_);\n   auto it = registry_.find(id);\n@@ -57,7 +61,8 @@ TrackedUserContextRef UserContextRegistry::Register(\n   return tracked_user_context;\n }\n \n-TrackedUserContextRef UserContextRegistry::Lookup(UserContextId id) const {\n+absl_nullable TrackedUserContextRef\n+UserContextRegistry::Lookup(UserContextId id) const {\n   absl::MutexLock lock(&mu_);\n   auto it = registry_.find(id);\n   if (it != registry_.end()) {\n@@ -69,9 +74,10 @@ TrackedUserContextRef UserContextRegistry::Lookup(UserContextId id) const {\n   return nullptr;\n }\n \n-std::vector<TrackedUserContextRef> UserContextRegistry::LookupAll() const {\n+std::vector<absl_nonnull TrackedUserContextRef> UserContextRegistry::LookupAll()\n+    const {\n   absl::MutexLock lock(&mu_);\n-  std::vector<TrackedUserContextRef> tracked_user_contexts;\n+  std::vector<absl_nonnull TrackedUserContextRef> tracked_user_contexts;\n   tracked_user_contexts.reserve(registry_.size());\n   for (auto it = registry_.begin(); it != registry_.end(); ++it) {\n     TrackedUserContextRef tracked_user_context = it->second.first.lock();"
        },
        {
            "sha": "00c6844c279f5cb81360020b185fa64a9f873fcd",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry.h",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h?ref=e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"absl/base/nullability.h\"\n #include \"absl/base/thread_annotations.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/synchronization/mutex.h\"\n@@ -65,16 +66,17 @@ class UserContextRegistry {\n \n   // Ensures that `user_context` is registered in the registry (if not) and\n   // returns `TrackedUserContextRef` for `user_context`.\n-  TrackedUserContextRef Register(UserContextRef user_context);\n+  absl_nullable TrackedUserContextRef\n+  Register(absl_nullable UserContextRef user_context);\n \n   // Returns `TrackedUserContextRef` for `id`.\n   // If no such `id` is found, returns `nullptr`.\n-  TrackedUserContextRef Lookup(UserContextId id) const;\n+  absl_nullable TrackedUserContextRef Lookup(UserContextId id) const;\n \n   // Returns all `TrackedUserContextRef`s in the registry. Note that since the\n   // registry is process-wide, the result will contain `TrackedUserContextRef`s\n   // seen from all local IFRT client instances.\n-  std::vector<TrackedUserContextRef> LookupAll() const;\n+  std::vector<absl_nonnull TrackedUserContextRef> LookupAll() const;\n \n  private:\n   friend TrackedUserContext;\n@@ -106,16 +108,19 @@ class TrackedUserContext {\n \n   ~TrackedUserContext() { UserContextRegistry::Get().Unregister(id_, this); }\n \n-  const UserContextRef& user_context() const { return user_context_; }\n+  absl_nonnull const UserContextRef& user_context() const {\n+    return user_context_;\n+  }\n \n  private:\n   friend UserContextRegistry;\n \n-  explicit TrackedUserContext(UserContextId id, UserContextRef user_context)\n+  explicit TrackedUserContext(UserContextId id,\n+                              absl_nonnull UserContextRef user_context)\n       : id_(id), user_context_(std::move(user_context)) {}\n \n   const UserContextId id_;\n-  const UserContextRef user_context_;\n+  absl_nonnull const UserContextRef user_context_;\n };\n \n }  // namespace ifrt"
        },
        {
            "sha": "46eb0b73dd567561b7aeb5b6726b450287b27e5e",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry_test.cc?ref=e2c71ae3b4a2b24f9c540dee894fe4a98048e6ee",
            "patch": "@@ -56,7 +56,13 @@ class TestUserContext : public llvm::RTTIExtends<TestUserContext, UserContext> {\n   const UserContextId id_;\n };\n \n-TEST(UserContextRegistryTest, GetAndLookup) {\n+TEST(UserContextRegistryTest, NullptrUserContext) {\n+  TrackedUserContextRef tracked_user_context =\n+      UserContextRegistry::Get().Register(UserContextRef());\n+  EXPECT_EQ(tracked_user_context, nullptr);\n+}\n+\n+TEST(UserContextRegistryTest, RegisterAndLookup) {\n   const UserContextId kUserContextId1(100);\n   UserContextRef user_context1 = TestUserContext::Create(kUserContextId1);\n   TrackedUserContextRef tracked_user_context1 ="
        }
    ],
    "stats": {
        "total": 60,
        "additions": 41,
        "deletions": 19
    }
}