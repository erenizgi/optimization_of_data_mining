{
    "author": "WillFroom",
    "message": "Fold no-op reshape when converting to linalg.\n\nPrior to this change we would hit an assert when constructing the tensor::CollapseShapeOp in the 0D->0D case.\n\nPiperOrigin-RevId: 837419131",
    "sha": "193a25319ed5fe2ac998da3be12be4b59842e739",
    "files": [
        {
            "sha": "dddb6e502042fc682a9583cca6fdb274850e957e",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/193a25319ed5fe2ac998da3be12be4b59842e739/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/193a25319ed5fe2ac998da3be12be4b59842e739/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=193a25319ed5fe2ac998da3be12be4b59842e739",
            "patch": "@@ -1,3 +1,38 @@\n+diff --ruN a/stablehlo/stablehlo/conversions/linalg/tests/miscellaneous.mlir b/stablehlo/stablehlo/conversions/linalg/tests/miscellaneous.mlir\n+--- stablehlo/stablehlo/conversions/linalg/tests/miscellaneous.mlir\n++++ stablehlo/stablehlo/conversions/linalg/tests/miscellaneous.mlir\n+@@ -913,6 +913,15 @@\n+ \n+ // -----\n+ \n++// CHECK-LABEL: func @reshape_0D_0D\n++func.func @reshape_0D_0D(%arg0: tensor<i32>) ->tensor<i32> {\n++  %0 = \"stablehlo.reshape\"(%arg0) : (tensor<i32>) -> tensor<i32>\n++  func.return %0 : tensor<i32>\n++}\n++// CHECK: return %arg0 : tensor<i32>\n++\n++// -----\n++\n+ // CHECK-LABEL: func @reshape_0D_1D_unsigned\n+ // CHECK-SAME:    %[[ARG_UNSIGNED:[a-zA-Z0-9_]*]]\n+ func.func @reshape_0D_1D_unsigned(%arg0: tensor<ui32>) -> tensor<1xui32> {\n+diff --ruN a/stablehlo/stablehlo/conversions/linalg/transforms/StablehloLegalizeToLinalg.cpp b/stablehlo/stablehlo/conversions/linalg/transforms/StablehloLegalizeToLinalg.cpp\n+--- stablehlo/stablehlo/conversions/linalg/transforms/StablehloLegalizeToLinalg.cpp\n++++ stablehlo/stablehlo/conversions/linalg/transforms/StablehloLegalizeToLinalg.cpp\n+@@ -1103,6 +1103,12 @@\n+ \n+     if (!resultType.hasStaticShape()) return failure();\n+ \n++    // If the reshape is a no-op simply fold it away.\n++    if (resultType == operandType) {\n++      rewriter.replaceOp(reshapeOp, operand);\n++      return success();\n++    }\n++\n+     // If any of the output dimensions is 0, the tensor has no elements. In that\n+     // case, we can just replace the reshape with an empty op.\n+     if (llvm::is_contained(resultType.getShape(), 0)) {\n diff --ruN a/stablehlo/stablehlo/dialect/StablehloOps.cpp b/stablehlo/stablehlo/dialect/StablehloOps.cpp\n --- stablehlo/stablehlo/dialect/StablehloOps.cpp\n +++ stablehlo/stablehlo/dialect/StablehloOps.cpp"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 35,
        "deletions": 0
    }
}