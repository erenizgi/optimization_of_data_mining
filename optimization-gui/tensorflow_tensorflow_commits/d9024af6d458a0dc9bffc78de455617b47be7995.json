{
    "author": "ezhulenev",
    "message": "[xla:cpu] Do not register legacy runtime symbols with XLA:CPU custom calls\n\nPiperOrigin-RevId: 826208548",
    "sha": "d9024af6d458a0dc9bffc78de455617b47be7995",
    "files": [
        {
            "sha": "1297eac7cc52e98c687ccd251b8a80560a6a917a",
            "filename": "third_party/xla/xla/service/cpu/runtime_symbol_generator.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 72,
            "changes": 73,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9024af6d458a0dc9bffc78de455617b47be7995/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_symbol_generator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9024af6d458a0dc9bffc78de455617b47be7995/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_symbol_generator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_symbol_generator.cc?ref=d9024af6d458a0dc9bffc78de455617b47be7995",
            "patch": "@@ -24,8 +24,6 @@ limitations under the License.\n #include <string>\n #include <utility>\n \n-#include \"absl/functional/any_invocable.h\"\n-#include \"absl/strings/string_view.h\"\n #include \"llvm/ADT/StringRef.h\"\n #include \"llvm/ExecutionEngine/JITSymbol.h\"\n #include \"llvm/ExecutionEngine/Orc/AbsoluteSymbols.h\"\n@@ -35,29 +33,10 @@ limitations under the License.\n #include \"llvm/ExecutionEngine/Orc/Shared/ExecutorSymbolDef.h\"\n #include \"llvm/IR/DataLayout.h\"\n #include \"llvm/Support/Error.h\"\n-#include \"mlir/ExecutionEngine/CRunnerUtils.h\"\n-#include \"xla/service/cpu/cpu_runtime.h\"\n-#include \"xla/service/cpu/runtime_conv2d.h\"\n-#include \"xla/service/cpu/runtime_conv2d_acl.h\"\n-#include \"xla/service/cpu/runtime_conv3d.h\"\n-#include \"xla/service/cpu/runtime_custom_call_status.h\"\n #include \"xla/service/cpu/runtime_fp16.h\"\n-#include \"xla/service/cpu/runtime_key_value_sort.h\"\n-#include \"xla/service/cpu/runtime_matmul.h\"\n-#include \"xla/service/cpu/runtime_matmul_acl.h\"\n #include \"xla/service/cpu/runtime_pow.h\"\n-#include \"xla/service/cpu/runtime_single_threaded_conv2d.h\"\n-#include \"xla/service/cpu/runtime_single_threaded_conv3d.h\"\n-#include \"xla/service/cpu/runtime_single_threaded_matmul.h\"\n-#include \"xla/service/cpu/runtime_topk.h\"\n-#include \"xla/service/cpu/windows_compatibility.h\"\n+#include \"xla/service/cpu/windows_compatibility.h\"  // IWYU pragma: keep\n #include \"xla/service/custom_call_target_registry.h\"\n-#include \"tsl/platform/logging.h\"\n-\n-#ifdef XLA_ONEDNN\n-#include \"xla/service/cpu/onednn_convolution.h\"\n-#include \"xla/service/cpu/onednn_matmul.h\"\n-#endif  // XLA_ONEDNN\n \n namespace xla::cpu {\n \n@@ -127,16 +106,6 @@ float __extendhfsf2(uint16_t a);\n \n }  // extern \"C\"\n \n-#define REGISTER_CPU_RUNTIME_SYMBOL(base_name)                               \\\n-  do {                                                                       \\\n-    auto* function_address =                                                 \\\n-        reinterpret_cast<void*>(__xla_cpu_runtime_##base_name);              \\\n-    registry->Register(xla::cpu::runtime::k##base_name##SymbolName,          \\\n-                       function_address, \"Host\");                            \\\n-    CHECK_EQ(absl::string_view(xla::cpu::runtime::k##base_name##SymbolName), \\\n-             \"__xla_cpu_runtime_\" #base_name);                               \\\n-  } while (false)\n-\n // Register both the f32 (float) and f64 (double) versions of a libm symbol.\n // Unfortunately the double versions are overloaded on some systems, e.g.\n // Mac so we need an explicit cast. This requires passing the function signature\n@@ -155,41 +124,6 @@ static bool RegisterKnownJITSymbols() {\n   registry->Register(\"printf\", reinterpret_cast<void*>(&printf), \"Host\");\n   registry->Register(\"puts\", reinterpret_cast<void*>(&puts), \"Host\");\n \n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenConv2DF16);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenConv2DF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenConv3DF16);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenConv3DF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenMatMulF16);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenMatMulF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenMatMulF64);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenMatMulC64);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenMatMulC128);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenMatMulS32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenBatchMatMulF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(ACLMatMulF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(ACLBatchMatMulF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(ACLConv2DF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedConv2DF16);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedConv2DF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedConv3DF16);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedConv3DF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulF8E4M3FN);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulF8E5M2);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulF16);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulF32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulF64);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulC64);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulC128);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulS32);\n-  REGISTER_CPU_RUNTIME_SYMBOL(EigenSingleThreadedMatMulU8);\n-  REGISTER_CPU_RUNTIME_SYMBOL(StatusIsSuccess);\n-  REGISTER_CPU_RUNTIME_SYMBOL(KeyValueSort);\n-  REGISTER_CPU_RUNTIME_SYMBOL(TopKF32);\n-#ifdef XLA_ONEDNN\n-  REGISTER_CPU_RUNTIME_SYMBOL(OneDnnMatMul);\n-  REGISTER_CPU_RUNTIME_SYMBOL(OneDnnMatMulReorder);\n-#endif  // XLA_ONEDNN\n-\n   registry->Register(\"__gnu_f2h_ieee\", reinterpret_cast<void*>(__gnu_f2h_ieee),\n                      \"Host\");\n   registry->Register(\"__gnu_h2f_ieee\", reinterpret_cast<void*>(__gnu_h2f_ieee),\n@@ -286,10 +220,6 @@ static bool RegisterKnownJITSymbols() {\n   registry->Register(\"malloc\", reinterpret_cast<void*>(malloc), \"Host\");\n   registry->Register(\"calloc\", reinterpret_cast<void*>(calloc), \"Host\");\n   registry->Register(\"free\", reinterpret_cast<void*>(free), \"Host\");\n-#ifndef _WIN32\n-  // TODO(b/246980307): fails to link on windows because it's marked dllimport.\n-  registry->Register(\"memrefCopy\", reinterpret_cast<void*>(memrefCopy), \"Host\");\n-#endif\n \n #ifdef __APPLE__\n   registry->Register(\"__bzero\", reinterpret_cast<void*>(bzero), \"Host\");\n@@ -310,7 +240,6 @@ static bool RegisterKnownJITSymbols() {\n   return true;\n }\n \n-#undef REGISTER_CPU_RUNTIME_SYMBOL\n #undef REGISTER_LIBM_SYMBOL\n \n static bool unused = RegisterKnownJITSymbols();"
        },
        {
            "sha": "6eaaa3b404989844f2246b08f4680205a28cf0d4",
            "filename": "third_party/xla/xla/service/cpu/small_while_loop_hoisting_pass.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d9024af6d458a0dc9bffc78de455617b47be7995/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fsmall_while_loop_hoisting_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d9024af6d458a0dc9bffc78de455617b47be7995/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fsmall_while_loop_hoisting_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fsmall_while_loop_hoisting_pass.cc?ref=d9024af6d458a0dc9bffc78de455617b47be7995",
            "patch": "@@ -47,6 +47,7 @@ static bool InstructionIsUnavailable(const HloInstruction* instr) {\n     case HloOpcode::kInfeed:\n     case HloOpcode::kOutfeed:\n     case HloOpcode::kScatter:\n+    case HloOpcode::kSort:\n     case HloOpcode::kFft:\n       return true;\n     default:"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 2,
        "deletions": 72
    }
}