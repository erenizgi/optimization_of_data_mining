{
    "author": "ezhulenev",
    "message": "[xla] Migrate to PjRtFuture<>::MakePromise() API\n\nPiperOrigin-RevId: 806070441",
    "sha": "ce019d289c8432e1ac123ba94a54a720cc6a703d",
    "files": [
        {
            "sha": "b5e4a7330e3649110696391cdd96c604a0652580",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_helpers.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ce019d289c8432e1ac123ba94a54a720cc6a703d/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_helpers.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ce019d289c8432e1ac123ba94a54a720cc6a703d/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_helpers.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_helpers.cc?ref=ce019d289c8432e1ac123ba94a54a720cc6a703d",
            "patch": "@@ -467,14 +467,15 @@ xla::PjRtFuture<> ConvertCEventToCppFuture(PJRT_Event* c_event,\n   event_onready_args.extension_start = nullptr;\n   event_onready_args.event = c_event;\n \n-  PjRtFuture<>::Promise promise = PjRtFuture<>::CreatePromise();\n+  auto [promise, future] = PjRtFuture<>::MakePromise();\n   event_onready_args.user_arg = new std::function<void(PJRT_Error*)>(\n-      [promise, c_event, c_api](PJRT_Error* error) mutable {\n+      [promise = std::make_shared<PjRtFuture<>::Promise>(std::move(promise)),\n+       c_event, c_api](PJRT_Error* error) mutable {\n         if (error != nullptr) {\n-          promise.Set(::pjrt::PjrtErrorToStatus(error, c_api));\n+          promise->Set(::pjrt::PjrtErrorToStatus(error, c_api));\n           ::pjrt::MakeErrorDeleter(c_api)(error);\n         } else {\n-          promise.Set();\n+          promise->Set();\n         }\n         ::pjrt::MakeEventDeleter(c_api)(c_event);\n       });\n@@ -489,7 +490,7 @@ xla::PjRtFuture<> ConvertCEventToCppFuture(PJRT_Event* c_event,\n   if (error != nullptr) {\n     return PjRtFuture<>(::pjrt::PjrtErrorToStatus(error, c_api));\n   }\n-  return PjRtFuture<>(std::move(promise));\n+  return std::move(future);\n }\n \n static absl::StatusOr<PJRT_NamedValue> ConvertToPjRtNamedValue("
        },
        {
            "sha": "04b424dbf51982607703ba33c241c665d305563c",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ce019d289c8432e1ac123ba94a54a720cc6a703d/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ce019d289c8432e1ac123ba94a54a720cc6a703d/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=ce019d289c8432e1ac123ba94a54a720cc6a703d",
            "patch": "@@ -692,15 +692,14 @@ PJRT_Error* PJRT_AsyncHostToDeviceTransferManager_TransferData(\n       \"PJRT_AsyncHostToDeviceTransferManager_TransferData_Args\",\n       PJRT_AsyncHostToDeviceTransferManager_TransferData_Args_STRUCT_SIZE,\n       args->struct_size));\n-  xla::PjRtFuture<>::Promise promise = xla::PjRtFuture<>::CreatePromise();\n+  auto [promise, future] = xla::PjRtFuture<>::MakePromise();\n   absl::AnyInvocable<void() &&> on_done_with_d2h_transfer =\n-      [promise]() mutable { promise.Set(); };\n+      [promise = std::move(promise)]() mutable { promise.Set(); };\n   PJRT_RETURN_IF_ERROR(\n       args->transfer_manager->transfer_manager->TransferRawDataToSubBuffer(\n           args->buffer_index, args->data, args->offset, args->transfer_size,\n           args->is_last_transfer, std::move(on_done_with_d2h_transfer)));\n-  args->done_with_h2d_transfer =\n-      new PJRT_Event{xla::PjRtFuture<>(std::move(promise))};\n+  args->done_with_h2d_transfer = new PJRT_Event{std::move(future)};\n   return nullptr;\n }\n "
        },
        {
            "sha": "4674a89c2ff069480bcd669919792be2c8776f43",
            "filename": "third_party/xla/xla/pjrt/se_raw_buffer.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ce019d289c8432e1ac123ba94a54a720cc6a703d/third_party%2Fxla%2Fxla%2Fpjrt%2Fse_raw_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ce019d289c8432e1ac123ba94a54a720cc6a703d/third_party%2Fxla%2Fxla%2Fpjrt%2Fse_raw_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fse_raw_buffer.cc?ref=ce019d289c8432e1ac123ba94a54a720cc6a703d",
            "patch": "@@ -37,20 +37,19 @@ limitations under the License.\n namespace xla {\n \n PjRtFuture<> PjRtStreamExecutorDeviceEvent::GetReadyFuture() {\n-  PjRtFuture<>::Promise promise = PjRtFuture<>::CreatePromise();\n-  event_.AndThen([promise, event = event_]() mutable {\n+  auto [promise, future] = PjRtFuture<>::MakePromise();\n+  event_.AndThen([promise = std::move(promise), event = event_]() mutable {\n     if (auto* error = event.GetErrorIfPresent()) {\n       promise.Set(*error);\n     } else {\n       promise.Set();\n     }\n   });\n \n-  return PjRtFuture<>(\n-      promise,\n+  return PjRtFutureHelpers::WithProfiling(\n+      std::move(future),\n       /*on_block_start=*/\n-      [ready_event = FormRef(promise.async_value()),\n-       callee_method = callee_method_, callee_type = callee_type_]() {\n+      [callee_method = callee_method_, callee_type = callee_type_]() {\n         tsl::profiler::TraceMeProducer traceme(\n             [&] { return absl::StrCat(callee_type, \"::\", callee_method); });\n         return PjRtFutureHelpers::ProfilingKeys({traceme.GetContextId()});"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 14,
        "deletions": 15
    }
}