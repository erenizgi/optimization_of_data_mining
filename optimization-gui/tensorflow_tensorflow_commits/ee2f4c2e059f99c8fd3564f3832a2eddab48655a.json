{
    "author": "zvikinoza",
    "message": "HloModuleSplit - convenience function to get cloned computation from the original computation\n\nPiperOrigin-RevId: 844963973",
    "sha": "ee2f4c2e059f99c8fd3564f3832a2eddab48655a",
    "files": [
        {
            "sha": "5a46cfb331364e9eeee526ec0ddee547ef689243",
            "filename": "third_party/xla/xla/hlo/separate_compilation/hlo_module_linking_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ee2f4c2e059f99c8fd3564f3832a2eddab48655a/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_linking_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ee2f4c2e059f99c8fd3564f3832a2eddab48655a/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_linking_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_linking_test.cc?ref=ee2f4c2e059f99c8fd3564f3832a2eddab48655a",
            "patch": "@@ -147,8 +147,9 @@ TEST_F(LinkingTest, SingleCallLinking) {\n   const HloLinkingManifest& linking_manifest =\n       module_split_group->linking_manifest;\n   auto* original_root = FindComputation(original_module.get(), \"main\");\n-  auto* split_group_root = module_split_group->address_book.at(original_root)\n-                               ->computation_map.at(original_root);\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      const HloComputation* split_group_root,\n+      module_split_group->GetClonedComputation(original_root));\n \n   TF_ASSERT_OK_AND_ASSIGN(auto linked_module,\n                           LinkComputation(linking_manifest, split_group_root));\n@@ -208,8 +209,9 @@ TEST_F(LinkingTest, ChainGraphLinking) {\n   const HloLinkingManifest& linking_manifest =\n       module_split_group->linking_manifest;\n   auto* original_root = FindComputation(original_module.get(), \"main\");\n-  auto* split_group_root = module_split_group->address_book.at(original_root)\n-                               ->computation_map.at(original_root);\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      const HloComputation* split_group_root,\n+      module_split_group->GetClonedComputation(original_root));\n \n   TF_ASSERT_OK_AND_ASSIGN(auto linked_module,\n                           LinkComputation(linking_manifest, split_group_root));\n@@ -280,13 +282,12 @@ TEST_F(LinkingTest, DiamondGraphLinking) {\n   const HloLinkingManifest& linking_manifest =\n       module_split_group->linking_manifest;\n   auto* original_root = FindComputation(original_module.get(), \"main\");\n-  ASSERT_TRUE(module_split_group->address_book.contains(original_root));\n-  auto* split = module_split_group->address_book.at(original_root);\n-  ASSERT_TRUE(split->computation_map.contains(original_root));\n-  auto* split_root = split->computation_map.at(original_root);\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      const HloComputation* split_group_root,\n+      module_split_group->GetClonedComputation(original_root));\n \n   TF_ASSERT_OK_AND_ASSIGN(auto linked_module,\n-                          LinkComputation(linking_manifest, split_root));\n+                          LinkComputation(linking_manifest, split_group_root));\n   HloVerifier verifier(HloVerifierOpts{});\n   TF_ASSERT_OK(verifier.Run(linked_module.get()));\n "
        },
        {
            "sha": "00a0bd2a0acefc52b96f5872c5a1fb0cc21862e4",
            "filename": "third_party/xla/xla/hlo/separate_compilation/hlo_module_splitting.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ee2f4c2e059f99c8fd3564f3832a2eddab48655a/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_splitting.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ee2f4c2e059f99c8fd3564f3832a2eddab48655a/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_splitting.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_splitting.cc?ref=ee2f4c2e059f99c8fd3564f3832a2eddab48655a",
            "patch": "@@ -332,4 +332,24 @@ absl::StatusOr<std::unique_ptr<HloModuleSplitGroup>> CreateHloModuleSplitGroup(\n       std::move(linking_manifest));\n }\n \n+absl::StatusOr<const HloComputation*> HloModuleSplitGroup::GetClonedComputation(\n+    const HloComputation* original_computation) const {\n+  auto it = address_book.find(original_computation);\n+  if (it == address_book.end()) {\n+    return absl::NotFoundError(\n+        absl::StrCat(\"Original computation '\", original_computation->name(),\n+                     \"' not found in HloModuleSplitGroup address book.\"));\n+  }\n+  auto& computation_map = it->second->computation_map;\n+  auto it2 = computation_map.find(original_computation);\n+  if (it2 == computation_map.end()) {\n+    return absl::InternalError(absl::StrCat(\n+        \"Original computation '\", original_computation->name(),\n+        \"' found in address book but not in computation map for its \"\n+        \"module split '\",\n+        it->second->submodule->name(), \"'.\"));\n+  }\n+  return it2->second;\n+}\n+\n }  // namespace xla::separate_compilation"
        },
        {
            "sha": "97a0031035511cb0c39bed217044c3d319b27f7f",
            "filename": "third_party/xla/xla/hlo/separate_compilation/hlo_module_splitting.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ee2f4c2e059f99c8fd3564f3832a2eddab48655a/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_splitting.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ee2f4c2e059f99c8fd3564f3832a2eddab48655a/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_splitting.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fseparate_compilation%2Fhlo_module_splitting.h?ref=ee2f4c2e059f99c8fd3564f3832a2eddab48655a",
            "patch": "@@ -94,6 +94,11 @@ struct HloModuleSplitGroup {\n       : address_book(std::move(address_book)),\n         module_splits(std::move(module_splits)),\n         linking_manifest(std::move(linking_manifest)) {}\n+\n+  // Returns the cloned version of the given original computation, or\n+  // an error if the computation is not part of this split group.\n+  absl::StatusOr<const HloComputation*> GetClonedComputation(\n+      const HloComputation* original_computation) const;\n };\n \n // Split the given module. Returns a mapping from `HloComputation*` to"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 35,
        "deletions": 9
    }
}