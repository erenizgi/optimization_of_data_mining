{
    "author": "Tongfei-Guo",
    "message": "[XLA:DEBUG] Add checking for illegal scheduling annotation from users such that it has a non-mitigatable gap which cannot be solved by annotation propagation.\n\nPiperOrigin-RevId: 810932204",
    "sha": "8f8b64ec4e554e8953eeda270e772f3a66fca1b6",
    "files": [
        {
            "sha": "9a178b837bf10560f335c2f2aac8e949dac345c7",
            "filename": "third_party/xla/xla/service/legalize_scheduling_annotations.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f8b64ec4e554e8953eeda270e772f3a66fca1b6/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f8b64ec4e554e8953eeda270e772f3a66fca1b6/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.cc?ref=8f8b64ec4e554e8953eeda270e772f3a66fca1b6",
            "patch": "@@ -103,7 +103,8 @@ absl::flat_hash_set<HloInstruction*> PropagateAnnotationFromSources(\n // the instructions already has an annotation.\n absl::Status AttachAnnotation(\n     Annotation annotation,\n-    const absl::flat_hash_set<HloInstruction*>& instructions) {\n+    const absl::flat_hash_set<HloInstruction*>& instructions,\n+    bool dry_run = false) {\n   for (HloInstruction* instr : instructions) {\n     TF_ASSIGN_OR_RETURN(std::optional<Annotation> instr_annotation,\n                         GetSchedulingAnnotation(instr));\n@@ -116,7 +117,9 @@ absl::Status AttachAnnotation(\n     }\n     LOG(INFO) << \"Propagating annotation \" << annotation.ToString() << \" to \"\n               << instr->name();\n-    TF_RETURN_IF_ERROR(SetSchedulingAnnotation(instr, annotation));\n+    if (!dry_run) {\n+      TF_RETURN_IF_ERROR(SetSchedulingAnnotation(instr, annotation));\n+    }\n   }\n   return absl::OkStatus();\n }\n@@ -332,13 +335,14 @@ absl::StatusOr<bool> RemoveLoopIterationAnnotation(HloModule* module) {\n absl::StatusOr<bool> LegalizeSchedulingAnnotations::PropagateAnnotations(\n     const HloComputation* computation,\n     const absl::btree_map<Annotation, std::vector<HloInstruction*>>&\n-        annotation_to_instruction) {\n+        annotation_to_instruction,\n+    bool dry_run) {\n   bool changed = false;\n   for (auto& [annotation, sources] : annotation_to_instruction) {\n     absl::flat_hash_set<HloInstruction*> to_annotate =\n         PropagateAnnotationFromSources(sources, computation);\n     changed |= (!to_annotate.empty());\n-    auto status = AttachAnnotation(annotation, to_annotate);\n+    auto status = AttachAnnotation(annotation, to_annotate, dry_run);\n     if (!status.ok()) {\n       return status;\n     }\n@@ -570,7 +574,8 @@ absl::StatusOr<bool> LegalizeSchedulingAnnotations::Run(\n         continue;\n       }\n       auto result = PropagateAnnotations(\n-          computation, per_computation_annotation_to_instruction);\n+          computation, per_computation_annotation_to_instruction,\n+          /*dry_run=*/config_.check_non_mitigatable_gap_only);\n       if (!result.ok()) {\n         return result.status();\n       }"
        },
        {
            "sha": "df50da7f5556743c719845e02eba5eff5d731ff9",
            "filename": "third_party/xla/xla/service/legalize_scheduling_annotations.h",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f8b64ec4e554e8953eeda270e772f3a66fca1b6/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f8b64ec4e554e8953eeda270e772f3a66fca1b6/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flegalize_scheduling_annotations.h?ref=8f8b64ec4e554e8953eeda270e772f3a66fca1b6",
            "patch": "@@ -46,6 +46,7 @@ class LegalizeSchedulingAnnotations : public HloModulePass {\n     bool keep_start_annotation = true;\n     bool deannotate_unsupported_groups = false;\n     bool check_gap_only = false;\n+    bool check_non_mitigatable_gap_only = false;\n   };\n \n   explicit LegalizeSchedulingAnnotations(Config config)\n@@ -54,10 +55,14 @@ class LegalizeSchedulingAnnotations : public HloModulePass {\n     return \"legalize-scheduling-annotations\";\n   }\n \n+  // Propagates the annotation to fill the gaps between instructions with the\n+  // same annotation ID. If dry_run is true, it will only check if the\n+  // propagation is possible without actually annotating the instructions.\n   static absl::StatusOr<bool> PropagateAnnotations(\n       const HloComputation* computation,\n       const absl::btree_map<Annotation, std::vector<HloInstruction*>>&\n-          annotation_to_instruction);\n+          annotation_to_instruction,\n+      bool dry_run = false);\n \n   static absl::Status Verify(HloModule* module);\n "
        }
    ],
    "stats": {
        "total": 22,
        "additions": 16,
        "deletions": 6
    }
}