{
    "author": "fengwuyao",
    "message": "Update to use half data type within the runtime.\n\nPiperOrigin-RevId: 839960908",
    "sha": "ca77fbdd97841de06f14d5e96bacf15adb5d3fb1",
    "files": [
        {
            "sha": "8ff93f60b1472c85c7bf43971abf065bc0aabcd2",
            "filename": "tensorflow/lite/tools/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca77fbdd97841de06f14d5e96bacf15adb5d3fb1/tensorflow%2Flite%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca77fbdd97841de06f14d5e96bacf15adb5d3fb1/tensorflow%2Flite%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Ftools%2FBUILD?ref=ca77fbdd97841de06f14d5e96bacf15adb5d3fb1",
            "patch": "@@ -398,6 +398,7 @@ cc_library(\n         \"//tensorflow/lite/c:common\",\n         \"//tensorflow/lite/core/c:common\",\n         \"//tensorflow/lite/kernels:kernel_util\",\n+        \"//tensorflow/lite/types:half\",\n         \"@com_google_absl//absl/types:span\",\n         \"@eigen_archive//:eigen3\",\n     ],\n@@ -410,6 +411,7 @@ cc_test(\n     deps = [\n         \":utils\",\n         \"//tensorflow/lite/c:common\",\n+        \"//tensorflow/lite/types:half\",\n         \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest_main\",\n     ],"
        },
        {
            "sha": "6173ec1b112203556f8df2077b6313d59df55cbe",
            "filename": "tensorflow/lite/tools/utils.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 19,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca77fbdd97841de06f14d5e96bacf15adb5d3fb1/tensorflow%2Flite%2Ftools%2Futils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca77fbdd97841de06f14d5e96bacf15adb5d3fb1/tensorflow%2Flite%2Ftools%2Futils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Ftools%2Futils.cc?ref=ca77fbdd97841de06f14d5e96bacf15adb5d3fb1",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include \"tensorflow/lite/c/common.h\"\n #include \"tensorflow/lite/kernels/kernel_util.h\"\n #include \"tensorflow/lite/tools/logging.h\"\n+#include \"tensorflow/lite/types/half.h\"\n \n namespace tflite {\n namespace utils {\n@@ -107,26 +108,8 @@ InputTensorData CreateRandomTensorData(std::string name, TfLiteType type,\n           std::uniform_real_distribution<float>(low_range, high_range));\n     }\n     case kTfLiteFloat16: {\n-      // TODO(b/138843274): Remove this preprocessor guard when bug is fixed.\n-#if TFLITE_ENABLE_FP16_CPU_BENCHMARKS\n-#if __GNUC__ && \\\n-    (__clang__ || __ARM_FP16_FORMAT_IEEE || __ARM_FP16_FORMAT_ALTERNATIVE)\n-      // __fp16 is available on Clang or when __ARM_FP16_FORMAT_* is defined.\n-      return CreateInputTensorData<__fp16>(\n+      return CreateInputTensorData<half>(\n           num_elements, std::uniform_real_distribution<float>(-0.5f, 0.5f));\n-#else\n-      TFLITE_LOG(FATAL) << \"Don't know how to populate tensor \" << t->name\n-                        << \" of type FLOAT16 on this platform.\";\n-#endif\n-#else\n-      // You need to build with -DTFLITE_ENABLE_FP16_CPU_BENCHMARKS=1 using a\n-      // compiler that supports __fp16 type. Note: when using Clang and *not*\n-      // linking with compiler-rt, a definition of __gnu_h2f_ieee and\n-      // __gnu_f2h_ieee must be supplied.\n-      TFLITE_LOG(FATAL) << \"Populating the tensor \" << name\n-                        << \" of type FLOAT16 is disabled.\";\n-#endif  // TFLITE_ENABLE_FP16_CPU_BENCHMARKS\n-      break;\n     }\n     case kTfLiteFloat64: {\n       return CreateInputTensorData<double>(\n@@ -219,6 +202,8 @@ TfLiteStatus TfLiteTensorToFloat32Array(const TfLiteTensor& tensor,\n       return ConvertToArray<float, float>(tensor, values);\n     case kTfLiteFloat64:\n       return ConvertToArray<double, float>(tensor, values);\n+    case kTfLiteFloat16:\n+      return ConvertToArray<half, float>(tensor, values);\n     default:\n       return kTfLiteError;\n   }"
        },
        {
            "sha": "be1893ae703fe2a48d88c23edf612281e5f8d312",
            "filename": "tensorflow/lite/tools/utils_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca77fbdd97841de06f14d5e96bacf15adb5d3fb1/tensorflow%2Flite%2Ftools%2Futils_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca77fbdd97841de06f14d5e96bacf15adb5d3fb1/tensorflow%2Flite%2Ftools%2Futils_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Ftools%2Futils_test.cc?ref=ca77fbdd97841de06f14d5e96bacf15adb5d3fb1",
            "patch": "@@ -24,10 +24,13 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"absl/types/span.h\"\n #include \"tensorflow/lite/c/common.h\"\n+#include \"tensorflow/lite/types/half.h\"\n \n namespace tflite::tools {\n namespace {\n+using ::testing::ElementsAre;\n using ::testing::FloatEq;\n+using ::testing::SizeIs;\n \n // Helper function to test TfLiteTensorToFloat32Array.\n template <typename T>\n@@ -77,6 +80,30 @@ TEST(Utils, TfLiteTensorToFloat32Array) {\n   TestTfLiteTensorToFloat32Array<double>(kTfLiteFloat64);\n }\n \n+// Tests TfLiteTensorToFloat32Array for kTfLiteFloat16.\n+TEST(Utils, TfLiteTensorToFloat32ArrayFp16) {\n+  half data[] = {\n+      half(1.0f),\n+      half(2.0f),\n+      half(3.0f),\n+      half(4.0f),\n+  };\n+  TfLiteTensor tensor;\n+  tensor.data.data = data;\n+  tensor.type = kTfLiteFloat16;\n+  // Create an int array with 1 dimension and the array size is 4.\n+  tensor.dims = TfLiteIntArrayCreate(1);\n+  tensor.dims->data[0] = 4;\n+  std::vector<float> result(4, 0.0);\n+  const TfLiteStatus status =\n+      utils::TfLiteTensorToFloat32Array(tensor, absl::MakeSpan(result));\n+  TfLiteIntArrayFree(tensor.dims);\n+  ASSERT_EQ(status, kTfLiteOk);\n+  ASSERT_THAT(result, SizeIs(4));\n+  EXPECT_THAT(result, ElementsAre(FloatEq(1.0f), FloatEq(2.0f), FloatEq(3.0f),\n+                                  FloatEq(4.0f)));\n+}\n+\n TEST(Utils, TfLiteTensorToInt64Array) {\n   TestTfLiteTensorToInt64Array<int8_t>(kTfLiteInt8);\n   TestTfLiteTensorToInt64Array<uint8_t>(kTfLiteUInt8);"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 33,
        "deletions": 19
    }
}