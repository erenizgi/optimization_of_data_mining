{
    "author": "tensorflower-gardener",
    "message": "#HLODiff Render HloComputations with HTML spans with a hover effect around each instruction.\n\nPiperOrigin-RevId: 797445693",
    "sha": "c719e56f80a047c078eb46516beb083176b01c6f",
    "files": [
        {
            "sha": "8b332a281a13ff21aef21580c6bc11ac2b7faeb1",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c719e56f80a047c078eb46516beb083176b01c6f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c719e56f80a047c078eb46516beb083176b01c6f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD?ref=c719e56f80a047c078eb46516beb083176b01c6f",
            "patch": "@@ -67,6 +67,8 @@ cc_library(\n         \":graph_url_generator\",\n         \":hlo_gumgraph_renderer_util\",\n         \":op_metric_getter\",\n+        \"//xla:printer\",\n+        \"//xla:shape_util\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/tools/hlo_diff:hlo_diff_result\",\n         \"//xla/hlo/tools/hlo_diff:hlo_diff_summary\","
        },
        {
            "sha": "7efe3f05291d135ce7ee1bb13af88efa3bda07d1",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 76,
            "deletions": 2,
            "changes": 78,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c719e56f80a047c078eb46516beb083176b01c6f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c719e56f80a047c078eb46516beb083176b01c6f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=c719e56f80a047c078eb46516beb083176b01c6f",
            "patch": "@@ -35,11 +35,14 @@\n #include \"absl/types/span.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/hlo/ir/hlo_print_options.h\"\n #include \"xla/hlo/tools/hlo_diff/hlo_diff_result.h\"\n #include \"xla/hlo/tools/hlo_diff/hlo_diff_summary.h\"\n #include \"xla/hlo/tools/hlo_diff/render/graph_url_generator.h\"\n #include \"xla/hlo/tools/hlo_diff/render/hlo_gumgraph_renderer_util.h\"\n #include \"xla/hlo/tools/hlo_diff/render/op_metric_getter.h\"\n+#include \"xla/printer.h\"\n+#include \"xla/shape_util.h\"\n #include \"tsl/platform/fingerprint.h\"\n \n namespace xla {\n@@ -208,6 +211,11 @@ std::string PrintCss() {\n     span.grey {\n       color: #999999;\n     }\n+\n+    span.hlo-instruction:hover {\n+      border: 1px solid #4285F4;\n+    }\n+\n     </style>\n   )html\";\n }\n@@ -361,18 +369,84 @@ std::string PrintTextbox(absl::string_view title, absl::string_view content,\n \n /*** Summary logic ***/\n \n+// Generates HTML for a single HloComputation with diff highlights.\n+std::string PrintHloComputationToHtml(const HloComputation* comp) {\n+  if (comp == nullptr) {\n+    return \"\";\n+  }\n+  StringPrinter printer;\n+\n+  // Mimic HloComputation::Print structure with default options.\n+  printer.Append(\"%\");\n+  printer.Append(comp->name());\n+  printer.Append(\" \");\n+  ShapeUtil::PrintHumanString(&printer,\n+                              comp->ComputeProgramShape(/*include_ids=*/true));\n+  printer.Append(\" \");\n+  printer.Append(\"{\\n\");\n+\n+  // Print instructions in this computation.\n+  {\n+    // Options for printing individual instructions.\n+    // Default indent_amount + 1 = 1. is_in_nested_computation = true.\n+    HloPrintOptions instruction_print_options = HloPrintOptions::Default();\n+    instruction_print_options.set_indent_amount(1);\n+    instruction_print_options.set_is_in_nested_computation(true);\n+\n+    CanonicalNameMap name_map;\n+    name_map.Reserve(comp->instruction_count());\n+\n+    // Iterate through instructions in the default order: post-order.\n+    std::vector<HloInstruction*> instruction_order =\n+        comp->MakeInstructionPostOrder();\n+    for (const HloInstruction* instruction : instruction_order) {\n+      DCHECK_EQ(comp, instruction->parent());\n+      printer.Append(\"  \");  // Instruction indentation (2 spaces)\n+\n+      printer.Append(\"<span class=\\\"hlo-instruction\\\">\");\n+\n+      if (instruction == comp->root_instruction()) {\n+        printer.Append(\"ROOT \");\n+      }\n+      instruction->PrintWithCanonicalNameMap(\n+          &printer, instruction_print_options, &name_map);\n+      printer.Append(\"</span>\\n\");\n+    }\n+  }\n+\n+  printer.Append(\"}\");  // Closing brace for computation.\n+\n+  // Default print_ids is true, so execution thread is printed if not main.\n+  if (!comp->IsMainThread()) {\n+    printer.Append(\", execution_thread=\\\"\");\n+    printer.Append(comp->execution_thread());\n+    printer.Append(\"\\\"\");\n+  }\n+\n+  return std::move(printer).ToString();\n+}\n+\n // Prints a pair of instructions or computations in a text box.\n template <typename T>\n std::string PrintHloTextboxPair(const T* left_node, const T* right_node) {\n   std::string left_title = \"None\", right_title = \"None\", left_text, right_text;\n   if (left_node != nullptr) {\n     left_title = left_node->name();\n-    left_text = left_node->ToString();\n+    if constexpr (std::is_same_v<T, HloComputation>) {\n+      left_text = PrintHloComputationToHtml(left_node);\n+    } else {\n+      left_text = left_node->ToString();\n+    }\n   }\n   if (right_node != nullptr) {\n     right_title = right_node->name();\n-    right_text = right_node->ToString();\n+    if constexpr (std::is_same_v<T, HloComputation>) {\n+      right_text = PrintHloComputationToHtml(right_node);\n+    } else {\n+      right_text = right_node->ToString();\n+    }\n   }\n+\n   uint64_t fingerprint =\n       tsl::Fingerprint64(absl::StrCat(left_text, right_text));\n   return PrintDiv("
        }
    ],
    "stats": {
        "total": 80,
        "additions": 78,
        "deletions": 2
    }
}