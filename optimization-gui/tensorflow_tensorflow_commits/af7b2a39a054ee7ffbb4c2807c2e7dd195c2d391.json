{
    "author": "khasanovaa",
    "message": "[XLA:GPU] Override `ToString` method for Conditional Thunk.\n\nThis is used in thunk sequences dumps and allows us to see the inner thunks of conditional thunks.\n\nConditional thunk has a boolean and a multiple branches mode. For the boolean case, I dump the annotation of (if the branch is `true` or `false`) along with the thunk sequence.\n\nPiperOrigin-RevId: 810838982",
    "sha": "af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391",
    "files": [
        {
            "sha": "ff4977dae3f3af52775c74542fb65b7f8a25cc9c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391",
            "patch": "@@ -457,8 +457,10 @@ cc_library(\n         \"@com_google_absl//absl/functional:function_ref\",\n         \"@com_google_absl//absl/functional:overload\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\","
        },
        {
            "sha": "0ba2caba082a2b6b835cfa954cfa4e59c559f85c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.cc?ref=af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391",
            "patch": "@@ -15,16 +15,20 @@ limitations under the License.\n \n #include \"xla/backends/gpu/runtime/conditional_thunk.h\"\n \n+#include <cstddef>\n #include <cstdint>\n #include <memory>\n+#include <string>\n #include <utility>\n #include <variant>\n #include <vector>\n \n #include \"absl/functional/function_ref.h\"\n #include \"absl/functional/overload.h\"\n+#include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n@@ -194,5 +198,24 @@ absl::StatusOr<std::unique_ptr<ConditionalThunk>> ConditionalThunk::FromProto(\n       std::move(branch_thunks), thunk_proto.branch_index_is_bool());\n }\n \n+std::string ConditionalThunk::ToString(int indent) const {\n+  std::string indent_str(indent * 2, ' ');\n+  std::string result;\n+  absl::StrAppend(&result, indent_str, \"\\n\");\n+  if (branch_index_is_bool_) {\n+    CHECK_EQ(branch_thunks_.size(), 2);\n+    absl::StrAppend(&result, indent_str, \"false_branch:\\n\",\n+                    branch_thunks_[0]->ToString(indent + 1));\n+    absl::StrAppend(&result, indent_str, \"true_branch:\\n\",\n+                    branch_thunks_[1]->ToString(indent + 1));\n+  } else {\n+    for (size_t i = 0; i < branch_thunks_.size(); ++i) {\n+      absl::StrAppend(&result, indent_str, \"branch_\", i, \":\\n\",\n+                      branch_thunks_[i]->ToString(indent + 1));\n+    }\n+  }\n+  return result;\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "deb51926f23c365c6698edc6fc7b463b5ecab9bb",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk.h?ref=af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391",
            "patch": "@@ -89,6 +89,8 @@ class ConditionalThunk : public Thunk {\n       absl::Span<const BufferAllocation> buffer_allocations,\n       const Deserializer& deserializer);\n \n+  std::string ToString(int indent) const override;\n+\n  private:\n   const BufferAllocation::Slice branch_index_buffer_index_;\n   std::vector<std::unique_ptr<SequentialThunk>> branch_thunks_;"
        },
        {
            "sha": "1b684c596503199d170269ea854396e37b78f506",
            "filename": "third_party/xla/xla/backends/gpu/runtime/conditional_thunk_test.cc",
            "status": "modified",
            "additions": 57,
            "deletions": 9,
            "changes": 66,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconditional_thunk_test.cc?ref=af7b2a39a054ee7ffbb4c2807c2e7dd195c2d391",
            "patch": "@@ -63,7 +63,7 @@ struct DummyThunk : public Thunk {\n   }\n };\n \n-ConditionalThunk CreateConditionalThunk(\n+std::unique_ptr<ConditionalThunk> CreateConditionalThunk(\n     const Thunk::ThunkInfo& thunk_info,\n     const BufferAllocation::Slice& branch_index_buffer_index,\n     std::vector<ThunkSequence> branch_thunk_sequences,\n@@ -74,8 +74,9 @@ ConditionalThunk CreateConditionalThunk(\n         thunk_info, std::move(thunk_sequence)));\n   }\n \n-  return ConditionalThunk(thunk_info, branch_index_buffer_index,\n-                          std::move(branch_thunks), kBranchIndexIsBool);\n+  return std::make_unique<ConditionalThunk>(\n+      thunk_info, branch_index_buffer_index, std::move(branch_thunks),\n+      kBranchIndexIsBool);\n }\n \n TEST(ConditionalThunkTest, BufferUses) {\n@@ -99,16 +100,16 @@ TEST(ConditionalThunkTest, BufferUses) {\n   branch_thunk_sequences.push_back(std::move(true_seq));\n \n   constexpr bool kBranchIndexIsBool = true;\n-  ConditionalThunk thunk = CreateConditionalThunk(\n+  std::unique_ptr<ConditionalThunk> thunk = CreateConditionalThunk(\n       thunk_info, slice, std::move(branch_thunk_sequences), kBranchIndexIsBool);\n \n-  EXPECT_EQ(thunk.branch_index_is_bool(), kBranchIndexIsBool);\n-  EXPECT_EQ(thunk.branch_index_buffer(), slice);\n+  EXPECT_EQ(thunk->branch_index_is_bool(), kBranchIndexIsBool);\n+  EXPECT_EQ(thunk->branch_index_buffer(), slice);\n \n   auto thunk_matcher = Pointee(Property(&Thunk::kind, Thunk::Kind::kGemm));\n   auto branch_matcher = Pointee(Property(\n       &SequentialThunk::thunks, ElementsAre(thunk_matcher, thunk_matcher)));\n-  EXPECT_THAT(thunk.branch_thunks(),\n+  EXPECT_THAT(thunk->branch_thunks(),\n               ElementsAre(branch_matcher, branch_matcher));\n }\n \n@@ -133,9 +134,9 @@ TEST(ConditionalThunkTest, ToProto) {\n   branch_thunk_seq.push_back(std::move(true_seq));\n \n   constexpr bool kBranchIndexIsBool = true;\n-  ConditionalThunk thunk = CreateConditionalThunk(\n+  std::unique_ptr<ConditionalThunk> thunk = CreateConditionalThunk(\n       thunk_info, slice, std::move(branch_thunk_seq), kBranchIndexIsBool);\n-  TF_ASSERT_OK_AND_ASSIGN(ThunkProto proto, thunk.ToProto());\n+  TF_ASSERT_OK_AND_ASSIGN(ThunkProto proto, thunk->ToProto());\n \n   std::string expected = R\"pb(\n     thunk_info {\n@@ -240,5 +241,52 @@ TEST(ConditionalThunkTest, FromProto) {\n   EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n }\n \n+TEST(ConditionalThunkTest, ToString) {\n+  Thunk::ThunkInfo thunk_info;\n+\n+  BufferAllocation alloc(/*index=*/0, /*size=*/1024, /*color=*/0);\n+  BufferAllocation::Slice slice(&alloc, /*offset=*/0, /*size=*/256);\n+\n+  auto create_branch_thunk_sequences = [&]() -> std::vector<ThunkSequence> {\n+    ThunkSequence false_seq;\n+    false_seq.push_back(std::make_unique<DummyThunk>(Kind::kGemm, thunk_info));\n+\n+    ThunkSequence true_seq;\n+    true_seq.push_back(std::make_unique<DummyThunk>(Kind::kGemm, thunk_info));\n+    true_seq.push_back(std::make_unique<DummyThunk>(Kind::kGemm, thunk_info));\n+\n+    std::vector<ThunkSequence> branch_thunk_sequences;\n+    branch_thunk_sequences.push_back(std::move(false_seq));\n+    branch_thunk_sequences.push_back(std::move(true_seq));\n+    return branch_thunk_sequences;\n+  };\n+\n+  ThunkSequence thunk_sequence;\n+  thunk_sequence.push_back(\n+      CreateConditionalThunk(thunk_info, slice, create_branch_thunk_sequences(),\n+                             /*kBranchIndexIsBool=*/true));\n+  auto sequential_thunk =\n+      std::make_unique<SequentialThunk>(thunk_info, std::move(thunk_sequence));\n+  EXPECT_EQ(sequential_thunk->ToString(0),\n+            \"000: kConditional\\t  \\n\"\n+            \"  false_branch:\\n\"\n+            \"000:     kGemm\\t\\n\"\n+            \"  true_branch:\\n\"\n+            \"000:     kGemm\\t\\n\"\n+            \"000:     kGemm\\t\\n\\n\");\n+\n+  std::unique_ptr<ConditionalThunk> thunk =\n+      CreateConditionalThunk(thunk_info, slice, create_branch_thunk_sequences(),\n+                             /*kBranchIndexIsBool=*/false);\n+\n+  EXPECT_EQ(thunk->ToString(0),\n+            \"\\n\"\n+            \"branch_0:\\n\"\n+            \"000:   kGemm\\t\\n\"\n+            \"branch_1:\\n\"\n+            \"000:   kGemm\\t\\n\"\n+            \"000:   kGemm\\t\\n\");\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 84,
        "deletions": 9
    }
}