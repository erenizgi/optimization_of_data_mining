{
    "author": "tensorflower-gardener",
    "message": "Fix output bytes for cuBLAS custom calls in GPU HLO Cost Model.\n\nPiperOrigin-RevId: 837823432",
    "sha": "b7bb8d25fea7624f8909f89eea896754fc0ee2de",
    "files": [
        {
            "sha": "e395f548adf79ce6f27b9768098a104354044ed8",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_hlo_cost_analysis.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b7bb8d25fea7624f8909f89eea896754fc0ee2de/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b7bb8d25fea7624f8909f89eea896754fc0ee2de/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis.cc?ref=b7bb8d25fea7624f8909f89eea896754fc0ee2de",
            "patch": "@@ -300,6 +300,14 @@ absl::Status GpuHloCostAnalysis::HandleCustomCall(\n     current_properties_[kFlopsKey] =\n         GetDotFlops(custom_call->operand(0)->shape(), output_shape,\n                     gemm_config.dot_dimension_numbers());\n+    // cublas custom-calls return a tuple (real_output, temp_bytes). Cost model\n+    // should only care about the real output size.\n+    // Update both output_bytes_accessed and bytes_accessed accordingly.\n+    int64_t output_size = options_.shape_size(output_shape);\n+    current_properties_[kBytesAccessedKey] -=\n+        current_properties_.output_bytes_accessed();\n+    current_properties_[kBytesAccessedKey] += output_size;\n+    current_properties_.set_output_bytes_accessed(output_size);\n     return absl::OkStatus();\n   }\n "
        },
        {
            "sha": "5bf67a56f06f57947089afbf6779c65f0dccaeec",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_hlo_cost_analysis_test.cc",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b7bb8d25fea7624f8909f89eea896754fc0ee2de/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b7bb8d25fea7624f8909f89eea896754fc0ee2de/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis_test.cc?ref=b7bb8d25fea7624f8909f89eea896754fc0ee2de",
            "patch": "@@ -71,6 +71,42 @@ ENTRY entry {\n   EXPECT_EQ(analysis_.flop_count(*conv1), 159694848);\n }\n \n+TEST_F(GpuHloCostAnalysisTest, CublasCustomCall) {\n+  absl::string_view hlo_string = R\"(\n+  HloModule module, entry_computation_layout={(f32[100,100]{1,0}, f32[100,100]{1,0})->f32[100,100]{1,0}}\n+\n+  ENTRY %main (arg0: f32[100,100], arg1: f32[100,100]) -> f32[100,100] {\n+    %arg0 = f32[100,100]{1,0} parameter(0)\n+    %arg1 = f32[100,100]{1,0} parameter(1)\n+    %custom-call.1 = (f32[100,100]{1,0}, s8[80000]{0}) custom-call(%arg0, %arg1),\n+    custom_call_target=\"__cublas$gemm\",\n+    backend_config={\n+      \"gemm_backend_config\":{\n+        \"dot_dimension_numbers\":\n+          {\n+            \"lhs_contracting_dimensions\":[\"1\"],\n+            \"rhs_contracting_dimensions\":[\"0\"],\n+            \"lhs_batch_dimensions\":[],\n+            \"rhs_batch_dimensions\":[]\n+        }\n+      }\n+    }\n+    ROOT %get-tuple-element = f32[100,100]{1,0} get-tuple-element(%custom-call.1), index=0\n+  })\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  ASSERT_IS_OK(module->entry_computation()->Accept(&analysis_));\n+  HloComputation* comp = module->entry_computation();\n+  const HloInstruction* instr = comp->GetInstructionWithName(\"custom-call.1\");\n+  int op0_size = sizeof(float) * 100 * 100;\n+  int op1_size = sizeof(float) * 100 * 100;\n+  int out_size = sizeof(float) * 100 * 100;\n+  EXPECT_EQ(analysis_.operand_bytes_accessed(*instr, 0), op0_size);\n+  EXPECT_EQ(analysis_.operand_bytes_accessed(*instr, 1), op1_size);\n+  EXPECT_EQ(analysis_.output_bytes_accessed(*instr), out_size);\n+  EXPECT_EQ(analysis_.bytes_accessed(*instr), op0_size + op1_size + out_size);\n+}\n+\n TEST_F(GpuHloCostAnalysisTest, ReduceWindowWithOverlapsRepeatedReads) {\n   absl::string_view hlo_string = R\"(\n HloModule module, is_scheduled=true"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 44,
        "deletions": 0
    }
}