{
    "author": "d4n1elchen",
    "message": "[HLO Diff] Refactor HLO instruction rendering to support text truncation and expansion.\n\nEach HLO instruction is now rendered within a `div.hlo-instruction`. The instruction text is placed inside a `span.hlo-instruction-text`, which is styled to truncate long lines with an ellipsis. A `button.hlo-expand-btn` is added, visible on hover for truncated lines, allowing users to expand the instruction to show the full text. JavaScript event handlers are updated to work with this new structure, ensuring diff highlighting and scrolling functionality remain correct.\n\nPiperOrigin-RevId: 809092613",
    "sha": "bbefd5760f4be980fc66b069a2106aa32b01f0bb",
    "files": [
        {
            "sha": "6391d3d4a0f864883151e485f12e81ba6de68f6e",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 120,
            "deletions": 75,
            "changes": 195,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bbefd5760f4be980fc66b069a2106aa32b01f0bb/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bbefd5760f4be980fc66b069a2106aa32b01f0bb/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=bbefd5760f4be980fc66b069a2106aa32b01f0bb",
            "patch": "@@ -227,29 +227,59 @@ std::string PrintCss() {\n     span.grey {\n       color: #999999;\n     }\n-\n-    span.hlo-instruction {\n-      display: inline-block;\n-      cursor: pointer;\n+    div.hlo-instruction {\n+      display: flex;\n       width: 100%;\n+      align-items: flex-start;\n     }\n-    span.hlo-instruction:hover {\n-      border: 2px solid #4285F4;\n+    div.hlo-instruction.expanded {\n+      max-width: unset;\n+    }\n+    span.hlo-instruction-text {\n+      flex: 1 1 auto;\n+      min-width: 0;\n+      white-space: pre;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n+      cursor: pointer;\n     }\n-    span.bordered {\n+    div.hlo-instruction.expanded span.hlo-instruction-text {\n+      white-space: pre-wrap;\n+      overflow: visible;\n+    }\n+    button.hlo-expand-btn {\n+      flex-shrink: 0;\n+      background: #e8eaf6;\n+      color: #3f51b5;\n+      padding: 0 4px;\n+      border: 1px solid #c5cae9;\n+      box-shadow: none;\n+      font-weight: bold;\n+      margin-left: 4px;\n+      min-width: 25px;\n+      height: 1.3em;\n+      line-height: 1.1;\n+      visibility: hidden;\n+      cursor: pointer;\n+    }\n+    div.hlo-instruction.has-overflow.expanded button.hlo-expand-btn,\n+    div.hlo-instruction.has-overflow:not(.expanded):hover button.hlo-expand-btn {\n+      visibility: visible;\n+    }\n+    div.bordered {\n       border: 2px solid #4285F4;\n     }\n \n-    span.red-highlight {\n+    .red-highlight {\n       background-color: #fad2cf;\n     }\n-    span.green-highlight {\n+    .green-highlight {\n       background-color: #ceead6;\n     }\n-    span.yellow-highlight {\n+    .yellow-highlight {\n       background-color: #feefc3;\n     }\n-    span.darker-yellow-highlight {\n+    .darker-yellow-highlight {\n       background-color: #FAD67F;\n       /* Ensure empty or minimal content spans are visible as a thin line */\n       display: inline-block;\n@@ -259,7 +289,7 @@ std::string PrintCss() {\n       line-height: 1; /* Prevent extra space */\n       overflow: hidden; /* Hide any overflow */\n     }\n-    span.temp-highlight {\n+    .temp-highlight {\n       background-color: #a8c7fa;\n       opacity: 0.7;\n       animation: breathe-highlight 1s infinite alternate;\n@@ -357,139 +387,153 @@ std::string PrintJavascriptForHoverEvent() {\n       }, 3000);\n   }\n \n-  const allSpans = document.querySelectorAll('span[data-diffid][data-diffid-mapped]');\n-  allSpans.forEach(span => {\n-      span.addEventListener('mouseover', handleMouseOver);\n-      span.addEventListener('mouseout', handleMouseOut);\n-      span.addEventListener('click', handleSpanClick);\n-      span.addEventListener('dblclick', handleSpanDoubleClick);\n+  const allInstructions = document.querySelectorAll('.hlo-instruction');\n+  allInstructions.forEach(instructionDiv => {\n+      instructionDiv.addEventListener('mouseover', handleInstructionMouseOver);\n+      instructionDiv.addEventListener('mouseout', handleInstructionMouseOut);\n+      instructionDiv.addEventListener('dblclick', handleInstructionDoubleClick);\n+      instructionDiv.addEventListener('click', handleInstructionClick);\n+\n+      const button = instructionDiv.querySelector('.hlo-expand-btn');\n+      const textSpan = instructionDiv.querySelector('.hlo-instruction-text');\n+      if(textSpan.scrollWidth > textSpan.clientWidth) {\n+        instructionDiv.classList.add('has-overflow');\n+        button.addEventListener('click', (e) => {\n+          instructionDiv.classList.toggle('expanded');\n+          button.textContent = instructionDiv.classList.contains('expanded') ? '-' : '+';\n+          e.stopPropagation();\n+        });\n+      }\n   });\n \n-  function getRelatedSpans(diffId, mappedId) {\n-    return document.querySelectorAll(`span[data-diffid=\"${diffId}\"][data-diffid-mapped=\"${mappedId}\"], span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+  function getRelatedDivs(diffId, mappedId) {\n+    return document.querySelectorAll(`div[data-diffid=\"${diffId}\"][data-diffid-mapped=\"${mappedId}\"], div[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n   }\n \n-  function handleMouseOver(event) {\n-      const diffId = event.target.getAttribute('data-diffid');\n-      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+  function handleInstructionMouseOver(event) {\n+      const instructionDiv = event.currentTarget;\n+      const diffId = instructionDiv.getAttribute('data-diffid');\n+      const mappedId = instructionDiv.getAttribute('data-diffid-mapped');\n       if (!diffId || !mappedId) {\n           return;\n       }\n-      const relatedSpans = getRelatedSpans(diffId, mappedId);\n-      relatedSpans.forEach(relatedSpan => {\n-          relatedSpan.classList.add('bordered');\n+      const relatedDivs = getRelatedDivs(diffId, mappedId);\n+      relatedDivs.forEach(relatedDiv => {\n+          relatedDiv.classList.add('bordered');\n       });\n   }\n \n-  function handleMouseOut(event) {\n-      const diffId = event.target.getAttribute('data-diffid');\n-      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+  function handleInstructionMouseOut(event) {\n+      const instructionDiv = event.currentTarget;\n+      const diffId = instructionDiv.getAttribute('data-diffid');\n+      const mappedId = instructionDiv.getAttribute('data-diffid-mapped');\n       if (!diffId || !mappedId) {\n           return;\n       }\n-      const relatedSpans = getRelatedSpans(diffId, mappedId);\n-      relatedSpans.forEach(relatedSpan => {\n-          relatedSpan.classList.remove('bordered');\n+      const relatedDivs = getRelatedDivs(diffId, mappedId);\n+      relatedDivs.forEach(relatedDiv => {\n+          relatedDiv.classList.remove('bordered');\n       });\n   }\n \n-  function handleSpanClick(event) {\n-      const diffId = event.target.getAttribute('data-diffid');\n-      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+  function handleInstructionClick(event) {\n+      const instructionDiv = event.currentTarget;\n+      const diffId = instructionDiv.getAttribute('data-diffid');\n+      const mappedId = instructionDiv.getAttribute('data-diffid-mapped');\n       if (!diffId || !mappedId) {\n           return;\n       }\n \n-      const clickedSpan = event.target;\n-      const clickedPre = clickedSpan.closest('pre');\n+      const clickedPre = instructionDiv.closest('pre');\n       if (!clickedPre) return;\n \n-      const selfTextboxes = clickedSpan.closest('.hlo-textboxes');\n+      const selfTextboxes = instructionDiv.closest('.hlo-textboxes');\n       if (!selfTextboxes) return;\n       const siblingTextboxes = selfTextboxes.nextElementSibling || selfTextboxes.previousElementSibling;\n       if (!siblingTextboxes || !siblingTextboxes.classList.contains('hlo-textboxes')) return;\n \n-      const targetSpan = siblingTextboxes.querySelector(`span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+      const targetDiv = siblingTextboxes.querySelector(`div[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n \n-      if (targetSpan) {\n-          const siblingPre = targetSpan.closest('pre');\n+      if (targetDiv) {\n+          const siblingPre = targetDiv.closest('pre');\n           if (!siblingPre) return;\n \n-          // Calculate the vertical offset of the clicked span from the top of its visible area.\n-          const clickedSpanViewportOffset = clickedSpan.offsetTop - clickedPre.scrollTop;\n+          // Calculate the vertical offset of the clicked div from the top of its visible area.\n+          const clickedDivViewportOffset = (instructionDiv.offsetTop - clickedPre.offsetTop) - clickedPre.scrollTop;\n \n           // Calculate the percentage of this offset within the clickedPre's visible height.\n           const percentage = clickedPre.clientHeight > 0 ?\n-              clickedSpanViewportOffset / clickedPre.clientHeight : 0;\n+              clickedDivViewportOffset / clickedPre.clientHeight : 0;\n \n-          // Calculate the desired offset for the targetSpan within the siblingPre's visible area.\n+          // Calculate the desired offset for the targetDiv within the siblingPre's visible area.\n           const desiredSiblingViewportOffset = percentage * siblingPre.clientHeight;\n \n           // Calculate the new scrollTop for siblingPre to achieve this alignment.\n-          const newScrollTop = targetSpan.offsetTop - desiredSiblingViewportOffset;\n+          const newScrollTop = (targetDiv.offsetTop - siblingPre.offsetTop) - desiredSiblingViewportOffset;\n \n           // Scroll the siblingPre element smoothly.\n           siblingPre.scrollTo({\n               top: Math.max(0, newScrollTop),\n               behavior: 'smooth'\n           });\n \n-          // Temporarily highlight the target span\n-          targetSpan.classList.add('temp-highlight');\n+          // Temporarily highlight the target div\n+          targetDiv.classList.add('temp-highlight');\n           setTimeout(() => {\n-              targetSpan.classList.remove('temp-highlight');\n+              targetDiv.classList.remove('temp-highlight');\n           }, 2000); // Remove highlight after 2 seconds\n       } else {\n           ShowSystemMessage(\"Corresponding instruction is in another computation, double click to jump to it.\");\n       }\n   }\n \n-  function handleSpanDoubleClick(event) {\n-      const diffId = event.target.getAttribute('data-diffid');\n-      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+  function handleInstructionDoubleClick(event) {\n+      const instructionDiv = event.currentTarget;\n+      const diffId = instructionDiv.getAttribute('data-diffid');\n+      const mappedId = instructionDiv.getAttribute('data-diffid-mapped');\n       if (!diffId || !mappedId) {\n           return;\n       }\n \n-      const clickedSpan = event.target;\n-      const clickedPre = clickedSpan.closest('pre');\n+      const clickedEl = event.target;\n+      const clickedPre = clickedEl.closest('pre');\n       if (!clickedPre) return;\n \n-      const selfTextboxes = clickedSpan.closest('.hlo-textboxes');\n+      const selfTextboxes = clickedEl.closest('.hlo-textboxes');\n       if (!selfTextboxes) return;\n       const siblingTextboxes = selfTextboxes.nextElementSibling || selfTextboxes.previousElementSibling;\n       if (!siblingTextboxes || !siblingTextboxes.classList.contains('hlo-textboxes')) return;\n \n-      const targetSpanInSibling = siblingTextboxes.querySelector(`span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+      const targetDivInSibling = siblingTextboxes.querySelector(`div[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n \n-      if (!targetSpanInSibling) {\n-          // Case 2: Corresponding span NOT found in sibling textboxes in same pair.\n-          // Search for the span with the same diffId in other hlo-textbox-pairs.\n-          const allMatchingSpans = document.querySelectorAll(`span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n-          let foundSpanInOtherPre = null;\n-          allMatchingSpans.forEach(span => {\n-              if (span !== clickedSpan) {\n-                  foundSpanInOtherPre = span;\n+      if (!targetDivInSibling) {\n+          // Case 2: Corresponding div NOT found in sibling textboxes in same pair.\n+          // Search for the div with the same diffId in other hlo-textbox-pairs.\n+          const allMatchingDivs = document.querySelectorAll(`div[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+          let foundDivInOtherPre = null;\n+          allMatchingDivs.forEach(div => {\n+              if (div !== instructionDiv) {\n+                  foundDivInOtherPre = div;\n               }\n           });\n \n-          if (foundSpanInOtherPre) {\n-              const foundPre = foundSpanInOtherPre.closest('pre');\n+          if (foundDivInOtherPre) {\n+              const foundPre = foundDivInOtherPre.closest('pre');\n               if (foundPre) {\n                   // Find ancestor detail and open it.\n-                  let parentDetails = foundSpanInOtherPre.closest('details');\n+                  let parentDetails = foundDivInOtherPre.closest('details');\n                   while (parentDetails) {\n                       parentDetails.open = true;\n                       parentDetails = parentDetails.parentElement ? parentDetails.parentElement.closest('details') : null;\n                   }\n \n-                  // Scroll the foundPre to make the foundSpanInOtherPre visible.\n-                  foundSpanInOtherPre.scrollIntoView({ behavior: 'smooth', block: 'center' });\n+                  // Scroll the foundPre to make the foundDivInOtherPre visible.\n+                  foundDivInOtherPre.scrollIntoView({ behavior: 'smooth', block: 'center' });\n \n-                  // Temporarily highlight the found span\n-                  foundSpanInOtherPre.classList.add('temp-highlight');\n+                  // Temporarily highlight the found div\n+                  foundDivInOtherPre.classList.add('temp-highlight');\n                   setTimeout(() => {\n-                      foundSpanInOtherPre.classList.remove('temp-highlight');\n+                      foundDivInOtherPre.classList.remove('temp-highlight');\n                   }, 3000);\n               }\n           }\n@@ -761,8 +805,9 @@ std::string PrintHloComputationToHtml(\n               EscapeStringForHtmlAttribute(it->second.mapped_diffid), \"\\\"\");\n         }\n       }\n-      printer.Append(absl::StrCat(\"<span class=\\\"hlo-instruction \",\n-                                  highlight_class, \"\\\"\", diffid_attrs, \" >\"));\n+      printer.Append(absl::StrCat(\"<div class=\\\"hlo-instruction \",\n+                                  highlight_class, \"\\\"\", diffid_attrs, \" >\",\n+                                  \"<span class='hlo-instruction-text'>\"));\n       printer.Append(\"  \");  // Instruction indentation (2 spaces)\n       if (instruction == comp->root_instruction()) {\n         printer.Append(\"ROOT \");\n@@ -817,7 +862,7 @@ std::string PrintHloComputationToHtml(\n           }\n         }\n       }\n-      printer.Append(\"</span>\");\n+      printer.Append(\"</span><button class='hlo-expand-btn'>+</button></div>\");\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 195,
        "additions": 120,
        "deletions": 75
    }
}