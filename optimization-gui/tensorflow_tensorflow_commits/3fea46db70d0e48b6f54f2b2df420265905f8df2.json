{
    "author": "ZixuanJiang",
    "message": "Remove `goto` in `hlo_sharding_util`.\n\nPure refactoring.\n\nPiperOrigin-RevId: 844944658",
    "sha": "3fea46db70d0e48b6f54f2b2df420265905f8df2",
    "files": [
        {
            "sha": "5bf1e9cdb42b234d0537dc1e0ccb011ecee6f4a5",
            "filename": "third_party/xla/xla/hlo/utils/hlo_sharding_util.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 14,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3fea46db70d0e48b6f54f2b2df420265905f8df2/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3fea46db70d0e48b6f54f2b2df420265905f8df2/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.cc?ref=3fea46db70d0e48b6f54f2b2df420265905f8df2",
            "patch": "@@ -405,19 +405,17 @@ bool MergeSharding(const HloSharding& to_merge, HloSharding* dst,\n     }\n     return changed;\n   }\n-  if (!may_combine_partial_sharding || !to_merge.HasPartialReplication() ||\n-      !dst->HasPartialReplication() ||\n-      to_merge.num_devices() != dst->num_devices()) {\n-    goto check_if_more_specific;\n-  }\n \n-  if (MergeShardingIfCompatible(\n+  if (may_combine_partial_sharding && to_merge.HasPartialReplication() &&\n+      dst->HasPartialReplication() &&\n+      to_merge.num_devices() == dst->num_devices() &&\n+      MergeShardingIfCompatible(\n           to_merge,\n           /*minimum_tiles=*/std::max(to_merge.NumTiles(), dst->NumTiles()) + 1,\n           dst)) {\n     return true;\n   }\n-check_if_more_specific:\n+\n   return IsLeafShardingMoreSpecific(*dst, to_merge);\n }\n \n@@ -2872,13 +2870,12 @@ std::optional<HloSharding> ReturnImprovedShardingImpl(\n     // with the existing one. This avoids unexpected resharding when `sharding`\n     // just has more tiles than existing sharding but they are not mergeable.\n     if (!allow_aggressive_resharding && to_improved_shape.IsArray() &&\n-        !to_improved->IsTileMaximal() && from.NumTiles() == sharding_tiles) {\n-      if (!IsSubTilingOrEqualSharding(to_improved_shape, from, *to_improved)) {\n-        VLOG(10) << \"Not merging because of different device distribution\";\n-        VLOG(10) << \"Instr sharding: \" << to_improved->ToString();\n-        VLOG(10) << \"New sharding \" << from.ToString();\n-        return std::nullopt;\n-      }\n+        !to_improved->IsTileMaximal() && from.NumTiles() == sharding_tiles &&\n+        !IsSubTilingOrEqualSharding(to_improved_shape, from, *to_improved)) {\n+      VLOG(10) << \"Not merging because of different device distribution\";\n+      VLOG(10) << \"Instr sharding: \" << to_improved->ToString();\n+      VLOG(10) << \"New sharding \" << from.ToString();\n+      return std::nullopt;\n     }\n     return from;\n   }"
        },
        {
            "sha": "66e60692386523a9e107bba80f79524b77835984",
            "filename": "third_party/xla/xla/hlo/utils/hlo_sharding_util.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3fea46db70d0e48b6f54f2b2df420265905f8df2/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3fea46db70d0e48b6f54f2b2df420265905f8df2/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Futils%2Fhlo_sharding_util.h?ref=3fea46db70d0e48b6f54f2b2df420265905f8df2",
            "patch": "@@ -99,8 +99,8 @@ bool IsSubTilingOrEqualSharding(const Shape& shape,\n // sharding with same preference level.\n bool IsShardingMoreSpecific(const HloSharding& lhs, const HloSharding& rhs);\n \n-// Tries to refine `to_merge` by combining with `old`. Returns if the final\n-// `to_merge` is more specific than `old`.\n+// Tries to refine `dst` by merging `to_merge` into it. Returns if the final\n+// `dst` is more specific than `to_merge`.\n bool MergeSharding(const HloSharding& to_merge, HloSharding* dst,\n                    bool may_combine_partial_sharding);\n "
        }
    ],
    "stats": {
        "total": 29,
        "additions": 13,
        "deletions": 16
    }
}