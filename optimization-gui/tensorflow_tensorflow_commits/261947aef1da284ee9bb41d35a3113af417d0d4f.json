{
    "author": "tensorflower-gardener",
    "message": "Moves Canonical Map to use unique_id_64_bits in preparation for upcoming changes to avoid breaking existing services. Reduces the log frequency of warnings of using int64 ids.\n\nPiperOrigin-RevId: 805610120",
    "sha": "261947aef1da284ee9bb41d35a3113af417d0d4f",
    "files": [
        {
            "sha": "3abefbbbf6b440d32af9a94dbb7b598de2e5244f",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=261947aef1da284ee9bb41d35a3113af417d0d4f",
            "patch": "@@ -160,6 +160,7 @@ xla_cc_test(\n     srcs = [\"hlo_instruction_test.cc\"],\n     deps = [\n         \":hlo\",\n+        \"//xla:printer\",\n         \"//xla:shape_util\",\n         \"//xla:side_effect_util\",\n         \"//xla:xla_data_proto_cc\","
        },
        {
            "sha": "258dbe4ec27bfe870f01879bdf7d4932e6bd53a5",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc?ref=261947aef1da284ee9bb41d35a3113af417d0d4f",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/functional/function_ref.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/log/log.h\"\n #include \"absl/memory/memory.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/ascii.h\"\n@@ -1368,10 +1369,12 @@ absl::StatusOr<std::unique_ptr<HloInstruction>> HloInstruction::CreateFromProto(\n       << \"Instruction with negative id: \" << proto.id();\n   // TODO(b/399394039): Reinforce the condition on INT64_MAX when upgrading\n   // unique_id_ to int64_t.\n-  LOG_IF(INFO, proto.id() > INT_MAX)\n-      << \"Instruction with id > INT_MAX: \" << proto.id()\n-      << \" this is not intended behavior and might indicate a bug in the HLO \"\n-         \"proto serialization.\";\n+  if (proto.id() > INT_MAX) {\n+    LOG_EVERY_N(WARNING, 10000)\n+        << \"Instruction with id > INT_MAX: \" << proto.id()\n+        << \" this is not intended behavior and might indicate a bug in the HLO \"\n+           \"proto serialization.\";\n+  }\n   instruction->unique_id_ = proto.id();\n \n   if (proto.has_sharding()) {\n@@ -3920,7 +3923,7 @@ void HloInstruction::PrintWithCanonicalNameMap(\n       // If we are canonicalizing instruction names and this is a top-level\n       // HloInstruction::ToString() call, don't print an instruction name.\n       DCHECK(!options.print_percent());  // no need to call PrintNameInternal\n-      printer->Append(canonical_name_map->LookupOrInsert(unique_id()));\n+      printer->Append(canonical_name_map->LookupOrInsert(unique_id_64_bits()));\n       printer->Append(\" = \");\n     }\n   } else {\n@@ -4046,7 +4049,7 @@ void HloInstruction::PrintOperandsWithCanonicalNameMap(\n           printer->Append(\" \");\n         }\n         printer->Append(\n-            canonical_name_map->LookupOrInsert(operand->unique_id()));\n+            canonical_name_map->LookupOrInsert(operand->unique_id_64_bits()));\n       }\n     } else if (options.print_operand_names()) {\n       if (add_space) {"
        },
        {
            "sha": "7d72b79394cf003763b225ad359f7d4fd7c34c7d",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction_test.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction_test.cc?ref=261947aef1da284ee9bb41d35a3113af417d0d4f",
            "patch": "@@ -17,6 +17,8 @@ limitations under the License.\n \n #include <cstdint>\n #include <memory>\n+#include <string>\n+#include <utility>\n #include <vector>\n \n #include <gmock/gmock.h>\n@@ -25,8 +27,10 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/hlo/ir/hlo_print_options.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/transforms/simplifiers/hlo_dce.h\"\n+#include \"xla/printer.h\"\n #include \"xla/service/hlo.pb.h\"\n #include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n@@ -211,5 +215,40 @@ TEST_F(HloInstructionTest, PrintCompareOpWorksIfDead) {\n   *module->mutable_entry_computation_layout() =\n       module->compute_computation_layout();\n }\n+\n+TEST_F(HloInstructionTest, CanonicalPrintingSupportsInt64) {\n+  std::unique_ptr<HloInstruction> param1 =\n+      HloInstruction::CreateParameter(0, Shape(F32, {4}), \"param1\");\n+  std::unique_ptr<HloInstruction> param2 =\n+      HloInstruction::CreateParameter(0, Shape(F32, {2}), \"param2\");\n+  std::unique_ptr<HloInstruction> param3 =\n+      HloInstruction::CreateParameter(0, Shape(F32, {6}), \"param3\");\n+\n+  param1->SetUniqueId(1 + (static_cast<int64_t>(1) << 32));\n+  param2->SetUniqueId(2 + (static_cast<int64_t>(2) << 32));\n+  param3->SetUniqueId(3 + (static_cast<int64_t>(3) << 32));\n+\n+  xla::HloPrintOptions hlo_print_options =\n+      xla::HloPrintOptions(xla::HloPrintOptions::Canonical());\n+  hlo_print_options.set_is_in_nested_computation(true);\n+\n+  xla::CanonicalNameMap new_map;\n+  xla::StringPrinter printer;\n+  param1->PrintWithCanonicalNameMap(&printer, hlo_print_options, &new_map);\n+  std::string param1_to_string = std::move(printer).ToString();\n+\n+  printer = StringPrinter();\n+  param2->PrintWithCanonicalNameMap(&printer, hlo_print_options, &new_map);\n+  std::string param2_to_string = std::move(printer).ToString();\n+\n+  printer = StringPrinter();\n+  param3->PrintWithCanonicalNameMap(&printer, hlo_print_options, &new_map);\n+  std::string param3_to_string = std::move(printer).ToString();\n+\n+  EXPECT_EQ(param1_to_string, \"tmp_0 = f32[4] parameter(0)\");\n+  EXPECT_EQ(param2_to_string, \"tmp_1 = f32[2] parameter(0)\");\n+  EXPECT_EQ(param3_to_string, \"tmp_2 = f32[6] parameter(0)\");\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "d9b5b3a2a7dd450c384d749ff1330bd5c2f96c42",
            "filename": "third_party/xla/xla/hlo/ir/hlo_print_options.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_print_options.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/261947aef1da284ee9bb41d35a3113af417d0d4f/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_print_options.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_print_options.h?ref=261947aef1da284ee9bb41d35a3113af417d0d4f",
            "patch": "@@ -464,7 +464,7 @@ class HloPrintOptions {\n // where <xxx> is an index starting from 0.\n class CanonicalNameMap {\n  public:\n-  const std::string& LookupOrInsert(int unique_id) {\n+  const std::string& LookupOrInsert(int64_t unique_id) {\n     std::string& canonical_name = canonical_name_map_[unique_id];\n     if (canonical_name.empty()) {\n       absl::StrAppend(&canonical_name, \"tmp_\", canonical_name_map_.size() - 1);\n@@ -475,7 +475,7 @@ class CanonicalNameMap {\n   void Reserve(size_t size) { canonical_name_map_.reserve(size); }\n \n  private:\n-  absl::flat_hash_map<int, std::string> canonical_name_map_;\n+  absl::flat_hash_map<int64_t, std::string> canonical_name_map_;\n };\n \n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 51,
        "deletions": 8
    }
}