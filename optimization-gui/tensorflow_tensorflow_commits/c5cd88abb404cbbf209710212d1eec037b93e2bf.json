{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Add ExecuteReplicated overload for cases when module does not need arguments.\n\nPiperOrigin-RevId: 838749495",
    "sha": "c5cd88abb404cbbf209710212d1eec037b93e2bf",
    "files": [
        {
            "sha": "08cbb58a107238e845322c2f55db45df157aa122",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test.cc",
            "status": "modified",
            "additions": 46,
            "deletions": 78,
            "changes": 124,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cd88abb404cbbf209710212d1eec037b93e2bf/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cd88abb404cbbf209710212d1eec037b93e2bf/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc?ref=c5cd88abb404cbbf209710212d1eec037b93e2bf",
            "patch": "@@ -209,9 +209,8 @@ TEST_P(AsyncCollectiveOps, AsyncAllReduce) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* all_reduce_start =\n@@ -253,9 +252,8 @@ TEST_P(AsyncCollectiveOps, AsyncAllGather) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* all_gather_start =\n@@ -300,9 +298,8 @@ TEST_P(AsyncCollectiveOps, AsyncAllGatherMixedTypes) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* all_gather_start =\n@@ -345,9 +342,8 @@ TEST_P(AsyncCollectiveOps, AsyncCollectiveBroadcast) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* cb_start =\n@@ -384,9 +380,8 @@ TEST_P(AsyncCollectiveOps, AsyncCollectivePermute) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* cp_start =\n@@ -424,9 +419,8 @@ TEST_P(AsyncCollectiveOps, CombinedCollectivePermute) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* cp_start =\n@@ -468,9 +462,8 @@ TEST_P(AsyncCollectiveOps, CollectivePermuteCombiner) {\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* cp_start =\n@@ -536,9 +529,8 @@ TEST_P(AsyncCollectiveOps, AsyncReduceScatter) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* rs_start =\n@@ -666,9 +658,8 @@ TEST_P(AsyncCollectiveOps, AsyncAllToAllWithoutSplitDim) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* a2a_start =\n@@ -716,12 +707,9 @@ TEST_P(AsyncCollectiveOps, AsyncAllToAllMemCpyWithoutSplitDim) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+  const std::vector<Literal>& results = execution_result.results;\n   ASSERT_EQ(results.size(), kNumReplicas);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({10, 15, 11, 16}, results[0]);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({40, 60, 44, 64}, results[1]);\n@@ -747,9 +735,8 @@ TEST_P(AsyncCollectiveOps, AsyncAllToAllNumberOfElementsLargerThanInt32Max) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   HloInstruction* a2a_start =\n@@ -801,9 +788,8 @@ ENTRY entry {\n   TF_ASSERT_OK_AND_ASSIGN(\n       auto module, ParseAndReturnVerifiedModule(kModuleStr, kNumReplicas));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      ExecutionResult execution_result,\n-      ExecuteReplicated(std::move(module), /*arguments=*/{{}, {}}));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n \n   const HloModule* hlo_module = execution_result.optimized_module;\n   const bool enable_async_ragged_all_to_all = GetParam();\n@@ -856,12 +842,9 @@ TEST_P(AsyncMemcpyCollectiveOps, AsyncAllToAllMultipleReplicaGroups) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+  const std::vector<Literal>& results = execution_result.results;\n   ASSERT_EQ(results.size(), kNumReplicas);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({10, 13}, results[0]);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({11, 12}, results[1]);\n@@ -891,12 +874,9 @@ TEST_P(AsyncMemcpyCollectiveOps, AsyncAllToAllDegenerateWithSplitDim) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+  const std::vector<Literal>& results = execution_result.results;\n   ASSERT_EQ(results.size(), kNumReplicas);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({10, 20}, results[0]);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({11, 21}, results[1]);\n@@ -925,12 +905,9 @@ TEST_P(AsyncMemcpyCollectiveOps, AsyncAllToAllDegenerateWithoutSplitDim) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+  const std::vector<Literal>& results = execution_result.results;\n   ASSERT_EQ(results.size(), kNumReplicas);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({10, 20}, results[0]);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({11, 21}, results[1]);\n@@ -963,13 +940,9 @@ TEST_P(MemcpyCollectiveOps, AllToAll8Gpus) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n-  ASSERT_EQ(results.size(), kNumReplicas);\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+  const std::vector<Literal>& results = execution_result.results;\n \n   Array<uint32_t> expected({16});\n   expected.SetValues(\n@@ -1160,11 +1133,10 @@ TEST_F(CollectiveOpsTestE2E, WhileLoopReduceScatterCodeMotion) {\n \n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-  TF_ASSERT_OK_AND_ASSIGN(const HloModule* const executable_module,\n-                          hlo_runner_->HloModuleFromWrapped(executable.get()));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+\n+  const HloModule* executable_module = execution_result.optimized_module;\n \n   // Verify that the reduce-scatter get hoisted out of the while loop.\n   const HloInstruction* while_loop =\n@@ -1183,8 +1155,7 @@ TEST_F(CollectiveOpsTestE2E, WhileLoopReduceScatterCodeMotion) {\n   const HloComputation* entry = executable_module->entry_computation();\n   EXPECT_EQ(reduce_scatter->parent(), entry);\n \n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n+  const std::vector<Literal>& results = execution_result.results;\n   ASSERT_EQ(results.size(), kNumReplicas);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({74}, results[0]);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({110}, results[1]);\n@@ -1213,19 +1184,16 @@ TEST_F(CollectiveOpsTestE2E, NoAllToAllDecomposition) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnVerifiedModule(kModuleStr, config));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      auto executable, hlo_runner_->CreateExecutable(std::move(module),\n-                                                     /*run_hlo_passes=*/true));\n-  TF_ASSERT_OK_AND_ASSIGN(const HloModule* const executable_module,\n-                          hlo_runner_->HloModuleFromWrapped(executable.get()));\n+  TF_ASSERT_OK_AND_ASSIGN(ExecutionResult execution_result,\n+                          ExecuteReplicated(std::move(module)));\n+  const HloModule* executable_module = execution_result.optimized_module;\n \n   // Verify that the all-to-all is not decomposed into a tuple all-to-all.\n   const HloInstruction* all_to_all =\n       FindInstruction(executable_module, HloOpcode::kAllToAll);\n   EXPECT_THAT(all_to_all, op::Shape(\"u32[2, 2]\"));\n \n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> results,\n-                          ExecuteReplicated(executable.get(), kNumReplicas));\n+  const std::vector<Literal>& results = execution_result.results;\n   ASSERT_EQ(results.size(), kNumReplicas);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({10, 15, 11, 16}, results[0]);\n   LiteralTestUtil::ExpectR1Equal<uint32_t>({20, 25, 21, 26}, results[1]);"
        },
        {
            "sha": "a5437ee15a9c129aab66683296a7097b6826310c",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test_base.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cd88abb404cbbf209710212d1eec037b93e2bf/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cd88abb404cbbf209710212d1eec037b93e2bf/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test_base.cc?ref=c5cd88abb404cbbf209710212d1eec037b93e2bf",
            "patch": "@@ -177,6 +177,14 @@ CollectiveOpsE2ETestBase::ExecuteReplicated(\n       /*device_assignment=*/device_assignment);\n }\n \n+absl::StatusOr<CollectiveOpsE2ETestBase::ExecutionResult>\n+CollectiveOpsE2ETestBase::ExecuteReplicated(std::unique_ptr<HloModule> module) {\n+  std::vector<std::vector<Literal*>> arguments(module->config().replica_count(),\n+                                               std::vector<Literal*>());\n+  return ExecuteReplicated(std::move(module), arguments,\n+                           /*run_hlo_passes=*/true);\n+}\n+\n absl::StatusOr<CollectiveOpsE2ETestBase::ExecutionResult>\n CollectiveOpsE2ETestBase::ExecuteReplicated(\n     std::unique_ptr<HloModule> module,"
        },
        {
            "sha": "217407dfd5c125a415bbc6673c778c9c99db804d",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test_base.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cd88abb404cbbf209710212d1eec037b93e2bf/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test_base.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cd88abb404cbbf209710212d1eec037b93e2bf/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test_base.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test_base.h?ref=c5cd88abb404cbbf209710212d1eec037b93e2bf",
            "patch": "@@ -75,6 +75,9 @@ class CollectiveOpsE2ETestBase : public HloHardwareIndependentTestBase {\n   absl::StatusOr<std::vector<Literal>> ExecuteReplicated(\n       OpaqueExecutable* executable, int64_t num_replicas);\n \n+  absl::StatusOr<ExecutionResult> ExecuteReplicated(\n+      std::unique_ptr<HloModule> module);\n+\n   absl::StatusOr<ExecutionResult> ExecuteReplicated(\n       std::unique_ptr<HloModule> module,\n       std::vector<std::vector<Literal*>> arguments, bool run_hlo_passes = true);"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 57,
        "deletions": 78
    }
}