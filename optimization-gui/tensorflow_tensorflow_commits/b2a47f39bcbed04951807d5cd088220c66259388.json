{
    "author": "hhb",
    "message": "Implement TransferLiteralToBuffer in PJRT C API client.\n\nPiperOrigin-RevId: 839988064",
    "sha": "b2a47f39bcbed04951807d5cd088220c66259388",
    "files": [
        {
            "sha": "25c3fbd29a0d3d55e6a143bf885f14a42c5ff91f",
            "filename": "third_party/xla/xla/pjrt/c/CHANGELOG.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -1,5 +1,9 @@\n # PJRT C API changelog\n \n+## 0.83\n+\n+* Add `PJRT_AsyncHostToDeviceTransferManager_TransferLiteral`.\n+\n ## 0.82\n \n * Add `PJRT_Client_CreateErrorBuffer`."
        },
        {
            "sha": "8a34314ff037b35a26713fad233fc9666b478f8d",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api.h",
            "status": "modified",
            "additions": 29,
            "deletions": 3,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -104,7 +104,7 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Extension_Base, next);\n // Changes include:\n // * Adding a new field to the PJRT_Api or argument structs\n // * Renaming a method or argument (doesn't affect ABI)\n-#define PJRT_API_MINOR 82\n+#define PJRT_API_MINOR 83\n \n // The plugin should set the major_version and minor_version of\n // PJRT_Api.pjrt_api_version to be the `PJRT_API_MAJOR` and `PJRT_API_MINOR` in\n@@ -967,6 +967,31 @@ struct PJRT_Buffer_MemoryLayout {\n };\n PJRT_DEFINE_STRUCT_TRAITS(PJRT_Buffer_MemoryLayout, type);\n \n+struct PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args {\n+  size_t struct_size;\n+  PJRT_Extension_Base* extension_start;\n+\n+  PJRT_AsyncHostToDeviceTransferManager* transfer_manager;\n+  int buffer_index;\n+  const void* data;\n+\n+  // Shape fields.\n+  const int64_t* shape_dims;\n+  size_t shape_num_dims;\n+  PJRT_Buffer_Type shape_element_type;\n+  PJRT_Buffer_MemoryLayout* shape_layout;\n+\n+  PJRT_Event* done_with_h2d_transfer;  // out\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(\n+    PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args,\n+    done_with_h2d_transfer);\n+\n+// Asynchronously copies a host literal to a buffer managed by a transfer\n+// manager.\n+typedef PJRT_Error* PJRT_AsyncHostToDeviceTransferManager_TransferLiteral(\n+    PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args* args);\n+\n struct PJRT_Client_CreateUninitializedBuffer_Args {\n   size_t struct_size;\n   PJRT_Extension_Base* extension_start;\n@@ -2708,11 +2733,12 @@ typedef struct PJRT_Api {\n   _PJRT_API_STRUCT_FIELD(PJRT_Client_FulfillAliasBuffer);\n   _PJRT_API_STRUCT_FIELD(PJRT_LoadedExecutable_GetDeviceAssignment);\n   _PJRT_API_STRUCT_FIELD(PJRT_Client_CreateErrorBuffer);\n+  _PJRT_API_STRUCT_FIELD(PJRT_AsyncHostToDeviceTransferManager_TransferLiteral);\n } PJRT_Api;\n \n enum {\n-  PJRT_Api_STRUCT_SIZE =\n-      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_Client_CreateErrorBuffer)\n+  PJRT_Api_STRUCT_SIZE = PJRT_STRUCT_SIZE(\n+      PJRT_Api, PJRT_AsyncHostToDeviceTransferManager_TransferLiteral)\n };\n \n #undef _PJRT_API_STRUCT_FIELD"
        },
        {
            "sha": "0a089ae0f34e38b395170866a151c828f680c8e9",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -946,6 +946,10 @@ FieldOffsetsAndSizesForVersion(int major_version, int minor_version) {\n     if (minor_version >= 82) {\n       add_field(\"PJRT_Client_CreateErrorBuffer\", kFnPtrSize);\n     }\n+    if (minor_version >= 83) {\n+      add_field(\"PJRT_AsyncHostToDeviceTransferManager_TransferLiteral\",\n+                kFnPtrSize);\n+    }\n     return version_offsets_and_sizes;\n   }\n   LOG(FATAL) << \"Unsupported API version: \" << major_version << \".\"\n@@ -1340,6 +1344,11 @@ TEST_F(PjrtCAbiTestBase, FieldOffsetsAndSizes) {\n           {\"PJRT_Client_CreateErrorBuffer\",\n            {offsetof(PJRT_Api, PJRT_Client_CreateErrorBuffer),\n             sizeof(PJRT_Api::PJRT_Client_CreateErrorBuffer)}},\n+          {\"PJRT_AsyncHostToDeviceTransferManager_TransferLiteral\",\n+           {offsetof(PJRT_Api,\n+                     PJRT_AsyncHostToDeviceTransferManager_TransferLiteral),\n+            sizeof(PJRT_Api::\n+                       PJRT_AsyncHostToDeviceTransferManager_TransferLiteral)}},\n       };\n   ASSERT_EQ(api_->pjrt_api_version.major_version, PJRT_API_MAJOR);\n   ASSERT_EQ(api_->pjrt_api_version.minor_version, PJRT_API_MINOR);"
        },
        {
            "sha": "078f16b27087f1a7bb7a4d26af33047e0380a68d",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -744,6 +744,36 @@ PJRT_Error* PJRT_AsyncHostToDeviceTransferManager_TransferData(\n   return nullptr;\n }\n \n+PJRT_Error* PJRT_AsyncHostToDeviceTransferManager_TransferLiteral(\n+    PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args* args) {\n+  PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n+      \"PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args\",\n+      PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args_STRUCT_SIZE,\n+      args->struct_size));\n+\n+  PJRT_ASSIGN_OR_RETURN(\n+      xla::Shape shape,\n+      pjrt::BuildXlaShapeFromC(args->shape_element_type, args->shape_dims,\n+                               args->shape_num_dims, args->shape_layout));\n+\n+  auto literal = std::make_unique<xla::BorrowingLiteral>(\n+      static_cast<const char*>(args->data), shape);\n+  xla::BorrowingLiteral* literal_ptr = literal.get();\n+\n+  auto [promise, future] = xla::Future<>::MakePromise();\n+  absl::AnyInvocable<void() &&> on_done_with_d2h_transfer =\n+      [promise = std::move(promise), literal = std::move(literal)]() mutable {\n+        promise.Set();\n+      };\n+\n+  PJRT_RETURN_IF_ERROR(\n+      args->transfer_manager->transfer_manager->TransferLiteralToBuffer(\n+          args->buffer_index, *literal_ptr,\n+          std::move(on_done_with_d2h_transfer)));\n+  args->done_with_h2d_transfer = new PJRT_Event{std::move(future)};\n+  return nullptr;\n+}\n+\n PJRT_Error* PJRT_AsyncHostToDeviceTransferManager_RetrieveBuffer(\n     PJRT_AsyncHostToDeviceTransferManager_RetrieveBuffer_Args* args) {\n   PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n@@ -3149,6 +3179,8 @@ PJRT_Api CreatePjrtApi(PJRT_Client_Create* create_fn,\n       pjrt::PJRT_LoadedExecutable_GetDeviceAssignment,\n       /*PJRT_Client_CreateErrorBuffer=*/\n       pjrt::PJRT_Client_CreateErrorBuffer,\n+      /*PJRT_AsyncHostToDeviceTransferManager_TransferLiteral=*/\n+      pjrt::PJRT_AsyncHostToDeviceTransferManager_TransferLiteral,\n   };\n }\n "
        },
        {
            "sha": "ee111d84b4c8bb7c06d53b624e110b397b5fda56",
            "filename": "third_party/xla/xla/pjrt/c_api_client/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2FBUILD?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -111,6 +111,7 @@ xla_cc_test(\n     ],\n     deps = [\n         \":pjrt_c_api_client\",\n+        \"//xla:future\",\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n         \"//xla:shape_util\","
        },
        {
            "sha": "3d579a45509817d17106f9ae8bfc52cd1b6bf6b7",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 4,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -1247,10 +1247,38 @@ class PjRtCApiAsyncHostToDeviceTransferManager\n   absl::Status TransferLiteralToBuffer(\n       int buffer_index, const LiteralSlice& literal,\n       absl::AnyInvocable<void() &&> on_done) override {\n-    return Unimplemented(\n-        \"PJRT C API does not support TransferLiteralToBuffer. Please report an \"\n-        \"issue at https://github.com/google/jax/issues if you need this \"\n-        \"feature.\");\n+    PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args args;\n+    args.struct_size =\n+        PJRT_AsyncHostToDeviceTransferManager_TransferLiteral_Args_STRUCT_SIZE;\n+    args.extension_start = nullptr;\n+    args.transfer_manager = c_transfer_manager_.get();\n+    args.buffer_index = buffer_index;\n+\n+    const xla::Shape& shape = literal.shape();\n+    args.shape_dims = shape.dimensions().data();\n+    args.shape_num_dims = shape.dimensions().size();\n+    args.shape_element_type =\n+        pjrt::ConvertToPjRtBufferType(shape.element_type());\n+\n+    pjrt::BufferMemoryLayoutData c_layout_data;\n+    if (shape.has_layout()) {\n+      TF_ASSIGN_OR_RETURN(\n+          c_layout_data, pjrt::ConvertToBufferMemoryLayoutData(shape.layout()));\n+      args.shape_layout = &c_layout_data.c_layout;\n+    } else {\n+      args.shape_layout = nullptr;\n+    }\n+\n+    args.data = literal.untyped_data();\n+    const PJRT_Api* api = c_client_->pjrt_c_api();\n+    RETURN_STATUS_IF_PJRT_ERROR(\n+        api->PJRT_AsyncHostToDeviceTransferManager_TransferLiteral(&args), api);\n+    std::unique_ptr<PJRT_Event, ::pjrt::PJRT_EventDeleter> event(\n+        args.done_with_h2d_transfer, ::pjrt::MakeEventDeleter(api));\n+    RETURN_STATUS_IF_PJRT_ERROR(\n+        pjrt::InvokePjRtEventWhenReady(api, event.get(), std::move(on_done)),\n+        api);\n+    return absl::OkStatus();\n   }\n \n   size_t buffer_size(int buffer_index) const override {"
        },
        {
            "sha": "3d74a142ac77f400ba7125b38c0799433f5cf1e6",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b2a47f39bcbed04951807d5cd088220c66259388/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc?ref=b2a47f39bcbed04951807d5cd088220c66259388",
            "patch": "@@ -36,6 +36,7 @@ limitations under the License.\n #include \"xla/backends/cpu/alignment.h\"\n #include \"xla/ffi/ffi.h\"\n #include \"xla/ffi/ffi_api.h\"\n+#include \"xla/future.h\"\n #include \"xla/hlo/builder/xla_builder.h\"\n #include \"xla/hlo/builder/xla_computation.h\"\n #include \"xla/hlo/parser/hlo_parser.h\"\n@@ -609,5 +610,34 @@ TEST(PjRtClientTest, BufferFromLiteralInt4) {\n               ElementsAreArray(literal.data<s4>()));\n }\n \n+TEST(PjRtCApiClientTest, AsyncHostToDeviceTransferManagerTransferLiteral) {\n+  SetUpCpuPjRtApi();\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                          GetCApiClient(\"cpu\"));\n+\n+  xla::Shape shape = xla::ShapeUtil::MakeShapeWithType<int32_t>({4});\n+  std::vector<int32_t> data = {1, 2, 3, 4};\n+  xla::Literal literal = xla::LiteralUtil::CreateR1<int32_t>(data);\n+\n+  std::vector<xla::Shape> host_shapes = {shape};\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<PjRtClient::AsyncHostToDeviceTransferManager>\n+          transfer_manager,\n+      client->CreateBuffersForAsyncHostToDevice(absl::MakeSpan(host_shapes),\n+                                                client->memory_spaces()[0]));\n+\n+  xla::Future<> future = transfer_manager->TransferLiteralToBuffer(\n+      /*buffer_index=*/0, literal, /*on_done=*/[]() {});\n+  TF_ASSERT_OK(future.Await());\n+\n+  std::unique_ptr<PjRtBuffer> buffer =\n+      transfer_manager->RetrieveBuffer(/*buffer_index=*/0);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<xla::Literal> result_literal,\n+                          buffer->ToLiteral().Await());\n+\n+  EXPECT_TRUE(LiteralTestUtil::Equal(literal, *result_literal));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 144,
        "additions": 137,
        "deletions": 7
    }
}