{
    "author": "ezhulenev",
    "message": "[xla:cpu] Improve TraceMe scopes for cpu_compiler debuggability\n\nPiperOrigin-RevId: 813761185",
    "sha": "8c728f5eaf39cdcaae4d1aab2a028fb268c2398e",
    "files": [
        {
            "sha": "9c66826947fe6dde43667e46c9eb0f3138dbc383",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8c728f5eaf39cdcaae4d1aab2a028fb268c2398e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8c728f5eaf39cdcaae4d1aab2a028fb268c2398e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=8c728f5eaf39cdcaae4d1aab2a028fb268c2398e",
            "patch": "@@ -1920,16 +1920,16 @@ CpuCompiler::CompileCpuExecutable(\n \n   VLOG(3) << \"Collected \" << compiled_symbols.size() << \" compiled symbols\";\n \n-  TraceMe trace_codegen([&] {\n-    return TraceMeEncode(\"Codegen\",\n-                         {{\"num_default_parts\", num_default_parts},\n+  TF_ASSIGN_OR_RETURN(\n+      std::unique_ptr<FunctionLibrary> function_library, std::invoke([&] {\n+        TraceMe trace_codegen([&] {\n+          return TraceMeEncode(\n+              \"Codegen\", {{\"num_default_parts\", num_default_parts},\n                           {\"num_extra_parts\", num_extra_parts},\n                           {\"num_compiled_functions\", num_compiled_functions}});\n-  });\n-\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<FunctionLibrary> function_library,\n-      std::move(*llvm_module_compiler).Compile(compiled_symbols));\n+        });\n+        return std::move(*llvm_module_compiler).Compile(compiled_symbols);\n+      }));\n \n   // Create constant allocations from the buffer assignment.\n   TF_ASSIGN_OR_RETURN(std::vector<ConstantAllocation> constants,"
        },
        {
            "sha": "132f83c5faa103546f5354d98f5ec7eeb3f4fec8",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8c728f5eaf39cdcaae4d1aab2a028fb268c2398e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8c728f5eaf39cdcaae4d1aab2a028fb268c2398e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc?ref=8c728f5eaf39cdcaae4d1aab2a028fb268c2398e",
            "patch": "@@ -227,6 +227,7 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitEntryComputation(\n \n absl::StatusOr<std::vector<ThunkEmitter::EmittedKernel>>\n ThunkEmitter::ConsumeKernels() {\n+  tsl::profiler::TraceMe trace(\"ThunkEmitter::ConsumeKernels\");\n   TF_ASSIGN_OR_RETURN(std::vector<LlvmKernelDefinition> fusion_kernels,\n                       parallel_fusion_emitter_.ConsumeKernels());\n "
        }
    ],
    "stats": {
        "total": 17,
        "additions": 9,
        "deletions": 8
    }
}