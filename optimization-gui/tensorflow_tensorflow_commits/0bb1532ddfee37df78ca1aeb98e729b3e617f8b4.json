{
    "author": "basioli-k",
    "message": "[XLA] Enable multihost runner to load unoptimized hlo snapshots dumped without custom serialization.\n\nPiperOrigin-RevId: 820643951",
    "sha": "0bb1532ddfee37df78ca1aeb98e729b3e617f8b4",
    "files": [
        {
            "sha": "f968b7d467180d94a9398b19102aa6ddd8a22554",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.cc",
            "status": "modified",
            "additions": 48,
            "deletions": 7,
            "changes": 55,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bb1532ddfee37df78ca1aeb98e729b3e617f8b4/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bb1532ddfee37df78ca1aeb98e729b3e617f8b4/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc?ref=0bb1532ddfee37df78ca1aeb98e729b3e617f8b4",
            "patch": "@@ -238,19 +238,60 @@ absl::StatusOr<HloModuleAndArguments> ReadModuleFromSnapshotBinaryProtoFile(\n   return hlo_module_and_arguments;\n }\n \n-absl::StatusOr<HloModuleAndArguments>\n-ReadModuleFromUnoptimizedSnapshotBinaryProtoFile(absl::string_view hlo_file) {\n-  HloModuleAndArguments hlo_module_and_arguments;\n-  tsl::Env* env = tsl::Env::Default();\n+namespace {\n \n+// This function reads an HloUnoptimizedSnapshot from the file at the given\n+// path.\n+// It first tries to deserialize the snapshot using custom serialization.\n+// If that fails, it falls back to standard deserialization.\n+absl::StatusOr<HloUnoptimizedSnapshot> ReadHloUnoptimizedSnapshot(\n+    absl::string_view hlo_file) {\n+  tsl::Env* env = tsl::Env::Default();\n   std::unique_ptr<tsl::RandomAccessFile> file;\n   TF_RETURN_IF_ERROR(env->NewRandomAccessFile(std::string(hlo_file), &file));\n \n-  tsl::RandomAccessFileCopyingInputStream input_stream(file.get());\n-  tsl::protobuf::io::CopyingInputStreamAdaptor adaptor(&input_stream);\n+  tsl::RandomAccessFileCopyingInputStream custom_deserialization_input_stream(\n+      file.get());\n+  tsl::protobuf::io::CopyingInputStreamAdaptor custom_deserialization_adaptor(\n+      &custom_deserialization_input_stream);\n+\n+  // Try to deserialize snapshot with custom deserialization.\n+  auto proto_or_status =\n+      DeserializeHloUnoptimizedSnapshot(&custom_deserialization_adaptor);\n+\n+  if (proto_or_status.ok()) {\n+    return proto_or_status.value();\n+  }\n+\n+  // Fallback to standard deserialization.\n+\n+  HloUnoptimizedSnapshot proto;\n+  // Fallback to standard deserialization. This requires creating a new input\n+  // stream because we need to read from the beginning of the file.\n+  tsl::RandomAccessFileCopyingInputStream fallback_input_stream(file.get());\n+  tsl::protobuf::io::CopyingInputStreamAdaptor fallback_adaptor(\n+      &fallback_input_stream);\n+  tsl::protobuf::io::CodedInputStream coded_stream(&fallback_adaptor);\n+\n+  if (!proto.ParseFromCodedStream(&coded_stream)) {\n+    return Internal(\n+        \"Failed to parse HloUnoptimizedSnapshot from the input stream with \"\n+        \"standard deserialization. Custom deserialization also failed with \"\n+        \"error: \"\n+        \"%s\",\n+        proto_or_status.status().message());\n+  }\n+  return proto;\n+}\n+\n+}  // namespace\n+\n+absl::StatusOr<HloModuleAndArguments>\n+ReadModuleFromUnoptimizedSnapshotBinaryProtoFile(absl::string_view hlo_file) {\n+  HloModuleAndArguments hlo_module_and_arguments;\n \n   TF_ASSIGN_OR_RETURN(HloUnoptimizedSnapshot proto,\n-                      DeserializeHloUnoptimizedSnapshot(&adaptor));\n+                      ReadHloUnoptimizedSnapshot(hlo_file));\n \n   TF_ASSIGN_OR_RETURN(hlo_module_and_arguments.hlo_module,\n                       CreateModuleFromProto(proto.hlo_module()));"
        },
        {
            "sha": "8e09c907e02dffd4ee28173e55142d372fe327f9",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner_test.cc",
            "status": "modified",
            "additions": 46,
            "deletions": 1,
            "changes": 47,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0bb1532ddfee37df78ca1aeb98e729b3e617f8b4/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0bb1532ddfee37df78ca1aeb98e729b3e617f8b4/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc?ref=0bb1532ddfee37df78ca1aeb98e729b3e617f8b4",
            "patch": "@@ -685,6 +685,51 @@ TEST_F(FunctionalHloRunnerTest, Sharded2DevicesHloUnoptimizedSnapshot) {\n   }\n }\n \n+TEST_F(FunctionalHloRunnerTest, ReadHloUnoptimizedSnapshotCustomSerialization) {\n+  std::string path_to_text_hlo =\n+      GetHloPath(\"sharded_unoptimized_hlo_snapshot.pbtxt\");\n+  std::string path_to_binary_hlo = tsl::io::JoinPath(\n+      std::getenv(\"TEST_UNDECLARED_OUTPUTS_DIR\"),\n+      \"sharded_unoptimized_hlo_snapshot_custom_serialization.pb\");\n+  tsl::Env* env = tsl::Env::Default();\n+\n+  // Read the text proto\n+  HloUnoptimizedSnapshot message;\n+  TF_ASSERT_OK(tsl::ReadTextProto(env, path_to_text_hlo, &message));\n+\n+  // Dump message in the custom binary format\n+  std::unique_ptr<tsl::WritableFile> file;\n+  TF_ASSERT_OK(env->NewWritableFile(path_to_binary_hlo, &file));\n+\n+  tsl::WritableFileCopyingOutputStream output(file.get());\n+\n+  tsl::protobuf::io::CopyingOutputStreamAdaptor adaptor(&output);\n+  TF_ASSERT_OK(SerializeHloUnoptimizedSnapshot(message, &adaptor));\n+  adaptor.Flush();\n+\n+  TF_ASSERT_OK(file->Close());\n+\n+  // Read HloModuleAndArguments from text dump.\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      HloModuleAndArguments hlo_module_and_arguments_from_text,\n+      FunctionalHloRunner::LoadHloModuleAndArguments(\n+          path_to_text_hlo, InputFormat::kUnoptimizedSnapshotProtoText));\n+  // Read HloModuleAndArguments from binary dump.\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      HloModuleAndArguments hlo_module_and_arguments_from_binary,\n+      FunctionalHloRunner::LoadHloModuleAndArguments(\n+          path_to_binary_hlo, InputFormat::kUnoptimizedSnapshotProtoBinary));\n+\n+  // Compare\n+  CHECK_EQ(hlo_module_and_arguments_from_binary.arguments.size(), 2);\n+\n+  CHECK_EQ(hlo_module_and_arguments_from_text.hlo_module->ToString(),\n+           hlo_module_and_arguments_from_binary.hlo_module->ToString());\n+\n+  CHECK_EQ(hlo_module_and_arguments_from_text.arguments.size(),\n+           hlo_module_and_arguments_from_binary.arguments.size());\n+}\n+\n TEST_F(FunctionalHloRunnerTest, ReadHloUnoptimizedSnapshot) {\n   std::string path_to_text_hlo =\n       GetHloPath(\"sharded_unoptimized_hlo_snapshot.pbtxt\");\n@@ -704,7 +749,7 @@ TEST_F(FunctionalHloRunnerTest, ReadHloUnoptimizedSnapshot) {\n   tsl::WritableFileCopyingOutputStream output(file.get());\n \n   tsl::protobuf::io::CopyingOutputStreamAdaptor adaptor(&output);\n-  TF_ASSERT_OK(SerializeHloUnoptimizedSnapshot(message, &adaptor));\n+  EXPECT_TRUE(message.SerializeToZeroCopyStream(&adaptor));\n   adaptor.Flush();\n \n   TF_ASSERT_OK(file->Close());"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 94,
        "deletions": 8
    }
}