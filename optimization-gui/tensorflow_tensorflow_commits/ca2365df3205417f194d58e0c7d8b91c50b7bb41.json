{
    "author": "tensorflower-gardener",
    "message": "Make ApproxTopK Op don't fail with kMhloFrontendAttributes.\n\nPiperOrigin-RevId: 822427505",
    "sha": "ca2365df3205417f194d58e0c7d8b91c50b7bb41",
    "files": [
        {
            "sha": "13d65a745d6e3e04b9fa4f45cb59258831fd9c70",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/mlir_hlo_to_hlo.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca2365df3205417f194d58e0c7d8b91c50b7bb41/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca2365df3205417f194d58e0c7d8b91c50b7bb41/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc?ref=ca2365df3205417f194d58e0c7d8b91c50b7bb41",
            "patch": "@@ -2361,7 +2361,7 @@ LogicalResult ExportXlaOp(CustomCallOp op, OpLoweringContext ctx) {\n       auto name = attr.getName();\n       return name == kCallTargetName || name == kBackendConfig ||\n              name == kApiVersion || name == kCalledComputations ||\n-             name == kHasSideEffect;\n+             name == kHasSideEffect || name == xla::kMhloFrontendAttributes;\n     };\n     for (const auto& attr : op->getAttrs()) {\n       if (!isSupportedAttrName(attr))\n@@ -4083,7 +4083,7 @@ LogicalResult ExportXlaOp(CustomCallOp op, OpLoweringContext ctx) {\n       auto name = attr.getName();\n       return name == kCallTargetName || name == kBackendConfig ||\n              name == kApiVersion || name == kCalledComputations ||\n-             name == kHasSideEffect;\n+             name == kHasSideEffect || name == xla::kMhloFrontendAttributes;\n     };\n     for (const auto& attr : op->getAttrs()) {\n       if (!isSupportedAttrName(attr))"
        },
        {
            "sha": "2b7e05c8e09c232963efed6095d9756548cc80cc",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/export.mlir",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ca2365df3205417f194d58e0c7d8b91c50b7bb41/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ca2365df3205417f194d58e0c7d8b91c50b7bb41/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir?ref=ca2365df3205417f194d58e0c7d8b91c50b7bb41",
            "patch": "@@ -906,6 +906,33 @@ func.func public @main(%arg0: tensor<16x256xbf16>, %arg1: tensor<i32>, %arg2: te\n \n // -----\n \n+// CHECK:  HloModule\n+func.func @top_k_gt_comparator(%arg0: tensor<bf16>, %arg1: tensor<bf16>, %arg2: tensor<i32>, %arg3: tensor<i32>) -> tensor<i1> {\n+  %0 = mhlo.compare  GT, %arg0, %arg1 : (tensor<bf16>, tensor<bf16>) -> tensor<i1>\n+  return %0 : tensor<i1>\n+}\n+func.func public @main(%arg0: tensor<16x256xbf16>, %arg1: tensor<i32>, %arg2: tensor<16x256xi32>, %arg3: tensor<bf16>) -> (tensor<16x4xbf16>, tensor<16x4xi32>) {\n+  %4:2 = mhlo.custom_call @ApproxTopK(%arg0, %arg2, %arg3, %arg1) {\n+    api_version = 4 : i32,\n+    called_computations = [@top_k_gt_comparator],\n+    backend_config = {\n+      aggregate_to_topk = true,\n+      recall_target = 9.492180e-01 : f32,\n+      reduction_dim = 1 : i64,\n+      reduction_input_size_override = -1 : i64,\n+      top_k = 4 : i64,\n+      is_fallback = true\n+      },\n+    mhlo.frontend_attributes = {_some_attribute = \"some_value\"}\n+    } : (tensor<16x256xbf16>, tensor<16x256xi32>, tensor<bf16>, tensor<i32>) -> (tensor<16x4xbf16>, tensor<16x4xi32>)\n+  return %4#0, %4#1 : tensor<16x4xbf16>, tensor<16x4xi32>\n+}\n+\n+// CHECK: ENTRY\n+// CHECK: frontend_attributes={_some_attribute=\"some_value\"}\n+\n+// -----\n+\n // CHECK:  HloModule\n func.func @top_k_gt_comparator(%arg0: tensor<bf16>, %arg1: tensor<bf16>, %arg2: tensor<i32>, %arg3: tensor<i32>) -> tensor<i1> {\n   %0 = mhlo.compare  GT, %arg0, %arg1 : (tensor<bf16>, tensor<bf16>) -> tensor<i1>"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 29,
        "deletions": 2
    }
}