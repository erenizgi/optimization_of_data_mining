{
    "author": "nvgrw",
    "message": "Test and fix issues with CseConstantKey.\n\nHLO CSE ConstantKey was not tested. There is at least one case where two\nConstantKeys can be equal (according to operator==) but have different hashes.\nThis change adds a test and fixes the hashing.\n\nPiperOrigin-RevId: 840802202",
    "sha": "d10f33357c20ed7709206faf81dda72e6f7c1b94",
    "files": [
        {
            "sha": "d111ef7db1d3b7d51f0f19a069922a1429d21d72",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d10f33357c20ed7709206faf81dda72e6f7c1b94/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d10f33357c20ed7709206faf81dda72e6f7c1b94/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=d10f33357c20ed7709206faf81dda72e6f7c1b94",
            "patch": "@@ -3978,6 +3978,20 @@ cc_library(\n     ],\n )\n \n+xla_cc_test(\n+    name = \"hlo_cse_constant_key_test\",\n+    srcs = [\"hlo_cse_constant_key_test.cc\"],\n+    deps = [\n+        \":hlo_cse_constant_key\",\n+        \"//xla:literal\",\n+        \"//xla:literal_util\",\n+        \"//xla:shape_util\",\n+        \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/hash:hash_testing\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n cc_library(\n     name = \"hlo_domain_map\",\n     srcs = [\"hlo_domain_map.cc\"],"
        },
        {
            "sha": "46c84ab77ea39808473ae4018e0ed6810a54cbe3",
            "filename": "third_party/xla/xla/service/hlo_cse_constant_key.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d10f33357c20ed7709206faf81dda72e6f7c1b94/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cse_constant_key.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d10f33357c20ed7709206faf81dda72e6f7c1b94/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cse_constant_key.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cse_constant_key.h?ref=d10f33357c20ed7709206faf81dda72e6f7c1b94",
            "patch": "@@ -29,6 +29,7 @@ struct CseConstantKey {\n   template <typename H>\n   friend H AbslHashValue(H h, const CseConstantKey& key) {\n     h = H::combine(std::move(h), key.domain);\n+    h = Shape::Hash<H, kIsLayoutSensitive>(std::move(h), key.shape);\n     return Literal::Hash<H, kIsLayoutSensitive, /*kByteLimit=*/64>(std::move(h),\n                                                                    key.literal);\n   }"
        },
        {
            "sha": "3b8c039445541b02e6e17380c1e2624d80f3d40c",
            "filename": "third_party/xla/xla/service/hlo_cse_constant_key_test.cc",
            "status": "added",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d10f33357c20ed7709206faf81dda72e6f7c1b94/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cse_constant_key_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d10f33357c20ed7709206faf81dda72e6f7c1b94/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cse_constant_key_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_cse_constant_key_test.cc?ref=d10f33357c20ed7709206faf81dda72e6f7c1b94",
            "patch": "@@ -0,0 +1,93 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/service/hlo_cse_constant_key.h\"\n+\n+#include <array>\n+#include <optional>\n+#include <string>\n+#include <type_traits>\n+#include <vector>\n+\n+#include <gtest/gtest.h>\n+#include \"absl/hash/hash_testing.h\"\n+#include \"xla/layout_util.h\"\n+#include \"xla/literal.h\"\n+#include \"xla/literal_util.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/tsl/platform/test.h\"\n+\n+namespace xla {\n+namespace {\n+\n+template <typename kIsLayoutSensitive>\n+class HloCseConstantKeyTest : public ::testing::Test {\n+ public:\n+  using ConstantKey = CseConstantKey<kIsLayoutSensitive::value>;\n+};\n+\n+class NameGenerator {\n+ public:\n+  template <typename T>\n+  static std::string GetName(int) {\n+    if constexpr (T::value) {\n+      return \"layout_sensitive\";\n+    }\n+    return \"not_layout_sensitive\";\n+  }\n+};\n+\n+using HloCseConstantKeyTestTypes =\n+    ::testing::Types<std::true_type, std::false_type>;\n+TYPED_TEST_SUITE(HloCseConstantKeyTest, HloCseConstantKeyTestTypes,\n+                 NameGenerator);\n+\n+TYPED_TEST(HloCseConstantKeyTest, VerifyAbslHashIsImplementedCorrectly) {\n+  using ConstantKey = typename TestFixture::ConstantKey;\n+\n+  // Values that we will combine to create the constant keys to check.\n+  // Combinations need not make inherent sense. We just want to check that\n+  // AbslHash is implemented correctly.\n+  const std::array<Literal, 3> literals = {\n+      LiteralUtil::CreateR3WithLayout({{{0.0f}}},\n+                                      LayoutUtil::MakeLayout({2, 1, 0})),\n+      LiteralUtil::CreateR3WithLayout({{{0.0f}}},\n+                                      LayoutUtil::MakeLayout({1, 2, 0})),\n+      LiteralUtil::CreateR3WithLayout({{{-0.0f}}},\n+                                      LayoutUtil::MakeLayout({1, 2, 0})),\n+  };\n+  const std::array<std::optional<Shape>, 2> shapes = {\n+      std::nullopt,  // nullopt represents the scenario where we take the shape\n+                     // of the literal rather than emulating the HLO constant\n+                     // instruction's shape.\n+      ShapeUtil::MakeShape(F32, {3, 4, 5}),\n+  };\n+  constexpr std::array<int, 3> kDomains = {0, 1, 2};\n+\n+  std::vector<ConstantKey> keys;\n+  keys.reserve(literals.size() * kDomains.size() * shapes.size());\n+  for (const Literal& literal : literals) {\n+    for (const std::optional<Shape>& shape : shapes) {\n+      for (const int domain : kDomains) {\n+        keys.push_back(ConstantKey{\n+            literal, shape.has_value() ? *shape : literal.shape(), domain});\n+      }\n+    }\n+  }\n+  EXPECT_TRUE(absl::VerifyTypeImplementsAbslHashCorrectly(keys));\n+}\n+\n+}  // namespace\n+}  // namespace xla"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 108,
        "deletions": 0
    }
}