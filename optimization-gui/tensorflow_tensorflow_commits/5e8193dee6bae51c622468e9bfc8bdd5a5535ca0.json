{
    "author": "tensorflower-gardener",
    "message": "Enable Hardware event system for Blackwell+ and cuda 12.8+\n\nPiperOrigin-RevId: 840919128",
    "sha": "5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
    "files": [
        {
            "sha": "30e6a1cfa72cb472e1c4207415fc4dfd123070db",
            "filename": "third_party/xla/xla/backends/profiler/gpu/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -865,10 +865,15 @@ xla_test(\n     size = \"small\",\n     srcs = [\"profile_with_cuda_kernels_test.cc\"],\n     args = if_google([\"--heap_check=\"]),  # There is a memory leak in CUPTI\n-    backends = [\"gpu\"],\n+    backends = [\n+        \"a100\",\n+        \"h100\",\n+        \"b200\",\n+    ],\n     tags = [\n         \"cuda-only\",\n         \"no_mac\",\n+        \"nomsan\",\n     ],\n     deps = [\n         \":cupti_collector\",\n@@ -882,5 +887,6 @@ xla_test(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/time\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_config_cuda//cuda:cuda_headers\",\n     ],\n )"
        },
        {
            "sha": "2ca18b30282bb135305c519a7569e80e951f8936",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_error_manager.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_error_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_error_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_error_manager.cc?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -65,6 +65,9 @@ void CuptiErrorManager::RegisterUndoFunction(\n CUptiResult CuptiErrorManager::ActivityDisable(CUpti_ActivityKind kind) {\n   IGNORE_CALL_IF_DISABLED;\n   CUptiResult error = interface_->ActivityDisable(kind);\n+  if (error != CUPTI_SUCCESS) {\n+    LOG(ERROR) << \"ActivityDisable() error on activity kind: \" << kind;\n+  }\n   LOG_AND_DISABLE_IF_ERROR(error);\n   return error;\n }\n@@ -75,6 +78,8 @@ CUptiResult CuptiErrorManager::ActivityEnable(CUpti_ActivityKind kind) {\n   if (error == CUPTI_SUCCESS) {\n     auto f = std::bind(&CuptiErrorManager::ActivityDisable, this, kind);\n     RegisterUndoFunction(f);\n+  } else {\n+    LOG(ERROR) << \"ActivityEnable() error on activity kind: \" << kind;\n   }\n   LOG_AND_DISABLE_IF_ERROR(error);\n   return error;\n@@ -304,6 +309,14 @@ CUptiResult CuptiErrorManager::SetThreadIdType(\n   return error;\n }\n \n+CUptiResult CuptiErrorManager::ActivityEnableHWTrace(bool enable) {\n+  IGNORE_CALL_IF_DISABLED;\n+  CUptiResult error = interface_->ActivityEnableHWTrace(enable);\n+  // Don't disable cupti just because the gpu hardware or cuda don't support\n+  // hardware event system.\n+  return error;\n+}\n+\n // Profiler Host APIs\n CUptiResult CuptiErrorManager::ProfilerHostInitialize(\n     CUpti_Profiler_Host_Initialize_Params* params) {"
        },
        {
            "sha": "ced37b538c0b469e8f2c05263268d6e426f00ef7",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_error_manager.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_error_manager.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_error_manager.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_error_manager.h?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -124,6 +124,8 @@ class CuptiErrorManager : public xla::profiler::CuptiInterface {\n \n   CUptiResult SetThreadIdType(CUpti_ActivityThreadIdType type) override;\n \n+  CUptiResult ActivityEnableHWTrace(bool enable) override;\n+\n   // Profiler Host APIs\n   CUptiResult ProfilerHostInitialize(\n       CUpti_Profiler_Host_Initialize_Params* params) override;"
        },
        {
            "sha": "b947d4f94793093073fee85bab70845aee882a4b",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_interface.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_interface.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_interface.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_interface.h?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -135,6 +135,8 @@ class CuptiInterface {\n \n   virtual CUptiResult SetThreadIdType(CUpti_ActivityThreadIdType type) = 0;\n \n+  virtual CUptiResult ActivityEnableHWTrace(bool enable) = 0;\n+\n   // Functions related to profiling APIs - range profiling, PC sampling, PM\n   // sampling Equivalent functions are declared in\n   // cuda/extras/CUPTI/include/cupti_profiler_host.h and"
        },
        {
            "sha": "cb42984230bba6dbec4d3a87857ae8ee7896c6e1",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_tracer.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -1068,6 +1068,15 @@ class CuptiDriverApiHookWithActivityApi : public CuptiDriverApiHook {\n   return absl::StrCat(tsl::port::Hostname(), \": \", error_message);\n }\n \n+const char* GetCuptiErrorString(CuptiInterface* cupti_interface,\n+                                CUptiResult err) {\n+  const char* err_str = \"ERROR-WHEN-GETTING-NAME\";\n+  if (cupti_interface != nullptr) {\n+    cupti_interface->GetResultString(err, &err_str);\n+  }\n+  return err_str;\n+}\n+\n }  // namespace\n \n CuptiTracer::CuptiTracer(CuptiInterface* cupti_interface)\n@@ -1437,6 +1446,20 @@ absl::Status CuptiTracer::EnableActivityTracing() {\n                       \"overhead may be big. CUPTI ERROR CODE:\"\n                    << err;\n     }\n+    if (option_->enable_activity_hardware_tracing) {\n+      auto err = cupti_interface_->ActivityEnableHWTrace(true);\n+      if (err == CUPTI_ERROR_NOT_SUPPORTED) {\n+        LOG(INFO)\n+            << \"CUPTI activity HW trace not enabled due to not supported on \"\n+               \"this platform!\";\n+      } else if (err != CUPTI_SUCCESS) {\n+        LOG(WARNING)\n+            << \"Fail to enable CUPTI activity HW trace, CUPTI ERROR CODE:\"\n+            << err << \" (\" << GetCuptiErrorString(cupti_interface_, err) << \")\";\n+      } else {\n+        LOG(INFO) << \"CUPTI activity HW trace successfully enabled.\";\n+      }\n+    }\n     RETURN_IF_CUPTI_ERROR(ActivityRegisterCallbacks(\n         RequestCuptiActivityBuffer, ProcessCuptiActivityBuffer));\n     VLOG(1) << \"Enabling activity tracing for \"\n@@ -1474,6 +1497,22 @@ absl::Status CuptiTracer::DisableActivityTracing() {\n     }\n     option_->activities_selected.clear();\n \n+    if (option_->enable_activity_hardware_tracing) {\n+      auto err = cupti_interface_->ActivityEnableHWTrace(false);\n+      // CUPTI_ERROR_NOT_SUPPORTED here is ok as it already handled/logged\n+      // in EnableActivityTracing.\n+      if (err == CUPTI_ERROR_NOT_SUPPORTED) {\n+        LOG(INFO) << \"CUPTI activity HW trace not disabled due to not \"\n+                     \"supported on this platform!\";\n+      } else if (err != CUPTI_SUCCESS) {\n+        LOG(WARNING)\n+            << \"Fail to disable CUPTI activity HW trace, CUPTI ERROR CODE:\"\n+            << err << \" (\" << GetCuptiErrorString(cupti_interface_, err) << \")\";\n+      } else {\n+        LOG(INFO) << \"CUPTI activity HW trace successfully disabled.\";\n+      }\n+    }\n+\n     VLOG(1) << \"Flushing CUPTI activity buffer\";\n     RETURN_IF_CUPTI_ERROR(ActivityFlushAll(CUPTI_ACTIVITY_FLAG_FLUSH_FORCED));\n     LOG(INFO) << \"CUPTI activity buffer flushed\";"
        },
        {
            "sha": "279bd8aa0d8435e6782e72ac1bb44434c82ba158",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_tracer.h",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.h?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -42,7 +42,7 @@ struct CuptiTracerOptions {\n   // We only care CUPTI_CB_DOMAIN_DRIVER_API domain for now. It is kind of\n   // redundant to have both CUPTI_CB_DOMAIN_DRIVER_API and\n   // CUPTI_CB_DOMAIN_RUNTIME_API.\n-  std::vector<CUpti_driver_api_trace_cbid_enum> cbids_selected;\n+  std::vector<CUpti_driver_api_trace_cbid_enum> cbids_selected{};\n   // Activity kinds to be collected using Activity API. If empty, the Activity\n   // API is disable.\n   std::vector<CUpti_ActivityKind> activities_selected;\n@@ -55,7 +55,12 @@ struct CuptiTracerOptions {\n   // PM sampling configuration (defaults are 2khz rate, 100ms decode)\n   // Only read during creation of a PM sampling object, later changes have\n   // no effect\n-  CuptiPmSamplerOptions pm_sampler_options;\n+  CuptiPmSamplerOptions pm_sampler_options{};\n+  // Whether to enable activity hardware events tracing using HES. see:\n+  // https://docs.nvidia.com/cupti/release-notes/release-notes.html?highlight=cuptiActivityEnableHWTrace#updates-in-cuda-12-8\n+  // This currently can not run second session with HES enabled, so do not turn\n+  // on this. TODO(b/466437495): Remove this comment once the bug is fixed.\n+  bool enable_activity_hardware_tracing = false;\n };\n \n class CuptiTracer;\n@@ -159,7 +164,7 @@ class CuptiTracer {\n   // Buffer size and alignment, 32K and 8 as in CUPTI samples.\n   static constexpr size_t kBufferSizeInBytes = 32 * 1024;\n \n-  std::unique_ptr<CuptiActivityBufferManager> activity_buffers_;\n+  std::unique_ptr<CuptiActivityBufferManager> activity_buffers_{};\n   static_assert(std::atomic<size_t>::is_always_lock_free,\n                 \"std::atomic<size_t> is not lock free! This may cause very bad\"\n                 \" profiling overhead in some circumstances.\");"
        },
        {
            "sha": "7be33dbaed2c29bb6015533cffcb4248903dbb02",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_wrapper.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper.cc?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -15,10 +15,13 @@ limitations under the License.\n \n #include \"xla/backends/profiler/gpu/cupti_wrapper.h\"\n \n+#include <cstdint>\n+\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_activity.h\"\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_profiler_target.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_result.h\"\n #include \"third_party/gpus/cuda/include/cuda.h\"\n-#include \"xla/backends/profiler/gpu/cupti_interface.h\"\n \n #if CUPTI_API_VERSION >= 24\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_pmsampling.h\"\n@@ -164,6 +167,17 @@ CUptiResult CuptiWrapper::GetStreamIdEx(CUcontext context, CUstream stream,\n   return cuptiGetStreamIdEx(context, stream, per_thread_stream, stream_id);\n }\n \n+extern \"C\" {\n+// Prototype for cuptiActivityEnableHWTrace if headers are not present.\n+[[gnu::weak]] CUptiResult cuptiActivityEnableHWTrace(uint8_t enable);\n+}  // extern \"C\"\n+\n+CUptiResult CuptiWrapper::ActivityEnableHWTrace(bool enable) {\n+  return (cuptiActivityEnableHWTrace == nullptr)\n+             ? CUPTI_ERROR_NOT_SUPPORTED\n+             : cuptiActivityEnableHWTrace(enable ? 1 : 0);\n+}\n+\n // Prototypes for PM sampling and profiler host APIs if headers are not present\n extern \"C\" {\n [[gnu::weak]] CUptiResult cuptiProfilerHostInitialize("
        },
        {
            "sha": "7541eba1271b37dbe9f226c2399de72876fe752b",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_wrapper.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper.h?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -99,6 +99,8 @@ class CuptiWrapper : public xla::profiler::CuptiInterface {\n \n   CUptiResult SetThreadIdType(CUpti_ActivityThreadIdType type) override;\n \n+  CUptiResult ActivityEnableHWTrace(bool enable) override;\n+\n   // Profiler Host APIs\n   CUptiResult ProfilerHostInitialize(\n       CUpti_Profiler_Host_Initialize_Params* params) override;\n@@ -277,6 +279,8 @@ class CuptiWrapperStub : public xla::profiler::CuptiInterface {\n \n   CUptiResult SetThreadIdType(CUpti_ActivityThreadIdType type) override;\n \n+  CUptiResult ActivityEnableHWTrace(bool enable) override;\n+\n   // Profiler Host APIs\n   CUptiResult ProfilerHostInitialize(\n       CUpti_Profiler_Host_Initialize_Params* params) override;"
        },
        {
            "sha": "3055530128f209a6d4478931f7f3f5aa72081fc5",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_wrapper_stub.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper_stub.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper_stub.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_wrapper_stub.cc?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -135,6 +135,10 @@ CUptiResult CuptiWrapperStub::SetThreadIdType(CUpti_ActivityThreadIdType type) {\n   return CUPTI_SUCCESS;\n }\n \n+CUptiResult CuptiWrapperStub::ActivityEnableHWTrace(bool enable) {\n+  return CUPTI_SUCCESS;\n+}\n+\n // Profiler Host APIs\n CUptiResult CuptiWrapperStub::ProfilerHostInitialize(\n     CUpti_Profiler_Host_Initialize_Params* params) {"
        },
        {
            "sha": "78c1eff878d387112a902484bd1254209cd81f53",
            "filename": "third_party/xla/xla/backends/profiler/gpu/device_tracer_cuda.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fdevice_tracer_cuda.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fdevice_tracer_cuda.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fdevice_tracer_cuda.cc?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -95,6 +95,11 @@ absl::Status GpuTracer::DoStart() {\n   options_.activities_selected.push_back(CUPTI_ACTIVITY_KIND_OVERHEAD);\n   options_.activities_selected.push_back(CUPTI_ACTIVITY_KIND_MEMSET);\n \n+  // TODO: Change default to true once we have more confidence in HES.\n+  ReadBoolFromEnvVar(\"TF_GPU_CUPTI_ENABLE_ACTIVITY_HW_TRACING\", false,\n+                     &options_.enable_activity_hardware_tracing)\n+      .IgnoreError();\n+\n // CUDA/CUPTI 10 have issues (leaks and crashes) with CuptiFinalize.\n #if CUDA_VERSION >= 11000\n   options_.cupti_finalize = true;"
        },
        {
            "sha": "ffebd2af423a96ab3d5d8b8bf7904901b40e1382",
            "filename": "third_party/xla/xla/backends/profiler/gpu/mock_cupti.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fmock_cupti.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fmock_cupti.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fmock_cupti.h?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -99,6 +99,8 @@ class MockCupti : public xla::profiler::CuptiInterface {\n   MOCK_METHOD(CUptiResult, SetThreadIdType, (CUpti_ActivityThreadIdType type),\n               (override));\n \n+  MOCK_METHOD(CUptiResult, ActivityEnableHWTrace, (bool enable), (override));\n+\n   MOCK_METHOD(CUptiResult, GetGraphExecId,\n               (CUgraphExec graph_exec, uint32_t* graph_id), (override));\n "
        },
        {
            "sha": "3ca82f9d92161fa433691e8027c6e1f7318772f4",
            "filename": "third_party/xla/xla/backends/profiler/gpu/profile_with_cuda_kernels_test.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 25,
            "changes": 69,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fprofile_with_cuda_kernels_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5e8193dee6bae51c622468e9bfc8bdd5a5535ca0/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fprofile_with_cuda_kernels_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fprofile_with_cuda_kernels_test.cc?ref=5e8193dee6bae51c622468e9bfc8bdd5a5535ca0",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_activity.h\"\n #include \"xla/backends/profiler/gpu/cupti_collector.h\"\n #include \"xla/backends/profiler/gpu/cupti_error_manager.h\"\n #include \"xla/backends/profiler/gpu/cupti_pm_sampler.h\"\n@@ -105,33 +106,29 @@ void HandleRecords(PmSamples* samples) {\n   }\n }\n \n-TEST(ProfilerCudaKernelSanityTest, SimpleAddSub) {\n-  // Ensure this is only run on CUPTI > 26 (paired w/ CUDA 12.6)\n-  if (CUPTI_API_VERSION < 24) {\n-    GTEST_SKIP() << \"PM Sampling not supported on this version of CUPTI\";\n-  }\n-\n+void SimpleAddSubWithProfilerTest(bool enable_activity_hardware_tracing,\n+                                  bool enable_pm_sampling) {\n   uint32_t cupti_version = 0;\n   cuptiGetVersion(&cupti_version);\n-  EXPECT_EQ(CUPTI_API_VERSION, cupti_version);\n-\n-  if (cupti_version < 24) {\n-    GTEST_SKIP() << \"PM Sampling not supported on this version of CUPTI\";\n-  }\n+  LOG(INFO) << \"RUNTIME CUPTI version \" << cupti_version\n+            << \" and CUPTI_API_VERSION \" << CUPTI_API_VERSION;\n \n-  LOG(INFO) << \"Starting PM Sampling test with CUPTI version \" << cupti_version;\n+  enable_pm_sampling =\n+      enable_pm_sampling && (cupti_version >= 24 && CUPTI_API_VERSION >= 24);\n+  LOG(INFO) << \"PM Sampling enabled: \" << enable_pm_sampling;\n \n   constexpr int kNumElements = 256 * 1024;\n \n-  CuptiTracerCollectorOptions collector_options;\n+  CuptiTracerCollectorOptions collector_options{};\n   collector_options.num_gpus = CuptiTracer::NumGpus();\n+  LOG(INFO) << \"Cupti found #gpus: \" << collector_options.num_gpus;\n   uint64_t start_walltime_ns = absl::GetCurrentTimeNanos();\n   uint64_t start_gputime_ns = CuptiTracer::GetTimestamp();\n   auto collector = CreateCuptiCollector(collector_options, start_walltime_ns,\n                                         start_gputime_ns);\n \n   CuptiPmSamplerOptions sampler_options;\n-  sampler_options.enable = true;\n+  sampler_options.enable = enable_pm_sampling;\n   // Metrics can be queried with Nsight Compute\n   // ncu --query-metrics-collection pmsampling --chip <CHIP>\n   // Any metrics marked with a particular Triage group naming should be\n@@ -141,8 +138,13 @@ TEST(ProfilerCudaKernelSanityTest, SimpleAddSub) {\n                              \"sm__inst_executed_pipe_fp64.sum\"};\n   sampler_options.process_samples = HandleRecords;\n \n-  CuptiTracerOptions tracer_options;\n+  CuptiTracerOptions tracer_options{};\n   tracer_options.enable_nvtx_tracking = false;\n+  tracer_options.activities_selected.push_back(\n+      CUPTI_ACTIVITY_KIND_CONCURRENT_KERNEL);\n+  tracer_options.enable_activity_hardware_tracing =\n+      enable_activity_hardware_tracing;\n+  tracer_options.cupti_finalize = true;\n \n   tracer_options.pm_sampler_options = sampler_options;\n \n@@ -185,19 +187,36 @@ TEST(ProfilerCudaKernelSanityTest, SimpleAddSub) {\n   EXPECT_EQ(vec.size(), kNumElements);\n   EXPECT_THAT(vec, Each(DistanceFrom(0, Lt(0.001))));\n \n-  // Expect 4 * elems / (32 elemn / warp) +- 5% double instructions\n-  // (if they were sampled)\n-  // Double this as two kernels are sampled (middle kernel is not)\n-  if (records_fp64 > 0) {\n-    LOG(INFO) << \"Sampled \" << total_fp64 << \" fp64 instructions\";\n-    double target = kNumElements * 4 * 2 / 32;\n-    EXPECT_THAT(total_fp64, DistanceFrom(target, Lt(target * 5 / 100)));\n-  }\n-  if (records_cycles > 0) {\n-    LOG(INFO) << \"Sampled \" << total_cycles << \" cycles\";\n+  if (enable_pm_sampling) {\n+    // Expect 4 * elems / (32 elemn / warp) +- 5% double instructions\n+    // (if they were sampled)\n+    // Double this as two kernels are sampled (middle kernel is not)\n+    if (records_fp64 > 0) {\n+      LOG(INFO) << \"Sampled \" << total_fp64 << \" fp64 instructions\";\n+      double target = kNumElements * 4 * 2 / 32;\n+      EXPECT_THAT(total_fp64, DistanceFrom(target, Lt(target * 5 / 100)));\n+    }\n+    if (records_cycles > 0) {\n+      LOG(INFO) << \"Sampled \" << total_cycles << \" cycles\";\n+    }\n   }\n }\n \n+TEST(ProfilerCudaKernelSanityTest, SimpleAddSubWithPMSampling) {\n+  SimpleAddSubWithProfilerTest(/*enable_activity_hardware_tracing=*/false,\n+                               /*enable_pm_sampling=*/true);\n+}\n+\n+TEST(ProfilerCudaKernelSanityTest, SimpleAddSubWithHESDisabled) {\n+  SimpleAddSubWithProfilerTest(/*enable_activity_hardware_tracing=*/false,\n+                               /*enable_pm_sampling=*/false);\n+}\n+\n+TEST(ProfilerCudaKernelSanityTest, SimpleAddSubWithHESEnabled) {\n+  SimpleAddSubWithProfilerTest(/*enable_activity_hardware_tracing=*/true,\n+                               /*enable_pm_sampling=*/false);\n+}\n+\n }  // namespace\n }  // namespace test\n }  // namespace profiler"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 145,
        "deletions": 30
    }
}