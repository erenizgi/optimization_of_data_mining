{
    "author": "GleasonK",
    "message": "[MHLO->StableHLO] Migrate kernelgen to use StableHLO->Linalg passes.\n\nAllows for deletion of MHLO->Linalg\n\nPiperOrigin-RevId: 812860062",
    "sha": "2ef289ae0a765c20c0bd5f832f33007dbdee0ed8",
    "files": [
        {
            "sha": "6147b3887404c021ca142995fddb7e20bbb24658",
            "filename": "tensorflow/compiler/mlir/tools/kernel_gen/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2ef289ae0a765c20c0bd5f832f33007dbdee0ed8/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2ef289ae0a765c20c0bd5f832f33007dbdee0ed8/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2FBUILD?ref=2ef289ae0a765c20c0bd5f832f33007dbdee0ed8",
            "patch": "@@ -99,6 +99,7 @@ cc_library(\n         \"@local_xla//xla/mlir_hlo:transforms_gpu_passes\",\n         \"@local_xla//xla/mlir_hlo:transforms_passes\",\n         \"@stablehlo//:chlo_ops\",\n+        \"@stablehlo//:linalg_passes\",\n         \"@stablehlo//:stablehlo_passes\",\n     ],\n )"
        },
        {
            "sha": "cc9153dad6e2105ea9f6d9448ffa40ce6ad81432",
            "filename": "tensorflow/compiler/mlir/tools/kernel_gen/kernel_creator.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2ef289ae0a765c20c0bd5f832f33007dbdee0ed8/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2Fkernel_creator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2ef289ae0a765c20c0bd5f832f33007dbdee0ed8/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2Fkernel_creator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2Fkernel_creator.cc?ref=2ef289ae0a765c20c0bd5f832f33007dbdee0ed8",
            "patch": "@@ -61,6 +61,7 @@ limitations under the License.\n #include \"mlir/Target/LLVMIR/Dialect/ROCDL/ROCDLToLLVMIRTranslation.h\"  // from @llvm-project\n #include \"mlir/Transforms/DialectConversion.h\"  // from @llvm-project\n #include \"mlir/Transforms/Passes.h\"  // from @llvm-project\n+#include \"stablehlo/conversions/linalg/transforms/Passes.h\"  // from @stablehlo\n #include \"stablehlo/dialect/ChloOps.h\"  // from @stablehlo\n #include \"stablehlo/transforms/Passes.h\"  // from @stablehlo\n #include \"tensorflow/compiler/mlir/tensorflow/utils/dump_mlir_util.h\"\n@@ -179,9 +180,18 @@ absl::Status LowerHlotoLoops(mlir::ModuleOp module,\n   pm.addNestedPass<FuncOp>(mlir::createCanonicalizerPass());\n   pm.addNestedPass<FuncOp>(mlir::createCSEPass());\n \n-  // Transform HLO operations to LinAlg and standard.\n-  pm.addNestedPass<FuncOp>(::mlir::mhlo::createLegalizeHloToLinalgPass());\n-  pm.addPass(::mlir::mhlo::createLegalizeToArithmeticPass());\n+  // Transform HLO operations to Linalg and standard.\n+  mlir::mhlo::HloLegalizeToStablehloPassOptions options;\n+  options.allow_xla_features_ = true;  // MinimumBroadcastOp\n+  pm.addPass(mlir::mhlo::createHloLegalizeToStablehloPass(options));\n+\n+  // Allowing implicit captures of scalar inputs causes crashes in kernelgen\n+  // JIT kernels.\n+  mlir::stablehlo::StablehloLegalizeToLinalgPassOptions linalg_options;\n+  linalg_options.captureScalarInputs = false;\n+  pm.addNestedPass<FuncOp>(\n+      mlir::stablehlo::createStablehloLegalizeToLinalgPass(linalg_options));\n+  pm.addPass(mlir::mhlo::createStablehloLegalizeToHloPass());\n \n   // Convert tensor.reshape to MHLO before running any bufferization passes.\n   // We'll need to teach this pipeline how to properly handle tensor.reshape"
        },
        {
            "sha": "c0610077b8b09e514c7cbe510f03a18e3a2d8f84",
            "filename": "tensorflow/compiler/mlir/tools/kernel_gen/tests/legalize_tensor_reshape.mlir",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2ef289ae0a765c20c0bd5f832f33007dbdee0ed8/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2Ftests%2Flegalize_tensor_reshape.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2ef289ae0a765c20c0bd5f832f33007dbdee0ed8/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2Ftests%2Flegalize_tensor_reshape.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftools%2Fkernel_gen%2Ftests%2Flegalize_tensor_reshape.mlir?ref=2ef289ae0a765c20c0bd5f832f33007dbdee0ed8",
            "patch": "@@ -0,0 +1,14 @@\n+// RUN: kernel-gen-opt --split-input-file --legalize-tensor-reshape %s | FileCheck %s\n+\n+// CHECK-LABEL: func @tanh\n+func.func @tanh(%arg0: tensor<*xf32>) -> tensor<*xf32> attributes {tf_entry} {\n+  %0 = shape.shape_of %arg0 : tensor<*xf32> -> tensor<?xindex>\n+  %1 = shape.num_elements %0 : tensor<?xindex> -> index\n+  %from_elements = tensor.from_elements %1 : tensor<1xindex>\n+  // CHECK: mhlo.dynamic_reshape\n+  // CHECK-NOT: tensor.reshape\n+  %2 = tensor.reshape %arg0(%from_elements) : (tensor<*xf32>, tensor<1xindex>) -> tensor<?xf32>\n+  %3 = mhlo.tanh %2 : tensor<?xf32>\n+  %4 = tensor.reshape %3(%0) : (tensor<?xf32>, tensor<?xindex>) -> tensor<*xf32>\n+  return %4 : tensor<*xf32>\n+}"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 28,
        "deletions": 3
    }
}