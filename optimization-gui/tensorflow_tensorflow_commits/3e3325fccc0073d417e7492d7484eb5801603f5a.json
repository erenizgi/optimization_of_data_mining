{
    "author": "thevilledev",
    "message": "PR #31888: fix: improve parsing in TextLiteralReader\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31888\n\nüìù Summary of Changes\n\n- Ignore empty or whitespace-only lines when parsing literal data in `TextLiteralReader`. Trim lines before splitting and enforce that each data line contains a colon separating coordinates and value. Return InvalidArgument when the separator is missing.\n- Add tests for whitespace-only line and for missing colon.\n\nüéØ Justification\n\n- Fixes [OSS-Fuzz finding #427934198](https://issues.oss-fuzz.com/issues/427934198), found through a Tensorflow fuzzer.\n\nüöÄ Kind of Contribution\n\n- üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\n- N/A\n\nüß™ Unit Tests:\n- Add unit tests to cover malformed input (whitespace, or missing colon). The test yields a crash + stacktrace against the `main` branch.\n- Tests run successfully with:\n\n```\ndocker exec xla bazel test \\\n  --spawn_strategy=sandboxed \\\n  --test_output=all \\\n  //xla:text_literal_reader_test\n```\n\nOutput:\n\n```\n[==========] Running 3 tests from 1 test suite.\n[----------] Global test environment set-up.\n[----------] 3 tests from TextLiteralReaderTest\n[ RUN      ] TextLiteralReaderTest.WhitespaceOnlyLineAfterShapeDoesNotCrashAndYieldsScalarNaN\n[       OK ] TextLiteralReaderTest.WhitespaceOnlyLineAfterShapeDoesNotCrashAndYieldsScalarNaN (19 ms)\n[ RUN      ] TextLiteralReaderTest.MissingColonReturnsInvalidArgument\n[       OK ] TextLiteralReaderTest.MissingColonReturnsInvalidArgument (10 ms)\n[ RUN      ] TextLiteralReaderTest.ReadsR3File\n[       OK ] TextLiteralReaderTest.ReadsR3File (1 ms)\n[----------] 3 tests from TextLiteralReaderTest (32 ms total)\n```\n\nüß™ Execution Tests:\n- N/A\n\nCopybara import of the project:\n\n--\n6fa79c5ec1702fe1e8b38c0af477b3641c0477c9 by Ville Vesilehto <ville@vesilehto.fi>:\n\nfix: improve parsing in TextLiteralReader\n\nIgnore empty or whitespace-only lines when parsing literal data.\nTrim lines before splitting and enforce that each data line contains\na colon separating coordinates and value. Return InvalidArgument when\nthe separator is missing.\n\nAdd tests for whitespace-only line and for missing colon.\n\nSigned-off-by: Ville Vesilehto <ville@vesilehto.fi>\n\nMerging this change closes #31888\n\nPiperOrigin-RevId: 813658833",
    "sha": "3e3325fccc0073d417e7492d7484eb5801603f5a",
    "files": [
        {
            "sha": "22f8bd7c9ed4465d0d1802664d2a970165c19813",
            "filename": "third_party/xla/xla/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e3325fccc0073d417e7492d7484eb5801603f5a/third_party%2Fxla%2Fxla%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e3325fccc0073d417e7492d7484eb5801603f5a/third_party%2Fxla%2Fxla%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2FBUILD?ref=3e3325fccc0073d417e7492d7484eb5801603f5a",
            "patch": "@@ -1005,6 +1005,9 @@ xla_cc_test(\n         \"//xla/hlo/testlib:test\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:test_main\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_googletest//:gtest\",\n     ],\n )"
        },
        {
            "sha": "c1641b2239b48231831612a47d3f895bfcb285ae",
            "filename": "third_party/xla/xla/text_literal_reader.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e3325fccc0073d417e7492d7484eb5801603f5a/third_party%2Fxla%2Fxla%2Ftext_literal_reader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e3325fccc0073d417e7492d7484eb5801603f5a/third_party%2Fxla%2Fxla%2Ftext_literal_reader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftext_literal_reader.cc?ref=3e3325fccc0073d417e7492d7484eb5801603f5a",
            "patch": "@@ -87,7 +87,17 @@ absl::StatusOr<Literal> TextLiteralReader::ReadAllLines() {\n   std::vector<int64_t> coordinate_values;\n   std::string line;\n   while (buf.ReadLine(&line).ok()) {\n-    pieces = absl::StrSplit(line, ':');\n+    // Ignore empty or whitespace-only lines.\n+    absl::string_view trimmed_line = absl::StripAsciiWhitespace(line);\n+    if (trimmed_line.empty()) {\n+      continue;\n+    }\n+\n+    pieces = absl::StrSplit(trimmed_line, ':');\n+    if (pieces.size() != 2) {\n+      return InvalidArgument(\n+          \"expected ':' separating coordinates and value: \\\"%s\\\"\", line);\n+    }\n     absl::string_view coordinates_string =\n         absl::StripAsciiWhitespace(pieces[0]);\n     absl::string_view value_string = absl::StripAsciiWhitespace(pieces[1]);"
        },
        {
            "sha": "b7414c87d734bd13589743acf6e9e11b9fee6507",
            "filename": "third_party/xla/xla/text_literal_reader_test.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e3325fccc0073d417e7492d7484eb5801603f5a/third_party%2Fxla%2Fxla%2Ftext_literal_reader_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e3325fccc0073d417e7492d7484eb5801603f5a/third_party%2Fxla%2Fxla%2Ftext_literal_reader_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftext_literal_reader_test.cc?ref=3e3325fccc0073d417e7492d7484eb5801603f5a",
            "patch": "@@ -15,9 +15,13 @@ limitations under the License.\n \n #include \"xla/text_literal_reader.h\"\n \n+#include <cmath>\n #include <string>\n \n #include <gtest/gtest.h>\n+#include \"absl/status/status.h\"\n+#include \"absl/status/status_matchers.h\"\n+#include \"absl/status/statusor.h\"\n #include \"xla/hlo/testlib/test.h\"\n #include \"xla/literal.h\"\n #include \"xla/shape_util.h\"\n@@ -27,6 +31,9 @@ limitations under the License.\n namespace xla {\n namespace {\n \n+using ::absl_testing::IsOk;\n+using ::absl_testing::StatusIs;\n+\n TEST(TextLiteralReaderTest, ReadsR3File) {\n   std::string contents = R\"(f32[1,2,3]\n (0,0,0): 42.5\n@@ -52,5 +59,35 @@ TEST(TextLiteralReaderTest, ReadsR3File) {\n   EXPECT_EQ(47.5, literal.Get<float>({0, 1, 2}));\n }\n \n+TEST(TextLiteralReaderTest,\n+     WhitespaceOnlyLineAfterShapeDoesNotCrashAndYieldsScalarNaN) {\n+  // Equivalent to the fuzzed input: \"f32[]\\n \"\n+  std::string contents = \"f32[]\\n \";\n+\n+  std::string fname =\n+      tsl::testing::TmpDir() + \"/WhitespaceOnlyAfterShape.data.txt\";\n+  ASSERT_THAT(tsl::WriteStringToFile(tsl::Env::Default(), fname, contents),\n+              IsOk());\n+\n+  absl::StatusOr<Literal> literal = TextLiteralReader::ReadPath(fname);\n+  EXPECT_THAT(literal, IsOk());\n+  EXPECT_TRUE(\n+      ShapeUtil::Equal(ShapeUtil::MakeShape(F32, {}), literal->shape()));\n+  float value = literal->Get<float>({});\n+  EXPECT_TRUE(std::isnan(value));\n+}\n+\n+TEST(TextLiteralReaderTest, MissingColonReturnsInvalidArgument) {\n+  std::string contents = R\"(f32[1]\n+ (0) 1.0\n+)\";\n+\n+  std::string fname = tsl::testing::TmpDir() + \"/MissingColon.data.txt\";\n+  ASSERT_THAT(tsl::WriteStringToFile(tsl::Env::Default(), fname, contents),\n+              IsOk());\n+  absl::StatusOr<Literal> literal = TextLiteralReader::ReadPath(fname);\n+  EXPECT_THAT(literal, StatusIs(absl::StatusCode::kInvalidArgument));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 51,
        "deletions": 1
    }
}