{
    "author": "tensorflower-gardener",
    "message": "Do not use no_duplicate for F32 sort key data\n\nPiperOrigin-RevId: 814081278",
    "sha": "b79d9f6e3154f28cd27694a89a09314681c86e78",
    "files": [
        {
            "sha": "8f1ff45fabc1069b0de8efd25b85329eb645637e",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b79d9f6e3154f28cd27694a89a09314681c86e78/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b79d9f6e3154f28cd27694a89a09314681c86e78/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=b79d9f6e3154f28cd27694a89a09314681c86e78",
            "patch": "@@ -58,12 +58,14 @@ cc_library(\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n         \"//xla:shape_util\",\n+        \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/hlo/analysis:hlo_dataflow_analysis\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/service:hlo_verifier\",\n         \"//xla/service:transfer_manager\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/types:span\",\n         \"@local_tsl//tsl/platform:protobuf\","
        },
        {
            "sha": "413d918796ee1e142cc219dcea08eced4310752e",
            "filename": "third_party/xla/xla/tests/test_utils.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b79d9f6e3154f28cd27694a89a09314681c86e78/third_party%2Fxla%2Fxla%2Ftests%2Ftest_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b79d9f6e3154f28cd27694a89a09314681c86e78/third_party%2Fxla%2Fxla%2Ftests%2Ftest_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Ftest_utils.cc?ref=b79d9f6e3154f28cd27694a89a09314681c86e78",
            "patch": "@@ -25,13 +25,20 @@ limitations under the License.\n #include <utility>\n \n #include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/hlo/analysis/hlo_dataflow_analysis.h\"\n #include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n+#include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/primitive_util.h\"\n #include \"xla/service/hlo_verifier.h\"\n #include \"xla/service/transfer_manager.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n+#include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -251,7 +258,11 @@ absl::StatusOr<Literal> CreateLiteralForConstrainedUses(\n         break;\n \n       case HloOpcode::kSort:\n-        no_duplicates = true;\n+        if (ShapeUtil::ElementIsIntegral(use->operand(0)->shape())) {\n+          // Turn on no_duplicates for integer keys. It's basically shuffled\n+          // iota from [0, N) for unsigned, or [-N/2, N/2) for signed.\n+          no_duplicates = true;\n+        }\n         break;\n \n       default:"
        },
        {
            "sha": "265ff894dc2f9051b04bd21679cce9a770a72367",
            "filename": "third_party/xla/xla/tests/test_utils_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 62,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b79d9f6e3154f28cd27694a89a09314681c86e78/third_party%2Fxla%2Fxla%2Ftests%2Ftest_utils_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b79d9f6e3154f28cd27694a89a09314681c86e78/third_party%2Fxla%2Fxla%2Ftests%2Ftest_utils_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Ftest_utils_test.cc?ref=b79d9f6e3154f28cd27694a89a09314681c86e78",
            "patch": "@@ -116,37 +116,6 @@ TEST_F(TestUtilsTest, MultipleIndexSpacesForDynamicUpdateSlices) {\n   EXPECT_LE(args[2].Get<int32_t>({}), 3);\n }\n \n-TEST_F(TestUtilsTest, NoDuplicatesFloats) {\n-  // Inputs which are sort keys in key/value sorts should have no duplicates.\n-  auto module = ParseAndReturnVerifiedModule(R\"(\n-HloModule sort.148.1589\n-\n-compare {\n-  p.0.lhs = f32[] parameter(0)\n-  p.0.rhs = f32[] parameter(1)\n-  p.1.lhs = s32[] parameter(2)\n-  p.1.rhs = s32[] parameter(3)\n-  ROOT lt = pred[] compare(p.0.lhs, p.0.rhs), direction=LT\n-}\n-\n-ENTRY %sort.148.1589 (parameter.0: f32[1048576], parameter.1: s32[1048576]) -> (f32[1048576], s32[1048576]) {\n-  %parameter.0 = f32[1048576]{0} parameter(0)\n-  %parameter.1 = s32[1048576]{0} parameter(1)\n-  ROOT %sort.148.1589 = (f32[1048576]{0}, s32[1048576]{0}) sort(f32[1048576]{0} %parameter.0, s32[1048576]{0} %parameter.1), dimensions={0}, to_apply=compare\n-}\n-)\")\n-                    .value();\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> args,\n-                          MakeFakeArguments(module.get()));\n-  ASSERT_EQ(args.size(), 2);\n-  const Literal& key_arg = args[0];\n-\n-  absl::flat_hash_set<uint32_t> key_set;\n-  for (const float& value : key_arg.data<float>()) {\n-    EXPECT_TRUE(key_set.insert(absl::bit_cast<uint32_t>(value)).second);\n-  }\n-}\n-\n TEST_F(TestUtilsTest, NoDuplicatesInt32) {\n   // Inputs which are sort keys in key/value sorts should have no duplicates.\n   auto module = ParseAndReturnVerifiedModule(R\"(\n@@ -178,37 +147,6 @@ ENTRY %sort.148.1589 (parameter.0: s32[1048576], parameter.1: s32[1048576]) -> (\n   }\n }\n \n-TEST_F(TestUtilsTest, NoDuplicatesBfloat16) {\n-  // Inputs which are sort keys in key/value sorts should have no duplicates.\n-  auto module = ParseAndReturnVerifiedModule(R\"(\n-HloModule sort, is_scheduled=true\n-\n-compare {\n-  p.0.lhs = bf16[] parameter(0)\n-  p.0.rhs = bf16[] parameter(1)\n-  p.1.lhs = s32[] parameter(2)\n-  p.1.rhs = s32[] parameter(3)\n-  ROOT lt = pred[] compare(p.0.lhs, p.0.rhs), direction=LT\n-}\n-\n-ENTRY %sort. (parameter.0: bf16[2,1452], parameter.1: s32[2,1452]) -> (bf16[2,1452], s32[2,1452]) {\n-  %parameter.0 = bf16[2,1452]{1,0} parameter(0)\n-  %parameter.1 = s32[2,1452]{1,0} parameter(1)\n-  ROOT %sort = (bf16[2,1452]{1,0}, s32[2,1452]{1,0}) sort(bf16[2,1452]{1,0} %parameter.0, s32[2,1452]{1,0} %parameter.1), dimensions={1}, to_apply=compare\n-}\n-)\")\n-                    .value();\n-  TF_ASSERT_OK_AND_ASSIGN(std::vector<Literal> args,\n-                          MakeFakeArguments(module.get()));\n-  ASSERT_EQ(args.size(), 2);\n-  const Literal& key_arg = args[0];\n-\n-  absl::flat_hash_set<uint16_t> key_set;\n-  for (const bfloat16& value : key_arg.data<bfloat16>()) {\n-    EXPECT_TRUE(key_set.insert(absl::bit_cast<uint16_t>(value)).second);\n-  }\n-}\n-\n TEST_F(TestUtilsTest, MakeFakeArgumentsR0InputToDynamicSlice) {\n   auto module = ParseAndReturnVerifiedModule(R\"(\n HloModule Test"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 14,
        "deletions": 63
    }
}