{
    "author": "alekstheod",
    "message": "PR #33897: [ROCm] Make rbe amdgpu pools configurable\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33897\n\nüìù Summary of Changes\nMaking ROCm rbe amdgpu pool name for tests configurable.\nPreparation for rbe with different gpu archs\n\nüéØ Justification\nWe pass the environment variable that sets the rbe gpu pool name set dynamically.\nThis is needed to execute some builds on a certain gpu arch rbe pool. Especially\nrelevant for hermetic builds where the rocm provided supports a single archictecture.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply:\n‚ú® New Feature\n\nüìä Benchmark (for Performance Improvements)\nNot relevant, rbe setup\n\nüß™ Unit Tests:\nNot relevant, rbe setup\n\nüß™ Execution Tests:\nNot relevant, rbe setup\n\nCopybara import of the project:\n\n--\na92c11cd76f496e99398cc1123096caa12524743 by Alexandros Theodoridis <atheodor@amd.com>:\n\nMake rbe amdgpu pools configurable\n\n--\nf18b3ef3429f35b08b0901c6586f8cfb4d2f97c8 by Alexandros Theodoridis <atheodor@amd.com>:\n\nTrigger CI/CD pipeline\n\nMerging this change closes #33897\n\nPiperOrigin-RevId: 836556731",
    "sha": "84f74d8598509c779eff88742ada7b1661c638b7",
    "files": [
        {
            "sha": "a690f767d8dbd54f71eb66b429fd7659add2bd8e",
            "filename": "third_party/xla/third_party/gpus/rocm/build_defs.bzl.tpl",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84f74d8598509c779eff88742ada7b1661c638b7/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Fbuild_defs.bzl.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84f74d8598509c779eff88742ada7b1661c638b7/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Fbuild_defs.bzl.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Fbuild_defs.bzl.tpl?ref=84f74d8598509c779eff88742ada7b1661c638b7",
            "patch": "@@ -81,3 +81,6 @@ def rocm_library(copts = [], deps = [], **kwargs):\n     if \"@local_config_rocm//rocm:rocm_headers\" not in deps:\n       deps.append(\"@local_config_rocm//rocm:rocm_headers\")\n     native.cc_library(copts = rocm_default_copts() + copts, deps = deps, **kwargs)\n+\n+def get_rbe_amdgpu_pool(is_single_gpu = False):\n+    return \"%{single_gpu_rbe_pool}\" if is_single_gpu else \"%{multi_gpu_rbe_pool}\""
        },
        {
            "sha": "2679e2e0447a448be12cfb9e6f3b99a8f6783de1",
            "filename": "third_party/xla/third_party/gpus/rocm_configure.bzl",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84f74d8598509c779eff88742ada7b1661c638b7/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84f74d8598509c779eff88742ada7b1661c638b7/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl?ref=84f74d8598509c779eff88742ada7b1661c638b7",
            "patch": "@@ -9,6 +9,9 @@\n     host code compilation if TF_ROCM_CLANG is 1.\n   * `ROCM_PATH`: The path to the ROCm toolkit. Default is `/opt/rocm`.\n   * `TF_ROCM_AMDGPU_TARGETS`: The AMDGPU targets.\n+  * `TF_ROCM_RBE_DOCKER_IMAGE`: Docker image to be used in rbe worker to execute the action\n+  * `TF_ROCM_RBE_SINGLE_GPU_POOL`: The name of the rbe pool used to execute single gpu tests\n+  * `TF_ROCM_RBE_MULTI_GPU_POOL`: The name of the rbe pool used to execute multi gpu tests\n \"\"\"\n \n load(\"@bazel_skylib//lib:paths.bzl\", \"paths\")\n@@ -56,6 +59,10 @@ _TMPDIR = \"TMPDIR\"\n _DEFAULT_ROCM_TOOLKIT_PATH = \"/opt/rocm\"\n _TF_ROCM_MULTIPLE_PATHS = \"TF_ROCM_MULTIPLE_PATHS\"\n _TF_ROCM_RBE_DOCKER_IMAGE = \"TF_ROCM_RBE_DOCKER_IMAGE\"\n+_TF_ROCM_RBE_SINGLE_GPU_POOL = \"TF_ROCM_RBE_SINGLE_GPU_POOL\"\n+_TF_ROCM_RBE_MULTI_GPU_POOL = \"TF_ROCM_RBE_MULTI_GPU_POOL\"\n+_DEFAULT_TF_ROCM_RBE_SINGLE_GPU_POOL = \"linux_x64_gpu\"\n+_DEFAULT_TF_ROCM_RBE_MULTI_GPU_POOL = \"linux_x64_multigpu\"\n \n # rocm/tensorflow-build:latest-jammy-python3.11-rocm7.0.2\n _DEFAULT_TF_ROCM_RBE_DOCKER_IMAGE = \"rocm/tensorflow-build@sha256:a2672ff2510b369b4a5f034272a518dc93c2e492894e3befaeef19649632ccaa\"\n@@ -435,6 +442,8 @@ def _create_dummy_repository(repository_ctx):\n             \"%{rocm_gpu_architectures}\": \"[]\",\n             \"%{rocm_version_number}\": \"0\",\n             \"%{rocm_hipblaslt}\": \"False\",\n+            \"%{single_gpu_rbe_pool}\": repository_ctx.os.environ.get(_TF_ROCM_RBE_SINGLE_GPU_POOL, _DEFAULT_TF_ROCM_RBE_SINGLE_GPU_POOL),\n+            \"%{multi_gpu_rbe_pool}\": repository_ctx.os.environ.get(_TF_ROCM_RBE_MULTI_GPU_POOL, _DEFAULT_TF_ROCM_RBE_MULTI_GPU_POOL),\n         },\n     )\n     _tpl(\n@@ -619,6 +628,8 @@ def _create_local_rocm_repository(repository_ctx):\n                 repository_ctx,\n                 rocm_config.amdgpu_targets,\n             ),\n+            \"%{single_gpu_rbe_pool}\": repository_ctx.os.environ.get(_TF_ROCM_RBE_SINGLE_GPU_POOL, _DEFAULT_TF_ROCM_RBE_SINGLE_GPU_POOL),\n+            \"%{multi_gpu_rbe_pool}\": repository_ctx.os.environ.get(_TF_ROCM_RBE_MULTI_GPU_POOL, _DEFAULT_TF_ROCM_RBE_MULTI_GPU_POOL),\n             \"%{rocm_gpu_architectures}\": str(rocm_config.amdgpu_targets),\n             \"%{rocm_version_number}\": str(rocm_version_number),\n             \"%{rocm_hipblaslt}\": \"True\",\n@@ -845,6 +856,8 @@ _ENVIRONS = [\n     _TF_ROCM_AMDGPU_TARGETS,\n     _ROCM_DISTRO_VERSION,\n     _TF_ROCM_RBE_DOCKER_IMAGE,\n+    _TF_ROCM_RBE_SINGLE_GPU_POOL,\n+    _TF_ROCM_RBE_MULTI_GPU_POOL,\n     _TF_ROCM_MULTIPLE_PATHS,\n ]\n "
        },
        {
            "sha": "546f16a8979550f885760e66af25fa7f7b11782b",
            "filename": "third_party/xla/xla/tsl/platform/default/build_config_root.bzl",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84f74d8598509c779eff88742ada7b1661c638b7/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fbuild_config_root.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84f74d8598509c779eff88742ada7b1661c638b7/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fbuild_config_root.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fbuild_config_root.bzl?ref=84f74d8598509c779eff88742ada7b1661c638b7",
            "patch": "@@ -5,7 +5,7 @@ be separate to avoid cyclic references.\n \"\"\"\n \n load(\"@local_config_remote_execution//:remote_execution.bzl\", \"gpu_test_tags\")\n-load(\"@local_config_rocm//rocm:build_defs.bzl\", \"is_rocm_configured\")\n+load(\"@local_config_rocm//rocm:build_defs.bzl\", \"get_rbe_amdgpu_pool\", \"is_rocm_configured\")\n load(\"//third_party/py/rules_pywrap:pywrap.default.bzl\", \"use_pywrap_rules\")\n load(\"//xla/tsl:package_groups.bzl\", \"DEFAULT_LOAD_VISIBILITY\")\n load(\"//xla/tsl/platform/default:cuda_build_defs.bzl\", \"is_cuda_configured\")\n@@ -20,11 +20,11 @@ GPU_TEST_PROPERTIES = {\n }\n \n ROCM_SINGLE_GPU_TEST_PROPERTIES = {\n-    \"test.Pool\": \"linux_x64_gpu\",\n+    \"test.Pool\": get_rbe_amdgpu_pool(is_single_gpu = True),\n }\n \n ROCM_MULTI_GPU_TEST_PROPERTIES = {\n-    \"test.Pool\": \"linux_x64_multigpu\",\n+    \"test.Pool\": get_rbe_amdgpu_pool(is_single_gpu = False),\n }\n \n def tf_gpu_tests_tags():"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 19,
        "deletions": 3
    }
}