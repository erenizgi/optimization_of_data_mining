{
    "author": "subhankarshah",
    "message": "[XLA:MSA] BlockPrefetching: Test low concurrent prefetching limit. Fix the failure condition to fail the edge case when concurrent prefetches is equal to the allowed prefetching limit.\n\nPiperOrigin-RevId: 808420734",
    "sha": "ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61",
    "files": [
        {
            "sha": "3b057eaa8925a171f0bd6dbc88988c670dd60872",
            "filename": "third_party/xla/xla/service/memory_space_assignment/algorithm.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc?ref=ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61",
            "patch": "@@ -2232,14 +2232,15 @@ void MsaAlgorithm::ProcessBlockPrefetches() {\n         std::upper_bound(prefetch_end_times.begin(), prefetch_end_times.end(),\n                          start_time) -\n         prefetch_end_times.begin();\n-    int64_t n_in_flight_prefetches =\n+    int64_t n_prefetches_already_in_flight =\n         n_prefetches_scheduled - n_prefetches_finished;\n \n-    if (n_in_flight_prefetches > max_in_flight_prefetches_allowed) {\n+    if (n_prefetches_already_in_flight >= max_in_flight_prefetches_allowed) {\n       LOG(WARNING)\n           << \"block prefetched value exceeds max prefetches in flight: \"\n           << maybe_sliced_value->defining_position().ToString() << \" \"\n-          << n_in_flight_prefetches << \" \" << max_in_flight_prefetches_allowed;\n+          << n_prefetches_already_in_flight << \" \"\n+          << max_in_flight_prefetches_allowed;\n       continue;\n     }\n "
        },
        {
            "sha": "91a774d899240bebe1f83dd8550e843f148a47ce",
            "filename": "third_party/xla/xla/service/memory_space_assignment/memory_space_assignment_test.cc",
            "status": "modified",
            "additions": 86,
            "deletions": 0,
            "changes": 86,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc?ref=ae1c3ad5428bc0fa727e10d93c5913f49b6e8d61",
            "patch": "@@ -14676,6 +14676,92 @@ ENTRY entry {\n             kDefaultMemorySpace);\n }\n \n+TEST_F(MemorySpaceAssignmentTest, TestBlockPrefetchingLowConcurrentPrefetches) {\n+  // The size of alternate memory allows for 4 concurrent block prefetches but\n+  // the maximum number of concurrent block prefetches allowed is 2.\n+  absl::string_view hlo_string = R\"(\n+HloModule module, is_scheduled=true\n+\n+ENTRY entry {\n+  p0 = f32[2,3]{1,0} parameter(0)\n+  p1 = f32[2,3]{1,0} parameter(1)\n+  p2 = f32[2,3]{1,0} parameter(2)\n+  p3 = f32[2,3]{1,0} parameter(3)\n+  p4 = f32[2,3]{1,0} parameter(4)\n+  p5 = f32[2,3]{1,0} parameter(5)\n+  negate0 = f32[2,3]{1,0} negate(p0)\n+  negate1 = f32[2,3]{1,0} negate(negate0)\n+  negate2 = f32[2,3]{1,0} negate(negate1)\n+  add3 = f32[2,3]{1,0} add(p1, negate2)\n+  negate4 = f32[2,3]{1,0} negate(add3)\n+  negate5 = f32[2,3]{1,0} negate(negate4)\n+  add6 = f32[2,3]{1,0} add(p2, negate5)\n+  negate7 = f32[2,3]{1,0} negate(add6)\n+  negate8 = f32[2,3]{1,0} negate(negate7)\n+  add9 = f32[2,3]{1,0} add(p3, negate8)\n+  negate10 = f32[2,3]{1,0} negate(add9)\n+  negate11 = f32[2,3]{1,0} negate(negate10)\n+  add12 = f32[2,3]{1,0} add(p4, negate11)\n+  add13 = f32[2,3]{1,0} add(p0, add12)\n+  add14 = f32[2,3]{1,0} add(p1, add13)\n+  ROOT add15 = f32[2,3]{1,0} add(p5, add14)\n+})\";\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  Options memory_space_options = DefaultMemorySpaceOptions();\n+  memory_space_options.max_size_in_bytes = 96;\n+  memory_space_options.reserved_bytes_for_block_prefetches = 96;\n+\n+  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n+  HloPosition p0_position{p0, {}};\n+  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n+  HloPosition p1_position{p1, {}};\n+  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n+  HloPosition p2_position{p2, {}};\n+  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n+  HloPosition p3_position{p3, {}};\n+  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n+  HloPosition p4_position{p4, {}};\n+  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n+  HloPosition p5_position{p5, {}};\n+  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n+                                                     p3_position, p2_position,\n+                                                     p1_position, p0_position};\n+  memory_space_options.max_outstanding_block_prefetches = 2;\n+  memory_space_options.max_outstanding_prefetches = 0;\n+  XLA_LOG_LINES(INFO, \"Before MSA: \\n\" + module->ToString());\n+  AssignMemorySpaceUsingCostAnalysis(module.get(), memory_space_options);\n+  XLA_LOG_LINES(INFO, \"After MSA: \\n\" + module->ToString());\n+\n+  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n+  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n+  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add13 = FindInstruction(module.get(), \"add13\");\n+  EXPECT_EQ(add13->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+  HloInstruction* add14 = FindInstruction(module.get(), \"add14\");\n+  EXPECT_EQ(add14->operand(0)->shape().layout().memory_space(),\n+            kAlternateMemorySpace);\n+\n+  // The following operands are not prefetched because the prefetches are\n+  // limited to 2 concurrent prefetches.\n+  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n+  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n+            kDefaultMemorySpace);\n+  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n+  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n+            kDefaultMemorySpace);\n+  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n+  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n+            kDefaultMemorySpace);\n+  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n+  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n+            kDefaultMemorySpace);\n+}\n+\n TEST_F(MemorySpaceAssignmentTest, TestSingleBufferedBlockPrefetching) {\n   absl::string_view hlo_string = R\"(\n HloModule module, is_scheduled=true"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 90,
        "deletions": 3
    }
}