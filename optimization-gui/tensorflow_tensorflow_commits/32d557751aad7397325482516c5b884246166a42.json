{
    "author": "bhatuzdaname",
    "message": "Refactor HloDCE to use a setter for removing dead entry parameters.\n\nRemoves `remove_dead_parameters_from_entry_computation` from the HloDCE constructor in favor of an explicit setter. This option is risky in production, so moving it ensures a safe default and prevents accidental enablement via constructor arguments.\n\nPiperOrigin-RevId: 837209570",
    "sha": "32d557751aad7397325482516c5b884246166a42",
    "files": [
        {
            "sha": "bec84edb975775855becc3de99c87866f7a3f10c",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/hlo_dce.h",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/32d557751aad7397325482516c5b884246166a42/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/32d557751aad7397325482516c5b884246166a42/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce.h?ref=32d557751aad7397325482516c5b884246166a42",
            "patch": "@@ -39,17 +39,11 @@ namespace xla {\n // to do so if the graph is not inlined.\n class HloDCE : public HloModulePass {\n  public:\n-  // If `remove_dead_parameters_from_entry_computation` is true, then this pass\n-  // will remove dead parameters from the entry computation and update the entry\n-  // computation layout of the module.\n   explicit HloDCE(bool remove_cross_partition_collective_ops = false,\n-                  bool use_call_analysis = false,\n-                  bool remove_dead_parameters_from_entry_computation = false)\n+                  bool use_call_analysis = false)\n       : remove_cross_partition_collective_ops_(\n             remove_cross_partition_collective_ops),\n-        use_call_analysis_(use_call_analysis),\n-        remove_dead_parameters_from_entry_computation_(\n-            remove_dead_parameters_from_entry_computation) {}\n+        use_call_analysis_(use_call_analysis) {}\n   ~HloDCE() override {}\n   absl::string_view name() const override { return \"dce\"; }\n \n@@ -63,6 +57,16 @@ class HloDCE : public HloModulePass {\n       CallGraph* call_graph = nullptr,\n       bool remove_dead_parameters_from_entry_computation = false);\n \n+  // If `remove_dead_parameters_from_entry_computation` is true, then this pass\n+  // will remove dead parameters from the entry computation and update the entry\n+  // computation layout of the module.\n+  // Note: The caller needs to be aware of the entry computation layout changes.\n+  void set_remove_dead_parameters_from_entry_computation(\n+      bool remove_dead_parameters_from_entry_computation) {\n+    remove_dead_parameters_from_entry_computation_ =\n+        remove_dead_parameters_from_entry_computation;\n+  }\n+\n  protected:\n   // Run the pass on the given module. Returns whether the module was changed\n   // (instructions were removed).\n@@ -73,7 +77,7 @@ class HloDCE : public HloModulePass {\n  private:\n   bool remove_cross_partition_collective_ops_;\n   bool use_call_analysis_;\n-  bool remove_dead_parameters_from_entry_computation_;\n+  bool remove_dead_parameters_from_entry_computation_ = false;\n };\n \n }  // namespace xla"
        },
        {
            "sha": "b04d6ee1b2aaf5168fcd9b2c5adba69db1f17aa6",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/hlo_dce_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/32d557751aad7397325482516c5b884246166a42/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/32d557751aad7397325482516c5b884246166a42/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fhlo_dce_test.cc?ref=32d557751aad7397325482516c5b884246166a42",
            "patch": "@@ -998,9 +998,8 @@ ENTRY entry_computation {\n   EXPECT_EQ(computation->instruction_count(), 4);\n   EXPECT_EQ(module->entry_computation_layout().parameter_count(), 3);\n \n-  HloDCE dce(/*remove_cross_partition_collective_ops=*/false,\n-             /*use_call_analysis=*/false,\n-             /*remove_dead_parameters_from_entry_computation=*/true);\n+  HloDCE dce;\n+  dce.set_remove_dead_parameters_from_entry_computation(true);\n   EXPECT_TRUE(dce.Run(module.get()).value());\n \n   EXPECT_EQ(computation->num_parameters(), 2);"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 15,
        "deletions": 12
    }
}