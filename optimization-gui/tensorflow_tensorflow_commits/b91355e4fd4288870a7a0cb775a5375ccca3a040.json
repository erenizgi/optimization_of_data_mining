{
    "author": "ScXfjiang",
    "message": "PR #31386: [ROCm] fix hardcoded properties for rocm\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31386\n\nThis PR fixes some hardcoded properties for the ROCm platform.\nCopybara import of the project:\n\n--\n9d0207080bb4e5c75ae3853115e37fba5149947a by scxfjiang <xuefei.jiang@amd.com>:\n\nfix hardcoded properties for rocm\n\n--\n1faf4217dede27c785e91bcf7e78130081989f70 by scxfjiang <xuefei.jiang@amd.com>:\n\nupdate\n\nMerging this change closes #31386\n\nPiperOrigin-RevId: 814150861",
    "sha": "b91355e4fd4288870a7a0cb775a5375ccca3a040",
    "files": [
        {
            "sha": "5db217980de522c17076d322256e5cdcba3af4f2",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_executor.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b91355e4fd4288870a7a0cb775a5375ccca3a040/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_executor.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b91355e4fd4288870a7a0cb775a5375ccca3a040/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_executor.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_executor.cc?ref=b91355e4fd4288870a7a0cb775a5375ccca3a040",
            "patch": "@@ -312,6 +312,11 @@ absl::Status GetGridLimits(int* x, int* y, int* z, hipDevice_t device) {\n   return absl::OkStatus();\n }\n \n+absl::StatusOr<int64_t> GetMaxRegistersPerMultiprocessor(hipDevice_t device) {\n+  return GetSimpleAttribute<int64_t>(\n+      device, hipDeviceAttributeMaxRegistersPerMultiprocessor);\n+}\n+\n // Returns the device associated with the given device_ordinal.\n absl::StatusOr<hipDevice_t> GetDevice(int device_ordinal) {\n   hipDevice_t device;\n@@ -400,6 +405,14 @@ std::string GetPCIBusID(hipDevice_t device) {\n   return pci_bus_id;\n }\n \n+absl::StatusOr<bool> IsEccEnabled(hipDevice_t device) {\n+  int value = 0;\n+  TF_RETURN_IF_ERROR(ToStatus(\n+      wrap::hipDeviceGetAttribute(&value, hipDeviceAttributeEccEnabled, device),\n+      \"hipDeviceGetAttribute(hipDeviceAttributeEccEnabled) failed\"));\n+  return value != 0;\n+}\n+\n bool GetDeviceProperties(hipDeviceProp_t* device_properties,\n                          int device_ordinal) {\n   hipError_t res =\n@@ -1108,8 +1121,15 @@ RocmExecutor::CreateDeviceDescription(int device_ordinal) {\n     desc.set_l2_cache_size(prop.l2CacheSize);\n   }\n \n-  // No way to query ECC status from the API.\n-  desc.set_ecc_enabled(false);\n+  {\n+    auto ecc_enabled_or = IsEccEnabled(device);\n+    if (!ecc_enabled_or.ok()) {\n+      LOG(ERROR) << \"Device \" << device_ordinal\n+                 << \": ECC status query failed: \" << ecc_enabled_or.status();\n+      return ecc_enabled_or.status();\n+    }\n+    desc.set_ecc_enabled(*ecc_enabled_or);\n+  }\n \n   uint64_t device_memory_size = -1;\n   (void)RocmContext::GetDeviceTotalMemory(device, &device_memory_size);\n@@ -1147,7 +1167,11 @@ RocmExecutor::CreateDeviceDescription(int device_ordinal) {\n       GetMaxThreadsPerMultiprocessor(device).value());\n   desc.set_registers_per_block_limit(GetMaxRegistersPerBlock(device).value());\n   desc.set_threads_per_warp(GetThreadsPerWarp(device).value());\n-  desc.set_registers_per_core_limit(64 * 1024);\n+  {\n+    TF_ASSIGN_OR_RETURN(int64_t regs_per_mp,\n+                        GetMaxRegistersPerMultiprocessor(device));\n+    desc.set_registers_per_core_limit(regs_per_mp);\n+  }\n   desc.set_compile_time_toolkit_version(\n       SemanticVersion{HIP_VERSION_MAJOR, HIP_VERSION_MINOR, HIP_VERSION_PATCH});\n   int32_t runtime_version;"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 27,
        "deletions": 3
    }
}