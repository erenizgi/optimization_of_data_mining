{
    "author": "beckerhe",
    "message": "Fix protobuf dependencies in OSS\n\nSince the builtin proto targets that come with the protobuf package are now supported in OSS, we can get rid of the `if_google` guards.\n\nAlso we will need these explicit dependencies in OSS for the layering check.\n\nPiperOrigin-RevId: 837119260",
    "sha": "689b02eb0a4966f894bf637674ea7b8f0fce2084",
    "files": [
        {
            "sha": "3fdb4311d477e383542f00e0753edd8ededce1fe",
            "filename": "third_party/xla/xla/service/gpu/transforms/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD?ref=689b02eb0a4966f894bf637674ea7b8f0fce2084",
            "patch": "@@ -6,7 +6,7 @@ load(\n     \"if_gpu_is_configured\",\n )\n load(\"//xla/tests:build_defs.bzl\", \"xla_test\")\n-load(\"//xla/tsl:tsl.bzl\", \"if_google\", \"if_oss\")\n+load(\"//xla/tsl:tsl.bzl\", \"if_oss\")\n load(\n     \"//xla/tsl/platform:build_config_root.bzl\",\n     \"tf_gpu_tests_tags\",\n@@ -812,14 +812,13 @@ cc_library(\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/types:span\",\n+        \"@com_google_protobuf//:wrappers_cc_proto\",\n         \"@local_tsl//tsl/platform:errors\",\n         \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:statusor\",\n     ] + if_cuda_is_configured([\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_config_cuda//cuda:cudnn_header\",\n-    ]) + if_google([\n-        \"@com_google_protobuf//:wrappers_cc_proto\",\n     ]),\n )\n "
        },
        {
            "sha": "3936e440837211fbe5f7d006ef74a059743db905",
            "filename": "third_party/xla/xla/stream_executor/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD?ref=689b02eb0a4966f894bf637674ea7b8f0fce2084",
            "patch": "@@ -200,7 +200,8 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/types:span\",\n-    ] + if_google([\"@com_google_protobuf//:wrappers_cc_proto\"]),\n+        \"@com_google_protobuf//:wrappers_cc_proto\",\n+    ],\n )\n \n cc_library(\n@@ -372,13 +373,14 @@ cc_library(\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/types:span\",\n+        \"@com_google_protobuf//:wrappers_cc_proto\",\n         \"@eigen_archive//:eigen3\",  # buildcleaner: keep\n         \"@local_tsl//tsl/platform:errors\",\n         \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:ml_dtypes\",\n         \"@local_tsl//tsl/platform:status\",\n         \"@local_tsl//tsl/platform:statusor\",\n-    ] + if_google([\"@com_google_protobuf//:wrappers_cc_proto\"]),\n+    ],\n )\n \n tf_proto_library("
        },
        {
            "sha": "c91170e74564cb43a23baf739e33d598cbfb9ae2",
            "filename": "third_party/xla/xla/tools/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2FBUILD?ref=689b02eb0a4966f894bf637674ea7b8f0fce2084",
            "patch": "@@ -1027,6 +1027,7 @@ tsl_gpu_library(\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n+        \"@com_google_protobuf//:duration_cc_proto\",\n         \"@com_google_protobuf//:protobuf\",\n         \"@llvm-project//mlir:ArithDialect\",\n         \"@llvm-project//mlir:FuncDialect\",\n@@ -1045,7 +1046,7 @@ tsl_gpu_library(\n         \"//xla/service/gpu:nvptx_compiler\",\n     ]) + if_rocm_is_configured([\n         \"//xla/service/gpu:amdgpu_compiler\",\n-    ]) + if_google([\"@com_google_protobuf//:duration_cc_proto\"]),\n+    ]),\n )\n \n xla_test(\n@@ -1079,14 +1080,15 @@ xla_test(\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_googletest//:gtest\",\n+        \"@com_google_protobuf//:duration_cc_proto\",\n         \"@local_tsl//tsl/platform:env\",\n         \"@local_tsl//tsl/platform:env_time\",\n         \"@local_tsl//tsl/platform:errors\",\n         \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:status_matchers\",\n         \"@local_tsl//tsl/platform:statusor\",\n         \"@local_tsl//tsl/platform:test\",\n-    ] + if_google([\"@com_google_protobuf//:duration_cc_proto\"]) + if_cuda([\n+    ] + if_cuda([\n         \"//xla/tsl/cuda:nvml\",\n     ]),\n )"
        },
        {
            "sha": "14d8f1bba7a4871880df7a09c3e939e174492e4d",
            "filename": "third_party/xla/xla/tsl/platform/default/build_config.bzl",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fbuild_config.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/689b02eb0a4966f894bf637674ea7b8f0fce2084/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fbuild_config.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fbuild_config.bzl?ref=689b02eb0a4966f894bf637674ea7b8f0fce2084",
            "patch": "@@ -419,18 +419,28 @@ def tf_fingerprint_deps():\n         \"@farmhash_archive//:farmhash\",\n     ]\n \n+def _protobuf_deps():\n+    return [\n+        clean_dep(\"@com_google_protobuf//:delimited_message_util\"),\n+        clean_dep(\"@com_google_protobuf//:differencer\"),\n+        clean_dep(\"@com_google_protobuf//:json_util\"),\n+        clean_dep(\"@com_google_protobuf//:type_resolver\"),\n+        clean_dep(\"@com_google_protobuf//:protobuf\"),\n+        clean_dep(\"@com_google_protobuf//:protobuf_lite\"),\n+        clean_dep(\"@com_google_protobuf//src/google/protobuf/io\"),\n+        clean_dep(\"@com_google_protobuf//src/google/protobuf/io:tokenizer\"),\n+    ]\n+\n def tf_protobuf_deps():\n     return if_static(\n-        [\n-            clean_dep(\"@com_google_protobuf//:protobuf\"),\n-        ],\n+        _protobuf_deps(),\n         otherwise = [clean_dep(\"@com_google_protobuf//:protobuf_headers\")],\n     )\n \n # TODO(b/356020232): remove completely after migration is done\n # Link protobuf, unless the tsl_link_protobuf build flag is explicitly set to false.\n def tsl_protobuf_deps():\n-    return if_tsl_link_protobuf([clean_dep(\"@com_google_protobuf//:protobuf\")], [clean_dep(\"@com_google_protobuf//:protobuf_headers\")])\n+    return if_tsl_link_protobuf(_protobuf_deps(), [clean_dep(\"@com_google_protobuf//:protobuf_headers\")])\n \n def strict_cc_test(\n         name,"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 24,
        "deletions": 11
    }
}