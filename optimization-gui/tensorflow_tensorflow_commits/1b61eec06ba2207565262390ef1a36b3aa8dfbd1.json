{
    "author": "tensorflower-gardener",
    "message": "This is an internal change\n\nReverts 86c82562e1188f693f49cd0b369e70d07a74eb7e\n\nPiperOrigin-RevId: 848262323",
    "sha": "1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
    "files": [
        {
            "sha": "02d51f21d4fa4ebec6bf5063f4c1acfa299e4141",
            "filename": "tensorflow/lite/delegates/xnnpack/BUILD",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -392,6 +392,21 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"fingerprint_test_helpers\",\n+    testonly = True,\n+    hdrs = [\"fingerprint_test_helpers.h\"],\n+    compatible_with = get_compatible_with_portable(),\n+    deps = [\n+        \":weight_cache\",\n+        \":weight_cache_test_helpers\",\n+        \":xnnpack_delegate_hdrs_only\",\n+        \"//tensorflow/lite/c:common\",\n+        \"@XNNPACK\",\n+        \"@com_google_googletest//:gtest\",\n+    ],\n+)\n+\n cc_library(\n     name = \"mmap_handle\",\n     srcs = [\"mmap_handle.cc\"],\n@@ -1347,6 +1362,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1363,6 +1379,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_depthwise_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1397,6 +1414,7 @@ cc_test(\n     }),\n     deps = [\n         \":conv_2d_tester\",\n+        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1446,6 +1464,7 @@ cc_test(\n     }),\n     deps = [\n         \":depthwise_conv_2d_tester\",\n+        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1465,6 +1484,7 @@ cc_test(\n     tags = [\"notap\"],\n     deps = [\n         \":dynamically_quantized_fully_connected_tester\",\n+        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1481,6 +1501,7 @@ cc_test(\n     }),\n     deps = [\n         \":dynamically_quantized_conv_2d_tester\",\n+        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1497,6 +1518,7 @@ cc_test(\n     }),\n     deps = [\n         \":dynamically_quantized_transpose_conv_tester\",\n+        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1513,10 +1535,14 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":fully_connected_tester\",\n         \":test_main\",\n+        \":weight_cache\",\n+        \":weight_cache_test_helpers\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n+        \"@XNNPACK\",\n         \"@com_google_googletest//:gtest\",\n     ],\n )\n@@ -1864,6 +1890,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1880,6 +1907,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_depthwise_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1930,6 +1958,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_fully_connected_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2163,6 +2192,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_transpose_conv_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2307,6 +2337,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":transpose_conv_tester\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2386,6 +2417,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2401,6 +2433,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_depthwise_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2431,6 +2464,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_fully_connected_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2641,6 +2675,7 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n+        \":fingerprint_test_helpers\",\n         \":quantized_transpose_conv_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\","
        },
        {
            "sha": "d195d4f25435e892f119bf0b39b469df97ad14de",
            "filename": "tensorflow/lite/delegates/xnnpack/channelwise_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 71,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -24,17 +24,16 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(ChannelwiseQuantizedConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct ChannelwiseQuantizedConv2D : DelegateTest {};\n \n+TEST_F(ChannelwiseQuantizedConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -71,11 +70,7 @@ TEST(ChannelwiseQuantizedConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -112,11 +107,7 @@ TEST(ChannelwiseQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -155,11 +146,7 @@ TEST(ChannelwiseQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -198,11 +185,7 @@ TEST(ChannelwiseQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -241,11 +224,7 @@ TEST(ChannelwiseQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -288,11 +267,7 @@ TEST(ChannelwiseQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -335,11 +310,7 @@ TEST(ChannelwiseQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -382,11 +353,7 @@ TEST(ChannelwiseQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -429,11 +396,7 @@ TEST(ChannelwiseQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -476,11 +439,7 @@ TEST(ChannelwiseQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -523,11 +482,7 @@ TEST(ChannelwiseQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -570,13 +525,11 @@ TEST(ChannelwiseQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, MultiThreading) {\n+TEST_F(ChannelwiseQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -619,17 +572,15 @@ TEST(ChannelwiseQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, WeightsCache) {\n+TEST_F(ChannelwiseQuantizedConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -673,15 +624,13 @@ TEST(ChannelwiseQuantizedConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedConv2D, TransientIndirectionBuffer) {\n+TEST_F(ChannelwiseQuantizedConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(xnnpack_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "0c6de84e9a8d2ff046d5ceeceff7dc2b25eeeedb",
            "filename": "tensorflow/lite/delegates/xnnpack/channelwise_quantized_depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 92,
            "changes": 116,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_depthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_depthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_depthwise_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -23,18 +23,16 @@ limitations under the License.\n #include <vector>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_depthwise_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct ChannelwiseQuantizedDepthwiseConv2D : DelegateTest {};\n \n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -66,11 +64,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, 2x2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 2x2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -103,11 +97,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -140,11 +130,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -179,11 +165,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, 5x5) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 5x5) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -216,11 +198,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, 5x5Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 5x5Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -255,11 +233,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -297,11 +271,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -339,11 +309,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -385,11 +351,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -431,11 +393,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -477,11 +435,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -523,11 +477,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, DepthMultiplier) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DepthMultiplier) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -573,11 +523,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -619,11 +565,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -665,11 +607,7 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -711,13 +649,11 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, MultiThreading) {\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -759,17 +695,15 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, WeightsCache) {\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -812,15 +746,13 @@ TEST(ChannelwiseQuantizedDepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(ChannelwiseQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n+TEST_F(ChannelwiseQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(xnnpack_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "e1b5a674946b73919d41273e82cb8931e2c9be8c",
            "filename": "tensorflow/lite/delegates/xnnpack/conv_2d_test.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 126,
            "changes": 159,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fconv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fconv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fconv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,18 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/conv_2d_tester.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(Conv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct Conv2D : DelegateTest {};\n \n+TEST_F(Conv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -52,11 +50,7 @@ TEST(Conv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -78,11 +72,7 @@ TEST(Conv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -106,11 +96,7 @@ TEST(Conv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, Grouped) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, Grouped) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -136,11 +122,7 @@ TEST(Conv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -164,11 +146,7 @@ TEST(Conv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -192,11 +170,7 @@ TEST(Conv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -224,11 +198,7 @@ TEST(Conv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -256,11 +226,7 @@ TEST(Conv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -288,11 +254,7 @@ TEST(Conv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -320,11 +282,7 @@ TEST(Conv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, FP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, FP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -352,11 +310,7 @@ TEST(Conv2D, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, TensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, TensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -384,11 +338,7 @@ TEST(Conv2D, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, ChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, ChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -416,11 +366,7 @@ TEST(Conv2D, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, SparseWeights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, SparseWeights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -448,11 +394,7 @@ TEST(Conv2D, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, SparseFP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, SparseFP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -481,11 +423,7 @@ TEST(Conv2D, SparseFP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, SparseTensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, SparseTensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -514,11 +452,7 @@ TEST(Conv2D, SparseTensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, SparseChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, SparseChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -547,11 +481,7 @@ TEST(Conv2D, SparseChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -579,11 +509,7 @@ TEST(Conv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -611,11 +537,7 @@ TEST(Conv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -643,11 +565,7 @@ TEST(Conv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, DISABLED_TanhActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, DISABLED_TanhActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -675,11 +593,7 @@ TEST(Conv2D, DISABLED_TanhActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, DISABLED_SignBitActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(Conv2D, DISABLED_SignBitActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -707,13 +621,11 @@ TEST(Conv2D, DISABLED_SignBitActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, MultiThreading) {\n+TEST_F(Conv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -741,18 +653,15 @@ TEST(Conv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, WeightsCache) {\n+TEST_F(Conv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -781,15 +690,13 @@ TEST(Conv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(Conv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions xnnpack_options =\n+TEST_F(Conv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  xnnpack_options.num_threads = 2;\n-  xnnpack_options.flags |=\n+  delegate_options.num_threads = 2;\n+  delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "931fff88178dfb4c33a09202a2a15b7c70070327",
            "filename": "tensorflow/lite/delegates/xnnpack/depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 137,
            "changes": 170,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdepthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdepthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdepthwise_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,18 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/depthwise_conv_2d_tester.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(DepthwiseConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct DepthwiseConv2D : DelegateTest {};\n \n+TEST_F(DepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -47,11 +45,7 @@ TEST(DepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, 2x2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, 2x2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -69,11 +63,7 @@ TEST(DepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -91,11 +81,7 @@ TEST(DepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -115,11 +101,7 @@ TEST(DepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, 5x5) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, 5x5) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -137,11 +119,7 @@ TEST(DepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, 5x5Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, 5x5Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -161,11 +139,7 @@ TEST(DepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -188,11 +162,7 @@ TEST(DepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -215,11 +185,7 @@ TEST(DepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -246,11 +212,7 @@ TEST(DepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -277,11 +239,7 @@ TEST(DepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -308,11 +266,7 @@ TEST(DepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -339,11 +293,7 @@ TEST(DepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, DepthMultiplier) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, DepthMultiplier) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -372,11 +322,7 @@ TEST(DepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, FP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, FP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -403,11 +349,7 @@ TEST(DepthwiseConv2D, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, TensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, TensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -434,11 +376,7 @@ TEST(DepthwiseConv2D, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, ChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, ChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -465,11 +403,7 @@ TEST(DepthwiseConv2D, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, SparseWeights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, SparseWeights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -496,11 +430,7 @@ TEST(DepthwiseConv2D, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, SparseFP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, SparseFP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -528,11 +458,7 @@ TEST(DepthwiseConv2D, SparseFP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, SparseTensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, SparseTensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -560,11 +486,7 @@ TEST(DepthwiseConv2D, SparseTensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, SparseChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, SparseChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -592,11 +514,7 @@ TEST(DepthwiseConv2D, SparseChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -623,11 +541,7 @@ TEST(DepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -654,11 +568,7 @@ TEST(DepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -685,11 +595,7 @@ TEST(DepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, DISABLED_TanhActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, DISABLED_TanhActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -716,11 +622,7 @@ TEST(DepthwiseConv2D, DISABLED_TanhActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, DISABLED_SignBitActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DepthwiseConv2D, DISABLED_SignBitActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -747,13 +649,11 @@ TEST(DepthwiseConv2D, DISABLED_SignBitActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, MultiThreading) {\n+TEST_F(DepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -780,17 +680,15 @@ TEST(DepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, WeightsCache) {\n+TEST_F(DepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -818,15 +716,13 @@ TEST(DepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DepthwiseConv2D, TransientIndirectionBuffer) {\n+TEST_F(DepthwiseConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(xnnpack_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "52e8333db4fd049cde3591d7bf2383d49a2ae1d5",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 155,
            "changes": 179,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,22 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/dynamically_quantized_conv_2d_tester.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(DynamicallyQuantizedConv2D, 3x3) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+struct DynamicallyQuantizedConv2D : DelegateTest {};\n \n+TEST_F(DynamicallyQuantizedConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -56,15 +50,7 @@ TEST(DynamicallyQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, 3x3Stride2) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -88,15 +74,7 @@ TEST(DynamicallyQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, Grouped) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, Grouped) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -122,15 +100,7 @@ TEST(DynamicallyQuantizedConv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, SmallKernelWithSamePadding) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -154,15 +124,7 @@ TEST(DynamicallyQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, SmallKernelWithValidPadding) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -186,14 +148,7 @@ TEST(DynamicallyQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, StrideWithSamePadding) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+TEST_F(DynamicallyQuantizedConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -221,15 +176,7 @@ TEST(DynamicallyQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, StrideWithValidPadding) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -257,15 +204,7 @@ TEST(DynamicallyQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, DilationWithSamePadding) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -293,15 +232,7 @@ TEST(DynamicallyQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, DilationWithValidPadding) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -329,15 +260,7 @@ TEST(DynamicallyQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, TensorWiseQuantizedInt8Weights) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, TensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -364,15 +287,7 @@ TEST(DynamicallyQuantizedConv2D, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, ChannelWiseQuantizedInt8Weights) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, ChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -399,15 +314,7 @@ TEST(DynamicallyQuantizedConv2D, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, ReluActivation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -435,15 +342,7 @@ TEST(DynamicallyQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, Relu6Activation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -471,15 +370,7 @@ TEST(DynamicallyQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, ReluMinus1To1Activation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -507,15 +398,7 @@ TEST(DynamicallyQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, TanhActivation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, TanhActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -543,15 +426,7 @@ TEST(DynamicallyQuantizedConv2D, TanhActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, SignBitActivation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedConv2D, SignBitActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -579,15 +454,13 @@ TEST(DynamicallyQuantizedConv2D, SignBitActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, MultiThreading) {\n+TEST_F(DynamicallyQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n   delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -615,7 +488,7 @@ TEST(DynamicallyQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, WeightsCache) {\n+TEST_F(DynamicallyQuantizedConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n@@ -625,9 +498,7 @@ TEST(DynamicallyQuantizedConv2D, WeightsCache) {\n   delegate_options.weights_cache = weights_cache.get();\n   delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -656,16 +527,14 @@ TEST(DynamicallyQuantizedConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedConv2D, TransientIndirectionBuffer) {\n+TEST_F(DynamicallyQuantizedConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n   xnnpack_options.flags |= TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(xnnpack_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "2d2febcb21ab6617a59cf85ea2b117f3d40f4642",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_fully_connected_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 107,
            "changes": 113,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_fully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_fully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_fully_connected_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -21,18 +21,19 @@ limitations under the License.\n #include <string>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/dynamically_quantized_fully_connected_tester.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n // Dummy class to use with parameterized test.\n class DynamicallyQuantizedFullyConnectedTest\n-    : public testing::TestWithParam<WeightsType> {};\n+    : public testing::WithParamInterface<WeightsType>,\n+      public DelegateTest {};\n \n-int GenInputChannels(const std::function<int()> &rng,\n+int GenInputChannels(const std::function<int()>& rng,\n                      WeightsType weights_type) {\n   switch (weights_type) {\n     case WeightsType::kChannelWiseQuantizedInt8:\n@@ -45,14 +46,6 @@ int GenInputChannels(const std::function<int()> &rng,\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 1D) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto channels_rng =\n@@ -71,14 +64,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 1D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 2D) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -99,14 +84,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 2D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 2DKeepDims) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -128,13 +105,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 2DKeepDims) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 3D) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -156,14 +126,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 3D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DReshape) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -184,14 +146,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DReshape) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DKeepDims) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -214,14 +168,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DKeepDims) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 4D) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -244,14 +190,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 4D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 4DKeepDims) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -275,14 +213,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 4DKeepDims) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, NoBias) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -304,14 +234,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, NoBias) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluActivation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -333,14 +255,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluActivation) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, Relu6Activation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -362,14 +276,6 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, Relu6Activation) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluMinus1To1Activation) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n-      TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -393,13 +299,8 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluMinus1To1Activation) {\n TEST_P(DynamicallyQuantizedFullyConnectedTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.flags |=\n-      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+  UseCustomDelegate(delegate_options);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -429,9 +330,7 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, WeightsCache) {\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng ="
        },
        {
            "sha": "4a40e56852b56cebd15469a6771a91df7fe155be",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_transpose_conv_test.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 46,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,18 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/core/c/common.h\"\n #include \"tensorflow/lite/delegates/xnnpack/dynamically_quantized_transpose_conv_tester.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(DynamicallyQuantizedTransposeConvTest, 2x2Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct DynamicallyQuantizedTransposeConvTest : DelegateTest {};\n \n+TEST_F(DynamicallyQuantizedTransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -51,10 +49,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+TEST_F(DynamicallyQuantizedTransposeConvTest, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -75,11 +70,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, 4x4Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedTransposeConvTest, 4x4Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -100,11 +91,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, 4x4Stride4) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedTransposeConvTest, 4x4Stride4) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -125,11 +112,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -153,10 +136,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+TEST_F(DynamicallyQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -180,11 +160,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedTransposeConvTest, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -212,11 +188,7 @@ TEST(DynamicallyQuantizedTransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(DynamicallyQuantizedTransposeConvTest, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -244,13 +216,11 @@ TEST(DynamicallyQuantizedTransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, MultiThreading) {\n+TEST_F(DynamicallyQuantizedTransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -279,17 +249,15 @@ TEST(DynamicallyQuantizedTransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(DynamicallyQuantizedTransposeConvTest, WeightsCache) {\n+TEST_F(DynamicallyQuantizedTransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "abfd76c12a14f9e1906fb620208da396b0a6f709",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_transpose_conv_tester.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_tester.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_tester.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_tester.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -55,10 +55,12 @@ void DynamicallyQuantizedTransposeConvTester::Test(\n   const Model* model = GetModel(buffer.data());\n \n   std::unique_ptr<Interpreter> delegate_interpreter;\n-  ASSERT_EQ(InterpreterBuilder(\n-                model, ::tflite::ops::builtin::BuiltinOpResolverWithXNNPACK())(\n-                &delegate_interpreter),\n-            kTfLiteOk);\n+  ASSERT_EQ(\n+      InterpreterBuilder(\n+          model,\n+          ::tflite::ops::builtin::BuiltinOpResolverWithoutDefaultDelegates())(\n+          &delegate_interpreter),\n+      kTfLiteOk);\n   std::unique_ptr<Interpreter> default_interpreter;\n   ASSERT_EQ(\n       InterpreterBuilder("
        },
        {
            "sha": "29edbe5a35c841f2c91ba9aa38923a26f3de9a3b",
            "filename": "tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h",
            "status": "added",
            "additions": 112,
            "deletions": 0,
            "changes": 112,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffingerprint_test_helpers.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffingerprint_test_helpers.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffingerprint_test_helpers.h?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -0,0 +1,112 @@\n+/* Copyright 2025 The TensorFlow Authors. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+#ifndef TENSORFLOW_LITE_DELEGATES_XNNPACK_FINGERPRINT_TEST_HELPERS_H_\n+#define TENSORFLOW_LITE_DELEGATES_XNNPACK_FINGERPRINT_TEST_HELPERS_H_\n+\n+#include <memory>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"experimental.h\"  // from @XNNPACK\n+#include \"tensorflow/lite/c/common.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/weight_cache.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/weight_cache_test_helpers.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n+\n+namespace tflite::xnnpack {\n+\n+struct TfLiteDelegateDeleter {\n+  void operator()(TfLiteDelegate* delegate) {\n+    TfLiteXNNPackDelegateDelete(delegate);\n+  }\n+};\n+\n+using TfLiteDelegatePtr =\n+    std::unique_ptr<TfLiteDelegate, TfLiteDelegateDeleter>;\n+\n+struct DelegateTest : public virtual testing::Test {\n+  void SetUp() override {\n+    TfLiteXNNPackDelegateOptions delegate_options =\n+        TfLiteXNNPackDelegateOptionsDefault();\n+\n+    // By default, we try to setup a file weight cache to also check fingerprint\n+    // generation. If the test system doesn't support a file system, then the\n+    // cache file will be invalid.\n+    if (cache_file.IsValid()) {\n+      xnn_clear_fingerprints();\n+      delegate_options.weight_cache_file_path = cache_file.GetCPath();\n+      delegate_options.weight_cache_file_descriptor =\n+          cache_file.Duplicate().Release();\n+      delegate_options.flags |=\n+          TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+      check_for_cache_fingerprints = true;\n+    }\n+\n+    xnnpack_delegate =\n+        TfLiteDelegatePtr(TfLiteXNNPackDelegateCreate(&delegate_options));\n+    ASSERT_THAT(xnnpack_delegate, testing::NotNull());\n+  }\n+\n+  void TearDown() override {\n+    if (check_for_cache_fingerprints) {\n+      ASSERT_TRUE(cache_file.IsValid());\n+      EXPECT_TRUE(IsCompatibleCacheFile(cache_file));\n+      if (AlterXNNPackFingerprints()) {\n+        EXPECT_FALSE(IsCompatibleCacheFile(cache_file));\n+      }\n+    }\n+  }\n+\n+  // Artificially change fingerprint values.\n+  //\n+  // This allows us to check that changing a fingerprint value will make the\n+  // cache file incompatible.\n+  //\n+  // Returns the current number of fingerprints.\n+  int AlterXNNPackFingerprints() {\n+    int i = 0;\n+    int modified = 0;\n+    for (const xnn_fingerprint* fingerprint = xnn_get_fingerprint_by_idx(i);\n+         fingerprint != nullptr;\n+         fingerprint = xnn_get_fingerprint_by_idx(++i)) {\n+      xnn_fingerprint new_fingerprint = *fingerprint;\n+      ++new_fingerprint.value;\n+      xnn_set_fingerprint(new_fingerprint);\n+      ++modified;\n+    }\n+    return modified;\n+  }\n+\n+  // Replaces the xnnpack delegate with a custom one.\n+  void UseCustomDelegate(const TfLiteXNNPackDelegateOptions& delegate_options) {\n+    check_for_cache_fingerprints = false;\n+    xnnpack_delegate =\n+        TfLiteDelegatePtr(TfLiteXNNPackDelegateCreate(&delegate_options));\n+    ASSERT_THAT(xnnpack_delegate, testing::NotNull());\n+  }\n+\n+  // Replaces the xnnpack delegate with one that sets up a file backed weight\n+  // cache.\n+  void UseDelegateWithFileWeightCache() {}\n+\n+  // The default delegate is created in a generic way.\n+  TfLiteDelegatePtr xnnpack_delegate;\n+  tflite::xnnpack::TempFileDesc cache_file;\n+  bool check_for_cache_fingerprints = false;\n+};\n+\n+}  // namespace tflite::xnnpack\n+\n+#endif  // TENSORFLOW_LITE_DELEGATES_XNNPACK_FINGERPRINT_TEST_HELPERS_H_"
        },
        {
            "sha": "6701d0bc1c8f597f2eb82f40b4aa8b588f320136",
            "filename": "tensorflow/lite/delegates/xnnpack/fully_connected_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 123,
            "changes": 152,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffully_connected_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,18 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/fully_connected_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(FullyConnected, 1D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct FullyConnectedTest : public DelegateTest {};\n \n+TEST_F(FullyConnectedTest, 1D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto channels_rng =\n@@ -45,11 +43,7 @@ TEST(FullyConnected, 1D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 1DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 1DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto channels_rng =\n@@ -65,11 +59,7 @@ TEST(FullyConnected, 1DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 2D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 2D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -87,11 +77,7 @@ TEST(FullyConnected, 2D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 2DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 2DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -110,11 +96,7 @@ TEST(FullyConnected, 2DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 3D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 3D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -133,11 +115,7 @@ TEST(FullyConnected, 3D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 3DReshape) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 3DReshape) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -156,11 +134,7 @@ TEST(FullyConnected, 3DReshape) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 3DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 3DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -180,11 +154,7 @@ TEST(FullyConnected, 3DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 4D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 4D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -204,11 +174,7 @@ TEST(FullyConnected, 4D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, 4DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, 4DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -229,11 +195,7 @@ TEST(FullyConnected, 4DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -252,11 +214,7 @@ TEST(FullyConnected, NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, FP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, FP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -275,11 +233,7 @@ TEST(FullyConnected, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, FP16WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, FP16WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -299,11 +253,7 @@ TEST(FullyConnected, FP16WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, DynamicWeights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, DynamicWeights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -322,11 +272,7 @@ TEST(FullyConnected, DynamicWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, DynamicWeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, DynamicWeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -346,11 +292,7 @@ TEST(FullyConnected, DynamicWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, DynamicBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, DynamicBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -369,11 +311,7 @@ TEST(FullyConnected, DynamicBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, DynamicWeightsAndBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, DynamicWeightsAndBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -393,11 +331,7 @@ TEST(FullyConnected, DynamicWeightsAndBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, TensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, TensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -416,11 +350,7 @@ TEST(FullyConnected, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, TensorWiseQuantizedInt8WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, TensorWiseQuantizedInt8WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -440,11 +370,7 @@ TEST(FullyConnected, TensorWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, ChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, ChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -463,11 +389,7 @@ TEST(FullyConnected, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, ChannelWiseQuantizedInt8WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -487,11 +409,7 @@ TEST(FullyConnected, ChannelWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -510,11 +428,7 @@ TEST(FullyConnected, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -533,11 +447,7 @@ TEST(FullyConnected, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(FullyConnectedTest, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -556,13 +466,11 @@ TEST(FullyConnected, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, MultiThreading) {\n+TEST_F(FullyConnectedTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -581,17 +489,15 @@ TEST(FullyConnected, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(FullyConnected, WeightsCache) {\n+TEST_F(FullyConnectedTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "06daba0d9bada768548405f5bedd6ba00a0b4110",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 75,
            "changes": 97,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -21,17 +21,16 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(SignedQuantizedConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct SignedQuantizedConv2D : DelegateTest {};\n \n+TEST_F(SignedQuantizedConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -59,11 +58,7 @@ TEST(SignedQuantizedConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -91,11 +86,7 @@ TEST(SignedQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -125,11 +116,7 @@ TEST(SignedQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, Grouped) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, Grouped) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -163,11 +150,7 @@ TEST(SignedQuantizedConv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -197,11 +180,7 @@ TEST(SignedQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -231,11 +210,7 @@ TEST(SignedQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -269,11 +244,7 @@ TEST(SignedQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -307,11 +278,7 @@ TEST(SignedQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -345,11 +312,7 @@ TEST(SignedQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -383,11 +346,7 @@ TEST(SignedQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -421,11 +380,7 @@ TEST(SignedQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -459,11 +414,7 @@ TEST(SignedQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -497,13 +448,11 @@ TEST(SignedQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, MultiThreading) {\n+TEST_F(SignedQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -537,15 +486,13 @@ TEST(SignedQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions xnnpack_options =\n+TEST_F(SignedQuantizedConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  xnnpack_options.num_threads = 2;\n-  xnnpack_options.flags |=\n+  delegate_options.num_threads = 2;\n+  delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "c409b18002ef51995a9cfd26e3318c9307734d5b",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 95,
            "changes": 122,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_depthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_depthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_depthwise_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -20,18 +20,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_depthwise_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(SignedQuantizedDepthwiseConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct SignedQuantizedDepthwiseConv2D : DelegateTest {};\n \n+TEST_F(SignedQuantizedDepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -54,11 +52,7 @@ TEST(SignedQuantizedDepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, 2x2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, 2x2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -82,11 +76,7 @@ TEST(SignedQuantizedDepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -110,11 +100,7 @@ TEST(SignedQuantizedDepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -140,11 +126,7 @@ TEST(SignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, 5x5) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, 5x5) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -168,11 +150,7 @@ TEST(SignedQuantizedDepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -198,11 +176,7 @@ TEST(SignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -231,11 +205,7 @@ TEST(SignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -264,11 +234,7 @@ TEST(SignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -301,11 +267,7 @@ TEST(SignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -338,11 +300,7 @@ TEST(SignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -375,11 +333,7 @@ TEST(SignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -412,11 +366,7 @@ TEST(SignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -451,11 +401,7 @@ TEST(SignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -488,11 +434,7 @@ TEST(SignedQuantizedDepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -525,11 +467,7 @@ TEST(SignedQuantizedDepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -562,13 +500,11 @@ TEST(SignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, MultiThreading) {\n+TEST_F(SignedQuantizedDepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -601,17 +537,15 @@ TEST(SignedQuantizedDepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, WeightsCache) {\n+TEST_F(SignedQuantizedDepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -645,15 +579,13 @@ TEST(SignedQuantizedDepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions xnnpack_options =\n+TEST_F(SignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  xnnpack_options.num_threads = 2;\n-  xnnpack_options.flags |=\n+  delegate_options.num_threads = 2;\n+  delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "5a7a9dfd77b24ec5874ee01489200d65a1822c9c",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_fully_connected_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 72,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_fully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_fully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_fully_connected_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -21,17 +21,16 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_fully_connected_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(SignedQuantizedFullyConnected, 1D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct SignedQuantizedFullyConnected : DelegateTest {};\n \n+TEST_F(SignedQuantizedFullyConnected, 1D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -52,11 +51,7 @@ TEST(SignedQuantizedFullyConnected, 1D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 1DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 1DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -78,11 +73,7 @@ TEST(SignedQuantizedFullyConnected, 1DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 2D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 2D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -106,11 +97,7 @@ TEST(SignedQuantizedFullyConnected, 2D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 2DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 2DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -135,11 +122,7 @@ TEST(SignedQuantizedFullyConnected, 2DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 3D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 3D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -164,11 +147,7 @@ TEST(SignedQuantizedFullyConnected, 3D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 3DReshape) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 3DReshape) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -193,11 +172,7 @@ TEST(SignedQuantizedFullyConnected, 3DReshape) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 3DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 3DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -223,11 +198,7 @@ TEST(SignedQuantizedFullyConnected, 3DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 4D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 4D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -253,11 +224,7 @@ TEST(SignedQuantizedFullyConnected, 4D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, 4DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, 4DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -284,11 +251,7 @@ TEST(SignedQuantizedFullyConnected, 4DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -313,11 +276,7 @@ TEST(SignedQuantizedFullyConnected, NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -342,11 +301,7 @@ TEST(SignedQuantizedFullyConnected, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -371,11 +326,7 @@ TEST(SignedQuantizedFullyConnected, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -400,13 +351,11 @@ TEST(SignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, MultiThreading) {\n+TEST_F(SignedQuantizedFullyConnected, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -431,17 +380,15 @@ TEST(SignedQuantizedFullyConnected, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedFullyConnected, WeightsCache) {\n+TEST_F(SignedQuantizedFullyConnected, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "d4dceb9077ff26ef2ed30b5a18e5806c620195a5",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_transpose_conv_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 101,
            "changes": 127,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_transpose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_transpose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_transpose_conv_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -20,17 +20,16 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_transpose_conv_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(SignedQuantizedTransposeConvTest, 2x2Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct SignedQuantizedTransposeConvTest : DelegateTest {};\n \n+TEST_F(SignedQuantizedTransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -52,11 +51,7 @@ TEST(SignedQuantizedTransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -79,11 +74,7 @@ TEST(SignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -105,11 +96,7 @@ TEST(SignedQuantizedTransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -132,11 +119,7 @@ TEST(SignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 4x4Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -158,11 +141,7 @@ TEST(SignedQuantizedTransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -185,11 +164,7 @@ TEST(SignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 4x4Stride4) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride4) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -211,11 +186,7 @@ TEST(SignedQuantizedTransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -238,11 +209,7 @@ TEST(SignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -267,11 +234,7 @@ TEST(SignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -297,11 +260,7 @@ TEST(SignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -326,11 +285,7 @@ TEST(SignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -356,11 +311,7 @@ TEST(SignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -389,11 +340,7 @@ TEST(SignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -423,11 +370,7 @@ TEST(SignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -456,11 +399,7 @@ TEST(SignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -490,11 +429,7 @@ TEST(SignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, SparseWeights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, SparseWeights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -524,11 +459,7 @@ TEST(SignedQuantizedTransposeConvTest, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(SignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -559,13 +490,11 @@ TEST(SignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, MultiThreading) {\n+TEST_F(SignedQuantizedTransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -595,13 +524,11 @@ TEST(SignedQuantizedTransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n+TEST_F(SignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -632,17 +559,15 @@ TEST(SignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(SignedQuantizedTransposeConvTest, WeightsCache) {\n+TEST_F(SignedQuantizedTransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "d37317c34f545a5e62b386e0a2017d24a3be6ec9",
            "filename": "tensorflow/lite/delegates/xnnpack/transpose_conv_test.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 161,
            "changes": 199,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ftranspose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ftranspose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ftranspose_conv_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,17 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/transpose_conv_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(TransposeConvTest, 2x2Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct TransposeConvTest : DelegateTest {};\n \n+TEST_F(TransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -50,11 +49,7 @@ TEST(TransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 2x2Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 2x2Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -76,11 +71,7 @@ TEST(TransposeConvTest, 2x2Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -101,11 +92,7 @@ TEST(TransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 3x3Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 3x3Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -127,11 +114,7 @@ TEST(TransposeConvTest, 3x3Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 4x4Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 4x4Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -152,11 +135,7 @@ TEST(TransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 4x4Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 4x4Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -178,11 +157,7 @@ TEST(TransposeConvTest, 4x4Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 4x4Stride4) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 4x4Stride4) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -203,11 +178,7 @@ TEST(TransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, 4x4Stride4NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, 4x4Stride4NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -229,11 +200,7 @@ TEST(TransposeConvTest, 4x4Stride4NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -257,11 +224,7 @@ TEST(TransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -286,11 +249,7 @@ TEST(TransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -314,11 +273,7 @@ TEST(TransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -343,11 +298,7 @@ TEST(TransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -375,11 +326,7 @@ TEST(TransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, StrideWithSamePaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, StrideWithSamePaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -408,11 +355,7 @@ TEST(TransposeConvTest, StrideWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -440,11 +383,7 @@ TEST(TransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, StrideWithValidPaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, StrideWithValidPaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -473,11 +412,7 @@ TEST(TransposeConvTest, StrideWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, FP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, FP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -506,11 +441,7 @@ TEST(TransposeConvTest, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, FP16WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, FP16WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -540,11 +471,7 @@ TEST(TransposeConvTest, FP16WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, TensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, TensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -573,11 +500,7 @@ TEST(TransposeConvTest, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, TensorWiseQuantizedInt8WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, TensorWiseQuantizedInt8WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -607,11 +530,7 @@ TEST(TransposeConvTest, TensorWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, ChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, ChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -640,11 +559,7 @@ TEST(TransposeConvTest, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -674,11 +589,7 @@ TEST(TransposeConvTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseWeights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseWeights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -707,11 +618,7 @@ TEST(TransposeConvTest, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseWeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseWeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -741,11 +648,7 @@ TEST(TransposeConvTest, SparseWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseFP16Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseFP16Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -775,11 +678,7 @@ TEST(TransposeConvTest, SparseFP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseFP16WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseFP16WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -810,11 +709,7 @@ TEST(TransposeConvTest, SparseFP16WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseTensorWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseTensorWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -844,11 +739,7 @@ TEST(TransposeConvTest, SparseTensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseTensorWiseQuantizedInt8WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseTensorWiseQuantizedInt8WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -879,11 +770,7 @@ TEST(TransposeConvTest, SparseTensorWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseChannelWiseQuantizedInt8Weights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseChannelWiseQuantizedInt8Weights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -913,11 +800,7 @@ TEST(TransposeConvTest, SparseChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, SparseChannelWiseQuantizedInt8WeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(TransposeConvTest, SparseChannelWiseQuantizedInt8WeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -948,13 +831,11 @@ TEST(TransposeConvTest, SparseChannelWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, MultiThreading) {\n+TEST_F(TransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -983,13 +864,11 @@ TEST(TransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, MultiThreadingNoBias) {\n+TEST_F(TransposeConvTest, MultiThreadingNoBias) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -1019,17 +898,15 @@ TEST(TransposeConvTest, MultiThreadingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(TransposeConvTest, WeightsCache) {\n+TEST_F(TransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "b8c9d48f4f05a22088336b4e2a6b71c029d36347",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 75,
            "changes": 97,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -20,17 +20,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(UnsignedQuantizedConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct UnsignedQuantizedConv2D : DelegateTest {};\n \n+TEST_F(UnsignedQuantizedConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -61,11 +60,7 @@ TEST(UnsignedQuantizedConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -96,11 +91,7 @@ TEST(UnsignedQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -137,11 +128,7 @@ TEST(UnsignedQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, Grouped) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, Grouped) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -174,11 +161,7 @@ TEST(UnsignedQuantizedConv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -211,11 +194,7 @@ TEST(UnsignedQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -248,11 +227,7 @@ TEST(UnsignedQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -289,11 +264,7 @@ TEST(UnsignedQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -330,11 +301,7 @@ TEST(UnsignedQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -371,11 +338,7 @@ TEST(UnsignedQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -412,11 +375,7 @@ TEST(UnsignedQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -453,11 +412,7 @@ TEST(UnsignedQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -494,11 +449,7 @@ TEST(UnsignedQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -535,13 +486,11 @@ TEST(UnsignedQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, MultiThreading) {\n+TEST_F(UnsignedQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -578,15 +527,13 @@ TEST(UnsignedQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions xnnpack_options =\n+TEST_F(UnsignedQuantizedConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  xnnpack_options.num_threads = 2;\n-  xnnpack_options.flags |=\n+  delegate_options.num_threads = 2;\n+  delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "a269343dafc5129fd4ad3120592c64bc58ce77be",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 94,
            "changes": 121,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_depthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_depthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_depthwise_conv_2d_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -20,17 +20,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_depthwise_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, 1x1) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct UnsignedQuantizedDepthwiseConv2D : DelegateTest {};\n \n+TEST_F(UnsignedQuantizedDepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -56,11 +55,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, 2x2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, 2x2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -87,11 +82,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, 3x3) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -118,11 +109,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -151,11 +138,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, 5x5) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, 5x5) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -182,11 +165,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -215,11 +194,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -251,11 +226,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -287,11 +258,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -327,11 +294,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -367,11 +330,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -407,11 +366,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -447,11 +402,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -489,11 +440,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -529,11 +476,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -569,11 +512,7 @@ TEST(UnsignedQuantizedDepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -609,13 +548,11 @@ TEST(UnsignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, MultiThreading) {\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -651,17 +588,15 @@ TEST(UnsignedQuantizedDepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, WeightsCache) {\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -698,15 +633,13 @@ TEST(UnsignedQuantizedDepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions xnnpack_options =\n+TEST_F(UnsignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  xnnpack_options.num_threads = 2;\n-  xnnpack_options.flags |=\n+  delegate_options.num_threads = 2;\n+  delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "25aabd2a5594136b247f721ade67344e34c51673",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_fully_connected_test.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 68,
            "changes": 85,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_fully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_fully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_fully_connected_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -20,17 +20,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_fully_connected_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(UnsignedQuantizedFullyConnected, 1D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct UnsignedQuantizedFullyConnected : DelegateTest {};\n \n+TEST_F(UnsignedQuantizedFullyConnected, 1D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -54,11 +53,7 @@ TEST(UnsignedQuantizedFullyConnected, 1D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 1DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 1DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -83,11 +78,7 @@ TEST(UnsignedQuantizedFullyConnected, 1DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 2D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 2D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -114,11 +105,7 @@ TEST(UnsignedQuantizedFullyConnected, 2D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 2DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 2DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -146,11 +133,7 @@ TEST(UnsignedQuantizedFullyConnected, 2DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 3D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 3D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -178,11 +161,7 @@ TEST(UnsignedQuantizedFullyConnected, 3D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 3DReshape) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 3DReshape) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -210,11 +189,7 @@ TEST(UnsignedQuantizedFullyConnected, 3DReshape) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 3DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 3DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -243,11 +218,7 @@ TEST(UnsignedQuantizedFullyConnected, 3DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 4D) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 4D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -276,11 +247,7 @@ TEST(UnsignedQuantizedFullyConnected, 4D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, 4DKeepDims) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, 4DKeepDims) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -310,11 +277,7 @@ TEST(UnsignedQuantizedFullyConnected, 4DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -342,11 +305,7 @@ TEST(UnsignedQuantizedFullyConnected, NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, ReluActivation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, ReluActivation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -374,11 +333,7 @@ TEST(UnsignedQuantizedFullyConnected, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, Relu6Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, Relu6Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -406,11 +361,7 @@ TEST(UnsignedQuantizedFullyConnected, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -438,13 +389,11 @@ TEST(UnsignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedFullyConnected, MultiThreading) {\n+TEST_F(UnsignedQuantizedFullyConnected, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "5167d18443ac305ab15c686fd1e3b9849e28ee28",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_transpose_conv_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 101,
            "changes": 127,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_transpose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_transpose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_transpose_conv_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -19,17 +19,16 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_transpose_conv_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-TEST(UnsignedQuantizedTransposeConvTest, 2x2Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n+struct UnsignedQuantizedTransposeConvTest : DelegateTest {};\n \n+TEST_F(UnsignedQuantizedTransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -51,11 +50,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -78,11 +73,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 3x3Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 3x3Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -104,11 +95,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -131,11 +118,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride2) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -157,11 +140,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -184,11 +163,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride4) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride4) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -210,11 +185,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -237,11 +208,7 @@ TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -266,11 +233,7 @@ TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -296,11 +259,7 @@ TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -325,11 +284,7 @@ TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -355,11 +310,7 @@ TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -388,11 +339,7 @@ TEST(UnsignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -422,11 +369,7 @@ TEST(UnsignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -455,11 +398,7 @@ TEST(UnsignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -489,11 +428,7 @@ TEST(UnsignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, SparseWeights) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, SparseWeights) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -523,11 +458,7 @@ TEST(UnsignedQuantizedTransposeConvTest, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n-                       TfLiteXNNPackDelegateDelete);\n-\n+TEST_F(UnsignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -558,13 +489,11 @@ TEST(UnsignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, MultiThreading) {\n+TEST_F(UnsignedQuantizedTransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -594,13 +523,11 @@ TEST(UnsignedQuantizedTransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n+TEST_F(UnsignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -631,17 +558,15 @@ TEST(UnsignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST(UnsignedQuantizedTransposeConvTest, WeightsCache) {\n+TEST_F(UnsignedQuantizedTransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n-      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n-                       TfLiteXNNPackDelegateDelete);\n+  UseCustomDelegate(delegate_options);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "9aaf497700f87f531a8dd1e165e4df5de7d882b5",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 64,
            "deletions": 21,
            "changes": 85,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include <unistd.h>\n #endif\n \n+#include <algorithm>\n #include <cerrno>  // IWYU pragma: keep\n #include <cinttypes>\n #include <cstddef>\n@@ -37,6 +38,7 @@ limitations under the License.\n #include <unordered_map>\n #include <utility>\n \n+#include \"experimental.h\"  // from @XNNPACK\n #include \"xnnpack.h\"  // from @XNNPACK\n #include \"flatbuffers/flatbuffer_builder.h\"  // from @flatbuffers\n #include \"flatbuffers/verifier.h\"  // from @flatbuffers\n@@ -78,6 +80,20 @@ bool FileExists(const char* path) {\n   return access(path, F_OK) != -1;\n }\n \n+bool CheckFingerprints(const cache::schema::BufferList* buffer_list) {\n+  if (buffer_list->fingerprints()) {\n+    for (uint64_t cache_fingerprint : *buffer_list->fingerprints()) {\n+      xnn_fingerprint fingerprint;\n+      static_assert(sizeof(fingerprint) == sizeof(cache_fingerprint));\n+      std::memcpy(&fingerprint, &cache_fingerprint, sizeof(fingerprint));\n+      XNNPACK_RETURN_CHECK(\n+          xnn_check_fingerprint(fingerprint) == xnn_status_success,\n+          \"fingerprint (id: 0x%x) could not be matched\", fingerprint.id);\n+    }\n+  }\n+  return true;\n+}\n+\n }  // namespace\n \n #define XNN_MOVE_CONSTRUCT_MEMBER(x) x(std::move(other.x))\n@@ -182,7 +198,8 @@ void* WeightCacheBuilder::Reserve(size_t size) {\n }\n \n BufferLocation WeightCacheBuilder::Append(PackIdentifier pack_id,\n-                                          const void* data, uint64_t size) {\n+                                          const void* data, uint64_t size,\n+                                          int32_t fingerprint_id) {\n   XNNPACK_ABORT_CHECK(is_build_step_,\n                       \"cannot append data to an unstarted builder.\");\n   // Add some padding so that the cache file can be mmaped and the buffer\n@@ -201,6 +218,34 @@ BufferLocation WeightCacheBuilder::Append(PackIdentifier pack_id,\n   buffer.size = loc.size;\n   schema_.buffers.push_back(std::make_unique<cache::schema::BufferT>(buffer));\n \n+  // Not passing a fingerprint id is a logic error on XNNPack's side. If we\n+  // don't have a fingerprint for an operation, we have no way of ensuring that\n+  // the generation of the cached data hasn't changed when reloading the cache.\n+  //\n+  // If we just log this and continue on with the work. This run will build a\n+  // cache with cached data that can't be checked in the future. This will lead,\n+  // in future runs that reuse the cache, to crashes that are impossible to\n+  // debug or outputs that are nonsensical without any chance of linking this\n+  // back to this error.\n+  //\n+  // We abort because we have no way of making that failure bubble up to the\n+  // calling code to handle it gracefully...\n+  XNNPACK_ABORT_CHECK(fingerprint_id != 0,\n+                      \"XNNPack weight cache: no fingerprint identifier was set \"\n+                      \"when appending a buffer to the cache file.\");\n+  const xnn_fingerprint* fingerprint = xnn_get_fingerprint(fingerprint_id);\n+  XNNPACK_ABORT_CHECK(fingerprint,\n+                      \"XNNPack weight cache: could not find a fingerprint with \"\n+                      \"id 0x%x when appending a buffer to the cache file.\",\n+                      fingerprint_id);\n+  uint64_t fingerprint_value;\n+  static_assert(sizeof(fingerprint_value) == sizeof(*fingerprint));\n+  std::memcpy(&fingerprint_value, fingerprint, sizeof(*fingerprint));\n+  if (std::find(schema_.fingerprints.begin(), schema_.fingerprints.end(),\n+                fingerprint_value) == schema_.fingerprints.end()) {\n+    schema_.fingerprints.push_back(fingerprint_value);\n+  }\n+\n   if (!fd_.Write(data, size)) {\n     TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR,\n                     \"XNNPack weight cache: cannot append buffer to cache file\");\n@@ -233,16 +278,7 @@ bool WeightCacheBuilder::StopBuildStep() {\n   XNNPACK_RETURN_CHECK(fd_.SetPos(layout_offset) != -1,\n                        \"could not move in the file: %s\", strerror(errno));\n \n-  XNNPACK_RETURN_CHECK(\n-      sizeof(XNNPackCacheHeader::xnnpack_build_identifier) ==\n-          xnn_experimental_get_build_identifier_size(),\n-      \"cache file ('%s') header cannot hold XNNPack's build identifier: %s.\",\n-      file_path_.c_str(), strerror(errno));\n-\n   XNNPackCacheHeader header{XNNPackCacheHeader::kVersion};\n-  memcpy(header.xnnpack_build_identifier,\n-         xnn_experimental_get_build_identifier_data(),\n-         xnn_experimental_get_build_identifier_size());\n   header.buffer_list_offset = fd_.GetPos();\n   header.buffer_list_size = builder.GetSize();\n \n@@ -405,12 +441,6 @@ bool MMapWeightCacheProvider::Load() {\n                        \", expected %\" PRIu64 \". Cache needs to be built again.\",\n                        header.version, XNNPackCacheHeader::kVersion);\n \n-  XNNPACK_RETURN_CHECK(xnn_experimental_check_build_identifier(\n-                           header.xnnpack_build_identifier,\n-                           sizeof(header.xnnpack_build_identifier)),\n-                       \"XNNPack weight cache: incompatible XNNPack version. \"\n-                       \"Cache needs to be built again.\");\n-\n   XNNPACK_RETURN_CHECK(header.buffer_list_offset < mmap_handle.size(),\n                        \"invalid offset for buffer list descriptor.\");\n \n@@ -430,6 +460,8 @@ bool MMapWeightCacheProvider::Load() {\n   XNNPACK_RETURN_CHECK(buffer_list,\n                        \"could not get packed weights from flatbuffer.\");\n \n+  XNNPACK_RETURN_CHECK(CheckFingerprints(buffer_list));\n+\n   mmap_buffer_base_offset_ = buffer_list->base_offset();\n   if (const auto buffers = buffer_list->buffers(); buffers) {\n     for (auto* buffer : *buffers) {\n@@ -584,7 +616,8 @@ size_t MMapWeightCacheProvider::LookUpOrInsert(\n     return offset_it->second.offset;\n   }\n \n-  const BufferLocation location = builder_.Append(pack_id, ptr, size);\n+  const BufferLocation location =\n+      builder_.Append(pack_id, ptr, size, cache_key->fingerprint_id);\n   XNNPACK_ABORT_CHECK(!location.IsInvalid(),\n                       \"Inserting data in the cache failed.\");\n   cache_key_to_offset_.emplace(pack_id, location);\n@@ -693,10 +726,20 @@ bool IsCompatibleCacheFile(FileDescriptorView fd) {\n                        \"Cache header version is incompatible. Expected %\" PRIu64\n                        \", got %\" PRIu64 \".\",\n                        XNNPackCacheHeader::kVersion, header.version);\n-  XNNPACK_RETURN_CHECK(xnn_experimental_check_build_identifier(\n-                           header.xnnpack_build_identifier,\n-                           sizeof(header.xnnpack_build_identifier)),\n-                       \"Cache header build identifier is different.\");\n+\n+  fd.SetPos(header.buffer_list_offset);\n+  auto buffer = std::make_unique<uint8_t[]>(header.buffer_list_size);\n+  XNNPACK_RETURN_CHECK(fd.Read(buffer.get(), header.buffer_list_size));\n+\n+  flatbuffers::Verifier verifier(buffer.get(), header.buffer_list_size);\n+  XNNPACK_RETURN_CHECK(cache::schema::VerifyBufferListBuffer(verifier),\n+                       \"buffer list validation failed.\");\n+\n+  const cache::schema::BufferList* buffer_list =\n+      cache::schema::GetBufferList(buffer.get());\n+  XNNPACK_RETURN_CHECK(buffer_list,\n+                       \"could not get packed weights from flatbuffer.\");\n+  XNNPACK_RETURN_CHECK(CheckFingerprints(buffer_list));\n   return true;\n }\n "
        },
        {
            "sha": "781422b4bec6620d49fa67e58098710601fbdb0c",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.h",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -56,9 +56,8 @@ inline constexpr char kInMemoryCachePath[] = \":memory\";\n // When reading a cache file, the cache should be rejected if `version`\n // doesn't match `kVersion`.\n struct XNNPackCacheHeader {\n-  enum : uint64_t { kInvalidHeader = 0, kVersion = 1 };\n+  enum : uint64_t { kInvalidHeader = 0, kVersion = 2 };\n   uint64_t version;\n-  uint8_t xnnpack_build_identifier[32];\n   uint64_t buffer_list_offset;\n   uint64_t buffer_list_size;\n };\n@@ -161,8 +160,8 @@ class WeightCacheBuilder {\n   // The buffer space must have been reserved before using `Reserve`. If not, a\n   // new call to `Reserve` will be done and the data will be copied over.\n   [[nodiscard /*The location to the appended data should be saved.*/]]\n-  BufferLocation Append(PackIdentifier pack_id, const void* data,\n-                        uint64_t size);\n+  BufferLocation Append(PackIdentifier pack_id, const void* data, uint64_t size,\n+                        int fingerprint_id);\n \n   // Writes the flatbuffer to disk.\n   [[nodiscard /*Writing the weight cache can fail.*/]]"
        },
        {
            "sha": "37f19612010709f4df38b0c829afe356661ffe75",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache_schema.fbs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_schema.fbs",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_schema.fbs",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_schema.fbs?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -32,11 +32,14 @@ table Buffer {\n }\n \n table BufferList {\n+  /// A list of packing fingerprints. All of these need to be checked when\n+  /// loading the cache to ensure that it is compatible.\n+  fingerprints: [uint64];\n   /// A list of buffers.\n   buffers: [Buffer];\n   /// Defines the base offset for the data in the file. That offset\n   /// may be needed to guarantee data alignment.\n-  base_offset:uint64;\n+  base_offset: uint64;\n }\n \n root_type BufferList;"
        },
        {
            "sha": "c1e4071ff4a3537f5face3f0b7b0635a2a05cc27",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache_test.cc",
            "status": "modified",
            "additions": 134,
            "deletions": 58,
            "changes": 192,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -35,6 +35,7 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"experimental.h\"  // from @XNNPACK\n #include \"xnnpack.h\"  // from @XNNPACK\n #include \"flatbuffers/verifier.h\"  // from @flatbuffers\n #include \"tensorflow/lite/c/common.h\"\n@@ -56,7 +57,13 @@ namespace {\n \n using testing::ElementsAreArray;\n \n-TEST(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n+static xnn_fingerprint kDefaultFingerprint{/*id=*/0xf00d, /*value=*/0xb33f};\n+\n+struct WeightCacheBuilderTest : testing::Test {\n+  void SetUp() override { xnn_set_fingerprint(kDefaultFingerprint); }\n+};\n+\n+TEST_F(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n   using std::size;\n \n   const std::string payload = \"This is some data in the file.\";\n@@ -72,7 +79,8 @@ TEST(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n   const size_t payload_size = size(payload);\n   void* buffer = builder.Reserve(payload_size);\n   std::memcpy(buffer, payload.c_str(), payload_size);\n-  auto loc = builder.Append(dummy_id, buffer, payload_size);\n+  auto loc =\n+      builder.Append(dummy_id, buffer, payload_size, kDefaultFingerprint.id);\n \n   EXPECT_EQ(loc.size, payload_size);\n   EXPECT_GE(builder.capacity(), payload_size);\n@@ -123,7 +131,7 @@ TEST(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n   EXPECT_THAT(cache_data, ElementsAreArray(payload));\n }\n \n-TEST(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n+TEST_F(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   using std::size;\n \n   const std::string payload = \"This is some data in the file.\";\n@@ -137,7 +145,8 @@ TEST(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   ASSERT_TRUE(builder.StartBuildStep());\n \n   const size_t payload_size = size(payload);\n-  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size);\n+  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size,\n+                            kDefaultFingerprint.id);\n \n   EXPECT_EQ(loc.size, payload_size);\n \n@@ -186,7 +195,7 @@ TEST(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   EXPECT_THAT(cache_data, ElementsAreArray(payload));\n }\n \n-TEST(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n+TEST_F(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n   const std::string cache_path = testing::TempDir() + \"/cache\";\n   const std::string payload = \"This is some data in the file.\";\n   const PackIdentifier dummy_id{1, 2, 3};\n@@ -198,7 +207,8 @@ TEST(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n   ASSERT_TRUE(builder.StartBuildStep());\n \n   const size_t payload_size = size(payload);\n-  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size);\n+  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size,\n+                            kDefaultFingerprint.id);\n   EXPECT_EQ(loc.size, payload_size);\n   ASSERT_TRUE(builder.StopBuildStep());\n \n@@ -218,13 +228,13 @@ TEST(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n   EXPECT_FALSE(builder.StartBuildStep());\n }\n \n-TEST(WeightCacheBuilderTest, InvalidFileDescriptorFails) {\n+TEST_F(WeightCacheBuilderTest, InvalidFileDescriptorFails) {\n   WeightCacheBuilder builder;\n   EXPECT_FALSE(builder.Start(\"\", FileDescriptor()));\n   EXPECT_FALSE(builder.Start(\"/seldf/sedsft\", FileDescriptor()));\n }\n \n-TEST(WeightCacheBuilderTest, InMemoryCacheCanBeBuilt) {\n+TEST_F(WeightCacheBuilderTest, InMemoryCacheCanBeBuilt) {\n   if (!TfLiteXNNPackDelegateCanUseInMemoryWeightCacheProvider()) {\n     GTEST_SKIP() << \"In-memory weight cache isn't enabled for this build or \"\n                     \"isn't supported by the current system, skipping test.\";\n@@ -239,7 +249,7 @@ TEST(WeightCacheBuilderTest, InMemoryCacheCanBeBuilt) {\n   EXPECT_EQ(errno, ENOENT);\n }\n \n-TEST(WeightCacheBuilderTest, MultipleStepBuild) {\n+TEST_F(WeightCacheBuilderTest, MultipleStepBuild) {\n   using std::size;\n \n   const std::string payload1 = \"This is some data in the file.\";\n@@ -262,15 +272,17 @@ TEST(WeightCacheBuilderTest, MultipleStepBuild) {\n     const size_t payload_size = size(payload1);\n     void* buffer = builder.Reserve(payload_size);\n     std::memcpy(buffer, payload1.c_str(), payload_size);\n-    const auto loc = builder.Append(dummy_id1, buffer, payload_size);\n+    const auto loc =\n+        builder.Append(dummy_id1, buffer, payload_size, kDefaultFingerprint.id);\n     EXPECT_EQ(loc.size, payload_size);\n     EXPECT_GE(builder.capacity(), payload_size);\n   }\n   {\n     const size_t payload_size = size(payload3);\n     void* buffer = builder.Reserve(payload_size);\n     std::memcpy(buffer, payload3.c_str(), payload_size);\n-    const auto loc = builder.Append(dummy_id3, buffer, payload_size);\n+    const auto loc =\n+        builder.Append(dummy_id3, buffer, payload_size, kDefaultFingerprint.id);\n     (void)loc;\n   }\n \n@@ -284,7 +296,8 @@ TEST(WeightCacheBuilderTest, MultipleStepBuild) {\n     const size_t payload_size = size(payload2);\n     void* buffer = builder.Reserve(payload_size);\n     std::memcpy(buffer, payload2.c_str(), payload_size);\n-    const auto loc = builder.Append(dummy_id2, buffer, payload_size);\n+    const auto loc =\n+        builder.Append(dummy_id2, buffer, payload_size, kDefaultFingerprint.id);\n     EXPECT_EQ(loc.size, payload_size);\n     EXPECT_GE(builder.capacity(), payload_size);\n   }\n@@ -389,7 +402,8 @@ struct FakeContext {\n                                           const int weights_index) const {\n     return {.seed = algorithm_seed,\n             .kernel = buffers[weights_index].data(),\n-            .bias = nullptr};\n+            .bias = nullptr,\n+            .fingerprint_id = kDefaultFingerprint.id};\n   }\n \n   // Creates a look up key for the XNNPack weight provider C interface.\n@@ -398,7 +412,8 @@ struct FakeContext {\n                                           const int bias_index) const {\n     return {.seed = algorithm_seed,\n             .kernel = buffers[weights_index].data(),\n-            .bias = buffers[bias_index].data()};\n+            .bias = buffers[bias_index].data(),\n+            .fingerprint_id = kDefaultFingerprint.id};\n   }\n \n   // Helps creating fake packed data.\n@@ -505,6 +520,7 @@ struct BuildMMapWeightCacheProviderTest : testing::TestWithParam<TestVariant> {\n       GTEST_SKIP() << \"In-memory weight cache isn't enabled for this build or \"\n                       \"isn't supported by the current system, skipping test.\";\n     }\n+    xnn_set_fingerprint(kDefaultFingerprint);\n     AddTensors();\n     EndSetup();\n   }\n@@ -723,6 +739,7 @@ struct MMapWeightCacheProviderTest : testing::TestWithParam<TestVariant> {\n       GTEST_SKIP() << \"In-memory weight cache isn't enabled for this build or \"\n                       \"isn't supported by the current system, skipping test.\";\n     }\n+    xnn_set_fingerprint(kDefaultFingerprint);\n   }\n   bool use_explicit_fd = GetParam().use_explicit_fd;\n   const char* const explicit_fd_path = GetParam().explicit_fd_path;\n@@ -783,12 +800,14 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n     const xnn_weights_cache_look_up_key look_up_key_1{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[0].data.data,\n-        .bias = tensors[1].data.data};\n+        .bias = tensors[1].data.data,\n+        .fingerprint_id = kDefaultFingerprint.id};\n \n     const xnn_weights_cache_look_up_key look_up_key_3{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[3].data.data,\n-        .bias = tensors[4].data.data};\n+        .bias = tensors[4].data.data,\n+        .fingerprint_id = kDefaultFingerprint.id};\n \n     // Lookup non-packed tensor.\n     ASSERT_EQ(cache->look_up(cache, &look_up_key_1), SIZE_MAX);\n@@ -829,7 +848,8 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n     const xnn_weights_cache_look_up_key look_up_key_2{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[2].data.data,\n-        .bias = tensors[3].data.data};\n+        .bias = tensors[3].data.data,\n+        .fingerprint_id = kDefaultFingerprint.id};\n \n     const size_t build_offset_2 = cache->look_up_or_insert(\n         cache, &look_up_key_2, (void*)packed_data_ref_2,\n@@ -904,17 +924,20 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n     const xnn_weights_cache_look_up_key look_up_key_1{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[0].data.data,\n-        .bias = tensors[1].data.data};\n+        .bias = tensors[1].data.data,\n+        .fingerprint_id = kDefaultFingerprint.id};\n \n     const xnn_weights_cache_look_up_key look_up_key_2{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[2].data.data,\n-        .bias = tensors[3].data.data};\n+        .bias = tensors[3].data.data,\n+        .fingerprint_id = kDefaultFingerprint.id};\n \n     const xnn_weights_cache_look_up_key look_up_key_3{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[3].data.data,\n-        .bias = tensors[4].data.data};\n+        .bias = tensors[4].data.data,\n+        .fingerprint_id = kDefaultFingerprint.id};\n \n     ASSERT_TRUE(cache->is_finalized(cache));\n \n@@ -945,30 +968,59 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n   }\n }\n \n-TEST_P(MMapWeightCacheProviderTest, XnnpackRebuildOnVersionMismatch) {\n+TEST_P(MMapWeightCacheProviderTest, CacheIsRebuiltOnFingerprintMismatch) {\n+  if (use_in_memory_cache) {\n+    GTEST_SUCCEED() << \"In-memory cache is never reloaded.\";\n+    return;\n+  }\n   TempFileDesc temp_fd;\n   const char* temp_fd_cpath = explicit_fd_path;\n-  FileDescriptor temp_fd_value = temp_fd.Duplicate();\n \n-  {  // Set bad build identifier\n-    XNNPackCacheHeader header{.version = XNNPackCacheHeader::kVersion};\n-    header.xnnpack_build_identifier[0] += 1;\n-    ASSERT_TRUE(temp_fd_value.Write(&header, sizeof(header)));\n+  xnn_fingerprint test_fingeprint{0x7357, 0xF33D};\n+  {  // Build a cache file with a specific fingerprint.\n+    // Clear fingerprints and add a test fingerprint to XNNPack.\n+    xnn_clear_fingerprints();\n+    xnn_set_fingerprint(test_fingeprint);\n+\n+    // Build a cache file.\n+    MMapWeightCacheProvider cache_provider;\n+\n+    const char kernel[] = \"Fake data.\";\n+    TfLiteTensor tensor;\n+    tensor.data.data = (void*)kernel;\n+    cache_provider.MapTensorIdentifiers(\n+        &tensor, /*size=*/1, /*tensor_index_to_identifier=*/{{0, 1}});\n+    ASSERT_TRUE(\n+        cache_provider.LoadOrStartBuild(temp_fd_cpath, temp_fd.Duplicate()));\n+    ASSERT_TRUE(cache_provider.StartBuildStep());\n+    const xnn_weights_cache_look_up_key look_up_key_1{\n+        .seed = 1234,\n+        .kernel = kernel,\n+        .bias = nullptr,\n+        .fingerprint_id = test_fingeprint.id};\n+    xnn_weights_cache_t cache = &cache_provider.GetCacheProvider();\n+    const size_t build_offset_1 = cache->look_up_or_insert(\n+        cache, &look_up_key_1,\n+        const_cast<void*>(reinterpret_cast<const void*>(kernel)),\n+        sizeof(kernel));\n+    (void)build_offset_1;\n+    ASSERT_TRUE(cache_provider.StopBuildStep());\n   }\n \n   if (!use_explicit_fd) {\n     temp_fd.Close();\n     temp_fd_cpath = temp_fd.GetCPath();\n-    temp_fd_value.Close();\n-    if (use_in_memory_cache) {\n-      temp_fd_cpath = kInMemoryCachePath;\n-    }\n   }\n \n+  // Change the test fingerprint value.\n+  test_fingeprint.value = 0xdeadb33f;\n+  xnn_set_fingerprint(test_fingeprint);\n+\n+  // Reload the file.\n   auto build_cache_provider = std::make_unique<MMapWeightCacheProvider>();\n   MMapWeightCacheProvider& cache_provider = *build_cache_provider;\n-  ASSERT_TRUE(cache_provider.LoadOrStartBuild(temp_fd_cpath,\n-                                              temp_fd_value.Duplicate()));\n+  ASSERT_TRUE(\n+      cache_provider.LoadOrStartBuild(temp_fd_cpath, temp_fd.Duplicate()));\n   ASSERT_TRUE(cache_provider.StartBuildStep());\n }\n \n@@ -980,29 +1032,53 @@ class IsCompatibleCacheFileTest\n   using Param = IsCompatibleCacheFileTestOverload;\n \n   void SetUp() override {\n-    header_.version = XNNPackCacheHeader::kVersion;\n-    memcpy(header_.xnnpack_build_identifier,\n-           xnn_experimental_get_build_identifier_data(),\n-           xnn_experimental_get_build_identifier_size());\n+    xnn_clear_fingerprints();\n+    xnn_set_fingerprint(kDefaultFingerprint);\n+\n+    // Build a cache file.\n+    MMapWeightCacheProvider cache_provider;\n+\n+    const char kernel[] = \"Fake data.\";\n+    TfLiteTensor tensor;\n+    tensor.data.data = (void*)kernel;\n+    cache_provider.MapTensorIdentifiers(\n+        &tensor, /*size=*/1, /*tensor_index_to_identifier=*/{{0, 1}});\n+    ASSERT_TRUE(\n+        cache_provider.LoadOrStartBuild(fd_.GetCPath(), fd_.Duplicate()));\n+    ASSERT_TRUE(cache_provider.StartBuildStep());\n+    const xnn_weights_cache_look_up_key look_up_key_1{\n+        .seed = 1234,\n+        .kernel = kernel,\n+        .bias = nullptr,\n+        .fingerprint_id = kDefaultFingerprint.id};\n+    xnn_weights_cache_t cache = &cache_provider.GetCacheProvider();\n+    const size_t build_offset_1 = cache->look_up_or_insert(\n+        cache, &look_up_key_1,\n+        const_cast<void*>(reinterpret_cast<const void*>(kernel)),\n+        sizeof(kernel));\n+    (void)build_offset_1;\n+    ASSERT_TRUE(cache_provider.StopBuildStep());\n   }\n \n-  bool WriteHeaderAndReturnIsCompatibleCacheFile() {\n-    if (!fd_.Write(&header_, sizeof(header_))) {\n-      return false;\n-    }\n-    if (GetParam() == Param::kPath) {\n-      fd_.Close();\n-      return IsCompatibleCacheFile(fd_.GetCPath());\n-    } else {\n-      const FileDescriptor::Offset pos = fd_.GetPos();\n-      EXPECT_NE(pos, 0);  // Ensure that we are testing with a non 0 position.\n-      const bool compatible = IsCompatibleCacheFile(fd_);\n-      EXPECT_EQ(pos, fd_.GetPos());\n-      return compatible;\n+  void ChangeRuntimeFingerprintValue() {\n+    xnn_set_fingerprint(\n+        {kDefaultFingerprint.id, kDefaultFingerprint.value + 1});\n+  }\n+\n+  bool CallIsCompatibleCacheFile() {\n+    switch (GetParam()) {\n+      case Param::kPath:\n+        fd_.Close();\n+        return IsCompatibleCacheFile(fd_.GetCPath());\n+      case Param::kDescriptor: {\n+        const auto pos = fd_.GetPos();\n+        EXPECT_NE(pos, 0);  // We test with a non zero position.\n+        return IsCompatibleCacheFile(fd_);\n+        EXPECT_EQ(fd_.GetPos(), pos);\n+      }\n     }\n   }\n \n-  XNNPackCacheHeader header_{};\n   TempFileDesc fd_;\n };\n \n@@ -1016,18 +1092,18 @@ std::string Name(\n   }\n }\n \n-TEST_P(IsCompatibleCacheFileTest, ReturnsTrueForACorrectHeader) {\n-  EXPECT_TRUE(WriteHeaderAndReturnIsCompatibleCacheFile());\n+TEST_P(IsCompatibleCacheFileTest, ReturnsTrueWhenFingerprintMatches) {\n+  EXPECT_TRUE(CallIsCompatibleCacheFile());\n }\n \n-TEST_P(IsCompatibleCacheFileTest, ReturnsFalseForWrongHeaderVersion) {\n-  header_.version += 1;\n-  EXPECT_FALSE(WriteHeaderAndReturnIsCompatibleCacheFile());\n+TEST_P(IsCompatibleCacheFileTest, ReturnsFalseWhenFingerprintMismatches) {\n+  ChangeRuntimeFingerprintValue();\n+  EXPECT_FALSE(CallIsCompatibleCacheFile());\n }\n \n-TEST_P(IsCompatibleCacheFileTest, ReturnsFalseForWrongBuildIdentifier) {\n-  header_.xnnpack_build_identifier[0] += 1;\n-  EXPECT_FALSE(WriteHeaderAndReturnIsCompatibleCacheFile());\n+TEST_P(IsCompatibleCacheFileTest, ReturnsFalseWhenFingerprintIsNotFound) {\n+  xnn_clear_fingerprints();\n+  EXPECT_FALSE(CallIsCompatibleCacheFile());\n }\n \n INSTANTIATE_TEST_SUITE_P("
        },
        {
            "sha": "14e4370cbbd929dc92659815ad42edefc5a5ce4c",
            "filename": "tensorflow/lite/tools/cmake/modules/xnnpack.cmake",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Ftools%2Fcmake%2Fmodules%2Fxnnpack.cmake",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b61eec06ba2207565262390ef1a36b3aa8dfbd1/tensorflow%2Flite%2Ftools%2Fcmake%2Fmodules%2Fxnnpack.cmake",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Ftools%2Fcmake%2Fmodules%2Fxnnpack.cmake?ref=1b61eec06ba2207565262390ef1a36b3aa8dfbd1",
            "patch": "@@ -49,5 +49,6 @@ include_directories(\n    \"${PTHREADPOOL_SOURCE_DIR}/include\"\n    \"${FP16_SOURCE_DIR}/include\"\n    \"${XNNPACK_SOURCE_DIR}/include\"\n+   \"${XNNPACK_SOURCE_DIR}\"\n    \"${CPUINFO_SOURCE_DIR}/\"\n )"
        }
    ],
    "stats": {
        "total": 2553,
        "additions": 766,
        "deletions": 1787
    }
}