{
    "author": "akuegel",
    "message": "[XLA:GPU] Relax layout check in SortThunk.\n\nA difference in element size is ok.\nThe added test needs to be disabled because it does not work with PjrtTestBase\nyet (it does work with HloTestBase).\n\nPiperOrigin-RevId: 842651908",
    "sha": "3625c2be440dbcdd3deafca7773e28fa4a5f262b",
    "files": [
        {
            "sha": "4f38a16b7232d0e46b80e27f51c806777570b795",
            "filename": "third_party/xla/xla/service/gpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3625c2be440dbcdd3deafca7773e28fa4a5f262b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3625c2be440dbcdd3deafca7773e28fa4a5f262b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fthunk_emitter.cc?ref=3625c2be440dbcdd3deafca7773e28fa4a5f262b",
            "patch": "@@ -1564,12 +1564,12 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitSort(\n         sort->operand_count() > 1 ? ShapeIndex({i}) : ShapeIndex({});\n     // We assume that the layout of all involved operands and\n     // outputs is the same.\n-    TF_RET_CHECK(\n-        LayoutUtil::LayoutsInShapesEqual(keys_shape, sort->operand(i)->shape(),\n-                                         Layout::Equal().IgnoreMemorySpace()));\n+    TF_RET_CHECK(LayoutUtil::LayoutsInShapesEqual(\n+        keys_shape, sort->operand(i)->shape(),\n+        Layout::Equal().IgnoreMemorySpace().IgnoreElementSize()));\n     TF_RET_CHECK(LayoutUtil::LayoutsInShapesEqual(\n         keys_shape, ShapeUtil::GetSubshape(sort->shape(), shape_index),\n-        Layout::Equal().IgnoreMemorySpace()));\n+        Layout::Equal().IgnoreMemorySpace().IgnoreElementSize()));\n \n     BufferAllocation::Slice destination_buffer;\n     BufferAllocation::Slice source_address;"
        },
        {
            "sha": "c065c718707719465c741563a91311612a7f6c1c",
            "filename": "third_party/xla/xla/tests/sort_test.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3625c2be440dbcdd3deafca7773e28fa4a5f262b/third_party%2Fxla%2Fxla%2Ftests%2Fsort_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3625c2be440dbcdd3deafca7773e28fa4a5f262b/third_party%2Fxla%2Fxla%2Ftests%2Fsort_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fsort_test.cc?ref=3625c2be440dbcdd3deafca7773e28fa4a5f262b",
            "patch": "@@ -91,6 +91,29 @@ TEST_F(SortTest, SortTwiceWithSameComparator) {\n   EXPECT_TRUE(RunAndCompare(hlo_text_module, ErrorSpec{0.0, 0.0}));\n }\n \n+// TODO(b/456833594): Enable this test once PJRT packs int4 types.\n+TEST_F(SortTest, DISABLED_SortTuple) {\n+  absl::string_view hlo_text_module = R\"(\n+    HloModule sort\n+\n+    compare {\n+      p.0.lhs = s4[] parameter(0)\n+      p.0.rhs = s4[] parameter(1)\n+      p.1.lhs = s32[] parameter(2)\n+      p.1.rhs = s32[] parameter(3)\n+      ROOT lt = pred[] compare(p.0.lhs, p.0.rhs), direction=LT\n+    }\n+\n+    ENTRY main {\n+      p0 = s4[2,1452]{1,0} parameter(0)\n+      p1 = s32[2,1452]{1,0} iota(), iota_dimension=1\n+      ROOT sort = (s4[2,1452]{1,0}, s32[2,1452]{1,0}) sort(p0, p1), dimensions={1}, is_stable=true, to_apply=compare\n+    }\n+  )\";\n+\n+  EXPECT_TRUE(RunAndCompare(hlo_text_module, ErrorSpec{0.0, 0.0}));\n+}\n+\n class SortManyInputsTest : public SortTest,\n                            public ::testing::WithParamInterface<int> {\n  public:"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 27,
        "deletions": 4
    }
}