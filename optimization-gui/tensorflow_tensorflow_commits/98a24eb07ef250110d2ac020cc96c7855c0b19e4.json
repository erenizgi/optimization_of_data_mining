{
    "author": "fergushenderson",
    "message": "Fix test breakage when address/memory/thread sanitizer was enabled.\n\nUpdate the production code to not set the `*_allocated_bytes` fields\nwhen using address/memory/thread sanitizer, since those sanitizers don't\nsupport `mallinfo()` -- `mallinfo()` may return invalid results when sanitizers\nare enabled .\n\nUpdate test to not expect the `*_allocated_bytes` fields to be valid when using\naddress/memory/thread sanitizer.\n\nAlso update docs in `memory_info.h` to make it clearer that even if `isSupported()`\nreturns true, it is possible that only _some_ of the fields are supported.\n\nAlso document that `memory_info.h` supports Windows; this was already clear from\nother parts of the header file that described the behaviour on Windows.\n\nPiperOrigin-RevId: 825505016",
    "sha": "98a24eb07ef250110d2ac020cc96c7855c0b19e4",
    "files": [
        {
            "sha": "dc9b262623643e8a3a88d4df60e7be4b87882bae",
            "filename": "tensorflow/lite/profiling/memory_info.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/98a24eb07ef250110d2ac020cc96c7855c0b19e4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/98a24eb07ef250110d2ac020cc96c7855c0b19e4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info.cc?ref=98a24eb07ef250110d2ac020cc96c7855c0b19e4",
            "patch": "@@ -92,7 +92,9 @@ MemoryUsage GetMemoryUsage() {\n       result.private_footprint_bytes = (vm_swap_kb + res.ru_maxrss) * 1024;\n     }\n   }\n-#if defined(__NO_MALLINFO__) || !defined(__GLIBC__)\n+#if defined(__NO_MALLINFO__) || !defined(__GLIBC__) ||         \\\n+    defined(ADDRESS_SANITIZER) || defined(MEMORY_SANITIZER) || \\\n+    defined(THREAD_SANITIZER)\n   result.total_allocated_bytes = -1;\n   result.in_use_allocated_bytes = -1;\n #elif __GLIBC_MINOR__ >= 33\n@@ -103,7 +105,9 @@ MemoryUsage GetMemoryUsage() {\n   const auto mem = mallinfo();\n   result.total_allocated_bytes = mem.arena;\n   result.in_use_allocated_bytes = mem.uordblks;\n-#endif  // defined(__NO_MALLINFO__)\n+#endif  // defined(__NO_MALLINFO__) || !defined(__GLIBC__) || \\\n+        // defined(ADDRESS_SANITIZER) || defined(MEMORY_SANITIZER) ||\n+        // defined(THREAD_SANITIZER)\n #elif defined(__APPLE__)\n   struct task_vm_info vm_info;\n   mach_msg_type_number_t count = TASK_VM_INFO_COUNT;"
        },
        {
            "sha": "0416c9148fd27a5c7da16f13a4016630c6ec7f8e",
            "filename": "tensorflow/lite/profiling/memory_info.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/98a24eb07ef250110d2ac020cc96c7855c0b19e4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/98a24eb07ef250110d2ac020cc96c7855c0b19e4/tensorflow%2Flite%2Fprofiling%2Fmemory_info.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info.h?ref=98a24eb07ef250110d2ac020cc96c7855c0b19e4",
            "patch": "@@ -30,6 +30,9 @@ struct MemoryUsage {\n \n   // Indicates whether obtaining memory usage is supported on the platform, thus\n   // indicating whether the values defined in this struct make sense or not.\n+  // Note that even if this returns true, some of the fields in the struct may\n+  // not be supported by GetMemoryUsage(); in such cases, unsupported fields\n+  // will be set to kValueNotSet (zero) or -1.\n   static bool IsSupported();\n \n   MemoryUsage()\n@@ -127,7 +130,7 @@ struct MemoryUsage {\n };\n \n // Return the memory usage from the system.\n-// Note: this currently only works on Linux-based and Apple systems.\n+// Note: this currently only works on Linux-based, Apple, and Windows systems.\n MemoryUsage GetMemoryUsage();\n \n }  // namespace memory"
        },
        {
            "sha": "4a174cbb2f6ddced05ac9ddda8d81b141f7ce90c",
            "filename": "tensorflow/lite/profiling/memory_info_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/98a24eb07ef250110d2ac020cc96c7855c0b19e4/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/98a24eb07ef250110d2ac020cc96c7855c0b19e4/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc?ref=98a24eb07ef250110d2ac020cc96c7855c0b19e4",
            "patch": "@@ -15,7 +15,6 @@ limitations under the License.\n #include \"tensorflow/lite/profiling/memory_info.h\"\n \n #include <memory>\n-#include <new>\n #include <sstream>\n #include <string>\n \n@@ -75,10 +74,28 @@ TEST(MemoryUsage, GetMemoryUsage) {\n   }\n \n   EXPECT_GE(result.mem_footprint_kb, size / 1024);\n+#if !defined(__linux__) ||                                        \\\n+    (!defined(ADDRESS_SANITIZER) && !defined(MEMORY_SANITIZER) && \\\n+     !defined(THREAD_SANITIZER))\n   EXPECT_GE(result.total_allocated_bytes, size);\n   EXPECT_GE(result.in_use_allocated_bytes, size);\n+#else\n+  // The mallinfo() function, which is used on Linux, returns invalid\n+  // results when address/memory/thread sanitizer is enabled, e.g.\n+  // <https://github.com/google/sanitizers/issues/1845>, so the\n+  // *_allocated_bytes fields are not supported in those cases,\n+  // and should be set to either -1 or kValueNotSet(0).\n+  if (result.total_allocated_bytes != -1) {\n+    EXPECT_EQ(result.total_allocated_bytes, MemoryUsage::kValueNotSet);\n+  }\n+  if (result.in_use_allocated_bytes != -1) {\n+    EXPECT_EQ(result.in_use_allocated_bytes, MemoryUsage::kValueNotSet);\n+  }\n+#endif  // !defined(__linux__) ||                                        \\\n+        // (!defined(ADDRESS_SANITIZER) && !defined(MEMORY_SANITIZER) && \\\n+        //  !defined(THREAD_SANITIZER))\n   EXPECT_GE(result.private_footprint_bytes, size);\n-#endif\n+#endif  // defined(__linux__) || defined(__APPLE__) || defined(_WIN32)\n }\n \n // The main aim of this test is just to exercise the code for"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 29,
        "deletions": 5
    }
}