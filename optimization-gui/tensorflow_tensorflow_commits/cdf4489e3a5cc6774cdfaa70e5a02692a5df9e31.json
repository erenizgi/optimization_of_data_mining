{
    "author": "tensorflower-gardener",
    "message": "Update layout only when ```allow_spmd_sharding_propagation_to_output/parameter``` is true.\n\nOld GSPMD propagation needs them since they do not have the concept of open/closed sharding. In Shardy with sdy-round-trip, JAX creates the correct open/closed shardings for parameters and results. We do not need these vectors at all.\n\nBefore this change, we always canonicalize layout at after Shardy propagaiton, which may be redundant.\n\nPiperOrigin-RevId: 834684933",
    "sha": "cdf4489e3a5cc6774cdfaa70e5a02692a5df9e31",
    "files": [
        {
            "sha": "336d7855e2932397a12ece61707acfedb69f3d00",
            "filename": "third_party/xla/xla/service/spmd/shardy/shardy_xla_pass.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cdf4489e3a5cc6774cdfaa70e5a02692a5df9e31/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cdf4489e3a5cc6774cdfaa70e5a02692a5df9e31/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.cc?ref=cdf4489e3a5cc6774cdfaa70e5a02692a5df9e31",
            "patch": "@@ -504,13 +504,11 @@ absl::StatusOr<bool> ShardyXLA::RunImpl(\n       std::move(flattenedInputOutputAliasConfig));\n   hloModule->set_buffer_donor_config(std::move(flattenedBufferDonorsConfig));\n \n-  // Shardy currently propagates shardings to parameters and root\n-  // instructions. Hence, we specify `true` for update_output_layout and\n-  // update_parameters_layout.\n   TF_RETURN_IF_ERROR(\n       hlo_sharding_util::CanonicalizeLayoutAfterShardingPropagation(\n-          hloModule, /*update_output_layout=*/{true},\n-          /*update_parameters_layout=*/{true}));\n+          hloModule,\n+          hloModule->config().allow_spmd_sharding_propagation_to_output(),\n+          hloModule->config().allow_spmd_sharding_propagation_to_parameters()));\n \n   // We don't fully replace the HLO module, so it will continue to have the\n   // temporary frontend attributes. So clean them up as XLA won't need them."
        }
    ],
    "stats": {
        "total": 8,
        "additions": 3,
        "deletions": 5
    }
}