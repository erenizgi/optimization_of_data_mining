{
    "author": "ishark",
    "message": "Add the reconnected task to unsynced tasks, when leave ongoing barrier is set.\n\nThis path calling task_state->connect was missed before.\n\nAlso add some more log info for easier debugging when failure occurs.\n\nPiperOrigin-RevId: 799286877",
    "sha": "1fd36b500eb3d804faa2eb2ed77549c98a1ac311",
    "files": [
        {
            "sha": "0f4ffb129146109a1b396f43909c9eea1c8ceefd",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 6,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1fd36b500eb3d804faa2eb2ed77549c98a1ac311/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1fd36b500eb3d804faa2eb2ed77549c98a1ac311/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service.cc?ref=1fd36b500eb3d804faa2eb2ed77549c98a1ac311",
            "patch": "@@ -301,9 +301,11 @@ CoordinationService::GetCountOfOutOfSyncTasksPerBarrier() {\n       }\n     }\n   }\n-  VLOG(1) << \"out_of_sync_tasks_per_barrier: \"\n-          << absl::StrJoin(out_of_sync_tasks_per_barrier, \",\",\n-                           absl::PairFormatter(\"=\"));\n+  if (!out_of_sync_tasks_per_barrier.empty()) {\n+    LOG(INFO) << \"out_of_sync_tasks_per_barrier: \"\n+              << absl::StrJoin(out_of_sync_tasks_per_barrier, \",\",\n+                               absl::PairFormatter(\"=\"));\n+  }\n \n   return out_of_sync_tasks_per_barrier;\n }\n@@ -525,9 +527,17 @@ CoordinationService::ConnectAfterBarrierPasses(absl::string_view task_name,\n           done = std::move(done)](absl::Status s,\n                                   int64_t unused_counter) mutable {\n     state_mu_.AssertHeld();\n-    if (s.ok() && incarnation == cluster_state_[task]->GetTaskIncarnation()) {\n+    const std::unique_ptr<TaskState>& task_state = cluster_state_[task];\n+    if (s.ok() && incarnation == task_state->GetTaskIncarnation()) {\n       // Connect task to service.\n-      cluster_state_[task]->Connect();\n+      task_state->Connect();\n+      if (task_state->IsRecoverable() &&\n+          absl::GetFlag(FLAGS_leave_barriers_on_recoverable_agent_restart)) {\n+        // We want to mark the task unsynced when it connects again. When the\n+        // task passes a barrier with other tasks, it will be removed from the\n+        // unsynced set.\n+        unsynced_recoverable_jobs_.insert(task);\n+      }\n       done(absl::OkStatus());\n       ClusterStateUpdated();\n     } else if (s.ok() || absl::IsCancelled(s)) {\n@@ -1328,6 +1338,9 @@ void CoordinationService::BarrierAsyncLocked(\n     // Initialize new barrier instance state.\n     if (!InitializeBarrier(barrier, barrier_id, counter, timeout, task,\n                            participating_tasks, done)) {\n+      LOG(WARNING) << \"Barrier init failed for barrier: \"\n+                   << BarrierName(barrier_id, counter)\n+                   << \" task: \" << GetTaskName(task);\n       return;  // Exit early if barrier init failed.\n     }\n   }\n@@ -1762,7 +1775,8 @@ void CoordinationService::ReachBarrier(BarrierState* barrier,\n         if (unsynced_recoverable_jobs_.contains(GetTaskName(task))) {\n           LOG(INFO)\n               << \"Removing task \" << GetTaskName(task)\n-              << \" from unsynced recoverable jobset, since it is synced now\";\n+              << \" from unsynced recoverable jobset, since it is synced now \"\n+              << \" with barrier \" << BarrierName(*barrier);\n           unsynced_recoverable_jobs_.erase(GetTaskName(task));\n         }\n       }"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 20,
        "deletions": 6
    }
}