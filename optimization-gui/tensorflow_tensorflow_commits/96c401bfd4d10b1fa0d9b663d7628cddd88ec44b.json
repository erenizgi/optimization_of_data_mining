{
    "author": "kadirb4rut",
    "message": "fix(saved_model_cli): sanitize tag_set/denylist inputs and error on whitespace-only; add unit tests",
    "sha": "96c401bfd4d10b1fa0d9b663d7628cddd88ec44b",
    "files": [
        {
            "sha": "62c538ad887714fbc9d4b4c0b92306a337af438e",
            "filename": "tensorflow/python/tools/saved_model_cli.py",
            "status": "modified",
            "additions": 36,
            "deletions": 16,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/96c401bfd4d10b1fa0d9b663d7628cddd88ec44b/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/96c401bfd4d10b1fa0d9b663d7628cddd88ec44b/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli.py?ref=96c401bfd4d10b1fa0d9b663d7628cddd88ec44b",
            "patch": "@@ -233,6 +233,19 @@\n     'aot_compile_cpu': ['cpp_class'],\n }\n \n+def _sanitize_nonempty_str_list(xs, name: str):\n+  \"\"\"Trim items, drop empties/None, require at least one non-empty string.\"\"\"\n+  out = []\n+  for x in xs:\n+    if x is None:\n+      continue\n+    s = str(x).strip()\n+    if s:\n+      out.append(s)\n+  if not out:\n+    raise ValueError(f'{name} must contain at least one non-empty item.')\n+  return out\n+\n \n def _show_tag_sets(saved_model_dir):\n   \"\"\"Prints the tag-sets stored in SavedModel directory.\n@@ -283,8 +296,9 @@ def _show_ops_in_metagraph(saved_model_dir, tag_set):\n     tag_set: Group of tag(s) of the MetaGraphDef in string format, separated by\n       ','. For tag-set contains multiple tags, all tags must be passed in.\n   \"\"\"\n-  meta_graph_def = saved_model_utils.get_meta_graph_def(saved_model_dir,\n-                                                        tag_set)\n+  tags = _sanitize_nonempty_str_list(tag_set.split(','), 'tag_set')\n+  meta_graph_def = saved_model_utils.get_meta_graph_def(\n+      saved_model_dir, ','.join(tags))\n   _show_ops_in_metagraph_mgd(meta_graph_def)\n \n \n@@ -342,8 +356,6 @@ def _get_outputs_tensor_info_from_meta_graph_def(meta_graph_def,\n   Args:\n     meta_graph_def: MetaGraphDef protocol buffer with the SignatureDefmap to\n     look up signature_def_key.\n-    signature_def_key: A SignatureDef key string.\n-\n   Returns:\n     A dictionary that maps output tensor keys to TensorInfos.\n   \"\"\"\n@@ -399,8 +411,9 @@ def _show_inputs_outputs(saved_model_dir, tag_set, signature_def_key, indent=0):\n     signature_def_key: A SignatureDef key string.\n     indent: How far (in increments of 2 spaces) to indent each line of output.\n   \"\"\"\n+  tags = _sanitize_nonempty_str_list(tag_set.split(','), 'tag_set')\n   meta_graph_def = saved_model_utils.get_meta_graph_def(\n-      saved_model_dir, tag_set\n+      saved_model_dir, ','.join(tags)\n   )\n   _show_inputs_outputs_mgd(meta_graph_def, signature_def_key, indent)\n \n@@ -601,7 +614,7 @@ def get_signature_def_map(saved_model_dir, tag_set):\n \n def _get_op_denylist_set(op_denylist):\n   # Note: Discard empty ops so that \"\" can mean the empty denylist set.\n-  set_of_denylisted_ops = set([op for op in op_denylist.split(',') if op])\n+  set_of_denylisted_ops = {op.strip() for op in op_denylist.split(',') if op and op.strip()}\n   return set_of_denylisted_ops\n \n \n@@ -671,8 +684,9 @@ def run_saved_model_with_feed_dict(saved_model_dir,\n     enabled.\n   \"\"\"\n   # Get a list of output tensor names.\n+  tags = _sanitize_nonempty_str_list(tag_set.split(','), 'tag_set')\n   meta_graph_def = saved_model_utils.get_meta_graph_def(saved_model_dir,\n-                                                        tag_set)\n+                                                        ','.join(tags))\n \n   # Re-create feed_dict based on input tensor name instead of key as session.run\n   # uses tensor name.\n@@ -713,7 +727,7 @@ def run_saved_model_with_feed_dict(saved_model_dir,\n       # restarts after a preemption.\n       sess.run(tpu.initialize_system())\n \n-    loader.load(sess, tag_set.split(','), saved_model_dir)\n+    loader.load(sess, tags, saved_model_dir)\n \n     if tf_debug:\n       sess = local_cli_wrapper.LocalCLIDebugWrapperSession(sess)\n@@ -1049,14 +1063,16 @@ def run():\n def scan():\n   \"\"\"Function triggered by scan command.\"\"\"\n   if _SMCLI_TAG_SET.value and _SMCLI_OP_DENYLIST.value:\n+    tags = ','.join(_sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set'))\n     scan_meta_graph_def(\n         saved_model_utils.get_meta_graph_def(\n-            _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n+            _SMCLI_DIR.value, tags),\n         _get_op_denylist_set(_SMCLI_OP_DENYLIST.value))\n   elif _SMCLI_TAG_SET.value:\n+    tags = ','.join(_sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set'))\n     scan_meta_graph_def(\n         saved_model_utils.get_meta_graph_def(\n-            _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n+            _SMCLI_DIR.value, tags),\n         _OP_DENYLIST)\n   else:\n     saved_model = saved_model_utils.read_saved_model(_SMCLI_DIR.value)\n@@ -1083,7 +1099,7 @@ def convert_with_tensorrt():\n     try:\n       converter = trt.TrtGraphConverterV2(\n           input_saved_model_dir=_SMCLI_DIR.value,\n-          input_saved_model_tags=_SMCLI_TAG_SET.value.split(','),\n+          input_saved_model_tags=_sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set'),\n           **params._asdict())\n       converter.convert()\n     except Exception as exc:\n@@ -1100,7 +1116,7 @@ def convert_with_tensorrt():\n         minimum_segment_size=_SMCLI_MINIMUM_SEGMENT_SIZE.value,\n         is_dynamic_op=True,\n         input_saved_model_dir=_SMCLI_DIR.value,\n-        input_saved_model_tags=_SMCLI_TAG_SET.value.split(','),\n+        input_saved_model_tags=_sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set'),\n         output_saved_model_dir=_SMCLI_OUTPUT_DIR.value)\n \n \n@@ -1114,12 +1130,14 @@ def freeze_model():\n   elif _SMCLI_VARIABLES_TO_FEED.value.lower() == 'all':\n     variables_to_feed = None  # We will identify them after.\n   else:\n-    variables_to_feed = _SMCLI_VARIABLES_TO_FEED.value.split(',')\n+    variables_to_feed = _sanitize_nonempty_str_list(\n+        _SMCLI_VARIABLES_TO_FEED.value.split(','), 'variables_to_feed')\n \n   saved_model_aot_compile.freeze_model(\n       checkpoint_path=checkpoint_path,\n       meta_graph_def=saved_model_utils.get_meta_graph_def(\n-          _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n+          _SMCLI_DIR.value,\n+          ','.join(_sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set'))),\n       signature_def_key=_SMCLI_SIGNATURE_DEF_KEY.value,\n       variables_to_feed=variables_to_feed,\n       output_prefix=_SMCLI_OUTPUT_PREFIX.value)\n@@ -1135,12 +1153,14 @@ def aot_compile_cpu():\n   elif _SMCLI_VARIABLES_TO_FEED.value.lower() == 'all':\n     variables_to_feed = None  # We will identify them after.\n   else:\n-    variables_to_feed = _SMCLI_VARIABLES_TO_FEED.value.split(',')\n+    variables_to_feed = _sanitize_nonempty_str_list(\n+        _SMCLI_VARIABLES_TO_FEED.value.split(','), 'variables_to_feed')\n \n   saved_model_aot_compile.aot_compile_cpu_meta_graph_def(\n       checkpoint_path=checkpoint_path,\n       meta_graph_def=saved_model_utils.get_meta_graph_def(\n-          _SMCLI_DIR.value, _SMCLI_TAG_SET.value),\n+          _SMCLI_DIR.value,\n+          ','.join(_sanitize_nonempty_str_list(_SMCLI_TAG_SET.value.split(','), 'tag_set'))),\n       signature_def_key=_SMCLI_SIGNATURE_DEF_KEY.value,\n       variables_to_feed=variables_to_feed,\n       output_prefix=_SMCLI_OUTPUT_PREFIX.value,"
        },
        {
            "sha": "013dce80c9717d6cbb6519dfec5090b35f36bb1b",
            "filename": "tensorflow/python/tools/saved_model_cli_sanitize_list_test.py",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/96c401bfd4d10b1fa0d9b663d7628cddd88ec44b/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli_sanitize_list_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/96c401bfd4d10b1fa0d9b663d7628cddd88ec44b/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli_sanitize_list_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Ftools%2Fsaved_model_cli_sanitize_list_test.py?ref=96c401bfd4d10b1fa0d9b663d7628cddd88ec44b",
            "patch": "@@ -0,0 +1,38 @@\n+# tensorflow/python/tools/saved_model_cli_sanitize_list_test.py\n+# Copyright 2025 The TensorFlow Authors.\n+# Licensed under the Apache License, Version 2.0\n+# pylint: disable=line-too-long\n+\n+\"\"\"Unit tests for trim & validation helpers in saved_model_cli.\"\"\"\n+\n+from absl.testing import parameterized\n+from tensorflow.python.platform import test\n+from tensorflow.python.tools import saved_model_cli as smcli\n+\n+\n+class SanitizeNonEmptyStrListTest(test.TestCase, parameterized.TestCase):\n+\n+  def test_trims_and_drops_empty_and_none(self):\n+    self.assertEqual(\n+        smcli._sanitize_nonempty_str_list([' a ', '', '\\t', None, 'b '], 'field'),\n+        ['a', 'b'])\n+\n+  def test_raises_on_all_empty_like_inputs(self):\n+    with self.assertRaisesRegex(ValueError, 'field.*at least one non-empty'):\n+      smcli._sanitize_nonempty_str_list(['  ', '\\n', '', None], 'field')\n+\n+\n+class DenylistParsingTest(test.TestCase, parameterized.TestCase):\n+\n+  @parameterized.parameters(\n+      ('OpA, OpB, , ,,OpC', {'OpA', 'OpB', 'OpC'}),\n+      ('  , , ', set()),\n+      ('', set()),\n+      (' ReadFile ,WriteFile , PrintV2', {'ReadFile', 'WriteFile', 'PrintV2'}),\n+  )\n+  def test_get_op_denylist_set_trims_and_ignores_empties(self, raw, expected):\n+    self.assertEqual(smcli._get_op_denylist_set(raw), expected)\n+\n+\n+if __name__ == '__main__':\n+  test.main()"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 74,
        "deletions": 16
    }
}