{
    "author": "tensorflower-gardener",
    "message": "Moves the profile uploading to be before FetchAndLogOutput so no trailing MemcpyD2H will be included in the trace data\n\nPiperOrigin-RevId: 802910040",
    "sha": "3fb83f7fe6af3e66f36a181f3ae47da08d89b674",
    "files": [
        {
            "sha": "3e6365ab225a8583d099a4b6b20b46d0db1dd8a5",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3fb83f7fe6af3e66f36a181f3ae47da08d89b674/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3fb83f7fe6af3e66f36a181f3ae47da08d89b674/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc?ref=3fb83f7fe6af3e66f36a181f3ae47da08d89b674",
            "patch": "@@ -579,6 +579,9 @@ absl::StatusOr<PerDeviceLiteralVecType> RunInternal(\n   std::vector<std::vector<std::unique_ptr<PjRtBuffer>>> device_buffers;\n   std::vector<std::vector<PjRtBuffer*>> argument_ptrs;\n   for (int repeat = 0; repeat < running_options.num_repeats; ++repeat) {\n+    const bool is_last_repeat = (repeat == running_options.num_repeats - 1);\n+    const bool profile_current_repeat =\n+        (running_options.profiler != nullptr) && is_last_repeat;\n     VLOG(1) << \"FunctionalHloRunner: ExecuteOnDevices started (repeat = \"\n             << repeat << \").\";\n     {\n@@ -592,29 +595,33 @@ absl::StatusOr<PerDeviceLiteralVecType> RunInternal(\n                                                 flatten_arguments));\n         argument_ptrs = CreateArgumentPointersFromDeviceBuffers(device_buffers);\n       }\n-      if (repeat == running_options.num_repeats - 1) {\n+      if (is_last_repeat) {\n         execute_options.untuple_result = default_untuple_result;\n-        if (running_options.profiler != nullptr) {\n-          running_options.profiler->CreateSession();\n-        }\n       }\n       execute_options.launch_id = repeat + 1 + running_options.base_run_id;\n       if (running_options.execution_profiles != nullptr) {\n         execute_options.execution_profile =\n             &running_options.execution_profiles->emplace_back();\n         execute_options.execution_profile->set_warmup_run_executed(repeat > 0);\n       }\n+\n+      if (profile_current_repeat) {\n+        running_options.profiler->CreateSession();\n+      }\n       futures->clear();\n       TF_ASSIGN_OR_RETURN(\n           output_buffers,\n           executable->Execute(argument_ptrs, execute_options, futures));\n       for (auto& future : *futures) {\n         TF_RETURN_IF_ERROR(future.Await());\n       }\n+      if (profile_current_repeat) {\n+        running_options.profiler->UploadSession();\n+      }\n     }\n     VLOG(1) << \"FunctionalHloRunner: ExecuteOnDevices succeeded (repeat = \"\n             << repeat << \")\";\n-    if (repeat < running_options.num_repeats - 1) {\n+    if (!is_last_repeat) {\n       switch (parameter_type) {\n         case ParameterType::kOneTupleOfArrays:\n           argument_ptrs = CreateArgumentPointersBasedOnAliasing(\n@@ -638,9 +645,6 @@ absl::StatusOr<PerDeviceLiteralVecType> RunInternal(\n                       FetchAndLogOutput(client, output_buffers,\n                                         running_options.module_output_mode,\n                                         running_options.log_input_output()));\n-  if (running_options.profiler != nullptr) {\n-    running_options.profiler->UploadSession();\n-  }\n   return results;\n }\n "
        }
    ],
    "stats": {
        "total": 20,
        "additions": 12,
        "deletions": 8
    }
}