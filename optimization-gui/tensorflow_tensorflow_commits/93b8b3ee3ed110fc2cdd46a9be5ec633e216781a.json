{
    "author": "ezhulenev",
    "message": "[xla] Keep Lazy<T> payload on heap to minimize memory footprint\n\nLazy<T> implies that the value is computed rarely, and it means that it's ok to move to to heap, to reduce the size of the parent object.\n\nPiperOrigin-RevId: 798323766",
    "sha": "93b8b3ee3ed110fc2cdd46a9be5ec633e216781a",
    "files": [
        {
            "sha": "8963fa3f6ae8614f01d701c24195d42e032f7f4e",
            "filename": "third_party/xla/xla/lazy.h",
            "status": "modified",
            "additions": 11,
            "deletions": 8,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/93b8b3ee3ed110fc2cdd46a9be5ec633e216781a/third_party%2Fxla%2Fxla%2Flazy.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/93b8b3ee3ed110fc2cdd46a9be5ec633e216781a/third_party%2Fxla%2Fxla%2Flazy.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Flazy.h?ref=93b8b3ee3ed110fc2cdd46a9be5ec633e216781a",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #ifndef XLA_LAZY_H_\n #define XLA_LAZY_H_\n \n+#include <memory>\n #include <variant>\n \n #include \"absl/functional/any_invocable.h\"\n@@ -24,22 +25,24 @@ namespace xla {\n \n template <typename T>\n class Lazy {\n+  using Value = std::unique_ptr<T>;\n+\n  public:\n-  explicit Lazy(absl::AnyInvocable<T() &&> func)\n-      : maybe_value_(std::move(func)) {}\n+  using Initializer = absl::AnyInvocable<T() &&>;\n+\n+  explicit Lazy(Initializer init) : data_(std::move(init)) {}\n \n-  bool has_value() const { return std::holds_alternative<T>(maybe_value_); }\n+  bool has_value() const { return std::holds_alternative<Value>(data_); }\n \n   const T& get() const {\n-    if (!std::holds_alternative<T>(maybe_value_)) {\n-      maybe_value_ =\n-          std::move(std::get<absl::AnyInvocable<T() &&>>(maybe_value_))();\n+    if (!has_value()) {\n+      data_ = std::make_unique<T>(std::move(std::get<Initializer>(data_))());\n     }\n-    return std::get<T>(maybe_value_);\n+    return *std::get<Value>(data_);\n   }\n \n  private:\n-  mutable std::variant<absl::AnyInvocable<T() &&>, T> maybe_value_;\n+  mutable std::variant<Initializer, Value> data_;\n };\n \n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 11,
        "deletions": 8
    }
}