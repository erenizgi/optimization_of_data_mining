{
    "author": "jsmeredith",
    "message": "Adding skeleton for alternative variation of restore ops.\n\nPiperOrigin-RevId: 803710961",
    "sha": "f4d036d5d254a989da124fc18f86fcd788be27ce",
    "files": [
        {
            "sha": "4d30d43c0ccdf6932ea18f785f4226d83c09f1bc",
            "filename": "tensorflow/compiler/mlir/tensorflow/ir/host_runtime/tfrt_ops.td",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftensorflow%2Fir%2Fhost_runtime%2Ftfrt_ops.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftensorflow%2Fir%2Fhost_runtime%2Ftfrt_ops.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftensorflow%2Fir%2Fhost_runtime%2Ftfrt_ops.td?ref=f4d036d5d254a989da124fc18f86fcd788be27ce",
            "patch": "@@ -188,4 +188,19 @@ def TF_PwStreamResultsOp : TF_Op<\"PwStreamResults\"> {\n   let hasVerifier = 1;\n }\n \n+ def TF_IfrtResourceDeserializeOp : TF_Op<\"IfrtResourceDeserialize\", []> {\n+   let summary = \"Deserialize resource vars.\";\n+   let description = [{\n+     This Op is a variant of IfrtResourceDeserialize for use with the\n+     TFRT/IFRT runtime. It is not a stable interface.\n+   }];\n+\n+   let arguments = (ins\n+     Arg<TF_ResourceTensor, \"The variable to change.\">:$resource_var,\n+     Arg<TF_StrTensor, \"The directory to read from.\">:$input_dir,\n+     DefaultValuedOptionalAttr<BoolAttr, \"true\">:$require_matching_crc,\n+     DefaultValuedOptionalAttr<StrAttr, \"\\\"\\\"\">:$tensor_name\n+   );\n+ }\n+\n #endif // TFRT_OPS"
        },
        {
            "sha": "d9b30a3661473981b4eb3d6e484e9dc90a1793f2",
            "filename": "tensorflow/compiler/mlir/tf2xla/transforms/legalization_op_config_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftf2xla%2Ftransforms%2Flegalization_op_config_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftf2xla%2Ftransforms%2Flegalization_op_config_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftf2xla%2Ftransforms%2Flegalization_op_config_test.cc?ref=f4d036d5d254a989da124fc18f86fcd788be27ce",
            "patch": "@@ -84,7 +84,7 @@ TEST(LegalizationOpConfigTest, CountLoweringsSet) {\n   // a new op, we should expect these to change too.\n   EXPECT_EQ(mlir_lowering_count, 67);\n   EXPECT_EQ(tf2xla_fallback_count, 333);\n-  EXPECT_EQ(non_categorized_count, 432);\n+  EXPECT_EQ(non_categorized_count, 433);\n }\n \n // Just a counter test to see which ops have duplicate lowerings. This isn't a"
        },
        {
            "sha": "441793d13bff7561b666d96dea7898a8ec0aa3ea",
            "filename": "tensorflow/compiler/mlir/tfrt/ir/mlrt/tf_mlrt_ops.td",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Fir%2Fmlrt%2Ftf_mlrt_ops.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Fir%2Fmlrt%2Ftf_mlrt_ops.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Fir%2Fmlrt%2Ftf_mlrt_ops.td?ref=f4d036d5d254a989da124fc18f86fcd788be27ce",
            "patch": "@@ -533,4 +533,17 @@ def IfrtRestoreVariableOp: TensorflowMlrt_Op<\"ifrt_restore_variable\", []> {\n   );\n }\n \n+def MlrtIfrtResourceDeserializeOp: TensorflowMlrt_Op<\"ifrt_resource_deserialize\", []> {\n+  let summary = \"Deserialize resource vars.\";\n+  let description = [{\n+    This is the MLRT version of the IfrtResourceDeserialize op.\n+  }];\n+\n+  let arguments = (ins\n+    TFTensorType:$resource_var,\n+    TFTensorType:$input_dir,\n+    StrAttr:$tensor_name\n+  );\n+}\n+\n #endif"
        },
        {
            "sha": "66d210e4df96c8e92bcd54a5b95475ccc503058c",
            "filename": "tensorflow/compiler/mlir/tfrt/tests/mlrt/tf_to_mlrt.mlir",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftests%2Fmlrt%2Ftf_to_mlrt.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftests%2Fmlrt%2Ftf_to_mlrt.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftests%2Fmlrt%2Ftf_to_mlrt.mlir?ref=f4d036d5d254a989da124fc18f86fcd788be27ce",
            "patch": "@@ -495,4 +495,15 @@ func.func @ifrt_restore_variable_test() -> () {\n   func.return\n }\n \n+// -----\n+\n+// Test lowering of tf.IfrtResourceDeserializeOp to tf_mlrt.ifrt_resource_deserialize\n+\n+// CHECK-LABEL: func @ifrt_resource_deserialize_test\n+func.func @ifrt_resource_deserialize_test(%arg0: tensor<!tf_type.resource<tensor<f32>>>) {\n+  %input_dir = \"tf.Const\"() { value = dense<\"some/path\"> : tensor<!tf_type.string> } : () -> tensor<!tf_type.string>\n+  // CHECK: \"tf_mlrt.ifrt_resource_deserialize\"(%arg0, %{{.*}}) <{tensor_name = \"my_tensor\"}>\n+  \"tf.IfrtResourceDeserialize\"(%arg0, %input_dir) {require_matching_crc = false, tensor_name = \"my_tensor\"} : (tensor<!tf_type.resource<tensor<f32>>>, tensor<!tf_type.string>) -> ()\n+  func.return\n+}\n "
        },
        {
            "sha": "cc59c9150da7697497d94b682b68cb3d89a0646a",
            "filename": "tensorflow/compiler/mlir/tfrt/transforms/mlrt/tf_to_mlrt.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftransforms%2Fmlrt%2Ftf_to_mlrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4d036d5d254a989da124fc18f86fcd788be27ce/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftransforms%2Fmlrt%2Ftf_to_mlrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftransforms%2Fmlrt%2Ftf_to_mlrt.cc?ref=f4d036d5d254a989da124fc18f86fcd788be27ce",
            "patch": "@@ -382,6 +382,29 @@ class IfrtRestoreVariableOpConversion\n   }\n };\n \n+class IfrtResourceDeserializeOpConversion\n+    : public mlir::OpConversionPattern<mlir::TF::IfrtResourceDeserializeOp> {\n+ public:\n+  using OpConversionPattern::OpConversionPattern;\n+\n+  mlir::LogicalResult matchAndRewrite(\n+      mlir::TF::IfrtResourceDeserializeOp op, OpAdaptor adaptor,\n+      mlir::ConversionPatternRewriter& rewriter) const override {\n+    // Transfer the tensor_name attribute; drop the unused require_matching_crc.\n+    auto tensor_name_attr = op->getAttr(\"tensor_name\");\n+    if (!tensor_name_attr) {\n+      return op.emitError(\"tensor_name attribute not found\");\n+    }\n+\n+    auto new_op = rewriter.create<tf_mlrt::MlrtIfrtResourceDeserializeOp>(\n+        op.getLoc(), adaptor.getResourceVar(), adaptor.getInputDir(),\n+        llvm::cast<mlir::StringAttr>(tensor_name_attr));\n+    rewriter.replaceOp(op, new_op);\n+\n+    return mlir::success();\n+  }\n+};\n+\n std::optional<std::string> DecodeLongName(mlir::Location loc) {\n   if (auto name_loc = mlir::dyn_cast<mlir::NameLoc>(loc)) {\n     return name_loc.getName().str();\n@@ -1278,7 +1301,8 @@ class TfToMlrtConversionPass\n     patterns.add<WhileOpConversion>(&context, &type_converter_, &symbol_table);\n     patterns.add<AsyncOpConversion, GetResourceOpConversion,\n                  SetResourceOpConversion, IfrtRestoreVariableOpConversion,\n-                 TFAwaitOpConversion, TFPromiseOpConversion>(&context);\n+                 TFAwaitOpConversion, TFPromiseOpConversion,\n+                 IfrtResourceDeserializeOpConversion>(&context);\n     patterns.add<BatchFunctionOpConversion, CaseOpConversion, CondOpConversion,\n                  TFAsyncWhileOpConversion, TFMapFnOpConversion>(type_converter_,\n                                                                 &context);"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 65,
        "deletions": 2
    }
}