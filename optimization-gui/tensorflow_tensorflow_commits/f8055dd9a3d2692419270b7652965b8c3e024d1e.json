{
    "author": "blakehechtman",
    "message": "[XLA:LAYOUT_ASSIGNMENT] Forward custom call operand layouts through alias protection copies\n\nPiperOrigin-RevId: 807281243",
    "sha": "f8055dd9a3d2692419270b7652965b8c3e024d1e",
    "files": [
        {
            "sha": "029363e33603cf153f20be01191f7f4de6b25bfe",
            "filename": "third_party/xla/xla/service/layout_assignment.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f8055dd9a3d2692419270b7652965b8c3e024d1e/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f8055dd9a3d2692419270b7652965b8c3e024d1e/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment.cc?ref=f8055dd9a3d2692419270b7652965b8c3e024d1e",
            "patch": "@@ -2491,6 +2491,11 @@ absl::Status LayoutAssignment::RunOnComputation(\n         } else {\n           TF_RETURN_IF_ERROR(SetOperandLayout(\n               custom_call->operand_shapes_with_layout()[i], custom_call, i));\n+          if (instruction->operand(i)->opcode() == HloOpcode::kCopy) {\n+            TF_RETURN_IF_ERROR(\n+                SetOperandLayout(custom_call->operand_shapes_with_layout()[i],\n+                                 custom_call->operand(i), 0));\n+          }\n         }\n       }\n     }"
        },
        {
            "sha": "7ab0e6038d1e9508cdd76a3a256231a0e906171c",
            "filename": "third_party/xla/xla/service/layout_assignment_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f8055dd9a3d2692419270b7652965b8c3e024d1e/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f8055dd9a3d2692419270b7652965b8c3e024d1e/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment_test.cc?ref=f8055dd9a3d2692419270b7652965b8c3e024d1e",
            "patch": "@@ -2254,7 +2254,7 @@ TEST_F(LayoutAssignmentTest, BufferChainLayoutConstrainedPin) {\n   HloModule test\n   ENTRY test_computation {\n     init = s32[2,8] parameter(0)\n-    b0 = b(s32[2,8]{0, 1}) custom-call(init), custom_call_target=\"Pin\",\n+    b0 = b(s32[2,8]{0,1}) custom-call(init), custom_call_target=\"Pin\",\n       output_to_operand_aliasing={{}: (0, {})},\n       operand_layout_constraints={s32[2,8]{0,1}}\n     b1 = b(s32[2,8]) custom-call(b0), custom_call_target=\"CallBack_AddOne\",\n@@ -2280,12 +2280,11 @@ TEST_F(LayoutAssignmentTest, BufferChainLayoutConstrainedPin) {\n   // Verify that the operand of the Pin instruction is a copy with the needed\n   // layout change.\n   Layout layout01 = LayoutUtil::MakeLayout({0, 1});\n-  Layout layout10 = LayoutUtil::MakeLayout({1, 0});\n \n   EXPECT_THAT(\n       FindInstruction(m.get(), \"b0\"),\n       GmockMatch(m::CustomCall(m::Copy(m::Parameter(0).WithShape(\n-                                   m::Shape().WithLayoutEqualTo(&layout10))))\n+                                   m::Shape().WithLayoutEqualTo(&layout01))))\n                      .WithShape(m::Shape().WithLayoutEqualTo(&layout01))));\n }\n "
        }
    ],
    "stats": {
        "total": 10,
        "additions": 7,
        "deletions": 3
    }
}