{
    "author": "tensorflower-gardener",
    "message": "Allow disabling WLICP via frontend attribute.\n\nPiperOrigin-RevId: 803223545",
    "sha": "361c256e3065836c00b65fe3d941694e5b3c58ae",
    "files": [
        {
            "sha": "63db25f7fbb5a10d56382e1b0e2e7b27967a7c65",
            "filename": "third_party/xla/xla/service/while_loop_expensive_invariant_code_motion.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/361c256e3065836c00b65fe3d941694e5b3c58ae/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_expensive_invariant_code_motion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/361c256e3065836c00b65fe3d941694e5b3c58ae/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_expensive_invariant_code_motion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_expensive_invariant_code_motion.cc?ref=361c256e3065836c00b65fe3d941694e5b3c58ae",
            "patch": "@@ -345,8 +345,8 @@ absl::StatusOr<bool> WhileLoopExpensiveInvariantCodeMotion::\n absl::StatusOr<bool> WhileLoopExpensiveInvariantCodeMotion::Run(\n     HloModule* module,\n     const absl::flat_hash_set<absl::string_view>& execution_threads) {\n-  VLOG(2) << \"HLO module before WhileLoopExpensiveInvariantCodeMotion:\";\n-  XLA_VLOG_LINES(2, module->ToString());\n+  VLOG(3) << \"HLO module before WhileLoopExpensiveInvariantCodeMotion:\";\n+  XLA_VLOG_LINES(3, module->ToString());\n \n   bool changed = false;\n   std::vector<HloInstruction*> while_instrs;\n@@ -373,17 +373,28 @@ absl::StatusOr<bool> WhileLoopExpensiveInvariantCodeMotion::Run(\n     // * We delete while loops that have a zero trip count, so this would have\n     //   to be a while loop with a somewhat opaque condition expression.\n \n+    if (while_instr->frontend_attributes().map().contains(\n+            \"_xla_disable_loop_instr_hoisting\")) {\n+      // If this frontend attr is present, we have knowledge from the framework\n+      // to disable hoisting from this loop.\n+      auto print_no_metadata = HloPrintOptions{}.set_print_metadata(false);\n+      std::string while_instr_name = while_instr->ToString(print_no_metadata);\n+      VLOG(2) << \"Skipping hoisting from: \" << while_instr_name\n+              << \" because it is disabled via xla metadata.\";\n+      continue;\n+    }\n+\n     TF_ASSIGN_OR_RETURN(\n         bool result,\n         TryHoistingInvariantInstructionsFromWhileBody(while_instr));\n     changed |= result;\n   }\n \n   if (changed) {\n-    VLOG(2) << \"HLO module after WhileLoopExpensiveInvariantCodeMotion:\";\n-    XLA_VLOG_LINES(2, module->ToString());\n+    VLOG(3) << \"HLO module after WhileLoopExpensiveInvariantCodeMotion:\";\n+    XLA_VLOG_LINES(3, module->ToString());\n   } else {\n-    VLOG(2)\n+    VLOG(3)\n         << \"HLO module unchanged after WhileLoopExpensiveInvariantCodeMotion\";\n   }\n "
        },
        {
            "sha": "db752a0df3d8381394a85d2cd7baede6d2d614a1",
            "filename": "third_party/xla/xla/service/while_loop_invariant_code_motion.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/361c256e3065836c00b65fe3d941694e5b3c58ae/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_invariant_code_motion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/361c256e3065836c00b65fe3d941694e5b3c58ae/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_invariant_code_motion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_invariant_code_motion.cc?ref=361c256e3065836c00b65fe3d941694e5b3c58ae",
            "patch": "@@ -341,8 +341,8 @@ WhileLoopInvariantCodeMotion::TryHoistingInvariantInstructionsFromWhileBody(\n absl::StatusOr<bool> WhileLoopInvariantCodeMotion::Run(\n     HloModule* module,\n     const absl::flat_hash_set<absl::string_view>& execution_threads) {\n-  VLOG(2) << \"HLO module before WhileLoopInvariantCodeMotion:\";\n-  XLA_VLOG_LINES(2, module->ToString());\n+  VLOG(3) << \"HLO module before WhileLoopInvariantCodeMotion:\";\n+  XLA_VLOG_LINES(3, module->ToString());\n \n   bool changed = false;\n   std::vector<HloInstruction*> while_instrs;\n@@ -373,6 +373,18 @@ absl::StatusOr<bool> WhileLoopInvariantCodeMotion::Run(\n     if (!allowance.ContinueAnalysis()) {\n       break;\n     }\n+\n+    if (while_instr->frontend_attributes().map().contains(\n+            \"_xla_disable_loop_instr_hoisting\")) {\n+      // If this frontend attr is present, we have knowledge from the framework\n+      // to disable hoisting from this loop.\n+      auto print_no_metadata = HloPrintOptions{}.set_print_metadata(false);\n+      std::string while_instr_name = while_instr->ToString(print_no_metadata);\n+      VLOG(2) << \"Skipping hoisting from: \" << while_instr_name\n+              << \" because it is disabled via xla metadata.\";\n+      continue;\n+    }\n+\n     TF_ASSIGN_OR_RETURN(\n         bool result,\n         TryHoistingInvariantInstructionsFromWhileBody(while_instr, &allowance));\n@@ -392,10 +404,10 @@ absl::StatusOr<bool> WhileLoopInvariantCodeMotion::Run(\n   }\n \n   if (changed) {\n-    VLOG(2) << \"HLO module after WhileLoopInvariantCodeMotion:\";\n-    XLA_VLOG_LINES(2, module->ToString());\n+    VLOG(3) << \"HLO module after WhileLoopInvariantCodeMotion:\";\n+    XLA_VLOG_LINES(3, module->ToString());\n   } else {\n-    VLOG(2) << \"HLO module unchanged after WhileLoopInvariantCodeMotion\";\n+    VLOG(3) << \"HLO module unchanged after WhileLoopInvariantCodeMotion\";\n   }\n \n   return changed;"
        },
        {
            "sha": "7aa19cb42b3ad23bea4a82683282c4697b64ce53",
            "filename": "third_party/xla/xla/service/while_loop_invariant_code_motion_test.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/361c256e3065836c00b65fe3d941694e5b3c58ae/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_invariant_code_motion_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/361c256e3065836c00b65fe3d941694e5b3c58ae/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_invariant_code_motion_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_invariant_code_motion_test.cc?ref=361c256e3065836c00b65fe3d941694e5b3c58ae",
            "patch": "@@ -722,5 +722,54 @@ TEST_F(WhileLoopInvariantCodeMotionTest, DoesNotHoistShardingCustomCalls) {\n   EXPECT_FALSE(simplified_loop);\n }\n \n+TEST_F(WhileLoopInvariantCodeMotionTest, RespectFrontendAttrDisablingHoisting) {\n+  const char* const kHloModule = R\"(\n+  HloModule jit_countdown, entry_computation_layout={(f32[]{:T(128)}, f32[]{:T(128)}, f32[10,10]{1,0:T(8,128)})->(f32[]{:T(128)}, f32[]{:T(128)}, f32[10,10]{1,0:T(8,128)})}\n+\n+  %region_1.4 (Arg_0.5: f32[], Arg_1.6: f32[]) -> f32[] {\n+    %Arg_0.5 = f32[] parameter(0)\n+    %Arg_1.6 = f32[] parameter(1)\n+    ROOT %add.7 = f32[] add(%Arg_0.5, %Arg_1.6)\n+  }\n+\n+  %region_0.8 (arg_tuple.9: (f32[], f32[], f32[10,10])) -> (f32[], f32[], f32[10,10]) {\n+    %arg_tuple.9 = (f32[], f32[], f32[10,10]{1,0}) parameter(0)\n+    %get-tuple-element.10 = f32[] get-tuple-element(%arg_tuple.9), index=0\n+    %constant.14 = f32[] constant(1)\n+    %negate = f32[] negate(%constant.14)\n+    %add = f32[] add(%get-tuple-element.10, %negate)\n+    %get-tuple-element.11 = f32[] get-tuple-element(%arg_tuple.9), index=1\n+    %get-tuple-element.12 = f32[10,10]{1,0} get-tuple-element(%arg_tuple.9), index=2\n+    %constant.13 = f32[] constant(0)\n+    %reduce.16 = f32[] reduce(%get-tuple-element.12, %constant.13), dimensions={0,1}, to_apply=%region_1.4\n+    %add.17 = f32[] add(%get-tuple-element.11, %reduce.16)\n+    ROOT %tuple.18 = (f32[], f32[], f32[10,10]{1,0}) tuple(%add, %add.17, %get-tuple-element.12)\n+  }\n+\n+  %region_2.19 (arg_tuple.20: (f32[], f32[], f32[10,10])) -> pred[] {\n+    %arg_tuple.20 = (f32[], f32[], f32[10,10]{1,0}) parameter(0)\n+    %get-tuple-element.21 = f32[] get-tuple-element(%arg_tuple.20), index=0\n+    %constant.24 = f32[] constant(0)\n+    ROOT %compare.25 = pred[] compare(%get-tuple-element.21, %constant.24), direction=GT\n+  }\n+\n+  ENTRY %main.40 (Arg_0.1: f32[], Arg_1.2: f32[], Arg_2.3: f32[10,10]) -> (f32[], f32[], f32[10,10]) {\n+    %Arg_0.1 = f32[] parameter(0)\n+    %Arg_1.2 = f32[] parameter(1)\n+    %Arg_2.3 = f32[10,10]{1,0} parameter(2)\n+    %tuple.0 = (f32[], f32[], f32[10,10]{1,0}) tuple(%Arg_0.1, %Arg_1.2, %Arg_2.3)\n+    %while.0 = (f32[], f32[], f32[10,10]{1,0}) while(%tuple.0), condition=%region_2.19, body=%region_0.8, frontend_attributes={_xla_disable_loop_instr_hoisting=\"true\"}\n+    %get-tuple-element.36 = f32[] get-tuple-element(%while.0), index=0\n+    %get-tuple-element.37 = f32[] get-tuple-element(%while.0), index=1\n+    ROOT %tuple.39 = (f32[], f32[], f32[10,10]{1,0}) tuple(%get-tuple-element.36, %get-tuple-element.37, %Arg_2.3)\n+  }\n+  )\";\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(kHloModule));\n+  TF_ASSERT_OK_AND_ASSIGN(bool simplified_loop,\n+                          WhileLoopInvariantCodeMotion{}.Run(module.get()));\n+  EXPECT_FALSE(simplified_loop);\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 82,
        "deletions": 10
    }
}