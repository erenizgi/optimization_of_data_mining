{
    "author": "ezhulenev",
    "message": "[xla:pjrt] Add PjRtFuture::MoveOnlyPromise as helper type for MakePromise() migration\n\nAvoid accidental copies of a promise returned from PjRtFuture::MakePromise(), as in the end we want to make PjRtFuture::Promise a move-only type.\n\nPiperOrigin-RevId: 803306283",
    "sha": "4905554655ac0444680d9b27217562e3fc062d63",
    "files": [
        {
            "sha": "c3c4cbbf29ae3dc32c5c2c8f4397451744cc4b4b",
            "filename": "third_party/xla/xla/pjrt/pjrt_future.h",
            "status": "modified",
            "additions": 28,
            "deletions": 4,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4905554655ac0444680d9b27217562e3fc062d63/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4905554655ac0444680d9b27217562e3fc062d63/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h?ref=4905554655ac0444680d9b27217562e3fc062d63",
            "patch": "@@ -470,6 +470,17 @@ class PjRtFuture : public internal::PjRtFutureBase<absl::StatusOr<T>> {\n     friend class PjRtFuture;\n   };\n \n+  // This is a temporary class to support migration from CreatePromise() to\n+  // MakePromise() and an end goal of making Promise move-only type.\n+  class MoveOnlyPromise : public Promise {\n+   public:\n+    using Promise::Promise;\n+    using Promise::Set;\n+\n+    MoveOnlyPromise(MoveOnlyPromise&&) = default;\n+    MoveOnlyPromise& operator=(MoveOnlyPromise&&) = default;\n+  };\n+\n   // Returns a Promise that can be used to construct a PjRtFuture, and then Set\n   // later.\n   static Promise CreatePromise() {\n@@ -478,8 +489,9 @@ class PjRtFuture : public internal::PjRtFutureBase<absl::StatusOr<T>> {\n \n   // Returns a pair of connected Promise and PjRtFuture<T>. Setting the returned\n   // promise will fulfill the connected future.\n-  static std::pair<Promise, PjRtFuture<T>> MakePromise() {\n-    Promise promise(tsl::MakeUnconstructedAsyncValueRef<absl::StatusOr<T>>());\n+  static std::pair<MoveOnlyPromise, PjRtFuture<T>> MakePromise() {\n+    MoveOnlyPromise promise(\n+        tsl::MakeUnconstructedAsyncValueRef<absl::StatusOr<T>>());\n     PjRtFuture<T> future(promise);\n     return std::make_pair(std::move(promise), std::move(future));\n   }\n@@ -728,6 +740,17 @@ class PjRtFuture<void> : public internal::PjRtFutureBase<absl::Status> {\n     friend class PjRtFuture<void>;\n   };\n \n+  // This is a temporary class to support migration from CreatePromise() to\n+  // MakePromise() and an end goal of making Promise move-only type.\n+  class MoveOnlyPromise : public Promise {\n+   public:\n+    using Promise::Promise;\n+    using Promise::Set;\n+\n+    MoveOnlyPromise(MoveOnlyPromise&&) = default;\n+    MoveOnlyPromise& operator=(MoveOnlyPromise&&) = default;\n+  };\n+\n   // Returns a Promise that can be used to construct a PjRtFuture, and then Set\n   // later.\n   static Promise CreatePromise() {\n@@ -736,8 +759,9 @@ class PjRtFuture<void> : public internal::PjRtFutureBase<absl::Status> {\n \n   // Returns a pair of connected Promise and PjRtFuture<>. Setting the returned\n   // promise will fulfill the connected future.\n-  static std::pair<Promise, PjRtFuture<>> MakePromise() {\n-    Promise promise(tsl::MakeUnconstructedAsyncValueRef<absl::Status>());\n+  static std::pair<MoveOnlyPromise, PjRtFuture<>> MakePromise() {\n+    MoveOnlyPromise promise(\n+        tsl::MakeUnconstructedAsyncValueRef<absl::Status>());\n     PjRtFuture<> future(promise);\n     return std::make_pair(std::move(promise), std::move(future));\n   }"
        },
        {
            "sha": "d5848250be34c4a7ad1137de966b360eca2064b5",
            "filename": "third_party/xla/xla/pjrt/pjrt_future_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4905554655ac0444680d9b27217562e3fc062d63/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4905554655ac0444680d9b27217562e3fc062d63/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future_test.cc?ref=4905554655ac0444680d9b27217562e3fc062d63",
            "patch": "@@ -176,13 +176,6 @@ TEST(PjRtFutureTest, PromiseIsUnique) {\n   // else, and the promise becomes unique.\n   promise.Set();\n   EXPECT_TRUE(promise.IsUniqueReference());\n-\n-  {  // Making a copy of the promise makes it not unique.\n-    auto copy = promise;\n-    EXPECT_FALSE(promise.IsUniqueReference());\n-    EXPECT_FALSE(copy.IsUniqueReference());\n-  }\n-  EXPECT_TRUE(promise.IsUniqueReference());\n }\n \n TEST(PjRtFutureTest, MapCopyableFuture) {"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 28,
        "deletions": 11
    }
}