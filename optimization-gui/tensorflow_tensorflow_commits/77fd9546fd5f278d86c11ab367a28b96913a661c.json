{
    "author": "pschuh",
    "message": "Add a test for early disconnect to verify that it returns errors instead of\nspinning.\n\nPiperOrigin-RevId: 815943872",
    "sha": "77fd9546fd5f278d86c11ab367a28b96913a661c",
    "files": [
        {
            "sha": "a31010ad91e1b59d57768bb1fb298f27c3654b2e",
            "filename": "third_party/xla/xla/python/transfer/socket_bulk_transport.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/77fd9546fd5f278d86c11ab367a28b96913a661c/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket_bulk_transport.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/77fd9546fd5f278d86c11ab367a28b96913a661c/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket_bulk_transport.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket_bulk_transport.cc?ref=77fd9546fd5f278d86c11ab367a28b96913a661c",
            "patch": "@@ -530,6 +530,11 @@ absl::Status RecvThreadState::HandleRecvItem(recv_work_item& work,\n       ssize_t recv_count =\n           recv(work.fd, reinterpret_cast<char*>(alloc.data) + offset,\n                work.recv_size - offset, 0);\n+      if (recv_count == 0) {\n+        std::move(alloc.on_done)();\n+        return absl::InternalError(\n+            \"RecvThreadState::HandleRecvItem -> recv_count == 0\");\n+      }\n       if (recv_count < 0) {\n         std::move(alloc.on_done)();\n         return absl::ErrnoToStatus(errno, \"recv-fallback\");"
        },
        {
            "sha": "384f263cf5fdcc8e0b5917d68fd02c315500fdde",
            "filename": "third_party/xla/xla/python/transfer/socket_bulk_transport_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/77fd9546fd5f278d86c11ab367a28b96913a661c/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket_bulk_transport_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/77fd9546fd5f278d86c11ab367a28b96913a661c/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket_bulk_transport_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fsocket_bulk_transport_test.cc?ref=77fd9546fd5f278d86c11ab367a28b96913a661c",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include <cstring>\n #include <deque>\n #include <memory>\n+#include <optional>\n #include <string>\n #include <tuple>\n #include <utility>\n@@ -155,6 +156,32 @@ TEST(SendQueue, SendAndRecvQueuesArtificialLimit) {\n   }\n }\n \n+TEST(SendQueue, SendAndRecvQueuesEarlyClose) {\n+  size_t packet_size = 1024 * 8;\n+  SlabAllocator uallocator(AllocateAlignedMemory(packet_size * 4).value(),\n+                           packet_size);\n+  auto recv_thread = RecvThreadState::Create(std::nullopt, uallocator);\n+\n+  int send_fd, recv_fd;\n+  auto status = SetupSocketPairUsingEventLoop(send_fd, recv_fd);\n+  ASSERT_TRUE(status.ok()) << status;\n+\n+  close(send_fd);\n+\n+  for (size_t i = 0; i < 2; ++i) {\n+    absl::Notification recv_notify;\n+    absl::StatusOr<aux::BulkTransportInterface::Message> recv_msg;\n+    recv_thread->ScheduleRecvWork(\n+        packet_size, recv_fd,\n+        [&](absl::StatusOr<aux::BulkTransportInterface::Message> msg) {\n+          recv_msg = std::move(msg);\n+          recv_notify.Notify();\n+        });\n+    recv_notify.WaitForNotification();\n+    ASSERT_FALSE(recv_msg.ok());\n+  }\n+}\n+\n TEST(SocketBulkTransportFactoryTest, SendAndRecvWithFactory) {\n   size_t packet_size = 1024 * 8;\n   SlabAllocator allocator(AllocateNetworkPinnedMemory(packet_size * 4).value(),"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 32,
        "deletions": 0
    }
}