{
    "author": "thomasjoerg",
    "message": "[XLA] Fix UndefinedBehaviorSanitizer `null-pointer-use` issue in `xla_host_send_recv_device_context_test`.\n\nPiperOrigin-RevId: 836639198",
    "sha": "489c77747c4b4377b6ed1aa463897fc2c2559d96",
    "files": [
        {
            "sha": "62089beed8224f88f12e490626aebcd144852001",
            "filename": "tensorflow/compiler/jit/xla_host_send_recv_device_context_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/489c77747c4b4377b6ed1aa463897fc2c2559d96/tensorflow%2Fcompiler%2Fjit%2Fxla_host_send_recv_device_context_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/489c77747c4b4377b6ed1aa463897fc2c2559d96/tensorflow%2Fcompiler%2Fjit%2Fxla_host_send_recv_device_context_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fjit%2Fxla_host_send_recv_device_context_test.cc?ref=489c77747c4b4377b6ed1aa463897fc2c2559d96",
            "patch": "@@ -34,8 +34,12 @@ namespace {\n \n class XlaHostSendRecvDeviceContextTest : public ::testing::Test {\n  public:\n-  void SetDevice(const string& device_type) {\n+  absl::Status SetDevice(const string& device_type) {\n     auto device_factory = DeviceFactory::GetFactory(device_type);\n+    if (device_factory == nullptr) {\n+      return absl::NotFoundError(\n+          \"Failed to get DeviceFactory for device_type: \" + device_type);\n+    }\n     SessionOptions options;\n     std::vector<std::unique_ptr<Device>> devices;\n     Status s = device_factory->CreateDevices(\n@@ -49,6 +53,7 @@ class XlaHostSendRecvDeviceContextTest : public ::testing::Test {\n     AllocatorAttributes device_alloc_attr;\n     device_alloc_attr.set_on_host(false);\n     device_allocator_ = device_->GetAllocator(device_alloc_attr);\n+    return absl::OkStatus();\n   }\n \n  protected:\n@@ -58,7 +63,7 @@ class XlaHostSendRecvDeviceContextTest : public ::testing::Test {\n };\n \n TEST_F(XlaHostSendRecvDeviceContextTest, CopyDeviceTensorToCPU) {\n-  SetDevice(\"GPU\");\n+  TF_ASSERT_OK(SetDevice(\"GPU\"));\n   Tensor origin_cpu_tensor(host_allocator_, DT_FLOAT, TensorShape({2, 2}));\n   test::FillValues<float>(&origin_cpu_tensor, {1.2, 2.3, 3.4, 4.5});\n   Tensor device_tensor(device_allocator_, DT_FLOAT, TensorShape({2, 2}));\n@@ -93,7 +98,7 @@ TEST_F(XlaHostSendRecvDeviceContextTest, CopyDeviceTensorToCPU) {\n }\n \n TEST_F(XlaHostSendRecvDeviceContextTest, CopyCPUTensorToDevice) {\n-  SetDevice(\"GPU\");\n+  TF_ASSERT_OK(SetDevice(\"GPU\"));\n   Tensor origin_cpu_tensor(host_allocator_, DT_FLOAT, TensorShape({2, 2}));\n   test::FillValues<float>(&origin_cpu_tensor, {1.2, 2.3, 3.4, 4.5});\n   Tensor device_tensor(device_allocator_, DT_FLOAT, TensorShape({2, 2}));\n@@ -127,7 +132,7 @@ TEST_F(XlaHostSendRecvDeviceContextTest, CopyCPUTensorToDevice) {\n }\n \n TEST_F(XlaHostSendRecvDeviceContextTest, RoundTrip) {\n-  SetDevice(\"GPU\");\n+  TF_ASSERT_OK(SetDevice(\"GPU\"));\n   Tensor origin_cpu_tensor(host_allocator_, DT_FLOAT, TensorShape({2, 2}));\n   test::FillValues<float>(&origin_cpu_tensor, {1.2, 2.3, 3.4, 4.5});\n   Tensor device_tensor(device_allocator_, DT_FLOAT, TensorShape({2, 2}));"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 9,
        "deletions": 4
    }
}