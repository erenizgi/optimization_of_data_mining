{
    "author": "dubstack",
    "message": "Add `FlattenDebugPayloadIntoMessage` to XLA error utilities.\n\nPiperOrigin-RevId: 814883674",
    "sha": "0ff641da799d44a202af650183801f338d8d5ddc",
    "files": [
        {
            "sha": "ac1a5aedc1d16e7e6cfb26f014a5073334adc744",
            "filename": "third_party/xla/xla/error/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2FBUILD?ref=0ff641da799d44a202af650183801f338d8d5ddc",
            "patch": "@@ -41,8 +41,10 @@ cc_library(\n     deps = [\n         \"//xla/tsl/platform:debug_me_context\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:cord\",\n+        \"@local_tsl//tsl/platform\",\n     ],\n )\n \n@@ -52,8 +54,12 @@ xla_cc_test(\n     deps = [\n         \":debug_me_context_util\",\n         \"//xla/tsl/platform:debug_me_context\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:cord\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform\",\n     ],\n )\n "
        },
        {
            "sha": "005f8fb6bb73f6e49f32d998c6f65ec7cc9e1fb5",
            "filename": "third_party/xla/xla/error/debug_me_context_util.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 10,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.cc?ref=0ff641da799d44a202af650183801f338d8d5ddc",
            "patch": "@@ -15,27 +15,20 @@ limitations under the License.\n \n #include \"xla/error/debug_me_context_util.h\"\n \n+#include <optional>\n #include <string>\n #include <vector>\n \n #include \"absl/status/status.h\"\n #include \"absl/strings/cord.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_join.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"xla/tsl/platform/debug_me_context.h\"\n+#include \"tsl/platform/platform.h\"\n \n namespace xla::error {\n \n-void AttachDebugMeContextPayload(absl::Status& status) {\n-  if (!status.ok()) {\n-    std::string error_message_string = DebugMeContextToErrorMessageString();\n-    if (!error_message_string.empty()) {\n-      status.SetPayload(kDebugContextPayloadUrl,\n-                        absl::Cord(error_message_string));\n-    }\n-  }\n-}\n-\n std::string DebugMeContextToErrorMessageString() {\n   if (!tsl::DebugMeContext<DebugMeContextKey>::HasAnyValues()) {\n     return \"\";\n@@ -73,4 +66,45 @@ std::string DebugMeContextToErrorMessageString() {\n   return error_message;\n }\n \n+void AttachDebugMeContextPayload(absl::Status& status) {\n+  if (!status.ok()) {\n+    std::string error_message_string = DebugMeContextToErrorMessageString();\n+    if (!error_message_string.empty()) {\n+      status.SetPayload(kDebugContextPayloadUrl,\n+                        absl::Cord(error_message_string));\n+    }\n+  }\n+}\n+\n+absl::Status FlattenDebugPayloadIntoMessage(const absl::Status& status) {\n+  if (status.ok()) {\n+    return status;\n+  }\n+\n+  std::optional<absl::Cord> debug_context_payload =\n+      status.GetPayload(kDebugContextPayloadUrl);\n+  if (!debug_context_payload.has_value()) {\n+    return status;\n+  }\n+\n+  std::string new_message =\n+      absl::StrCat(status.message(), \"\\n\", debug_context_payload.value());\n+#if defined(PLATFORM_GOOGLE)\n+  absl::Status new_status(status.code(), new_message,\n+                          status.GetSourceLocations().front());\n+#else   // ndef PLATFORM_GOOGLE\n+  absl::Status new_status(status.code(), new_message);\n+#endif  // ndef PLATFORM_GOOGLE\n+\n+  // Copy all other payloads from the old status to the new one.\n+  status.ForEachPayload([&](absl::string_view type_url, const absl::Cord& p) {\n+    if (type_url != kDebugContextPayloadUrl) {\n+      new_status.SetPayload(type_url, p);\n+    }\n+  });\n+\n+  // Replace the original status with our new, updated one.\n+  return new_status;\n+}\n+\n }  // namespace xla::error"
        },
        {
            "sha": "96b9dada5d61887d81f78a64a8b9a5d5ae231bea",
            "filename": "third_party/xla/xla/error/debug_me_context_util.h",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.h?ref=0ff641da799d44a202af650183801f338d8d5ddc",
            "patch": "@@ -20,8 +20,8 @@ limitations under the License.\n #include <string>\n \n #include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n-#include \"xla/tsl/platform/debug_me_context.h\"\n \n // This file provides XLA-specific specializations and utilities for the\n // thread-local debugging context system.\n@@ -59,6 +59,20 @@ std::string DebugMeContextToErrorMessageString();\n // status, if the context is not empty and the status is not OK.\n void AttachDebugMeContextPayload(absl::Status& status);\n \n+// If the status contains a DebugMeContext payload, this function will add it to\n+// the status's message and remove the payload. Otherwise, do nothing.\n+absl::Status FlattenDebugPayloadIntoMessage(const absl::Status& status);\n+\n+template <typename T>\n+inline absl::StatusOr<T> FlattenDebugPayloadIntoMessage(\n+    const absl::StatusOr<T>& status_or) {\n+  if (status_or.ok()) {\n+    return status_or;\n+  }\n+\n+  return FlattenDebugPayloadIntoMessage(status_or.status());\n+}\n+\n }  // namespace error\n }  // namespace xla\n "
        },
        {
            "sha": "6e6f176b189c3c771cb72aa808da3011815c5b67",
            "filename": "third_party/xla/xla/error/debug_me_context_util_test.cc",
            "status": "modified",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0ff641da799d44a202af650183801f338d8d5ddc/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util_test.cc?ref=0ff641da799d44a202af650183801f338d8d5ddc",
            "patch": "@@ -15,16 +15,24 @@ limitations under the License.\n \n #include \"xla/error/debug_me_context_util.h\"\n \n+#include <optional>\n #include <string>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/cord.h\"\n #include \"absl/strings/match.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/tsl/platform/debug_me_context.h\"\n+#include \"tsl/platform/platform.h\"\n \n namespace xla {\n namespace {\n \n+using ::testing::EndsWith;\n+\n TEST(DebugMeContextUtil, StringCheck) {\n   constexpr absl::string_view kCompilerName{\"MyCompiler\"};\n \n@@ -37,5 +45,72 @@ TEST(DebugMeContextUtil, StringCheck) {\n   EXPECT_TRUE(absl::StrContains(error_message, kCompilerName));\n }\n \n+TEST(FlattenDebugPayloadIntoMessage, StatusWithPayloadIsFlattened) {\n+  absl::Status status = absl::InternalError(\"Original message.\");\n+  status.SetPayload(error::kDebugContextPayloadUrl, absl::Cord(\"Debug info.\"));\n+\n+  status = error::FlattenDebugPayloadIntoMessage(status);\n+\n+  EXPECT_EQ(status.code(), absl::StatusCode::kInternal);\n+  EXPECT_TRUE(\n+      absl::StrContains(status.message(), \"Original message.\\nDebug info.\"));\n+  EXPECT_FALSE(status.GetPayload(error::kDebugContextPayloadUrl).has_value());\n+#if defined(PLATFORM_GOOGLE)\n+  EXPECT_THAT(status.GetSourceLocations().front().file_name(),\n+              EndsWith(\"debug_me_context_util_test.cc\"));\n+#endif  // defined(PLATFORM_GOOGLE)\n+}\n+\n+TEST(FlattenDebugPayloadIntoMessage, StatusWithOtherPayloadsIsPreserved) {\n+  constexpr absl::string_view kOtherPayloadUrl = \"other_payload\";\n+  constexpr absl::string_view kOtherPayloadContent = \"preserved\";\n+  absl::Status status = absl::InternalError(\"Original message.\");\n+  status.SetPayload(error::kDebugContextPayloadUrl, absl::Cord(\"Debug info.\"));\n+  status.SetPayload(kOtherPayloadUrl, absl::Cord(kOtherPayloadContent));\n+\n+  status = error::FlattenDebugPayloadIntoMessage(status);\n+\n+  // Assert the debug payload was flattened.\n+  EXPECT_TRUE(\n+      absl::StrContains(status.message(), \"Original message.\\nDebug info.\"));\n+  EXPECT_FALSE(status.GetPayload(error::kDebugContextPayloadUrl).has_value());\n+  std::optional<absl::Cord> other_payload = status.GetPayload(kOtherPayloadUrl);\n+  ASSERT_TRUE(other_payload.has_value());\n+  EXPECT_EQ(other_payload.value(), kOtherPayloadContent);\n+}\n+\n+TEST(FlattenDebugPayloadIntoMessage, StatusWithoutPayloadIsUnchanged) {\n+  absl::Status status = absl::InternalError(\"Original message.\");\n+  absl::Status original_status = status;\n+\n+  status = error::FlattenDebugPayloadIntoMessage(status);\n+\n+  EXPECT_EQ(status, original_status);\n+}\n+\n+TEST(FlattenDebugPayloadIntoMessage, OkStatusIsUnchanged) {\n+  absl::Status status = absl::OkStatus();\n+\n+  status = error::FlattenDebugPayloadIntoMessage(status);\n+\n+  EXPECT_TRUE(status.ok());\n+}\n+\n+TEST(FlattenDebugPayloadIntoMessage, StatusOrWithPayloadIsFlattened) {\n+  absl::Status status = absl::InternalError(\"Original message.\");\n+  status.SetPayload(error::kDebugContextPayloadUrl, absl::Cord(\"Debug info.\"));\n+  absl::StatusOr<int> status_or = status;\n+\n+  status_or = error::FlattenDebugPayloadIntoMessage(status_or);\n+\n+  EXPECT_FALSE(status_or.ok());\n+  EXPECT_EQ(status_or.status().code(), absl::StatusCode::kInternal);\n+  EXPECT_TRUE(absl::StrContains(status_or.status().message(),\n+                                \"Original message.\\nDebug info.\"));\n+  EXPECT_FALSE(status_or.status()\n+                   .GetPayload(error::kDebugContextPayloadUrl)\n+                   .has_value());\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 140,
        "deletions": 11
    }
}