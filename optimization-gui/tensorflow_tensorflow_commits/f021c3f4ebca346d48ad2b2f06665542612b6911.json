{
    "author": "ermilovmaxim",
    "message": "Reuse session in tests\n\nPiperOrigin-RevId: 829288737",
    "sha": "f021c3f4ebca346d48ad2b2f06665542612b6911",
    "files": [
        {
            "sha": "453cbeb13126489f58cf0ce7751d7833323fdc62",
            "filename": "tensorflow/compiler/tests/cast_test.py",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f021c3f4ebca346d48ad2b2f06665542612b6911/tensorflow%2Fcompiler%2Ftests%2Fcast_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f021c3f4ebca346d48ad2b2f06665542612b6911/tensorflow%2Fcompiler%2Ftests%2Fcast_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Ftests%2Fcast_test.py?ref=f021c3f4ebca346d48ad2b2f06665542612b6911",
            "patch": "@@ -35,9 +35,10 @@ def test_cast(self):\n         dtypes.uint32,\n         dtypes.uint64,\n     }\n-    for src_type in types:\n-      for dst_type in types:\n-        self._test_cast(src_type, dst_type)\n+    with self.session() as session:\n+      for src_type in types:\n+        for dst_type in types:\n+          self._test_cast(src_type, dst_type, session)\n \n   def test_cast_fp8(self):\n     if platform.system() == \"Darwin\":\n@@ -61,12 +62,13 @@ def test_cast_fp8(self):\n         dtypes.uint32,\n         dtypes.uint64,\n     }\n-    for fp8_type in fp8_types:\n-      for other_type in other_types | fp8_types:\n-        self._test_cast(fp8_type, other_type)\n-        self._test_cast(other_type, fp8_type)\n+    with self.session() as session:\n+      for fp8_type in fp8_types:\n+        for other_type in other_types | fp8_types:\n+          self._test_cast(fp8_type, other_type, session)\n+          self._test_cast(other_type, fp8_type, session)\n \n-  def _test_cast(self, src_type, dst_type):\n+  def _test_cast(self, src_type, dst_type, session):\n     with self.subTest(src_type=src_type, dst_type=dst_type):\n       shapes = [[], [4], [2, 3], [2, 0, 4]]\n       src_np_dtype = src_type.as_numpy_dtype\n@@ -83,6 +85,7 @@ def _test_cast(self, src_type, dst_type):\n             lambda x, dst_type=dst_type: math_ops.cast(x, dst_type),\n             src,\n             expected=dst,\n+            local_session=session,\n         )\n \n       # Check special values.\n@@ -112,6 +115,7 @@ def _test_cast(self, src_type, dst_type):\n           lambda x, dst_type=dst_type: math_ops.cast(x, dst_type),\n           src,\n           expected=dst,\n+          local_session=session,\n       )\n \n   def test_give_me_a_name(self):"
        },
        {
            "sha": "67a1ecc967f24cc6722129d9027aba3898d0a194",
            "filename": "tensorflow/compiler/tests/float_ops_test.py",
            "status": "modified",
            "additions": 513,
            "deletions": 440,
            "changes": 953,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f021c3f4ebca346d48ad2b2f06665542612b6911/tensorflow%2Fcompiler%2Ftests%2Ffloat_ops_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f021c3f4ebca346d48ad2b2f06665542612b6911/tensorflow%2Fcompiler%2Ftests%2Ffloat_ops_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Ftests%2Ffloat_ops_test.py?ref=f021c3f4ebca346d48ad2b2f06665542612b6911",
            "patch": "@@ -23,449 +23,522 @@\n class FloatOpsTest(xla_test.XLATestCase):\n \n   def test_float_ops(self):\n-    for dtype in self.float_types:\n-      x = np.arange(-0.90, 0.90, 0.25)\n-      self.assert_op_output_matches_expected(\n-          math_ops.acos, x.astype(dtype), expected=np.arccos(x).astype(dtype)\n-      )\n-      self.assert_op_output_matches_expected(\n-          math_ops.asin, x.astype(dtype), expected=np.arcsin(x).astype(dtype)\n-      )\n-      x = np.arange(-3, 3).reshape(1, 3, 2)\n-      self.assert_op_output_matches_expected(\n-          math_ops.atan, x.astype(dtype), expected=np.arctan(x).astype(dtype)\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.acosh,\n-          np.array([1, 2, 3, 4], dtype=dtype),\n-          expected=np.array(\n-              [0, 1.3169579, 1.76274717, 2.06343707], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.asinh,\n-          np.array([1, 2, 3, 4], dtype=dtype),\n-          expected=np.array(\n-              [0.88137359, 1.44363548, 1.81844646, 2.09471255], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.atanh,\n-          np.array([0.1, 0.2, 0.3, 0.4], dtype=dtype),\n-          expected=np.array(\n-              [0.10033535, 0.20273255, 0.3095196, 0.42364893], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.ceil,\n-          np.array([[-1.7, 1.2]], dtype=dtype),\n-          expected=np.array([[-1, 2]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.cosh,\n-          np.array([1, 2, 3, 4], dtype=dtype),\n-          expected=np.array(\n-              [1.54308063, 3.76219569, 10.067662, 27.30823284], dtype=dtype\n-          ),\n-      )\n-\n-      # Disable float16 testing for now\n-      if dtype != np.float16:\n-        x = np.arange(-10, 10, 1).astype(dtype)\n-        with self.session() as session:\n+    with self.session() as session:\n+      for dtype in self.float_types:\n+        x = np.arange(-0.90, 0.90, 0.25)\n+        self.assert_op_output_matches_expected(\n+            math_ops.acos,\n+            x.astype(dtype),\n+            expected=np.arccos(x).astype(dtype),\n+            local_session=session,\n+        )\n+        self.assert_op_output_matches_expected(\n+            math_ops.asin,\n+            x.astype(dtype),\n+            expected=np.arcsin(x).astype(dtype),\n+            local_session=session,\n+        )\n+        x = np.arange(-3, 3).reshape(1, 3, 2)\n+        self.assert_op_output_matches_expected(\n+            math_ops.atan,\n+            x.astype(dtype),\n+            expected=np.arctan(x).astype(dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.acosh,\n+            np.array([1, 2, 3, 4], dtype=dtype),\n+            expected=np.array(\n+                [0, 1.3169579, 1.76274717, 2.06343707], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.asinh,\n+            np.array([1, 2, 3, 4], dtype=dtype),\n+            expected=np.array(\n+                [0.88137359, 1.44363548, 1.81844646, 2.09471255], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.atanh,\n+            np.array([0.1, 0.2, 0.3, 0.4], dtype=dtype),\n+            expected=np.array(\n+                [0.10033535, 0.20273255, 0.3095196, 0.42364893], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.ceil,\n+            np.array([[-1.7, 1.2]], dtype=dtype),\n+            expected=np.array([[-1, 2]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.cosh,\n+            np.array([1, 2, 3, 4], dtype=dtype),\n+            expected=np.array(\n+                [1.54308063, 3.76219569, 10.067662, 27.30823284], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        # Disable float16 testing for now\n+        if dtype != np.float16:\n+          x = np.arange(-10, 10, 1).astype(dtype)\n           erf_x = session.run(math_ops.erf(x))\n           erfc_x = session.run(math_ops.erfc(x))\n \n-        self.assert_op_output_matches_expected(math_ops.erf, x, expected=erf_x)\n-        self.assert_op_output_matches_expected(\n-            math_ops.erfc, x, expected=erfc_x\n-        )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.exp,\n-          np.array([[-1, 1]], dtype=dtype),\n-          expected=np.array([[0.36787945, 2.7182817]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.expm1,\n-          np.array([[-1, 1]], dtype=dtype),\n-          expected=np.array([[-0.63212056, 1.71828183]], dtype=dtype),\n-          rtol=1e-5,\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.floor,\n-          np.array([[-1.7, 1.2]], dtype=dtype),\n-          expected=np.array([[-2, 1]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.is_finite,\n-          np.array(\n-              [[-np.inf, -2, -1, 0, 0.5, 1, 2, np.inf, np.nan]], dtype=dtype\n-          ),\n-          expected=np.array([[0, 1, 1, 1, 1, 1, 1, 0, 0]], dtype=np.bool_),\n-      )\n-\n-      # Tests for tf.nn ops.\n-      self.assert_op_output_matches_expected(\n-          nn_ops.l2_loss, np.array([[[]]], dtype=dtype), expected=dtype(0)\n-      )\n-\n-      self.assert_op_output_matches_expected(nn_ops.l2_loss, dtype(4), dtype(8))\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.l2_loss, np.array([[-2, 4]], dtype=dtype), expected=dtype(10)\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.reciprocal,\n-          np.array([[1, 2]], dtype=dtype),\n-          expected=np.array([[1, 0.5]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.log,\n-          np.array([[1, 2]], dtype=dtype),\n-          expected=np.array([[0, 0.69314718]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.sin,\n-          np.array([[1, 2]], dtype=dtype),\n-          expected=np.array([[0.841478, 0.909302]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.cos,\n-          np.array([[1, 2]], dtype=dtype),\n-          expected=np.array([[0.540297, -0.41614]], dtype=dtype),\n-      )\n-\n-      # Confirm that log1p will remain precise across a range of small values.\n-      self.assert_op_output_matches_expected(\n-          math_ops.log1p,\n-          np.array(\n-              [[1e-14, 1e-15, 0.6, 2] + [x * 1e-5 for x in range(1, 20)]],\n-              dtype=dtype,\n-          ),\n-          expected=np.log1p(\n-              np.array(\n-                  [[1e-14, 1e-15, 0.6, 2] + [x * 1e-5 for x in range(1, 20)]],\n-                  dtype=dtype,\n-              )\n-          ).astype(dtype),\n-          rtol=1e-15 if dtype == np.float64 else 1e-4,\n-          atol=1e-15 if dtype == np.float64 else 1e-4,\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.rint,\n-          np.array(\n-              [\n-                  [-1.7, 1.2, 4.0, 0.0],\n-                  [-3.5, -2.5, -1.5, -0.5],\n-                  [0.5, 1.5, 2.5, 3.5],\n-              ],\n-              dtype=dtype,\n-          ),\n-          expected=np.array(\n-              [[-2, 1, 4, 0], [-4, -2, -2, 0], [0, 2, 2, 4]], dtype=dtype\n-          ),\n-      )\n-      self.assert_op_output_matches_expected(\n-          math_ops.round,\n-          np.array(\n-              [\n-                  [-1.7, 1.2, 4.0, 0.0],\n-                  [-3.5, -2.5, -1.5, -0.5],\n-                  [0.5, 1.5, 2.5, 3.5],\n-              ],\n-              dtype=dtype,\n-          ),\n-          expected=np.array(\n-              [[-2, 1, 4, 0], [-4, -2, -2, 0], [0, 2, 2, 4]], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.rsqrt,\n-          np.array([[4, 16]], dtype=dtype),\n-          expected=np.array([[0.5, 0.25]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.sigmoid,\n-          np.array([[1, 1, 1, 1], [1, 2, 3, 4]], dtype=dtype),\n-          expected=np.array(\n-              [\n-                  [0.7310586, 0.7310586, 0.7310586, 0.7310586],\n-                  [0.7310586, 0.880797, 0.95257413, 0.98201376],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.sigmoid,\n-          np.array([-300, -150, 0, 150, 300], dtype=dtype),\n-          expected=np.array([0, 0, 0.5, 1, 1], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.sinh,\n-          np.array([1, 2, 3, 4], dtype=dtype),\n-          expected=np.array(\n-              [1.17520119, 3.62686041, 10.01787493, 27.2899172], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.sqrt,\n-          np.array([[4, 9]], dtype=dtype),\n-          expected=np.array([[2, 3]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.tan,\n-          np.array([1, 2, 3, 4], dtype=dtype),\n-          expected=np.array(\n-              [1.55740772, -2.18503986, -0.14254654, 1.15782128], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.tanh,\n-          np.array(\n-              [[1, 2, 3, 4], [np.inf, -np.inf, np.nan, 20], [19, -19, 22, -22]],\n-              dtype=dtype,\n-          ),\n-          expected=np.array(\n-              [\n-                  [0.76159418, 0.96402758, 0.99505478, 0.99932933],\n-                  [1.0, -1.0, np.nan, 1.0],\n-                  [1.0, -1.0, 1.0, -1.0],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.log_softmax,\n-          np.array([[1, 1, 1, 1], [1, 2, 3, 4]], dtype=dtype),\n-          expected=np.array(\n-              [\n-                  [-1.3862944, -1.3862944, -1.3862944, -1.3862944],\n-                  [-3.4401896, -2.4401896, -1.4401897, -0.44018969],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.elu,\n-          np.array([[-1, 0, 1, -1e-6]], dtype=dtype),\n-          expected=np.array([[-0.63212056, 0, 1, -9.999995e-07]], dtype=dtype),\n-          rtol=1e-5,\n-          atol=1e-6,\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.selu,\n-          np.array([[-1, 0, 1, -1e-5]], dtype=dtype),\n-          expected=np.array(\n-              [[-1.11133074, 0.0, 1.05070099, -1.758090550379974e-05]],\n-              dtype=dtype,\n-          ),\n-          rtol=1e-5,\n-          atol=1e-6,\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.relu,\n-          np.array([[-1, 1]], dtype=dtype),\n-          expected=np.array([[0, 1]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.relu6,\n-          np.array([[-0.05, 6.05, 5]], dtype=dtype),\n-          expected=np.array([[0, 6, 5]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.leaky_relu,\n-          np.array([[-2, -1, 0, 1, 2]], dtype=dtype),\n-          expected=np.array([[-0.4, -0.2, 0.0, 1.0, 2.0]], dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.softmax,\n-          np.array([1, 2, 3, 4], dtype=dtype),\n-          expected=np.array(\n-              [0.032058604, 0.087144323, 0.23688284, 0.64391428], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.softmax,\n-          np.array([[1, 1, 1, 1], [1, 2, 3, 4]], dtype=dtype),\n-          expected=np.array(\n-              [\n-                  [0.25, 0.25, 0.25, 0.25],\n-                  [0.032058604, 0.087144323, 0.23688284, 0.64391428],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.softmax,\n-          np.array([[[1, 1], [1, 1]], [[1, 2], [3, 4]]], dtype=dtype),\n-          expected=np.array(\n-              [\n-                  [[0.5, 0.5], [0.5, 0.5]],\n-                  [[0.26894142, 0.73105858], [0.26894142, 0.73105858]],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          nn_ops.softsign,\n-          np.array([[-2, -1, 0, 1, 2]], dtype=dtype),\n-          expected=np.array(\n-              [[-0.66666669, -0.5, 0, 0.5, 0.66666669]], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.sign,\n-          np.array(\n-              [[-2.0, -1.0, -0.0, +0.0, 1.0, 2.0, float(\"nan\")]], dtype=dtype\n-          ),\n-          expected=np.array(\n-              [[-1.0, -1.0, -0.0, +0.0, 1.0, 1.0, float(\"nan\")]], dtype=dtype\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.is_finite,\n-          np.array(\n-              [[42, float(\"inf\"), -123], [float(\"nan\"), 0, -0.0]], dtype=dtype\n-          ),\n-          expected=np.array(\n-              [[True, False, True], [False, True, True]], dtype=np.bool_\n-          ),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.lgamma,\n-          np.array(0.5, dtype=dtype),\n-          expected=np.array(np.log(np.pi) / 2, dtype=dtype),\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.lgamma,\n-          np.array(\n-              [\n-                  [1, 2, 3],\n-                  [4, 5, 6],\n-                  [1 / 2, 3 / 2, 5 / 2],\n-                  [-3 / 2, -7 / 2, -11 / 2],\n-              ],\n-              dtype=dtype,\n-          ),\n-          expected=np.array(\n-              [\n-                  [0, 0, np.log(2.0)],\n-                  [np.log(6.0), np.log(24.0), np.log(120)],\n-                  [\n-                      np.log(np.pi) / 2,\n-                      np.log(np.pi) / 2 - np.log(2),\n-                      np.log(np.pi) / 2 - np.log(4) + np.log(3),\n-                  ],\n-                  [\n-                      np.log(np.pi) / 2 - np.log(3) + np.log(4),\n-                      np.log(np.pi) / 2 - np.log(105) + np.log(16),\n-                      np.log(np.pi) / 2 - np.log(10395) + np.log(64),\n-                  ],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n-\n-      # The actual result is complex. Take the real part.\n-      self.assert_op_output_matches_expected(\n-          math_ops.lgamma,\n-          np.array([-1 / 2, -5 / 2, -9 / 2], dtype=dtype),\n-          expected=np.array(\n-              [\n-                  np.log(np.pi) / 2 + np.log(2),\n-                  np.log(np.pi) / 2 - np.log(15) + np.log(8),\n-                  np.log(np.pi) / 2 - np.log(945) + np.log(32),\n-              ],\n-              dtype=dtype,\n-          ),\n-          atol=1e-4,\n-      )\n-\n-      self.assert_op_output_matches_expected(\n-          math_ops.digamma,\n-          np.array(\n-              [\n-                  [1.0, 0.5, 1 / 3.0],\n-                  [0.25, 1 / 6.0, 0.125],\n-                  [2.0, 3.0, 4.0],\n-                  [6.0, 8.0, 9.0],\n-              ],\n-              dtype=dtype,\n-          ),\n-          expected=np.array(\n-              [\n-                  [\n-                      -np.euler_gamma,\n-                      -2 * np.log(2) - np.euler_gamma,\n-                      -np.pi / 2 / np.sqrt(3)\n-                      - 3 * np.log(3) / 2\n-                      - np.euler_gamma,\n-                  ],\n-                  [\n-                      -np.pi / 2 - 3 * np.log(2) - np.euler_gamma,\n-                      -np.pi * np.sqrt(3) / 2\n-                      - 2 * np.log(2)\n-                      - 3 * np.log(3) / 2\n-                      - np.euler_gamma,\n-                      -np.pi / 2\n-                      - 4 * np.log(2)\n-                      - (\n-                          np.pi\n-                          + np.log(2 + np.sqrt(2))\n-                          - np.log(2 - np.sqrt(2))\n-                      )\n-                      / np.sqrt(2)\n-                      - np.euler_gamma,\n-                  ],\n-                  [\n-                      1 - np.euler_gamma,\n-                      1.5 - np.euler_gamma,\n-                      11 / 6.0 - np.euler_gamma,\n-                  ],\n-                  [\n-                      137 / 60.0 - np.euler_gamma,\n-                      363 / 140.0 - np.euler_gamma,\n-                      761 / 280.0 - np.euler_gamma,\n-                  ],\n-              ],\n-              dtype=dtype,\n-          ),\n-      )\n+          self.assert_op_output_matches_expected(\n+              math_ops.erf,\n+              x,\n+              expected=erf_x,\n+              local_session=session,\n+          )\n+          self.assert_op_output_matches_expected(\n+              math_ops.erfc,\n+              x,\n+              expected=erfc_x,\n+              local_session=session,\n+          )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.exp,\n+            np.array([[-1, 1]], dtype=dtype),\n+            expected=np.array([[0.36787945, 2.7182817]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.expm1,\n+            np.array([[-1, 1]], dtype=dtype),\n+            expected=np.array([[-0.63212056, 1.71828183]], dtype=dtype),\n+            local_session=session,\n+            rtol=1e-5,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.floor,\n+            np.array([[-1.7, 1.2]], dtype=dtype),\n+            expected=np.array([[-2, 1]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.is_finite,\n+            np.array(\n+                [[-np.inf, -2, -1, 0, 0.5, 1, 2, np.inf, np.nan]], dtype=dtype\n+            ),\n+            expected=np.array([[0, 1, 1, 1, 1, 1, 1, 0, 0]], dtype=np.bool_),\n+            local_session=session,\n+        )\n+\n+        # Tests for tf.nn ops.\n+        self.assert_op_output_matches_expected(\n+            nn_ops.l2_loss,\n+            np.array([[[]]], dtype=dtype),\n+            expected=dtype(0),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.l2_loss,\n+            dtype(4),\n+            dtype(8),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.l2_loss,\n+            np.array([[-2, 4]], dtype=dtype),\n+            expected=dtype(10),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.reciprocal,\n+            np.array([[1, 2]], dtype=dtype),\n+            expected=np.array([[1, 0.5]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.log,\n+            np.array([[1, 2]], dtype=dtype),\n+            expected=np.array([[0, 0.69314718]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.sin,\n+            np.array([[1, 2]], dtype=dtype),\n+            expected=np.array([[0.841478, 0.909302]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.cos,\n+            np.array([[1, 2]], dtype=dtype),\n+            expected=np.array([[0.540297, -0.41614]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        # Confirm that log1p will remain precise across a range of small values.\n+        self.assert_op_output_matches_expected(\n+            math_ops.log1p,\n+            np.array(\n+                [[1e-14, 1e-15, 0.6, 2] + [x * 1e-5 for x in range(1, 20)]],\n+                dtype=dtype,\n+            ),\n+            expected=np.log1p(\n+                np.array(\n+                    [[1e-14, 1e-15, 0.6, 2] + [x * 1e-5 for x in range(1, 20)]],\n+                    dtype=dtype,\n+                )\n+            ).astype(dtype),\n+            local_session=session,\n+            rtol=1e-15 if dtype == np.float64 else 1e-4,\n+            atol=1e-15 if dtype == np.float64 else 1e-4,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.rint,\n+            np.array(\n+                [\n+                    [-1.7, 1.2, 4.0, 0.0],\n+                    [-3.5, -2.5, -1.5, -0.5],\n+                    [0.5, 1.5, 2.5, 3.5],\n+                ],\n+                dtype=dtype,\n+            ),\n+            expected=np.array(\n+                [[-2, 1, 4, 0], [-4, -2, -2, 0], [0, 2, 2, 4]], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+        self.assert_op_output_matches_expected(\n+            math_ops.round,\n+            np.array(\n+                [\n+                    [-1.7, 1.2, 4.0, 0.0],\n+                    [-3.5, -2.5, -1.5, -0.5],\n+                    [0.5, 1.5, 2.5, 3.5],\n+                ],\n+                dtype=dtype,\n+            ),\n+            expected=np.array(\n+                [[-2, 1, 4, 0], [-4, -2, -2, 0], [0, 2, 2, 4]], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.rsqrt,\n+            np.array([[4, 16]], dtype=dtype),\n+            expected=np.array([[0.5, 0.25]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.sigmoid,\n+            np.array([[1, 1, 1, 1], [1, 2, 3, 4]], dtype=dtype),\n+            expected=np.array(\n+                [\n+                    [0.7310586, 0.7310586, 0.7310586, 0.7310586],\n+                    [0.7310586, 0.880797, 0.95257413, 0.98201376],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.sigmoid,\n+            np.array([-300, -150, 0, 150, 300], dtype=dtype),\n+            expected=np.array([0, 0, 0.5, 1, 1], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.sinh,\n+            np.array([1, 2, 3, 4], dtype=dtype),\n+            expected=np.array(\n+                [1.17520119, 3.62686041, 10.01787493, 27.2899172], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.sqrt,\n+            np.array([[4, 9]], dtype=dtype),\n+            expected=np.array([[2, 3]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.tan,\n+            np.array([1, 2, 3, 4], dtype=dtype),\n+            expected=np.array(\n+                [1.55740772, -2.18503986, -0.14254654, 1.15782128], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.tanh,\n+            np.array(\n+                [\n+                    [1, 2, 3, 4],\n+                    [np.inf, -np.inf, np.nan, 20],\n+                    [19, -19, 22, -22],\n+                ],\n+                dtype=dtype,\n+            ),\n+            expected=np.array(\n+                [\n+                    [0.76159418, 0.96402758, 0.99505478, 0.99932933],\n+                    [1.0, -1.0, np.nan, 1.0],\n+                    [1.0, -1.0, 1.0, -1.0],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.log_softmax,\n+            np.array([[1, 1, 1, 1], [1, 2, 3, 4]], dtype=dtype),\n+            expected=np.array(\n+                [\n+                    [-1.3862944, -1.3862944, -1.3862944, -1.3862944],\n+                    [-3.4401896, -2.4401896, -1.4401897, -0.44018969],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.elu,\n+            np.array([[-1, 0, 1, -1e-6]], dtype=dtype),\n+            expected=np.array(\n+                [[-0.63212056, 0, 1, -9.999995e-07]], dtype=dtype\n+            ),\n+            rtol=1e-5,\n+            atol=1e-6,\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.selu,\n+            np.array([[-1, 0, 1, -1e-5]], dtype=dtype),\n+            expected=np.array(\n+                [[-1.11133074, 0.0, 1.05070099, -1.758090550379974e-05]],\n+                dtype=dtype,\n+            ),\n+            rtol=1e-5,\n+            atol=1e-6,\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.relu,\n+            np.array([[-1, 1]], dtype=dtype),\n+            expected=np.array([[0, 1]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.relu6,\n+            np.array([[-0.05, 6.05, 5]], dtype=dtype),\n+            expected=np.array([[0, 6, 5]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.leaky_relu,\n+            np.array([[-2, -1, 0, 1, 2]], dtype=dtype),\n+            expected=np.array([[-0.4, -0.2, 0.0, 1.0, 2.0]], dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.softmax,\n+            np.array([1, 2, 3, 4], dtype=dtype),\n+            expected=np.array(\n+                [0.032058604, 0.087144323, 0.23688284, 0.64391428], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.softmax,\n+            np.array([[1, 1, 1, 1], [1, 2, 3, 4]], dtype=dtype),\n+            expected=np.array(\n+                [\n+                    [0.25, 0.25, 0.25, 0.25],\n+                    [0.032058604, 0.087144323, 0.23688284, 0.64391428],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.softmax,\n+            np.array([[[1, 1], [1, 1]], [[1, 2], [3, 4]]], dtype=dtype),\n+            expected=np.array(\n+                [\n+                    [[0.5, 0.5], [0.5, 0.5]],\n+                    [[0.26894142, 0.73105858], [0.26894142, 0.73105858]],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            nn_ops.softsign,\n+            np.array([[-2, -1, 0, 1, 2]], dtype=dtype),\n+            expected=np.array(\n+                [[-0.66666669, -0.5, 0, 0.5, 0.66666669]], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.sign,\n+            np.array(\n+                [[-2.0, -1.0, -0.0, +0.0, 1.0, 2.0, float(\"nan\")]], dtype=dtype\n+            ),\n+            expected=np.array(\n+                [[-1.0, -1.0, -0.0, +0.0, 1.0, 1.0, float(\"nan\")]], dtype=dtype\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.is_finite,\n+            np.array(\n+                [[42, float(\"inf\"), -123], [float(\"nan\"), 0, -0.0]], dtype=dtype\n+            ),\n+            expected=np.array(\n+                [[True, False, True], [False, True, True]], dtype=np.bool_\n+            ),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.lgamma,\n+            np.array(0.5, dtype=dtype),\n+            expected=np.array(np.log(np.pi) / 2, dtype=dtype),\n+            local_session=session,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.lgamma,\n+            np.array(\n+                [\n+                    [1, 2, 3],\n+                    [4, 5, 6],\n+                    [1 / 2, 3 / 2, 5 / 2],\n+                    [-3 / 2, -7 / 2, -11 / 2],\n+                ],\n+                dtype=dtype,\n+            ),\n+            expected=np.array(\n+                [\n+                    [0, 0, np.log(2.0)],\n+                    [np.log(6.0), np.log(24.0), np.log(120)],\n+                    [\n+                        np.log(np.pi) / 2,\n+                        np.log(np.pi) / 2 - np.log(2),\n+                        np.log(np.pi) / 2 - np.log(4) + np.log(3),\n+                    ],\n+                    [\n+                        np.log(np.pi) / 2 - np.log(3) + np.log(4),\n+                        np.log(np.pi) / 2 - np.log(105) + np.log(16),\n+                        np.log(np.pi) / 2 - np.log(10395) + np.log(64),\n+                    ],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n+\n+        # The actual result is complex. Take the real part.\n+        self.assert_op_output_matches_expected(\n+            math_ops.lgamma,\n+            np.array([-1 / 2, -5 / 2, -9 / 2], dtype=dtype),\n+            expected=np.array(\n+                [\n+                    np.log(np.pi) / 2 + np.log(2),\n+                    np.log(np.pi) / 2 - np.log(15) + np.log(8),\n+                    np.log(np.pi) / 2 - np.log(945) + np.log(32),\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+            atol=1e-4,\n+        )\n+\n+        self.assert_op_output_matches_expected(\n+            math_ops.digamma,\n+            np.array(\n+                [\n+                    [1.0, 0.5, 1 / 3.0],\n+                    [0.25, 1 / 6.0, 0.125],\n+                    [2.0, 3.0, 4.0],\n+                    [6.0, 8.0, 9.0],\n+                ],\n+                dtype=dtype,\n+            ),\n+            expected=np.array(\n+                [\n+                    [\n+                        -np.euler_gamma,\n+                        -2 * np.log(2) - np.euler_gamma,\n+                        -np.pi / 2 / np.sqrt(3)\n+                        - 3 * np.log(3) / 2\n+                        - np.euler_gamma,\n+                    ],\n+                    [\n+                        -np.pi / 2 - 3 * np.log(2) - np.euler_gamma,\n+                        -np.pi * np.sqrt(3) / 2\n+                        - 2 * np.log(2)\n+                        - 3 * np.log(3) / 2\n+                        - np.euler_gamma,\n+                        -np.pi / 2\n+                        - 4 * np.log(2)\n+                        - (\n+                            np.pi\n+                            + np.log(2 + np.sqrt(2))\n+                            - np.log(2 - np.sqrt(2))\n+                        )\n+                        / np.sqrt(2)\n+                        - np.euler_gamma,\n+                    ],\n+                    [\n+                        1 - np.euler_gamma,\n+                        1.5 - np.euler_gamma,\n+                        11 / 6.0 - np.euler_gamma,\n+                    ],\n+                    [\n+                        137 / 60.0 - np.euler_gamma,\n+                        363 / 140.0 - np.euler_gamma,\n+                        761 / 280.0 - np.euler_gamma,\n+                    ],\n+                ],\n+                dtype=dtype,\n+            ),\n+            local_session=session,\n+        )\n \n \n if __name__ == \"__main__\":"
        },
        {
            "sha": "d642418a44c2f5ccd334b5507825863af943bcb1",
            "filename": "tensorflow/compiler/tests/xla_test.py",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f021c3f4ebca346d48ad2b2f06665542612b6911/tensorflow%2Fcompiler%2Ftests%2Fxla_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f021c3f4ebca346d48ad2b2f06665542612b6911/tensorflow%2Fcompiler%2Ftests%2Fxla_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Ftests%2Fxla_test.py?ref=f021c3f4ebca346d48ad2b2f06665542612b6911",
            "patch": "@@ -308,33 +308,34 @@ def device_scope(self):\n       yield\n \n   def assert_op_output_matches_expected(\n-      self, op, inp, expected, equality_test=None, rtol=1e-3, atol=1e-5\n+      self, op, inp, expected, local_session,\n+      equality_test=None, rtol=1e-3, atol=1e-5\n   ):\n     \"\"\"Verifies that 'op' produces 'expected' when fed input 'inp' .\n \n     Args:\n       op: operator to test\n       inp: numpy input array to use as input to 'op'.\n       expected: numpy array representing the expected output of 'op'.\n+      local_session: The session to use for the test.\n       equality_test: either None, or a function that tests two numpy arrays for\n         equality. If None, self.assertAllClose is used.\n       rtol: relative tolerance for equality test.\n       atol: absolute tolerance for equality test.\n     \"\"\"\n-    with self.session() as local_session:\n-      with self.test_scope():\n-        pinp = array_ops.placeholder(\n-            dtypes.as_dtype(inp.dtype), inp.shape, name='a'\n-        )\n-        output = op(pinp)\n-      result = local_session.run(output, {pinp: inp})\n-      if equality_test is None:\n-        self.assertEqual(output.dtype, expected.dtype)\n-        self.assertAllCloseAccordingToType(\n-            expected, result, rtol=rtol, atol=atol, bfloat16_rtol=0.03\n-        )\n-      else:\n-        equality_test(result, expected, rtol=rtol, atol=atol)\n+    with self.test_scope():\n+      pinp = array_ops.placeholder(\n+          dtypes.as_dtype(inp.dtype), inp.shape, name='a'\n+      )\n+      output = op(pinp)\n+    result = local_session.run(output, {pinp: inp})\n+    if equality_test is None:\n+      self.assertEqual(output.dtype, expected.dtype)\n+      self.assertAllCloseAccordingToType(\n+          expected, result, rtol=rtol, atol=atol, bfloat16_rtol=0.03\n+      )\n+    else:\n+      equality_test(result, expected, rtol=rtol, atol=atol)\n \n   def test_scope(self):\n     \"\"\"Deprecated alias of `device_scope`."
        }
    ],
    "stats": {
        "total": 1004,
        "additions": 541,
        "deletions": 463
    }
}