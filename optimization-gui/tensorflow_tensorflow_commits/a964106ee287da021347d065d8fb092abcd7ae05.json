{
    "author": "tensorflower-gardener",
    "message": "Add all the unary and binary ops to hlo op profiler.\nMany ops aren't supported currently.\n\nPiperOrigin-RevId: 806320749",
    "sha": "a964106ee287da021347d065d8fb092abcd7ae05",
    "files": [
        {
            "sha": "b83f7523966fa5820379929bf3c49e29113a5c11",
            "filename": "third_party/xla/xla/service/gpu/model/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2FBUILD?ref=a964106ee287da021347d065d8fb092abcd7ae05",
            "patch": "@@ -1024,6 +1024,7 @@ cc_library(\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/time\",\n+        \"@com_google_absl//absl/types:span\",\n         \"@local_tsl//tsl/platform:errors\",\n         \"@local_tsl//tsl/platform:statusor\",\n     ] + if_cuda([\n@@ -1089,10 +1090,10 @@ xla_test(\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/tests:hlo_test_base\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:errors\",\n         \"@com_google_googletest//:gtest\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:errors\",\n-        \"@local_tsl//tsl/platform:status_matchers\",\n     ],\n )\n "
        },
        {
            "sha": "27b2ae929a99ad1f2e3b11515a3aa6d2b9cd345b",
            "filename": "third_party/xla/xla/service/gpu/model/hlo_op_profiler.cc",
            "status": "modified",
            "additions": 174,
            "deletions": 0,
            "changes": 174,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler.cc?ref=a964106ee287da021347d065d8fb092abcd7ae05",
            "patch": "@@ -15,10 +15,12 @@ limitations under the License.\n \n #include \"xla/service/gpu/model/hlo_op_profiler.h\"\n \n+#include <array>\n #include <cstdint>\n #include <memory>\n #include <random>\n #include <string>\n+#include <unordered_set>\n #include <utility>\n #include <vector>\n \n@@ -27,6 +29,7 @@ limitations under the License.\n #include \"absl/status/statusor.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n@@ -55,6 +58,175 @@ limitations under the License.\n namespace xla {\n namespace gpu {\n \n+static constexpr std::array<PrimitiveType, 13> dtypes = {\n+    S8, S16, S32, S64, U8, U16, U32, U64, F16, F32, F64, C64, C128,\n+};\n+\n+static constexpr std::array<HloOpcode, 74> ops = {\n+    // Unary\n+    // go/keep-sorted start\n+    HloOpcode::kAbs,\n+    HloOpcode::kBitcast,\n+    HloOpcode::kBitcastConvert,\n+    HloOpcode::kBroadcast,\n+    HloOpcode::kCbrt,\n+    HloOpcode::kCeil,\n+    HloOpcode::kCholesky,\n+    HloOpcode::kClz,\n+    HloOpcode::kCollectivePermuteDone,\n+    HloOpcode::kConvert,\n+    HloOpcode::kCopy,\n+    HloOpcode::kCos,\n+    HloOpcode::kDomain,\n+    HloOpcode::kErf,\n+    HloOpcode::kExp,\n+    HloOpcode::kExpm1,\n+    HloOpcode::kFft,\n+    HloOpcode::kFloor,\n+    HloOpcode::kGetDimensionSize,\n+    HloOpcode::kGetTupleElement,\n+    HloOpcode::kImag,\n+    HloOpcode::kIsFinite,\n+    HloOpcode::kLog,\n+    HloOpcode::kLog1p,\n+    HloOpcode::kLogistic,\n+    HloOpcode::kNegate,\n+    HloOpcode::kNot,\n+    HloOpcode::kPopulationCount,\n+    HloOpcode::kReal,\n+    HloOpcode::kReducePrecision,\n+    HloOpcode::kReshape,\n+    HloOpcode::kReverse,\n+    HloOpcode::kRngBitGenerator,\n+    HloOpcode::kRoundNearestAfz,\n+    HloOpcode::kRoundNearestEven,\n+    HloOpcode::kRsqrt,\n+    HloOpcode::kSign,\n+    HloOpcode::kSin,\n+    HloOpcode::kSlice,\n+    HloOpcode::kSqrt,\n+    HloOpcode::kTan,\n+    HloOpcode::kTanh,\n+    HloOpcode::kTopK,\n+    HloOpcode::kTranspose,\n+    // go/keep-sorted end\n+    // Binary\n+    // go/keep-sorted start\n+    HloOpcode::kAdd,\n+    HloOpcode::kAddDependency,\n+    HloOpcode::kAnd,\n+    HloOpcode::kAtan2,\n+    HloOpcode::kCompare,\n+    HloOpcode::kConvolution,\n+    HloOpcode::kDivide,\n+    HloOpcode::kDot,\n+    HloOpcode::kGather,\n+    HloOpcode::kMaximum,\n+    HloOpcode::kMinimum,\n+    HloOpcode::kMultiply,\n+    HloOpcode::kOr,\n+    HloOpcode::kOutfeed,\n+    HloOpcode::kPad,\n+    HloOpcode::kPower,\n+    HloOpcode::kRemainder,\n+    HloOpcode::kSetDimensionSize,\n+    HloOpcode::kShiftLeft,\n+    HloOpcode::kShiftRightArithmetic,\n+    HloOpcode::kShiftRightLogical,\n+    HloOpcode::kStochasticConvert,\n+    HloOpcode::kSubtract,\n+    HloOpcode::kTriangularSolve,\n+    HloOpcode::kXor,\n+    // go/keep-sorted end\n+    // TODO(b/443800190): HloOpcode::kComplex\n+};\n+\n+static const std::unordered_set<HloOpcode> TooFastToMeasureOps = {\n+    // go/keep-sorted start\n+    HloOpcode::kAbs,\n+    HloOpcode::kAnd,\n+    HloOpcode::kBitcast,\n+    HloOpcode::kBitcastConvert,\n+    HloOpcode::kCeil,\n+    HloOpcode::kClz,\n+    HloOpcode::kCopy,\n+    HloOpcode::kFloor,\n+    HloOpcode::kImag,\n+    HloOpcode::kIsFinite,\n+    HloOpcode::kMaximum,\n+    HloOpcode::kMinimum,\n+    HloOpcode::kNegate,\n+    HloOpcode::kNot,\n+    HloOpcode::kOr,\n+    HloOpcode::kReal,\n+    HloOpcode::kSign,\n+    HloOpcode::kXor\n+    // go/keep-sorted end\n+};\n+\n+static const std::unordered_set<HloOpcode> UnsupportedOps = {\n+    // These Opcodes need custom APIs to create instructions that can be\n+    // used for profiling. They are not created by HloInstruction::CreateUnary\n+    // or HloInstruction::CreateBinary functions.\n+\n+    // Unary\n+    // go/keep-sorted start\n+    HloOpcode::kBitcastConvert,\n+    HloOpcode::kBroadcast,\n+    HloOpcode::kCholesky,\n+    HloOpcode::kCollectivePermuteDone,\n+    HloOpcode::kConvert,\n+    HloOpcode::kDomain,\n+    HloOpcode::kFft,\n+    HloOpcode::kGetDimensionSize,\n+    HloOpcode::kGetTupleElement,\n+    HloOpcode::kOutfeed,\n+    HloOpcode::kPad,\n+    HloOpcode::kPower,\n+    HloOpcode::kReducePrecision,\n+    HloOpcode::kRemainder,\n+    HloOpcode::kReshape,\n+    HloOpcode::kReverse,\n+    HloOpcode::kRngBitGenerator,\n+    HloOpcode::kSetDimensionSize,\n+    HloOpcode::kShiftLeft,\n+    HloOpcode::kShiftRightArithmetic,\n+    HloOpcode::kShiftRightLogical,\n+    HloOpcode::kSlice,\n+    HloOpcode::kStochasticConvert,\n+    HloOpcode::kTopK,\n+    HloOpcode::kTranspose,\n+    // go/keep-sorted end\n+    // Binary\n+    // go/keep-sorted start\n+    HloOpcode::kAddDependency,\n+    HloOpcode::kCompare,\n+    HloOpcode::kConvolution,\n+    HloOpcode::kDot,\n+    HloOpcode::kGather,\n+    HloOpcode::kOutfeed,\n+    HloOpcode::kPad,\n+    HloOpcode::kSetDimensionSize,\n+    HloOpcode::kTriangularSolve,\n+    // go/keep-sorted end\n+};\n+\n+absl::Span<const PrimitiveType> HloOpProfiler::AllSupportedDtypes() {\n+  return absl::MakeConstSpan(dtypes);\n+}\n+\n+absl::Span<const HloOpcode> HloOpProfiler::AllSupportedOps() {\n+  return absl::MakeConstSpan(ops);\n+}\n+\n+const std::unordered_set<HloOpcode>& HloOpProfiler::Unsupported() {\n+  return UnsupportedOps;\n+}\n+\n+const std::unordered_set<HloOpcode>& HloOpProfiler::TooFastToMeasure() {\n+  return TooFastToMeasureOps;\n+}\n+\n #ifdef GOOGLE_CUDA\n class CuptiKernelTracer : public HloOpProfiler::KernelTracer,\n                           public profiler::CuptiTraceCollector {\n@@ -133,6 +305,8 @@ HloOpProfiler::GetKernelTracer() {\n   HloInstruction* pf = fusion_builder.AddInstruction(\n       HloInstruction::CreateParameter(0, shape, \"pf\"));\n   HloInstruction* last = pf;\n+  // TODO(appujee): This only works when the op takes `Shape` as input; i.e.,\n+  // fails for kComplex for example.\n   for (int i = 0; i < chain_length; ++i) {\n     switch (HloOpcodeArity(op).value_or(0)) {\n       case 1:"
        },
        {
            "sha": "a4ca2dae8ba8d45ba143b8738782c76f23e3e0ca",
            "filename": "third_party/xla/xla/service/gpu/model/hlo_op_profiler.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler.h?ref=a964106ee287da021347d065d8fb092abcd7ae05",
            "patch": "@@ -18,9 +18,11 @@ limitations under the License.\n \n #include <cstdint>\n #include <memory>\n+#include <unordered_set>\n \n #include \"absl/status/statusor.h\"\n #include \"absl/time/time.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/service/gpu/model/hlo_op_profile.pb.h\"\n@@ -43,6 +45,14 @@ class HloOpProfiler {\n \n   static std::unique_ptr<KernelTracer> GetKernelTracer();\n \n+  static absl::Span<const HloOpcode> AllSupportedOps();\n+\n+  static const std::unordered_set<HloOpcode>& Unsupported();\n+\n+  static const std::unordered_set<HloOpcode>& TooFastToMeasure();\n+\n+  static absl::Span<const PrimitiveType> AllSupportedDtypes();\n+\n   absl::StatusOr<HloInstructionProfile> MeasureClockCyclesPerOp(\n       HloOpcode op, PrimitiveType data_type);\n "
        },
        {
            "sha": "23df64014a23dcab923914b8ba02fc1df818a428",
            "filename": "third_party/xla/xla/service/gpu/model/hlo_op_profiler_run.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_run.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_run.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_run.cc?ref=a964106ee287da021347d065d8fb092abcd7ae05",
            "patch": "@@ -89,7 +89,6 @@ int RunProfiler(int argc, char** argv) {\n   };\n   const std::vector<HloOpcode> ops = {\n       // Unary\n-      HloOpcode::kAcosh,\n       HloOpcode::kCbrt,\n       HloOpcode::kCos,\n       HloOpcode::kErf,\n@@ -113,8 +112,8 @@ int RunProfiler(int argc, char** argv) {\n \n   HloInstructionProfileList instr_profiles;\n \n-  for (const PrimitiveType data_type : dtypes) {\n-    for (const HloOpcode op : ops) {\n+  for (const PrimitiveType data_type : HloOpProfiler::AllSupportedDtypes()) {\n+    for (const HloOpcode op : HloOpProfiler::AllSupportedOps()) {\n       auto result = profiler.MeasureClockCyclesPerOp(op, data_type);\n       if (result.ok()) {\n         instr_profiles.add_entries()->Swap(&*result);"
        },
        {
            "sha": "a44f850930d33951142e2ceb099ae1d74b3dafb7",
            "filename": "third_party/xla/xla/service/gpu/model/hlo_op_profiler_test.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 2,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a964106ee287da021347d065d8fb092abcd7ae05/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fhlo_op_profiler_test.cc?ref=a964106ee287da021347d065d8fb092abcd7ae05",
            "patch": "@@ -15,13 +15,15 @@ limitations under the License.\n \n #include \"xla/service/gpu/model/hlo_op_profiler.h\"\n \n+#include <unordered_set>\n+\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/xla_data.pb.h\"\n-#include \"tsl/platform/errors.h\"\n-#include \"tsl/platform/status_matchers.h\"\n \n namespace xla {\n namespace gpu {\n@@ -60,6 +62,51 @@ TEST_F(HloOpProfilerTest, UnsupportedCombinationsDoNotCrash) {\n               absl_testing::StatusIs(tsl::error::INVALID_ARGUMENT));\n }\n \n+TEST_F(HloOpProfilerTest, AllSupportedCombinationsAreMeasurable) {\n+  std::unordered_set<HloOpcode> FloatTypes = {\n+      // go/keep-sorted start\n+      HloOpcode::kAtan2,\n+      HloOpcode::kCbrt,\n+      HloOpcode::kCeil,\n+      HloOpcode::kCos,\n+      HloOpcode::kErf,\n+      HloOpcode::kExp,\n+      HloOpcode::kExpm1,\n+      HloOpcode::kFloor,\n+      HloOpcode::kImag,\n+      HloOpcode::kIsFinite,\n+      HloOpcode::kLog,\n+      HloOpcode::kLog1p,\n+      HloOpcode::kLogistic,\n+      HloOpcode::kReal,\n+      HloOpcode::kRoundNearestAfz,\n+      HloOpcode::kRoundNearestEven,\n+      HloOpcode::kRsqrt,\n+      HloOpcode::kSin,\n+      HloOpcode::kSqrt,\n+      HloOpcode::kTan,\n+      HloOpcode::kTanh\n+      // go/keep-sorted end\n+  };\n+  std::unordered_set<HloOpcode> MeasurebleInFloat = {\n+      // go/keep-sorted start\n+      HloOpcode::kAdd,\n+      HloOpcode::kMultiply,\n+      HloOpcode::kSubtract,\n+      // go/keep-sorted end\n+  };\n+\n+  FloatTypes.insert(MeasurebleInFloat.begin(), MeasurebleInFloat.end());\n+  HloOpProfiler profiler(test_runner_as_hlo_runner());\n+  for (const HloOpcode op : HloOpProfiler::AllSupportedOps()) {\n+    if (!HloOpProfiler::TooFastToMeasure().count(op) &&\n+        !HloOpProfiler::Unsupported().count(op)) {\n+      auto Type = FloatTypes.count(op) ? F32 : S32;\n+      TF_EXPECT_OK(profiler.MeasureClockCyclesPerOp(op, Type));\n+    }\n+  }\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 245,
        "additions": 238,
        "deletions": 7
    }
}