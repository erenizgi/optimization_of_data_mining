{
    "author": "ezhulenev",
    "message": "[stream_executor] Document se::MemoryAllocation as a future direction for unifying physcal memory allocations in SE\n\nPiperOrigin-RevId: 842694845",
    "sha": "62925a3d0e7a6c18c10644b39d143d47e049ecdd",
    "files": [
        {
            "sha": "b94670ea68a49c088b76cebf1eebae71ebdd44ce",
            "filename": "third_party/xla/xla/stream_executor/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62925a3d0e7a6c18c10644b39d143d47e049ecdd/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62925a3d0e7a6c18c10644b39d143d47e049ecdd/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD?ref=62925a3d0e7a6c18c10644b39d143d47e049ecdd",
            "patch": "@@ -344,6 +344,10 @@ xla_cc_test(\n cc_library(\n     name = \"memory_allocation\",\n     hdrs = [\"memory_allocation.h\"],\n+    deps = [\n+        \":device_address\",\n+        \"@com_google_absl//absl/base:core_headers\",\n+    ],\n )\n \n cc_library(\n@@ -529,6 +533,7 @@ cc_library(\n     name = \"generic_memory_allocation\",\n     hdrs = [\"generic_memory_allocation.h\"],\n     deps = [\n+        \":device_address\",\n         \":memory_allocation\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n     ],"
        },
        {
            "sha": "69ec0d9361ec1a65e8f5d3229ab7ba8a29d301e3",
            "filename": "third_party/xla/xla/stream_executor/generic_memory_allocation.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62925a3d0e7a6c18c10644b39d143d47e049ecdd/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgeneric_memory_allocation.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62925a3d0e7a6c18c10644b39d143d47e049ecdd/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgeneric_memory_allocation.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgeneric_memory_allocation.h?ref=62925a3d0e7a6c18c10644b39d143d47e049ecdd",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <utility>\n \n #include \"absl/functional/any_invocable.h\"\n+#include \"xla/stream_executor/device_address.h\"\n #include \"xla/stream_executor/memory_allocation.h\"\n \n namespace stream_executor {\n@@ -39,8 +40,9 @@ class GenericMemoryAllocation final : public MemoryAllocation {\n     }\n   }\n \n-  void* opaque() const final { return ptr_; }\n-  uint64_t size() const final { return size_; }\n+  DeviceAddressBase address() const final {\n+    return DeviceAddressBase(ptr_, size_);\n+  }\n \n  private:\n   void* ptr_ = nullptr;"
        },
        {
            "sha": "2a75a1069b648b6b4509a3379449f0c3bb5f2a3f",
            "filename": "third_party/xla/xla/stream_executor/memory_allocation.h",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62925a3d0e7a6c18c10644b39d143d47e049ecdd/third_party%2Fxla%2Fxla%2Fstream_executor%2Fmemory_allocation.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62925a3d0e7a6c18c10644b39d143d47e049ecdd/third_party%2Fxla%2Fxla%2Fstream_executor%2Fmemory_allocation.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fmemory_allocation.h?ref=62925a3d0e7a6c18c10644b39d143d47e049ecdd",
            "patch": "@@ -18,11 +18,22 @@ limitations under the License.\n \n #include <cstdint>\n \n+#include \"absl/base/macros.h\"\n+#include \"xla/stream_executor/device_address.h\"\n+\n namespace stream_executor {\n \n-// An RAII handle for a memory allocated for a device. It can be pinned host\n-// memory, unified memory, device memory, etc. depending on what kinds of\n-// memories are supported by underlying device.\n+// A MemoryAllocation is a block of physical memory allocated on the\n+// StreamExecutor device.\n+//\n+// MemoryAllocation is not necessarily a physical memory on the physical device\n+// (i.e. GPU), it can be a memory on the host pre-mapped for the host to device\n+// communication. It can be pinned host memory, unified memory, device memory,\n+// etc. depending on what kinds of memories are supported by underlying device.\n+//\n+// MemoryAllocation can be mapped to a DeviceAddress, which can be used to\n+// access the memory from device or host. Multiple device address ranges can be\n+// mapped to the same MemoryAllocation.\n class MemoryAllocation {\n  public:\n   MemoryAllocation() = default;\n@@ -31,8 +42,16 @@ class MemoryAllocation {\n   MemoryAllocation(MemoryAllocation&&) = delete;\n   MemoryAllocation& operator=(MemoryAllocation&&) = delete;\n \n-  virtual void* opaque() const = 0;\n-  virtual uint64_t size() const = 0;\n+  // A device address which gives access to the memory allocation. Can be\n+  // nullptr if memory allocation is not adressable, i.e. physical allocation\n+  // might not be mapped to any virtual address by default.\n+  virtual DeviceAddressBase address() const = 0;\n+\n+  ABSL_DEPRECATE_AND_INLINE()\n+  void* opaque() const { return address().opaque(); }\n+\n+  ABSL_DEPRECATE_AND_INLINE()\n+  uint64_t size() const { return address().size(); }\n };\n \n }  // namespace stream_executor"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 33,
        "deletions": 7
    }
}