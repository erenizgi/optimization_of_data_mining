{
    "author": "majnemer",
    "message": "Refactor: Use `std::align_val_t` for aligned allocation functions.\n\nThis change updates `AlignedMalloc`, `AlignedSizedFree`, and `AlignedAllocator` to use `std::align_val_t` for specifying alignment, aligning with standard C++ practices for overaligned allocation. Deprecated inline overloads are provided to ease the transition for existing callers.\n\nThis matches the standard `new(size_t size, std::align_val_t alignment)`\nand `delete(void* ptr, size_t size, std::align_val_t alignment)` ordering.\n\nPiperOrigin-RevId: 832825664",
    "sha": "53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
    "files": [
        {
            "sha": "ab4822e73fcc91a00b2b43e06200f5a12c70aa1e",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2FBUILD?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -688,6 +688,7 @@ cc_library(\n     ],\n     deps = tf_windows_aware_platform_deps(\"platform_port\") + [\n         \":platform\",\n+        \"@com_google_absl//absl/base:core_headers\",\n         \"@local_xla//xla/tsl/platform:byte_order\",\n         \"@local_xla//xla/tsl/platform:dynamic_annotations\",\n         \"@local_xla//xla/tsl/platform:types\","
        },
        {
            "sha": "d2b3286f07e78a0f6e0c0363d19024f73a6db6e8",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/mem.h",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fmem.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fmem.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Fmem.h?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -18,8 +18,10 @@ limitations under the License.\n \n #include <cstddef>\n #include <cstdint>\n+#include <new>\n \n // TODO(cwhipkey): remove this when callers use annotations directly.\n+#include \"absl/base/macros.h\"\n #include \"xla/tsl/platform/dynamic_annotations.h\"\n #include \"xla/tsl/platform/types.h\"\n #include \"tsl/platform/platform.h\"\n@@ -29,12 +31,23 @@ namespace port {\n \n // Aligned allocation/deallocation. `minimum_alignment` must be a power of 2\n // and a multiple of sizeof(void*).\n-void* AlignedMalloc(size_t size, int minimum_alignment);\n+void* AlignedMalloc(size_t size, std::align_val_t minimum_alignment);\n+ABSL_DEPRECATE_AND_INLINE()\n+inline void* AlignedMalloc(size_t size, int minimum_alignment) {\n+  return AlignedMalloc(size, static_cast<std::align_val_t>(minimum_alignment));\n+}\n void AlignedFree(void* aligned_memory);\n-void AlignedSizedFree(void* aligned_memory, size_t alignment, size_t size);\n+void AlignedSizedFree(void* aligned_memory, size_t size,\n+                      std::align_val_t minimum_alignment);\n+ABSL_DEPRECATE_AND_INLINE()\n+inline void AlignedSizedFree(void* aligned_memory, size_t alignment,\n+                             size_t size) {\n+  AlignedSizedFree(aligned_memory, size,\n+                   static_cast<std::align_val_t>(alignment));\n+}\n \n // An allocator that allocates memory with the given minimum alignment.\n-template <class T, size_t minimum_alignment>\n+template <class T, std::align_val_t minimum_alignment>\n struct AlignedAllocator {\n   using value_type = T;\n \n@@ -44,7 +57,7 @@ struct AlignedAllocator {\n   }\n \n   void deallocate(value_type* p, size_t n) {\n-    return AlignedSizedFree(p, minimum_alignment, n);\n+    return AlignedSizedFree(p, n, minimum_alignment);\n   }\n };\n "
        },
        {
            "sha": "baecfc09471db4097d74c58ecd8c47467dd6ade3",
            "filename": "third_party/xla/xla/backends/cpu/nanort/nanort_executable.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fnanort_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fnanort_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fnanort_executable.h?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <cstdint>\n #include <cstdlib>\n #include <memory>\n+#include <new>\n #include <optional>\n #include <utility>\n #include <vector>\n@@ -174,7 +175,9 @@ class NanoRtExecutable {\n \n    private:\n     friend class NanoRtExecutable;\n-    using Allocator = tsl::port::AlignedAllocator<std::byte, Align()>;\n+    using Allocator =\n+        tsl::port::AlignedAllocator<std::byte,\n+                                    static_cast<std::align_val_t>(Align())>;\n     alignas(Align()) absl::FixedArray<std::byte, n, Allocator> data_;\n   };\n "
        },
        {
            "sha": "3c0b20666535bee555be65499883853ebb454926",
            "filename": "third_party/xla/xla/tsl/platform/default/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -359,6 +359,7 @@ cc_library(\n         \"//xla/tsl/platform:types\",\n         \"//xla/tsl/platform/profile_utils:profile_utils_cpu_utils\",\n         \"@com_google_absl//absl/base\",\n+        \"@com_google_absl//absl/base:core_headers\",\n         \"@local_tsl//tsl/platform\",\n         \"@snappy\",\n     ] + select({"
        },
        {
            "sha": "31a2b75b317aaa2fd6104569aa24e75381ef6e82",
            "filename": "third_party/xla/xla/tsl/platform/default/port.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fport.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fport.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fport.cc?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -13,6 +13,8 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include <new>\n+\n #include \"absl/base/internal/sysinfo.h\"\n #include \"xla/tsl/platform/logging.h\"\n #include \"xla/tsl/platform/profile_utils/cpu_utils.h\"\n@@ -249,28 +251,31 @@ double NominalCPUFrequency() {\n namespace tsl {\n namespace port {\n \n-void* AlignedMalloc(size_t size, int minimum_alignment) {\n+void* AlignedMalloc(size_t size, std::align_val_t minimum_alignment) {\n+  const size_t alignment = static_cast<size_t>(minimum_alignment);\n #if defined(__ANDROID__)\n-  return memalign(minimum_alignment, size);\n+  return memalign(alignment, size);\n #else  // !defined(__ANDROID__)\n-  void* ptr = nullptr;\n   // posix_memalign requires that the requested alignment be at least\n   // sizeof(void*). In this case, fall back on malloc which should return\n   // memory aligned to at least the size of a pointer.\n-  const int required_alignment = sizeof(void*);\n-  if (minimum_alignment < required_alignment) return Malloc(size);\n-  int err = posix_memalign(&ptr, minimum_alignment, size);\n+  constexpr int kRequiredAlignment = sizeof(void*);\n+  if (alignment < kRequiredAlignment) {\n+    return Malloc(size);\n+  }\n+  void* ptr = nullptr;\n+  int err = posix_memalign(&ptr, alignment, size);\n   if (err != 0) {\n     return nullptr;\n-  } else {\n-    return ptr;\n   }\n+  return ptr;\n #endif\n }\n \n void AlignedFree(void* aligned_memory) { Free(aligned_memory); }\n \n-void AlignedSizedFree(void* aligned_memory, size_t alignment, size_t size) {\n+void AlignedSizedFree(void* aligned_memory, size_t size,\n+                      std::align_val_t alignment) {\n   (void)alignment;\n   (void)size;\n "
        },
        {
            "sha": "6052e72acee91826c0fa51b5ccc56a0a17017855",
            "filename": "third_party/xla/xla/tsl/platform/windows/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2FBUILD?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -199,6 +199,7 @@ cc_library(\n         \"//xla/tsl/platform:dynamic_annotations\",\n         \"//xla/tsl/platform:logging\",\n         \"//xla/tsl/platform:types\",\n+        \"@com_google_absl//absl/base:core_headers\",\n         \"@local_tsl//tsl/platform\",\n         \"@snappy\",\n     ],"
        },
        {
            "sha": "7f2f84bd4799ecc00a24f056b1faddb2a02d45a3",
            "filename": "third_party/xla/xla/tsl/platform/windows/port.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2Fport.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53f42dc1c6a74cee571f4512fa9bccd7be853a9e/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2Fport.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2Fport.cc?ref=53f42dc1c6a74cee571f4512fa9bccd7be853a9e",
            "patch": "@@ -16,6 +16,8 @@ limitations under the License.\n #include <stdio.h>\n #include <stdlib.h>\n #include <string.h>\n+\n+#include <new>\n #ifdef TF_USE_SNAPPY\n #include \"snappy.h\"\n #endif\n@@ -186,13 +188,14 @@ int NumHyperthreadsPerCore() {\n namespace tsl {\n namespace port {\n \n-void* AlignedMalloc(size_t size, int minimum_alignment) {\n-  return _aligned_malloc(size, minimum_alignment);\n+void* AlignedMalloc(size_t size, std::align_val_t minimum_alignment) {\n+  return _aligned_malloc(size, static_cast<size_t>(minimum_alignment));\n }\n \n void AlignedFree(void* aligned_memory) { _aligned_free(aligned_memory); }\n \n-void AlignedSizedFree(void* aligned_memory, size_t alignment, size_t size) {\n+void AlignedSizedFree(void* aligned_memory, size_t size,\n+                      std::align_val_t alignment) {\n   (void)alignment;\n   (void)size;\n "
        }
    ],
    "stats": {
        "total": 61,
        "additions": 44,
        "deletions": 17
    }
}