{
    "author": "bixia1",
    "message": "[xla] Fix gather expander and scatter expander to handle s64 indices.\n\nThis fixes https://github.com/jax-ml/jax/issues/30197\n\nPiperOrigin-RevId: 802706095",
    "sha": "cd0df31a2041d46bda6b2b395d42aabe81a2876b",
    "files": [
        {
            "sha": "3f1a2edd8b71917184c1eb0dac842a5b2ca95cd2",
            "filename": "third_party/xla/xla/service/gather_expander_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 19,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cd0df31a2041d46bda6b2b395d42aabe81a2876b/third_party%2Fxla%2Fxla%2Fservice%2Fgather_expander_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cd0df31a2041d46bda6b2b395d42aabe81a2876b/third_party%2Fxla%2Fxla%2Fservice%2Fgather_expander_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgather_expander_test.cc?ref=cd0df31a2041d46bda6b2b395d42aabe81a2876b",
            "patch": "@@ -282,7 +282,7 @@ HloModule GatherWithBatchDims\n \n ENTRY main {\n   operand = s32[5,2] parameter(0)\n-  indices = s32[5,1] parameter(1)\n+  indices = s64[5,1] parameter(1)\n   ROOT gather = s32[5,1] gather(operand, indices),\n       offset_dims={1},\n       collapsed_slice_dims={},\n@@ -294,33 +294,33 @@ ENTRY main {\n }\n )\";\n   const std::string expected = R\"(\n-  //CHECK: (s32[], s32[5,2], s32[5,1], s32[5,1])) -> (s32[], s32[5,2], s32[5,1], s32[5,1]) {\n-  //CHECK: %[[PARAM:.*]] = (s32[], s32[5,2], s32[5,1], s32[5,1]) parameter(0)\n-  //CHECK: %[[I:.*]] = s32[] get-tuple-element(%[[PARAM]]), index=\n+  //CHECK: (s32[], s32[5,2], s64[5,1], s32[5,1])) -> (s32[], s32[5,2], s64[5,1], s32[5,1]) {\n+  //CHECK: %[[PARAM:.*]] = (s32[], s32[5,2], s64[5,1], s32[5,1]) parameter(0)\n+  //CHECK: %[[I_0:.*]] = s32[] get-tuple-element(%[[PARAM]]), index=0\n   //CHECK: %[[CONSTANT1:.*]] = s32[] constant(1)\n-  //CHECK: %[[I_PLUS_1:.*]] = s32[] add(%[[I]], %[[CONSTANT1]])\n+  //CHECK: %[[I_PLUS_1:.*]] = s32[] add(%[[I_0]], %[[CONSTANT1]])\n   //CHECK: %[[OPERAND:.*]] = s32[5,2] get-tuple-element(%[[PARAM]]), index=1\n-  //CHECK: %[[START_INDICES:.*]] = s32[5,1] get-tuple-element(%[[PARAM]]), index=2\n+  //CHECK: %[[START_INDICES:.*]] = s64[5,1] get-tuple-element(%[[PARAM]]), index=2\n   //CHECK: %[[RESULT:.*]] = s32[5,1] get-tuple-element(%[[PARAM]]), index=3\n-\n-  //CHECK: %[[I_1D_1:.*]] = s32[1] broadcast(%[[I]])\n-  //CHECK: %[[I_1D_2:.*]] = s32[1] broadcast(%[[I]])\n+  //CHECK: %[[CONVERT:.*]] = s64[] convert(%[[I_0]])\n+  //CHECK: %[[I_1D_1:.*]] = s64[1] broadcast(%[[CONVERT]])\n+  //CHECK: %[[I_1D_2:.*]] = s32[1] broadcast(%[[I_0]])\n \n   //CHECK: %[[START_INDICES_INDEX_D1_PAD:.*]] = s32[] constant(0)\n   //CHECK: %[[START_INDICES_INDEX_VECTOR:.*]] = s32[2] pad(%[[I_1D_2]], %[[START_INDICES_INDEX_D1_PAD]]), padding=0_1\n   //CHECK: %[[START_INDICES_INDEX_D0_SLICE:.*]] = s32[1] slice(%[[START_INDICES_INDEX_VECTOR]]), slice={[0:1]}\n   //CHECK: %[[START_INDICES_INDEX_D0:.*]] = s32[] reshape(%[[START_INDICES_INDEX_D0_SLICE]])\n   //CHECK: %[[START_INDICES_INDEX_D1_SLICE:.*]] = s32[1] slice(%[[START_INDICES_INDEX_VECTOR]]), slice={[1:2]}\n   //CHECK: %[[START_INDICES_INDEX_D1:.*]] = s32[] reshape(%[[START_INDICES_INDEX_D1_SLICE]])\n-  //CHECK: %[[INDEX_VECTOR:.*]] = s32[1,1] dynamic-slice(%[[START_INDICES]], %[[START_INDICES_INDEX_D0]], %[[START_INDICES_INDEX_D1]])\n-\n-  //CHECK: %[[OFFSET_RAW:.*]] = s32[1] reshape(%[[INDEX_VECTOR]])\n-  //CHECK: %[[OFFSET:.*]] = s32[1] slice(%[[OFFSET_RAW]])\n-  //CHECK: %[[OPERAND_INDEX:.*]] = s32[2] concatenate(%[[I_1D_1]], %[[OFFSET]])\n-  //CHECK: %[[OPERAND_INDEX_D0_RAW:.*]] = s32[1] slice(%[[OPERAND_INDEX]]), slice={[0:1]}\n-  //CHECK: %[[OPERAND_INDEX_D0:.*]] = s32[] reshape(%[[OPERAND_INDEX_D0_RAW]])\n-  //CHECK: %[[OPERAND_INDEX_D1_RAW:.*]] = s32[1] slice(%[[OPERAND_INDEX]]), slice={[1:2]}\n-  //CHECK: %[[OPERAND_INDEX_D1:.*]] = s32[] reshape(%[[OPERAND_INDEX_D1_RAW]])\n+  //CHECK: %[[INDEX_VECTOR:.*]] = s64[1,1] dynamic-slice(%[[START_INDICES]], %[[START_INDICES_INDEX_D0]], %[[START_INDICES_INDEX_D1]])\n+\n+  //CHECK: %[[OFFSET_RAW:.*]] = s64[1] reshape(%[[INDEX_VECTOR]])\n+  //CHECK: %[[OFFSET:.*]] = s64[1] slice(%[[OFFSET_RAW]])\n+  //CHECK: %[[OPERAND_INDEX:.*]] = s64[2] concatenate(%[[I_1D_1]], %[[OFFSET]])\n+  //CHECK: %[[OPERAND_INDEX_D0_RAW:.*]] = s64[1] slice(%[[OPERAND_INDEX]]), slice={[0:1]}\n+  //CHECK: %[[OPERAND_INDEX_D0:.*]] = s64[] reshape(%[[OPERAND_INDEX_D0_RAW]])\n+  //CHECK: %[[OPERAND_INDEX_D1_RAW:.*]] = s64[1] slice(%[[OPERAND_INDEX]]), slice={[1:2]}\n+  //CHECK: %[[OPERAND_INDEX_D1:.*]] = s64[] reshape(%[[OPERAND_INDEX_D1_RAW]])\n   //CHECK: %[[RESULT_SLICE_RAW0:.*]] = s32[1,1] dynamic-slice(%[[OPERAND]], %[[OPERAND_INDEX_D0]], %[[OPERAND_INDEX_D1]])\n \n   //CHECK: %[[RESULT_SLICE_RAW1:.*]] = s32[1] reshape(%[[RESULT_SLICE_RAW0]])\n@@ -333,7 +333,7 @@ ENTRY main {\n   //CHECK: %[[RESULT_INDEX_D1:.*]] = s32[] reshape(%[[RESULT_INDEX_D1_SLICE]])\n   //CHECK: %[[UPDATED_RESULT:.*]] = s32[5,1] dynamic-update-slice(%[[RESULT]], %[[RESULT_SLICE]], %[[RESULT_INDEX_D0]], %[[RESULT_INDEX_D1]])\n \n-  //CHECK: ROOT %{{.*}} = (s32[], s32[5,2], s32[5,1], s32[5,1]) tuple(%[[I_PLUS_1]], %[[OPERAND]], %[[START_INDICES]], %[[UPDATED_RESULT]])\n+  //CHECK: ROOT %{{.*}} = (s32[], s32[5,2], s64[5,1], s32[5,1]) tuple(%[[I_PLUS_1]], %[[OPERAND]], %[[START_INDICES]], %[[UPDATED_RESULT]])\n )\";\n \n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,"
        },
        {
            "sha": "024483703b5b3157b9007673ae7e9adcf84db2ab",
            "filename": "third_party/xla/xla/service/gather_scatter_utils.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cd0df31a2041d46bda6b2b395d42aabe81a2876b/third_party%2Fxla%2Fxla%2Fservice%2Fgather_scatter_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cd0df31a2041d46bda6b2b395d42aabe81a2876b/third_party%2Fxla%2Fxla%2Fservice%2Fgather_scatter_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgather_scatter_utils.cc?ref=cd0df31a2041d46bda6b2b395d42aabe81a2876b",
            "patch": "@@ -75,9 +75,9 @@ std::vector<HloInstruction*> GenerateExplicitBatchDimIndices(\n       break;\n     }\n \n-    HloInstruction* divisor =\n-        computation->AddInstruction(HloInstruction::CreateConstant(\n-            LiteralUtil::CreateR0<int32_t>(start_indices_shape.dimensions(i))));\n+    HloInstruction* divisor = computation->AddInstruction(\n+        HloInstruction::CreateConstant(LiteralUtil::CreateR0(\n+            shape.element_type(), start_indices_shape.dimensions(i))));\n     if (it != start_indices_batching_dims.end()) {\n       explicit_batch_dim_indices[it - start_indices_batching_dims.begin()] =\n           computation->AddInstruction(HloInstruction::CreateBinary(\n@@ -195,6 +195,13 @@ absl::StatusOr<HloInstruction*> ExpandIndexVectorIntoOperandSpace(\n       computation->AddInstruction(HloInstruction::CreateConstant(\n           LiteralUtil::CreateFromDimensions(index_shape.element_type(), {1})));\n \n+  if (induction_var->shape().element_type() != index_shape.element_type()) {\n+    induction_var =\n+        induction_var->parent()->AddInstruction(HloInstruction::CreateConvert(\n+            ShapeUtil::ChangeElementType(induction_var->shape(),\n+                                         index_shape.element_type()),\n+            induction_var));\n+  }\n   // We extract out individual components from the smaller index and concatenate\n   // them (interspersing zeros as needed) into the larger index.\n   std::vector<HloInstruction*> expanded_index_components;"
        },
        {
            "sha": "cadfeb695760db9ada753b366c0b519728b81ead",
            "filename": "third_party/xla/xla/service/scatter_expander_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 26,
            "changes": 53,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cd0df31a2041d46bda6b2b395d42aabe81a2876b/third_party%2Fxla%2Fxla%2Fservice%2Fscatter_expander_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cd0df31a2041d46bda6b2b395d42aabe81a2876b/third_party%2Fxla%2Fxla%2Fservice%2Fscatter_expander_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fscatter_expander_test.cc?ref=cd0df31a2041d46bda6b2b395d42aabe81a2876b",
            "patch": "@@ -152,7 +152,7 @@ HloModule TensorFlowScatter\n   }\n \n   ENTRY main {\n-  indices = s32[2,3,5]{2,1,0} parameter(0)\n+  indices = s64[2,3,5]{2,1,0} parameter(0)\n   update = s32[2,3,2,5]{3,2,1,0} parameter(1)\n   z = s32[] constant(0)\n   input = s32[5,3,2,2]{3,2,1,0} broadcast(z), dimensions={}\n@@ -168,39 +168,40 @@ HloModule TensorFlowScatter\n \n   // Verify the code that indexes into the operand.\n   const std::string expected = R\"(\n-  //CHECK: (s32[], s32[5,3,2,2], s32[30], s32[30,2])) -> (s32[], s32[5,3,2,2], s32[30], s32[30,2]) {\n-  //CHECK: %[[PARAM:.*]] = (s32[], s32[5,3,2,2], s32[30], s32[30,2]) parameter(0)\n+  //CHECK: (s32[], s32[5,3,2,2], s64[30], s32[30,2])) -> (s32[], s32[5,3,2,2], s64[30], s32[30,2]) {\n+  //CHECK: %[[PARAM:.*]] = (s32[], s32[5,3,2,2], s64[30], s32[30,2]) parameter(0)\n   //CHECK: %[[I:.*]] = s32[] get-tuple-element(%[[PARAM]]), index=0\n   //CHECK: %[[CONSTANT1:.*]] = s32[] constant(1)\n   //CHECK: %[[I_PLUS_1:.*]] = s32[] add(%[[I]], %[[CONSTANT1]])\n   //CHECK: %[[OPERAND:.*]] = s32[5,3,2,2] get-tuple-element(%[[PARAM]]), index=1\n \n-  //CHECK: %[[CONSTANT0:.*]] = s32[] constant(0)\n-  //CHECK: %[[OPERAND_INDICES_LOWER_BOUND:.*]] = s32[4] broadcast(%[[CONSTANT0]])\n-  //CHECK: %[[CONSTANT5:.*]] = s32[] constant(5)\n-  //CHECK: %[[REMAINDER:.*]] = s32[] remainder(%[[I]], %[[CONSTANT5]])\n-  //CHECK: %[[BD2:.*]] = s32[1] broadcast(%[[REMAINDER]])\n-  //CHECK: %[[START_INDICES:.*]] = s32[30] get-tuple-element(%[[PARAM]]), index=2\n+  //CHECK: %[[CONSTANT0:.*]] = s64[] constant(0)\n+  //CHECK: %[[OPERAND_INDICES_LOWER_BOUND:.*]] = s64[4] broadcast(%[[CONSTANT0]])\n+  //CHECK: %[[CONVERT:.*]] = s64[] convert(%[[I]])\n+  //CHECK: %[[CONSTANT5:.*]] = s64[] constant(5)\n+  //CHECK: %[[REMAINDER:.*]] = s64[] remainder(%[[CONVERT]], %[[CONSTANT5]])\n+  //CHECK: %[[BD2:.*]] = s64[1] broadcast(%[[REMAINDER]])\n+  //CHECK: %[[START_INDICES:.*]] = s64[30] get-tuple-element(%[[PARAM]]), index=2\n   //CHECK: %[[I_1D_1:.*]] = s32[1] broadcast(%[[I]])\n   //CHECK: %[[START_INDICES_INDEX_RAW:.*]] = s32[1] slice(%[[I_1D_1]])\n   //CHECK: %[[START_INDICES_INDEX:.*]] = s32[] reshape(%[[START_INDICES_INDEX_RAW]])\n-  //CHECK: %[[INDEX_VECTOR:.*]] = s32[1] dynamic-slice(%[[START_INDICES]], %[[START_INDICES_INDEX]])\n-\n-  //CHECK: %[[SCATTER_INDEX:.*]] = s32[1] slice(%[[INDEX_VECTOR]])\n-  //CHECK: %[[CONSTANT0_2:.*]] = s32[1] constant({0})\n-  //CHECK: %[[BD_0_1:.*]] = s32[] divide(%[[I]], %[[CONSTANT5]])\n-  //CHECK: %[[CONSTANT3:.*]] = s32[] constant(3)\n-  //CHECK: %[[BD0_RAW:.*]] = s32[] divide(%[[BD_0_1]], %[[CONSTANT3]])\n-  //CHECK: %[[BD0:.*]] = s32[1] broadcast(%[[BD0_RAW]])\n-  //CHECK: %[[OPERAND_INDICES:.*]] = s32[4] concatenate(%[[BD2]], %[[SCATTER_INDEX]], %[[CONSTANT0_2]], %[[BD0]])\n-  //CHECK: %[[OPERAND_INDEX_D0_RAW:.*]] = s32[1] slice(%[[OPERAND_INDICES]]), slice={[0:1]}\n-  //CHECK: %[[OPERAND_INDEX_D0:.*]] = s32[] reshape(%[[OPERAND_INDEX_D0_RAW]])\n-  //CHECK: %[[OPERAND_INDEX_D1_RAW:.*]] = s32[1] slice(%[[OPERAND_INDICES]]), slice={[1:2]}\n-  //CHECK: %[[OPERAND_INDEX_D1:.*]] = s32[] reshape(%[[OPERAND_INDEX_D1_RAW]])\n-  //CHECK: %[[OPERAND_INDEX_D2_RAW:.*]] = s32[1] slice(%[[OPERAND_INDICES]]), slice={[2:3]}\n-  //CHECK: %[[OPERAND_INDEX_D2:.*]] = s32[] reshape(%[[OPERAND_INDEX_D2_RAW]])\n-  //CHECK: %[[OPERAND_INDEX_D3_RAW:.*]] = s32[1] slice(%[[OPERAND_INDICES]]), slice={[3:4]}\n-  //CHECK: %[[OPERAND_INDEX_D3:.*]] = s32[] reshape(%[[OPERAND_INDEX_D3_RAW]])\n+  //CHECK: %[[INDEX_VECTOR:.*]] = s64[1] dynamic-slice(%[[START_INDICES]], %[[START_INDICES_INDEX]])\n+\n+  //CHECK: %[[SCATTER_INDEX:.*]] = s64[1] slice(%[[INDEX_VECTOR]])\n+  //CHECK: %[[CONSTANT0_2:.*]] = s64[1] constant({0})\n+  //CHECK: %[[BD_0_1:.*]] = s64[] divide(%[[CONVERT]], %[[CONSTANT5]])\n+  //CHECK: %[[CONSTANT3:.*]] = s64[] constant(3)\n+  //CHECK: %[[BD0_RAW:.*]] = s64[] divide(%[[BD_0_1]], %[[CONSTANT3]])\n+  //CHECK: %[[BD0:.*]] = s64[1] broadcast(%[[BD0_RAW]])\n+  //CHECK: %[[OPERAND_INDICES:.*]] = s64[4] concatenate(%[[BD2]], %[[SCATTER_INDEX]], %[[CONSTANT0_2]], %[[BD0]])\n+  //CHECK: %[[OPERAND_INDEX_D0_RAW:.*]] = s64[1] slice(%[[OPERAND_INDICES]]), slice={[0:1]}\n+  //CHECK: %[[OPERAND_INDEX_D0:.*]] = s64[] reshape(%[[OPERAND_INDEX_D0_RAW]])\n+  //CHECK: %[[OPERAND_INDEX_D1_RAW:.*]] = s64[1] slice(%[[OPERAND_INDICES]]), slice={[1:2]}\n+  //CHECK: %[[OPERAND_INDEX_D1:.*]] = s64[] reshape(%[[OPERAND_INDEX_D1_RAW]])\n+  //CHECK: %[[OPERAND_INDEX_D2_RAW:.*]] = s64[1] slice(%[[OPERAND_INDICES]]), slice={[2:3]}\n+  //CHECK: %[[OPERAND_INDEX_D2:.*]] = s64[] reshape(%[[OPERAND_INDEX_D2_RAW]])\n+  //CHECK: %[[OPERAND_INDEX_D3_RAW:.*]] = s64[1] slice(%[[OPERAND_INDICES]]), slice={[3:4]}\n+  //CHECK: %[[OPERAND_INDEX_D3:.*]] = s64[] reshape(%[[OPERAND_INDEX_D3_RAW]])\n   //CHECK: %{{.*}} = s32[1,1,2,1] dynamic-slice(%[[OPERAND]], %[[OPERAND_INDEX_D0]], %[[OPERAND_INDEX_D1]], %[[OPERAND_INDEX_D2]], %[[OPERAND_INDEX_D3]])\n )\";\n "
        }
    ],
    "stats": {
        "total": 104,
        "additions": 56,
        "deletions": 48
    }
}