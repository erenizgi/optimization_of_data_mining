{
    "author": "deeptanshusekhri",
    "message": "[tosa] : fixing dynamic batch handling in FullyConnected legalization (#106638)",
    "sha": "d0b7f40548c9fa54b9eea1d71e24c49b67933984",
    "files": [
        {
            "sha": "78e616d8967bb62d229eb819ee63002bec582b0f",
            "filename": "tensorflow/compiler/mlir/tosa/tests/tfl-to-tosa-pipeline.mlir",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0b7f40548c9fa54b9eea1d71e24c49b67933984/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftests%2Ftfl-to-tosa-pipeline.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0b7f40548c9fa54b9eea1d71e24c49b67933984/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftests%2Ftfl-to-tosa-pipeline.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftests%2Ftfl-to-tosa-pipeline.mlir?ref=d0b7f40548c9fa54b9eea1d71e24c49b67933984",
            "patch": "@@ -3282,6 +3282,21 @@ func.func @test_fullyconnected_dynamic_output(%arg0: tensor<1x2048xf32>, %arg1:\n \n // -----\n \n+// CHECK-LABEL: @test_fullyconnected_dynamic_batch\n+func.func @test_fullyconnected_dynamic_batch(%arg0: tensor<?x512xf32>, %arg1: tensor<256x512xf32>, %arg2: tensor<256xf32>) -> tensor<?x256xf32> {\n+  // CHECK-DAG: %[[OUT_SHAPE:.*]] = tosa.const_shape  {values = dense<[-1, 256]> : tensor<2xindex>} : () -> !tosa.shape<2>\n+  // CHECK-DAG: %[[FILTER_SHAPE:.*]] = tosa.const_shape  {values = dense<[256, 1, 1, 512]> : tensor<4xindex>} : () -> !tosa.shape<4>\n+  // CHECK-DAG: %[[IN_SHAPE:.*]] = tosa.const_shape  {values = dense<[-1, 1, 1, 512]> : tensor<4xindex>} : () -> !tosa.shape<4>\n+  // CHECK: %[[RESHAPE_IN:.*]] = tosa.reshape %arg0, %[[IN_SHAPE]]\n+  // CHECK: %[[RESHAPE_FILTER:.*]] = tosa.reshape %arg1, %[[FILTER_SHAPE]]\n+  // CHECK: %[[CONV:.*]] = tosa.conv2d %[[RESHAPE_IN]], %[[RESHAPE_FILTER]], %arg2, {{.*}}, {{.*}}\n+  // CHECK: tosa.reshape %[[CONV]], %[[OUT_SHAPE]]\n+  %0 = \"tfl.fully_connected\"(%arg0, %arg1, %arg2) {fused_activation_function = \"NONE\", keep_num_dims = false, weights_format = \"DEFAULT\"} : (tensor<?x512xf32>, tensor<256x512xf32>, tensor<256xf32>) -> tensor<?x256xf32>\n+  func.return %0 : tensor<?x256xf32>\n+}\n+\n+// -----\n+\n // CHECK-LABEL: @test_fullyconnected_keep_dims\n func.func @test_fullyconnected_keep_dims(%arg0: tensor<1x64x64x768x!quant.uniform<i8:f32, 0.13852123916149139:5>>, %arg1: tensor<3072x768x!quant.uniform<i8<-127:127>:f32, 0.003333511995151639>>, %arg2: tensor<3072x!quant.uniform<i32:f32, 4.6176221803762019E-4>>) -> tensor<1x64x64x3072x!quant.uniform<i8:f32, 0.1022367924451828:45>> {\n     // CHECK-DAG: %[[CONST_SHAPE0:.*]] = tosa.const_shape  {values = dense<[1, 64, 64, 3072]> : tensor<4xindex>}"
        },
        {
            "sha": "b5e19e35e9d40a9055ee5ca7527b9fdf00c354d9",
            "filename": "tensorflow/compiler/mlir/tosa/transforms/legalize_tfl.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0b7f40548c9fa54b9eea1d71e24c49b67933984/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tfl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0b7f40548c9fa54b9eea1d71e24c49b67933984/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tfl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftosa%2Ftransforms%2Flegalize_tfl.cc?ref=d0b7f40548c9fa54b9eea1d71e24c49b67933984",
            "patch": "@@ -2336,7 +2336,10 @@ LogicalResult ConvertTFLFullyConnectedOp::matchAndRewrite(\n   // shape[1].\n   if (input_type.getRank() != 2) {\n     int64_t num_elems = filter_type.getShape()[1];\n-    int64_t num_batch = input_type.getNumElements() / num_elems;\n+    int64_t num_batch = ShapedType::kDynamic;\n+    if (input_type.hasStaticShape()) {\n+      num_batch = input_type.getNumElements() / num_elems;\n+    }\n     SmallVector<int64_t, 2> shape_vals({num_batch, num_elems});\n \n     RankedTensorType reshape_type ="
        }
    ],
    "stats": {
        "total": 20,
        "additions": 19,
        "deletions": 1
    }
}