{
    "author": "tensorflower-gardener",
    "message": "[Autotuner] Get least duration config within configs using the same scratch bytes.\n\nPiperOrigin-RevId: 816165669",
    "sha": "73fce0fb92925b2a385bff7714b5b2b3f81d33df",
    "files": [
        {
            "sha": "f9dd675cff2318f0f4d290c643c514f2796c3bd3",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/73fce0fb92925b2a385bff7714b5b2b3f81d33df/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/73fce0fb92925b2a385bff7714b5b2b3f81d33df/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc?ref=73fce0fb92925b2a385bff7714b5b2b3f81d33df",
            "patch": "@@ -355,11 +355,18 @@ absl::StatusOr<Autotuner::ConfigResult> Autotuner::PickBestConfig(\n     absl::Duration duration_limit =\n         min_duration +\n         absl::Microseconds(autotune_config_.scratch_bytes_window_size_us);\n+    absl::Duration min_duration_with_optimzed_scratch_bytes =\n+        absl::InfiniteDuration();\n     for (ConfigResult& result : results) {\n-      if (!result.failure.has_value() && result.duration <= duration_limit &&\n-          result.scratch_bytes < min_scratch_bytes) {\n-        best_result = &result;\n-        min_scratch_bytes = result.scratch_bytes;\n+      if (!result.failure.has_value() && result.duration <= duration_limit) {\n+        if (result.scratch_bytes < min_scratch_bytes) {\n+          min_scratch_bytes = result.scratch_bytes;\n+          min_duration_with_optimzed_scratch_bytes = result.duration;\n+          best_result = &result;\n+        } else if (result.scratch_bytes == min_scratch_bytes &&\n+                   result.duration < min_duration_with_optimzed_scratch_bytes) {\n+          best_result = &result;\n+        }\n       }\n     }\n   }"
        },
        {
            "sha": "96ecf98c3631c73dd41ce938e7ae8134dbc9266e",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/73fce0fb92925b2a385bff7714b5b2b3f81d33df/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/73fce0fb92925b2a385bff7714b5b2b3f81d33df/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc?ref=73fce0fb92925b2a385bff7714b5b2b3f81d33df",
            "patch": "@@ -469,16 +469,18 @@ TEST_F(AutotunerTest, AutotuneWithBufferCheck) {\n TEST_F(AutotunerTest, AutotuneWithScratchBytesOptimization) {\n   std::vector<std::unique_ptr<BackendConfig>> configs;\n   configs.push_back(GetTestConfig(\"config_more_time_less_scratch\"));\n-  configs.push_back(GetTestConfig(\"config_less_time_more_scratch\"));\n+  configs.push_back(GetTestConfig(\"config_less_time_less_scratch\"));\n+  configs.push_back(GetTestConfig(\"config_least_time_most_scratch\"));\n   auto backend_1 = std::make_unique<MockCodegenBackend>();\n   EXPECT_CALL(*backend_1, GetSupportedConfigs)\n       .WillOnce(Return(std::move(configs)));\n   EXPECT_CALL(*backend_1, Compile(_, _))\n+      .WillOnce(Return(std::unique_ptr<Executable>()))\n       .WillOnce(Return(std::unique_ptr<Executable>()))\n       .WillOnce(Return(std::unique_ptr<Executable>()));\n \n   EXPECT_CALL(*backend_1,\n-              ApplyConfig(_, ConfigMatcher(\"config_more_time_less_scratch\")))\n+              ApplyConfig(_, ConfigMatcher(\"config_less_time_less_scratch\")))\n       .Times(1)\n       .WillRepeatedly(Return(absl::OkStatus()));\n \n@@ -487,12 +489,17 @@ TEST_F(AutotunerTest, AutotuneWithScratchBytesOptimization) {\n       .WillOnce(Return(std::make_unique<InputBuffers>()));\n   EXPECT_CALL(*profiler, Profile(_, _))\n       .WillOnce(Return(ProfileResult({\n-          /*duration=*/absl::Microseconds(2),\n+          /*duration=*/absl::Microseconds(5),\n           /*output_buffer=*/std::nullopt,\n           /*scratch_bytes=*/100,\n       })))\n       .WillOnce(Return(ProfileResult({\n-          /*duration=*/absl::Microseconds(1),\n+          /*duration=*/absl::Microseconds(3),\n+          /*output_buffer=*/std::nullopt,\n+          /*scratch_bytes=*/100,\n+      })))\n+      .WillOnce(Return(ProfileResult({\n+          /*duration=*/absl::Microseconds(2),\n           /*output_buffer=*/std::nullopt,\n           /*scratch_bytes=*/200,\n       })));"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 22,
        "deletions": 8
    }
}