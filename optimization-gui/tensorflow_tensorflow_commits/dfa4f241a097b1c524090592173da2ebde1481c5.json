{
    "author": "shawnwang18",
    "message": "PR #35237: [XLA:GPU] Add synchronize API for cuda event\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35237\n\nüìù Summary of Changes\nThis PR adds support for synchronizing CUDA events from the host and includes a corresponding unit test.\n\nüéØ Justification\nWe may have XLA optimization that might needs this support, e.g. from command buffer update-free cuda-graph.\n\nüöÄ Kind of Contribution\n‚ú® New Feature\n\nüß™ Unit Tests:\nxla/stream_executor/cuda/cuda_event_test.cc\n\nCopybara import of the project:\n\n--\n53b38a2526453bf19300f2a1e7786e8949f5dc26 by Shawn Wang <shawnw@nvidia.com>:\n\nAdd synchronize API for cuda event\n\n--\n041fb9a19969390d665f2aab35a142fa4d1731bf by Shawn Wang <shawnw@nvidia.com>:\n\nadd missing header\n\nMerging this change closes #35237\n\nPiperOrigin-RevId: 845118206",
    "sha": "dfa4f241a097b1c524090592173da2ebde1481c5",
    "files": [
        {
            "sha": "a74214ce0f1f73bab485ca3b10e306f08d9687ba",
            "filename": "third_party/xla/xla/stream_executor/cuda/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD?ref=dfa4f241a097b1c524090592173da2ebde1481c5",
            "patch": "@@ -783,10 +783,13 @@ xla_test(\n         \":cuda_event\",\n         \":cuda_executor\",\n         \":cuda_platform_id\",\n+        \":cuda_stream\",\n         \"//xla/stream_executor:event\",\n         \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:platform_manager\",\n         \"//xla/stream_executor:stream_executor_h\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:statusor\","
        },
        {
            "sha": "f232232db3f05339a49a92d9808fe94bc1c05edf",
            "filename": "third_party/xla/xla/stream_executor/cuda/cuda_event.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event.cc?ref=dfa4f241a097b1c524090592173da2ebde1481c5",
            "patch": "@@ -88,6 +88,11 @@ absl::Status CudaEvent::WaitForEventOnExternalStream(std::intptr_t stream) {\n                            handle_);\n }\n \n+absl::Status CudaEvent::Synchronize() {\n+  std::unique_ptr<ActivateContext> activation = executor_->Activate();\n+  return cuda::ToStatus(cuEventSynchronize(handle_));\n+}\n+\n absl::StatusOr<CudaEvent> CudaEvent::Create(StreamExecutor *executor,\n                                             bool allow_timing) {\n   TF_ASSIGN_OR_RETURN("
        },
        {
            "sha": "c338da7795fa8babeaa3ee427ee8b5762bc2c799",
            "filename": "third_party/xla/xla/stream_executor/cuda/cuda_event.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event.h?ref=dfa4f241a097b1c524090592173da2ebde1481c5",
            "patch": "@@ -33,6 +33,7 @@ class CudaEvent : public Event {\n  public:\n   Event::Status PollForStatus() override;\n   absl::Status WaitForEventOnExternalStream(std::intptr_t stream) override;\n+  absl::Status Synchronize() override;\n \n   // Creates a new CudaEvent. If allow_timing is false, the event will not\n   // support timing, which is cheaper to create."
        },
        {
            "sha": "d9b230f7f198d9ba6623a2fa0a9a4d7bcd538903",
            "filename": "third_party/xla/xla/stream_executor/cuda/cuda_event_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fcuda_event_test.cc?ref=dfa4f241a097b1c524090592173da2ebde1481c5",
            "patch": "@@ -15,16 +15,20 @@ limitations under the License.\n \n #include \"xla/stream_executor/cuda/cuda_event.h\"\n \n+#include <memory>\n #include <utility>\n \n #include <gtest/gtest.h>\n+#include \"absl/status/status_matchers.h\"\n #include \"third_party/gpus/cuda/include/cuda.h\"\n #include \"xla/stream_executor/cuda/cuda_executor.h\"\n #include \"xla/stream_executor/cuda/cuda_platform_id.h\"\n+#include \"xla/stream_executor/cuda/cuda_stream.h\"\n #include \"xla/stream_executor/event.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/platform_manager.h\"\n #include \"xla/stream_executor/stream_executor.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"tsl/platform/statusor.h\"\n #include \"tsl/platform/test.h\"\n \n@@ -50,6 +54,31 @@ TEST(CudaEventTest, CreateEvent) {\n   EXPECT_EQ(event2.GetHandle(), handle);\n }\n \n+TEST(CudaEventTest, Synchronize) {\n+  TF_ASSERT_OK_AND_ASSIGN(Platform * platform,\n+                          stream_executor::PlatformManager::PlatformWithId(\n+                              stream_executor::cuda::kCudaPlatformId));\n+  TF_ASSERT_OK_AND_ASSIGN(StreamExecutor * executor,\n+                          platform->ExecutorForDevice(0));\n+  CudaExecutor* cuda_executor = reinterpret_cast<CudaExecutor*>(executor);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(CudaEvent event,\n+                          CudaEvent::Create(cuda_executor, false));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<CudaStream> stream,\n+                          CudaStream::Create(cuda_executor,\n+                                             /*priority=*/std::nullopt));\n+\n+  // Record the event on the stream.\n+  TF_ASSERT_OK(stream->RecordEvent(&event));\n+\n+  // Synchronize on the event (blocks until the event is recorded).\n+  EXPECT_THAT(event.Synchronize(), absl_testing::IsOk());\n+\n+  // After synchronization, the event should be complete.\n+  EXPECT_EQ(event.PollForStatus(), Event::Status::kComplete);\n+}\n+\n }  // namespace\n \n }  // namespace stream_executor::gpu"
        },
        {
            "sha": "f63e9736e30e9d95130bc7dfa0a84d4e503686c8",
            "filename": "third_party/xla/xla/stream_executor/event.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fevent.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dfa4f241a097b1c524090592173da2ebde1481c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Fevent.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fevent.h?ref=dfa4f241a097b1c524090592173da2ebde1481c5",
            "patch": "@@ -50,6 +50,13 @@ class Event {\n   virtual absl::Status WaitForEventOnExternalStream(std::intptr_t stream) {\n     return absl::UnimplementedError(\"Not supported for this Event.\");\n   }\n+\n+  // Blocks the calling host thread until the event has been recorded.\n+  // Wraps the underlying platform-specific synchronization (e.g.\n+  // cuEventSynchronize for CUDA).\n+  virtual absl::Status Synchronize() {\n+    return absl::UnimplementedError(\"Not supported for this Event.\");\n+  }\n };\n \n }  // namespace stream_executor"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 45,
        "deletions": 0
    }
}