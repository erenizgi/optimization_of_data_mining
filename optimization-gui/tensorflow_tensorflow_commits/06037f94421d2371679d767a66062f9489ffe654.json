{
    "author": "dimitar-asenov",
    "message": "[XLA:GPU] Fix timing out test.\n\nPiperOrigin-RevId: 833784794",
    "sha": "06037f94421d2371679d767a66062f9489ffe654",
    "files": [
        {
            "sha": "e7501f625108aee1a607e80fcd8638c20df1ba04",
            "filename": "third_party/xla/xla/service/gpu/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/06037f94421d2371679d767a66062f9489ffe654/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/06037f94421d2371679d767a66062f9489ffe654/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD?ref=06037f94421d2371679d767a66062f9489ffe654",
            "patch": "@@ -610,7 +610,7 @@ xla_test(\n         \"//xla:types\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n-        \"//xla/stream_executor/cuda:cuda_compute_capability\",\n+        \"//xla/service/gpu/transforms:sort_rewriter\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/strings\","
        },
        {
            "sha": "cede784db9245214c7ea889eee2b258d7c3bb8aa",
            "filename": "third_party/xla/xla/service/gpu/tests/sorting_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/06037f94421d2371679d767a66062f9489ffe654/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fsorting_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/06037f94421d2371679d767a66062f9489ffe654/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fsorting_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fsorting_test.cc?ref=06037f94421d2371679d767a66062f9489ffe654",
            "patch": "@@ -37,6 +37,7 @@ limitations under the License.\n #include \"xla/literal_util.h\"\n #include \"xla/primitive_util.h\"\n #include \"xla/service/gpu/tests/gpu_codegen_test.h\"\n+#include \"xla/service/gpu/transforms/sort_rewriter.h\"\n #include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -59,17 +60,21 @@ ROOT lt = pred[] compare(p.0.lhs, p.0.rhs), direction=LT\n }\n \n ENTRY test {\n-p0 = $0[132000]{0} parameter(0)\n-ROOT sort = $0[132000]{0} sort(p0), dimensions={0}, is_stable=false,\n+p0 = $0[32]{0} parameter(0)\n+ROOT sort = $0[32]{0} sort(p0), dimensions={0}, is_stable=false,\n to_apply=compare\n })\";\n+  // It's OK to set kAlways, because we want to check support, not heuristics.\n+  // kAlways does not change what's supported, it only forces the rewrite to\n+  // happen if it is supported.\n+  SortRewriter::SetSortModeForTestingOnly(SortRewriter::Mode::kAlways);\n   std::string hlo = absl::Substitute(\n       kHloTemplate, primitive_util::LowercasePrimitiveTypeName(GetParam()));\n   // We expect that all types except PRED and F8 types are rewritten to a custom\n   // call.\n-  if (GetParam() != PRED && !primitive_util::IsF8Type(GetParam())) {\n-    MatchOptimizedHlo(hlo, \"CHECK: custom-call\");\n-  }\n+  bool rewrite = GetParam() != PRED && !primitive_util::IsF8Type(GetParam());\n+  std::string check = rewrite ? \"CHECK: custom-call\" : \"CHECK-NOT: custom-call\";\n+  MatchOptimizedHlo(hlo, check);\n   EXPECT_TRUE(RunAndCompare(hlo, ErrorSpec{0, 0}));\n }\n "
        }
    ],
    "stats": {
        "total": 17,
        "additions": 11,
        "deletions": 6
    }
}