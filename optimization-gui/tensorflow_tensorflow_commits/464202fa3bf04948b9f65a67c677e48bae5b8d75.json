{
    "author": "matthiaskramm",
    "message": "Apply memory optimizations if options.allow_in_place_mlir_modification is true.\n\nPiperOrigin-RevId: 818818778",
    "sha": "464202fa3bf04948b9f65a67c677e48bae5b8d75",
    "files": [
        {
            "sha": "500e008d9d208a1f0ab4770e1ea2baf6705e99da",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464202fa3bf04948b9f65a67c677e48bae5b8d75/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464202fa3bf04948b9f65a67c677e48bae5b8d75/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=464202fa3bf04948b9f65a67c677e48bae5b8d75",
            "patch": "@@ -38,6 +38,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n+#include \"llvm/ADT/STLExtras.h\"\n #include \"llvm/Support/ErrorHandling.h\"\n #include \"mlir/IR/OwningOpRef.h\"\n #include \"mlir/Pass/PassManager.h\"\n@@ -516,8 +517,16 @@ PjRtCApiClient::CompileAndLoad(mlir::ModuleOp module, CompileOptions options) {\n   if (!pjrt_c_api()) llvm::report_fatal_error(\"pjrt_c_api is null\");\n \n   std::string version_string = GetPluginStablehloVersionOrDefault(this);\n-  TF_ASSIGN_OR_RETURN(std::string serialized,\n-                      xla::Serialize(module, version_string));\n+\n+  TF_ASSIGN_OR_RETURN(\n+      std::string serialized,\n+      xla::Serialize(module, version_string,\n+                     /*inplace=*/options.allow_in_place_mlir_modification));\n+  if (options.allow_in_place_mlir_modification) {\n+    // If we're allowed to modify the computation, free the functions in the\n+    // MLIR. We don't use them anymore, and this reduces peak memory.\n+    module.getBody()->clear();\n+  }\n   std::string format(pjrt::kMlirFormat);\n   return InitializeArgsAndCompile(this, c_api_, c_client_.get(), options,\n                                   serialized, format);"
        },
        {
            "sha": "991b86b7454599ec2635d39213510dc68d4501d4",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464202fa3bf04948b9f65a67c677e48bae5b8d75/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464202fa3bf04948b9f65a67c677e48bae5b8d75/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc?ref=464202fa3bf04948b9f65a67c677e48bae5b8d75",
            "patch": "@@ -331,6 +331,21 @@ TEST(PjRtClientTest, CompileUsesStableHloVersion) {\n   const_cast<PJRT_Api*>(c_api)->PJRT_Client_Compile = PJRT_Client_Compile_Orig;\n }\n \n+TEST(PjRtClientTest, CompileWorksInplace) {\n+  SetUpCpuPjRtApi();\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                          GetCApiClient(\"cpu\"));\n+  constexpr char kProgram[] = \"func.func @main() {return}\";\n+  mlir::MLIRContext context;\n+  TF_ASSERT_OK_AND_ASSIGN(mlir::OwningOpRef<mlir::ModuleOp> module,\n+                          ParseMlirModuleString(kProgram, context));\n+  CompileOptions options;\n+  options.allow_in_place_mlir_modification = true;\n+  std::unique_ptr<PjRtLoadedExecutable> executable =\n+      client->CompileAndLoad(*module, options).value();\n+  EXPECT_NE(executable.get(), nullptr);\n+}\n+\n TEST(PjRtClientTest, CanQueryMemoryDescriptions) {\n   SetUpCpuPjRtApi();\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 26,
        "deletions": 2
    }
}