{
    "author": "qukhan",
    "message": "Add a function to check for empty/non existing files.\n\nThe `fd.Size()` check doesn't work when the file descriptor is invalid and only\nthe path was given.\n\nPiperOrigin-RevId: 846207406",
    "sha": "69cd9be8994ef3ff67e2e30ff48faed67d1df93e",
    "files": [
        {
            "sha": "227537a79f14546dd78aca3e5bdca7704f42e977",
            "filename": "tensorflow/lite/delegates/xnnpack/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD?ref=69cd9be8994ef3ff67e2e30ff48faed67d1df93e",
            "patch": "@@ -421,6 +421,7 @@ cc_library(\n     hdrs = [\"file_util.h\"],\n     compatible_with = get_compatible_with_portable(),\n     deps = [\n+        \":macros\",\n         \"//tensorflow/lite:minimal_logging\",\n     ],\n )"
        },
        {
            "sha": "268aebc50468e3be2ebdc4e6626fd380ed16bd4e",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc?ref=69cd9be8994ef3ff67e2e30ff48faed67d1df93e",
            "patch": "@@ -39,7 +39,13 @@ limitations under the License.\n #endif  // TFLITE_XNNPACK_IN_MEMORY_FILE_ENABLED\n #endif  // defined(__linux__) || defined(__ANDROID__)\n \n+#include <sys/stat.h>\n+\n+#include <cerrno>\n #include <cstdio>\n+#include <cstring>\n+\n+#include \"tensorflow/lite/delegates/xnnpack/macros.h\"\n \n #if !TFLITE_XNNPACK_IN_MEMORY_FILE_ENABLED\n #include \"tensorflow/lite/logger.h\"\n@@ -154,5 +160,22 @@ FileDescriptor CreateInMemoryFileDescriptor(const char* path) {\n #endif\n }\n \n+bool IsFileEmpty(const char* path, const FileDescriptor& fd) {\n+#if defined(_WIN32)\n+  struct _stat64 file_stats{};\n+  const int res = fd.IsValid() ? _fstat64(fd.Value(), &file_stats)\n+                               : _stat64(path, &file_stats);\n+#else\n+  struct stat file_stats{};\n+  const int res =\n+      fd.IsValid() ? fstat(fd.Value(), &file_stats) : stat(path, &file_stats);\n+#endif\n+  XNNPACK_RETURN_CHECK(\n+      res == 0 || errno == ENOENT,\n+      \"could not access file descriptor %d stats to get size ('%s'): %s.\",\n+      fd.Value(), path, strerror(errno));\n+  return file_stats.st_size == 0;\n+}\n+\n }  // namespace xnnpack\n }  // namespace tflite"
        },
        {
            "sha": "9817c74d9f7ee60a6d41f3a3790120469d2c5f84",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h?ref=69cd9be8994ef3ff67e2e30ff48faed67d1df93e",
            "patch": "@@ -175,6 +175,11 @@ class FileDescriptor : public FileDescriptorView {\n // descriptor.\n bool InMemoryFileDescriptorAvailable();\n \n+// Returns true if the file is empty (the file may exist)\n+//\n+// Note: if `fd` is valid, then `path` is ignored.\n+bool IsFileEmpty(const char* path, const FileDescriptor& fd);\n+\n // Creates a new file descriptor that isn't backed by a file system. The file\n // will be automatically cleaned up when the last file descriptor pointing to it\n // is closed."
        },
        {
            "sha": "c7f204befd4776c1937f31b5a38861cdce1b302a",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util_test.cc",
            "status": "modified",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util_test.cc?ref=69cd9be8994ef3ff67e2e30ff48faed67d1df93e",
            "patch": "@@ -84,5 +84,50 @@ TEST(FileDescriptorTest, ReadFailureReturnsFalse) {\n   EXPECT_FALSE(fd.Read(dst_data.data(), dst_data.size()));\n }\n \n+TEST(FileDescriptorTest, IsFileEmptyReturnTrueForAnEmptyFileThatExists) {\n+  const std::string tmp_file = testing::TempDir() + __FUNCTION__;\n+  FileDescriptor fd = FileDescriptor::Open(tmp_file.c_str(),\n+                                           O_CREAT | O_TRUNC | O_WRONLY, 0644);\n+  fd.Close();\n+  EXPECT_TRUE(IsFileEmpty(tmp_file.c_str(), FileDescriptor()));\n+}\n+\n+TEST(FileDescriptorTest, IsFileEmptyReturnTrueForAnNonExistingFile) {\n+  const std::string tmp_file = testing::TempDir() + __FUNCTION__;\n+  EXPECT_TRUE(IsFileEmpty(tmp_file.c_str(), FileDescriptor()));\n+}\n+\n+TEST(FileDescriptorTest,\n+     IsFileEmptyReturnTrueForAnNonExistingFileWithFileDescriptor) {\n+  const std::string tmp_file = testing::TempDir() + __FUNCTION__;\n+  FileDescriptor fd = FileDescriptor::Open(tmp_file.c_str(),\n+                                           O_CREAT | O_TRUNC | O_WRONLY, 0644);\n+  EXPECT_TRUE(IsFileEmpty(\"asdfasdf\", FileDescriptor()));\n+}\n+\n+TEST(FileDescriptorTest, IsFileEmptyReturnFalseForAFileThatHasContents) {\n+  const std::string tmp_file = testing::TempDir() + __FUNCTION__;\n+  FileDescriptor fd = FileDescriptor::Open(tmp_file.c_str(),\n+                                           O_CREAT | O_TRUNC | O_WRONLY, 0644);\n+  const std::string src_data = \"The quick brown fox jumps over the lazy dog.\";\n+  EXPECT_TRUE(fd.Write(src_data.data(), src_data.size()));\n+  EXPECT_FALSE(IsFileEmpty(tmp_file.c_str(), fd));\n+}\n+\n+TEST(FileDescriptorTest, IsFileEmptyPrioritizesTheFileDescriptor) {\n+  // We open 2 files, put some data only in one and then pass the file name of\n+  // the one that has data and the file descriptor of the empty one.\n+  const std::string tmp_file = testing::TempDir() + __FUNCTION__;\n+  const std::string tmp_file2 = testing::TempDir() + __FUNCTION__ + \"2\";\n+  FileDescriptor fd = FileDescriptor::Open(tmp_file.c_str(),\n+                                           O_CREAT | O_TRUNC | O_WRONLY, 0644);\n+  FileDescriptor fd2 = FileDescriptor::Open(tmp_file2.c_str(),\n+                                            O_CREAT | O_TRUNC | O_WRONLY, 0644);\n+  const std::string src_data = \"The quick brown fox jumps over the lazy dog.\";\n+  EXPECT_TRUE(fd.Write(src_data.data(), src_data.size()));\n+  fd.Close();\n+  EXPECT_TRUE(IsFileEmpty(tmp_file.c_str(), fd2));\n+}\n+\n }  // namespace\n }  // namespace tflite::xnnpack"
        },
        {
            "sha": "a8c86ff5a2552923ff5ebf6e3ffd6eb7ae97d35e",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/69cd9be8994ef3ff67e2e30ff48faed67d1df93e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=69cd9be8994ef3ff67e2e30ff48faed67d1df93e",
            "patch": "@@ -330,7 +330,7 @@ bool MMapWeightCacheProvider::LoadOrStartBuild(const char* path,\n   }\n   const char* const safe_path = Sanitize(path);\n   FileDescriptor build_fd = fd.Duplicate();\n-  if (!IsInMemoryCachePath(safe_path) && fd.Size() &&\n+  if (!IsInMemoryCachePath(safe_path) && !IsFileEmpty(safe_path, fd) &&\n       Load(safe_path, std::move(fd))) {\n     TFLITE_LOG_PROD(tflite::TFLITE_LOG_VERBOSE,\n                     \"XNNPack weight cache loaded from '%s'.\", safe_path);"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 75,
        "deletions": 1
    }
}