{
    "author": "qukhan",
    "message": "Make file handling utilities compatible with files larger than 4GiB on 32 bit Windows.\n\nThis also changes from using `_MSC_VER` to `_WIN32` to detect compilation on windows.\n\nPiperOrigin-RevId: 819853587",
    "sha": "9e80aec7d822994eb04969ce63c946fa0eec7039",
    "files": [
        {
            "sha": "b475080480ecb421c3ee551dfdb0b812c2526bf1",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.cc?ref=9e80aec7d822994eb04969ce63c946fa0eec7039",
            "patch": "@@ -16,13 +16,15 @@ limitations under the License.\n \n #include <fcntl.h>\n \n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n #include <io.h>\n #define F_OK 0\n #define ftruncate _chsize_s\n+#define XNN_LSEEK _lseeki64\n #else\n #include <unistd.h>\n-#endif  // defined(_MSC_VER)\n+#define XNN_LSEEK lseek\n+#endif  // defined(_WIN32)\n \n // We currently use the memfd_create system call to create in-memory files which\n // is only supported on Linux and Android.\n@@ -68,22 +70,27 @@ void FileDescriptor::Reset(int new_fd) {\n   fd_ = new_fd;\n }\n \n-off_t FileDescriptorView::GetPos() const { return lseek(fd_, 0, SEEK_CUR); }\n+FileDescriptor::Offset FileDescriptorView::GetPos() const {\n+  return XNN_LSEEK(fd_, 0, SEEK_CUR);\n+}\n \n-off_t FileDescriptorView::SetPos(off_t position) const {\n-  return lseek(fd_, position, SEEK_SET);\n+FileDescriptor::Offset FileDescriptorView::SetPos(\n+    FileDescriptor::Offset position) const {\n+  return XNN_LSEEK(fd_, position, SEEK_SET);\n }\n \n-off_t FileDescriptorView::SetPosFromEnd(off_t offset) const {\n-  return lseek(fd_, offset, SEEK_END);\n+FileDescriptor::Offset FileDescriptorView::SetPosFromEnd(\n+    FileDescriptor::Offset offset) const {\n+  return XNN_LSEEK(fd_, offset, SEEK_END);\n }\n \n-off_t FileDescriptorView::MovePos(off_t offset) const {\n-  return lseek(fd_, offset, SEEK_CUR);\n+FileDescriptor::Offset FileDescriptorView::MovePos(\n+    FileDescriptor::Offset offset) const {\n+  return XNN_LSEEK(fd_, offset, SEEK_CUR);\n }\n \n FileDescriptor FileDescriptor::Open(const char* path, int flags, mode_t mode) {\n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n   if (!(flags & O_TEXT)) {\n     flags |= O_BINARY;\n   }"
        },
        {
            "sha": "931bf9fd064f1cd8e74f7521af6353f4fd6544e4",
            "filename": "tensorflow/lite/delegates/xnnpack/file_util.h",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffile_util.h?ref=9e80aec7d822994eb04969ce63c946fa0eec7039",
            "patch": "@@ -23,12 +23,18 @@ limitations under the License.\n namespace tflite {\n namespace xnnpack {\n \n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n using mode_t = int;\n #endif\n \n class FileDescriptorView {\n  public:\n+#if defined(_WIN32)\n+  using Offset = __int64;\n+#else\n+  using Offset = off_t;\n+#endif\n+\n   explicit FileDescriptorView(int fd) : fd_(fd) {}\n   FileDescriptorView() = default;\n \n@@ -45,28 +51,28 @@ class FileDescriptorView {\n   // Equivalent to MovePos(0).\n   //\n   // WARNING: the file descriptor must be valid and the file must be opened.\n-  off_t GetPos() const;\n+  Offset GetPos() const;\n \n   // Sets the absolute cursor position in the current file.\n   //\n   // Returns the cursor position in the file or -1 on error.\n   //\n   // WARNING: the file descriptor must be valid and the file must be opened.\n-  off_t SetPos(off_t position) const;\n+  Offset SetPos(Offset position) const;\n \n   // Sets the cursor position relative to the file end.\n   //\n   // Returns the cursor position in the file or -1 on error.\n   //\n   // WARNING: the file descriptor must be valid and the file must be opened.\n-  off_t SetPosFromEnd(off_t offset) const;\n+  Offset SetPosFromEnd(Offset offset) const;\n \n   // Moves the cursor position by the given offset in the current file.\n   //\n   // Returns the cursor position in the file or -1 on error.\n   //\n   // WARNING: the file descriptor must be valid and the file must be opened.\n-  off_t MovePos(off_t offset) const;\n+  Offset MovePos(Offset offset) const;\n \n   // Reads `count` bytes from the file at the current position to `dst`.\n   //"
        },
        {
            "sha": "fcfb6d7f2065e167a822e89b33c923f646c90a83",
            "filename": "tensorflow/lite/delegates/xnnpack/mmap_handle.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc?ref=9e80aec7d822994eb04969ce63c946fa0eec7039",
            "patch": "@@ -14,7 +14,7 @@ limitations under the License.\n ==============================================================================*/\n #include \"tensorflow/lite/delegates/xnnpack/mmap_handle.h\"\n \n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n #include <io.h>\n #include <windows.h>\n #else\n@@ -79,7 +79,7 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n                        \"cannot mmap invalid file descriptor %d ('%s').\",\n                        fd.Value(), path);\n \n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n   struct _stat64 file_stats;\n   XNNPACK_RETURN_CHECK(_fstat64(fd.Value(), &file_stats) == 0,\n                        \"could not access file stats to get size ('%s'): %s.\",\n@@ -101,7 +101,7 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n   fd.SetPos(offset);\n   XNNPACK_RETURN_CHECK(fd.Read(data_, size_), \"could not read file ('%s'): %s.\",\n                        safe_path, strerror(errno));\n-#elif defined(_MSC_VER)\n+#elif defined(_WIN32)\n   HANDLE osf_handle = reinterpret_cast<HANDLE>(_get_osfhandle(fd.Value()));\n   XNNPACK_RETURN_CHECK(osf_handle != INVALID_HANDLE_VALUE,\n                        \"could not convert file descriptor to file handle: %s.\",\n@@ -178,7 +178,7 @@ void MMapHandle::UnMap() {\n   if (data_) {\n #if defined(XNNPACK_CACHE_NO_MMAP_FOR_TEST)\n     delete[] data_;\n-#elif defined(_MSC_VER)\n+#elif defined(_WIN32)\n     UnmapViewOfFile(data_);\n     CloseHandle(file_mapping_);\n #else"
        },
        {
            "sha": "a4ef96017e282469e0f25a05625b3045d79f3e8e",
            "filename": "tensorflow/lite/delegates/xnnpack/mmap_handle.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9e80aec7d822994eb04969ce63c946fa0eec7039/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.h?ref=9e80aec7d822994eb04969ce63c946fa0eec7039",
            "patch": "@@ -15,7 +15,7 @@ limitations under the License.\n #ifndef TENSORFLOW_LITE_DELEGATES_XNNPACK_MMAP_HANDLE_H_\n #define TENSORFLOW_LITE_DELEGATES_XNNPACK_MMAP_HANDLE_H_\n \n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n #include <windows.h>\n #endif\n \n@@ -130,7 +130,7 @@ class MMapHandle {\n   size_t offset_ = 0;\n   size_t offset_page_adjustment_ = 0;\n   uint8_t* data_ = nullptr;\n-#if defined(_MSC_VER)\n+#if defined(_WIN32)\n   HANDLE file_mapping_ = 0;\n #endif\n };"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 34,
        "deletions": 21
    }
}