{
    "author": "subhamsoni-google",
    "message": "Add hostname override to customize remote profiling filenames\n\nPiperOrigin-RevId: 836117944",
    "sha": "464b2a03a443943706b4981632c2aa870a3d1204",
    "files": [
        {
            "sha": "334ab25ac60c6e3bf6d3469ff424b6a46807d1c6",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2FBUILD?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -41,13 +41,15 @@ cc_library(\n         \"//xla/tsl/profiler/rpc/client:save_profile\",\n         \"//xla/tsl/profiler/utils:file_system_utils\",\n         \"//xla/tsl/profiler/utils:math_utils\",\n+        \"//xla/tsl/profiler/utils:profiler_options_util\",\n         \"//xla/tsl/profiler/utils:time_utils\",\n         \"//xla/tsl/profiler/utils:xplane_utils\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n+        \"@local_tsl//tsl/platform:platform_port\",\n         \"@local_tsl//tsl/profiler/lib:profiler_session\",\n         \"@local_tsl//tsl/profiler/protobuf:profiler_service_cc_grpc_proto\",\n         \"@local_tsl//tsl/profiler/protobuf:profiler_service_proto_cc\","
        },
        {
            "sha": "36f922eeb8abe20938cdb748095f58292c05cbc9",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/client/BUILD",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2FBUILD?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -165,16 +165,21 @@ tsl_cc_test(\n         \":profiler_client\",\n         \":profiler_client_impl\",  # for oss\n         \":profiler_client_test_util\",\n+        \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:env_impl\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/platform:types\",\n         \"//xla/tsl/profiler/rpc:profiler_server_impl\",\n         \"//xla/tsl/profiler/rpc:profiler_service_impl\",\n+        \"//xla/tsl/profiler/utils:file_system_utils\",\n         \"//xla/tsl/profiler/utils:time_utils_impl\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/time\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform:platform_port\",\n         \"@local_tsl//tsl/profiler/lib:profiler_factory_impl\",\n         \"@local_tsl//tsl/profiler/lib:profiler_session_impl\",\n     ] + tf_protos_profiler_service(),\n@@ -187,14 +192,15 @@ cc_library(\n     copts = tf_profiler_copts(),\n     deps = [\n         \":profiler_client_for_pybind\",\n-        \"//xla/tsl/platform:env_time\",\n-        \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/lib/gtl:map_util\",\n         \"//xla/tsl/platform:logging\",\n         \"//xla/tsl/platform:macros\",\n         \"//xla/tsl/platform:status\",\n+        \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:types\",\n-        \"//xla/tsl/profiler/utils:time_utils\",\n         \"@com_google_absl//absl/memory\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/time\",\n@@ -210,18 +216,23 @@ tsl_cc_test(\n         \":profiler_client_impl\",  # for oss\n         \":profiler_client_test_util\",\n         \":remote_profiler_session_manager\",\n+        \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:env_impl\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/platform:types\",\n         \"//xla/tsl/profiler/rpc:profiler_server_impl\",\n         \"//xla/tsl/profiler/rpc:profiler_service_impl\",\n+        \"//xla/tsl/profiler/utils:file_system_utils\",\n         \"//xla/tsl/profiler/utils:time_utils_impl\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/time\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@local_tsl//tsl/profiler/lib:profiler_factory_impl\",\n+        \"@local_tsl//tsl/profiler/lib:profiler_session\",\n         \"@local_tsl//tsl/profiler/lib:profiler_session_impl\",\n         \"@local_tsl//tsl/profiler/protobuf:profiler_options_proto_cc\",\n     ] + tf_protos_profiler_service(),"
        },
        {
            "sha": "ac2678763919a262e7d8a701f0376c4f402817b0",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/client/profiler_client_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fprofiler_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fprofiler_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fprofiler_client_test.cc?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -17,20 +17,22 @@ limitations under the License.\n #include <memory>\n #include <string>\n \n+#include \"absl/status/status.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n-#include \"xla/tsl/platform/errors.h\"\n-#include \"xla/tsl/platform/status.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/test.h\"\n-#include \"xla/tsl/platform/types.h\"\n #include \"xla/tsl/profiler/rpc/client/profiler_client_test_util.h\"\n+#include \"xla/tsl/profiler/rpc/profiler_server.h\"\n+#include \"xla/tsl/profiler/utils/file_system_utils.h\"\n #include \"tsl/profiler/protobuf/profiler_service.pb.h\"\n \n namespace tsl {\n namespace profiler {\n namespace {\n \n using tensorflow::ProfileRequest;\n+using tensorflow::ProfileResponse;\n using ::tsl::profiler::test::DurationApproxLess;\n using ::tsl::profiler::test::DurationNear;\n using ::tsl::profiler::test::StartServer;\n@@ -148,6 +150,27 @@ TEST(RemoteProfilerSession, LongDuration) {\n   EXPECT_THAT(elapsed, DurationApproxLess(max_duration));\n }\n \n+TEST(ProfileGrpcTest, ProfileWithOverrideHostname) {\n+  absl::Duration duration = absl::Milliseconds(100);\n+  ProfileRequest request;\n+  std::string service_addr;\n+  std::unique_ptr<ProfilerServer> server =\n+      StartServer(duration, &service_addr, &request);\n+\n+  (*request.mutable_opts()\n+        ->mutable_advanced_configuration())[\"override_hostname\"]\n+      .set_string_value(\"testhost\");\n+\n+  tensorflow::ProfileResponse response;\n+  absl::Status status = ProfileGrpc(service_addr, request, &response);\n+  EXPECT_TRUE(status.ok());\n+\n+  std::string expected_filepath = ProfilerJoinPath(\n+      request.repository_root(), request.session_id(), \"testhost.xplane.pb\");\n+\n+  EXPECT_TRUE(Env::Default()->FileExists(expected_filepath).ok());\n+}\n+\n }  // namespace\n }  // namespace profiler\n }  // namespace tsl"
        },
        {
            "sha": "e87073e6c9feb0a26ffc75a4e5cabae471228c82",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/client/remote_profiler_session_manager.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 8,
            "changes": 57,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fremote_profiler_session_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fremote_profiler_session_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fremote_profiler_session_manager.cc?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -17,25 +17,55 @@ limitations under the License.\n \n #include <cstddef>\n #include <memory>\n+#include <string>\n+#include <vector>\n \n #include \"absl/memory/memory.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n-#include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n-#include \"xla/tsl/platform/env_time.h\"\n-#include \"xla/tsl/platform/errors.h\"\n+#include \"xla/tsl/lib/gtl/map_util.h\"\n #include \"xla/tsl/platform/logging.h\"\n-#include \"xla/tsl/platform/types.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/profiler/rpc/client/profiler_client.h\"\n-#include \"xla/tsl/profiler/utils/time_utils.h\"\n \n namespace tsl {\n namespace profiler {\n \n+namespace {\n+\n using tensorflow::ProfileRequest;\n using tensorflow::RemoteProfilerSessionManagerOptions;\n \n+// Parses \"override_hostnames\" from the configuration to save profile results.\n+// Validates that the hostnames match the count and order of `service_addresses`\n+// in `options`. The caller needs to ensure that order of `service_addresses`\n+// and `override_hostnames` is same.\n+absl::StatusOr<std::vector<std::string>> ParseAndValidateOverrideHostnames(\n+    const RemoteProfilerSessionManagerOptions& options,\n+    ProfileRequest& request) {\n+  const auto* override_hostnames = gtl::FindOrNull(\n+      request.opts().advanced_configuration(), \"override_hostnames\");\n+  if (override_hostnames == nullptr) {\n+    return std::vector<std::string>();\n+  }\n+  std::vector<std::string> override_hostnames_list =\n+      absl::StrSplit(override_hostnames->string_value(), ',');\n+  if (override_hostnames_list.size() != options.service_addresses().size()) {\n+    return absl::InvalidArgumentError(\n+        \"The number of override hostnames must match the number of service \"\n+        \"addresses.\");\n+  }\n+  request.mutable_opts()->mutable_advanced_configuration()->erase(\n+      \"override_hostnames\");\n+  return override_hostnames_list;\n+}\n+\n+}  // namespace\n+\n /*static*/ std::unique_ptr<RemoteProfilerSessionManager>\n RemoteProfilerSessionManager::Create(\n     const RemoteProfilerSessionManagerOptions& options,\n@@ -84,12 +114,23 @@ absl::Status RemoteProfilerSessionManager::Init() {\n             << session_created_ts << \"]\";\n \n   // Prepare a list of clients.\n-  clients_.reserve(options_.service_addresses_size());\n+  clients_.reserve(options_.service_addresses().size());\n+\n+  ProfileRequest request_template = request_;\n+  TF_ASSIGN_OR_RETURN(\n+      std::vector<std::string> override_hostnames_list,\n+      ParseAndValidateOverrideHostnames(options_, request_template));\n \n-  ProfileRequest request = request_;\n-  for (auto& service_address : options_.service_addresses()) {\n+  for (size_t i = 0; i < options_.service_addresses().size(); ++i) {\n+    const std::string& service_address = options_.service_addresses(i);\n     std::string resolved_service_address = resolver_(service_address);\n+    ProfileRequest request = request_template;\n     request.set_host_name(resolved_service_address);\n+    if (i < override_hostnames_list.size()) {\n+      (*request.mutable_opts()\n+            ->mutable_advanced_configuration())[\"override_hostname\"]\n+          .set_string_value(override_hostnames_list[i]);\n+    }\n \n     // Creation also issues Profile RPC asynchronously.\n     auto client = RemoteProfilerSession::Create(resolved_service_address,"
        },
        {
            "sha": "25c93c7134ce46d302b13fd1ad598e5c8130d419",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/client/remote_profiler_session_manager_test.cc",
            "status": "modified",
            "additions": 81,
            "deletions": 7,
            "changes": 88,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fremote_profiler_session_manager_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fremote_profiler_session_manager_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fremote_profiler_session_manager_test.cc?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -14,18 +14,23 @@ limitations under the License.\n ==============================================================================*/\n #include \"xla/tsl/profiler/rpc/client/remote_profiler_session_manager.h\"\n \n+#include <cstdint>\n #include <memory>\n #include <string>\n #include <vector>\n \n+#include <gmock/gmock.h>\n #include \"absl/status/status.h\"\n+#include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n-#include \"xla/tsl/platform/errors.h\"\n-#include \"xla/tsl/platform/status.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/test.h\"\n-#include \"xla/tsl/platform/types.h\"\n #include \"xla/tsl/profiler/rpc/client/profiler_client_test_util.h\"\n+#include \"xla/tsl/profiler/rpc/profiler_server.h\"\n+#include \"xla/tsl/profiler/utils/file_system_utils.h\"\n+#include \"tsl/profiler/lib/profiler_session.h\"\n #include \"tsl/profiler/protobuf/profiler_options.pb.h\"\n #include \"tsl/profiler/protobuf/profiler_service.pb.h\"\n \n@@ -74,7 +79,8 @@ TEST(RemoteProfilerSessionManagerTest, Simple) {\n       absl::ToInt64Milliseconds(duration));\n \n   std::string service_address;\n-  auto server = StartServer(duration, &service_address);\n+  std::unique_ptr<ProfilerServer> server =\n+      StartServer(duration, &service_address);\n   options.add_service_addresses(service_address);\n   absl::Time approx_start = absl::Now();\n   absl::Duration grace = absl::Seconds(kGracePeriodSeconds);\n@@ -85,7 +91,7 @@ TEST(RemoteProfilerSessionManagerTest, Simple) {\n   ProfileRequest request =\n       PopulateProfileRequest(TmpDir(), \"session_id\", service_address, options);\n   absl::Status status;\n-  auto sessions =\n+  std::unique_ptr<RemoteProfilerSessionManager> sessions =\n       RemoteProfilerSessionManager::Create(options, request, status);\n   EXPECT_TRUE(status.ok());\n   std::vector<Response> responses = sessions->WaitForCompletion();\n@@ -117,7 +123,7 @@ TEST(RemoteProfilerSessionManagerTest, ExpiredDeadline) {\n   ProfileRequest request =\n       PopulateProfileRequest(TmpDir(), \"session_id\", service_address, options);\n   absl::Status status;\n-  auto sessions =\n+  std::unique_ptr<RemoteProfilerSessionManager> sessions =\n       RemoteProfilerSessionManager::Create(options, request, status);\n   EXPECT_TRUE(status.ok());\n   std::vector<Response> responses = sessions->WaitForCompletion();\n@@ -149,7 +155,7 @@ TEST(RemoteProfilerSessionManagerTest, LongSession) {\n   ProfileRequest request =\n       PopulateProfileRequest(TmpDir(), \"session_id\", service_address, options);\n   absl::Status status;\n-  auto sessions =\n+  std::unique_ptr<RemoteProfilerSessionManager> sessions =\n       RemoteProfilerSessionManager::Create(options, request, status);\n   EXPECT_TRUE(status.ok());\n   std::vector<Response> responses = sessions->WaitForCompletion();\n@@ -161,6 +167,74 @@ TEST(RemoteProfilerSessionManagerTest, LongSession) {\n   EXPECT_THAT(elapsed, DurationApproxLess(max_duration));\n }\n \n+TEST(RemoteProfilerSessionManagerTest, OverrideHostnames) {\n+  absl::Duration duration = absl::Milliseconds(100);\n+  RemoteProfilerSessionManagerOptions options;\n+  *options.mutable_profiler_options() = tsl::ProfilerSession::DefaultOptions();\n+  options.mutable_profiler_options()->set_duration_ms(\n+      absl::ToInt64Milliseconds(duration));\n+\n+  std::string service_address;\n+  std::unique_ptr<ProfilerServer> server =\n+      StartServer(duration, &service_address);\n+  options.add_service_addresses(service_address);\n+  absl::Time approx_start = absl::Now();\n+  absl::Duration grace = absl::Seconds(kGracePeriodSeconds);\n+  absl::Duration max_duration = duration + grace;\n+  options.set_max_session_duration_ms(absl::ToInt64Milliseconds(max_duration));\n+  options.set_session_creation_timestamp_ns(absl::ToUnixNanos(approx_start));\n+\n+  ProfileRequest request =\n+      PopulateProfileRequest(TmpDir(), \"session_id\", service_address, options);\n+  std::string random_hostname =\n+      absl::StrCat(\"testhost_\", absl::ToUnixNanos(absl::Now()));\n+  (*request.mutable_opts()\n+        ->mutable_advanced_configuration())[\"override_hostnames\"]\n+      .set_string_value(random_hostname);\n+\n+  absl::Status status;\n+  std::unique_ptr<RemoteProfilerSessionManager> sessions =\n+      RemoteProfilerSessionManager::Create(options, request, status);\n+  ASSERT_TRUE(status.ok());\n+  EXPECT_THAT(\n+      sessions->WaitForCompletion(),\n+      ElementsAre(::testing::Field(&Response::status, absl::OkStatus())));\n+\n+  EXPECT_TRUE(Env::Default()\n+                  ->FileExists(ProfilerJoinPath(\n+                      request.repository_root(), request.session_id(),\n+                      absl::StrCat(random_hostname, \".xplane.pb\")))\n+                  .ok());\n+}\n+\n+TEST(RemoteProfilerSessionManagerTest, OverrideHostnamesMismatch) {\n+  absl::Duration duration = absl::Milliseconds(30);\n+  RemoteProfilerSessionManagerOptions options;\n+  *options.mutable_profiler_options() = tsl::ProfilerSession::DefaultOptions();\n+  options.mutable_profiler_options()->set_duration_ms(\n+      absl::ToInt64Milliseconds(duration));\n+\n+  std::string service_address;\n+  auto server = StartServer(duration, &service_address);\n+  options.add_service_addresses(service_address);\n+  absl::Time approx_start = absl::Now();\n+  absl::Duration grace = absl::Seconds(kGracePeriodSeconds);\n+  absl::Duration max_duration = duration + grace;\n+  options.set_max_session_duration_ms(absl::ToInt64Milliseconds(max_duration));\n+  options.set_session_creation_timestamp_ns(absl::ToUnixNanos(approx_start));\n+\n+  ProfileRequest request =\n+      PopulateProfileRequest(TmpDir(), \"session_id\", service_address, options);\n+  (*request.mutable_opts()\n+        ->mutable_advanced_configuration())[\"override_hostnames\"]\n+      .set_string_value(\"override1,override2\");\n+\n+  absl::Status status;\n+  std::unique_ptr<RemoteProfilerSessionManager> sessions =\n+      RemoteProfilerSessionManager::Create(options, request, status);\n+  EXPECT_EQ(status.code(), absl::StatusCode::kInvalidArgument);\n+}\n+\n }  // namespace\n }  // namespace profiler\n }  // namespace tsl"
        },
        {
            "sha": "1207e529fbdc3010597ccfa59807738b1f0e3841",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fprofiler_service_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fprofiler_service_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fprofiler_service_impl.cc?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -17,21 +17,22 @@ limitations under the License.\n \n #include <cstdint>\n #include <memory>\n+#include <optional>\n+#include <string>\n+#include <variant>\n \n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/status/status.h\"\n-#include \"absl/strings/str_replace.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"grpcpp/support/status.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/env_time.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/logging.h\"\n #include \"xla/tsl/platform/macros.h\"\n-#include \"xla/tsl/platform/status.h\"\n #include \"xla/tsl/profiler/rpc/client/save_profile.h\"\n-#include \"xla/tsl/profiler/utils/file_system_utils.h\"\n #include \"xla/tsl/profiler/utils/math_utils.h\"\n+#include \"xla/tsl/profiler/utils/profiler_options_util.h\"\n #include \"xla/tsl/profiler/utils/time_utils.h\"\n #include \"xla/tsl/profiler/utils/xplane_utils.h\"\n #include \"tsl/profiler/lib/profiler_session.h\"\n@@ -50,6 +51,20 @@ using tensorflow::ProfileResponse;\n using tensorflow::TerminateRequest;\n using tensorflow::TerminateResponse;\n \n+std::string GetHostname(const ProfileRequest& request) {\n+  std::optional<std::variant<std::string, bool, int64_t>> hostname_override =\n+      GetConfigValue(request.opts(), \"override_hostname\");\n+  if (!hostname_override.has_value()) {\n+    return request.host_name();\n+  }\n+  const std::string* hostname_str =\n+      std::get_if<std::string>(&*hostname_override);\n+  if (hostname_str != nullptr && !hostname_str->empty()) {\n+    return *hostname_str;\n+  }\n+  return request.host_name();\n+}\n+\n // Collects data in XSpace format. The data is saved to a repository\n // unconditionally.\n absl::Status CollectData(const ProfileRequest& request,\n@@ -69,7 +84,7 @@ absl::Status CollectData(const ProfileRequest& request,\n   }\n \n   return SaveXSpace(request.repository_root(), request.session_id(),\n-                    request.host_name(), xspace);\n+                    GetHostname(request), xspace);\n }\n \n class ProfilerServiceImpl : public tensorflow::grpc::ProfilerService::Service {"
        },
        {
            "sha": "3304df3c55da2f773df24123a609c651fb9a5d24",
            "filename": "third_party/xla/xla/tsl/profiler/utils/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2FBUILD?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -480,6 +480,7 @@ cc_library(\n         \"//xla/tsl/platform:status\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@local_tsl//tsl/profiler/lib:profiler_session\",\n         \"@local_tsl//tsl/profiler/protobuf:profiler_options_proto_cc\","
        },
        {
            "sha": "7d4e66a5a94a895ccf1cffbc4cbe570cb5c993ed",
            "filename": "third_party/xla/xla/tsl/profiler/utils/session_manager.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 6,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fsession_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/464b2a03a443943706b4981632c2aa870a3d1204/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fsession_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fsession_manager.cc?ref=464b2a03a443943706b4981632c2aa870a3d1204",
            "patch": "@@ -22,6 +22,10 @@ limitations under the License.\n \n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/strings/match.h\"\n+#include \"absl/strings/numbers.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/tsl/platform/errors.h\"\n@@ -78,6 +82,8 @@ void UpdateMaxSessionDuration(RemoteProfilerSessionManagerOptions& options) {\n \n // Receives a comma delimited list of service_addresses and adds them to\n // RemoteProfilerSessionManagerOptions::service_addresses.\n+// If override_hostnames is also specified, the order of hosts in\n+// service_addresses and override_hostnames must match.\n void AddServiceAddresses(absl::string_view service_addresses,\n                          RemoteProfilerSessionManagerOptions* options) {\n   for (absl::string_view server : absl::StrSplit(service_addresses, ',')) {\n@@ -143,6 +149,18 @@ RemoteProfilerSessionManagerOptions GetRemoteSessionManagerOptionsLocked(\n             options.mutable_profiler_options()->set_session_id(value);\n           },\n           nullptr);\n+    } else if (key == \"override_hostnames\") {\n+      // A comma-separated list of hostnames that should be used to save the\n+      // profile results. The order of these hostnames must match the order of\n+      // service_addresses.\n+      SetOption<std::string>(\n+          key, kw.second,\n+          [&options](tensorflow::ProfileOptions*, std::string value) {\n+            (*options.mutable_profiler_options()\n+                  ->mutable_advanced_configuration())[\"override_hostnames\"]\n+                .set_string_value(value);\n+          },\n+          nullptr);\n     } else {\n       LOG(WARNING) << \"Unrecognised key: \" << key;\n     }\n@@ -197,12 +215,11 @@ RemoteProfilerSessionManagerOptions GetRemoteSessionManagerOptionsLocked(\n absl::Status ValidateRemoteProfilerSessionManagerOptions(\n     const RemoteProfilerSessionManagerOptions& options) {\n   if (options.service_addresses().empty()) {\n-    return tsl::errors::InvalidArgument(\"No service address provided.\");\n+    return absl::InvalidArgumentError(\"No service address provided.\");\n   }\n \n   if (options.profiler_options().duration_ms() == 0) {\n-    return tsl::errors::InvalidArgument(\n-        \"duration_ms must be greater than zero.\");\n+    return absl::InvalidArgumentError(\"duration_ms must be greater than zero.\");\n   }\n \n   for (absl::string_view host_port : options.service_addresses()) {\n@@ -211,7 +228,7 @@ absl::Status ValidateRemoteProfilerSessionManagerOptions(\n \n   if (options.max_session_duration_ms() <\n       options.profiler_options().duration_ms()) {\n-    return tsl::errors::InvalidArgument(\n+    return absl::InvalidArgumentError(\n         \"The maximum profiling session duration must be greater than or equal \"\n         \"to the local profiler duration.\");\n   }\n@@ -226,8 +243,8 @@ absl::Status ValidateHostPortPair(absl::string_view host_port) {\n   // host also must not be empty.\n   if (parts.size() != 2 || !absl::SimpleAtoi(parts[1], &port) ||\n       absl::StrContains(parts[0], \"/\") || parts[0].empty()) {\n-    return tsl::errors::InvalidArgument(\"Could not interpret \\\"\", host_port,\n-                                        \"\\\" as a host-port pair.\");\n+    return absl::InvalidArgumentError(absl::StrCat(\n+        \"Could not interpret \\\"\", host_port, \"\\\" as a host-port pair.\"));\n   }\n   return absl::OkStatus();\n }"
        }
    ],
    "stats": {
        "total": 246,
        "additions": 215,
        "deletions": 31
    }
}