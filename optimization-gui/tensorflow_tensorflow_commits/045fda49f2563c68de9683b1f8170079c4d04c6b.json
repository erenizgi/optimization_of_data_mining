{
    "author": "ezhulenev",
    "message": "[xla] Add HloModule::Finalize to release internal data structure not needed after compilation is done\n\nPiperOrigin-RevId: 798356871",
    "sha": "045fda49f2563c68de9683b1f8170079c4d04c6b",
    "files": [
        {
            "sha": "41c21e04b1a444271d03cecaff22ef71535985fd",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/045fda49f2563c68de9683b1f8170079c4d04c6b/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/045fda49f2563c68de9683b1f8170079c4d04c6b/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc?ref=045fda49f2563c68de9683b1f8170079c4d04c6b",
            "patch": "@@ -144,6 +144,11 @@ HloModule::StackFrame HloModule::get_stack_frame(int id) const {\n   return stack_frame;\n }\n \n+void HloModule::Finalize() {\n+  instruction_name_uniquer_.reset();\n+  computation_name_uniquer_.reset();\n+}\n+\n HloComputation* HloModule::AddComputationInternal(\n     std::unique_ptr<HloComputation> computation, bool is_entry,\n     bool uniquify_identifiers, bool preserve_entry_layouts) {\n@@ -166,9 +171,9 @@ HloComputation* HloModule::AddComputationInternal(\n   }\n \n   if (uniquify_identifiers) {\n-    computation->UniquifyName(&computation_name_uniquer_);\n+    computation->UniquifyName(&computation_name_uniquer());\n     for (auto* instruction : computation->instructions()) {\n-      instruction->UniquifyName(&instruction_name_uniquer_);\n+      instruction->UniquifyName(&instruction_name_uniquer());\n     }\n \n     // Pick unique IDs for each instruction.\n@@ -185,9 +190,9 @@ HloComputation* HloModule::AddComputationInternal(\n     // for computations and instructions created later. Also, set the\n     // next_unique_id_ to the one greater than the max unique id of any\n     // instruction (or the computation) to avoid ID collisions.\n-    computation_name_uniquer_.GetUniqueName(computation->name());\n+    computation_name_uniquer().GetUniqueName(computation->name());\n     for (auto* instruction : computation->instructions()) {\n-      instruction_name_uniquer_.GetUniqueName(instruction->name());\n+      instruction_name_uniquer().GetUniqueName(instruction->name());\n       next_unique_id_ =\n           std::max(next_unique_id_, instruction->unique_id_64_bits() + 1);\n     }\n@@ -302,9 +307,9 @@ void HloModule::MoveComputationsFrom(HloModule* module,\n         /*uniquify_identifiers=*/false,\n         /*preserve_entry_layouts=*/false);\n     if (make_names_unique) {\n-      computation_raw_ptr->UniquifyName(&computation_name_uniquer_);\n+      computation_raw_ptr->UniquifyName(&computation_name_uniquer());\n       for (auto* instruction : computation_raw_ptr->instructions()) {\n-        instruction->UniquifyName(&instruction_name_uniquer_);\n+        instruction->UniquifyName(&instruction_name_uniquer());\n       }\n     }\n     // Pick unique IDs for each instruction."
        },
        {
            "sha": "be54282ec73bdb2f698b0a9f37ce579560df1f11",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.h",
            "status": "modified",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/045fda49f2563c68de9683b1f8170079c4d04c6b/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/045fda49f2563c68de9683b1f8170079c4d04c6b/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.h?ref=045fda49f2563c68de9683b1f8170079c4d04c6b",
            "patch": "@@ -498,10 +498,18 @@ class HloModule {\n   uint64_t RandomNew64() const;\n \n   // Returns the NameUniquer for uniquing instruction names in this module.\n-  NameUniquer& instruction_name_uniquer() { return instruction_name_uniquer_; }\n+  NameUniquer& instruction_name_uniquer() {\n+    DCHECK(computation_name_uniquer_.has_value())\n+        << \"Can't get instruction name uniquer after HloModule was finalized\";\n+    return *instruction_name_uniquer_;\n+  }\n \n   // Returns the NameUniquer for uniquing computation names in this module.\n-  NameUniquer& computation_name_uniquer() { return computation_name_uniquer_; }\n+  NameUniquer& computation_name_uniquer() {\n+    DCHECK(computation_name_uniquer_.has_value())\n+        << \"Can't get computation name uniquer after HloModule was finalized\";\n+    return *computation_name_uniquer_;\n+  }\n \n   // Assign a new unique dense id for an instruction\n   int64_t NewUniqueInstructionId() {\n@@ -569,13 +577,13 @@ class HloModule {\n \n   void SetAndUniquifyInstrName(HloInstruction* instr, absl::string_view name) {\n     instr->SetAndSanitizeName(name);\n-    instr->UniquifyName(&instruction_name_uniquer_);\n+    instr->UniquifyName(&instruction_name_uniquer());\n   }\n \n   void SetAndUniquifyComputationName(HloComputation* computation,\n                                      absl::string_view name) {\n     computation->SetAndSanitizeName(name);\n-    computation->UniquifyName(&computation_name_uniquer_);\n+    computation->UniquifyName(&computation_name_uniquer());\n   }\n \n   absl::Status CheckUniqueNamesAndIdsForComputationsAndInstructions() const;\n@@ -736,6 +744,12 @@ class HloModule {\n   // Getter for the specific stack frame. Argument is a 1-based index.\n   StackFrame get_stack_frame(int id) const;\n \n+  // Finalizes this module by destroying internal data structures that might be\n+  // used for building or modifying the module. It is undefined behavior to\n+  // modify the module (add computations or instructions) after the call. Should\n+  // be called once, after HLO module is compiled to executable.\n+  void Finalize();\n+\n  private:\n   friend class HloComputation;\n \n@@ -766,9 +780,9 @@ class HloModule {\n   mutable absl::Mutex rng_mutex_;\n \n   // Unique name generator for computation and instruction names, which are\n-  // unique per module.\n-  NameUniquer computation_name_uniquer_{/*separator=*/\".\"};\n-  NameUniquer instruction_name_uniquer_{/*separator=*/\".\"};\n+  // unique per module. Will be reset to nullopt when Finalize() is called.\n+  std::optional<NameUniquer> computation_name_uniquer_{/*separator=*/\".\"};\n+  std::optional<NameUniquer> instruction_name_uniquer_{/*separator=*/\".\"};\n   int64_t next_unique_id_ = 0;\n \n   // Used to keep track of the next unique module id that should be assigned."
        },
        {
            "sha": "1e644469167ac7230903d49f88853d1757319e99",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/045fda49f2563c68de9683b1f8170079c4d04c6b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/045fda49f2563c68de9683b1f8170079c4d04c6b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc?ref=045fda49f2563c68de9683b1f8170079c4d04c6b",
            "patch": "@@ -561,7 +561,12 @@ int64_t CpuExecutable::SizeOfGeneratedCodeInBytes() const {\n   return 0;\n }\n \n-void CpuExecutable::Finalize() { assignment_->Finalize(); }\n+void CpuExecutable::Finalize() {\n+  if (has_module()) {\n+    shared_module()->Finalize();\n+  }\n+  assignment_->Finalize();\n+}\n \n }  // namespace cpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 38,
        "deletions": 14
    }
}