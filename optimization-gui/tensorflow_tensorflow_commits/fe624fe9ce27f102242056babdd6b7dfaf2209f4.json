{
    "author": "GleasonK",
    "message": "[StableHLO->HLO] Only lower MHLO constants in MHLO prepare for export pass.\n\nPiperOrigin-RevId: 822198262",
    "sha": "fe624fe9ce27f102242056babdd6b7dfaf2209f4",
    "files": [
        {
            "sha": "265bb8f4cac0eacb323dc3fe7d7645647d2e49aa",
            "filename": "third_party/xla/xla/mlir_hlo/mhlo/transforms/prepare_for_export/prepare_for_export.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fe624fe9ce27f102242056babdd6b7dfaf2209f4/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Fmhlo%2Ftransforms%2Fprepare_for_export%2Fprepare_for_export.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fe624fe9ce27f102242056babdd6b7dfaf2209f4/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Fmhlo%2Ftransforms%2Fprepare_for_export%2Fprepare_for_export.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Fmhlo%2Ftransforms%2Fprepare_for_export%2Fprepare_for_export.cc?ref=fe624fe9ce27f102242056babdd6b7dfaf2209f4",
            "patch": "@@ -130,7 +130,8 @@ void prepareExplicitCapturedConstants(Operation* op) {\n       // it explicit and replace uses within the block\n       Operation *definingOp = input.getDefiningOp();\n       mlir::DenseElementsAttr attr;\n-      if (matchPattern(input, m_Constant(&attr))) {\n+      if (mlir::isa_and_present<ConstantOp>(input.getDefiningOp()) &&\n+          matchPattern(input, m_Constant(&attr))) {\n         Operation *clonedOp = builder.clone(*definingOp);\n         // Find which uses belong to the block and replace\n         // with the cloned/explicit one\n@@ -146,9 +147,10 @@ void prepareExplicitCapturedConstants(Operation* op) {\n }  // namespace\n \n void PrepareForExportPass::runOnOperation() {\n-  getOperation().walk([&](Operation *op) {\n+  getOperation().walk([&](Operation* op) {\n     mlir::SplatElementsAttr attr;\n-    if (matchPattern(op, m_Constant(&attr))) return prepareConstantOp(op, attr);\n+    if (isa<ConstantOp>(op) && matchPattern(op, m_Constant(&attr)))\n+      return prepareConstantOp(op, attr);\n \n     if (auto bcastOp = dyn_cast<BroadcastInDimOp>(op))\n       return prepareBroadcastInDim(bcastOp);"
        },
        {
            "sha": "9bc777043898b5e1b935a52d3de5097925269583",
            "filename": "third_party/xla/xla/mlir_hlo/tests/Dialect/mhlo/prepare-for-export.mlir",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fe624fe9ce27f102242056babdd6b7dfaf2209f4/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fmhlo%2Fprepare-for-export.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fe624fe9ce27f102242056babdd6b7dfaf2209f4/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fmhlo%2Fprepare-for-export.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fmhlo%2Fprepare-for-export.mlir?ref=fe624fe9ce27f102242056babdd6b7dfaf2209f4",
            "patch": "@@ -11,6 +11,16 @@ func.func @splat_constants() -> tensor<1x64x224x224xf32> {\n \n // -----\n \n+// CHECK-LABEL: @non_mhlo_constant\n+func.func @non_mhlo_constant() -> tensor<128x1014x508xcomplex<f64>> {\n+// CHECK:     arith.constant dense<(1.000000e+00,2.000000e+00)> : tensor<128x1014x508xcomplex<f64>>\n+// CHECK-NOT: mhlo.broadcast_in_dim\n+  %0 = arith.constant dense<(1.000000e+00,2.000000e+00)> : tensor<128x1014x508xcomplex<f64>>\n+  func.return %0 : tensor<128x1014x508xcomplex<f64>>\n+}\n+\n+// -----\n+\n // CHECK-LABEL: @splat_constant_complex_float\n func.func @splat_constant_complex_float() -> tensor<128x1014x508xcomplex<f64>> {\n // CHECK: %[[CST:.*]] = mhlo.constant dense<(1.000000e+00,2.000000e+00)> : tensor<complex<f64>>"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 15,
        "deletions": 3
    }
}