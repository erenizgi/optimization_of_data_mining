{
    "author": "hhb",
    "message": "Create extension for TPU callbacks\n\nPiperOrigin-RevId: 810178459",
    "sha": "37b4d1a9b367776e573ea6748033ada07e10e47e",
    "files": [
        {
            "sha": "6df2dedfd57b9879111118897d8ef4ae573b6514",
            "filename": "third_party/xla/xla/pjrt/c/BUILD",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/37b4d1a9b367776e573ea6748033ada07e10e47e/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/37b4d1a9b367776e573ea6748033ada07e10e47e/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FBUILD?ref=37b4d1a9b367776e573ea6748033ada07e10e47e",
            "patch": "@@ -49,6 +49,22 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"pjrt_c_api_callback_extension_hdrs\",\n+    hdrs = [\"pjrt_c_api_callback_extension.h\"],\n+    deps = [\n+        \"//xla:shape_util\",\n+        \"//xla/pjrt:pjrt_client\",\n+        \"//xla/pjrt:pjrt_future\",\n+        \"//xla/pjrt/c:pjrt_c_api_hdrs\",\n+        \"//xla/pjrt/c:pjrt_c_api_helpers\",\n+        \"//xla/pjrt/c:pjrt_c_api_wrapper_impl\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)\n+\n cc_library(\n     name = \"pjrt_c_api_ffi_extension_hdrs\",\n     hdrs = [\"pjrt_c_api_ffi_extension.h\"],"
        },
        {
            "sha": "bc2c116e323d9ef1bb5048567c86f2f0e8ef0579",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/37b4d1a9b367776e573ea6748033ada07e10e47e/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/37b4d1a9b367776e573ea6748033ada07e10e47e/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h?ref=37b4d1a9b367776e573ea6748033ada07e10e47e",
            "patch": "@@ -67,6 +67,7 @@ typedef enum {\n   PJRT_Extension_Type_Unknown,\n   PJRT_Extension_Type_CrossHostTransfers,\n   PJRT_Extension_Type_ExecutableMetadata,\n+  PJRT_Extension_Type_Callback,\n } PJRT_Extension_Type;\n \n // PJRT_Extension_Base contains a type and a pointer to next"
        },
        {
            "sha": "4f2a66d7710d63649e7f9fdbaac4fa5a52b930fc",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_callback_extension.h",
            "status": "added",
            "additions": 146,
            "deletions": 0,
            "changes": 146,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/37b4d1a9b367776e573ea6748033ada07e10e47e/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_callback_extension.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/37b4d1a9b367776e573ea6748033ada07e10e47e/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_callback_extension.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_callback_extension.h?ref=37b4d1a9b367776e573ea6748033ada07e10e47e",
            "patch": "@@ -0,0 +1,146 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PJRT_C_PJRT_C_API_CALLBACK_EXTENSION_H_\n+#define XLA_PJRT_C_PJRT_C_API_CALLBACK_EXTENSION_H_\n+\n+#include <stddef.h>\n+#include <stdint.h>\n+\n+#include \"xla/pjrt/c/pjrt_c_api.h\"\n+\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+\n+// This extension provides functionality for registering callbacks.\n+\n+#define PJRT_API_CALLBACK_EXTENSION_VERSION 1\n+\n+// ------------------------------ Callback types ------------------------------\n+\n+enum PJRT_Callback_Type {\n+  PJRT_Callback_Type_Unknown,\n+  PJRT_Callback_Type_Tpu_SliceBuilder,\n+  PJRT_Callback_Type_Prefatal,\n+};\n+\n+// A TPU ICI Slice's failure as captured by SliceBuilder. The failure detected\n+// could be because of software, hardware, or firmware issues. It surfaces to\n+// SliceBuilder via software polling APIs.\n+#ifdef __cplusplus\n+enum class PJRT_Callback_Tpu_SliceFailureType : int32_t {\n+#else\n+enum PJRT_Callback_Tpu_SliceFailureType : int32_t {\n+#endif\n+\n+  // An undefined slice failure.\n+  SLICE_FAILURE_UNKNOWN = 0,\n+\n+  // Slice failure during slice initialization (ICI network config) phase.\n+  SLICE_FAILURE_INIT_ERROR = 1,\n+\n+  // Slice failure when a worker is disconnected from the rest of the job\n+  // after\n+  // the heartbeat check threshold is reached.\n+  SLICE_FAILURE_WORKER_UNAVAILABLE = 2,\n+\n+  // Slice failure due to a flapping task, potentially caused by fast task\n+  // restart, which leads to mis-configuring a previous built slice in a job.\n+  // This failure scenario is amenable to job quick_exit.\n+  SLICE_FAILURE_FLAPPING_TASK_ERROR = 3,\n+\n+  // Slice failure injected by software, e.g., from the TPU runtime to mimic\n+  // slice hardware error for various control actions, or for testing purpose.\n+  SLICE_FAILURE_SW_INJECT_ERROR = 4,\n+\n+  // Slice failure due to a chip driver reporting some error (could correspond\n+  // to bad TPU or ICI link going down) as perceived from SliceBuilder\n+  // software polling after the slice has been successfully built.\n+  SLICE_FAILURE_CHIP_DRIVER_ERROR = 5\n+};\n+\n+struct PJRT_Callback_Tpu_SliceBuilderArgs {\n+  size_t struct_size;\n+  PJRT_Callback_Tpu_SliceFailureType failure_type;\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Callback_Tpu_SliceBuilderArgs, failure_type);\n+\n+struct PJRT_Callback_PrefatalArgs {\n+  size_t struct_size;\n+\n+  PJRT_Error_Code error_code;\n+\n+  // The error message is only valid for the duration of the callback.\n+  const char* error_message;\n+  size_t error_message_size;\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Callback_PrefatalArgs, error_message_size);\n+\n+// ---------------------------------- Methods ----------------------------------\n+\n+// The type of a callback function. The first argument is the callback type\n+// specific arguments, and the second argument is the user provided argument.\n+typedef void PJRT_Callback_Function(void* args, void* user_arg);\n+typedef struct PJRT_Callback_RegisterCallback_Args {\n+  size_t struct_size;\n+  PJRT_Client* client;\n+\n+  // The type of callback to be registered.\n+  PJRT_Callback_Type type;\n+\n+  // The callback to be registered.\n+  PJRT_Callback_Function* callback;\n+\n+  // The user argument to be passed to the callback.\n+  void* user_arg;\n+} PJRT_Callback_RegisterCallback_Args;\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Callback_RegisterCallback_Args, user_arg);\n+\n+// Registers a callback.\n+typedef PJRT_Error* PJRT_Register_Callback(\n+    PJRT_Callback_RegisterCallback_Args* args);\n+\n+typedef struct PJRT_Callback_InvokeCallback_Args {\n+  size_t struct_size;\n+  PJRT_Client* client;\n+\n+  // The type of callback to be registered.\n+  PJRT_Callback_Type type;\n+\n+  // The callback type specific arguments. The registered callbacks are invoked\n+  // synchronously, so `args` needs to be valid for the duration of the\n+  // `PJRT_Callback_InvokeCallback` call.\n+  void* args;\n+} PJRT_Callback_InvokeCallback_Args;\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Callback_InvokeCallback_Args, args);\n+\n+typedef PJRT_Error* PJRT_Callback_InvokeCallback(\n+    PJRT_Callback_InvokeCallback_Args* args);\n+\n+// --------------------------- Extension entrypoint ----------------------------\n+\n+typedef struct PJRT_Callback_Extension {\n+  PJRT_Extension_Base base;\n+  PJRT_Register_Callback* register_callback;\n+  PJRT_Callback_InvokeCallback* invoke_callback;\n+} PJRT_Callback_Extension;\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Callback_Extension, invoke_callback);\n+\n+#ifdef __cplusplus\n+}\n+#endif\n+\n+#endif  // XLA_PJRT_C_PJRT_C_API_CALLBACK_EXTENSION_H_"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 163,
        "deletions": 0
    }
}