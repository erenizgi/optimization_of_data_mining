{
    "author": "thomasjoerg",
    "message": "[XLA:GPU] DotMerger: Stop merging when dots have become too large. Perform expensive reachability checks last.\n\nPiperOrigin-RevId: 843157999",
    "sha": "f6d55d77560fa15908fd811ad59c9a587e108b19",
    "files": [
        {
            "sha": "dc55e09dbdb953ef220ee5e209bb7b8c38058596",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/dot_merger.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f6d55d77560fa15908fd811ad59c9a587e108b19/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fdot_merger.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f6d55d77560fa15908fd811ad59c9a587e108b19/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fdot_merger.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fdot_merger.cc?ref=f6d55d77560fa15908fd811ad59c9a587e108b19",
            "patch": "@@ -473,6 +473,9 @@ absl::StatusOr<bool> MergeDots(HloComputation* comp, int64_t max_size_to_merge,\n     return false;\n   }\n \n+  VLOG(0) << \"Merging Dots in computation: \" << comp->name();\n+  VLOG(1) << \"Found \" << equivalence_classes.size() << \" equivalence classes.\";\n+\n   // Build a dependency graph representing the whole computation.\n   GraphCycles graph;\n \n@@ -537,9 +540,10 @@ absl::StatusOr<bool> MergeDots(HloComputation* comp, int64_t max_size_to_merge,\n \n         if (dead_instrs.contains(a) || dead_instrs.contains(b) ||\n             (!is_merge_candidate(a) && !is_merge_candidate(b)) ||\n+            !can_merge(a, b) ||\n             // Perform reachability checks last since they can be expensive.\n             graph.IsReachableNonConst(a_id, b_id) ||\n-            graph.IsReachableNonConst(b_id, a_id) || !can_merge(a, b)) {\n+            graph.IsReachableNonConst(b_id, a_id)) {\n           continue;\n         }\n \n@@ -559,6 +563,10 @@ absl::StatusOr<bool> MergeDots(HloComputation* comp, int64_t max_size_to_merge,\n           dead_instrs.insert(b);\n           dots[i] = merged;\n           dots[j] = nullptr;\n+          if (!is_merge_candidate(merged)) {\n+            // The merged dot is not a candidate for futher merging.\n+            break;\n+          }\n         }\n       }\n     }"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}