{
    "author": "LarryLansing",
    "message": "Google internal change.\n\nPiperOrigin-RevId: 832430433",
    "sha": "edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a",
    "files": [
        {
            "sha": "a302174b93cc666044c21360f2e78a3e28fd9d2f",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/tstring.h",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring.h?ref=edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <assert.h>\n \n #include <cstddef>\n+#include <optional>\n #include <ostream>\n #include <string>\n #include <utility>\n@@ -309,8 +310,16 @@ inline tstring::tstring(const absl::string_view str)\n #ifdef PLATFORM_GOOGLE\n inline tstring::tstring(const absl::Cord& cord) {\n   TF_TString_Init(&tstr_);\n+  if (cord.size() > TF_TString_SmallCapacity) {\n+    std::optional<absl::string_view> flat = cord.TryFlat();\n+    if (flat.has_value()) {\n+      auto* cord_owner = new tstring::owner<absl::Cord>(cord);\n+      assign_as_shared_view(*flat, cord_owner);\n+      cord_owner->Unref();\n+      return;\n+    }\n+  }\n   TF_TString_ResizeUninitialized(&tstr_, cord.size());\n-\n   cord.CopyToArray(data());\n }\n #endif  // PLATFORM_GOOGLE\n@@ -367,10 +376,17 @@ inline tstring& tstring::operator=(const absl::string_view str) {\n \n #ifdef PLATFORM_GOOGLE\n inline tstring& tstring::operator=(const absl::Cord& cord) {\n+  if (cord.size() > TF_TString_SmallCapacity) {\n+    std::optional<absl::string_view> flat = cord.TryFlat();\n+    if (flat.has_value()) {\n+      auto* cord_owner = new tstring::owner<absl::Cord>(cord);\n+      assign_as_shared_view(*flat, cord_owner);\n+      cord_owner->Unref();\n+      return *this;\n+    }\n+  }\n   TF_TString_ResizeUninitialized(&tstr_, cord.size());\n-\n   cord.CopyToArray(data());\n-\n   return *this;\n }\n #endif  // PLATFORM_GOOGLE\n@@ -547,15 +563,15 @@ inline tstring& tstring::assign_as_view(const char* str) {\n \n template <typename T>\n inline tstring& tstring::assign_as_shared_view(const absl::string_view str,\n-                                        tstring::owner<T>* owner) {\n+                                               tstring::owner<T>* owner) {\n   TF_TString_AssignViewWithOwner(&tstr_, str.data(), str.size(),\n                                  owner ? &owner->capi_ : nullptr);\n   return *this;\n }\n \n template <typename T>\n inline tstring& tstring::assign_as_shared_view(const char* str, size_t len,\n-                                        tstring::owner<T>* owner) {\n+                                               tstring::owner<T>* owner) {\n   TF_TString_AssignViewWithOwner(&tstr_, str, len,\n                                  owner ? &owner->capi_ : nullptr);\n   return *this;"
        },
        {
            "sha": "16118d88953e607add94655130a600c4dc0c269f",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/tstring_test.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring_test.cc?ref=edb9a9b86d16a5d7bab6deb4c5afcc75bb0aad8a",
            "patch": "@@ -183,15 +183,29 @@ TEST(TF_TStringTest, Assignment) {\n #ifdef PLATFORM_GOOGLE\n   s33 = absl::Cord(kLongString);\n \n+  // Check flat cord.\n   EXPECT_EQ(kLongString, s33);\n-  EXPECT_EQ(tstring::Type::LARGE, s33.type());\n+  EXPECT_EQ(tstring::Type::VIEW, s33.type());\n   EXPECT_EQ(kLongStringLen, s33.size());\n \n   tstring s34((absl::Cord(kLongString)));\n \n   EXPECT_EQ(kLongString, s34);\n-  EXPECT_EQ(tstring::Type::LARGE, s34.type());\n+  EXPECT_EQ(tstring::Type::VIEW, s34.type());\n   EXPECT_EQ(kLongStringLen, s34.size());\n+\n+  // Check non-flat cord.\n+  absl::Cord c1(kLongString);\n+  absl::Cord c2(std::string(500, 'x'));\n+  c1.Append(c2);\n+  if (!c1.TryFlat()) {\n+    tstring s35(c1);\n+    EXPECT_EQ(tstring::Type::LARGE, s35.type());\n+    EXPECT_EQ(c1.size(), s35.size());\n+    s33 = c1;\n+    EXPECT_EQ(tstring::Type::LARGE, s33.type());\n+    EXPECT_EQ(c1.size(), s33.size());\n+  }\n #endif  // PLATFORM_GOOGLE\n }\n "
        }
    ],
    "stats": {
        "total": 44,
        "additions": 37,
        "deletions": 7
    }
}