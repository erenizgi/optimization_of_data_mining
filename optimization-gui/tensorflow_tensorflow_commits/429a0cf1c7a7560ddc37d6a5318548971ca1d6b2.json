{
    "author": "ezhulenev",
    "message": "[xla:cpu] Add target machine features to the error message\n\nPiperOrigin-RevId: 826253599",
    "sha": "429a0cf1c7a7560ddc37d6a5318548971ca1d6b2",
    "files": [
        {
            "sha": "daed5024ae60129b43768daf9cde3633efb4c387",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/429a0cf1c7a7560ddc37d6a5318548971ca1d6b2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/429a0cf1c7a7560ddc37d6a5318548971ca1d6b2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=429a0cf1c7a7560ddc37d6a5318548971ca1d6b2",
            "patch": "@@ -2177,6 +2177,7 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:Target\","
        },
        {
            "sha": "e968b76f0692d19475d4f9bbf43c89803cf5e54f",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/429a0cf1c7a7560ddc37d6a5318548971ca1d6b2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/429a0cf1c7a7560ddc37d6a5318548971ca1d6b2/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc?ref=429a0cf1c7a7560ddc37d6a5318548971ca1d6b2",
            "patch": "@@ -23,7 +23,9 @@ limitations under the License.\n \n #include \"absl/log/log.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_join.h\"\n #include \"absl/strings/str_split.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/StringRef.h\"\n #include \"llvm/IR/DataLayout.h\"\n@@ -185,18 +187,28 @@ CpuAotLoader::LoadAotCompilationResult(\n                     expected_triple.getArchName(), triple.getArchName());\n   }\n \n+  llvm::StringMap<bool> host_machine_features = llvm::sys::getHostCPUFeatures();\n   auto compile_machine_features =\n       absl::StrSplit(aot_result_proto.target_machine_options().features(), ',');\n \n-  auto host_machine_features = llvm::sys::getHostCPUFeatures();\n-\n-  for (const auto& feature : compile_machine_features) {\n+  for (const absl::string_view feature : compile_machine_features) {\n     if (!host_machine_features.contains(feature) ||\n         !host_machine_features[feature]) {\n+      // Convert the supported features to a vector of strings.\n+      std::vector<std::string> host_machine_features_vector;\n+      for (const auto& [feature, supported] : host_machine_features) {\n+        if (supported) {\n+          host_machine_features_vector.push_back(feature.str());\n+        }\n+      }\n+\n       return Internal(\n-          \"Cannot load AOT result. Target machine feature %s is not supported \"\n-          \"on the host machine.\",\n-          feature);\n+          \"Cannot load XLA:CPU AOT result. Target machine feature %s is not \"\n+          \"supported on the host machine. Machine type used for XLA:CPU \"\n+          \"compilation doesn't match the machine type for execution. Compile \"\n+          \"machine features: [%s] vs host machine features: [%s]\",\n+          feature, absl::StrJoin(compile_machine_features, \",\"),\n+          absl::StrJoin(host_machine_features_vector, \",\"));\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 25,
        "additions": 19,
        "deletions": 6
    }
}