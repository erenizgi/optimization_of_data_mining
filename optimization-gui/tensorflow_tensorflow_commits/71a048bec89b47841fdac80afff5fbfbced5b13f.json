{
    "author": "ICGog",
    "message": "[IFRT IR] Do not register all mlir dialects as only FuncDialect and ShapeDialect are necessary\n\nPiperOrigin-RevId: 806477953",
    "sha": "71a048bec89b47841fdac80afff5fbfbced5b13f",
    "files": [
        {
            "sha": "0dd7ccecd5204c2d200caa27b3bc0f8960367322",
            "filename": "third_party/xla/xla/python/ifrt/ir/tests/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2FBUILD?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -54,10 +54,10 @@ xla_cc_binary(\n         \"@com_google_googletest//:gtest\",\n         \"@llvm-project//mlir:AllPassesAndDialects\",\n         \"@llvm-project//mlir:IR\",\n+        \"@llvm-project//mlir:MathDialect\",\n         \"@llvm-project//mlir:MlirOptLib\",\n-        \"@llvm-project//mlir:RegisterAllDialects\",\n-        \"@llvm-project//mlir:RegisterAllExtensions\",\n-        \"@llvm-project//mlir:RegisterAllPasses\",\n+        \"@llvm-project//mlir:RegisterAllDialects\",  # buildcleaner: keep\n+        \"@llvm-project//mlir:RegisterAllPasses\",  # buildcleaner: keep\n         \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:platform_port\",\n     ],\n@@ -78,6 +78,7 @@ xla_cc_binary(\n         \"@com_google_absl//absl/strings\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:AllPassesAndDialects\",\n+        \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:Pass\",\n         \"@llvm-project//mlir:Support\","
        },
        {
            "sha": "33ec942ef8fda2fbbe7b2b68742ae462d7d5d071",
            "filename": "third_party/xla/xla/python/ifrt/ir/tests/ifrt-opt.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2Fifrt-opt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2Fifrt-opt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2Fifrt-opt.cc?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n+#include \"mlir/Dialect/Math/IR/Math.h\"\n #include \"mlir/IR/DialectRegistry.h\"\n #include \"mlir/InitAllPasses.h\"\n #include \"mlir/Tools/mlir-opt/MlirOptMain.h\"\n@@ -153,6 +154,8 @@ int main(int argc, char** argv) {\n       compiler, compile_options, atom_executable_map, bound_executable_map);\n   mlir::DialectRegistry registry;\n   xla::ifrt::support::InitializeMlirDialectRegistry(registry);\n+  // Register dialects that are only used in the MLIR lit tests.\n+  registry.insert<mlir::math::MathDialect>();\n \n   return mlir::asMainReturnCode(\n       mlir::MlirOptMain(argc, argv, \"IFRT IR dialect driver\\n\", registry));"
        },
        {
            "sha": "dc46aa47b944ae7ae33c4f6d18e624b95e4183da",
            "filename": "third_party/xla/xla/python/ifrt/ir/tests/ifrt-translate.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 17,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2Fifrt-translate.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2Fifrt-translate.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftests%2Fifrt-translate.cc?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include \"llvm/Support/CommandLine.h\"\n #include \"llvm/Support/Debug.h\"\n #include \"llvm/Support/raw_ostream.h\"\n+#include \"mlir/Dialect/Func/IR/FuncOps.h\"\n #include \"mlir/IR/BuiltinOps.h\"\n #include \"mlir/IR/MLIRContext.h\"\n #include \"mlir/InitAllDialects.h\"\n@@ -58,7 +59,7 @@ llvm::cl::opt<std::string> atom_program_version_option(\n \n mlir::TranslateFromMLIRRegistration serializeRegistration(\n     \"serialize\", \"Serialize IFRT IR program into a VIFRT artifact\",\n-    [](mlir::ModuleOp module, llvm::raw_ostream &os) -> mlir::LogicalResult {\n+    [](mlir::ModuleOp module, llvm::raw_ostream& os) -> mlir::LogicalResult {\n       std::string ifrt_version = ifrt_version_option.getValue();\n       if (ifrt_version == \"current\") {\n         ifrt_version = Version::getCurrentVersion().toString();\n@@ -71,8 +72,9 @@ mlir::TranslateFromMLIRRegistration serializeRegistration(\n       if (strip_debug_info_option) {\n         mlir::PassManager pm(module->getContext());\n         pm.addPass(mlir::createStripDebugInfoPass());\n-        if (mlir::failed(pm.run(module)))\n+        if (mlir::failed(pm.run(module))) {\n           return module.emitError(\"failed to strip debuginfo\");\n+        }\n       }\n \n       auto program = std::make_unique<IfrtIRProgram>(module);\n@@ -82,23 +84,20 @@ mlir::TranslateFromMLIRRegistration serializeRegistration(\n       if (serialized_or.ok()) {\n         os << serialized_or->SerializeAsString();\n         return mlir::success();\n-      } else {\n-        module.emitError(absl::StrCat(\"failed to serialize: \",\n-                                      serialized_or.status().message()));\n-        return mlir::failure();\n       }\n+      module.emitError(absl::StrCat(\"failed to serialize: \",\n+                                    serialized_or.status().message()));\n+      return mlir::failure();\n     },\n-    [](mlir::DialectRegistry &registry) {\n-      mlir::registerAllDialects(registry);\n+    [](mlir::DialectRegistry& registry) {\n       mlir::stablehlo::registerAllDialects(registry);\n-      registry.insert<xla::ifrt::IfrtDialect>();\n-      registry.insert<xla::ifrt::VifrtDialect>();\n+      registry.insert<IfrtDialect, VifrtDialect, mlir::func::FuncDialect>();\n     });\n \n mlir::TranslateToMLIRRegistration deserializeRegistration(\n     \"deserialize\", \"Deserialize VIFRT into an IFRT IR program\",\n     [](llvm::StringRef input,\n-       mlir::MLIRContext *context) -> mlir::OwningOpRef<mlir::ModuleOp> {\n+       mlir::MLIRContext* context) -> mlir::OwningOpRef<mlir::ModuleOp> {\n       Serialized serialized_proto;\n       if (!serialized_proto.ParseFromString(std::string(input))) {\n         return nullptr;\n@@ -109,14 +108,12 @@ mlir::TranslateToMLIRRegistration deserializeRegistration(\n       if (deserialized_program_or.ok()) {\n         return mlir::OwningOpRef<mlir::ModuleOp>(\n             deserialized_program_or.value()->mlir_module);\n-      } else {\n-        llvm::dbgs() << \"failed to deserialize: \"\n-                     << deserialized_program_or.status().message() << \"\\n\";\n-        return nullptr;\n       }\n+      llvm::dbgs() << \"failed to deserialize: \"\n+                   << deserialized_program_or.status().message() << \"\\n\";\n+      return nullptr;\n     },\n-    [](mlir::DialectRegistry &registry) {\n-      mlir::registerAllDialects(registry);\n+    [](mlir::DialectRegistry& registry) {\n       mlir::stablehlo::registerAllDialects(registry);\n       registry.insert<xla::ifrt::IfrtDialect>();\n       registry.insert<xla::ifrt::VifrtDialect>();"
        },
        {
            "sha": "43b9cbfe05837545bba17a2503ebde4dd4fb4799",
            "filename": "third_party/xla/xla/python/ifrt/ir/transforms/ifrt_atom_programs_from_vhlo_pass.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_atom_programs_from_vhlo_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_atom_programs_from_vhlo_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_atom_programs_from_vhlo_pass.cc?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -54,7 +54,6 @@ class IfrtAtomProgramsFromVhloPass\n   }\n \n   void getDependentDialects(::mlir::DialectRegistry& registry) const override {\n-    mlir::registerAllDialects(registry);\n     mlir::stablehlo::registerAllDialects(registry);\n   }\n "
        },
        {
            "sha": "e3aca5ddfaf61d442c31290b4a46503a3a7e51a5",
            "filename": "third_party/xla/xla/python/ifrt/ir/transforms/ifrt_atom_programs_to_vhlo_pass.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_atom_programs_to_vhlo_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_atom_programs_to_vhlo_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Ftransforms%2Fifrt_atom_programs_to_vhlo_pass.cc?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -71,7 +71,6 @@ class IfrtAtomProgramsToVhloPass\n   }\n \n   void getDependentDialects(::mlir::DialectRegistry& registry) const override {\n-    mlir::registerAllDialects(registry);\n     mlir::stablehlo::registerAllDialects(registry);\n   }\n "
        },
        {
            "sha": "2e7b5a7ae729d3ac36310ae5da3c9629b0b42223",
            "filename": "third_party/xla/xla/python/ifrt/support/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsupport%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsupport%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsupport%2FBUILD?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -24,10 +24,11 @@ cc_library(\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@llvm-project//mlir:AllPassesAndDialects\",\n+        \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:FuncExtensions\",\n         \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:Parser\",\n-        \"@llvm-project//mlir:RegisterAllDialects\",\n+        \"@llvm-project//mlir:ShapeDialect\",\n         \"@shardy//shardy/dialect/sdy/ir:register\",\n         \"@stablehlo//:register\",\n     ],"
        },
        {
            "sha": "06ade8c9140e6fbaf54e72bebb55555b6d1ce9b6",
            "filename": "third_party/xla/xla/python/ifrt/support/module_parsing.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsupport%2Fmodule_parsing.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71a048bec89b47841fdac80afff5fbfbced5b13f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsupport%2Fmodule_parsing.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsupport%2Fmodule_parsing.cc?ref=71a048bec89b47841fdac80afff5fbfbced5b13f",
            "patch": "@@ -20,6 +20,8 @@ limitations under the License.\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n #include \"mlir/Dialect/Func/Extensions/AllExtensions.h\"\n+#include \"mlir/Dialect/Func/IR/FuncOps.h\"\n+#include \"mlir/Dialect/Shape/IR/Shape.h\"\n #include \"mlir/IR/BuiltinOps.h\"\n #include \"mlir/IR/MLIRContext.h\"\n #include \"mlir/IR/OwningOpRef.h\"\n@@ -38,9 +40,8 @@ namespace ifrt {\n namespace support {\n \n void InitializeMlirDialectRegistry(mlir::DialectRegistry& registry) {\n-  registry.insert<xla::ifrt::IfrtDialect>();\n-  registry.insert<xla::ifrt::VifrtDialect>();\n-  mlir::registerAllDialects(registry);\n+  registry.insert<IfrtDialect, VifrtDialect, mlir::func::FuncDialect,\n+                  mlir::shape::ShapeDialect>();\n   mlir::func::registerAllExtensions(registry);\n   mlir::mhlo::registerAllMhloDialects(registry);\n   mlir::sdy::registerAllDialects(registry);"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 27,
        "deletions": 26
    }
}