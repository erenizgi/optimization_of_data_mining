{
    "author": "sohaibiftikhar",
    "message": "[XLA:GPU]: Add support for loading HLO directly from profiler to graphviz\n\nNo change to the OSS version for this tool.\n\nPiperOrigin-RevId: 817546670",
    "sha": "197b1c2454e94c9ba1e1eac14063c2c242716527",
    "files": [
        {
            "sha": "9400a61805db20e7757b0d96dd0379203865df3b",
            "filename": "third_party/xla/xla/tools/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2FBUILD?ref=197b1c2454e94c9ba1e1eac14063c2c242716527",
            "patch": "@@ -311,6 +311,7 @@ xla_cc_binary(\n         \":hlo_extractor\",\n         \"//xla:debug_options_flags\",\n         \"//xla:shape_util\",\n+        \"//xla:util\",\n         \"//xla/client:client_library\",\n         \"//xla/client:local_client\",\n         \"//xla/hlo/ir:hlo\",\n@@ -324,19 +325,23 @@ xla_cc_binary(\n         \"//xla/service:platform_util\",\n         \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:stream_executor_h\",\n+        \"//xla/tools/platform:xprof_loader\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:status\",\n+        \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:subprocess\",\n         \"//xla/tsl/protobuf:error_codes_proto_impl_cc\",\n         \"//xla/tsl/util:command_line_flags\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/types:span\",\n+        \"@local_tsl//tsl/platform\",\n         \"@local_tsl//tsl/platform:logging\",\n         \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:platform_port\","
        },
        {
            "sha": "1740f34e844708a8ec835f0a8141e66eeb97e2cf",
            "filename": "third_party/xla/xla/tools/interactive_graphviz.cc",
            "status": "modified",
            "additions": 63,
            "deletions": 12,
            "changes": 75,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Finteractive_graphviz.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Finteractive_graphviz.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Finteractive_graphviz.cc?ref=197b1c2454e94c9ba1e1eac14063c2c242716527",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include <cstdint>\n #include <iostream>\n #include <memory>\n+#include <optional>\n #include <ostream>\n #include <string>\n #include <utility>\n@@ -38,6 +39,7 @@ limitations under the License.\n #include \"absl/algorithm/container.h\"\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/match.h\"\n #include \"absl/strings/numbers.h\"\n@@ -61,14 +63,18 @@ limitations under the License.\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/stream_executor.h\"\n #include \"xla/tools/hlo_extractor.h\"\n+#include \"xla/tools/platform/xprof_loader.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/status.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/subprocess.h\"\n #include \"xla/tsl/protobuf/error_codes.pb.h\"\n #include \"xla/tsl/util/command_line_flags.h\"\n+#include \"xla/util.h\"\n #include \"tsl/platform/init_main.h\"\n #include \"tsl/platform/path.h\"\n+#include \"tsl/platform/platform.h\"\n #if defined(PLATFORM_GOOGLE)\n #include \"util/readline/readline.h\"\n #endif\n@@ -99,8 +105,12 @@ struct Options {\n   std::string hlo_proto;\n   std::string hlo_module_proto;\n   std::string hlo_text;\n+  std::string xprof_session_id;\n+  int64_t xprof_hlo_program_id{-1};  // -1 means use the biggest HLO module.\n   std::string platform;\n   std::string browser;\n+  // Help flag to print usage.\n+  bool help{false};\n };\n \n const char* const kUsage = R\"(\n@@ -692,6 +702,21 @@ void InteractiveDumpGraphs(const Options& opts, const HloModule& module) {\n   }\n }\n \n+absl::StatusOr<std::unique_ptr<HloModule>> ReadModuleFromXprof(\n+    std::string xprof_session_id, int64_t xprof_hlo_program_id,\n+    const DebugOptions& debug_options) {\n+  std::cout << \"Reading module from Xprof session: \" << xprof_session_id\n+            << std::endl;\n+  XLA_SCOPED_LOGGING_TIMER_LEVEL(\"ReadModuleFromXprof\", 0);\n+  const std::optional<uint64_t> xprof_hlo_program_id_optional =\n+      xprof_hlo_program_id >= 0 ? std::make_optional(xprof_hlo_program_id)\n+                                : std::nullopt;\n+  TF_ASSIGN_OR_RETURN(\n+      auto hlo_module_proto,\n+      LoadHloModuleFromXprof(xprof_session_id, xprof_hlo_program_id_optional));\n+  return CreateModuleFromProto(hlo_module_proto, debug_options);\n+}\n+\n void CheckFlags(const Options& opts) {\n   int nonempty_flags_amount = 0;\n   if (!opts.hlo_proto.empty()) {\n@@ -706,11 +731,15 @@ void CheckFlags(const Options& opts) {\n   if (!opts.hlo_module_proto.empty()) {\n     ++nonempty_flags_amount;\n   }\n+  if (!opts.xprof_session_id.empty()) {\n+    ++nonempty_flags_amount;\n+  }\n   if (nonempty_flags_amount == 1) {\n     return;\n   }\n   LOG(FATAL) << \"Can only specify one and only one of '--hlo_proto', \"\n-                \"'--hlo_snapshot', '--hlo_text', '--hlo_module_proto' flags.\";\n+                \"'--hlo_snapshot', '--hlo_text', '--hlo_module_proto' or \"\n+                \"'--xprof_session_id' flags.\";\n }\n \n void RealMain(const Options& opts) {\n@@ -747,6 +776,11 @@ void RealMain(const Options& opts) {\n     module = ReadModuleFromModuleBinaryProtofile(\n                  opts.hlo_module_proto, xla::GetDebugOptionsFromFlags())\n                  .value();\n+  } else if (!opts.xprof_session_id.empty()) {\n+    module =\n+        ReadModuleFromXprof(opts.xprof_session_id, opts.xprof_hlo_program_id,\n+                            xla::GetDebugOptionsFromFlags())\n+            .value();\n   }\n \n   // If a platform was specified, compile the module for that platform.\n@@ -771,15 +805,8 @@ void RealMain(const Options& opts) {\n   }\n }\n \n-}  // namespace\n-}  // namespace tools\n-}  // namespace xla\n-\n-int main(int argc, char** argv) {\n-  xla::tools::Options opts;\n-  opts.browser = \"/usr/bin/sensible-browser\";\n-  bool need_help = false;\n-  const std::vector<tsl::Flag> flag_list = {\n+std::vector<tsl::Flag> GetFlagList(xla::tools::Options& opts) {\n+  std::vector<tsl::Flag> flag_list = {\n       tsl::Flag(\"hlo_snapshot\", &opts.hlo_snapshot,\n                 \"HloSnapshot proto to interactively dump to graphviz\"),\n       tsl::Flag(\"hlo_proto\", &opts.hlo_proto,\n@@ -792,12 +819,36 @@ int main(int argc, char** argv) {\n                 \"Platform to compile for: CPU, CUDA, etc\"),\n       tsl::Flag(\"browser\", &opts.browser,\n                 \"Path to web browser used to display produced graphs.\"),\n-      tsl::Flag(\"help\", &need_help, \"Prints this help message\"),\n+      tsl::Flag(\"help\", &opts.help, \"Prints this help message\"),\n   };\n+  if constexpr (!tsl::kIsOpenSource) {\n+    flag_list.push_back(\n+        tsl::Flag(\"xprof_session_id\", &opts.xprof_session_id,\n+                  \"XProf session ID to pull HLO proto from and interactively \"\n+                  \"dump to graphviz. Not valid for OSS.\"));\n+    flag_list.push_back(tsl::Flag(\n+        \"xprof_hlo_program_id\", &opts.xprof_hlo_program_id,\n+        \"The Program ID of the HLO module to pull from the XProf session. \"\n+        \"Modules in Xprof are identified by <Name>(<Id>). For example, \"\n+        \"'jit_prefill(1175)'. Here 1175 is the program id. \"\n+        \"If not specified, the tool will try to find the largest program by \"\n+        \"HLO bytes size.\"));\n+  }\n+  return flag_list;\n+}\n+\n+}  // namespace\n+}  // namespace tools\n+}  // namespace xla\n+\n+int main(int argc, char** argv) {\n+  xla::tools::Options opts;\n+  opts.browser = \"/usr/bin/sensible-browser\";\n+  const auto flag_list = xla::tools::GetFlagList(opts);\n   std::string usage = tsl::Flags::Usage(argv[0], flag_list);\n   bool parse_ok = tsl::Flags::Parse(&argc, argv, flag_list);\n   tsl::port::InitMain(argv[0], &argc, &argv);\n-  if (argc != 1 || !parse_ok || need_help) {\n+  if (argc != 1 || !parse_ok || opts.help) {\n     LOG(QFATAL) << usage;\n   }\n   xla::tools::RealMain(opts);"
        },
        {
            "sha": "9990ddcc8c99319173960c2d9aa1ed7d17e04ae1",
            "filename": "third_party/xla/xla/tools/platform/BUILD",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2FBUILD?ref=197b1c2454e94c9ba1e1eac14063c2c242716527",
            "patch": "@@ -0,0 +1,38 @@\n+load(\n+    \"//xla/tsl:tsl.bzl\",\n+    \"if_google\",\n+    \"internal_visibility\",\n+)\n+load(\n+    \"//xla/tsl/platform:rules_cc.bzl\",\n+    \"cc_library\",\n+)\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = internal_visibility(\n+        [\"//xla:__subpackages__\"],\n+    ),\n+    licenses = [\"notice\"],\n+)\n+\n+exports_files(\n+    [\"xprof_loader.h\"],\n+    visibility = internal_visibility(\n+        [\"//xla/tools/platform:__subpackages__\"],\n+    ),\n+)\n+\n+cc_library(\n+    name = \"xprof_loader\",\n+    hdrs = [\"xprof_loader.h\"],\n+    compatible_with = [],\n+    textual_hdrs = [\"xprof_loader.h\"],\n+    deps = [\n+        \"//xla/service:hlo_proto_cc\",\n+        \"@com_google_absl//absl/status:statusor\",\n+    ] + if_google(\n+        [\"//xla/tools/platform/google:xprof_loader\"],\n+        [\"//xla/tools/platform/default:xprof_loader\"],\n+    ),\n+)"
        },
        {
            "sha": "7e5424c46998965456c29e686479baa62bd54799",
            "filename": "third_party/xla/xla/tools/platform/default/BUILD",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fdefault%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fdefault%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fdefault%2FBUILD?ref=197b1c2454e94c9ba1e1eac14063c2c242716527",
            "patch": "@@ -0,0 +1,24 @@\n+load(\n+    \"//xla/tsl/platform:rules_cc.bzl\",\n+    \"cc_library\",\n+)\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = [\n+        \"//xla/tools/platform:__subpackages__\",\n+    ],\n+    licenses = [\"notice\"],\n+)\n+\n+cc_library(\n+    name = \"xprof_loader\",\n+    srcs = [\"xprof_loader.cc\"],\n+    hdrs = [\"//xla/tools/platform:xprof_loader.h\"],\n+    compatible_with = [],\n+    deps = [\n+        \"//xla/service:hlo_proto_cc\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+    ],\n+)"
        },
        {
            "sha": "4a18f9287b3f38a6d9d33a0454b1322e9e6f90c6",
            "filename": "third_party/xla/xla/tools/platform/default/xprof_loader.cc",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fdefault%2Fxprof_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fdefault%2Fxprof_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fdefault%2Fxprof_loader.cc?ref=197b1c2454e94c9ba1e1eac14063c2c242716527",
            "patch": "@@ -0,0 +1,33 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tools/platform/xprof_loader.h\"\n+\n+#include <cstdint>\n+#include <optional>\n+#include <string>\n+\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"xla/service/hlo.pb.h\"\n+\n+namespace xla {\n+\n+absl::StatusOr<HloModuleProto> LoadHloModuleFromXprof(\n+    std::string xprof_session_id,\n+    std::optional<uint64_t> xprof_hlo_program_id) {\n+  return absl::UnimplementedError(\"Not implemented for non-google platforms.\");\n+}\n+}  // namespace xla"
        },
        {
            "sha": "44050d688faf75b36a65cc28ddff28905b959c3a",
            "filename": "third_party/xla/xla/tools/platform/xprof_loader.h",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fxprof_loader.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/197b1c2454e94c9ba1e1eac14063c2c242716527/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fxprof_loader.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fplatform%2Fxprof_loader.h?ref=197b1c2454e94c9ba1e1eac14063c2c242716527",
            "patch": "@@ -0,0 +1,31 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_TOOLS_PLATFORM_XPROF_LOADER_H_\n+#define XLA_TOOLS_PLATFORM_XPROF_LOADER_H_\n+\n+#include <cstdint>\n+#include <optional>\n+#include <string>\n+\n+#include \"absl/status/statusor.h\"\n+#include \"xla/service/hlo.pb.h\"\n+\n+namespace xla {\n+absl::StatusOr<HloModuleProto> LoadHloModuleFromXprof(\n+    std::string xprof_session_id, std::optional<uint64_t> xprof_hlo_program_id);\n+}  // namespace xla\n+\n+#endif  // XLA_TOOLS_PLATFORM_XPROF_LOADER_H_"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 194,
        "deletions": 12
    }
}