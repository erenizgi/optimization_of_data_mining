{
    "author": "unknown",
    "message": "[XLA:GPU] Add SdcLog::ReadProto\n\nA helper that does `SdcLog::ReadFromDevice` and returns the result as\n`SdcLogProto`. The proto will be dumped to log directory for debugging.\n\nPiperOrigin-RevId: 817587228",
    "sha": "9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
    "files": [
        {
            "sha": "e28586a79c8ff4462191675cf7c15751fed9708f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
            "patch": "@@ -2805,6 +2805,11 @@ xla_test(\n     ],\n )\n \n+tf_proto_library(\n+    name = \"sdc_proto\",\n+    srcs = [\"sdc.proto\"],\n+)\n+\n cc_library(\n     name = \"sdc_buffer_id\",\n     hdrs = [\"sdc_buffer_id.h\"],"
        },
        {
            "sha": "3f5f79907b82b9745d670f66dcc2e5bc3c7d8b4f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/sdc.proto",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsdc.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsdc.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fsdc.proto?ref=9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
            "patch": "@@ -0,0 +1,36 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+syntax = \"proto3\";\n+\n+package xla.gpu;\n+\n+message SdcLogEntryProto {\n+  // The ID of the thunk that produced this entry, as returned by\n+  // ThunkInfo::thunk_id().\n+  uint64 thunk_id = 1;\n+\n+  // The index of the buffer within the list of thunk buffers returned by\n+  // Thunk::buffer_uses().\n+  uint64 buffer_idx = 2;\n+\n+  // The checksum of the buffer.\n+  uint32 checksum = 3;\n+}\n+\n+message SdcLogProto {\n+  // The list of entries in the SDC log.\n+  repeated SdcLogEntryProto entries = 1;\n+}"
        },
        {
            "sha": "cdcdbfcb0b856abd7e756f6c7dd0f38bbc212a72",
            "filename": "third_party/xla/xla/stream_executor/cuda/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD?ref=9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
            "patch": "@@ -431,10 +431,12 @@ cc_library(\n     tags = [\"gpu\"],\n     deps = [\n         \"//xla/backends/gpu/runtime:sdc_log_structs\",\n+        \"//xla/backends/gpu/runtime:sdc_proto_cc\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:device_memory_allocator\",\n         \"//xla/stream_executor:stream\",\n         \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:str_format\",\n@@ -447,16 +449,21 @@ xla_test(\n     backends = [\"gpu\"],\n     deps = [\n         \":sdc_log\",\n+        \"//xla/backends/gpu/runtime:sdc_buffer_id\",\n         \"//xla/backends/gpu/runtime:sdc_log_structs\",\n+        \"//xla/backends/gpu/runtime:thunk_id\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:platform_manager\",\n         \"//xla/stream_executor:stream\",\n         \"//xla/stream_executor:stream_executor_h\",\n         \"//xla/stream_executor:stream_executor_memory_allocator\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "e692cb56dd2206bbe4f494371d8e35451140e191",
            "filename": "third_party/xla/xla/stream_executor/cuda/sdc_log.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log.cc?ref=9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n #include \"xla/stream_executor/device_memory_allocator.h\"\n #include \"xla/stream_executor/stream.h\"\n #include \"xla/tsl/platform/errors.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n namespace stream_executor::cuda {\n \n@@ -89,4 +90,19 @@ absl::StatusOr<std::vector<SdcLogEntry>> SdcLog::ReadFromDevice(\n   return entries;\n }\n \n+absl::StatusOr<xla::gpu::SdcLogProto> SdcLog::ReadProto(Stream& stream) const {\n+  TF_ASSIGN_OR_RETURN(std::vector<SdcLogEntry> entries, ReadFromDevice(stream));\n+\n+  xla::gpu::SdcLogProto sdc_log_proto;\n+  sdc_log_proto.mutable_entries()->Reserve(entries.size());\n+  for (const auto& entry : entries) {\n+    xla::gpu::SdcLogEntryProto* entry_proto = sdc_log_proto.add_entries();\n+    entry_proto->set_thunk_id(entry.entry_id.thunk_id().value());\n+    entry_proto->set_buffer_idx(entry.entry_id.buffer_idx());\n+    entry_proto->set_checksum(entry.checksum);\n+  }\n+\n+  return sdc_log_proto;\n+}\n+\n }  // namespace stream_executor::cuda"
        },
        {
            "sha": "75de21c7cb5ec5f13e0a0cd98263ba38ee0764c6",
            "filename": "third_party/xla/xla/stream_executor/cuda/sdc_log.h",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log.h?ref=9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
            "patch": "@@ -21,6 +21,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/status/statusor.h\"\n+#include \"xla/backends/gpu/runtime/sdc.pb.h\"\n #include \"xla/backends/gpu/runtime/sdc_log_structs.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/stream.h\"\n@@ -51,6 +52,13 @@ class SdcLog {\n   static absl::StatusOr<SdcLog> CreateOnDevice(\n       Stream& stream, DeviceMemory<uint8_t> log_buffer);\n \n+  // Creates a `SdcLog` from an already initialized device memory buffer.\n+  //\n+  // `log_buffer` must contain an initialized `SdcLogHeader`.\n+  static SdcLog FromDeviceMemoryUnchecked(DeviceMemory<uint8_t> log_buffer) {\n+    return SdcLog(log_buffer);\n+  }\n+\n   // Reads the header from the device log.\n   //\n   // `stream` must be associated with the same device as the one used to create\n@@ -68,6 +76,12 @@ class SdcLog {\n   absl::StatusOr<std::vector<xla::gpu::SdcLogEntry>> ReadFromDevice(\n       Stream& stream) const;\n \n+  // Reads all entries from the device log into a proto dump.\n+  //\n+  // `stream` must be associated with the same device as the one used to create\n+  // the log.\n+  absl::StatusOr<xla::gpu::SdcLogProto> ReadProto(Stream& stream) const;\n+\n   // Returns a view of the `SdcLogHeader`.\n   //\n   // The returned `DeviceMemory` gets invalidated when the `SdcLog` is"
        },
        {
            "sha": "f19d278cfc6339a2d0e50b93f0434b0d933bbb76",
            "filename": "third_party/xla/xla/stream_executor/cuda/sdc_log_test.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_log_test.cc?ref=9ba0ed96cf762e46e7e06d59a1e8dcdca0af8860",
            "patch": "@@ -17,27 +17,38 @@ limitations under the License.\n \n #include <cstddef>\n #include <cstdint>\n+#include <cstring>\n #include <memory>\n #include <optional>\n+#include <vector>\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/status/status.h\"\n #include \"absl/status/status_matchers.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/backends/gpu/runtime/sdc_buffer_id.h\"\n #include \"xla/backends/gpu/runtime/sdc_log_structs.h\"\n+#include \"xla/backends/gpu/runtime/thunk_id.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/platform_manager.h\"\n #include \"xla/stream_executor/stream.h\"\n #include \"xla/stream_executor/stream_executor.h\"\n #include \"xla/stream_executor/stream_executor_memory_allocator.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/proto_matchers.h\"\n \n namespace stream_executor::cuda {\n namespace {\n \n+using ::tsl::proto_testing::EqualsProto;\n+using ::xla::gpu::SdcBufferId;\n using ::xla::gpu::SdcLogEntry;\n using ::xla::gpu::SdcLogHeader;\n+using ::xla::gpu::SdcLogProto;\n+using ::xla::gpu::ThunkId;\n \n class SdcLogTest : public ::testing::Test {\n  protected:\n@@ -107,5 +118,32 @@ TEST_F(SdcLogTest, CreateSdcLogOnDevice_FailsForTooSmallBuffer) {\n               absl_testing::StatusIs(absl::StatusCode::kInvalidArgument));\n }\n \n+TEST_F(SdcLogTest, ReadAsProto) {\n+  DeviceMemory<uint8_t> log_buffer =\n+      executor_->AllocateArray<uint8_t>(SdcLog::RequiredSizeForEntries(10));\n+  const SdcLogHeader header = {/*write_idx=*/2,\n+                               /*capacity=*/10};\n+  const SdcLogEntry entries[] = {\n+      {/*entry_id=*/SdcBufferId::Create(ThunkId(123), 4).value(),\n+       /*checksum=*/12341234},\n+      {/*entry_id=*/SdcBufferId::Create(ThunkId(567), 8).value(),\n+       /*checksum=*/56785678},\n+  };\n+  std::vector<uint8_t> log_data(sizeof(header) + sizeof(entries));\n+  memcpy(log_data.data(), &header, sizeof(header));\n+  memcpy(log_data.data() + sizeof(header), entries, sizeof(entries));\n+  TF_ASSERT_OK(stream_->MemcpyH2D(absl::MakeConstSpan(log_data), &log_buffer));\n+  TF_ASSERT_OK(stream_->BlockHostUntilDone());\n+\n+  SdcLog device_log = SdcLog::FromDeviceMemoryUnchecked(log_buffer);\n+  TF_ASSERT_OK_AND_ASSIGN(SdcLogProto log_proto,\n+                          device_log.ReadProto(*stream_));\n+\n+  EXPECT_THAT(log_proto, EqualsProto(R\"pb(\n+                entries { thunk_id: 123 buffer_idx: 4 checksum: 12341234 }\n+                entries { thunk_id: 567 buffer_idx: 8 checksum: 56785678 }\n+              )pb\"));\n+}\n+\n }  // namespace\n }  // namespace stream_executor::cuda"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 116,
        "deletions": 0
    }
}