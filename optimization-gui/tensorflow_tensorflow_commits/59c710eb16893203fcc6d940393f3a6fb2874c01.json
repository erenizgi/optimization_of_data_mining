{
    "author": "tensorflower-gardener",
    "message": "[XLA] Add tests for `original_value` in `WhileLoopConstantSinking`.\n\nThese tests verify that the `original_value` field of the `while` instruction is correctly maintained and remains shape-compatible after constants are sunk into the while loop's body and condition. This includes tests for sinking single constants, broadcasted constants, and tuple-shaped constants.\n\nPiperOrigin-RevId: 839949534",
    "sha": "59c710eb16893203fcc6d940393f3a6fb2874c01",
    "files": [
        {
            "sha": "d9cdfba994a98b4d4782a90cc9cb4524309ee7f4",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/59c710eb16893203fcc6d940393f3a6fb2874c01/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/59c710eb16893203fcc6d940393f3a6fb2874c01/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=59c710eb16893203fcc6d940393f3a6fb2874c01",
            "patch": "@@ -4927,7 +4927,7 @@ xla_cc_test(\n         \"//xla/hlo/testlib:test\",\n         \"//xla/hlo/utils:hlo_matchers\",\n         \"//xla/tests:xla_internal_test_main\",\n-        \"@local_tsl//tsl/platform:statusor\",\n+        \"//xla/tsl/platform:statusor\",\n     ],\n )\n "
        },
        {
            "sha": "dd77172e6bafd6ec612039790bca737e7c63e989",
            "filename": "third_party/xla/xla/service/while_loop_constant_sinking_test.cc",
            "status": "modified",
            "additions": 167,
            "deletions": 1,
            "changes": 168,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/59c710eb16893203fcc6d940393f3a6fb2874c01/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_constant_sinking_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/59c710eb16893203fcc6d940393f3a6fb2874c01/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_constant_sinking_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_constant_sinking_test.cc?ref=59c710eb16893203fcc6d940393f3a6fb2874c01",
            "patch": "@@ -21,7 +21,7 @@ limitations under the License.\n #include \"xla/hlo/testlib/test.h\"\n #include \"xla/hlo/utils/hlo_matchers.h\"\n #include \"xla/literal_util.h\"\n-#include \"tsl/platform/statusor.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n namespace {\n@@ -77,6 +77,48 @@ ENTRY entry {\n               op::Tuple(op::Add(_, op::Constant()), _));\n }\n \n+TEST_F(WhileLoopConstantSinkingTest, SinkOneConstantWithOriginalValue) {\n+  const char* const hlo_string = R\"(\n+HloModule ModuleWithWhile\n+\n+body {\n+  p_body = (f32[2],f32[2]) parameter(0)\n+  p_body.0 = f32[2] get-tuple-element((f32[2],f32[2]) p_body), index=0\n+  p_body.1 = f32[2] get-tuple-element((f32[2],f32[2]) p_body), index=1\n+\n+  add.0 = f32[2] add(p_body.0, p_body.1)\n+  ROOT root = (f32[2],f32[2]) tuple(add.0, p_body.1)\n+}\n+\n+condition {\n+  p_cond = (f32[2],f32[2]) parameter(0)\n+  ROOT result = pred[] constant(true)\n+}\n+\n+ENTRY entry {\n+  const_0 = f32[2] constant({1, 2})\n+  const_1 = f32[2] constant({2, 1})\n+  while_init = (f32[2],f32[2]) tuple(const_0, const_1)\n+  ROOT while = (f32[2],f32[2]) while(while_init), condition=condition, body=body, origin={({\"a\"},{\"b\"})}\n+}\n+)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      bool changed,\n+      WhileLoopConstantSinking(/*sink_broadcast_of_constants=*/false,\n+                               /*sink_only_scalar_constants=*/false)\n+          .Run(module.get()));\n+  ASSERT_TRUE(changed);\n+\n+  auto while_instr = module->entry_computation()->root_instruction();\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_TRUE(\n+      while_instr->original_value()->IsCompatibleWith(while_instr->shape()));\n+}\n+\n TEST_F(WhileLoopConstantSinkingTest, SinkBroadcastOfConstant) {\n   const char* const hlo_string = R\"(\n HloModule ModuleWithWhile\n@@ -124,6 +166,49 @@ ENTRY entry {\n               op::Tuple(op::Add(_, op::Broadcast(op::Constant())), _));\n }\n \n+TEST_F(WhileLoopConstantSinkingTest, SinkBroadcastOfConstantWithOriginalValue) {\n+  const char* const hlo_string = R\"(\n+HloModule ModuleWithWhile\n+\n+body {\n+  p_body = (f32[16],f32[16]) parameter(0)\n+  p_body.0 = get-tuple-element(p_body), index=0\n+  p_body.1 = get-tuple-element(p_body), index=1\n+\n+  add.0 = add(p_body.0, p_body.1)\n+  ROOT root = tuple(add.0, p_body.1)\n+}\n+\n+condition {\n+  p_cond = (f32[16],f32[16]) parameter(0)\n+  ROOT result = pred[] constant(true)\n+}\n+\n+ENTRY entry {\n+  const_0 = f32[] constant(1)\n+  const_1 = f32[] constant(2)\n+  broadcast_0 = f32[16] broadcast(const_0), dimensions={}\n+  broadcast_1 = f32[16] broadcast(const_1), dimensions={}\n+  while_init = tuple(broadcast_0, broadcast_1)\n+  ROOT while = while(while_init), condition=condition, body=body, origin={({\"a\"},{\"b\"})}\n+}\n+)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      bool changed,\n+      WhileLoopConstantSinking(/*sink_broadcast_of_constants=*/true)\n+          .Run(module.get()));\n+  ASSERT_TRUE(changed);\n+\n+  auto* while_instr = module->entry_computation()->root_instruction();\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_TRUE(\n+      while_instr->original_value()->IsCompatibleWith(while_instr->shape()));\n+}\n+\n TEST_F(WhileLoopConstantSinkingTest, KeepConstantsLoopInvariant) {\n   const char* const hlo_string = R\"(\n HloModule ModuleWithWhile\n@@ -206,6 +291,46 @@ ENTRY entry {\n                         op::GetTupleElement(op::Parameter(0))));\n }\n \n+TEST_F(WhileLoopConstantSinkingTest, TupleShapedConstantsWithOriginalValue) {\n+  const char* const hlo_string = R\"(\n+HloModule ModuleWithWhile\n+\n+body {\n+  p_b = (f32[2],(f32[2],f32[2])) parameter(0)\n+  p_b.0 = f32[2] get-tuple-element((f32[2],(f32[2],f32[2])) p_b), index=0\n+  p_b.1 = (f32[2],f32[2]) get-tuple-element((f32[2],(f32[2],f32[2])) p_b), index=1\n+\n+  p_b.1.1 = f32[2] get-tuple-element(p_b.1), index=0\n+\n+  ROOT root = (f32[2],(f32[2],f32[2])) tuple(p_b.1.1, p_b.1)\n+}\n+\n+condition {\n+  p_cond = (f32[2],(f32[2],f32[2])) parameter(0)\n+  ROOT result = pred[] constant(true)\n+}\n+\n+ENTRY entry {\n+  const_0 = f32[2] constant({1, 2})\n+  const_1 = (f32[2], f32[2]) constant(({2, 1},{3,1}))\n+  while_init = (f32[2],(f32[2],f32[2])) tuple(const_0, const_1)\n+  ROOT while = (f32[2],(f32[2],f32[2])) while(while_init), condition=condition, body=body, origin={({\"a\"},({\"b\"},{\"c\"}))}\n+}\n+)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(bool changed,\n+                          WhileLoopConstantSinking{}.Run(module.get()));\n+  ASSERT_TRUE(changed);\n+\n+  auto* while_instr = module->entry_computation()->root_instruction();\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_TRUE(\n+      while_instr->original_value()->IsCompatibleWith(while_instr->shape()));\n+}\n+\n TEST_F(WhileLoopConstantSinkingTest, DuplicateGTEs) {\n   // This test shows that the pass fails to optimize non-canonical IR.\n   //\n@@ -340,6 +465,47 @@ ENTRY entry {\n   EXPECT_THAT(while_condition->root_instruction(), op::Lt(_, op::Constant()));\n }\n \n+TEST_F(WhileLoopConstantSinkingTest, ConditionalSinkConstantWithOriginalValue) {\n+  const char* const hlo_string = R\"(\n+HloModule ModuleWithWhile\n+\n+body {\n+  p_body = (f32[],f32[]) parameter(0)\n+  p_body.0 = f32[] get-tuple-element((f32[],f32[]) p_body), index=0\n+  const = f32[] constant(1)\n+  add = f32[] add(p_body.0, const)\n+  p_body.1 = f32[] get-tuple-element((f32[],f32[]) p_body), index=1\n+  ROOT root = (f32[],f32[]) tuple(add, p_body.1)\n+}\n+\n+condition {\n+  p_cond = (f32[],f32[]) parameter(0)\n+  p_cond.0 = f32[] get-tuple-element((f32[],f32[]) p_cond), index=0\n+  p_cond.1 = f32[] get-tuple-element((f32[],f32[]) p_cond), index=1\n+  ROOT result = pred[] compare(p_cond.0, p_cond.1), direction=LT\n+}\n+\n+ENTRY entry {\n+  const_0 = f32[] constant(0)\n+  const_1 = f32[] constant(10)\n+  while_init = (f32[],f32[]) tuple(const_0, const_1)\n+  ROOT while = (f32[],f32[]) while(while_init), condition=condition, body=body, origin={({\"a\"},{\"b\"})}\n+}\n+)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(bool changed,\n+                          WhileLoopConstantSinking{}.Run(module.get()));\n+  ASSERT_TRUE(changed);\n+\n+  auto* while_instr = module->entry_computation()->root_instruction();\n+  ASSERT_NE(while_instr->original_value(), nullptr);\n+  EXPECT_TRUE(\n+      while_instr->original_value()->IsCompatibleWith(while_instr->shape()));\n+}\n+\n TEST_F(WhileLoopConstantSinkingTest, ConditionalTupleShapedConstants) {\n   const char* const hlo_string = R\"(\n HloModule ModuleWithWhile"
        }
    ],
    "stats": {
        "total": 170,
        "additions": 168,
        "deletions": 2
    }
}