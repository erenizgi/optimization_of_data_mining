{
    "author": "ZixuanJiang",
    "message": "Refactor mesh and axis representation.\n\nPiperOrigin-RevId: 826647907",
    "sha": "bf84442f21770c27d1452d7432bae21666016c7e",
    "files": [
        {
            "sha": "effba677d0fd42e27cce132448e6990fcc73488d",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h?ref=bf84442f21770c27d1452d7432bae21666016c7e",
            "patch": "@@ -75,6 +75,8 @@ class Mesh {\n            axes_names_ == other.axes_names_;\n   }\n \n+  bool operator!=(const Mesh& other) const { return !(*this == other); }\n+\n   std::string ToString() const {\n     std::string mesh_str = \"@mesh\";\n     // Add the mesh axes names and sizes.\n@@ -97,8 +99,6 @@ class Mesh {\n     return mesh_str;\n   }\n \n-  bool operator!=(const Mesh& other) const { return !(*this == other); }\n-\n   bool DeviceAssignmentEquals(const Mesh& other) const {\n     return device_assignment_ == other.device_assignment_;\n   }\n@@ -167,6 +167,8 @@ class AxisRef {\n     return true;\n   }\n \n+  bool operator!=(const xla::AxisRef& other) const { return !(*this == other); }\n+\n   std::string ToString(const Mesh& mesh) const {\n     CHECK_GE(mesh_axis_index_, 0);\n     CHECK_LT(mesh_axis_index_, mesh.axis_names().size());\n@@ -178,8 +180,6 @@ class AxisRef {\n     return axis_str;\n   }\n \n-  bool operator!=(const xla::AxisRef& other) const { return !(*this == other); }\n-\n   AxisRefProto ToProto() const;\n \n   static AxisRef FromProto(const AxisRefProto& proto);"
        },
        {
            "sha": "b99e0bb8f9b7956a36939c0d6c4a3d39c114a4a1",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc?ref=bf84442f21770c27d1452d7432bae21666016c7e",
            "patch": "@@ -16,7 +16,6 @@ limitations under the License.\n #include \"xla/hlo/ir/mesh_and_axis.h\"\n \n #include <cstdint>\n-#include <memory>\n #include <string>\n #include <vector>\n \n@@ -123,9 +122,8 @@ TEST(MeshAndAxisTest, MeshToProtoIotaTilingWithReshapeDims) {\n \n   std::vector<std::string> axes_names = {\"axis1\", \"axis2\", \"axis3\"};\n   EXPECT_THAT(\n-      Mesh(TileAssignment(IotaTileAssignment::Create(\n-               /*dims=*/{4, 4, 1},\n-               /*reshape_dims=*/{4, 2, 2}, /*transpose_perm=*/{1, 0, 2})),\n+      Mesh(TileAssignment(/*dims=*/{4, 4, 1}, /*reshape_dims=*/{4, 2, 2},\n+                          /*transpose_perm=*/{1, 0, 2}),\n            axes_names)\n           .ToProto(),\n       EqualsProto(expected));\n@@ -180,15 +178,15 @@ TEST(MeshAxesReplicaGroupListTest, MeshAxesToString) {\n   Mesh mesh_uvw({10, 12, 15}, {\"u\", \"v\", \"w\"});\n   EXPECT_EQ(mesh_uvw.ToString(), \"@mesh<u=10,v=12,w=15>\");\n \n-  Mesh mesh_abcd(TileAssignment(IotaTileAssignment::Create(\n-                     /*dims=*/{2, 4, 4, 2}, /*reshape_dims=*/{1, 4, 1, 16},\n-                     /*transpose_perm=*/{2, 3, 0, 1})),\n-                 /*axes_names=*/{\"a\", \"b\", \"c\", \"d\"});\n+  Mesh mesh_abcd(\n+      TileAssignment(/*dims=*/{2, 4, 4, 2}, /*reshape_dims=*/{1, 4, 1, 16},\n+                     /*transpose_perm=*/{2, 3, 0, 1}),\n+      {\"a\", \"b\", \"c\", \"d\"});\n   EXPECT_EQ(mesh_abcd.ToString(), \"@mesh<a=2,b=4,c=4,d=2>([4,16]T(1,0))\");\n \n   Array<int64_t> array({{8, 3, 7, 5, 4, 2, 6, 0, 1, 9}});\n   array.Reshape({10});\n-  Mesh mesh_ooo(array, /*axes_names=*/{\"ooo\"});\n+  Mesh mesh_ooo(array, {\"ooo\"});\n   EXPECT_EQ(mesh_ooo.ToString(), \"@mesh<ooo=10>(8,3,7,5,4,2,6,0,1,9)\");\n }\n "
        },
        {
            "sha": "d56902d10b580b14408f6c27b509d5d70eebc1e9",
            "filename": "third_party/xla/xla/hlo/ir/replica_group.h",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group.h?ref=bf84442f21770c27d1452d7432bae21666016c7e",
            "patch": "@@ -20,16 +20,12 @@ limitations under the License.\n #include <cstddef>\n #include <cstdint>\n #include <memory>\n-#include <numeric>\n #include <optional>\n #include <string>\n #include <utility>\n #include <vector>\n \n #include \"absl/container/flat_hash_map.h\"\n-#include \"absl/container/flat_hash_set.h\"\n-#include \"absl/log/check.h\"\n-#include \"absl/log/log.h\"\n #include \"absl/types/span.h\"\n #include \"google/protobuf/repeated_ptr_field.h\"\n #include \"xla/array.h\""
        },
        {
            "sha": "2815984412c1e252710d644e9d0b8f5fc39cba96",
            "filename": "third_party/xla/xla/hlo/ir/replica_group_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 31,
            "changes": 49,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf84442f21770c27d1452d7432bae21666016c7e/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Freplica_group_test.cc?ref=bf84442f21770c27d1452d7432bae21666016c7e",
            "patch": "@@ -43,7 +43,7 @@ CollectiveDeviceListProto CreateDeviceListProto(\n }\n \n TEST(MeshAxesReplicaGroupListTest, MaterializedReplicaGroups) {\n-  Mesh mesh_xy(TileAssignment({2, 2}), /*axes_names=*/{\"x\", \"y\"});\n+  Mesh mesh_xy({2, 2}, {\"x\", \"y\"});\n \n   MeshAxesReplicaGroupList replica_group_none(mesh_xy, {});\n   std::vector<std::vector<int64_t>> expected_replica_groups_none = {\n@@ -70,8 +70,7 @@ TEST(MeshAxesReplicaGroupListTest, MaterializedReplicaGroups) {\n }\n \n TEST(MeshAxesReplicaGroupListTest, MaterializedReplicaGroupsWithSubaxes) {\n-  Mesh mesh(TileAssignment(IotaTileAssignment::Create(/*dims=*/{6, 6})),\n-            /*axes_names=*/{\"a\", \"b\"});\n+  Mesh mesh({6, 6}, {\"a\", \"b\"});\n \n   // a:(1)2\n   MeshAxesReplicaGroupList replica_group_a_1_2(mesh, {AxisRef(0, {1, 2})});\n@@ -172,8 +171,7 @@ TEST(MeshAxesReplicaGroupListTest, MaterializedReplicaGroupsWithSubaxes) {\n }\n \n TEST(MeshAxesReplicaGroupListTest, MaterializedReplicaGroupsMatchExpectedV2) {\n-  Mesh mesh(TileAssignment(IotaTileAssignment::Create(/*dims=*/{8})),\n-            /*axes_names=*/{\"a\"});\n+  Mesh mesh({8}, {\"a\"});\n \n   // a:(1)2 -> replica_groups=[4,2]<=[2,4]T(1,0)\n   MeshAxesReplicaGroupList v3_subaxis_1_2(mesh, {AxisRef(0, {1, 2})});\n@@ -231,7 +229,7 @@ TEST(MeshAxesReplicaGroupListTest,\n   // Create a mesh with non-iota device ordering.\n   Array2D<int64_t> array({{3, 1}, {0, 2}});\n   TileAssignment tile_assignment(std::make_shared<Array<int64_t>>(array));\n-  Mesh mesh_xy(tile_assignment, /*axes_names=*/{\"x\", \"y\"});\n+  Mesh mesh_xy(tile_assignment, {\"x\", \"y\"});\n \n   // Reduce along x axis.\n   MeshAxesReplicaGroupList replica_group_x(mesh_xy, {AxisRef(0)});\n@@ -253,40 +251,34 @@ TEST(MeshAxesReplicaGroupListTest,\n }\n \n TEST(MeshAxesReplicaGroupListTest, NumReplicaGroups) {\n-  Mesh all_axes(TileAssignment(IotaTileAssignment::Create(\n-                    /*dims=*/{4, 4})),\n-                /*axes_names=*/{\"x\", \"y\"});\n+  Mesh all_axes({4, 4}, {\"x\", \"y\"});\n   MeshAxesReplicaGroupList replica_group_across_all_axes(\n       all_axes, {AxisRef(0), AxisRef(1)});\n   EXPECT_EQ(replica_group_across_all_axes.num_replica_groups(), 1);\n   EXPECT_EQ(replica_group_across_all_axes.num_devices_per_group(), 16);\n \n-  Mesh one_axes(TileAssignment(IotaTileAssignment::Create(\n-                    /*dims=*/{3, 5})),\n-                /*axes_names=*/{\"a\", \"b\"});\n+  Mesh one_axes({3, 5}, {\"a\", \"b\"});\n   MeshAxesReplicaGroupList replica_group_across_a(one_axes, {AxisRef(0)});\n   MeshAxesReplicaGroupList replica_group_across_b(one_axes, {AxisRef(1)});\n   EXPECT_EQ(replica_group_across_a.num_replica_groups(), 5);\n   EXPECT_EQ(replica_group_across_a.num_devices_per_group(), 3);\n   EXPECT_EQ(replica_group_across_b.num_replica_groups(), 3);\n   EXPECT_EQ(replica_group_across_b.num_devices_per_group(), 5);\n \n-  Mesh no_axes(TileAssignment(IotaTileAssignment::Create(\n-                   /*dims=*/{2, 3, 5})),\n-               /*axes_names=*/{\"p1\", \"p2\", \"p3\"});\n+  Mesh no_axes({2, 3, 5}, {\"p1\", \"p2\", \"p3\"});\n   MeshAxesReplicaGroupList replica_group_across_no_axes(no_axes, /*axes=*/{});\n   EXPECT_EQ(replica_group_across_no_axes.num_replica_groups(), 2 * 3 * 5);\n   EXPECT_EQ(replica_group_across_no_axes.num_devices_per_group(), 1);\n }\n \n TEST(MeshAxesReplicaGroupListTest, ValidateSubAxesCoexistenceCheck) {\n-  Mesh mesh(TileAssignment({8}), /*axes_names=*/{\"1\"});\n+  Mesh mesh({8}, {\"a\"});\n   MeshAxesReplicaGroupList replica_group_multiple_subaxes1(\n       mesh, {AxisRef(0, {1, 2}), AxisRef(0, {4, 2})});\n   MeshAxesReplicaGroupList replica_group_multiple_subaxes2(\n       mesh, {AxisRef(0, {4, 2}), AxisRef(0, {1, 2})});\n \n-  Mesh overlap_mesh(TileAssignment({2 * 3 * 5}), /*axes_names=*/{\"u\"});\n+  Mesh overlap_mesh({2 * 3 * 5}, {\"u\"});\n   EXPECT_DEATH(\n       {\n         MeshAxesReplicaGroupList overlapping_subaxes(\n@@ -296,9 +288,7 @@ TEST(MeshAxesReplicaGroupListTest, ValidateSubAxesCoexistenceCheck) {\n }\n \n TEST(MeshAxesReplicaGroupListTest, ReplicaGroupsCountAndSizeForSubaxes) {\n-  Mesh mesh_one_subaxis(TileAssignment(IotaTileAssignment::Create(\n-                            /*dims=*/{2, 6, 10})),\n-                        /*axes_names=*/{\"axis1\", \"axis2\", \"axis3\"});\n+  Mesh mesh_one_subaxis({2, 6, 10}, {\"axis1\", \"axis2\", \"axis3\"});\n   MeshAxesReplicaGroupList replica_group_across_axis1_subaxis(\n       mesh_one_subaxis, {AxisRef(0, {1, 2})});\n   MeshAxesReplicaGroupList replica_group_across_axis2_subaxis(\n@@ -308,9 +298,8 @@ TEST(MeshAxesReplicaGroupListTest, ReplicaGroupsCountAndSizeForSubaxes) {\n   EXPECT_EQ(replica_group_across_axis2_subaxis.num_replica_groups(), 40);\n   EXPECT_EQ(replica_group_across_axis2_subaxis.num_devices_per_group(), 3);\n \n-  Mesh mesh_multiple_subaxis(TileAssignment(IotaTileAssignment::Create(\n-                                 /*dims=*/{2 * 3, 5 * 7, 11 * 13})),\n-                             /*axes_names=*/{\"alpha\", \"beta\", \"gamma\"});\n+  Mesh mesh_multiple_subaxis({2 * 3, 5 * 7, 11 * 13},\n+                             {\"alpha\", \"beta\", \"gamma\"});\n   MeshAxesReplicaGroupList replica_group_across_multiple_subaxis1(\n       mesh_multiple_subaxis,\n       {AxisRef(0, {1, 2}), AxisRef(1, {1, 5}), AxisRef(2, {1, 11})});\n@@ -329,20 +318,18 @@ TEST(MeshAxesReplicaGroupListTest, ReplicaGroupsCountAndSizeForSubaxes) {\n \n TEST(MeshAxesReplicaGroupListTest, MeshAxesToString) {\n   // No subaxes and iota device assignment.\n-  Mesh mesh_uvw(TileAssignment(IotaTileAssignment::Create(\n-                    /*dims=*/{10, 12, 15})),\n-                /*axes_names=*/{\"u\", \"v\", \"w\"});\n+  Mesh mesh_uvw({10, 12, 15}, {\"u\", \"v\", \"w\"});\n   MeshAxesReplicaGroupList replica_group_across_none(mesh_uvw, {});\n   EXPECT_EQ(replica_group_across_none.ToString(), \"@mesh<u=10,v=12,w=15> {}\");\n   MeshAxesReplicaGroupList replica_group_across_uv(mesh_uvw,\n                                                    {AxisRef(0), AxisRef(1)});\n   EXPECT_EQ(replica_group_across_uv.ToString(), \"@mesh<u=10,v=12,w=15> {u,v}\");\n \n   // Subaxes and replica group v2 iota style device assignment.\n-  Mesh mesh_abcd(TileAssignment(IotaTileAssignment::Create(\n-                     /*dims=*/{2, 4, 4, 2}, /*reshape_dims=*/{1, 4, 1, 16},\n-                     /*transpose_perm=*/{2, 3, 0, 1})),\n-                 /*axes_names=*/{\"a\", \"b\", \"c\", \"d\"});\n+  Mesh mesh_abcd(\n+      TileAssignment(/*dims=*/{2, 4, 4, 2}, /*reshape_dims=*/{1, 4, 1, 16},\n+                     /*transpose_perm=*/{2, 3, 0, 1}),\n+      {\"a\", \"b\", \"c\", \"d\"});\n   MeshAxesReplicaGroupList rg_abcd_across_none(mesh_abcd, {});\n   EXPECT_EQ(rg_abcd_across_none.ToString(),\n             \"@mesh<a=2,b=4,c=4,d=2>([4,16]T(1,0)) {}\");\n@@ -355,7 +342,7 @@ TEST(MeshAxesReplicaGroupListTest, MeshAxesToString) {\n   Array<int64_t> array({{8, 3, 7, 5, 4, 2, 6, 0, 1, 9}});\n   array.Reshape({10});\n   TileAssignment tile_assignment(std::make_shared<Array<int64_t>>(array));\n-  Mesh mesh_ooo(tile_assignment, /*axes_names=*/{\"ooo\"});\n+  Mesh mesh_ooo(tile_assignment, {\"ooo\"});\n   MeshAxesReplicaGroupList rg_ooo_across_none(mesh_ooo, {});\n   EXPECT_EQ(rg_ooo_across_none.ToString(),\n             \"@mesh<ooo=10>(8,3,7,5,4,2,6,0,1,9) {}\");"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 29,
        "deletions": 48
    }
}