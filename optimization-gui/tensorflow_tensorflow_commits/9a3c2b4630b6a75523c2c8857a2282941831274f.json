{
    "author": "ezhulenev",
    "message": "[xla] Migrate to PjRtFuture<>::MakePromise() API\n\nPiperOrigin-RevId: 805609202",
    "sha": "9a3c2b4630b6a75523c2c8857a2282941831274f",
    "files": [
        {
            "sha": "8a1eefb1bdf91cabb852de9fce81cad895afc403",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/array.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Farray.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Farray.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Farray.cc?ref=9a3c2b4630b6a75523c2c8857a2282941831274f",
            "patch": "@@ -451,12 +451,12 @@ Future<> Array::GetReadyFuture() const {\n   auto req = std::make_unique<CheckValueReadyRequest>();\n   req->add_value_handles(handle_.handle);\n \n-  auto promise = Future<>::CreatePromise();\n+  auto [promise, future] = Future<>::MakePromise();\n   rpc_helper_->CheckValueReady(std::move(req))\n-      .OnReady(\n-          [promise](absl::StatusOr<std::shared_ptr<CheckValueReadyResponse>>\n-                        resp) mutable { promise.Set(resp.status()); });\n-  ready_future_ = Future<>(std::move(promise));\n+      .OnReady([promise = std::move(promise)](\n+                   absl::StatusOr<std::shared_ptr<CheckValueReadyResponse>>\n+                       resp) mutable { promise.Set(resp.status()); });\n+  ready_future_ = std::move(future);\n   return ready_future_;\n }\n \n@@ -817,8 +817,8 @@ Future<> Array::CopyToStringHostBuffer(\n \n   const uint64_t host_buffer_handle = rpc_helper_->NextHandle();\n   req->set_host_buffer_handle(host_buffer_handle);\n-  auto promise = Future<>::CreatePromise();\n-  auto on_ready = [promise,\n+  auto [promise, future] = Future<>::MakePromise();\n+  auto on_ready = [promise = std::move(promise),\n                    host_buffer_store = rpc_helper_->host_buffer_store(),\n                    host_buffer_handle,\n                    dst_buffer = static_cast<absl::Cord*>(data)](\n@@ -829,7 +829,8 @@ Future<> Array::CopyToStringHostBuffer(\n       return;\n     }\n     host_buffer_store->Lookup(host_buffer_handle)\n-        .OnReady([promise, dst_buffer, host_buffer_store, host_buffer_handle](\n+        .OnReady([promise = std::move(promise), dst_buffer, host_buffer_store,\n+                  host_buffer_handle](\n                      absl::StatusOr<absl::Cord> array_contents) mutable {\n           absl::Cleanup cleanup = [&]() {\n             host_buffer_store->Delete(host_buffer_handle)\n@@ -854,7 +855,7 @@ Future<> Array::CopyToStringHostBuffer(\n         });\n   };\n   rpc_helper_->CopyToHostBuffer(std::move(req)).OnReady(std::move(on_ready));\n-  return Future<>(std::move(promise));\n+  return std::move(future);\n }\n \n Future<> Array::CopyToHostBuffer(\n@@ -882,9 +883,9 @@ Future<> Array::CopyToHostBuffer(\n   const uint64_t host_buffer_handle = rpc_helper_->NextHandle();\n   req->set_host_buffer_handle(host_buffer_handle);\n \n-  auto promise = Future<>::CreatePromise();\n+  auto [promise, future] = Future<>::MakePromise();\n   auto on_ready = [host_buffer_store = rpc_helper_->host_buffer_store(),\n-                   promise, host_buffer_handle,\n+                   promise = std::move(promise), host_buffer_handle,\n                    mem_region = mem_region->mem_region()](\n                       absl::StatusOr<std::shared_ptr<CopyToHostBufferResponse>>\n                           resp) mutable {\n@@ -895,7 +896,7 @@ Future<> Array::CopyToHostBuffer(\n \n     auto host_buffer = host_buffer_store->Lookup(host_buffer_handle);\n     host_buffer.OnReady(\n-        [promise, mem_region, host_buffer_store,\n+        [promise = std::move(promise), mem_region, host_buffer_store,\n          host_buffer_handle](absl::StatusOr<absl::Cord> data) mutable {\n           absl::Cleanup cleanup = [&]() {\n             host_buffer_store->Delete(host_buffer_handle)\n@@ -930,7 +931,7 @@ Future<> Array::CopyToHostBuffer(\n         });\n   };\n   rpc_helper_->CopyToHostBuffer(std::move(req)).OnReady(std::move(on_ready));\n-  return Future<>(std::move(promise));\n+  return std::move(future);\n }\n \n absl::StatusOr<std::shared_ptr<const PjRtLayout>> Array::pjrt_layout() const {"
        },
        {
            "sha": "0d6c6efb4dfa97bb8c7117ac3cdadfca5690ce50",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/grpc_host_buffer.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 42,
            "changes": 86,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc?ref=9a3c2b4630b6a75523c2c8857a2282941831274f",
            "patch": "@@ -93,56 +93,58 @@ GrpcClientHostBufferStore::~GrpcClientHostBufferStore() {\n \n Future<> GrpcClientHostBufferStore::Store(uint64_t handle,\n                                           absl::string_view data) {\n-  auto promise = Future<>::CreatePromise();\n+  auto [promise, future] = Future<>::MakePromise();\n \n   XFlowHelper flow(\"GrpcClientHostBufferStore::StoreAsync\");\n   flow.InstantActivity<XFlowHelper::kSend>();\n \n   std::unique_ptr<std::string> buffered_data;\n \n   auto reservation = ScopedAcquireSemaphore(store_throttler_);\n-  work_queue_->Schedule([this, reservation = std::move(reservation), handle,\n-                         promise, data, flow]() mutable -> void {\n-    auto span = flow.Span<XFlowHelper::kRecv>();\n-    GrpcHostBufferStoreMetadata metadata;\n-    metadata.set_session_id(session_id_);\n-    metadata.set_handle(handle);\n-    metadata.set_buffer_size(data.size());\n-    VLOG(3) << \"GrpcClientHostBufferStore::Store start \"\n-            << metadata.ShortDebugString();\n-\n-    ::grpc::ClientContext context;\n-    context.AddMetadata(\"ifrt-proxy-grpc-host-buffer-store-metadata-bin\",\n-                        metadata.SerializeAsString());\n-\n-    GrpcHostBufferStoreResponse response;\n-    auto writer = stub_->HostBufferStore(&context, &response);\n-\n-    {\n-      tsl::profiler::TraceMe trace_me_send_data([size = data.size()]() {\n-        return tsl::profiler::TraceMeEncode(\n-            \"GrpcClientHostBufferStore::StoreAsync_Send\", {{\"size\", size}});\n+  work_queue_->Schedule(\n+      [this, reservation = std::move(reservation), handle,\n+       promise = std::make_shared<Future<>::Promise>(std::move(promise)), data,\n+       flow]() mutable -> void {\n+        auto span = flow.Span<XFlowHelper::kRecv>();\n+        GrpcHostBufferStoreMetadata metadata;\n+        metadata.set_session_id(session_id_);\n+        metadata.set_handle(handle);\n+        metadata.set_buffer_size(data.size());\n+        VLOG(3) << \"GrpcClientHostBufferStore::Store start \"\n+                << metadata.ShortDebugString();\n+\n+        ::grpc::ClientContext context;\n+        context.AddMetadata(\"ifrt-proxy-grpc-host-buffer-store-metadata-bin\",\n+                            metadata.SerializeAsString());\n+\n+        GrpcHostBufferStoreResponse response;\n+        auto writer = stub_->HostBufferStore(&context, &response);\n+\n+        {\n+          tsl::profiler::TraceMe trace_me_send_data([size = data.size()]() {\n+            return tsl::profiler::TraceMeEncode(\n+                \"GrpcClientHostBufferStore::StoreAsync_Send\", {{\"size\", size}});\n+          });\n+          for (int64_t offset = 0; offset < data.size(); offset += kChunkSize) {\n+            GrpcHostBufferStoreRequest request;\n+            SetDataFromStringView(request, data.substr(offset, kChunkSize));\n+            writer->Write(request);\n+          }\n+\n+          if (!writer->WritesDone()) {\n+            absl::Status s = xla::FromGrpcStatus(writer->Finish());\n+            promise->Set(absl::InternalError(absl::StrCat(\n+                \"Failed to write all host buffer chunks, Finish() returned: \",\n+                s.ToString())));\n+            return;\n+          }\n+        }\n+\n+        VLOG(3) << \"GrpcClientHostBufferStore::Store done \"\n+                << metadata.ShortDebugString();\n+        promise->Set(xla::FromGrpcStatus(writer->Finish()));\n       });\n-      for (int64_t offset = 0; offset < data.size(); offset += kChunkSize) {\n-        GrpcHostBufferStoreRequest request;\n-        SetDataFromStringView(request, data.substr(offset, kChunkSize));\n-        writer->Write(request);\n-      }\n-\n-      if (!writer->WritesDone()) {\n-        absl::Status s = xla::FromGrpcStatus(writer->Finish());\n-        promise.Set(absl::InternalError(absl::StrCat(\n-            \"Failed to write all host buffer chunks, Finish() returned: \",\n-            s.ToString())));\n-        return;\n-      }\n-    }\n-\n-    VLOG(3) << \"GrpcClientHostBufferStore::Store done \"\n-            << metadata.ShortDebugString();\n-    promise.Set(xla::FromGrpcStatus(writer->Finish()));\n-  });\n-  return Future<>(promise);\n+  return std::move(future);\n }\n \n Future<> GrpcClientHostBufferStore::Store(uint64_t handle,"
        },
        {
            "sha": "a13f9c88e7f1e1e4d6e7884ad8bced9e730eaf1c",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/rpc_helper.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Frpc_helper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Frpc_helper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Frpc_helper.cc?ref=9a3c2b4630b6a75523c2c8857a2282941831274f",
            "patch": "@@ -352,13 +352,13 @@ Future<> RpcHelper::CheckFuture(uint64_t handle) {\n   auto req = std::make_unique<CheckFutureRequest>();\n   req->set_future_handle(handle);\n \n-  auto promise = Future<>::CreatePromise();\n+  auto [promise, future] = Future<>::MakePromise();\n   CheckFuture(std::move(req))\n-      .OnReady(\n-          [promise](absl::StatusOr<std::shared_ptr<CheckFutureResponse>>\n-                        response) mutable { promise.Set(response.status()); });\n+      .OnReady([promise = std::move(promise)](\n+                   absl::StatusOr<std::shared_ptr<CheckFutureResponse>>\n+                       response) mutable { promise.Set(response.status()); });\n \n-  return Future<>(std::move(promise));\n+  return std::move(future);\n }\n \n RpcHelper::RpcHelper(IfrtProxyVersion version,"
        },
        {
            "sha": "6f0ef23d6c8fd27f746b83e2c8bdf14054cd22c4",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/basic_string_array.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fbasic_string_array.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fbasic_string_array.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fbasic_string_array.cc?ref=9a3c2b4630b6a75523c2c8857a2282941831274f",
            "patch": "@@ -275,8 +275,8 @@ Future<> BasicStringArray::CopyToHostBuffer(\n         sharding_->devices()->size())));\n   }\n \n-  auto copy_completion_promise = Future<>::CreatePromise();\n-  auto copy_completion_future = Future<>(copy_completion_promise);\n+  auto [copy_completion_promise, copy_completion_future] =\n+      Future<>::MakePromise();\n \n   buffers_.OnReady(\n       [copy_completion_promise = std::move(copy_completion_promise),"
        },
        {
            "sha": "390791c3903ee4409eb219cb61103396de23b0dc",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_array.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_array.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_array.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_array.cc?ref=9a3c2b4630b6a75523c2c8857a2282941831274f",
            "patch": "@@ -400,8 +400,7 @@ Future<> PjRtArray::CopyToHostBuffer(\n         static_cast<char*>(data), xla_shape);\n   }\n   auto* literal_ptr = literal.get();\n-  auto promise = Future<>::CreatePromise();\n-  Future<> future(promise);\n+  auto [promise, future] = Future<>::MakePromise();\n   // TODO(hyeontaek): Handle semantics == kDonateInput.\n   pjrt_buffer->ToLiteral(literal_ptr)\n       .OnReady([literal = std::move(literal),"
        },
        {
            "sha": "80b70f5137bde7ff9bd0a5674b76d4133e158e05",
            "filename": "third_party/xla/xla/python/transfer/streaming_ifrt.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a3c2b4630b6a75523c2c8857a2282941831274f/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_ifrt.cc?ref=9a3c2b4630b6a75523c2c8857a2282941831274f",
            "patch": "@@ -331,10 +331,10 @@ class SlicedRawBufferChunkDestination : public ChunkDestination {\n absl::StatusOr<std::pair<tsl::RCReference<ChunkDestination>, xla::PjRtFuture<>>>\n CreateSlicedRawBufferDest(tsl::RCReference<xla::PjRtRawBuffer> raw_buffer,\n                           size_t offset, size_t size) {\n-  auto promise = xla::PjRtFuture<>::CreatePromise();\n-  auto dest = tsl::MakeRef<SlicedRawBufferChunkDestination>(raw_buffer, offset,\n-                                                            size, promise);\n-  return std::make_pair(std::move(dest), xla::PjRtFuture<>(std::move(promise)));\n+  auto [promise, future] = xla::PjRtFuture<>::MakePromise();\n+  auto dest = tsl::MakeRef<SlicedRawBufferChunkDestination>(\n+      raw_buffer, offset, size, std::move(promise));\n+  return std::make_pair(std::move(dest), std::move(future));\n }\n \n RawBufferEntry::RawBufferEntry(std::vector<BufferRef> arrs,"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 70,
        "deletions": 68
    }
}