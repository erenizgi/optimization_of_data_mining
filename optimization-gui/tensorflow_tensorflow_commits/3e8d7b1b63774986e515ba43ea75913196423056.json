{
    "author": "d4n1elchen",
    "message": "[HLO Diff] Add DiffSummary::FromProto to deserialize from proto.\n\nThis change introduces a static method `DiffSummary::FromProto` which allows reconstructing a DiffSummary object from its protobuf representation. It uses the provided left and right HloModules to find the HloComputation objects referenced by name in the proto.\n\nPiperOrigin-RevId: 834051365",
    "sha": "3e8d7b1b63774986e515ba43ea75913196423056",
    "files": [
        {
            "sha": "3864da0384028ea09f4225863e43bd14715aeb8d",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e8d7b1b63774986e515ba43ea75913196423056/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e8d7b1b63774986e515ba43ea75913196423056/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc?ref=3e8d7b1b63774986e515ba43ea75913196423056",
            "patch": "@@ -492,5 +492,44 @@ DiffSummaryProto DiffSummary::ToProto() const {\n   return proto;\n }\n \n+DiffSummary DiffSummary::FromProto(const DiffSummaryProto& proto,\n+                                   const HloModule& left_module,\n+                                   const HloModule& right_module) {\n+  DiffSummary summary;\n+  absl::flat_hash_map<std::string, const HloComputation*> left_computation_map;\n+  for (const HloComputation* computation : left_module.computations()) {\n+    left_computation_map[computation->name()] = computation;\n+  }\n+  absl::flat_hash_map<std::string, const HloComputation*> right_computation_map;\n+  for (const HloComputation* computation : right_module.computations()) {\n+    right_computation_map[computation->name()] = computation;\n+  }\n+\n+  for (const auto& diff_pattern_proto : proto.computation_diff_patterns()) {\n+    ComputationDiffPattern diff_pattern;\n+    diff_pattern.fingerprint = diff_pattern_proto.fingerprint();\n+    diff_pattern.diff_metrics.changed_instruction_count =\n+        diff_pattern_proto.changed_instruction_count();\n+    diff_pattern.diff_metrics.left_unmatched_instruction_count =\n+        diff_pattern_proto.left_unmatched_instruction_count();\n+    diff_pattern.diff_metrics.right_unmatched_instruction_count =\n+        diff_pattern_proto.right_unmatched_instruction_count();\n+    for (const auto& group_proto : diff_pattern_proto.computation_group()) {\n+      ComputationGroup group;\n+      for (const auto& computation_details : group_proto.left_computations()) {\n+        group.left_computations.push_back(\n+            left_computation_map.at(computation_details.name()));\n+      }\n+      for (const auto& computation_details : group_proto.right_computations()) {\n+        group.right_computations.push_back(\n+            right_computation_map.at(computation_details.name()));\n+      }\n+      diff_pattern.computation_groups.push_back(group);\n+    }\n+    summary.computation_diff_patterns.push_back(diff_pattern);\n+  }\n+  return summary;\n+}\n+\n }  // namespace hlo_diff\n }  // namespace xla"
        },
        {
            "sha": "7ebcdf2e78f7e79fbce0082f2deba3f89a2e7eb4",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e8d7b1b63774986e515ba43ea75913196423056/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e8d7b1b63774986e515ba43ea75913196423056/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h?ref=3e8d7b1b63774986e515ba43ea75913196423056",
            "patch": "@@ -105,6 +105,11 @@ struct DiffSummary {\n \n   // Converts the diff summary to a proto.\n   DiffSummaryProto ToProto() const;\n+\n+  // Constructs the diff summary from a proto.\n+  static DiffSummary FromProto(const DiffSummaryProto& proto,\n+                               const HloModule& left_module,\n+                               const HloModule& right_module);\n };\n \n // Constructs the diff summary from the diff result."
        },
        {
            "sha": "bf10f584e8e1685b21ce35eb18114a497fc56ef5",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary_test.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e8d7b1b63774986e515ba43ea75913196423056/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e8d7b1b63774986e515ba43ea75913196423056/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc?ref=3e8d7b1b63774986e515ba43ea75913196423056",
            "patch": "@@ -692,6 +692,50 @@ TEST_F(HloDiffTest, DiffSummaryToProtoWorks) {\n               2))));\n }\n \n+TEST_F(HloDiffTest, DiffSummaryFromProtoWorks) {\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::VerifiedHloModule> module_l,\n+                          ParseAndReturnVerifiedModule(R\"(\n+  HloModule module, is_scheduled=true\n+\n+  ENTRY entry {\n+    parameter.0 = f32[] parameter(0)\n+    parameter.1 = f32[] parameter(1)\n+    add.0 = f32[] add(parameter.0, parameter.1)\n+  }\n+  )\"));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<const HloGumgraph> graph_l,\n+                          HloGumgraph::Create(module_l.get()));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::VerifiedHloModule> module_r,\n+                          ParseAndReturnVerifiedModule(R\"(\n+  HloModule module, is_scheduled=true\n+\n+  ENTRY entry {\n+    parameter.0 = f32[] parameter(0)\n+    parameter.1 = f32[] parameter(1)\n+    add.0 = f32[] add(parameter.1, parameter.0)\n+  }\n+  )\"));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<const HloGumgraph> graph_r,\n+                          HloGumgraph::Create(module_r.get()));\n+  HloGumgraphMappings mappings;\n+  ASSERT_NO_FATAL_FAILURE(OverwriteMapInstructions(\n+      GetNodeByName(*graph_l, \"add.0\"), GetNodeByName(*graph_r, \"add.0\"),\n+      mappings, true));\n+  std::unique_ptr<const DiffResult> diff_result =\n+      ConstructDiffResult(*graph_l, *graph_r, mappings);\n+  std::unique_ptr<const DiffSummary> diff_summary =\n+      ConstructDiffSummary(*graph_l, *graph_r, *diff_result);\n+\n+  DiffSummaryProto proto = diff_summary->ToProto();\n+  DiffSummary summary_from_proto =\n+      DiffSummary::FromProto(proto, *module_l, *module_r);\n+\n+  EXPECT_THAT(summary_from_proto.computation_diff_patterns,\n+              UnorderedPointwise(EqualsComputationDiffPattern(),\n+                                 diff_summary->computation_diff_patterns));\n+}\n+\n }  // namespace\n }  // namespace hlo_diff\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 88,
        "deletions": 0
    }
}