{
    "author": "thcmbs",
    "message": "[XLA:GPU] Move layout checks into GetNormalizedLogicalTransposeShape\n\nRequired to fail gracefully in `GetDescriptionForTiledTransposeEmitter` in cl/841759079.\n\nPiperOrigin-RevId: 845187244",
    "sha": "09c97bbcf667f5325107c82ff35df9f82a547a1c",
    "files": [
        {
            "sha": "9f017b8ad97df5472e2df5f92ba2381017dce005",
            "filename": "third_party/xla/xla/service/gpu/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD?ref=09c97bbcf667f5325107c82ff35df9f82a547a1c",
            "patch": "@@ -2799,7 +2799,7 @@ cc_library(\n         \"//xla:util\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\",\n-        \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/platform:status_macros\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\","
        },
        {
            "sha": "de243e47343e9837fbcf5cd020f52f88da57f558",
            "filename": "third_party/xla/xla/service/gpu/transforms/transpose_dimension_grouper.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 17,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ftranspose_dimension_grouper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ftranspose_dimension_grouper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ftranspose_dimension_grouper.cc?ref=09c97bbcf667f5325107c82ff35df9f82a547a1c",
            "patch": "@@ -30,12 +30,11 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"xla/hlo/ir/dfs_hlo_visitor_with_default.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n-#include \"xla/layout_util.h\"\n #include \"xla/permutation_util.h\"\n #include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n-#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n+#include \"xla/tsl/platform/status_macros.h\"\n \n namespace xla {\n namespace gpu {\n@@ -46,19 +45,14 @@ class TransposeDimensionGroupVisitor : public DfsHloRewriteVisitor {\n  public:\n   absl::Status HandleTranspose(HloInstruction* transpose) override {\n     VLOG(4) << \"Input: \" << transpose->ToString();\n-    if (!LayoutUtil::IsMonotonicWithDim0Major(transpose->shape().layout()) ||\n-        !LayoutUtil::IsMonotonicWithDim0Major(\n-            transpose->operand(0)->shape().layout())) {\n-      // TransposeDimensionGrouper runs almost immediately after\n-      // LayoutNormalization. The passes in between have been verified to not\n-      // introduce transposes with non-default layout.\n-      return FailedPrecondition(\n-          \"Layout normalization should have assigned the default layout to \"\n-          \"transpose and its operand\");\n-    }\n     absl::InlinedVector<int64_t, 3> permutation;\n-    auto normalized_dims = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-        transpose->shape(), transpose->dimensions(), permutation);\n+    // TransposeDimensionGrouper runs almost immediately after\n+    // LayoutNormalization. The passes in between have been verified to not\n+    // introduce transposes with non-default layout.\n+    ASSIGN_OR_RETURN(auto normalized_dims,\n+                     ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                         transpose->operand(0)->shape(), transpose->shape(),\n+                         transpose->dimensions(), permutation));\n     if (normalized_dims.size() == 1 ||\n         normalized_dims == transpose->shape().dimensions()) {\n       return absl::OkStatus();\n@@ -85,9 +79,8 @@ class TransposeDimensionGroupVisitor : public DfsHloRewriteVisitor {\n absl::StatusOr<bool> TransposeDimensionGrouper::RunImpl(\n     HloModule* module,\n     const absl::flat_hash_set<absl::string_view>& execution_threads) {\n-  TF_ASSIGN_OR_RETURN(\n-      bool changed,\n-      TransposeDimensionGroupVisitor().RunOnModule(module, execution_threads));\n+  ASSIGN_OR_RETURN(bool changed, TransposeDimensionGroupVisitor().RunOnModule(\n+                                     module, execution_threads));\n   return changed;\n }\n "
        },
        {
            "sha": "a9e0f6dee030c24c8f65ae53f6cba92284ffd663",
            "filename": "third_party/xla/xla/shape_util.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fshape_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fshape_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fshape_util.cc?ref=09c97bbcf667f5325107c82ff35df9f82a547a1c",
            "patch": "@@ -2403,19 +2403,25 @@ absl::InlinedVector<int64_t, 3> GetNormalizedTransposeShapeHelper(\n \n }  // namespace\n \n-/*static*/ absl::InlinedVector<int64_t, 3>\n+/*static*/ absl::StatusOr<absl::InlinedVector<int64_t, 3>>\n ShapeUtil::GetNormalizedLogicalTransposeShape(\n-    const Shape& output_shape, absl::Span<int64_t const> dimensions,\n+    const Shape& input_shape, const Shape& output_shape,\n+    absl::Span<int64_t const> dimensions,\n     absl::InlinedVector<int64_t, 3>& permutation) {\n+  if (!LayoutUtil::IsMonotonicWithDim0Major(input_shape.layout()) ||\n+      !LayoutUtil::IsMonotonicWithDim0Major(output_shape.layout())) {\n+    return FailedPrecondition(\n+        \"Transpose normalization requires monotonic layouts. Layout \"\n+        \"normalization should have assigned the default layout.\");\n+  }\n+\n   permutation.clear();\n   // Drop degenerate dimensions.\n   absl::InlinedVector<int64_t, 3> delta(output_shape.dimensions().size() + 1,\n                                         0);\n-  auto input_dimensions =\n-      Permute(output_shape.dimensions(), InversePermutation(dimensions));\n   for (int i = 0; i < output_shape.dimensions().size(); ++i) {\n     delta[i + 1] = delta[i];\n-    if (input_dimensions[i] == static_cast<int64_t>(1)) {\n+    if (input_shape.dimensions(i) == static_cast<int64_t>(1)) {\n       ++delta[i + 1];\n     }\n   }"
        },
        {
            "sha": "545b247fbc2a2c864ba29352cafd61e758b1f46a",
            "filename": "third_party/xla/xla/shape_util.h",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fshape_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fshape_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fshape_util.h?ref=09c97bbcf667f5325107c82ff35df9f82a547a1c",
            "patch": "@@ -463,8 +463,12 @@ class ShapeUtil {\n   // 'dimensions' is set to {3, 1, 0, 2}. This means the corresponding input\n   // shape is [10, 1, 11, 32]. The normalized output shape is [32, 110] with\n   // 'permutation' set to {1,0}.\n-  static absl::InlinedVector<int64_t, 3> GetNormalizedLogicalTransposeShape(\n-      const Shape& output_shape, absl::Span<int64_t const> dimensions,\n+  // Note: the method fails if the input shape or the output shape has a\n+  // non-monotonic layout.\n+  static absl::StatusOr<absl::InlinedVector<int64_t, 3>>\n+  GetNormalizedLogicalTransposeShape(\n+      const Shape& input_shape, const Shape& output_shape,\n+      absl::Span<int64_t const> dimensions,\n       absl::InlinedVector<int64_t, 3>& permutation);\n \n   // Returns an empty tuple shape. Can be used as a sentinel Shape value."
        },
        {
            "sha": "8d3cedb6d1d21a16dc68fcc73d1981c30cab79e2",
            "filename": "third_party/xla/xla/shape_util_test.cc",
            "status": "modified",
            "additions": 59,
            "deletions": 26,
            "changes": 85,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fshape_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09c97bbcf667f5325107c82ff35df9f82a547a1c/third_party%2Fxla%2Fxla%2Fshape_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fshape_util_test.cc?ref=09c97bbcf667f5325107c82ff35df9f82a547a1c",
            "patch": "@@ -1305,7 +1305,7 @@ TEST(ShapeUtilTest, B_250640044) {\n              is_dynamic_dimension: false\n            })pb\",\n       &proto));\n-  TF_ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n+  ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n   EXPECT_FALSE(ShapeUtil::ValidateShape(shape).ok());\n }\n \n@@ -1339,7 +1339,7 @@ TEST(ShapeUtilTest, B_251055887) {\n           physical_shape { element_type: -562 }\n         })pb\",\n       &proto));\n-  TF_ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n+  ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n   EXPECT_FALSE(ShapeUtil::ValidateShape(shape).ok());\n }\n \n@@ -1350,14 +1350,14 @@ TEST(ShapeUtilTest, B_385192799) {\n   {\n     EXPECT_TRUE(tsl::protobuf::TextFormat::ParseFromString(\n         R\"pb(element_type: 2000)pb\", &proto));\n-    TF_ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n+    ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n     EXPECT_FALSE(ShapeUtil::ValidateShape(shape).ok());\n   }\n \n   {\n     EXPECT_TRUE(tsl::protobuf::TextFormat::ParseFromString(\n         R\"pb(element_type: -1)pb\", &proto));\n-    TF_ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n+    ASSERT_OK_AND_ASSIGN(Shape shape, Shape::FromProto(proto));\n     EXPECT_FALSE(ShapeUtil::ValidateShape(shape).ok());\n   }\n }\n@@ -1781,124 +1781,157 @@ BENCHMARK(BM_ForEachIndexNoStatus)->Arg(0)->Arg(1)->Arg(2);\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {32, 1, 10, 11});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {10, 1, 11, 32});\n   absl::InlinedVector<int64_t, 3> dimensions = {3, 1, 0, 2};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(32, 110));\n   EXPECT_THAT(permutation, ElementsAre(1, 0));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape2) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {20, 30, 50});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {50, 20, 30});\n   absl::InlinedVector<int64_t, 3> dimensions = {1, 2, 0};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(600, 50));\n   EXPECT_THAT(permutation, ElementsAre(1, 0));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_NoTranspose) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {64, 1, 128});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {64, 128, 1});\n   absl::InlinedVector<int64_t, 3> dimensions = {0, 2, 1};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(8192));\n   EXPECT_THAT(permutation, IsEmpty());\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_Simple2D) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {64, 128});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {128, 64});\n   absl::InlinedVector<int64_t, 3> dimensions = {1, 0};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(64, 128));\n   EXPECT_THAT(permutation, ElementsAre(1, 0));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_Simple3D_021) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {8, 16, 32768});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {8, 32768, 16});\n   absl::InlinedVector<int64_t, 3> dimensions = {0, 2, 1};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(8, 16, 32768));\n   EXPECT_THAT(permutation, ElementsAre(0, 2, 1));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_Simple3D_210) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {16, 32768, 8});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {8, 32768, 16});\n   absl::InlinedVector<int64_t, 3> dimensions = {2, 1, 0};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(16, 32768, 8));\n   EXPECT_THAT(permutation, ElementsAre(2, 1, 0));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_Simple4D) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {16, 32768, 8, 4});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {32768, 4, 16, 8});\n   absl::InlinedVector<int64_t, 3> dimensions = {2, 0, 3, 1};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(16, 32768, 8, 4));\n   EXPECT_THAT(permutation, ElementsAre(2, 0, 3, 1));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_NormalizeTo3D) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {8, 16, 32, 32, 32});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {8, 32, 32, 32, 16});\n   absl::InlinedVector<int64_t, 3> dimensions = {0, 4, 1, 2, 3};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(8, 16, 32768));\n   EXPECT_THAT(permutation, ElementsAre(0, 2, 1));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_LargeShapeSizeOverflow) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {16, 4096, 4096, 128});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {4096, 4096, 128, 16});\n   absl::InlinedVector<int64_t, 3> dimensions = {3, 0, 1, 2};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(16, 2147483648));\n   EXPECT_THAT(permutation, ElementsAre(1, 0));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_DegenerateDims) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {1, 32, 1, 64, 1, 3, 1});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {1, 32, 1, 3, 1, 64, 1});\n   absl::InlinedVector<int64_t, 3> dimensions = {6, 1, 4, 5, 2, 3, 0};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(32, 64, 3));\n   EXPECT_THAT(permutation, ElementsAre(0, 2, 1));\n }\n \n TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_TransposeWithGrouping) {\n   Shape output_shape = ShapeUtil::MakeShape(F32, {10, 1, 32, 100, 2});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {100, 1, 10, 32, 2});\n   absl::InlinedVector<int64_t, 3> dimensions = {2, 1, 3, 0, 4};\n   absl::InlinedVector<int64_t, 3> permutation;\n-  auto normalized_shape = ShapeUtil::GetNormalizedLogicalTransposeShape(\n-      output_shape, dimensions, permutation);\n+  ASSERT_OK_AND_ASSIGN(auto normalized_shape,\n+                       ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                           input_shape, output_shape, dimensions, permutation));\n \n   EXPECT_THAT(normalized_shape, ElementsAre(320, 100, 2));\n   EXPECT_THAT(permutation, ElementsAre(1, 0, 2));\n }\n \n+TEST(ShapeUtilTest, GetNormalizedLogicalTransposeShape_InvalidLayout) {\n+  Shape output_shape = ShapeUtil::MakeShape(F32, {32, 10});\n+  *output_shape.mutable_layout() = LayoutUtil::MakeLayout({0, 1});\n+  Shape input_shape = ShapeUtil::MakeShape(F32, {10, 32});\n+  absl::InlinedVector<int64_t, 3> dimensions = {1, 0};\n+  absl::InlinedVector<int64_t, 3> permutation;\n+  EXPECT_FALSE(ShapeUtil::GetNormalizedLogicalTransposeShape(\n+                   input_shape, output_shape, dimensions, permutation)\n+                   .ok());\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 87,
        "deletions": 51
    }
}