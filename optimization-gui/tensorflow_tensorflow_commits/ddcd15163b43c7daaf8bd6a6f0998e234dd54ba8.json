{
    "author": "tensorflower-gardener",
    "message": "[XLA:PJRT] Add call_location field to PJRT and IFRT\n\nPiperOrigin-RevId: 804489496",
    "sha": "ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
    "files": [
        {
            "sha": "5bd52a40f45a474e8fd18c649a8af39c7c2de776",
            "filename": "third_party/xla/xla/pjrt/c/CHANGELOG.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -1,5 +1,9 @@\n # PJRT C API changelog\n \n+## 0.76\n+\n+* Added `call_location` to `PJRT_ExecuteOptions`\n+\n ## 0.75\n \n * Added `PJRT_TopologyDescription_Deserialize.`"
        },
        {
            "sha": "bdc88a5553fe9521df7cd8ecc719f041d1b8cb34",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api.h",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -101,7 +101,7 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Extension_Base, next);\n // Changes include:\n // * Adding a new field to the PJRT_Api or argument structs\n // * Renaming a method or argument (doesn't affect ABI)\n-#define PJRT_API_MINOR 75\n+#define PJRT_API_MINOR 76\n \n // The plugin should set the major_version and minor_version of\n // PJRT_Api.pjrt_api_version to be the `PJRT_API_MAJOR` and `PJRT_API_MINOR` in\n@@ -1649,8 +1649,20 @@ struct PJRT_ExecuteOptions {\n   const int64_t* non_donatable_input_indices;\n   size_t num_non_donatable_input_indices;\n   PJRT_ExecuteContext* context;\n-};\n-PJRT_DEFINE_STRUCT_TRAITS(PJRT_ExecuteOptions, context);\n+  // The `call_location` field is used to pass down call site location\n+  // information from higher-level frameworks like JAX and PyTorch to the PJRT\n+  // plugin. This field stores the source location (e.g., file:line) of the\n+  // Python code that triggered the execution of this compiled program. This\n+  // differs from the source location metadata stored in `OpMetadata`, which\n+  // refers to the origin of individual operations within the HLO module.\n+  // The plugin can use `call_location` for debugging and error reporting,\n+  // allowing users to pinpoint which program execution led to an issue.\n+  // The `call_location` pointer is owned by the caller and must point to a\n+  // null-terminated string. It is only valid for the duration of the C API\n+  // call. The plugin must copy the string if it needs to be stored.\n+  const char* call_location;\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_ExecuteOptions, call_location);\n \n struct PJRT_LoadedExecutable_Execute_Args {\n   size_t struct_size;"
        },
        {
            "sha": "843291ad9c2195f8264fbb9002827a1750ca7f44",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -1734,6 +1734,9 @@ PJRT_Error* PJRT_LoadedExecutable_Execute(\n \n   xla::ExecuteOptions options;\n   options.launch_id = args->options->launch_id;\n+  if (args->options->call_location) {\n+    options.call_location = std::string(args->options->call_location);\n+  }\n   options.strict_shape_checking = true;\n   options.arguments_are_tupled = false;\n   options.untuple_result = true;"
        },
        {
            "sha": "50490cbd9d1e219702e6583872de5ab6ada7b3ef",
            "filename": "third_party/xla/xla/pjrt/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -1992,6 +1992,9 @@ PjRtCApiLoadedExecutable::GetCommonExecuteArgs(\n   args.options->non_donatable_input_indices =\n       non_donatable_input_indices_storage.data();\n   args.num_devices = argument_handles.size();\n+  if (pjrt_c_api()->pjrt_api_version.minor_version >= 76) {\n+    args.options->call_location = options.call_location.c_str();\n+  }\n \n   // If the executable has no addressable devices, `num_args` cannot be\n   // determined but it is unused. 0 serves as a placeholder."
        },
        {
            "sha": "4c2b716eac976b6dbce6049778756e02416b757e",
            "filename": "third_party/xla/xla/pjrt/pjrt_executable.h",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable.h?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -279,6 +279,19 @@ struct ExecuteOptions {\n   // may be executed in any order and concurrently.\n   int64_t execution_stream_id = 0;\n \n+  // The `call_location` field is used to pass down call site location\n+  // information from higher-level frameworks like JAX and PyTorch to the PJRT\n+  // plugin. This field stores the source location (e.g., file:line) of the\n+  // Python code that triggered the execution of this compiled program. This\n+  // differs from the source location metadata stored in `OpMetadata`, which\n+  // refers to the origin of individual operations within the HLO module.\n+  // The plugin can use `call_location` for debugging and error reporting,\n+  // allowing users to pinpoint which program execution led to an issue.\n+  // The `call_location` pointer is owned by the caller and must point to a\n+  // null-terminated string. It is only valid for the duration of the C API\n+  // call. The plugin must copy the string if it needs to be stored.\n+  std::string call_location = \"\";\n+\n   absl::StatusOr<ExecuteOptionsProto> ToProto() const;\n   static absl::StatusOr<ExecuteOptions> FromProto(\n       const ExecuteOptionsProto& proto);"
        },
        {
            "sha": "7eb4aa8c17e238f20a81dcd71ab34914787cb057",
            "filename": "third_party/xla/xla/pjrt/pjrt_executable_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_executable_test.cc?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -73,6 +73,7 @@ TEST(ExecuteOptionsTest, Serialization) {\n   src.strict_shape_checking = true;\n   src.execution_mode = ExecuteOptions::ExecutionMode::kAsynchronous;\n   src.non_donatable_input_indices = {2, 3};\n+  src.call_location = \"foo:1\";\n \n   TF_ASSERT_OK_AND_ASSIGN(ExecuteOptionsProto proto, src.ToProto());\n   TF_ASSERT_OK_AND_ASSIGN(ExecuteOptions output,"
        },
        {
            "sha": "48a63f310e0255dfc91db4f0e609c8b11cca569d",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <optional>\n #include <string>\n #include <utility>\n+#include <variant>\n #include <vector>\n \n #include \"absl/container/flat_hash_map.h\"\n@@ -44,6 +45,7 @@ limitations under the License.\n #include \"xla/pjrt/pjrt_layout.h\"\n #include \"xla/primitive_util.h\"\n #include \"xla/python/ifrt/array.h\"\n+#include \"xla/python/ifrt/attribute_map.h\"\n #include \"xla/python/ifrt/basic_device_list.h\"\n #include \"xla/python/ifrt/device.h\"\n #include \"xla/python/ifrt/device_list.h\"\n@@ -570,6 +572,20 @@ PjRtLoadedExecutable::Execute(absl::Span<ArrayRef> args,\n   opts.non_donatable_input_indices = options.non_donatable_input_indices;\n   opts.execution_stream_id = options.execution_stream_id;\n \n+  if (options.custom_options.has_value()) {\n+    const auto& attributes = options.custom_options->map();\n+    // Check if the custom options contain a call location key.\n+    if (auto it = attributes.find(\n+            xla::ifrt::PjRtCompatibleLoadedExecutable::kCallLocation);\n+        it != attributes.end()) {\n+      const xla::ifrt::AttributeMap::Value& value = it->second;\n+      if (const auto* call_location =\n+              std::get_if<xla::ifrt::AttributeMap::StringValue>(&value)) {\n+        opts.call_location = call_location->value;\n+      }\n+    }\n+  }\n+\n   auto context = std::make_unique<xla::ExecuteContext>();\n   auto platform_id = pjrt_loaded_executable_->client()->platform_id();\n   auto ffi_callbacks = std::make_unique<xla::FfiLoadedHostCallbacks>();"
        },
        {
            "sha": "aafd156488668752a8fc2669eba021898b0c10a3",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h?ref=ddcd15163b43c7daaf8bd6a6f0998e234dd54ba8",
            "patch": "@@ -72,6 +72,9 @@ class PjRtCompatibleLoadedExecutable\n     : public llvm::RTTIExtends<PjRtCompatibleLoadedExecutable,\n                                LoadedExecutable> {\n  public:\n+  // Key for the call location attribute in the custom_options attribute map.\n+  static constexpr absl::string_view kCallLocation = \"call_location\";\n+\n   // APIs that allow direct access to `xla::PjRtLoadedExecutable` for PjRt-only\n   // operations.\n   virtual xla::PjRtLoadedExecutable* pjrt_loaded_executable() = 0;"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 58,
        "deletions": 3
    }
}