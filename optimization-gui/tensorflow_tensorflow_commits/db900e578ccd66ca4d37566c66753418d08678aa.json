{
    "author": "vksnk",
    "message": "[XLA:CPU] Refactor grouped convolution handling in YNN emitter.\n\nFor the grouped convolutions split_dim of the input buffer is now combined into one call with stencil copy.\n\nPiperOrigin-RevId: 848260240",
    "sha": "db900e578ccd66ca4d37566c66753418d08678aa",
    "files": [
        {
            "sha": "b2fdada31d3618f004201a2a0e5e7f94c0c8b789",
            "filename": "third_party/xla/xla/backends/cpu/ynn_emitter.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 34,
            "changes": 65,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/db900e578ccd66ca4d37566c66753418d08678aa/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/db900e578ccd66ca4d37566c66753418d08678aa/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_emitter.cc?ref=db900e578ccd66ca4d37566c66753418d08678aa",
            "patch": "@@ -436,37 +436,21 @@ static ynn_status DefineConvolution(\n     uint32_t input1_id, uint32_t input2_id, uint32_t output_id,\n     const std::vector<size_t>& filter_dims, const std::vector<size_t>& out_dims,\n     size_t feature_group_count, size_t input_channels,\n-    size_t kernel_output_channels, const std::vector<int32_t>& stencil_axes,\n-    const std::vector<int32_t>& new_axes,\n-    const std::vector<size_t>& stencil_dims,\n-    const std::vector<size_t>& stencil_strides,\n-    const std::vector<size_t>& stencil_dilations,\n+    size_t kernel_output_channels, std::vector<int32_t> stencil_axes,\n+    std::vector<size_t> stencil_dims, std::vector<size_t> stencil_strides,\n+    std::vector<size_t> stencil_dilations,\n     const std::vector<int64_t>& padding_lows,\n     const std::vector<int64_t>& padding_highs) {\n+  size_t num_k_dims = stencil_dims.size() + 1;\n   ynn_status status;\n \n-  // Make a copy in case we need to shift these for grouped convolution.\n-  std::vector<int32_t> new_axes_shifted = new_axes;\n-\n   // We will need to create an intermediate buffer for the output if it's\n   // grouped convolution.\n   uint32_t output_unfused_id =\n       feature_group_count != 1 ? YNN_INVALID_VALUE_ID : output_id;\n \n   if (feature_group_count != 1) {\n     uint32_t split_id = YNN_INVALID_VALUE_ID;\n-\n-    // [n, h, w, ci] -> [n, h, w, g, 1, ci/g].\n-    size_t input_split[] = {feature_group_count, 1,\n-                            input_channels / feature_group_count};\n-    status =\n-        ynn_define_split_dim(subgraph, /*axis=*/-1, /*num_splits=*/3,\n-                             input_split, input1_id, &split_id, /*flags=*/0);\n-    if (status != ynn_status_success) {\n-      return status;\n-    }\n-    input1_id = split_id;\n-    split_id = YNN_INVALID_VALUE_ID;\n     CHECK_EQ(filter_dims.size(), 4);\n     // [kh, kw, ci/g, co] -> [kh, kw, ci/g, g, co/g].\n     size_t filter_split[] = {feature_group_count,\n@@ -506,11 +490,6 @@ static ynn_status DefineConvolution(\n     if (status != ynn_status_success) {\n       return status;\n     }\n-\n-    // Shift new stencil axes by two.\n-    for (int i = 0; i < new_axes_shifted.size(); ++i) {\n-      new_axes_shifted[i] += 2;\n-    }\n   }\n \n   // If any of paddings is not zero, define a padding value and pad the input.\n@@ -543,20 +522,40 @@ static ynn_status DefineConvolution(\n     padding_id = YNN_INVALID_VALUE_ID;\n   }\n \n+  std::vector<int32_t> new_axes;\n+\n+  if (feature_group_count != 1) {\n+    // (n, h, w, c) -> (n, h, w, [g, 1,] kh, kw, c / g)\n+    stencil_dims.push_back(feature_group_count);\n+    stencil_dims.push_back(1);\n+    stencil_axes.push_back(3);\n+    stencil_axes.push_back(3);\n+    // We need to insert stencil dimensions [kh, kw] right before the channel\n+    // dimension and [g, 1] before stencil dimensions.\n+    new_axes = {-3, -2, -5, -4};\n+    stencil_strides.push_back(1);\n+    stencil_strides.push_back(1);\n+    stencil_dilations.push_back(input_channels / feature_group_count);\n+    stencil_dilations.push_back(1);\n+  } else {\n+    // We need to insert stencil dimensions [kh, kw] right before the channel\n+    // dimension.\n+    new_axes = {-3, -2};\n+  }\n+\n   uint32_t stencil_id = YNN_INVALID_VALUE_ID;\n   // Make a stenciled view of the input [n, h, w, ci] -> [n, h, w, kh, kw, ci].\n   status = ynn_define_stencil_copy(\n       subgraph, /*num_stencils=*/stencil_dims.size(), stencil_axes.data(),\n-      new_axes_shifted.data(), stencil_dims.data(), stencil_strides.data(),\n+      new_axes.data(), stencil_dims.data(), stencil_strides.data(),\n       stencil_dilations.data(), input1_id, YNN_INVALID_VALUE_ID, &stencil_id,\n       /*flags=*/0);\n   if (status != ynn_status_success) {\n     return status;\n   }\n \n-  status = ynn_define_dot(subgraph, /*num_k_dims=*/stencil_dims.size() + 1,\n-                          stencil_id, input2_id, YNN_INVALID_VALUE_ID,\n-                          &output_unfused_id,\n+  status = ynn_define_dot(subgraph, num_k_dims, stencil_id, input2_id,\n+                          YNN_INVALID_VALUE_ID, &output_unfused_id,\n                           /*flags=*/0);\n \n   if (status != ynn_status_success) {\n@@ -714,7 +713,6 @@ static absl::StatusOr<YnnSubgraph> EmitYnnConvolutionSubgraph(\n       conv->convolution_dimension_numbers();\n \n   std::vector<int32_t> stencil_axes(conv_window_dims_size);\n-  std::vector<int32_t> new_axes(conv_window_dims_size);\n   std::vector<size_t> stencil_dims(conv_window_dims_size);\n   std::vector<size_t> stencil_strides(conv_window_dims_size);\n   std::vector<size_t> stencil_dilations(conv_window_dims_size);\n@@ -730,17 +728,16 @@ static absl::StatusOr<YnnSubgraph> EmitYnnConvolutionSubgraph(\n     padding_highs[i] = conv_window.dimensions(i).padding_high();\n   }\n \n-  std::iota(new_axes.begin(), new_axes.end(), lhs_dims.size() - 1);\n-\n   YNN_RETURN_IF_ERROR(DefineConvolution(\n       subgraph.get(), ynn_lhs_type, ynn_out_type, lhs_id, rhs_id, out_id,\n       rhs_dims, out_dims, conv->feature_group_count(),\n       conv->operand(0)->shape().dimensions(\n           conv_dimensions.input_feature_dimension()),\n       conv->operand(1)->shape().dimensions(\n           conv_dimensions.kernel_output_feature_dimension()),\n-      stencil_axes, new_axes, stencil_dims, stencil_strides, stencil_dilations,\n-      padding_lows, padding_highs));\n+      std::move(stencil_axes), std::move(stencil_dims),\n+      std::move(stencil_strides), std::move(stencil_dilations), padding_lows,\n+      padding_highs));\n \n   ynn_status status = ynn_optimize_subgraph(\n       subgraph.get(), /*threadpool=*/nullptr, /*flags=*/0);"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 31,
        "deletions": 34
    }
}