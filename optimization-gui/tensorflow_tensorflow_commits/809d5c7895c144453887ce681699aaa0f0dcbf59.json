{
    "author": "nvgrw",
    "message": "cpu_compiler_internals_test is compiler-specific. Invoke CpuCompiler directly.\n\nPiperOrigin-RevId: 823138394",
    "sha": "809d5c7895c144453887ce681699aaa0f0dcbf59",
    "files": [
        {
            "sha": "393e5c8513eea730ff2984ec13ed453f5b963b5a",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/809d5c7895c144453887ce681699aaa0f0dcbf59/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/809d5c7895c144453887ce681699aaa0f0dcbf59/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=809d5c7895c144453887ce681699aaa0f0dcbf59",
            "patch": "@@ -503,19 +503,19 @@ xla_test(\n     ],\n )\n \n-xla_test(\n+xla_cc_test(\n     name = \"cpu_compiler_internals_test\",\n     srcs = [\"cpu_compiler_internals_test.cc\"],\n-    backends = [\n-        \"cpu\",\n-    ],\n     deps = [\n+        \":cpu_compiler_pure\",\n         \"//xla/backends/cpu/codegen/emitters:cpu_fusion_emitter_config\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/hlo/testlib:verified_hlo_module\",\n         \"//xla/service:llvm_compiler\",\n         \"//xla/tests:hlo_test_base\",\n         \"//xla/tests:xla_internal_test_main\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"@com_google_absl//absl/base:nullability\","
        },
        {
            "sha": "9c570ddcb877421fa3ce79e41290f14aef091e95",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler_internals_test.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 21,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/809d5c7895c144453887ce681699aaa0f0dcbf59/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler_internals_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/809d5c7895c144453887ce681699aaa0f0dcbf59/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler_internals_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler_internals_test.cc?ref=809d5c7895c144453887ce681699aaa0f0dcbf59",
            "patch": "@@ -28,17 +28,20 @@ limitations under the License.\n #include \"llvm/Support/Casting.h\"\n #include \"xla/backends/cpu/codegen/emitters/cpu_fusion_emitter_config.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n+#include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/testlib/verified_hlo_module.h\"\n+#include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/service/llvm_compiler.h\"\n #include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n \n namespace xla {\n namespace cpu {\n namespace {\n \n-using CpuCompilerInternalsTest = HloTestBase;\n+using CpuCompilerInternalsTest = HloHardwareIndependentTestBase;\n \n std::optional<int64_t> GetMetadataInt(llvm::Metadata* absl_nullable value) {\n   if (value == nullptr) {\n@@ -106,8 +109,12 @@ TEST_F(CpuCompilerInternalsTest, DylibWithThunks) {\n   DebugOptions& debug_options =\n       hlo_module->mutable_config().mutable_debug_options();\n   debug_options.set_xla_cpu_use_fusion_emitters(false);\n-  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> optimized_module,\n-                          GetOptimizedModule(std::move(hlo_module)));\n+\n+  CpuCompiler compiler;\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<HloModule> optimized_module,\n+      compiler.RunHloPasses(std::move(hlo_module), /*stream_exec=*/nullptr,\n+                            /*options=*/{}));\n \n   int64_t max_seen = -1;\n   auto pre_opt_hook = [&](const llvm::Module& llvm_module) {\n@@ -117,14 +124,11 @@ TEST_F(CpuCompilerInternalsTest, DylibWithThunks) {\n     }\n   };\n \n-  LLVMCompiler* compiler = static_cast<LLVMCompiler*>(backend().compiler());\n-  compiler->SetPreOptimizationHook(pre_opt_hook);\n-  ASSERT_TRUE(compiler\n-                  ->RunBackend(std::move(optimized_module),\n-                               backend().default_stream_executor(),\n-                               /*device_allocator=*/nullptr)\n-                  .ok());\n-  compiler->RemovePreOptimizationHook();\n+  compiler.SetPreOptimizationHook(pre_opt_hook);\n+  TF_ASSERT_OK(compiler.RunBackend(std::move(optimized_module),\n+                                   /*stream_exec=*/nullptr,\n+                                   /*options=*/{}));\n+  compiler.RemovePreOptimizationHook();\n \n   EXPECT_GT(max_seen, 0) << \"max dylib_index(\" << max_seen << \") too low; \"\n                          << \"expected to use more dylibs.\";\n@@ -137,8 +141,12 @@ TEST_F(CpuCompilerInternalsTest, JustOneDylibWithThunks) {\n       hlo_module->mutable_config().mutable_debug_options();\n   debug_options.set_xla_cpu_use_fusion_emitters(false);\n   debug_options.set_xla_cpu_parallel_codegen_split_count(1);\n-  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> optimized_module,\n-                          GetOptimizedModule(std::move(hlo_module)));\n+\n+  CpuCompiler compiler;\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<HloModule> optimized_module,\n+      compiler.RunHloPasses(std::move(hlo_module), /*stream_exec=*/nullptr,\n+                            /*options=*/{}));\n \n   int64_t max_seen = -1;\n   auto pre_opt_hook = [&](const llvm::Module& llvm_module) {\n@@ -148,14 +156,10 @@ TEST_F(CpuCompilerInternalsTest, JustOneDylibWithThunks) {\n     }\n   };\n \n-  LLVMCompiler* compiler = static_cast<LLVMCompiler*>(backend().compiler());\n-  compiler->SetPreOptimizationHook(pre_opt_hook);\n-  ASSERT_TRUE(compiler\n-                  ->RunBackend(std::move(optimized_module),\n-                               backend().default_stream_executor(),\n-                               /*device_allocator=*/nullptr)\n-                  .ok());\n-  compiler->RemovePreOptimizationHook();\n+  compiler.SetPreOptimizationHook(pre_opt_hook);\n+  TF_ASSERT_OK(compiler.RunBackend(std::move(optimized_module),\n+                                   /*stream_exec=*/nullptr, /*options=*/{}));\n+  compiler.RemovePreOptimizationHook();\n \n   EXPECT_EQ(max_seen, 0) << \"max dylib_index(\" << max_seen\n                          << \") != 0, but only \""
        }
    ],
    "stats": {
        "total": 54,
        "additions": 29,
        "deletions": 25
    }
}