{
    "author": "d4n1elchen",
    "message": "[XLA:HLO Diff] Refactor HLO diff span attributes to use `data-diffid` and `data-diffid-mapped`.\n\nFixes the click to scroll function broken by many-to-many computation group support.\n\nPiperOrigin-RevId: 805977595",
    "sha": "f4e928c794cdabc598f843b443c9c7b3a6d1071a",
    "files": [
        {
            "sha": "13c23d2b3b8dc05b48c44f1a7cd6511bff178ce2",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 134,
            "deletions": 116,
            "changes": 250,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f4e928c794cdabc598f843b443c9c7b3a6d1071a/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f4e928c794cdabc598f843b443c9c7b3a6d1071a/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=f4e928c794cdabc598f843b443c9c7b3a6d1071a",
            "patch": "@@ -357,132 +357,140 @@ std::string PrintJavascriptForHoverEvent() {\n       }, 3000);\n   }\n \n-  const allSpans = document.querySelectorAll('span[data-diffid]');\n+  const allSpans = document.querySelectorAll('span[data-diffid][data-diffid-mapped]');\n   allSpans.forEach(span => {\n       span.addEventListener('mouseover', handleMouseOver);\n       span.addEventListener('mouseout', handleMouseOut);\n       span.addEventListener('click', handleSpanClick);\n       span.addEventListener('dblclick', handleSpanDoubleClick);\n   });\n+\n+  function getRelatedSpans(diffId, mappedId) {\n+    return document.querySelectorAll(`span[data-diffid=\"${diffId}\"][data-diffid-mapped=\"${mappedId}\"], span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+  }\n+\n   function handleMouseOver(event) {\n       const diffId = event.target.getAttribute('data-diffid');\n-      if (!diffId) {\n+      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+      if (!diffId || !mappedId) {\n           return;\n       }\n-      const relatedSpans = document.querySelectorAll(`span[data-diffid=\"${diffId}\"]`);\n+      const relatedSpans = getRelatedSpans(diffId, mappedId);\n       relatedSpans.forEach(relatedSpan => {\n           relatedSpan.classList.add('bordered');\n       });\n   }\n \n   function handleMouseOut(event) {\n       const diffId = event.target.getAttribute('data-diffid');\n-      if (!diffId) {\n+      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+      if (!diffId || !mappedId) {\n           return;\n       }\n-      const relatedSpans = document.querySelectorAll(`span[data-diffid=\"${diffId}\"]`);\n+      const relatedSpans = getRelatedSpans(diffId, mappedId);\n       relatedSpans.forEach(relatedSpan => {\n           relatedSpan.classList.remove('bordered');\n       });\n   }\n \n   function handleSpanClick(event) {\n       const diffId = event.target.getAttribute('data-diffid');\n-      if (!diffId) {\n+      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+      if (!diffId || !mappedId) {\n           return;\n       }\n \n       const clickedSpan = event.target;\n-      const clickedPre = clickedSpan.closest('.hlo-textbox').querySelector('pre');\n+      const clickedPre = clickedSpan.closest('pre');\n       if (!clickedPre) return;\n \n-      const idParts = clickedPre.id.split('-');\n-      const fingerprint = idParts[0];\n-      const isLeft = idParts[1] === 'left';\n-      const siblingPreId = fingerprint + '-' + (isLeft ? 'right' : 'left');\n-      const siblingPre = document.getElementById(siblingPreId);\n-\n-      if (siblingPre) {\n-          const targetSpan = siblingPre.querySelector(`span[data-diffid=\"${diffId}\"]`);\n-          if (targetSpan) {\n-              // Calculate the vertical offset of the clicked span from the top of its visible area.\n-              const clickedSpanViewportOffset = clickedSpan.offsetTop - clickedPre.scrollTop;\n-\n-              // Calculate the percentage of this offset within the clickedPre's visible height.\n-              const percentage = clickedPre.clientHeight > 0 ?\n-                  clickedSpanViewportOffset / clickedPre.clientHeight : 0;\n-\n-              // Calculate the desired offset for the targetSpan within the siblingPre's visible area.\n-              const desiredSiblingViewportOffset = percentage * siblingPre.clientHeight;\n-\n-              // Calculate the new scrollTop for siblingPre to achieve this alignment.\n-              const newScrollTop = targetSpan.offsetTop - desiredSiblingViewportOffset;\n-\n-              // Scroll the siblingPre element smoothly.\n-              siblingPre.scrollTo({\n-                  top: Math.max(0, newScrollTop),\n-                  behavior: 'smooth'\n-              });\n-\n-              // Temporarily highlight the target span\n-              targetSpan.classList.add('temp-highlight');\n-              setTimeout(() => {\n-                  targetSpan.classList.remove('temp-highlight');\n-              }, 2000); // Remove highlight after 2 seconds\n-          } else {\n-              ShowSystemMessage(\"Corresponding instruction is in another computation, double click to jump to it.\");\n-          }\n+      const selfTextboxes = clickedSpan.closest('.hlo-textboxes');\n+      if (!selfTextboxes) return;\n+      const siblingTextboxes = selfTextboxes.nextElementSibling || selfTextboxes.previousElementSibling;\n+      if (!siblingTextboxes || !siblingTextboxes.classList.contains('hlo-textboxes')) return;\n+\n+      const targetSpan = siblingTextboxes.querySelector(`span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+\n+      if (targetSpan) {\n+          const siblingPre = targetSpan.closest('pre');\n+          if (!siblingPre) return;\n+\n+          // Calculate the vertical offset of the clicked span from the top of its visible area.\n+          const clickedSpanViewportOffset = clickedSpan.offsetTop - clickedPre.scrollTop;\n+\n+          // Calculate the percentage of this offset within the clickedPre's visible height.\n+          const percentage = clickedPre.clientHeight > 0 ?\n+              clickedSpanViewportOffset / clickedPre.clientHeight : 0;\n+\n+          // Calculate the desired offset for the targetSpan within the siblingPre's visible area.\n+          const desiredSiblingViewportOffset = percentage * siblingPre.clientHeight;\n+\n+          // Calculate the new scrollTop for siblingPre to achieve this alignment.\n+          const newScrollTop = targetSpan.offsetTop - desiredSiblingViewportOffset;\n+\n+          // Scroll the siblingPre element smoothly.\n+          siblingPre.scrollTo({\n+              top: Math.max(0, newScrollTop),\n+              behavior: 'smooth'\n+          });\n+\n+          // Temporarily highlight the target span\n+          targetSpan.classList.add('temp-highlight');\n+          setTimeout(() => {\n+              targetSpan.classList.remove('temp-highlight');\n+          }, 2000); // Remove highlight after 2 seconds\n+      } else {\n+          ShowSystemMessage(\"Corresponding instruction is in another computation, double click to jump to it.\");\n       }\n   }\n \n   function handleSpanDoubleClick(event) {\n       const diffId = event.target.getAttribute('data-diffid');\n-      if (!diffId) {\n+      const mappedId = event.target.getAttribute('data-diffid-mapped');\n+      if (!diffId || !mappedId) {\n           return;\n       }\n \n       const clickedSpan = event.target;\n-      const clickedPre = clickedSpan.closest('.hlo-textbox').querySelector('pre');\n+      const clickedPre = clickedSpan.closest('pre');\n       if (!clickedPre) return;\n \n-      const idParts = clickedPre.id.split('-');\n-      const fingerprint = idParts[0];\n-      const isLeft = idParts[1] === 'left';\n-      const siblingPreId = fingerprint + '-' + (isLeft ? 'right' : 'left');\n-      const siblingPre = document.getElementById(siblingPreId);\n-\n-      if (siblingPre) {\n-          const targetSpan = siblingPre.querySelector(`span[data-diffid=\"${diffId}\"]`);\n-          if (!targetSpan) {\n-              // Case 2: Corresponding span NOT found in siblingPre.\n-              // Search for the span with the same diffId in other hlo-textbox-pairs.\n-              const allMatchingSpans = document.querySelectorAll(`span[data-diffid=\"${diffId}\"]`);\n-              let foundSpanInOtherPre = null;\n-              allMatchingSpans.forEach(span => {\n-                  if (span !== clickedSpan) {\n-                      foundSpanInOtherPre = span;\n-                  }\n-              });\n-\n-              if (foundSpanInOtherPre) {\n-                  const foundPre = foundSpanInOtherPre.closest('.hlo-textbox').querySelector('pre');\n-                  if (foundPre) {\n-                      // Find ancestor detail and open it.\n-                      let parentDetails = foundSpanInOtherPre.closest('details');\n-                      while (parentDetails) {\n-                          parentDetails.open = true;\n-                          parentDetails = parentDetails.parentElement ? parentDetails.parentElement.closest('details') : null;\n-                      }\n-\n-                      // Scroll the foundPre to make the foundSpanInOtherPre visible.\n-                      foundSpanInOtherPre.scrollIntoView({ behavior: 'smooth', block: 'center' });\n-\n-                      // Temporarily highlight the found span\n-                      foundSpanInOtherPre.classList.add('temp-highlight');\n-                      setTimeout(() => {\n-                          foundSpanInOtherPre.classList.remove('temp-highlight');\n-                      }, 3000);\n+      const selfTextboxes = clickedSpan.closest('.hlo-textboxes');\n+      if (!selfTextboxes) return;\n+      const siblingTextboxes = selfTextboxes.nextElementSibling || selfTextboxes.previousElementSibling;\n+      if (!siblingTextboxes || !siblingTextboxes.classList.contains('hlo-textboxes')) return;\n+\n+      const targetSpanInSibling = siblingTextboxes.querySelector(`span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+\n+      if (!targetSpanInSibling) {\n+          // Case 2: Corresponding span NOT found in sibling textboxes in same pair.\n+          // Search for the span with the same diffId in other hlo-textbox-pairs.\n+          const allMatchingSpans = document.querySelectorAll(`span[data-diffid=\"${mappedId}\"][data-diffid-mapped=\"${diffId}\"]`);\n+          let foundSpanInOtherPre = null;\n+          allMatchingSpans.forEach(span => {\n+              if (span !== clickedSpan) {\n+                  foundSpanInOtherPre = span;\n+              }\n+          });\n+\n+          if (foundSpanInOtherPre) {\n+              const foundPre = foundSpanInOtherPre.closest('pre');\n+              if (foundPre) {\n+                  // Find ancestor detail and open it.\n+                  let parentDetails = foundSpanInOtherPre.closest('details');\n+                  while (parentDetails) {\n+                      parentDetails.open = true;\n+                      parentDetails = parentDetails.parentElement ? parentDetails.parentElement.closest('details') : null;\n                   }\n+\n+                  // Scroll the foundPre to make the foundSpanInOtherPre visible.\n+                  foundSpanInOtherPre.scrollIntoView({ behavior: 'smooth', block: 'center' });\n+\n+                  // Temporarily highlight the found span\n+                  foundSpanInOtherPre.classList.add('temp-highlight');\n+                  setTimeout(() => {\n+                      foundSpanInOtherPre.classList.remove('temp-highlight');\n+                  }, 3000);\n               }\n           }\n       }\n@@ -647,8 +655,10 @@ std::string PrintTextbox(absl::string_view title, absl::string_view content,\n struct Attributes {\n   // The class name of the highlight. Empty if no highlight.\n   std::string highlight;\n-  // The diffid attribute of the span. Empty if no mapping to another span.\n+  // The diffid of instruction.\n   std::string diffid;\n+  // The diffid of mapped instruction. Empty if no mapping to another span.\n+  std::string mapped_diffid;\n   // The mapped instruction of the span. Null if no mapping to another span.\n   const HloInstruction* mapped_instruction;\n };\n@@ -658,40 +668,44 @@ absl::flat_hash_map<const HloInstruction*, Attributes> GenerateSpanAttributes(\n     const DiffResult& diff_result) {\n   absl::flat_hash_map<const HloInstruction*, Attributes> span_attributes;\n   for (auto& instruction : diff_result.left_module_unmatched_instructions) {\n-    span_attributes[instruction] = {.highlight = \"red-highlight\",\n-                                    .diffid = \"\",\n-                                    .mapped_instruction = nullptr};\n+    span_attributes[instruction] =\n+        Attributes{.highlight = \"red-highlight\",\n+                   .diffid = std::string(instruction->name()),\n+                   .mapped_diffid = \"\",\n+                   .mapped_instruction = nullptr};\n   }\n   for (auto& instruction : diff_result.right_module_unmatched_instructions) {\n-    span_attributes[instruction] = {.highlight = \"green-highlight\",\n-                                    .diffid = \"\",\n-                                    .mapped_instruction = nullptr};\n+    span_attributes[instruction] =\n+        Attributes{.highlight = \"green-highlight\",\n+                   .diffid = std::string(instruction->name()),\n+                   .mapped_diffid = \"\",\n+                   .mapped_instruction = nullptr};\n   }\n   for (const auto& [l_instruction, r_instruction] :\n        diff_result.changed_instructions) {\n-    span_attributes[l_instruction] = {\n-        .highlight = \"yellow-highlight\",\n-        .diffid =\n-            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n-        .mapped_instruction = r_instruction};\n-    span_attributes[r_instruction] = {\n-        .highlight = \"yellow-highlight\",\n-        .diffid =\n-            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n-        .mapped_instruction = l_instruction};\n+    span_attributes[l_instruction] =\n+        Attributes{.highlight = \"yellow-highlight\",\n+                   .diffid = std::string(l_instruction->name()),\n+                   .mapped_diffid = std::string(r_instruction->name()),\n+                   .mapped_instruction = r_instruction};\n+    span_attributes[r_instruction] =\n+        Attributes{.highlight = \"yellow-highlight\",\n+                   .diffid = std::string(r_instruction->name()),\n+                   .mapped_diffid = std::string(l_instruction->name()),\n+                   .mapped_instruction = l_instruction};\n   }\n   for (const auto& [l_instruction, r_instruction] :\n        diff_result.unchanged_instructions) {\n-    span_attributes[l_instruction] = {\n-        .highlight = \"\",\n-        .diffid =\n-            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n-        .mapped_instruction = r_instruction};\n-    span_attributes[r_instruction] = {\n-        .highlight = \"\",\n-        .diffid =\n-            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n-        .mapped_instruction = l_instruction};\n+    span_attributes[l_instruction] =\n+        Attributes{.highlight = \"\",\n+                   .diffid = std::string(l_instruction->name()),\n+                   .mapped_diffid = std::string(r_instruction->name()),\n+                   .mapped_instruction = r_instruction};\n+    span_attributes[r_instruction] =\n+        Attributes{.highlight = \"\",\n+                   .diffid = std::string(r_instruction->name()),\n+                   .mapped_diffid = std::string(l_instruction->name()),\n+                   .mapped_instruction = l_instruction};\n   }\n   return span_attributes;\n };\n@@ -737,14 +751,18 @@ std::string PrintHloComputationToHtml(\n           it != span_attributes.end() && !it->second.highlight.empty()\n               ? std::string(it->second.highlight) + \" highlighted\"\n               : \"\";\n-      std::string diffid =\n-          it != span_attributes.end() && !it->second.diffid.empty()\n-              ? absl::StrCat(\"data-diffid=\\\"\",\n-                             EscapeStringForHtmlAttribute(it->second.diffid),\n-                             \"\\\"\")\n-              : \"\";\n+      std::string diffid_attrs;\n+      if (it != span_attributes.end()) {\n+        absl::StrAppend(&diffid_attrs, \" data-diffid=\\\"\",\n+                        EscapeStringForHtmlAttribute(it->second.diffid), \"\\\"\");\n+        if (!it->second.mapped_diffid.empty()) {\n+          absl::StrAppend(\n+              &diffid_attrs, \" data-diffid-mapped=\\\"\",\n+              EscapeStringForHtmlAttribute(it->second.mapped_diffid), \"\\\"\");\n+        }\n+      }\n       printer.Append(absl::StrCat(\"<span class=\\\"hlo-instruction \",\n-                                  highlight_class, \"\\\"\", diffid, \" >\"));\n+                                  highlight_class, \"\\\"\", diffid_attrs, \" >\"));\n       printer.Append(\"  \");  // Instruction indentation (2 spaces)\n       if (instruction == comp->root_instruction()) {\n         printer.Append(\"ROOT \");"
        }
    ],
    "stats": {
        "total": 250,
        "additions": 134,
        "deletions": 116
    }
}