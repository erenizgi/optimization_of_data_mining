{
    "author": "ScXfjiang",
    "message": "PR #31387: [ROCm] remove reserved memory for rocm libraries\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31387\n\nThis PR removes the reserved memory for ROCm libraries, which is not needed anymore.\nCopybara import of the project:\n\n--\n6c17deccbbdf01340d7f5384ec00485877892716 by scxfjiang <xuefei.jiang@amd.com>:\n\nremove reserved memory for rocm libraries\n\nMerging this change closes #31387\n\nPiperOrigin-RevId: 809919220",
    "sha": "aa3dded831f10f7fb15e5387a791bd10fcf591c5",
    "files": [
        {
            "sha": "ab61f6902aa2d34c000c8af5f5492a3662efcbd8",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_context.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 55,
            "changes": 59,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/aa3dded831f10f7fb15e5387a791bd10fcf591c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_context.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/aa3dded831f10f7fb15e5387a791bd10fcf591c5/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_context.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_context.cc?ref=aa3dded831f10f7fb15e5387a791bd10fcf591c5",
            "patch": "@@ -60,45 +60,6 @@ hipCtx_t CurrentContext() {\n   return current;\n }\n \n-// Returns the amount of memory reserved by ROCm libraries.\n-bool GetReservedMemory(uint64_t* reserve) {\n-  hipDeviceProp_t props;\n-  hipDevice_t dev;\n-  hipError_t res = wrap::hipGetDevice(&dev);\n-\n-  if (res != hipSuccess) {\n-    LOG(FATAL) << \"failed to query current device: \" << ToString(res);\n-    return false;\n-  }\n-  res = wrap::hipGetDeviceProperties(&props, dev);\n-  if (res != hipSuccess) {\n-    LOG(ERROR) << \"failed to query device properties: \" << ToString(res);\n-    return false;\n-  }\n-\n-  std::string gcnArchName = props.gcnArchName;\n-  auto compute_capability = RocmComputeCapability(gcnArchName);\n-  // On gfx90a, we hide 1 GB of GPU memory (512MB for gfx908) from TF,\n-  // to allow for late allocations by internal ROCm libraries\n-  // (e.g. rocBLAS alone needs~200 MB to put its kernels as of ROCm 4.1)\n-  const uint64_t RESERVED_GFX908 = 1048576 * 512;\n-  const uint64_t RESERVED_GFX9_X = 1048576 * 1024;\n-  const uint64_t RESERVED_GFX10_X = 1048576 * 512;\n-  const uint64_t RESERVED_GFX11_X = 1048576 * 512;\n-  if (compute_capability.gfx9_mi100()) {\n-    *reserve = RESERVED_GFX908;\n-  } else if (compute_capability.gfx9_mi200_or_later()) {\n-    *reserve = RESERVED_GFX9_X;\n-  } else if (compute_capability.gfx10_rx68xx() ||\n-             compute_capability.gfx10_rx69xx()) {\n-    *reserve = RESERVED_GFX10_X;\n-  } else if (compute_capability.gfx11()) {\n-    *reserve = RESERVED_GFX11_X;\n-  }\n-\n-  return true;\n-}\n-\n }  // namespace\n \n // Returns the singleton ContextMap.\n@@ -126,12 +87,7 @@ bool RocmContext::GetDeviceTotalMemory(hipDevice_t device, uint64_t* result) {\n     LOG(ERROR) << \"failed to query total available memory: \" << ToString(res);\n     return false;\n   }\n-  uint64_t reserve = 0;\n-  if (!GetReservedMemory(&reserve)) {\n-    LOG(ERROR) << \"failed to reserved device memory for ROCm libraries\";\n-    return false;\n-  }\n-  *result = value - reserve;\n+  *result = value;\n   return true;\n }\n \n@@ -145,24 +101,17 @@ bool RocmContext::GetDeviceMemoryUsage(int64_t* free_out, int64_t* total_out) {\n     return false;\n   }\n \n-  uint64_t reserve = 0;\n-  if (!GetReservedMemory(&reserve)) {\n-    LOG(ERROR) << \"failed to reserved device memory for ROCm libraries\";\n-    return false;\n-  }\n-\n   VLOG(1) << \"Device memory: \" << total / 1048576 << \" MB total, \"\n-          << free / 1048576 << \" MB free, reserving \" << reserve / 1048576\n-          << \" MB\";\n+          << free / 1048576 << \" MB free\";\n \n   // overflow check\n   if (free > std::numeric_limits<int64_t>::max()) {\n     LOG(ERROR) << \"free memory (\" << free << \") is overflow int64_t\";\n     return false;\n   }\n \n-  *free_out = free >= reserve ? free - reserve : 0;\n-  *total_out = total - reserve;\n+  *free_out = free;\n+  *total_out = total;\n   return true;\n }\n "
        }
    ],
    "stats": {
        "total": 59,
        "additions": 4,
        "deletions": 55
    }
}