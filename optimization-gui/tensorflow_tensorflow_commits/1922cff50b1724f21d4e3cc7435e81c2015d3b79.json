{
    "author": "junwhanahn",
    "message": "Return `std::nullopt` from `xla::ifrt::LoadedExecutable::devices()` for portable executables\n\nPortable executables are not bound to any specific device list, so it makes sense to be explicit about it rather than letting each implementation return an unspecified value.\n\nPiperOrigin-RevId: 837188096",
    "sha": "1922cff50b1724f21d4e3cc7435e81c2015d3b79",
    "files": [
        {
            "sha": "733dd00f6eb2f73ad08f91d06d9b7c8da9142e9c",
            "filename": "third_party/xla/xla/backends/cpu/nanort/ifrt_client.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fifrt_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fifrt_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fifrt_client.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -1009,7 +1009,9 @@ class NanoExecutable final\n     return client_->addressable_devices();\n   }\n \n-  const ifrt::DeviceListRef& devices() const override { return devices_; }\n+  std::optional<ifrt::DeviceListRef> devices() const override {\n+    return devices_;\n+  }\n \n   static char ID;  // NOLINT\n "
        },
        {
            "sha": "7fc51e21a4755170a62c916f2ea8cf28cccfe899",
            "filename": "third_party/xla/xla/backends/cpu/nanort/ifrt_client_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fifrt_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fifrt_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fnanort%2Fifrt_client_test.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -337,6 +337,8 @@ int main(int argc, char** argv) {\n       \"*LoadedExecutableImplTest.GetHloModules*:\"\n       \"*LoadedExecutableImplTest.ProgramText*:\"\n       \"*LoadedExecutableImplTest.Analysis*:\"\n+      // NanoRT does not support portable execution.\n+      \"*LoadedExecutableImplTest.CompileAndExecutePortable*:\"\n       // Serialization is not implemented.\n       \"*SerializeAndLoad*\";\n   xla::ifrt::test_util::SetTestFilterIfNotUserSpecified(kFilter);"
        },
        {
            "sha": "bf9a4e380cec3b29a9da17c78c6bb97b85b56889",
            "filename": "third_party/xla/xla/python/ifrt/executable.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.h?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -279,8 +279,9 @@ class LoadedExecutable\n       std::optional<DeviceListRef> devices) = 0;\n \n   // Returns the list of devices where the executable has been compiled and\n-  // loaded onto.\n-  virtual const DeviceListRef& devices() const = 0;\n+  // loaded onto. Returns `std::nullopt` if the executable is not bound to a\n+  // particular device list, e.g., portable executables.\n+  virtual std::optional<DeviceListRef> devices() const = 0;\n \n   // The following APIs are taken from xla::PjRtLoadedExecutable for fast\n   // prototyping."
        },
        {
            "sha": "cca55d1ca94b7cbc4ab2760244ccaff2cde3dfde",
            "filename": "third_party/xla/xla/python/ifrt/mock.h",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fmock.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fmock.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fmock.h?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -317,13 +317,6 @@ class MockExecutable : public llvm::RTTIExtends<MockExecutable, Executable> {\n class MockLoadedExecutable\n     : public llvm::RTTIExtends<MockLoadedExecutable, LoadedExecutable> {\n  public:\n-  MockLoadedExecutable() {\n-    static absl::NoDestructor<DeviceListRef> kEmptyDeviceList(\n-        BasicDeviceList::Create({}));\n-    ON_CALL(*this, devices())\n-        .WillByDefault(testing::ReturnRef(*kEmptyDeviceList));\n-  }\n-\n   MOCK_METHOD(Client*, client, (), (const, final));\n   MOCK_METHOD(absl::string_view, name, (), (const, final));\n   MOCK_METHOD(absl::StatusOr<std::optional<std::string>>, Fingerprint, (),\n@@ -363,7 +356,7 @@ class MockLoadedExecutable\n               (final));\n   MOCK_METHOD(absl::Span<Device* const>, addressable_devices, (),\n               (const, final));\n-  MOCK_METHOD(const DeviceListRef&, devices, (), (const, final));\n+  MOCK_METHOD(std::optional<DeviceListRef>, devices, (), (const, final));\n \n   static char ID;  // NOLINT\n };"
        },
        {
            "sha": "0774883ed997bcdc0d9c685a8cab77d92ac9efff",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/compiler.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fcompiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fcompiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fcompiler.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -177,8 +177,10 @@ absl::StatusOr<xla::ifrt::LoadedExecutableRef> Compiler::CompileAndLoad(\n       devices.push_back(device);\n     }\n   }\n-  TF_ASSIGN_OR_RETURN(DeviceListRef device_list,\n-                      client_->MakeDeviceList(devices));\n+  std::optional<DeviceListRef> device_list;\n+  if (!devices.empty()) {\n+    TF_ASSIGN_OR_RETURN(device_list, client_->MakeDeviceList(devices));\n+  }\n \n   return std::make_unique<LoadedExecutable>(\n       client_, rpc_helper_, response->loaded_executable_handle(),"
        },
        {
            "sha": "ce1235204004f5691fc4f2776061fc53bda07ca9",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/executable.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -337,7 +337,8 @@ class LoadedExecutable::OutputSpecCache {\n \n LoadedExecutable::LoadedExecutable(\n     xla::ifrt::Client* client, std::shared_ptr<RpcHelper> rpc_helper,\n-    uint64_t handle, std::string name, int num_devices, DeviceListRef devices,\n+    uint64_t handle, std::string name, int num_devices,\n+    std::optional<DeviceListRef> devices,\n     std::vector<xla::ifrt::Device*> addressable_devices,\n     absl::StatusOr<std::optional<std::string>> fingerprint,\n     tsl::Future<> ready_future,\n@@ -843,7 +844,9 @@ LoadedExecutable::Execute(absl::Span<xla::ifrt::ArrayRef> args,\n   return result;\n }\n \n-const DeviceListRef& LoadedExecutable::devices() const { return devices_; }\n+std::optional<DeviceListRef> LoadedExecutable::devices() const {\n+  return devices_;\n+}\n \n absl::Span<xla::ifrt::Device* const> LoadedExecutable::addressable_devices()\n     const {"
        },
        {
            "sha": "749c7af950543f0279351d3f6a61447ac174d4a3",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/executable.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.h?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -59,7 +59,8 @@ class LoadedExecutable final\n  public:\n   LoadedExecutable(xla::ifrt::Client* client,\n                    std::shared_ptr<RpcHelper> rpc_helper, uint64_t handle,\n-                   std::string name, int num_devices, DeviceListRef devices,\n+                   std::string name, int num_devices,\n+                   std::optional<DeviceListRef> devices,\n                    std::vector<xla::ifrt::Device*> addressable_devices,\n                    absl::StatusOr<std::optional<std::string>> fingerprint,\n                    tsl::Future<> ready_future,\n@@ -111,7 +112,7 @@ class LoadedExecutable final\n       absl::Span<xla::ifrt::ArrayRef> args, const ExecuteOptions& options,\n       std::optional<xla::ifrt::DeviceListRef> devices) override;\n \n-  const DeviceListRef& devices() const override;\n+  std::optional<DeviceListRef> devices() const override;\n   absl::Span<xla::ifrt::Device* const> addressable_devices() const override;\n \n   static char ID;  // NOLINT\n@@ -148,7 +149,7 @@ class LoadedExecutable final\n   const uint64_t handle_;\n   const std::string name_;\n   const int num_devices_;\n-  const DeviceListRef devices_;\n+  const std::optional<DeviceListRef> devices_;\n   const std::vector<xla::ifrt::Device*> addressable_devices_;\n   const absl::StatusOr<std::optional<std::string>> fingerprint_;\n   const tsl::Future<> ready_future_;"
        },
        {
            "sha": "a3914e53d400ec2a9e0845ccda58b5dbf601562a",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -1456,8 +1456,12 @@ tsl::Future<BackendInterface::Response> IfrtBackend::HandleCompileRequest(\n     for (const auto* device : executable->addressable_devices()) {\n       compile_resp->add_addressable_device_ids(device->Id().value());\n     }\n-    for (const auto* device : executable->devices()->devices()) {\n-      compile_resp->add_device_ids(device->Id().value());\n+    if (std::optional<xla::ifrt::DeviceListRef> device_list =\n+            executable->devices();\n+        device_list.has_value()) {\n+      for (const auto* device : (*device_list)->devices()) {\n+        compile_resp->add_device_ids(device->Id().value());\n+      }\n     }\n     // TODO(b/282757875): Consider making fingerprint calculation asynchronous\n     // if it is expected to take long."
        },
        {
            "sha": "fd4cefa44035b4578ed6fc1762e801a6339b20e4",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -1157,7 +1157,8 @@ TEST_P(IfrtBackendHandlerTest, CompileSuccess) {\n   auto executable = std::make_unique<MockLoadedExecutable>();\n   EXPECT_CALL(*executable, name()).WillOnce(Return(\"executable_name\"));\n   EXPECT_CALL(*executable, num_devices()).WillOnce(Return(4));\n-  EXPECT_CALL(*executable, devices()).WillOnce(ReturnRef(device_list));\n+  EXPECT_CALL(*executable, devices())\n+      .WillOnce(Return(std::make_optional(device_list)));\n   EXPECT_CALL(*executable, addressable_devices())\n       .WillOnce(Return(absl::MakeSpan(addressable_devices)));\n   EXPECT_CALL(*executable, Fingerprint()).WillOnce(Return(\"fingerprint\"));"
        },
        {
            "sha": "8a69517b935db27b207eeba295634d9ec3654357",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.h",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -316,7 +316,14 @@ class PjRtLoadedExecutable final\n       absl::Span<ArrayRef> args, const ExecuteOptions& options,\n       std::optional<DeviceListRef> devices) override;\n \n-  const DeviceListRef& devices() const override { return devices_; }\n+  std::optional<DeviceListRef> devices() const override {\n+    if (pjrt_loaded_executable_->addressable_devices().empty()) {\n+      // Portable executable.\n+      return std::nullopt;\n+    } else {\n+      return devices_;\n+    }\n+  }\n \n   absl::Span<Device* const> addressable_devices() const override {\n     DCHECK(this);"
        },
        {
            "sha": "1a5d16b4ff3ca0c64fab258a69b64b36f620e20b",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/xla_executable_impl_test_lib.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_impl_test_lib.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_impl_test_lib.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_impl_test_lib.cc?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -406,6 +406,7 @@ TEST_P(LoadedExecutableImplTest, CompileAndExecutePortable) {\n                          /*replicated=*/false, serialize));\n   }\n   EXPECT_EQ(loaded_executable->user_context()->Id(), UserContextId(20));\n+  EXPECT_EQ(loaded_executable->devices(), std::nullopt);\n \n   DType dtype(DType::kF32);\n   Shape shape({2, 3});"
        },
        {
            "sha": "6e52cd86ecc1a0d40d6870bd2a704c4e5d5b06cd",
            "filename": "third_party/xla/xla/python/version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1922cff50b1724f21d4e3cc7435e81c2015d3b79/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h?ref=1922cff50b1724f21d4e3cc7435e81c2015d3b79",
            "patch": "@@ -19,6 +19,6 @@ limitations under the License.\n // An increasing version number to protect jax code against breaking changes.\n // In JAX, reference this via jax._src.lib.ifrt_version.\n #define JAX_IFRT_VERSION_NUMBER \\\n-  36  // Explicit `has_custom_layout` argument in PjRt-IFRT Array creation.\n+  37  // `LoadedExecutable::devices()` returns nullopt for portable executables.\n \n #endif  // XLA_PYTHON_VERSION_H_"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 40,
        "deletions": 23
    }
}