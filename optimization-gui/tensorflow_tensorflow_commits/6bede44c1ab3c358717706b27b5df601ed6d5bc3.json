{
    "author": "tensorflower-gardener",
    "message": "Integrate LLVM at llvm/llvm-project@621ed04e2878\n\nUpdates LLVM usage to match\n[621ed04e2878](https://github.com/llvm/llvm-project/commit/621ed04e2878)\n\nPiperOrigin-RevId: 823941203",
    "sha": "6bede44c1ab3c358717706b27b5df601ed6d5bc3",
    "files": [
        {
            "sha": "6f93f597a092dc83e08df68b212e76eff895a4b6",
            "filename": "third_party/xla/third_party/llvm/generated.patch",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch?ref=6bede44c1ab3c358717706b27b5df601ed6d5bc3",
            "patch": "@@ -1 +1,53 @@\n Auto generated patch. Do not edit or delete it, even if empty.\n+diff -ruN --strip-trailing-cr a/llvm/include/llvm/ExecutionEngine/Orc/Core.h b/llvm/include/llvm/ExecutionEngine/Orc/Core.h\n+--- a/llvm/include/llvm/ExecutionEngine/Orc/Core.h\n++++ b/llvm/include/llvm/ExecutionEngine/Orc/Core.h\n+@@ -1768,7 +1768,7 @@\n+   // FIXME: We should be able to derive FailedSymsForQuery from each query once\n+   //        we fix how the detach operation works.\n+   struct EmitQueries {\n+-    JITDylib::AsynchronousSymbolQuerySet Updated;\n++    JITDylib::AsynchronousSymbolQuerySet Completed;\n+     JITDylib::AsynchronousSymbolQuerySet Failed;\n+     DenseMap<AsynchronousSymbolQuery *, std::shared_ptr<SymbolDependenceMap>>\n+         FailedSymsForQuery;\n+diff -ruN --strip-trailing-cr a/llvm/lib/ExecutionEngine/Orc/Core.cpp b/llvm/lib/ExecutionEngine/Orc/Core.cpp\n+--- a/llvm/lib/ExecutionEngine/Orc/Core.cpp\n++++ b/llvm/lib/ExecutionEngine/Orc/Core.cpp\n+@@ -2901,13 +2901,23 @@\n+ \n+   for (auto &SN : ER.Ready)\n+     IL_collectQueries(\n+-        EQ.Updated, SN->defs(),\n++        EQ.Completed, SN->defs(),\n+         [](JITDylib::SymbolTableEntry &E) { E.setState(SymbolState::Ready); },\n+         [](AsynchronousSymbolQuery &Q, JITDylib &JD,\n+            NonOwningSymbolStringPtr Name, JITDylib::SymbolTableEntry &E) {\n+           Q.notifySymbolMetRequiredState(SymbolStringPtr(Name), E.getSymbol());\n+         });\n+ \n++  // std::erase_if is not available in C++17, and llvm::erase_if does not work\n++  // here.\n++  for (auto it = EQ.Completed.begin(), end = EQ.Completed.end(); it != end;) {\n++    if ((*it)->isComplete()) {\n++      ++it;\n++    } else {\n++      it = EQ.Completed.erase(it);\n++    }\n++  }\n++\n+ #ifdef EXPENSIVE_CHECKS\n+   verifySessionState(\"exiting ExecutionSession::IL_emit\");\n+ #endif\n+@@ -3043,9 +3053,8 @@\n+     }\n+   }\n+ \n+-  for (auto &UQ : EmitQueries->Updated)\n+-    if (UQ->isComplete())\n+-      UQ->handleComplete(*this);\n++  for (auto &UQ : EmitQueries->Completed)\n++    UQ->handleComplete(*this);\n+ \n+   // If there are any bad dependencies then return an error.\n+   if (!BadDeps.empty()) {"
        },
        {
            "sha": "335486c46d2814c72984a0df627ed5f144500de3",
            "filename": "third_party/xla/third_party/llvm/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl?ref=6bede44c1ab3c358717706b27b5df601ed6d5bc3",
            "patch": "@@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\")\n \n def repo(name):\n     \"\"\"Imports LLVM.\"\"\"\n-    LLVM_COMMIT = \"704240125ddf17b9b4995871af3759c742a202ba\"\n-    LLVM_SHA256 = \"0354f1e0c3842bb9f36e590e17bbb91018b014bd5c72736dff0b14d1b3f256e8\"\n+    LLVM_COMMIT = \"621ed04e28787ade92b98e296332ac71d1b81678\"\n+    LLVM_SHA256 = \"60729061c07f0e834acb1a18607d2552dc08596e651125a7aea9c37a4b390058\"\n \n     tf_http_archive(\n         name = name,"
        },
        {
            "sha": "c9375a95c0319a4598f159c0b925e5332e37a3fb",
            "filename": "third_party/xla/third_party/shardy/temporary.patch",
            "status": "modified",
            "additions": 59,
            "deletions": 21,
            "changes": 80,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch?ref=6bede44c1ab3c358717706b27b5df601ed6d5bc3",
            "patch": "@@ -1,35 +1,73 @@\n diff --git a/third_party/llvm/generated.patch b/third_party/llvm/generated.patch\n-index f8fc3c3..509398d 100644\n+index 509398d..6f93f59 100644\n --- a/third_party/llvm/generated.patch\n +++ b/third_party/llvm/generated.patch\n-@@ -1,15 +1 @@\n+@@ -1 +1,53 @@\n  Auto generated patch. Do not edit or delete it, even if empty.\n--diff -ruN --strip-trailing-cr a/mlir/lib/Dialect/OpenMP/Transforms/OpenMPOffloadPrivatizationPrepare.cpp b/mlir/lib/Dialect/OpenMP/Transforms/OpenMPOffloadPrivatizationPrepare.cpp\n----- a/mlir/lib/Dialect/OpenMP/Transforms/OpenMPOffloadPrivatizationPrepare.cpp\n--+++ b/mlir/lib/Dialect/OpenMP/Transforms/OpenMPOffloadPrivatizationPrepare.cpp\n--@@ -189,7 +189,9 @@\n-- \n--         DominanceInfo dom;\n--         llvm::sort(chainOfOps, [&](Operation *l, Operation *r) {\n---          return dom.dominates(l, r);\n--+          if (l == r)\n--+            return false;\n--+          return dom.properlyDominates(l, r);\n--         });\n-- \n--         rewriter.setInsertionPoint(chainOfOps.front());\n++diff -ruN --strip-trailing-cr a/llvm/include/llvm/ExecutionEngine/Orc/Core.h b/llvm/include/llvm/ExecutionEngine/Orc/Core.h\n++--- a/llvm/include/llvm/ExecutionEngine/Orc/Core.h\n+++++ b/llvm/include/llvm/ExecutionEngine/Orc/Core.h\n++@@ -1768,7 +1768,7 @@\n++   // FIXME: We should be able to derive FailedSymsForQuery from each query once\n++   //        we fix how the detach operation works.\n++   struct EmitQueries {\n++-    JITDylib::AsynchronousSymbolQuerySet Updated;\n+++    JITDylib::AsynchronousSymbolQuerySet Completed;\n++     JITDylib::AsynchronousSymbolQuerySet Failed;\n++     DenseMap<AsynchronousSymbolQuery *, std::shared_ptr<SymbolDependenceMap>>\n++         FailedSymsForQuery;\n++diff -ruN --strip-trailing-cr a/llvm/lib/ExecutionEngine/Orc/Core.cpp b/llvm/lib/ExecutionEngine/Orc/Core.cpp\n++--- a/llvm/lib/ExecutionEngine/Orc/Core.cpp\n+++++ b/llvm/lib/ExecutionEngine/Orc/Core.cpp\n++@@ -2901,13 +2901,23 @@\n++ \n++   for (auto &SN : ER.Ready)\n++     IL_collectQueries(\n++-        EQ.Updated, SN->defs(),\n+++        EQ.Completed, SN->defs(),\n++         [](JITDylib::SymbolTableEntry &E) { E.setState(SymbolState::Ready); },\n++         [](AsynchronousSymbolQuery &Q, JITDylib &JD,\n++            NonOwningSymbolStringPtr Name, JITDylib::SymbolTableEntry &E) {\n++           Q.notifySymbolMetRequiredState(SymbolStringPtr(Name), E.getSymbol());\n++         });\n++ \n+++  // std::erase_if is not available in C++17, and llvm::erase_if does not work\n+++  // here.\n+++  for (auto it = EQ.Completed.begin(), end = EQ.Completed.end(); it != end;) {\n+++    if ((*it)->isComplete()) {\n+++      ++it;\n+++    } else {\n+++      it = EQ.Completed.erase(it);\n+++    }\n+++  }\n+++\n++ #ifdef EXPENSIVE_CHECKS\n++   verifySessionState(\"exiting ExecutionSession::IL_emit\");\n++ #endif\n++@@ -3043,9 +3053,8 @@\n++     }\n++   }\n++ \n++-  for (auto &UQ : EmitQueries->Updated)\n++-    if (UQ->isComplete())\n++-      UQ->handleComplete(*this);\n+++  for (auto &UQ : EmitQueries->Completed)\n+++    UQ->handleComplete(*this);\n++ \n++   // If there are any bad dependencies then return an error.\n++   if (!BadDeps.empty()) {\n diff --git a/third_party/llvm/workspace.bzl b/third_party/llvm/workspace.bzl\n-index 974f27d..98e83ed 100644\n+index 98e83ed..335486c 100644\n --- a/third_party/llvm/workspace.bzl\n +++ b/third_party/llvm/workspace.bzl\n @@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\")\n  \n  def repo(name):\n      \"\"\"Imports LLVM.\"\"\"\n--    LLVM_COMMIT = \"917d1f20aecfdbdc9e5a7a0eaf947ff7be6fbe15\"\n--    LLVM_SHA256 = \"8d3d2fe0dfa882a4c4e1c790e2100bc9506b617f50ab30b0c7e303792d9d522f\"\n-+    LLVM_COMMIT = \"704240125ddf17b9b4995871af3759c742a202ba\"\n-+    LLVM_SHA256 = \"0354f1e0c3842bb9f36e590e17bbb91018b014bd5c72736dff0b14d1b3f256e8\"\n+-    LLVM_COMMIT = \"704240125ddf17b9b4995871af3759c742a202ba\"\n+-    LLVM_SHA256 = \"0354f1e0c3842bb9f36e590e17bbb91018b014bd5c72736dff0b14d1b3f256e8\"\n++    LLVM_COMMIT = \"621ed04e28787ade92b98e296332ac71d1b81678\"\n++    LLVM_SHA256 = \"60729061c07f0e834acb1a18607d2552dc08596e651125a7aea9c37a4b390058\"\n  \n      tf_http_archive(\n          name = name,"
        },
        {
            "sha": "25af7beb4d4038747ab651a76d08663e7070bf5a",
            "filename": "third_party/xla/third_party/shardy/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6bede44c1ab3c358717706b27b5df601ed6d5bc3/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl?ref=6bede44c1ab3c358717706b27b5df601ed6d5bc3",
            "patch": "@@ -3,8 +3,8 @@\n load(\"//third_party:repo.bzl\", \"tf_http_archive\", \"tf_mirror_urls\")\n \n def repo():\n-    SHARDY_COMMIT = \"5603c190362a7193d374c908b8fcea1f644e1352\"\n-    SHARDY_SHA256 = \"db8b1313b9732e8db82de4c65db131a2af4916909fb4df69e729e6f44629a7be\"\n+    SHARDY_COMMIT = \"59b218bcc81a77142ce68f75b7f3dfce7573dd94\"\n+    SHARDY_SHA256 = \"6e47a724c68dff26b0e7e28b3b191adef1c259ff2eb31ffcda59fd8fbedfc671\"\n \n     tf_http_archive(\n         name = \"shardy\","
        }
    ],
    "stats": {
        "total": 140,
        "additions": 115,
        "deletions": 25
    }
}