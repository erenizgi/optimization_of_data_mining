{
    "author": "Becker-ZH",
    "message": "XProf GPU - Expose # of Chips to Profile\n\nPiperOrigin-RevId: 830581691",
    "sha": "05dc92a62776baa4c6e01c9dd91c1b100e6aa642",
    "files": [
        {
            "sha": "5284fbd3ded6ac2887c67fa79eca5b0d010813cf",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_tracer_options_utils.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/05dc92a62776baa4c6e01c9dd91c1b100e6aa642/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer_options_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/05dc92a62776baa4c6e01c9dd91c1b100e6aa642/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer_options_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer_options_utils.cc?ref=05dc92a62776baa4c6e01c9dd91c1b100e6aa642",
            "patch": "@@ -18,6 +18,7 @@ limitations under the License.\n #include <algorithm>\n #include <cstdint>\n #include <functional>\n+#include <limits>\n #include <string>\n #include <vector>\n \n@@ -73,6 +74,14 @@ absl::Status UpdateCuptiTracerOptionsFromProfilerOptions(\n       profile_options, \"gpu_dump_graph_node_mapping\", input_keys,\n       [&](bool value) { collector_options.dump_graph_nope_mapping = value; }));\n \n+  TF_RETURN_IF_ERROR(SetValue<int64_t>(\n+      profile_options, \"gpu_num_chips_to_profile_per_task\", input_keys,\n+      [&](int64_t value) {\n+        if (value >= 0 && value <= std::numeric_limits<uint32_t>::max()) {\n+          collector_options.num_gpus = static_cast<uint32_t>(value);\n+        }\n+      }));\n+\n   TF_RETURN_IF_ERROR(SetValue<bool>(\n       profile_options, \"gpu_enable_nvtx_tracking\", input_keys,\n       [&](bool value) { tracer_options.enable_nvtx_tracking = value; }));"
        },
        {
            "sha": "c948652db5154061bf077cfbbeb89bacad195eda",
            "filename": "third_party/xla/xla/backends/profiler/gpu/device_tracer_cuda.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/05dc92a62776baa4c6e01c9dd91c1b100e6aa642/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fdevice_tracer_cuda.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/05dc92a62776baa4c6e01c9dd91c1b100e6aa642/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fdevice_tracer_cuda.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fdevice_tracer_cuda.cc?ref=05dc92a62776baa4c6e01c9dd91c1b100e6aa642",
            "patch": "@@ -101,14 +101,26 @@ absl::Status GpuTracer::DoStart() {\n #endif\n \n   CuptiTracerCollectorOptions collector_options;\n-  collector_options.num_gpus = cupti_tracer_->NumGpus();\n+  int num_gpus = cupti_tracer_->NumGpus();\n+  collector_options.num_gpus = num_gpus;\n \n   // TODO: Add a test to verify that the options are set correctly and\n   // collectors are generating correct data once ProfileData is\n   // available(b/399675726).\n   TF_RETURN_IF_ERROR(UpdateCuptiTracerOptionsFromProfilerOptions(\n       profile_options_, options_, collector_options));\n \n+  if (collector_options.num_gpus <= 0 ||\n+      collector_options.num_gpus > num_gpus) {\n+    if (collector_options.num_gpus != 0) {\n+      LOG(WARNING)\n+          << \"The provided number of GPUs (\" << collector_options.num_gpus\n+          << \") is invalid. Profiling will be done on all available GPUs (\"\n+          << num_gpus << \").\";\n+    }\n+    collector_options.num_gpus = num_gpus;\n+  }\n+\n   uint64_t start_gputime_ns = CuptiTracer::GetTimestamp();\n   uint64_t start_walltime_ns = tsl::profiler::GetCurrentTimeNanos();\n   cupti_collector_ = CreateCuptiCollector(collector_options, start_walltime_ns,"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 22,
        "deletions": 1
    }
}