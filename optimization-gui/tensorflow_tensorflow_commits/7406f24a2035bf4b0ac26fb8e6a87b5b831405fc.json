{
    "author": "akuegel",
    "message": "[XLA:GPU] Treat bitcast that is a bitcast-convert as elementwise\n\nA recent change replaces bitcast-convert with bitcast if it is actually a\nbitcast. However bitcast-convert is considered an elementwise op, while bitcast\nis in general not considered to be an elementwise op. Add an extra check to the\ncost analysis logic to treat bitcasts that don't change indexing as\nelementwise.\n\nPiperOrigin-RevId: 799968246",
    "sha": "7406f24a2035bf4b0ac26fb8e6a87b5b831405fc",
    "files": [
        {
            "sha": "42b6285a1ca308cdf649ebeae8d042536500f40b",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_hlo_cost_analysis.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7406f24a2035bf4b0ac26fb8e6a87b5b831405fc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7406f24a2035bf4b0ac26fb8e6a87b5b831405fc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis.cc?ref=7406f24a2035bf4b0ac26fb8e6a87b5b831405fc",
            "patch": "@@ -194,7 +194,11 @@ absl::Status GpuHloCostAnalysis::FusionCalculateUtilizations(\n     for (int operand_idx = 0; operand_idx < instr->operand_count();\n          ++operand_idx) {\n       const HloInstruction* operand = instr->operand(operand_idx);\n-      if ((instr->IsElementwise()) || instr->opcode() == HloOpcode::kTuple ||\n+      if ((instr->IsElementwise() ||\n+           (instr->opcode() == HloOpcode::kBitcast &&\n+            ShapeUtil::EqualIgnoringElementType(instr->operand(0)->shape(),\n+                                                instr->shape()))) ||\n+          instr->opcode() == HloOpcode::kTuple ||\n           instr->opcode() == HloOpcode::kGetTupleElement) {\n         for (const HloInstruction* r : elementwise_use_roots_[instr]) {\n           elementwise_use_roots_[operand].insert(r);"
        },
        {
            "sha": "8c6be3336c888f93c25fc76ea3d862cf0ee2c283",
            "filename": "third_party/xla/xla/service/gpu/model/gpu_hlo_cost_analysis_test.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7406f24a2035bf4b0ac26fb8e6a87b5b831405fc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7406f24a2035bf4b0ac26fb8e6a87b5b831405fc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fgpu_hlo_cost_analysis_test.cc?ref=7406f24a2035bf4b0ac26fb8e6a87b5b831405fc",
            "patch": "@@ -297,6 +297,34 @@ ENTRY e {\n   EXPECT_EQ(analysis_.IrSize(*root), 4);\n }\n \n+TEST_F(GpuHloCostAnalysisTest, ElementwiseBitcast) {\n+  absl::string_view hlo_string = R\"(\n+HloModule m\n+\n+f {\n+  p0 = s8[10] parameter(0)\n+  negate = s8[10] negate(p0)\n+  bitcast = u8[10] bitcast(p0)\n+  ROOT result = (s8[10], u8[10]) tuple(negate, bitcast)\n+}\n+\n+ENTRY e {\n+  param0 = s8[10] parameter(0)\n+  ROOT fusion = (s8[10], u8[10]) fusion(param0), kind=kLoop, calls=f\n+}\n+)\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  HloInstruction* root = module->entry_computation()->root_instruction();\n+  ASSERT_IS_OK(module->entry_computation()->Accept(&analysis_));\n+\n+  // There are 2 element-wise accesses from the root. One of them is a\n+  // elementwise bitcast, which needs to be detected separately as in general\n+  // bitcasts are not elementwise.\n+  EXPECT_EQ(analysis_.IrSize(*root->fused_parameter(0)), 1);\n+  EXPECT_EQ(analysis_.IrSize(*root), 4);\n+}\n+\n TEST_F(GpuHloCostAnalysisTest, MixedUsers) {\n   absl::string_view hlo_string = R\"(\n HloModule m"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 33,
        "deletions": 1
    }
}