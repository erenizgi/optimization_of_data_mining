{
    "author": "pemeliya",
    "message": "PR #35354: [ROCM] bug-fixing SortRewriter and fixing self_adjoint_test on ROCM\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35354\n\nüìù Summary of Changes\n- This reenables SortRewriter which was erroneously disabled on ROCM (wrong platform).\n- SortRewriter is called after EighExpander to make sure sort op inserted by EighExpander gets properly rewritten\n- Reenables sort_rewriter_test on ROCM which was marked 'cuda-only'\n\nThis shall also improve the perf of EighExpander on CUDA since [this sort op](https://github.com/ROCm/xla/blob/855c22fafe82b400429380621fa8596a523a2014/xla/hlo/transforms/expanders/eigh_expander.cc#L375) gets now rewritten to CUB custom-call\n\nüöÄ Kind of Contribution\nüêõ Bug Fix, ‚ö°Ô∏è Performance Improvement,\n\nüß™ Unit Tests:\nThe existing self_adjoint_test was failing on ROCM due to disabled SortRewriter.\nAlso sort_rewriter_test is now enabled on ROCM too\n\n@xla-rotation could you have a look please?\nCopybara import of the project:\n\n--\n2ef0f6553a3255d3f66535fd01abfd0aa3f68ef4 by Pavel Emeliyanenko <pavel.emeliyanenko@amd.com>:\n\nFixing SortRewriter and fixing self_adjoint_test on ROCM\n\nMoved SortRewriter back to its original place\n\nMerging this change closes #35354\n\nPiperOrigin-RevId: 846691031",
    "sha": "8bb1b4215c096c0800f99b19567856948b0ab332",
    "files": [
        {
            "sha": "1f2b9204105c19b3f0da30b2feb931f751a09dac",
            "filename": "third_party/xla/xla/service/gpu/transforms/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8bb1b4215c096c0800f99b19567856948b0ab332/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8bb1b4215c096c0800f99b19567856948b0ab332/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD?ref=8bb1b4215c096c0800f99b19567856948b0ab332",
            "patch": "@@ -2629,7 +2629,6 @@ xla_test(\n         \"gpu\",\n     ],\n     tags = [\n-        \"cuda-only\",\n         \"test_migrated_to_hlo_runner_pjrt\",\n     ],\n     deps = ["
        },
        {
            "sha": "471facbe522d88e7c36286b33954bdcc9192028f",
            "filename": "third_party/xla/xla/service/gpu/transforms/sort_rewriter_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 6,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8bb1b4215c096c0800f99b19567856948b0ab332/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8bb1b4215c096c0800f99b19567856948b0ab332/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fsort_rewriter_test.cc?ref=8bb1b4215c096c0800f99b19567856948b0ab332",
            "patch": "@@ -439,6 +439,9 @@ ENTRY %main {\n   ROOT %sort = f32[$0,100000] sort(%input), dimensions={1}, to_apply=%compare\n })\";\n \n+  if (xla::PlatformUtil::CanonicalPlatformName(\"gpu\").value() == \"rocm\") {\n+    GTEST_SKIP() << \"Skipping CUDA-specific test\";\n+  }\n   auto pass = SortRewriter(TestGpuDeviceInfo::RTXH100SXMDeviceInfo(), \"CUDA\");\n \n   // Batch 1\n@@ -477,6 +480,9 @@ ENTRY %main {\n   ROOT %sort = f32[$0,100000] sort(%input), dimensions={1}, to_apply=%compare\n })\";\n \n+  if (xla::PlatformUtil::CanonicalPlatformName(\"gpu\").value() == \"rocm\") {\n+    GTEST_SKIP() << \"Skipping CUDA-specific test\";\n+  }\n   auto pass = SortRewriter(TestGpuDeviceInfo::RTXA6000DeviceInfo(), \"CUDA\");\n \n   // Batch 1\n@@ -571,13 +577,23 @@ ENTRY %main {\n       dimensions={0}, to_apply=%compare, metadata={op_type=\"sort\" op_name=\"sort\" source_file=\"path/to/test.cc\" source_line=68}\n })\";\n   constexpr char kExpectedPattern[] = R\"(\n-    // CHECK: %[[CC:.*]] = (u16[1000]{0}, u8[1]{0}) custom-call({{.*}}), custom_call_target=\"__cub$DeviceRadixSortUnassignedScratchSize\", metadata={op_type=\"sort\" op_name=\"sort\" source_file=\"path/to/test.cc\" source_line=68}, backend_config={\"descending\":true}\n+    // CHECK: %[[CC:.*]] = (u16[1000]{0}, u8[{{[0-9]+}}]{0}) custom-call({{.*}}), custom_call_target=\"__cub$DeviceRadixSortUnassignedScratchSize\", metadata={op_type=\"sort\" op_name=\"sort\" source_file=\"path/to/test.cc\" source_line=68}, backend_config={\"descending\":true}\n   )\";\n-  for (const auto& [device_description, platform_name] :\n-       {std::tuple{TestGpuDeviceInfo::RTXA6000DeviceInfo(), \"CUDA\"},\n-        std::tuple{TestGpuDeviceInfo::RTXH100SXMDeviceInfo(), \"CUDA\"}}) {\n-    RunAndFilecheckHloRewrite(kHlo,\n-                              SortRewriter(device_description, platform_name),\n+\n+  auto platform_name = absl::AsciiStrToUpper(\n+      xla::PlatformUtil::CanonicalPlatformName(\"gpu\").value());\n+  auto device_list = [platform_name]() -> std::vector<se::DeviceDescription> {\n+    if (platform_name == \"CUDA\") {\n+      return {TestGpuDeviceInfo::RTXA6000DeviceInfo(),\n+              TestGpuDeviceInfo::RTXH100SXMDeviceInfo()};\n+    } else {\n+      return {TestGpuDeviceInfo::AMDMI210DeviceInfo(),\n+              TestGpuDeviceInfo::AMDRX7900DeviceInfo()};\n+    }\n+  };\n+\n+  for (const auto& device_desc : device_list()) {\n+    RunAndFilecheckHloRewrite(kHlo, SortRewriter(device_desc, platform_name),\n                               kExpectedPattern);\n   }\n }"
        },
        {
            "sha": "d6dcaade5543da6a8054e7e076a9b2d4612e8be9",
            "filename": "third_party/xla/xla/stream_executor/rocm/cub_sort_kernel_rocm.cu.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8bb1b4215c096c0800f99b19567856948b0ab332/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8bb1b4215c096c0800f99b19567856948b0ab332/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Fcub_sort_kernel_rocm.cu.cc?ref=8bb1b4215c096c0800f99b19567856948b0ab332",
            "patch": "@@ -252,7 +252,7 @@ static absl::Status CubSortPairsGetScratchSize(size_t* temp_bytes,\n           .Attr<size_t>(\"num_items\")                                          \\\n           .Attr<size_t>(\"batch_size\"));                                       \\\n   XLA_FFI_REGISTER_HANDLER(                                                   \\\n-      xla::ffi::GetXlaFfiApi(), \"xla.gpu.ext.cub_sort_keys_\" #suffix, \"CUDA\", \\\n+      xla::ffi::GetXlaFfiApi(), \"xla.gpu.ext.cub_sort_keys_\" #suffix, \"ROCM\", \\\n       {/* .instantiate = */ nullptr, /* .prepare = */ nullptr,                \\\n        /* .initialize = */ kCubSortKeysInitialize_##suffix,                   \\\n        /* .execute = */ kCubSortKeysExecute_##suffix});\n@@ -278,7 +278,7 @@ static absl::Status CubSortPairsGetScratchSize(size_t* temp_bytes,\n           .Attr<size_t>(\"num_items\")                                           \\\n           .Attr<size_t>(\"batch_size\"));                                        \\\n   XLA_FFI_REGISTER_HANDLER(                                                    \\\n-      xla::ffi::GetXlaFfiApi(), \"xla.gpu.ext.cub_sort_pairs_\" #suffix, \"CUDA\", \\\n+      xla::ffi::GetXlaFfiApi(), \"xla.gpu.ext.cub_sort_pairs_\" #suffix, \"ROCM\", \\\n       {/* .instantiate = */ nullptr, /* .prepare = */ nullptr,                 \\\n        /* .initialize = */ kCubSortPairsInitialize_##suffix,                   \\\n        /* .execute = */ kCubSortPairsExecute_##suffix});"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 24,
        "deletions": 9
    }
}