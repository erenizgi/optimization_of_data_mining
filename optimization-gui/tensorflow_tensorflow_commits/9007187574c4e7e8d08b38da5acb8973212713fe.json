{
    "author": "meteorcloudy",
    "message": "Update data dependency loading for open-source builds.\n\n- Split resource_loader.cc into an internal version and an oss version since the runfiles library isn't available internally.\n- Use the cc runfiles library in the OSS build so that getting runfiles data works with Bzlmod enabled.\n\nPiperOrigin-RevId: 816376379",
    "sha": "9007187574c4e7e8d08b38da5acb8973212713fe",
    "files": [
        {
            "sha": "f85e742f2933ab4ce5ae43ab770e8a25b64a0c9a",
            "filename": "third_party/xla/xla/hlo/testlib/filecheck.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9007187574c4e7e8d08b38da5acb8973212713fe/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9007187574c4e7e8d08b38da5acb8973212713fe/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.cc?ref=9007187574c4e7e8d08b38da5acb8973212713fe",
            "patch": "@@ -74,7 +74,8 @@ absl::StatusOr<bool> RunFileCheckWithPatternFile(\n   file_check_process.SetChannelAction(tsl::CHAN_STDIN, tsl::ACTION_PIPE);\n   file_check_process.SetChannelAction(tsl::CHAN_STDERR, tsl::ACTION_PIPE);\n   if (!file_check_process.Start()) {\n-    return absl::InternalError(\"couldn't start FileCheck\");\n+    return absl::InternalError(\"couldn't start FileCheck at \" +\n+                               file_check_path);\n   }\n \n   std::string standard_error;"
        },
        {
            "sha": "b903104b42af8a1c77056fda9d5193bea8dcc028",
            "filename": "third_party/xla/xla/tsl/platform/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9007187574c4e7e8d08b38da5acb8973212713fe/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9007187574c4e7e8d08b38da5acb8973212713fe/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD?ref=9007187574c4e7e8d08b38da5acb8973212713fe",
            "patch": "@@ -823,14 +823,17 @@ cc_library(\n cc_library(\n     name = \"resource_loader\",\n     testonly = 1,\n-    srcs = [\"resource_loader.cc\"],\n+    srcs = if_oss(\n+        [\"//xla/tsl/platform/default:resource_loader.cc\"],\n+        google_value = [\"//xla/tsl/platform/google:resource_loader.cc\"],\n+    ),\n     textual_hdrs = [\"resource_loader.h\"],\n     deps = [\n         \":logging\",\n         \":test\",\n         \"@local_tsl//tsl/platform\",\n         \"@local_tsl//tsl/platform:path\",\n-    ],\n+    ] + if_oss([\"@bazel_tools//tools/cpp/runfiles\"]),\n )\n \n cc_library("
        },
        {
            "sha": "7a2f890201fa37f8af44bcb1fcfa0aa91fb1d540",
            "filename": "third_party/xla/xla/tsl/platform/default/resource_loader.cc",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9007187574c4e7e8d08b38da5acb8973212713fe/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fresource_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9007187574c4e7e8d08b38da5acb8973212713fe/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fresource_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fresource_loader.cc?ref=9007187574c4e7e8d08b38da5acb8973212713fe",
            "patch": "@@ -0,0 +1,56 @@\n+/* Copyright 2023 The TensorFlow Authors. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tsl/platform/resource_loader.h\"\n+\n+#include <cstdlib>\n+#include <string>\n+\n+#include \"xla/tsl/platform/logging.h\"\n+#include \"tsl/platform/path.h\"\n+#include \"tools/cpp/runfiles/runfiles.h\"\n+\n+namespace tsl {\n+\n+std::string GetDataDependencyFilepath(const std::string& relative_path) {\n+  using bazel::tools::cpp::runfiles::Runfiles;\n+  std::string error;\n+  std::unique_ptr<Runfiles> runfiles(Runfiles::CreateForTest(&error));\n+  if (runfiles == nullptr) {\n+    LOG(FATAL) << \"Could not initialize runfiles: \" << error.c_str();\n+  }\n+\n+  std::string actual_relative_path;\n+  if (relative_path.find(\"external/\", 0) == 0) {\n+    // This is a path from an external repo, remove \"external/\" for Rlocation\n+    actual_relative_path = relative_path.substr(strlen(\"external/\"));\n+  } else {\n+    // This is a path from the main repo, preappend TEST_WORKSPACE for Rlocation\n+    const char* workspace = std::getenv(\"TEST_WORKSPACE\");\n+    if (!workspace) {\n+      LOG(FATAL) << \"Environment variable TEST_WORKSPACE unset!\";  // Crash OK\n+    }\n+    actual_relative_path = io::JoinPath(workspace, relative_path);\n+  }\n+\n+  std::string full_path = runfiles->Rlocation(actual_relative_path);\n+  if (full_path.empty()) {\n+    LOG(FATAL) << \"Could not find runfile \" << actual_relative_path;\n+  }\n+\n+  return full_path;\n+}\n+\n+}  // namespace tsl"
        },
        {
            "sha": "77421a66e4885a1c63fdb973b7f4347bab4ecb4c",
            "filename": "third_party/xla/xla/tsl/platform/resource_loader.cc",
            "status": "removed",
            "additions": 0,
            "deletions": 45,
            "changes": 45,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/beab9d0058c60759b0f9592b4f98f3540269dbbf/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fresource_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/beab9d0058c60759b0f9592b4f98f3540269dbbf/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fresource_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fresource_loader.cc?ref=beab9d0058c60759b0f9592b4f98f3540269dbbf",
            "patch": "@@ -1,45 +0,0 @@\n-/* Copyright 2023 The TensorFlow Authors. All Rights Reserved.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#include \"xla/tsl/platform/resource_loader.h\"\n-\n-#include <cstdlib>\n-#include <string>\n-\n-#include \"xla/tsl/platform/logging.h\"\n-#include \"xla/tsl/platform/test.h\"\n-#include \"tsl/platform/path.h\"\n-#include \"tsl/platform/platform.h\"\n-\n-namespace tsl {\n-\n-std::string GetDataDependencyFilepath(const std::string& relative_path) {\n-  // TODO(ddunleavy): replace this with `TensorFlowSrcRoot()` from `test.h`.\n-  const char* srcdir = std::getenv(\"TEST_SRCDIR\");\n-  if (!srcdir) {\n-    LOG(FATAL) << \"Environment variable TEST_SRCDIR unset!\";  // Crash OK\n-  }\n-\n-  const char* workspace = std::getenv(\"TEST_WORKSPACE\");\n-  if (!workspace) {\n-    LOG(FATAL) << \"Environment variable TEST_WORKSPACE unset!\";  // Crash OK\n-  }\n-\n-  return kIsOpenSource\n-             ? io::JoinPath(srcdir, workspace, relative_path)\n-             : io::JoinPath(srcdir, workspace, \"third_party\", relative_path);\n-}\n-\n-}  // namespace tsl"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 63,
        "deletions": 48
    }
}