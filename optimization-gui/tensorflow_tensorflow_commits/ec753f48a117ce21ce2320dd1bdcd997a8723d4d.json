{
    "author": "tensorflower-gardener",
    "message": "[XLA] Remove brittleness regarding the `CHECK-HIGH-LEVEL` directives in `chlo_legalize_to_mhlo.mlir` tests by adding a `CHECK-HIGH-LEVEL-LABEL` to discard any output preceding the beginning of the test. Without this, the tests   are dependent; a `CHECK-HIGH-LEVEL` can match an output from a previous test, as it matches all output up until the latest preceding `CHECK-HIGH-LEVEL`. To prevent also matching output after the end of the test, a `CHECK-HIGH-LEVEL-LABEL` is added to each test following a test that contains a `CHECK-HIGH-LEVEL`.\n\nAlso, add `func.func` in some `CHECK-LABEL`s to make them more robust.\n\nPiperOrigin-RevId: 818670103",
    "sha": "ec753f48a117ce21ce2320dd1bdcd997a8723d4d",
    "files": [
        {
            "sha": "ba354d4d37b41a0917939e46beddba166b83cfd6",
            "filename": "third_party/xla/xla/mlir_hlo/tests/Dialect/chlo/chlo_legalize_to_mhlo.mlir",
            "status": "modified",
            "additions": 45,
            "deletions": 23,
            "changes": 68,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ec753f48a117ce21ce2320dd1bdcd997a8723d4d/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fchlo%2Fchlo_legalize_to_mhlo.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ec753f48a117ce21ce2320dd1bdcd997a8723d4d/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fchlo%2Fchlo_legalize_to_mhlo.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fchlo%2Fchlo_legalize_to_mhlo.mlir?ref=ec753f48a117ce21ce2320dd1bdcd997a8723d4d",
            "patch": "@@ -467,6 +467,7 @@ func.func @asinh_f64(%arg : tensor<f64>) -> tensor<f64> {\n // -----\n \n // CHECK-LABEL: func.func @acosh_complex_f32(\n+// CHECK-HIGH-LEVEL-LABEL: func.func @acosh_complex_f32(\n // CHECK-SAME:   %[[TEMP_arg0:.*]]: tensor<complex<f32>>) -> tensor<complex<f32>> {\n // CHECK: %[[TEMP_0:.*]] = mhlo.real %[[TEMP_arg0:.*]] : (tensor<complex<f32>>) -> tensor<f32>\n // CHECK: %[[TEMP_1:.*]] = mhlo.abs %[[TEMP_0]] : tensor<f32>\n@@ -618,7 +619,8 @@ func.func @acosh_complex_f32(%arg : tensor<complex<f32>>) -> tensor<complex<f32>\n // -----\n \n // Lower statically shaped `constant_like` to constant.\n-// CHECK-LABEL: @constant_like_static_shape\n+// CHECK-LABEL: func.func @constant_like_static_shape\n+// CHECK-HIGH-LEVEL-LABEL: func.func @constant_like_static_shape\n func.func @constant_like_static_shape(%arg : tensor<1x2xi64>) -> tensor<1x2xf32> {\n   // CHECK: %[[RESULT:.*]] = mhlo.constant dense<3.200000e+00> : tensor<1x2xf32>\n   // CHECK: return %[[RESULT]]\n@@ -657,7 +659,8 @@ func.func @conj(%arg0: tensor<3xcomplex<f32>>) -> tensor<3xcomplex<f32>> {\n \n // -----\n \n-// CHECK-LABEL: @erf_f64\n+// CHECK-LABEL: func.func @erf_f64\n+// CHECK-HIGH-LEVEL-LABEL: func.func @erf_f64\n // CHECK-SAME: %[[ARG:.*]]: tensor<f64>\n func.func @erf_f64(%arg : tensor<f64>) -> tensor<f64> {\n   // CHECK-HIGH-LEVEL: mhlo.erf\n@@ -669,7 +672,8 @@ func.func @erf_f64(%arg : tensor<f64>) -> tensor<f64> {\n \n // -----\n \n-// CHECK-LABEL: @erf_f32\n+// CHECK-LABEL: func.func @erf_f32\n+// CHECK-HIGH-LEVEL-LABEL: func.func @erf_f32\n // CHECK-SAME: %[[ARG:.*]]: tensor<f32>\n func.func @erf_f32(%arg : tensor<f32>) -> tensor<f32> {\n   // CHECK-HIGH-LEVEL: mhlo.erf\n@@ -681,7 +685,8 @@ func.func @erf_f32(%arg : tensor<f32>) -> tensor<f32> {\n \n // -----\n \n-// CHECK-LABEL: @erf_f16\n+// CHECK-LABEL: func.func @erf_f16\n+// CHECK-HIGH-LEVEL-LABEL: func.func @erf_f16\n // CHECK-SAME: %[[ARG:.*]]: tensor<f16>\n func.func @erf_f16(%arg : tensor<f16>) -> tensor<f16> {\n   // CHECK-HIGH-LEVEL: mhlo.erf\n@@ -693,7 +698,8 @@ func.func @erf_f16(%arg : tensor<f16>) -> tensor<f16> {\n \n // -----\n \n-// CHECK-LABEL: @erf_bf16\n+// CHECK-LABEL: func.func @erf_bf16\n+// CHECK-HIGH-LEVEL-LABEL: func.func @erf_bf16\n // CHECK-SAME: %[[ARG:.*]]: tensor<bf16>\n func.func @erf_bf16(%arg : tensor<bf16>) -> tensor<bf16> {\n   // CHECK-HIGH-LEVEL: mhlo.erf\n@@ -705,7 +711,8 @@ func.func @erf_bf16(%arg : tensor<bf16>) -> tensor<bf16> {\n \n // -----\n \n-// CHECK-LABEL: @acos\n+// CHECK-LABEL: func.func @acos\n+// CHECK-HIGH-LEVEL-LABEL: func.func @acos\n func.func @acos(%arg : tensor<f64>) -> tensor<f64> {\n   // CHECK-HIGH-LEVEL: mhlo.acos\n   %1 = \"chlo.acos\"(%arg) : (tensor<f64>) -> tensor<f64>\n@@ -714,7 +721,8 @@ func.func @acos(%arg : tensor<f64>) -> tensor<f64> {\n \n // -----\n \n-// CHECK-LABEL: @acosh\n+// CHECK-LABEL: func.func @acosh\n+// CHECK-HIGH-LEVEL-LABEL: func.func @acosh\n // CHECK-SAME:  %[[VAL_0:.*]]: tensor<f16>) -> tensor<f16> {\n func.func @acosh(%arg: tensor<f16>) -> tensor<f16> {\n   // CHECK-DAG:   %[[VAL_1:.*]] = mhlo.constant dense<6.550400e+04> : tensor<f16>\n@@ -742,7 +750,8 @@ func.func @acosh(%arg: tensor<f16>) -> tensor<f16> {\n \n // -----\n \n-// CHECK-LABEL: @erfc_f64\n+// CHECK-LABEL: func.func @erfc_f64\n+// CHECK-HIGH-LEVEL-LABEL: func.func @erfc_f64\n // CHECK-SAME: %[[ARG:.*]]: tensor<f64>\n func.func @erfc_f64(%arg : tensor<f64>) -> tensor<f64> {\n   // CHECK-NEXT: %[[TMP_0:.*]] = mhlo.multiply %[[ARG]], %[[ARG]]\n@@ -2465,7 +2474,8 @@ func.func @polygamma_f16(%lhs : tensor<f16>, %rhs : tensor<f16>) -> tensor<f16>\n // -----\n \n \n-// CHECK-LABEL: @sinh_f32\n+// CHECK-LABEL: func.func @sinh_f32\n+// CHECK-HIGH-LEVEL-LABEL: func.func @sinh_f32\n // CHECK-SAME: (%[[X:.*]]: tensor<f32>)\n func.func @sinh_f32(%x : tensor<f32>) -> tensor<f32> {\n   // CHECK: %[[HALF:.*]] = mhlo.constant dense<5.000000e-01> : tensor<f32>\n@@ -2493,7 +2503,8 @@ func.func @sinh_f32(%x : tensor<f32>) -> tensor<f32> {\n \n // -----\n \n-// CHECK-LABEL: @sinh_f16\n+// CHECK-LABEL: func.func @sinh_f16\n+// CHECK-HIGH-LEVEL-LABEL: func.func @sinh_f16\n // CHECK-SAME: (%[[ARG0:.*]]: tensor<f16>)\n func.func @sinh_f16(%x : tensor<f16>) -> tensor<f16> {\n   // CHECK: mhlo.convert %[[ARG0]] : (tensor<f16>) -> tensor<f32>\n@@ -2506,7 +2517,8 @@ func.func @sinh_f16(%x : tensor<f16>) -> tensor<f16> {\n \n // -----\n \n-// CHECK-LABEL: @sinh_complex\n+// CHECK-LABEL: func.func @sinh_complex\n+// CHECK-HIGH-LEVEL-LABEL: func.func @sinh_complex\n // CHECK-SAME: (%[[X:.*]]: tensor<2xcomplex<f32>>)\n func.func @sinh_complex(%x : tensor<2xcomplex<f32>>) -> tensor<2xcomplex<f32>> {\n   // CHECK: %[[HALF:.*]] = mhlo.constant dense<(5.000000e-01,0.000000e+00)> : tensor<2xcomplex<f32>>\n@@ -2524,7 +2536,8 @@ func.func @sinh_complex(%x : tensor<2xcomplex<f32>>) -> tensor<2xcomplex<f32>> {\n \n // -----\n \n-// CHECK-LABEL: @cosh_f32\n+// CHECK-LABEL: func.func @cosh_f32\n+// CHECK-HIGH-LEVEL-LABEL: func.func @cosh_f32\n // CHECK-SAME: (%[[X:.*]]: tensor<f32>)\n func.func @cosh_f32(%x : tensor<f32>) -> tensor<f32> {\n   // CHECK-HIGH-LEVEL: mhlo.cosh\n@@ -2542,7 +2555,8 @@ func.func @cosh_f32(%x : tensor<f32>) -> tensor<f32> {\n \n // -----\n \n-// CHECK-LABEL: @cosh_f16\n+// CHECK-LABEL: func.func @cosh_f16\n+// CHECK-HIGH-LEVEL-LABEL: func.func @cosh_f16\n // CHECK-SAME: (%[[ARG0:.*]]: tensor<f16>)\n func.func @cosh_f16(%x : tensor<f16>) -> tensor<f16> {\n   // CHECK: mhlo.convert %[[ARG0]] : (tensor<f16>) -> tensor<f32>\n@@ -2571,7 +2585,8 @@ func.func @cosh_complex_f32(%x : tensor<complex<f32>>) -> tensor<complex<f32>> {\n \n // -----\n \n-// CHECK-LABEL: @atanh_f32\n+// CHECK-LABEL: func.func @atanh_f32\n+// CHECK-HIGH-LEVEL-LABEL: func.func @atanh_f32\n // CHECK-SAME: %[[ARG:.*]]: tensor<f32>\n func.func @atanh_f32(%arg : tensor<f32>) -> tensor<f32> {\n   // CHECK-NEXT: %[[TMP_0:.*]] = mhlo.abs %[[ARG]]\n@@ -2593,7 +2608,8 @@ func.func @atanh_f32(%arg : tensor<f32>) -> tensor<f32> {\n \n // -----\n \n-// CHECK-LABEL: @atanh_complex_f32\n+// CHECK-LABEL: func.func @atanh_complex_f32\n+// CHECK-HIGH-LEVEL-LABEL: func.func @atanh_complex_f32\n // CHECK-SAME: %[[ARG:.*]]: tensor<complex<f32>>\n func.func @atanh_complex_f32(%arg : tensor<complex<f32>>) -> tensor<complex<f32>> {\n   // CHECK-NEXT: %[[REAL:.*]] = mhlo.real %[[ARG]]\n@@ -2672,7 +2688,8 @@ func.func @atanh_complex_f32(%arg : tensor<complex<f32>>) -> tensor<complex<f32>\n \n // -----\n \n-// CHECK-LABEL: @next_after_f32\n+// CHECK-LABEL: func.func @next_after_f32\n+// CHECK-HIGH-LEVEL-LABEL: func.func @next_after_f32\n // CHECK-SAME: (%[[ARG0:.*]]: tensor<2xf32>, %[[ARG1:.*]]: tensor<2xf32>)\n func.func @next_after_f32(%x: tensor<2xf32>, %y: tensor<2xf32>) -> tensor<2xf32> {\n   // CHECK: %[[X_AS_INT:.*]] = mhlo.bitcast_convert %[[ARG0]] : (tensor<2xf32>) -> tensor<2xi32>\n@@ -2712,7 +2729,8 @@ func.func @next_after_f32(%x: tensor<2xf32>, %y: tensor<2xf32>) -> tensor<2xf32>\n \n // -----\n \n-// CHECK-LABEL: @top_k\n+// CHECK-LABEL: func.func @top_k\n+// CHECK-HIGH-LEVEL-LABEL: func.func @top_k\n // CHECK-SAME: (%[[ARG:.*]]: tensor<16x16xf32>)\n func.func @top_k(%arg : tensor<16x16xf32>) -> (tensor<16x8xf32>, tensor<16x8xi32>) {\n   // CHECK-HIGH-LEVEL: mhlo.topk\n@@ -2723,7 +2741,8 @@ func.func @top_k(%arg : tensor<16x16xf32>) -> (tensor<16x8xf32>, tensor<16x8xi32\n \n // -----\n \n-// CHECK-LABEL: @dyn_top_k\n+// CHECK-LABEL: func.func @dyn_top_k\n+// CHECK-HIGH-LEVEL-LABEL: func.func @dyn_top_k\n // CHECK-SAME: ([[ARG:%.*]]: tensor<?x5x?xi1>\n // CHECK-SAME: -> (tensor<?x5x2xi1>, tensor<?x5x2xi32>)\n func.func @dyn_top_k(%arg0: tensor<?x5x?xi1>) -> (tensor<?x5x2xi1>, tensor<?x5x2xi32>) {\n@@ -2734,7 +2753,6 @@ func.func @dyn_top_k(%arg0: tensor<?x5x?xi1>) -> (tensor<?x5x2xi1>, tensor<?x5x2\n }\n \n // -----\n-\n func.func @unranked_top_k(%arg : tensor<*xf32>) -> (tensor<*xf32>, tensor<*xi32>) {\n   // expected-error@+1 {{failed to legalize operation 'chlo.top_k' that was explicitly marked illegal}}\n   %1:2 = chlo.top_k(%arg, k=8) : tensor<*xf32> -> (tensor<*xf32>, tensor<*xi32>)\n@@ -3511,7 +3529,8 @@ func.func @erf_inv_wide(%arg0 : tensor<16x16xf64>) {\n }\n \n // -----\n-\n+// CHECK-LABEL: func.func @ragged_dot_non_contracting\n+// CHECK-HIGH-LEVEL-LABEL: func.func @ragged_dot_non_contracting\n func.func @ragged_dot_non_contracting(%lhs : tensor<2x11x5xf32>, %rhs : tensor<3x2x5x7xf32>, %group_sizes : tensor<3xi64>) -> tensor<2x11x7xf32> {\n   // CHECK-HIGH-LEVEL: mhlo.ragged_dot\n   %0 = \"chlo.ragged_dot\"(%lhs, %rhs, %group_sizes) {\n@@ -3529,7 +3548,8 @@ func.func @ragged_dot_non_contracting(%lhs : tensor<2x11x5xf32>, %rhs : tensor<3\n }\n \n // -----\n-\n+// CHECK-LABEL: func.func @ragged_dot_contracting\n+// CHECK-HIGH-LEVEL-LABEL: func.func @ragged_dot_contracting\n func.func @ragged_dot_contracting(%lhs : tensor<2x11x5xf32>, %rhs : tensor<2x5x7xf32>, %group_sizes : tensor<2x3xi64>) -> tensor<3x2x11x7xf32> {\n   // CHECK-HIGH-LEVEL: mhlo.ragged_dot\n   %0 = \"chlo.ragged_dot\"(%lhs, %rhs, %group_sizes) {\n@@ -3547,7 +3567,8 @@ func.func @ragged_dot_contracting(%lhs : tensor<2x11x5xf32>, %rhs : tensor<2x5x7\n }\n \n // -----\n-\n+// CHECK-LABEL: func.func @ragged_dot_batch\n+// CHECK-HIGH-LEVEL-LABEL: func.func @ragged_dot_batch\n func.func @ragged_dot_batch(%lhs : tensor<19x17x11x5xf32>, %rhs : tensor<19x17x5x7xf32>, %group_sizes : tensor<19x3xi64>) -> tensor<19x17x11x7xf32> {\n   // CHECK-HIGH-LEVEL: mhlo.ragged_dot\n   %0 = \"chlo.ragged_dot\"(%lhs, %rhs, %group_sizes) {\n@@ -3565,7 +3586,8 @@ func.func @ragged_dot_batch(%lhs : tensor<19x17x11x5xf32>, %rhs : tensor<19x17x5\n }\n \n // -----\n-\n+// CHECK-LABEL: func.func @ragged_dot_frontend_attributes\n+// CHECK-HIGH-LEVEL-LABEL: func.func @ragged_dot_frontend_attributes\n func.func @ragged_dot_frontend_attributes(%lhs : tensor<2x11x5xf32>, %rhs : tensor<3x2x5x7xf32>, %group_sizes : tensor<3xi64>) -> tensor<2x11x7xf32> {\n   // CHECK-HIGH-LEVEL: mhlo.ragged_dot\n   // CHECK-HIGH-LEVEL: mhlo.frontend_attributes = {foo = \"bar\"}"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 45,
        "deletions": 23
    }
}