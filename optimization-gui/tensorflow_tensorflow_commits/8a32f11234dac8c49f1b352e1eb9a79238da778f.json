{
    "author": "tensorflower-gardener",
    "message": "Automated Code Change\n\nPiperOrigin-RevId: 845697432",
    "sha": "8a32f11234dac8c49f1b352e1eb9a79238da778f",
    "files": [
        {
            "sha": "506fae3cfe85bab651c7660dabd93f5629e38fa5",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8a32f11234dac8c49f1b352e1eb9a79238da778f/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8a32f11234dac8c49f1b352e1eb9a79238da778f/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc?ref=8a32f11234dac8c49f1b352e1eb9a79238da778f",
            "patch": "@@ -505,7 +505,8 @@ Future<> TfrtGpuBuffer::ToLiteralHelper(Future<MutableLiteralBase*> literal) {\n             int64_t unpacked_size = ShapeUtil::ElementsIn(on_device_shape);\n             if (transpose != nullptr) {\n               buffer = tsl::port::AlignedMalloc(\n-                  unpacked_size, tsl::Allocator::kAllocatorAlignment);\n+                  unpacked_size, static_cast<std::align_val_t>(\n+                                     tsl::Allocator::kAllocatorAlignment));\n             } else {\n               buffer = literal->untyped_data();\n             }\n@@ -747,7 +748,8 @@ absl::StatusOr<std::unique_ptr<PjRtBuffer>> TfrtGpuBuffer::CopyToMemorySpace(\n \n   // Copying across PjRtClients involves a copy through the host.\n   if (dst_device->client() != client_) {\n-    TF_ASSIGN_OR_RETURN(std::shared_ptr<Literal> literal, ToLiteralSync());\n+    TF_ASSIGN_OR_RETURN(std::shared_ptr<Literal> literal,\n+                        PjRtBuffer::ToLiteral().Await());\n     // Avoid use-after-free on `literal` due to unsequenced move and use.\n     Literal* literal_pointer = literal.get();\n     absl::InlinedVector<int64_t, 4> byte_strides("
        },
        {
            "sha": "32a04ec6b5115a32744c422ceeb77b04a688e49f",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_client_test.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 30,
            "changes": 74,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8a32f11234dac8c49f1b352e1eb9a79238da778f/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8a32f11234dac8c49f1b352e1eb9a79238da778f/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client_test.cc?ref=8a32f11234dac8c49f1b352e1eb9a79238da778f",
            "patch": "@@ -139,7 +139,7 @@ absl::StatusOr<std::shared_ptr<xla::Literal>> ExtractSingleResult(\n   TF_RET_CHECK(result->size() == 1);\n   std::vector<std::unique_ptr<xla::PjRtBuffer>>& result_buffers = (*result)[0];\n   TF_RET_CHECK(result_buffers.size() == 1);\n-  TF_ASSIGN_OR_RETURN(auto literal, result_buffers[0]->ToLiteralSync());\n+  TF_ASSIGN_OR_RETURN(auto literal, result_buffers[0]->ToLiteral().Await());\n   return literal;\n }\n \n@@ -563,7 +563,7 @@ TEST(TfrtGpuClientTest, ShouldStageHostToDeviceTransfersSetToTrue) {\n           /*device_layout=*/nullptr));\n   TF_EXPECT_OK(buffer->GetReadyFuture().Await());\n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> literal,\n-                          buffer->ToLiteralSync());\n+                          buffer->ToLiteral().Await());\n   EXPECT_TRUE(\n       LiteralTestUtil::Equal(*literal, LiteralUtil::CreateR1<int32_t>(data)));\n }\n@@ -588,7 +588,7 @@ TEST(TfrtGpuClientTest, ShouldStageHostToDeviceTransfersSetToFalse) {\n           /*device_layout=*/nullptr));\n   TF_EXPECT_OK(buffer->GetReadyFuture().Await());\n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> literal,\n-                          buffer->ToLiteralSync());\n+                          buffer->ToLiteral().Await());\n   EXPECT_TRUE(\n       LiteralTestUtil::Equal(*literal, LiteralUtil::CreateR1<int32_t>(data)));\n }\n@@ -612,7 +612,7 @@ TEST(TfrtGpuClientTest, BufferFromHostBufferPinnedMemory) {\n   EXPECT_EQ(buffer->memory_space()->kind(), \"pinned_host\");\n   EXPECT_TRUE(buffer->IsOnCpu());\n \n-  TF_ASSERT_OK_AND_ASSIGN(auto literal, buffer->ToLiteralSync());\n+  TF_ASSERT_OK_AND_ASSIGN(auto literal, buffer->ToLiteral().Await());\n   std::vector<int32_t> expected{1, 2, 3, 4};\n   EXPECT_TRUE(LiteralTestUtil::Equal(LiteralUtil::CreateR1<int32_t>(expected),\n                                      *literal));\n@@ -641,7 +641,7 @@ TEST(TfrtGpuClientTest, CopyToPinnedHostMemorySpace) {\n   EXPECT_EQ(result->memory_space()->kind(), \"pinned_host\");\n   EXPECT_TRUE(result->IsOnCpu());\n \n-  TF_ASSERT_OK_AND_ASSIGN(auto literal, result->ToLiteralSync());\n+  TF_ASSERT_OK_AND_ASSIGN(auto literal, result->ToLiteral().Await());\n   std::vector<int32_t> expected{1, 2, 3, 4};\n   EXPECT_TRUE(LiteralTestUtil::Equal(LiteralUtil::CreateR1<int32_t>(expected),\n                                      *literal));\n@@ -664,7 +664,7 @@ TEST(TfrtGpuClientTest, CopyToPinnedHostMemorySpaceInt4) {\n \n   TF_EXPECT_OK(buffer->GetReadyFuture().Await());\n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> device_literal,\n-                          buffer->ToLiteralSync());\n+                          buffer->ToLiteral().Await());\n   std::vector<xla::s4> expected{xla::s4(1), xla::s4(2), xla::s4(3), xla::s4(4)};\n   Literal expected_literal = LiteralUtil::CreateR1<xla::s4>(expected);\n   EXPECT_TRUE(LiteralTestUtil::Equal(expected_literal, *device_literal));\n@@ -677,7 +677,7 @@ TEST(TfrtGpuClientTest, CopyToPinnedHostMemorySpaceInt4) {\n   EXPECT_EQ(result->memory_space()->kind(), \"pinned_host\");\n   EXPECT_TRUE(result->IsOnCpu());\n \n-  TF_ASSERT_OK_AND_ASSIGN(auto literal, result->ToLiteralSync());\n+  TF_ASSERT_OK_AND_ASSIGN(auto literal, result->ToLiteral().Await());\n   EXPECT_TRUE(LiteralTestUtil::Equal(expected_literal, *literal));\n }\n \n@@ -1027,7 +1027,8 @@ TEST(TfrtGpuClientTest, FromHostAsyncPinnedHostChunked) {\n     }\n     offset = end;\n   }\n-  TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> lit, buf->ToLiteralSync());\n+  TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> lit,\n+                          buf->ToLiteral().Await());\n   EXPECT_THAT(lit->data<float>(), ElementsAreArray(data));\n }\n \n@@ -1182,15 +1183,17 @@ TEST(TfrtGpuClientTest, CopyRawToHostFullBuffer) {\n       std::unique_ptr<PjRtBuffer> buffer,\n       client->BufferFromHostLiteral(literal, client->memory_spaces()[0]));\n   TF_ASSERT_OK_AND_ASSIGN(int64_t size, buffer->GetOnDeviceSizeInBytes());\n-  void* dst =\n-      tsl::port::AlignedMalloc(size, tsl::Allocator::kAllocatorAlignment);\n+  void* dst = tsl::port::AlignedMalloc(\n+      size, static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n \n   auto result = buffer->CopyRawToHost(dst, 0, size);\n   TF_EXPECT_OK(result.Await());\n   EXPECT_EQ(*(static_cast<float*>(dst)), 41.0f);\n   EXPECT_EQ(*(static_cast<float*>(dst) + 1), 42.0f);\n \n-  tsl::port::AlignedSizedFree(dst, tsl::Allocator::kAllocatorAlignment, size);\n+  tsl::port::AlignedSizedFree(\n+      dst, size,\n+      static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n }\n \n TEST(TfrtGpuClientTest, CopyRawToHostSubBuffer) {\n@@ -1201,14 +1204,16 @@ TEST(TfrtGpuClientTest, CopyRawToHostSubBuffer) {\n       std::unique_ptr<PjRtBuffer> buffer,\n       client->BufferFromHostLiteral(literal, client->memory_spaces()[0]));\n   TF_ASSERT_OK_AND_ASSIGN(int64_t size, buffer->GetOnDeviceSizeInBytes());\n-  void* dst =\n-      tsl::port::AlignedMalloc(size, tsl::Allocator::kAllocatorAlignment);\n+  void* dst = tsl::port::AlignedMalloc(\n+      size, static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n \n   auto result = buffer->CopyRawToHost(dst, 0, sizeof(float));\n   TF_EXPECT_OK(result.Await());\n   EXPECT_EQ(*(static_cast<float*>(dst)), 41.0f);\n \n-  tsl::port::AlignedSizedFree(dst, tsl::Allocator::kAllocatorAlignment, size);\n+  tsl::port::AlignedSizedFree(\n+      dst, size,\n+      static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n }\n \n TEST(TfrtGpuClientTest, CopyRawToHostOutOfRange) {\n@@ -1219,13 +1224,15 @@ TEST(TfrtGpuClientTest, CopyRawToHostOutOfRange) {\n       std::unique_ptr<PjRtBuffer> buffer,\n       client->BufferFromHostLiteral(literal, client->memory_spaces()[0]));\n   TF_ASSERT_OK_AND_ASSIGN(int64_t size, buffer->GetOnDeviceSizeInBytes());\n-  void* dst =\n-      tsl::port::AlignedMalloc(size, tsl::Allocator::kAllocatorAlignment);\n+  void* dst = tsl::port::AlignedMalloc(\n+      size, static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n \n   auto result = buffer->CopyRawToHost(dst, 1, size);\n   EXPECT_THAT(result.Await(), StatusIs(absl::StatusCode::kInvalidArgument,\n                                        HasSubstr(\"invalid offset 1\")));\n-  tsl::port::AlignedSizedFree(dst, tsl::Allocator::kAllocatorAlignment, size);\n+  tsl::port::AlignedSizedFree(\n+      dst, size,\n+      static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n }\n \n TEST(TfrtGpuClientTest, CopyRawToHostFuture) {\n@@ -1246,8 +1253,9 @@ TEST(TfrtGpuClientTest, CopyRawToHostFuture) {\n   buffer.reset();\n   ready.OnReady([dst_promise = std::move(dst_promise),\n                  size](absl::Status status) mutable {\n-    void* dst =\n-        tsl::port::AlignedMalloc(size, tsl::Allocator::kAllocatorAlignment);\n+    void* dst = tsl::port::AlignedMalloc(\n+        size,\n+        static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n     dst_promise.Set(dst);\n   });\n \n@@ -1256,7 +1264,9 @@ TEST(TfrtGpuClientTest, CopyRawToHostFuture) {\n   EXPECT_EQ(*(static_cast<float*>(dst)), 41.0f);\n   EXPECT_EQ(*(static_cast<float*>(dst) + 1), 42.0f);\n \n-  tsl::port::AlignedSizedFree(dst, tsl::Allocator::kAllocatorAlignment, size);\n+  tsl::port::AlignedSizedFree(\n+      dst, size,\n+      static_cast<std::align_val_t>(tsl::Allocator::kAllocatorAlignment));\n }\n \n TEST(GpuTopology, FromProto) {\n@@ -1413,7 +1423,7 @@ TEST(TfrtGpuClientTest, ExecutePinnedHostOutputTest) {\n   EXPECT_GT(memory_stats.peak_memory_in_bytes, 0);\n \n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> literal,\n-                          result_buffers[0]->ToLiteralSync());\n+                          result_buffers[0]->ToLiteral().Await());\n   EXPECT_THAT(literal->data<int32_t>(), ElementsAreArray(kData));\n }\n \n@@ -1450,10 +1460,10 @@ TEST(TfrtGpuClientTest, ExecutePinnedHostOutputTupleTest) {\n   EXPECT_EQ(result_buffers[1]->memory_space()->kind(), \"pinned_host\");\n \n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> literal,\n-                          result_buffers[0]->ToLiteralSync());\n+                          result_buffers[0]->ToLiteral().Await());\n   EXPECT_THAT(literal->data<int32_t>(), ElementsAreArray(kData));\n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> another_literal,\n-                          result_buffers[1]->ToLiteralSync());\n+                          result_buffers[1]->ToLiteral().Await());\n   EXPECT_THAT(another_literal->data<int32_t>(), ElementsAreArray(kData));\n }\n \n@@ -1622,7 +1632,7 @@ TEST(TfrtGpuClientTest, CopyToMemorySpace) {\n     TF_ASSERT_OK_AND_ASSIGN(buffer,\n                             buffer->CopyToMemorySpace(buffer->memory_space()));\n     TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<Literal> received_literal,\n-                            buffer->ToLiteralSync());\n+                            buffer->ToLiteral().Await());\n     EXPECT_THAT(received_literal->data<int32_t>(),\n                 ElementsAreArray(literal.data<int32_t>()));\n   }\n@@ -1740,10 +1750,12 @@ TEST(TfrtGpuClientTest, DmaMapUnmap) {\n   auto client = tensorflow::down_cast<TfrtGpuClient*>(gpu_client.get());\n   size_t dma_size = 8192;\n   size_t alignment = 4096;\n-  auto host_dma_ptr = tsl::port::AlignedMalloc(dma_size, alignment);\n+  auto host_dma_ptr = tsl::port::AlignedMalloc(\n+      dma_size, static_cast<std::align_val_t>(alignment));\n   auto host_dma_ptr_deleter =\n       absl::Cleanup([host_dma_ptr, dma_size, alignment] {\n-        tsl::port::AlignedSizedFree(host_dma_ptr, alignment, dma_size);\n+        tsl::port::AlignedSizedFree(host_dma_ptr, dma_size,\n+                                    static_cast<std::align_val_t>(alignment));\n       });\n \n   // DmaMap the first half of the buffer.\n@@ -1817,10 +1829,12 @@ TEST(TfrtGpuClientTest, MultipleDeviceShareDmaMapping) {\n \n   size_t dma_size = 2 * 1024 * 1024;\n   size_t alignment = 1024;\n-  auto host_dma_ptr = tsl::port::AlignedMalloc(dma_size, alignment);\n+  auto host_dma_ptr = tsl::port::AlignedMalloc(\n+      dma_size, static_cast<std::align_val_t>(alignment));\n   auto host_dma_ptr_deleter =\n       absl::Cleanup([host_dma_ptr, dma_size, alignment] {\n-        tsl::port::AlignedSizedFree(host_dma_ptr, alignment, dma_size);\n+        tsl::port::AlignedSizedFree(host_dma_ptr, dma_size,\n+                                    static_cast<std::align_val_t>(alignment));\n       });\n \n   TF_EXPECT_OK(client->DmaMap(host_dma_ptr, dma_size));\n@@ -1837,7 +1851,7 @@ TEST(TfrtGpuClientTest, MultipleDeviceShareDmaMapping) {\n \n   TF_EXPECT_OK(transfer_manager->TransferRawDataToSubBuffer(\n       0, host_dma_ptr, 0, size, true, []() {}));\n-  TF_ASSERT_OK_AND_ASSIGN(auto literal, second_buffer->ToLiteralSync());\n+  TF_ASSERT_OK_AND_ASSIGN(auto literal, second_buffer->ToLiteral().Await());\n   EXPECT_EQ(literal->element_count(), test_length);\n   EXPECT_THAT(literal->data<int32_t>(), ElementsAreArray(data));\n \n@@ -1944,7 +1958,7 @@ TEST(TfrtGpuClientTest, CreateAliasBuffer) {\n   ASSERT_NE(alias_buffer.second, nullptr);\n   TF_ASSERT_OK(std::move(alias_buffer.second)(result_buffer.get()));\n   TF_ASSERT_OK_AND_ASSIGN(auto alias_literal,\n-                          alias_buffer.first->ToLiteralSync());\n+                          alias_buffer.first->ToLiteral().Await());\n \n   // Expected result: data + 1\n   EXPECT_TRUE(LiteralTestUtil::Equal("
        }
    ],
    "stats": {
        "total": 80,
        "additions": 48,
        "deletions": 32
    }
}