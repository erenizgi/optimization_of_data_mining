{
    "author": "basioli-k",
    "message": "[XLA:CPU] Guard LLVM command line options when infering target machine whilst running HLO passes.\n\nPiperOrigin-RevId: 814175343",
    "sha": "9846045702f71a13a8976928a7e4a8361197385e",
    "files": [
        {
            "sha": "6a6b4611f80b5678413abb27237a8b678fcbe28d",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9846045702f71a13a8976928a7e4a8361197385e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9846045702f71a13a8976928a7e4a8361197385e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=9846045702f71a13a8976928a7e4a8361197385e",
            "patch": "@@ -1156,11 +1156,20 @@ absl::StatusOr<std::unique_ptr<HloModule>> CpuCompiler::RunHloPasses(\n     const CompileOptions& options) {\n   auto& config = module->config();\n \n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<llvm::TargetMachine> jit_target_machine,\n-      IrCompiler::InferTargetMachine(\n-          CompilerTargetOptions(config), IrCompiler::GetCodeGenOptLevel(config),\n-          CpuFeatureFromString(config.debug_options().xla_cpu_max_isa())));\n+  std::unique_ptr<llvm::TargetMachine> jit_target_machine;\n+\n+  {\n+    auto llvm_options = llvm_ir::ExtractXlaBackendExtraOptions(\n+        module->config().debug_options().xla_backend_extra_options());\n+    llvm_ir::LLVMCommandLineOptionsLock llvm_lock(llvm_options);\n+\n+    TF_ASSIGN_OR_RETURN(\n+        jit_target_machine,\n+        IrCompiler::InferTargetMachine(\n+            CompilerTargetOptions(config),\n+            IrCompiler::GetCodeGenOptLevel(config),\n+            CpuFeatureFromString(config.debug_options().xla_cpu_max_isa())));\n+  }\n \n   TF_RETURN_IF_ERROR(RunHloPasses(module.get(), /*is_aot_compile=*/false,\n                                   jit_target_machine.get(),"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 14,
        "deletions": 5
    }
}