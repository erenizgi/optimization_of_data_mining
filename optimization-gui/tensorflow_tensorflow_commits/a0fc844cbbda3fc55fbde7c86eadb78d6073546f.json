{
    "author": "tensorflower-gardener",
    "message": "[XLA:TPU] Use caching in CanShareOperandBufferWithUser.\n\nCurrently buffer assignment repeatedly calls CanShareOperandBufferWithUser. Each time this calls `GetInPlaceInputOutputPairs(user)`, then iterates through the pairs and checks the ones with the provided user_index. To avoid this repeated work, the first time we call `GetInPlaceInputOutputPairs(user)` we split and cache the values by user_index, avoiding duplicate work in subsequent calls.\n\nWe also cache the uses of the operand and speedup the HLO use check: converting the the inner for-loop into a lookup in a hash set.\n\nPiperOrigin-RevId: 807962432",
    "sha": "a0fc844cbbda3fc55fbde7c86eadb78d6073546f",
    "files": [
        {
            "sha": "553cf6363b8c0dcc90519c344bec638298022c17",
            "filename": "third_party/xla/xla/hlo/analysis/hlo_dataflow_analysis.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 8,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a0fc844cbbda3fc55fbde7c86eadb78d6073546f/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_dataflow_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a0fc844cbbda3fc55fbde7c86eadb78d6073546f/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_dataflow_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_dataflow_analysis.cc?ref=a0fc844cbbda3fc55fbde7c86eadb78d6073546f",
            "patch": "@@ -1818,15 +1818,33 @@ bool HloDataflowAnalysis::CanShareOperandBufferWithUser(\n   if (shapes_equal) {\n     // Must-alias relationship returns true for in-place operations (DUS and DUS\n     // fusions), regardless of the backend.\n-    for (const auto& operand_and_output_index :\n-         alias_info->GetInPlaceInputOutputPairs(user)) {\n-      if (operand_and_output_index.second != user_index) {\n-        continue;\n+    // Cache uses of value and alias_info->GetInPlaceInputOutputPairs to speed\n+    // up repeated calls.\n+    auto [operand_it, operand_inserted] =\n+        cache_share_buffer_with_operand_.try_emplace(\n+            std::make_pair(operand, operand_index),\n+            absl::flat_hash_set<HloUse>());\n+    if (operand_inserted) {\n+      auto uses = GetUniqueValueAt(operand, operand_index).GetUses();\n+      operand_it->second.insert(uses.begin(), uses.end());\n+    }\n+    auto [user_it, user_inserted] = cache_share_buffer_with_user_.try_emplace(\n+        user, absl::flat_hash_map<ShapeIndex, std::vector<HloOperandIndex>>());\n+    if (user_inserted) {\n+      auto& pairs = user_it->second;\n+      for (const auto& operand_and_output_index :\n+           alias_info->GetInPlaceInputOutputPairs(user)) {\n+        pairs[operand_and_output_index.second].push_back(\n+            operand_and_output_index.first);\n       }\n-      for (const HloUse& use :\n-           GetUniqueValueAt(operand, operand_index).GetUses()) {\n-        if (use == HloUse{user, operand_and_output_index.first.operand_number,\n-                          operand_and_output_index.first.operand_index}) {\n+    }\n+    auto& uses = operand_it->second;\n+    auto& user_pairs = user_it->second;\n+    auto pairs_it = user_pairs.find(user_index);\n+    if (pairs_it != user_pairs.end()) {\n+      for (const auto& operand_index : pairs_it->second) {\n+        if (uses.contains(HloUse{user, operand_index.operand_number,\n+                                 operand_index.operand_index})) {\n           return true;\n         }\n       }"
        },
        {
            "sha": "0288edc4b7162e8449bd9443d5f52ea6d541e413",
            "filename": "third_party/xla/xla/hlo/analysis/hlo_dataflow_analysis.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a0fc844cbbda3fc55fbde7c86eadb78d6073546f/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_dataflow_analysis.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a0fc844cbbda3fc55fbde7c86eadb78d6073546f/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_dataflow_analysis.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fhlo_dataflow_analysis.h?ref=a0fc844cbbda3fc55fbde7c86eadb78d6073546f",
            "patch": "@@ -321,6 +321,15 @@ class HloDataflowAnalysis {\n \n   // An explicit graph holding phi values and edges.\n   PhiGraph phi_graph_;\n+\n+  // Caches for CanShareOperandBufferWithUser.\n+  mutable absl::flat_hash_map<\n+      HloInstruction*,\n+      absl::flat_hash_map<ShapeIndex, std::vector<HloOperandIndex>>>\n+      cache_share_buffer_with_user_;\n+  mutable absl::flat_hash_map<std::pair<HloInstruction*, ShapeIndex>,\n+                              absl::flat_hash_set<HloUse>>\n+      cache_share_buffer_with_operand_;\n };\n \n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 35,
        "deletions": 8
    }
}