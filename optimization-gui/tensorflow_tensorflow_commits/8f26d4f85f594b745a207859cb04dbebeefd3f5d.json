{
    "author": "thcmbs",
    "message": "[XLA:GPU][XLA:CPU] Add simplifications for HloOpcode::kConditional.\n\nIf the predicate is a convert from a PRED type, remove the convert.\n\nPiperOrigin-RevId: 839915656",
    "sha": "8f26d4f85f594b745a207859cb04dbebeefd3f5d",
    "files": [
        {
            "sha": "413520c0f2ab489f3f4465739446e7c7a6c09c84",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/algebraic_simplifier.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.cc?ref=8f26d4f85f594b745a207859cb04dbebeefd3f5d",
            "patch": "@@ -10056,4 +10056,30 @@ absl::StatusOr<bool> AlgebraicSimplifier::RunImpl(\n   return changed;\n }\n \n+absl::Status AlgebraicSimplifierVisitor::HandleConditional(\n+    HloInstruction* conditional) {\n+  // TODO: b/427635449 - Investigate TPU regression and re-enable this pass for\n+  // TPU.\n+  if (!options_.enable_conditional_simplification()) {\n+    return absl::OkStatus();\n+  }\n+  HloInstruction* pred = conditional->mutable_operand(0);\n+\n+  // conditional(convert(pred), a, b) => conditional(pred, a, b)\n+  if (pred->opcode() == HloOpcode::kConvert &&\n+      pred->operand(0)->shape().element_type() == PRED &&\n+      conditional->branch_computations().size() == 2) {\n+    return ReplaceWithNewInstruction(\n+        conditional,\n+        HloInstruction::CreateConditional(\n+            conditional->shape(), pred->mutable_operand(0),\n+            conditional->mutable_operand(2),          // True Op (Branch 1)\n+            conditional->branch_computations()[1],    // True Comp (Branch 1)\n+            conditional->mutable_operand(1),          // False Op (Branch 0)\n+            conditional->branch_computations()[0]));  // False Comp (Branch 0)\n+  }\n+\n+  return absl::OkStatus();\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "da0eb0f8612d7cea9294ca6389247b668dfb13e3",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/algebraic_simplifier.h",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier.h?ref=8f26d4f85f594b745a207859cb04dbebeefd3f5d",
            "patch": "@@ -363,6 +363,14 @@ class AlgebraicSimplifierOptions {\n     rewrite_no_op_bitcast_convert_to_bitcast_ = value;\n   }\n \n+  bool enable_conditional_simplification() const {\n+    return enable_conditional_simplification_;\n+  }\n+\n+  void set_enable_conditional_simplification(bool value) {\n+    enable_conditional_simplification_ = value;\n+  }\n+\n  private:\n   // Metadata struct can be used to store any metadata information encapsulated\n   // with the AlgebraicSimplifierOptions that can be later used in an\n@@ -410,6 +418,7 @@ class AlgebraicSimplifierOptions {\n   bool rewrite_reshape_transpose_as_slice_concatenate_{true};\n   bool run_to_fixed_point_{true};\n   bool rewrite_no_op_bitcast_convert_to_bitcast_{false};\n+  bool enable_conditional_simplification_{false};\n   Metadata metadata_;\n };\n \n@@ -470,6 +479,8 @@ class AlgebraicSimplifierVisitor : public DfsHloRewriteVisitor {\n \n   absl::Status HandleCompare(HloInstruction* compare) override;\n \n+  absl::Status HandleConditional(HloInstruction* conditional) override;\n+\n   absl::Status HandleConcatenate(HloInstruction* concatenate) override;\n \n   absl::Status HandleConstant(HloInstruction* constant) override;"
        },
        {
            "sha": "34bea124e05379c19ba6c5a47ead37e5fafaabba",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/algebraic_simplifier_test.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Falgebraic_simplifier_test.cc?ref=8f26d4f85f594b745a207859cb04dbebeefd3f5d",
            "patch": "@@ -13048,5 +13048,47 @@ ENTRY main {\n                                /*allow_mixed_precision=*/true));\n }\n \n+TEST_F(AlgebraicSimplifierTest, ConditionalWithConvert) {\n+  const char* kModuleStr = R\"(\n+    HloModule test\n+    branch_false {\n+      p0 = f32[] parameter(0)\n+      ROOT r0 = f32[] copy(p0)\n+    }\n+    branch_true {\n+      p1 = f32[] parameter(0)\n+      ROOT r1 = f32[] copy(p1)\n+    }\n+    ENTRY main {\n+      %p = pred[] parameter(0)\n+      cond_val = s32[] convert(%p)\n+      val_false = f32[] constant(10.0)\n+      val_true = f32[] constant(20.0)\n+\n+      ROOT conditional = f32[] conditional(cond_val, val_false, val_true),\n+        branch_computations={branch_false, branch_true}\n+    }\n+  )\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto m, ParseAndReturnVerifiedModule(kModuleStr));\n+  AlgebraicSimplifierOptions options = default_options_;\n+  options.set_enable_conditional_simplification(true);\n+  AlgebraicSimplifier simplifier(options);\n+  ASSERT_THAT(simplifier.Run(m.get()), absl_testing::IsOkAndHolds(true));\n+\n+  // The simplified Boolean Conditional should be:\n+  // conditional(pred, true_arg, false_arg)\n+  //\n+  // We expect:\n+  // True Arg  -> val_true (20.0)  [Originally Index 1]\n+  // False Arg -> val_false (10.0) [Originally Index 0]\n+  EXPECT_THAT(m->entry_computation()->root_instruction(),\n+              GmockMatch(m::Conditional(\n+                  m::Parameter(0),\n+                  m::ConstantEffectiveScalar(20.0),  // Expected True Slot\n+                  m::ConstantEffectiveScalar(10.0)   // Expected False Slot\n+                  )));\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "226af176f93d41c28ff70d40af708285f70855eb",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=8f26d4f85f594b745a207859cb04dbebeefd3f5d",
            "patch": "@@ -483,6 +483,7 @@ std::unique_ptr<HloPassFix<HloPassPipeline>> CreateSimplificationPipeline(\n   options.set_executing_on_cpu(true);\n   options.set_enable_onednn_support(use_onednn_custom_call);\n   options.set_rewrite_no_op_bitcast_convert_to_bitcast(true);\n+  options.set_enable_conditional_simplification(true);\n   pipeline->AddPass<AlgebraicSimplifier>(options);\n   pipeline->AddPass<SortSimplifier>();\n   pipeline->AddPass<HloDCE>();\n@@ -1059,6 +1060,7 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n     // oneDNN support is currently enabled only when thunk runtime is turned off\n     options.set_enable_onednn_support(use_onednn_custom_call);\n     options.set_rewrite_no_op_bitcast_convert_to_bitcast(true);\n+    options.set_enable_conditional_simplification(true);\n     pipeline.AddPass<AlgebraicSimplifier>(options);\n     pipeline.AddPass<HloDCE>();\n     pipeline.AddPass<HloCSE>(/*is_layout_sensitive=*/true);"
        },
        {
            "sha": "0f2cf3037ba75a3662ebcd7cf7163adae8b27234",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8f26d4f85f594b745a207859cb04dbebeefd3f5d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=8f26d4f85f594b745a207859cb04dbebeefd3f5d",
            "patch": "@@ -1288,6 +1288,7 @@ AlgebraicSimplifierOptions GpuCompiler::GetAlgebraicSimplifierOptions(\n   opts.set_supports_non_canonical_dots(false);\n   opts.set_enable_unconditional_reduce_of_concat_replacement(false);\n   opts.set_rewrite_no_op_bitcast_convert_to_bitcast(true);\n+  opts.set_enable_conditional_simplification(true);\n \n   switch (mode) {\n     case AlgebraicSimplifierMode::kPostFusionSimplification:\n@@ -3005,7 +3006,6 @@ GpuCompiler::LoadExecutableFromAotResult(\n       stream_exec.GetDeviceDescription();\n   llvm::LLVMContext llvm_context;\n \n-\n   // Recreate BufferAssignment from proto.\n   std::unique_ptr<GpuAliasInfo> alias_info = GetAliasInfo(gpu_device_info);\n   TF_ASSIGN_OR_RETURN("
        }
    ],
    "stats": {
        "total": 83,
        "additions": 82,
        "deletions": 1
    }
}