{
    "author": "akuegel",
    "message": "[XLA:GPU] Add a test case where scatter determinism expander still fails.\n\nWhen using the flag --xla_gpu_deterministic_ops, the added test will fail.\n\nPiperOrigin-RevId: 804763827",
    "sha": "d30d6fdd4dd609c02d42a106f23d4242957d5dd9",
    "files": [
        {
            "sha": "364d848e5d98723a2114b11698725347caf4bf9e",
            "filename": "third_party/xla/xla/tests/scatter_test.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d30d6fdd4dd609c02d42a106f23d4242957d5dd9/third_party%2Fxla%2Fxla%2Ftests%2Fscatter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d30d6fdd4dd609c02d42a106f23d4242957d5dd9/third_party%2Fxla%2Fxla%2Ftests%2Fscatter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fscatter_test.cc?ref=d30d6fdd4dd609c02d42a106f23d4242957d5dd9",
            "patch": "@@ -88,6 +88,44 @@ ENTRY main {\n   RunTest(hlo_text, &operand, &scatter_indices, &updates);\n }\n \n+TEST_F(ScatterTest, TensorFlowScatterV1_UpdateTwice) {\n+  const std::string hlo_text = R\"(\n+HloModule TensorFlowScatterV1\n+\n+update_s32 (lhs: s32[], rhs: s32[]) -> s32[] {\n+  lhs = s32[] parameter(0)\n+  ROOT rhs = s32[] parameter(1)\n+}\n+\n+ENTRY main {\n+  operand = s32[3,3] parameter(0)\n+  indices = s32[2] parameter(1)\n+  updates = s32[2,3] parameter(2)\n+  ROOT scatter = s32[3,3] scatter(operand, indices, updates),\n+      to_apply=update_s32,\n+      update_window_dims={1},\n+      inserted_window_dims={0},\n+      scatter_dims_to_operand_dims={0},\n+      index_vector_dim=1\n+}\n+)\";\n+  Literal operand =\n+      LiteralUtil::CreateR2<int32_t>({{1, 2, 3}, {4, 5, 6}, {7, 8, 9}});\n+  Literal scatter_indices = LiteralUtil::CreateR1<int32_t>({0, 0});\n+  Literal updates =\n+      LiteralUtil::CreateR2<int32_t>({{10, 20, 30}, {70, 80, 90}});\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(hlo_text));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      Literal result,\n+      Execute(std::move(module), {&operand, &scatter_indices, &updates}));\n+  Literal expected_option_one =\n+      LiteralUtil::CreateR2<int32_t>({{10, 20, 30}, {4, 5, 6}, {7, 8, 9}});\n+  Literal expected_option_two =\n+      LiteralUtil::CreateR2<int32_t>({{70, 80, 90}, {4, 5, 6}, {7, 8, 9}});\n+  EXPECT_TRUE(result == expected_option_one || result == expected_option_two);\n+}\n+\n TEST_F(ScatterTest, TensorFlowScatterV1_WithFusedAdds) {\n   const std::string hlo_text = R\"(\n HloModule TensorFlowScatterV1"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 38,
        "deletions": 0
    }
}