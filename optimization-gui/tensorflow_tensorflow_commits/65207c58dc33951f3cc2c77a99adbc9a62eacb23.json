{
    "author": "hhb",
    "message": "Cache PJRT C API extensions in a map.\n\nThis change adds a hash map to `PjRtCApiClient` to store pointers to PJRT extensions provided by the `PJRT_Api`. The extensions are initialized from the `c_api->extension_start` linked list during client construction, allowing for efficient lookup of extensions by their type.\n\nPiperOrigin-RevId: 811644395",
    "sha": "65207c58dc33951f3cc2c77a99adbc9a62eacb23",
    "files": [
        {
            "sha": "a2442f12076e4ca893502249b77ad1e5972efcd1",
            "filename": "third_party/xla/xla/pjrt/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 21,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65207c58dc33951f3cc2c77a99adbc9a62eacb23/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65207c58dc33951f3cc2c77a99adbc9a62eacb23/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.cc?ref=65207c58dc33951f3cc2c77a99adbc9a62eacb23",
            "patch": "@@ -112,6 +112,16 @@ static absl::StatusOr<const PjRtCApiTopologyDescription> InitClientTopoDesc(\n   return PjRtCApiTopologyDescription(c_api, *c_topo, /*owned=*/false);\n }\n \n+static absl::flat_hash_map<PJRT_Extension_Type, PJRT_Extension_Base*>\n+InitExtensions(const PJRT_Api* c_api) {\n+  absl::flat_hash_map<PJRT_Extension_Type, PJRT_Extension_Base*> extensions;\n+  for (PJRT_Extension_Base* ext = c_api->extension_start; ext != nullptr;\n+       ext = ext->next) {\n+    extensions.emplace(ext->type, ext);\n+  }\n+  return extensions;\n+}\n+\n PjRtCApiClient::PjRtCApiClient(\n     const PJRT_Api* c_api, PJRT_Client* c_client,\n     std::unique_ptr<pjrt::PJRT_KeyValueCallbackData> kv_callback_data)\n@@ -120,6 +130,7 @@ PjRtCApiClient::PjRtCApiClient(\n           c_client, ::pjrt::MakeClientDeleter(c_api))),\n       kv_callback_data_(std::move(kv_callback_data)),\n       topo_desc_(InitClientTopoDesc(c_api, c_client)),\n+      extensions_(InitExtensions(c_api)),\n       // Example platform version string:\n       //   PJRT C API\n       //   TFRT TPU v2\n@@ -258,15 +269,23 @@ void PjRtCApiClient::InitAttributes() {\n   attributes_ =\n       pjrt::ConvertFromPjRtNamedValueList(args.attributes, args.num_attributes);\n   attributes_[\"serialize_with_sdy\"] = true;\n-  const PJRT_Api* c_api = pjrt_c_api();\n   PJRT_CrossHostTransfers_Extension* extension =\n-      pjrt::FindExtension<PJRT_CrossHostTransfers_Extension>(\n-          c_api, PJRT_Extension_Type::PJRT_Extension_Type_CrossHostTransfers);\n+      FindExtension<PJRT_CrossHostTransfers_Extension>(\n+          PJRT_Extension_Type::PJRT_Extension_Type_CrossHostTransfers);\n   if (extension != nullptr) {\n     attributes_[\"supports_cross_host_transfers\"] = true;\n   }\n }\n \n+PJRT_Extension_Base* PjRtCApiClient::FindExtensionImpl(\n+    PJRT_Extension_Type type) const {\n+  auto it = extensions_.find(type);\n+  if (it == extensions_.end()) {\n+    return nullptr;\n+  }\n+  return it->second;\n+}\n+\n int PjRtCApiClient::device_count() const { return devices_.size(); }\n \n int PjRtCApiClient::addressable_device_count() const {\n@@ -827,9 +846,8 @@ PjRtCApiClient::CreateViewOfDeviceBuffer(\n absl::StatusOr<Layout> PjRtCApiClient::GetDefaultLayout(\n     PrimitiveType element_type, absl::Span<const int64_t> dims) {\n   const PJRT_Api* c_api = pjrt_c_api();\n-  PJRT_Layouts_Extension* extension =\n-      pjrt::FindExtension<PJRT_Layouts_Extension>(\n-          c_api, PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n+  PJRT_Layouts_Extension* extension = FindExtension<PJRT_Layouts_Extension>(\n+      PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n   if (extension == nullptr) {\n     return LayoutUtil::MakeDescendingLayout(dims.size());\n   }\n@@ -944,8 +962,8 @@ PjRtCApiClient::MakeCrossHostReceiveBuffers(\n     PjRtCrossHostRecvNotifier notifier) {\n   const PJRT_Api* c_api = pjrt_c_api();\n   PJRT_CrossHostTransfers_Extension* extension =\n-      pjrt::FindExtension<PJRT_CrossHostTransfers_Extension>(\n-          c_api, PJRT_Extension_Type::PJRT_Extension_Type_CrossHostTransfers);\n+      FindExtension<PJRT_CrossHostTransfers_Extension>(\n+          PJRT_Extension_Type::PJRT_Extension_Type_CrossHostTransfers);\n   if (extension == nullptr) {\n     return absl::UnimplementedError(\n         \"MakeCrossHostReceiveBuffers is not implemented in this PJRT plugin.\");\n@@ -1446,8 +1464,9 @@ absl::StatusOr<tsl::AllocatorStats> PjRtCApiDevice::GetAllocatorStats() const {\n absl::StatusOr<std::intptr_t> PjRtCApiDevice::GetStreamForExternalReadyEvents()\n     const {\n   const PJRT_Api* c_api = client_->pjrt_c_api();\n-  PJRT_Stream_Extension* extension = pjrt::FindExtension<PJRT_Stream_Extension>(\n-      c_api, PJRT_Extension_Type::PJRT_Extension_Type_Stream);\n+  PJRT_Stream_Extension* extension =\n+      client_->FindExtension<PJRT_Stream_Extension>(\n+          PJRT_Extension_Type::PJRT_Extension_Type_Stream);\n   if (extension == nullptr) {\n     return absl::UnimplementedError(\n         \"Stream extension not implemented in this PJRT plugin.\");\n@@ -2171,14 +2190,15 @@ PjRtCApiLoadedExecutable::GetCommonExecuteArgs(\n }\n \n static absl::StatusOr<PJRT_ExecuteContext*> ForwardExecuteContext(\n-    const PJRT_Api* c_api, const ExecuteContext* context) {\n+    const PjRtCApiClient* client, const ExecuteContext* context) {\n+  const PJRT_Api* c_api = client->pjrt_c_api();\n   // If the execute context is null, we don't have anything to forward.\n   if (context == nullptr) return nullptr;\n \n   // If we can't find the FFI extension, we can't forward anything from the\n   // execute context to the C API.\n-  PJRT_FFI_Extension* ffi_extension = pjrt::FindExtension<PJRT_FFI_Extension>(\n-      c_api, PJRT_Extension_Type::PJRT_Extension_Type_FFI);\n+  PJRT_FFI_Extension* ffi_extension = client->FindExtension<PJRT_FFI_Extension>(\n+      PJRT_Extension_Type::PJRT_Extension_Type_FFI);\n   if (ffi_extension == nullptr) return nullptr;\n \n   // Create a new instance of the PJRT_ExecuteContext.\n@@ -2223,7 +2243,7 @@ PjRtCApiLoadedExecutable::Execute(\n \n   PJRT_ExecuteOptions c_options = {PJRT_ExecuteOptions_STRUCT_SIZE, nullptr};\n   TF_ASSIGN_OR_RETURN(c_options.context,\n-                      ForwardExecuteContext(pjrt_c_api(), options.context));\n+                      ForwardExecuteContext(client_, options.context));\n \n   // Don't forget to destroy execute context if we created it.\n   auto destroy_context = absl::MakeCleanup([&]() {\n@@ -2457,8 +2477,8 @@ std::shared_ptr<const PjRtLayout> PjRtCApiBuffer::layout() const {\n     if (layout_ == nullptr) {\n       const PJRT_Api* c_api = pjrt_c_api();\n       PJRT_Layouts_Extension* extension =\n-          pjrt::FindExtension<PJRT_Layouts_Extension>(\n-              c_api, PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n+          client_->FindExtension<PJRT_Layouts_Extension>(\n+              PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n       if (extension == nullptr) {\n         layout_ = std::make_shared<PjRtLayout>(\n             LayoutUtil::MakeDescendingLayout(dimensions().size()));\n@@ -2821,10 +2841,9 @@ PjRtCApiBuffer::AcquireExternalReference() {\n \n void PjRtCApiBuffer::CopyToRemoteDevice(\n     PjRtFuture<std::string> serialized_descriptor, RemoteSendCallback on_done) {\n-  const PJRT_Api* c_api = pjrt_c_api();\n   PJRT_CrossHostTransfers_Extension* extension =\n-      pjrt::FindExtension<PJRT_CrossHostTransfers_Extension>(\n-          c_api, PJRT_Extension_Type::PJRT_Extension_Type_CrossHostTransfers);\n+      client_->FindExtension<PJRT_CrossHostTransfers_Extension>(\n+          PJRT_Extension_Type::PJRT_Extension_Type_CrossHostTransfers);\n   if (extension == nullptr) {\n     LOG(FATAL) << \"PjRtBuffer::CopyToRemoteDevice: Cross host transfers \"\n                   \"extension not found in PJRT plugin.\";\n@@ -2857,8 +2876,9 @@ PjRtCApiExternalReference::~PjRtCApiExternalReference() {\n absl::Status PjRtCApiExternalReference::WaitUntilBufferReadyOnStream(\n     std::intptr_t stream) {\n   const PJRT_Api* c_api = buffer_->pjrt_c_api();\n-  PJRT_Stream_Extension* extension = pjrt::FindExtension<PJRT_Stream_Extension>(\n-      c_api, PJRT_Extension_Type::PJRT_Extension_Type_Stream);\n+  PJRT_Stream_Extension* extension =\n+      client_->FindExtension<PJRT_Stream_Extension>(\n+          PJRT_Extension_Type::PJRT_Extension_Type_Stream);\n   if (extension == nullptr) {\n     return absl::UnimplementedError(\n         \"Stream extension not implemented in this PJRT plugin.\");"
        },
        {
            "sha": "c64de6662e9be4a9a5b2a96814cfa5d52c540de4",
            "filename": "third_party/xla/xla/pjrt/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/65207c58dc33951f3cc2c77a99adbc9a62eacb23/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/65207c58dc33951f3cc2c77a99adbc9a62eacb23/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_c_api_client.h?ref=65207c58dc33951f3cc2c77a99adbc9a62eacb23",
            "patch": "@@ -402,9 +402,15 @@ class PjRtCApiClient : public PjRtClient {\n   using CrossHostRecvNotifierFunction =\n       std::function<void(PJRT_Error*, const char**, size_t*, size_t)>;\n \n+  template <typename ExtType>\n+  ExtType* FindExtension(PJRT_Extension_Type type) const {\n+    return reinterpret_cast<ExtType*>(FindExtensionImpl(type));  // NOLINT\n+  }\n+\n  private:\n   void InitDevicesAndMemorySpaces();\n   void InitAttributes();\n+  PJRT_Extension_Base* FindExtensionImpl(PJRT_Extension_Type type) const;\n \n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> BufferFromHostBufferInternalImpl(\n       const void* data, PrimitiveType type, absl::Span<int64_t const> dims,\n@@ -428,6 +434,7 @@ class PjRtCApiClient : public PjRtClient {\n   // (e.g. unimplemented). Save the error during client init so we can return it\n   // from GetTopologyDescription().\n   absl::StatusOr<const PjRtCApiTopologyDescription> topo_desc_;\n+  absl::flat_hash_map<PJRT_Extension_Type, PJRT_Extension_Base*> extensions_;\n \n   const std::string platform_version_;\n   const std::string platform_name_;"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 48,
        "deletions": 21
    }
}