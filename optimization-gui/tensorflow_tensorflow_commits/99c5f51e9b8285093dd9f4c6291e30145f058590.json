{
    "author": "ezhulenev",
    "message": "[tsl] Add AsExecutor() adaptor to tsl::thread::ThreadPool\n\nIt's hard to construct ThreadPoolExecutor from a ThreadPool& reference and correctly manage the lifetime of executor. Instead make it possible to get a tsl::Executor adaptor from a ThreadPool instance.\n\nPiperOrigin-RevId: 817872041",
    "sha": "99c5f51e9b8285093dd9f4c6291e30145f058590",
    "files": [
        {
            "sha": "29aea47709cd6d39f808da81a80cf8d04be64295",
            "filename": "tensorflow/core/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/tensorflow%2Fcore%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/tensorflow%2Fcore%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2FBUILD?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -1073,6 +1073,7 @@ cc_library(\n #         \"@com_google_absl//absl/status:statusor\",\n #         \"@com_google_absl//absl/strings\",\n #         \"@com_google_absl//absl/types:optional\",\n+#         \"@local_xla//xla/tsl/concurrency:executor\",\n #         \"@local_xla//xla/tsl/framework/fixedpoint\",\n #         \"@local_xla//xla/tsl/util:safe_reinterpret_cast\",\n #         \"//tensorflow/core/platform:resource\","
        },
        {
            "sha": "f7438211a35de1a773714f9bf9ace219acac62c4",
            "filename": "third_party/xla/xla/backends/gpu/collectives/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2FBUILD?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -553,7 +553,6 @@ cc_library(\n     deps = [\n         \"//xla/tsl/concurrency:executor\",\n         \"//xla/tsl/platform:env\",\n-        \"//xla/tsl/platform:threadpool_executor\",\n     ],\n )\n "
        },
        {
            "sha": "6319c8ce94b9ecd513f7c6273292c18fedf1c08e",
            "filename": "third_party/xla/xla/backends/gpu/collectives/single_threaded_executor.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Fsingle_threaded_executor.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Fsingle_threaded_executor.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Fsingle_threaded_executor.cc?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -19,16 +19,14 @@ limitations under the License.\n \n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n-#include \"xla/tsl/platform/threadpool_executor.h\"\n \n namespace xla::gpu {\n \n SingleThreadedExecutor::SingleThreadedExecutor(tsl::Env& env)\n-    : thread_pool_(&env, \"SingleThreadedExecutor\", 1),\n-      executor_(&thread_pool_) {}\n+    : thread_pool_(&env, \"SingleThreadedExecutor\", 1) {}\n \n void SingleThreadedExecutor::Execute(SingleThreadedExecutor::Task task) {\n-  executor_.Execute(std::move(task));\n+  thread_pool_.AsExecutor()->Execute(std::move(task));\n }\n \n }  // namespace xla::gpu"
        },
        {
            "sha": "1b79aa4b8413e384f7dcd86234f3b8d6707d45de",
            "filename": "third_party/xla/xla/backends/gpu/collectives/single_threaded_executor.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Fsingle_threaded_executor.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Fsingle_threaded_executor.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcollectives%2Fsingle_threaded_executor.h?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -19,7 +19,6 @@ limitations under the License.\n #include \"xla/tsl/concurrency/executor.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n-#include \"xla/tsl/platform/threadpool_executor.h\"\n \n namespace xla::gpu {\n \n@@ -34,7 +33,6 @@ class SingleThreadedExecutor : public tsl::Executor {\n \n  private:\n   tsl::thread::ThreadPool thread_pool_;\n-  tsl::thread::ThreadPoolExecutor executor_;\n };\n \n }  // namespace xla::gpu"
        },
        {
            "sha": "60b1b00aef600fa21d871ed8d59220c13067eb00",
            "filename": "third_party/xla/xla/tsl/platform/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 12,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -692,23 +692,14 @@ cc_library(\n     alwayslink = 1,\n )\n \n-cc_library(\n-    name = \"threadpool_executor\",\n-    hdrs = [\"threadpool_executor.h\"],\n-    deps = [\n-        \":env\",\n-        \"//xla/tsl/concurrency:executor\",\n-    ],\n-)\n-\n tsl_cc_test(\n-    name = \"threadpool_executor_test\",\n-    srcs = [\"threadpool_executor_test.cc\"],\n+    name = \"threadpool_test\",\n+    srcs = [\"threadpool_test.cc\"],\n     deps = [\n         \":env\",\n         \":env_impl\",\n         \":test\",\n-        \":threadpool_executor\",\n+        \"//xla/tsl/concurrency:executor\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_googletest//:gtest_main\",\n     ],"
        },
        {
            "sha": "6fd359c041bb1d505e8ad98d5ecb87dd570fad54",
            "filename": "third_party/xla/xla/tsl/platform/default/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2FBUILD?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -152,6 +152,7 @@ cc_library(\n         \"nobuilder\",\n     ],\n     deps = [\n+        \"//xla/tsl/concurrency:executor\",\n         \"//xla/tsl/platform:env_time\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:file_statistics\",\n@@ -163,6 +164,7 @@ cc_library(\n         \"//xla/tsl/platform:types\",\n         \"//xla/tsl/protobuf:error_codes_proto_impl_cc\",\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/base:nullability\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\","
        },
        {
            "sha": "5d176deaaf945f1e4012ae33a5c43e6e976c5b87",
            "filename": "third_party/xla/xla/tsl/platform/threadpool.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool.cc?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -23,7 +23,9 @@ limitations under the License.\n #include <string>\n #include <utility>\n \n+#include \"absl/base/nullability.h\"\n #include \"absl/base/optimization.h\"\n+#include \"xla/tsl/concurrency/executor.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/logging.h\"\n #include \"xla/tsl/platform/threadpool_interface.h\"\n@@ -120,7 +122,8 @@ ThreadPool::ThreadPool(Env* env, const ThreadOptions& thread_options,\n \n ThreadPool::ThreadPool(Env* env, const ThreadOptions& thread_options,\n                        const std::string& name, int num_threads,\n-                       bool low_latency_hint, Eigen::Allocator* allocator) {\n+                       bool low_latency_hint, Eigen::Allocator* allocator)\n+    : executor_(this) {\n   CHECK_GE(num_threads, 1);\n \n #ifdef DNNL_AARCH64_USE_ACL\n@@ -146,7 +149,8 @@ ThreadPool::ThreadPool(Env* env, const ThreadOptions& thread_options,\n       underlying_threadpool_, num_threads, allocator);\n }\n \n-ThreadPool::ThreadPool(thread::ThreadPoolInterface* user_threadpool) {\n+ThreadPool::ThreadPool(thread::ThreadPoolInterface* user_threadpool)\n+    : executor_(this) {\n   underlying_threadpool_ = user_threadpool;\n   threadpool_device_ = std::make_unique<Eigen::ThreadPoolDevice>(\n       underlying_threadpool_, underlying_threadpool_->NumThreads(), nullptr);\n@@ -281,4 +285,17 @@ Eigen::ThreadPoolInterface* ThreadPool::AsEigenThreadPool() const {\n   return underlying_threadpool_;\n }\n \n+tsl::Executor* absl_nonnull ThreadPool::AsExecutor() { return &executor_; }\n+\n+ThreadPool::ThreadPoolExecutor::ThreadPoolExecutor(ThreadPool* thread_pool)\n+    : thread_pool_(thread_pool) {}\n+\n+void ThreadPool::ThreadPoolExecutor::Execute(Task task) {\n+  auto* task_ptr = new Task(std::move(task));\n+  thread_pool_->Schedule([task_ptr] {\n+    std::move((*task_ptr))();\n+    delete task_ptr;\n+  });\n+}\n+\n }  // namespace tsl::thread"
        },
        {
            "sha": "b68eb11fa7c936c00c7c68c050f976cabb47b114",
            "filename": "third_party/xla/xla/tsl/platform/threadpool.h",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool.h?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -23,6 +23,8 @@ limitations under the License.\n #include <string>\n \n #include \"absl/base/attributes.h\"\n+#include \"absl/base/nullability.h\"\n+#include \"xla/tsl/concurrency/executor.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/threadpool_interface.h\"\n \n@@ -228,7 +230,22 @@ class ThreadPool {\n   // pointer points to, and should not attempt to delete.\n   Eigen::ThreadPoolInterface* AsEigenThreadPool() const;\n \n+  // Returns a non-null pointer to the tsl::Executor implementation. Returned\n+  // executor is owned by the thread pool and its lifetime is bound to the\n+  // lifetime of the thread pool itself.\n+  tsl::Executor* absl_nonnull AsExecutor();\n+\n  private:\n+  // An adaptor for a ThreadPool that converts it into the tsl::Executor.\n+  class ThreadPoolExecutor : public Executor {\n+    friend class ThreadPool;\n+\n+    explicit ThreadPoolExecutor(ThreadPool* thread_pool);\n+    void Execute(Task task) final;\n+\n+    ThreadPool* thread_pool_;\n+  };\n+\n   // Divides the work represented by the range [0, total) into k shards.\n   // Calls fn(i*block_size, (i+1)*block_size) from the ith shard (0 <= i < k).\n   // Each shard may be executed on a different thread in parallel, depending on\n@@ -240,6 +257,9 @@ class ThreadPool {\n       int64_t total, int64_t block_size,\n       const std::function<void(int64_t begin, int64_t end)>& fn);\n \n+  // An adaptor from the thread pool to the tsl::Executor.\n+  ThreadPoolExecutor executor_;\n+\n   // underlying_threadpool_ is the user_threadpool if user_threadpool is\n   // provided in the constructor. Otherwise it is the eigen_threadpool_.\n   Eigen::ThreadPoolInterface* underlying_threadpool_;"
        },
        {
            "sha": "4db56dec1fbc6345b1e2fe3f0b301c354ffc229a",
            "filename": "third_party/xla/xla/tsl/platform/threadpool_executor.h",
            "status": "removed",
            "additions": 0,
            "deletions": 50,
            "changes": 50,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0573fab4a4dbbb723597f44afc069af34bc5169f/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool_executor.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0573fab4a4dbbb723597f44afc069af34bc5169f/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool_executor.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool_executor.h?ref=0573fab4a4dbbb723597f44afc069af34bc5169f",
            "patch": "@@ -1,50 +0,0 @@\n-/* Copyright 2024 The TensorFlow Authors. All Rights Reserved.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#ifndef XLA_TSL_PLATFORM_THREADPOOL_EXECUTOR_H_\n-#define XLA_TSL_PLATFORM_THREADPOOL_EXECUTOR_H_\n-\n-#include <utility>\n-\n-#include \"xla/tsl/concurrency/executor.h\"\n-#include \"xla/tsl/platform/threadpool.h\"\n-\n-namespace tsl::thread {\n-\n-// An adaptor for a ThreadPool that converts it into the tsl::Executor.\n-//\n-// tsl::Executor task is a move-only absl::AnyInvocable, and ThreadPool\n-// expects a copyable std::function. This class adapts the two and makes sure\n-// that the task is deleted when it's done executing.\n-class ThreadPoolExecutor : public Executor {\n- public:\n-  explicit ThreadPoolExecutor(ThreadPool* thread_pool)\n-      : thread_pool_(thread_pool) {}\n-\n-  void Execute(Task task) final {\n-    auto* task_ptr = new Task(std::move(task));\n-    thread_pool_->Schedule([task_ptr] {\n-      std::move((*task_ptr))();\n-      delete task_ptr;\n-    });\n-  }\n-\n- private:\n-  ThreadPool* thread_pool_;\n-};\n-\n-}  // namespace tsl::thread\n-\n-#endif  // XLA_TSL_PLATFORM_THREADPOOL_EXECUTOR_H_"
        },
        {
            "sha": "0c48aa1f42dd37d0653bdcbff88f94d56c4efae7",
            "filename": "third_party/xla/xla/tsl/platform/threadpool_test.cc",
            "status": "renamed",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fthreadpool_test.cc?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -13,22 +13,22 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/tsl/platform/threadpool_executor.h\"\n+#include \"xla/tsl/platform/threadpool.h\"\n \n #include \"absl/synchronization/notification.h\"\n+#include \"xla/tsl/concurrency/executor.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/test.h\"\n-#include \"xla/tsl/platform/threadpool.h\"\n \n namespace tsl::thread {\n namespace {\n \n-TEST(ThreadPoolExecutorTest, ExecuteTasks) {\n+TEST(ThreadPoolTest, AsExecutor) {\n   ThreadPool thread_pool(Env::Default(), \"test\", 4);\n-  ThreadPoolExecutor executor(&thread_pool);\n+  Executor* executor = thread_pool.AsExecutor();\n \n   absl::Notification notification;\n-  executor.Execute([&] { notification.Notify(); });\n+  executor->Execute([&] { notification.Notify(); });\n   notification.WaitForNotification();\n }\n ",
            "previous_filename": "third_party/xla/xla/tsl/platform/threadpool_executor_test.cc"
        },
        {
            "sha": "a934119641c1ca6f80d5b1e39c89d1b5e08307df",
            "filename": "third_party/xla/xla/tsl/platform/windows/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/99c5f51e9b8285093dd9f4c6291e30145f058590/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2FBUILD?ref=99c5f51e9b8285093dd9f4c6291e30145f058590",
            "patch": "@@ -45,6 +45,7 @@ cc_library(\n     deps = [\n         \":error_windows\",\n         \":wide_char\",\n+        \"//xla/tsl/concurrency:executor\",\n         \"//xla/tsl/platform:env_time\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:file_statistics\",\n@@ -55,6 +56,7 @@ cc_library(\n         \"//xla/tsl/platform:threadpool_interface\",\n         \"//xla/tsl/platform:types\",\n         \"//xla/tsl/protobuf:error_codes_proto_impl_cc\",\n+        \"@com_google_absl//absl/base:nullability\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/time\",\n         \"@eigen_archive//:eigen3\","
        }
    ],
    "stats": {
        "total": 130,
        "additions": 54,
        "deletions": 76
    }
}