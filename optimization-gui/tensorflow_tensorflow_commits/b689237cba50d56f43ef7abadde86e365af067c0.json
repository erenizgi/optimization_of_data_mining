{
    "author": "mehrdadkhani",
    "message": "Adds a new test that MemorySpacePropagation currently fails on.\n\nPiperOrigin-RevId: 848233727",
    "sha": "b689237cba50d56f43ef7abadde86e365af067c0",
    "files": [
        {
            "sha": "778942bfc200a37db832cb3276a0c674e92634bc",
            "filename": "third_party/xla/xla/hlo/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b689237cba50d56f43ef7abadde86e365af067c0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b689237cba50d56f43ef7abadde86e365af067c0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2FBUILD?ref=b689237cba50d56f43ef7abadde86e365af067c0",
            "patch": "@@ -189,6 +189,7 @@ xla_cc_test(\n         \"//xla/hlo/parser:hlo_parser\",\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/hash\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "1b4558a9dfe2a66ebe43e770a76bb1bddc3f6560",
            "filename": "third_party/xla/xla/hlo/transforms/memory_space_propagation_test.cc",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b689237cba50d56f43ef7abadde86e365af067c0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fmemory_space_propagation_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b689237cba50d56f43ef7abadde86e365af067c0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fmemory_space_propagation_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fmemory_space_propagation_test.cc?ref=b689237cba50d56f43ef7abadde86e365af067c0",
            "patch": "@@ -24,9 +24,11 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/hlo/analysis/hlo_dataflow_analysis.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n+#include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/parser/hlo_parser.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n namespace {\n@@ -592,5 +594,54 @@ TEST_F(MemorySpacePropagationTest, RunOnComputationPropagateFromOutput) {\n   EXPECT_EQ(absl::HashOf(*module), absl::HashOf(*ref));\n }\n \n+// TODO (b/469840065): Re-enable this test once the memory space propagation bug\n+// is fixed for nested fusions.\n+TEST_F(MemorySpacePropagationTest, DISABLED_NestedFusionShapeMismatchBug) {\n+  absl::string_view hlo_string =\n+      R\"(HloModule jit_insert.fusion.21.isolated, is_scheduled=true\n+\n+%copy_fusion.20.clone {\n+  %input.20 = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)S(1)} parameter(0)\n+  ROOT %copy.4014 = s4[8,32768,1,256]{3,1,0,2:T(8,128)(8,1)E(4)} copy(%input.20)\n+}\n+\n+%fused_computation.434.clone {\n+  %param_0.777 = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)S(1)} parameter(0)\n+  %fusion.505 = s4[8,32768,1,256]{3,1,0,2:T(8,128)(8,1)E(4)S(1)} fusion(%param_0.777), kind=kLoop, output_to_operand_aliasing={{}: (0, {})}, calls=%copy_fusion.20.clone\n+  %param_3.751 = pred[]{:T(512)} parameter(3)\n+  %broadcast.1846 = pred[1,16384,1,256]{3,1,0,2:T(8,128)(4,1)} broadcast(%param_3.751), dimensions={}, metadata={op_name=\"jit(insert)/jit(main)/pjit/jit(insert)/jit(main)/jit(insert)/pjit/jit(insert)/jit(main)/jit(insert)/jit(insert)/dynamic_update_slice\" stack_frame_id=146}\n+  %param_2.1768 = s4[1,16384,1,256]{3,1,0,2:T(8,128)(8,1)E(4)S(1)} parameter(2)\n+  %param_1.980 = s32[]{:T(128)S(6)} parameter(1)\n+  %constant.9791 = s32[]{:T(128)} constant(0), metadata={op_name=\"jit(insert)/jit(main)/pjit/jit(insert)/jit(main)/jit(insert)/pjit\"}\n+  %dynamic-slice.2042 = s4[1,16384,1,256]{3,1,0,2:T(8,128)(8,1)E(4)} dynamic-slice(%fusion.505, %param_1.980, %constant.9791, %constant.9791, %constant.9791), dynamic_slice_sizes={1,16384,1,256}, metadata={op_name=\"jit(insert)/jit(main)/pjit/jit(insert)/jit(main)/jit(insert)/pjit/jit(insert)/jit(main)/jit(insert)/jit(insert)/dynamic_update_slice\" stack_frame_id=146}, backend_config={\"flag_configs\":[],\"scoped_memory_configs\":[],\"indices_config\":{\"index_known_bits\":[{\"zeroes\":\"0\",\"ones\":\"0\",\"bitwidth\":\"32\"},{\"zeroes\":\"4294967295\",\"ones\":\"0\",\"bitwidth\":\"32\"},{\"zeroes\":\"4294967295\",\"ones\":\"0\",\"bitwidth\":\"32\"},{\"zeroes\":\"4294967295\",\"ones\":\"0\",\"bitwidth\":\"32\"}],\"is_index_aligned\":[true,true,true,true]},\"used_scoped_memory_configs\":[]}\n+  %select.912 = s4[1,16384,1,256]{3,1,0,2:T(8,128)(8,1)E(4)} select(%broadcast.1846, %param_2.1768, %dynamic-slice.2042), metadata={op_name=\"jit(insert)/jit(main)/pjit/jit(insert)/jit(main)/jit(insert)/pjit/jit(insert)/jit(main)/jit(insert)/jit(insert)/dynamic_update_slice\" stack_frame_id=146}\n+  ROOT %dynamic-update-slice.455 = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)S(1)} dynamic-update-slice(%fusion.505, %select.912, %param_1.980, %constant.9791, %constant.9791, /*index=5*/%constant.9791), metadata={op_name=\"jit(insert)/jit(main)/pjit/jit(insert)/jit(main)/jit(insert)/pjit/jit(insert)/jit(main)/jit(insert)/jit(insert)/dynamic_update_slice\" stack_frame_id=146}, backend_config={\"flag_configs\":[],\"scoped_memory_configs\":[],\"indices_config\":{\"index_known_bits\":[{\"zeroes\":\"0\",\"ones\":\"0\",\"bitwidth\":\"32\"},{\"zeroes\":\"4294967295\",\"ones\":\"0\",\"bitwidth\":\"32\"},{\"zeroes\":\"4294967295\",\"ones\":\"0\",\"bitwidth\":\"32\"},{\"zeroes\":\"4294967295\",\"ones\":\"0\",\"bitwidth\":\"32\"}],\"is_index_aligned\":[true,true,true,true]},\"used_scoped_memory_configs\":[]}\n+}\n+\n+ENTRY %jit_insert.fusion.21.isolated.root {\n+  %bitcast.1556.hbm = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)} parameter(0)\n+  %select.32 = s32[]{:T(128)S(6)} parameter(1)\n+  %collective-permute.56.hbm = s4[1,16384,1,256]{3,1,0,2:T(8,128)(8,1)E(4)} parameter(2)\n+  %and.74 = pred[]{:T(512)} parameter(3)\n+  %copy = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)S(1)} copy(%bitcast.1556.hbm)\n+  %copy.1 = s4[1,16384,1,256]{3,1,0,2:T(8,128)(8,1)E(4)S(1)} copy(%collective-permute.56.hbm)\n+  %fusion.21 = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)S(1)} fusion(%copy, %select.32, %copy.1, %and.74), kind=kLoop, calls=%fused_computation.434.clone, metadata={op_name=\"jit(insert)/jit(main)/pjit/jit(insert)/jit(main)/jit(insert)/pjit/jit(insert)/jit(main)/jit(insert)/jit(insert)/dynamic_update_slice\" stack_frame_id=146}, backend_config={\"flag_configs\":[],\"scoped_memory_configs\":[],\"used_scoped_memory_configs\":[],\"aliasing_operands\":{\"lists\":[{\"indices\":[\"0\",\"4\"]}]}}\n+  ROOT %copy.2 = s4[8,32768,1,256]{3,1,0,2:T(64,128)(8,1)E(4)} copy(%fusion.21)\n+})\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnUnverifiedModule(hlo_string));\n+  MemorySpacePropagation memory_space_propagation;\n+  // %copy.4014 output memory space must get modified to match %fusion.505\n+  // output shape.\n+  EXPECT_TRUE(memory_space_propagation.Run(module.get()).value());\n+  HloComputation* computation =\n+      module->GetComputationWithName(\"copy_fusion.20.clone\");\n+  EXPECT_NE(computation, nullptr);\n+  const HloInstruction* copy = computation->GetInstructionWithName(\"copy.4014\");\n+  EXPECT_NE(copy, nullptr);\n+  EXPECT_EQ(copy->shape().layout().memory_space(), 1);\n+  TF_EXPECT_OK(Verify(module.get()));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 52,
        "deletions": 0
    }
}