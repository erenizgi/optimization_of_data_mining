{
    "author": "ZixuanJiang",
    "message": "Reorder DynamicUpdateSlice partitioning methods.\n\nBefore this change, if the method is `kAllPartitionedSliceDimsHaveConstantIndices` but enzyme is disabled. The partitioner does nothing, which is wrong.\n\nWe should have the default solution at the end if the optimizations are not enabled.\n\nPiperOrigin-RevId: 834416365",
    "sha": "71c1ec1305f8cd0989d299704249e45cb346ff3b",
    "files": [
        {
            "sha": "ed943aec0fb37af94f35aa504cd71db88f253a00",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 11,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71c1ec1305f8cd0989d299704249e45cb346ff3b/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71c1ec1305f8cd0989d299704249e45cb346ff3b/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner.cc?ref=71c1ec1305f8cd0989d299704249e45cb346ff3b",
            "patch": "@@ -3969,31 +3969,30 @@ absl::Status SpmdPartitioningVisitor::HandleDynamicUpdateSlice(\n     }\n   }\n \n+  // Refer to go/dus-spmd for more details.\n   DynamicUpdateSliceAnalysis analysis = AnalyzeDynamicUpdateSlice(hlo);\n \n-  // Method 1. Replicate the slice dimensions for all involved tensors.\n-  if (analysis.method == DynamicUpdateSliceMethod::kDefault) {\n-    return HandleDUSDefault(hlo, input_tensor, update_tensor, new_indices,\n-                            analysis.slice_dims);\n-  }\n-\n-  // Method 2. Keep the sharding for input and output since the update is fully\n-  // contained in a single partition.\n+  // Keep the sharding for input and output since the update is fully contained\n+  // in a single partition.\n   if (analysis.method == DynamicUpdateSliceMethod::kUpdateOnASinglePartition) {\n     return HandleDUSSinglePartitionUpdate(hlo, input_tensor, update_tensor,\n                                           new_indices, analysis.slice_dims,\n                                           analysis.partitioned_slice_dims);\n   }\n \n-  // Method 3: All partitioned slice dimensions have compile-time constant\n-  // indices.\n+  // All partitioned slice dimensions have compile-time constant indices. It is\n+  // currently enabled for enzyme only.\n   if (analysis.method == DynamicUpdateSliceMethod::\n                              kAllPartitionedSliceDimsHaveConstantIndices &&\n       module_->config().debug_options().xla_enable_enzyme_comms_opt()) {\n     return HandleDUSAllPartitionedSliceDimsHaveConstantIndices(\n         hlo, input_tensor, update_tensor);\n   }\n-  return absl::OkStatus();\n+\n+  // The default method is to replicate the slice dimensions for all involved\n+  // tensors.\n+  return HandleDUSDefault(hlo, input_tensor, update_tensor, new_indices,\n+                          analysis.slice_dims);\n }\n \n absl::Status SpmdPartitioningVisitor::HandleGetTupleElement("
        }
    ],
    "stats": {
        "total": 21,
        "additions": 10,
        "deletions": 11
    }
}