{
    "author": "Tongfei-Guo",
    "message": "[XLA:Collective] Preserve scheduling annotation id for debugging and issue warning if collective is not overlapped.\n\nPiperOrigin-RevId: 816316201",
    "sha": "11578dba494efbc3ca265a2951cc7f4867473e57",
    "files": [
        {
            "sha": "d93d541185ae8959906f9cf031823dbdfb9fd6be",
            "filename": "third_party/xla/xla/hlo/transforms/collectives/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/11578dba494efbc3ca265a2951cc7f4867473e57/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/11578dba494efbc3ca265a2951cc7f4867473e57/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2FBUILD?ref=11578dba494efbc3ca265a2951cc7f4867473e57",
            "patch": "@@ -105,6 +105,8 @@ cc_library(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\",\n         \"//xla/hlo/utils:hlo_query\",\n+        \"//xla/service:scheduling_annotations_util\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/log\",\n@@ -126,7 +128,9 @@ xla_cc_test(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n         \"//xla/hlo/utils:hlo_matchers\",\n+        \"//xla/service:scheduling_annotations_util\",\n         \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\","
        },
        {
            "sha": "ec51d1948d38382fd94294a8bfa05f2472815b8a",
            "filename": "third_party/xla/xla/hlo/transforms/collectives/convert_async_collectives_to_sync.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/11578dba494efbc3ca265a2951cc7f4867473e57/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Fconvert_async_collectives_to_sync.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/11578dba494efbc3ca265a2951cc7f4867473e57/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Fconvert_async_collectives_to_sync.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Fconvert_async_collectives_to_sync.cc?ref=11578dba494efbc3ca265a2951cc7f4867473e57",
            "patch": "@@ -15,6 +15,8 @@ limitations under the License.\n \n #include \"xla/hlo/transforms/collectives/convert_async_collectives_to_sync.h\"\n \n+#include <cstdint>\n+#include <optional>\n #include <utility>\n #include <vector>\n \n@@ -32,7 +34,9 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/ir/hlo_schedule.h\"\n #include \"xla/hlo/utils/hlo_query.h\"\n+#include \"xla/service/scheduling_annotations_util.h\"\n #include \"xla/status_macros.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n #include \"tsl/platform/errors.h\"\n@@ -89,6 +93,8 @@ absl::StatusOr<HloInstruction*> CreateSyncVariant(HloInstruction* async_start,\n \n   sync_instruction->set_metadata(async_start->metadata());\n   sync_instruction->CopyBackendConfigFrom(async_start);\n+  FrontendAttributes fas = async_done->frontend_attributes();\n+  sync_instruction->set_frontend_attributes(fas);\n \n   TF_RETURN_IF_ERROR(async_done->ReplaceAllUsesWith(sync_instruction));\n \n@@ -123,6 +129,16 @@ ConvertAsyncCollectivesToSync::ReplaceAsyncInstructionsWithSync(\n   for (auto& [async_start, async_done] : async_pairs) {\n     TF_ASSIGN_OR_RETURN(HloInstruction * sync,\n                         CreateSyncVariant(async_start, async_done));\n+    TF_ASSIGN_OR_RETURN(std::optional<int64_t> group_id,\n+                        GetSchedulingAnnotationGroupId(async_done));\n+    if (group_id) {\n+      LOG(WARNING) << \"Async collective pair (\" << async_start->name() << \", \"\n+                   << async_done->name() << \") with scheduling group id \"\n+                   << *group_id\n+                   << \" is not overlapped after scheduling and is converted \"\n+                      \"to a synchronous collective \"\n+                   << sync->name() << \".\";\n+    }\n     // Remember name of async instruction for profile usability.\n     FrontendAttributes attributes;\n     auto& map = *attributes.mutable_map();"
        },
        {
            "sha": "737882f3e5ac8e8a68fbb9c2d18b168480dfb392",
            "filename": "third_party/xla/xla/hlo/transforms/collectives/convert_async_collectives_to_sync_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/11578dba494efbc3ca265a2951cc7f4867473e57/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Fconvert_async_collectives_to_sync_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/11578dba494efbc3ca265a2951cc7f4867473e57/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Fconvert_async_collectives_to_sync_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fcollectives%2Fconvert_async_collectives_to_sync_test.cc?ref=11578dba494efbc3ca265a2951cc7f4867473e57",
            "patch": "@@ -15,7 +15,9 @@ limitations under the License.\n \n #include \"xla/hlo/transforms/collectives/convert_async_collectives_to_sync.h\"\n \n+#include <cstdint>\n #include <memory>\n+#include <optional>\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n@@ -27,7 +29,9 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/utils/hlo_matchers.h\"\n+#include \"xla/service/scheduling_annotations_util.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n #include \"tsl/platform/statusor.h\"\n \n@@ -160,6 +164,26 @@ TEST_F(ConvertAsyncCollectivesToSyncTest, SimpleAllGather) {\n   EXPECT_EQ(GetAsyncName(ag), \"ags\");\n }\n \n+TEST_F(ConvertAsyncCollectivesToSyncTest, PreserveFrontendAttributes) {\n+  const absl::string_view hlo_string = R\"(\n+  HloModule test, is_scheduled=true\n+  ENTRY test_computation {\n+    a1 = u32[1, 2] parameter(0)\n+    ags = (u32[1, 2], u32[2, 2]) all-gather-start(a1), dimensions={0}, channel_id=3, frontend_attributes={_scheduling_group_id=\"127\"}\n+    ROOT allgather = u32[2,2] all-gather-done(ags), frontend_attributes={_scheduling_group_id=\"127\"}\n+  })\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  TF_ASSERT_OK(RunPass(module.get(), /*expect_change=*/true));\n+  const HloInstruction* root = module->entry_computation()->root_instruction();\n+  EXPECT_THAT(root, m::AllGather(m::Parameter(0)));\n+  EXPECT_TRUE(root->has_frontend_attributes());\n+  TF_ASSERT_OK_AND_ASSIGN(std::optional<int64_t> group_id,\n+                          GetSchedulingAnnotationGroupId(root));\n+  EXPECT_TRUE(group_id.has_value());\n+  EXPECT_EQ(*group_id, 127);\n+}\n+\n TEST_F(ConvertAsyncCollectivesToSyncTest, SimpleCollectivePermute) {\n   const absl::string_view hlo_string = R\"(\n   HloModule test, is_scheduled=true"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 44,
        "deletions": 0
    }
}