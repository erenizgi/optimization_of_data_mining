{
    "author": "tensorflower-gardener",
    "message": "[Autotuner] Early exit if there is only one supported config.\n\n- We encounter this case very often (for cublas autotuner), so it makes sense to optimize it.\n- Running cuBLAS kernels as part of autotuning has some unintended side effect which changes the optimized HLO, this fix also mitigates the issue, while we look more into it.\n\nPiperOrigin-RevId: 821716593",
    "sha": "027a15b3dc9107622a6b8ec9dc71beecb7f7212c",
    "files": [
        {
            "sha": "9ac4a53c0012b6400cd185c170f928224e488b22",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/027a15b3dc9107622a6b8ec9dc71beecb7f7212c/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/027a15b3dc9107622a6b8ec9dc71beecb7f7212c/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc?ref=027a15b3dc9107622a6b8ec9dc71beecb7f7212c",
            "patch": "@@ -197,6 +197,15 @@ absl::StatusOr<Autotuner::Config> Autotuner::TuneBestConfig(\n   VLOG(1) << \"Successfully compiled \" << executable_candidates.size()\n           << \" configs out of \" << supported_configs.size() << \" configs.\";\n \n+  bool skip_profiling =\n+      executable_candidates.size() == 1 || autotune_config_.select_first_config;\n+  if (skip_profiling) {\n+    VLOG(1) << \"Skipping profiling and using the \"\n+            << (autotune_config_.select_first_config ? \"first\" : \"only\")\n+            << \" config: \" << executable_candidates[0].config.ToString();\n+    return std::move(executable_candidates[0].config);\n+  }\n+\n   TF_ASSIGN_OR_RETURN(std::vector<ConfigResult> results,\n                       ProfileAll(executable_candidates));\n   LogConfigResults(*instr, results);\n@@ -386,9 +395,6 @@ absl::StatusOr<Autotuner::ConfigResult> Autotuner::PickBestConfig(\n   if (best_result == nullptr) {\n     return absl::NotFoundError(\"No valid config found!\");\n   }\n-  if (autotune_config_.select_first_config) {\n-    return std::move(results[0]);\n-  }\n \n   return std::move(*best_result);\n }"
        },
        {
            "sha": "14a070372f0ee8b33ac85a7f67c491e0abd45229",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/027a15b3dc9107622a6b8ec9dc71beecb7f7212c/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/027a15b3dc9107622a6b8ec9dc71beecb7f7212c/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.h?ref=027a15b3dc9107622a6b8ec9dc71beecb7f7212c",
            "patch": "@@ -68,7 +68,7 @@ struct AutotuneConfig {\n   // deprecated.\n   // If true, autotuner will not select cublas configs. We still try cublas\n   // configs as they can be used to check numerical issues with triton but they\n-  // are not considered for selection.\n+  // are not considered for selection, unless there are no other options.\n   bool exclude_cublas_config = false;\n   // TODO b/446870267- Remove this option and use default configs rather than\n   // the first config."
        },
        {
            "sha": "3729e3e67320c5cf7de01bfe6d5ffda17cf74e27",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 11,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/027a15b3dc9107622a6b8ec9dc71beecb7f7212c/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/027a15b3dc9107622a6b8ec9dc71beecb7f7212c/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc?ref=027a15b3dc9107622a6b8ec9dc71beecb7f7212c",
            "patch": "@@ -414,11 +414,6 @@ TEST_F(AutotunerTest, AutotuneButOneBackendFails) {\n       .WillOnce(Return(absl::InternalError(\"test error\")));\n \n   auto profiler = std::make_unique<MockProfiler>();\n-  auto device_description = CreateDummyDeviceDescription();\n-  EXPECT_CALL(*profiler, CreateInputBuffers(_))\n-      .WillOnce(Return(std::make_unique<InputBuffers>()));\n-  EXPECT_CALL(*profiler, Profile(_, _))\n-      .WillOnce(Return(ProfileResult({absl::Seconds(1)})));\n   std::vector<std::unique_ptr<CodegenBackend>> backends;\n   backends.push_back(std::move(good_backend));\n   backends.push_back(std::move(bad_backend));\n@@ -641,11 +636,13 @@ TEST_F(AutotunerTest, ExcludeCublasConfig) {\n   config_.exclude_cublas_config = true;\n   std::vector<std::unique_ptr<BackendConfig>> configs;\n   configs.push_back(GetTestConfig(\"test_config_1\"));\n+  configs.push_back(GetTestConfig(\"test_config_2\"));\n \n   auto backend = std::make_unique<MockCodegenBackend>();\n   EXPECT_CALL(*backend, GetSupportedConfigs(_))\n       .WillOnce(Return(std::move(configs)));\n   EXPECT_CALL(*backend, Compile(_, _))\n+      .WillOnce(Return(std::unique_ptr<Executable>()))\n       .WillOnce(Return(std::unique_ptr<Executable>()));\n   EXPECT_CALL(*backend, name()).WillRepeatedly(Return(\"cublas\"));\n   std::vector<std::unique_ptr<CodegenBackend>> backends;\n@@ -655,7 +652,8 @@ TEST_F(AutotunerTest, ExcludeCublasConfig) {\n   EXPECT_CALL(*profiler, CreateInputBuffers(_))\n       .WillOnce(Return(std::make_unique<InputBuffers>()));\n   EXPECT_CALL(*profiler, Profile(_, _))\n-      .WillOnce(Return(ProfileResult({absl::Seconds(1)})));\n+      .WillOnce(Return(ProfileResult({absl::Seconds(1)})))\n+      .WillOnce(Return(ProfileResult({absl::Seconds(2)})));\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner, Autotuner::Create(std::move(backends),\n@@ -686,11 +684,6 @@ TEST_F(AutotunerTest, SelectFirstConfig) {\n   backends.push_back(std::move(backend));\n \n   auto profiler = std::make_unique<MockProfiler>();\n-  EXPECT_CALL(*profiler, CreateInputBuffers(_))\n-      .WillOnce(Return(std::make_unique<InputBuffers>()));\n-  EXPECT_CALL(*profiler, Profile(_, _))\n-      .WillOnce(Return(ProfileResult({absl::Seconds(2)})))\n-      .WillOnce(Return(ProfileResult({absl::Seconds(1)})));\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto autotuner, Autotuner::Create(std::move(backends),"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 14,
        "deletions": 15
    }
}