{
    "author": "pschuh",
    "message": "Change EnterHostCallback() and\nLeaveHostCallback() to use a c++ raii object to ensure\nthat Enter and Leave are always matched.\n\nPiperOrigin-RevId: 819993376",
    "sha": "0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf",
    "files": [
        {
            "sha": "9a5c06f1bef9bee17783e0cd9c46d2f652520cdd",
            "filename": "third_party/xla/xla/pjrt/host_callback.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_callback.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_callback.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_callback.cc?ref=0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf",
            "patch": "@@ -37,6 +37,9 @@ static thread_local int on_send_guard = 0;\n void EnterHostCallback() { ++on_send_guard; }\n void LeaveHostCallback() { --on_send_guard; }\n \n+HostCallbackScope::HostCallbackScope() { ++on_send_guard; }\n+HostCallbackScope::~HostCallbackScope() { --on_send_guard; }\n+\n bool ThisThreadIsInsideHostCallback() { return on_send_guard > 0; }\n \n absl::Status HostCallbackContext::OnSend(int arg_num,\n@@ -90,9 +93,11 @@ absl::Status HostCallbackContext::OnSend(int arg_num,\n     result_ptrs.push_back(results.back().data());\n   }\n \n-  EnterHostCallback();\n-  auto status = host_callback_.callback(result_ptrs.data(), arg_ptrs.data());\n-  LeaveHostCallback();\n+  absl::Status status;\n+  {\n+    xla::HostCallbackScope scope;\n+    status = host_callback_.callback(result_ptrs.data(), arg_ptrs.data());\n+  }\n \n   // TODO(chky): Consider populating garbage data in results upon errors.\n "
        },
        {
            "sha": "5d93d7c5c27fee0545bb1f20f95ee426bb282e05",
            "filename": "third_party/xla/xla/pjrt/host_callback.h",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_callback.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_callback.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_callback.h?ref=0c8f3eab9a1bcc0c2fbd2e24cabbf1cfa9330ecf",
            "patch": "@@ -47,9 +47,17 @@ namespace xla {\n \n bool ThisThreadIsInsideHostCallback();\n \n-void EnterHostCallback();\n+ABSL_DEPRECATED(\"Use HostCallbackScope\") void EnterHostCallback();\n \n-void LeaveHostCallback();\n+ABSL_DEPRECATED(\"Use HostCallbackScope\") void LeaveHostCallback();\n+\n+class HostCallbackScope {\n+ public:\n+  HostCallbackScope();\n+  ~HostCallbackScope();\n+  HostCallbackScope(const HostCallbackScope& o) = delete;\n+  HostCallbackScope& operator=(const HostCallbackScope& o) = delete;\n+};\n \n // A thread-safe queue for passing PjRtChunk objects for e.g. from Send ops to\n // Recv ops."
        }
    ],
    "stats": {
        "total": 23,
        "additions": 18,
        "deletions": 5
    }
}