{
    "author": "beckerhe",
    "message": "Make xla/tsl/mkl::onednn target an alias\n\nIt's currently a cc_library target which breaks the layering_check which\nI'm trying to enable. Therefore this change introduces a new Bazel function `mkl_dep` which returns a select which resolves to a single target.\n\nThis is based on the function `mkl_deps` which returns a select that resolves to a list of target. But this list has always one element or less, which is why it's easy to make this an alias.\n\nPiperOrigin-RevId: 837493107",
    "sha": "1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1",
    "files": [
        {
            "sha": "fdb5bb308878039989ca66a72617f66d53a7c44c",
            "filename": "third_party/xla/xla/tsl/mkl/BUILD.bazel",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2FBUILD.bazel",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2FBUILD.bazel?ref=1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1",
            "patch": "@@ -1,6 +1,6 @@\n load(\"@bazel_skylib//:bzl_library.bzl\", \"bzl_library\")\n load(\"@local_xla//xla/tsl:tsl.bzl\", \"clean_dep\")\n-load(\"@local_xla//xla/tsl/mkl:build_defs.bzl\", \"mkl_deps\")\n+load(\"@local_xla//xla/tsl/mkl:build_defs.bzl\", \"mkl_dep\")\n \n licenses([\"notice\"])  # 3-Clause BSD\n \n@@ -153,10 +153,12 @@ cc_library(\n     }),\n )\n \n-cc_library(\n+cc_library(name = \"dummy_mkl_dnn\")\n+\n+alias(\n     name = \"onednn\",\n+    actual = mkl_dep(),\n     visibility = [\"//visibility:public\"],\n-    deps = mkl_deps(),\n )\n \n bzl_library("
        },
        {
            "sha": "81f8015b3932331b121b5f1e9e338bc9406c6cfd",
            "filename": "third_party/xla/xla/tsl/mkl/build_defs.bzl",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl?ref=1b3a4c2053bae4bf8d6a6eefc3792ebb1de0dba1",
            "patch": "@@ -115,6 +115,25 @@ def mkl_deps():\n         \"//conditions:default\": [],\n     })\n \n+def mkl_dep():\n+    \"\"\"Returns the correct oneDNN library dependency.\n+\n+      Shorthand for select() to pull in the correct oneDNN library dep\n+      depending on the platform. x86 Linux/Windows with or without --config=mkl\n+      will always build with oneDNN library.\n+\n+    Returns:\n+      a select evaluating to a library target, suitable for\n+      inclusion in the deps attribute of rules.\n+    \"\"\"\n+    return select({\n+        Label(\"//xla/tsl/mkl:build_with_mkl_aarch64\"): \"@mkl_dnn_acl_compatible//:mkl_dnn_acl\",\n+        Label(\"//xla/tsl:linux_x86_64_with_onednn_async\"): \"@onednn_async//:mkl_dnn\",\n+        Label(\"//xla/tsl:linux_x86_64\"): \"@onednn//:mkl_dnn\",\n+        Label(\"//xla/tsl:windows\"): \"@onednn//:mkl_dnn\",\n+        \"//conditions:default\": \"//xla/tsl/mkl:dummy_mkl_dnn\",\n+    })\n+\n def if_onednn_async(if_true, if_false = []):\n     \"\"\"Returns `if_true` if building oneDNN with async runtime support.\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 24,
        "deletions": 3
    }
}