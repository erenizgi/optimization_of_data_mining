{
    "author": "qukhan",
    "message": "Add a helper to compute `*Low/High` `DWORD` parameter couples from a 64 bit int.\n\nExample: `MapViewOfFile` takes a couple of parameters `dwFileOffset(High|Low)`\nwhen specifying the file offset.\nPiperOrigin-RevId: 821635630",
    "sha": "3a6eef2333cad21113fea35454a9140e6bf00de2",
    "files": [
        {
            "sha": "3f368d04c9ecd81d1a4dfaa569c21ccd46cdccf1",
            "filename": "tensorflow/lite/delegates/xnnpack/mmap_handle.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 11,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3a6eef2333cad21113fea35454a9140e6bf00de2/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3a6eef2333cad21113fea35454a9140e6bf00de2/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fmmap_handle.cc?ref=3a6eef2333cad21113fea35454a9140e6bf00de2",
            "patch": "@@ -49,6 +49,20 @@ limitations under the License.\n \n namespace tflite::xnnpack {\n \n+#ifdef _WIN32\n+// Helper to split a value in high/low parts to pass to Windows APIs.\n+struct HighLow {\n+  DWORD high;\n+  DWORD low;\n+  static HighLow From(uint64_t val) {\n+    static_assert(sizeof(val) <= 2 * sizeof(DWORD),\n+                  \"Value type doesn't fit in two DWORDs.\");\n+    return {static_cast<DWORD>(val >> CHAR_BIT * sizeof(DWORD)),\n+            static_cast<DWORD>(val)};\n+  }\n+};\n+#endif\n+\n void swap(MMapHandle& a, MMapHandle& b) {\n   using std::swap;\n   swap(a.size_, b.size_);\n@@ -121,26 +135,23 @@ bool MMapHandle::Map(const FileDescriptorView& fd, const size_t offset,\n                          /*flProtect=*/PAGE_READONLY, /*dwMaximumSizeHigh=*/0,\n                          /*dwMaximumSizeLow=*/0, /*lpName=*/handle_name);\n   XNNPACK_RETURN_CHECK(file_mapping_ != NULL,\n-                       \"could not create a file mapping: %s.\",\n+                       \"could not create a file mapping: %s\",\n                        GetLastErrorString().c_str());\n \n   SYSTEM_INFO sys_info;\n   GetSystemInfo(&sys_info);\n \n   offset_page_adjustment_ = offset_ % sys_info.dwAllocationGranularity;\n \n-  const size_t adjusted_offset = offset - offset_page_adjustment_;\n-  const DWORD file_offset_high =\n-      sizeof(DWORD) < sizeof(adjusted_offset)\n-          ? (adjusted_offset >> CHAR_BIT * sizeof(DWORD))\n-          : 0;\n-  const DWORD file_offset_low = static_cast<DWORD>(adjusted_offset);\n+  const size_t adjusted_offset = offset_ - offset_page_adjustment_;\n+  const size_t adjusted_size = size_ + offset_page_adjustment_;\n+  HighLow file_offset = HighLow::From(adjusted_offset);\n \n-  data_ = static_cast<uint8_t*>(MapViewOfFile(file_mapping_, FILE_MAP_READ,\n-                                              file_offset_high, file_offset_low,\n-                                              /*dwNumberOfBytesToMap=*/0));\n+  data_ = static_cast<uint8_t*>(MapViewOfFile(\n+      file_mapping_, FILE_MAP_READ, file_offset.high, file_offset.low,\n+      /*dwNumberOfBytesToMap=*/adjusted_size));\n \n-  XNNPACK_RETURN_CHECK(data_ != nullptr, \"could not map file (%s): %s.\",\n+  XNNPACK_RETURN_CHECK(data_ != nullptr, \"could not map file (%s): %s\",\n                        safe_path, GetLastErrorString().c_str());\n #else\n   offset_page_adjustment_ = offset_ % getpagesize();"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 22,
        "deletions": 11
    }
}