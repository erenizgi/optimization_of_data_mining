{
    "author": "hhb",
    "message": "Add GetCompilationOptions to PjRt C API\n\nPiperOrigin-RevId: 846601597",
    "sha": "45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
    "files": [
        {
            "sha": "c1c7c8cce991390f8dc6228fcd7d81f4bf2eb780",
            "filename": "third_party/xla/xla/pjrt/c/CHANGELOG.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -1,5 +1,9 @@\n # PJRT C API changelog\n \n+## 0.87\n+\n+* Add `PJRT_Executable_GetCompileOptions`.\n+\n ## 0.86\n \n * Add `PJRT_Device_CreateAsyncTrackingEvent`."
        },
        {
            "sha": "a89d6a4c93bc8c671c25b579ec09c4ac0e552826",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api.h",
            "status": "modified",
            "additions": 28,
            "deletions": 2,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -104,7 +104,7 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Extension_Base, next);\n // Changes include:\n // * Adding a new field to the PJRT_Api or argument structs\n // * Renaming a method or argument (doesn't affect ABI)\n-#define PJRT_API_MINOR 86\n+#define PJRT_API_MINOR 87\n \n // The plugin should set the major_version and minor_version of\n // PJRT_Api.pjrt_api_version to be the `PJRT_API_MAJOR` and `PJRT_API_MINOR` in\n@@ -2031,6 +2031,8 @@ typedef PJRT_Error* PJRT_Executable_OutputMemoryKinds(\n \n typedef struct PJRT_SerializedExecutable PJRT_SerializedExecutable;\n \n+typedef struct PJRT_SerializedCompileOptions PJRT_SerializedCompileOptions;\n+\n struct PJRT_Executable_Serialize_Args {\n   size_t struct_size;\n   PJRT_Extension_Base* extension_start;\n@@ -2054,6 +2056,29 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Executable_Serialize_Args,\n typedef PJRT_Error* PJRT_Executable_Serialize(\n     PJRT_Executable_Serialize_Args* args);\n \n+struct PJRT_Executable_GetCompileOptions_Args {\n+  size_t struct_size;\n+  PJRT_Extension_Base* extension_start;\n+  PJRT_Executable* executable;\n+\n+  // Lives only as long as serialized_compile_options\n+  const char* serialized_bytes;  // out\n+  size_t serialized_bytes_size;  // out\n+\n+  PJRT_SerializedCompileOptions*\n+      serialized_compile_options;  // backs serialized_bytes.\n+  // cleanup fn must be called to free the backing memory for serialized_bytes.\n+  // Should only be called once on serialized_compile_options.\n+  void (*serialized_compile_options_deleter)(\n+      PJRT_SerializedCompileOptions* options);  // out\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Executable_GetCompileOptions_Args,\n+                          serialized_compile_options_deleter);\n+\n+// Returns the CompileOptions that were used to compile this executable.\n+typedef PJRT_Error* PJRT_Executable_GetCompileOptions(\n+    PJRT_Executable_GetCompileOptions_Args* args);\n+\n struct PJRT_Executable_DeserializeAndLoad_Args {\n   size_t struct_size;\n   PJRT_Extension_Base* extension_start;\n@@ -2826,11 +2851,12 @@ typedef struct PJRT_Api {\n   _PJRT_API_STRUCT_FIELD(PJRT_Device_PoisonExecution);\n   _PJRT_API_STRUCT_FIELD(PJRT_Device_CreateAsyncTrackingEvent);\n   _PJRT_API_STRUCT_FIELD(PJRT_AsyncTrackingEvent_Destroy);\n+  _PJRT_API_STRUCT_FIELD(PJRT_Executable_GetCompileOptions);\n } PJRT_Api;\n \n enum {\n   PJRT_Api_STRUCT_SIZE =\n-      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_AsyncTrackingEvent_Destroy)\n+      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_Executable_GetCompileOptions)\n };\n \n #undef _PJRT_API_STRUCT_FIELD"
        },
        {
            "sha": "246e746bf0ddf688eb6a32c3e5ac446c9232fd85",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -960,6 +960,9 @@ FieldOffsetsAndSizesForVersion(int major_version, int minor_version) {\n       add_field(\"PJRT_Device_CreateAsyncTrackingEvent\", kFnPtrSize);\n       add_field(\"PJRT_AsyncTrackingEvent_Destroy\", kFnPtrSize);\n     }\n+    if (minor_version >= 87) {\n+      add_field(\"PJRT_Executable_GetCompileOptions\", kFnPtrSize);\n+    }\n     return version_offsets_and_sizes;\n   }\n   LOG(FATAL) << \"Unsupported API version: \" << major_version << \".\"\n@@ -1371,6 +1374,9 @@ TEST_F(PjrtCAbiTestBase, FieldOffsetsAndSizes) {\n           {\"PJRT_AsyncTrackingEvent_Destroy\",\n            {offsetof(PJRT_Api, PJRT_AsyncTrackingEvent_Destroy),\n             sizeof(PJRT_Api::PJRT_AsyncTrackingEvent_Destroy)}},\n+          {\"PJRT_Executable_GetCompileOptions\",\n+           {offsetof(PJRT_Api, PJRT_Executable_GetCompileOptions),\n+            sizeof(PJRT_Api::PJRT_Executable_GetCompileOptions)}},\n       };\n   ASSERT_EQ(api_->pjrt_api_version.major_version, PJRT_API_MAJOR);\n   ASSERT_EQ(api_->pjrt_api_version.minor_version, PJRT_API_MINOR);"
        },
        {
            "sha": "7c95b2c80e7d1ecc68b9a3ab3735e44f6cb7e851",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -2068,6 +2068,28 @@ PJRT_Error* PJRT_Executable_Serialize(PJRT_Executable_Serialize_Args* args) {\n   return nullptr;\n }\n \n+PJRT_Error* PJRT_Executable_GetCompileOptions(\n+    PJRT_Executable_GetCompileOptions_Args* args) {\n+  PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n+      \"PJRT_Executable_GetCompileOptions_Args\",\n+      PJRT_Executable_GetCompileOptions_Args_STRUCT_SIZE, args->struct_size));\n+  PJRT_ASSIGN_OR_RETURN(xla::CompileOptions options,\n+                        args->executable->executable->GetCompileOptions());\n+  PJRT_ASSIGN_OR_RETURN(xla::CompileOptionsProto options_proto,\n+                        options.ToProto());\n+  std::string serialized = options_proto.SerializeAsString();\n+\n+  PJRT_SerializedCompileOptions* serialized_options =\n+      new PJRT_SerializedCompileOptions;\n+  serialized_options->serialized = std::move(serialized);\n+  args->serialized_compile_options = serialized_options;\n+  args->serialized_bytes = serialized_options->serialized.data();\n+  args->serialized_bytes_size = serialized_options->serialized.size();\n+  args->serialized_compile_options_deleter =\n+      +[](PJRT_SerializedCompileOptions* options) { delete options; };\n+  return nullptr;\n+}\n+\n PJRT_Error* PJRT_Executable_GetCompiledMemoryStats(\n     PJRT_Executable_GetCompiledMemoryStats_Args* args) {\n   PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n@@ -3276,6 +3298,8 @@ PJRT_Api CreatePjrtApi(PJRT_Client_Create* create_fn,\n       pjrt::PJRT_Device_CreateAsyncTrackingEvent,\n       /*PJRT_AsyncTrackingEvent_Destroy=*/\n       pjrt::PJRT_AsyncTrackingEvent_Destroy,\n+      /*PJRT_Executable_GetCompileOptions=*/\n+      pjrt::PJRT_Executable_GetCompileOptions,\n   };\n }\n "
        },
        {
            "sha": "a0da7731d1783722bc5418bd79803669204a5f68",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.h?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -215,6 +215,10 @@ struct PJRT_SerializedExecutable {\n   std::string serialized;\n };\n \n+struct PJRT_SerializedCompileOptions {\n+  std::string serialized;\n+};\n+\n struct PJRT_DeviceAssignmentSerialized {\n   std::string serialized;\n };\n@@ -378,6 +382,8 @@ PJRT_Error* PJRT_Executable_OutputMemoryKinds(\n PJRT_Error* PJRT_Executable_OptimizedProgram(\n     PJRT_Executable_OptimizedProgram_Args* args);\n PJRT_Error* PJRT_Executable_Serialize(PJRT_Executable_Serialize_Args* args);\n+PJRT_Error* PJRT_Executable_GetCompileOptions(\n+    PJRT_Executable_GetCompileOptions_Args* args);\n PJRT_Error* PJRT_Executable_GetCompiledMemoryStats(\n     PJRT_Executable_GetCompiledMemoryStats_Args* args);\n "
        },
        {
            "sha": "1e4823dc2f80b8b2887418615b1f0b5122ff8ccc",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -2210,6 +2210,32 @@ absl::StatusOr<std::string> PjRtCApiExecutable::FingerprintExecutable() const {\n                      args.executable_fingerprint_size);\n }\n \n+absl::StatusOr<CompileOptions> PjRtCApiExecutable::GetCompileOptions() const {\n+  if (c_api_->pjrt_api_version.major_version == 0 &&\n+      c_api_->pjrt_api_version.minor_version < 87) {\n+    return absl::UnimplementedError(\n+        \"PJRT_Executable_GetCompileOptions not implemented in this PJRT \"\n+        \"plugin.\");\n+  }\n+  PJRT_Executable_GetCompileOptions_Args args;\n+  args.struct_size = PJRT_Executable_GetCompileOptions_Args_STRUCT_SIZE;\n+  args.extension_start = nullptr;\n+  args.executable = c_executable();\n+  RETURN_STATUS_IF_PJRT_ERROR(c_api_->PJRT_Executable_GetCompileOptions(&args),\n+                              c_api_);\n+  absl::Cleanup cleanup = [&args] {\n+    args.serialized_compile_options_deleter(args.serialized_compile_options);\n+  };\n+  CompileOptionsProto proto;\n+  if (!proto.ParseFromString(\n+          std::string(args.serialized_bytes, args.serialized_bytes_size))) {\n+    return absl::InternalError(\n+        \"PjRtCApiExecutable::GetCompileOptions: Failed to parse \"\n+        \"CompileOptionsProto\");\n+  }\n+  return CompileOptions::FromProto(proto);\n+}\n+\n // ------------------------ Loaded Executables ---------------------------------\n \n PjRtCApiLoadedExecutable::PjRtCApiLoadedExecutable("
        },
        {
            "sha": "84d71e9740ec7fa99aaf022e0f191f23eb7f4539",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -680,6 +680,8 @@ class PjRtCApiExecutable : public PjRtExecutable {\n   // TODO(b/438000615): Move this to PjRtLoadedExecutable.\n   absl::StatusOr<std::string> GetSerializedExecutableMetadata() const;\n \n+  absl::StatusOr<CompileOptions> GetCompileOptions() const override;\n+\n  private:\n   const PJRT_Api* c_api_;\n   std::unique_ptr<PJRT_Executable, ::pjrt::PJRT_ExecutableDeleter> executable_;\n@@ -755,6 +757,10 @@ class PjRtCApiLoadedExecutable : public PjRtLoadedExecutable {\n     return executable_->GetOutputMemoryKinds();\n   }\n \n+  absl::StatusOr<CompileOptions> GetCompileOptions() const override {\n+    return executable_->GetCompileOptions();\n+  }\n+\n   absl::StatusOr<std::vector<std::vector<std::unique_ptr<PjRtBuffer>>>> Execute(\n       absl::Span<const std::vector<PjRtBuffer*>> argument_handles,\n       const ExecuteOptions& options,"
        },
        {
            "sha": "f45151debe82db3d8286f175d83ab44d4c3a1fa5",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc?ref=45c0013db6d0b5c8dadca5ca1f9e80cb4b0b60fa",
            "patch": "@@ -338,6 +338,29 @@ TEST(PjRtCApiClientTest, NonEmptyExecutableFingerprint) {\n   }\n }\n \n+TEST(PjRtCApiClientTest, GetCompileOptions) {\n+  SetUpCpuPjRtApi();\n+  ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                       GetCApiClient(\"cpu\"));\n+  Shape shape = ShapeUtil::MakeShapeWithType<float>({4});\n+  XlaBuilder builder(\"sum\");\n+  auto inp_0 = Parameter(&builder, 0, shape, \"input0\");\n+  auto inp_1 = Parameter(&builder, 1, shape, \"input1\");\n+  auto sum = Add(inp_0, inp_1);\n+  builder.SetUpAlias({}, 0, {});\n+  auto computation = builder.Build(sum).value();\n+\n+  CompileOptions options;\n+  options.compile_portable_executable = !options.compile_portable_executable;\n+  ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtLoadedExecutable> executable,\n+                       client->CompileAndLoad(computation, options));\n+\n+  ASSERT_OK_AND_ASSIGN(CompileOptions retrieved_options,\n+                       executable->GetCompileOptions());\n+  EXPECT_EQ(retrieved_options.compile_portable_executable,\n+            options.compile_portable_executable);\n+}\n+\n TEST(PjRtCApiClientTest, CreateBuffersForAsyncHostToDeviceWithShape) {\n   SetUpCpuPjRtApi();\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,"
        }
    ],
    "stats": {
        "total": 125,
        "additions": 123,
        "deletions": 2
    }
}