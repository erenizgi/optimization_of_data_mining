{
    "author": "deqiangc",
    "message": "Add a StartDetachedThread api to tsl::Env.\n\nReverts fc70e15edda5569dd29915100bb5f48415f88eca\n\nPiperOrigin-RevId: 800631279",
    "sha": "e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4",
    "files": [
        {
            "sha": "2213127de34fce0af58fa1b6c6575d7c82f59298",
            "filename": "third_party/xla/xla/tsl/platform/BUILD",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD?ref=e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4",
            "patch": "@@ -381,6 +381,18 @@ cc_library(\n     deps = tf_windows_aware_platform_deps(\"env_impl\"),\n )\n \n+tsl_cc_test(\n+    name = \"env_test\",\n+    srcs = [\"env_test.cc\"],\n+    deps = [\n+        \":env\",\n+        \":test\",\n+        \"@com_google_absl//absl/synchronization\",\n+        \"@com_google_absl//absl/time\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n cc_library(\n     name = \"env_time\",\n     compatible_with = get_compatible_with_portable(),"
        },
        {
            "sha": "a17d6538bcfe1b7f1dad7f05d36f8518c02d5b0a",
            "filename": "third_party/xla/xla/tsl/platform/default/env.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fenv.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fdefault%2Fenv.cc?ref=e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4",
            "patch": "@@ -66,7 +66,8 @@ std::map<std::thread::id, string>& GetThreadNameRegistry()\n class PThread : public Thread {\n  public:\n   PThread(const ThreadOptions& thread_options, const std::string& name,\n-          absl::AnyInvocable<void()> fn) {\n+          absl::AnyInvocable<void()> fn, bool detached = false)\n+      : detached_(detached) {\n     ThreadParams* params = new ThreadParams;\n     params->name = name;\n     params->fn = std::move(fn);\n@@ -75,14 +76,21 @@ class PThread : public Thread {\n     if (thread_options.stack_size != 0) {\n       pthread_attr_setstacksize(&attributes, thread_options.stack_size);\n     }\n+    if (detached) {\n+      pthread_attr_setdetachstate(&attributes, PTHREAD_CREATE_DETACHED);\n+    }\n     int ret = pthread_create(&thread_, &attributes, &ThreadFn, params);\n     // There is no mechanism for the thread creation API to fail, so we CHECK.\n     CHECK_EQ(ret, 0) << \"Thread \" << name\n                      << \" creation via pthread_create() failed.\";\n     pthread_attr_destroy(&attributes);\n   }\n \n-  ~PThread() override { pthread_join(thread_, nullptr); }\n+  ~PThread() override {\n+    if (!detached_) {\n+      pthread_join(thread_, nullptr);\n+    }\n+  }\n \n  private:\n   struct ThreadParams {\n@@ -105,6 +113,7 @@ class PThread : public Thread {\n   }\n \n   pthread_t thread_;\n+  bool detached_;\n };\n \n class PosixEnv : public Env {\n@@ -142,6 +151,11 @@ class PosixEnv : public Env {\n                       absl::AnyInvocable<void()> fn) override {\n     return new PThread(thread_options, name, std::move(fn));\n   }\n+  void StartDetachedThread(const ThreadOptions& thread_options,\n+                           const string& name,\n+                           absl::AnyInvocable<void()> fn) override {\n+    PThread detached(thread_options, name, std::move(fn), /*detached=*/true);\n+  }\n \n   int64_t GetCurrentThreadId() override {\n     static thread_local int64_t current_thread_id ="
        },
        {
            "sha": "2357ae513d2581a61e7e74dada93dd2be47bad2f",
            "filename": "third_party/xla/xla/tsl/platform/env.h",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fenv.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fenv.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fenv.h?ref=e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4",
            "patch": "@@ -449,6 +449,15 @@ class Env {\n       const ThreadOptions& thread_options, const std::string& name,\n       absl::AnyInvocable<void()> fn) TF_MUST_USE_RESULT = 0;\n \n+  /// \\brief Starts a new detached thread that runs fn() and is identified\n+  /// (for debugging/performance-analysis) by \"name\".\n+  ///\n+  virtual void StartDetachedThread(const ThreadOptions& thread_options,\n+                                   const std::string& name,\n+                                   absl::AnyInvocable<void()> fn) {\n+    LOG(FATAL) << \"StartDetachedThread is not implemented in this environment.\";\n+  }\n+\n   // Returns the thread id of calling thread.\n   // Posix: Returns pthread id which is only guaranteed to be unique within a\n   //        process.\n@@ -551,6 +560,12 @@ class EnvWrapper : public Env {\n                       absl::AnyInvocable<void()> fn) override {\n     return target_->StartThread(thread_options, name, std::move(fn));\n   }\n+  void StartDetachedThread(const ThreadOptions& thread_options,\n+                           const std::string& name,\n+                           absl::AnyInvocable<void()> fn) override {\n+    target_->StartDetachedThread(thread_options, name, std::move(fn));\n+  }\n+\n   int64_t GetCurrentThreadId() override {\n     return target_->GetCurrentThreadId();\n   }"
        },
        {
            "sha": "fe3f28bb71201d1d55282b0c0d090fbf845acf91",
            "filename": "third_party/xla/xla/tsl/platform/env_test.cc",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fenv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fenv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fenv_test.cc?ref=e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4",
            "patch": "@@ -0,0 +1,43 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tsl/platform/env.h\"\n+\n+#include <gtest/gtest.h>\n+#include \"absl/synchronization/blocking_counter.h\"\n+#include \"absl/time/clock.h\"\n+#include \"absl/time/time.h\"\n+\n+namespace tsl {\n+namespace {\n+\n+TEST(EnvTest, StartDetachedThread) {\n+  Env* env = Env::Default();\n+  const int num_threads = 10;\n+  absl::BlockingCounter counter(num_threads);\n+\n+  ThreadOptions thread_options;\n+  for (int i = 0; i < num_threads; ++i) {\n+    env->StartDetachedThread(thread_options, \"MyDetachedThread\", [&]() {\n+      absl::SleepFor(absl::Milliseconds(50));\n+      counter.DecrementCount();\n+    });\n+  }\n+\n+  counter.Wait();\n+}\n+\n+}  // namespace\n+}  // namespace tsl"
        },
        {
            "sha": "6b57728045ec8b3fdf72cfa703955f2e3a865e17",
            "filename": "third_party/xla/xla/tsl/platform/windows/env.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2Fenv.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fwindows%2Fenv.cc?ref=e8c6c2ab4f9b52e05ef9f9f648066ad0775509c4",
            "patch": "@@ -57,20 +57,26 @@ class StdThread : public Thread {\n  public:\n   // thread_options is ignored.\n   StdThread(const ThreadOptions& thread_options, const string& name,\n-            absl::AnyInvocable<void()> fn)\n-      : thread_(std::move(fn)) {\n+            absl::AnyInvocable<void()> fn, bool detached = false)\n+      : detached_(detached), thread_(std::move(fn)) {\n+    if (detached) {\n+      thread_.detach();\n+    }\n     mutex_lock l(name_mutex);\n     GetThreadNameRegistry().emplace(thread_.get_id(), name);\n   }\n \n   ~StdThread() override {\n     std::thread::id thread_id = thread_.get_id();\n-    thread_.join();\n+    if (!detached_) {\n+      thread_.join();\n+    }\n     mutex_lock l(name_mutex);\n     GetThreadNameRegistry().erase(thread_id);\n   }\n \n  private:\n+  bool detached_;\n   std::thread thread_;\n };\n \n@@ -106,6 +112,13 @@ class WindowsEnv : public Env {\n     return new StdThread(thread_options, name, std::move(fn));\n   }\n \n+  void StartDetachedThread(const ThreadOptions& thread_options,\n+                           const string& name,\n+                           absl::AnyInvocable<void()> fn) override {\n+    StdThread detached_thread(thread_options, name, std::move(fn),\n+                              /*detached=*/true);\n+  }\n+\n   int64_t GetCurrentThreadId() override {\n     return static_cast<int64_t>(::GetCurrentThreadId());\n   }"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 102,
        "deletions": 5
    }
}