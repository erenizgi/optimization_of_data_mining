{
    "author": "mkuperst",
    "message": "[XLA] Add methods to permute the operands of a fusion op.\n\nPiperOrigin-RevId: 841903126",
    "sha": "5854d191dc17b477b4efc7228160f3febcfd72a6",
    "files": [
        {
            "sha": "50d5655aeab3abc6a5e71717c2cf2675607f9391",
            "filename": "third_party/xla/xla/hlo/ir/hlo_computation.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc?ref=5854d191dc17b477b4efc7228160f3febcfd72a6",
            "patch": "@@ -593,6 +593,36 @@ absl::Status HloComputation::RemoveUnusedParametersImpl(bool allow_non_fusion) {\n   return absl::OkStatus();\n }\n \n+absl::Status HloComputation::PermuteParameters(\n+    absl::Span<const int64_t> permutation) {\n+  if (permutation.size() != num_parameters()) {\n+    return absl::InvalidArgumentError(\n+        \"Permutation size must match the number of parameters.\");\n+  }\n+  if (permutation.size() == 1) {\n+    return absl::OkStatus();\n+  }\n+\n+  std::vector<std::unique_ptr<HloInstruction>> new_param_instructions(\n+      num_parameters());\n+  for (int64_t i = 0; i < num_parameters(); ++i) {\n+    int64_t new_param_number = permutation[i];\n+    new_param_instructions[new_param_number] = HloInstruction::CreateParameter(\n+        new_param_number, param_instructions_[i]->shape(),\n+        param_instructions_[i]->name());\n+  }\n+\n+  for (int64_t i = 0; i < num_parameters(); ++i) {\n+    ReplaceParameter(i, std::move(new_param_instructions[permutation[i]]));\n+  }\n+\n+  absl::c_sort(param_instructions_,\n+               [](const HloInstruction* a, const HloInstruction* b) {\n+                 return a->parameter_number() < b->parameter_number();\n+               });\n+  return absl::OkStatus();\n+}\n+\n bool HloComputation::IsSafelyRemovable(\n     const HloInstruction* instruction, bool ignore_control_dependency,\n     std::optional<"
        },
        {
            "sha": "64f3ca34d84a98dca730c5410bcb8b0a2dd0dfdf",
            "filename": "third_party/xla/xla/hlo/ir/hlo_computation.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.h?ref=5854d191dc17b477b4efc7228160f3febcfd72a6",
            "patch": "@@ -984,6 +984,10 @@ class HloComputation {\n \n   void ClearCalledComputations();\n \n+  // Permutes the parameter numbers of this computation according to the\n+  // provided permutation.\n+  absl::Status PermuteParameters(absl::Span<const int64_t> permutation);\n+\n  private:\n   friend class HloModule;\n "
        },
        {
            "sha": "526165754c97946ff295c5a7a8502609b137d4dd",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instructions.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc?ref=5854d191dc17b477b4efc7228160f3febcfd72a6",
            "patch": "@@ -2597,6 +2597,33 @@ absl::Status HloFusionInstruction::DeduplicateFusionOperands() {\n   return absl::OkStatus();\n }\n \n+absl::Status HloFusionInstruction::PermuteFusionOperands(\n+    absl::Span<const int64_t> permutation) {\n+  if (permutation.size() != operand_count()) {\n+    return absl::InvalidArgumentError(\n+        \"Permutation size must match the number of operands.\");\n+  }\n+  std::vector<bool> seen(permutation.size(), false);\n+  for (int64_t i = 0; i < permutation.size(); ++i) {\n+    if (permutation[i] < 0 || permutation[i] >= operand_count() ||\n+        seen[permutation[i]]) {\n+      return absl::InvalidArgumentError(\n+          \"Argument is not a permutation of operand indices.\");\n+    }\n+    seen[permutation[i]] = true;\n+  }\n+\n+  TF_RETURN_IF_ERROR(\n+      fused_instructions_computation()->PermuteParameters(permutation));\n+  InstructionVector new_operands(operand_count());\n+  for (int64_t i = 0; i < operand_count(); ++i) {\n+    new_operands[permutation[i]] = mutable_operand(i);\n+  }\n+  RemoveAllOperands();\n+  AppendOperands(new_operands);\n+  return absl::OkStatus();\n+}\n+\n HloCallInstruction::HloCallInstruction(const Shape& shape,\n                                        HloInstruction* called_computation_root)\n     : HloCallableInstruction(HloOpcode::kCall, shape) {"
        },
        {
            "sha": "b73f54e0b830f9fc12b7e0d3ec3750ca21864b01",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instructions.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.h?ref=5854d191dc17b477b4efc7228160f3febcfd72a6",
            "patch": "@@ -1588,6 +1588,10 @@ class HloFusionInstruction : public HloCallableInstruction {\n   // If multiple operands are the same instruction, keeps only one of them.\n   absl::Status DeduplicateFusionOperands();\n \n+  // Permutes the operands computation according to the provided permutation.\n+  // The fusion computation is also adjusted accordingly.\n+  absl::Status PermuteFusionOperands(absl::Span<const int64_t> permutation);\n+\n   static bool ClassOf(const HloInstruction* hlo) {\n     return hlo->opcode() == HloOpcode::kFusion;\n   }"
        },
        {
            "sha": "52e39430e85f9de705c2fcd78878956a68308a5f",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=5854d191dc17b477b4efc7228160f3febcfd72a6",
            "patch": "@@ -925,6 +925,7 @@ xla_cc_test(\n         \"//xla/service/gpu:backend_configs_cc\",\n         \"//xla/tests:xla_internal_test_main\",\n         \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "aa90adc01f6e8a32ea5fa9f11b10f10a3be9f14f",
            "filename": "third_party/xla/xla/service/hlo_instruction_test.cc",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5854d191dc17b477b4efc7228160f3febcfd72a6/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc?ref=5854d191dc17b477b4efc7228160f3febcfd72a6",
            "patch": "@@ -51,6 +51,7 @@ limitations under the License.\n #include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"xla/util.h\"\n #include \"xla/window_util.h\"\n@@ -3381,5 +3382,39 @@ TEST_F(HloInstructionTest, DifferentResultAccuracy) {\n   EXPECT_FALSE(exp1->equal_result_accuracy(exp2));\n }\n \n+TEST_F(HloInstructionTest, FusionPermuteOperandsTest) {\n+  constexpr char kHloString[] = R\"(\n+  HloModule test_module\n+  fusion_computation {\n+    p0 = f32[] parameter(0)\n+    p1 = f32[32] parameter(1)\n+    p2 = f32[32,32] parameter(2)\n+    bcast0 = f32[32,32] broadcast(p0), dimensions={}\n+    bcast1 = f32[32,32] broadcast(p1), dimensions={0}\n+    sub = f32[32,32] subtract(bcast0, bcast1)\n+    ROOT add = f32[32,32] add(sub, p2)\n+  }\n+\n+  ENTRY reduce {\n+    p0 = f32[] parameter(0)\n+    p1 = f32[32] parameter(1)\n+    p2 = f32[32,32] parameter(2)\n+    ROOT root = f32[32,32] fusion(p0, p1, p2), kind=kLoop, calls=fusion_computation\n+  })\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(kHloString));\n+  HloFusionInstruction* fusion = Cast<HloFusionInstruction>(\n+      module->entry_computation()->root_instruction());\n+  EXPECT_OK(fusion->PermuteFusionOperands({1, 2, 0}));\n+\n+  EXPECT_THAT(fusion, GmockMatch(m::Fusion(m::Parameter(2), m::Parameter(0),\n+                                           m::Parameter(1))));\n+  HloComputation* fusion_computation = fusion->fused_instructions_computation();\n+  EXPECT_THAT(fusion_computation->root_instruction(),\n+              GmockMatch(m::Add(m::Subtract(m::Broadcast(m::Parameter(1)),\n+                                            m::Broadcast(m::Parameter(2))),\n+                                m::Parameter(0))));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 101,
        "deletions": 0
    }
}