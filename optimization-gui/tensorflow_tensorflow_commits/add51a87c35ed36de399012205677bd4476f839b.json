{
    "author": "felixwqp",
    "message": "[XLA:GPU] Update latency hiding scheduler cost models for B200/H100 FP8 matmul\n\nPiperOrigin-RevId: 822446122",
    "sha": "add51a87c35ed36de399012205677bd4476f839b",
    "files": [
        {
            "sha": "f97be52d5a245933f070427712c8bca7b43389c5",
            "filename": "third_party/xla/xla/service/gpu/model/matmul_interpolator_data.h",
            "status": "modified",
            "additions": 5967,
            "deletions": 3717,
            "changes": 9684,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/add51a87c35ed36de399012205677bd4476f839b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_data.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/add51a87c35ed36de399012205677bd4476f839b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_data.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_data.h?ref=add51a87c35ed36de399012205677bd4476f839b"
        },
        {
            "sha": "d2190003d598e4f4696a557dcc4474eed6988222",
            "filename": "third_party/xla/xla/service/gpu/model/matmul_interpolator_test.cc",
            "status": "modified",
            "additions": 91,
            "deletions": 5,
            "changes": 96,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/add51a87c35ed36de399012205677bd4476f839b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/add51a87c35ed36de399012205677bd4476f839b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_test.cc?ref=add51a87c35ed36de399012205677bd4476f839b",
            "patch": "@@ -413,7 +413,7 @@ INSTANTIATE_TEST_SUITE_P(\n              /*clock_cycles=*/0},\n             // Expected duration based on linear interpolation of flops/sec\n             // between (1,1024,1024,512) and (1,1024,4096,512).\n-            /*expected_duration=*/absl::Microseconds(9),\n+            /*expected_duration=*/absl::Microseconds(8),\n         },\n     }),\n     [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&\n@@ -497,7 +497,7 @@ INSTANTIATE_TEST_SUITE_P(\n              /*clock_cycles=*/0},\n             // Expected duration based on nearest point (1,2048,2048,2048)\n             // flops/sec and scaling by new dimensions.\n-            /*expected_duration=*/absl::Microseconds(72),\n+            /*expected_duration=*/absl::Microseconds(67),\n         },\n         {\n             /*test_name=*/\"interpolate_larger_batch_s8\",\n@@ -509,7 +509,7 @@ INSTANTIATE_TEST_SUITE_P(\n              /*clock_cycles=*/0},\n             // Expected duration based on nearest point (1,2048,2048,2048)\n             // flops/sec and scaling by new dimensions.\n-            /*expected_duration=*/absl::Microseconds(280),\n+            /*expected_duration=*/absl::Microseconds(275),\n         },\n     }),\n     [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&\n@@ -539,7 +539,7 @@ INSTANTIATE_TEST_SUITE_P(\n              /*rhs_type=*/\"s8\",\n              /*result_type=*/\"s8\",\n              /*clock_cycles=*/0},\n-            /*expected_duration=*/absl::Microseconds(44),\n+            /*expected_duration=*/absl::Microseconds(39),\n         },\n         {\n             /*test_name=*/\"exact_match2_s8\",\n@@ -549,7 +549,93 @@ INSTANTIATE_TEST_SUITE_P(\n              /*rhs_type=*/\"s8\",\n              /*result_type=*/\"s8\",\n              /*clock_cycles=*/0},\n-            /*expected_duration=*/absl::Microseconds(64),\n+            /*expected_duration=*/absl::Microseconds(59),\n+        },\n+    }),\n+    [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&\n+           info) { return info.param.test_name; });\n+\n+using H100F8Test = MatmulInterpolatorDefaultTableTest;\n+\n+TEST_P(H100F8Test, EstimatesRuntimeForF8) {\n+  const auto& [_, spec, expected_duration] = GetParam();\n+  TF_ASSERT_OK_AND_ASSIGN(DotContext context,\n+                          Dot(spec.b, spec.m, spec.n, spec.k, spec.lhs_type,\n+                              spec.rhs_type, spec.result_type));\n+  // Compare with nanosecond precision.\n+  EXPECT_EQ(\n+      absl::Trunc(*GetMatmulInterpolatorH100()->EstimatedRuntime(*context.dot),\n+                  absl::Microseconds(1)),\n+      expected_duration);\n+}\n+\n+INSTANTIATE_TEST_SUITE_P(\n+    MatmulInterpolatorDefaultTableTestInstantiationF8, H100F8Test,\n+    ValuesIn<ParametrizedTestCase>({\n+        {\n+            /*test_name=*/\"extrapolate_small_f8e4m3fn_f8e4m3fn_bf16\",\n+            /*spec=*/\n+            {/*b=*/1, /*m=*/64, /*n=*/64, /*k=*/64,\n+             /*lhs_type=*/\"f8e4m3fn\",\n+             /*rhs_type=*/\"f8e4m3fn\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n+            // Expected duration based on nearest point (1,512,512,512)\n+            // flops/sec and scaling by new dimensions.\n+            /*expected_duration=*/absl::Microseconds(0),\n+        },\n+        {\n+            /*test_name=*/\"interpolate_larger_f8e4m3fn_f8e4m3fn_bf16\",\n+            /*spec=*/\n+            {/*b=*/1, /*m=*/2048, /*n=*/2048, /*k=*/2048,\n+             /*lhs_type=*/\"f8e4m3fn\",\n+             /*rhs_type=*/\"f8e4m3fn\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n+            // Expected duration based on nearest point (1,2048,2048,2048)\n+            // flops/sec and scaling by new dimensions.\n+            /*expected_duration=*/absl::Microseconds(12),\n+        },\n+    }),\n+    [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&\n+           info) { return info.param.test_name; });\n+\n+using B200F8Test = MatmulInterpolatorDefaultTableTest;\n+\n+TEST_P(B200F8Test, EstimatesRuntimeForF8) {\n+  const auto& [_, spec, expected_duration] = GetParam();\n+  TF_ASSERT_OK_AND_ASSIGN(DotContext context,\n+                          Dot(spec.b, spec.m, spec.n, spec.k, spec.lhs_type,\n+                              spec.rhs_type, spec.result_type));\n+  // Compare with nanosecond precision.\n+  EXPECT_EQ(\n+      absl::Trunc(*GetMatmulInterpolatorB200()->EstimatedRuntime(*context.dot),\n+                  absl::Microseconds(1)),\n+      expected_duration);\n+}\n+\n+INSTANTIATE_TEST_SUITE_P(\n+    MatmulInterpolatorDefaultTableTestInstantiationF8, B200F8Test,\n+    ValuesIn<ParametrizedTestCase>({\n+        {\n+            /*test_name=*/\"exact_match1_f8e4m3fn_f8e5m2_bf16\",\n+            /*spec=*/\n+            {/*b=*/1, /*m=*/512, /*n=*/512, /*k=*/512,\n+             /*lhs_type=*/\"f8e4m3fn\",\n+             /*rhs_type=*/\"f8e5m2\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n+            /*expected_duration=*/absl::Microseconds(5),\n+        },\n+        {\n+            /*test_name=*/\"exact_match2_f8e4m3fn_f8e4m3fn_bf16\",\n+            /*spec=*/\n+            {/*b=*/1, /*m=*/2048, /*n=*/2048, /*k=*/2048,\n+             /*lhs_type=*/\"f8e4m3fn\",\n+             /*rhs_type=*/\"f8e4m3fn\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n+            /*expected_duration=*/absl::Microseconds(12),\n         },\n     }),\n     [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&"
        },
        {
            "sha": "52a8389a8360af5f2c3649245b16120cb2e7b2f0",
            "filename": "third_party/xla/xla/service/gpu/model/sol_latency_estimator_test.cc",
            "status": "modified",
            "additions": 122,
            "deletions": 2,
            "changes": 124,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/add51a87c35ed36de399012205677bd4476f839b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsol_latency_estimator_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/add51a87c35ed36de399012205677bd4476f839b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsol_latency_estimator_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fsol_latency_estimator_test.cc?ref=add51a87c35ed36de399012205677bd4476f839b",
            "patch": "@@ -344,7 +344,7 @@ ENTRY e {\n })\",\n       /*opcode_to_find=*/HloOpcode::kFusion,\n       /*cost_type=*/CostType::kNodeCost,\n-      /*expected_latency=*/absl::Microseconds(9),\n+      /*expected_latency=*/absl::Microseconds(8),\n   };\n \n   EstimatorTestCase cublas_matmul_bf16_batch1_1024_1024_1024 = {\n@@ -374,7 +374,127 @@ ENTRY e {\n })\",\n       /*opcode_to_find=*/HloOpcode::kCustomCall,\n       /*cost_type=*/CostType::kNodeCost,\n-      /*expected_latency=*/absl::Microseconds(9),\n+      /*expected_latency=*/absl::Microseconds(8),\n+  };\n+\n+  EstimatorTestCase cublaslt_matmul_mixed_fp8_batch1_1024_1024_1024 = {\n+      /*test_name=*/\"cublas_matmul_mixed_fp8_batch1_1024_1024_1024\",\n+      /*module_string=*/R\"(\n+HloModule m\n+\n+ENTRY e {\n+  p0 = f8e5m2[1024,1024] parameter(0)\n+  p1 = f8e4m3fn[1024,1024] parameter(1)\n+  ROOT _ =  (bf16[1024,1024], s8[2097152]{0}) custom-call(p0,p1),\n+    custom_call_target=\"__cublas$lt$matmul$f8\",\n+    backend_config={\n+      \"operation_queue_id\":\"0\",\n+      \"wait_on_operation_queues\":[],\n+      \"gemm_backend_config\":{\n+        \"alpha_real\":1,\n+        \"beta\":1,\n+        \"dot_dimension_numbers\": {\n+          \"lhs_contracting_dimensions\":[\"1\"],\n+          \"rhs_contracting_dimensions\":[\"1\"],\n+          \"lhs_batch_dimensions\":[],\n+          \"rhs_batch_dimensions\":[]\n+        }\n+      }\n+    }\n+})\",\n+      /*opcode_to_find=*/HloOpcode::kCustomCall,\n+      /*cost_type=*/CostType::kNodeCost,\n+      /*expected_latency=*/absl::Microseconds(8),\n+  };\n+\n+  EstimatorTestCase cublaslt_matmul_f8e5m2_f8e4m3fn_batch1_1024_1024_1024 = {\n+      /*test_name=*/\"cublaslt_matmul_f8e5m2_f8e4m3fn_batch1_1024_1024_1024\",\n+      /*module_string=*/R\"(\n+HloModule m\n+\n+ENTRY e {\n+  p0 = f8e5m2[1024,1024] parameter(0)\n+  p1 = f8e4m3fn[1024,1024] parameter(1)\n+  ROOT _ =  (bf16[1024,1024], s8[2097152]{0}) custom-call(p0,p1),\n+    custom_call_target=\"__cublas$lt$matmul$f8\",\n+    backend_config={\n+      \"operation_queue_id\":\"0\",\n+      \"wait_on_operation_queues\":[],\n+      \"gemm_backend_config\":{\n+        \"alpha_real\":1,\n+        \"beta\":1,\n+        \"dot_dimension_numbers\": {\n+          \"lhs_contracting_dimensions\":[\"1\"],\n+          \"rhs_contracting_dimensions\":[\"1\"],\n+          \"lhs_batch_dimensions\":[],\n+          \"rhs_batch_dimensions\":[]\n+        }\n+      }\n+    }\n+})\",\n+      /*opcode_to_find=*/HloOpcode::kCustomCall,\n+      /*cost_type=*/CostType::kNodeCost,\n+      /*expected_latency=*/absl::Microseconds(8),\n+  };\n+\n+  EstimatorTestCase cublaslt_matmul_f8e4m3fn_f8e5m2_batch1_1024_1024_1024 = {\n+      /*test_name=*/\"cublaslt_matmul_f8e4m3fn_f8e5m2_batch1_1024_1024_1024\",\n+      /*module_string=*/R\"(\n+HloModule m\n+\n+ENTRY e {\n+  p0 = f8e4m3fn[1024,1024] parameter(0)\n+  p1 = f8e5m2[1024,1024] parameter(1)\n+  ROOT _ =  (bf16[1024,1024], s8[2097152]{0}) custom-call(p0,p1),\n+    custom_call_target=\"__cublas$lt$matmul$f8\",\n+    backend_config={\n+      \"operation_queue_id\":\"0\",\n+      \"wait_on_operation_queues\":[],\n+      \"gemm_backend_config\":{\n+        \"alpha_real\":1,\n+        \"beta\":1,\n+        \"dot_dimension_numbers\": {\n+          \"lhs_contracting_dimensions\":[\"1\"],\n+          \"rhs_contracting_dimensions\":[\"1\"],\n+          \"lhs_batch_dimensions\":[],\n+          \"rhs_batch_dimensions\":[]\n+        }\n+      }\n+    }\n+})\",\n+      /*opcode_to_find=*/HloOpcode::kCustomCall,\n+      /*cost_type=*/CostType::kNodeCost,\n+      /*expected_latency=*/absl::Microseconds(8),\n+  };\n+\n+  EstimatorTestCase cublaslt_matmul_f8e4m3fn_f8e4m3fn_batch1_1024_1024_1024 = {\n+      /*test_name=*/\"cublaslt_matmul_f8e4m3fn_f8e4m3fn_batch1_1024_1024_1024\",\n+      /*module_string=*/R\"(\n+HloModule m\n+\n+ENTRY e {\n+  p0 = f8e4m3fn[1024,1024] parameter(0)\n+  p1 = f8e4m3fn[1024,1024] parameter(1)\n+  ROOT _ =  (bf16[1024,1024], s8[2097152]{0}) custom-call(p0,p1),\n+    custom_call_target=\"__cublas$lt$matmul$f8\",\n+    backend_config={\n+      \"operation_queue_id\":\"0\",\n+      \"wait_on_operation_queues\":[],\n+      \"gemm_backend_config\":{\n+        \"alpha_real\":1,\n+        \"beta\":1,\n+        \"dot_dimension_numbers\": {\n+          \"lhs_contracting_dimensions\":[\"1\"],\n+          \"rhs_contracting_dimensions\":[\"1\"],\n+          \"lhs_batch_dimensions\":[],\n+          \"rhs_batch_dimensions\":[]\n+        }\n+      }\n+    }\n+})\",\n+      /*opcode_to_find=*/HloOpcode::kCustomCall,\n+      /*cost_type=*/CostType::kNodeCost,\n+      /*expected_latency=*/absl::Microseconds(8),\n   };\n \n   EstimatorTestCase simple_fusion_elementwise = {"
        }
    ],
    "stats": {
        "total": 9904,
        "additions": 6180,
        "deletions": 3724
    }
}