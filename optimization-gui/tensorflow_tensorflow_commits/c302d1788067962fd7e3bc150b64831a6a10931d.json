{
    "author": "sergachev",
    "message": "PR #31340: [GPU] Move bitcast-convert expansion past layout assignment.\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31340\n\nThis lets post-layout assignment algebraic simplifier replace no-op bitcast-converts with bitcasts first.\n\nCopybara import of the project:\n\n--\n4a7570e1f798f79a6e437ee438fb8302114c8af5 by Ilia Sergachev <isergachev@nvidia.com>:\n\n[GPU] Move bitcast-convert expansion past layout assignment.\n\nThis lets post-layout assignment algebraic simplifier replace no-op\nbitcast-converts with bitcasts first.\n\nMerging this change closes #31340\n\nPiperOrigin-RevId: 808473266",
    "sha": "c302d1788067962fd7e3bc150b64831a6a10931d",
    "files": [
        {
            "sha": "0dd0cf71a3e7d362d3cd90b126a23e7f9f88fd3c",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=c302d1788067962fd7e3bc150b64831a6a10931d",
            "patch": "@@ -899,7 +899,6 @@ absl::Status RunOptimizationPasses(\n         gpu_target_config.device_description.gpu_compute_capability());\n     pipeline.AddPass<GpuAlgebraicSimplifier>(layout_insensitive_algsimp_opts,\n                                              gpu_version);\n-    pipeline.AddPass<BitcastDtypesExpander>();\n     // Only merge \"smallish\" dots.  This threshold defaults to 32MB today, with\n     // a flag to override.\n     // Do not merge dots when they are assigned different stream ids.\n@@ -1704,6 +1703,10 @@ absl::Status GpuCompiler::OptimizeHloPostLayoutAssignment(\n     pipeline.AddPass<HloPassFix<GpuAlgebraicSimplifier>>(simplifier_options,\n                                                          gpu_version);\n \n+    // Expand bitcast-converts which are not bitcasts remaining after algebraic\n+    // simplification.\n+    pipeline.AddPass<BitcastDtypesExpander>();\n+\n     // GemmRewriter assumes that all transposes are folded into gemms, but,\n     // since commit 7d529df, this is not always true at this point.\n     // Therefore, rerun transpose folding."
        },
        {
            "sha": "d9eae15c0c0b55a5c4b7a20ce6c462a7e21787ff",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler_test.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc?ref=c302d1788067962fd7e3bc150b64831a6a10931d",
            "patch": "@@ -2132,6 +2132,34 @@ TEST_F(GpuCompilerTest, NoCudnnVectorizationOnHopperAndBeyond) {\n               absl_testing::IsOkAndHolds(true));\n }\n \n+TEST_F(GpuCompilerTest, BitcastConvertSimplificationToBitcastIsValid) {\n+  const std::string kHloText = R\"(\n+m {\n+  a = s4[3,5,2]{2,1,0} parameter(0)\n+  b = s8[3,5]{1,0} bitcast-convert(a)\n+  c = s8[3,5]{1,0} copy(b)\n+})\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> optimized_module,\n+                          GetOptimizedModule(kHloText));\n+  EXPECT_THAT(optimized_module->entry_computation()->root_instruction(),\n+              GmockMatch(m::Copy(m::Bitcast(m::Parameter()))));\n+\n+  HloModuleConfig config;\n+  DebugOptions debug_options = GetDebugOptionsForTest();\n+  debug_options.add_xla_disable_hlo_passes(\"algsimp\");\n+  config.set_debug_options(debug_options);\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> ref_module,\n+                          ParseAndReturnVerifiedModule(kHloText, config));\n+  TF_ASSERT_OK_AND_ASSIGN(ref_module,\n+                          GetOptimizedModule(std::move(ref_module)));\n+  EXPECT_THAT(ref_module->entry_computation()->root_instruction(),\n+              GmockMatch(m::Fusion(m::Parameter())));\n+\n+  EXPECT_TRUE(RunAndCompareTwoModules(std::move(optimized_module),\n+                                      std::move(ref_module), std::nullopt,\n+                                      /*run_hlo_passes=*/false));\n+}\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "076a77999452bd65a7af0a3ba4193ad784bc8f9f",
            "filename": "third_party/xla/xla/service/gpu/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD?ref=c302d1788067962fd7e3bc150b64831a6a10931d",
            "patch": "@@ -609,6 +609,7 @@ lit_test_suite(\n     name = \"hlo_lit_tests\",\n     srcs = enforce_glob(\n         [\n+            \"bitcast-convert.hlo\",\n             \"calling_convention.hlo\",\n             \"dot_bf16.hlo\",\n             \"kernel_reuse.hlo\","
        },
        {
            "sha": "a70d34d60e935a086eb33dcb10c0ec5ae7725e5f",
            "filename": "third_party/xla/xla/service/gpu/tests/bitcast-convert.hlo",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fbitcast-convert.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c302d1788067962fd7e3bc150b64831a6a10931d/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fbitcast-convert.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fbitcast-convert.hlo?ref=c302d1788067962fd7e3bc150b64831a6a10931d",
            "patch": "@@ -0,0 +1,13 @@\n+// RUN: hlo-opt %s --platform=gpu --xla_gpu_target_config_filename=%S/../../../tools/hlo_opt/gpu_specs/%{GPU}.txtpb | FileCheck  %s\n+\n+e {\n+  a = s4[8,2]{1,0} parameter(0)\n+  b = s8[8]{0} bitcast-convert(a)\n+  c = s8[8]{0} copy(b)\n+}\n+\n+// CHECK-NOT: bitcast-convert\n+// CHECK: ENTRY\n+// CHECK-NEXT: %[[p0:.*]] = s4[8,2]{1,0:E(4)} parameter(0)\n+// CHECK-NEXT: %[[b:.*]] = s8[8]{0} bitcast(%[[p0]])\n+// CHECK-NEXT: ROOT %[[c:.*]] = s8[8]{0} copy(%[[b]])"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 46,
        "deletions": 1
    }
}