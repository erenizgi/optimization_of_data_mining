{
    "author": "junwhanahn",
    "message": "Introduce a variant of `ToProto` that takes the proto as an output parameter\n\nThis is useful when the proto is part of a bigger message that's allocated on a custom arena. The previous `ToProto()` API forces a copy during assignment, whereas the new API allows the caller to serialize the proto directly into the arena-allocated submessage.\n\nPiperOrigin-RevId: 839475034",
    "sha": "20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
    "files": [
        {
            "sha": "0560dc56dc7d9af092f7d3b55f14eaa3f38d9fef",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -674,6 +674,7 @@ cc_library(\n         \":serdes_default_version_accessor\",\n         \":serdes_proto_cc\",\n         \":serdes_version\",\n+        \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n@@ -747,6 +748,7 @@ cc_library(\n         \":serdes_version\",\n         \":sharding_serdes_proto_cc\",\n         \"//xla/python/ifrt/ir:sharding_param\",\n+        \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n@@ -1092,6 +1094,7 @@ cc_library(\n         \":serdes_version\",\n         \":sharding_proto_cc\",\n         \":sharding_serdes\",\n+        \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\","
        },
        {
            "sha": "bcafdcb3ca0a04183c0ad28b0bf5d44991581e55",
            "filename": "third_party/xla/xla/python/ifrt/array_spec.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Farray_spec.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Farray_spec.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Farray_spec.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -58,22 +58,23 @@ absl::StatusOr<ArraySpec> ArraySpec::FromProto(Client* client,\n   };\n }\n \n-absl::StatusOr<ArraySpecProto> ArraySpec::ToProto(SerDesVersion version) const {\n+absl::Status ArraySpec::ToProto(ArraySpecProto& proto,\n+                                SerDesVersion version) const {\n   if (version.version_number() < SerDesVersionNumber(0)) {\n     return absl::FailedPreconditionError(\n         absl::StrCat(\"Unsupported \", version.version_number(),\n                      \" for ArraySpec serialization\"));\n   }\n \n-  ArraySpecProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n-  *proto.mutable_dtype() = dtype.ToProto(version);\n-  *proto.mutable_shape() = shape.ToProto(version);\n+  dtype.ToProto(*proto.mutable_dtype(), version);\n+  shape.ToProto(*proto.mutable_shape(), version);\n   TF_ASSIGN_OR_RETURN(*proto.mutable_sharding(), sharding->ToProto(version));\n   if (layout != nullptr) {\n     proto.set_layout(layout->Serialize());\n   }\n-  return proto;\n+  return absl::OkStatus();\n }\n \n std::string ArraySpec::DebugString() const {"
        },
        {
            "sha": "b3dccff08f9f09d7b3ead91f00cfaf3cd336bade",
            "filename": "third_party/xla/xla/python/ifrt/array_spec.h",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Farray_spec.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Farray_spec.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Farray_spec.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes_version.h\"\n #include \"xla/python/ifrt/shape.h\"\n #include \"xla/python/ifrt/sharding.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -78,9 +79,18 @@ struct ArraySpec {\n   static absl::StatusOr<ArraySpec> FromProto(Client* client,\n                                              const ArraySpecProto& proto);\n \n+  // Converts the array spec to a protobuf.\n+  absl::Status ToProto(\n+      ArraySpecProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `ArraySpecProto` representation.\n   absl::StatusOr<ArraySpecProto> ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    ArraySpecProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n \n   // TODO(hyeontaek): Remove this method in favor of AbslStringify.\n   std::string DebugString() const;"
        },
        {
            "sha": "18e827c78194e335b7952a8bfc25d8924b6e6e5e",
            "filename": "third_party/xla/xla/python/ifrt/attribute_map.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -71,14 +71,15 @@ absl::StatusOr<AttributeMap> AttributeMap::FromProto(\n   return AttributeMap(std::move(map));\n }\n \n-AttributeMapProto AttributeMap::ToProto(SerDesVersion version) const {\n+void AttributeMap::ToProto(AttributeMapProto& proto,\n+                           SerDesVersion version) const {\n   // TODO(b/423702568): Change the return type to `absl::StatusOr<...>` for\n   // graceful error handling.\n   CHECK_GE(version.version_number(), SerDesVersionNumber(0))\n       << \"Unsupported \" << version.version_number()\n       << \" for AttributeMap serialization\";\n \n-  AttributeMapProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n   for (const auto& [key, value] : map_) {\n@@ -105,7 +106,6 @@ AttributeMapProto AttributeMap::ToProto(SerDesVersion version) const {\n         value);\n     proto.mutable_attributes()->insert({key, std::move(value_proto)});\n   }\n-  return proto;\n }\n \n std::string AttributeMap::DebugString(size_t max_string_length,"
        },
        {
            "sha": "11dc6ae3b86af47f5896254baf446cba8eaae9dd",
            "filename": "third_party/xla/xla/python/ifrt/attribute_map.h",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -115,10 +115,18 @@ class AttributeMap {\n   // Deserializes `AttributeMapProto` into `AttributeMap`.\n   static absl::StatusOr<AttributeMap> FromProto(const AttributeMapProto& proto);\n \n-  // Serializes `AttributeMap` into `AttributeMapProto`.\n-  AttributeMapProto ToProto(\n+  // Converts the attribute map to a protobuf.\n+  void ToProto(\n+      AttributeMapProto& proto,\n       SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n \n+  AttributeMapProto ToProto(\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    AttributeMapProto proto;\n+    ToProto(proto, version);\n+    return proto;\n+  }\n+\n   std::string DebugString(size_t max_string_length = 64,\n                           size_t max_int64_list_size = 16) const;\n "
        },
        {
            "sha": "8f86114d91e27cc937e963f8121525eda480e484",
            "filename": "third_party/xla/xla/python/ifrt/custom_call_program_serdes.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fcustom_call_program_serdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fcustom_call_program_serdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fcustom_call_program_serdes.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n #include \"xla/python/ifrt/sharding.pb.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n@@ -69,12 +70,12 @@ class CustomCallProgramSerDes\n     // generates `absl::Cord` support on all platforms.\n     absl::CopyCordToString(program.serialized_program_text,\n                            proto.mutable_serialized_program_text());\n-    *proto.mutable_devices() = program.devices->ToProto(version);\n+    program.devices->ToProto(*proto.mutable_devices(), version);\n     for (const ArraySpec& spec : program.input_specs) {\n-      TF_ASSIGN_OR_RETURN(*proto.add_input_specs(), spec.ToProto(version));\n+      TF_RETURN_IF_ERROR(spec.ToProto(*proto.add_input_specs(), version));\n     }\n     for (const ArraySpec& spec : program.output_specs) {\n-      TF_ASSIGN_OR_RETURN(*proto.add_output_specs(), spec.ToProto(version));\n+      TF_RETURN_IF_ERROR(spec.ToProto(*proto.add_output_specs(), version));\n     }\n     return proto.SerializeAsString();\n   }"
        },
        {
            "sha": "054ef6b3834f5561e6939de7a281abb93247f07e",
            "filename": "third_party/xla/xla/python/ifrt/device_list.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdevice_list.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdevice_list.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdevice_list.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -80,21 +80,20 @@ absl::StatusOr<DeviceListRef> DeviceList::FromProto(\n   return client->MakeDeviceList(devices);\n }\n \n-DeviceListProto DeviceList::ToProto(SerDesVersion version) const {\n-  // TODO(b/423702568): Change the return type to `absl::StatusOr<...>` for\n-  // graceful error handling.\n+void DeviceList::ToProto(DeviceListProto& proto, SerDesVersion version) const {\n+  // TODO(b/423702568): Change the return type to `absl::Status` for graceful\n+  // error handling.\n   CHECK_GE(version.version_number(), SerDesVersionNumber(0))\n       << \"Unsupported \" << version.version_number()\n       << \" for DeviceList serialization\";\n \n-  DeviceListProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n   proto.mutable_device_ids()->Reserve(devices().size());\n   for (Device* device : devices()) {\n     proto.mutable_device_ids()->AddAlreadyReserved(device->Id().value());\n   }\n-  return proto;\n }\n \n uint64_t DeviceList::fingerprint() const {"
        },
        {
            "sha": "f3b540cb11238733f86a0281b32d98f8a8b45f84",
            "filename": "third_party/xla/xla/python/ifrt/device_list.h",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdevice_list.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdevice_list.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdevice_list.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -51,9 +51,18 @@ class DeviceList : public tsl::ReferenceCounted<DeviceList>,\n   static absl::StatusOr<RCReferenceWrapper<DeviceList>> FromProto(\n       xla::ifrt::Client* client, const DeviceListProto& proto);\n \n+  // Converts the device list to a protobuf.\n+  void ToProto(\n+      DeviceListProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `DeviceListProto` representation.\n   DeviceListProto ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    DeviceListProto proto;\n+    ToProto(proto, version);\n+    return proto;\n+  }\n \n   // Returns the number of devices.\n   // TODO(hyeontaek): Make this a virtual method and make it possible for a"
        },
        {
            "sha": "dfa09aef3ba2d60e535b3f26c49a1bf0f0404beb",
            "filename": "third_party/xla/xla/python/ifrt/dtype.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -173,14 +173,14 @@ absl::StatusOr<DType> DType::FromProto(const DTypeProto& dtype_proto) {\n   }\n }\n \n-DTypeProto DType::ToProto(SerDesVersion version) const {\n+void DType::ToProto(DTypeProto& dtype_proto, SerDesVersion version) const {\n   // TODO(b/423702568): Change the return type to `absl::StatusOr<...>` for\n   // graceful error handling.\n   CHECK_GE(version.version_number(), SerDesVersionNumber(0))\n       << \"Unsupported \" << version.version_number()\n       << \" for DType serialization\";\n \n-  DTypeProto dtype_proto;\n+  dtype_proto.Clear();\n   dtype_proto.set_version_number(SerDesVersionNumber(0).value());\n \n   switch (kind()) {\n@@ -232,7 +232,6 @@ DTypeProto DType::ToProto(SerDesVersion version) const {\n       dtype_proto.set_kind(DTypeProto::KIND_UNSPECIFIED);\n       break;\n   }\n-  return dtype_proto;\n }\n \n std::string DType::DebugString() const {"
        },
        {
            "sha": "aa74613f8d37fa16db475e2231e7ccbb9d8c1b4e",
            "filename": "third_party/xla/xla/python/ifrt/dtype.h",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fdtype.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -133,9 +133,18 @@ class DType {\n   // Constructs `DType` from `DTypeProto`.\n   static absl::StatusOr<DType> FromProto(const DTypeProto& proto);\n \n+  // Converts the dtype to a protobuf.\n+  void ToProto(\n+      DTypeProto& dtype_proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `DTypeProto` representation.\n   DTypeProto ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    DTypeProto proto;\n+    ToProto(proto, version);\n+    return proto;\n+  }\n \n   // TODO(hyeontaek): Remove this method in favor of AbslStringify.\n   std::string DebugString() const;"
        },
        {
            "sha": "6df2739da2d22194b1e7e6ca4d6be11a9747ba24",
            "filename": "third_party/xla/xla/python/ifrt/executable.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -31,15 +31,15 @@ char Executable::ID = 0;\n char LoadedExecutable::ID = 0;\n [[maybe_unused]] char ExecutableVersion::ID = 0;\n \n-absl::StatusOr<ExecuteOptionsProto> ExecuteOptions::ToProto(\n-    SerDesVersion version) const {\n+absl::Status ExecuteOptions::ToProto(ExecuteOptionsProto& proto,\n+                                     SerDesVersion version) const {\n   if (version.version_number() < SerDesVersionNumber(0)) {\n     return absl::FailedPreconditionError(\n         absl::StrCat(\"Unsupported \", version.version_number(),\n                      \" for ExecuteOptions serialization\"));\n   }\n \n-  ExecuteOptionsProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n   proto.set_launch_id(launch_id);\n@@ -48,10 +48,10 @@ absl::StatusOr<ExecuteOptionsProto> ExecuteOptions::ToProto(\n   proto.set_fill_status(fill_status);\n   proto.set_execution_stream_id(execution_stream_id);\n   if (custom_options.has_value()) {\n-    *proto.mutable_custom_options() = custom_options->ToProto(version);\n+    custom_options->ToProto(*proto.mutable_custom_options(), version);\n   }\n \n-  return proto;\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<ExecuteOptions> ExecuteOptions::FromProto("
        },
        {
            "sha": "c237e0f08a46b4509acec2cffd7975a0c553cd17",
            "filename": "third_party/xla/xla/python/ifrt/executable.h",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fexecutable.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -23,6 +23,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/container/flat_hash_set.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n@@ -40,6 +41,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes_version.h\"\n #include \"xla/python/ifrt/user_context.h\"\n #include \"xla/tsl/concurrency/future.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -145,9 +147,18 @@ struct ExecuteOptions {\n   // are responsible for ensuring version compatibility.\n   std::optional<AttributeMap> custom_options;\n \n-  absl::StatusOr<ExecuteOptionsProto> ToProto(\n+  // Converts the execute options to a protobuf.\n+  absl::Status ToProto(\n+      ExecuteOptionsProto& proto,\n       SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n \n+  absl::StatusOr<ExecuteOptionsProto> ToProto(\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    ExecuteOptionsProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n+\n   static absl::StatusOr<ExecuteOptions> FromProto(\n       const ExecuteOptionsProto& proto);\n };"
        },
        {
            "sha": "5a635d18571e6e7e7b64b971eda6116ccab2fe78",
            "filename": "third_party/xla/xla/python/ifrt/ir/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -174,6 +174,7 @@ cc_library(\n         \"//xla/python/ifrt:serdes_default_version_accessor\",\n         \"//xla/python/ifrt:serdes_version\",\n         \"//xla/python/pjrt_ifrt:xla_ifrt\",\n+        \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log:check\","
        },
        {
            "sha": "2247309437ccb37c28ee144939fd0f7569bddf0e",
            "filename": "third_party/xla/xla/python/ifrt/ir/ifrt_ir_program.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -103,15 +103,15 @@ IfrtIRCompileOptions::FromProto(const IfrtIrCompileOptionsProto& proto) {\n       proto.dot_graph_min_per_device_transfer_size_bytes());\n }\n \n-absl::StatusOr<IfrtIrCompileOptionsProto> IfrtIRCompileOptions::ToProto(\n-    SerDesVersion version) const {\n+absl::Status IfrtIRCompileOptions::ToProto(IfrtIrCompileOptionsProto& proto,\n+                                           SerDesVersion version) const {\n   if (version.version_number() < SerDesVersionNumber(0)) {\n     return absl::FailedPreconditionError(\n         absl::StrCat(\"Unsupported \", version.version_number(),\n                      \" for IfrtIRCompileOptions serialization\"));\n   }\n \n-  IfrtIrCompileOptionsProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n   proto.mutable_device_ids()->Reserve(device_assignments.size());\n   for (const DeviceId& device_id : device_assignments) {\n@@ -143,7 +143,7 @@ absl::StatusOr<IfrtIrCompileOptionsProto> IfrtIRCompileOptions::ToProto(\n   proto.set_dot_graph_min_executable_flops(dot_graph_min_executable_flops);\n   proto.set_dot_graph_min_per_device_transfer_size_bytes(\n       dot_graph_min_per_device_transfer_size_bytes);\n-  return proto;\n+  return absl::OkStatus();\n }\n \n llvm::raw_ostream& operator<<(llvm::raw_ostream& os,"
        },
        {
            "sha": "3d6ae5dbc900d1283e32f0a9beaf7241668d9179",
            "filename": "third_party/xla/xla/python/ifrt/ir/ifrt_ir_program.h",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fifrt_ir_program.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/container/flat_hash_map.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"llvm/ADT/StringRef.h\"\n@@ -41,6 +42,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes.h\"\n #include \"xla/python/ifrt/serdes_default_version_accessor.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -163,9 +165,18 @@ struct IfrtIRCompileOptions\n   static absl::StatusOr<std::unique_ptr<IfrtIRCompileOptions>> FromProto(\n       const IfrtIrCompileOptionsProto& proto);\n \n+  // Converts the compile options to a protobuf.\n+  absl::Status ToProto(\n+      IfrtIrCompileOptionsProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `IfrtIrCompileOptionsProto` representation.\n   absl::StatusOr<IfrtIrCompileOptionsProto> ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    IfrtIrCompileOptionsProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n \n   // Whether to propagate shardings from atom program executables for\n   // unspecified shardings."
        },
        {
            "sha": "36197d41a98f582d189c5fcb936c7aad946a786e",
            "filename": "third_party/xla/xla/python/ifrt/ir/sharding_param.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fsharding_param.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fsharding_param.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fsharding_param.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -322,22 +322,22 @@ absl::StatusOr<ShardingParam> ShardingParam::FromProto(\n   return ShardingParam(std::move(dim_shards), std::move(minor_to_major));\n }\n \n-absl::StatusOr<ShardingParamProto> ShardingParam::ToProto(\n-    SerDesVersion version) const {\n+absl::Status ShardingParam::ToProto(ShardingParamProto& proto,\n+                                    SerDesVersion version) const {\n   if (version.version_number() < SerDesVersionNumber(0)) {\n     return absl::FailedPreconditionError(\n         absl::StrCat(\"Unsupported \", version.version_number(),\n                      \" for ShardingParam serialization\"));\n   }\n \n-  ShardingParamProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n   proto.mutable_dim_shards()->Add(dim_shards().begin(), dim_shards().end());\n   proto.mutable_permutation()->Add(minor_to_major().permutation.begin(),\n                                    minor_to_major().permutation.end());\n   proto.mutable_axis_sizes()->Add(minor_to_major().axis_sizes.begin(),\n                                   minor_to_major().axis_sizes.end());\n-  return proto;\n+  return absl::OkStatus();\n }\n \n }  // namespace ifrt"
        },
        {
            "sha": "be461efb40971a569e52dd233107adb487e8944d",
            "filename": "third_party/xla/xla/python/ifrt/ir/sharding_param.h",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fsharding_param.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fsharding_param.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fsharding_param.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -35,6 +35,7 @@ limitations under the License.\n #include \"xla/python/ifrt/ir/sharding_param.pb.h\"\n #include \"xla/python/ifrt/serdes_default_version_accessor.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -161,9 +162,18 @@ class ShardingParam {\n \n   std::string DebugString() const;\n \n+  // Converts this sharding param to a protobuf.\n+  absl::Status ToProto(\n+      ShardingParamProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `ShardingParamProto` representation.\n   absl::StatusOr<ShardingParamProto> ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    ShardingParamProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n \n   // Constructs `ShardingParam` from `ShardingParamProto`.\n   static absl::StatusOr<ShardingParam> FromProto("
        },
        {
            "sha": "d79ccb904cb309417e4e4715e2a88e013bb97d97",
            "filename": "third_party/xla/xla/python/ifrt/layout.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Flayout.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Flayout.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Flayout.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -53,14 +53,13 @@ absl::StatusOr<CustomLayoutRef> Layout::FromProto(\n                              /*options=*/nullptr);\n }\n \n-absl::StatusOr<LayoutProto> Layout::ToProto(SerDesVersion version) const {\n-  LayoutProto layout_proto;\n+absl::Status Layout::ToProto(LayoutProto& layout_proto,\n+                             SerDesVersion version) const {\n   // `LayoutProto` does not store its own version. It delegates the details to\n   // SerDes of the `Layout` subclasses.\n   auto options = std::make_unique<SerializeOptions>(version);\n-  TF_ASSIGN_OR_RETURN(*layout_proto.mutable_serialized_layout(),\n-                      Serialize(*this, std::move(options)));\n-  return layout_proto;\n+  return Serialize(*this, std::move(options),\n+                   *layout_proto.mutable_serialized_layout());\n }\n \n absl::StatusOr<absl_nonnull std::unique_ptr<CompactLayout>>"
        },
        {
            "sha": "d75eae9e21ef65cfbae4fbc2894f0b8e4ccb4064",
            "filename": "third_party/xla/xla/python/ifrt/layout.h",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Flayout.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Flayout.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Flayout.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n \n #include \"absl/base/nullability.h\"\n #include \"absl/container/inlined_vector.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/Support/ExtensibleRTTI.h\"\n@@ -34,6 +35,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes_version.h\"\n #include \"xla/python/ifrt/shape.h\"\n #include \"xla/python/ifrt/sharding.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -79,9 +81,18 @@ class Layout : public llvm::RTTIExtends<Layout, Serializable> {\n   // Constructs `Layout` from `LayoutProto`.\n   static absl::StatusOr<CustomLayoutRef> FromProto(const LayoutProto& proto);\n \n+  // Converts the layout to a protobuf.\n+  absl::Status ToProto(\n+      LayoutProto& layout_proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `LayoutProto` representation.\n   absl::StatusOr<LayoutProto> ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    LayoutProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n \n   template <typename Sink>\n   friend void AbslStringify(Sink& sink, const Layout& layout) {"
        },
        {
            "sha": "f2a1a29fa7151ea1a5a9bc1b9a9017a5b83c90a6",
            "filename": "third_party/xla/xla/python/ifrt/remap_plan.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 19,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fremap_plan.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fremap_plan.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fremap_plan.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -79,12 +79,10 @@ absl::StatusOr<RemapPlan::Mapping> MappingFromProto(\n }\n \n // Serializes `RemapPlan::Mapping` into `RemapPlanProto::MappingProto`.\n-absl::StatusOr<RemapPlanProto::MappingProto> MappingToProto(\n-    const RemapPlan::Mapping& mapping) {\n+absl::Status MappingToProto(const RemapPlan::Mapping& mapping,\n+                            RemapPlanProto::MappingProto& proto) {\n   TF_RET_CHECK(mapping.from.size() == mapping.to.size());\n \n-  RemapPlanProto::MappingProto proto;\n-\n   proto.set_in_array(mapping.in_array);\n   proto.set_out_array(mapping.out_array);\n \n@@ -103,7 +101,7 @@ absl::StatusOr<RemapPlanProto::MappingProto> MappingToProto(\n     proto.add_to_end(mapping.to[i].end);\n     proto.add_to_step(mapping.to[i].step);\n   }\n-  return proto;\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<RemapPlan::InputDeviceRange> InputDeviceRangeFromProto(\n@@ -115,17 +113,16 @@ absl::StatusOr<RemapPlan::InputDeviceRange> InputDeviceRangeFromProto(\n   return range;\n }\n \n-RemapPlanProto::InputDevicesForOutput InputDeviceToOutputToProto(\n+void InputDeviceToOutputToProto(\n     SerDesVersion version, int out_array,\n-    absl::Span<const RemapPlan::InputDeviceRange> input_devices) {\n-  RemapPlanProto::InputDevicesForOutput proto;\n+    absl::Span<const RemapPlan::InputDeviceRange> input_devices,\n+    RemapPlanProto::InputDevicesForOutput& proto) {\n   proto.set_out_array(out_array);\n   for (const RemapPlan::InputDeviceRange& input : input_devices) {\n     RemapPlanProto::InputDevices* input_proto = proto.add_input_devices();\n     input_proto->set_in_array(input.in_array);\n-    *input_proto->mutable_device_list() = input.input_devices->ToProto(version);\n+    input.input_devices->ToProto(*input_proto->mutable_device_list(), version);\n   }\n-  return proto;\n }\n \n // Checks if `interval` is in a valid range for the given number of shards.\n@@ -501,39 +498,39 @@ absl::StatusOr<RemapPlan> RemapPlan::FromProto(Client* client,\n   return plan;\n }\n \n-absl::StatusOr<RemapPlanProto> RemapPlan::ToProto(SerDesVersion version) const {\n+absl::Status RemapPlan::ToProto(RemapPlanProto& proto,\n+                                SerDesVersion version) const {\n   if (version.version_number() < SerDesVersionNumber(0)) {\n     return absl::FailedPreconditionError(\n         absl::StrCat(\"Unsupported \", version.version_number(),\n                      \" for RemapPlan serialization\"));\n   }\n \n-  RemapPlanProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n   proto.mutable_input_specs()->Reserve(input_specs.size());\n   for (const auto& input_spec : input_specs) {\n-    TF_ASSIGN_OR_RETURN(*proto.add_input_specs(), input_spec.ToProto(version));\n+    TF_RETURN_IF_ERROR(input_spec.ToProto(*proto.add_input_specs(), version));\n   }\n   proto.mutable_output_specs()->Reserve(output_specs.size());\n   for (const auto& output_spec : output_specs) {\n-    TF_ASSIGN_OR_RETURN(*proto.add_output_specs(),\n-                        output_spec.ToProto(version));\n+    TF_RETURN_IF_ERROR(output_spec.ToProto(*proto.add_output_specs(), version));\n   }\n \n   proto.mutable_mappings()->Reserve(mappings->size());\n   for (const auto& mapping : *mappings) {\n-    TF_ASSIGN_OR_RETURN(*proto.add_mappings(), MappingToProto(mapping));\n+    TF_RETURN_IF_ERROR(MappingToProto(mapping, *proto.add_mappings()));\n   }\n \n   proto.mutable_input_devices_for_output()->Reserve(\n       input_devices_for_output_map.size());\n   for (const auto& [out_array, input_devices] : input_devices_for_output_map) {\n-    *proto.add_input_devices_for_output() =\n-        InputDeviceToOutputToProto(version, out_array, input_devices);\n+    InputDeviceToOutputToProto(version, out_array, input_devices,\n+                               *proto.add_input_devices_for_output());\n   }\n \n-  return proto;\n+  return absl::OkStatus();\n }\n \n std::string RemapPlan::DebugString() const {"
        },
        {
            "sha": "0de16bde819f3332e391c01f57987035a71765ab",
            "filename": "third_party/xla/xla/python/ifrt/remap_plan.h",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fremap_plan.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fremap_plan.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fremap_plan.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include \"xla/python/ifrt/remap_plan.pb.h\"\n #include \"xla/python/ifrt/serdes_default_version_accessor.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -130,9 +131,18 @@ struct RemapPlan {\n   static absl::StatusOr<RemapPlan> FromProto(Client* client,\n                                              const RemapPlanProto& proto);\n \n+  // Converts this plan to a protobuf.\n+  absl::Status ToProto(\n+      RemapPlanProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `RemapPlanProto` representation.\n   absl::StatusOr<RemapPlanProto> ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    RemapPlanProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n \n   std::string DebugString() const;\n "
        },
        {
            "sha": "6a81ad59ad47dd5bf5808c56772565cb1e847818",
            "filename": "third_party/xla/xla/python/ifrt/serdes.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fserdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fserdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fserdes.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes.pb.h\"\n #include \"xla/python/ifrt/serdes_default_version_accessor.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n@@ -90,9 +91,9 @@ void RegisterSerDes(const void* type_id, std::unique_ptr<SerDes> serdes) {\n   serdes.release();\n }\n \n-absl::StatusOr<Serialized> Serialize(\n-    const Serializable& serializable,\n-    std::unique_ptr<SerializeOptions> options) {\n+absl::Status Serialize(const Serializable& serializable,\n+                       std::unique_ptr<SerializeOptions> options,\n+                       Serialized& proto) {\n   SerDes* serdes;\n   {\n     Registry* const r = registry();\n@@ -108,10 +109,18 @@ absl::StatusOr<Serialized> Serialize(\n   TF_ASSIGN_OR_RETURN(std::string data,\n                       serdes->Serialize(serializable, std::move(options)));\n \n-  Serialized proto;\n+  proto.Clear();\n   proto.set_type_name(std::string(serdes->type_name()));\n   proto.set_data(std::move(data));\n-  return proto;\n+  return absl::OkStatus();\n+}\n+\n+absl::StatusOr<Serialized> Serialize(\n+    const Serializable& serializable,\n+    std::unique_ptr<SerializeOptions> options) {\n+  Serialized serialized;\n+  TF_RETURN_IF_ERROR(Serialize(serializable, std::move(options), serialized));\n+  return serialized;\n }\n \n namespace serdes_internal {"
        },
        {
            "sha": "54b26cd55745655bb6e9f462b942d715fda8dc2f",
            "filename": "third_party/xla/xla/python/ifrt/serdes.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fserdes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fserdes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fserdes.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -120,6 +120,10 @@ absl::StatusOr<std::unique_ptr<Serializable>> DeserializeUnchecked(\n //\n // Returns an error if the `Serializable` type does not have a corresponding\n // `SerDes` registered or the `SerDes` returns an error.\n+absl::Status Serialize(const Serializable& serializable,\n+                       std::unique_ptr<SerializeOptions> options,\n+                       Serialized& proto);\n+\n absl::StatusOr<Serialized> Serialize(const Serializable& serializable,\n                                      std::unique_ptr<SerializeOptions> options);\n "
        },
        {
            "sha": "36d89529deca6f731924abca23e6d2adeb4b585d",
            "filename": "third_party/xla/xla/python/ifrt/shape.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fshape.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fshape.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fshape.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -70,21 +70,20 @@ absl::StatusOr<Shape> Shape::FromProto(const ShapeProto& proto) {\n   return Shape(std::move(dims));\n }\n \n-ShapeProto Shape::ToProto(SerDesVersion version) const {\n+void Shape::ToProto(ShapeProto& proto, SerDesVersion version) const {\n   // TODO(b/423702568): Change the return type to `absl::StatusOr<...>` for\n   // graceful error handling.\n   CHECK_GE(version.version_number(), SerDesVersionNumber(0))\n       << \"Unsupported \" << version.version_number()\n       << \" for Shape serialization\";\n \n-  ShapeProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n   proto.mutable_dims()->Reserve(dims().size());\n   for (int64_t dim : dims()) {\n     proto.mutable_dims()->AddAlreadyReserved(dim);\n   }\n-  return proto;\n }\n \n int64_t Shape::num_elements() const {\n@@ -116,22 +115,21 @@ absl::StatusOr<BoundedDynamicShapeTag> BoundedDynamicShapeTag::FromProto(\n   return BoundedDynamicShapeTag(std::move(dynamic_dims));\n }\n \n-BoundedDynamicShapeTagProto BoundedDynamicShapeTag::ToProto(\n-    SerDesVersion version) const {\n+void BoundedDynamicShapeTag::ToProto(BoundedDynamicShapeTagProto& proto,\n+                                     SerDesVersion version) const {\n   // TODO(b/423702568): Change the return type to `absl::StatusOr<...>` for\n   // graceful error handling.\n   CHECK_GE(version.version_number(), SerDesVersionNumber(0))\n       << \"Unsupported \" << version.version_number()\n       << \" for BoundedDynamicShapeTag serialization\";\n \n-  BoundedDynamicShapeTagProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n   proto.mutable_is_dynamic_dims()->Reserve(dynamic_dims_.size());\n   for (bool dynamic_dim : dynamic_dims_) {\n     proto.mutable_is_dynamic_dims()->AddAlreadyReserved(dynamic_dim);\n   }\n-  return proto;\n }\n \n absl::StatusOr<DynamicShape> DynamicShape::Create(Shape shape,\n@@ -186,25 +184,25 @@ absl::StatusOr<DynamicShape> DynamicShape::FromProto(\n   return InvalidArgument(\"Only support bounded dynamic shape.\");\n }\n \n-DynamicShapeProto DynamicShape::ToProto(SerDesVersion version) const {\n+void DynamicShape::ToProto(DynamicShapeProto& proto,\n+                           SerDesVersion version) const {\n   // TODO(b/423702568): Change the return type to `absl::StatusOr<...>` for\n   // graceful error handling.\n   CHECK_GE(version.version_number(), SerDesVersionNumber(0))\n       << \"Unsupported \" << version.version_number()\n       << \" for DynamicShape serialization\";\n \n-  DynamicShapeProto proto;\n+  proto.Clear();\n   proto.set_version_number(SerDesVersionNumber(0).value());\n \n-  *proto.mutable_shape() = shape_.ToProto(version);\n+  shape_.ToProto(*proto.mutable_shape(), version);\n   std::visit(\n       overloaded{\n           [&proto, version](BoundedDynamicShapeTag tag) {\n-            *proto.mutable_bounded_dynamic_shape_tag() = tag.ToProto(version);\n+            tag.ToProto(*proto.mutable_bounded_dynamic_shape_tag(), version);\n           },\n       },\n       tag_);\n-  return proto;\n }\n \n std::string DynamicShape::DebugString() const {"
        },
        {
            "sha": "564ccc873484c0216998eafea21be24cc67e59f7",
            "filename": "third_party/xla/xla/python/ifrt/shape.h",
            "status": "modified",
            "additions": 32,
            "deletions": 3,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fshape.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fshape.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fshape.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -55,9 +55,18 @@ class Shape {\n   // Constructs `Shape` from `ShapeProto`.\n   static absl::StatusOr<Shape> FromProto(const ShapeProto& proto);\n \n+  // Converts the shape to a protobuf.\n+  void ToProto(\n+      ShapeProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `ShapeProto` representation.\n   ShapeProto ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    ShapeProto proto;\n+    ToProto(proto, version);\n+    return proto;\n+  }\n \n   absl::Span<const int64_t> dims() const { return dims_; }\n \n@@ -129,9 +138,19 @@ class BoundedDynamicShapeTag {\n   static absl::StatusOr<BoundedDynamicShapeTag> FromProto(\n       const BoundedDynamicShapeTagProto& proto);\n \n+  // Serializes the tag to `proto`. The caller must make sure that `proto` is\n+  // empty.\n+  void ToProto(\n+      BoundedDynamicShapeTagProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `BoundedDynamicShapeTagProto` representation.\n   BoundedDynamicShapeTagProto ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    BoundedDynamicShapeTagProto proto;\n+    ToProto(proto, version);\n+    return proto;\n+  }\n \n  private:\n   // This vector is the same size as `Shape`'s 'dims()' and indicates whether\n@@ -181,9 +200,19 @@ class DynamicShape {\n   // Constructs `DynamicShape` from `DynamicShapeProto`.\n   static absl::StatusOr<DynamicShape> FromProto(const DynamicShapeProto& proto);\n \n+  // Serializes the shape to `proto`. The caller must make sure that `proto` is\n+  // empty.\n+  void ToProto(\n+      DynamicShapeProto& proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Returns a `DynamicShapeProto` representation.\n   DynamicShapeProto ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    DynamicShapeProto proto;\n+    ToProto(proto, version);\n+    return proto;\n+  }\n \n   std::string DebugString() const;\n "
        },
        {
            "sha": "028c064194ad2825cead7a0fb59763dae1867e52",
            "filename": "third_party/xla/xla/python/ifrt/sharding.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -28,6 +28,7 @@ limitations under the License.\n #include \"absl/algorithm/container.h\"\n #include \"absl/hash/hash.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/str_join.h\"\n@@ -190,14 +191,13 @@ absl::StatusOr<ShardingRef> Sharding::FromProto(\n       std::make_unique<DeserializeShardingOptions>(client));\n }\n \n-absl::StatusOr<ShardingProto> Sharding::ToProto(SerDesVersion version) const {\n-  ShardingProto sharding_proto;\n+absl::Status Sharding::ToProto(ShardingProto& sharding_proto,\n+                               SerDesVersion version) const {\n   // `ShardingProto` does not store its own version. It delegates the details to\n   // SerDes of the `Sharding` subclasses.\n   auto options = std::make_unique<SerializeOptions>(version);\n-  TF_ASSIGN_OR_RETURN(*sharding_proto.mutable_serialized_sharding(),\n-                      Serialize(*this, std::move(options)));\n-  return sharding_proto;\n+  return Serialize(*this, std::move(options),\n+                   *sharding_proto.mutable_serialized_sharding());\n }\n \n std::ostream& operator<<(std::ostream& os, const Sharding& sharding) {"
        },
        {
            "sha": "442af82900597722afb23556a531237275ca21fb",
            "filename": "third_party/xla/xla/python/ifrt/sharding.h",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -38,6 +38,7 @@ limitations under the License.\n #include \"xla/python/ifrt/serdes_version.h\"\n #include \"xla/python/ifrt/shape.h\"\n #include \"xla/python/ifrt/sharding.pb.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -169,11 +170,20 @@ class Sharding : public llvm::RTTIExtends<Sharding, Serializable> {\n   static absl::StatusOr<ShardingRef> FromProto(\n       Client* client, const ShardingProto& sharding_proto);\n \n+  // Converts `Sharding` into a protobuf.\n+  absl::Status ToProto(\n+      ShardingProto& sharding_proto,\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+\n   // Serializes `Sharding` into `ShardingProto`.\n   // Note that `Sharding` serialization uses `SerDes` to handle an open set of\n   // `Sharding` subclasses. See `serdes.h`.\n   absl::StatusOr<ShardingProto> ToProto(\n-      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const;\n+      SerDesVersion version = SerDesDefaultVersionAccessor::Get()) const {\n+    ShardingProto proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n \n   // TODO(hyeontaek): Remove this method in favor of AbslStringify.\n   virtual std::string DebugString() const = 0;"
        },
        {
            "sha": "5d450da9747dd1432e12d1067ca7085c70fa21cb",
            "filename": "third_party/xla/xla/python/ifrt/sharding_serdes.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding_serdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding_serdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fsharding_serdes.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"xla/python/ifrt/shape.h\"\n #include \"xla/python/ifrt/sharding.h\"\n #include \"xla/python/ifrt/sharding_serdes.pb.h\"\n+#include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n@@ -122,7 +123,7 @@ class OpaqueShardingSerDes\n     const OpaqueSharding& sharding = llvm::cast<OpaqueSharding>(serializable);\n     OpaqueShardingProto proto;\n     proto.set_version_number(SerDesVersionNumber(0).value());\n-    *proto.mutable_devices() = sharding.devices()->ToProto(version);\n+    sharding.devices()->ToProto(*proto.mutable_devices(), version);\n     if (sharding.memory_kind().memory_kind().has_value()) {\n       proto.set_memory_kind(std::string(*sharding.memory_kind().memory_kind()));\n     }\n@@ -180,21 +181,20 @@ class ConcreteShardingSerDes\n         llvm::cast<ConcreteSharding>(serializable);\n     ConcreteShardingProto proto;\n     proto.set_version_number(SerDesVersionNumber(0).value());\n-    *proto.mutable_devices() = sharding.devices()->ToProto(version);\n+    sharding.devices()->ToProto(*proto.mutable_devices(), version);\n     if (sharding.memory_kind().memory_kind().has_value()) {\n       proto.set_memory_kind(std::string(*sharding.memory_kind().memory_kind()));\n     }\n     if (sharding.has_static_shape()) {\n-      *proto.mutable_shape() = sharding.shape().ToProto(version);\n+      sharding.shape().ToProto(*proto.mutable_shape(), version);\n       for (const Shape& shape : sharding.shard_shapes()) {\n         *proto.add_shard_shapes() = shape.ToProto(version);\n       }\n     } else {\n-      *proto.mutable_dynamic_shape() =\n-          sharding.dynamic_shape().ToProto(version);\n+      sharding.dynamic_shape().ToProto(*proto.mutable_dynamic_shape(), version);\n       for (const DynamicShape& dynamic_shape :\n            sharding.shard_dynamic_shapes()) {\n-        *proto.add_shard_dynamic_shapes() = dynamic_shape.ToProto(version);\n+        dynamic_shape.ToProto(*proto.add_shard_dynamic_shapes(), version);\n       }\n     }\n     return proto.SerializeAsString();\n@@ -279,12 +279,12 @@ class ConcreteEvenShardingSerDes\n         llvm::cast<ConcreteEvenSharding>(serializable);\n     ConcreteEvenShardingProto proto;\n     proto.set_version_number(SerDesVersionNumber(0).value());\n-    *proto.mutable_devices() = sharding.devices()->ToProto(version);\n+    sharding.devices()->ToProto(*proto.mutable_devices(), version);\n     if (sharding.memory_kind().memory_kind().has_value()) {\n       proto.set_memory_kind(std::string(*sharding.memory_kind().memory_kind()));\n     }\n-    *proto.mutable_shape() = sharding.shape().ToProto(version);\n-    *proto.mutable_shard_shape() = sharding.shard_shape().ToProto(version);\n+    sharding.shape().ToProto(*proto.mutable_shape(), version);\n+    sharding.shard_shape().ToProto(*proto.mutable_shard_shape(), version);\n     proto.set_is_fully_replicated(sharding.IsFullyReplicated());\n     return proto.SerializeAsString();\n   }\n@@ -344,12 +344,12 @@ class ShardingParamShardingSerDes\n         llvm::cast<ShardingParamSharding>(serializable);\n     ShardingParamShardingProto proto;\n     proto.set_version_number(SerDesVersionNumber(0).value());\n-    *proto.mutable_devices() = sharding.devices()->ToProto(version);\n+    sharding.devices()->ToProto(*proto.mutable_devices(), version);\n     if (sharding.memory_kind().memory_kind().has_value()) {\n       proto.set_memory_kind(std::string(*sharding.memory_kind().memory_kind()));\n     }\n-    TF_ASSIGN_OR_RETURN(*proto.mutable_sharding_param(),\n-                        sharding.sharding_param().ToProto(version));\n+    TF_RETURN_IF_ERROR(sharding.sharding_param().ToProto(\n+        *proto.mutable_sharding_param(), version));\n     return proto.SerializeAsString();\n   }\n "
        },
        {
            "sha": "dcec390b28cc56b9f12962d6937423a04ac09c33",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -630,6 +630,7 @@ ifrt_proxy_cc_test(\n         \"//xla/python/ifrt_proxy/common:types\",\n         \"//xla/tsl/concurrency:future\",\n         \"//xla/tsl/concurrency:ref_count\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "d30ee6f9e0d03d38b66cf2f94ab16486cbf2f5df",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/array.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 19,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Farray.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Farray.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Farray.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -224,10 +224,10 @@ absl::StatusOr<xla::ifrt::ArrayRef> Array::MakeArrayFromHostBuffer(\n   // Reuse the host_buffer_handle as also the client-generated\n   // array_handle.\n   req->set_array_handle(host_buffer_handle);\n-  *req->mutable_dtype() = dtype.ToProto(rpc_helper->ifrt_serdes_version());\n-  *req->mutable_shape() = shape.ToProto(rpc_helper->ifrt_serdes_version());\n-  TF_ASSIGN_OR_RETURN(*req->mutable_sharding(),\n-                      sharding->ToProto(rpc_helper->ifrt_serdes_version()));\n+  dtype.ToProto(*req->mutable_dtype(), rpc_helper->ifrt_serdes_version());\n+  shape.ToProto(*req->mutable_shape(), rpc_helper->ifrt_serdes_version());\n+  TF_RETURN_IF_ERROR(sharding->ToProto(*req->mutable_sharding(),\n+                                       rpc_helper->ifrt_serdes_version()));\n   if (byte_strides.has_value()) {\n     *req->mutable_byte_strides() = ToByteStridesProto(*byte_strides);\n   }\n@@ -320,20 +320,19 @@ Array::MakeArraysFromHostBufferShards(\n \n       MakeArraysFromHostBufferShardsRequest::HostBuffer* host_buffer_proto =\n           spec_proto->add_host_buffers();\n-      *host_buffer_proto->mutable_dtype() =\n-          host_buffer.dtype.ToProto(rpc_helper->ifrt_serdes_version());\n-      *host_buffer_proto->mutable_shape() =\n-          host_buffer.shape.ToProto(rpc_helper->ifrt_serdes_version());\n+      host_buffer.dtype.ToProto(*host_buffer_proto->mutable_dtype(),\n+                                rpc_helper->ifrt_serdes_version());\n+      host_buffer.shape.ToProto(*host_buffer_proto->mutable_shape(),\n+                                rpc_helper->ifrt_serdes_version());\n       host_buffer_proto->set_host_buffer_handle(\n           host_buffer_handles_for_specs[spec_idx][buffer_idx]);\n       if (host_buffer.byte_strides.has_value()) {\n         *host_buffer_proto->mutable_byte_strides() =\n             ToByteStridesProto(*host_buffer.byte_strides);\n       }\n     }\n-    TF_ASSIGN_OR_RETURN(\n-        *spec_proto->mutable_array_spec(),\n-        spec.array_spec.ToProto(rpc_helper->ifrt_serdes_version()));\n+    TF_RETURN_IF_ERROR(spec.array_spec.ToProto(\n+        *spec_proto->mutable_array_spec(), rpc_helper->ifrt_serdes_version()));\n \n     if (!GetGlobalClientFlags()->synchronous_host_buffer_store) {\n       uint64_t arr_handle;\n@@ -389,8 +388,8 @@ absl::StatusOr<std::vector<xla::ifrt::ArrayRef>> Array::MakeErrorArrays(\n   for (const ArraySpec& array_spec : array_specs) {\n     const uint64_t array_handle = rpc_helper->NextHandle();\n     req->add_array_handles(array_handle);\n-    TF_ASSIGN_OR_RETURN(*req->add_array_specs(),\n-                        array_spec.ToProto(rpc_helper->ifrt_serdes_version()));\n+    TF_RETURN_IF_ERROR(array_spec.ToProto(*req->add_array_specs(),\n+                                          rpc_helper->ifrt_serdes_version()));\n     arr_handles.push_back(ArrayHandle{array_handle});\n   }\n \n@@ -550,13 +549,13 @@ absl::StatusOr<xla::ifrt::ArrayRef> Array::AssembleArrayFromSingleDeviceArrays(\n         \"AssembleArrayFromSingleDeviceArrays() called with empty arrays list\");\n   }\n   auto req = std::make_unique<AssembleArrayFromSingleDeviceArraysRequest>();\n-  *req->mutable_shape() = shape.ToProto(rpc_helper->ifrt_serdes_version());\n-  TF_ASSIGN_OR_RETURN(*req->mutable_sharding(),\n-                      sharding->ToProto(rpc_helper->ifrt_serdes_version()));\n+  shape.ToProto(*req->mutable_shape(), rpc_helper->ifrt_serdes_version());\n+  TF_RETURN_IF_ERROR(sharding->ToProto(*req->mutable_sharding(),\n+                                       rpc_helper->ifrt_serdes_version()));\n   req->set_copy_semantics(ToArrayCopySemanticsProto(array_copy_semantics));\n   req->set_single_device_shard_semantics(\n       ToSingleDeviceShardSemanticsProto(single_device_shard_semantics));\n-  *req->mutable_dtype() = dtype.ToProto(rpc_helper->ifrt_serdes_version());\n+  dtype.ToProto(*req->mutable_dtype(), rpc_helper->ifrt_serdes_version());\n   for (const xla::ifrt::ArrayRef& rcref : arrays) {\n     Array* array = llvm::dyn_cast<Array>(rcref.get());\n     if (array == nullptr) {\n@@ -616,8 +615,8 @@ absl::StatusOr<std::vector<xla::ifrt::ArrayRef>> Array::RemapArrays(\n \n   auto req = std::make_unique<RemapArraysRequest>();\n   TF_RET_CHECK(!arrays.empty());\n-  TF_ASSIGN_OR_RETURN(*req->mutable_plan(),\n-                      plan.ToProto(rpc_helper->ifrt_serdes_version()));\n+  TF_RETURN_IF_ERROR(\n+      plan.ToProto(*req->mutable_plan(), rpc_helper->ifrt_serdes_version()));\n   req->set_copy_semantics(ToArrayCopySemanticsProto(semantics));\n   for (int i = 0; i < num_inputs; ++i) {\n     const xla::ifrt::ArrayRef& rcref = arrays[i];"
        },
        {
            "sha": "80fe6eba22f1f146e667703826376ee306fc9c8c",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/client.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -462,7 +462,7 @@ Client::GetDefaultPjRtLayout(xla::ifrt::DType dtype,\n     }\n   }\n \n-  *req->mutable_dtype() = dtype.ToProto(rpc_helper_->ifrt_serdes_version());\n+  dtype.ToProto(*req->mutable_dtype(), rpc_helper_->ifrt_serdes_version());\n   req->mutable_dims()->Reserve(dims.size());\n   for (int64_t dim : dims) {\n     req->add_dims(dim);"
        },
        {
            "sha": "69fe478c93770fb7359d00b55614662183bd1710",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/client_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fclient_test.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -245,9 +245,9 @@ class ClientTest : public ::testing::TestWithParam</*protocol_version=*/int> {\n \n     AttributeMap::Map client_attributes(\n         {{\"test_key\", AttributeMap::StringValue(\"test_value\")}});\n-    *response.mutable_client_attributes() =\n-        AttributeMap(client_attributes)\n-            .ToProto(rpc_helper_->ifrt_serdes_version());\n+    AttributeMap(client_attributes)\n+        .ToProto(*response.mutable_client_attributes(),\n+                 rpc_helper_->ifrt_serdes_version());\n \n     TF_ASSERT_OK_AND_ASSIGN(client_, Client::Create(rpc_helper_, response));\n     TF_ASSERT_OK_AND_ASSIGN(device_, client_->LookupDevice(DeviceId(0)));"
        },
        {
            "sha": "a1173d09c8ee7d473d9608b3776e005a0a4750c2",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/executable.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -727,8 +727,8 @@ LoadedExecutable::Execute(absl::Span<xla::ifrt::ArrayRef> args,\n       req->add_args_handles(handle.handle);\n     }\n   }\n-  TF_ASSIGN_OR_RETURN(*req->mutable_execute_options(),\n-                      options.ToProto(rpc_helper_->ifrt_serdes_version()));\n+  TF_RETURN_IF_ERROR(options.ToProto(*req->mutable_execute_options(),\n+                                     rpc_helper_->ifrt_serdes_version()));\n   if (devices.has_value()) {\n     for (const auto* device : (*devices)->devices()) {\n       req->add_device_ids(device->Id().value());"
        },
        {
            "sha": "54d11c3cdf4539cfc7a5df511bff7c1f7ef000c7",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/executable_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fexecutable_test.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -51,6 +51,7 @@\n #include \"xla/python/ifrt_proxy/common/types.h\"\n #include \"xla/tsl/concurrency/future.h\"\n #include \"xla/tsl/concurrency/ref_count.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"xla/xla_data.pb.h\"\n@@ -253,12 +254,12 @@ TEST_F(LoadedExecutableTest, Execute) {\n     auto* outputs =\n         execute_response.mutable_loaded_executable_execute_response()\n             ->mutable_outputs();\n-    TF_ASSERT_OK_AND_ASSIGN(*(*outputs)[0].mutable_sharding(),\n-                            SingleDeviceSharding::Create(&device, MemoryKind())\n-                                ->ToProto(rpc_helper_->ifrt_serdes_version()));\n-    TF_ASSERT_OK_AND_ASSIGN(*(*outputs)[1].mutable_sharding(),\n-                            SingleDeviceSharding::Create(&device, MemoryKind())\n-                                ->ToProto(rpc_helper_->ifrt_serdes_version()));\n+    TF_ASSERT_OK(SingleDeviceSharding::Create(&device, MemoryKind())\n+                     ->ToProto(*(*outputs)[0].mutable_sharding(),\n+                               rpc_helper_->ifrt_serdes_version()));\n+    TF_ASSERT_OK(SingleDeviceSharding::Create(&device, MemoryKind())\n+                     ->ToProto(*(*outputs)[1].mutable_sharding(),\n+                               rpc_helper_->ifrt_serdes_version()));\n   }\n   EXPECT_CALL(*session_, Enqueue(Pointee(Partially(EquivToProto(\n                              R\"pb(loaded_executable_execute_request {"
        },
        {
            "sha": "4722648d0ce8ecd4af4c352deb383ba08b7515e1",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/grpc_client.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_client.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -124,7 +124,8 @@ absl::StatusOr<std::unique_ptr<Client>> AttemptConnection(\n              SerDesVersion::current().version_number().value());\n     *metadata.mutable_version() = response.version();\n   }\n-  *metadata.mutable_initialization_data() = options.initialization_data.ToProto(\n+  options.initialization_data.ToProto(\n+      *metadata.mutable_initialization_data(),\n       SerDesAnyVersionAccessor::Get(SerDesVersionNumber(\n           metadata.version().ifrt_serdes_version_number())));\n "
        },
        {
            "sha": "a4e81bd42832377d0de5d19512d084b0968035cd",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 11,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -760,8 +760,8 @@ absl::StatusOr<BackendInterface::Response> IfrtBackend::HandleInit(\n                 attr));\n       }\n     } else {\n-      *d->mutable_attributes() =\n-          device->Attributes().ToProto(ifrt_serdes_version());\n+      device->Attributes().ToProto(*d->mutable_attributes(),\n+                                   ifrt_serdes_version());\n     }\n \n     if (device->IsAddressable()) {\n@@ -794,8 +794,8 @@ absl::StatusOr<BackendInterface::Response> IfrtBackend::HandleInit(\n     m->set_debug_string(AsProtoStringData(memory->DebugString()));\n     m->set_to_string(AsProtoStringData(memory->ToString()));\n   }\n-  *init_resp->mutable_client_attributes() =\n-      client_->Attributes().ToProto(ifrt_serdes_version());\n+  client_->Attributes().ToProto(*init_resp->mutable_client_attributes(),\n+                                ifrt_serdes_version());\n \n   return response;\n }\n@@ -1769,9 +1769,8 @@ IfrtBackend::HandleLoadedExecutableExecuteRequest(\n   if (execute.result_array_handle().empty()) {\n     output_sharding_protos.reserve(result.outputs.size());\n     for (int i = 0; i < result.outputs.size(); ++i) {\n-      TF_ASSIGN_OR_RETURN(\n-          output_sharding_protos.emplace_back(),\n-          result.outputs[i]->sharding().ToProto(ifrt_serdes_version()));\n+      TF_RETURN_IF_ERROR(result.outputs[i]->sharding().ToProto(\n+          output_sharding_protos.emplace_back(), ifrt_serdes_version()));\n     }\n   }\n \n@@ -1803,10 +1802,10 @@ IfrtBackend::HandleLoadedExecutableExecuteRequest(\n       for (int i = 0; i < result.outputs.size(); ++i) {\n         LoadedExecutableExecuteResponse::Output* output =\n             execute_response->add_outputs();\n-        *output->mutable_dtype() =\n-            result.outputs[i]->dtype().ToProto(ifrt_serdes_version());\n-        *output->mutable_shape() =\n-            result.outputs[i]->shape().ToProto(ifrt_serdes_version());\n+        result.outputs[i]->dtype().ToProto(*output->mutable_dtype(),\n+                                           ifrt_serdes_version());\n+        result.outputs[i]->shape().ToProto(*output->mutable_shape(),\n+                                           ifrt_serdes_version());\n         *output->mutable_sharding() = std::move(output_sharding_protos[i]);\n         output->set_array_handle(result_handles[i]);\n       }"
        },
        {
            "sha": "66827ee8d27ef4a4ab42fa0a245e6a0264103cdd",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 24,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -345,9 +345,9 @@ class IfrtBackendHandlerTest : public IfrtBackendTest {\n \n       TF_ASSIGN_OR_RETURN(auto* device,\n                           mock_client_->LookupDevice(DeviceId(1)));\n-      TF_ASSIGN_OR_RETURN(*make_array->mutable_sharding(),\n-                          SingleDeviceSharding::Create(device, MemoryKind())\n-                              ->ToProto(ifrt_serdes_version()));\n+      TF_RETURN_IF_ERROR(SingleDeviceSharding::Create(device, MemoryKind())\n+                             ->ToProto(*make_array->mutable_sharding(),\n+                                       ifrt_serdes_version()));\n     }\n     TF_ASSIGN_OR_RETURN(auto make_array_response,\n                         CallBackend(std::move(ifrt_request)));\n@@ -599,9 +599,9 @@ TEST_P(IfrtBackendHandlerTest, MakeArrayFromHostBufferSuccess) {\n     make_array->set_host_buffer_handle(kHostBufferHandle);\n     TF_ASSERT_OK_AND_ASSIGN(auto* device,\n                             mock_client_->LookupDevice(DeviceId(1)));\n-    TF_ASSERT_OK_AND_ASSIGN(*make_array->mutable_sharding(),\n-                            SingleDeviceSharding::Create(device, MemoryKind())\n-                                ->ToProto(ifrt_serdes_version()));\n+    TF_ASSERT_OK(\n+        SingleDeviceSharding::Create(device, MemoryKind())\n+            ->ToProto(*make_array->mutable_sharding(), ifrt_serdes_version()));\n   }\n \n   const Shape expected_shape({5, 3, 4});\n@@ -644,9 +644,9 @@ TEST_P(IfrtBackendHandlerTest, MakeStringArrayFromHostBufferSuccess) {\n   make_array->set_host_buffer_handle(kHostBufferHandle);\n   TF_ASSERT_OK_AND_ASSIGN(auto* device,\n                           mock_client_->LookupDevice(DeviceId(1)));\n-  TF_ASSERT_OK_AND_ASSIGN(*make_array->mutable_sharding(),\n-                          SingleDeviceSharding::Create(device, MemoryKind())\n-                              ->ToProto(ifrt_serdes_version()));\n+  TF_ASSERT_OK(\n+      SingleDeviceSharding::Create(device, MemoryKind())\n+          ->ToProto(*make_array->mutable_sharding(), ifrt_serdes_version()));\n \n   const DType expected_dtype = DType(DType::kString);\n   const Shape expected_shape({2});\n@@ -686,13 +686,13 @@ TEST_P(IfrtBackendHandlerTest, AssembleArrayFromSingleDeviceArrays) {\n     }\n     if (Version().protocol_version() >=\n         protocol_version::kAssembleArrayFromSingleDeviceArraysWithDType) {\n-      *req->mutable_dtype() = dtype.ToProto(ifrt_serdes_version());\n+      dtype.ToProto(*req->mutable_dtype(), ifrt_serdes_version());\n     }\n     TF_ASSERT_OK_AND_ASSIGN(auto* device,\n                             mock_client_->LookupDevice(DeviceId(1)));\n-    TF_ASSERT_OK_AND_ASSIGN(*req->mutable_sharding(),\n-                            SingleDeviceSharding::Create(device, MemoryKind())\n-                                ->ToProto(ifrt_serdes_version()));\n+    TF_ASSERT_OK(\n+        SingleDeviceSharding::Create(device, MemoryKind())\n+            ->ToProto(*req->mutable_sharding(), ifrt_serdes_version()));\n   }\n \n   std::vector<tsl::RCReference<xla::ifrt::MockArray>> single_device_arrays;\n@@ -715,8 +715,8 @@ TEST_P(IfrtBackendHandlerTest, AssembleArrayFromSingleDeviceArrays) {\n     }\n     if (Version().protocol_version() >=\n         protocol_version::kAssembleArrayFromSingleDeviceArraysWithDType) {\n-      *assemble_array_from_single_device_arrays->mutable_dtype() =\n-          dtype.ToProto(ifrt_serdes_version());\n+      dtype.ToProto(*assemble_array_from_single_device_arrays->mutable_dtype(),\n+                    ifrt_serdes_version());\n     }\n   }\n \n@@ -791,9 +791,9 @@ TEST_P(IfrtBackendHandlerTest, CopyToHostSuccessWithStringArray) {\n   make_array->set_host_buffer_handle(kHostBufferHandle);\n   TF_ASSERT_OK_AND_ASSIGN(auto* device,\n                           mock_client_->LookupDevice(DeviceId(1)));\n-  TF_ASSERT_OK_AND_ASSIGN(*make_array->mutable_sharding(),\n-                          SingleDeviceSharding::Create(device, MemoryKind())\n-                              ->ToProto(ifrt_serdes_version()));\n+  TF_ASSERT_OK(\n+      SingleDeviceSharding::Create(device, MemoryKind())\n+          ->ToProto(*make_array->mutable_sharding(), ifrt_serdes_version()));\n \n   const DType expected_dtype = DType(DType::kString);\n   const Shape expected_shape({2});\n@@ -1347,8 +1347,8 @@ TEST_P(IfrtBackendHandlerTest, LoadedExecutableExecute) {\n   execute_request->set_loaded_executable_handle(handle);\n   xla::ifrt::LoadedExecutable::ExecuteOptions execute_options;\n   execute_options.fill_status = true;\n-  TF_ASSERT_OK_AND_ASSIGN(*execute_request->mutable_execute_options(),\n-                          execute_options.ToProto(ifrt_serdes_version()));\n+  TF_ASSERT_OK(execute_options.ToProto(\n+      *execute_request->mutable_execute_options(), ifrt_serdes_version()));\n \n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<IfrtResponse> response,\n                           CallBackend(std::move(request)));\n@@ -1440,8 +1440,8 @@ TEST_P(IfrtBackendHandlerTest, LoadedExecutableExecuteErrorWithClientHandles) {\n \n   xla::ifrt::LoadedExecutable::ExecuteOptions execute_options;\n   execute_options.fill_status = true;\n-  TF_ASSERT_OK_AND_ASSIGN(*execute_request->mutable_execute_options(),\n-                          execute_options.ToProto(ifrt_serdes_version()));\n+  TF_ASSERT_OK(execute_options.ToProto(\n+      *execute_request->mutable_execute_options(), ifrt_serdes_version()));\n \n   auto status_is_err = absl_testing::StatusIs(absl::StatusCode::kInternal,\n                                               StrEq(\"injected error\"));\n@@ -1706,8 +1706,8 @@ TEST_P(IfrtBackendHandlerTest, GetDefaultPjRtLayoutSuccess) {\n \n   auto request = NewIfrtRequest(NewOpId());\n   auto* default_layout_request = request->mutable_get_default_layout_request();\n-  *default_layout_request->mutable_dtype() =\n-      kDType.ToProto(ifrt_serdes_version());\n+  kDType.ToProto(*default_layout_request->mutable_dtype(),\n+                 ifrt_serdes_version());\n   default_layout_request->mutable_dims()->Reserve(kDims.size());\n   for (int64_t dim : kDims) {\n     default_layout_request->add_dims(dim);"
        },
        {
            "sha": "46451a959629d55cf5f378a90a7032e88a5635ba",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2FBUILD?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -135,6 +135,7 @@ cc_library(\n         \"//xla/python/ifrt\",\n         \"//xla/python/ifrt:serdes_default_version_accessor\",\n         \"//xla/python/ifrt:serdes_version\",\n+        \"//xla/tsl/platform:errors\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\","
        },
        {
            "sha": "1eabc7efb7f4675ea72c9e46b726c7e0f4f4d917",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/xla_executable_version.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_version.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_version.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_version.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -52,20 +52,21 @@ bool XlaExecutableVersion::IsCompatibleWith(\n   return false;\n }\n \n-absl::StatusOr<SerializedXlaExecutableVersion> XlaExecutableVersion::ToProto(\n+absl::Status XlaExecutableVersion::ToProto(\n+    SerializedXlaExecutableVersion& executable_version_proto,\n     SerDesVersion version) const {\n   if (version.version_number() < SerDesVersionNumber(0)) {\n     return absl::FailedPreconditionError(\n         absl::StrCat(\"Unsupported \", version.version_number(),\n                      \" for XlaExecutableVersion serialization\"));\n   }\n \n-  SerializedXlaExecutableVersion executable_version_proto;\n+  executable_version_proto.Clear();\n   executable_version_proto.set_version_number(SerDesVersionNumber(0).value());\n   executable_version_proto.set_platform_id(platform_id);\n   executable_version_proto.set_runtime_abi_version(runtime_abi_version);\n \n-  return executable_version_proto;\n+  return absl::OkStatus();\n }\n \n absl::StatusOr<std::unique_ptr<XlaExecutableVersion>>"
        },
        {
            "sha": "4df01fbf105c2e13f7f1adf398812294152cdb71",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/xla_executable_version.h",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_version.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_version.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_version.h?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -20,12 +20,14 @@ limitations under the License.\n #include <memory>\n #include <string>\n \n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"llvm/Support/ExtensibleRTTI.h\"\n #include \"xla/python/ifrt/executable.h\"\n #include \"xla/python/ifrt/serdes_default_version_accessor.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n #include \"xla/python/pjrt_ifrt/executable_metadata.pb.h\"\n+#include \"xla/tsl/platform/errors.h\"\n \n namespace xla {\n namespace ifrt {\n@@ -43,8 +45,16 @@ struct XlaExecutableVersion\n \n   bool IsCompatibleWith(const ExecutableVersion& other) const override;\n \n+  absl::Status ToProto(SerializedXlaExecutableVersion& executable_version_proto,\n+                       SerDesVersion version = SerDesVersion::current()) const;\n+\n   absl::StatusOr<SerializedXlaExecutableVersion> ToProto(\n-      SerDesVersion version = SerDesVersion::current()) const;\n+      SerDesVersion version = SerDesVersion::current()) const {\n+    SerializedXlaExecutableVersion proto;\n+    TF_RETURN_IF_ERROR(ToProto(proto, version));\n+    return proto;\n+  }\n+\n   static absl::StatusOr<std::unique_ptr<XlaExecutableVersion>> FromProto(\n       const SerializedXlaExecutableVersion& proto);\n "
        },
        {
            "sha": "f8e493146316dd48b5a59f6fca559bc00c9806fd",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/xla_sharding_serdes.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_sharding_serdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/20938db8dd939bb97d6d462c7d4bd4c7668ee41d/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_sharding_serdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_sharding_serdes.cc?ref=20938db8dd939bb97d6d462c7d4bd4c7668ee41d",
            "patch": "@@ -58,7 +58,7 @@ class HloShardingSerDes : public llvm::RTTIExtends<HloSharding, SerDes> {\n     const HloSharding& sharding = llvm::cast<HloSharding>(serializable);\n     HloShardingProto proto;\n     proto.set_version_number(SerDesVersionNumber(0).value());\n-    *proto.mutable_devices() = sharding.devices()->ToProto(version);\n+    sharding.devices()->ToProto(*proto.mutable_devices(), version);\n     if (sharding.memory_kind().memory_kind().has_value()) {\n       proto.set_memory_kind(std::string(*sharding.memory_kind().memory_kind()));\n     }"
        }
    ],
    "stats": {
        "total": 504,
        "additions": 328,
        "deletions": 176
    }
}