{
    "author": "nvgrw",
    "message": "Switch to the Tfrt GPU client.\n\nThis change also adds a way to detect if the GPU SE client is being used to\nconditionally skip specific test cases, and adds a variant `_notfrt` that that\nruns GPU tests like before to provide test coverage to the SE GPU client.\n\nIn short: this change makes the TFRT GPU client the default for GPU tests that\nhave been migrated to the PjRt runtime, creating an alternate `_notfrt` target\nto continue running tests that do work with the SE GPU PjRt client as before.\n\nPiperOrigin-RevId: 805404551",
    "sha": "fb5781eb31a01fc47fea0202006d65738e823353",
    "files": [
        {
            "sha": "e745aae39f99f364553b5c96d220223e59b0b73a",
            "filename": "third_party/xla/xla/hlo/builder/lib/math_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Flib%2Fmath_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Flib%2Fmath_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fbuilder%2Flib%2Fmath_test.cc?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -219,18 +219,21 @@ class MathTypedTest : public MathTest {\n     if (std::is_same_v<T, double> && !test::BackendSupportsFloat64()) {\n       GTEST_SKIP();\n     }\n+\n+    if (std::is_same_v<T, tsl::float4_e2m1fn> &&\n+        test::DeviceTypeIs(test::kGpu) &&\n+        !test::UsingStreamExecutorGpuClient()) {\n+      // TODO: b/443805514 - Test float4_e2m1fn on TFRT GPU client.\n+      GTEST_SKIP() << \"TFRT GPU client does not support float4_e2m1fn.\";\n+    }\n   }\n };\n \n using TestTypes =\n     ::testing::Types<tsl::float8_e3m4, tsl::float8_e4m3, tsl::float8_e4m3fnuz,\n                      tsl::float8_e4m3b11fnuz, tsl::float8_e5m2,\n-                     tsl::float8_e5m2fnuz,\n-                     Eigen::half,\n-                     Eigen::bfloat16,\n-                     double,\n-                     tsl::float4_e2m1fn,\n-                     float>;\n+                     tsl::float8_e5m2fnuz, Eigen::half, Eigen::bfloat16, double,\n+                     tsl::float4_e2m1fn, float>;\n \n TYPED_TEST_CASE(MathTypedTest, TestTypes);\n "
        },
        {
            "sha": "d1323dd5624b280234c77642e52a86349e35dd90",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -135,8 +135,9 @@ cc_library(\n     ],\n     deps = [\n         \":pjrt_client_registry\",\n-        \"//xla/pjrt/gpu:gpu_helpers\",\n-        \"//xla/pjrt/gpu:se_gpu_pjrt_client\",\n+        \"//xla/pjrt/plugin/xla_gpu:xla_gpu_allocator_config\",\n+        \"//xla/pjrt/plugin/xla_gpu:xla_gpu_client_options\",\n+        \"//xla/pjrt/plugin/xla_gpu:xla_gpu_pjrt_client\",\n     ],\n     alwayslink = True,\n )\n@@ -2067,6 +2068,7 @@ xla_test(\n         \"//xla/hlo/builder:xla_computation\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/service:hlo_runner_interface\",\n+        \"//xla/tests:xla_test_backend_predicates\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest\","
        },
        {
            "sha": "46b6fb773a22207e65153349a4de3e7e16c8fb5c",
            "filename": "third_party/xla/xla/tests/build_defs.bzl",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fbuild_defs.bzl?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -433,6 +433,35 @@ def xla_test(\n             (backend in AMD_GPU_DEFAULT_BACKENDS and is_rocm_configured())):\n             test_names.append(test_name)\n \n+        # For coverage purposes, we want all GPU tests to also run with the PjRt\n+        # StreamExecutor GPU client, unless they are incompatible or blocking\n+        # the PjRt test migration. Only until the TFRT GPU client is fully\n+        # supported.\n+        if device_type_for_env == \"gpu\" and \"incompatible_with_pjrt_se_gpu_client\" not in this_backend_tags and \"test_migrated_to_hlo_runner_pjrt\" in this_backend_tags:\n+            variant_test_name = test_name + \"_notfrt\"\n+            xla_cc_test(\n+                name = variant_test_name,\n+                srcs = srcs,\n+                tags = this_backend_tags,\n+                copts = copts + this_backend_copts,\n+                args = args + this_backend_args,\n+                deps = deps + backend_deps,\n+                data = data + this_backend_data,\n+                env = env | {\n+                    \"XLA_TEST_DEVICE\": device,\n+                    \"XLA_TEST_DEVICE_TYPE\": device_type_for_env,\n+                    \"XLA_TEST_MODIFIERS\": \",\".join(modifiers),\n+                    \"XLA_TEST_USE_STREAM_EXECUTOR_GPU_CLIENT\": \"\",\n+                },\n+                linkstatic = linkstatic,\n+                fail_if_no_test_linked = fail_if_no_test_linked,\n+                fail_if_no_test_selected = fail_if_no_test_selected,\n+                **this_backend_kwargs\n+            )\n+            if ((backend in NVIDIA_GPU_BACKENDS and is_cuda_configured()) or\n+                (backend in AMD_GPU_DEFAULT_BACKENDS and is_rocm_configured())):\n+                test_names.append(variant_test_name)\n+\n     # Notably, a test_suite with `tests = []` is not empty:\n     # https://bazel.build/reference/be/general#test_suite_args and the default\n     # `tests = []` behavior doesn't respect `--build_tag_filters` due to"
        },
        {
            "sha": "25d0195e8b2ac629f3ba964e03dd57d1add8ed1c",
            "filename": "third_party/xla/xla/tests/convert_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fconvert_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fconvert_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fconvert_test.cc?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -560,6 +560,10 @@ TEST_F(ConvertTest, ConvertR1S4ToR1S8) {\n }\n \n TEST_F(ConvertTest, ConvertR1S4ParameterToR1S8) {\n+  if (test::DeviceTypeIs(test::kGpu) && !test::UsingStreamExecutorGpuClient()) {\n+    // TODO: b/443805514 - Enable this test for the TFRT GPU client.\n+    GTEST_SKIP() << \"The TFRT GPU client does not support packed formats.\";\n+  }\n   XlaBuilder builder(TestName());\n   Literal arg_literal =\n       LiteralUtil::CreateR1<s4>({s4(0), s4(1), s4(2), s4(-8)});\n@@ -581,6 +585,10 @@ TEST_F(ConvertTest, ConvertR1U4ToR1U8) {\n }\n \n TEST_F(ConvertTest, ConvertR1U4ParameterToR1U8) {\n+  if (test::DeviceTypeIs(test::kGpu) && !test::UsingStreamExecutorGpuClient()) {\n+    // TODO: b/443805514 - Enable this test for the TFRT GPU client.\n+    GTEST_SKIP() << \"The TFRT GPU client does not support packed formats.\";\n+  }\n   XlaBuilder builder(TestName());\n   Literal arg_literal =\n       LiteralUtil::CreateR1<u4>({u4(0), u4(1), u4(2), u4(15)});"
        },
        {
            "sha": "84b0a62dc0bddcb4e9ad27598cb910b840fbfcc3",
            "filename": "third_party/xla/xla/tests/copy_test.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fcopy_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fcopy_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcopy_test.cc?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"xla/tests/xla_test_backend_predicates.h\"\n #include <gtest/gtest.h>\n #include \"absl/types/span.h\"\n #include \"xla/array3d.h\"\n@@ -103,6 +104,10 @@ TEST_F(CopyOpTest, CopyDynamicR1S1310720U32Dynamic0) {\n   if (test_runner().HasProperty(HloRunnerPropertyTag::kCpu)) {\n     GTEST_SKIP();\n   }\n+  if (test::DeviceTypeIs(test::kGpu) && !test::UsingStreamExecutorGpuClient()) {\n+    // TODO: b/443805514 - Enable this test for the TFRT GPU client.\n+    GTEST_SKIP() << \"Does not work with the TFRT GPU client.\";\n+  }\n   Shape bounded_shape =\n       ShapeUtil::MakeShape(PrimitiveType::F32, {1310720}, {true});\n   TestDynamicCopyOp(LiteralUtil::CreateRandomLiteral<PrimitiveType::F32>(\n@@ -116,6 +121,10 @@ TEST_F(CopyOpTest, CopyDynamicR1S1310720U32Dynamic106632) {\n   if (test_runner().HasProperty(HloRunnerPropertyTag::kCpu)) {\n     GTEST_SKIP();\n   }\n+  if (test::DeviceTypeIs(test::kGpu) && !test::UsingStreamExecutorGpuClient()) {\n+    // TODO: b/443805514 - Enable this test for the TFRT GPU client.\n+    GTEST_SKIP() << \"Does not work with the TFRT GPU client.\";\n+  }\n   Shape bounded_shape =\n       ShapeUtil::MakeShape(PrimitiveType::F32, {1310720}, {true});\n   TestDynamicCopyOp(\n@@ -130,6 +139,10 @@ TEST_F(CopyOpTest, CopyDynamicR1S1310720U32Dynamic1310720) {\n   if (test_runner().HasProperty(HloRunnerPropertyTag::kCpu)) {\n     GTEST_SKIP();\n   }\n+  if (test::DeviceTypeIs(test::kGpu) && !test::UsingStreamExecutorGpuClient()) {\n+    // TODO: b/443805514 - Enable this test for the TFRT GPU client.\n+    GTEST_SKIP() << \"Does not work with the TFRT GPU client.\";\n+  }\n   Shape bounded_shape =\n       ShapeUtil::MakeShape(PrimitiveType::F32, {1310720}, {true});\n   TestDynamicCopyOp(\n@@ -144,6 +157,10 @@ TEST_F(CopyOpTest, CopyDynamicR1S512U32Dynamic64) {\n   if (test_runner().HasProperty(HloRunnerPropertyTag::kCpu)) {\n     GTEST_SKIP();\n   }\n+  if (test::DeviceTypeIs(test::kGpu) && !test::UsingStreamExecutorGpuClient()) {\n+    // TODO: b/443805514 - Enable this test for the TFRT GPU client.\n+    GTEST_SKIP() << \"Does not work with the TFRT GPU client.\";\n+  }\n   Shape bounded_shape = ShapeUtil::MakeShape(PrimitiveType::F32, {512}, {true});\n   TestDynamicCopyOp(LiteralUtil::CreateRandomLiteral<PrimitiveType::F32>(\n                         ShapeUtil::MakeShape(PrimitiveType::F32, {64}), 0, 1)"
        },
        {
            "sha": "5a0426622c560e25cbd4a9b13eef0653f42450e7",
            "filename": "third_party/xla/xla/tests/pjrt_gpu_client_registry.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 14,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fpjrt_gpu_client_registry.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fpjrt_gpu_client_registry.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fpjrt_gpu_client_registry.cc?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -13,26 +13,32 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/pjrt/gpu/gpu_helpers.h\"\n-#include \"xla/pjrt/gpu/se_gpu_pjrt_client.h\"\n+#include <cstdlib>\n+#include <utility>\n+\n+#include \"xla/pjrt/plugin/xla_gpu/xla_gpu_allocator_config.h\"\n+#include \"xla/pjrt/plugin/xla_gpu/xla_gpu_client_options.h\"\n+#include \"xla/pjrt/plugin/xla_gpu/xla_gpu_pjrt_client.h\"\n #include \"xla/tests/pjrt_client_registry.h\"\n \n namespace xla {\n namespace {\n \n // Register a GPU PjRt client for tests.\n-const bool kUnused = (RegisterPjRtClientTestFactory([]() {\n-                        xla::GpuAllocatorConfig gpu_config;\n-                        gpu_config.kind =\n-                            xla::GpuAllocatorConfig::Kind::kDefault;\n-                        gpu_config.preallocate = true;\n-                        gpu_config.memory_fraction = 0.08;\n-                        gpu_config.collective_memory_size = 0;\n-                        GpuClientOptions options;\n-                        options.allocator_config = gpu_config;\n-                        return GetStreamExecutorGpuClient(options);\n-                      }),\n-                      true);\n+const bool kUnused =\n+    (RegisterPjRtClientTestFactory([]() {\n+       GpuAllocatorConfig gpu_config;\n+       gpu_config.kind = GpuAllocatorConfig::Kind::kDefault;\n+       gpu_config.preallocate = true;\n+       gpu_config.memory_fraction = 0.08;\n+       gpu_config.collective_memory_size = 0;\n+       GpuClientOptions options;\n+       options.allocator_config = std::move(gpu_config);\n+       options.use_tfrt_gpu_client =\n+           std::getenv(\"XLA_TEST_USE_STREAM_EXECUTOR_GPU_CLIENT\") == nullptr;\n+       return GetXlaPjrtGpuClient(options);\n+     }),\n+     true);\n \n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "d92437095089de42365de516dd6c64ab43225ec3",
            "filename": "third_party/xla/xla/tests/xla_test_backend_predicates.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fxla_test_backend_predicates.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fxla_test_backend_predicates.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fxla_test_backend_predicates.cc?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -113,4 +113,8 @@ bool BackendIsStrict(absl::string_view device) {\n bool BackendSupportsFloat64() { return !DeviceTypeIs(kTpu); }\n bool BackendSupportsComplex128() { return !DeviceTypeIs(kTpu); }\n \n+bool UsingStreamExecutorGpuClient() {\n+  return std::getenv(\"XLA_TEST_USE_STREAM_EXECUTOR_GPU_CLIENT\") != nullptr;\n+}\n+\n }  // namespace xla::test"
        },
        {
            "sha": "d57a3d97b206b918a36e81bcac057cf7a616f22d",
            "filename": "third_party/xla/xla/tests/xla_test_backend_predicates.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fxla_test_backend_predicates.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fb5781eb31a01fc47fea0202006d65738e823353/third_party%2Fxla%2Fxla%2Ftests%2Fxla_test_backend_predicates.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fxla_test_backend_predicates.h?ref=fb5781eb31a01fc47fea0202006d65738e823353",
            "patch": "@@ -92,6 +92,8 @@ bool BackendIsStrict(absl::string_view device);\n bool BackendSupportsFloat64();\n bool BackendSupportsComplex128();\n \n+bool UsingStreamExecutorGpuClient();\n+\n // Useful to generate an intentionally empty set of inputs for a parameterized\n // test. This is needed when we are manipulating the inputs based on the\n // backend and would like some backends to receive zero inputs. Usage of this"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 93,
        "deletions": 22
    }
}