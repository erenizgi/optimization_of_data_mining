{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Add `ReplaceDimsAndSymbols` and `ReplaceSymbols`\n\nThese methods are added to facilitate integration with `IndexingMap` by providing ways to replace dimension and symbolic variables.\n\nPiperOrigin-RevId: 804350996",
    "sha": "5fa75ff111b60f20ad43a12ebc5e970215b9472b",
    "files": [
        {
            "sha": "90d22b262fcd068d17a8ef2ddb2ba7402ade1740",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5fa75ff111b60f20ad43a12ebc5e970215b9472b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5fa75ff111b60f20ad43a12ebc5e970215b9472b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=5fa75ff111b60f20ad43a12ebc5e970215b9472b",
            "patch": "@@ -68,6 +68,17 @@ std::string GetBinaryOpString(SymbolicExprType type) {\n   }\n }\n \n+llvm::SmallVector<SymbolicExpr> CreateVariableRange(SymbolicExprContext* ctx,\n+                                                    int64_t n,\n+                                                    int64_t offset = 0) {\n+  llvm::SmallVector<SymbolicExpr> replacements;\n+  replacements.reserve(n);\n+  for (int64_t i = 0; i < n; ++i) {\n+    replacements.push_back(ctx->CreateVariable(offset + i));\n+  }\n+  return replacements;\n+}\n+\n // Helper class to manage the state of the parser.\n class Parser {\n  public:\n@@ -697,6 +708,21 @@ SymbolicExpr SymbolicExpr::ReplaceVariables(\n   }\n }\n \n+SymbolicExpr SymbolicExpr::ReplaceSymbols(\n+    absl::Span<const SymbolicExpr> sym_replacements, int64_t num_dims) const {\n+  auto dim_replacements = CreateVariableRange(GetContext(), num_dims);\n+  return ReplaceDimsAndSymbols(dim_replacements, sym_replacements);\n+}\n+\n+SymbolicExpr SymbolicExpr::ReplaceDimsAndSymbols(\n+    absl::Span<const SymbolicExpr> dim_replacements,\n+    absl::Span<const SymbolicExpr> symbol_replacements) const {\n+  llvm::SmallVector<SymbolicExpr> replacements;\n+  replacements.append(dim_replacements.begin(), dim_replacements.end());\n+  replacements.append(symbol_replacements.begin(), symbol_replacements.end());\n+  return ReplaceVariables(replacements);\n+}\n+\n SymbolicExpr SymbolicExpr::Replace(SymbolicExpr expr,\n                                    SymbolicExpr replacement) const {\n   llvm::DenseMap<SymbolicExpr, SymbolicExpr> replacements;"
        },
        {
            "sha": "85db9018da66d746d38718cb449535e616f68cb9",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.h",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5fa75ff111b60f20ad43a12ebc5e970215b9472b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5fa75ff111b60f20ad43a12ebc5e970215b9472b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h?ref=5fa75ff111b60f20ad43a12ebc5e970215b9472b",
            "patch": "@@ -73,6 +73,20 @@ class SymbolicExpr {\n   int64_t Evaluate(absl::Span<const int64_t> variable_values) const;\n   SymbolicExpr ReplaceVariables(\n       absl::Span<const SymbolicExpr> substitutions) const;\n+  // TODO(karupayun): These methods are needed for IndexingMap, but dimensions\n+  // and symbols are SymbolicMap specific. We should remove them once we have a\n+  // better way to integrate SymbolicExpr with IndexingMap. It is assuming that\n+  // dimensions are the first (0...num_dims-1) variables and symbols are the\n+  // rest.\n+  SymbolicExpr ReplaceSymbols(absl::Span<const SymbolicExpr> replacements,\n+                              int64_t num_dims) const;\n+  // ReplaceDimsAndSymbols assumes the total number of dimensions and symbols in\n+  // the expression is the same the size of dim_replacements and\n+  // symbol_replacements.\n+  SymbolicExpr ReplaceDimsAndSymbols(\n+      absl::Span<const SymbolicExpr> dim_replacements,\n+      absl::Span<const SymbolicExpr> symbol_replacements) const;\n+\n   SymbolicExpr Canonicalize() const;\n \n   /// Sparse replace method. Replace `expr` by `replacement` and return the"
        },
        {
            "sha": "0b0065eaa54f92fee5290a514e1988aab430c1e1",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5fa75ff111b60f20ad43a12ebc5e970215b9472b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5fa75ff111b60f20ad43a12ebc5e970215b9472b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc?ref=5fa75ff111b60f20ad43a12ebc5e970215b9472b",
            "patch": "@@ -123,6 +123,26 @@ TEST_F(SymbolicExprTest, ReplaceVariables) {\n   EXPECT_EQ(result.ToString(), \"(v0 + (v2 * 10))\");\n }\n \n+TEST_F(SymbolicExprTest, ReplaceSymbols) {\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr s0 = ctx.CreateVariable(1);\n+  SymbolicExpr s1 = ctx.CreateVariable(2);\n+  SymbolicExpr c7 = ctx.CreateConstant(7);\n+  SymbolicExpr expr_to_sub = (d0 + s0 * 2) * s1;\n+  SymbolicExpr result = expr_to_sub.ReplaceSymbols({d0, c7}, 1);\n+  EXPECT_EQ(result, ((d0 + (d0 * 2)) * c7));\n+}\n+\n+TEST_F(SymbolicExprTest, ReplaceDimsAndSymbols) {\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr s0 = ctx.CreateVariable(1);\n+  SymbolicExpr s1 = ctx.CreateVariable(2);\n+  SymbolicExpr c7 = ctx.CreateConstant(7);\n+  SymbolicExpr expr_to_sub = (d0 + s0 * 2) * s1;\n+  SymbolicExpr result = expr_to_sub.ReplaceDimsAndSymbols({s0}, {d0, c7});\n+  EXPECT_EQ(result, ((s0 + (d0 * 2)) * c7));\n+}\n+\n TEST_F(SymbolicExprTest, UniquingWorks) {\n   SymbolicExpr c1 = ctx.CreateConstant(42);\n   SymbolicExpr c2 = ctx.CreateConstant(42);"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 60,
        "deletions": 0
    }
}