{
    "author": "qukhan",
    "message": "Return building status from `WeightCacheBuilder` in `MMapWeightCacheProvider`.\n\nThis removes state management that is duplicated in both classes.\n\nPiperOrigin-RevId: 806355921",
    "sha": "9c3742cb5680dcd432ab45cabeb4bf691e3d565f",
    "files": [
        {
            "sha": "0c213ebbb9df112be38f3ffacb0c0650557345f1",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9c3742cb5680dcd432ab45cabeb4bf691e3d565f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9c3742cb5680dcd432ab45cabeb4bf691e3d565f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=9c3742cb5680dcd432ab45cabeb4bf691e3d565f",
            "patch": "@@ -286,7 +286,6 @@ MMapWeightCacheProvider::MMapWeightCacheProvider(\n       XNN_MOVE_CONSTRUCT_MEMBER(file_descriptor_),\n       XNN_MOVE_CONSTRUCT_MEMBER(builder_),\n       XNN_MOVE_CONSTRUCT_MEMBER(building_run_),\n-      XNN_MOVE_CONSTRUCT_MEMBER(is_build_step_),\n       XNN_MOVE_CONSTRUCT_MEMBER(offset_to_addr_) {\n   // The contexts need to keep pointing to their owning object.\n   cache_provider_.context = this;\n@@ -310,7 +309,6 @@ MMapWeightCacheProvider& MMapWeightCacheProvider::operator=(\n   XNN_MOVE_MEMBER(file_descriptor_);\n   XNN_MOVE_MEMBER(builder_);\n   XNN_MOVE_MEMBER(building_run_);\n-  XNN_MOVE_MEMBER(is_build_step_);\n   XNN_MOVE_MEMBER(offset_to_addr_);\n #undef XNN_MOVE_MEMBER\n   return *this;\n@@ -528,8 +526,7 @@ bool MMapWeightCacheProvider::StartBuildStep() {\n   if (IsBuilding()) {\n     return true;\n   }\n-  is_build_step_ = builder_.StartBuildStep();\n-  return is_build_step_;\n+  return builder_.StartBuildStep();\n }\n \n bool MMapWeightCacheProvider::StopBuildStep() {\n@@ -543,7 +540,6 @@ bool MMapWeightCacheProvider::StopBuildStep() {\n         file_descriptor_, /*offset=*/0, file_path_.c_str()));\n   }\n #endif\n-  is_build_step_ = false;\n   return LoadLastBuildStep();\n }\n "
        },
        {
            "sha": "e6e4797ba8001acb2b207b867d00affb4a891e0f",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.h",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9c3742cb5680dcd432ab45cabeb4bf691e3d565f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9c3742cb5680dcd432ab45cabeb4bf691e3d565f/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h?ref=9c3742cb5680dcd432ab45cabeb4bf691e3d565f",
            "patch": "@@ -121,6 +121,11 @@ class WeightCacheBuilder {\n     return fd_.IsValid();\n   }\n \n+  [[nodiscard]]\n+  bool IsBuilding() const {\n+    return is_build_step_;\n+  }\n+\n   // Reopens the given file to add data to it.\n   //\n   // This should be only called from the weight cache provider.\n@@ -311,7 +316,7 @@ class MMapWeightCacheProvider {\n   // Returns true if any weights have been added to the underlying builder.\n   [[nodiscard]]\n   bool IsBuilding() const {\n-    return is_build_step_;\n+    return builder_.IsBuilding();\n   };\n \n   // Returns true if a file is mapped or a file path is set.\n@@ -393,12 +398,6 @@ class MMapWeightCacheProvider {\n   // tries to append data to an existing file (i.e. when this is `false`).\n   bool building_run_ = false;\n \n-  // True between StartBuildStep and StopBuildStep.\n-  //\n-  // This is used to check whether the builder is active, which means that some\n-  // of the buffers are not available/can't be retrieved.\n-  bool is_build_step_ = false;\n-\n   // Stores the loaded buffer addresses corresponding to the given offset in the\n   // cache file.\n   std::map<size_t, void*> offset_to_addr_;"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 7,
        "deletions": 12
    }
}