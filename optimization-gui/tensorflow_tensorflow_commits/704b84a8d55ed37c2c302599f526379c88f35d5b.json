{
    "author": "beckerhe",
    "message": "Fix bug in KernelArgsPackedVector::number_of_arguments\n\n`KernelArgs::number_of_arguments()` is supposed to consider the number\nof shared memory bytes as an argument (if the shared memory is required).\n\nThis change fixes that assumption and adds a test.\n\nPiperOrigin-RevId: 831746579",
    "sha": "704b84a8d55ed37c2c302599f526379c88f35d5b",
    "files": [
        {
            "sha": "2d2b19ee02bcdcfb550eac198fa0be5c58b9b88d",
            "filename": "third_party/xla/xla/stream_executor/kernel_args_packed_vector.h",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/704b84a8d55ed37c2c302599f526379c88f35d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_args_packed_vector.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/704b84a8d55ed37c2c302599f526379c88f35d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_args_packed_vector.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_args_packed_vector.h?ref=704b84a8d55ed37c2c302599f526379c88f35d5b",
            "patch": "@@ -40,7 +40,14 @@ class KernelArgsPackedVector : public KernelArgsPackedArrayBase {\n     }\n   }\n \n-  size_t number_of_arguments() const final { return argument_storage_.size(); }\n+  size_t number_of_arguments() const final {\n+    // We need to add 1 to the number of arguments if the kernel is using shared\n+    // memory because we treat the number of shared memory bytes like an\n+    // additional argument in the StreamExecutor kernel launch API. Note that\n+    // shared memory doesn't appear in\n+    // KernelArgsPackedVector::argument_addresses().\n+    return argument_storage_.size() + (shared_memory_bytes_ > 0);\n+  }\n \n   // Returns the number of bytes that need to be allocated in shared memory for\n   // this kernel. This value is treated like an additional argument in the CUDA"
        },
        {
            "sha": "186ca5b9d7f2f2ae0d4bb35debc2c9054fec12bb",
            "filename": "third_party/xla/xla/stream_executor/kernel_args_packed_vector_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/704b84a8d55ed37c2c302599f526379c88f35d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_args_packed_vector_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/704b84a8d55ed37c2c302599f526379c88f35d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_args_packed_vector_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_args_packed_vector_test.cc?ref=704b84a8d55ed37c2c302599f526379c88f35d5b",
            "patch": "@@ -34,6 +34,7 @@ TEST(KernelArgsPackedVectorTest, StoresSharedMemoryBytes) {\n   KernelArgsPackedVector args(std::vector<std::vector<char>>(),\n                               /*shared_memory_bytes=*/42);\n   EXPECT_EQ(args.number_of_shared_bytes(), 42);\n+  EXPECT_EQ(args.number_of_arguments(), 1);\n }\n \n TEST(KernelArgsPackedVectorTest, StoresArgumentAddresses) {\n@@ -64,5 +65,14 @@ TEST(KernelArgsPackedVectorTest, StoresArgumentAddresses) {\n       ElementsAre(30, 31, 32));\n }\n \n+TEST(KernelArgsPackedVectorTest,\n+     ConsidersSharedMemoryBytesInNumberOfArguments) {\n+  KernelArgsPackedVector args({{}, {}},\n+                              /*shared_memory_bytes=*/42);\n+\n+  // Two arguments and one shared memory argument.\n+  EXPECT_EQ(args.number_of_arguments(), 3);\n+}\n+\n }  // namespace\n }  // namespace stream_executor"
        },
        {
            "sha": "d4df438232066194a5e667ee9acaa3a6d0317632",
            "filename": "third_party/xla/xla/stream_executor/kernel_argument_packing_spec_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/704b84a8d55ed37c2c302599f526379c88f35d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/704b84a8d55ed37c2c302599f526379c88f35d5b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec_test.cc?ref=704b84a8d55ed37c2c302599f526379c88f35d5b",
            "patch": "@@ -150,7 +150,9 @@ TEST(KernelArgumentsPackingSpecTest, BuildArguments) {\n           {DeviceMemoryBase(\n               absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)), 0)},\n           /*shared_memory_bytes=*/8989));\n-  EXPECT_EQ(packed_args->number_of_arguments(), 2);\n+  // We expect 3 arguments: 2 parameters and the shared memory which counts as\n+  // an argument.\n+  EXPECT_EQ(packed_args->number_of_arguments(), 3);\n   EXPECT_EQ(packed_args->number_of_shared_bytes(), 8989);\n   EXPECT_EQ(packed_args->argument_addresses().size(), 2);\n   EXPECT_THAT(\n@@ -201,7 +203,9 @@ TEST(KernelArgumentsPackingSpecTest, FromProto) {\n           {DeviceMemoryBase(\n               absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)), 0)},\n           /*shared_memory_bytes=*/8989));\n-  EXPECT_EQ(arguments->number_of_arguments(), 2);\n+  // We expect 3 arguments: 2 parameters and the shared memory which counts as\n+  // an argument.\n+  EXPECT_EQ(arguments->number_of_arguments(), 3);\n   EXPECT_EQ(arguments->number_of_shared_bytes(), 8989);\n   ASSERT_THAT(arguments->argument_addresses(), SizeIs(2));\n   EXPECT_THAT(absl::Span<const char>(absl::bit_cast<const char*>("
        }
    ],
    "stats": {
        "total": 27,
        "additions": 24,
        "deletions": 3
    }
}