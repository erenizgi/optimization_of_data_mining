{
    "author": "subhankarshah",
    "message": "[XLA:MSA] Allow allocation requests with a continuous default memory requirement to fall through without resulting in a failure requiring un-commit.\n\nPiperOrigin-RevId: 821165250",
    "sha": "a139a50e5679e3d31df503ed74a61f572c760ada",
    "files": [
        {
            "sha": "80aefa2fdba4417535ca4caf091fd431ae83b82d",
            "filename": "third_party/xla/xla/service/memory_space_assignment/algorithm.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a139a50e5679e3d31df503ed74a61f572c760ada/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a139a50e5679e3d31df503ed74a61f572c760ada/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Falgorithm.cc?ref=a139a50e5679e3d31df503ed74a61f572c760ada",
            "patch": "@@ -5811,11 +5811,21 @@ AllocationResult MsaAlgorithm::AllocateSegment(AllocationRequest& request) {\n           request.end_time));\n       prev_allocation_in_default_mem_it = allocation_sequence->rbegin();\n     }\n+  } else if (prev_allocation_it == allocation_sequence->rend() &&\n+             (request.require_start_colored_in_default_memory ||\n+              request.require_end_colored_in_default_memory)) {\n+    // There are no previous allocations, we require contiguous allocation and\n+    // either the start or end needs to be colored in the default memory.\n+    // We can satisfy this requirement by pinning the allocation in the default\n+    // memory space for this time range.\n+    allocation_sequence->push_back(std::make_unique<PinnedAllocation>(\n+        defining_position, MemorySpace::kDefault,\n+        /*chunk=*/std::nullopt, request.inclusive_start_time,\n+        request.end_time));\n+    prev_allocation_in_default_mem_it = allocation_sequence->rbegin();\n   } else if (prev_allocation_in_default_mem_it == allocation_sequence->rend()) {\n     VLOG(3) << \"Allocation requires contiguous allocation, but it wasn't \"\n-               \"possible to find one.\";\n-    CHECK(!request.require_start_colored_in_default_memory);\n-    CHECK(!request.require_end_colored_in_default_memory);\n+               \"possible to find one in alternate memory or default memory.\";\n     return result_mark(AllocationResult::kFailRequiresUncommit,\n                        allocation_result);\n   }"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 13,
        "deletions": 3
    }
}