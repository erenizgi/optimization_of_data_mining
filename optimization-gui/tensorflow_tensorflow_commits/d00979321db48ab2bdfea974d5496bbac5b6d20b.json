{
    "author": "beckerhe",
    "message": "Make TopK custom kernels serializable\n\nTo make them serializable, two things are needed:\n\n1. Register the symbols in the KernelSymbolRegistry\n2. Move away from the custom kernel args packing function and use the KernelArgumentsPackingSpec instead. (The latter is serializable while the former is not.)\n\nPiperOrigin-RevId: 832305305",
    "sha": "d00979321db48ab2bdfea974d5496bbac5b6d20b",
    "files": [
        {
            "sha": "d5b1264de254c383f767ca06dc984c5a46c0859f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -2438,8 +2438,7 @@ cc_library(\n         \"//xla:types\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/service/gpu/kernels:custom_kernel\",\n-        \"//xla/stream_executor:device_memory\",\n-        \"//xla/stream_executor:kernel\",\n+        \"//xla/stream_executor:kernel_argument_packing_spec\",\n         \"//xla/stream_executor:kernel_spec\",\n         \"//xla/stream_executor:launch_dim\",\n         \"//xla/stream_executor:platform\",\n@@ -2465,10 +2464,12 @@ xla_test(\n         \"//xla/service:platform_util\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:kernel\",\n+        \"//xla/stream_executor:kernel_args\",\n         \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:platform_manager\",\n         \"//xla/stream_executor:stream\",\n         \"//xla/stream_executor:stream_executor_h\",\n+        \"//xla/stream_executor/gpu:kernel_serialization_check\",\n         \"//xla/stream_executor/host:host_platform\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\","
        },
        {
            "sha": "10b611d29a6c0f9949837f25ff4a8829fc4472ae",
            "filename": "third_party/xla/xla/backends/gpu/runtime/topk.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 21,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Ftopk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Ftopk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Ftopk.cc?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -21,7 +21,6 @@ limitations under the License.\n #include <cstddef>\n #include <cstdint>\n #include <limits>\n-#include <memory>\n #include <string>\n #include <utility>\n \n@@ -31,10 +30,9 @@ limitations under the License.\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/service/gpu/kernels/custom_kernel.h\"\n-#include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/gpu/gpu_kernel_registry.h\"\n #include \"xla/stream_executor/gpu/topk_kernel.h\"\n-#include \"xla/stream_executor/kernel.h\"\n+#include \"xla/stream_executor/kernel_argument_packing_spec.h\"\n #include \"xla/stream_executor/kernel_spec.h\"\n #include \"xla/stream_executor/launch_dim.h\"\n #include \"xla/stream_executor/platform.h\"\n@@ -47,8 +45,6 @@ namespace xla::gpu::kernel::topk {\n \n namespace {\n \n-using KernelArgsPacking = se::KernelLoaderSpec::KernelArgsPacking;\n-\n // The optimal number of threads is the smaller value between the number of\n // threads available per block and the number of slices of data.\n size_t EstimateOptimalNumThreads(size_t n, size_t k, size_t batch_size) {\n@@ -66,21 +62,16 @@ size_t EstimateOptimalNumThreads(size_t n, size_t k, size_t batch_size) {\n   return std::min(threads_per_block, min_slice);\n }\n \n-// Returns the function creating packed arguments for TopK kernel.\n-template <typename T>\n-KernelArgsPacking CreateTopKArgsPacking(size_t num_elements, size_t k) {\n-  using Packed = absl::StatusOr<std::unique_ptr<se::KernelArgsPackedArrayBase>>;\n-\n-  return [=](const se::Kernel& kernel, const se::KernelArgs& args) -> Packed {\n-    auto* mem_args = se::Cast<se::KernelArgsDeviceMemoryArray>(&args);\n-\n-    se::DeviceMemory<T> data(mem_args->device_memory_args()[0]);\n-    se::DeviceMemory<T> top_elements(mem_args->device_memory_args()[1]);\n-    se::DeviceMemory<uint32_t> top_indices(mem_args->device_memory_args()[2]);\n-\n-    return se::PackKernelArgs(args.number_of_shared_bytes(), data, num_elements,\n-                              top_elements, top_indices, k);\n-  };\n+// Returns a packing spec for invoking the TopK kernel.\n+se::KernelArgumentsPackingSpec CreateTopKArgsPacking(size_t num_elements,\n+                                                     size_t k) {\n+  se::KernelArgumentsPackingSpec spec;\n+  spec.AddAddressArgument(0);  // data\n+  spec.AddConstantArgument(num_elements);\n+  spec.AddAddressArgument(1);  // top_elements\n+  spec.AddAddressArgument(2);  // top_indices\n+  spec.AddConstantArgument(k);\n+  return spec;\n }\n \n // Finds the TopK kernel for the given platform registered in the global\n@@ -158,7 +149,7 @@ absl::StatusOr<CustomKernel> GetTypedTopK(std::string name, size_t num_elements,\n       se::KernelLoaderSpec spec,\n       GetTopKKernelForKAndPlatformAndN<T>(k, platform->id(), num_elements));\n \n-  spec.set_kernel_args_packing(CreateTopKArgsPacking<T>(num_elements, k));\n+  spec.set_kernel_args_packing(CreateTopKArgsPacking(num_elements, k));\n   return CustomKernel(std::move(name), std::move(spec),\n                       se::BlockDim(batch_size, 1, 1),\n                       se::ThreadDim(num_threads, 1, 1), shmem_size);"
        },
        {
            "sha": "2dc181e9bd97ca160836851c78243c2f647c5ab5",
            "filename": "third_party/xla/xla/backends/gpu/runtime/topk_test.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Ftopk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Ftopk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Ftopk_test.cc?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -29,7 +29,9 @@ limitations under the License.\n #include \"absl/strings/substitute.h\"\n #include \"xla/service/platform_util.h\"\n #include \"xla/stream_executor/device_memory.h\"\n+#include \"xla/stream_executor/gpu/kernel_serialization_check.h\"\n #include \"xla/stream_executor/kernel.h\"\n+#include \"xla/stream_executor/kernel_args.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/platform_manager.h\"\n #include \"xla/stream_executor/stream.h\"\n@@ -190,6 +192,21 @@ TEST_P(TopKKernelTest, TopKPackedNegative) {\n   }\n }\n \n+TEST_P(TopKKernelTest, EnsureSerializable) {\n+  auto name =\n+      absl::AsciiStrToUpper(PlatformUtil::CanonicalPlatformName(\"gpu\").value());\n+  se::Platform* platform = se::PlatformManager::PlatformWithName(name).value();\n+\n+  const auto [n_kb, k, batch_size, offset] = GetParam();\n+  const size_t n = n_kb * 1024 + offset;\n+\n+  auto custom_kernel = GetTopKKernel(\"topk\", PrimitiveType::F32, n, k,\n+                                     batch_size, platform->Name(), 32);\n+\n+  stream_executor::gpu::VerifyKernelIsSerializable(custom_kernel->kernel_spec(),\n+                                                   platform->id());\n+}\n+\n INSTANTIATE_TEST_SUITE_P(TopKTests, TopKKernelTest,\n                          Combine(\n                              /*n_kb=*/Values(1, 8, 12, 64, 128),"
        },
        {
            "sha": "f41c323185160e0c1f8c5fab88cedd353ffd72a7",
            "filename": "third_party/xla/xla/stream_executor/cuda/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -2424,6 +2424,7 @@ cuda_library(\n     deps = [\n         \":cuda_platform_id\",\n         \"//xla:types\",\n+        \"//xla/stream_executor:kernel_symbol_registry\",\n         \"//xla/stream_executor/gpu:gpu_kernel_registry\",\n         \"//xla/stream_executor/gpu:topk_kernel\",\n         \"//xla/tsl/lib/math:math_util\","
        },
        {
            "sha": "e89f3cc8dfdec084a4574c6dff731e8333bf873e",
            "filename": "third_party/xla/xla/stream_executor/cuda/topk_kernel_cuda_common.cu.h",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Ftopk_kernel_cuda_common.cu.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Ftopk_kernel_cuda_common.cu.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Ftopk_kernel_cuda_common.cu.h?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -1,3 +1,4 @@\n+#include \"xla/stream_executor/kernel_symbol_registry.h\"\n /* Copyright 2023 The OpenXLA Authors.\n \n Licensed under the Apache License, Version 2.0 (the \"License\");\n@@ -285,10 +286,15 @@ __launch_bounds__(stream_executor::gpu::kTopKMaxThreadsPerBlock, 1) __global__\n   GPU_KERNEL_REGISTRY_REGISTER_KERNEL_STATICALLY(                             \\\n       TopKKernelCuda_K##K_VAL##_##TYPE##_##VT, KERNEL_TRAIT(K_VAL, TYPE, VT), \\\n       stream_executor::cuda::kCudaPlatformId, ([](size_t arity) {             \\\n-        return stream_executor::KernelLoaderSpec::CreateInProcessSymbolSpec(  \\\n-            absl::bit_cast<void*>(&Run<K_VAL, TYPE, VT>),                     \\\n-            \"topk_k\" #K_VAL \"_\" #TYPE \"_\" #VT, arity);                        \\\n-      }));\n+        return stream_executor::KernelLoaderSpec::                            \\\n+            CreateSerializableInProcessSymbolSpec(                            \\\n+                /*persistent_kernel_name=*/\"topk_k\" #K_VAL \"_\" #TYPE \"_\" #VT, \\\n+                absl::bit_cast<void*>(&Run<K_VAL, TYPE, VT>),                 \\\n+                \"topk_k\" #K_VAL \"_\" #TYPE \"_\" #VT, arity);                    \\\n+      }));                                                                    \\\n+  KERNEL_SYMBOL_REGISTRY_REGISTER_SYMBOL_STATICALLY(                          \\\n+      topk_k##K_VAL##_##TYPE##_##VT, stream_executor::cuda::kCudaPlatformId,  \\\n+      (&Run<K_VAL, TYPE, VT>));\n \n }  // namespace stream_executor::cuda\n "
        },
        {
            "sha": "966bd43eb72f55e9f1aeeef523578308dc1dc85b",
            "filename": "third_party/xla/xla/stream_executor/gpu/BUILD",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2FBUILD?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -1017,3 +1017,19 @@ cc_library(\n         \"//xla/stream_executor:kernel\",\n     ],\n )\n+\n+cc_library(\n+    name = \"kernel_serialization_check\",\n+    testonly = True,\n+    srcs = [\"kernel_serialization_check.cc\"],\n+    hdrs = [\"kernel_serialization_check.h\"],\n+    deps = [\n+        \"//xla/stream_executor:kernel_spec\",\n+        \"//xla/stream_executor:kernel_symbol_registry\",\n+        \"//xla/stream_executor:platform\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_googletest//:gtest_for_library\",\n+    ],\n+)"
        },
        {
            "sha": "ab79887a10dabc84573dc6106ce94f7296bc6eea",
            "filename": "third_party/xla/xla/stream_executor/gpu/kernel_serialization_check.cc",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fkernel_serialization_check.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fkernel_serialization_check.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fkernel_serialization_check.cc?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -0,0 +1,56 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/stream_executor/gpu/kernel_serialization_check.h\"\n+\n+#include <gmock/gmock.h>\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/stream_executor/kernel_spec.h\"\n+#include \"xla/stream_executor/kernel_symbol_registry.h\"\n+#include \"xla/stream_executor/platform.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+\n+namespace stream_executor::gpu {\n+using ::testing::IsEmpty;\n+using ::testing::NotNull;\n+\n+void VerifyKernelIsSerializable(const KernelLoaderSpec& kernel_spec,\n+                                Platform::Id platform_id) {\n+  auto resolve_kernel_symbol =\n+      [&](absl::string_view persistent_kernel_name) -> absl::StatusOr<void*> {\n+    return KernelSymbolRegistry::GetGlobalInstance().FindSymbol(\n+        persistent_kernel_name, platform_id);\n+  };\n+\n+  TF_ASSERT_OK_AND_ASSIGN(KernelLoaderSpecProto proto, kernel_spec.ToProto());\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      KernelLoaderSpec deserialized_spec,\n+      KernelLoaderSpec::FromProto(proto, resolve_kernel_symbol));\n+\n+  if (deserialized_spec.has_in_process_symbol()) {\n+    EXPECT_THAT(deserialized_spec.in_process_symbol()->symbol, NotNull());\n+  }\n+  if (deserialized_spec.has_cuda_cubin_in_memory()) {\n+    EXPECT_THAT(deserialized_spec.cuda_cubin_in_memory()->cubin_bytes,\n+                Not(IsEmpty()));\n+  }\n+  if (deserialized_spec.has_cuda_ptx_in_memory()) {\n+    EXPECT_THAT(deserialized_spec.cuda_ptx_in_memory()->ptx, Not(IsEmpty()));\n+  }\n+}\n+\n+}  // namespace stream_executor::gpu"
        },
        {
            "sha": "e790acb9493a3fab9fba13ad4ac762a2cb4d30c7",
            "filename": "third_party/xla/xla/stream_executor/gpu/kernel_serialization_check.h",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fkernel_serialization_check.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fkernel_serialization_check.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fkernel_serialization_check.h?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -0,0 +1,32 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_STREAM_EXECUTOR_GPU_KERNEL_SERIALIZATION_CHECK_H_\n+#define XLA_STREAM_EXECUTOR_GPU_KERNEL_SERIALIZATION_CHECK_H_\n+\n+#include \"xla/stream_executor/kernel_spec.h\"\n+#include \"xla/stream_executor/platform.h\"\n+namespace stream_executor::gpu {\n+\n+// Verifies that a the given KernelLoaderSpec can be serialized and deserialized\n+// correctly for the given platform id.\n+// The check is best-effort and won't actually try to run or load the kernel.\n+// It's just verifying that the necessary information is present.\n+void VerifyKernelIsSerializable(const KernelLoaderSpec& kernel_spec,\n+                                Platform::Id platform_id);\n+\n+}  // namespace stream_executor::gpu\n+\n+#endif  // XLA_STREAM_EXECUTOR_GPU_KERNEL_SERIALIZATION_CHECK_H_"
        },
        {
            "sha": "d37250234f05df6e44793c16127eccdb80c71c5e",
            "filename": "third_party/xla/xla/stream_executor/rocm/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2FBUILD?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -1184,6 +1184,7 @@ rocm_library(\n     deps = [\n         \":rocm_platform_id\",\n         \"//xla:types\",\n+        \"//xla/stream_executor:kernel_symbol_registry\",\n         \"//xla/stream_executor/gpu:gpu_kernel_registry\",\n         \"//xla/stream_executor/gpu:topk_kernel\",\n         \"//xla/tsl/lib/math:math_util\","
        },
        {
            "sha": "2ce77648b0ef089fc9d81dfb23f9db315946363e",
            "filename": "third_party/xla/xla/stream_executor/rocm/topk_kernel_rocm_common.cu.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Ftopk_kernel_rocm_common.cu.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d00979321db48ab2bdfea974d5496bbac5b6d20b/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Ftopk_kernel_rocm_common.cu.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Ftopk_kernel_rocm_common.cu.h?ref=d00979321db48ab2bdfea974d5496bbac5b6d20b",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n \n #include \"xla/stream_executor/gpu/gpu_kernel_registry.h\"\n #include \"xla/stream_executor/gpu/topk_kernel.h\"\n+#include \"xla/stream_executor/kernel_symbol_registry.h\"\n #include \"xla/stream_executor/rocm/rocm_platform_id.h\"\n #include \"xla/tsl/lib/math/math_util.h\"\n \n@@ -292,7 +293,10 @@ __launch_bounds__(stream_executor::gpu::kTopKMaxThreadsPerBlock, 1) __global__\n         return stream_executor::KernelLoaderSpec::CreateInProcessSymbolSpec(  \\\n             absl::bit_cast<void*>(&Run<K_VAL, TYPE, VT>),                     \\\n             \"topk_k\" #K_VAL \"_\" #TYPE \"_\" #VT, arity);                        \\\n-      }));\n+      }));                                                                    \\\n+  KERNEL_SYMBOL_REGISTRY_REGISTER_SYMBOL_STATICALLY(                          \\\n+      TopKKernelRocm_K##K_VAL##_##TYPE##_##VT,                                \\\n+      stream_executor::rocm::kROCmPlatformId, (&Run<K_VAL, TYPE, VT>));\n \n }  // namespace stream_executor::rocm\n "
        }
    ],
    "stats": {
        "total": 181,
        "additions": 153,
        "deletions": 28
    }
}