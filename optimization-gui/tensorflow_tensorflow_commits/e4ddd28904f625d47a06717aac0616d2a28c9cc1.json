{
    "author": "tensorflower-gardener",
    "message": "[SymbolicMap] Implement ReplaceDimsAndSymbols\n\nPiperOrigin-RevId: 799984573",
    "sha": "e4ddd28904f625d47a06717aac0616d2a28c9cc1",
    "files": [
        {
            "sha": "87fa1a91c1f6c2c6bc5fae2f3ec6e07387929792",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD?ref=e4ddd28904f625d47a06717aac0616d2a28c9cc1",
            "patch": "@@ -215,7 +215,9 @@ cc_library(\n     hdrs = [\"symbolic_map.h\"],\n     deps = [\n         \":symbolic_expr\",\n+        \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n     ],\n )"
        },
        {
            "sha": "88fe8178aba8cde233139d904664c9eaa9ca3c07",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=e4ddd28904f625d47a06717aac0616d2a28c9cc1",
            "patch": "@@ -16,10 +16,13 @@ limitations under the License.\n #include \"xla/service/gpu/model/experimental/symbolic_map.h\"\n \n #include <cstdint>\n+#include <iterator>\n #include <utility>\n #include <vector>\n \n+#include \"absl/algorithm/container.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/types/span.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n@@ -72,6 +75,27 @@ llvm::SmallVector<int64_t> SymbolicMap::GetConstantResults() const {\n   return constants;\n }\n \n+SymbolicMap SymbolicMap::ReplaceDimsAndSymbols(\n+    absl::Span<const SymbolicExpr> dim_replacements,\n+    absl::Span<const SymbolicExpr> sym_replacements, int64_t num_result_dims,\n+    int64_t num_result_symbols) const {\n+  CHECK_EQ(dim_replacements.size(), num_dimensions_);\n+  CHECK_EQ(sym_replacements.size(), num_symbols_);\n+\n+  llvm::SmallVector<SymbolicExpr> all_replacements;\n+  all_replacements.reserve(num_dimensions_ + num_symbols_);\n+  absl::c_copy(dim_replacements, std::back_inserter(all_replacements));\n+  absl::c_copy(sym_replacements, std::back_inserter(all_replacements));\n+\n+  std::vector<SymbolicExpr> new_exprs;\n+  new_exprs.reserve(exprs_.size());\n+  for (const auto& expr : exprs_) {\n+    new_exprs.push_back(expr.ReplaceVariables(all_replacements));\n+  }\n+  return SymbolicMap(ctx_, num_result_dims, num_result_symbols,\n+                     std::move(new_exprs));\n+}\n+\n bool SymbolicMap::operator==(const SymbolicMap& other) const {\n   return ctx_ == other.ctx_ && num_dimensions_ == other.num_dimensions_ &&\n          num_symbols_ == other.num_symbols_ && exprs_ == other.exprs_;"
        },
        {
            "sha": "7a903f9172e5727680f0d20276f1073e5f85724a",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=e4ddd28904f625d47a06717aac0616d2a28c9cc1",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <cstdint>\n #include <vector>\n \n+#include \"absl/types/span.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n \n@@ -53,6 +54,15 @@ class SymbolicMap {\n   // any result expression is not a constant.\n   llvm::SmallVector<int64_t> GetConstantResults() const;\n \n+  // Replaces the dimensions and symbols in the map with the given expressions.\n+  // The number of dimension and symbol replacements must match the number of\n+  // dimensions and symbols in the map. The new map will have the given number\n+  // of dimensions and symbols.\n+  SymbolicMap ReplaceDimsAndSymbols(\n+      absl::Span<const SymbolicExpr> dim_replacements,\n+      absl::Span<const SymbolicExpr> sym_replacements, int64_t num_result_dims,\n+      int64_t num_result_symbols) const;\n+\n   bool operator==(const SymbolicMap& other) const;\n   bool operator!=(const SymbolicMap& other) const { return !(*this == other); }\n "
        },
        {
            "sha": "f0ffbebb003a8b5fd9a245ba10a93cd05198cfdb",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4ddd28904f625d47a06717aac0616d2a28c9cc1/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=e4ddd28904f625d47a06717aac0616d2a28c9cc1",
            "patch": "@@ -81,6 +81,38 @@ TEST(SymbolicMapTest, GetConstantResults) {\n   EXPECT_THAT(no_results_map.GetConstantResults(), ElementsAre());\n }\n \n+TEST(SymbolicMapTest, ReplaceDimsAndSymbols) {\n+  SymbolicExprContext ctx;\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+  SymbolicExpr s0 = ctx.CreateVariable(2);\n+  SymbolicExpr s1 = ctx.CreateVariable(3);\n+  SymbolicExpr c1 = ctx.CreateConstant(10);\n+  SymbolicExpr c2 = ctx.CreateConstant(20);\n+  SymbolicExpr c3 = ctx.CreateConstant(30);\n+\n+  SymbolicMap map_basic = SymbolicMap::Get(&ctx, 2, 2, {d0 + s0, d1 * s1});\n+  SymbolicMap replaced_basic = map_basic.ReplaceDimsAndSymbols(\n+      {c1, c2}, {c3, d0}, map_basic.GetNumDims(), map_basic.GetNumSymbols());\n+  EXPECT_THAT(replaced_basic.GetResults(), ElementsAre(c1 + c3, c2 * d0));\n+\n+  SymbolicMap map_empty = SymbolicMap::Get(&ctx, 0, 0, {});\n+  SymbolicMap replaced_empty = map_empty.ReplaceDimsAndSymbols({}, {}, 0, 0);\n+  EXPECT_TRUE(replaced_empty.IsEmpty());\n+\n+  SymbolicMap map_change_dims = SymbolicMap::Get(&ctx, 1, 1, {d0 + s0 * c2});\n+  // Replacements in the context of the NEW map (2 dims, 1 symbol)\n+  SymbolicExpr new_d0 = ctx.CreateVariable(0);\n+  SymbolicExpr new_d1 = ctx.CreateVariable(1);\n+  SymbolicExpr new_s0 = ctx.CreateVariable(2);\n+  SymbolicMap replaced_change_dims = map_change_dims.ReplaceDimsAndSymbols(\n+      {new_d0 * c1 + new_d1}, {new_s0}, 2, 1);\n+  EXPECT_EQ(replaced_change_dims.GetNumDims(), 2);\n+  EXPECT_EQ(replaced_change_dims.GetNumSymbols(), 1);\n+  EXPECT_THAT(replaced_change_dims.GetResults(),\n+              ElementsAre((new_d0 * c1 + new_d1) + new_s0 * c2));\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 68,
        "deletions": 0
    }
}