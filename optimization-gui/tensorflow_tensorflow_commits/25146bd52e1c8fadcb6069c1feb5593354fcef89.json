{
    "author": "vwbaker",
    "message": "Update splitk checks in gemm_fusion_autotuner_test\n\nGetting this test to work with `--xla_gpu_experimental_enable_fusion_autotuner` - previously, the tests were assuming they could check for a reduction by checking the last part was a fusion of kind=kInput. However, the change I'm making allows reductions to go through the triton or native emitter backends. I've updated the tests to check for the fusion output of both fusions, which should be more representative of the dot+reduce patter that the test is looking for.\n\nPiperOrigin-RevId: 812770934",
    "sha": "25146bd52e1c8fadcb6069c1feb5593354fcef89",
    "files": [
        {
            "sha": "7966e5b9b7e2e792162f5665fd03aae5c8242c92",
            "filename": "third_party/xla/xla/service/gpu/autotuning/gemm_fusion_autotuner_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/25146bd52e1c8fadcb6069c1feb5593354fcef89/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/25146bd52e1c8fadcb6069c1feb5593354fcef89/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner_test.cc?ref=25146bd52e1c8fadcb6069c1feb5593354fcef89",
            "patch": "@@ -569,10 +569,13 @@ ENTRY e {\n     lhs_contracting_dims={1}, rhs_contracting_dims={0}\n })\";\n \n+  // To check for splitk, we check that two fusions are created - one for dot\n+  // and the second for reduce.\n   MatchOptimizedHlo(kHloText, R\"(\n ; CHECK: reduce\n ; CHECK: ENTRY\n-; CHECK: ROOT {{.*}} fusion({{.*}}), kind=kLoop\n+; CHECK: f32[16,7,18]{2,1,0} fusion({{.*}})\n+; CHECK: ROOT {{.*}} f16[7,18]{1,0} fusion({{.*}})\n )\");\n \n   EXPECT_TRUE(RunAndCompare(kHloText, ErrorSpec{/*aabs=*/1e-2, /*arel=*/1e-3}));\n@@ -594,6 +597,9 @@ ENTRY e {\n     backend_config={\"fusion_backend_config\":{kind: \"__triton_gemm\", triton_gemm_config: {\"block_m\":16,\"block_n\":64,\"block_k\":32,\"split_k\":3,\"num_stages\":1,\"num_warps\":2,\"num_ctas\":1}}}\n })\";\n \n+  // Check for tiling and splitk.\n+  // To check for splitk, we check that two fusions are created - one for dot\n+  // and the second for reduce.\n   MatchOptimizedHlo(kHloText, R\"(\n ; CHECK: f16[55,3,40]{2,1,0} fusion\n ; CHECK-SAME: \"kind\":\"__triton_nested_gemm_fusion\"\n@@ -602,7 +608,8 @@ ENTRY e {\n ; CHECK-SAME: \"kind\":\"__triton_nested_gemm_fusion\"\n ; CHECK-SAME: \"sizes\":[\"1\",\"32\",\"64\"]\n ; CHECK: ENTRY\n-; CHECK: ROOT {{.*}} f16[55,20]{1,0} fusion({{.*}}), kind=kLoop\n+; CHECK: f32[3,55,20]{2,1,0} fusion({{.*}})\n+; CHECK: ROOT {{.*}} f16[55,20]{1,0} fusion({{.*}})\n )\");\n \n   EXPECT_TRUE(RunAndCompare(kHloText, ErrorSpec{/*aabs=*/1e-3, /*arel=*/1e-3}));"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 9,
        "deletions": 2
    }
}