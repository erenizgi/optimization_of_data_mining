{
    "author": "ezhulenev",
    "message": "[xla:gpu] Add an API to lookup acquired communicator by global id\n\nPiperOrigin-RevId: 838895441",
    "sha": "3ad8c9360e93b634de9cbfd9e69c52c5c789aa73",
    "files": [
        {
            "sha": "fd09e850a119bc8ac81a6e882912b8a59bbfc98f",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=3ad8c9360e93b634de9cbfd9e69c52c5c789aa73",
            "patch": "@@ -1636,15 +1636,16 @@ cc_library(\n     srcs = [\"collective_cliques.cc\"],\n     hdrs = [\"collective_cliques.h\"],\n     deps = [\n+        \":collective_clique_requests\",\n         \":collective_params\",\n         \"//xla:util\",\n         \"//xla/backends/gpu/collectives:gpu_clique\",\n         \"//xla/backends/gpu/collectives:gpu_clique_key\",\n         \"//xla/backends/gpu/collectives:gpu_cliques\",\n         \"//xla/backends/gpu/collectives:gpu_collectives\",\n-        \"//xla/backends/gpu/runtime:collective_clique_requests\",\n         \"//xla/core/collectives:communicator\",\n         \"//xla/core/collectives:rank_id\",\n+        \"//xla/runtime:device_id\",\n         \"//xla/service/gpu:gpu_executable_run_options\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:statusor\",\n@@ -2075,6 +2076,7 @@ cc_library(\n     srcs = [\"thunk.cc\"],\n     hdrs = [\"thunk.h\"],\n     deps = [\n+        \":collective_clique_requests\",\n         \":collective_cliques\",\n         \":collective_params\",\n         \":thunk_id\",\n@@ -2085,7 +2087,6 @@ cc_library(\n         \"//xla/backends/gpu/collectives:gpu_clique_key\",\n         \"//xla/backends/gpu/collectives:gpu_cliques\",\n         \"//xla/backends/gpu/collectives:gpu_collectives\",\n-        \"//xla/backends/gpu/runtime:collective_clique_requests\",\n         \"//xla/core/collectives:communicator\",\n         \"//xla/core/collectives:rank_id\",\n         \"//xla/ffi:execution_context\","
        },
        {
            "sha": "fa0381cefdd14b9eb3dea77608fe4509dd208d84",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_cliques.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_cliques.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_cliques.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_cliques.cc?ref=3ad8c9360e93b634de9cbfd9e69c52c5c789aa73",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/collective_params.h\"\n #include \"xla/core/collectives/communicator.h\"\n #include \"xla/core/collectives/rank_id.h\"\n+#include \"xla/runtime/device_id.h\"\n #include \"xla/service/gpu/gpu_executable_run_options.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -80,6 +81,15 @@ absl::StatusOr<Communicator*> CollectiveCliques::GetComm(\n   return *communicator;\n }\n \n+absl::StatusOr<Communicator*> CollectiveCliques::GetComm(\n+    const GpuCliqueKey& clique_key, GlobalDeviceId global_device_id) const {\n+  std::optional<RankId> rank = clique_key.rank(global_device_id);\n+  if (!rank.has_value()) {\n+    return InvalidArgument(\"Rank not found for device %v\", global_device_id);\n+  }\n+  return GetComm(clique_key, *rank);\n+}\n+\n absl::StatusOr<bool> CollectiveCliques::peer_access_enabled(\n     const GpuCliqueKey& clique_key) const {\n   // Check that we locked access to a clique for `clique_key`."
        },
        {
            "sha": "89338dbb76b3747c6b5a18070ae63726b2aba80c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_cliques.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_cliques.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_cliques.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_cliques.h?ref=3ad8c9360e93b634de9cbfd9e69c52c5c789aa73",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/collective_params.h\"\n #include \"xla/core/collectives/communicator.h\"\n #include \"xla/core/collectives/rank_id.h\"\n+#include \"xla/runtime/device_id.h\"\n \n namespace xla::gpu {\n \n@@ -39,6 +40,9 @@ class CollectiveCliques {\n   absl::StatusOr<Communicator*> GetComm(const GpuCliqueKey& clique_key,\n                                         RankId rank) const;\n \n+  absl::StatusOr<Communicator*> GetComm(const GpuCliqueKey& clique_key,\n+                                        GlobalDeviceId global_device_id) const;\n+\n   // Returns whether peer device memory access is possible between all devices\n   // in the clique.\n   absl::StatusOr<bool> peer_access_enabled("
        },
        {
            "sha": "2009bba083ab93eff35c17d45773b8a89a23d171",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_execution.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 10,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_execution.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3ad8c9360e93b634de9cbfd9e69c52c5c789aa73/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_execution.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_execution.cc?ref=3ad8c9360e93b634de9cbfd9e69c52c5c789aa73",
            "patch": "@@ -16,7 +16,6 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/collective_execution.h\"\n \n #include <cstdint>\n-#include <optional>\n #include <utility>\n #include <vector>\n \n@@ -28,7 +27,6 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/collective_cliques.h\"\n #include \"xla/backends/gpu/runtime/collective_params.h\"\n #include \"xla/core/collectives/communicator.h\"\n-#include \"xla/core/collectives/rank_id.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/runtime/device_id.h\"\n #include \"xla/service/collective_ops_utils.h\"\n@@ -135,14 +133,9 @@ absl::StatusOr<GpuCliqueKey> GetGpuCliqueKey(\n absl::StatusOr<CommunicatorHandle> GetComm(\n     const CollectiveParams& params, const CollectiveCliques& collective_cliques,\n     const GpuCliqueKey& clique_key) {\n-  std::optional<RankId> rank = clique_key.rank(params.global_device_id);\n-  if (!rank.has_value()) {\n-    return InvalidArgument(\"Rank not found for device %v\",\n-                           params.global_device_id);\n-  }\n-\n-  TF_ASSIGN_OR_RETURN(Communicator * comm,\n-                      collective_cliques.GetComm(clique_key, *rank));\n+  TF_ASSIGN_OR_RETURN(\n+      Communicator * comm,\n+      collective_cliques.GetComm(clique_key, params.global_device_id));\n   return CommunicatorHandle(comm, std::move(clique_key));\n }\n "
        }
    ],
    "stats": {
        "total": 32,
        "additions": 20,
        "deletions": 12
    }
}