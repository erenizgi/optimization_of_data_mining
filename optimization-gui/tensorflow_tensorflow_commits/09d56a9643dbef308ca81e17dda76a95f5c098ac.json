{
    "author": "WillFroom",
    "message": "[XLA:CPU][XTile] Add lowering for reshape.\n\nPiperOrigin-RevId: 825605674",
    "sha": "09d56a9643dbef308ca81e17dda76a95f5c098ac",
    "files": [
        {
            "sha": "01e33977a006b9540d3ef988fa7c25e95a757619",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/shlo_to_vector.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09d56a9643dbef308ca81e17dda76a95f5c098ac/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fshlo_to_vector.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09d56a9643dbef308ca81e17dda76a95f5c098ac/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fshlo_to_vector.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Fshlo_to_vector.cc?ref=09d56a9643dbef308ca81e17dda76a95f5c098ac",
            "patch": "@@ -300,16 +300,32 @@ struct LowerBroadcastInDim\n   }\n };\n \n+struct LowerReshape : mlir::OpRewritePattern<mlir::stablehlo::ReshapeOp> {\n+  using OpRewritePattern::OpRewritePattern;\n+\n+  mlir::LogicalResult matchAndRewrite(\n+      mlir::stablehlo::ReshapeOp op,\n+      mlir::PatternRewriter& rewriter) const override {\n+    auto source_vector = CastToVector(rewriter, op.getOperand());\n+    auto result_vector_type = GetVectorType(op.getType());\n+\n+    mlir::Value reshaped_vector = mlir::vector::ShapeCastOp::create(\n+        rewriter, op->getLoc(), result_vector_type, source_vector);\n+\n+    rewriter.replaceOp(op, CastToTensor(rewriter, reshaped_vector));\n+    return mlir::success();\n+  }\n+};\n+\n class ShloToVectorPass : public impl::ShloToVectorPassBase<ShloToVectorPass> {\n  public:\n   using ShloToVectorPassBase::ShloToVectorPassBase;\n \n   void runOnOperation() override {\n     mlir::MLIRContext* context = &getContext();\n     mlir::RewritePatternSet patterns(context);\n-    patterns\n-        .add<LowerTranspose, LowerDotGeneral, LowerReduce, LowerBroadcastInDim>(\n-            context);\n+    patterns.add<LowerTranspose, LowerDotGeneral, LowerReduce,\n+                 LowerBroadcastInDim, LowerReshape>(context);\n     if (mlir::failed(\n             mlir::applyPatternsGreedily(getOperation(), std::move(patterns)))) {\n       signalPassFailure();"
        },
        {
            "sha": "f12b434fd0fe8389feaa50c0d2eeefea5a9e0ddb",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/transforms/tests/shlo_to_vector.mlir",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09d56a9643dbef308ca81e17dda76a95f5c098ac/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Fshlo_to_vector.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09d56a9643dbef308ca81e17dda76a95f5c098ac/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Fshlo_to_vector.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftransforms%2Ftests%2Fshlo_to_vector.mlir?ref=09d56a9643dbef308ca81e17dda76a95f5c098ac",
            "patch": "@@ -174,3 +174,14 @@ func.func @broadcast_2D_tensor_outer(%input : tensor<4xf32>) -> tensor<4x32xf32>\n // CHECK-LABEL: @broadcast_2D_tensor_outer\n // CHECK: vector.shape_cast {{.*}} : vector<4xf32> to vector<4x1xf32>\n // CHECK: vector.broadcast {{.*}} : vector<4x1xf32> to vector<4x32xf32>\n+\n+// -----\n+\n+func.func @reshape(%input : tensor<4xf32>) -> tensor<2x1x2xf32> {\n+  %result = stablehlo.reshape %input : (tensor<4xf32>) -> tensor<2x1x2xf32>\n+  return %result : tensor<2x1x2xf32>\n+}\n+\n+// CHECK-LABEL: @reshape\n+// CHECK:vector.shape_cast {{.*}} : vector<4xf32> to vector<2x1x2xf32>\n+"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 30,
        "deletions": 3
    }
}