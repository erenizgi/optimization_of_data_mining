{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Original Value] Try to infer original value of GetTupleElement operations\n\nIf the tuple operand of an GetTupleElement instruction is a Tuple operation and the instruction does not have an original value yet, returns the original value of the corresponding tuple element instead.\n\nPiperOrigin-RevId: 827373266",
    "sha": "b05099c7e5a9fbc830e45085620024a33fb5e7c1",
    "files": [
        {
            "sha": "a13fb0540a520c17929fdcd1fe6a512cb9d31ed0",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b05099c7e5a9fbc830e45085620024a33fb5e7c1/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b05099c7e5a9fbc830e45085620024a33fb5e7c1/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc?ref=b05099c7e5a9fbc830e45085620024a33fb5e7c1",
            "patch": "@@ -6043,7 +6043,13 @@ void HloInstruction::set_output_to_operand_aliasing(\n }\n \n std::shared_ptr<OriginalValue> HloInstruction::original_value() const {\n-  return original_value_;\n+  if (original_value_ != nullptr || opcode_ != HloOpcode::kGetTupleElement) {\n+    return original_value_;\n+  }\n+  const HloInstruction* tuple = operand(0);\n+  return tuple->opcode() == HloOpcode::kTuple\n+             ? tuple->operand(tuple_index())->original_value()\n+             : nullptr;\n }\n \n void HloInstruction::set_original_value("
        },
        {
            "sha": "b70a8f1576587e76d1f115a5a93367c27f5b0ffd",
            "filename": "third_party/xla/xla/hlo/ir/hlo_original_value_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b05099c7e5a9fbc830e45085620024a33fb5e7c1/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b05099c7e5a9fbc830e45085620024a33fb5e7c1/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_original_value_test.cc?ref=b05099c7e5a9fbc830e45085620024a33fb5e7c1",
            "patch": "@@ -435,5 +435,24 @@ ENTRY main {\n   EXPECT_EQ(p0->original_value(), p1->original_value());\n }\n \n+TEST_F(OriginalValueHloTest, InferGetTupleElementOriginalValue) {\n+  const char* hlo_string = R\"(\n+HloModule test\n+\n+ENTRY main {\n+  p0 = f32[] parameter(0), origin={{\"p0\"}}\n+  p1 = f32[] parameter(1)\n+  tuple = (f32[], f32[]) tuple(p0, p1)\n+  ROOT gte = f32[] get-tuple-element(tuple), index=0\n+}\n+)\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(hlo_string));\n+  const HloInstruction* gte = module->entry_computation()->root_instruction();\n+\n+  EXPECT_NE(gte->original_value(), nullptr);\n+  EXPECT_EQ(gte->original_value()->ToString(), R\"({\"p0\"})\");\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 26,
        "deletions": 1
    }
}