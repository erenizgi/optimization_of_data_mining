{
    "author": "alekstheod",
    "message": "PR #34750: [ROCm] Split multigpu and singlegpu tests execution for nightly\n\nImported from GitHub PR https://github.com/openxla/xla/pull/34750\n\nüìù Summary of Changes\nSupport split of test execution by using ci_multi_gpu and\nci_single_gpu configs.\n\nüéØ Justification\nThis change is required for rocm internal nightly build because\nmultigpu tests shall be executed separately from the singlegpu tests\nto avoid clashes and use different run_under script which will not hide\nall the gpus.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply:  ‚ôªÔ∏è Cleanup, üß™ Tests\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nNot relevant\n\nüß™ Execution Tests:\nNot relevant\n\nCopybara import of the project:\n\n--\n87f1a49772006fbaaed97c8d9e5bc1cb9bac0f04 by Alexandros Theodoridis <atheodor@amd.com>:\n\nSplit multigpu and singlegpu tests execution for nightly\n\nMerging this change closes #34750\n\nPiperOrigin-RevId: 840205401",
    "sha": "45dadd532f8dc3a70fd11b3a947209b1b66770d8",
    "files": [
        {
            "sha": "d4d0ee515a4267574c0a0cef261033a152ddae08",
            "filename": "third_party/xla/build_tools/rocm/rocm_xla.bazelrc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45dadd532f8dc3a70fd11b3a947209b1b66770d8/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45dadd532f8dc3a70fd11b3a947209b1b66770d8/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frocm_xla.bazelrc?ref=45dadd532f8dc3a70fd11b3a947209b1b66770d8",
            "patch": "@@ -34,6 +34,17 @@ build:asan --test_env=LSAN_OPTIONS=suppressions=build_tools/rocm/lsan_ignore_lis\n build:asan --//build_tools/rocm:sanitizer=asan\n build:asan --run_under=//build_tools/rocm:sanitizer_wrapper\n \n+build:ci_single_gpu --run_under=//build_tools/rocm:parallel_gpu_execute\n+build:ci_single_gpu --flaky_test_attempts=3\n+\n+build:ci_multi_gpu --action_env=XLA_FLAGS=\"--xla_gpu_force_compilation_parallelism=16 --xla_gpu_enable_llvm_module_compilation_parallelism=true\"\n+build:ci_multi_gpu --action_env=NCCL_MAX_NCHANNELS=1\n+build:ci_multi_gpu --run_under=//build_tools/rocm:sanitizer_wrapper\n+build:ci_multi_gpu --test_sharding_strategy=disabled\n+build:ci_multi_gpu --flaky_test_attempts=3\n+build:ci_multi_gpu --experimental_guard_against_concurrent_changes\n+build:ci_multi_gpu --test_env=HIP_VISIBLE_DEVICES=0,1,2,3\n+\n test:xla_sgpu -- \\\n //xla/... \\\n -//xla/backends/gpu/collectives:gpu_clique_key_test \\"
        },
        {
            "sha": "ee30a665a48903c72d2b615f05a3acc813145c9b",
            "filename": "third_party/xla/build_tools/rocm/run_xla_ci_build.sh",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/45dadd532f8dc3a70fd11b3a947209b1b66770d8/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/45dadd532f8dc3a70fd11b3a947209b1b66770d8/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Frun_xla_ci_build.sh?ref=45dadd532f8dc3a70fd11b3a947209b1b66770d8",
            "patch": "@@ -19,11 +19,18 @@ set -e\n set -x\n \n SCRIPT_DIR=$(realpath $(dirname $0))\n-TAG_FILTERS=$($SCRIPT_DIR/rocm_tag_filters.sh),gpu,requires-gpu-amd,,-skip_rocprofiler_sdk,-no_oss,-oss_excluded,-oss_serial\n+TAG_FILTERS=$($SCRIPT_DIR/rocm_tag_filters.sh),-skip_rocprofiler_sdk,-no_oss,-oss_excluded,-oss_serial\n \n-if [ ! -d /tf/pkg ]; then\n-\tmkdir -p /tf/pkg\n-fi\n+mkdir -p /tf/pkg\n+\n+for arg in \"$@\"; do\n+    if [[ \"$arg\" == \"--config=ci_multi_gpu\" ]]; then\n+        TAG_FILTERS=\"${TAG_FILTERS},multi_gpu\"\n+    fi\n+    if [[ \"$arg\" == \"--config=ci_single_gpu\" ]]; then\n+        TAG_FILTERS=\"${TAG_FILTERS},gpu,-multi_gpu\"\n+    fi\n+done\n \n SCRIPT_DIR=$(dirname $0)\n bazel --bazelrc=\"$SCRIPT_DIR/rocm_xla_ci.bazelrc\" test \\"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 22,
        "deletions": 4
    }
}