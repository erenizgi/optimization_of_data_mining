{
    "author": "tensorflower-gardener",
    "message": "#HLODiff Broaden --ignore_shape to also apply to diff reporting.\n\nPiperOrigin-RevId: 831946284",
    "sha": "650d7453f7d6e02be1b402c762291220a147c41f",
    "files": [
        {
            "sha": "a80769523cc7fd9090a39641600acb9dbe7085cf",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/graph/hlo_gumgraph.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/650d7453f7d6e02be1b402c762291220a147c41f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fgraph%2Fhlo_gumgraph.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/650d7453f7d6e02be1b402c762291220a147c41f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fgraph%2Fhlo_gumgraph.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fgraph%2Fhlo_gumgraph.cc?ref=650d7453f7d6e02be1b402c762291220a147c41f",
            "patch": "@@ -63,7 +63,6 @@ HloPrintOptions CreateHloPrintOptions(\n     const HloGumgraphFingerprintOptions& fingerprint_options) {\n   HloPrintOptions hlo_print_options =\n       HloPrintOptions::Fingerprint()\n-          .set_include_layout_in_shapes(false)\n           .set_print_subcomputation_mode(\n               HloPrintOptions::PrintSubcomputationMode::kOff)\n           .set_print_parameter_number(false)\n@@ -137,11 +136,10 @@ absl::Status HloGumgraph::ConstructGraph(const HloModule& hlo_module) {\n \n       HloInstructionNode* node = node_and_inserted.first;\n       node->props.fingerprint = GetHloInstructionFingerprint(\n-          instruction, CreateHloPrintOptions(fingerprint_options_));\n+          instruction, CreateHloPrintOptions(fingerprint_options_)\n+                           .set_include_layout_in_shapes(false));\n       node->props.canonical_fingerprint = GetHloInstructionFingerprint(\n-          instruction, HloPrintOptions::Fingerprint()\n-                           .set_print_parameter_number(false)\n-                           .set_print_only_essential_constants(false));\n+          instruction, CreateHloPrintOptions(fingerprint_options_));\n \n       bool inline_called_computations = false;\n       switch (instruction->opcode()) {"
        },
        {
            "sha": "1bf46508a9ab3318c00b403a12daf40fdee40b5f",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/graph/hlo_gumgraph_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/650d7453f7d6e02be1b402c762291220a147c41f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fgraph%2Fhlo_gumgraph_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/650d7453f7d6e02be1b402c762291220a147c41f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fgraph%2Fhlo_gumgraph_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fgraph%2Fhlo_gumgraph_test.cc?ref=650d7453f7d6e02be1b402c762291220a147c41f",
            "patch": "@@ -235,25 +235,25 @@ ENTRY entry {\n                   /*generation=*/1,\n                   /*height=*/3, /*subgraph_fingerprint=*/10174981490612213786U,\n                   /*fingerprint=*/7968662072287666665U,\n-                  /*canonical_fingerprint=*/962574172336760684U));\n+                  /*canonical_fingerprint=*/7968662072287666665U));\n   EXPECT_THAT(entry->children[0]->props,\n               FieldsAre(\n                   /*generation=*/2,\n                   /*height=*/2, /*subgraph_fingerprint=*/12866517545790127195U,\n                   /*fingerprint=*/7968662072287666665U,\n-                  /*canonical_fingerprint=*/962574172336760684U));\n+                  /*canonical_fingerprint=*/7968662072287666665U));\n   EXPECT_THAT(entry->children[1]->props,\n               FieldsAre(\n                   /*generation=*/3,\n                   /*height=*/1, /*subgraph_fingerprint=*/3741348072536313129U,\n                   /*fingerprint=*/3741348072536313129U,\n-                  /*canonical_fingerprint=*/12841472793063608770U));\n+                  /*canonical_fingerprint=*/3741348072536313129U));\n   EXPECT_THAT(entry->children[0]->children[0]->props,\n               FieldsAre(\n                   /*generation=*/3,\n                   /*height=*/1, /*subgraph_fingerprint=*/856105463456541506U,\n                   /*fingerprint=*/856105463456541506U,\n-                  /*canonical_fingerprint=*/1668459129586447343U));\n+                  /*canonical_fingerprint=*/856105463456541506U));\n \n   EXPECT_THAT(\n       graph->AllComputationProps(),"
        },
        {
            "sha": "d22d069b8865d6fc3f06733890b4668d0b6846db",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_main.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/650d7453f7d6e02be1b402c762291220a147c41f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/650d7453f7d6e02be1b402c762291220a147c41f/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_main.cc?ref=650d7453f7d6e02be1b402c762291220a147c41f",
            "patch": "@@ -57,16 +57,15 @@ names, parameter ordering etc, layouts (in some instances).\n       bazel run hlo_diff -- \\\n         --{first_hlo_snapshot,first_hlo_proto,first_hlo_module_proto,first_hlo_text}=path/to/first/binary_proto\n         --{second_hlo_snapshot,second_hlo_proto,second_hlo_module_proto,second_hlo_text}=path/to/second/binary_proto\n-        [--ignore_shape_during_instruction_matching]\n+        [--ignore_shape]\n         [--text_output=path/to/file/to/save/text]\n         [--html_output=path/to/file/to/save/html]\n \n first and second hlo file paths are required flags. Optionally the following\n flags can be used:\n \n-If --ignore_shape_during_instruction_matching is specified, the tool ignores\n-array/tensor shapes when matching instructions allowing for more permissive\n-matches.\n+If --ignore_shape is specified, the tool ignores array/tensor shapes when\n+matching instructions and reporting diffs, allowing for more permissive matches.\n If --text_output is specified, the full diff result will be printed in text\n format and saved to the specified file.\n if --html_output is specified, the diff result will be rendered in HTML\n@@ -248,9 +247,10 @@ int main(int argc, char** argv) {\n                 \"second XLA hlo module proto to compare\"),\n       tsl::Flag(\"second_hlo_text\", &opts.second.hlo_text,\n                 \"second XLA hlo text to compare\"),\n-      tsl::Flag(\"ignore_shape_during_instruction_matching\",\n-                &opts.diff_options.fingerprint_options.ignore_shape,\n-                \"Ignore array/tensor shapes when matching instructions\"),\n+      tsl::Flag(\n+          \"ignore_shape\", &opts.diff_options.fingerprint_options.ignore_shape,\n+          \"If true, ignore array/tensor shapes when matching instructions \"\n+          \"and reporting diffs.\"),\n       tsl::Flag(\"text_output\", &opts.render_options.text_output,\n                 \"file to save diff blocks as text\"),\n       tsl::Flag(\"html_output\", &opts.render_options.html_output,"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 14,
        "deletions": 16
    }
}