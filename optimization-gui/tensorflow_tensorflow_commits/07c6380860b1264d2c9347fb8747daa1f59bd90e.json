{
    "author": "frgossen",
    "message": "[XLA:GPU] Support merging of performance tables for gemms\n\nPiperOrigin-RevId: 806384430",
    "sha": "07c6380860b1264d2c9347fb8747daa1f59bd90e",
    "files": [
        {
            "sha": "4c0372fd8ccec91d3804ac050d89140ed5444d06",
            "filename": "third_party/xla/xla/tools/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2FBUILD?ref=07c6380860b1264d2c9347fb8747daa1f59bd90e",
            "patch": "@@ -709,6 +709,7 @@ xla_test(\n         \"//xla/service/gpu/model:hlo_op_profile_proto_cc\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/tests:hlo_test_base\",\n+        \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "2553ef4f732fb72925bb9bba67500a4893f04159",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.cc?ref=07c6380860b1264d2c9347fb8747daa1f59bd90e",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n #include <array>\n #include <cstddef>\n #include <cstdint>\n+#include <iostream>\n #include <memory>\n #include <random>\n #include <string>\n@@ -496,7 +497,13 @@ absl::StatusOr<DeviceHloInstructionProfiles> MatmulPerfTableGen::Merge(\n GemmPerfTable MatmulPerfTableGen::Merge(std::vector<GemmPerfTable> tables) {\n   GemmPerfTable result;\n   for (GemmPerfTable& table : tables) {\n-    result.MergeFrom(table);\n+    for (auto& [key, entries] : *table.mutable_entries()) {\n+      if (result.entries().contains(key)) {\n+        result.mutable_entries()->at(key).MergeFrom(entries);\n+      } else {\n+        result.mutable_entries()->insert({key, entries});\n+      }\n+    }\n   }\n   return result;\n }\n@@ -638,7 +645,7 @@ absl::Status MatmulPerfTableGen::Dump(\n \n absl::Status MatmulPerfTableGen::Dump(const GemmPerfTable& table) {\n   if (config_.output.empty()) {\n-    LOG(INFO) << table.DebugString();\n+    std::cout << table.DebugString();\n     return absl::OkStatus();\n   }\n   if (absl::StrContains(config_.output, \".pbtxt\")) {"
        },
        {
            "sha": "4a24e8efe6adbd208e0ba16593f2964600f6fa9a",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen_main.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_main.cc?ref=07c6380860b1264d2c9347fb8747daa1f59bd90e",
            "patch": "@@ -276,6 +276,7 @@ int main(int argc, char* argv[]) {\n   std::string hlo_scan_path;\n   std::string merge_path;\n   bool dry_run = false;\n+  std::vector<std::string> merge_files;\n \n   std::vector<tsl::Flag> flag_list = {\n       tsl::Flag(\"b_spec\", &b_spec,\n@@ -306,6 +307,13 @@ int main(int argc, char* argv[]) {\n       tsl::Flag(\"dry_run\", &dry_run,\n                 \"For a defined search space does not perform measurements but \"\n                 \"runs everything else.\"),\n+      tsl::Flag(\n+          \"merge\",\n+          [&merge_files](std::string file) {\n+            merge_files.push_back(file);\n+            return true;\n+          },\n+          \"none\", \"Merge gemm perf tables.\"),\n   };\n   const std::string kUsageString =\n       absl::StrCat(kUsageText, \"\\n\\n\", tsl::Flags::Usage(argv[0], flag_list));\n@@ -319,6 +327,20 @@ int main(int argc, char* argv[]) {\n       b_spec, m_spec, n_spec, k_spec, dtypes, out, hlo_scan_path, dry_run);\n   MatmulPerfTableGen table_gen(std::move(cfg));\n \n+  if (!merge_files.empty()) {\n+    LOG(INFO) << \"Merging matmul perf tables...\";\n+    std::vector<xla::GemmPerfTable> tables;\n+    for (const std::string& file : merge_files) {\n+      LOG(INFO) << \"Merging in \" << file;\n+      xla::GemmPerfTable it;\n+      CHECK_OK(tsl::ReadTextOrBinaryProto(tsl::Env::Default(), file, &it));\n+      tables.push_back(it);\n+    }\n+    xla::GemmPerfTable perf_table = MatmulPerfTableGen::Merge(tables);\n+    CHECK_OK(table_gen.Dump(perf_table));\n+    return 0;\n+  }\n+\n   if (!merge_path.empty()) {\n     LOG(INFO) << \"Merging profiling data from: \" << merge_path;\n     auto profile_data = table_gen.Merge(merge_path);"
        },
        {
            "sha": "835ed8fbe01d7c9da3bf2133c144ba487b80bff9",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 19,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/07c6380860b1264d2c9347fb8747daa1f59bd90e/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_test.cc?ref=07c6380860b1264d2c9347fb8747daa1f59bd90e",
            "patch": "@@ -18,12 +18,13 @@ limitations under the License.\n #include <cstdint>\n #include <variant>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/strings/string_view.h\"\n-#include \"xla/hlo/testlib/pattern_matcher_gmock.h\"\n #include \"xla/service/gpu/model/hlo_op_profile.pb.h\"\n #include \"xla/stream_executor/device_description.h\"\n #include \"xla/tests/hlo_test_base.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"xla/xla_data.pb.h\"\n@@ -235,14 +236,6 @@ TEST_F(MatmulPerfTableGenTest, MergeGemmTables) {\n           flops { key: \"bf16xbf16->bf16\" value: 123000 }\n           flops { key: \"f32xf32->f32\" value: 456000 }\n         }\n-        entries {\n-          b: 2\n-          m: 256\n-          n: 2048\n-          k: 2048\n-          flops { key: \"bf16xbf16->bf16\" value: 789000 }\n-          flops { key: \"f32xf32->f32\" value: 123000 }\n-        }\n       }\n     }\n   )pb\";\n@@ -251,14 +244,16 @@ TEST_F(MatmulPerfTableGenTest, MergeGemmTables) {\n       key: \"sm_90\"\n       value {\n         entries {\n-          b: 1\n-          m: 1024\n+          b: 2\n+          m: 256\n           n: 2048\n-          k: 256\n-          flops { key: \"bf16xbf16->bf16\" value: 123 }\n-          flops { key: \"f32xf32->f32\" value: 456 }\n+          k: 2048\n+          flops { key: \"bf16xbf16->bf16\" value: 789000 }\n+          flops { key: \"f32xf32->f32\" value: 123000 }\n         }\n       }\n+    }\n+    entries {\n       key: \"sm_100\"\n       value {\n         entries {\n@@ -281,8 +276,8 @@ TEST_F(MatmulPerfTableGenTest, MergeGemmTables) {\n           m: 1024\n           n: 2048\n           k: 256\n-          flops { key: \"bf16xbf16->bf16\" value: 123 }\n-          flops { key: \"f32xf32->f32\" value: 456 }\n+          flops { key: \"bf16xbf16->bf16\" value: 123000 }\n+          flops { key: \"f32xf32->f32\" value: 456000 }\n         }\n         entries {\n           b: 2\n@@ -293,6 +288,8 @@ TEST_F(MatmulPerfTableGenTest, MergeGemmTables) {\n           flops { key: \"f32xf32->f32\" value: 123000 }\n         }\n       }\n+    }\n+    entries {\n       key: \"sm_100\"\n       value {\n         entries {\n@@ -307,11 +304,14 @@ TEST_F(MatmulPerfTableGenTest, MergeGemmTables) {\n     }\n   )pb\";\n   GemmPerfTable old_perf_table;\n-  old_perf_table.ParseFromString(kGemmTableOld);\n+  EXPECT_TRUE(tsl::protobuf::TextFormat::ParseFromString(kGemmTableOld,\n+                                                         &old_perf_table));\n   GemmPerfTable new_perf_table;\n-  new_perf_table.ParseFromString(kGemmTableNew);\n+  ASSERT_TRUE(tsl::protobuf::TextFormat::ParseFromString(kGemmTableNew,\n+                                                         &new_perf_table));\n   GemmPerfTable expected_merged_perf_table;\n-  expected_merged_perf_table.ParseFromString(kGemmTableExpected);\n+  ASSERT_TRUE(tsl::protobuf::TextFormat::ParseFromString(\n+      kGemmTableExpected, &expected_merged_perf_table));\n   GemmPerfTable actual_merged_perf_table =\n       MatmulPerfTableGen::Merge({old_perf_table, new_perf_table});\n   EXPECT_THAT(expected_merged_perf_table,"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 51,
        "deletions": 21
    }
}