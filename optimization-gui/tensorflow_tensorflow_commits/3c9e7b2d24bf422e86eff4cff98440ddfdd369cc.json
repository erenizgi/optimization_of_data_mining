{
    "author": "ezhulenev",
    "message": "[xla:cpu] Move GetDeviceOrdinal to cpu_executable\n\nPreparing for removing mostly unused cpu_runtime.h\n\nPiperOrigin-RevId: 828490766",
    "sha": "3c9e7b2d24bf422e86eff4cff98440ddfdd369cc",
    "files": [
        {
            "sha": "74c78a121cec48d96301256340a415e4273a38e4",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc?ref=3c9e7b2d24bf422e86eff4cff98440ddfdd369cc",
            "patch": "@@ -51,7 +51,6 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_module_metadata.h\"\n #include \"xla/service/buffer_assignment.h\"\n-#include \"xla/service/cpu/cpu_runtime.h\"\n #include \"xla/service/custom_call_status.h\"\n #include \"xla/service/custom_call_status_internal.h\"\n #include \"xla/service/executable.h\"\n@@ -228,6 +227,16 @@ CpuExecutable::CreateBufferTable(se::DeviceMemoryAllocator* memory_allocator,\n   return std::move(buffers);\n }\n \n+static int32_t GetDeviceOrdinal(const ExecutableRunOptions* run_options) {\n+  if (!run_options) {\n+    return 0;\n+  }\n+  if (run_options->device_ordinal() != -1) {\n+    return run_options->device_ordinal();\n+  }\n+  return run_options->stream()->parent()->device_ordinal();\n+}\n+\n absl::Status CpuExecutable::ExecuteThunks(\n     const ExecutableRunOptions* run_options,\n     absl::Span<MaybeOwningDeviceMemory const> buffers) {\n@@ -273,7 +282,7 @@ absl::Status CpuExecutable::ExecuteThunks(\n   Thunk::ExecuteParams execute_params = {\n       &*function_library_,\n       &allocations,\n-      GetXfeedManager(runtime::GetDeviceOrdinal(run_options)),\n+      GetXfeedManager(GetDeviceOrdinal(run_options)),\n       intra_op_thread_pool,\n       &task_runner,\n       &collective_execute_params,"
        },
        {
            "sha": "d2722faab2a2b4cd6e8fd071492f497e70a9bc85",
            "filename": "third_party/xla/xla/service/cpu/cpu_runtime.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime.cc?ref=3c9e7b2d24bf422e86eff4cff98440ddfdd369cc",
            "patch": "@@ -71,17 +71,6 @@ namespace xla {\n namespace cpu {\n namespace runtime {\n \n-// TODO(zhangqiaorjc): Prefer to make callers set and use device_ordinal\n-// directly since callers may not have a Stream*.\n-int GetDeviceOrdinal(const xla::ExecutableRunOptions* run_options) {\n-  if (!run_options) {\n-    return 0;\n-  } else if (run_options->device_ordinal() != -1) {\n-    return run_options->device_ordinal();\n-  }\n-  return run_options->stream()->parent()->device_ordinal();\n-}\n-\n extern const char* const kEigenMatMulF16SymbolName =\n     \"__xla_cpu_runtime_EigenMatMulF16\";\n extern const char* const kEigenMatMulF32SymbolName ="
        },
        {
            "sha": "2131c3224acbc676d8d51f97ddc0f1f618d5edc0",
            "filename": "third_party/xla/xla/service/cpu/cpu_runtime.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime.h?ref=3c9e7b2d24bf422e86eff4cff98440ddfdd369cc",
            "patch": "@@ -95,8 +95,6 @@ extern const char* const kHandleFfiCallSymbolName;\n // prefix.\n extern const char* const kXlaCpuRuntimeSymbolNamePrefix;\n \n-int GetDeviceOrdinal(const xla::ExecutableRunOptions* run_options);\n-\n }  // namespace runtime\n }  // namespace cpu\n }  // namespace xla"
        },
        {
            "sha": "04d9439ff534eff71b232c8460a0ab544047a12a",
            "filename": "third_party/xla/xla/service/cpu/cpu_runtime_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3c9e7b2d24bf422e86eff4cff98440ddfdd369cc/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_runtime_test.cc?ref=3c9e7b2d24bf422e86eff4cff98440ddfdd369cc",
            "patch": "@@ -183,29 +183,5 @@ TEST_F(CpuRuntimeTest, FailureStatus) {\n   ASSERT_FALSE(__xla_cpu_runtime_StatusIsSuccess(&success_status));\n }\n \n-// When run_options is null, the process should not crash and the device ordinal\n-// should be 0.\n-TEST_F(CpuRuntimeTest, GetDeviceOrdinalWhenRunOptionsEmpty) {\n-  EXPECT_EQ(cpu::runtime::GetDeviceOrdinal(/*run_options=*/nullptr), 0);\n-}\n-\n-// When the device ordinal is set directly in run options, it should be returned\n-// (and NOT the value from stream).\n-TEST_F(CpuRuntimeTest, GetDeviceOrdinalWhenSetInRunOptions) {\n-  // GetDeviceOrdinal implementation bases on the fact that device ordinal is\n-  // -1 by default. So we need to assert for that here to avoid crash in case\n-  // the default value changes in the future.\n-  ExecutableRunOptions run_options;\n-  ASSERT_EQ(run_options.device_ordinal(), -1);\n-\n-  // Actual test - set device ordinal in run options and check that it is\n-  // returned.\n-  run_options.set_device_ordinal(3);\n-  EXPECT_EQ(cpu::runtime::GetDeviceOrdinal(&run_options), 3);\n-}\n-\n-// TODO(abanas): Add test case for the device ordinal with stream case. It\n-// requires mocking the stream and stream executor.\n-\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 11,
        "deletions": 39
    }
}