{
    "author": "tensorflower-gardener",
    "message": "Fix nontrivial-memcall DoRollWithMemcpy w/ constexpr\n\nInvoking memcpy with a nontrivial datatype T is\nundefined behavior. This is caught by -Wnontrivial-memcall correctly,\nwhich has been expanded to identify such cases. Introduce a\ncompile-time check to ensure that we don't cause undefined behavior\nwhen we call DoRollWithMemcpy with T=tsl::string\n\nPiperOrigin-RevId: 816784592",
    "sha": "d1f820fbcb6864eeb4404174610f4eb5162406b9",
    "files": [
        {
            "sha": "d739d3e49ccd0f5d6fbbb0b4b6db85aebdf56686",
            "filename": "tensorflow/core/kernels/roll_op.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d1f820fbcb6864eeb4404174610f4eb5162406b9/tensorflow%2Fcore%2Fkernels%2Froll_op.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d1f820fbcb6864eeb4404174610f4eb5162406b9/tensorflow%2Fcore%2Fkernels%2Froll_op.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fkernels%2Froll_op.cc?ref=d1f820fbcb6864eeb4404174610f4eb5162406b9",
            "patch": "@@ -257,7 +257,13 @@ void DoRollWithMemcpy(const OpKernelContext* context,\n     int64_t i = start;\n     while (i < end) {\n       // copy group of elements\n-      memcpy(out_ptr, in_ptr, group_size * sizeof(T));\n+      if constexpr (DataTypeCanUseMemcpy(DataTypeToEnum<T>::v())) {\n+        memcpy(out_ptr, in_ptr, group_size * sizeof(T));\n+      } else {\n+        for (int64_t k = 0; k < group_size; ++k) {\n+          *out_ptr++ = *in_ptr++;\n+        }\n+      }\n \n       // shift i and the pointers over to the next group position\n       i += group_size;"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}