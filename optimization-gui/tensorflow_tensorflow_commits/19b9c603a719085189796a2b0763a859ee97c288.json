{
    "author": "tensorflower-gardener",
    "message": "Allow annotations to be appended or prepended in AnnotatedUserContext.\n\nFor some annotations, it is more user-friendly to print the annotation\nbefore the annotated context. Add an option for this and remove the\nautomatic \"; \" delimiter to allow more flexibility in the annotation\nformat.\n\nPiperOrigin-RevId: 818118289",
    "sha": "19b9c603a719085189796a2b0763a859ee97c288",
    "files": [
        {
            "sha": "2d87bf87431e829c26e30b97e5772b8bcd761eb8",
            "filename": "third_party/xla/xla/python/ifrt/user_context.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/19b9c603a719085189796a2b0763a859ee97c288/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/19b9c603a719085189796a2b0763a859ee97c288/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.cc?ref=19b9c603a719085189796a2b0763a859ee97c288",
            "patch": "@@ -50,21 +50,30 @@ ABSL_CONST_INIT thread_local\n absl_nonnull UserContextRef\n AnnotatedUserContext::Create(UserContextRef user_context, std::string msg) {\n   return tsl::MakeRef<AnnotatedUserContext>(std::move(user_context),\n-                                            std::move(msg));\n+                                            std::move(msg), kAfter);\n+}\n+\n+absl_nonnull UserContextRef\n+AnnotatedUserContext::Create(std::string msg, UserContextRef user_context) {\n+  return tsl::MakeRef<AnnotatedUserContext>(std::move(user_context),\n+                                            std::move(msg), kBefore);\n }\n \n AnnotatedUserContext::AnnotatedUserContext(UserContextRef user_context,\n-                                           std::string msg)\n+                                           std::string msg,\n+                                           MessagePosition msg_position)\n     : id_(tsl::random::ThreadLocalNew64()),\n       user_context_(std::move(user_context)),\n-      msg_(std::move(msg)) {}\n+      msg_(std::move(msg)),\n+      msg_position_(msg_position) {}\n \n UserContextId AnnotatedUserContext::Id() const { return id_; }\n \n std::string AnnotatedUserContext::DebugString() const {\n-  return absl::StrCat(\n-      (user_context_ ? user_context_->DebugString() : \"(nullptr user context)\"),\n-      \"; \", msg_);\n+  const std::string context_str =\n+      user_context_ ? user_context_->DebugString() : \"(nullptr user context)\";\n+  return msg_position_ == kBefore ? absl::StrCat(msg_, context_str)\n+                                  : absl::StrCat(context_str, msg_);\n }\n \n absl_nonnull UserContextRef"
        },
        {
            "sha": "481f268427f1b5c0f265228df0e5cb313a9d8b19",
            "filename": "third_party/xla/xla/python/ifrt/user_context.h",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/19b9c603a719085189796a2b0763a859ee97c288/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/19b9c603a719085189796a2b0763a859ee97c288/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context.h?ref=19b9c603a719085189796a2b0763a859ee97c288",
            "patch": "@@ -75,9 +75,16 @@ using UserContextRef = tsl::RCReference<UserContext>;\n class AnnotatedUserContext\n     : public llvm::RTTIExtends<AnnotatedUserContext, UserContext> {\n  public:\n+  // `DebugString()` will contain `msg` appended to `user_context`'s\n+  // debug string (with no delimiter in between).\n   static absl_nonnull UserContextRef Create(UserContextRef user_context,\n                                             std::string msg);\n \n+  // Like the above, but `DebugString()` prepends `msg` to\n+  // `user_context`'s debug string.\n+  static absl_nonnull UserContextRef Create(std::string msg,\n+                                            UserContextRef user_context);\n+\n   const UserContextRef& user_context() const { return user_context_; }\n   absl::string_view msg() const { return msg_; }\n \n@@ -92,11 +99,19 @@ class AnnotatedUserContext\n   template <typename T, typename... Args>\n   friend tsl::RCReference<T> tsl::MakeRef(Args&&... args);\n \n-  explicit AnnotatedUserContext(UserContextRef user_context, std::string msg);\n+  enum MessagePosition {\n+    kBefore,\n+    kAfter,\n+  };\n+\n+  explicit AnnotatedUserContext(UserContextRef user_context, std::string msg,\n+                                MessagePosition msg_position);\n \n   UserContextId id_;\n   UserContextRef user_context_;\n   std::string msg_;\n+\n+  MessagePosition msg_position_;\n };\n \n // `ChainedUserContext` represents a chain of `UserContext`s of the operations,"
        },
        {
            "sha": "46e96e52b8e9c26875b59856d30fa7721cdd3613",
            "filename": "third_party/xla/xla/python/ifrt/user_context_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/19b9c603a719085189796a2b0763a859ee97c288/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/19b9c603a719085189796a2b0763a859ee97c288/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_test.cc?ref=19b9c603a719085189796a2b0763a859ee97c288",
            "patch": "@@ -35,15 +35,15 @@ TEST(AnnotatedUserContextTest, Id) {\n   UserContextRef context = TestUserContext::Create(kUserContextId);\n \n   UserContextRef annotated_context1 =\n-      AnnotatedUserContext::Create(context, \"test annotation\");\n+      AnnotatedUserContext::Create(context, \"; test annotation\");\n   EXPECT_NE(annotated_context1->Id(), context->Id());\n \n   UserContextRef annotated_context2 =\n-      AnnotatedUserContext::Create(context, \"test annotation 2\");\n+      AnnotatedUserContext::Create(context, \"; test annotation 2\");\n   EXPECT_NE(annotated_context2->Id(), annotated_context1->Id());\n \n   UserContextRef annotated_context3 =\n-      AnnotatedUserContext::Create(UserContextRef(), \"test annotation\");\n+      AnnotatedUserContext::Create(UserContextRef(), \"; test annotation\");\n   EXPECT_NE(annotated_context3->Id(), annotated_context1->Id());\n }\n \n@@ -52,13 +52,21 @@ TEST(AnnotatedUserContextTest, DebugString) {\n     const UserContextId kUserContextId(100);\n     UserContextRef context = TestUserContext::Create(kUserContextId);\n     UserContextRef annotated_context =\n-        AnnotatedUserContext::Create(context, \"test annotation\");\n+        AnnotatedUserContext::Create(context, \"; test annotation\");\n     EXPECT_EQ(annotated_context->DebugString(),\n               \"TestUserContext(100); test annotation\");\n   }\n+  {\n+    const UserContextId kUserContextId(200);\n+    UserContextRef context = TestUserContext::Create(kUserContextId);\n+    UserContextRef annotated_context =\n+        AnnotatedUserContext::Create(\"test annotation: \", context);\n+    EXPECT_EQ(annotated_context->DebugString(),\n+              \"test annotation: TestUserContext(200)\");\n+  }\n   {\n     UserContextRef annotated_context =\n-        AnnotatedUserContext::Create(UserContextRef(), \"test annotation\");\n+        AnnotatedUserContext::Create(UserContextRef(), \"; test annotation\");\n     EXPECT_EQ(annotated_context->DebugString(),\n               \"(nullptr user context); test annotation\");\n   }"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 44,
        "deletions": 12
    }
}