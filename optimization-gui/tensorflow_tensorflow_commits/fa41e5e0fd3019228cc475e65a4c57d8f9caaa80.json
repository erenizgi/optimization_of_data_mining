{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Value Tracking] Print the entire recovery module when printing the original value recovery table\n\nCurrently we only print the entry computation of the recovery module in the HLO original value recovery table. But some recovery modules may have more than one computation, e.g. when such a module includes an all-reduce op, and we need to include the reduction computation in the module as well. This change prints all the computations in a recovery module.\n\nPiperOrigin-RevId: 814548388",
    "sha": "fa41e5e0fd3019228cc475e65a4c57d8f9caaa80",
    "files": [
        {
            "sha": "53c7f414b594f1050c232a6968200bcb9db40ddc",
            "filename": "third_party/xla/xla/hlo/ir/hlo_module.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_module.cc?ref=fa41e5e0fd3019228cc475e65a4c57d8f9caaa80",
            "patch": "@@ -351,6 +351,8 @@ void HloModule::ReplaceComputations(\n void HloModule::Print(\n     Printer* printer, const HloPrintOptions& options,\n     const absl::btree_map<std::string, NumericOrString>& custom_fields) const {\n+  const std::string tab(2 * options.indent_amount(), ' ');\n+  printer->Append(tab);\n   printer->Append(\"HloModule \");\n   if (options.print_ids()) {\n     // When print_ids() is false, exclude module's name because it includes and\n@@ -1508,14 +1510,11 @@ std::string HloModule::OriginalValueRecoveryTable::ToString(\n     const std::string tab(2 * (options.indent_amount()), ' ');\n     std::string recovery_module_string;\n     if (recovery_module) {\n-      absl::StrAppend(&recovery_module_string, \",\\n\", tab, \"\\\"\\n\",\n-                      recovery_module->entry_computation()->ToString(\n-                          HloPrintOptions()\n-                              .set_print_computation_mode(\n-                                  HloPrintOptions::PrintComputationMode::\n-                                      kComputationWithEntryKeyword)\n-                              .set_indent_amount(options.indent_amount() + 1)),\n-                      \"\\n\", tab, \"\\\"\");\n+      absl::StrAppend(\n+          &recovery_module_string, \",\\n\", tab, \"\\\"\\n\",\n+          recovery_module->ToString(\n+              HloPrintOptions().set_indent_amount(options.indent_amount() + 1)),\n+          \"\\n\", tab, \"\\\"\");\n     }\n     absl::StrAppend(&result, tab, \"{\", old_original_array.ToString(), \"} : {\",\n                     new_original_array.ToString(), \"}\", recovery_module_string,"
        },
        {
            "sha": "3d6ef2c0b18d7b96859206cf13ccc948ddceae6a",
            "filename": "third_party/xla/xla/hlo/parser/hlo_parser_test.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 9,
            "changes": 58,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser_test.cc?ref=fa41e5e0fd3019228cc475e65a4c57d8f9caaa80",
            "patch": "@@ -1561,21 +1561,61 @@ ENTRY %test (v1: f32[]) -> f32[] {\n \n {\n \"OriginalValueRecoveryTable\",\n-R\"(HloModule test, entry_computation_layout={(f32[192]{0})->f32[1,17,17,192]{3,2,1,0}}, origin_recovery_table={\n-  {\"broadcast.2340\"} : {\"reshape.2341\"}\n-  {\"reshape.2341\"} : {\"placeholder_reshape.201\"},\n+R\"(HloModule module, entry_computation_layout={()->s32[1,3]{1,0}}, num_partitions=2, origin_recovery_table={\n+  {\"constant\"} : {\"constant__ovp0\"},\n   \"\n-    ENTRY %recovery_computation.3 (p.1: f32[192]) -> f32[1,192] {\n-      %p.1 = f32[192]{0} parameter(0)\n-      ROOT %reshape.2 = f32[1,192]{1,0} reshape(%p.1)\n+    HloModule recovery_module, entry_computation_layout={(s32[2,3]{1,0})->s32[2,3]{1,0}}\n+\n+    %add (x: s32[], y: s32[]) -> s32[] {\n+      %x = s32[] parameter(0)\n+      %y = s32[] parameter(1)\n+      ROOT %add = s32[] add(%x, %y)\n+    }\n+\n+    %add.clone (x.1: s32[], y.1: s32[]) -> s32[] {\n+      %x.1 = s32[] parameter(0)\n+      %y.1 = s32[] parameter(1)\n+      ROOT %add.1 = s32[] add(%x.1, %y.1)\n     }\n+\n+    ENTRY %recovery_computation (param: s32[2,3]) -> s32[2,3] {\n+      %partition-id = u32[] partition-id()\n+      %constant = u32[] constant(0)\n+      %compare = pred[] compare(%partition-id, %constant), direction=EQ\n+      %broadcast = pred[2,3]{1,0} broadcast(%compare), dimensions={}\n+      %param = s32[2,3]{1,0} parameter(0), sharding={maximal device=0}\n+      %constant.1 = s32[] constant(0)\n+      %broadcast.1 = s32[2,3]{1,0} broadcast(%constant.1), dimensions={}\n+      %select = s32[2,3]{1,0} select(%broadcast, %param, %broadcast.1)\n+      ROOT %all-reduce = s32[2,3]{1,0} all-reduce(%select), channel_id=1, replica_groups={{0,1}}, use_global_device_ids=true, to_apply=%add.clone, sharding={replicated}\n+    }\n+\n+\n   \"\n }\n \n \n-ENTRY %main (Arg_0: f32[192]) -> f32[1,17,17,192] {\n-  %Arg_0 = f32[192]{0} parameter(0)\n-  ROOT %broadcast.2342 = f32[1,17,17,192]{3,2,1,0} broadcast(f32[192]{0} %Arg_0), dimensions={3}, origin={{\"broadcast.2342\"}}\n+%add.clone (x.1: s32[], y.1: s32[]) -> s32[] {\n+  %x.1 = s32[] parameter(0)\n+  %y.1 = s32[] parameter(1)\n+  ROOT %add.1 = s32[] add(s32[] %x.1, s32[] %y.1)\n+}\n+\n+ENTRY %entry_spmd () -> s32[1,3] {\n+  %partition-id = u32[] partition-id()\n+  %constant.2 = u32[] constant(0)\n+  %compare = pred[] compare(u32[] %partition-id, u32[] %constant.2), direction=EQ\n+  %broadcast = pred[2,3]{1,0} broadcast(pred[] %compare), dimensions={}\n+  %constant.1 = s32[2,3]{1,0} constant({ { 1, 1, 1 }, { 1, 1, 1 } }), origin={{\"constant__ovp0\"}}\n+  %constant.3 = s32[] constant(0)\n+  %broadcast.1 = s32[2,3]{1,0} broadcast(s32[] %constant.3), dimensions={}\n+  %select = s32[2,3]{1,0} select(pred[2,3]{1,0} %broadcast, s32[2,3]{1,0} %constant.1, s32[2,3]{1,0} %broadcast.1)\n+  %all-reduce = s32[2,3]{1,0} all-reduce(s32[2,3]{1,0} %select), channel_id=1, replica_groups={{0,1}}, use_global_device_ids=true, to_apply=%add.clone\n+  %constant.4 = s32[2]{0} constant({1, 0})\n+  %dynamic-slice = s32[1]{0} dynamic-slice(s32[2]{0} %constant.4, u32[] %partition-id), dynamic_slice_sizes={1}\n+  %reshape = s32[] reshape(s32[1]{0} %dynamic-slice)\n+  %dynamic-slice.1 = s32[1,3]{1,0} dynamic-slice(s32[2,3]{1,0} %all-reduce, s32[] %reshape, s32[] %constant.3), dynamic_slice_sizes={1,3}\n+  ROOT %copy.1 = s32[1,3]{1,0} copy(s32[1,3]{1,0} %dynamic-slice.1)\n }\n \n )\""
        },
        {
            "sha": "05b01d09e4bd8cf2e9c7a7e8a082ba566e63df1d",
            "filename": "third_party/xla/xla/service/propagate_original_value_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fservice%2Fpropagate_original_value_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fservice%2Fpropagate_original_value_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fpropagate_original_value_test.cc?ref=fa41e5e0fd3019228cc475e65a4c57d8f9caaa80",
            "patch": "@@ -233,11 +233,11 @@ TEST_F(OriginalValueRecoveryTableTest,\n // CHECK:      HloModule test, entry_computation_layout={((f32[5]{0}, f32[5]{0}))->f32[1,2,3,5,1]{4,3,2,1,0}}, origin_recovery_table={\n // CHECK-NEXT:   {\"reshape\"} : {\"reshape__ovp0\"},\n // CHECK-NEXT:   \"\n-// CHECK-NEXT:     ENTRY %recovery_computation (p: f32[5]) -> f32[1,5,1] {\n+// CHECK:          ENTRY %recovery_computation (p: f32[5]) -> f32[1,5,1] {\n // CHECK-NEXT:       %p = f32[5]{0} parameter(0)\n // CHECK-NEXT:       ROOT %reshape = f32[1,5,1]{2,1,0} reshape(%p)\n // CHECK-NEXT:     }\n-// CHECK-NEXT:   \"\n+// CHECK:        \"\n // CHECK-NEXT: }\n // CHECK:      ENTRY %main (param: (f32[5], f32[5])) -> f32[1,2,3,5,1] {\n // CHECK-NEXT:   %param = (f32[5]{0}, f32[5]{0}) parameter(0)"
        },
        {
            "sha": "2e58040aeb84c0771d66a1bbc35d422eba38df86",
            "filename": "third_party/xla/xla/service/spmd/shardy/shardy_xla_pass_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa41e5e0fd3019228cc475e65a4c57d8f9caaa80/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass_test.cc?ref=fa41e5e0fd3019228cc475e65a4c57d8f9caaa80",
            "patch": "@@ -1092,11 +1092,11 @@ TEST_F(ShardyXLATest, PreserveOriginalValueRecoveryTable) {\n   const char* const expected = R\"(\n   // CHECK:       {\"reshape.2341\"} : {\"placeholder_reshape.201\"},\n   // CHECK-NEXT:  \"\n-  // CHECK-NEXT:    ENTRY %recovery_computation.1 (p.1: f32[192]) -> f32[1,192] {\n+  // CHECK:       ENTRY %recovery_computation.1 (p.1: f32[192]) -> f32[1,192] {\n   // CHECK-NEXT:      %p.1 = f32[192]{0} parameter(0)\n   // CHECK-NEXT:      ROOT %reshape.2 = f32[1,192]{1,0} reshape(%p.1)\n   // CHECK-NEXT:    }\n-  // CHECK-NEXT:  \"\n+  // CHECK:       \"\n   )\";\n \n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 60,
        "deletions": 21
    }
}