{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Implement ceilDiv for negative divisors in SymbolicExpr.\n\nPiperOrigin-RevId: 797708012",
    "sha": "eb5b8363509441213e579815730244705ba5ed76",
    "files": [
        {
            "sha": "d60899d70ab5fd5e57b0123d1ede96d8f5641687",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/eb5b8363509441213e579815730244705ba5ed76/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/eb5b8363509441213e579815730244705ba5ed76/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=eb5b8363509441213e579815730244705ba5ed76",
            "patch": "@@ -461,7 +461,7 @@ SymbolicExpr CanonicalizeCeilDiv(SymbolicExpr lhs, SymbolicExpr rhs) {\n     if (divisor > 0) {\n       return ((lhs + divisor - 1).Canonicalize()).floorDiv(rhs).Canonicalize();\n     }\n-    // TODO(b/433693793): Handle negative divisor for ceildiv.\n+    return (-(lhs.floorDiv(-divisor))).Canonicalize();\n   }\n \n   return ctx->CreateBinaryOp(SymbolicExprType::kCeilDiv, lhs, rhs);\n@@ -743,13 +743,11 @@ SymbolicExpr SymbolicExpr::operator+(int64_t v) const {\n   return *this + GetContext()->CreateConstant(v);\n }\n SymbolicExpr SymbolicExpr::operator+(SymbolicExpr other) const {\n-  // TODO(b/433693793): This should be modified when we introduce the\n-  // simplification logic.\n   return GetContext()->CreateBinaryOp(SymbolicExprType::kAdd, *this, other);\n }\n \n SymbolicExpr SymbolicExpr::operator-() const {\n-  return *this * GetContext()->CreateConstant(-1);\n+  return (*this * GetContext()->CreateConstant(-1)).Canonicalize();\n }\n SymbolicExpr SymbolicExpr::operator-(int64_t v) const { return *this + (-v); }\n SymbolicExpr SymbolicExpr::operator-(SymbolicExpr other) const {"
        },
        {
            "sha": "911f63b65047439f09cbaf4764c908d2339a3a6d",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/eb5b8363509441213e579815730244705ba5ed76/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/eb5b8363509441213e579815730244705ba5ed76/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc?ref=eb5b8363509441213e579815730244705ba5ed76",
            "patch": "@@ -137,8 +137,8 @@ TEST_F(SymbolicExprTest, Canonicalization_Basic) {\n   SymbolicExpr add_combining_constants = (c2 + v0) + 3;\n   EXPECT_EQ(add_combining_constants.Canonicalize().ToString(), \"(v0 + 5)\");\n \n-  SymbolicExpr mul_combining_constants = (c2 * v0) * 3;\n-  EXPECT_EQ(mul_combining_constants.Canonicalize().ToString(), \"(v0 * 6)\");\n+  SymbolicExpr mul_combining_constants = (c2 * v0) * -1;\n+  EXPECT_EQ(mul_combining_constants.Canonicalize().ToString(), \"(v0 * -2)\");\n \n   SymbolicExpr combination = (v0 * 3) + (v0 * 2);\n   EXPECT_EQ(combination.Canonicalize().ToString(), \"(v0 * 5)\");\n@@ -201,6 +201,13 @@ TEST_F(SymbolicExprTest, Canonicalization_DivMod) {\n \n   EXPECT_EQ(((v0 * 8) % 4).Canonicalize().ToString(), \"0\");\n   EXPECT_EQ(((v0 * 8 + 3) % 4).Canonicalize().ToString(), \"3\");\n+\n+  // Test ceilDiv with negative divisor.\n+  EXPECT_EQ((v0.ceilDiv(-1)).Canonicalize().ToString(), \"(v0 * -1)\");\n+  EXPECT_EQ((v0.ceilDiv(-2)).Canonicalize().ToString(),\n+            \"((v0 floordiv 2) * -1)\");\n+  EXPECT_EQ(((v0 * 6).floorDiv(-3)).Canonicalize().ToString(), \"(v0 * -2)\");\n+  EXPECT_EQ(((v0 * 6).ceilDiv(-3)).Canonicalize().ToString(), \"(v0 * -2)\");\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 11,
        "deletions": 6
    }
}