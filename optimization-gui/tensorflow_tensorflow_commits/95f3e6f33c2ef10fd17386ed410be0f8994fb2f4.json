{
    "author": "felixwqp",
    "message": "[XLA:GPU]: Refactor the unit test of matmul_interpolator_test.cc to prepare for adding the mix-precision fp8 unit test.\n\nPiperOrigin-RevId: 822239646",
    "sha": "95f3e6f33c2ef10fd17386ed410be0f8994fb2f4",
    "files": [
        {
            "sha": "aa6f42c9b6a9585bec5d76cb42b50ed80c4ad578",
            "filename": "third_party/xla/xla/service/gpu/model/matmul_interpolator_test.cc",
            "status": "modified",
            "additions": 155,
            "deletions": 94,
            "changes": 249,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/95f3e6f33c2ef10fd17386ed410be0f8994fb2f4/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/95f3e6f33c2ef10fd17386ed410be0f8994fb2f4/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fmatmul_interpolator_test.cc?ref=95f3e6f33c2ef10fd17386ed410be0f8994fb2f4",
            "patch": "@@ -58,9 +58,49 @@ struct DotSpec {\n   int m;\n   int n;\n   int k;\n+  absl::string_view lhs_type;\n+  absl::string_view rhs_type;\n+  absl::string_view result_type;\n   int64_t clock_cycles;\n };\n \n+absl::StatusOr<DotContext> Dot(int b, int m, int n, int k,\n+                               absl::string_view lhs_type,\n+                               absl::string_view rhs_type,\n+                               absl::string_view result_type) {\n+  absl::string_view kTemplate = R\"(\n+    HloModule m\n+\n+    ENTRY r {\n+      lhs = $4[$0,$1,$2] parameter(0)\n+      rhs = $5[$0,$2,$3] parameter(1)\n+      ROOT _ = $6[$0,$1,$3] dot(lhs,rhs),\n+       lhs_contracting_dims={2}, rhs_contracting_dims={1},\n+       lhs_batch_dims={0}, rhs_batch_dims={0}\n+    })\";\n+  TF_ASSIGN_OR_RETURN(\n+      auto module,\n+      ParseAndReturnUnverifiedModule(absl::Substitute(\n+          kTemplate, b, m, k, n, lhs_type, rhs_type, result_type)));\n+  return DotContext{\n+      /*dot=*/module->entry_computation()->root_instruction(),\n+      /*module=*/std::move(module),\n+  };\n+}\n+\n+// Generates a Dot HLO instruction with S8 data type.\n+absl::StatusOr<DotContext> DotS8(int b, int m, int n, int k) {\n+  // Template uses $0=b, $1=m, $2=k, $3=n for dimensions.\n+  return Dot(b, m, n, k, /*lhs_type=*/\"s8\", /*rhs_type=*/\"s8\",\n+             /*result_type=*/\"s8\");\n+}\n+\n+// Generates a Dot HLO instruction with BF16 data type.\n+absl::StatusOr<DotContext> DotBF16(int b, int m, int n, int k) {\n+  return Dot(b, m, n, k, /*lhs_type=*/\"bf16\", /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\");\n+}\n+\n struct ParametrizedTestCase {\n   std::string test_name;\n   DotSpec spec;\n@@ -83,26 +123,6 @@ class MatmulInterpolatorParamTest : public TestWithParam<ParametrizedTestCase> {\n   }\n \n  protected:\n-  absl::StatusOr<DotContext> Dot(int b, int m, int n, int k) {\n-    absl::string_view kTemplate = R\"(\n-    HloModule m\n-\n-    ENTRY r {\n-      lhs = f32[$0,$1,$2] parameter(0)\n-      rhs = f32[$0,$2,$3] parameter(1)\n-      ROOT _ = f32[$0,$1,$3] dot(lhs,rhs),\n-       lhs_contracting_dims={2}, rhs_contracting_dims={1},\n-       lhs_batch_dims={0}, rhs_batch_dims={0}\n-    })\";\n-    TF_ASSIGN_OR_RETURN(auto module,\n-                        ParseAndReturnUnverifiedModule(\n-                            absl::Substitute(kTemplate, b, m, k, n)));\n-    return DotContext{\n-        /*dot=*/module->entry_computation()->root_instruction(),\n-        /*module=*/std::move(module),\n-    };\n-  }\n-\n   void AddProfileEntry(DotContext dot_context, int64_t clock_cycles,\n                        HloInstructionProfileList& list) {\n     HloInstructionProfile profile;\n@@ -118,7 +138,8 @@ class MatmulInterpolatorParamTest : public TestWithParam<ParametrizedTestCase> {\n     HloInstructionProfileList list;\n     for (DotSpec spec : specs) {\n       TF_ASSIGN_OR_RETURN(DotContext dot_context,\n-                          Dot(spec.b, spec.m, spec.n, spec.k));\n+                          Dot(spec.b, spec.m, spec.n, spec.k, spec.lhs_type,\n+                              spec.rhs_type, spec.result_type));\n       AddProfileEntry(std::move(dot_context), spec.clock_cycles, list);\n     }\n     return list;\n@@ -138,34 +159,49 @@ class MatmulInterpolatorParamTest : public TestWithParam<ParametrizedTestCase> {\n           /*m=*/256,\n           /*n=*/1024,\n           /*k=*/512,\n+          /*lhs_type=*/\"f32\",\n+          /*rhs_type=*/\"f32\",\n+          /*result_type=*/\"f32\",\n           /*clock_cycles=*/ClockCycles(absl::Seconds(1)),\n       },\n       DotSpec{\n           /*b=*/1,\n           /*m=*/256,\n           /*n=*/2048,\n           /*k=*/512,\n+          /*lhs_type=*/\"f32\",\n+          /*rhs_type=*/\"f32\",\n+          /*result_type=*/\"f32\",\n           /*clock_cycles=*/ClockCycles(absl::Seconds(2)),\n       },\n       DotSpec{\n           /*b=*/1,\n           /*m=*/64,\n           /*n=*/2048,\n           /*k=*/512,\n+          /*lhs_type=*/\"f32\",\n+          /*rhs_type=*/\"f32\",\n+          /*result_type=*/\"f32\",\n           /*clock_cycles=*/ClockCycles(absl::Seconds(3)),\n       },\n       DotSpec{\n           /*b=*/2,\n           /*m=*/256,\n           /*n=*/1024,\n           /*k=*/512,\n+          /*lhs_type=*/\"f32\",\n+          /*rhs_type=*/\"f32\",\n+          /*result_type=*/\"f32\",\n           /*clock_cycles=*/ClockCycles(absl::Seconds(4)),\n       },\n       DotSpec{\n           /*b=*/2,\n           /*m=*/256,\n           /*n=*/2048,\n           /*k=*/512,\n+          /*lhs_type=*/\"f32\",\n+          /*rhs_type=*/\"f32\",\n+          /*result_type=*/\"f32\",\n           /*clock_cycles=*/ClockCycles(absl::Seconds(5)),\n       },\n   };\n@@ -175,8 +211,8 @@ class MatmulInterpolatorParamTest : public TestWithParam<ParametrizedTestCase> {\n TEST_P(MatmulInterpolatorParamTest,\n        MatmulInteprolatorNextNeighbourInterpolation) {\n   const auto& [_, spec, expected_duration] = GetParam();\n-  TF_ASSERT_OK_AND_ASSIGN(DotContext context,\n-                          Dot(spec.b, spec.m, spec.n, spec.k));\n+  TF_ASSERT_OK_AND_ASSIGN(DotContext context, Dot(spec.b, spec.m, spec.n,\n+                                                  spec.k, \"f32\", \"f32\", \"f32\"));\n   EXPECT_EQ(absl::Trunc(*interpolator().EstimatedRuntime(*context.dot),\n                         absl::Milliseconds(1)),\n             expected_duration);\n@@ -193,6 +229,9 @@ INSTANTIATE_TEST_SUITE_P(\n                 /*m=*/64,\n                 /*n=*/64,\n                 /*k=*/64,\n+                /*lhs_type=*/\"f32\",\n+                /*rhs_type=*/\"f32\",\n+                /*result_type=*/\"f32\",\n             },\n             /*expected_duration=*/absl::Milliseconds(1),\n         },\n@@ -204,6 +243,9 @@ INSTANTIATE_TEST_SUITE_P(\n                 /*m=*/512,\n                 /*n=*/2048,\n                 /*k=*/1024,\n+                /*lhs_type=*/\"f32\",\n+                /*rhs_type=*/\"f32\",\n+                /*result_type=*/\"f32\",\n             },\n             /*expected_duration=*/absl::Seconds(40),\n         },\n@@ -215,6 +257,9 @@ INSTANTIATE_TEST_SUITE_P(\n                 /*m=*/128,\n                 /*n=*/2048,\n                 /*k=*/512,\n+                /*lhs_type=*/\"f32\",\n+                /*rhs_type=*/\"f32\",\n+                /*result_type=*/\"f32\",\n             },\n             /*expected_duration=*/absl::Seconds(12),\n         },\n@@ -226,6 +271,9 @@ INSTANTIATE_TEST_SUITE_P(\n                 /*m=*/512,\n                 /*n=*/2048,\n                 /*k=*/512,\n+                /*lhs_type=*/\"f32\",\n+                /*rhs_type=*/\"f32\",\n+                /*result_type=*/\"f32\",\n             },\n             /*expected_duration=*/absl::Seconds(10),\n         },\n@@ -237,6 +285,9 @@ INSTANTIATE_TEST_SUITE_P(\n                 /*m=*/256,\n                 /*n=*/4096,\n                 /*k=*/512,\n+                /*lhs_type=*/\"f32\",\n+                /*rhs_type=*/\"f32\",\n+                /*result_type=*/\"f32\",\n             },\n             /*expected_duration=*/absl::Seconds(10),\n         },\n@@ -248,6 +299,9 @@ INSTANTIATE_TEST_SUITE_P(\n                 /*m=*/256,\n                 /*n=*/2048,\n                 /*k=*/1024,\n+                /*lhs_type=*/\"f32\",\n+                /*rhs_type=*/\"f32\",\n+                /*result_type=*/\"f32\",\n             },\n             /*expected_duration=*/absl::Seconds(10),\n         },\n@@ -277,51 +331,6 @@ class MatmulInterpolatorDefaultTableTest\n     return GetMatmulInterpolator(TestGpuDeviceInfo::RTXA6000DeviceInfo(\n         se::CudaComputeCapability(10, 0)));\n   }\n-\n- protected:\n-  // Generates a Dot HLO instruction with BF16 data type.\n-  absl::StatusOr<DotContext> DotBF16(int b, int m, int n, int k) {\n-    // Template uses $0=b, $1=m, $2=k, $3=n for dimensions.\n-    absl::string_view kTemplate = R\"(\n-    HloModule m\n-\n-    ENTRY r {\n-      lhs = bf16[$0,$1,$2] parameter(0)\n-      rhs = bf16[$0,$2,$3] parameter(1)\n-      ROOT _ = bf16[$0,$1,$3] dot(lhs,rhs),\n-       lhs_contracting_dims={2}, rhs_contracting_dims={1},\n-       lhs_batch_dims={0}, rhs_batch_dims={0}\n-    })\";\n-    TF_ASSIGN_OR_RETURN(auto module,\n-                        ParseAndReturnUnverifiedModule(\n-                            absl::Substitute(kTemplate, b, m, k, n)));\n-    return DotContext{\n-        /*dot=*/module->entry_computation()->root_instruction(),\n-        /*module=*/std::move(module),\n-    };\n-  }\n-\n-  // Generates a Dot HLO instruction with FP8 data type.\n-  absl::StatusOr<DotContext> DotFP8(int b, int m, int n, int k) {\n-    // Template uses $0=b, $1=m, $2=k, $3=n for dimensions.\n-    absl::string_view kTemplate = R\"(\n-    HloModule m\n-\n-    ENTRY r {\n-      lhs = s8[$0,$1,$2] parameter(0)\n-      rhs = s8[$0,$2,$3] parameter(1)\n-      ROOT _ = s8[$0,$1,$3] dot(lhs,rhs),\n-       lhs_contracting_dims={2}, rhs_contracting_dims={1},\n-       lhs_batch_dims={0}, rhs_batch_dims={0}\n-    })\";\n-    TF_ASSIGN_OR_RETURN(auto module,\n-                        ParseAndReturnUnverifiedModule(\n-                            absl::Substitute(kTemplate, b, m, k, n)));\n-    return DotContext{\n-        /*dot=*/module->entry_computation()->root_instruction(),\n-        /*module=*/std::move(module),\n-    };\n-  }\n };\n \n using H100BF16Test = MatmulInterpolatorDefaultTableTest;\n@@ -343,41 +352,65 @@ INSTANTIATE_TEST_SUITE_P(\n         {\n             /*test_name=*/\"exact_match1_bf16\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/1024, /*n=*/4096, /*k=*/512, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/1024, /*n=*/4096, /*k=*/512,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(12),\n         },\n         {\n             /*test_name=*/\"exact_match2_bf16\",\n             /*spec=*/\n-            {/*b=*/4, /*m=*/256, /*n=*/1024, /*k=*/256, /*clock_cycles=*/0},\n+            {/*b=*/4, /*m=*/256, /*n=*/1024, /*k=*/256,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(6),\n         },\n         {\n             /*test_name=*/\"exact_match3_bf16\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/4096, /*n=*/2048, /*k=*/4096, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/4096, /*n=*/2048, /*k=*/4096,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(90),\n         },\n         {\n             /*test_name=*/\"extrapolate_small_bf16\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/64, /*n=*/64, /*k=*/64, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/64, /*n=*/64, /*k=*/64,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             // Expected duration based on nearest point (1,256,256,256)\n             // flops/sec and scaling by new dimensions.\n             /*expected_duration=*/absl::Microseconds(0),\n         },\n         {\n             /*test_name=*/\"extrapolate_slightly_larger_k_bf16\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/1024, /*n=*/4096, /*k=*/513, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/1024, /*n=*/4096, /*k=*/513,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             // Expected duration based on (1,1024,4096,512) flops/sec and\n             // scaling k.\n             /*expected_duration=*/absl::Microseconds(12),\n         },\n         {\n             /*test_name=*/\"interpolate_mid_n_bf16\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/1024, /*n=*/2048, /*k=*/512, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/1024, /*n=*/2048, /*k=*/512,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             // Expected duration based on linear interpolation of flops/sec\n             // between (1,1024,1024,512) and (1,1024,4096,512).\n             /*expected_duration=*/absl::Microseconds(9),\n@@ -405,25 +438,33 @@ INSTANTIATE_TEST_SUITE_P(\n         {\n             /*test_name=*/\"exact_match1_bf16\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/1024, /*n=*/4096, /*k=*/512, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/1024, /*n=*/4096, /*k=*/512,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(9),\n         },\n         {\n             /*test_name=*/\"exact_match2_bf16\",\n             /*spec=*/\n-            {/*b=*/4, /*m=*/256, /*n=*/1024, /*k=*/256, /*clock_cycles=*/0},\n+            {/*b=*/4, /*m=*/256, /*n=*/1024, /*k=*/256,\n+             /*lhs_type=*/\"bf16\",\n+             /*rhs_type=*/\"bf16\",\n+             /*result_type=*/\"bf16\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(6),\n         },\n     }),\n     [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&\n            info) { return info.param.test_name; });\n \n-using H100F8Test = MatmulInterpolatorDefaultTableTest;\n+using H100S8Test = MatmulInterpolatorDefaultTableTest;\n \n-TEST_P(H100F8Test, EstimatesRuntimeForFP8) {\n+TEST_P(H100S8Test, EstimatesRuntimeForS8) {\n   const auto& [_, spec, expected_duration] = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(DotContext context,\n-                          DotFP8(spec.b, spec.m, spec.n, spec.k));\n+                          DotS8(spec.b, spec.m, spec.n, spec.k));\n   // Compare with nanosecond precision.\n   EXPECT_EQ(\n       absl::Trunc(*GetMatmulInterpolatorH100()->EstimatedRuntime(*context.dot),\n@@ -432,28 +473,40 @@ TEST_P(H100F8Test, EstimatesRuntimeForFP8) {\n }\n \n INSTANTIATE_TEST_SUITE_P(\n-    MatmulInterpolatorDefaultTableTestInstantiationFP8, H100F8Test,\n+    MatmulInterpolatorDefaultTableTestInstantiationS8, H100S8Test,\n     ValuesIn<ParametrizedTestCase>({\n         {\n-            /*test_name=*/\"extrapolate_small_fp8\",\n+            /*test_name=*/\"extrapolate_small_s8\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/64, /*n=*/64, /*k=*/64, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/64, /*n=*/64, /*k=*/64,\n+             /*lhs_type=*/\"s8\",\n+             /*rhs_type=*/\"s8\",\n+             /*result_type=*/\"s8\",\n+             /*clock_cycles=*/0},\n             // Expected duration based on nearest point (1,512,512,512)\n             // flops/sec and scaling by new dimensions.\n             /*expected_duration=*/absl::Microseconds(0),\n         },\n         {\n-            /*test_name=*/\"interpolate_larger_fp8\",\n+            /*test_name=*/\"interpolate_larger_s8\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/2048, /*n=*/2048, /*k=*/2048, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/2048, /*n=*/2048, /*k=*/2048,\n+             /*lhs_type=*/\"s8\",\n+             /*rhs_type=*/\"s8\",\n+             /*result_type=*/\"s8\",\n+             /*clock_cycles=*/0},\n             // Expected duration based on nearest point (1,2048,2048,2048)\n             // flops/sec and scaling by new dimensions.\n             /*expected_duration=*/absl::Microseconds(72),\n         },\n         {\n-            /*test_name=*/\"interpolate_larger_batch_fp8\",\n+            /*test_name=*/\"interpolate_larger_batch_s8\",\n             /*spec=*/\n-            {/*b=*/8, /*m=*/2048, /*n=*/2048, /*k=*/2048, /*clock_cycles=*/0},\n+            {/*b=*/8, /*m=*/2048, /*n=*/2048, /*k=*/2048,\n+             /*lhs_type=*/\"s8\",\n+             /*rhs_type=*/\"s8\",\n+             /*result_type=*/\"s8\",\n+             /*clock_cycles=*/0},\n             // Expected duration based on nearest point (1,2048,2048,2048)\n             // flops/sec and scaling by new dimensions.\n             /*expected_duration=*/absl::Microseconds(280),\n@@ -462,12 +515,12 @@ INSTANTIATE_TEST_SUITE_P(\n     [](const TestParamInfo<MatmulInterpolatorDefaultTableTest::ParamType>&\n            info) { return info.param.test_name; });\n \n-using B200F8Test = MatmulInterpolatorDefaultTableTest;\n+using B200S8Test = MatmulInterpolatorDefaultTableTest;\n \n-TEST_P(B200F8Test, EstimatesRuntimeForFP8) {\n+TEST_P(B200S8Test, EstimatesRuntimeForS8) {\n   const auto& [_, spec, expected_duration] = GetParam();\n   TF_ASSERT_OK_AND_ASSIGN(DotContext context,\n-                          DotFP8(spec.b, spec.m, spec.n, spec.k));\n+                          DotS8(spec.b, spec.m, spec.n, spec.k));\n   // Compare with nanosecond precision.\n   EXPECT_EQ(\n       absl::Trunc(*GetMatmulInterpolatorB200()->EstimatedRuntime(*context.dot),\n@@ -476,18 +529,26 @@ TEST_P(B200F8Test, EstimatesRuntimeForFP8) {\n }\n \n INSTANTIATE_TEST_SUITE_P(\n-    MatmulInterpolatorDefaultTableTestInstantiationFP8, B200F8Test,\n+    MatmulInterpolatorDefaultTableTestInstantiationS8, B200S8Test,\n     ValuesIn<ParametrizedTestCase>({\n         {\n-            /*test_name=*/\"exact_match1_fp8\",\n+            /*test_name=*/\"exact_match1_s8\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/512, /*n=*/512, /*k=*/512, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/512, /*n=*/512, /*k=*/512,\n+             /*lhs_type=*/\"s8\",\n+             /*rhs_type=*/\"s8\",\n+             /*result_type=*/\"s8\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(44),\n         },\n         {\n-            /*test_name=*/\"exact_match2_fp8\",\n+            /*test_name=*/\"exact_match2_s8\",\n             /*spec=*/\n-            {/*b=*/1, /*m=*/2048, /*n=*/2048, /*k=*/2048, /*clock_cycles=*/0},\n+            {/*b=*/1, /*m=*/2048, /*n=*/2048, /*k=*/2048,\n+             /*lhs_type=*/\"s8\",\n+             /*rhs_type=*/\"s8\",\n+             /*result_type=*/\"s8\",\n+             /*clock_cycles=*/0},\n             /*expected_duration=*/absl::Microseconds(64),\n         },\n     }),"
        }
    ],
    "stats": {
        "total": 249,
        "additions": 155,
        "deletions": 94
    }
}