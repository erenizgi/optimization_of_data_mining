{
    "author": "junwhanahn",
    "message": "Expect the IFRT IR compiler to put the program on a properly initialized MLIR context so that we don't change the MLIR context at compile time\n\nReverts edf4a3c88e9d802afac6dbdccad95191ebe3c90a\n\nPiperOrigin-RevId: 808868465",
    "sha": "16710c5780ea92f0434d86ce66d48727982eaf2e",
    "files": [
        {
            "sha": "24f25032bba096237fc2382b4c114b791e0d987c",
            "filename": "third_party/xla/xla/python/ifrt/ir/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/16710c5780ea92f0434d86ce66d48727982eaf2e/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/16710c5780ea92f0434d86ce66d48727982eaf2e/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD?ref=16710c5780ea92f0434d86ce66d48727982eaf2e",
            "patch": "@@ -482,7 +482,6 @@ cc_library(\n         \"//xla/python/ifrt/support:module_parsing\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n-        \"@com_google_absl//absl/cleanup\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\","
        },
        {
            "sha": "f0fb282e33d25145ef0c7212097c91a0b3516207",
            "filename": "third_party/xla/xla/python/ifrt/ir/compiled_ifrt_ir_program.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/16710c5780ea92f0434d86ce66d48727982eaf2e/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/16710c5780ea92f0434d86ce66d48727982eaf2e/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc?ref=16710c5780ea92f0434d86ce66d48727982eaf2e",
            "patch": "@@ -22,7 +22,6 @@ limitations under the License.\n #include <variant>\n #include <vector>\n \n-#include \"absl/cleanup/cleanup.h\"\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n@@ -312,9 +311,7 @@ absl::StatusOr<CompiledIfrtIrProgram> CompiledIfrtIrProgram::Create(\n   }\n \n   mlir::ModuleOp mlir_module = ifrt_ir_program->mlir_module;\n-  // Load the dialects necessary to compile the IFRT IR module.\n   mlir::MLIRContext* context = mlir_module.getContext();\n-  xla::ifrt::support::RegisterMlirDialects(*context);\n \n   // Add the bounded executables to the atom program executable map so that\n   // they can be used by the interpreter\n@@ -338,20 +335,6 @@ absl::StatusOr<CompiledIfrtIrProgram> CompiledIfrtIrProgram::Create(\n                     compile_options->mlir_dump_pass_re,\n                     compile_options->mlir_dump_func_re,\n                     compile_options->mlir_enable_timing);\n-    // We need to ensure that Multithreading is enabled in order to be able\n-    // to dispatch compilations from multiple threads. Otherwise, we would\n-    // trigger data races while printing the ModuleOps for creating the\n-    // compilation cache keys\n-    // (see llvm/llvm-project/mlir/lib/Support/StorageUniquer.cpp).\n-    // JAX currently disables Multithreading for all contexts, but temporarily\n-    // enabling multithreading here is safe because the context is not shared\n-    // across JAX ModuleOps.\n-    bool wasMultithreaded = context->isMultithreadingEnabled();\n-    context->enableMultithreading(true);\n-    absl::Cleanup reset_multithreading = [&]() {\n-      context->enableMultithreading(wasMultithreaded);\n-    };\n-\n     xla::ifrt::IfrtToOutlinedAtomProgramsPipelineOptions\n         outline_pipeline_options;\n     outline_pipeline_options.propagate_shardings ="
        }
    ],
    "stats": {
        "total": 18,
        "additions": 0,
        "deletions": 18
    }
}