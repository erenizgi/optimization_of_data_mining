{
    "author": "subhankarshah",
    "message": "[XLA:MSA] Make all block-prefetch tests better readable by refactoring common elements.\n\nPiperOrigin-RevId: 817818480",
    "sha": "10e6b9eaee2341eae0fa408295a587a62a634e12",
    "files": [
        {
            "sha": "1e36c198ab4fca00187ccde88d5b5244079b7e5c",
            "filename": "third_party/xla/xla/service/memory_space_assignment/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/10e6b9eaee2341eae0fa408295a587a62a634e12/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/10e6b9eaee2341eae0fa408295a587a62a634e12/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2FBUILD?ref=10e6b9eaee2341eae0fa408295a587a62a634e12",
            "patch": "@@ -192,6 +192,7 @@ cc_library(\n         \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest_for_library\","
        },
        {
            "sha": "086030991b589fc33106f8e5bf53396b60f655c2",
            "filename": "third_party/xla/xla/service/memory_space_assignment/memory_space_assignment_test.cc",
            "status": "modified",
            "additions": 163,
            "deletions": 414,
            "changes": 577,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/10e6b9eaee2341eae0fa408295a587a62a634e12/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/10e6b9eaee2341eae0fa408295a587a62a634e12/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test.cc?ref=10e6b9eaee2341eae0fa408295a587a62a634e12",
            "patch": "@@ -14683,45 +14683,21 @@ ENTRY entry {\n   memory_space_options.max_outstanding_block_prefetches = 10;\n   memory_space_options.max_outstanding_prefetches = 0;\n \n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p0_position, p1_position,\n-                                                     p2_position, p3_position,\n-                                                     p4_position, p5_position};\n+  memory_space_options.block_prefetched_positions = GetHloPositions(\n+      /*module=*/module.get(),\n+      /*instruction_names=*/{\"p0\", \"p1\", \"p2\", \"p3\", \"p4\", \"p5\"});\n \n   XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n+  std::vector<std::string> default_memory_uses = {\"negate0\", \"add3\",  \"add6\",\n+                                                  \"add9\",    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/default_memory_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kParameter,\n+      /*operand_memory_space=*/kDefaultMemorySpace);\n }\n \n TEST_F(MemorySpaceAssignmentTest, TestBlockPrefetchingLowConcurrentPrefetches) {\n@@ -14761,53 +14737,24 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 96;\n   memory_space_options.reserved_bytes_for_block_prefetches = 96;\n-\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n-                                                     p3_position, p2_position,\n-                                                     p1_position, p0_position};\n   memory_space_options.max_outstanding_block_prefetches = 2;\n   memory_space_options.max_outstanding_prefetches = 0;\n-  XLA_LOG_LINES(INFO, \"Before MSA: \\n\" + module->ToString());\n+\n+  memory_space_options.block_prefetched_positions = GetHloPositions(\n+      /*module=*/module.get(),\n+      /*instruction_names=*/{\"p0\", \"p1\", \"p2\", \"p3\", \"p4\", \"p5\"});\n+\n+  XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n-  XLA_LOG_LINES(INFO, \"After MSA: \\n\" + module->ToString());\n+  XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add13 = FindInstruction(module.get(), \"add13\");\n-  EXPECT_EQ(add13->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add14 = FindInstruction(module.get(), \"add14\");\n-  EXPECT_EQ(add14->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+  std::vector<std::string> alternate_memory_uses = {\n+      \"negate0\", \"add3\", \"add6\", \"add9\", \"add12\", \"add13\", \"add14\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/alternate_memory_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n }\n \n TEST_F(MemorySpaceAssignmentTest, TestSingleBufferedBlockPrefetching) {\n@@ -14843,46 +14790,24 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 24;\n   memory_space_options.reserved_bytes_for_block_prefetches = 24;\n-\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n-                                                     p3_position, p2_position,\n-                                                     p1_position, p0_position};\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+  memory_space_options.max_outstanding_prefetches = 0;\n+\n+  memory_space_options.block_prefetched_positions = GetHloPositions(\n+      /*module=*/module.get(),\n+      /*instruction_names=*/{\"p0\", \"p1\", \"p2\", \"p3\", \"p4\", \"p5\"});\n+\n   XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+  std::vector<std::string> alternate_memory_uses = {\n+      \"negate0\", \"add3\", \"add6\", \"add9\", \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/alternate_memory_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n }\n \n TEST_F(MemorySpaceAssignmentTest,\n@@ -14921,46 +14846,30 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 24;\n   memory_space_options.reserved_bytes_for_block_prefetches = 24;\n-\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n-                                                     p3_position, p2_position,\n-                                                     p1_position, p0_position};\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+  memory_space_options.max_outstanding_prefetches = 0;\n+\n+  memory_space_options.block_prefetched_positions = GetHloPositions(\n+      /*module=*/module.get(),\n+      /*instruction_names=*/{\"p0\", \"p1\", \"p2\", \"p3\", \"p4\", \"p5\"});\n+\n   XLA_LOG_LINES(INFO, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_LOG_LINES(INFO, \"After MSA: \\n\" + module->ToString());\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kDefaultMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+  std::vector<std::string> alternate_memory_uses = {\"negate0\", \"add3\", \"add6\",\n+                                                    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/alternate_memory_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n+\n+  std::vector<std::string> default_memory_uses = {\"add9\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/default_memory_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kParameter,\n+      /*operand_memory_space=*/kDefaultMemorySpace);\n }\n \n TEST_F(MemorySpaceAssignmentTest, TestBlockPrefetchingDoubleBuffered) {\n@@ -14996,44 +14905,24 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 48;\n   memory_space_options.reserved_bytes_for_block_prefetches = 48;\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n-                                                     p3_position, p2_position,\n-                                                     p1_position, p0_position};\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+  memory_space_options.max_outstanding_prefetches = 0;\n+\n+  memory_space_options.block_prefetched_positions = GetHloPositions(\n+      /*module=*/module.get(),\n+      /*instruction_names=*/{\"p0\", \"p1\", \"p2\", \"p3\", \"p4\", \"p5\"});\n+\n   XLA_VLOG_LINES(3, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(3, \"After MSA: \\n\" + module->ToString());\n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+\n+  std::vector<std::string> prefetched_uses = {\"negate0\", \"add3\",  \"add6\",\n+                                              \"add9\",    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/prefetched_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n }\n \n TEST_F(MemorySpaceAssignmentTest, TestBlockPrefetchesWithMultipleUses) {\n@@ -15074,64 +14963,33 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 72;\n   memory_space_options.reserved_bytes_for_block_prefetches = 72;\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n-                                                     p3_position, p2_position,\n-                                                     p1_position, p0_position};\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+  memory_space_options.max_outstanding_prefetches = 0;\n+\n+  memory_space_options.block_prefetched_positions = GetHloPositions(\n+      /*module=*/module.get(),\n+      /*instruction_names=*/{\"p0\", \"p1\", \"p2\", \"p3\", \"p4\", \"p5\"});\n+\n   XLA_VLOG_LINES(3, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(3, \"After MSA: \\n\" + module->ToString());\n+\n+  std::vector<std::string> alternate_memory_uses = {\n+      \"negate0\", \"add3\", \"add6\", \"add9\", \"add12\", \"add13\", \"add14\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/alternate_memory_uses,\n+      /*operand_index=*/0, /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n+\n   HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  const HloInstruction* negate0_operand0 = negate0->operand(0);\n-  EXPECT_EQ(negate0_operand0->opcode(), HloOpcode::kCopyDone);\n-  EXPECT_EQ(negate0_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n   HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  const HloInstruction* add3_operand0 = add3->operand(0);\n-  EXPECT_EQ(add3_operand0->opcode(), HloOpcode::kCopyDone);\n-  EXPECT_EQ(add3_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  const HloInstruction* add6_operand0 = add6->operand(0);\n-  EXPECT_EQ(add6_operand0->opcode(), HloOpcode::kCopyDone);\n-  EXPECT_EQ(add6_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  const HloInstruction* add9_operand0 = add9->operand(0);\n-  EXPECT_EQ(add9_operand0->opcode(), HloOpcode::kCopyDone);\n-  EXPECT_EQ(add9_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  const HloInstruction* add12_operand0 = add12->operand(0);\n-  EXPECT_EQ(add12_operand0->opcode(), HloOpcode::kCopyDone);\n-  EXPECT_EQ(add12_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n   HloInstruction* add13 = FindInstruction(module.get(), \"add13\");\n-  const HloInstruction* add13_operand0 = add13->operand(0);\n-  // Check that the prefetch of p1 is reused for add13.\n-  EXPECT_EQ(add13_operand0, add3_operand0);\n   HloInstruction* add14 = FindInstruction(module.get(), \"add14\");\n-  const HloInstruction* add14_operand0 = add14->operand(0);\n   // Check that the prefetch of p0 is reused for add14.\n-  EXPECT_EQ(add14_operand0, negate0_operand0);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  const HloInstruction* add15_operand0 = add15->operand(0);\n-  EXPECT_EQ(add15_operand0->opcode(), HloOpcode::kCopyDone);\n-  EXPECT_EQ(add15_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+  EXPECT_EQ(negate0->operand(0), add14->operand(0));\n+  // Check that the prefetch of p1 is reused for add13.\n+  EXPECT_EQ(add3->operand(0), add13->operand(0));\n }\n \n TEST_F(MemorySpaceAssignmentTest,\n@@ -15168,51 +15026,35 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 48;\n   memory_space_options.reserved_bytes_for_block_prefetches = 48;\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  HloInstruction* p3 = FindInstruction(module.get(), \"p3\");\n-  HloPosition p3_position{p3, {}};\n-  HloInstruction* p4 = FindInstruction(module.get(), \"p4\");\n-  HloPosition p4_position{p4, {}};\n-  HloInstruction* p5 = FindInstruction(module.get(), \"p5\");\n-  HloPosition p5_position{p5, {}};\n-  memory_space_options.block_prefetched_positions = {p5_position, p4_position,\n-                                                     p3_position, p2_position,\n-                                                     p1_position, p0_position};\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+\n+  memory_space_options.block_prefetched_positions =\n+      GetHloPositions(module.get(), {\"p5\", \"p4\", \"p3\", \"p2\", \"p1\", \"p0\"});\n+\n   HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n   HloUse add15_negate14_use{add15, 1, {}};\n   memory_space_options.buffer_colorings = {\n       {add15_negate14_use, kAlternateMemorySpace}};\n+\n   XLA_VLOG_LINES(3, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(3, \"After MSA: \\n\" + module->ToString());\n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15_after_msa = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15_after_msa->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  // Operand 1 of add15 is colored in alternate memory.\n-  EXPECT_EQ(add15_after_msa->operand(1)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+\n+  std::vector<std::string> prefetched_uses = {\"negate0\", \"add3\",  \"add6\",\n+                                              \"add9\",    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/prefetched_uses,\n+      /*operand_index=*/0,\n+      /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n+\n+  std::vector<std::string> colored_uses = {\"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/colored_uses,\n+      /*operand_index=*/1,\n+      /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n }\n \n TEST_F(MemorySpaceAssignmentTest,\n@@ -15249,6 +15091,8 @@ ENTRY entry {\n   Options memory_space_options = DefaultMemorySpaceOptions();\n   memory_space_options.max_size_in_bytes = 48;\n   memory_space_options.reserved_bytes_for_block_prefetches = 48;\n+  memory_space_options.max_outstanding_block_prefetches = 10;\n+\n   absl::flat_hash_set<HloPosition> block_prefetched_positions;\n   TF_ASSERT_OK_AND_ASSIGN(auto alias_analysis,\n                           HloAliasAnalysis::Run(module.get(), &alias_info_));\n@@ -15277,36 +15121,31 @@ ENTRY entry {\n         });\n   }\n   memory_space_options.block_prefetched_positions = block_prefetched_positions;\n-  memory_space_options.max_outstanding_block_prefetches = 10;\n+\n   HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n   HloUse add15_negate14_use{add15, 1, {}};\n   memory_space_options.buffer_colorings = {\n       {add15_negate14_use, kAlternateMemorySpace}};\n+\n   XLA_VLOG_LINES(3, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(3, \"After MSA: \\n\" + module->ToString());\n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  EXPECT_EQ(negate0->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  EXPECT_EQ(add3->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  EXPECT_EQ(add6->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  EXPECT_EQ(add9->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  EXPECT_EQ(add12->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15_after_msa = FindInstruction(module.get(), \"add15\");\n-  EXPECT_EQ(add15_after_msa->operand(0)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  // Operand 1 of add15 is colored in alternate memory.\n-  EXPECT_EQ(add15_after_msa->operand(1)->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+\n+  std::vector<std::string> prefetched_uses = {\"negate0\", \"add3\",  \"add6\",\n+                                              \"add9\",    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/prefetched_uses,\n+      /*operand_index=*/0,\n+      /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n+\n+  std::vector<std::string> colored_uses = {\"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/colored_uses,\n+      /*operand_index=*/1,\n+      /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n }\n \n TEST_F(SlicedPrefetchTest, TestBlockPrefetchingAsyncSlicePrefetches) {\n@@ -15348,51 +15187,22 @@ ENTRY entry {\n   memory_space_options.max_size_in_bytes = 48;\n   memory_space_options.reserved_bytes_for_block_prefetches = 24;\n   memory_space_options.max_outstanding_block_prefetches = 10;\n-\n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  memory_space_options.block_prefetched_positions = {p0_position, p1_position,\n-                                                     p2_position};\n+  memory_space_options.max_outstanding_prefetches = 0;\n+  memory_space_options.block_prefetched_positions =\n+      GetHloPositions(module.get(), {\"p0\", \"p1\", \"p2\"});\n \n   XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  const HloInstruction* negate0_operand0 = negate0->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(negate0_operand0));\n-  EXPECT_EQ(negate0_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  const HloInstruction* add3_operand0 = add3->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add3_operand0));\n-  EXPECT_EQ(add3_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  const HloInstruction* add6_operand0 = add6->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add6_operand0));\n-  EXPECT_EQ(add6_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  const HloInstruction* add9_operand0 = add9->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add9_operand0));\n-  EXPECT_EQ(add9_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  const HloInstruction* add12_operand0 = add12->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add12_operand0));\n-  EXPECT_EQ(add12_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  const HloInstruction* add15_operand0 = add15->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add15_operand0));\n-  EXPECT_EQ(add15_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+  std::vector<std::string> sliced_prefetch_uses = {\"negate0\", \"add3\",  \"add6\",\n+                                                   \"add9\",    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/sliced_prefetch_uses,\n+      /*operand_index=*/0,\n+      /*operand_opcode=*/HloOpcode::kAsyncDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n \n   // Check there are no additional prefetches apart from block prefetches.\n   const std::vector<HloInstruction*>& instructions =\n@@ -15450,72 +15260,39 @@ ENTRY entry {\n   memory_space_options.max_size_in_bytes = 96;\n   memory_space_options.reserved_bytes_for_block_prefetches = 96;\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+  memory_space_options.max_outstanding_prefetches = 0;\n \n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  memory_space_options.block_prefetched_positions = {p0_position, p1_position,\n-                                                     p2_position};\n+  memory_space_options.block_prefetched_positions =\n+      GetHloPositions(module.get(), {\"p0\", \"p1\", \"p2\"});\n \n-  XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n+  XLA_LOG_LINES(INFO, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n-  XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n+  XLA_LOG_LINES(INFO, \"After MSA: \\n\" + module->ToString());\n+\n+  std::vector<std::string> sliced_prefetch_uses = {\n+      \"negate0\", \"add3\", \"add6\", \"add9\", \"add11\", \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/sliced_prefetch_uses,\n+      /*operand_index=*/0,\n+      /*operand_opcode=*/HloOpcode::kAsyncDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n+\n+  std::vector<std::string> prefetched_uses = {\"negate16\", \"add17\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/prefetched_uses,\n+      /*operand_index=*/0,\n+      /*operand_opcode=*/HloOpcode::kCopyDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  const HloInstruction* negate0_operand0 = negate0->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(negate0_operand0));\n-  EXPECT_EQ(negate0_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n   HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  const HloInstruction* add3_operand0 = add3->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add3_operand0));\n-  EXPECT_EQ(add3_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  const HloInstruction* add6_operand0 = add6->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add6_operand0));\n-  EXPECT_EQ(add6_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  const HloInstruction* add9_operand0 = add9->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add9_operand0));\n-  EXPECT_EQ(add9_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n   HloInstruction* add11 = FindInstruction(module.get(), \"add11\");\n-  const HloInstruction* add11_operand0 = add11->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add11_operand0));\n-  EXPECT_EQ(add11_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  const HloInstruction* add12_operand0 = add12->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add12_operand0));\n-  EXPECT_EQ(add12_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  const HloInstruction* add15_operand0 = add15->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add15_operand0));\n-  EXPECT_EQ(add15_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n   HloInstruction* negate16 = FindInstruction(module.get(), \"negate16\");\n-  const HloInstruction* negate16_operand0 = negate16->operand(0);\n-  EXPECT_TRUE(negate16_operand0->opcode() == HloOpcode::kCopyDone);\n-  EXPECT_EQ(negate16_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n   HloInstruction* add17 = FindInstruction(module.get(), \"add17\");\n-  const HloInstruction* add17_operand0 = add17->operand(0);\n-  EXPECT_TRUE(add17_operand0->opcode() == HloOpcode::kCopyDone);\n-  EXPECT_EQ(add17_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-\n   // Check slice1 is only prefetched once.\n-  EXPECT_EQ(add3_operand0, add11_operand0);\n-\n+  EXPECT_EQ(add3->operand(0), add11->operand(0));\n   // Check p0 is only prefetched once.\n-  EXPECT_EQ(negate16_operand0, add17_operand0);\n+  EXPECT_EQ(negate16->operand(0), add17->operand(0));\n \n   // Check there are no additional prefetches apart from block prefetches.\n   const std::vector<HloInstruction*>& instructions =\n@@ -15572,51 +15349,23 @@ ENTRY entry {\n   memory_space_options.max_size_in_bytes = 48;\n   memory_space_options.reserved_bytes_for_block_prefetches = 48;\n   memory_space_options.max_outstanding_block_prefetches = 10;\n+  memory_space_options.max_outstanding_prefetches = 0;\n \n-  HloInstruction* p0 = FindInstruction(module.get(), \"p0\");\n-  HloPosition p0_position{p0, {}};\n-  HloInstruction* p1 = FindInstruction(module.get(), \"p1\");\n-  HloPosition p1_position{p1, {}};\n-  HloInstruction* p2 = FindInstruction(module.get(), \"p2\");\n-  HloPosition p2_position{p2, {}};\n-  memory_space_options.block_prefetched_positions = {p0_position, p1_position,\n-                                                     p2_position};\n+  memory_space_options.block_prefetched_positions =\n+      GetHloPositions(module.get(), {\"p0\", \"p1\", \"p2\"});\n \n   XLA_VLOG_LINES(1, \"Before MSA: \\n\" + module->ToString());\n   AssignMemorySpaceUsingCostAnalysis(module.get(),\n                                      std::move(memory_space_options));\n   XLA_VLOG_LINES(1, \"After MSA: \\n\" + module->ToString());\n \n-  HloInstruction* negate0 = FindInstruction(module.get(), \"negate0\");\n-  const HloInstruction* negate0_operand0 = negate0->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(negate0_operand0));\n-  EXPECT_EQ(negate0_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add3 = FindInstruction(module.get(), \"add3\");\n-  const HloInstruction* add3_operand0 = add3->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add3_operand0));\n-  EXPECT_EQ(add3_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add6 = FindInstruction(module.get(), \"add6\");\n-  const HloInstruction* add6_operand0 = add6->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add6_operand0));\n-  EXPECT_EQ(add6_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add9 = FindInstruction(module.get(), \"add9\");\n-  const HloInstruction* add9_operand0 = add9->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add9_operand0));\n-  EXPECT_EQ(add9_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add12 = FindInstruction(module.get(), \"add12\");\n-  const HloInstruction* add12_operand0 = add12->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add12_operand0));\n-  EXPECT_EQ(add12_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n-  HloInstruction* add15 = FindInstruction(module.get(), \"add15\");\n-  const HloInstruction* add15_operand0 = add15->operand(0);\n-  EXPECT_TRUE(IsAsyncSliceDone(add15_operand0));\n-  EXPECT_EQ(add15_operand0->shape().layout().memory_space(),\n-            kAlternateMemorySpace);\n+  std::vector<std::string> sliced_prefetch_uses = {\"negate0\", \"add3\",  \"add6\",\n+                                                   \"add9\",    \"add12\", \"add15\"};\n+  CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      /*module=*/module.get(), /*instruction_names=*/sliced_prefetch_uses,\n+      /*operand_index=*/0,\n+      /*operand_opcode=*/HloOpcode::kAsyncDone,\n+      /*operand_memory_space=*/kAlternateMemorySpace);\n \n   // Check there are no additional prefetches apart from block prefetches.\n   const std::vector<HloInstruction*>& instructions ="
        },
        {
            "sha": "3ae688a100db02d47b79d0e6920d3d9b21e0cfcc",
            "filename": "third_party/xla/xla/service/memory_space_assignment/memory_space_assignment_test_base.h",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/10e6b9eaee2341eae0fa408295a587a62a634e12/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test_base.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/10e6b9eaee2341eae0fa408295a587a62a634e12/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test_base.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fmemory_space_assignment%2Fmemory_space_assignment_test_base.h?ref=10e6b9eaee2341eae0fa408295a587a62a634e12",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"absl/container/flat_hash_map.h\"\n+#include \"absl/container/flat_hash_set.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/types/span.h\"\n #include \"xla/hlo/analysis/alias_info.h\"\n@@ -375,6 +376,36 @@ class MemorySpaceAssignmentTestBase : public HloTestBase {\n     }\n   }\n \n+  // Returns a set of HloPositions for the given instruction names and\n+  // shape_index.\n+  absl::flat_hash_set<HloPosition> GetHloPositions(\n+      const HloModule* module, std::vector<std::string> instruction_names,\n+      ShapeIndex shape_index = {}) {\n+    absl::flat_hash_set<HloPosition> block_prefetched_positions;\n+    for (const auto& instruction_name : instruction_names) {\n+      HloInstruction* param = FindInstruction(module, instruction_name);\n+      EXPECT_NE(param, nullptr);\n+      HloPosition param_position{param, shape_index};\n+      block_prefetched_positions.insert(param_position);\n+    }\n+    return block_prefetched_positions;\n+  }\n+\n+  // Checks for every instruction in instruction_names that the operand at\n+  // operand_index has the given opcode and memory space.\n+  void CheckOperandOpcodeAndMemorySpaceForInstructionNames(\n+      HloModule* module, std::vector<std::string>& instruction_names,\n+      int64_t operand_index, HloOpcode operand_opcode,\n+      int64_t operand_memory_space) {\n+    for (const std::string& name : instruction_names) {\n+      HloInstruction* use_inst = FindInstruction(module, name);\n+      EXPECT_NE(use_inst, nullptr);\n+      const HloInstruction* operand = use_inst->operand(operand_index);\n+      EXPECT_EQ(operand->opcode(), operand_opcode);\n+      EXPECT_EQ(operand->shape().layout().memory_space(), operand_memory_space);\n+    }\n+  }\n+\n   struct OutstandingAsyncCopies {\n     int64_t max_copies;\n     int64_t max_prefetches;"
        }
    ],
    "stats": {
        "total": 609,
        "additions": 195,
        "deletions": 414
    }
}