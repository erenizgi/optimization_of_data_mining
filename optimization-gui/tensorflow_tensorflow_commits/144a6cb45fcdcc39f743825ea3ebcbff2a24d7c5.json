{
    "author": "akuegel",
    "message": "Make use of inserted_window_dims attribute of scatter.\n\nThis makes the logic a bit easier. Right now, ScatterSimplifier will turn this\ninto the original expanded update shape with 1-sized update window dimensions.\nBut once our scatter emitter can handle it, we might avoid the reshape.\n\nPiperOrigin-RevId: 841690525",
    "sha": "144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5",
    "files": [
        {
            "sha": "cfb796aef6c8987f35f75ec9fa194ffa594c49d6",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/permutation_sort_expander.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fpermutation_sort_expander.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fpermutation_sort_expander.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fpermutation_sort_expander.cc?ref=144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5",
            "patch": "@@ -127,13 +127,6 @@ absl::StatusOr<HloInstruction*> PermutationSortExpander::ExpandInstruction(\n       instruction->AddInstruction(HloInstruction::CreateBroadcast(\n           update_shape, zero, /*broadcast_dimensions=*/{}));\n \n-  // Construct the updates operand of scatter.\n-  for (int64_t i = 0; i < rank; ++i) {\n-    ShapeUtil::AppendMinorDimension(1, &update_shape);\n-  }\n-  HloInstruction* scatter_updates = instruction->AddInstruction(\n-      HloInstruction::CreateReshape(update_shape, values));\n-\n   // Construct the updates computation, which simply replaces the operand\n   // values with the update values.\n   HloComputation::Builder b(\"update_replace_computation\");\n@@ -149,12 +142,12 @@ absl::StatusOr<HloInstruction*> PermutationSortExpander::ExpandInstruction(\n   ScatterDimensionNumbers dim_numbers;\n   dim_numbers.set_index_vector_dim(rank);\n   for (int64_t i = 0; i < rank; ++i) {\n-    dim_numbers.add_update_window_dims(rank + i);\n+    dim_numbers.add_inserted_window_dims(i);\n     dim_numbers.add_scatter_dims_to_operand_dims(i);\n   }\n   HloInstruction* scatter =\n       instruction->AddInstruction(HloInstruction::CreateScatter(\n-          values->shape(), scatter_operand, scatter_indices, scatter_updates,\n+          update_shape, scatter_operand, scatter_indices, values,\n           update_replace_computation, dim_numbers,\n           /*indices_are_sorted=*/false, /*unique_indices=*/true));\n   return instruction->AddInstruction(HloInstruction::CreateTuple("
        },
        {
            "sha": "329df8c95e9bd68b72bd80e05d73898080be5e92",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/permutation_sort_expander_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fpermutation_sort_expander_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fpermutation_sort_expander_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fpermutation_sort_expander_test.cc?ref=144a6cb45fcdcc39f743825ea3ebcbff2a24d7c5",
            "patch": "@@ -63,11 +63,14 @@ TEST_F(PermutationSortExpanderTest, ReplacePermutationSortWithScatter) {\n \n   EXPECT_THAT(PermutationSortExpander().Run(module.get()), IsOkAndHolds(true));\n   auto root = module->entry_computation()->root_instruction();\n-  EXPECT_THAT(root,\n-              op::Tuple(op::Iota(),\n-                        op::Scatter(op::Broadcast(op::Constant()),\n-                                    op::Concatenate(op::Iota(), op::Reshape()),\n-                                    op::Reshape())));\n+  EXPECT_THAT(\n+      root, op::Tuple(op::Iota(),\n+                      op::Scatter(\n+                          op::Broadcast(op::Constant()),\n+                          op::Concatenate(op::Iota(),\n+                                          op::Reshape(op::GetTupleElement(\n+                                              op::Sort(), /*tuple_index=*/1))),\n+                          op::Iota())));\n }\n \n TEST_F(PermutationSortExpanderTest, DontReplaceIfWrongComparisonDirection) {"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 10,
        "deletions": 14
    }
}