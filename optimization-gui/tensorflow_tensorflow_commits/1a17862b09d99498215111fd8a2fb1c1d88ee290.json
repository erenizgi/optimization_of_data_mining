{
    "author": "ezhulenev",
    "message": "[xla:codegen] Fix warnings in KernelDefinition + cleanup API a bit\n\nPiperOrigin-RevId: 825283848",
    "sha": "1a17862b09d99498215111fd8a2fb1c1d88ee290",
    "files": [
        {
            "sha": "6204c2bbf6eced2b5a5b5690e42c570f737efe8e",
            "filename": "third_party/xla/xla/backends/cpu/codegen/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -631,6 +631,7 @@ cc_library(\n         \"//xla/backends/cpu:alignment\",\n         \"//xla/codegen:hlo_fusion_spec\",\n         \"//xla/codegen:ir_emission_utils\",\n+        \"//xla/codegen:kernel_spec\",\n         \"//xla/codegen:mlir_kernel_source\",\n         \"//xla/codegen/emitters:concatenate_kernel_emitter\",\n         \"//xla/codegen/emitters:dynamic_update_slice_kernel_emitter\","
        },
        {
            "sha": "6d2661a037c7d63ea45ff9133a7b36ce85b30e2b",
            "filename": "third_party/xla/xla/backends/cpu/codegen/emitters/cpu_fusion_emitter_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 18,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Fcpu_fusion_emitter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Fcpu_fusion_emitter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Fcpu_fusion_emitter_test.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -45,26 +45,11 @@ limitations under the License.\n #include \"xla/service/gpu/model/experimental/symbolic_expr.h\"\n #include \"xla/service/logical_buffer.h\"\n #include \"xla/tsl/platform/statusor.h\"\n-#include \"tsl/platform/casts.h\"\n \n namespace xla {\n namespace cpu {\n namespace {\n \n-std::string LlvmModuleToString(const llvm::Module& module) {\n-  std::string dump;\n-  llvm::raw_string_ostream stream(dump);\n-  stream << module;\n-  return dump;\n-}\n-\n-std::string MlirModuleToString(const mlir::ModuleOp& module) {\n-  std::string mlir_dump;\n-  llvm::raw_string_ostream mlir_stream(mlir_dump);\n-  module->print(mlir_stream);\n-  return mlir_dump;\n-}\n-\n class CpuFusionEmitterTest : public HloHardwareIndependentTestBase {\n  protected:\n   absl::StatusOr<std::unique_ptr<BufferAssignment>> RunBufferAssignment(\n@@ -168,11 +153,11 @@ TEST_F(CpuFusionEmitterTest, ScatterLlvm) {\n                            symbolic_expr_context.get());\n   TF_ASSERT_OK_AND_ASSIGN(KernelDefinition kernel_definition,\n                           emitter.EmitKernelDefinition());\n-  auto [spec, source] = std::move(kernel_definition).ReleaseStorage();\n   FusionCompiler compiler(mlir_context.get(),\n                           FusionCompiler::Options{512, 1, true});\n-  TF_ASSERT_OK_AND_ASSIGN(LlvmKernelSource llvm_source,\n-                          compiler.Compile(std::move(source)));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      LlvmKernelSource llvm_source,\n+      compiler.Compile(std::move(kernel_definition).TakeSource()));\n   auto llvm_dump = llvm_source.ToString();\n   TF_ASSERT_OK_AND_ASSIGN(bool filecheck_matched,\n                           RunFileCheck(llvm_dump, kExpected));"
        },
        {
            "sha": "9cc536df132dcfad943252b8921fae0b662d4119",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_emitter.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 21,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -42,6 +42,8 @@ limitations under the License.\n #include \"xla/codegen/emitters/loop_kernel_emitter.h\"\n #include \"xla/codegen/hlo_fusion_spec.h\"\n #include \"xla/codegen/ir_emission_utils.h\"\n+#include \"xla/codegen/kernel_spec.h\"\n+#include \"xla/codegen/mlir_kernel_source.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n@@ -219,17 +221,13 @@ static absl::StatusOr<MlirKernelDefinition> EmitLoopFusionKernel(\n   TF_ASSIGN_OR_RETURN(auto mlir_kernel_definition,\n                       loop_fusion_emitter.EmitKernelDefinition());\n \n-  // We have to release otherwise the source wouldn't be mutable, and we\n-  // wouldn't be able to set the CpuMemoryRegionNameAttr.\n-  auto [kernel_spec, kernel_source] =\n-      std::move(mlir_kernel_definition).ReleaseStorage();\n-\n   mlir::OpBuilder builder(context.GetMLIRContext());\n-  kernel_source.module().getOperation()->setAttr(\n+  mlir_kernel_definition.source().module().getOperation()->setAttr(\n       xla::CpuMemoryRegionNameAttr::name,\n       builder.getStringAttr(\n           BuildModuleMemoryRegionName(loop_fusion_emitter.name(), &fusion)));\n-  return MlirKernelDefinition(std::move(kernel_spec), std::move(kernel_source));\n+\n+  return mlir_kernel_definition;\n }\n \n static absl::StatusOr<MlirKernelDefinition> EmitConcatenateFusionKernel(\n@@ -245,17 +243,13 @@ static absl::StatusOr<MlirKernelDefinition> EmitConcatenateFusionKernel(\n   TF_ASSIGN_OR_RETURN(auto mlir_kernel_definition,\n                       concatenate_fusion_emitter.EmitKernelDefinition());\n \n-  // We have to release otherwise the source wouldn't be mutable, and we\n-  // wouldn't be able to set the CpuMemoryRegionNameAttr.\n-  auto [kernel_spec, kernel_source] =\n-      std::move(mlir_kernel_definition).ReleaseStorage();\n-\n   mlir::OpBuilder builder(context.GetMLIRContext());\n-  kernel_source.module().getOperation()->setAttr(\n+  mlir_kernel_definition.source().module().getOperation()->setAttr(\n       xla::CpuMemoryRegionNameAttr::name,\n       builder.getStringAttr(BuildModuleMemoryRegionName(\n           concatenate_fusion_emitter.name(), &fusion)));\n-  return MlirKernelDefinition(std::move(kernel_spec), std::move(kernel_source));\n+\n+  return mlir_kernel_definition;\n }\n \n static absl::StatusOr<MlirKernelDefinition> EmitDynamicUpdateSliceFusionKernel(\n@@ -272,17 +266,13 @@ static absl::StatusOr<MlirKernelDefinition> EmitDynamicUpdateSliceFusionKernel(\n   TF_ASSIGN_OR_RETURN(auto mlir_kernel_definition,\n                       emitter.EmitKernelDefinition());\n \n-  // We have to release otherwise the source wouldn't be mutable, and we\n-  // wouldn't be able to set the CpuMemoryRegionNameAttr.\n-  auto [kernel_spec, kernel_source] =\n-      std::move(mlir_kernel_definition).ReleaseStorage();\n-\n   mlir::OpBuilder builder(context.GetMLIRContext());\n-  kernel_source.module().getOperation()->setAttr(\n+  mlir_kernel_definition.source().module().getOperation()->setAttr(\n       xla::CpuMemoryRegionNameAttr::name,\n       builder.getStringAttr(\n           BuildModuleMemoryRegionName(emitter.name(), &fusion)));\n-  return MlirKernelDefinition(std::move(kernel_spec), std::move(kernel_source));\n+\n+  return mlir_kernel_definition;\n }\n \n absl::StatusOr<MlirKernelDefinition> EmitFusionKernel("
        },
        {
            "sha": "8efee620687116594da5fd410e3ca7f68b2a8e4f",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -52,9 +52,9 @@ namespace xla::cpu {\n \n absl::StatusOr<KernelRunner> KernelRunner::Create(\n     LlvmKernelDefinition kernel_definition, JitCompiler compiler) {\n-  auto [spec, source] = std::move(kernel_definition).ReleaseStorage();\n-\n-  auto thread_safe_module = std::move(source).thread_safe_module();\n+  auto spec = kernel_definition.spec();\n+  auto thread_safe_module =\n+      std::move(kernel_definition).TakeSource().thread_safe_module();\n   SetModuleMemoryRegionName(*thread_safe_module.getModuleUnlocked(),\n                             \"kernel_runner_test\");\n \n@@ -74,8 +74,8 @@ absl::StatusOr<KernelRunner> KernelRunner::Create(\n \n absl::StatusOr<KernelRunner> KernelRunner::Create(\n     MlirKernelDefinition kernel_definition, JitCompiler compiler) {\n-  auto [spec, source] = std::move(kernel_definition).ReleaseStorage();\n-\n+  auto spec = kernel_definition.spec();\n+  auto source = std::move(kernel_definition).TakeSource();\n   TF_ASSIGN_OR_RETURN(LlvmKernelSource llvm_kernel_source, LowerToLlvm(source));\n \n   return Create(LlvmKernelDefinition(spec, std::move(llvm_kernel_source)),"
        },
        {
            "sha": "a40d98f62b0012b60c0311c635d7133c504157c5",
            "filename": "third_party/xla/xla/backends/cpu/testlib/llvm_ir_kernel_emitter_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fllvm_ir_kernel_emitter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fllvm_ir_kernel_emitter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fllvm_ir_kernel_emitter_test.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -28,10 +28,8 @@ limitations under the License.\n #include \"xla/codegen/llvm_kernel_source.h\"\n #include \"xla/runtime/buffer_use.h\"\n #include \"xla/service/buffer_assignment.h\"\n-#include \"xla/stream_executor/launch_dim.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n-#include \"tsl/platform/casts.h\"\n \n namespace xla::cpu {\n \n@@ -48,12 +46,11 @@ TEST(LlvmIrKernelEmitterTest, ParseLlvmIr) {\n   LlvmTestKernelEmitter::KernelArg arg{1024, BufferUse::MemoryAccess::kWrite};\n   LlvmTestKernelEmitter emitter(kLlvmIr, \"noop\", {}, {arg});\n \n-  TF_ASSERT_OK_AND_ASSIGN(KernelDefinition kernel_definition,\n+  TF_ASSERT_OK_AND_ASSIGN(auto kernel_definition,\n                           emitter.EmitKernelDefinition());\n \n   // Check that LLVM IR was parsed and loaded as a LLVM IR kernel source.\n-  auto [kernel_spec, kernel_source] =\n-      std::move(kernel_definition).ReleaseStorage();\n+  const KernelSpec& kernel_spec = kernel_definition.spec();\n \n   EXPECT_EQ(kernel_spec.name(), \"noop\");\n \n@@ -66,7 +63,7 @@ TEST(LlvmIrKernelEmitterTest, ParseLlvmIr) {\n   EXPECT_EQ(result_slice.size(), 1024);\n \n   llvm::orc::ThreadSafeModule thread_safe_module =\n-      std::move(kernel_source).thread_safe_module();\n+      std::move(kernel_definition).TakeSource().thread_safe_module();\n   const llvm::Module::FunctionListType& functions =\n       thread_safe_module.getModuleUnlocked()->getFunctionList();\n   EXPECT_THAT(functions,"
        },
        {
            "sha": "abb5a8fb8e3826e298b05103e158080716866f79",
            "filename": "third_party/xla/xla/backends/gpu/codegen/emitters/concatenate.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fconcatenate.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fconcatenate.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fconcatenate.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -87,8 +87,7 @@ ConcatenateFusion::CreateMLIRModule(\n       BackendKind::kGpu);\n \n   TF_ASSIGN_OR_RETURN(auto kernel_definition, emitter.EmitKernelDefinition());\n-  auto [spec, source] = std::move(kernel_definition).ReleaseStorage();\n-  return std::move(source).ReleaseStorage().module;\n+  return std::move(kernel_definition).TakeSource().ReleaseStorage().module;\n }\n \n absl::Status ConcatenateFusion::EmitEntryFunction("
        },
        {
            "sha": "efacae8753d6d95427174af23231b0855f76c92b",
            "filename": "third_party/xla/xla/backends/gpu/codegen/emitters/in_place_dynamic_update_slice.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fin_place_dynamic_update_slice.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fin_place_dynamic_update_slice.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Fin_place_dynamic_update_slice.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -105,8 +105,7 @@ InPlaceDynamicUpdateSliceFusion::CreateMLIRModule(\n       BackendKind::kGpu);\n \n   TF_ASSIGN_OR_RETURN(auto kernel_definition, emitter.EmitKernelDefinition());\n-  auto [spec, source] = std::move(kernel_definition).ReleaseStorage();\n-  return std::move(source).ReleaseStorage().module;\n+  return std::move(kernel_definition).TakeSource().ReleaseStorage().module;\n }\n \n absl::Status InPlaceDynamicUpdateSliceFusion::EmitEntryFunction("
        },
        {
            "sha": "68130db02a2098fe7825b8324e5cc99ecbe5aad8",
            "filename": "third_party/xla/xla/backends/gpu/codegen/emitters/loop.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Floop.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Floop.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Femitters%2Floop.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -116,8 +116,7 @@ absl::StatusOr<mlir::OwningOpRef<mlir::ModuleOp>> LoopFusion::CreateMLIRModule(\n       BackendKind::kGpu);\n \n   TF_ASSIGN_OR_RETURN(auto kernel_definition, emitter.EmitKernelDefinition());\n-  auto [spec, source] = std::move(kernel_definition).ReleaseStorage();\n-  return std::move(source).ReleaseStorage().module;\n+  return std::move(kernel_definition).TakeSource().ReleaseStorage().module;\n }\n \n absl::Status LoopFusion::EmitEntryFunction("
        },
        {
            "sha": "cc561633f6223af283049351bc020ea0ba1a6a25",
            "filename": "third_party/xla/xla/codegen/kernel_definition.h",
            "status": "modified",
            "additions": 41,
            "deletions": 21,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_definition.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_definition.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_definition.h?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -1,4 +1,3 @@\n-#include \"xla/codegen/kernel_source.h\"\n /* Copyright 2024 The OpenXLA Authors.\n \n Licensed under the Apache License, Version 2.0 (the \"License\");\n@@ -19,47 +18,68 @@ limitations under the License.\n \n #include <utility>\n \n+#include \"xla/codegen/kernel_source.h\"\n #include \"xla/codegen/kernel_spec.h\"\n \n namespace xla {\n \n+//===----------------------------------------------------------------------===//\n+// KernelDefinitionBase.\n+//===----------------------------------------------------------------------===//\n+\n+// A base class for kernel definitions.\n+//\n+// KernelDefinition defines how the kernel must be executed via the `KernelSpec`\n+// and also contains the `KernelSource` that implements the kernel itself.\n class KernelDefinitionBase {\n  public:\n+  explicit KernelDefinitionBase(KernelSpec spec) : spec_(std::move(spec)) {}\n   virtual ~KernelDefinitionBase() = default;\n \n-  virtual const KernelSpec& spec() const = 0;\n+  const KernelSpec& spec() const { return spec_; }\n+  KernelSpec& spec() { return spec_; }\n+\n   virtual const KernelSource& source() const = 0;\n+  virtual KernelSource& source() = 0;\n+\n+ protected:\n+  KernelDefinitionBase(KernelDefinitionBase&&) = default;\n+  KernelDefinitionBase& operator=(KernelDefinitionBase&&) = default;\n+\n+ private:\n+  KernelSpec spec_;\n };\n \n-template <typename KernelSourceType>\n+//===----------------------------------------------------------------------===//\n+// KernelDefinition.\n+//===----------------------------------------------------------------------===//\n+\n+// A concrete kernel definition implementation for the given kernel source type.\n+template <typename Source>\n class KernelDefinition final : public KernelDefinitionBase {\n- public:\n-  struct Storage {\n-    KernelSpec spec;\n-    KernelSourceType source;\n-  };\n+  static_assert(std::is_base_of_v<KernelSource, Source>,\n+                \"Source must be a subclass of KernelSource\");\n \n-  KernelDefinition(KernelSpec spec, KernelSourceType source)\n-      : storage_{std::move(spec), std::move(source)} {}\n+ public:\n+  KernelDefinition(KernelSpec spec, Source source)\n+      : KernelDefinitionBase(std::move(spec)), source_(std::move(source)) {}\n \n   KernelDefinition(KernelDefinition&&) = default;\n-  KernelDefinition& operator=(KernelDefinition&&) noexcept = default;\n+  KernelDefinition& operator=(KernelDefinition&&) = default;\n \n-  const KernelSpec& spec() const override { return storage_.spec; }\n-  const KernelSourceType& source() const override { return storage_.source; }\n+  const Source& source() const final { return source_; }\n+  Source& source() final { return source_; }\n \n-  // Release the kernel definition implementation.\n-  // This is useful for backends that need to store the kernel definition\n-  // separately from the kernel spec.\n-  Storage ReleaseStorage() && { return std::move(storage_); }\n+  // Moves ownership of the source to the caller.\n+  Source TakeSource() && { return std::move(source_); }\n \n  private:\n-  Storage storage_;\n+  Source source_;\n };\n \n-template <typename KernelSourceType>\n-KernelDefinition(KernelSpec, KernelSourceType)\n-    -> KernelDefinition<KernelSourceType>;\n+// Class template argument deduction guide for KernelDefinition.\n+template <typename Source>\n+KernelDefinition(KernelSpec, Source) -> KernelDefinition<Source>;\n \n }  // namespace xla\n "
        },
        {
            "sha": "fbf5f5d6fe53ff9c71aabcc9ac138cc741bfb832",
            "filename": "third_party/xla/xla/codegen/kernel_source.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_source.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_source.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fkernel_source.h?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -25,10 +25,15 @@ namespace xla {\n // already compiled) or an LLVM IR (if XLA itself will compile it to PTX).\n class KernelSource {\n  public:\n+  KernelSource() = default;\n   virtual ~KernelSource() = default;\n \n   // Get a human readable string representation of the kernel source.\n   virtual std::string ToString() const = 0;\n+\n+ protected:\n+  KernelSource(KernelSource&&) = default;\n+  KernelSource& operator=(KernelSource&&) = default;\n };\n \n }  // namespace xla"
        },
        {
            "sha": "dc64e7c99fa02bf274de54769a87b5341140da80",
            "filename": "third_party/xla/xla/codegen/testlib/kernel_runner_extension.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fcodegen%2Ftestlib%2Fkernel_runner_extension.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fcodegen%2Ftestlib%2Fkernel_runner_extension.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftestlib%2Fkernel_runner_extension.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -193,10 +193,18 @@ NB_MODULE(_extension, kernel_runner_module) {\n   nb::class_<KernelSpec> kernel_spec(kernel_runner_module, \"KernelSpec\");\n \n   nb::class_<KernelDefinitionBase>(kernel_runner_module, \"KernelDefinitionBase\")\n-      .def(\"spec\", &KernelDefinitionBase::spec,\n-           nb::rv_policy::reference_internal)\n-      .def(\"source\", &KernelDefinitionBase::source,\n-           nb::rv_policy::reference_internal);\n+      .def(\n+          \"spec\",\n+          [](const KernelDefinitionBase* self) -> const KernelSpec& {\n+            return self->spec();\n+          },\n+          nb::rv_policy::reference_internal)\n+      .def(\n+          \"source\",\n+          [](const KernelDefinitionBase* self) -> const KernelSource& {\n+            return self->source();\n+          },\n+          nb::rv_policy::reference_internal);\n \n   nb::class_<MlirKernelDefinition, KernelDefinitionBase>(\n       kernel_runner_module, \"MlirKernelDefinition\");"
        },
        {
            "sha": "d55ddc14d79e644f97ea613b87dc8d99f40531cb",
            "filename": "third_party/xla/xla/service/cpu/parallel_fusion_emitter.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -214,9 +214,10 @@ ParallelFusionEmitter::ConsumeKernels() {\n void ParallelFusionEmitter::CompileFusion(\n     std::shared_ptr<MlirKernelDefinition> mlir_kernel_definition,\n     std::shared_ptr<CompilerInstance> compiler_instance) {\n-  auto [spec, source] = std::move(*mlir_kernel_definition).ReleaseStorage();\n+  KernelSpec spec = mlir_kernel_definition->spec();\n   absl::StatusOr<LlvmKernelSource> llvm_kernel_source =\n-      compiler_instance->compiler->Compile(std::move(source));\n+      compiler_instance->compiler->Compile(\n+          std::move(*mlir_kernel_definition).TakeSource());\n \n   absl::MutexLock lock(kernels_mutex_);\n   outstanding_kernels_--;"
        },
        {
            "sha": "79c4e7b833423cc861743397d1355c2168232d61",
            "filename": "third_party/xla/xla/service/cpu/parallel_fusion_emitter_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter_test.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -124,8 +124,8 @@ TEST_F(ParallelFusionEmitterTest, HappyPathSingleFusion) {\n   TF_ASSERT_OK_AND_ASSIGN(auto kernels, fussion_emitter.ConsumeKernels());\n   ASSERT_EQ(kernels.size(), 1);\n   LlvmKernelDefinition& lowered_kernel = kernels[0];\n-  auto [spec, source] = std::move(lowered_kernel).ReleaseStorage();\n-  EXPECT_EQ(spec.name(), expected_name);\n+  EXPECT_EQ(lowered_kernel.spec().name(), expected_name);\n+  auto source = std::move(lowered_kernel).TakeSource();\n \n   llvm::orc::ThreadSafeModule thread_safe_llvm_module =\n       std::move(source).thread_safe_module();"
        },
        {
            "sha": "10e6838cdcbbc181a268bb2e171154ba309b0760",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 12,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a17862b09d99498215111fd8a2fb1c1d88ee290/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc?ref=1a17862b09d99498215111fd8a2fb1c1d88ee290",
            "patch": "@@ -239,8 +239,9 @@ ThunkEmitter::ConsumeKernels() {\n \n   kernels_.reserve(kernels_.size() + fusion_kernels.size());\n   for (LlvmKernelDefinition& kernel : fusion_kernels) {\n-    auto [spec, source] = std::move(kernel).ReleaseStorage();\n-    kernels_.push_back({spec.name(), std::move(source).thread_safe_module()});\n+    std::string name(kernel.spec().name());\n+    auto source = std::move(kernel).TakeSource();\n+    kernels_.push_back({name, std::move(source).thread_safe_module()});\n   }\n \n   return std::move(kernels_);\n@@ -690,8 +691,8 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitCallThunk(\n     TF_ASSIGN_OR_RETURN(LlvmKernelDefinition kernel_definition,\n                         emitter.EmitKernelDefinition());\n \n-    auto [kernel_spec, kernel_source] =\n-        std::move(kernel_definition).ReleaseStorage();\n+    auto kernel_spec = kernel_definition.spec();\n+    auto kernel_source = std::move(kernel_definition).TakeSource();\n \n     kernels_.push_back(\n         {kernel_spec.name(), std::move(kernel_source).thread_safe_module()});\n@@ -714,8 +715,8 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitConcatenateKernelThunk(\n   TF_ASSIGN_OR_RETURN(LlvmKernelDefinition kernel_definition,\n                       emitter.EmitKernelDefinition());\n \n-  auto [kernel_spec, kernel_source] =\n-      std::move(kernel_definition).ReleaseStorage();\n+  auto kernel_spec = kernel_definition.spec();\n+  auto kernel_source = std::move(kernel_definition).TakeSource();\n \n   TF_ASSIGN_OR_RETURN(auto backend_config,\n                       instruction->backend_config<BackendConfig>());\n@@ -820,8 +821,8 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitElementalKernelThunk(\n   TF_ASSIGN_OR_RETURN(LlvmKernelDefinition kernel_definition,\n                       emitter.EmitKernelDefinition());\n \n-  auto [kernel_spec, kernel_source] =\n-      std::move(kernel_definition).ReleaseStorage();\n+  auto kernel_spec = kernel_definition.spec();\n+  auto kernel_source = std::move(kernel_definition).TakeSource();\n \n   kernels_.push_back(\n       {kernel_spec.name(), std::move(kernel_source).thread_safe_module()});\n@@ -852,8 +853,8 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitFusionKernelThunk(\n     TF_ASSIGN_OR_RETURN(MlirKernelDefinition kernel_definition,\n                         kernel_emitter->EmitKernelDefinition());\n \n-    auto [kernel_spec, kernel_source] =\n-        std::move(kernel_definition).ReleaseStorage();\n+    auto kernel_spec = kernel_definition.spec();\n+    auto kernel_source = std::move(kernel_definition).TakeSource();\n \n     TF_ASSIGN_OR_RETURN(LlvmKernelSource llvm_kernel_source,\n                         fusion_compiler_.Compile(std::move(kernel_source)));\n@@ -1064,8 +1065,8 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitDotThunk(\n       TF_ASSIGN_OR_RETURN(LlvmKernelDefinition kernel_definition,\n                           emitter.EmitKernelDefinition());\n \n-      auto [kernel_spec, kernel_source] =\n-          std::move(kernel_definition).ReleaseStorage();\n+      auto kernel_spec = kernel_definition.spec();\n+      auto kernel_source = std::move(kernel_definition).TakeSource();\n \n       kernels_.push_back(\n           {kernel_spec.name(), std::move(kernel_source).thread_safe_module()});"
        }
    ],
    "stats": {
        "total": 199,
        "additions": 102,
        "deletions": 97
    }
}