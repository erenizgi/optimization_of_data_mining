{
    "author": "tensorflower-gardener",
    "message": "This is an internal change\n\nReverts 911ce60c2902b58cd892ca05f2297d72ef624e5f\n\nPiperOrigin-RevId: 847933822",
    "sha": "86c82562e1188f693f49cd0b369e70d07a74eb7e",
    "files": [
        {
            "sha": "227537a79f14546dd78aca3e5bdca7704f42e977",
            "filename": "tensorflow/lite/delegates/xnnpack/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 35,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2FBUILD?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -392,21 +392,6 @@ cc_library(\n     ],\n )\n \n-cc_library(\n-    name = \"fingerprint_test_helpers\",\n-    testonly = True,\n-    hdrs = [\"fingerprint_test_helpers.h\"],\n-    compatible_with = get_compatible_with_portable(),\n-    deps = [\n-        \":weight_cache\",\n-        \":weight_cache_test_helpers\",\n-        \":xnnpack_delegate_hdrs_only\",\n-        \"//tensorflow/lite/c:common\",\n-        \"@XNNPACK\",\n-        \"@com_google_googletest//:gtest\",\n-    ],\n-)\n-\n cc_library(\n     name = \"mmap_handle\",\n     srcs = [\"mmap_handle.cc\"],\n@@ -1362,7 +1347,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1379,7 +1363,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_depthwise_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1414,7 +1397,6 @@ cc_test(\n     }),\n     deps = [\n         \":conv_2d_tester\",\n-        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1464,7 +1446,6 @@ cc_test(\n     }),\n     deps = [\n         \":depthwise_conv_2d_tester\",\n-        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1484,7 +1465,6 @@ cc_test(\n     tags = [\"notap\"],\n     deps = [\n         \":dynamically_quantized_fully_connected_tester\",\n-        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1501,7 +1481,6 @@ cc_test(\n     }),\n     deps = [\n         \":dynamically_quantized_conv_2d_tester\",\n-        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1518,7 +1497,6 @@ cc_test(\n     }),\n     deps = [\n         \":dynamically_quantized_transpose_conv_tester\",\n-        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n@@ -1535,14 +1513,10 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":fully_connected_tester\",\n         \":test_main\",\n-        \":weight_cache\",\n-        \":weight_cache_test_helpers\",\n         \":xnnpack_delegate_test_mode\",\n         \"//tensorflow/lite/c:c_api_types\",\n-        \"@XNNPACK\",\n         \"@com_google_googletest//:gtest\",\n     ],\n )\n@@ -1890,7 +1864,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1907,7 +1880,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_depthwise_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -1958,7 +1930,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_fully_connected_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2192,7 +2163,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_transpose_conv_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2337,7 +2307,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":test_main\",\n         \":transpose_conv_tester\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2417,7 +2386,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2433,7 +2401,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_depthwise_conv_2d_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2464,7 +2431,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_fully_connected_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\",\n@@ -2675,7 +2641,6 @@ cc_test(\n         \"//conditions:default\": [],\n     }),\n     deps = [\n-        \":fingerprint_test_helpers\",\n         \":quantized_transpose_conv_tester\",\n         \":test_main\",\n         \":xnnpack_delegate_test_mode\","
        },
        {
            "sha": "92293e082275933da8dfac0a4fc86f0499f31110",
            "filename": "tensorflow/lite/delegates/xnnpack/channelwise_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 71,
            "deletions": 20,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -24,16 +24,17 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct ChannelwiseQuantizedConv2D : DelegateTest {};\n+TEST(ChannelwiseQuantizedConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(ChannelwiseQuantizedConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -70,7 +71,11 @@ TEST_F(ChannelwiseQuantizedConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, 3x3) {\n+TEST(ChannelwiseQuantizedConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -107,7 +112,11 @@ TEST_F(ChannelwiseQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, 3x3Stride2) {\n+TEST(ChannelwiseQuantizedConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -146,7 +155,11 @@ TEST_F(ChannelwiseQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, SmallKernelWithSamePadding) {\n+TEST(ChannelwiseQuantizedConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -185,7 +198,11 @@ TEST_F(ChannelwiseQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, SmallKernelWithValidPadding) {\n+TEST(ChannelwiseQuantizedConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -224,7 +241,11 @@ TEST_F(ChannelwiseQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, StrideWithSamePadding) {\n+TEST(ChannelwiseQuantizedConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -267,7 +288,11 @@ TEST_F(ChannelwiseQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, StrideWithValidPadding) {\n+TEST(ChannelwiseQuantizedConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -310,7 +335,11 @@ TEST_F(ChannelwiseQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, DilationWithSamePadding) {\n+TEST(ChannelwiseQuantizedConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -353,7 +382,11 @@ TEST_F(ChannelwiseQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, DilationWithValidPadding) {\n+TEST(ChannelwiseQuantizedConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -396,7 +429,11 @@ TEST_F(ChannelwiseQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, ReluActivation) {\n+TEST(ChannelwiseQuantizedConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -439,7 +476,11 @@ TEST_F(ChannelwiseQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, Relu6Activation) {\n+TEST(ChannelwiseQuantizedConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -482,7 +523,11 @@ TEST_F(ChannelwiseQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, ReluMinus1To1Activation) {\n+TEST(ChannelwiseQuantizedConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -525,11 +570,13 @@ TEST_F(ChannelwiseQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, MultiThreading) {\n+TEST(ChannelwiseQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -572,15 +619,17 @@ TEST_F(ChannelwiseQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, WeightsCache) {\n+TEST(ChannelwiseQuantizedConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -624,13 +673,15 @@ TEST_F(ChannelwiseQuantizedConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedConv2D, TransientIndirectionBuffer) {\n+TEST(ChannelwiseQuantizedConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(xnnpack_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "25dada01896c349226f516615518e65e368f4f54",
            "filename": "tensorflow/lite/delegates/xnnpack/channelwise_quantized_depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 92,
            "deletions": 24,
            "changes": 116,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_depthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_depthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fchannelwise_quantized_depthwise_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -23,16 +23,18 @@ limitations under the License.\n #include <vector>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_depthwise_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct ChannelwiseQuantizedDepthwiseConv2D : DelegateTest {};\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -64,7 +66,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 2x2) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, 2x2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -97,7 +103,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 3x3) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -130,7 +140,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 3x3Stride2) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -165,7 +179,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 5x5) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, 5x5) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -198,7 +216,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 5x5Stride2) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, 5x5Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -233,7 +255,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -271,7 +297,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -309,7 +339,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -351,7 +385,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -393,7 +431,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -435,7 +477,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -477,7 +523,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DepthMultiplier) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, DepthMultiplier) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -523,7 +573,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, ReluActivation) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -565,7 +619,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, Relu6Activation) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -607,7 +665,11 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto scale_rng = std::bind(\n@@ -649,11 +711,13 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, MultiThreading) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -695,15 +759,17 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, WeightsCache) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -746,13 +812,15 @@ TEST_F(ChannelwiseQuantizedDepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(ChannelwiseQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n+TEST(ChannelwiseQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(xnnpack_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "25090bbaf2b5cf1ba90deddf48f17546c0216f33",
            "filename": "tensorflow/lite/delegates/xnnpack/conv_2d_test.cc",
            "status": "modified",
            "additions": 126,
            "deletions": 33,
            "changes": 159,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fconv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fconv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fconv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,18 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/conv_2d_tester.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct Conv2D : DelegateTest {};\n+TEST(Conv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(Conv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -50,7 +52,11 @@ TEST_F(Conv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, 3x3) {\n+TEST(Conv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -72,7 +78,11 @@ TEST_F(Conv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, 3x3Stride2) {\n+TEST(Conv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -96,7 +106,11 @@ TEST_F(Conv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, Grouped) {\n+TEST(Conv2D, Grouped) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -122,7 +136,11 @@ TEST_F(Conv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, SmallKernelWithSamePadding) {\n+TEST(Conv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -146,7 +164,11 @@ TEST_F(Conv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, SmallKernelWithValidPadding) {\n+TEST(Conv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -170,7 +192,11 @@ TEST_F(Conv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, StrideWithSamePadding) {\n+TEST(Conv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -198,7 +224,11 @@ TEST_F(Conv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, StrideWithValidPadding) {\n+TEST(Conv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -226,7 +256,11 @@ TEST_F(Conv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, DilationWithSamePadding) {\n+TEST(Conv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -254,7 +288,11 @@ TEST_F(Conv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, DilationWithValidPadding) {\n+TEST(Conv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -282,7 +320,11 @@ TEST_F(Conv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, FP16Weights) {\n+TEST(Conv2D, FP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -310,7 +352,11 @@ TEST_F(Conv2D, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, TensorWiseQuantizedInt8Weights) {\n+TEST(Conv2D, TensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -338,7 +384,11 @@ TEST_F(Conv2D, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, ChannelWiseQuantizedInt8Weights) {\n+TEST(Conv2D, ChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -366,7 +416,11 @@ TEST_F(Conv2D, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, SparseWeights) {\n+TEST(Conv2D, SparseWeights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -394,7 +448,11 @@ TEST_F(Conv2D, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, SparseFP16Weights) {\n+TEST(Conv2D, SparseFP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -423,7 +481,11 @@ TEST_F(Conv2D, SparseFP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, SparseTensorWiseQuantizedInt8Weights) {\n+TEST(Conv2D, SparseTensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -452,7 +514,11 @@ TEST_F(Conv2D, SparseTensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, SparseChannelWiseQuantizedInt8Weights) {\n+TEST(Conv2D, SparseChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -481,7 +547,11 @@ TEST_F(Conv2D, SparseChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, ReluActivation) {\n+TEST(Conv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -509,7 +579,11 @@ TEST_F(Conv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, Relu6Activation) {\n+TEST(Conv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -537,7 +611,11 @@ TEST_F(Conv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, ReluMinus1To1Activation) {\n+TEST(Conv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -565,7 +643,11 @@ TEST_F(Conv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, DISABLED_TanhActivation) {\n+TEST(Conv2D, DISABLED_TanhActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -593,7 +675,11 @@ TEST_F(Conv2D, DISABLED_TanhActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, DISABLED_SignBitActivation) {\n+TEST(Conv2D, DISABLED_SignBitActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -621,11 +707,13 @@ TEST_F(Conv2D, DISABLED_SignBitActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, MultiThreading) {\n+TEST(Conv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -653,15 +741,18 @@ TEST_F(Conv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, WeightsCache) {\n+TEST(Conv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -690,13 +781,15 @@ TEST_F(Conv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(Conv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n+TEST(Conv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.num_threads = 2;\n-  delegate_options.flags |=\n+  xnnpack_options.num_threads = 2;\n+  xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "e894bcdc2bc46a3f61b6e632b8cb800f1eb94d12",
            "filename": "tensorflow/lite/delegates/xnnpack/depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 137,
            "deletions": 33,
            "changes": 170,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdepthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdepthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdepthwise_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,18 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/depthwise_conv_2d_tester.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct DepthwiseConv2D : DelegateTest {};\n+TEST(DepthwiseConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(DepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -45,7 +47,11 @@ TEST_F(DepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, 2x2) {\n+TEST(DepthwiseConv2D, 2x2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -63,7 +69,11 @@ TEST_F(DepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, 3x3) {\n+TEST(DepthwiseConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -81,7 +91,11 @@ TEST_F(DepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, 3x3Stride2) {\n+TEST(DepthwiseConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -101,7 +115,11 @@ TEST_F(DepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, 5x5) {\n+TEST(DepthwiseConv2D, 5x5) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -119,7 +137,11 @@ TEST_F(DepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, 5x5Stride2) {\n+TEST(DepthwiseConv2D, 5x5Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto input_rng =\n@@ -139,7 +161,11 @@ TEST_F(DepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, SmallKernelWithSamePadding) {\n+TEST(DepthwiseConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -162,7 +188,11 @@ TEST_F(DepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, SmallKernelWithValidPadding) {\n+TEST(DepthwiseConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -185,7 +215,11 @@ TEST_F(DepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, StrideWithSamePadding) {\n+TEST(DepthwiseConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -212,7 +246,11 @@ TEST_F(DepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, StrideWithValidPadding) {\n+TEST(DepthwiseConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -239,7 +277,11 @@ TEST_F(DepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, DilationWithSamePadding) {\n+TEST(DepthwiseConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -266,7 +308,11 @@ TEST_F(DepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, DilationWithValidPadding) {\n+TEST(DepthwiseConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -293,7 +339,11 @@ TEST_F(DepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, DepthMultiplier) {\n+TEST(DepthwiseConv2D, DepthMultiplier) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -322,7 +372,11 @@ TEST_F(DepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, FP16Weights) {\n+TEST(DepthwiseConv2D, FP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -349,7 +403,11 @@ TEST_F(DepthwiseConv2D, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, TensorWiseQuantizedInt8Weights) {\n+TEST(DepthwiseConv2D, TensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -376,7 +434,11 @@ TEST_F(DepthwiseConv2D, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, ChannelWiseQuantizedInt8Weights) {\n+TEST(DepthwiseConv2D, ChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -403,7 +465,11 @@ TEST_F(DepthwiseConv2D, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, SparseWeights) {\n+TEST(DepthwiseConv2D, SparseWeights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -430,7 +496,11 @@ TEST_F(DepthwiseConv2D, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, SparseFP16Weights) {\n+TEST(DepthwiseConv2D, SparseFP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -458,7 +528,11 @@ TEST_F(DepthwiseConv2D, SparseFP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, SparseTensorWiseQuantizedInt8Weights) {\n+TEST(DepthwiseConv2D, SparseTensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -486,7 +560,11 @@ TEST_F(DepthwiseConv2D, SparseTensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, SparseChannelWiseQuantizedInt8Weights) {\n+TEST(DepthwiseConv2D, SparseChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -514,7 +592,11 @@ TEST_F(DepthwiseConv2D, SparseChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, ReluActivation) {\n+TEST(DepthwiseConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -541,7 +623,11 @@ TEST_F(DepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, Relu6Activation) {\n+TEST(DepthwiseConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -568,7 +654,11 @@ TEST_F(DepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, ReluMinus1To1Activation) {\n+TEST(DepthwiseConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -595,7 +685,11 @@ TEST_F(DepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, DISABLED_TanhActivation) {\n+TEST(DepthwiseConv2D, DISABLED_TanhActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -622,7 +716,11 @@ TEST_F(DepthwiseConv2D, DISABLED_TanhActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, DISABLED_SignBitActivation) {\n+TEST(DepthwiseConv2D, DISABLED_SignBitActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -649,11 +747,13 @@ TEST_F(DepthwiseConv2D, DISABLED_SignBitActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, MultiThreading) {\n+TEST(DepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -680,15 +780,17 @@ TEST_F(DepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, WeightsCache) {\n+TEST(DepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -716,13 +818,15 @@ TEST_F(DepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DepthwiseConv2D, TransientIndirectionBuffer) {\n+TEST(DepthwiseConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(xnnpack_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "59507269580cbdad0663aa0e9c2b9774d87438ae",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 155,
            "deletions": 24,
            "changes": 179,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,22 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/dynamically_quantized_conv_2d_tester.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct DynamicallyQuantizedConv2D : DelegateTest {};\n+TEST(DynamicallyQuantizedConv2D, 3x3) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(DynamicallyQuantizedConv2D, 3x3) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -50,7 +56,15 @@ TEST_F(DynamicallyQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, 3x3Stride2) {\n+TEST(DynamicallyQuantizedConv2D, 3x3Stride2) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -74,7 +88,15 @@ TEST_F(DynamicallyQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, Grouped) {\n+TEST(DynamicallyQuantizedConv2D, Grouped) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -100,7 +122,15 @@ TEST_F(DynamicallyQuantizedConv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, SmallKernelWithSamePadding) {\n+TEST(DynamicallyQuantizedConv2D, SmallKernelWithSamePadding) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -124,7 +154,15 @@ TEST_F(DynamicallyQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, SmallKernelWithValidPadding) {\n+TEST(DynamicallyQuantizedConv2D, SmallKernelWithValidPadding) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -148,7 +186,14 @@ TEST_F(DynamicallyQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, StrideWithSamePadding) {\n+TEST(DynamicallyQuantizedConv2D, StrideWithSamePadding) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -176,7 +221,15 @@ TEST_F(DynamicallyQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, StrideWithValidPadding) {\n+TEST(DynamicallyQuantizedConv2D, StrideWithValidPadding) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -204,7 +257,15 @@ TEST_F(DynamicallyQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, DilationWithSamePadding) {\n+TEST(DynamicallyQuantizedConv2D, DilationWithSamePadding) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -232,7 +293,15 @@ TEST_F(DynamicallyQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, DilationWithValidPadding) {\n+TEST(DynamicallyQuantizedConv2D, DilationWithValidPadding) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -260,7 +329,15 @@ TEST_F(DynamicallyQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, TensorWiseQuantizedInt8Weights) {\n+TEST(DynamicallyQuantizedConv2D, TensorWiseQuantizedInt8Weights) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -287,7 +364,15 @@ TEST_F(DynamicallyQuantizedConv2D, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, ChannelWiseQuantizedInt8Weights) {\n+TEST(DynamicallyQuantizedConv2D, ChannelWiseQuantizedInt8Weights) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -314,7 +399,15 @@ TEST_F(DynamicallyQuantizedConv2D, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, ReluActivation) {\n+TEST(DynamicallyQuantizedConv2D, ReluActivation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -342,7 +435,15 @@ TEST_F(DynamicallyQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, Relu6Activation) {\n+TEST(DynamicallyQuantizedConv2D, Relu6Activation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -370,7 +471,15 @@ TEST_F(DynamicallyQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, ReluMinus1To1Activation) {\n+TEST(DynamicallyQuantizedConv2D, ReluMinus1To1Activation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -398,7 +507,15 @@ TEST_F(DynamicallyQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, TanhActivation) {\n+TEST(DynamicallyQuantizedConv2D, TanhActivation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -426,7 +543,15 @@ TEST_F(DynamicallyQuantizedConv2D, TanhActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, SignBitActivation) {\n+TEST(DynamicallyQuantizedConv2D, SignBitActivation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -454,13 +579,15 @@ TEST_F(DynamicallyQuantizedConv2D, SignBitActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, MultiThreading) {\n+TEST(DynamicallyQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n   delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -488,7 +615,7 @@ TEST_F(DynamicallyQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, WeightsCache) {\n+TEST(DynamicallyQuantizedConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n@@ -498,7 +625,9 @@ TEST_F(DynamicallyQuantizedConv2D, WeightsCache) {\n   delegate_options.weights_cache = weights_cache.get();\n   delegate_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -527,14 +656,16 @@ TEST_F(DynamicallyQuantizedConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedConv2D, TransientIndirectionBuffer) {\n+TEST(DynamicallyQuantizedConv2D, TransientIndirectionBuffer) {\n   TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   xnnpack_options.num_threads = 2;\n   xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n   xnnpack_options.flags |= TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-  UseCustomDelegate(xnnpack_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "2f198a95195f11d941c8fe349dbcdd9176c66322",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_fully_connected_test.cc",
            "status": "modified",
            "additions": 107,
            "deletions": 6,
            "changes": 113,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_fully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_fully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_fully_connected_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -21,19 +21,18 @@ limitations under the License.\n #include <string>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/dynamically_quantized_fully_connected_tester.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n // Dummy class to use with parameterized test.\n class DynamicallyQuantizedFullyConnectedTest\n-    : public testing::WithParamInterface<WeightsType>,\n-      public DelegateTest {};\n+    : public testing::TestWithParam<WeightsType> {};\n \n-int GenInputChannels(const std::function<int()>& rng,\n+int GenInputChannels(const std::function<int()> &rng,\n                      WeightsType weights_type) {\n   switch (weights_type) {\n     case WeightsType::kChannelWiseQuantizedInt8:\n@@ -46,6 +45,14 @@ int GenInputChannels(const std::function<int()>& rng,\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 1D) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto channels_rng =\n@@ -64,6 +71,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 1D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 2D) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -84,6 +99,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 2D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 2DKeepDims) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -105,6 +128,13 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 2DKeepDims) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 3D) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -126,6 +156,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 3D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DReshape) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -146,6 +184,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DReshape) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DKeepDims) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -168,6 +214,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 3DKeepDims) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 4D) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -190,6 +244,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 4D) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, 4DKeepDims) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -213,6 +275,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, 4DKeepDims) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, NoBias) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -234,6 +304,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, NoBias) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluActivation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -255,6 +333,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluActivation) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, Relu6Activation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -276,6 +362,14 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, Relu6Activation) {\n }\n \n TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluMinus1To1Activation) {\n+  TfLiteXNNPackDelegateOptions delegate_options =\n+      TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -299,8 +393,13 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, ReluMinus1To1Activation) {\n TEST_P(DynamicallyQuantizedFullyConnectedTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n+  delegate_options.flags |=\n+      TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -330,7 +429,9 @@ TEST_P(DynamicallyQuantizedFullyConnectedTest, WeightsCache) {\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng ="
        },
        {
            "sha": "de863e4f1e2125e882f098f951c4ee9365c1d829",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_transpose_conv_test.cc",
            "status": "modified",
            "additions": 46,
            "deletions": 14,
            "changes": 60,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,18 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n+#include \"tensorflow/lite/core/c/common.h\"\n #include \"tensorflow/lite/delegates/xnnpack/dynamically_quantized_transpose_conv_tester.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct DynamicallyQuantizedTransposeConvTest : DelegateTest {};\n+TEST(DynamicallyQuantizedTransposeConvTest, 2x2Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -49,7 +51,10 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, 3x3Stride2) {\n+TEST(DynamicallyQuantizedTransposeConvTest, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -70,7 +75,11 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, 4x4Stride2) {\n+TEST(DynamicallyQuantizedTransposeConvTest, 4x4Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -91,7 +100,11 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, 4x4Stride4) {\n+TEST(DynamicallyQuantizedTransposeConvTest, 4x4Stride4) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -112,7 +125,11 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n+TEST(DynamicallyQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -136,7 +153,10 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n+TEST(DynamicallyQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -160,7 +180,11 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, StrideWithSamePadding) {\n+TEST(DynamicallyQuantizedTransposeConvTest, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -188,7 +212,11 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, StrideWithValidPadding) {\n+TEST(DynamicallyQuantizedTransposeConvTest, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -216,11 +244,13 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, MultiThreading) {\n+TEST(DynamicallyQuantizedTransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -249,15 +279,17 @@ TEST_F(DynamicallyQuantizedTransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(DynamicallyQuantizedTransposeConvTest, WeightsCache) {\n+TEST(DynamicallyQuantizedTransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "3bdcd343373bac23f3b12d1d647d9f8e1f69d5e7",
            "filename": "tensorflow/lite/delegates/xnnpack/dynamically_quantized_transpose_conv_tester.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_tester.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_tester.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fdynamically_quantized_transpose_conv_tester.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -55,12 +55,10 @@ void DynamicallyQuantizedTransposeConvTester::Test(\n   const Model* model = GetModel(buffer.data());\n \n   std::unique_ptr<Interpreter> delegate_interpreter;\n-  ASSERT_EQ(\n-      InterpreterBuilder(\n-          model,\n-          ::tflite::ops::builtin::BuiltinOpResolverWithoutDefaultDelegates())(\n-          &delegate_interpreter),\n-      kTfLiteOk);\n+  ASSERT_EQ(InterpreterBuilder(\n+                model, ::tflite::ops::builtin::BuiltinOpResolverWithXNNPACK())(\n+                &delegate_interpreter),\n+            kTfLiteOk);\n   std::unique_ptr<Interpreter> default_interpreter;\n   ASSERT_EQ(\n       InterpreterBuilder("
        },
        {
            "sha": "29edbe5a35c841f2c91ba9aa38923a26f3de9a3b",
            "filename": "tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h",
            "status": "removed",
            "additions": 0,
            "deletions": 112,
            "changes": 112,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6160600087fb23d583897b0300a461526e27e026/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffingerprint_test_helpers.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6160600087fb23d583897b0300a461526e27e026/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffingerprint_test_helpers.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffingerprint_test_helpers.h?ref=6160600087fb23d583897b0300a461526e27e026",
            "patch": "@@ -1,112 +0,0 @@\n-/* Copyright 2025 The TensorFlow Authors. All Rights Reserved.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-#ifndef TENSORFLOW_LITE_DELEGATES_XNNPACK_FINGERPRINT_TEST_HELPERS_H_\n-#define TENSORFLOW_LITE_DELEGATES_XNNPACK_FINGERPRINT_TEST_HELPERS_H_\n-\n-#include <memory>\n-\n-#include <gmock/gmock.h>\n-#include <gtest/gtest.h>\n-#include \"experimental.h\"  // from @XNNPACK\n-#include \"tensorflow/lite/c/common.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/weight_cache.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/weight_cache_test_helpers.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n-\n-namespace tflite::xnnpack {\n-\n-struct TfLiteDelegateDeleter {\n-  void operator()(TfLiteDelegate* delegate) {\n-    TfLiteXNNPackDelegateDelete(delegate);\n-  }\n-};\n-\n-using TfLiteDelegatePtr =\n-    std::unique_ptr<TfLiteDelegate, TfLiteDelegateDeleter>;\n-\n-struct DelegateTest : public virtual testing::Test {\n-  void SetUp() override {\n-    TfLiteXNNPackDelegateOptions delegate_options =\n-        TfLiteXNNPackDelegateOptionsDefault();\n-\n-    // By default, we try to setup a file weight cache to also check fingerprint\n-    // generation. If the test system doesn't support a file system, then the\n-    // cache file will be invalid.\n-    if (cache_file.IsValid()) {\n-      xnn_clear_fingerprints();\n-      delegate_options.weight_cache_file_path = cache_file.GetCPath();\n-      delegate_options.weight_cache_file_descriptor =\n-          cache_file.Duplicate().Release();\n-      delegate_options.flags |=\n-          TFLITE_XNNPACK_DELEGATE_FLAG_ENABLE_LATEST_OPERATORS;\n-      check_for_cache_fingerprints = true;\n-    }\n-\n-    xnnpack_delegate =\n-        TfLiteDelegatePtr(TfLiteXNNPackDelegateCreate(&delegate_options));\n-    ASSERT_THAT(xnnpack_delegate, testing::NotNull());\n-  }\n-\n-  void TearDown() override {\n-    if (check_for_cache_fingerprints) {\n-      ASSERT_TRUE(cache_file.IsValid());\n-      EXPECT_TRUE(IsCompatibleCacheFile(cache_file));\n-      if (AlterXNNPackFingerprints()) {\n-        EXPECT_FALSE(IsCompatibleCacheFile(cache_file));\n-      }\n-    }\n-  }\n-\n-  // Artificially change fingerprint values.\n-  //\n-  // This allows us to check that changing a fingerprint value will make the\n-  // cache file incompatible.\n-  //\n-  // Returns the current number of fingerprints.\n-  int AlterXNNPackFingerprints() {\n-    int i = 0;\n-    int modified = 0;\n-    for (const xnn_fingerprint* fingerprint = xnn_get_fingerprint_by_idx(i);\n-         fingerprint != nullptr;\n-         fingerprint = xnn_get_fingerprint_by_idx(++i)) {\n-      xnn_fingerprint new_fingerprint = *fingerprint;\n-      ++new_fingerprint.value;\n-      xnn_set_fingerprint(new_fingerprint);\n-      ++modified;\n-    }\n-    return modified;\n-  }\n-\n-  // Replaces the xnnpack delegate with a custom one.\n-  void UseCustomDelegate(const TfLiteXNNPackDelegateOptions& delegate_options) {\n-    check_for_cache_fingerprints = false;\n-    xnnpack_delegate =\n-        TfLiteDelegatePtr(TfLiteXNNPackDelegateCreate(&delegate_options));\n-    ASSERT_THAT(xnnpack_delegate, testing::NotNull());\n-  }\n-\n-  // Replaces the xnnpack delegate with one that sets up a file backed weight\n-  // cache.\n-  void UseDelegateWithFileWeightCache() {}\n-\n-  // The default delegate is created in a generic way.\n-  TfLiteDelegatePtr xnnpack_delegate;\n-  tflite::xnnpack::TempFileDesc cache_file;\n-  bool check_for_cache_fingerprints = false;\n-};\n-\n-}  // namespace tflite::xnnpack\n-\n-#endif  // TENSORFLOW_LITE_DELEGATES_XNNPACK_FINGERPRINT_TEST_HELPERS_H_"
        },
        {
            "sha": "92a6074c464f85dc5f17ca0156f16925310db997",
            "filename": "tensorflow/lite/delegates/xnnpack/fully_connected_test.cc",
            "status": "modified",
            "additions": 123,
            "deletions": 29,
            "changes": 152,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ffully_connected_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,18 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/fully_connected_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct FullyConnectedTest : public DelegateTest {};\n+TEST(FullyConnected, 1D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(FullyConnectedTest, 1D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto channels_rng =\n@@ -43,7 +45,11 @@ TEST_F(FullyConnectedTest, 1D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 1DKeepDims) {\n+TEST(FullyConnected, 1DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto channels_rng =\n@@ -59,7 +65,11 @@ TEST_F(FullyConnectedTest, 1DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 2D) {\n+TEST(FullyConnected, 2D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -77,7 +87,11 @@ TEST_F(FullyConnectedTest, 2D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 2DKeepDims) {\n+TEST(FullyConnected, 2DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -96,7 +110,11 @@ TEST_F(FullyConnectedTest, 2DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 3D) {\n+TEST(FullyConnected, 3D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -115,7 +133,11 @@ TEST_F(FullyConnectedTest, 3D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 3DReshape) {\n+TEST(FullyConnected, 3DReshape) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -134,7 +156,11 @@ TEST_F(FullyConnectedTest, 3DReshape) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 3DKeepDims) {\n+TEST(FullyConnected, 3DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -154,7 +180,11 @@ TEST_F(FullyConnectedTest, 3DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 4D) {\n+TEST(FullyConnected, 4D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -174,7 +204,11 @@ TEST_F(FullyConnectedTest, 4D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, 4DKeepDims) {\n+TEST(FullyConnected, 4DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto shape_rng =\n@@ -195,7 +229,11 @@ TEST_F(FullyConnectedTest, 4DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, NoBias) {\n+TEST(FullyConnected, NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -214,7 +252,11 @@ TEST_F(FullyConnectedTest, NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, FP16Weights) {\n+TEST(FullyConnected, FP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -233,7 +275,11 @@ TEST_F(FullyConnectedTest, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, FP16WeightsNoBias) {\n+TEST(FullyConnected, FP16WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -253,7 +299,11 @@ TEST_F(FullyConnectedTest, FP16WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, DynamicWeights) {\n+TEST(FullyConnected, DynamicWeights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -272,7 +322,11 @@ TEST_F(FullyConnectedTest, DynamicWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, DynamicWeightsNoBias) {\n+TEST(FullyConnected, DynamicWeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -292,7 +346,11 @@ TEST_F(FullyConnectedTest, DynamicWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, DynamicBias) {\n+TEST(FullyConnected, DynamicBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -311,7 +369,11 @@ TEST_F(FullyConnectedTest, DynamicBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, DynamicWeightsAndBias) {\n+TEST(FullyConnected, DynamicWeightsAndBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -331,7 +393,11 @@ TEST_F(FullyConnectedTest, DynamicWeightsAndBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, TensorWiseQuantizedInt8Weights) {\n+TEST(FullyConnected, TensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -350,7 +416,11 @@ TEST_F(FullyConnectedTest, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, TensorWiseQuantizedInt8WeightsNoBias) {\n+TEST(FullyConnected, TensorWiseQuantizedInt8WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -370,7 +440,11 @@ TEST_F(FullyConnectedTest, TensorWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, ChannelWiseQuantizedInt8Weights) {\n+TEST(FullyConnected, ChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -389,7 +463,11 @@ TEST_F(FullyConnectedTest, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n+TEST(FullyConnected, ChannelWiseQuantizedInt8WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -409,7 +487,11 @@ TEST_F(FullyConnectedTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, ReluActivation) {\n+TEST(FullyConnected, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -428,7 +510,11 @@ TEST_F(FullyConnectedTest, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, Relu6Activation) {\n+TEST(FullyConnected, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -447,7 +533,11 @@ TEST_F(FullyConnectedTest, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, ReluMinus1To1Activation) {\n+TEST(FullyConnected, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -466,11 +556,13 @@ TEST_F(FullyConnectedTest, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, MultiThreading) {\n+TEST(FullyConnected, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -489,15 +581,17 @@ TEST_F(FullyConnectedTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(FullyConnectedTest, WeightsCache) {\n+TEST(FullyConnected, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "f67ba714b01cc82270f2fed799a5bb33f76bdbec",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 75,
            "deletions": 22,
            "changes": 97,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -21,16 +21,17 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct SignedQuantizedConv2D : DelegateTest {};\n+TEST(SignedQuantizedConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(SignedQuantizedConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -58,7 +59,11 @@ TEST_F(SignedQuantizedConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, 3x3) {\n+TEST(SignedQuantizedConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -86,7 +91,11 @@ TEST_F(SignedQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, 3x3Stride2) {\n+TEST(SignedQuantizedConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -116,7 +125,11 @@ TEST_F(SignedQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, Grouped) {\n+TEST(SignedQuantizedConv2D, Grouped) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -150,7 +163,11 @@ TEST_F(SignedQuantizedConv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, SmallKernelWithSamePadding) {\n+TEST(SignedQuantizedConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -180,7 +197,11 @@ TEST_F(SignedQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, SmallKernelWithValidPadding) {\n+TEST(SignedQuantizedConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -210,7 +231,11 @@ TEST_F(SignedQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, StrideWithSamePadding) {\n+TEST(SignedQuantizedConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -244,7 +269,11 @@ TEST_F(SignedQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, StrideWithValidPadding) {\n+TEST(SignedQuantizedConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -278,7 +307,11 @@ TEST_F(SignedQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, DilationWithSamePadding) {\n+TEST(SignedQuantizedConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -312,7 +345,11 @@ TEST_F(SignedQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, DilationWithValidPadding) {\n+TEST(SignedQuantizedConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -346,7 +383,11 @@ TEST_F(SignedQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, ReluActivation) {\n+TEST(SignedQuantizedConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -380,7 +421,11 @@ TEST_F(SignedQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, Relu6Activation) {\n+TEST(SignedQuantizedConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -414,7 +459,11 @@ TEST_F(SignedQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, ReluMinus1To1Activation) {\n+TEST(SignedQuantizedConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -448,11 +497,13 @@ TEST_F(SignedQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, MultiThreading) {\n+TEST(SignedQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -486,13 +537,15 @@ TEST_F(SignedQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n+TEST(SignedQuantizedConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.num_threads = 2;\n-  delegate_options.flags |=\n+  xnnpack_options.num_threads = 2;\n+  xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "3acfbaaf34778ea4b06948caa2db6b250667275b",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 95,
            "deletions": 27,
            "changes": 122,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_depthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_depthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_depthwise_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -20,16 +20,18 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n+#include \"tensorflow/lite/c/c_api_types.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_depthwise_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct SignedQuantizedDepthwiseConv2D : DelegateTest {};\n+TEST(SignedQuantizedDepthwiseConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -52,7 +54,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, 2x2) {\n+TEST(SignedQuantizedDepthwiseConv2D, 2x2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -76,7 +82,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, 3x3) {\n+TEST(SignedQuantizedDepthwiseConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -100,7 +110,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n+TEST(SignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -126,7 +140,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, 5x5) {\n+TEST(SignedQuantizedDepthwiseConv2D, 5x5) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -150,7 +168,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n+TEST(SignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -176,7 +198,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n+TEST(SignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -205,7 +231,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n+TEST(SignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -234,7 +264,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n+TEST(SignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -267,7 +301,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n+TEST(SignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -300,7 +338,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n+TEST(SignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -333,7 +375,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n+TEST(SignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -366,7 +412,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n+TEST(SignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -401,7 +451,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, ReluActivation) {\n+TEST(SignedQuantizedDepthwiseConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -434,7 +488,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, Relu6Activation) {\n+TEST(SignedQuantizedDepthwiseConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -467,7 +525,11 @@ TEST_F(SignedQuantizedDepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n+TEST(SignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -500,11 +562,13 @@ TEST_F(SignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, MultiThreading) {\n+TEST(SignedQuantizedDepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -537,15 +601,17 @@ TEST_F(SignedQuantizedDepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, WeightsCache) {\n+TEST(SignedQuantizedDepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -579,13 +645,15 @@ TEST_F(SignedQuantizedDepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n+TEST(SignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.num_threads = 2;\n-  delegate_options.flags |=\n+  xnnpack_options.num_threads = 2;\n+  xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "3097d314a3a6ab56e379cbc2cb3bb33bc7ff3f3a",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_fully_connected_test.cc",
            "status": "modified",
            "additions": 72,
            "deletions": 19,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_fully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_fully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_fully_connected_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -21,16 +21,17 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_fully_connected_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct SignedQuantizedFullyConnected : DelegateTest {};\n+TEST(SignedQuantizedFullyConnected, 1D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(SignedQuantizedFullyConnected, 1D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -51,7 +52,11 @@ TEST_F(SignedQuantizedFullyConnected, 1D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 1DKeepDims) {\n+TEST(SignedQuantizedFullyConnected, 1DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -73,7 +78,11 @@ TEST_F(SignedQuantizedFullyConnected, 1DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 2D) {\n+TEST(SignedQuantizedFullyConnected, 2D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -97,7 +106,11 @@ TEST_F(SignedQuantizedFullyConnected, 2D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 2DKeepDims) {\n+TEST(SignedQuantizedFullyConnected, 2DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -122,7 +135,11 @@ TEST_F(SignedQuantizedFullyConnected, 2DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 3D) {\n+TEST(SignedQuantizedFullyConnected, 3D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -147,7 +164,11 @@ TEST_F(SignedQuantizedFullyConnected, 3D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 3DReshape) {\n+TEST(SignedQuantizedFullyConnected, 3DReshape) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -172,7 +193,11 @@ TEST_F(SignedQuantizedFullyConnected, 3DReshape) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 3DKeepDims) {\n+TEST(SignedQuantizedFullyConnected, 3DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -198,7 +223,11 @@ TEST_F(SignedQuantizedFullyConnected, 3DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 4D) {\n+TEST(SignedQuantizedFullyConnected, 4D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -224,7 +253,11 @@ TEST_F(SignedQuantizedFullyConnected, 4D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, 4DKeepDims) {\n+TEST(SignedQuantizedFullyConnected, 4DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -251,7 +284,11 @@ TEST_F(SignedQuantizedFullyConnected, 4DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, NoBias) {\n+TEST(SignedQuantizedFullyConnected, NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -276,7 +313,11 @@ TEST_F(SignedQuantizedFullyConnected, NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, ReluActivation) {\n+TEST(SignedQuantizedFullyConnected, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -301,7 +342,11 @@ TEST_F(SignedQuantizedFullyConnected, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, Relu6Activation) {\n+TEST(SignedQuantizedFullyConnected, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -326,7 +371,11 @@ TEST_F(SignedQuantizedFullyConnected, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n+TEST(SignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -351,11 +400,13 @@ TEST_F(SignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, MultiThreading) {\n+TEST(SignedQuantizedFullyConnected, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -380,15 +431,17 @@ TEST_F(SignedQuantizedFullyConnected, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedFullyConnected, WeightsCache) {\n+TEST(SignedQuantizedFullyConnected, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "7daae13ebdea16f7111cfed06f8a0ab9dc0319fb",
            "filename": "tensorflow/lite/delegates/xnnpack/signed_quantized_transpose_conv_test.cc",
            "status": "modified",
            "additions": 101,
            "deletions": 26,
            "changes": 127,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_transpose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_transpose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fsigned_quantized_transpose_conv_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -20,16 +20,17 @@ limitations under the License.\n \n #include <gtest/gtest.h>\n #include \"tensorflow/lite/c/c_api_types.h\"\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_transpose_conv_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct SignedQuantizedTransposeConvTest : DelegateTest {};\n+TEST(SignedQuantizedTransposeConvTest, 2x2Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(SignedQuantizedTransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -51,7 +52,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n+TEST(SignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -74,7 +79,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 3x3Stride2) {\n+TEST(SignedQuantizedTransposeConvTest, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -96,7 +105,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n+TEST(SignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -119,7 +132,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride2) {\n+TEST(SignedQuantizedTransposeConvTest, 4x4Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -141,7 +158,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n+TEST(SignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -164,7 +185,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride4) {\n+TEST(SignedQuantizedTransposeConvTest, 4x4Stride4) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -186,7 +211,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n+TEST(SignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -209,7 +238,11 @@ TEST_F(SignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n+TEST(SignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -234,7 +267,11 @@ TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n+TEST(SignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -260,7 +297,11 @@ TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n+TEST(SignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -285,7 +326,11 @@ TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n+TEST(SignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -311,7 +356,11 @@ TEST_F(SignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n+TEST(SignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -340,7 +389,11 @@ TEST_F(SignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n+TEST(SignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -370,7 +423,11 @@ TEST_F(SignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n+TEST(SignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -399,7 +456,11 @@ TEST_F(SignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n+TEST(SignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -429,7 +490,11 @@ TEST_F(SignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, SparseWeights) {\n+TEST(SignedQuantizedTransposeConvTest, SparseWeights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -459,7 +524,11 @@ TEST_F(SignedQuantizedTransposeConvTest, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n+TEST(SignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -490,11 +559,13 @@ TEST_F(SignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, MultiThreading) {\n+TEST(SignedQuantizedTransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -524,11 +595,13 @@ TEST_F(SignedQuantizedTransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n+TEST(SignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -559,15 +632,17 @@ TEST_F(SignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(SignedQuantizedTransposeConvTest, WeightsCache) {\n+TEST(SignedQuantizedTransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "260fd87e282a6326db31415525ef3d71bb953fe9",
            "filename": "tensorflow/lite/delegates/xnnpack/transpose_conv_test.cc",
            "status": "modified",
            "additions": 161,
            "deletions": 38,
            "changes": 199,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ftranspose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ftranspose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Ftranspose_conv_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,17 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/transpose_conv_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct TransposeConvTest : DelegateTest {};\n+TEST(TransposeConvTest, 2x2Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(TransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -49,7 +50,11 @@ TEST_F(TransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 2x2Stride2NoBias) {\n+TEST(TransposeConvTest, 2x2Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -71,7 +76,11 @@ TEST_F(TransposeConvTest, 2x2Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 3x3Stride2) {\n+TEST(TransposeConvTest, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -92,7 +101,11 @@ TEST_F(TransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 3x3Stride2NoBias) {\n+TEST(TransposeConvTest, 3x3Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -114,7 +127,11 @@ TEST_F(TransposeConvTest, 3x3Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 4x4Stride2) {\n+TEST(TransposeConvTest, 4x4Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -135,7 +152,11 @@ TEST_F(TransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 4x4Stride2NoBias) {\n+TEST(TransposeConvTest, 4x4Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -157,7 +178,11 @@ TEST_F(TransposeConvTest, 4x4Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 4x4Stride4) {\n+TEST(TransposeConvTest, 4x4Stride4) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -178,7 +203,11 @@ TEST_F(TransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, 4x4Stride4NoBias) {\n+TEST(TransposeConvTest, 4x4Stride4NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -200,7 +229,11 @@ TEST_F(TransposeConvTest, 4x4Stride4NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SmallKernelWithSamePadding) {\n+TEST(TransposeConvTest, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -224,7 +257,11 @@ TEST_F(TransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n+TEST(TransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -249,7 +286,11 @@ TEST_F(TransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SmallKernelWithValidPadding) {\n+TEST(TransposeConvTest, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -273,7 +314,11 @@ TEST_F(TransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n+TEST(TransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -298,7 +343,11 @@ TEST_F(TransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, StrideWithSamePadding) {\n+TEST(TransposeConvTest, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -326,7 +375,11 @@ TEST_F(TransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, StrideWithSamePaddingNoBias) {\n+TEST(TransposeConvTest, StrideWithSamePaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -355,7 +408,11 @@ TEST_F(TransposeConvTest, StrideWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, StrideWithValidPadding) {\n+TEST(TransposeConvTest, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -383,7 +440,11 @@ TEST_F(TransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, StrideWithValidPaddingNoBias) {\n+TEST(TransposeConvTest, StrideWithValidPaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -412,7 +473,11 @@ TEST_F(TransposeConvTest, StrideWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, FP16Weights) {\n+TEST(TransposeConvTest, FP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -441,7 +506,11 @@ TEST_F(TransposeConvTest, FP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, FP16WeightsNoBias) {\n+TEST(TransposeConvTest, FP16WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -471,7 +540,11 @@ TEST_F(TransposeConvTest, FP16WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, TensorWiseQuantizedInt8Weights) {\n+TEST(TransposeConvTest, TensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -500,7 +573,11 @@ TEST_F(TransposeConvTest, TensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, TensorWiseQuantizedInt8WeightsNoBias) {\n+TEST(TransposeConvTest, TensorWiseQuantizedInt8WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -530,7 +607,11 @@ TEST_F(TransposeConvTest, TensorWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, ChannelWiseQuantizedInt8Weights) {\n+TEST(TransposeConvTest, ChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -559,7 +640,11 @@ TEST_F(TransposeConvTest, ChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n+TEST(TransposeConvTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -589,7 +674,11 @@ TEST_F(TransposeConvTest, ChannelWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseWeights) {\n+TEST(TransposeConvTest, SparseWeights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -618,7 +707,11 @@ TEST_F(TransposeConvTest, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseWeightsNoBias) {\n+TEST(TransposeConvTest, SparseWeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -648,7 +741,11 @@ TEST_F(TransposeConvTest, SparseWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseFP16Weights) {\n+TEST(TransposeConvTest, SparseFP16Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -678,7 +775,11 @@ TEST_F(TransposeConvTest, SparseFP16Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseFP16WeightsNoBias) {\n+TEST(TransposeConvTest, SparseFP16WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -709,7 +810,11 @@ TEST_F(TransposeConvTest, SparseFP16WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseTensorWiseQuantizedInt8Weights) {\n+TEST(TransposeConvTest, SparseTensorWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -739,7 +844,11 @@ TEST_F(TransposeConvTest, SparseTensorWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseTensorWiseQuantizedInt8WeightsNoBias) {\n+TEST(TransposeConvTest, SparseTensorWiseQuantizedInt8WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -770,7 +879,11 @@ TEST_F(TransposeConvTest, SparseTensorWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseChannelWiseQuantizedInt8Weights) {\n+TEST(TransposeConvTest, SparseChannelWiseQuantizedInt8Weights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -800,7 +913,11 @@ TEST_F(TransposeConvTest, SparseChannelWiseQuantizedInt8Weights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, SparseChannelWiseQuantizedInt8WeightsNoBias) {\n+TEST(TransposeConvTest, SparseChannelWiseQuantizedInt8WeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -831,11 +948,13 @@ TEST_F(TransposeConvTest, SparseChannelWiseQuantizedInt8WeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, MultiThreading) {\n+TEST(TransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -864,11 +983,13 @@ TEST_F(TransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, MultiThreadingNoBias) {\n+TEST(TransposeConvTest, MultiThreadingNoBias) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -898,15 +1019,17 @@ TEST_F(TransposeConvTest, MultiThreadingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(TransposeConvTest, WeightsCache) {\n+TEST(TransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "6660fc5af75ebe20e7cd61b16f6e3a08c4e560c4",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_conv_2d_test.cc",
            "status": "modified",
            "additions": 75,
            "deletions": 22,
            "changes": 97,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -20,16 +20,17 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct UnsignedQuantizedConv2D : DelegateTest {};\n+TEST(UnsignedQuantizedConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(UnsignedQuantizedConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -60,7 +61,11 @@ TEST_F(UnsignedQuantizedConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, 3x3) {\n+TEST(UnsignedQuantizedConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -91,7 +96,11 @@ TEST_F(UnsignedQuantizedConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, 3x3Stride2) {\n+TEST(UnsignedQuantizedConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -128,7 +137,11 @@ TEST_F(UnsignedQuantizedConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, Grouped) {\n+TEST(UnsignedQuantizedConv2D, Grouped) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -161,7 +174,11 @@ TEST_F(UnsignedQuantizedConv2D, Grouped) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, SmallKernelWithSamePadding) {\n+TEST(UnsignedQuantizedConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -194,7 +211,11 @@ TEST_F(UnsignedQuantizedConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, SmallKernelWithValidPadding) {\n+TEST(UnsignedQuantizedConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -227,7 +248,11 @@ TEST_F(UnsignedQuantizedConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, StrideWithSamePadding) {\n+TEST(UnsignedQuantizedConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -264,7 +289,11 @@ TEST_F(UnsignedQuantizedConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, StrideWithValidPadding) {\n+TEST(UnsignedQuantizedConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -301,7 +330,11 @@ TEST_F(UnsignedQuantizedConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, DilationWithSamePadding) {\n+TEST(UnsignedQuantizedConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -338,7 +371,11 @@ TEST_F(UnsignedQuantizedConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, DilationWithValidPadding) {\n+TEST(UnsignedQuantizedConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -375,7 +412,11 @@ TEST_F(UnsignedQuantizedConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, ReluActivation) {\n+TEST(UnsignedQuantizedConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -412,7 +453,11 @@ TEST_F(UnsignedQuantizedConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, Relu6Activation) {\n+TEST(UnsignedQuantizedConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -449,7 +494,11 @@ TEST_F(UnsignedQuantizedConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, ReluMinus1To1Activation) {\n+TEST(UnsignedQuantizedConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -486,11 +535,13 @@ TEST_F(UnsignedQuantizedConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, MultiThreading) {\n+TEST(UnsignedQuantizedConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -527,13 +578,15 @@ TEST_F(UnsignedQuantizedConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n+TEST(UnsignedQuantizedConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.num_threads = 2;\n-  delegate_options.flags |=\n+  xnnpack_options.num_threads = 2;\n+  xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "7facb9787338c7c2393659f6118db888e278cb95",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_depthwise_conv_2d_test.cc",
            "status": "modified",
            "additions": 94,
            "deletions": 27,
            "changes": 121,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_depthwise_conv_2d_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_depthwise_conv_2d_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_depthwise_conv_2d_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -20,16 +20,17 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_depthwise_conv_2d_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct UnsignedQuantizedDepthwiseConv2D : DelegateTest {};\n+TEST(UnsignedQuantizedDepthwiseConv2D, 1x1) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, 1x1) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -55,7 +56,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, 1x1) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, 2x2) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, 2x2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -82,7 +87,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, 2x2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, 3x3) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, 3x3) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -109,7 +118,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, 3x3) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -138,7 +151,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, 5x5) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, 5x5) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -165,7 +182,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, 5x5) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -194,7 +215,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, 5x5Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -226,7 +251,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -258,7 +287,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -294,7 +327,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -330,7 +367,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -366,7 +407,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, DilationWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -402,7 +447,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, DilationWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -440,7 +489,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, DepthMultiplier) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, ReluActivation) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -476,7 +529,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, Relu6Activation) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -512,7 +569,11 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -548,11 +609,13 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, MultiThreading) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -588,15 +651,17 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, WeightsCache) {\n+TEST(UnsignedQuantizedDepthwiseConv2D, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -633,13 +698,15 @@ TEST_F(UnsignedQuantizedDepthwiseConv2D, WeightsCache) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n-  TfLiteXNNPackDelegateOptions delegate_options =\n+TEST(UnsignedQuantizedDepthwiseConv2D, TransientIndirectionBuffer) {\n+  TfLiteXNNPackDelegateOptions xnnpack_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n-  delegate_options.num_threads = 2;\n-  delegate_options.flags |=\n+  xnnpack_options.num_threads = 2;\n+  xnnpack_options.flags |=\n       TFLITE_XNNPACK_DELEGATE_FLAG_TRANSIENT_INDIRECTION_BUFFER;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&xnnpack_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "90df47c884d0421972de6a89c2dde033996c55b9",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_fully_connected_test.cc",
            "status": "modified",
            "additions": 68,
            "deletions": 17,
            "changes": 85,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_fully_connected_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_fully_connected_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_fully_connected_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -20,16 +20,17 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_fully_connected_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct UnsignedQuantizedFullyConnected : DelegateTest {};\n+TEST(UnsignedQuantizedFullyConnected, 1D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(UnsignedQuantizedFullyConnected, 1D) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -53,7 +54,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 1D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 1DKeepDims) {\n+TEST(UnsignedQuantizedFullyConnected, 1DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -78,7 +83,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 1DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 2D) {\n+TEST(UnsignedQuantizedFullyConnected, 2D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -105,7 +114,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 2D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 2DKeepDims) {\n+TEST(UnsignedQuantizedFullyConnected, 2DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -133,7 +146,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 2DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 3D) {\n+TEST(UnsignedQuantizedFullyConnected, 3D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -161,7 +178,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 3D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 3DReshape) {\n+TEST(UnsignedQuantizedFullyConnected, 3DReshape) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -189,7 +210,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 3DReshape) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 3DKeepDims) {\n+TEST(UnsignedQuantizedFullyConnected, 3DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -218,7 +243,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 3DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 4D) {\n+TEST(UnsignedQuantizedFullyConnected, 4D) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -247,7 +276,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 4D) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, 4DKeepDims) {\n+TEST(UnsignedQuantizedFullyConnected, 4DKeepDims) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -277,7 +310,11 @@ TEST_F(UnsignedQuantizedFullyConnected, 4DKeepDims) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, NoBias) {\n+TEST(UnsignedQuantizedFullyConnected, NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -305,7 +342,11 @@ TEST_F(UnsignedQuantizedFullyConnected, NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, ReluActivation) {\n+TEST(UnsignedQuantizedFullyConnected, ReluActivation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -333,7 +374,11 @@ TEST_F(UnsignedQuantizedFullyConnected, ReluActivation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, Relu6Activation) {\n+TEST(UnsignedQuantizedFullyConnected, Relu6Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -361,7 +406,11 @@ TEST_F(UnsignedQuantizedFullyConnected, Relu6Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n+TEST(UnsignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto zero_point_rng = std::bind(std::uniform_int_distribution<int32_t>(\n@@ -389,11 +438,13 @@ TEST_F(UnsignedQuantizedFullyConnected, ReluMinus1To1Activation) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedFullyConnected, MultiThreading) {\n+TEST(UnsignedQuantizedFullyConnected, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "8e6a779a1979f958c44651f4dbc56948fd48ce72",
            "filename": "tensorflow/lite/delegates/xnnpack/unsigned_quantized_transpose_conv_test.cc",
            "status": "modified",
            "additions": 101,
            "deletions": 26,
            "changes": 127,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_transpose_conv_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_transpose_conv_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Funsigned_quantized_transpose_conv_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -19,16 +19,17 @@ limitations under the License.\n #include <random>\n \n #include <gtest/gtest.h>\n-#include \"tensorflow/lite/delegates/xnnpack/fingerprint_test_helpers.h\"\n #include \"tensorflow/lite/delegates/xnnpack/quantized_transpose_conv_tester.h\"\n #include \"tensorflow/lite/delegates/xnnpack/xnnpack_delegate.h\"\n \n namespace tflite {\n namespace xnnpack {\n \n-struct UnsignedQuantizedTransposeConvTest : DelegateTest {};\n+TEST(UnsignedQuantizedTransposeConvTest, 2x2Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 2x2Stride2) {\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -50,7 +51,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 2x2Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -73,7 +78,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 2x2Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 3x3Stride2) {\n+TEST(UnsignedQuantizedTransposeConvTest, 3x3Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -95,7 +104,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 3x3Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -118,7 +131,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 3x3Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride2) {\n+TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride2) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -140,7 +157,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride2) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -163,7 +184,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride2NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride4) {\n+TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride4) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -185,7 +210,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride4) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto output_rng =\n@@ -208,7 +237,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, 4x4Stride4NoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n+TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -233,7 +266,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -259,7 +296,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n+TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -284,7 +325,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -310,7 +355,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, SmallKernelWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n+TEST(UnsignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -339,7 +388,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithSamePadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -369,7 +422,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithSamePaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n+TEST(UnsignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -398,7 +455,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithValidPadding) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -428,7 +489,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, StrideWithValidPaddingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, SparseWeights) {\n+TEST(UnsignedQuantizedTransposeConvTest, SparseWeights) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -458,7 +523,11 @@ TEST_F(UnsignedQuantizedTransposeConvTest, SparseWeights) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(nullptr),\n+                       TfLiteXNNPackDelegateDelete);\n+\n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n   auto batch_rng =\n@@ -489,11 +558,13 @@ TEST_F(UnsignedQuantizedTransposeConvTest, SparseWeightsNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, MultiThreading) {\n+TEST(UnsignedQuantizedTransposeConvTest, MultiThreading) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -523,11 +594,13 @@ TEST_F(UnsignedQuantizedTransposeConvTest, MultiThreading) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n+TEST(UnsignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   delegate_options.num_threads = 2;\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());\n@@ -558,15 +631,17 @@ TEST_F(UnsignedQuantizedTransposeConvTest, MultiThreadingNoBias) {\n       .Test(xnnpack_delegate.get());\n }\n \n-TEST_F(UnsignedQuantizedTransposeConvTest, WeightsCache) {\n+TEST(UnsignedQuantizedTransposeConvTest, WeightsCache) {\n   TfLiteXNNPackDelegateOptions delegate_options =\n       TfLiteXNNPackDelegateOptionsDefault();\n   std::unique_ptr<TfLiteXNNPackDelegateWeightsCache,\n                   decltype(&TfLiteXNNPackDelegateWeightsCacheDelete)>\n       weights_cache(TfLiteXNNPackDelegateWeightsCacheCreate(),\n                     TfLiteXNNPackDelegateWeightsCacheDelete);\n   delegate_options.weights_cache = weights_cache.get();\n-  UseCustomDelegate(delegate_options);\n+  std::unique_ptr<TfLiteDelegate, decltype(&TfLiteXNNPackDelegateDelete)>\n+      xnnpack_delegate(TfLiteXNNPackDelegateCreate(&delegate_options),\n+                       TfLiteXNNPackDelegateDelete);\n \n   std::random_device random_device;\n   auto rng = std::mt19937(random_device());"
        },
        {
            "sha": "a8c86ff5a2552923ff5ebf6e3ffd6eb7ae97d35e",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 64,
            "changes": 85,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -25,7 +25,6 @@ limitations under the License.\n #include <unistd.h>\n #endif\n \n-#include <algorithm>\n #include <cerrno>  // IWYU pragma: keep\n #include <cinttypes>\n #include <cstddef>\n@@ -38,7 +37,6 @@ limitations under the License.\n #include <unordered_map>\n #include <utility>\n \n-#include \"experimental.h\"  // from @XNNPACK\n #include \"xnnpack.h\"  // from @XNNPACK\n #include \"flatbuffers/flatbuffer_builder.h\"  // from @flatbuffers\n #include \"flatbuffers/verifier.h\"  // from @flatbuffers\n@@ -80,20 +78,6 @@ bool FileExists(const char* path) {\n   return access(path, F_OK) != -1;\n }\n \n-bool CheckFingerprints(const cache::schema::BufferList* buffer_list) {\n-  if (buffer_list->fingerprints()) {\n-    for (uint64_t cache_fingerprint : *buffer_list->fingerprints()) {\n-      xnn_fingerprint fingerprint;\n-      static_assert(sizeof(fingerprint) == sizeof(cache_fingerprint));\n-      std::memcpy(&fingerprint, &cache_fingerprint, sizeof(fingerprint));\n-      XNNPACK_RETURN_CHECK(\n-          xnn_check_fingerprint(fingerprint) == xnn_status_success,\n-          \"fingerprint (id: 0x%x) could not be matched\", fingerprint.id);\n-    }\n-  }\n-  return true;\n-}\n-\n }  // namespace\n \n #define XNN_MOVE_CONSTRUCT_MEMBER(x) x(std::move(other.x))\n@@ -198,8 +182,7 @@ void* WeightCacheBuilder::Reserve(size_t size) {\n }\n \n BufferLocation WeightCacheBuilder::Append(PackIdentifier pack_id,\n-                                          const void* data, uint64_t size,\n-                                          int32_t fingerprint_id) {\n+                                          const void* data, uint64_t size) {\n   XNNPACK_ABORT_CHECK(is_build_step_,\n                       \"cannot append data to an unstarted builder.\");\n   // Add some padding so that the cache file can be mmaped and the buffer\n@@ -218,34 +201,6 @@ BufferLocation WeightCacheBuilder::Append(PackIdentifier pack_id,\n   buffer.size = loc.size;\n   schema_.buffers.push_back(std::make_unique<cache::schema::BufferT>(buffer));\n \n-  // Not passing a fingerprint id is a logic error on XNNPack's side. If we\n-  // don't have a fingerprint for an operation, we have no way of ensuring that\n-  // the generation of the cached data hasn't changed when reloading the cache.\n-  //\n-  // If we just log this and continue on with the work. This run will build a\n-  // cache with cached data that can't be checked in the future. This will lead,\n-  // in future runs that reuse the cache, to crashes that are impossible to\n-  // debug or outputs that are nonsensical without any chance of linking this\n-  // back to this error.\n-  //\n-  // We abort because we have no way of making that failure bubble up to the\n-  // calling code to handle it gracefully...\n-  XNNPACK_ABORT_CHECK(fingerprint_id != 0,\n-                      \"XNNPack weight cache: no fingerprint identifier was set \"\n-                      \"when appending a buffer to the cache file.\");\n-  const xnn_fingerprint* fingerprint = xnn_get_fingerprint(fingerprint_id);\n-  XNNPACK_ABORT_CHECK(fingerprint,\n-                      \"XNNPack weight cache: could not find a fingerprint with \"\n-                      \"id 0x%x when appending a buffer to the cache file.\",\n-                      fingerprint_id);\n-  uint64_t fingerprint_value;\n-  static_assert(sizeof(fingerprint_value) == sizeof(*fingerprint));\n-  std::memcpy(&fingerprint_value, fingerprint, sizeof(*fingerprint));\n-  if (std::find(schema_.fingerprints.begin(), schema_.fingerprints.end(),\n-                fingerprint_value) == schema_.fingerprints.end()) {\n-    schema_.fingerprints.push_back(fingerprint_value);\n-  }\n-\n   if (!fd_.Write(data, size)) {\n     TFLITE_LOG_PROD(tflite::TFLITE_LOG_ERROR,\n                     \"XNNPack weight cache: cannot append buffer to cache file\");\n@@ -278,7 +233,16 @@ bool WeightCacheBuilder::StopBuildStep() {\n   XNNPACK_RETURN_CHECK(fd_.SetPos(layout_offset) != -1,\n                        \"could not move in the file: %s\", strerror(errno));\n \n+  XNNPACK_RETURN_CHECK(\n+      sizeof(XNNPackCacheHeader::xnnpack_build_identifier) ==\n+          xnn_experimental_get_build_identifier_size(),\n+      \"cache file ('%s') header cannot hold XNNPack's build identifier: %s.\",\n+      file_path_.c_str(), strerror(errno));\n+\n   XNNPackCacheHeader header{XNNPackCacheHeader::kVersion};\n+  memcpy(header.xnnpack_build_identifier,\n+         xnn_experimental_get_build_identifier_data(),\n+         xnn_experimental_get_build_identifier_size());\n   header.buffer_list_offset = fd_.GetPos();\n   header.buffer_list_size = builder.GetSize();\n \n@@ -441,6 +405,12 @@ bool MMapWeightCacheProvider::Load() {\n                        \", expected %\" PRIu64 \". Cache needs to be built again.\",\n                        header.version, XNNPackCacheHeader::kVersion);\n \n+  XNNPACK_RETURN_CHECK(xnn_experimental_check_build_identifier(\n+                           header.xnnpack_build_identifier,\n+                           sizeof(header.xnnpack_build_identifier)),\n+                       \"XNNPack weight cache: incompatible XNNPack version. \"\n+                       \"Cache needs to be built again.\");\n+\n   XNNPACK_RETURN_CHECK(header.buffer_list_offset < mmap_handle.size(),\n                        \"invalid offset for buffer list descriptor.\");\n \n@@ -460,8 +430,6 @@ bool MMapWeightCacheProvider::Load() {\n   XNNPACK_RETURN_CHECK(buffer_list,\n                        \"could not get packed weights from flatbuffer.\");\n \n-  XNNPACK_RETURN_CHECK(CheckFingerprints(buffer_list));\n-\n   mmap_buffer_base_offset_ = buffer_list->base_offset();\n   if (const auto buffers = buffer_list->buffers(); buffers) {\n     for (auto* buffer : *buffers) {\n@@ -616,8 +584,7 @@ size_t MMapWeightCacheProvider::LookUpOrInsert(\n     return offset_it->second.offset;\n   }\n \n-  const BufferLocation location =\n-      builder_.Append(pack_id, ptr, size, cache_key->fingerprint_id);\n+  const BufferLocation location = builder_.Append(pack_id, ptr, size);\n   XNNPACK_ABORT_CHECK(!location.IsInvalid(),\n                       \"Inserting data in the cache failed.\");\n   cache_key_to_offset_.emplace(pack_id, location);\n@@ -726,20 +693,10 @@ bool IsCompatibleCacheFile(FileDescriptorView fd) {\n                        \"Cache header version is incompatible. Expected %\" PRIu64\n                        \", got %\" PRIu64 \".\",\n                        XNNPackCacheHeader::kVersion, header.version);\n-\n-  fd.SetPos(header.buffer_list_offset);\n-  auto buffer = std::make_unique<uint8_t[]>(header.buffer_list_size);\n-  XNNPACK_RETURN_CHECK(fd.Read(buffer.get(), header.buffer_list_size));\n-\n-  flatbuffers::Verifier verifier(buffer.get(), header.buffer_list_size);\n-  XNNPACK_RETURN_CHECK(cache::schema::VerifyBufferListBuffer(verifier),\n-                       \"buffer list validation failed.\");\n-\n-  const cache::schema::BufferList* buffer_list =\n-      cache::schema::GetBufferList(buffer.get());\n-  XNNPACK_RETURN_CHECK(buffer_list,\n-                       \"could not get packed weights from flatbuffer.\");\n-  XNNPACK_RETURN_CHECK(CheckFingerprints(buffer_list));\n+  XNNPACK_RETURN_CHECK(xnn_experimental_check_build_identifier(\n+                           header.xnnpack_build_identifier,\n+                           sizeof(header.xnnpack_build_identifier)),\n+                       \"Cache header build identifier is different.\");\n   return true;\n }\n "
        },
        {
            "sha": "a7c8654df4f7eca7943ef60b65aff0a5170ef34d",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -56,8 +56,9 @@ inline constexpr char kInMemoryCachePath[] = \":memory\";\n // When reading a cache file, the cache should be rejected if `version`\n // doesn't match `kVersion`.\n struct XNNPackCacheHeader {\n-  enum : uint64_t { kInvalidHeader = 0, kVersion = 2 };\n+  enum : uint64_t { kInvalidHeader = 0, kVersion = 1 };\n   uint64_t version;\n+  uint8_t xnnpack_build_identifier[32];\n   uint64_t buffer_list_offset;\n   uint64_t buffer_list_size;\n };\n@@ -160,8 +161,8 @@ class WeightCacheBuilder {\n   // The buffer space must have been reserved before using `Reserve`. If not, a\n   // new call to `Reserve` will be done and the data will be copied over.\n   [[nodiscard /*The location to the appended data should be saved.*/]]\n-  BufferLocation Append(PackIdentifier pack_id, const void* data, uint64_t size,\n-                        int fingerprint_id);\n+  BufferLocation Append(PackIdentifier pack_id, const void* data,\n+                        uint64_t size);\n \n   // Writes the flatbuffer to disk.\n   [[nodiscard /*Writing the weight cache can fail.*/]]"
        },
        {
            "sha": "33566b8be2208a3f6282fd9dfde111efb4486a26",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache_schema.fbs",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_schema.fbs",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_schema.fbs",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_schema.fbs?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -32,14 +32,11 @@ table Buffer {\n }\n \n table BufferList {\n-  /// A list of packing fingerprints. All of these need to be checked when\n-  /// loading the cache to ensure that it is compatible.\n-  fingerprints: [uint64];\n   /// A list of buffers.\n   buffers: [Buffer];\n   /// Defines the base offset for the data in the file. That offset\n   /// may be needed to guarantee data alignment.\n-  base_offset: uint64;\n+  base_offset:uint64;\n }\n \n root_type BufferList;"
        },
        {
            "sha": "dd3093b27365172197a5cfa72653b1a3b67b1dfb",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache_test.cc",
            "status": "modified",
            "additions": 58,
            "deletions": 134,
            "changes": 192,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/86c82562e1188f693f49cd0b369e70d07a74eb7e/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc?ref=86c82562e1188f693f49cd0b369e70d07a74eb7e",
            "patch": "@@ -35,7 +35,6 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n-#include \"experimental.h\"  // from @XNNPACK\n #include \"xnnpack.h\"  // from @XNNPACK\n #include \"flatbuffers/verifier.h\"  // from @flatbuffers\n #include \"tensorflow/lite/c/common.h\"\n@@ -57,13 +56,7 @@ namespace {\n \n using testing::ElementsAreArray;\n \n-static xnn_fingerprint kDefaultFingerprint{/*id=*/0xf00d, /*value=*/0xb33f};\n-\n-struct WeightCacheBuilderTest : testing::Test {\n-  void SetUp() override { xnn_set_fingerprint(kDefaultFingerprint); }\n-};\n-\n-TEST_F(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n+TEST(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n   using std::size;\n \n   const std::string payload = \"This is some data in the file.\";\n@@ -79,8 +72,7 @@ TEST_F(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n   const size_t payload_size = size(payload);\n   void* buffer = builder.Reserve(payload_size);\n   std::memcpy(buffer, payload.c_str(), payload_size);\n-  auto loc =\n-      builder.Append(dummy_id, buffer, payload_size, kDefaultFingerprint.id);\n+  auto loc = builder.Append(dummy_id, buffer, payload_size);\n \n   EXPECT_EQ(loc.size, payload_size);\n   EXPECT_GE(builder.capacity(), payload_size);\n@@ -131,7 +123,7 @@ TEST_F(WeightCacheBuilderTest, ReserveAppendWriteWorks) {\n   EXPECT_THAT(cache_data, ElementsAreArray(payload));\n }\n \n-TEST_F(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n+TEST(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   using std::size;\n \n   const std::string payload = \"This is some data in the file.\";\n@@ -145,8 +137,7 @@ TEST_F(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   ASSERT_TRUE(builder.StartBuildStep());\n \n   const size_t payload_size = size(payload);\n-  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size,\n-                            kDefaultFingerprint.id);\n+  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size);\n \n   EXPECT_EQ(loc.size, payload_size);\n \n@@ -195,7 +186,7 @@ TEST_F(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   EXPECT_THAT(cache_data, ElementsAreArray(payload));\n }\n \n-TEST_F(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n+TEST(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n   const std::string cache_path = testing::TempDir() + \"/cache\";\n   const std::string payload = \"This is some data in the file.\";\n   const PackIdentifier dummy_id{1, 2, 3};\n@@ -207,8 +198,7 @@ TEST_F(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n   ASSERT_TRUE(builder.StartBuildStep());\n \n   const size_t payload_size = size(payload);\n-  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size,\n-                            kDefaultFingerprint.id);\n+  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size);\n   EXPECT_EQ(loc.size, payload_size);\n   ASSERT_TRUE(builder.StopBuildStep());\n \n@@ -228,13 +218,13 @@ TEST_F(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n   EXPECT_FALSE(builder.StartBuildStep());\n }\n \n-TEST_F(WeightCacheBuilderTest, InvalidFileDescriptorFails) {\n+TEST(WeightCacheBuilderTest, InvalidFileDescriptorFails) {\n   WeightCacheBuilder builder;\n   EXPECT_FALSE(builder.Start(\"\", FileDescriptor()));\n   EXPECT_FALSE(builder.Start(\"/seldf/sedsft\", FileDescriptor()));\n }\n \n-TEST_F(WeightCacheBuilderTest, InMemoryCacheCanBeBuilt) {\n+TEST(WeightCacheBuilderTest, InMemoryCacheCanBeBuilt) {\n   if (!TfLiteXNNPackDelegateCanUseInMemoryWeightCacheProvider()) {\n     GTEST_SKIP() << \"In-memory weight cache isn't enabled for this build or \"\n                     \"isn't supported by the current system, skipping test.\";\n@@ -249,7 +239,7 @@ TEST_F(WeightCacheBuilderTest, InMemoryCacheCanBeBuilt) {\n   EXPECT_EQ(errno, ENOENT);\n }\n \n-TEST_F(WeightCacheBuilderTest, MultipleStepBuild) {\n+TEST(WeightCacheBuilderTest, MultipleStepBuild) {\n   using std::size;\n \n   const std::string payload1 = \"This is some data in the file.\";\n@@ -272,17 +262,15 @@ TEST_F(WeightCacheBuilderTest, MultipleStepBuild) {\n     const size_t payload_size = size(payload1);\n     void* buffer = builder.Reserve(payload_size);\n     std::memcpy(buffer, payload1.c_str(), payload_size);\n-    const auto loc =\n-        builder.Append(dummy_id1, buffer, payload_size, kDefaultFingerprint.id);\n+    const auto loc = builder.Append(dummy_id1, buffer, payload_size);\n     EXPECT_EQ(loc.size, payload_size);\n     EXPECT_GE(builder.capacity(), payload_size);\n   }\n   {\n     const size_t payload_size = size(payload3);\n     void* buffer = builder.Reserve(payload_size);\n     std::memcpy(buffer, payload3.c_str(), payload_size);\n-    const auto loc =\n-        builder.Append(dummy_id3, buffer, payload_size, kDefaultFingerprint.id);\n+    const auto loc = builder.Append(dummy_id3, buffer, payload_size);\n     (void)loc;\n   }\n \n@@ -296,8 +284,7 @@ TEST_F(WeightCacheBuilderTest, MultipleStepBuild) {\n     const size_t payload_size = size(payload2);\n     void* buffer = builder.Reserve(payload_size);\n     std::memcpy(buffer, payload2.c_str(), payload_size);\n-    const auto loc =\n-        builder.Append(dummy_id2, buffer, payload_size, kDefaultFingerprint.id);\n+    const auto loc = builder.Append(dummy_id2, buffer, payload_size);\n     EXPECT_EQ(loc.size, payload_size);\n     EXPECT_GE(builder.capacity(), payload_size);\n   }\n@@ -402,8 +389,7 @@ struct FakeContext {\n                                           const int weights_index) const {\n     return {.seed = algorithm_seed,\n             .kernel = buffers[weights_index].data(),\n-            .bias = nullptr,\n-            .fingerprint_id = kDefaultFingerprint.id};\n+            .bias = nullptr};\n   }\n \n   // Creates a look up key for the XNNPack weight provider C interface.\n@@ -412,8 +398,7 @@ struct FakeContext {\n                                           const int bias_index) const {\n     return {.seed = algorithm_seed,\n             .kernel = buffers[weights_index].data(),\n-            .bias = buffers[bias_index].data(),\n-            .fingerprint_id = kDefaultFingerprint.id};\n+            .bias = buffers[bias_index].data()};\n   }\n \n   // Helps creating fake packed data.\n@@ -520,7 +505,6 @@ struct BuildMMapWeightCacheProviderTest : testing::TestWithParam<TestVariant> {\n       GTEST_SKIP() << \"In-memory weight cache isn't enabled for this build or \"\n                       \"isn't supported by the current system, skipping test.\";\n     }\n-    xnn_set_fingerprint(kDefaultFingerprint);\n     AddTensors();\n     EndSetup();\n   }\n@@ -739,7 +723,6 @@ struct MMapWeightCacheProviderTest : testing::TestWithParam<TestVariant> {\n       GTEST_SKIP() << \"In-memory weight cache isn't enabled for this build or \"\n                       \"isn't supported by the current system, skipping test.\";\n     }\n-    xnn_set_fingerprint(kDefaultFingerprint);\n   }\n   bool use_explicit_fd = GetParam().use_explicit_fd;\n   const char* const explicit_fd_path = GetParam().explicit_fd_path;\n@@ -800,14 +783,12 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n     const xnn_weights_cache_look_up_key look_up_key_1{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[0].data.data,\n-        .bias = tensors[1].data.data,\n-        .fingerprint_id = kDefaultFingerprint.id};\n+        .bias = tensors[1].data.data};\n \n     const xnn_weights_cache_look_up_key look_up_key_3{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[3].data.data,\n-        .bias = tensors[4].data.data,\n-        .fingerprint_id = kDefaultFingerprint.id};\n+        .bias = tensors[4].data.data};\n \n     // Lookup non-packed tensor.\n     ASSERT_EQ(cache->look_up(cache, &look_up_key_1), SIZE_MAX);\n@@ -848,8 +829,7 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n     const xnn_weights_cache_look_up_key look_up_key_2{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[2].data.data,\n-        .bias = tensors[3].data.data,\n-        .fingerprint_id = kDefaultFingerprint.id};\n+        .bias = tensors[3].data.data};\n \n     const size_t build_offset_2 = cache->look_up_or_insert(\n         cache, &look_up_key_2, (void*)packed_data_ref_2,\n@@ -924,20 +904,17 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n     const xnn_weights_cache_look_up_key look_up_key_1{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[0].data.data,\n-        .bias = tensors[1].data.data,\n-        .fingerprint_id = kDefaultFingerprint.id};\n+        .bias = tensors[1].data.data};\n \n     const xnn_weights_cache_look_up_key look_up_key_2{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[2].data.data,\n-        .bias = tensors[3].data.data,\n-        .fingerprint_id = kDefaultFingerprint.id};\n+        .bias = tensors[3].data.data};\n \n     const xnn_weights_cache_look_up_key look_up_key_3{\n         .seed = fake_packing_algo_seed,\n         .kernel = tensors[3].data.data,\n-        .bias = tensors[4].data.data,\n-        .fingerprint_id = kDefaultFingerprint.id};\n+        .bias = tensors[4].data.data};\n \n     ASSERT_TRUE(cache->is_finalized(cache));\n \n@@ -968,59 +945,30 @@ TEST_P(MMapWeightCacheProviderTest, XnnpackCApiJourney) {\n   }\n }\n \n-TEST_P(MMapWeightCacheProviderTest, CacheIsRebuiltOnFingerprintMismatch) {\n-  if (use_in_memory_cache) {\n-    GTEST_SUCCEED() << \"In-memory cache is never reloaded.\";\n-    return;\n-  }\n+TEST_P(MMapWeightCacheProviderTest, XnnpackRebuildOnVersionMismatch) {\n   TempFileDesc temp_fd;\n   const char* temp_fd_cpath = explicit_fd_path;\n+  FileDescriptor temp_fd_value = temp_fd.Duplicate();\n \n-  xnn_fingerprint test_fingeprint{0x7357, 0xF33D};\n-  {  // Build a cache file with a specific fingerprint.\n-    // Clear fingerprints and add a test fingerprint to XNNPack.\n-    xnn_clear_fingerprints();\n-    xnn_set_fingerprint(test_fingeprint);\n-\n-    // Build a cache file.\n-    MMapWeightCacheProvider cache_provider;\n-\n-    const char kernel[] = \"Fake data.\";\n-    TfLiteTensor tensor;\n-    tensor.data.data = (void*)kernel;\n-    cache_provider.MapTensorIdentifiers(\n-        &tensor, /*size=*/1, /*tensor_index_to_identifier=*/{{0, 1}});\n-    ASSERT_TRUE(\n-        cache_provider.LoadOrStartBuild(temp_fd_cpath, temp_fd.Duplicate()));\n-    ASSERT_TRUE(cache_provider.StartBuildStep());\n-    const xnn_weights_cache_look_up_key look_up_key_1{\n-        .seed = 1234,\n-        .kernel = kernel,\n-        .bias = nullptr,\n-        .fingerprint_id = test_fingeprint.id};\n-    xnn_weights_cache_t cache = &cache_provider.GetCacheProvider();\n-    const size_t build_offset_1 = cache->look_up_or_insert(\n-        cache, &look_up_key_1,\n-        const_cast<void*>(reinterpret_cast<const void*>(kernel)),\n-        sizeof(kernel));\n-    (void)build_offset_1;\n-    ASSERT_TRUE(cache_provider.StopBuildStep());\n+  {  // Set bad build identifier\n+    XNNPackCacheHeader header{.version = XNNPackCacheHeader::kVersion};\n+    header.xnnpack_build_identifier[0] += 1;\n+    ASSERT_TRUE(temp_fd_value.Write(&header, sizeof(header)));\n   }\n \n   if (!use_explicit_fd) {\n     temp_fd.Close();\n     temp_fd_cpath = temp_fd.GetCPath();\n+    temp_fd_value.Close();\n+    if (use_in_memory_cache) {\n+      temp_fd_cpath = kInMemoryCachePath;\n+    }\n   }\n \n-  // Change the test fingerprint value.\n-  test_fingeprint.value = 0xdeadb33f;\n-  xnn_set_fingerprint(test_fingeprint);\n-\n-  // Reload the file.\n   auto build_cache_provider = std::make_unique<MMapWeightCacheProvider>();\n   MMapWeightCacheProvider& cache_provider = *build_cache_provider;\n-  ASSERT_TRUE(\n-      cache_provider.LoadOrStartBuild(temp_fd_cpath, temp_fd.Duplicate()));\n+  ASSERT_TRUE(cache_provider.LoadOrStartBuild(temp_fd_cpath,\n+                                              temp_fd_value.Duplicate()));\n   ASSERT_TRUE(cache_provider.StartBuildStep());\n }\n \n@@ -1032,53 +980,29 @@ class IsCompatibleCacheFileTest\n   using Param = IsCompatibleCacheFileTestOverload;\n \n   void SetUp() override {\n-    xnn_clear_fingerprints();\n-    xnn_set_fingerprint(kDefaultFingerprint);\n-\n-    // Build a cache file.\n-    MMapWeightCacheProvider cache_provider;\n-\n-    const char kernel[] = \"Fake data.\";\n-    TfLiteTensor tensor;\n-    tensor.data.data = (void*)kernel;\n-    cache_provider.MapTensorIdentifiers(\n-        &tensor, /*size=*/1, /*tensor_index_to_identifier=*/{{0, 1}});\n-    ASSERT_TRUE(\n-        cache_provider.LoadOrStartBuild(fd_.GetCPath(), fd_.Duplicate()));\n-    ASSERT_TRUE(cache_provider.StartBuildStep());\n-    const xnn_weights_cache_look_up_key look_up_key_1{\n-        .seed = 1234,\n-        .kernel = kernel,\n-        .bias = nullptr,\n-        .fingerprint_id = kDefaultFingerprint.id};\n-    xnn_weights_cache_t cache = &cache_provider.GetCacheProvider();\n-    const size_t build_offset_1 = cache->look_up_or_insert(\n-        cache, &look_up_key_1,\n-        const_cast<void*>(reinterpret_cast<const void*>(kernel)),\n-        sizeof(kernel));\n-    (void)build_offset_1;\n-    ASSERT_TRUE(cache_provider.StopBuildStep());\n-  }\n-\n-  void ChangeRuntimeFingerprintValue() {\n-    xnn_set_fingerprint(\n-        {kDefaultFingerprint.id, kDefaultFingerprint.value + 1});\n+    header_.version = XNNPackCacheHeader::kVersion;\n+    memcpy(header_.xnnpack_build_identifier,\n+           xnn_experimental_get_build_identifier_data(),\n+           xnn_experimental_get_build_identifier_size());\n   }\n \n-  bool CallIsCompatibleCacheFile() {\n-    switch (GetParam()) {\n-      case Param::kPath:\n-        fd_.Close();\n-        return IsCompatibleCacheFile(fd_.GetCPath());\n-      case Param::kDescriptor: {\n-        const auto pos = fd_.GetPos();\n-        EXPECT_NE(pos, 0);  // We test with a non zero position.\n-        return IsCompatibleCacheFile(fd_);\n-        EXPECT_EQ(fd_.GetPos(), pos);\n-      }\n+  bool WriteHeaderAndReturnIsCompatibleCacheFile() {\n+    if (!fd_.Write(&header_, sizeof(header_))) {\n+      return false;\n+    }\n+    if (GetParam() == Param::kPath) {\n+      fd_.Close();\n+      return IsCompatibleCacheFile(fd_.GetCPath());\n+    } else {\n+      const FileDescriptor::Offset pos = fd_.GetPos();\n+      EXPECT_NE(pos, 0);  // Ensure that we are testing with a non 0 position.\n+      const bool compatible = IsCompatibleCacheFile(fd_);\n+      EXPECT_EQ(pos, fd_.GetPos());\n+      return compatible;\n     }\n   }\n \n+  XNNPackCacheHeader header_{};\n   TempFileDesc fd_;\n };\n \n@@ -1092,18 +1016,18 @@ std::string Name(\n   }\n }\n \n-TEST_P(IsCompatibleCacheFileTest, ReturnsTrueWhenFingerprintMatches) {\n-  EXPECT_TRUE(CallIsCompatibleCacheFile());\n+TEST_P(IsCompatibleCacheFileTest, ReturnsTrueForACorrectHeader) {\n+  EXPECT_TRUE(WriteHeaderAndReturnIsCompatibleCacheFile());\n }\n \n-TEST_P(IsCompatibleCacheFileTest, ReturnsFalseWhenFingerprintMismatches) {\n-  ChangeRuntimeFingerprintValue();\n-  EXPECT_FALSE(CallIsCompatibleCacheFile());\n+TEST_P(IsCompatibleCacheFileTest, ReturnsFalseForWrongHeaderVersion) {\n+  header_.version += 1;\n+  EXPECT_FALSE(WriteHeaderAndReturnIsCompatibleCacheFile());\n }\n \n-TEST_P(IsCompatibleCacheFileTest, ReturnsFalseWhenFingerprintIsNotFound) {\n-  xnn_clear_fingerprints();\n-  EXPECT_FALSE(CallIsCompatibleCacheFile());\n+TEST_P(IsCompatibleCacheFileTest, ReturnsFalseForWrongBuildIdentifier) {\n+  header_.xnnpack_build_identifier[0] += 1;\n+  EXPECT_FALSE(WriteHeaderAndReturnIsCompatibleCacheFile());\n }\n \n INSTANTIATE_TEST_SUITE_P("
        }
    ],
    "stats": {
        "total": 2552,
        "additions": 1787,
        "deletions": 765
    }
}