{
    "author": "sfvaroglu",
    "message": "PR #31030: [XLA:GPU] Move ReduceScatterCreator after AlgebraicSimplifier\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31030\n\nüìù Summary of Changes\nThis PR moves the ReduceScatterCreator pass to run after AlgebraicSimplifier, simplifying the transformation pattern and allowing ReduceScatterCreator to convert more all-reduces into reduce-scatters that would otherwise be missed.\n\nüéØ Justification\nRunning ReduceScatterCreator after AlgebraicSimplifier makes the input patterns easier to recognize. This allows more all-reduces to be converted into reduce-scatters, which would otherwise be missed, leading to better performance. _This was reported internally as an optimization for llama3.3-70b._\n\nüöÄ Kind of Contribution\n‚ö°Ô∏è Performance Improvement,\n\nüìä Benchmark (for Performance Improvements)\nOn H100:\n|  | PR | main |\n|----------|----------|----------|\n| llama31_8b_bf16_1x8    | 1372251 us   | 1369631 us    |\n| llama31_8b_fp8_1x8    | 1106135 us   | 1107605 us    |\n| llama31_8b_bf16_2x8    | 1373637 us   | 1370564 us    |\n| llama31_8b_fp8_2x8    | 1111912 us   | 1108061 us    |\n| llama31_70b_bf16_16x8    | 13933022 us   | 13913957 us    |\n| llama31_70b_fp8_16x8    | 9848173 us   | 9867955 us    |\n| llama31_70b_bf16_32x8    | 14103619 us   | 14065225 us    |\n| llama31_70b_fp8_32x8    | 9732961 us   | 9760739 us    |\n| llama31_405b_bf16_64x8    | 52926476 us   | 52886529 us    |\n| llama31_405b_fp8_64x8    | 35576505 us   | 37929776 us   |\n| mixtral_8x7b_bf16_1x8   | 744367 us   | 744491 us    |\n| mixtral_8x7b_bf16_2x8    | 1126425 us   | 1130912 us    |\n\nüß™ Unit Tests:\nAdded a new unit test\n\nüß™ Execution Tests:\nTested for functionality with llama3.3 70b zero1 + gradient accumulation and saw ~5% performance improvement.\n\nCopybara import of the project:\n\n--\n2d999987762ac3d90960179b06587bc95fc954d1 by Sevin Varoglu <svaroglu@nvidia.com>:\n\nMove ReduceScatterCreator after AlgebraicSimplifier\n\n--\n0e41c2b8281234eec9af21a98fd5f81bd4884689 by Sevin Varoglu <svaroglu@nvidia.com>:\n\nAdd unit test\n\nMerging this change closes #31030\n\nPiperOrigin-RevId: 820221148",
    "sha": "b81b3316bebf42896668c0343b7349f6697caf5a",
    "files": [
        {
            "sha": "97bf53ad43a75cd8ed70a715ed8f1b511b30c921",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b81b3316bebf42896668c0343b7349f6697caf5a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b81b3316bebf42896668c0343b7349f6697caf5a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=b81b3316bebf42896668c0343b7349f6697caf5a",
            "patch": "@@ -1105,8 +1105,6 @@ absl::Status RunCollectiveOptimizationPasses(\n     collectives_pipeline.AddPass<CollectivePipeliner>(config);\n   }\n \n-  collectives_pipeline.AddPass<ReduceScatterCreator>();\n-\n   DebugOptions::PipelineParallelismOptLevel pipeline_parallelism_opt_level =\n       debug_options.xla_gpu_experimental_pipeline_parallelism_opt_level();\n   if (debug_options.xla_gpu_enable_pipelined_p2p()) {\n@@ -1128,6 +1126,8 @@ absl::Status RunCollectiveOptimizationPasses(\n   collectives_pipeline.AddPass<GpuAlgebraicSimplifier>(\n       layout_insensitive_algsimp_opts, gpu_version);\n \n+  collectives_pipeline.AddPass<ReduceScatterCreator>();\n+\n   collectives_pipeline.AddPass<AllGatherBroadcastReorder>();\n   collectives_pipeline.AddPass<AllGatherRemoveDegenerateDims>();\n "
        },
        {
            "sha": "b4e2a37172cf94975c6f585e70a839b5635bef75",
            "filename": "third_party/xla/xla/service/gpu/transforms/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b81b3316bebf42896668c0343b7349f6697caf5a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b81b3316bebf42896668c0343b7349f6697caf5a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD?ref=b81b3316bebf42896668c0343b7349f6697caf5a",
            "patch": "@@ -2172,6 +2172,7 @@ xla_cc_test(\n     name = \"reduce_scatter_creator_test\",\n     srcs = [\"reduce_scatter_creator_test.cc\"],\n     deps = [\n+        \":algebraic_simplifier\",\n         \":reduce_scatter_creator\",\n         \"//xla:util\",\n         \"//xla/hlo/ir:hlo\",\n@@ -2180,6 +2181,7 @@ xla_cc_test(\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service:pattern_matcher\",\n         \"//xla/service/gpu:backend_configs_cc\",\n+        \"//xla/stream_executor:device_description\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/log\","
        },
        {
            "sha": "b9d28d90a980cb81ea60e4b5a45baf075a61925c",
            "filename": "third_party/xla/xla/service/gpu/transforms/reduce_scatter_creator_test.cc",
            "status": "modified",
            "additions": 77,
            "deletions": 1,
            "changes": 78,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b81b3316bebf42896668c0343b7349f6697caf5a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Freduce_scatter_creator_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b81b3316bebf42896668c0343b7349f6697caf5a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Freduce_scatter_creator_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Freduce_scatter_creator_test.cc?ref=b81b3316bebf42896668c0343b7349f6697caf5a",
            "patch": "@@ -34,8 +34,10 @@ limitations under the License.\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n #include \"xla/hlo/testlib/pattern_matcher_gmock.h\"\n #include \"xla/service/gpu/backend_configs.pb.h\"\n+#include \"xla/service/gpu/transforms/algebraic_simplifier.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/service/pattern_matcher.h\"\n+#include \"xla/stream_executor/device_description.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n \n@@ -68,11 +70,27 @@ class GpuReduceScatterCreatorTest : public HloHardwareIndependentTestBase {\n   }\n \n   size_t ReduceScatterCount(std::unique_ptr<HloModule> &module) {\n-    return CollectiveCount(module, HloOpcode::kAllReduce);\n+    return CollectiveCount(module, HloOpcode::kReduceScatter);\n+  }\n+\n+  template <typename T>\n+  size_t AllReduceCount(std::unique_ptr<T>& module) {\n+    return CollectiveCount(module.get(), HloOpcode::kAllReduce);\n+  }\n+\n+  template <typename T>\n+  size_t ReduceScatterCount(std::unique_ptr<T>& module) {\n+    return CollectiveCount(module.get(), HloOpcode::kReduceScatter);\n   }\n \n  private:\n   size_t CollectiveCount(std::unique_ptr<HloModule> &module, HloOpcode opcode) {\n+    return absl::c_count_if(\n+        module->entry_computation()->instructions(),\n+        [&opcode](HloInstruction* instr) { return instr->opcode() == opcode; });\n+  }\n+\n+  size_t CollectiveCount(HloModule* module, HloOpcode opcode) {\n     return absl::c_count_if(\n         module->entry_computation()->instructions(),\n         [&opcode](HloInstruction *instr) { return instr->opcode() == opcode; });\n@@ -699,6 +717,64 @@ ENTRY %SubtractionPattern {\n   EXPECT_EQ(AllReduceCount(module), 0);\n }\n \n+TEST_F(GpuReduceScatterCreatorTest, AllReduceThroughTuple) {\n+  absl::string_view hlo_string = R\"(\n+HloModule AllReduceThroughTuple\n+\n+%sum {\n+  %a = f32[] parameter(0)\n+  %b = f32[] parameter(1)\n+  ROOT %add = f32[] add(%a, %b)\n+}\n+\n+ENTRY %AllReduce {\n+  %param0 = f32[4096,4096]{1,0} parameter(0)\n+  %param1 = f32[1024,4096]{1,0} parameter(1)\n+  %all-reduce = f32[4096,4096]{1,0} all-reduce(%param0),\n+    replica_groups={{0,1,2,3,4,5,6,7}}, channel_id=5, use_global_device_ids=true, to_apply=%sum\n+  %tuple = (f32[4096,4096]{1,0}, f32[1024,4096]{1,0}) tuple(%all-reduce, %param1)\n+  %get-tuple-element = f32[4096,4096]{1,0} get-tuple-element(%tuple), index=0\n+  %pid = u32[] partition-id()\n+  %pid_s32 = s32[] convert(%pid)\n+  %slice_size = s32[] constant(512)\n+  %offset = s32[] multiply(%pid_s32, %slice_size)\n+  %zero = s32[] constant(0)\n+  ROOT %dynamic-slice = f32[512,4096]{1,0} dynamic-slice(%get-tuple-element, %offset, %zero),\n+    dynamic_slice_sizes={512,4096}\n+}\n+)\";\n+\n+  HloModuleConfig config = GetModuleConfigForTest(\n+      /*replica_count=*/1, /*num_partitions=*/8);\n+  config.set_use_spmd_partitioning(true);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module_without_algsimp,\n+                          ParseAndReturnVerifiedModule(hlo_string, config));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      bool changed_without,\n+      ReduceScatterCreator().Run(module_without_algsimp.get()));\n+  EXPECT_FALSE(changed_without) << \"ReduceScatterCreator should not transform \"\n+                                   \"without AlgebraicSimplifier\";\n+  EXPECT_EQ(AllReduceCount(module_without_algsimp), 1);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module_with_algsimp,\n+                          ParseAndReturnVerifiedModule(hlo_string, config));\n+\n+  AlgebraicSimplifierOptions options;\n+  se::GpuComputeCapability compute_capability{se::CudaComputeCapability{8, 0}};\n+  GpuAlgebraicSimplifier algsimp(options, compute_capability);\n+  TF_ASSERT_OK_AND_ASSIGN(bool algsimp_changed,\n+                          algsimp.Run(module_with_algsimp.get(), {}));\n+  EXPECT_TRUE(algsimp_changed);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      bool changed_with, ReduceScatterCreator().Run(module_with_algsimp.get()));\n+  EXPECT_TRUE(changed_with)\n+      << \"ReduceScatterCreator should transform after AlgebraicSimplifier\";\n+  EXPECT_GE(ReduceScatterCount(module_with_algsimp), 1)\n+      << \"Expected at least one ReduceScatter after transformation\";\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 81,
        "deletions": 3
    }
}