{
    "author": "tensorflower-gardener",
    "message": "Add rules_python_versions.patch to fix usage of custom python versions.\n\nA custom runtime can be specified by setting the `HERMETIC_PYTHON_URL`, which\nmay point to a mostly arbitrary URL, i.e. one not following the same format\nas python-build-standalone URLs, such e.g. `file:///__w/jax/jax/python-tsan.tgz`.\nInternally, some rules_python code assumes the python-build-standalone URL\nformat and eventually errors.\n\nTo fix, the python version is used to determine the URL build suffix.\n\nThis also patches the rule_python versions URL generation logic to add musl\nto the list of platforms it generates freethreaded runtime urls for.\n\nWork around for https://github.com/bazel-contrib/rules_python/issues/3285, https://github.com/bazel-contrib/rules_python/issues/3286\n\nPiperOrigin-RevId: 810132685",
    "sha": "62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2",
    "files": [
        {
            "sha": "48e88ea6dfcd366249e08388dd9973c0d5d334c2",
            "filename": "third_party/py/python_init_rules.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fpy%2Fpython_init_rules.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fpy%2Fpython_init_rules.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fpy%2Fpython_init_rules.bzl?ref=62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2",
            "patch": "@@ -43,5 +43,6 @@ def python_init_rules(extra_patches = []):\n         patches = [\n             Label(\"//third_party/py:rules_python_pip_version.patch\"),\n             Label(\"//third_party/py:rules_python_freethreaded.patch\"),\n+            Label(\"//third_party/py:rules_python_versions.patch\"),\n         ] + extra_patches,\n     )"
        },
        {
            "sha": "a4e54ed7c2515406724527a07ed601eb6f1b64f4",
            "filename": "third_party/py/rules_python_versions.patch",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fpy%2Frules_python_versions.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fpy%2Frules_python_versions.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fpy%2Frules_python_versions.patch?ref=62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2",
            "patch": "@@ -0,0 +1,40 @@\n+diff --git a/python/versions.bzl b/python/versions.bzl\n+index 30929f82..73974065 100644\n+--- a/python/versions.bzl\n++++ b/python/versions.bzl\n+@@ -1045,29 +1045,29 @@ def get_release_info(platform, python_version, base_url = DEFAULT_RELEASE_BASE_U\n+     for u in url:\n+         p, _, _ = platform.partition(FREETHREADED)\n+ \n+-        release_id = int(u.split(\"/\")[-2])\n+-\n+         if FREETHREADED.lstrip(\"-\") in platform:\n++            if \"3.13\" in python_version:\n++                aarch64_linux_suffix = \"lto\"\n++            else:\n++                aarch64_linux_suffix = \"pgo+lto\"\n+             build = \"{}+{}-full\".format(\n+                 FREETHREADED.lstrip(\"-\"),\n+                 {\n+                     \"aarch64-apple-darwin\": \"pgo+lto\",\n+                     \"aarch64-pc-windows-msvc\": \"pgo\",\n+-                    \"aarch64-unknown-linux-gnu\": \"lto\" if release_id < 20250702 else \"pgo+lto\",\n++                    \"aarch64-unknown-linux-gnu\": aarch64_linux_suffix,\n+                     \"ppc64le-unknown-linux-gnu\": \"lto\",\n+                     \"riscv64-unknown-linux-gnu\": \"lto\",\n+                     \"s390x-unknown-linux-gnu\": \"lto\",\n+                     \"x86_64-apple-darwin\": \"pgo+lto\",\n+                     \"x86_64-pc-windows-msvc\": \"pgo\",\n+                     \"x86_64-unknown-linux-gnu\": \"pgo+lto\",\n++                    \"x86_64-unknown-linux-musl\": \"pgo+lto\",\n+                 }[p],\n+             )\n+         else:\n+             build = INSTALL_ONLY\n+ \n+-        if WINDOWS_NAME in platform and release_id < 20250317:\n+-            build = \"shared-\" + build\n+-\n+         release_filename = u.format(\n+             platform = p,\n+             python_version = python_version,"
        },
        {
            "sha": "48e88ea6dfcd366249e08388dd9973c0d5d334c2",
            "filename": "third_party/xla/third_party/py/python_init_rules.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_init_rules.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_init_rules.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_init_rules.bzl?ref=62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2",
            "patch": "@@ -43,5 +43,6 @@ def python_init_rules(extra_patches = []):\n         patches = [\n             Label(\"//third_party/py:rules_python_pip_version.patch\"),\n             Label(\"//third_party/py:rules_python_freethreaded.patch\"),\n+            Label(\"//third_party/py:rules_python_versions.patch\"),\n         ] + extra_patches,\n     )"
        },
        {
            "sha": "a4e54ed7c2515406724527a07ed601eb6f1b64f4",
            "filename": "third_party/xla/third_party/py/rules_python_versions.patch",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fxla%2Fthird_party%2Fpy%2Frules_python_versions.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2/third_party%2Fxla%2Fthird_party%2Fpy%2Frules_python_versions.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fpy%2Frules_python_versions.patch?ref=62b4c5b7637172bf87b3f2cddd1dba5b1a7a66b2",
            "patch": "@@ -0,0 +1,40 @@\n+diff --git a/python/versions.bzl b/python/versions.bzl\n+index 30929f82..73974065 100644\n+--- a/python/versions.bzl\n++++ b/python/versions.bzl\n+@@ -1045,29 +1045,29 @@ def get_release_info(platform, python_version, base_url = DEFAULT_RELEASE_BASE_U\n+     for u in url:\n+         p, _, _ = platform.partition(FREETHREADED)\n+ \n+-        release_id = int(u.split(\"/\")[-2])\n+-\n+         if FREETHREADED.lstrip(\"-\") in platform:\n++            if \"3.13\" in python_version:\n++                aarch64_linux_suffix = \"lto\"\n++            else:\n++                aarch64_linux_suffix = \"pgo+lto\"\n+             build = \"{}+{}-full\".format(\n+                 FREETHREADED.lstrip(\"-\"),\n+                 {\n+                     \"aarch64-apple-darwin\": \"pgo+lto\",\n+                     \"aarch64-pc-windows-msvc\": \"pgo\",\n+-                    \"aarch64-unknown-linux-gnu\": \"lto\" if release_id < 20250702 else \"pgo+lto\",\n++                    \"aarch64-unknown-linux-gnu\": aarch64_linux_suffix,\n+                     \"ppc64le-unknown-linux-gnu\": \"lto\",\n+                     \"riscv64-unknown-linux-gnu\": \"lto\",\n+                     \"s390x-unknown-linux-gnu\": \"lto\",\n+                     \"x86_64-apple-darwin\": \"pgo+lto\",\n+                     \"x86_64-pc-windows-msvc\": \"pgo\",\n+                     \"x86_64-unknown-linux-gnu\": \"pgo+lto\",\n++                    \"x86_64-unknown-linux-musl\": \"pgo+lto\",\n+                 }[p],\n+             )\n+         else:\n+             build = INSTALL_ONLY\n+ \n+-        if WINDOWS_NAME in platform and release_id < 20250317:\n+-            build = \"shared-\" + build\n+-\n+         release_filename = u.format(\n+             platform = p,\n+             python_version = python_version,"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 82,
        "deletions": 0
    }
}