{
    "author": "tensorflower-gardener",
    "message": "Add Python API for GPU ondevice tracing.\n\nPiperOrigin-RevId: 801021189",
    "sha": "c5cab63ee8ba199222e1c149717b28e97424e0b7",
    "files": [
        {
            "sha": "0e3d04ba5129038a640260cf4c1a6a8196ec0eb7",
            "filename": "third_party/xla/xla/python/BUILD",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Fpython%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Fpython%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2FBUILD?ref=c5cab63ee8ba199222e1c149717b28e97424e0b7",
            "patch": "@@ -5,7 +5,7 @@ load(\n     \"xla_cc_test\",\n     \"xla_py_test_deps\",\n )\n-load(\"//xla/python:package_groups.bzl\", \"XLA_PYTHON_XLA_CLIENT_USERS\", \"XLA_PYTHON_XLA_EXTENSION_USERS\")\n+load(\"//xla/python:package_groups.bzl\", \"XLA_PYTHON_PROFILER_USERS\", \"XLA_PYTHON_XLA_CLIENT_USERS\", \"XLA_PYTHON_XLA_EXTENSION_USERS\")\n load(\"//xla/python:pywrap.bzl\", \"nanobind_pywrap_extension\")\n load(\n     \"//xla/tsl:tsl.bzl\",\n@@ -424,6 +424,18 @@ py_strict_test(\n         ]),\n )\n \n+nanobind_pywrap_extension(\n+    name = \"_gpu_ondevice_tracing\",\n+    srcs = [\"gpu_ondevice_tracing.cc\"],\n+    pytype_srcs = [\"_gpu_ondevice_tracing.pyi\"],\n+    visibility = internal_visibility([\":jax\"] + XLA_PYTHON_PROFILER_USERS),\n+    deps = [\n+        \"//xla/tsl/profiler/backends/gpu:ondevice_event_receiver\",\n+        \"//xla/tsl/profiler/backends/gpu:ondevice_trace_event\",\n+        \"@nanobind\",\n+    ],\n+)\n+\n cc_library(\n     name = \"logging\",\n     srcs = [\"logging.cc\"],"
        },
        {
            "sha": "50d41d977b7544ed685be5c04b46e68819931663",
            "filename": "third_party/xla/xla/python/_gpu_ondevice_tracing.pyi",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Fpython%2F_gpu_ondevice_tracing.pyi",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Fpython%2F_gpu_ondevice_tracing.pyi",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2F_gpu_ondevice_tracing.pyi?ref=c5cab63ee8ba199222e1c149717b28e97424e0b7",
            "patch": "@@ -0,0 +1,42 @@\n+# Copyright 2025 The OpenXLA Authors.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+# ==============================================================================\n+\"\"\"Utilities for GPU on-device tracing inject events into Xprof profiler.\"\"\"\n+\n+\n+def active_version() -> int:\n+  \"\"\"Returns the active version of the GPU on-device tracing.\n+\n+  0 mean no active tracing.\n+  \"\"\"\n+  ...\n+\n+\n+def start_injection_instance(version: int) -> int:\n+  \"\"\"Starts a new injection instance of the GPU on-device tracing.\"\"\"\n+  ...\n+\n+\n+def inject(\n+    version: int,\n+    injection_instance_id: int,\n+    tag_name: str,\n+    tag_id: int,\n+    pid: int,\n+    tid: int,\n+    start_time_ns: int,\n+    duration_ps: int,\n+) -> None:\n+  \"\"\"Injects an event into the Xprof profiler.\"\"\"\n+  ..."
        },
        {
            "sha": "0ee845b94453f474bc71c8213ecd54555e215401",
            "filename": "third_party/xla/xla/python/gpu_ondevice_tracing.cc",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Fpython%2Fgpu_ondevice_tracing.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Fpython%2Fgpu_ondevice_tracing.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fgpu_ondevice_tracing.cc?ref=c5cab63ee8ba199222e1c149717b28e97424e0b7",
            "patch": "@@ -0,0 +1,72 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include <cstddef>\n+#include <cstdint>\n+\n+#include \"nanobind/nanobind.h\"\n+#include \"nanobind/stl/string_view.h\"  // IWYU pragma: keep\n+#include \"xla/tsl/profiler/backends/gpu/ondevice_event_receiver.h\"\n+#include \"xla/tsl/profiler/backends/gpu/ondevice_trace_event.h\"\n+\n+namespace nb = ::nanobind;\n+\n+namespace xla {\n+namespace {\n+\n+using ::tsl::profiler::GpuOnDeviceTraceEvent;\n+using ::tsl::profiler::GpuOnDeviceTraceEventReceiver;\n+\n+size_t ActiveVersion() {\n+  return GpuOnDeviceTraceEventReceiver::GetSingleton()->ActiveVersion();\n+}\n+\n+uint32_t StartInjectionInstance(uint32_t version) {\n+  return GpuOnDeviceTraceEventReceiver::GetSingleton()->StartInjectionInstance(\n+      version);\n+}\n+\n+void Inject(size_t version, int32_t injection_instance_id,\n+            absl::string_view tag_name, uint32_t tag_id, uint32_t pid,\n+            uint32_t tid, int64_t start_time_ns, int64_t duration_ps) {\n+  return GpuOnDeviceTraceEventReceiver::GetSingleton()\n+      ->Inject(version,\n+               GpuOnDeviceTraceEvent{\n+                   .injection_instance_id = injection_instance_id,\n+                   .tag_name = tag_name,\n+                   .tag_id = tag_id,\n+                   .pid = pid,\n+                   .tid = tid,\n+                   .start_time_ns = start_time_ns,\n+                   .duration_ps = duration_ps,\n+               })\n+      .IgnoreError();\n+}\n+\n+}  // namespace\n+\n+NB_MODULE(_gpu_ondevice_tracing, m) {\n+  m.def(\"active_version\", &ActiveVersion,\n+        \"Check if there are active profiling session using the on-device event \"\n+        \"receiver.\");\n+  m.def(\"start_injection_instance\", &StartInjectionInstance, nb::arg(\"version\"),\n+        \"Get the Id for a new injection instance.\");\n+  m.def(\"inject\", &Inject, nb::arg(\"version\"), nb::arg(\"injection_instance_id\"),\n+        nb::arg(\"tag_name\"), nb::arg(\"tag_id\"), nb::arg(\"pid\"), nb::arg(\"tid\"),\n+        nb::arg(\"start_time_ns\"), nb::arg(\"duration_ps\"),\n+        \"Injecting software generated events to the on-device event receiver.\");\n+}\n+\n+}  // namespace xla"
        },
        {
            "sha": "bfcd254a976b04696b5141f6db2d44f9b8c32615",
            "filename": "third_party/xla/xla/tsl/profiler/backends/gpu/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Fbackends%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c5cab63ee8ba199222e1c149717b28e97424e0b7/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Fbackends%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Fbackends%2Fgpu%2FBUILD?ref=c5cab63ee8ba199222e1c149717b28e97424e0b7",
            "patch": "@@ -9,6 +9,7 @@ cc_library(\n     hdrs = [\"ondevice_trace_event.h\"],\n     copts = tf_profiler_copts(),\n     visibility = internal_visibility([\n+        \"//xla/python:__pkg__\",\n         \"//xla/tsl/profiler:internal\",\n         \"//xla/tsl/profiler:xla_profiler_backends\",\n         \"//tensorflow/lite:__pkg__\",\n@@ -23,6 +24,7 @@ cc_library(\n     hdrs = [\"ondevice_event_collector.h\"],\n     copts = tf_profiler_copts(),\n     visibility = internal_visibility([\n+        \"//xla/python:__pkg__\",\n         \"//xla/tsl/profiler:internal\",\n         \"//xla/tsl/profiler:xla_profiler_backends\",\n         \"//tensorflow/lite:__pkg__\",\n@@ -39,6 +41,7 @@ cc_library(\n     hdrs = [\"ondevice_event_receiver.h\"],\n     copts = tf_profiler_copts(),\n     visibility = internal_visibility([\n+        \"//xla/python:__pkg__\",\n         \"//xla/tsl/profiler:internal\",\n         \"//xla/tsl/profiler:xla_profiler_backends\",\n         \"//tensorflow/lite:__pkg__\","
        }
    ],
    "stats": {
        "total": 131,
        "additions": 130,
        "deletions": 1
    }
}