{
    "author": "alexander-shaposhnikov",
    "message": "Add support for offloading suitable reductions to YNNPACK.\n\nPiperOrigin-RevId: 831647764",
    "sha": "55e7043a65e75d49071167e3bc2b49a5b4126eda",
    "files": [
        {
            "sha": "38dc8f6f820cf7963a1882779774332f356ff1de",
            "filename": "third_party/xla/xla/backends/cpu/transforms/ynn_matcher.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fynn_matcher.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fynn_matcher.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fynn_matcher.h?ref=55e7043a65e75d49071167e3bc2b49a5b4126eda",
            "patch": "@@ -63,7 +63,7 @@ class YnnMatcher : public LibraryMatcher {\n                                  instr->operand(1)->shape(), instr->shape());\n     }\n     if (instr->opcode() == HloOpcode::kReduce) {\n-      return IsReduceOpSupportedByYnn(instr);\n+      return IsReduceOpOffloadedToYnn(instr);\n     }\n     if (instr->IsConstant()) {\n       return IsConstantSupportedByYnn(instr);"
        },
        {
            "sha": "164030f451442e504823c10ca28fca91617f301b",
            "filename": "third_party/xla/xla/backends/cpu/ynn_support.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.cc?ref=55e7043a65e75d49071167e3bc2b49a5b4126eda",
            "patch": "@@ -248,6 +248,26 @@ bool IsReduceOpSupportedByYnn(const HloInstruction* hlo) {\n                                                match::Parameter(1)));\n }\n \n+bool IsReduceOpOffloadedToYnn(const HloInstruction* hlo) {\n+  if (!IsReduceOpSupportedByYnn(hlo)) {\n+    return false;\n+  }\n+  const HloInstruction* input = hlo->operand(0);\n+  if (ShapeUtil::ElementsIn(input->shape()) < 32 * 1024) {\n+    return false;\n+  }\n+  switch (input->opcode()) {\n+    case HloOpcode::kMultiply:\n+    case HloOpcode::kBroadcast:\n+    case HloOpcode::kSlice:\n+    case HloOpcode::kConcatenate:\n+      return false;\n+    default: {\n+      return true;\n+    }\n+  }\n+}\n+\n uint32_t YnnFlags(const DebugOptions& debug_options) {\n   uint32_t flags = 0;\n   if (!debug_options.xla_cpu_enable_platform_dependent_math()) {"
        },
        {
            "sha": "7025010715dad91c8659f6e2bd990f1e93c931e1",
            "filename": "third_party/xla/xla/backends/cpu/ynn_support.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.h?ref=55e7043a65e75d49071167e3bc2b49a5b4126eda",
            "patch": "@@ -68,6 +68,9 @@ absl::StatusOr<bool> IsDotSupportedByYnn(\n // Returns true if the reduce op is supported by YNNPACK.\n bool IsReduceOpSupportedByYnn(const HloInstruction* hlo);\n \n+// Returns true if the reduce op will be offloaded to YNNPACK.\n+bool IsReduceOpOffloadedToYnn(const HloInstruction* hlo);\n+\n // Convert XLA options to YNNPACK flags.\n uint32_t YnnFlags(const DebugOptions& debug_options);\n "
        },
        {
            "sha": "207ccfa6a306353aa51f9a2c2ef6ca37b97390e0",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/tree_reduction_rewriter.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Ftree_reduction_rewriter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Ftree_reduction_rewriter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Ftree_reduction_rewriter.cc?ref=55e7043a65e75d49071167e3bc2b49a5b4126eda",
            "patch": "@@ -42,10 +42,14 @@ namespace xla {\n \n class ReductionRewriterVisitor : public DfsHloRewriteVisitor {\n  public:\n-  explicit ReductionRewriterVisitor(int64_t reduce_window_size)\n-      : reduce_window_size_(reduce_window_size) {}\n+  ReductionRewriterVisitor(int64_t reduce_window_size, HloPredicate filter)\n+      : reduce_window_size_(reduce_window_size), filter_(std::move(filter)) {}\n \n   absl::Status HandleReduce(HloInstruction *hlo) override {\n+    if (filter_ && !filter_(hlo)) {\n+      return absl::OkStatus();\n+    }\n+\n     HloInstruction *reduced_op = hlo->mutable_operand(0);\n     HloInstruction *initial_value = hlo->mutable_operand(1);\n     const Shape &input_shape = reduced_op->shape();\n@@ -112,12 +116,13 @@ class ReductionRewriterVisitor : public DfsHloRewriteVisitor {\n \n  private:\n   int64_t reduce_window_size_;\n+  HloPredicate filter_;\n };\n \n absl::StatusOr<bool> TreeReductionRewriter::RunImpl(\n     HloModule* module,\n     const absl::flat_hash_set<absl::string_view>& execution_threads) {\n-  ReductionRewriterVisitor visitor(reduce_window_size_);\n+  ReductionRewriterVisitor visitor(reduce_window_size_, filter_);\n   bool changed = false;\n   for (const auto &computation :\n        module->MakeNonfusionComputations(execution_threads)) {"
        },
        {
            "sha": "52703c0da0545ca0b2936865e371a27c0e746beb",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/tree_reduction_rewriter.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Ftree_reduction_rewriter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Ftree_reduction_rewriter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Ftree_reduction_rewriter.h?ref=55e7043a65e75d49071167e3bc2b49a5b4126eda",
            "patch": "@@ -44,8 +44,9 @@ namespace xla {\n // increased to a larger value.\n class TreeReductionRewriter : public HloModulePass {\n  public:\n-  explicit TreeReductionRewriter(int64_t reduce_window_size = 32)\n-      : reduce_window_size_(reduce_window_size) {}\n+  explicit TreeReductionRewriter(int64_t reduce_window_size = 32,\n+                                 HloPredicate filter = nullptr)\n+      : reduce_window_size_(reduce_window_size), filter_(std::move(filter)) {}\n   ~TreeReductionRewriter() override = default;\n   absl::string_view name() const override { return \"tree_reduction_rewriter\"; }\n \n@@ -56,6 +57,7 @@ class TreeReductionRewriter : public HloModulePass {\n \n  private:\n   int64_t reduce_window_size_;\n+  HloPredicate filter_;\n };\n \n }  // end namespace xla"
        },
        {
            "sha": "c1312664a324390cd090413c4ae9d4227bfe19e2",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/55e7043a65e75d49071167e3bc2b49a5b4126eda/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=55e7043a65e75d49071167e3bc2b49a5b4126eda",
            "patch": "@@ -509,10 +509,21 @@ std::unique_ptr<HloPassFix<HloPassPipeline>> CreateSimplificationPipeline(\n                             .debug_options()\n                             .xla_cpu_experimental_ynn_fusion_type(),\n                         DebugOptions::LIBRARY_FUSION_TYPE_REDUCE)) {\n-    // Needs to happen after algebraic simplifier.\n     pipeline->AddPass<TreeReductionRewriter>();\n   }\n \n+#ifdef XLA_YNNPACK\n+  if (absl::c_contains(module->config()\n+                           .debug_options()\n+                           .xla_cpu_experimental_ynn_fusion_type(),\n+                       DebugOptions::LIBRARY_FUSION_TYPE_REDUCE)) {\n+    pipeline->AddPass<TreeReductionRewriter>(\n+        /*reduce_window_size=*/32, [](const HloInstruction* hlo) {\n+          return !IsReduceOpOffloadedToYnn(hlo);\n+        });\n+  }\n+#endif\n+\n   // BatchNormExpander can create zero-sized ops, so zero-sized HLO\n   // elimination has to come after that pass.\n   pipeline->AddPass<ZeroSizedHloElimination>();"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 48,
        "deletions": 7
    }
}