{
    "author": "akuegel",
    "message": "[XLA:GPU] Make sure to simplify both lhs and rhs of convolution.\n\nWe need to ensure that symbols for trivial dimensions are simplified away\nconsistently. If we simplify it on one side, we also need to simplify it on\nthe other, as we want to use the same iteration space for both lhs and rhs.\n\nPiperOrigin-RevId: 819606712",
    "sha": "a150bc01ab054aa39381ab73cf9908c2d35fe58e",
    "files": [
        {
            "sha": "adb9d12d343f1eed6489d674eb6bbd4eb32e8173",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_analysis.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a150bc01ab054aa39381ab73cf9908c2d35fe58e/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a150bc01ab054aa39381ab73cf9908c2d35fe58e/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis.cc?ref=a150bc01ab054aa39381ab73cf9908c2d35fe58e",
            "patch": "@@ -995,12 +995,18 @@ HloInstructionIndexing ComputeOutputToInputConvolutionOpIndexing(\n       AffineMap::get(rank, input_symbols.size(), input_exprs, mlir_context),\n       DimVarsFromTensorSizes(output_shape.dimensions()), input_symbols,\n       /*rt_vars=*/{}, input_constraints);\n+  // We may need to simplify and remove unused symbols again, as the input\n+  // feature dimension size may be trivial.\n+  inputs_indexing.Simplify();\n+  inputs_indexing.RemoveUnusedSymbols();\n \n   // Indexing map for the kernel value.\n   IndexingMap kernel_indexing(\n       AffineMap::get(rank, kernel_symbols.size(), kernel_exprs, mlir_context),\n       DimVarsFromTensorSizes(output_shape.dimensions()), kernel_symbols,\n       /*rt_vars=*/{});\n+  kernel_indexing.Simplify();\n+  kernel_indexing.RemoveUnusedSymbols();\n \n   return HloInstructionIndexing::FromIndexingMaps(\n       {inputs_indexing, kernel_indexing});"
        },
        {
            "sha": "ec4de8582f31fc6f5f90f6736f6d3b8c244665c2",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_analysis_test.cc",
            "status": "modified",
            "additions": 77,
            "deletions": 5,
            "changes": 82,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a150bc01ab054aa39381ab73cf9908c2d35fe58e/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a150bc01ab054aa39381ab73cf9908c2d35fe58e/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis_test.cc?ref=a150bc01ab054aa39381ab73cf9908c2d35fe58e",
            "patch": "@@ -1889,6 +1889,41 @@ TEST_F(IndexingAnalysisTest, ReduceWindowOp_NoPadding) {\n                           )\"));\n }\n \n+TEST_F(IndexingAnalysisTest, ReduceWindowOp_4DWithTrivalDims_NoPadding) {\n+  auto root = ParseAndGetRoot(R\"(\n+    HloModule m\n+    max {\n+      p0 = f32[] parameter(0)\n+      p1 = f32[] parameter(1)\n+      ROOT max = f32[] maximum(p0, p1)\n+    }\n+    ENTRY e {\n+      c_inf = f32[] constant(-inf)\n+      p0 = f32[1024, 514, 1, 1]parameter(0)\n+      ROOT reduce-window = f32[1024, 3, 1, 1] reduce-window(p0, c_inf),\n+        window={size=1x512x1x1 pad=0_0x0_0x0_0x0_0}, to_apply=max\n+    }\n+  )\");\n+  auto input_indexing = GetOutputToInputIndexing(root);\n+  EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n+                          operand id = 0\n+                            (d0, d1, d2, d3)[s0] -> (d0, d1 + s0, 0, 0),\n+                            domain:\n+                            d0 in [0, 1023],\n+                            d1 in [0, 2],\n+                            d2 in [0, 0],\n+                            d3 in [0, 0],\n+                            s0 in [0, 511]\n+                          operand id = 1\n+                            (d0, d1, d2, d3) -> (),\n+                            domain:\n+                            d0 in [0, 1023],\n+                            d1 in [0, 2],\n+                            d2 in [0, 0],\n+                            d3 in [0, 0]\n+                          )\"));\n+}\n+\n TEST_F(IndexingAnalysisTest, ReduceWindowOp_PaddingAndWindowStride) {\n   auto root = ParseAndGetRoot(R\"(\n     HloModule m\n@@ -2077,7 +2112,7 @@ TEST_F(IndexingAnalysisTest, ConvolutionOp_NoPadding) {\n   auto input_indexing = GetOutputToInputIndexing(root);\n   EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n                           operand id = 0\n-                            (d0, d1, d2, d3)[s0, s1, s2] -> (d0, d1 + s0, d2 + s1, s2),\n+                            (d0, d1, d2, d3)[s0, s1, s2] -> (0, d1 + s0, d2 + s1, s2),\n                             domain:\n                             d0 in [0, 0],\n                             d1 in [0, 9],\n@@ -2099,6 +2134,43 @@ TEST_F(IndexingAnalysisTest, ConvolutionOp_NoPadding) {\n                           )\"));\n }\n \n+TEST_F(IndexingAnalysisTest, ConvolutionOp_4DWithTrivialDims_NoPadding) {\n+  auto root = ParseAndGetRoot(R\"(\n+    HloModule m\n+    ENTRY e {\n+      p0 = f64[1,1,16,16,2,2]{5,4,3,2,1,0} parameter(0)\n+      p1 = f64[1,1,3,3,1,1]{5,4,3,2,1,0} parameter(1)\n+      ROOT conv = f64[1,1,14,14,2,2]{5,4,3,2,1,0} convolution(p0, p1),\n+        window={size=3x3x1x1}, dim_labels=bf0123_oi0123->bf0123\n+    }\n+  )\");\n+  auto input_indexing = GetOutputToInputIndexing(root);\n+  EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n+                          operand id = 0\n+                            (d0, d1, d2, d3, d4, d5)[s0, s1] -> (0, 0, d2 + s0, d3 + s1, d4, d5),\n+                            domain:\n+                            d0 in [0, 0],\n+                            d1 in [0, 0],\n+                            d2 in [0, 13],\n+                            d3 in [0, 13],\n+                            d4 in [0, 1],\n+                            d5 in [0, 1],\n+                            s0 in [0, 2],\n+                            s1 in [0, 2]\n+                          operand id = 1\n+                            (d0, d1, d2, d3, d4, d5)[s0, s1] -> (0, 0, s0, s1, 0, 0),\n+                            domain:\n+                            d0 in [0, 0],\n+                            d1 in [0, 0],\n+                            d2 in [0, 13],\n+                            d3 in [0, 13],\n+                            d4 in [0, 1],\n+                            d5 in [0, 1],\n+                            s0 in [0, 2],\n+                            s1 in [0, 2]\n+                          )\"));\n+}\n+\n TEST_F(IndexingAnalysisTest, ConvolutionOp_PaddingAndWindowStride) {\n   auto root = ParseAndGetRoot(R\"(\n     HloModule m\n@@ -2112,7 +2184,7 @@ TEST_F(IndexingAnalysisTest, ConvolutionOp_PaddingAndWindowStride) {\n   auto input_indexing = GetOutputToInputIndexing(root);\n   EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n                           operand id = 0\n-                            (d0, d1, d2, d3)[s0, s1, s2] -> (d0, d1 * 2 + s0 - 1, d2 * 2 + s1 - 2, s2),\n+                            (d0, d1, d2, d3)[s0, s1, s2] -> (0, d1 * 2 + s0 - 1, d2 * 2 + s1 - 2, s2),\n                             domain:\n                             d0 in [0, 0],\n                             d1 in [0, 5],\n@@ -2149,7 +2221,7 @@ TEST_F(IndexingAnalysisTest, ConvolutionOp_LhsDilation) {\n   auto input_indexing = GetOutputToInputIndexing(root);\n   EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n                           operand id = 0\n-                            (d0, d1, d2, d3)[s0, s1, s2] -> (d0, (d1 + s0) floordiv 2, (d2 + s1) floordiv 2, s2),\n+                            (d0, d1, d2, d3)[s0, s1, s2] -> (0, (d1 + s0) floordiv 2, (d2 + s1) floordiv 2, s2),\n                             domain:\n                             d0 in [0, 0],\n                             d1 in [0, 20],\n@@ -2186,7 +2258,7 @@ TEST_F(IndexingAnalysisTest, ConvolutionOp_RhsDilation) {\n   auto input_indexing = GetOutputToInputIndexing(root);\n   EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n                           operand id = 0\n-                            (d0, d1, d2, d3)[s0, s1, s2] -> (d0, d1 + s0 * 2, d2 + s1 * 2, s2),\n+                            (d0, d1, d2, d3)[s0, s1, s2] -> (0, d1 + s0 * 2, d2 + s1 * 2, s2),\n                             domain:\n                             d0 in [0, 0],\n                             d1 in [0, 7],\n@@ -2221,7 +2293,7 @@ TEST_F(IndexingAnalysisTest, ConvolutionOp_FeatureGroups) {\n   auto input_indexing = GetOutputToInputIndexing(root);\n   EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n                           operand id = 0\n-                            (d0, d1, d2, d3)[s0, s1, s2] -> (d0, d1 + s0, d2 + s1, (d3 floordiv 8) * 4 + s2),\n+                            (d0, d1, d2, d3)[s0, s1, s2] -> (0, d1 + s0, d2 + s1, (d3 floordiv 8) * 4 + s2),\n                             domain:\n                             d0 in [0, 0],\n                             d1 in [0, 9],"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 83,
        "deletions": 5
    }
}