{
    "author": "tensorflower-gardener",
    "message": "Reverts db360c5f907a5a3dd50a9f3c8c7473a4e0e525a7\n\nPiperOrigin-RevId: 814380105",
    "sha": "a2c5a160dae9e24151401d3693819ab0f95a99c6",
    "files": [
        {
            "sha": "7e9678bb515f797857e482725d017f4e24d37060",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/constant_deferring.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fconstant_deferring.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fconstant_deferring.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fconstant_deferring.cc?ref=a2c5a160dae9e24151401d3693819ab0f95a99c6",
            "patch": "@@ -35,8 +35,7 @@ namespace {\n bool IsConstant(const HloInstruction* instr) {\n   return instr->opcode() == HloOpcode::kConstant ||\n          (instr->opcode() == HloOpcode::kBroadcast &&\n-          instr->operand(0)->opcode() == HloOpcode::kConstant) ||\n-         instr->IsCustomCall(\"AllocateBuffer\");\n+          instr->operand(0)->opcode() == HloOpcode::kConstant);\n }\n \n }  // namespace"
        },
        {
            "sha": "82b18614d6ac1df951fc21c2ca647adf6cd1d2fa",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=a2c5a160dae9e24151401d3693819ab0f95a99c6",
            "patch": "@@ -4944,7 +4944,6 @@ cc_library(\n     hdrs = [\"while_loop_fusible_sinking.h\"],\n     deps = [\n         \":pattern_matcher\",\n-        \":while_loop_simplifier\",\n         \":while_util\",\n         \"//xla:comparison_util\",\n         \"//xla:shape_util\",\n@@ -4953,7 +4952,6 @@ cc_library(\n         \"//xla/hlo/analysis:while_loop_analysis\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/pass:hlo_pass\",\n-        \"//xla/hlo/transforms/simplifiers:hlo_dce\",\n         \"//xla/hlo/utils:hlo_query\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:flat_hash_map\","
        },
        {
            "sha": "39690ded697dd1f7e44575b64a043d0665b26563",
            "filename": "third_party/xla/xla/service/while_loop_fusible_sinking.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 11,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking.cc?ref=a2c5a160dae9e24151401d3693819ab0f95a99c6",
            "patch": "@@ -34,10 +34,8 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n-#include \"xla/hlo/transforms/simplifiers/hlo_dce.h\"\n #include \"xla/hlo/utils/hlo_query.h\"\n #include \"xla/service/pattern_matcher.h\"\n-#include \"xla/service/while_loop_simplifier.h\"\n #include \"xla/service/while_util.h\"\n #include \"xla/shape_util.h\"\n #include \"xla/util.h\"\n@@ -55,8 +53,7 @@ bool IsPurelyExpanding(const HloInstruction* instr) {\n   return instr->opcode() == HloOpcode::kBroadcast ||\n          (instr->opcode() == HloOpcode::kConstant &&\n           instr->shape().dimensions().empty()) ||\n-         instr->opcode() == HloOpcode::kIota ||\n-         instr->IsCustomCall(\"AllocateBuffer\");\n+         instr->opcode() == HloOpcode::kIota;\n }\n \n bool IsFusionCandidate(const HloInstruction* instr) {\n@@ -144,8 +141,7 @@ std::vector<int64_t> GetLoopShapeCoveringWriteIndices(\n     HloInstruction* arg_operand = tuple->mutable_operand(tuple_index);\n     // We're looking for an argument that is a broadcast(constant) feeds a while\n     // loop.\n-    if (!Match(arg_operand, match::Broadcast(match::ConstantScalar())) &&\n-        !arg_operand->IsCustomCall(\"AllocateBuffer\")) {\n+    if (!Match(arg_operand, match::Broadcast(match::ConstantScalar()))) {\n       continue;\n     }\n     HloInstruction* broadcast_gte = hlo_query::GetUniqueGteInstruction(\n@@ -543,11 +539,6 @@ absl::StatusOr<bool> WhileLoopFusibleSinking::Run(\n       }\n     }\n   }\n-  if (changed) {\n-    TF_ASSIGN_OR_RETURN(bool t, HloDCE().Run(module));\n-    TF_ASSIGN_OR_RETURN(bool t2, WhileLoopSimplifier().Run(module));\n-    changed |= t | t2;\n-  }\n   return changed;\n }\n }  // namespace xla"
        },
        {
            "sha": "d5ecda426902acae3f51961282e2d32af0d758d0",
            "filename": "third_party/xla/xla/service/while_loop_fusible_sinking_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a2c5a160dae9e24151401d3693819ab0f95a99c6/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fwhile_loop_fusible_sinking_test.cc?ref=a2c5a160dae9e24151401d3693819ab0f95a99c6",
            "patch": "@@ -18,6 +18,7 @@ limitations under the License.\n #include <memory>\n #include <string>\n \n+#include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/log/check.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -108,11 +109,11 @@ ENTRY entry {\n                           WhileLoopFusibleSinking{}.Run(module.get()));\n   ASSERT_TRUE(changed);\n \n-  auto* while_body = module->GetComputationWithName(\"body.clone\");\n+  auto* while_body = module->GetComputationWithName(\"body\");\n   EXPECT_THAT(while_body->root_instruction(),\n               op::Tuple(op::Add(_, op::Multiply(op::Add(op::Iota(), op::Iota()),\n                                                 op::Broadcast())),\n-                        _));\n+                        _, _));\n }\n \n TEST_F(WhileLoopFusibleSinkingTest, NoSinkSlicedMask) {\n@@ -282,6 +283,8 @@ TEST_F(WhileLoopFusibleSinkingTest,\n   TF_ASSERT_OK_AND_ASSIGN(bool changed,\n                           WhileLoopFusibleSinking{}.Run(module_before.get()));\n   EXPECT_TRUE(changed);\n+  EXPECT_THAT(FindInstruction(module_before.get(), \"while1\"),\n+              op::While(op::Tuple(_, op::CustomCall(), _, _)));\n   EXPECT_THAT(FindInstruction(module_before.get(), \"while2\"),\n               op::While(op::Tuple(_, op::CustomCall(), _, _)));\n }"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 8,
        "deletions": 17
    }
}