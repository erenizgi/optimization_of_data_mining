{
    "author": "dubstack",
    "message": "Introduce `XLA_[Q|D]CHECK` macros for Check failures.\n\nThese macros are carefully designed to\n1. have the exact same API as absl::CHECKs\n2. produce error messages and content in exactly the same format as absl::CHECK's.\n3. respect absl flags e.g. ABSL_MIN_LOG_LEVEL\n\nThey only differ from absl::CHECK's in that, for Check failures, they\n1. prepend an error code and append a link to the openxla.org webpage to the error message\n2. additionally, append DebugMeContext information if available.\n\nPiperOrigin-RevId: 817868212",
    "sha": "9a534e7b9dfedf17941f35b41004d0edcf88132f",
    "files": [
        {
            "sha": "03674b45fedaa9ae63143736eb8fd405508b537c",
            "filename": "third_party/xla/xla/error/BUILD",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2FBUILD?ref=9a534e7b9dfedf17941f35b41004d0edcf88132f",
            "patch": "@@ -5,6 +5,7 @@ load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n package(\n     # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n     default_visibility = [\"//visibility:public\"],\n+    licenses = [\"notice\"],\n )\n \n cc_library(\n@@ -92,6 +93,23 @@ xla_cc_test(\n     ],\n )\n \n+cc_library(\n+    name = \"check\",\n+    hdrs = [\"check.h\"],\n+    deps = [\"//xla/error/internal:check_impl\"],\n+)\n+\n+xla_cc_test(\n+    name = \"check_test\",\n+    srcs = [\"check_test.cc\"],\n+    deps = [\n+        \":check\",\n+        \":debug_me_context_util\",\n+        \"//xla/tsl/platform:debug_me_context\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n cc_library(\n     name = \"fatal_error_sink_registration\",\n     srcs = [\"fatal_error_sink_registration.cc\"],"
        },
        {
            "sha": "22898c60118d8838ca9898705c11200f5c45b666",
            "filename": "third_party/xla/xla/error/check.h",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Fcheck.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Fcheck.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Fcheck.h?ref=9a534e7b9dfedf17941f35b41004d0edcf88132f",
            "patch": "@@ -0,0 +1,52 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_ERROR_CHECK_H_\n+#define XLA_ERROR_CHECK_H_\n+\n+#include \"xla/error/internal/check_impl.h\"  // IWYU pragma: keep, b/300560485\n+\n+// XLA_CHECK is meant to be a drop-in replacement for Abseil's CHECK in XLA. It\n+// 1. has the exact same API as Abseil's CHECK.\n+// 2. respects absl flags e.g. ABSL_MIN_LOG_LEVEL\n+// 3. includes all message content as that of Abseil's CHECK, but additionally\n+//    a. prepends an error code and appends a link to the openxla.org webpage\n+//    b. appends DebugMeContext information if available.\n+//    to the error message.\n+//\n+// Example:\n+//   tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+//                                                  \"MyTestPass\");\n+//   XLA_CHECK(false) << \"custom message\";\n+//\n+// crashes with the following error message:\n+//   E0012: Internal: Check failed: false custom message\n+//   DebugMeContext:\n+//     HLO Passes: MyTestPass\n+#define XLA_CHECK(condition) XLA_INTERNAL_CHECK_IMPL((condition), #condition)\n+\n+// `XLA_QCHECK` behaves like `XLA_CHECK` but does not print a full stack trace\n+// and does not run registered error handlers (as `QFATAL`).  It is useful when\n+// the problem is definitely unrelated to program flow, e.g. when validating\n+// user input.\n+#define XLA_QCHECK(condition) XLA_INTERNAL_QCHECK_IMPL((condition), #condition)\n+\n+// `XLA_DCHECK` behaves like `XLA_CHECK` in debug mode and does nothing\n+// otherwise (as `XLA_DCHECK`).  Unlike with `CHECK` (but as with `assert`), it\n+// is not safe to rely on evaluation of `condition`: when `NDEBUG` is enabled,\n+// DCHECK does not evaluate the condition.\n+#define XLA_DCHECK(condition) XLA_INTERNAL_DCHECK_IMPL((condition), #condition)\n+\n+#endif  // XLA_ERROR_CHECK_H_"
        },
        {
            "sha": "4d64fd5952f35ac7534d6f4289289e5f571476c8",
            "filename": "third_party/xla/xla/error/check_test.cc",
            "status": "added",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Fcheck_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Fcheck_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Fcheck_test.cc?ref=9a534e7b9dfedf17941f35b41004d0edcf88132f",
            "patch": "@@ -0,0 +1,122 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/error/check.h\"\n+\n+#include <gtest/gtest.h>\n+#include \"xla/error/debug_me_context_util.h\"\n+#include \"xla/tsl/platform/debug_me_context.h\"\n+\n+namespace xla::error {\n+namespace {\n+\n+using ::testing::ContainsRegex;\n+\n+TEST(CheckTest, TrueCondition_DoesNotCrash) { XLA_CHECK(true); }\n+\n+TEST(CheckTest, TrueConditionWithExpression_EvaluatesOnlyOnce) {\n+  int x = 0;\n+  XLA_CHECK(++x == 1);\n+  EXPECT_EQ(x, 1);\n+}\n+\n+TEST(CheckTest, TrueConditionWithMessageExpression_DoesNotEvaluate) {\n+  int x = 0;\n+  XLA_CHECK(true) << ++x;\n+  EXPECT_EQ(x, 0);\n+}\n+\n+TEST(CheckTest, FalseCondition_Crashes) {\n+  EXPECT_DEATH(\n+      XLA_CHECK(false),\n+      ContainsRegex(\n+          \"check_test.cc:[0-9]+] E0012: Internal: Check failed: false\"));\n+}\n+\n+TEST(CheckTest, FalseConditionWithMessage_Crashes) {\n+  EXPECT_DEATH(XLA_CHECK(false) << \"custom error message\",\n+               ContainsRegex(\n+                   \"check_test.cc:[0-9]+] E0012: Internal: Check failed: false \"\n+                   \"custom error message\"));\n+}\n+\n+TEST(CheckTest, FalseConditionWithExpression_Crashes) {\n+  int x = 0;\n+  EXPECT_DEATH(\n+      XLA_CHECK(x == 1),\n+      ContainsRegex(\n+          \"check_test.cc:[0-9]+] E0012: Internal: Check failed: x == 1\"));\n+}\n+\n+TEST(CheckTest, FalseCondition_WithMessageAndDebugContext_Crashes) {\n+  tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+                                                 \"MyTestPass\");\n+  EXPECT_DEATH(XLA_CHECK(false) << \"custom error message\",\n+               ContainsRegex(\n+                   \"check_test.cc:[0-9]+] E0012: Internal: Check failed: false \"\n+                   \"custom error \"\n+                   \"message\\nDebugMeContext:\\nHLO Passes: MyTestPass\"));\n+}\n+\n+TEST(CheckTest, QFatalTrueCondition_DoesNotCrash) { XLA_QCHECK(true); }\n+\n+TEST(CheckTest, QFatalTrueConditionWithExpression_EvaluatesOnlyOnce) {\n+  int x = 0;\n+  XLA_QCHECK(++x == 1);\n+  EXPECT_EQ(x, 1);\n+}\n+\n+TEST(CheckTest, QFatalTrueConditionWithMessageExpression_DoesNotEvaluate) {\n+  int x = 0;\n+  XLA_QCHECK(true) << ++x;\n+  EXPECT_EQ(x, 0);\n+}\n+\n+TEST(CheckTest, QFatalCondition_Crashes) {\n+  EXPECT_DEATH(\n+      XLA_QCHECK(false),\n+      ContainsRegex(\n+          \"check_test.cc:[0-9]+] E0012: Internal: Check failed: false\"));\n+}\n+\n+TEST(CheckTest, QFatalConditionWithMessage_Crashes) {\n+  EXPECT_DEATH(XLA_QCHECK(false) << \"custom error message\",\n+               ContainsRegex(\n+                   \"check_test.cc:[0-9]+] E0012: Internal: Check failed: false \"\n+                   \"custom error message\"));\n+}\n+\n+TEST(CheckTest, QFatalConditionWithExpression_Crashes) {\n+  int x = 0;\n+  EXPECT_DEATH(\n+      XLA_QCHECK(x == 1),\n+      ContainsRegex(\n+          \"check_test.cc:[0-9]+] E0012: Internal: Check failed: x == 1\"));\n+}\n+\n+TEST(CheckTest, QFatalCondition_WithMessageAndDebugContext_Crashes) {\n+  tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+                                                 \"MyTestPass\");\n+  EXPECT_DEATH(XLA_QCHECK(false) << \"custom error message\",\n+               ContainsRegex(\n+                   \"check_test.cc:[0-9]+] E0012: Internal: Check failed: false \"\n+                   \"custom error \"\n+                   \"message\\nDebugMeContext:\\nHLO Passes: MyTestPass\"));\n+}\n+\n+TEST(CheckTest, DCheckTrueNoDebug_DoesNotCrash) { XLA_DCHECK(true); }\n+\n+}  // namespace\n+}  // namespace xla::error"
        },
        {
            "sha": "259574dbdfdd60399d8166f8dfce78f3db86a72e",
            "filename": "third_party/xla/xla/error/internal/BUILD",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2FBUILD?ref=9a534e7b9dfedf17941f35b41004d0edcf88132f",
            "patch": "@@ -0,0 +1,38 @@\n+load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = [\n+        \":internal_users\",\n+    ],\n+    licenses = [\"notice\"],\n+)\n+\n+package_group(\n+    name = \"internal_users\",\n+    packages = [\n+        \"//xla/error/...\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"check_impl\",\n+    hdrs = [\"check_impl.h\"],\n+    deps = [\n+        \":check_helper\",\n+        \"@com_google_absl//absl/base:core_headers\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"check_helper\",\n+    hdrs = [\"check_helper.h\"],\n+    deps = [\n+        \"//xla/error:debug_me_context_util\",\n+        \"//xla/error:error_codes\",\n+        \"@com_google_absl//absl/base:nullability\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+    ],\n+)"
        },
        {
            "sha": "a29d41c0da09d0e06c050955c47806b30d34eaaf",
            "filename": "third_party/xla/xla/error/internal/check_helper.h",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2Fcheck_helper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2Fcheck_helper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2Fcheck_helper.h?ref=9a534e7b9dfedf17941f35b41004d0edcf88132f",
            "patch": "@@ -0,0 +1,81 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_ERROR_INTERNAL_CHECK_HELPER_H_\n+#define XLA_ERROR_INTERNAL_CHECK_HELPER_H_\n+\n+#include <cstdint>\n+#include <ostream>\n+#include <sstream>\n+#include <string>\n+\n+#include \"absl/base/nullability.h\"\n+#include \"absl/log/log.h\"\n+#include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/error/debug_me_context_util.h\"\n+#include \"xla/error/error_codes.h\"\n+\n+namespace xla::error {\n+\n+// Enum to control the termination behavior of the CheckHelper.\n+enum class CheckType : std::uint8_t { kFatal, kQFatal };\n+\n+// Helper class to pretty print the debug context and user message when a check\n+// fails.\n+class CheckHelper {\n+ public:\n+  CheckHelper(const char* absl_nonnull file, int line,\n+              absl::string_view condition_text,\n+              CheckType check_type = CheckType::kFatal)\n+      : file_(absl::string_view(file)),\n+        line_(line),\n+        condition_text_(condition_text),\n+        check_type_(check_type) {}\n+\n+  // Non-copyable/movable.\n+  CheckHelper(const CheckHelper&) = delete;\n+  CheckHelper& operator=(const CheckHelper&) = delete;\n+\n+  // *always* terminates via LOG(FATAL).\n+  [[noreturn]] ~CheckHelper() {\n+    std::string error_message = absl::StrCat(\n+        GetErrorCodeAndName(ErrorCode::kInternal),\n+        \": Check failed: \", condition_text_, \" \", user_stream_.str(), \"\\n\",\n+        DebugMeContextToErrorMessageString());\n+\n+    switch (check_type_) {\n+      case CheckType::kFatal:\n+        LOG(FATAL).AtLocation(file_, line_) << error_message;\n+        break;\n+      case CheckType::kQFatal:\n+        LOG(QFATAL).AtLocation(file_, line_) << error_message;\n+        break;\n+    }\n+  }\n+\n+  std::ostream& InternalStream() { return user_stream_; }\n+\n+ private:\n+  absl::string_view file_;\n+  int line_;\n+  absl::string_view condition_text_;\n+  CheckType check_type_;\n+  std::ostringstream user_stream_;\n+};\n+\n+}  // namespace xla::error\n+\n+#endif  // XLA_ERROR_INTERNAL_CHECK_HELPER_H_"
        },
        {
            "sha": "16a01ec5595918aaa062530d70cbff4033f90605",
            "filename": "third_party/xla/xla/error/internal/check_impl.h",
            "status": "added",
            "additions": 96,
            "deletions": 0,
            "changes": 96,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2Fcheck_impl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a534e7b9dfedf17941f35b41004d0edcf88132f/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2Fcheck_impl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Finternal%2Fcheck_impl.h?ref=9a534e7b9dfedf17941f35b41004d0edcf88132f",
            "patch": "@@ -0,0 +1,96 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_ERROR_INTERNAL_CHECK_IMPL_H_\n+#define XLA_ERROR_INTERNAL_CHECK_IMPL_H_\n+\n+#include <cstdlib>  // IWYU pragma: keep\n+\n+#include \"absl/base/attributes.h\"\n+#include \"absl/base/optimization.h\"\n+#include \"xla/error/internal/check_helper.h\"  // IWYU pragma: keep, b/300560485\n+\n+namespace xla::error {\n+\n+// Helper class to allow us to use the `&&` operator in the `XLA_CHECK` macros.\n+class Voidify final {\n+ public:\n+  // This has to be an operator with a precedence lower than << but higher than\n+  // ?:\n+  template <typename T>\n+  ABSL_ATTRIBUTE_COLD void operator&&(T&& message) const&& {\n+    // The dispatching of the completed `absl::LogEntry` to applicable\n+    // `absl::LogSink`s happens here.\n+    message.flush();\n+  }\n+};\n+\n+[[noreturn]] inline void AbortQuietly() { abort(); }\n+\n+}  // namespace xla::error\n+\n+#define XLA_INTERNAL_CONDITION(condition) \\\n+  switch (0)                              \\\n+  case 0:                                 \\\n+  default:                                \\\n+    !(condition) ? (void)0 : ::xla::error::Voidify() &&\n+\n+#ifdef ABSL_MIN_LOG_LEVEL\n+#define XLA_INTERNAL_CONDITION_FATAL(condition)                        \\\n+  XLA_INTERNAL_CONDITION(                                              \\\n+      ((condition) ? (::absl::LogSeverity::kFatal >=                   \\\n+                              static_cast<::absl::LogSeverityAtLeast>( \\\n+                                  ABSL_MIN_LOG_LEVEL)                  \\\n+                          ? true                                       \\\n+                          : (xla::error::AbortQuietly(), false))       \\\n+                   : false))\n+#else  // ndef ABSL_MIN_LOG_LEVEL\n+#define XLA_INTERNAL_CONDITION_FATAL(condition) \\\n+  XLA_INTERNAL_CONDITION(condition)\n+#endif  // ABSL_MIN_LOG_LEVEL\n+\n+#ifdef ABSL_MIN_LOG_LEVEL\n+#define XLA_INTERNAL_CONDITION_QFATAL(condition)                       \\\n+  XLA_INTERNAL_CONDITION(                                              \\\n+      ((condition) ? (::absl::LogSeverity::kFatal >=                   \\\n+                              static_cast<::absl::LogSeverityAtLeast>( \\\n+                                  ABSL_MIN_LOG_LEVEL)                  \\\n+                          ? true                                       \\\n+                          : (xla::error::ExitQuietly(), false))        \\\n+                   : false))\n+#else  // ndef ABSL_MIN_LOG_LEVEL\n+#define XLA_INTERNAL_CONDITION_QFATAL(condition) \\\n+  XLA_INTERNAL_CONDITION(condition)\n+#endif  // ABSL_MIN_LOG_LEVEL\n+\n+#define XLA_INTERNAL_CHECK_IMPL(condition, condition_text)       \\\n+  XLA_INTERNAL_CONDITION_FATAL(ABSL_PREDICT_FALSE(!(condition))) \\\n+  CheckHelper(__FILE__, __LINE__, condition_text).InternalStream()\n+\n+#define XLA_INTERNAL_QCHECK_IMPL(condition, condition_text)           \\\n+  XLA_INTERNAL_CONDITION_QFATAL(ABSL_PREDICT_FALSE(!(condition)))     \\\n+  CheckHelper(__FILE__, __LINE__, condition_text, CheckType::kQFatal) \\\n+      .InternalStream()\n+\n+// DCHECK impl\n+#ifndef NDEBUG\n+#define XLA_INTERNAL_DCHECK_IMPL(condition, condition_text) \\\n+  XLA_INTERNAL_CHECK_IMPL(condition, condition_text)\n+#else\n+#define XLA_INTERNAL_DCHECK_IMPL(condition, condition_text) \\\n+  XLA_INTERNAL_CHECK_IMPL(true || (condition), \"true\")\n+#endif\n+\n+#endif  // XLA_ERROR_INTERNAL_CHECK_IMPL_H_"
        }
    ],
    "stats": {
        "total": 407,
        "additions": 407,
        "deletions": 0
    }
}