{
    "author": "ezhulenev",
    "message": "[xla:pjrt] Add Promise::MakeShared API to convert move-only promise to std::shared_ptr\n\nPiperOrigin-RevId: 806020441",
    "sha": "c7e1077ae86bde1e28003911bd8f9abf8deb018f",
    "files": [
        {
            "sha": "dcf2ccbb522be6d8557ea56baa3992d30c3af3a8",
            "filename": "third_party/xla/xla/pjrt/pjrt_future.h",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c7e1077ae86bde1e28003911bd8f9abf8deb018f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c7e1077ae86bde1e28003911bd8f9abf8deb018f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h?ref=c7e1077ae86bde1e28003911bd8f9abf8deb018f",
            "patch": "@@ -494,6 +494,12 @@ class PjRtFuture : public internal::PjRtFutureBase<absl::StatusOr<T>> {\n \n     MoveOnlyPromise(MoveOnlyPromise&&) = default;\n     MoveOnlyPromise& operator=(MoveOnlyPromise&&) = default;\n+\n+    // A helper function to convert move-only Promise to shared_ptr, which is\n+    // useful when the promise has to be captured by a std::function.\n+    std::shared_ptr<MoveOnlyPromise> ToShared() && {\n+      return std::make_shared<MoveOnlyPromise>(std::move(*this));\n+    }\n   };\n \n   // Returns a Promise that can be used to construct a PjRtFuture, and then Set\n@@ -767,6 +773,12 @@ class PjRtFuture<void> : public internal::PjRtFutureBase<absl::Status> {\n \n     MoveOnlyPromise(MoveOnlyPromise&&) = default;\n     MoveOnlyPromise& operator=(MoveOnlyPromise&&) = default;\n+\n+    // A helper function to convert move-only Promise to shared_ptr, which is\n+    // useful when the promise has to be captured by a std::function.\n+    std::shared_ptr<MoveOnlyPromise> ToShared() && {\n+      return std::make_shared<MoveOnlyPromise>(std::move(*this));\n+    }\n   };\n \n   // Returns a Promise that can be used to construct a PjRtFuture, and then Set"
        },
        {
            "sha": "9e7deb97d75e60908bb6dada4ae1ad180156cc42",
            "filename": "third_party/xla/xla/pjrt/pjrt_future_test.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c7e1077ae86bde1e28003911bd8f9abf8deb018f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c7e1077ae86bde1e28003911bd8f9abf8deb018f/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future_test.cc?ref=c7e1077ae86bde1e28003911bd8f9abf8deb018f",
            "patch": "@@ -617,6 +617,34 @@ TEST(PjRtFutureTest, WithProfiling) {\n   EXPECT_EQ(*update_profiling.Await(), 42);\n }\n \n+TEST(PjRtFutureTest, MakeSharedPromise) {\n+  {  // Stateless future.\n+    auto [promise, future] = PjRtFuture<>::MakePromise();\n+\n+    auto shared_promise = std::move(promise).ToShared();\n+    shared_promise->Set();\n+\n+    // NOLINTNEXTLINE(bugprone-use-after-move)\n+    EXPECT_FALSE(static_cast<bool>(promise));\n+\n+    EXPECT_TRUE(future.IsReady());\n+    EXPECT_EQ(future.Await(), absl::OkStatus());\n+  }\n+\n+  {  // Stateful future.\n+    auto [promise, future] = PjRtFuture<int32_t>::MakePromise();\n+\n+    auto shared_promise = std::move(promise).ToShared();\n+    shared_promise->Set(42);\n+\n+    // NOLINTNEXTLINE(bugprone-use-after-move)\n+    EXPECT_FALSE(static_cast<bool>(promise));\n+\n+    EXPECT_TRUE(future.IsReady());\n+    EXPECT_EQ(*future.Await(), 42);\n+  }\n+}\n+\n //===----------------------------------------------------------------------===//\n // Performance benchmarks.\n //===----------------------------------------------------------------------===//"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 40,
        "deletions": 0
    }
}