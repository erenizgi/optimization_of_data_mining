{
    "author": "metaflow",
    "message": "[XLA:GPU] don't stop traversal when sinking bitcasts\n\nFor example if we have a fusion\n\n```\ndot\nbitcast1\n...\nbad_op\n...\nbitcast2\n...\nROOT root = ...\n```\n\nwe can still benefit from sinking bitcast2 even though instructions between dot and bad_op will not change.\n\nPiperOrigin-RevId: 846314341",
    "sha": "1a5402d93fa5e31c19ba7113468aa970c2a2036a",
    "files": [
        {
            "sha": "d48d3ca7ad9156e6a57b41a07823fd99c3a52a40",
            "filename": "third_party/xla/xla/service/gpu/transforms/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a5402d93fa5e31c19ba7113468aa970c2a2036a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a5402d93fa5e31c19ba7113468aa970c2a2036a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2FBUILD?ref=1a5402d93fa5e31c19ba7113468aa970c2a2036a",
            "patch": "@@ -1888,14 +1888,11 @@ cc_library(\n         \"//xla/hlo/pass:hlo_pass\",\n         \"//xla/hlo/utils:hlo_query\",\n         \"//xla/service:call_graph\",\n-        \"//xla/service:matmul_indexing_utils\",\n         \"//xla/service/gpu:backend_configs_cc\",\n         \"//xla/service/gpu:matmul_utils\",\n-        \"//xla/service/gpu/model:block_level_parameters\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n-        \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\",\n@@ -1920,14 +1917,11 @@ xla_cc_test(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/testlib:filecheck\",\n         \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n-        \"//xla/hlo/testlib:pattern_matcher_gmock\",\n         \"//xla/hlo/testlib:verified_hlo_module\",\n-        \"//xla/service:pattern_matcher\",\n         \"//xla/service/gpu:backend_configs_cc\",\n         \"//xla/service/gpu:gpu_device_info_for_tests\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/stream_executor/cuda:cuda_compute_capability\",\n-        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status:status_matchers\","
        },
        {
            "sha": "8ca5c54ce1db0deef41653984696dc7acad8f522",
            "filename": "third_party/xla/xla/service/gpu/transforms/hoist_fused_bitcasts.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 18,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a5402d93fa5e31c19ba7113468aa970c2a2036a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fhoist_fused_bitcasts.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a5402d93fa5e31c19ba7113468aa970c2a2036a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fhoist_fused_bitcasts.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fhoist_fused_bitcasts.cc?ref=1a5402d93fa5e31c19ba7113468aa970c2a2036a",
            "patch": "@@ -638,7 +638,9 @@ PlanHoistBitcastUpwardsToCallers(const HloInstruction* bitcast) {\n   return result;\n }\n \n-// Returns the shape of the root instruction after hoisting all bitcasts.\n+// Returns the shape of the root instruction after hoisting bitcasts away from\n+// the dot instruction. If traversal encounters an instruction we cannot hoist\n+// bitcasts past we try to sink the bitcast starting from that instruction.\n //\n // For example, given:\n //\n@@ -700,28 +702,35 @@ absl::StatusOr<Shape> ComputeRootShapeAfterHoistingBitcasts(\n     TF_ASSIGN_OR_RETURN(Shape result_shape, [&]() -> absl::StatusOr<Shape> {\n       switch (instruction->opcode()) {\n         case HloOpcode::kBroadcast: {\n-          TF_ASSIGN_OR_RETURN(\n-              BitcastParams params,\n-              CalculateBroadcastOfBitcast(\n-                  Cast<HloBroadcastInstruction>(instruction), operand_shape));\n-          return params.new_shape;\n+          auto paramsOr = CalculateBroadcastOfBitcast(\n+              Cast<HloBroadcastInstruction>(instruction), operand_shape);\n+          if (paramsOr.ok()) {\n+            return paramsOr->new_shape;\n+          }\n+          VLOG(2) << \"Failed to calculate broadcast of bitcast: \"\n+                  << paramsOr.status();\n+          return instruction->shape();\n         }\n         case HloOpcode::kTranspose: {\n-          TF_ASSIGN_OR_RETURN(\n-              BitcastParams params,\n-              CalculateTransposeOfBitcast(\n-                  Cast<HloTransposeInstruction>(instruction), operand_shape));\n-          return params.new_shape;\n-        }\n-        default:\n-          if (!instruction->IsElementwise()) {\n-            return absl::FailedPreconditionError(absl::StrCat(\n-                \"Cannot hoist bitcast past \", instruction->ToString()));\n+          auto paramsOr = CalculateTransposeOfBitcast(\n+              Cast<HloTransposeInstruction>(instruction), operand_shape);\n+          if (paramsOr.ok()) {\n+            return paramsOr->new_shape;\n           }\n-          [[fallthrough]];\n-        case HloOpcode::kReshape:  // Reshape is a bitcast.\n+          VLOG(2) << \"Failed to calculate transpose of bitcast: \"\n+                  << paramsOr.status();\n+          return instruction->shape();\n+        }\n+        case HloOpcode::kReshape:\n         case HloOpcode::kBitcast:\n           return operand_shape;\n+        default:\n+          if (instruction->IsElementwise()) {\n+            return operand_shape;\n+          }\n+          // TODO(b/467421789): we can probably allow sinking from this op down.\n+          return absl::FailedPreconditionError(absl::StrCat(\n+              \"Cannot hoist bitcast past \", instruction->ToString()));\n       }\n     }());\n     if (instruction->IsRoot()) {\n@@ -822,6 +831,9 @@ absl::Status MaybeInsertRootBitcast(HloInstruction* dot,\n // transposes and broadcasts. This is not reported as an error.\n absl::Status TryHoistBitcastsInComputationToCallers(HloInstruction* dot,\n                                                     CallGraph* call_graph) {\n+  // Instead of implementing a logic to hoist bitcast upwards and downwards\n+  // we insert a bitcast at the root that and always hoist bitcasts upwards.\n+  // That significantly simplifies the implementation.\n   VLOG(2) << \"Before hoisting bitcasts: \" << dot->parent()->ToString();\n \n   auto callers = call_graph->GetComputationCallers(dot->parent());"
        },
        {
            "sha": "9077028ea7696353255387d85abc2b075c04f1a1",
            "filename": "third_party/xla/xla/service/gpu/transforms/hoist_fused_bitcasts_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 16,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a5402d93fa5e31c19ba7113468aa970c2a2036a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fhoist_fused_bitcasts_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a5402d93fa5e31c19ba7113468aa970c2a2036a/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fhoist_fused_bitcasts_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fhoist_fused_bitcasts_test.cc?ref=1a5402d93fa5e31c19ba7113468aa970c2a2036a",
            "patch": "@@ -231,27 +231,25 @@ CHECK: f16[3,11]{1,0} fusion(\n       IsOkAndHolds(true));\n }\n \n-// We cannot hoist bitcasts past transposes, but we don't need to hoist\n-// because the bitcast is not rank-expanding and symbolic tile analysis\n-// works fine.\n-TEST_P(HoistFusedBitcastsReshapeTest, BitcastsCannotBeHoistedPastTransposes) {\n+TEST_P(HoistFusedBitcastsReshapeTest,\n+       ResumeBitcastSinkingAfterIncompatibleOps) {\n+  // Even though we cannot hoist the bitcast1 past the transpose we still can\n+  // remove bitcast2.\n   HloOpcode opcode = GetParam();\n   absl::string_view hlo = R\"(\n dot {\n-  p0 = f32[72,36,2] parameter(0)\n-  transpose0 = f32[72,2,36] transpose(p0), dimensions={0,2,1}\n-  bitcast0 = f32[144,36] $0(transpose0)\n-  p1 = f32[36,3] parameter(1)\n-  dot = f32[144,3] dot(bitcast0, p1),\n-    lhs_contracting_dims={1}, rhs_contracting_dims={0}\n-  bitcast1 = f32[144,3] $0(dot)\n-  ROOT transpose1 = f32[3,144] transpose(bitcast1), dimensions={1,0}\n+  p0 = f32[2,32] parameter(0)\n+  p1 = f32[64,32] parameter(1)\n+  dot = f32[2,64] dot(p0, p1), lhs_contracting_dims={1}, rhs_contracting_dims={1}\n+  bitcast1 = f32[2,32,2] $0(dot)\n+  transpose1 = f32[2,2,32] transpose(bitcast1), dimensions={0,2,1}\n+  ROOT bitcast2 = f32[1,2,1,2,32] $0(transpose1)\n }\n \n ENTRY entry {\n-  p0 = f32[72,36,2] parameter(0)\n-  p1 = f32[36,3] parameter(1)\n-  ROOT fusion = f32[3,144] fusion(p0, p1),\n+  p0 = f32[2,32] parameter(0)\n+  p1 = f32[64,32] parameter(1)\n+  ROOT fusion = f32[1,2,1,2,32] fusion(p0, p1),\n     kind=kCustom, calls=dot, backend_config={\n       \"fusion_backend_config\":{\n         \"kind\":\"__triton_gemm\",\"triton_gemm_config\":{\n@@ -261,7 +259,15 @@ ENTRY entry {\n       }\n     }\n })\";\n-  RunHoistFusedBitcasts(absl::Substitute(hlo, HloOpcodeString(opcode)));\n+  auto module =\n+      RunHoistFusedBitcasts(absl::Substitute(hlo, HloOpcodeString(opcode)));\n+  EXPECT_THAT(\n+      RunFileCheck(module->ToString(HloPrintOptions::ShortParsable()), R\"(\n+  CHECK: ROOT {{.*}} = f32[2,2,32]{2,1,0} transpose\n+  CHECK: ENTRY\n+  CHECK: ROOT {{.*}} = f32[1,2,1,2,32]{4,3,2,1,0} bitcast\n+)\"),\n+      IsOkAndHolds(true));\n }\n \n TEST_P(HoistFusedBitcastsReshapeTest, BitcastsKeepElementSizeInBits) {"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 52,
        "deletions": 40
    }
}