{
    "author": "ezhulenev",
    "message": "[xla:ffi] Document XLA:FFI binary API guarantees and add a supporteded API range check\n\nPiperOrigin-RevId: 822214561",
    "sha": "61414968174396875917d754c69e542e66331d17",
    "files": [
        {
            "sha": "565b0636fecfa8ed52e3bd9eb3f620de5e62c9c6",
            "filename": "third_party/xla/xla/ffi/api/c_api.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/61414968174396875917d754c69e542e66331d17/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/61414968174396875917d754c69e542e66331d17/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h?ref=61414968174396875917d754c69e542e66331d17",
            "patch": "@@ -61,6 +61,15 @@ XLA_FFI_DEFINE_STRUCT_TRAITS(XLA_FFI_Extension_Base, next);\n // Version\n //===----------------------------------------------------------------------===//\n \n+// XLA FFI provides a stable binary API for registering custom calls with\n+// XLA runtime. XLA runtime guarantees that old API version are supported for\n+// at least 12 months, after that point FFI library has to be recompiled with\n+// latest XLA FFI headers to support new features. We don't plan to break ABI\n+// compatibility, unless it's absolutely necessary to enable new features that\n+// can't be implemented in a backward compatible way.\n+//\n+// The range of supported API versions is defined in `xla/ffi/ffi_api.cc`.\n+\n // Incremented when an ABI-incompatible change is made to the interface.\n //\n // Major changes include:"
        },
        {
            "sha": "03b7cbb5962b9b3ba84fbfa8e1463696aba0d54e",
            "filename": "third_party/xla/xla/ffi/ffi_api.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 9,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/61414968174396875917d754c69e542e66331d17/third_party%2Fxla%2Fxla%2Fffi%2Fffi_api.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/61414968174396875917d754c69e542e66331d17/third_party%2Fxla%2Fxla%2Fffi%2Fffi_api.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fffi_api.cc?ref=61414968174396875917d754c69e542e66331d17",
            "patch": "@@ -97,6 +97,25 @@ struct XLA_FFI_ExecutionContext {\n \n namespace xla::ffi {\n \n+// The minimum XLA:FFI API version that XLA runtime supports.\n+static constexpr std::pair<int32_t, int32_t> kMinSupportedApiVersion = {\n+    /*major=*/0,\n+    /*minor=*/1,\n+};\n+\n+// The maximum XLA:FFI API version that XLA runtime supports.\n+static constexpr std::pair<int32_t, int32_t> kMaxSupportedApiVersion = {\n+    XLA_FFI_API_MAJOR,\n+    XLA_FFI_API_MINOR,\n+};\n+\n+static bool IsSupportedApiVersion(const XLA_FFI_Api_Version& api_version) {\n+  std::pair<int32_t, int32_t> version = {api_version.major_version,\n+                                         api_version.minor_version};\n+  return version >= kMinSupportedApiVersion &&\n+         version <= kMaxSupportedApiVersion;\n+}\n+\n bool IsCommandBufferCompatible(XLA_FFI_Handler_Traits traits) {\n   return traits & XLA_FFI_HANDLER_TRAITS_COMMAND_BUFFER_COMPATIBLE;\n }\n@@ -381,17 +400,18 @@ static absl::Status RegisterHandler(absl::string_view name,\n         name, platform);\n   }\n \n-  // Check the API versions.\n+  // Check the API version that FFI handler was compiled with is supported.\n   TF_ASSIGN_OR_RETURN(XLA_FFI_Metadata metadata, GetMetadata(bundle.execute));\n-  const XLA_FFI_Api_Version& api_version = metadata.api_version;\n-  if (std::make_pair(api_version.major_version, api_version.minor_version) >\n-      std::make_pair(XLA_FFI_API_MAJOR, XLA_FFI_API_MINOR)) {\n+  if (!IsSupportedApiVersion(metadata.api_version)) {\n     return InvalidArgument(\n-        \"FFI handler registration for %s on platform %s (canonical %s) failed \"\n-        \"because the handler's API version (%d.%d) is incompatible with the \"\n-        \"framework's API version (%d.%d)\",\n-        name, platform, canonical_platform, api_version.major_version,\n-        api_version.minor_version, XLA_FFI_API_MAJOR, XLA_FFI_API_MINOR);\n+        \"XLA FFI handler registration for %s on platform %s (canonical %s) \"\n+        \"failed because the handler's API version (%d.%d) is incompatible with \"\n+        \"the framework's API version (%d.%d). Minimum supported API version is \"\n+        \"(%d.%d).\",\n+        name, platform, canonical_platform, metadata.api_version.major_version,\n+        metadata.api_version.minor_version, kMaxSupportedApiVersion.first,\n+        kMaxSupportedApiVersion.second, kMinSupportedApiVersion.first,\n+        kMinSupportedApiVersion.second);\n   }\n \n   // Incorporate handler traits."
        }
    ],
    "stats": {
        "total": 47,
        "additions": 38,
        "deletions": 9
    }
}