{
    "author": "loislo",
    "message": "[XLA:GPU] Add source location to FusionDecision explanations.\n\nThis change enhances `FusionDecision` to include the source location in the explanation string when a fusion is forbidden, under `PLATFORM_GOOGLE`. This helps in debugging by providing context on where the decision was made.\n\nPiperOrigin-RevId: 800461830",
    "sha": "1316a953f892d6bcd25f67c99e0fb492c2bfc033",
    "files": [
        {
            "sha": "5f572d4be546efa6b24ee6f9518bbf1109deead4",
            "filename": "third_party/xla/xla/service/instruction_fusion.h",
            "status": "modified",
            "additions": 38,
            "deletions": 8,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1316a953f892d6bcd25f67c99e0fb492c2bfc033/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1316a953f892d6bcd25f67c99e0fb492c2bfc033/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.h?ref=1316a953f892d6bcd25f67c99e0fb492c2bfc033",
            "patch": "@@ -59,32 +59,62 @@ struct InPlaceFusionOptions {\n class FusionDecision {\n  public:\n   static FusionDecision Allow() { return FusionDecision(); }\n-  static FusionDecision Forbid(absl::string_view explanation) {\n-    return FusionDecision(explanation);\n-  }\n   FusionDecision(const FusionDecision& decision) = default;\n \n+#if defined(PLATFORM_GOOGLE)\n+  static std::string LocToString(absl::SourceLocation source_location) {\n+    return absl::StrCat(\" at: \", source_location.file_name(), \":\",\n+                        source_location.line());\n+  }\n+  static FusionDecision Forbid(\n+      absl::string_view explanation,\n+      absl::SourceLocation source_location = absl::SourceLocation::current()) {\n+    return FusionDecision(\n+        absl::StrCat(explanation, LocToString(source_location)));\n+  }\n+\n   // If condition is `true` means that we CAN fuse. In that case, explanation is\n   // discarded.\n-  FusionDecision(bool condition, absl::string_view explanation) {\n+  FusionDecision(\n+      bool condition, absl::string_view explanation,\n+      absl::SourceLocation source_location = absl::SourceLocation::current()) {\n     if (!condition) {\n-      explanation_ = std::string(explanation);\n+      explanation_ = absl::StrCat(explanation, LocToString(source_location));\n     }\n   }\n \n-  explicit FusionDecision(absl::Status status) {\n+  explicit FusionDecision(\n+      absl::Status status,\n+      absl::SourceLocation source_location = absl::SourceLocation::current()) {\n     if (!status.ok()) {\n-      explanation_ = status.message();\n+      explanation_ =\n+          absl::StrCat(status.message(), LocToString(source_location));\n     }\n   }\n \n-#if defined(PLATFORM_GOOGLE)\n   // We can fuse iff. the decision is `true`. The source location indicates\n   // where an instance was created, making debugging easier without a need to\n   // provide explicit explanation.\n   FusionDecision(  // NOLINT\n       bool decision,\n       absl::SourceLocation source_location = absl::SourceLocation::current());\n+#else\n+  // If condition is `true` means that we CAN fuse. In that case, explanation is\n+  // discarded.\n+  FusionDecision(bool condition, absl::string_view explanation) {\n+    if (!condition) {\n+      explanation_ = std::string(explanation);\n+    }\n+  }\n+  static FusionDecision Forbid(absl::string_view explanation) {\n+    return FusionDecision(explanation);\n+  }\n+  explicit FusionDecision(absl::Status status) {\n+    if (!status.ok()) {\n+      explanation_ = status.message();\n+    }\n+  }\n+\n #endif  // PLATFORM_GOOGLE\n \n   // Returns whether it can be fused."
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}