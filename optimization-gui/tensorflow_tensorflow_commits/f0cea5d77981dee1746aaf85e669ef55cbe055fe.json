{
    "author": "liepieshov",
    "message": "Allow `ifrt::CopyArraysOp` as IFRT IR program outputs.\n\nThe output of an IFRT IR program can be either a direct argument (`mlir::BlockArgument`) or (`xla::ifrt::CallLoadedExecutableOp`) output or (`ifrt::CopyArraysOp`)\n\nPiperOrigin-RevId: 818592194",
    "sha": "f0cea5d77981dee1746aaf85e669ef55cbe055fe",
    "files": [
        {
            "sha": "b03802f3c33ebbf9497aa99a21e30fd7caba795e",
            "filename": "third_party/xla/xla/python/ifrt/ir/compiled_ifrt_ir_program.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f0cea5d77981dee1746aaf85e669ef55cbe055fe/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f0cea5d77981dee1746aaf85e669ef55cbe055fe/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc?ref=f0cea5d77981dee1746aaf85e669ef55cbe055fe",
            "patch": "@@ -283,6 +283,16 @@ absl::Status PopulateLayouts(mlir::ModuleOp mlir_module,\n         return absl::FailedPreconditionError(absl::StrFormat(\n             \"Could not find SPMD executable %s\", atom_program_name));\n       }\n+    } else if (llvm::isa<ifrt::CopyArraysOp>(op_result.getOwner())) {\n+      // The output is produced by a CopyArraysOp. Must be device\n+      // default layout.\n+      TF_ASSIGN_OR_RETURN(auto shard_shape,\n+                          out_spec.sharding->GetShardShape(out_spec.shape));\n+      TF_ASSIGN_OR_RETURN(out_spec.layout,\n+                          client->GetDefaultPjRtLayout(\n+                              out_spec.dtype, shard_shape.dims(),\n+                              out_spec.sharding->devices()->devices().front(),\n+                              out_spec.sharding->memory_kind()));\n     } else {\n       return absl::FailedPreconditionError(absl::StrFormat(\n           \"Layouts are supported only for programs that have outputs produced \""
        }
    ],
    "stats": {
        "total": 10,
        "additions": 10,
        "deletions": 0
    }
}