{
    "author": "khasanovaa",
    "message": "Add proto [de]serialization for `Memset32BitValueThunk`.\n\nPiperOrigin-RevId: 820109174",
    "sha": "4dab5ef4a6d8c4a239e89923fefba4f865677e5b",
    "files": [
        {
            "sha": "8252269039dd1ba5c15e20af4878d5b13780a6f8",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.cc?ref=4dab5ef4a6d8c4a239e89923fefba4f865677e5b",
            "patch": "@@ -60,5 +60,28 @@ absl::Status Memset32BitValueThunk::ExecuteOnStream(\n   return params.stream->Memset32(&dest_data, value_, dest_data.size());\n }\n \n+absl::StatusOr<std::unique_ptr<Memset32BitValueThunk>>\n+Memset32BitValueThunk::FromProto(\n+    ThunkInfo thunk_info, const Memset32BitValueThunkProto& thunk_proto,\n+    absl::Span<const BufferAllocation> buffer_allocations) {\n+  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice dest,\n+                      BufferAllocation::Slice::FromProto(\n+                          thunk_proto.dest_buffer(), buffer_allocations));\n+  return std::make_unique<Memset32BitValueThunk>(std::move(thunk_info),\n+                                                 thunk_proto.value(), dest);\n+}\n+\n+absl::StatusOr<ThunkProto> Memset32BitValueThunk::ToProto() const {\n+  ThunkProto proto;\n+  *proto.mutable_thunk_info() = thunk_info().ToProto();\n+\n+  Memset32BitValueThunkProto* memset_thunk_proto =\n+      proto.mutable_memset32bit_value_thunk();\n+  TF_ASSIGN_OR_RETURN(*memset_thunk_proto->mutable_dest_buffer(),\n+                      dest_.ToProto());\n+  memset_thunk_proto->set_value(value_);\n+  return proto;\n+}\n+\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "5fd260891b5fedd1baaf8f5cf5cd63f959e445fc",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk.h?ref=4dab5ef4a6d8c4a239e89923fefba4f865677e5b",
            "patch": "@@ -64,6 +64,12 @@ class Memset32BitValueThunk : public Thunk {\n   const BufferAllocation::Slice& destination() const { return dest_; }\n   uint32_t value() const { return value_; }\n \n+  static absl::StatusOr<std::unique_ptr<Memset32BitValueThunk>> FromProto(\n+      ThunkInfo thunk_info, const Memset32BitValueThunkProto& thunk_proto,\n+      absl::Span<const BufferAllocation> buffer_allocations);\n+\n+  absl::StatusOr<ThunkProto> ToProto() const override;\n+\n  private:\n   const uint32_t value_;\n   const BufferAllocation::Slice dest_;"
        },
        {
            "sha": "0eb1bc60ff2cb365138c5fff0e92dc2a980e7f8b",
            "filename": "third_party/xla/xla/backends/gpu/runtime/memset_thunk_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fmemset_thunk_test.cc?ref=4dab5ef4a6d8c4a239e89923fefba4f865677e5b",
            "patch": "@@ -61,5 +61,34 @@ TEST(MemzeroThunkTest, ProtoRoundTrip) {\n   EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n }\n \n+TEST(Memset32BitValueThunkTest, ProtoRoundTrip) {\n+  ThunkProto proto = ParseTextProtoOrDie<ThunkProto>(\n+      R\"pb(\n+        thunk_info {\n+          profile_annotation: \"partition_id_profile_annotation\"\n+          execution_stream_id: 2\n+        }\n+        memset32bit_value_thunk {\n+          dest_buffer { offset: 0 size: 4 buffer_allocation_index: 0 }\n+          value: 123\n+        }\n+      )pb\");\n+  std::vector<BufferAllocation> buffer_allocations = {\n+      BufferAllocation(/*index=*/0, /*size=*/4, /*color=*/0)};\n+\n+  Thunk::ThunkInfo thunk_info;\n+  thunk_info.profile_annotation = proto.thunk_info().profile_annotation();\n+  thunk_info.execution_stream_id = xla::gpu::ExecutionStreamId{\n+      static_cast<xla::gpu::ExecutionStreamId::ValueType>(\n+          proto.thunk_info().execution_stream_id())};\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Memset32BitValueThunk> thunk,\n+      Memset32BitValueThunk::FromProto(\n+          thunk_info, proto.memset32bit_value_thunk(), buffer_allocations));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(ThunkProto round_trip_proto, thunk->ToProto());\n+  EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        },
        {
            "sha": "7861db766ba2f204d9911e573a61c3094c783eba",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk.proto",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk.proto?ref=4dab5ef4a6d8c4a239e89923fefba4f865677e5b",
            "patch": "@@ -159,6 +159,11 @@ message MemzeroThunkProto {\n   xla.buffer_assignment.BufferAllocationSliceProto dest_buffer = 1;\n }\n \n+message Memset32BitValueThunkProto {\n+  xla.buffer_assignment.BufferAllocationSliceProto dest_buffer = 1;\n+  uint32 value = 2;\n+}\n+\n message ShapedSliceProto {\n   xla.buffer_assignment.BufferAllocationSliceProto slice = 1;\n   xla.ShapeProto shape = 2;\n@@ -263,6 +268,7 @@ message ThunkProto {\n     ConvolutionReorderThunkProto convolution_reorder_thunk = 26;\n     FftThunkProto fft_thunk = 27;\n     CholeskyThunkProto cholesky_thunk = 28;\n+    Memset32BitValueThunkProto memset32bit_value_thunk = 29;\n   }\n }\n "
        },
        {
            "sha": "c2ec6a97527476ea023a280d2cc014fd57269b55",
            "filename": "third_party/xla/xla/backends/gpu/runtime/thunk_proto_deserialization.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4dab5ef4a6d8c4a239e89923fefba4f865677e5b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fthunk_proto_deserialization.cc?ref=4dab5ef4a6d8c4a239e89923fefba4f865677e5b",
            "patch": "@@ -163,6 +163,10 @@ absl::StatusOr<std::unique_ptr<Thunk>> DeserializeThunkProto(\n     case ThunkProto::kFftThunk:\n       return FftThunk::FromProto(std::move(thunk_info), thunk_proto.fft_thunk(),\n                                  buffer_allocations);\n+    case ThunkProto::kMemset32BitValueThunk:\n+      return Memset32BitValueThunk::FromProto(\n+          std::move(thunk_info), thunk_proto.memset32bit_value_thunk(),\n+          buffer_allocations);\n     default:\n       std::optional<absl::string_view> unsupported_thunk_type =\n           GetStoredThunkTypeName(thunk_proto);"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 68,
        "deletions": 0
    }
}