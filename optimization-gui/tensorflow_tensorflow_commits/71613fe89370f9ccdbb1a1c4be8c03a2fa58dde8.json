{
    "author": "hheydary",
    "message": "Add verification for XNNPACK weight cache buffer list.\n\nPiperOrigin-RevId: 803156746",
    "sha": "71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8",
    "files": [
        {
            "sha": "274bdb42b0e1c5a60e598b0834618b16e5fd62ad",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8",
            "patch": "@@ -155,6 +155,11 @@ bool WeightCacheBuilder::StartBuildStep() {\n     XNNPACK_RETURN_CHECK(buffer_list_data.Map(fd_, header.buffer_list_offset,\n                                               file_path_.c_str()),\n                          \"could not map buffer list mapping\");\n+    flatbuffers::Verifier verifier(\n+        reinterpret_cast<const uint8_t*>(buffer_list_data.data()),\n+        header.buffer_list_size);\n+    XNNPACK_RETURN_CHECK(cache::schema::VerifyBufferListBuffer(verifier),\n+                         \"could not verify buffer list mapping\");\n     cache::schema::GetBufferList(buffer_list_data.data())->UnPackTo(&schema_);\n   }\n "
        },
        {
            "sha": "9e97e5265867d107f82efebe4ed0f711bd079565",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache_test.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache_test.cc?ref=71613fe89370f9ccdbb1a1c4be8c03a2fa58dde8",
            "patch": "@@ -186,6 +186,38 @@ TEST(WeightCacheBuilderTest, AppendWithoutReserveWriteWorks) {\n   EXPECT_THAT(cache_data, ElementsAreArray(payload));\n }\n \n+TEST(WeightCacheBuilderTest, CorruptBufferListFailsGracefully) {\n+  const std::string cache_path = testing::TempDir() + \"/cache\";\n+  const std::string payload = \"This is some data in the file.\";\n+  const PackIdentifier dummy_id{1, 2, 3};\n+\n+  FileDescriptor file_descriptor = FileDescriptor::Open(\n+      cache_path.c_str(), O_CREAT | O_TRUNC | O_RDWR, 0644);\n+  WeightCacheBuilder builder;\n+  ASSERT_TRUE(builder.Start(cache_path.c_str(), file_descriptor));\n+  ASSERT_TRUE(builder.StartBuildStep());\n+\n+  const size_t payload_size = size(payload);\n+  auto loc = builder.Append(dummy_id, payload.c_str(), payload_size);\n+  EXPECT_EQ(loc.size, payload_size);\n+  ASSERT_TRUE(builder.StopBuildStep());\n+\n+  // corrupt the buffer list data.\n+  {\n+    FileDescriptor file_descriptor =\n+        FileDescriptor::Open(cache_path.c_str(), O_RDWR, 0644);\n+    ASSERT_TRUE(file_descriptor.IsValid());\n+    XNNPackCacheHeader header;\n+    file_descriptor.SetPos(0);\n+    ASSERT_TRUE(file_descriptor.Read(&header, sizeof(header)));\n+    file_descriptor.SetPos(header.buffer_list_offset + 1);\n+    std::string data(8, 'a');\n+    ASSERT_TRUE(file_descriptor.Write(data.data(), data.size()));\n+  }\n+\n+  EXPECT_FALSE(builder.StartBuildStep());\n+}\n+\n TEST(WeightCacheBuilderTest, InvalidFileDescriptorFails) {\n   WeightCacheBuilder builder;\n   EXPECT_FALSE(builder.Start(\"\", FileDescriptor()));"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 37,
        "deletions": 0
    }
}