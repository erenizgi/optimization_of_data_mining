{
    "author": "ImanHosseini",
    "message": "[XLA:TPU] Refactor midpoint iterator to not use recursion\n\nPiperOrigin-RevId: 801174774",
    "sha": "0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba",
    "files": [
        {
            "sha": "6a31cbdbc11ed4d8a616b0f30676331a5e9851a3",
            "filename": "third_party/xla/xla/service/heap_simulator/heap_simulator.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba/third_party%2Fxla%2Fxla%2Fservice%2Fheap_simulator%2Fheap_simulator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba/third_party%2Fxla%2Fxla%2Fservice%2Fheap_simulator%2Fheap_simulator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fheap_simulator%2Fheap_simulator.cc?ref=0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba",
            "patch": "@@ -2729,13 +2729,17 @@ void BreadthFirstMidpointIterator::Next() {\n   WorkItem work_item = work_items_.front();\n   work_items_.pop_front();\n   if (work_item.start > work_item.end) {\n-    Next();\n+    value_ = std::nullopt;\n     return;\n   }\n   int midpoint = CeilOfRatio(work_item.start + work_item.end, 2);\n   value_ = midpoint;\n-  work_items_.push_back({work_item.start, midpoint - 1});\n-  work_items_.push_back({midpoint + 1, work_item.end});\n+  if (work_item.start < midpoint) {\n+    work_items_.push_back({work_item.start, midpoint - 1});\n+  }\n+  if (work_item.end > midpoint) {\n+    work_items_.push_back({midpoint + 1, work_item.end});\n+  }\n }\n \n template class GlobalDecreasingSizeBestFitHeap<HloValue>;"
        },
        {
            "sha": "4ce284f2bb92cd8c322978ce39bf2b796dcd0299",
            "filename": "third_party/xla/xla/service/heap_simulator/heap_simulator_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba/third_party%2Fxla%2Fxla%2Fservice%2Fheap_simulator%2Fheap_simulator_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba/third_party%2Fxla%2Fxla%2Fservice%2Fheap_simulator%2Fheap_simulator_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fheap_simulator%2Fheap_simulator_test.cc?ref=0539ac7dcd8021f45fbe65ec612ca51a0df0c1ba",
            "patch": "@@ -3827,6 +3827,17 @@ TEST_F(BreadthFirstMidpointIteratorTest, General2) {\n   RunTest(0, 10, {5, 2, 8, 1, 4, 7, 10, 0, 3, 6, 9});\n }\n \n+TEST_F(BreadthFirstMidpointIteratorTest, LargeValuesStackOverflow) {\n+  // This test ensures that the iterator can be used with large values without\n+  // overflowing the stack.\n+  int start = 0;\n+  int end = 1 << 12;\n+  BreadthFirstMidpointIterator iterator(start, end);\n+  for (; !iterator.End(); iterator.Next()) {\n+    // No need to check values, just iterate.\n+  }\n+}\n+\n class GlobalDecreasingSizeBestFitHeapBenchmark : public HeapAlgorithmTestBase {\n  public:\n   void TestBody() override {}"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 18,
        "deletions": 3
    }
}