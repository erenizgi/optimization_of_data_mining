{
    "author": "frgossen",
    "message": "[XLA:GPU] Merge performance table for gemms with existing one if any\n\nThis makes it easier to generate one performance table for multiple platforms.\n\nPiperOrigin-RevId: 806366361",
    "sha": "220df277e8054fba446d4cc515673ea8bf9e42d2",
    "files": [
        {
            "sha": "a411995fca204f49d6a030a550896c00b1bbb769",
            "filename": "third_party/xla/xla/tools/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2FBUILD?ref=220df277e8054fba446d4cc515673ea8bf9e42d2",
            "patch": "@@ -705,10 +705,13 @@ xla_test(\n     deps = [\n         \":matmul_perf_table_gen\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/hlo/testlib:pattern_matcher_gmock\",\n         \"//xla/service/gpu/model:hlo_op_profile_proto_cc\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/tests:hlo_test_base\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util/proto:proto_matchers\",\n+        \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "934549ffcc981b8d66a4665a33eba4ab8d21afef",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.cc?ref=220df277e8054fba446d4cc515673ea8bf9e42d2",
            "patch": "@@ -493,6 +493,14 @@ absl::StatusOr<DeviceHloInstructionProfiles> MatmulPerfTableGen::Merge(\n   return result;\n }\n \n+GemmPerfTable MatmulPerfTableGen::Merge(std::vector<GemmPerfTable> tables) {\n+  GemmPerfTable result;\n+  for (GemmPerfTable& table : tables) {\n+    result.MergeFrom(table);\n+  }\n+  return result;\n+}\n+\n DeviceHloInstructionProfiles MatmulPerfTableGen::ComputeTable() {\n   gpu::DeviceHloInstructionProfiles device_profiles;\n   gpu::HloInstructionProfileList profile_list;"
        },
        {
            "sha": "fc4148d2ac976e8a40f44ad334431fe18f9fc0ab",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen.h?ref=220df277e8054fba446d4cc515673ea8bf9e42d2",
            "patch": "@@ -84,6 +84,8 @@ class MatmulPerfTableGen {\n   absl::StatusOr<DeviceHloInstructionProfiles> Merge(\n       absl::string_view filepath);\n \n+  static GemmPerfTable Merge(std::vector<GemmPerfTable> tables);\n+\n   static absl::StatusOr<GemmPerfTable> Compact(\n       const DeviceHloInstructionProfiles& profiles);\n "
        },
        {
            "sha": "e68c9057a66e1f09d98b6eea5b3f44993b1ae03b",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen_main.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_main.cc?ref=220df277e8054fba446d4cc515673ea8bf9e42d2",
            "patch": "@@ -26,6 +26,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/service/gpu/model/hlo_op_profile.pb.h\"\n #include \"xla/tools/matmul_perf_table_gen.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/util/command_line_flags.h\"\n #include \"tsl/platform/init_main.h\"\n \n@@ -326,10 +327,25 @@ int main(int argc, char* argv[]) {\n     return 0;\n   }\n \n+  // Compute new profiling data.\n   xla::gpu::DeviceHloInstructionProfiles result = table_gen.ComputeTable();\n   auto compact_result = MatmulPerfTableGen::Compact(result);\n   CHECK_OK(compact_result.status());\n-  CHECK_OK(table_gen.Dump(*compact_result));\n+\n+  // Merge with previous results if any.\n+  xla::GemmPerfTable perf_table;\n+  if (tsl::Env::Default()->FileExists(out).ok()) {\n+    xla::GemmPerfTable previous_perf_table;\n+    CHECK_OK(tsl::ReadTextOrBinaryProto(tsl::Env::Default(), out,\n+                                        &previous_perf_table));\n+    perf_table =\n+        MatmulPerfTableGen::Merge({previous_perf_table, *compact_result});\n+  } else {\n+    perf_table = *compact_result;\n+  }\n+\n+  // Dump results.\n+  CHECK_OK(table_gen.Dump(perf_table));\n \n   return 0;\n }"
        },
        {
            "sha": "695a8a743b9e0a70a6544e11ada157fa914c1c6e",
            "filename": "third_party/xla/xla/tools/matmul_perf_table_gen_test.cc",
            "status": "modified",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/220df277e8054fba446d4cc515673ea8bf9e42d2/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmatmul_perf_table_gen_test.cc?ref=220df277e8054fba446d4cc515673ea8bf9e42d2",
            "patch": "@@ -19,10 +19,13 @@ limitations under the License.\n #include <variant>\n \n #include <gtest/gtest.h>\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/testlib/pattern_matcher_gmock.h\"\n #include \"xla/service/gpu/model/hlo_op_profile.pb.h\"\n #include \"xla/stream_executor/device_description.h\"\n #include \"xla/tests/hlo_test_base.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla::gpu {\n@@ -219,5 +222,102 @@ TEST_F(MatmulPerfTableGenTest, CompactTableInDeterministicOrder) {\n   }\n }\n \n+TEST_F(MatmulPerfTableGenTest, MergeGemmTables) {\n+  const absl::string_view kGemmTableOld = R\"pb(\n+    entries {\n+      key: \"sm_90\"\n+      value {\n+        entries {\n+          b: 1\n+          m: 1024\n+          n: 2048\n+          k: 256\n+          flops { key: \"bf16xbf16->bf16\" value: 123000 }\n+          flops { key: \"f32xf32->f32\" value: 456000 }\n+        }\n+        entries {\n+          b: 2\n+          m: 256\n+          n: 2048\n+          k: 2048\n+          flops { key: \"bf16xbf16->bf16\" value: 789000 }\n+          flops { key: \"f32xf32->f32\" value: 123000 }\n+        }\n+      }\n+    }\n+  )pb\";\n+  const absl::string_view kGemmTableNew = R\"pb(\n+    entries {\n+      key: \"sm_90\"\n+      value {\n+        entries {\n+          b: 1\n+          m: 1024\n+          n: 2048\n+          k: 256\n+          flops { key: \"bf16xbf16->bf16\" value: 123 }\n+          flops { key: \"f32xf32->f32\" value: 456 }\n+        }\n+      }\n+      key: \"sm_100\"\n+      value {\n+        entries {\n+          b: 2\n+          m: 256\n+          n: 2048\n+          k: 2048\n+          flops { key: \"bf16xbf16->bf16\" value: 789 }\n+          flops { key: \"f32xf32->f32\" value: 123 }\n+        }\n+      }\n+    }\n+  )pb\";\n+  const absl::string_view kGemmTableExpected = R\"pb(\n+    entries {\n+      key: \"sm_90\"\n+      value {\n+        entries {\n+          b: 1\n+          m: 1024\n+          n: 2048\n+          k: 256\n+          flops { key: \"bf16xbf16->bf16\" value: 123 }\n+          flops { key: \"f32xf32->f32\" value: 456 }\n+        }\n+        entries {\n+          b: 2\n+          m: 256\n+          n: 2048\n+          k: 2048\n+          flops { key: \"bf16xbf16->bf16\" value: 789000 }\n+          flops { key: \"f32xf32->f32\" value: 123000 }\n+        }\n+      }\n+      key: \"sm_100\"\n+      value {\n+        entries {\n+          b: 2\n+          m: 256\n+          n: 2048\n+          k: 2048\n+          flops { key: \"bf16xbf16->bf16\" value: 789 }\n+          flops { key: \"f32xf32->f32\" value: 123 }\n+        }\n+      }\n+    }\n+  )pb\";\n+  GemmPerfTable old_perf_table;\n+  old_perf_table.ParseFromString(kGemmTableOld);\n+  GemmPerfTable new_perf_table;\n+  new_perf_table.ParseFromString(kGemmTableNew);\n+  GemmPerfTable expected_merged_perf_table;\n+  expected_merged_perf_table.ParseFromString(kGemmTableExpected);\n+  GemmPerfTable actual_merged_perf_table =\n+      MatmulPerfTableGen::Merge({old_perf_table, new_perf_table});\n+  EXPECT_THAT(expected_merged_perf_table,\n+              tsl::proto_testing::IgnoringRepeatedFieldOrdering(\n+                  tsl::proto_testing::EqualsProto(actual_merged_perf_table)));\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 130,
        "deletions": 1
    }
}