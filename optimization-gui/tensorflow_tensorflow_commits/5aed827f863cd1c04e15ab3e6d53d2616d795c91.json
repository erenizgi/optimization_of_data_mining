{
    "author": "tensorflower-gardener",
    "message": "Add atomic increment functionality to `KeyValueStore`.\n\nImplement `KeyValueStore::IncrementBy` to atomically increment a key's value, which is stored as a big-endian `int64_t`.\n\nPiperOrigin-RevId: 797998356",
    "sha": "5aed827f863cd1c04e15ab3e6d53d2616d795c91",
    "files": [
        {
            "sha": "b93bd3859ea01093cc06320ad69847365c82247d",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2FBUILD?ref=5aed827f863cd1c04e15ab3e6d53d2616d795c91",
            "patch": "@@ -221,6 +221,7 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/synchronization\",\n     ],"
        },
        {
            "sha": "fca0bb666fc73197126e9a6c5421fd396d94ba3e",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/key_value_store.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store.cc?ref=5aed827f863cd1c04e15ab3e6d53d2616d795c91",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/tsl/distributed_runtime/coordination/key_value_store.h\"\n \n+#include <cstdint>\n #include <optional>\n #include <string>\n #include <utility>\n@@ -23,7 +24,9 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/match.h\"\n+#include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n \n@@ -68,6 +71,19 @@ std::optional<std::string> KeyValueStore::Get(absl::string_view key) {\n   return it->second;\n }\n \n+absl::StatusOr<std::string> KeyValueStore::IncrementBy(absl::string_view key,\n+                                                       int64_t increment) {\n+  absl::MutexLock l(&mu_);\n+  auto [it, inserted] = data_.try_emplace(key, \"0\");\n+  int val;\n+  if (!absl::SimpleAtoi(it->second, &val)) {\n+    return absl::FailedPreconditionError(absl::StrFormat(\n+        \"Failed to parse value \\\"%s\\\" as an integer.\", it->second));\n+  }\n+  it->second = absl::StrCat(val + increment);\n+  return it->second;\n+}\n+\n std::vector<tensorflow::KeyValueEntry> KeyValueStore::GetPrefix(\n     absl::string_view prefix) {\n   absl::MutexLock l(&mu_);"
        },
        {
            "sha": "685c71eeba873214a89e3454866cf9c493e36606",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/key_value_store.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store.h?ref=5aed827f863cd1c04e15ab3e6d53d2616d795c91",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #ifndef XLA_TSL_DISTRIBUTED_RUNTIME_COORDINATION_KEY_VALUE_STORE_H_\n #define XLA_TSL_DISTRIBUTED_RUNTIME_COORDINATION_KEY_VALUE_STORE_H_\n \n+#include <cstdint>\n #include <optional>\n #include <string>\n #include <vector>\n@@ -55,6 +56,15 @@ class KeyValueStore {\n   // Returns the value associated with the provided key, if one exists.\n   std::optional<std::string> Get(absl::string_view key);\n \n+  // Increments the value associated with the provided key by the provided\n+  // increment. If the key does not exist, the value is initialized to 0. And\n+  // then incremented.\n+  //\n+  // The value string is interpreted as a big-endian 64-bit integer. An error is\n+  // returned if the value string is not exactly 8 bytes.\n+  absl::StatusOr<std::string> IncrementBy(absl::string_view key,\n+                                          int64_t increment);\n+\n   // Returns all key-value pairs where the key has the provided prefix.\n   //\n   // The empty string \"\" is a prefix of every key, so GetPrefix(\"\") can be used"
        },
        {
            "sha": "6adc11870241b991eb1ff97b2c54508840596213",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/key_value_store_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5aed827f863cd1c04e15ab3e6d53d2616d795c91/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fkey_value_store_test.cc?ref=5aed827f863cd1c04e15ab3e6d53d2616d795c91",
            "patch": "@@ -202,5 +202,34 @@ TEST(KeyValueStore, CallbacksCalledOnDestruction) {\n   EXPECT_TRUE(callback_called);\n }\n \n+TEST(KeyValueStore, IncrementByPositiveValueSucceeds) {\n+  KeyValueStore store;\n+  ASSERT_OK(store.Put(\"foo\", \"3\",\n+                      /*allow_overwrite=*/true));\n+  EXPECT_THAT(store.IncrementBy(\"foo\", 2), IsOkAndHolds(\"5\"));\n+}\n+\n+TEST(KeyValueStore, IncrementByNegativeValueSucceeds) {\n+  KeyValueStore store;\n+  ASSERT_OK(store.Put(\"foo\", \"3\",\n+                      /*allow_overwrite=*/true));\n+  // Result will be the two's complement of the positive value.\n+  EXPECT_THAT(store.IncrementBy(\"foo\", -5), IsOkAndHolds(\"-2\"));\n+}\n+\n+TEST(KeyValueStore, IncrementByWithoutExistingValueSucceeds) {\n+  // Result will be the increment value. This behavior is consistent with\n+  // other KV store implementations.\n+  KeyValueStore store;\n+  EXPECT_THAT(store.IncrementBy(\"foo\", 2), IsOkAndHolds(\"2\"));\n+}\n+\n+TEST(KeyValueStore, IncrementByWithInvalidValueFails) {\n+  KeyValueStore store;\n+  ASSERT_OK(store.Put(\"foo\", \"invalid\", /*allow_overwrite=*/true));\n+  EXPECT_THAT(store.IncrementBy(\"foo\", 2),\n+              StatusIs(absl::StatusCode::kFailedPrecondition));\n+}\n+\n }  // namespace\n }  // namespace tsl"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 56,
        "deletions": 0
    }
}