{
    "author": "tensorflower-gardener",
    "message": "Remove unnecessary thread setting calling from instruction_fusion. Also remove embedded computation execution thread exclusion since there are hlo pass verification depending on embedded call having execution thread explicit.\n\nPiperOrigin-RevId: 814384542",
    "sha": "81c95e9aa9edf779bd009bed970b32aeddf067d1",
    "files": [
        {
            "sha": "1e63c41a2acc12ac41d84d21b0e85e4ca3709b2b",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instruction.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instruction.cc?ref=81c95e9aa9edf779bd009bed970b32aeddf067d1",
            "patch": "@@ -5993,11 +5993,6 @@ void HloInstruction::set_async_execution_thread(\n \n void HloInstruction::set_called_computations_execution_thread(\n     absl::string_view async_execution_thread) {\n-  if (GetInstructionCallContext(this->opcode()) == CallContext::kEmbedded) {\n-    // There is no need to set the thread name for embedded computations\n-    // recursively, because they cannot be executed asynchronously.\n-    return;\n-  }\n   Cast<HloCallableInstruction>(this)->RecursivelySetComputationsThreadName(\n       async_execution_thread);\n }"
        },
        {
            "sha": "2b61b69b7079ce02df510396211857a344d37df2",
            "filename": "third_party/xla/xla/service/hlo_instruction_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_instruction_test.cc?ref=81c95e9aa9edf779bd009bed970b32aeddf067d1",
            "patch": "@@ -2183,7 +2183,7 @@ TEST_F(HloInstructionTest, CanonicalStringificationFusion) {\n   tmp_1 = f32[20,10]{1,0} parameter(1)\n   tmp_2 = f32[10,20]{1,0} transpose(f32[20,10]{1,0} tmp_1), dimensions={1,0}\n   ROOT tmp_3 = f32[5,20]{1,0} dot(f32[5,10]{1,0} tmp_0, f32[10,20]{1,0} tmp_2), lhs_contracting_dims={1}, rhs_contracting_dims={0}\n-})\";\n+}, execution_thread=\"parallel_thread\")\";\n   EXPECT_EQ(fusion->ToString(options), expected_fusion);\n }\n "
        },
        {
            "sha": "d1179f2df8e16319fe6c882f0e096793e03d53a5",
            "filename": "third_party/xla/xla/service/hlo_verifier.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc?ref=81c95e9aa9edf779bd009bed970b32aeddf067d1",
            "patch": "@@ -1720,13 +1720,10 @@ absl::Status CheckCallableInstructionThreadName(\n     const HloInstruction* instruction) {\n   for (const HloComputation* computation : instruction->called_computations()) {\n     if (instruction->parent() != nullptr) {\n-      if (xla::GetInstructionCallContext(instruction->opcode()) !=\n-              CallContext::kEmbedded &&\n-          instruction->parent()->execution_thread() !=\n-              computation->execution_thread()) {\n+      if (instruction->parent()->execution_thread() !=\n+          computation->execution_thread()) {\n         return Internal(\n-            \"Non-Embedded context callable instruction %s expects parent \"\n-            \"computation thread name \"\n+            \"Callable instruction %s expects parent computation thread name \"\n             \"same as called computation's thread name (%s vs %s).\",\n             instruction->ToString(), instruction->parent()->execution_thread(),\n             computation->execution_thread());\n@@ -3747,13 +3744,10 @@ absl::Status InstructionVerifier::Preprocess(HloInstruction* instruction) {\n \n   if (opts_.verify_call_nested_computation_thread_name &&\n       instruction->has_to_apply() &&\n-      xla::GetInstructionCallContext(instruction->opcode()) !=\n-          xla::CallContext::kEmbedded &&\n       instruction->to_apply()->execution_thread() !=\n           instruction->parent()->execution_thread()) {\n     return Internal(\n-        \"Non-Embedded context callable instruction %s to_apply computation \"\n-        \"execution thread does not match (%s vs %s)\",\n+        \"%s to_apply computation execution thread does not match (%s vs %s)\",\n         instruction->name(), instruction->to_apply()->execution_thread(),\n         instruction->parent()->execution_thread());\n   }"
        },
        {
            "sha": "0ff83918022cf52e86a0683355de5207b8a13a75",
            "filename": "third_party/xla/xla/service/hlo_verifier_test.cc",
            "status": "modified",
            "additions": 48,
            "deletions": 11,
            "changes": 59,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc?ref=81c95e9aa9edf779bd009bed970b32aeddf067d1",
            "patch": "@@ -219,8 +219,7 @@ TEST_F(HloVerifierTest, CheckCallThreadMismatch) {\n           .status();\n   ASSERT_FALSE(status.ok());\n   EXPECT_THAT(status.message(),\n-              HasSubstr(\"Non-Embedded context callable instruction mycall \"\n-                        \"to_apply computation execution thread does not match \"\n+              HasSubstr(\"to_apply computation execution thread does not match \"\n                         \"(parallel_thread vs main)\"));\n }\n \n@@ -2303,27 +2302,62 @@ TEST_F(HloVerifierTest, FusionShapeVerifier) {\n               HasSubstr(\"Fused computation shape\"));\n }\n \n-TEST_F(HloVerifierTest, CallThreadVerifier) {\n+TEST_F(HloVerifierTest, FusionThreadVerifier) {\n   const char* const kModuleStr = R\"(\n   HloModule test\n \n-  called_computation {\n+  fused_computation {\n     ROOT p0 = f32[8,12] parameter(0)\n   }, execution_thread=\"parallel_thread\"\n \n   ENTRY entry {\n     p0 = f32[8,12] parameter(0)\n-    ROOT out = f32[8,12] call(p0), to_apply=called_computation\n+    ROOT out = f32[8,12] fusion(p0), kind=kInput, calls=fused_computation\n   }\n   )\";\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnUnverifiedModule(kModuleStr));\n-  EXPECT_THAT(\n+  EXPECT_THAT(verifier().Run(module.get()).status().message(),\n+              HasSubstr(\"expects parent computation thread name same as called \"\n+                        \"computation's thread name\"));\n+}\n+\n+TEST_F(HloVerifierTest, FusionNestedComputationThreadVerifier) {\n+  const char* const kModuleStr = R\"(\n+  HloModule test\n+\n+  add {\n+    lhs = f32[] parameter(0)\n+    rhs = f32[] parameter(1)\n+    ROOT add = f32[] add(lhs, rhs)\n+  }, execution_thread=\"parallel_thread\"\n+\n+  fused_computation {\n+    p0 = f32[8,12] parameter(0)\n+    p1 = f32[8,12] parameter(1)\n+    crs0 = f32[8,12] all-reduce(p1), replica_groups={}, to_apply=add\n+    ROOT result = add(p0, crs0)\n+  }\n+\n+  ENTRY entry {\n+    p0 = f32[8,12] parameter(0)\n+    p1 = f32[8,12] parameter(1)\n+    ROOT out = f32[8,12] fusion(p0, p1), kind=kInput, calls=fused_computation\n+  }\n+  )\";\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnUnverifiedModule(kModuleStr));\n+\n+  absl::Status status =\n       HloVerifier{HloVerifierOpts{}.VerifyCallNestedComputationThreadName()}\n           .Run(module.get())\n-          .status()\n-          .message(),\n-      HasSubstr(\"to_apply computation execution thread does not match\"));\n+          .status();\n+\n+  ASSERT_FALSE(status.ok());\n+  EXPECT_THAT(\n+      status.message(),\n+      HasSubstr(\"crs0 to_apply computation execution thread does not match \"\n+                \"(parallel_thread vs main)\"));\n }\n \n TEST_F(HloVerifierTest, AllReduceVerifier) {\n@@ -3057,8 +3091,11 @@ TEST_F(HloVerifierTest, VerifyCustomCallThread) {\n       HloVerifier{HloVerifierOpts{}.VerifyCallNestedComputationThreadName()}\n           .Run(module.get())\n           .status();\n-  // Embedded call context computation thread name is not checked.\n-  ASSERT_TRUE(status.ok());\n+\n+  ASSERT_FALSE(status.ok());\n+  EXPECT_THAT(status.message(),\n+              HasSubstr(\"custom to_apply computation execution thread does \"\n+                        \"not match (parallel_thread vs main)\"));\n }\n \n TEST_F(HloVerifierTest, CheckWhileThread) {"
        },
        {
            "sha": "f1a3b90f1f255eeee8d1c81eb0274aa9daa8c239",
            "filename": "third_party/xla/xla/service/instruction_fusion.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/81c95e9aa9edf779bd009bed970b32aeddf067d1/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Finstruction_fusion.cc?ref=81c95e9aa9edf779bd009bed970b32aeddf067d1",
            "patch": "@@ -801,8 +801,6 @@ HloInstruction* InstructionFusion::AddFusionInstruction(\n     // fusions.\n     TF_CHECK_OK(computation->ReplaceInstruction(consumer, fusion_instruction));\n   }\n-  fusion_instruction->set_called_computations_execution_thread(\n-      computation->execution_thread());\n   return fusion_instruction;\n }\n "
        }
    ],
    "stats": {
        "total": 82,
        "additions": 53,
        "deletions": 29
    }
}