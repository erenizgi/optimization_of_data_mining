{
    "author": "alekstheod",
    "message": "PR #33909: [ROCm] Make multi gpu tests exclusive if executed locally\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33909\n\nüìù Summary of Changes\nMake multigpu tests being executed exclusively.\n\nüéØ Justification\nMultigpu tests have to run exclusively to not clash the utilization of gpus in parallel.\nThis PR marks multigpu tests as such by adding 'multi_gpu' tag, and in case of rocm\nmake them run exclusively if executed locally.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply:  ‚ôªÔ∏è Cleanup\n\nüìä Benchmark (for Performance Improvements)\nNot relevant, no logic change\n\nüß™ Unit Tests:\nNot relevant, no logic change\n\nüß™ Execution Tests:\nNot relevant, no logic change\n\nCopybara import of the project:\n\n--\n7e84a78daffc36a5b6dcd66515a54d7ac0dee39d by Alexandros Theodoridis <atheodor@amd.com>:\n\nMark multigpu tests as such, make them exclusive if executed locally\n\n--\n23fc24cbf2fb03e3a30fe6a1749c7e0f22b690d7 by Alexandros Theodoridis <atheodor@amd.com>:\n\nRemove invalid multi_gpu tag from cpu tests\n\n--\na2a35de6faffebdf8a570b560c7108d9073a2908 by Alexandros Theodoridis <atheodor@amd.com>:\n\nRestore build_config not exposing has_tag\n\n--\nbabe5c7852716e87411a4c0e9d2f1af7f1510b7e by Alexandros Theodoridis <atheodor@amd.com>:\n\nUnmark test which is not multigpu\n\n--\n3e30cf6b1d3ca5a0569e4a6ab140cb942cc06452 by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd missing tag documentation\n\nMerging this change closes #33909\n\nPiperOrigin-RevId: 836288457",
    "sha": "2e00293113d1d5b9359d2a4c8d874c8095626a13",
    "files": [
        {
            "sha": "d0d226d5e0d166c02857d38cf67de42b9333b84a",
            "filename": "third_party/xla/build_tools/lint/tags.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e00293113d1d5b9359d2a4c8d874c8095626a13/third_party%2Fxla%2Fbuild_tools%2Flint%2Ftags.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e00293113d1d5b9359d2a4c8d874c8095626a13/third_party%2Fxla%2Fbuild_tools%2Flint%2Ftags.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Flint%2Ftags.py?ref=2e00293113d1d5b9359d2a4c8d874c8095626a13",
            "patch": "@@ -29,6 +29,7 @@\n     # Tags that Bazel recognizes\n     \"local\": \"https://bazel.build/reference/be/common-definitions\",\n     \"manual\": \"https://bazel.build/reference/be/common-definitions\",\n+    \"exclusive-if-local\": \"https://bazel.build/reference/be/common-definitions\",\n     \"large\": \"Conventional tag for `test_suites` of large tests\",\n     \"__PYTHON_RULES_MIGRATION_DO_NOT_USE_WILL_BREAK__\": \"Internal bazel tag\",\n     # Various disable tags (currently recognized by OpenXLA CI)"
        },
        {
            "sha": "d49ced7c465e800ba6d0da70a02876f7c2f949b7",
            "filename": "third_party/xla/third_party/gpus/rocm/build_defs.bzl.tpl",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e00293113d1d5b9359d2a4c8d874c8095626a13/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Fbuild_defs.bzl.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e00293113d1d5b9359d2a4c8d874c8095626a13/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Fbuild_defs.bzl.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Fbuild_defs.bzl.tpl?ref=2e00293113d1d5b9359d2a4c8d874c8095626a13",
            "patch": "@@ -60,9 +60,7 @@ def if_rocm_is_configured(if_true, if_false = []):\n     Unlike if_rocm(), this does not require that we are building with\n     --config=rocm. Used to allow non-ROCm code to depend on ROCm libraries.\n     \"\"\"\n-    if %{rocm_is_configured}:\n-      return select({\"//conditions:default\": if_true})\n-    return select({\"//conditions:default\": if_false})\n+    return if_true if %{rocm_is_configured} else if_false\n \n def is_rocm_configured():\n     \"\"\""
        },
        {
            "sha": "9266526a250827831d6c2dabe465827595783024",
            "filename": "third_party/xla/xla/tests/build_defs.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e00293113d1d5b9359d2a4c8d874c8095626a13/third_party%2Fxla%2Fxla%2Ftests%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e00293113d1d5b9359d2a4c8d874c8095626a13/third_party%2Fxla%2Fxla%2Ftests%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fbuild_defs.bzl?ref=2e00293113d1d5b9359d2a4c8d874c8095626a13",
            "patch": "@@ -374,6 +374,8 @@ def xla_test(\n                 ]\n             if backend in AMD_GPU_DEFAULT_BACKENDS:\n                 this_backend_tags.append(\"gpu\")\n+                if \"multi_gpu\" in this_backend_tags:\n+                    this_backend_tags.append(\"exclusive-if-local\")\n                 backend_deps += [\n                     \"//xla/stream_executor/rocm:all_runtime\",\n                     \"//xla/stream_executor/rocm:gpu_test_kernels_rocm\","
        }
    ],
    "stats": {
        "total": 7,
        "additions": 4,
        "deletions": 3
    }
}