{
    "author": "shawnwang18",
    "message": "PR #34316: [XLA:GPU] Add debug code to profile command buffer's memory types\n\nImported from GitHub PR https://github.com/openxla/xla/pull/34316\n\nüìù Summary of Changes\nThis PR add debug code to profile command buffer's memory allocation types.\n\nüéØ Justification\nWe want to profile the memory allocations types for a command buffer, so to understand which types of memory are consumed by command buffer, with that we can have data on improving the persistent of memory allocations.\n\nüöÄ Kind of Contribution\nüìö Documentation\n\nCopybara import of the project:\n\n--\na95e67dd77639853d3251df4e809b97a0b3d0e17 by Shawn Wang <shawnw@nvidia.com>:\n\nAdd debug code to profile command buffer's memory types\n\nMerging this change closes #34316\n\nPiperOrigin-RevId: 836283806",
    "sha": "75f7de78fa7984503f9f3ed715e1878cb473aad2",
    "files": [
        {
            "sha": "0b65e7b5927cdde3af375480dfa4fec68fb8340c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/command_buffer_cmd.cc",
            "status": "modified",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/75f7de78fa7984503f9f3ed715e1878cb473aad2/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/75f7de78fa7984503f9f3ed715e1878cb473aad2/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc?ref=75f7de78fa7984503f9f3ed715e1878cb473aad2",
            "patch": "@@ -491,6 +491,60 @@ absl::Status CommandBufferCmdExecutor::Record(\n   } else {\n     auto* create = std::get_if<CommandBufferCmd::RecordCreate>(&record_action);\n     CHECK(create);\n+\n+    if (VLOG_IS_ON(5) &&\n+        command_buffer->mode() == se::CommandBuffer::Mode::kPrimary) {\n+      int64_t input_count = 0;\n+      int64_t output_count = 0;\n+      int64_t input_temp_count = 0;\n+      int64_t output_temp_count = 0;\n+      int64_t input_output_count = 0;\n+      int64_t input_temp_output_count = 0;\n+\n+      for (const auto& cmd : commands_) {\n+        bool has_input = false;\n+        bool has_output = false;\n+        bool has_temp = false;\n+\n+        for (const auto& buffer : cmd->buffers()) {\n+          if (buffer.HasDefinedContentsOnInput()) {\n+            has_input = true;\n+          }\n+          if (buffer.HasDefinedContentsOnOutput()) {\n+            has_output = true;\n+          }\n+          if (!buffer.HasDefinedContentsOnInput() &&\n+              !buffer.HasDefinedContentsOnOutput()) {\n+            has_temp = true;\n+          }\n+        }\n+\n+        if (has_input && !has_output && !has_temp) input_count++;\n+        if (!has_input && has_output && !has_temp) output_count++;\n+        if (has_input && !has_output && has_temp) input_temp_count++;\n+        if (!has_input && has_output && has_temp) output_temp_count++;\n+        if (has_input && has_output && !has_temp) input_output_count++;\n+        if (has_input && has_output && has_temp) input_temp_output_count++;\n+      }\n+\n+      VLOG(5) << \"CommandBufferCmdExecutor allocation summary:\\n\"\n+              << \"  Total commands                                 : \"\n+              << commands_.size() << \"\\n\"\n+              << \"  ------------------------------------------------\\n\"\n+              << \"  Commands consuming input buffer                : \"\n+              << input_count << \"\\n\"\n+              << \"  Commands consuming output buffer               : \"\n+              << output_count << \"\\n\"\n+              << \"  Commands consuming input, temp buffers         : \"\n+              << input_temp_count << \"\\n\"\n+              << \"  Commands consuming output, temp buffers        : \"\n+              << output_temp_count << \"\\n\"\n+              << \"  Commands consuming input, output buffers       : \"\n+              << input_output_count << \"\\n\"\n+              << \"  Commands consuming input, temp, output buffers : \"\n+              << input_temp_output_count;\n+    }\n+\n     TF_RETURN_IF_ERROR(RecordCreate(execute_params, record_params,\n                                     command_buffer, create->dependencies)\n                            .status());"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 54,
        "deletions": 0
    }
}