{
    "author": "ezhulenev",
    "message": "[xla:cpu] Remove runtime_topk target\n\nPiperOrigin-RevId: 833014983",
    "sha": "389512473e0f9b6e9322ab5a128a265ef024a86e",
    "files": [
        {
            "sha": "783dc69b6ad5c22970c99e2082c82df27199c23a",
            "filename": "tensorflow/compiler/aot/codegen.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/tensorflow%2Fcompiler%2Faot%2Fcodegen.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/tensorflow%2Fcompiler%2Faot%2Fcodegen.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Faot%2Fcodegen.cc?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -708,7 +708,7 @@ absl::Status ExtendRewrites(\n   if (HasThunkKind(aot_thunks->proto().thunk_sequence(),\n                    xla::cpu::ThunkProto::kTopKThunk)) {\n     runtime_specific_includes.push_back(\n-        R\"(#include \"xla/service/cpu/runtime_topk.h\")\");\n+        R\"(#include \"xla/backends/cpu/runtime/topk_lib.h\")\");\n   }\n \n   TF_ASSIGN_OR_RETURN("
        },
        {
            "sha": "e2509d653974e744cbe42e6161e2efc87094f13a",
            "filename": "tensorflow/compiler/aot/tfcompile.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/tensorflow%2Fcompiler%2Faot%2Ftfcompile.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/tensorflow%2Fcompiler%2Faot%2Ftfcompile.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Faot%2Ftfcompile.bzl?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -337,9 +337,9 @@ def _tf_library(\n             # TODO(cwhipkey): only depend on kernel code that the model actually\n             # needed.\n             \"@local_xla//xla/backends/cpu/runtime:sort_lib\",\n+            \"@local_xla//xla/backends/cpu/runtime:topk_lib\",\n             \"@local_xla//xla/service/cpu:runtime_conv2d\",\n             \"@local_xla//xla/service/cpu:runtime_matmul\",\n-            \"@local_xla//xla/service/cpu:runtime_topk\",\n             \"@local_xla//xla/service/cpu:runtime_single_threaded_conv2d\",\n             \"@local_xla//xla/service/cpu:runtime_single_threaded_matmul\",\n             \"@eigen_archive//:eigen3\","
        },
        {
            "sha": "0c4edc85f99d1981478fe4a53d78cda3b8b31815",
            "filename": "tensorflow/compiler/aot/thunk_proto_execution_deserializer.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/tensorflow%2Fcompiler%2Faot%2Fthunk_proto_execution_deserializer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/tensorflow%2Fcompiler%2Faot%2Fthunk_proto_execution_deserializer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Faot%2Fthunk_proto_execution_deserializer.cc?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -688,7 +688,7 @@ ThunkProtoExecutionDeserializer::GetTopKThunkRunImpl(\n   absl::string_view topk_thunk_invocation_format = R\"(\n      // TopK Thunk\n      {\n-    __xla_cpu_runtime_TopKF32({{BATCH_SIZE}}, {{INPUT_SIZE}}, {{K}},\n+    ::xla::cpu::internal::TopK({{BATCH_SIZE}}, {{INPUT_SIZE}}, {{K}},\n                               reinterpret_cast<const float*>({{VALUES_PTR}}),\n                               reinterpret_cast<float*>({{OUTPUT_PTR}}),\n                               reinterpret_cast<int32_t*>({{INDICES_PTR}}));"
        },
        {
            "sha": "b2ce6300faba432f1eb624be80e495b0a9e214a3",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -1171,18 +1171,29 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"topk_lib\",\n+    hdrs = [\"topk_lib.h\"],\n+    deps = [\n+        \"@com_google_absl//absl/base\",\n+        \"@com_google_absl//absl/base:dynamic_annotations\",\n+        \"@com_google_absl//absl/numeric:bits\",\n+    ],\n+)\n+\n cc_library(\n     name = \"topk_thunk\",\n     srcs = [\"topk_thunk.cc\"],\n     hdrs = [\"topk_thunk.h\"],\n     deps = [\n         \":thunk\",\n+        \":topk_lib\",\n         \"//xla/runtime:buffer_use\",\n         \"//xla/service:buffer_assignment\",\n-        \"//xla/service/cpu:runtime_topk\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/tsl/concurrency:async_value\",\n         \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/base:dynamic_annotations\",\n         \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status:statusor\",\n     ],"
        },
        {
            "sha": "f26043de1b5e87501c2254c98469418b43de4979",
            "filename": "third_party/xla/xla/backends/cpu/runtime/topk_lib.h",
            "status": "renamed",
            "additions": 15,
            "deletions": 15,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ftopk_lib.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ftopk_lib.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ftopk_lib.h?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -1,4 +1,4 @@\n-/* Copyright 2020 The OpenXLA Authors.\n+/* Copyright 2025 The OpenXLA Authors.\n \n Licensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\n@@ -13,27 +13,29 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/service/cpu/runtime_topk.h\"\n+#ifndef XLA_BACKENDS_CPU_RUNTIME_TOPK_LIB_H_\n+#define XLA_BACKENDS_CPU_RUNTIME_TOPK_LIB_H_\n \n #include <algorithm>\n+#include <cstddef>\n #include <cstdint>\n-#include <cstring>\n #include <limits>\n #include <numeric>\n #include <vector>\n \n-#include \"absl/base/attributes.h\"\n #include \"absl/base/casts.h\"\n #include \"absl/base/dynamic_annotations.h\"\n \n+namespace xla::cpu::internal {\n+\n template <typename T>\n-static void TopK(int64_t batch_size, int64_t input_size, int64_t k,\n-                 const T* values, T* out_values, int32_t* out_indices) {\n-  // 'values' is managed by the JIT code, so msan can't tell they are\n-  // initialized.\n+void TopK(int64_t batch_size, int64_t input_size, int64_t k, const T* values,\n+          T* out_values, int32_t* out_indices) {\n+  // values is managed by the JIT code, so msan can't tell they are initialized.\n   ABSL_ANNOTATE_MEMORY_IS_INITIALIZED(values,\n                                       input_size * batch_size * sizeof(T));\n-  static constexpr auto convert_to_int = [](T value) {\n+\n+  auto convert_to_int = [](T value) {\n     uint32_t x = absl::bit_cast<uint32_t>(value);\n     return static_cast<int32_t>(x) < 0 ? std::numeric_limits<int32_t>::max() - x\n                                        : x;\n@@ -47,7 +49,7 @@ static void TopK(int64_t batch_size, int64_t input_size, int64_t k,\n \n     auto kth_element = temp_indices.begin() + k;\n     std::partial_sort(temp_indices.begin(), kth_element, temp_indices.end(),\n-                      [values_batch](size_t i1, size_t i2) {\n+                      [&](size_t i1, size_t i2) {\n                         // Do the comparison in integers to enforce a total\n                         // order of -NaN < -Inf < -0 < +0 < +Inf < +NaN.\n                         int32_t v1 = convert_to_int(values_batch[i1]);\n@@ -67,8 +69,6 @@ static void TopK(int64_t batch_size, int64_t input_size, int64_t k,\n   }\n }\n \n-ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_TopKF32(\n-    int64_t batch_size, int64_t input_size, int64_t k, const float* values,\n-    float* out_values, int32_t* out_indices) {\n-  TopK(batch_size, input_size, k, values, out_values, out_indices);\n-}\n+}  // namespace xla::cpu::internal\n+\n+#endif  // XLA_BACKENDS_CPU_RUNTIME_TOPK_LIB_H_",
            "previous_filename": "third_party/xla/xla/service/cpu/runtime_topk.cc"
        },
        {
            "sha": "cc473b82459879e02fb92923193bb970836ddae4",
            "filename": "third_party/xla/xla/backends/cpu/runtime/topk_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ftopk_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ftopk_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ftopk_thunk.cc?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -22,8 +22,8 @@ limitations under the License.\n #include \"absl/memory/memory.h\"\n #include \"absl/status/statusor.h\"\n #include \"xla/backends/cpu/runtime/thunk.h\"\n+#include \"xla/backends/cpu/runtime/topk_lib.h\"\n #include \"xla/service/buffer_assignment.h\"\n-#include \"xla/service/cpu/runtime_topk.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -62,10 +62,11 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> TopKThunk::Execute(\n       se::DeviceMemoryBase indices,\n       params.buffer_allocations->GetDeviceAddress(indices_buffer_));\n \n-  __xla_cpu_runtime_TopKF32(batch_size_, input_size_, k_,\n-                            reinterpret_cast<const float*>(values.opaque()),\n-                            reinterpret_cast<float*>(output.opaque()),\n-                            reinterpret_cast<int32_t*>(indices.opaque()));\n+  internal::TopK<float>(batch_size_, input_size_, k_,\n+                        static_cast<const float*>(values.opaque()),\n+                        static_cast<float*>(output.opaque()),\n+                        static_cast<int32_t*>(indices.opaque()));\n+\n   return OkExecuteEvent();\n }\n "
        },
        {
            "sha": "cb7aa7635fd4aa674910cec7dd166ba93c0b5b73",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/389512473e0f9b6e9322ab5a128a265ef024a86e/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=389512473e0f9b6e9322ab5a128a265ef024a86e",
            "patch": "@@ -63,7 +63,6 @@ filegroup(\n         \"runtime_single_threaded_matmul_f64.cc\",\n         \"runtime_single_threaded_matmul_s32.cc\",\n         \"runtime_single_threaded_matmul_u8.cc\",\n-        \"runtime_topk.cc\",\n         # Multi-threaded support.\n         \"runtime_conv2d.cc\",\n         \"runtime_conv3d.cc\",\n@@ -86,7 +85,6 @@ filegroup(\n         \"runtime_single_threaded_conv2d.h\",\n         \"runtime_single_threaded_conv3d.h\",\n         \"runtime_single_threaded_matmul.h\",\n-        \"runtime_topk.h\",\n         # Multi-threaded support.\n         \"runtime_conv2d.h\",\n         \"runtime_conv3d.h\",\n@@ -1187,19 +1185,6 @@ cc_library(\n     visibility = [\"//visibility:public\"],\n )\n \n-cc_library(\n-    name = \"runtime_topk\",\n-    srcs = [\"runtime_topk.cc\"],\n-    hdrs = [\"runtime_topk.h\"],\n-    copts = runtime_copts(),\n-    visibility = [\"//visibility:public\"],\n-    deps = [\n-        \"@com_google_absl//absl/base\",\n-        \"@com_google_absl//absl/base:core_headers\",\n-        \"@com_google_absl//absl/base:dynamic_annotations\",\n-    ],\n-)\n-\n xla_cc_test(\n     name = \"cpu_instruction_fusion_test\",\n     srcs = [\"cpu_instruction_fusion_test.cc\"],"
        },
        {
            "sha": "13e922d16401cd62332dadb33fe7629b96c0c127",
            "filename": "third_party/xla/xla/service/cpu/runtime_topk.h",
            "status": "removed",
            "additions": 0,
            "deletions": 30,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1684fbeb6db0254ab81d76caf7de07d759c59056/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_topk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1684fbeb6db0254ab81d76caf7de07d759c59056/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_topk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_topk.h?ref=1684fbeb6db0254ab81d76caf7de07d759c59056",
            "patch": "@@ -1,30 +0,0 @@\n-/* Copyright 2020 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#ifndef XLA_SERVICE_CPU_RUNTIME_TOPK_H_\n-#define XLA_SERVICE_CPU_RUNTIME_TOPK_H_\n-\n-#include <stdint.h>\n-\n-extern \"C\" {\n-\n-// Calculates `batch_size` topk operations with `input_size` inputs each. The\n-// outputs are written to `out_values` and `out_indices`.\n-extern void __xla_cpu_runtime_TopKF32(int64_t batch_size, int64_t input_size,\n-                                      int64_t k, const float* values,\n-                                      float* out_values, int32_t* out_indices);\n-}\n-\n-#endif  // XLA_SERVICE_CPU_RUNTIME_TOPK_H_"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 36,
        "deletions": 69
    }
}