{
    "author": "pschuh",
    "message": "This code can race with the new Reset() code.\n\nPiperOrigin-RevId: 831934135",
    "sha": "42b1074d260b507f051cc58ccb6dba0b07ba3400",
    "files": [
        {
            "sha": "7a88aa12c6daa85f09331b387cc14391ce8958de",
            "filename": "third_party/xla/xla/python/transfer/streaming.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/42b1074d260b507f051cc58ccb6dba0b07ba3400/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/42b1074d260b507f051cc58ccb6dba0b07ba3400/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming.cc?ref=42b1074d260b507f051cc58ccb6dba0b07ba3400",
            "patch": "@@ -322,7 +322,9 @@ void PullTable::Handle(tsl::RCReference<ConnectionState> state,\n   if (entry->Handle(std::move(state), req, base_req_id)) {\n     absl::MutexLock l(mu_);\n     auto it = entries_.find(req.uuid());\n-    entries_.erase(it);\n+    if (it != entries_.end()) {\n+      entries_.erase(it);\n+    }\n   }\n }\n "
        },
        {
            "sha": "af7988e3a264872c178bc53cd43567716f5a9f4d",
            "filename": "third_party/xla/xla/python/transfer/streaming_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/42b1074d260b507f051cc58ccb6dba0b07ba3400/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/42b1074d260b507f051cc58ccb6dba0b07ba3400/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Ftransfer%2Fstreaming_test.cc?ref=42b1074d260b507f051cc58ccb6dba0b07ba3400",
            "patch": "@@ -242,5 +242,29 @@ TEST(InvalidAllocator, InvalidAlignedAlloc) {\n   ASSERT_FALSE(alloc2_or.ok());\n }\n \n+class SelfResettingPullTableEntry : public PullTable::Entry {\n+ public:\n+  explicit SelfResettingPullTableEntry(std::shared_ptr<PullTable> table)\n+      : table_(std::move(table)) {}\n+\n+  bool Handle(tsl::RCReference<ConnectionState> state,\n+              const SocketTransferPullRequest& req,\n+              size_t base_req_id) override {\n+    table_->Reset();\n+    return true;\n+  }\n+\n+ private:\n+  std::shared_ptr<PullTable> table_;\n+};\n+\n+TEST(PullTable, PullTableRace) {\n+  auto table = std::make_shared<PullTable>();\n+  table->AwaitPull(6, tsl::MakeRef<SelfResettingPullTableEntry>(table));\n+  SocketTransferPullRequest req;\n+  req.set_uuid(6);\n+  table->Handle({}, req, 0);\n+}\n+\n }  // namespace\n }  // namespace aux"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 27,
        "deletions": 1
    }
}