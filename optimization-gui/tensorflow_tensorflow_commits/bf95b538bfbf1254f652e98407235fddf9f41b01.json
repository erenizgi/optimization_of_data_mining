{
    "author": "beckerhe",
    "message": "Make filecheck prefixes a parameter.\n\n`CHECK-PTX` and `CHECK-GCN` have been considered valid prefixes only if the build is configured as a ROCM or a CUDA build. This change makes this a parameter to the RunFilecheck functions and allows individual tests to decide which prefixes they wanna use.\n\nPiperOrigin-RevId: 846637426",
    "sha": "bf95b538bfbf1254f652e98407235fddf9f41b01",
    "files": [
        {
            "sha": "afd25005125febe62fe599703008e90c96d3c98f",
            "filename": "third_party/xla/xla/hlo/testlib/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 11,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2FBUILD?ref=bf95b538bfbf1254f652e98407235fddf9f41b01",
            "patch": "@@ -1,17 +1,9 @@\n # Description:\n #   Base testing infrastructure for XLA.\n \n-load(\n-    \"@local_config_rocm//rocm:build_defs.bzl\",\n-    \"if_rocm_is_configured\",\n-)\n load(\"//xla/tsl:tsl.bzl\", \"internal_visibility\")\n load(\"//xla/tsl:tsl.default.bzl\", \"filegroup\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n-load(\n-    \"//xla/tsl/platform/default:cuda_build_defs.bzl\",\n-    \"if_cuda_is_configured\",\n-)\n \n package(\n     # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n@@ -65,7 +57,6 @@ cc_library(\n         \"//xla:xla_data_proto_cc\",\n         \"//xla:xla_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n-        \"//xla/hlo/ir:hlo_module_group\",\n         \"//xla/hlo/parser:hlo_parser\",\n         \"//xla/hlo/pass:hlo_pass\",\n         \"//xla/hlo/utils:hlo_query\",\n@@ -99,17 +90,17 @@ cc_library(\n     data = [\n         \"@llvm-project//llvm:FileCheck\",\n     ],\n-    local_defines = if_cuda_is_configured([\"GOOGLE_CUDA=1\"]) + if_rocm_is_configured([\"TENSORFLOW_USE_ROCM=1\"]),\n     deps = [\n-        \"//xla:types\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:resource_loader\",\n         \"//xla/tsl/platform:subprocess\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_absl//absl/types:span\",\n         \"@local_tsl//tsl/platform\",\n         \"@local_tsl//tsl/platform:path\",\n     ],"
        },
        {
            "sha": "7f351633f231df23e56cbc765b1cf3ba5f80a4e9",
            "filename": "third_party/xla/xla/hlo/testlib/filecheck.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 18,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.cc?ref=bf95b538bfbf1254f652e98407235fddf9f41b01",
            "patch": "@@ -20,7 +20,9 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/resource_loader.h\"\n@@ -30,8 +32,9 @@ limitations under the License.\n \n namespace xla {\n \n-absl::StatusOr<bool> RunFileCheck(const std::string& input,\n-                                  absl::string_view pattern) {\n+absl::StatusOr<bool> RunFileCheck(\n+    const std::string& input, absl::string_view pattern,\n+    absl::Span<const absl::string_view> additional_check_prefixes) {\n   // Generate an input file for the FileCheck pattern.\n   std::string pattern_path;\n   auto env = tsl::Env::Default();\n@@ -40,11 +43,13 @@ absl::StatusOr<bool> RunFileCheck(const std::string& input,\n   }\n   TF_RETURN_IF_ERROR(tsl::WriteStringToFile(env, pattern_path, pattern));\n   VLOG(3) << \"input: \" << input;\n-  return RunFileCheckWithPatternFile(input, pattern_path);\n+  return RunFileCheckWithPatternFile(input, pattern_path,\n+                                     additional_check_prefixes);\n }\n \n absl::StatusOr<bool> RunFileCheckWithPatternFile(\n-    const std::string& input, const std::string& pattern_file) {\n+    const std::string& input, const std::string& pattern_file,\n+    absl::Span<const absl::string_view> additional_check_prefixes) {\n   // Invoke FileCheck to check whether input matches `pattern`.\n   std::string binary_name = \"FileCheck\";\n   tsl::io::AppendDotExeIfWindows(binary_name);\n@@ -53,24 +58,16 @@ absl::StatusOr<bool> RunFileCheckWithPatternFile(\n           ? tsl::io::JoinPath(\"external\", \"llvm-project\", \"llvm\", binary_name)\n           : tsl::io::JoinPath(\"llvm\", \"llvm-project\", \"llvm\", binary_name));\n \n+  std::string check_prefixes = \"--check-prefixes=CHECK\";\n+  for (const absl::string_view& prefix : additional_check_prefixes) {\n+    absl::StrAppend(&check_prefixes, \",\", prefix);\n+  }\n+\n   tsl::SubProcess file_check_process;\n-#if GOOGLE_CUDA || TENSORFLOW_USE_ROCM\n-  std::string file_check_prefixes;\n-#if GOOGLE_CUDA\n-  file_check_prefixes = \"--check-prefixes=CHECK,CHECK-PTX\";\n-#endif  // GOOGLE_CUDA\n-#if TENSORFLOW_USE_ROCM\n-  file_check_prefixes = \"--check-prefixes=CHECK,CHECK-GCN\";\n-#endif  // TENSORFLOW_USE_ROCM\n   file_check_process.SetProgram(\n       file_check_path,\n       {file_check_path, \"-v\", \"-dump-input=fail\", \"--dump-input-filter=all\",\n-       file_check_prefixes, \"--allow-unused-prefixes\", pattern_file});\n-#else  // !(GOOGLE_CUDA || TENSORFLOW_USE_ROCM)\n-  file_check_process.SetProgram(file_check_path,\n-                                {file_check_path, \"-v\", \"-dump-input=fail\",\n-                                 \"--dump-input-filter=all\", pattern_file});\n-#endif\n+       check_prefixes, \"--allow-unused-prefixes\", pattern_file});\n   file_check_process.SetChannelAction(tsl::CHAN_STDIN, tsl::ACTION_PIPE);\n   file_check_process.SetChannelAction(tsl::CHAN_STDERR, tsl::ACTION_PIPE);\n   if (!file_check_process.Start()) {"
        },
        {
            "sha": "2d2ec9712bd082189be47f4d6440f1770ed4d18d",
            "filename": "third_party/xla/xla/hlo/testlib/filecheck.h",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Ffilecheck.h?ref=bf95b538bfbf1254f652e98407235fddf9f41b01",
            "patch": "@@ -20,21 +20,23 @@ limitations under the License.\n \n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n-#include \"xla/types.h\"\n+#include \"absl/types/span.h\"\n \n namespace xla {\n \n // Runs FileCheck with the given pattern over given input string. Provided that\n // FileCheck can execute, returns true if and only if FileCheck succeeded in\n // matching the input.\n-absl::StatusOr<bool> RunFileCheck(const std::string& input,\n-                                  absl::string_view pattern);\n+absl::StatusOr<bool> RunFileCheck(\n+    const std::string& input, absl::string_view pattern,\n+    absl::Span<const absl::string_view> additional_check_prefixes = {});\n \n // Runs FileCheck with the given pattern file over given input string. Provided\n // that FileCheck can execute, returns true if and only if FileCheck succeeded\n // in matching the input.\n absl::StatusOr<bool> RunFileCheckWithPatternFile(\n-    const std::string& input, const std::string& pattern_file);\n+    const std::string& input, const std::string& pattern_file,\n+    absl::Span<const absl::string_view> additional_check_prefixes = {});\n \n }  // namespace xla\n "
        },
        {
            "sha": "8ac3ca2ef35c8950ce66a85fc4af4e5e6b6335f5",
            "filename": "third_party/xla/xla/hlo/testlib/hlo_hardware_independent_test_base.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Fhlo_hardware_independent_test_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Fhlo_hardware_independent_test_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Fhlo_hardware_independent_test_base.cc?ref=bf95b538bfbf1254f652e98407235fddf9f41b01",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"absl/strings/str_replace.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -222,7 +223,8 @@ void HloHardwareIndependentTestBase::RunAndFilecheckHloRewrite(\n     absl::string_view hlo, HloPassInterface&& hlo_pass,\n     std::optional<absl::string_view> expected,\n     std::function<void(HloModule*)> after_pass_checks,\n-    const HloModuleConfig* config) const {\n+    const HloModuleConfig* config,\n+    absl::Span<const absl::string_view> additional_check_prefixes) const {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n                           config ? ParseAndReturnVerifiedModule(hlo, *config)\n                                  : ParseAndReturnVerifiedModule(hlo));\n@@ -233,7 +235,7 @@ void HloHardwareIndependentTestBase::RunAndFilecheckHloRewrite(\n         bool filecheck_matches,\n         RunFileCheck(\n             module->ToString(HloPrintOptions().set_print_large_constants(true)),\n-            *expected));\n+            *expected, additional_check_prefixes));\n     EXPECT_TRUE(filecheck_matches) << module->ToString();\n     if (after_pass_checks) {\n       after_pass_checks(module.get());"
        },
        {
            "sha": "3d02c90b35c3752ad7f56911751b3fbd56fa1ab3",
            "filename": "third_party/xla/xla/hlo/testlib/hlo_hardware_independent_test_base.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Fhlo_hardware_independent_test_base.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Fhlo_hardware_independent_test_base.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftestlib%2Fhlo_hardware_independent_test_base.h?ref=bf95b538bfbf1254f652e98407235fddf9f41b01",
            "patch": "@@ -35,7 +35,6 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n-#include \"xla/hlo/ir/hlo_module_group.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/parser/hlo_parser.h\"\n #include \"xla/hlo/pass/hlo_pass_interface.h\"\n@@ -167,7 +166,8 @@ class HloHardwareIndependentTestBase : public ::testing::Test {\n       absl::string_view hlo_with_filecheck_lines, HloPassInterface&& hlo_pass,\n       std::optional<absl::string_view> expected,\n       std::function<void(HloModule*)> after_pass_checks = nullptr,\n-      const HloModuleConfig* config = nullptr) const;\n+      const HloModuleConfig* config = nullptr,\n+      absl::Span<const absl::string_view> additional_check_prefixes = {}) const;\n \n   using FixedMapping =\n       std::initializer_list<std::pair<absl::string_view, absl::string_view>>;"
        },
        {
            "sha": "04f1cbd82df4daf200488058d6ba7195ef71bf84",
            "filename": "third_party/xla/xla/service/gpu/transforms/gemm_rewriter_fp8_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_rewriter_fp8_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bf95b538bfbf1254f652e98407235fddf9f41b01/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_rewriter_fp8_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_rewriter_fp8_test.cc?ref=bf95b538bfbf1254f652e98407235fddf9f41b01",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <optional>\n #include <string>\n #include <utility>\n+#include <vector>\n \n #include <gtest/gtest.h>\n #include \"absl/container/flat_hash_map.h\"\n@@ -136,9 +137,18 @@ class ParameterizedFp8GemmRewriteTest\n     if (expected.has_value()) {\n       std::string replaced_pattern =\n           absl::StrReplaceAll(expected.value(), replacements_);\n+      std::vector<absl::string_view> additional_check_prefixes;\n+      if (IsCuda()) {\n+        additional_check_prefixes.push_back(\"CHECK-PTX\");\n+      }\n+      if (IsRocm()) {\n+        additional_check_prefixes.push_back(\"CHECK-GCN\");\n+      }\n+\n       GemmRewriteTestBase::RunAndFilecheckHloRewrite(\n           absl::StrReplaceAll(hlo, replacements_), std::move(hlo_pass),\n-          replaced_pattern, after_pass_checks, config);\n+          replaced_pattern, after_pass_checks, config,\n+          additional_check_prefixes);\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 78,
        "additions": 40,
        "deletions": 38
    }
}