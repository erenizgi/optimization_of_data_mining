{
    "author": "WillFroom",
    "message": "[XLA:CPU] Explicitly copy aliased input for DUS tests and check correctness on CPU.\n\nPiperOrigin-RevId: 799910498",
    "sha": "e073bd98aa251dd632aab28e9ee0e6f4237871b5",
    "files": [
        {
            "sha": "11f92d82804ae18cbf8b1e440ad3c80e64e7c32f",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/bitcast.hlo",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fbitcast.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fbitcast.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fbitcast.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,4 +1,5 @@\n // RUN: gpu_test_correctness %s\n+// RUN: cpu_test_correctness %s\n \n fusion {\n   in = f32[20,30] parameter(0)\n@@ -7,4 +8,15 @@ fusion {\n   i1 = s32[] parameter(3)\n   updated = f32[20,30] dynamic-update-slice(in, updates, i0, i1)\n   ROOT bitcast = f32[600] bitcast(updated)\n-}\n\\ No newline at end of file\n+}\n+\n+ENTRY main {\n+  %param_0 = f32[20,30] parameter(0)\n+  %param_1 = f32[5,6] parameter(1)\n+  %param_2 = s32[] parameter(2)\n+  %param_3 = s32[] parameter(3)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[20,30] copy(%param_0)\n+  ROOT %fusion = f32[600] fusion(%param_0_copy, %param_1, %param_2, %param_3), kind=kLoop, calls=fusion\n+}"
        },
        {
            "sha": "f366cd9acd71078878967c3416f14dc3d365e2b5",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/int4.hlo",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fint4.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fint4.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fint4.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,14 +1,24 @@\n // RUN: gpu_fusion_to_mlir %s | emitters_opt -xla-test-optimize \\\n // RUN:   -xla-gpu-test-transform-loops | FileCheck %s\n // RUN: gpu_test_correctness %s --bijection_inputs=dus:1\n+// RUN: cpu_test_correctness %s\n \n-f {\n+fusion {\n   input = s4[100,9] parameter(0)\n   slice = s4[100,6] parameter(1)\n   c0 = s32[] constant(0)\n   ROOT dus = s4[100,9] dynamic-update-slice(input, slice, c0, c0)\n }\n \n+ENTRY main {\n+  %param_0 = s4[100,9] parameter(0)\n+  %param_1 = s4[100,6] parameter(1)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = s4[100,9] copy(%param_0)\n+  ROOT %fusion = s4[100,9] fusion(%param_0_copy, %param_1), kind=kLoop, calls=fusion\n+}\n+\n // CHECK: vector.transfer_read\n // CHECK: tensor.insert\n // CHECK: tensor.insert"
        },
        {
            "sha": "bde51c5ba35193ab067079bb76c18ff76cb4d40c",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/mof.hlo",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fmof.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fmof.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fmof.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,4 +1,5 @@\n // RUN: gpu_test_correctness %s\n+// b/435101580: Add CPU test once DUS is migrated.\n \n fusion {\n   p0 = f32[10,11,12] parameter(0)\n@@ -13,4 +14,17 @@ fusion {\n   dus0 = f32[10,11,12] dynamic-update-slice(p0, select, c0, c0, c0)\n   dus1 = f32[8,11,12] dynamic-update-slice(p2, select, c0, c0, c0)\n   ROOT tuple = (f32[10,11,12], f32[8,11,12]) tuple(dus0, dus1)\n-}\n\\ No newline at end of file\n+}\n+\n+ENTRY main {\n+  %param_0 = f32[10,11,12] parameter(0)\n+  %param_1 = f32[1,11,12] parameter(1)\n+  %param_2 = f32[8,11,12] parameter(2)\n+  %param_3 = f32[1,11,12] parameter(3)\n+  %param_4 = s32[] parameter(4)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[10,11,12] copy(%param_0)\n+  %param_2_copy = f32[8,11,12] copy(%param_2)\n+  ROOT %fusion = (f32[10,11,12], f32[8,11,12]) fusion(%param_0_copy, %param_1, %param_2_copy, %param_3, %param_4), kind=kLoop, calls=fusion\n+}"
        },
        {
            "sha": "4f155ff9fbe498679aa9767ad69fa59193a095ca",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/operand_subgraph_two_roots.hlo",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Foperand_subgraph_two_roots.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Foperand_subgraph_two_roots.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Foperand_subgraph_two_roots.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,6 +1,7 @@\n // RUN: gpu_fusion_to_mlir %s | emitters_opt -xla-test-optimize |\\\n // RUN:   FileCheck %s\n // RUN: gpu_test_correctness %s\n+// RUN: cpu_test_correctness %s\n \n fusion {\n   param_0.8 = f32[512,512]{1,0} parameter(0)\n@@ -15,6 +16,18 @@ fusion {\n   ROOT dynamic-update-slice.5.1 = f32[512,512]{1,0} dynamic-update-slice(\n     param_0.8, param_1.10, param_2_plus_one, param_3_plus_one)\n }\n+\n+ENTRY main {\n+  %param_0 = f32[512,512]{1,0} parameter(0)\n+  %param_1 = f32[128,128]{1,0} parameter(1)\n+  %param_2 = s32[] parameter(2)\n+  %param_3 = s32[] parameter(3)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[512,512]{1,0} copy(%param_0)\n+  ROOT %fusion = f32[512,512]{1,0} fusion(%param_0_copy, %param_1, %param_2, %param_3), kind=kLoop, calls=fusion\n+}\n+\n // CHECK:     func.func @main(\n // CHECK-SAME:  %[[ARG0:[^:]+]]: tensor<512x512xf32>\n // CHECK-SAME:  , %[[ARG1:[^:]+]]: tensor<128x128xf32>"
        },
        {
            "sha": "46cc3b4f8e19e02e81c5b39c8fc1afb28b1604b3",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/out_of_bounds.hlo",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fout_of_bounds.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fout_of_bounds.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fout_of_bounds.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,6 +1,7 @@\n // RUN: gpu_fusion_to_mlir %s | emitters_opt -xla-test-optimize |\\\n // RUN:   FileCheck %s\n // RUN: gpu_test_correctness %s\n+// RUN: cpu_test_correctness %s\n \n fusion {\n   in = f32[7,8] parameter(0)\n@@ -9,6 +10,18 @@ fusion {\n   i1 = s32[] parameter(3)\n   ROOT updated = f32[7,8] dynamic-update-slice(in, updates, i0, i1)\n }\n+\n+ENTRY main {\n+  %param_0 = f32[7,8] parameter(0)\n+  %param_1 = f32[2,3] parameter(1)\n+  %param_2 = s32[] parameter(2)\n+  %param_3 = s32[] parameter(3)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[7,8] copy(%param_0)\n+  ROOT %fusion = f32[7,8] fusion(%param_0_copy, %param_1, %param_2, %param_3), kind=kLoop, calls=fusion\n+}\n+\n // CHECK:     func.func @main\n // CHECK-SAME:  %arg0: tensor<7x8xf32>\n // CHECK-SAME:  %arg1: tensor<2x3xf32>"
        },
        {
            "sha": "c265d813f86b1de9136c769f7664d10114591836",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/simple.hlo",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fsimple.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fsimple.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fsimple.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,6 +1,7 @@\n // RUN: gpu_fusion_to_mlir %s | emitters_opt -xla-test-optimize |\\\n // RUN:   FileCheck %s\n // RUN: gpu_test_correctness %s --bijection_inputs=updated:1\n+// RUN: cpu_test_correctness %s\n \n fusion {\n   in = f32[20,30] parameter(0)\n@@ -9,6 +10,18 @@ fusion {\n   i1 = s32[] parameter(3)\n   ROOT updated = f32[20,30] dynamic-update-slice(in, updates, i0, i1)\n }\n+\n+ENTRY main {\n+  %param_0 = f32[20,30] parameter(0)\n+  %param_1 = f32[5,6] parameter(1)\n+  %param_2 = s32[] parameter(2)\n+  %param_3 = s32[] parameter(3)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[20,30] copy(%param_0)\n+  ROOT %fusion = f32[20,30] fusion(%param_0_copy, %param_1, %param_2, %param_3), kind=kLoop, calls=fusion\n+}\n+\n // CHECK:     func.func @main\n // CHECK-SAME:  %arg0: tensor<20x30xf32>\n // CHECK-SAME:  %arg1: tensor<5x6xf32>"
        },
        {
            "sha": "8f9533cb3b281ca4163c796b7a1d351da537030f",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/vectorize_x1_too_small.hlo",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fvectorize_x1_too_small.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fvectorize_x1_too_small.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fvectorize_x1_too_small.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,14 +1,25 @@\n // RUN: gpu_fusion_to_mlir %s | emitters_opt -xla-test-optimize \\\n // RUN:   -xla-gpu-test-transform-loops | FileCheck %s\n // RUN: gpu_test_correctness %s --bijection_inputs=dus:1\n+// RUN: cpu_test_correctness %s\n \n-dus {\n+fusion {\n   %input = f32[40,40,300] parameter(0)\n   %update = f32[1,1,40] parameter(1)\n   %idx = s32[] parameter(2)\n   %zero = s32[] constant(0)\n   ROOT dus = f32[40,40,300] dynamic-update-slice(%input, %update, %idx, %zero, %zero)\n }\n \n+ENTRY main {\n+  %param_0 = f32[40,40,300] parameter(0)\n+  %param_1 = f32[1,1,40] parameter(1)\n+  %param_2 = s32[] parameter(2)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[40,40,300] copy(%param_0)\n+  ROOT %fusion = f32[40,40,300] fusion(%param_0_copy, %param_1, %param_2), kind=kLoop, calls=fusion\n+}\n+\n // CHECK-NOT: vector.transfer_read {{.*}} vector<4xf32>\n // CHECK-NOT: vector.transfer_write {{.*}} vector<4xf32>"
        },
        {
            "sha": "86b7bbc03820f13285d9222f19e0c7e67dfbb7f0",
            "filename": "third_party/xla/xla/codegen/emitters/tests/dynamic_update_slice/vectorize_x4.hlo",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fvectorize_x4.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e073bd98aa251dd632aab28e9ee0e6f4237871b5/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fvectorize_x4.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftests%2Fdynamic_update_slice%2Fvectorize_x4.hlo?ref=e073bd98aa251dd632aab28e9ee0e6f4237871b5",
            "patch": "@@ -1,14 +1,25 @@\n // RUN: gpu_fusion_to_mlir %s | emitters_opt -xla-test-optimize \\\n // RUN:   -xla-gpu-test-transform-loops | FileCheck %s\n // RUN: gpu_test_correctness %s --bijection_inputs=dus:1\n+// RUN: cpu_test_correctness %s\n \n-dus {\n+fusion {\n   %input = f32[40,40,300] parameter(0)\n   %update = f32[20,40,300] parameter(1)\n   %idx = s32[] parameter(2)\n   %zero = s32[] constant(0)\n   ROOT dus = f32[40,40,300] dynamic-update-slice(%input, %update, %idx, %zero, %zero)\n }\n \n+ENTRY main {\n+  %param_0 = f32[40,40,300] parameter(0)\n+  %param_1 = f32[20,40,300] parameter(1)\n+  %param_2 = s32[] parameter(2)\n+  // On CPU the input/output alias, this is resulting in a double free so we\n+  // need to copy the input.\n+  %param_0_copy = f32[40,40,300] copy(%param_0)\n+  ROOT %fusion = f32[40,40,300] fusion(%param_0_copy, %param_1, %param_2), kind=kLoop, calls=fusion\n+}\n+\n // CHECK: vector.transfer_read {{.*}} vector<4xf32>\n // CHECK: vector.transfer_write {{.*}} vector<4xf32>"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 102,
        "deletions": 5
    }
}