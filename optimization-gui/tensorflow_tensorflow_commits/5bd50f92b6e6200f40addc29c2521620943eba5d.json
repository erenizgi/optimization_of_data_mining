{
    "author": "beckerhe",
    "message": "Remove redundant replica group copy in CollectiveThunk.\n\nThe `config.replica_groups` was being populated twice from `proto.replica_groups`, once by `assign` and once by `absl::c_copy`. The `absl::c_copy` is redundant and causes duplicate entries.\n\nPiperOrigin-RevId: 848255824",
    "sha": "5bd50f92b6e6200f40addc29c2521620943eba5d",
    "files": [
        {
            "sha": "3d339a136aa0f1f177fd1fbca2814a5fc6e3312a",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_thunk.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5bd50f92b6e6200f40addc29c2521620943eba5d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5bd50f92b6e6200f40addc29c2521620943eba5d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk.cc?ref=5bd50f92b6e6200f40addc29c2521620943eba5d",
            "patch": "@@ -178,9 +178,6 @@ CollectiveConfig CollectiveConfig::FromProto(\n   config.replica_groups.assign(proto.replica_groups().begin(),\n                                proto.replica_groups().end());\n \n-  absl::c_copy(proto.replica_groups(),\n-               std::back_inserter(config.replica_groups));\n-\n   config.group_mode = proto.group_mode();\n   config.use_symmetric_buffer = proto.use_symmetric_buffer();\n   return config;"
        },
        {
            "sha": "3f5013bad2a47f9d9ce1c28debe8a333eac5e3e9",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_thunk.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5bd50f92b6e6200f40addc29c2521620943eba5d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5bd50f92b6e6200f40addc29c2521620943eba5d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk.h?ref=5bd50f92b6e6200f40addc29c2521620943eba5d",
            "patch": "@@ -29,6 +29,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/synchronization/mutex.h\"\n+#include \"absl/types/span.h\"\n #include \"xla/backends/gpu/collectives/gpu_clique_key.h\"\n #include \"xla/backends/gpu/runtime/collective_params.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\""
        },
        {
            "sha": "dd71d9eeb969de525077aff7a2b3808ae4affdaf",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_thunk_test.cc",
            "status": "modified",
            "additions": 49,
            "deletions": 1,
            "changes": 50,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5bd50f92b6e6200f40addc29c2521620943eba5d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5bd50f92b6e6200f40addc29c2521620943eba5d/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_thunk_test.cc?ref=5bd50f92b6e6200f40addc29c2521620943eba5d",
            "patch": "@@ -29,9 +29,11 @@ limitations under the License.\n namespace xla::gpu {\n namespace {\n \n+using ::testing::ElementsAre;\n using ::tsl::proto_testing::EqualsProto;\n+using ::tsl::proto_testing::ParseTextProtoOrDie;\n \n-TEST(CollectiveThunkTest, ProtoRoundTrip) {\n+TEST(CollectiveDoneThunkTest, ProtoRoundTrip) {\n   ThunkProto proto = tsl::proto_testing::ParseTextProtoOrDie<ThunkProto>(\n       R\"pb(\n         thunk_info {\n@@ -65,5 +67,51 @@ TEST(CollectiveThunkTest, ProtoRoundTrip) {\n   EXPECT_THAT(round_trip_proto, EqualsProto(proto));\n }\n \n+TEST(CollectiveConfigTest, ToProto) {\n+  CollectiveConfig config{\n+      /*operand_element_type=*/{PrimitiveType::F32, PrimitiveType::BF16},\n+      /*replica_groups=*/\n+      {ParseTextProtoOrDie<ReplicaGroup>(\n+           R\"pb(replica_ids: 0 replica_ids: 1)pb\"),\n+       ParseTextProtoOrDie<ReplicaGroup>(\n+           R\"pb(replica_ids: 2 replica_ids: 3)pb\")},\n+      /*group_mode=*/\n+      CollectiveOpGroupMode::COLLECTIVE_OP_GROUP_MODE_CROSS_PARTITION,\n+      /*use_symmetric_buffer=*/true,\n+  };\n+\n+  EXPECT_THAT(config.ToProto(), EqualsProto(R\"pb(\n+                operand_element_type: F32\n+                operand_element_type: BF16\n+                replica_groups { replica_ids: 0 replica_ids: 1 }\n+                replica_groups { replica_ids: 2 replica_ids: 3 }\n+                group_mode: COLLECTIVE_OP_GROUP_MODE_CROSS_PARTITION\n+                use_symmetric_buffer: true\n+              )pb\"));\n+}\n+\n+TEST(CollectiveConfigTest, FromProto) {\n+  CollectiveConfigProto proto = ParseTextProtoOrDie<CollectiveConfigProto>(\n+      R\"pb(\n+        operand_element_type: F32\n+        operand_element_type: BF16\n+        replica_groups { replica_ids: 0 replica_ids: 1 }\n+        replica_groups { replica_ids: 2 replica_ids: 3 }\n+        group_mode: COLLECTIVE_OP_GROUP_MODE_CROSS_PARTITION\n+        use_symmetric_buffer: true\n+      )pb\");\n+\n+  CollectiveConfig config = CollectiveConfig::FromProto(proto);\n+\n+  EXPECT_THAT(config.operand_element_type,\n+              ElementsAre(PrimitiveType::F32, PrimitiveType::BF16));\n+  EXPECT_THAT(config.replica_groups,\n+              ElementsAre(EqualsProto(R\"pb(replica_ids: 0 replica_ids: 1)pb\"),\n+                          EqualsProto(R\"pb(replica_ids: 2 replica_ids: 3)pb\")));\n+  EXPECT_EQ(config.group_mode,\n+            CollectiveOpGroupMode::COLLECTIVE_OP_GROUP_MODE_CROSS_PARTITION);\n+  EXPECT_TRUE(config.use_symmetric_buffer);\n+}\n+\n }  // namespace\n }  // namespace xla::gpu"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 50,
        "deletions": 4
    }
}