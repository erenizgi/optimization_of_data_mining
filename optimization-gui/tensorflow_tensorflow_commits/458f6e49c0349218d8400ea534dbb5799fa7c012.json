{
    "author": "ezhulenev",
    "message": "[xla] Stop using CreatePromise() in pjrt_future.cc\n\nPiperOrigin-RevId: 802848414",
    "sha": "458f6e49c0349218d8400ea534dbb5799fa7c012",
    "files": [
        {
            "sha": "9e47386e8a01d1ded9587ca8d5f1dab3d12ebb23",
            "filename": "third_party/xla/xla/pjrt/pjrt_future.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/458f6e49c0349218d8400ea534dbb5799fa7c012/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/458f6e49c0349218d8400ea534dbb5799fa7c012/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.cc?ref=458f6e49c0349218d8400ea534dbb5799fa7c012",
            "patch": "@@ -18,6 +18,7 @@ limitations under the License.\n #include <atomic>\n #include <cstdint>\n #include <memory>\n+#include <tuple>\n #include <utility>\n \n #include \"absl/base/no_destructor.h\"\n@@ -41,11 +42,13 @@ absl::NoDestructor<tsl::AsyncValueOwningRef<absl::Status>>\n \n namespace {\n struct State {\n-  explicit State(int32_t size)\n-      : pending_count(size), promise(PjRtFuture<>::CreatePromise()) {}\n+  explicit State(int32_t size) : pending_count(size) {\n+    std::tie(promise, future) = PjRtFuture<>::MakePromise();\n+  }\n \n   std::atomic<int32_t> pending_count;\n   PjRtFuture<>::Promise promise;\n+  PjRtFuture<> future;\n \n   absl::Mutex mu;\n   absl::Status status ABSL_GUARDED_BY(&mu);\n@@ -56,7 +59,8 @@ PjRtFuture<> JoinFutures(absl::Span<const PjRtFuture<>> futures) {\n   VLOG(2) << \"xla::JoinFutures: \" << futures.size() << \" futures\";\n   if (futures.empty()) {\n     return PjRtFuture<>(absl::OkStatus());\n-  } else if (futures.size() == 1) {\n+  }\n+  if (futures.size() == 1) {\n     return futures.front();\n   }\n \n@@ -86,7 +90,7 @@ PjRtFuture<> JoinFutures(absl::Span<const PjRtFuture<>> futures) {\n     });\n   }\n \n-  return PjRtFuture<>(state->promise);\n+  return std::move(state->future);\n }\n \n }  // namespace xla"
        },
        {
            "sha": "6e5fdb8149fdac5739084208655e1bf04f6dde00",
            "filename": "third_party/xla/xla/pjrt/pjrt_future.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/458f6e49c0349218d8400ea534dbb5799fa7c012/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/458f6e49c0349218d8400ea534dbb5799fa7c012/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_future.h?ref=458f6e49c0349218d8400ea534dbb5799fa7c012",
            "patch": "@@ -710,7 +710,7 @@ class PjRtFuture<void> : public internal::PjRtFutureBase<absl::Status> {\n   // Returns a pair of connected Promise and PjRtFuture<>. Setting the returned\n   // promise will fulfill the connected future.\n   static std::pair<Promise, PjRtFuture<>> MakePromise() {\n-    auto promise = CreatePromise();\n+    auto promise = Promise(tsl::MakeUnconstructedAsyncValueRef<absl::Status>());\n     auto future = PjRtFuture<void>(promise);\n     return std::make_pair(std::move(promise), std::move(future));\n   }"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 9,
        "deletions": 5
    }
}