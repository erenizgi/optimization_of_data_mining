{
    "author": "beckerhe",
    "message": "Make KernelArgumentPackingSpec work on 32bit platforms\n\nThe bit_casts between `void*` and `uint64_t` had the implicit assumption that we were running this code on 64bit platforms only, but there are also 32bit builds.\n\nTherefore I'm changing the casting logic. Instead of bit casting from `void*` to `uint64_t` which requires both types to have the same size in bytes we now reinterpret_cast from `void*` to `uintptr_t`. This is guaranteed to work by the standard. We can't use bit_cast here because `uintptr_t` can in theory be larger in size than `void*`. From `uintptr_t` we can then safely static_cast to `uint64_t`.\n\nI'm also changing the tests in a similar way. bit_casts get replaced by reinterpret_casts and a static_cast in some cases.\n\nPiperOrigin-RevId: 831776711",
    "sha": "696ec92d40674063fb3bd3016a9ace389845de07",
    "files": [
        {
            "sha": "31f25fed1cedbfb57bf6a6f023409fcbd797774e",
            "filename": "third_party/xla/xla/stream_executor/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/696ec92d40674063fb3bd3016a9ace389845de07/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/696ec92d40674063fb3bd3016a9ace389845de07/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2FBUILD?ref=696ec92d40674063fb3bd3016a9ace389845de07",
            "patch": "@@ -647,6 +647,7 @@ cc_library(\n         \":kernel_args_packed_vector\",\n         \":kernel_argument_packing_spec_proto_cc\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util:safe_reinterpret_cast\",\n         \"@com_google_absl//absl/base\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n@@ -669,14 +670,14 @@ xla_cc_test(\n         \":kernel_args_packed_vector\",\n         \":kernel_argument_packing_spec\",\n         \"//xla/tsl/platform:statusor\",\n+        \"//xla/tsl/util:safe_reinterpret_cast\",\n         \"//xla/tsl/util/proto:parse_text_proto\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/base\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@com_google_protobuf//:protobuf\",\n     ],\n )\n "
        },
        {
            "sha": "76b28a0f11655e4d51c0326d9ac613251bf65c54",
            "filename": "third_party/xla/xla/stream_executor/kernel_argument_packing_spec.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/696ec92d40674063fb3bd3016a9ace389845de07/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/696ec92d40674063fb3bd3016a9ace389845de07/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec.cc?ref=696ec92d40674063fb3bd3016a9ace389845de07",
            "patch": "@@ -21,14 +21,14 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n-#include \"absl/base/casts.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/types/span.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/kernel_args_packed_vector.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/tsl/util/safe_reinterpret_cast.h\"\n \n namespace stream_executor {\n namespace {\n@@ -71,8 +71,9 @@ absl::StatusOr<std::vector<char>> SingleArgumentPackingSpec::BuildArgument(\n                               \"at least %d, but got %d)\",\n                               sizeof(void*), argument.size()));\n         }\n-        uint64_t ptr = absl::bit_cast<uint64_t>(\n-            args.at(relocation.argument_index()).opaque());\n+        uint64_t ptr =\n+            static_cast<uint64_t>(tsl::safe_reinterpret_cast<uintptr_t>(\n+                args.at(relocation.argument_index()).opaque()));\n         std::memcpy(argument.data() + relocation.offset(), &ptr, sizeof(ptr));\n         break;\n       }"
        },
        {
            "sha": "8c4fae606bc590db2fed64968b5ff5123c79e80e",
            "filename": "third_party/xla/xla/stream_executor/kernel_argument_packing_spec_test.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 36,
            "changes": 69,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/696ec92d40674063fb3bd3016a9ace389845de07/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/696ec92d40674063fb3bd3016a9ace389845de07/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fkernel_argument_packing_spec_test.cc?ref=696ec92d40674063fb3bd3016a9ace389845de07",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/util/proto/parse_text_proto.h\"\n #include \"xla/tsl/util/proto/proto_matchers.h\"\n+#include \"xla/tsl/util/safe_reinterpret_cast.h\"\n \n namespace stream_executor {\n namespace {\n@@ -40,24 +41,34 @@ using ::testing::SizeIs;\n using tsl::proto_testing::EqualsProto;\n using tsl::proto_testing::ParseTextProtoOrDie;\n \n+// This function creates a `DeviceMemoryBase` with an opaque pointer that\n+// contains the given value. The size of the device memory is set to 0 since\n+// it's unused.\n+// Note that this device pointer is not a valid pointer to device memory, it\n+// is only used for testing and can't be dereferenced.\n+DeviceMemoryBase MakeDevicePointer(uint32_t value) {\n+  // To construct a pointer that works both on 32bit and 64bit platforms and\n+  // does not invoke undefined behaviour, we first cast our integer to uintptr_t\n+  // and then cast it to void*.\n+  return DeviceMemoryBase(\n+      tsl::safe_reinterpret_cast<void*>(static_cast<uintptr_t>(value)),\n+      /*size=*/0);\n+}\n+\n TEST(SingleArgumentPackingSpecTest, WriteArgumentAddress) {\n   SingleArgumentPackingSpec first_arg;\n   first_arg.WriteArgumentAddress(/*argument_index=*/2);\n \n   // We fail if not enough arguments are provided.Since we are referencing\n   // argument #2, we will need to provide 3 arguments.\n-  EXPECT_THAT(first_arg.BuildArgument({DeviceMemoryBase(nullptr, /*size=*/0),\n-                                       DeviceMemoryBase(nullptr, /*size=*/0)}),\n-              StatusIs(absl::StatusCode::kInvalidArgument));\n+  EXPECT_THAT(\n+      first_arg.BuildArgument({MakeDevicePointer(0), MakeDevicePointer(0)}),\n+      StatusIs(absl::StatusCode::kInvalidArgument));\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       std::vector<char> first_arg_storage,\n-      first_arg.BuildArgument(\n-          {DeviceMemoryBase(nullptr, /*size=*/0),\n-           DeviceMemoryBase(nullptr, /*size=*/0),\n-           DeviceMemoryBase(\n-               absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)),\n-               /*size=*/0)}));\n+      first_arg.BuildArgument({MakeDevicePointer(0), MakeDevicePointer(0),\n+                               MakeDevicePointer(0xff42)}));\n   EXPECT_THAT(first_arg_storage,\n               ElementsAre(0x42, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00));\n }\n@@ -70,21 +81,16 @@ TEST(SingleArgumentPackingSpecTest, WriteMultipleArgumentAddresses) {\n   TF_ASSERT_OK_AND_ASSIGN(\n       std::vector<char> first_arg_storage,\n       first_arg.BuildArgument(\n-          {DeviceMemoryBase(\n-               absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)),\n-               /*size=*/0),\n-           DeviceMemoryBase(\n-               absl::bit_cast<void*>(static_cast<uintptr_t>(0xaabbccdd)),\n-               /*size=*/0)}));\n+          {MakeDevicePointer(0xff42), MakeDevicePointer(0xaabbccdd)}));\n   EXPECT_THAT(first_arg_storage,\n               ElementsAre(0x42, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdd,\n                           0xcc, 0xbb, 0xaa, 0x00, 0x00, 0x00, 0x00));\n }\n \n TEST(SingleArgumentPackingSpecTest, WriteConstant) {\n   SingleArgumentPackingSpec first_arg;\n-  first_arg.WriteConstant(0x1348);\n-  first_arg.WriteConstant(0x2389ul);\n+  first_arg.WriteConstant(static_cast<uint32_t>(0x1348));\n+  first_arg.WriteConstant(static_cast<uint64_t>(0x2389));\n \n   TF_ASSERT_OK_AND_ASSIGN(std::vector<char> first_arg_storage,\n                           first_arg.BuildArgument(/*args=*/{}));\n@@ -100,12 +106,10 @@ TEST(SingleArgumentPackingSpecTest, WriteConstant) {\n TEST(SingleArgumentPackingSpecTest, WriteConstantAndAddress) {\n   SingleArgumentPackingSpec first_arg;\n   first_arg.WriteArgumentAddress(/*argument_index=*/0);\n-  first_arg.WriteConstant(0x1234);\n+  first_arg.WriteConstant(static_cast<uint32_t>(0x1234));\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      std::vector<char> first_arg_storage,\n-      first_arg.BuildArgument({DeviceMemoryBase(\n-          absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)), 0)}));\n+  TF_ASSERT_OK_AND_ASSIGN(std::vector<char> first_arg_storage,\n+                          first_arg.BuildArgument({MakeDevicePointer(0xff42)}));\n \n   EXPECT_THAT(first_arg_storage,\n               ElementsAre(0x42, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34,\n@@ -133,8 +137,7 @@ TEST(SingleArgumentPackingSpecTest, FromProto) {\n \n   TF_ASSERT_OK_AND_ASSIGN(SingleArgumentPackingSpec spec,\n                           SingleArgumentPackingSpec::FromProto(proto));\n-  EXPECT_THAT(spec.BuildArgument({DeviceMemoryBase(\n-                  absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)), 0)}),\n+  EXPECT_THAT(spec.BuildArgument({MakeDevicePointer(0xff42)}),\n               IsOkAndHolds(ElementsAre(0x34, 0x12, 0x00, 0x00, 0x42, 0xff, 0x00,\n                                        0x00, 0x00, 0x00, 0x00, 0x00)));\n }\n@@ -144,12 +147,9 @@ TEST(KernelArgumentsPackingSpecTest, BuildArguments) {\n   spec.AddAddressArgument(/*argument_index=*/0);\n   spec.AddConstantArgument(0x1234);\n \n-  TF_ASSERT_OK_AND_ASSIGN(\n-      std::unique_ptr<KernelArgsPackedVector> packed_args,\n-      spec.BuildArguments(\n-          {DeviceMemoryBase(\n-              absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)), 0)},\n-          /*shared_memory_bytes=*/8989));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<KernelArgsPackedVector> packed_args,\n+                          spec.BuildArguments({MakeDevicePointer(0xff42)},\n+                                              /*shared_memory_bytes=*/8989));\n   // We expect 3 arguments: 2 parameters and the shared memory which counts as\n   // an argument.\n   EXPECT_EQ(packed_args->number_of_arguments(), 3);\n@@ -197,12 +197,9 @@ TEST(KernelArgumentsPackingSpecTest, FromProto) {\n \n   TF_ASSERT_OK_AND_ASSIGN(KernelArgumentsPackingSpec spec,\n                           KernelArgumentsPackingSpec::FromProto(proto));\n-  TF_ASSERT_OK_AND_ASSIGN(\n-      std::unique_ptr<KernelArgsPackedVector> arguments,\n-      spec.BuildArguments(\n-          {DeviceMemoryBase(\n-              absl::bit_cast<void*>(static_cast<uintptr_t>(0xff42)), 0)},\n-          /*shared_memory_bytes=*/8989));\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<KernelArgsPackedVector> arguments,\n+                          spec.BuildArguments({MakeDevicePointer(0xff42)},\n+                                              /*shared_memory_bytes=*/8989));\n   // We expect 3 arguments: 2 parameters and the shared memory which counts as\n   // an argument.\n   EXPECT_EQ(arguments->number_of_arguments(), 3);"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 39,
        "deletions": 40
    }
}