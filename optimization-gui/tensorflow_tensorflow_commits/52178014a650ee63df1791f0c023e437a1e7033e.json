{
    "author": "boomanaiden154",
    "message": "Integrate LLVM at llvm/llvm-project@48d942c7158a\n\nUpdates LLVM usage to match\n[48d942c7158a](https://github.com/llvm/llvm-project/commit/48d942c7158a)\n\nPiperOrigin-RevId: 843253742",
    "sha": "52178014a650ee63df1791f0c023e437a1e7033e",
    "files": [
        {
            "sha": "509398da979e83350e3eb05534a4a72c6e1f3b19",
            "filename": "third_party/xla/third_party/llvm/generated.patch",
            "status": "modified",
            "additions": 0,
            "deletions": 1073,
            "changes": 1073,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch?ref=52178014a650ee63df1791f0c023e437a1e7033e",
            "patch": "@@ -1,1074 +1 @@\n Auto generated patch. Do not edit or delete it, even if empty.\n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/ClangdLSPServer.cpp b/clang-tools-extra/clangd/ClangdLSPServer.cpp\n---- a/clang-tools-extra/clangd/ClangdLSPServer.cpp\n-+++ b/clang-tools-extra/clangd/ClangdLSPServer.cpp\n-@@ -554,8 +554,6 @@\n-     if (const auto &Dir = Params.initializationOptions.compilationDatabasePath)\n-       CDBOpts.CompileCommandsDir = Dir;\n-     CDBOpts.ContextProvider = Opts.ContextProvider;\n--    if (Opts.StrongWorkspaceMode)\n--      CDBOpts.applyFallbackWorkingDirectory(Opts.WorkspaceRoot);\n-     BaseCDB =\n-         std::make_unique<DirectoryBasedGlobalCompilationDatabase>(CDBOpts);\n-   }\n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/ClangdServer.h b/clang-tools-extra/clangd/ClangdServer.h\n---- a/clang-tools-extra/clangd/ClangdServer.h\n-+++ b/clang-tools-extra/clangd/ClangdServer.h\n-@@ -152,11 +152,6 @@\n-     /// FIXME: If not set, should use the current working directory.\n-     std::optional<std::string> WorkspaceRoot;\n- \n--    /// Sets an alternate mode of operation. Current effects are:\n--    /// - Using the current working directory as the working directory for\n--    ///   fallback commands\n--    bool StrongWorkspaceMode;\n--\n-     /// The resource directory is used to find internal headers, overriding\n-     /// defaults and -resource-dir compiler flag).\n-     /// If std::nullopt, ClangdServer calls\n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp b/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n---- a/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n-+++ b/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n-@@ -64,9 +64,7 @@\n-   if (FileExtension.empty() || FileExtension == \".h\")\n-     Argv.push_back(\"-xobjective-c++-header\");\n-   Argv.push_back(std::string(File));\n--  tooling::CompileCommand Cmd(FallbackWorkingDirectory\n--                                  ? *FallbackWorkingDirectory\n--                                  : llvm::sys::path::parent_path(File),\n-+  tooling::CompileCommand Cmd(llvm::sys::path::parent_path(File),\n-                               llvm::sys::path::filename(File), std::move(Argv),\n-                               /*Output=*/\"\");\n-   Cmd.Heuristic = \"clangd fallback\";\n-@@ -351,8 +349,7 @@\n- \n- DirectoryBasedGlobalCompilationDatabase::\n-     DirectoryBasedGlobalCompilationDatabase(const Options &Opts)\n--    : GlobalCompilationDatabase(Opts.FallbackWorkingDirectory), Opts(Opts),\n--      Broadcaster(std::make_unique<BroadcastThread>(*this)) {\n-+    : Opts(Opts), Broadcaster(std::make_unique<BroadcastThread>(*this)) {\n-   if (!this->Opts.ContextProvider)\n-     this->Opts.ContextProvider = [](llvm::StringRef) {\n-       return Context::current().clone();\n-@@ -463,21 +460,6 @@\n-   return Result;\n- }\n- \n--void DirectoryBasedGlobalCompilationDatabase::Options::\n--    applyFallbackWorkingDirectory(\n--        std::optional<std::string> FallbackWorkingDirectory) {\n--  if (FallbackWorkingDirectory)\n--    this->FallbackWorkingDirectory = *FallbackWorkingDirectory;\n--  else {\n--    // Clangd is running in strong workspace mode but the client didn't\n--    // specify a workspace path in the `initialize` request.\n--    // Fallback to current working directory.\n--    SmallString<256> CWD;\n--    llvm::sys::fs::current_path(CWD);\n--    this->FallbackWorkingDirectory = std::string(CWD);\n--  }\n--}\n--\n- // The broadcast thread announces files with new compile commands to the world.\n- // Primarily this is used to enqueue them for background indexing.\n- //\n-@@ -777,10 +759,9 @@\n- \n- OverlayCDB::OverlayCDB(const GlobalCompilationDatabase *Base,\n-                        std::vector<std::string> FallbackFlags,\n--                       CommandMangler Mangler,\n--                       std::optional<std::string> FallbackWorkingDirectory)\n--    : DelegatingCDB(Base, FallbackWorkingDirectory),\n--      Mangler(std::move(Mangler)), FallbackFlags(std::move(FallbackFlags)) {}\n-+                       CommandMangler Mangler)\n-+    : DelegatingCDB(Base), Mangler(std::move(Mangler)),\n-+      FallbackFlags(std::move(FallbackFlags)) {}\n- \n- std::optional<tooling::CompileCommand>\n- OverlayCDB::getCompileCommand(PathRef File) const {\n-@@ -863,20 +844,16 @@\n-   return MDB;\n- }\n- \n--DelegatingCDB::DelegatingCDB(\n--    const GlobalCompilationDatabase *Base,\n--    std::optional<std::string> FallbackWorkingDirectory)\n--    : GlobalCompilationDatabase(FallbackWorkingDirectory), Base(Base) {\n-+DelegatingCDB::DelegatingCDB(const GlobalCompilationDatabase *Base)\n-+    : Base(Base) {\n-   if (Base)\n-     BaseChanged = Base->watch([this](const std::vector<std::string> Changes) {\n-       OnCommandChanged.broadcast(Changes);\n-     });\n- }\n- \n--DelegatingCDB::DelegatingCDB(\n--    std::unique_ptr<GlobalCompilationDatabase> Base,\n--    std::optional<std::string> FallbackWorkingDirectory)\n--    : DelegatingCDB(Base.get(), FallbackWorkingDirectory) {\n-+DelegatingCDB::DelegatingCDB(std::unique_ptr<GlobalCompilationDatabase> Base)\n-+    : DelegatingCDB(Base.get()) {\n-   BaseOwner = std::move(Base);\n- }\n- \n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/GlobalCompilationDatabase.h b/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n---- a/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n-+++ b/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n-@@ -35,9 +35,6 @@\n- /// Provides compilation arguments used for parsing C and C++ files.\n- class GlobalCompilationDatabase {\n- public:\n--  GlobalCompilationDatabase(\n--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt)\n--      : FallbackWorkingDirectory(FallbackWorkingDirectory) {}\n-   virtual ~GlobalCompilationDatabase() = default;\n- \n-   /// If there are any known-good commands for building this file, returns one.\n-@@ -72,19 +69,14 @@\n-   }\n- \n- protected:\n--  std::optional<std::string> FallbackWorkingDirectory;\n-   mutable CommandChanged OnCommandChanged;\n- };\n- \n- // Helper class for implementing GlobalCompilationDatabases that wrap others.\n- class DelegatingCDB : public GlobalCompilationDatabase {\n- public:\n--  DelegatingCDB(\n--      const GlobalCompilationDatabase *Base,\n--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n--  DelegatingCDB(\n--      std::unique_ptr<GlobalCompilationDatabase> Base,\n--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n-+  DelegatingCDB(const GlobalCompilationDatabase *Base);\n-+  DelegatingCDB(std::unique_ptr<GlobalCompilationDatabase> Base);\n- \n-   std::optional<tooling::CompileCommand>\n-   getCompileCommand(PathRef File) const override;\n-@@ -125,12 +117,6 @@\n-     // Only look for a compilation database in this one fixed directory.\n-     // FIXME: fold this into config/context mechanism.\n-     std::optional<Path> CompileCommandsDir;\n--    // Working directory for fallback commands\n--    // If unset, parent directory of file should be used\n--    std::optional<std::string> FallbackWorkingDirectory;\n--\n--    void applyFallbackWorkingDirectory(\n--        std::optional<std::string> FallbackWorkingDirectory);\n-   };\n- \n-   DirectoryBasedGlobalCompilationDatabase(const Options &Opts);\n-@@ -208,11 +194,9 @@\n-   // Base may be null, in which case no entries are inherited.\n-   // FallbackFlags are added to the fallback compile command.\n-   // Adjuster is applied to all commands, fallback or not.\n--  OverlayCDB(\n--      const GlobalCompilationDatabase *Base,\n--      std::vector<std::string> FallbackFlags = {},\n--      CommandMangler Mangler = nullptr,\n--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n-+  OverlayCDB(const GlobalCompilationDatabase *Base,\n-+             std::vector<std::string> FallbackFlags = {},\n-+             CommandMangler Mangler = nullptr);\n- \n-   std::optional<tooling::CompileCommand>\n-   getCompileCommand(PathRef File) const override;\n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/tool/Check.cpp b/clang-tools-extra/clangd/tool/Check.cpp\n---- a/clang-tools-extra/clangd/tool/Check.cpp\n-+++ b/clang-tools-extra/clangd/tool/Check.cpp\n-@@ -169,8 +169,6 @@\n-   bool buildCommand(const ThreadsafeFS &TFS) {\n-     log(\"Loading compilation database...\");\n-     DirectoryBasedGlobalCompilationDatabase::Options CDBOpts(TFS);\n--    if (Opts.StrongWorkspaceMode)\n--      CDBOpts.applyFallbackWorkingDirectory(Opts.WorkspaceRoot);\n-     CDBOpts.CompileCommandsDir =\n-         Config::current().CompileFlags.CDBSearch.FixedCDBPath;\n-     BaseCDB =\n-@@ -180,10 +178,8 @@\n-         getSystemIncludeExtractor(llvm::ArrayRef(Opts.QueryDriverGlobs));\n-     if (Opts.ResourceDir)\n-       Mangler.ResourceDir = *Opts.ResourceDir;\n--\n-     CDB = std::make_unique<OverlayCDB>(\n--        BaseCDB.get(), std::vector<std::string>{}, std::move(Mangler),\n--        CDBOpts.FallbackWorkingDirectory);\n-+        BaseCDB.get(), std::vector<std::string>{}, std::move(Mangler));\n- \n-     if (auto TrueCmd = CDB->getCompileCommand(File)) {\n-       Cmd = std::move(*TrueCmd);\n-@@ -506,7 +502,7 @@\n-                  config::DiagnosticCallback Diag) const override {\n-       config::Fragment F;\n-       // If we're timing clang-tidy checks, implicitly disabling the slow ones\n--      // is counterproductive!\n-+      // is counterproductive! \n-       if (CheckTidyTime.getNumOccurrences())\n-         F.Diagnostics.ClangTidy.FastCheckFilter.emplace(\"None\");\n-       return {std::move(F).compile(Diag)};\n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/tool/ClangdMain.cpp b/clang-tools-extra/clangd/tool/ClangdMain.cpp\n---- a/clang-tools-extra/clangd/tool/ClangdMain.cpp\n-+++ b/clang-tools-extra/clangd/tool/ClangdMain.cpp\n-@@ -500,17 +500,6 @@\n-     init(true),\n- };\n- \n--opt<bool> StrongWorkspaceMode{\n--    \"strong-workspace-mode\",\n--    cat(Features),\n--    desc(\"An alternate mode of operation for clangd, where the clangd instance \"\n--         \"is used to edit a single workspace.\\n\"\n--         \"When enabled, fallback commands use the workspace directory as their \"\n--         \"working directory instead of the parent folder.\"),\n--    init(false),\n--    Hidden,\n--};\n--\n- opt<bool> UseDirtyHeaders{\"use-dirty-headers\", cat(Misc),\n-                           desc(\"Use files open in the editor when parsing \"\n-                                \"headers instead of reading from the disk\"),\n-@@ -918,7 +907,6 @@\n-   }\n-   if (!ResourceDir.empty())\n-     Opts.ResourceDir = ResourceDir;\n--  Opts.StrongWorkspaceMode = StrongWorkspaceMode;\n-   Opts.BuildDynamicSymbolIndex = true;\n- #if CLANGD_ENABLE_REMOTE\n-   if (RemoteIndexAddress.empty() != ProjectRoot.empty()) {\n-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp b/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n---- a/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n-+++ b/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n-@@ -55,20 +55,6 @@\n-                                            testPath(\"foo/bar\")));\n- }\n- \n--TEST(GlobalCompilationDatabaseTest, FallbackWorkingDirectory) {\n--  MockFS TFS;\n--  DirectoryBasedGlobalCompilationDatabase::Options CDBOpts(TFS);\n--  CDBOpts.applyFallbackWorkingDirectory(testPath(\"foo\"));\n--  EXPECT_EQ(CDBOpts.FallbackWorkingDirectory, testPath(\"foo\"));\n--\n--  DirectoryBasedGlobalCompilationDatabase DB(CDBOpts);\n--  auto Cmd = DB.getFallbackCommand(testPath(\"foo/src/bar.cc\"));\n--  EXPECT_EQ(Cmd.Directory, testPath(\"foo\"));\n--  EXPECT_THAT(Cmd.CommandLine,\n--              ElementsAre(\"clang\", testPath(\"foo/src/bar.cc\")));\n--  EXPECT_EQ(Cmd.Output, \"\");\n--}\n--\n- static tooling::CompileCommand cmd(llvm::StringRef File, llvm::StringRef Arg) {\n-   return tooling::CompileCommand(\n-       testRoot(), File, {\"clang\", std::string(Arg), std::string(File)}, \"\");\n-diff -ruN --strip-trailing-cr a/llvm/lib/CodeGen/ShrinkWrap.cpp b/llvm/lib/CodeGen/ShrinkWrap.cpp\n---- a/llvm/lib/CodeGen/ShrinkWrap.cpp\n-+++ b/llvm/lib/CodeGen/ShrinkWrap.cpp\n-@@ -618,8 +618,6 @@\n- \n-   DenseSet<const MachineBasicBlock *> DirtyBBs;\n-   for (MachineBasicBlock &MBB : MF) {\n--    if (!MDT->isReachableFromEntry(&MBB))\n--      continue;\n-     if (MBB.isEHPad()) {\n-       DirtyBBs.insert(&MBB);\n-       continue;\n-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp b/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n---- a/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n-+++ b/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n-@@ -708,53 +708,6 @@\n-   return 2;\n- }\n- \n--bool llvm::optimizeTerminators(MachineBasicBlock *MBB,\n--                               const TargetInstrInfo &TII) {\n--  for (MachineInstr &MI : MBB->terminators()) {\n--    unsigned Opc = MI.getOpcode();\n--    switch (Opc) {\n--    case AArch64::CBZW:\n--    case AArch64::CBZX:\n--    case AArch64::TBZW:\n--    case AArch64::TBZX:\n--      // CBZ/TBZ with WZR/XZR -> unconditional B\n--      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n--          MI.getOperand(0).getReg() == AArch64::XZR) {\n--        DEBUG_WITH_TYPE(\"optimizeTerminators\",\n--                        dbgs() << \"Removing always taken branch: \" << MI);\n--        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n--        SmallVector<MachineBasicBlock *> Succs(MBB->successors());\n--        for (auto *S : Succs)\n--          if (S != Target)\n--            MBB->removeSuccessor(S);\n--        DebugLoc DL = MI.getDebugLoc();\n--        while (MBB->rbegin() != &MI)\n--          MBB->rbegin()->eraseFromParent();\n--        MI.eraseFromParent();\n--        BuildMI(MBB, DL, TII.get(AArch64::B)).addMBB(Target);\n--        return true;\n--      }\n--      break;\n--    case AArch64::CBNZW:\n--    case AArch64::CBNZX:\n--    case AArch64::TBNZW:\n--    case AArch64::TBNZX:\n--      // CBNZ/TBNZ with WZR/XZR -> never taken, remove branch and successor\n--      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n--          MI.getOperand(0).getReg() == AArch64::XZR) {\n--        DEBUG_WITH_TYPE(\"optimizeTerminators\",\n--                        dbgs() << \"Removing never taken branch: \" << MI);\n--        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n--        MI.getParent()->removeSuccessor(Target);\n--        MI.eraseFromParent();\n--        return true;\n--      }\n--      break;\n--    }\n--  }\n--  return false;\n--}\n--\n- // Find the original register that VReg is copied from.\n- static unsigned removeCopies(const MachineRegisterInfo &MRI, unsigned VReg) {\n-   while (Register::isVirtualRegister(VReg)) {\n-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64InstrInfo.h b/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n---- a/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n-+++ b/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n-@@ -705,8 +705,6 @@\n-                               unsigned *OutUnscaledOp = nullptr,\n-                               int64_t *EmittableOffset = nullptr);\n- \n--bool optimizeTerminators(MachineBasicBlock *MBB, const TargetInstrInfo &TII);\n--\n- static inline bool isUncondBranchOpcode(int Opc) { return Opc == AArch64::B; }\n- \n- static inline bool isCondBranchOpcode(int Opc) {\n-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp b/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n---- a/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n-+++ b/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n-@@ -14,7 +14,6 @@\n- //===----------------------------------------------------------------------===//\n- \n- #include \"AArch64.h\"\n--#include \"AArch64InstrInfo.h\"\n- #include \"llvm/CodeGen/MachineFunctionPass.h\"\n- #include \"llvm/CodeGen/MachineInstrBuilder.h\"\n- #include \"llvm/CodeGen/TargetInstrInfo.h\"\n-@@ -46,6 +45,51 @@\n-                 \"AArch64 Redundant Conditional Branch Elimination pass\", false,\n-                 false)\n- \n-+static bool optimizeTerminators(MachineBasicBlock *MBB,\n-+                                const TargetInstrInfo &TII) {\n-+  for (MachineInstr &MI : make_early_inc_range(MBB->terminators())) {\n-+    unsigned Opc = MI.getOpcode();\n-+    switch (Opc) {\n-+    case AArch64::CBZW:\n-+    case AArch64::CBZX:\n-+    case AArch64::TBZW:\n-+    case AArch64::TBZX:\n-+      // CBZ/TBZ with WZR/XZR -> unconditional B\n-+      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n-+          MI.getOperand(0).getReg() == AArch64::XZR) {\n-+        LLVM_DEBUG(dbgs() << \"Removing redundant branch: \" << MI);\n-+        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n-+        SmallVector<MachineBasicBlock *> Succs(MBB->successors());\n-+        for (auto *S : Succs)\n-+          if (S != Target)\n-+            MBB->removeSuccessor(S);\n-+        DebugLoc DL = MI.getDebugLoc();\n-+        while (MBB->rbegin() != &MI)\n-+          MBB->rbegin()->eraseFromParent();\n-+        MI.eraseFromParent();\n-+        BuildMI(MBB, DL, TII.get(AArch64::B)).addMBB(Target);\n-+        return true;\n-+      }\n-+      break;\n-+    case AArch64::CBNZW:\n-+    case AArch64::CBNZX:\n-+    case AArch64::TBNZW:\n-+    case AArch64::TBNZX:\n-+      // CBNZ/TBNZ with WZR/XZR -> never taken, remove branch and successor\n-+      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n-+          MI.getOperand(0).getReg() == AArch64::XZR) {\n-+        LLVM_DEBUG(dbgs() << \"Removing redundant branch: \" << MI);\n-+        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n-+        MI.getParent()->removeSuccessor(Target);\n-+        MI.eraseFromParent();\n-+        return true;\n-+      }\n-+      break;\n-+    }\n-+  }\n-+  return false;\n-+}\n-+\n- bool AArch64RedundantCondBranch::runOnMachineFunction(MachineFunction &MF) {\n-   if (skipFunction(MF.getFunction()))\n-     return false;\n-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp b/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n---- a/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n-+++ b/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n-@@ -50,7 +50,6 @@\n- //        to use WZR/XZR directly in some cases.\n- //===----------------------------------------------------------------------===//\n- #include \"AArch64.h\"\n--#include \"AArch64InstrInfo.h\"\n- #include \"llvm/ADT/SetVector.h\"\n- #include \"llvm/ADT/Statistic.h\"\n- #include \"llvm/ADT/iterator_range.h\"\n-@@ -476,7 +475,6 @@\n-     return false;\n-   TRI = MF.getSubtarget().getRegisterInfo();\n-   MRI = &MF.getRegInfo();\n--  const TargetInstrInfo &TII = *MF.getSubtarget().getInstrInfo();\n- \n-   // Resize the clobbered and used register unit trackers.  We do this once per\n-   // function.\n-@@ -486,10 +484,8 @@\n-   OptBBUsedRegs.init(*TRI);\n- \n-   bool Changed = false;\n--  for (MachineBasicBlock &MBB : MF) {\n--    Changed |= optimizeTerminators(&MBB, TII);\n-+  for (MachineBasicBlock &MBB : MF)\n-     Changed |= optimizeBlock(&MBB);\n--  }\n-   return Changed;\n- }\n- \n-diff -ruN --strip-trailing-cr a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n---- a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n-+++ b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n-@@ -1827,12 +1827,8 @@\n-     // profile info.\n-     CostTooHigh =\n-         LAI.getNumRuntimePointerChecks() > VectorizeMemoryCheckThreshold;\n--    if (CostTooHigh) {\n--      // Mark runtime checks as never succeeding when they exceed the threshold.\n--      MemRuntimeCheckCond = ConstantInt::getTrue(L->getHeader()->getContext());\n--      SCEVCheckCond = ConstantInt::getTrue(L->getHeader()->getContext());\n-+    if (CostTooHigh)\n-       return;\n--    }\n- \n-     BasicBlock *LoopHeader = L->getHeader();\n-     BasicBlock *Preheader = L->getLoopPreheader();\n-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll b/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n---- a/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n-+++ b/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n-@@ -735,15 +735,21 @@\n- ; ENABLE-NEXT:    .cfi_offset w29, -16\n- ; ENABLE-NEXT:    .cfi_offset w19, -24\n- ; ENABLE-NEXT:    .cfi_offset w20, -32\n-+; ENABLE-NEXT:  ; %bb.1: ; %if.then\n- ; ENABLE-NEXT:    sub x19, sp, #16\n- ; ENABLE-NEXT:    mov sp, x19\n- ; ENABLE-NEXT:    mov w20, wzr\n--; ENABLE-NEXT:  LBB10_1: ; %for.body\n-+; ENABLE-NEXT:  LBB10_2: ; %for.body\n- ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n- ; ENABLE-NEXT:    bl _something\n- ; ENABLE-NEXT:    add w20, w0, w20\n- ; ENABLE-NEXT:    str w20, [x19]\n--; ENABLE-NEXT:    b LBB10_1\n-+; ENABLE-NEXT:    b LBB10_2\n-+; ENABLE-NEXT:  ; %bb.3: ; %if.end\n-+; ENABLE-NEXT:    sub sp, x29, #16\n-+; ENABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-+; ENABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-+; ENABLE-NEXT:    ret\n- ;\n- ; DISABLE-LABEL: infiniteloop:\n- ; DISABLE:       ; %bb.0: ; %entry\n-@@ -755,15 +761,21 @@\n- ; DISABLE-NEXT:    .cfi_offset w29, -16\n- ; DISABLE-NEXT:    .cfi_offset w19, -24\n- ; DISABLE-NEXT:    .cfi_offset w20, -32\n-+; DISABLE-NEXT:  ; %bb.1: ; %if.then\n- ; DISABLE-NEXT:    sub x19, sp, #16\n- ; DISABLE-NEXT:    mov sp, x19\n- ; DISABLE-NEXT:    mov w20, wzr\n--; DISABLE-NEXT:  LBB10_1: ; %for.body\n-+; DISABLE-NEXT:  LBB10_2: ; %for.body\n- ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n- ; DISABLE-NEXT:    bl _something\n- ; DISABLE-NEXT:    add w20, w0, w20\n- ; DISABLE-NEXT:    str w20, [x19]\n--; DISABLE-NEXT:    b LBB10_1\n-+; DISABLE-NEXT:    b LBB10_2\n-+; DISABLE-NEXT:  ; %bb.3: ; %if.end\n-+; DISABLE-NEXT:    sub sp, x29, #16\n-+; DISABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-+; DISABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-+; DISABLE-NEXT:    ret\n- entry:\n-   br i1 undef, label %if.then, label %if.end\n- \n-@@ -794,10 +806,11 @@\n- ; ENABLE-NEXT:    .cfi_offset w29, -16\n- ; ENABLE-NEXT:    .cfi_offset w19, -24\n- ; ENABLE-NEXT:    .cfi_offset w20, -32\n-+; ENABLE-NEXT:  ; %bb.1: ; %if.then\n- ; ENABLE-NEXT:    sub x8, sp, #16\n- ; ENABLE-NEXT:    mov sp, x8\n- ; ENABLE-NEXT:    mov w9, wzr\n--; ENABLE-NEXT:  LBB11_1: ; %for.body\n-+; ENABLE-NEXT:  LBB11_2: ; %for.body\n- ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n- ; ENABLE-NEXT:    ; InlineAsm Start\n- ; ENABLE-NEXT:    mov x10, #0 ; =0x0\n-@@ -808,7 +821,12 @@\n- ; ENABLE-NEXT:    ; InlineAsm Start\n- ; ENABLE-NEXT:    nop\n- ; ENABLE-NEXT:    ; InlineAsm End\n--; ENABLE-NEXT:    b LBB11_1\n-+; ENABLE-NEXT:    b LBB11_2\n-+; ENABLE-NEXT:  ; %bb.3: ; %if.end\n-+; ENABLE-NEXT:    sub sp, x29, #16\n-+; ENABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-+; ENABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-+; ENABLE-NEXT:    ret\n- ;\n- ; DISABLE-LABEL: infiniteloop2:\n- ; DISABLE:       ; %bb.0: ; %entry\n-@@ -820,10 +838,11 @@\n- ; DISABLE-NEXT:    .cfi_offset w29, -16\n- ; DISABLE-NEXT:    .cfi_offset w19, -24\n- ; DISABLE-NEXT:    .cfi_offset w20, -32\n-+; DISABLE-NEXT:  ; %bb.1: ; %if.then\n- ; DISABLE-NEXT:    sub x8, sp, #16\n- ; DISABLE-NEXT:    mov sp, x8\n- ; DISABLE-NEXT:    mov w9, wzr\n--; DISABLE-NEXT:  LBB11_1: ; %for.body\n-+; DISABLE-NEXT:  LBB11_2: ; %for.body\n- ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n- ; DISABLE-NEXT:    ; InlineAsm Start\n- ; DISABLE-NEXT:    mov x10, #0 ; =0x0\n-@@ -834,7 +853,12 @@\n- ; DISABLE-NEXT:    ; InlineAsm Start\n- ; DISABLE-NEXT:    nop\n- ; DISABLE-NEXT:    ; InlineAsm End\n--; DISABLE-NEXT:    b LBB11_1\n-+; DISABLE-NEXT:    b LBB11_2\n-+; DISABLE-NEXT:  ; %bb.3: ; %if.end\n-+; DISABLE-NEXT:    sub sp, x29, #16\n-+; DISABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-+; DISABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-+; DISABLE-NEXT:    ret\n- entry:\n-   br i1 undef, label %if.then, label %if.end\n- \n-@@ -865,43 +889,49 @@\n- define void @infiniteloop3() {\n- ; ENABLE-LABEL: infiniteloop3:\n- ; ENABLE:       ; %bb.0: ; %entry\n-+; ENABLE-NEXT:  ; %bb.1: ; %loop2a.preheader\n- ; ENABLE-NEXT:    mov x8, xzr\n- ; ENABLE-NEXT:    mov x9, xzr\n- ; ENABLE-NEXT:    mov x11, xzr\n--; ENABLE-NEXT:    b LBB12_2\n--; ENABLE-NEXT:  LBB12_1: ; %loop2b\n--; ENABLE-NEXT:    ; in Loop: Header=BB12_2 Depth=1\n-+; ENABLE-NEXT:    b LBB12_3\n-+; ENABLE-NEXT:  LBB12_2: ; %loop2b\n-+; ENABLE-NEXT:    ; in Loop: Header=BB12_3 Depth=1\n- ; ENABLE-NEXT:    str x10, [x11]\n- ; ENABLE-NEXT:    mov x11, x10\n--; ENABLE-NEXT:  LBB12_2: ; %loop1\n-+; ENABLE-NEXT:  LBB12_3: ; %loop1\n- ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n- ; ENABLE-NEXT:    mov x10, x9\n- ; ENABLE-NEXT:    ldr x9, [x8]\n--; ENABLE-NEXT:    cbnz x8, LBB12_1\n--; ENABLE-NEXT:  ; %bb.3: ; in Loop: Header=BB12_2 Depth=1\n-+; ENABLE-NEXT:    cbnz x8, LBB12_2\n-+; ENABLE-NEXT:  ; %bb.4: ; in Loop: Header=BB12_3 Depth=1\n- ; ENABLE-NEXT:    mov x8, x10\n- ; ENABLE-NEXT:    mov x11, x10\n--; ENABLE-NEXT:    b LBB12_2\n-+; ENABLE-NEXT:    b LBB12_3\n-+; ENABLE-NEXT:  ; %bb.5: ; %end\n-+; ENABLE-NEXT:    ret\n- ;\n- ; DISABLE-LABEL: infiniteloop3:\n- ; DISABLE:       ; %bb.0: ; %entry\n-+; DISABLE-NEXT:  ; %bb.1: ; %loop2a.preheader\n- ; DISABLE-NEXT:    mov x8, xzr\n- ; DISABLE-NEXT:    mov x9, xzr\n- ; DISABLE-NEXT:    mov x11, xzr\n--; DISABLE-NEXT:    b LBB12_2\n--; DISABLE-NEXT:  LBB12_1: ; %loop2b\n--; DISABLE-NEXT:    ; in Loop: Header=BB12_2 Depth=1\n-+; DISABLE-NEXT:    b LBB12_3\n-+; DISABLE-NEXT:  LBB12_2: ; %loop2b\n-+; DISABLE-NEXT:    ; in Loop: Header=BB12_3 Depth=1\n- ; DISABLE-NEXT:    str x10, [x11]\n- ; DISABLE-NEXT:    mov x11, x10\n--; DISABLE-NEXT:  LBB12_2: ; %loop1\n-+; DISABLE-NEXT:  LBB12_3: ; %loop1\n- ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n- ; DISABLE-NEXT:    mov x10, x9\n- ; DISABLE-NEXT:    ldr x9, [x8]\n--; DISABLE-NEXT:    cbnz x8, LBB12_1\n--; DISABLE-NEXT:  ; %bb.3: ; in Loop: Header=BB12_2 Depth=1\n-+; DISABLE-NEXT:    cbnz x8, LBB12_2\n-+; DISABLE-NEXT:  ; %bb.4: ; in Loop: Header=BB12_3 Depth=1\n- ; DISABLE-NEXT:    mov x8, x10\n- ; DISABLE-NEXT:    mov x11, x10\n--; DISABLE-NEXT:    b LBB12_2\n-+; DISABLE-NEXT:    b LBB12_3\n-+; DISABLE-NEXT:  ; %bb.5: ; %end\n-+; DISABLE-NEXT:    ret\n- entry:\n-   br i1 undef, label %loop2a, label %body\n- \n-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll b/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n---- a/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n-+++ b/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n-@@ -8,14 +8,20 @@\n- define i8 @foo_optsize(i32 %v4) optsize {\n- ; CHECK-LABEL: foo_optsize:\n- ; CHECK:       // %bb.0: // %entry\n--; CHECK-NEXT:    cbnz w0, .LBB0_2\n--; CHECK-NEXT:  // %bb.1: // %b2\n--; CHECK-NEXT:    mov w0, #1 // =0x1\n-+; CHECK-NEXT:    b .LBB0_2\n-+; CHECK-NEXT:  .LBB0_1:\n-+; CHECK-NEXT:    mov w0, wzr\n- ; CHECK-NEXT:    ret\n- ; CHECK-NEXT:  .LBB0_2: // %b1\n--; CHECK-NEXT:    cmp w0, #1\n--; CHECK-NEXT:    mov w0, wzr\n-+; CHECK-NEXT:    cbnz w0, .LBB0_4\n-+; CHECK-NEXT:  // %bb.3: // %b2\n-+; CHECK-NEXT:    mov w0, #1 // =0x1\n- ; CHECK-NEXT:    ret\n-+; CHECK-NEXT:  .LBB0_4: // %b1\n-+; CHECK-NEXT:    cmp w0, #1\n-+; CHECK-NEXT:    b.ne .LBB0_1\n-+; CHECK-NEXT:  // %bb.5: // %b3\n-+; CHECK-NEXT:    b .LBB0_1\n- entry:\n-   %v2 = icmp eq i32 0, 0\n-   br i1 %v2, label %b1, label %b4\n-@@ -41,14 +47,20 @@\n- define i8 @foo_optspeed(i32 %v4) {\n- ; CHECK-LABEL: foo_optspeed:\n- ; CHECK:       // %bb.0: // %entry\n--; CHECK-NEXT:    cbnz w0, .LBB1_2\n--; CHECK-NEXT:  // %bb.1: // %b2\n--; CHECK-NEXT:    mov w0, #1 // =0x1\n-+; CHECK-NEXT:    b .LBB1_2\n-+; CHECK-NEXT:  .LBB1_1:\n-+; CHECK-NEXT:    mov w0, wzr\n- ; CHECK-NEXT:    ret\n- ; CHECK-NEXT:  .LBB1_2: // %b1\n--; CHECK-NEXT:    cmp w0, #1\n--; CHECK-NEXT:    mov w0, wzr\n-+; CHECK-NEXT:    cbnz w0, .LBB1_4\n-+; CHECK-NEXT:  // %bb.3: // %b2\n-+; CHECK-NEXT:    mov w0, #1 // =0x1\n- ; CHECK-NEXT:    ret\n-+; CHECK-NEXT:  .LBB1_4: // %b1\n-+; CHECK-NEXT:    cmp w0, #1\n-+; CHECK-NEXT:    b.ne .LBB1_1\n-+; CHECK-NEXT:  // %bb.5: // %b3\n-+; CHECK-NEXT:    b .LBB1_1\n- entry:\n-   %v2 = icmp eq i32 0, 0\n-   br i1 %v2, label %b1, label %b4\n-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll b/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n---- a/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n-+++ b/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n-@@ -21,8 +21,10 @@\n-   ; CHECK-NEXT:   B %bb.3\n-   ; CHECK-NEXT: {{  $}}\n-   ; CHECK-NEXT: bb.1.bb:\n-+  ; CHECK-NEXT:   successors: %bb.3(0x2aaaaaab), %bb.2(0x55555555)\n-   ; CHECK-NEXT:   liveins: $w0, $lr\n-   ; CHECK-NEXT: {{  $}}\n-+  ; CHECK-NEXT:   CBNZW $wzr, %bb.3\n-   ; CHECK-NEXT:   B %bb.2\n-   ; CHECK-NEXT: {{  $}}\n-   ; CHECK-NEXT: bb.2.bb1:\n-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/pr164181.ll b/llvm/test/CodeGen/AArch64/pr164181.ll\n---- a/llvm/test/CodeGen/AArch64/pr164181.ll\n-+++ b/llvm/test/CodeGen/AArch64/pr164181.ll\n-@@ -29,11 +29,11 @@\n- ; CHECK-NEXT:    str w4, [sp, #72] // 4-byte Spill\n- ; CHECK-NEXT:    str w3, [sp, #112] // 4-byte Spill\n- ; CHECK-NEXT:    str w5, [sp, #36] // 4-byte Spill\n--; CHECK-NEXT:    tbz w5, #0, .LBB0_40\n-+; CHECK-NEXT:    tbz w5, #0, .LBB0_43\n- ; CHECK-NEXT:  // %bb.1: // %for.body41.lr.ph\n- ; CHECK-NEXT:    ldr x4, [sp, #312]\n- ; CHECK-NEXT:    ldr x14, [sp, #280]\n--; CHECK-NEXT:    tbz w0, #0, .LBB0_39\n-+; CHECK-NEXT:    tbz w0, #0, .LBB0_42\n- ; CHECK-NEXT:  // %bb.2: // %for.body41.us.preheader\n- ; CHECK-NEXT:    ldrb w8, [sp, #368]\n- ; CHECK-NEXT:    ldrb w12, [sp, #256]\n-@@ -92,7 +92,7 @@\n- ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n- ; CHECK-NEXT:    ldr w8, [sp, #20] // 4-byte Reload\n- ; CHECK-NEXT:    mov x12, x24\n- ; CHECK-NEXT:    str x24, [sp, #48] // 8-byte Spill\n-@@ -117,7 +117,7 @@\n- ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n- ; CHECK-NEXT:    str x12, [sp, #40] // 8-byte Spill\n- ; CHECK-NEXT:    cmn x24, #30\n- ; CHECK-NEXT:    mov x12, #-30 // =0xffffffffffffffe2\n-@@ -142,7 +142,7 @@\n- ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n- ; CHECK-NEXT:    ldr x8, [sp, #64] // 8-byte Reload\n- ; CHECK-NEXT:    mov w14, #1152 // =0x480\n- ; CHECK-NEXT:    mov w24, #1 // =0x1\n-@@ -176,7 +176,7 @@\n- ; CHECK-NEXT:    // => This Loop Header: Depth=4\n- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n- ; CHECK-NEXT:    ldr w8, [sp, #116] // 4-byte Reload\n- ; CHECK-NEXT:    and w8, w8, w8, asr #31\n- ; CHECK-NEXT:    str w8, [sp, #128] // 4-byte Spill\n-@@ -281,23 +281,31 @@\n- ; CHECK-NEXT:    mov x24, xzr\n- ; CHECK-NEXT:    mul w12, w12, w22\n- ; CHECK-NEXT:    mov x22, x5\n--; CHECK-NEXT:    tbz w0, #0, .LBB0_33\n--; CHECK-NEXT:  .LBB0_28: // %if.then222.us\n-+; CHECK-NEXT:    tbz w0, #0, .LBB0_36\n-+; CHECK-NEXT:  .LBB0_28: // %for.body194.us\n- ; CHECK-NEXT:    // Parent Loop BB0_4 Depth=1\n- ; CHECK-NEXT:    // Parent Loop BB0_6 Depth=2\n- ; CHECK-NEXT:    // Parent Loop BB0_8 Depth=3\n- ; CHECK-NEXT:    // Parent Loop BB0_10 Depth=4\n- ; CHECK-NEXT:    // => This Inner Loop Header: Depth=5\n-+; CHECK-NEXT:  // %bb.29: // %if.then222.us\n-+; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n- ; CHECK-NEXT:    adrp x27, :got:var_32\n- ; CHECK-NEXT:    ldur w8, [x19, #-12]\n- ; CHECK-NEXT:    ldr x27, [x27, :got_lo12:var_32]\n- ; CHECK-NEXT:    strh w8, [x27]\n- ; CHECK-NEXT:    sxtb w8, w25\n--; CHECK-NEXT:    strb w3, [x16]\n- ; CHECK-NEXT:    bic w25, w8, w8, asr #31\n-+; CHECK-NEXT:    b .LBB0_31\n-+; CHECK-NEXT:    .p2align 5, , 16\n-+; CHECK-NEXT:  // %bb.30:\n-+; CHECK-NEXT:    mov w25, wzr\n-+; CHECK-NEXT:  .LBB0_31: // %if.end239.us\n-+; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n-+; CHECK-NEXT:    strb w3, [x16]\n- ; CHECK-NEXT:    tst w13, #0xff\n--; CHECK-NEXT:    b.eq .LBB0_30\n--; CHECK-NEXT:  // %bb.29: // %if.then254.us\n-+; CHECK-NEXT:    b.eq .LBB0_33\n-+; CHECK-NEXT:  // %bb.32: // %if.then254.us\n- ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n- ; CHECK-NEXT:    ldrh w8, [x26, x14, lsl #1]\n- ; CHECK-NEXT:    adrp x27, :got:var_35\n-@@ -306,7 +314,7 @@\n- ; CHECK-NEXT:    csel x8, xzr, x7, eq\n- ; CHECK-NEXT:    str x8, [x27]\n- ; CHECK-NEXT:    strh w1, [x17]\n--; CHECK-NEXT:  .LBB0_30: // %if.end282.us\n-+; CHECK-NEXT:  .LBB0_33: // %if.end282.us\n- ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n- ; CHECK-NEXT:    orr x27, x24, x4\n- ; CHECK-NEXT:    adrp x8, :got:var_39\n-@@ -317,14 +325,14 @@\n- ; CHECK-NEXT:    str x8, [x18]\n- ; CHECK-NEXT:    mov w8, #1 // =0x1\n- ; CHECK-NEXT:    cbnz x2, .LBB0_27\n--; CHECK-NEXT:  // %bb.31: // %if.then327.us\n-+; CHECK-NEXT:  // %bb.34: // %if.then327.us\n- ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n- ; CHECK-NEXT:    cbz w8, .LBB0_25\n--; CHECK-NEXT:  // %bb.32: // in Loop: Header=BB0_28 Depth=5\n-+; CHECK-NEXT:  // %bb.35: // in Loop: Header=BB0_28 Depth=5\n- ; CHECK-NEXT:    mov w4, wzr\n- ; CHECK-NEXT:    b .LBB0_26\n- ; CHECK-NEXT:    .p2align 5, , 16\n--; CHECK-NEXT:  .LBB0_33: // %for.cond376.preheader.us\n-+; CHECK-NEXT:  .LBB0_36: // %for.cond376.preheader.us\n- ; CHECK-NEXT:    // in Loop: Header=BB0_10 Depth=4\n- ; CHECK-NEXT:    mov w3, #1152 // =0x480\n- ; CHECK-NEXT:    mov x22, xzr\n-@@ -335,24 +343,24 @@\n- ; CHECK-NEXT:    madd x14, x14, x3, x11\n- ; CHECK-NEXT:    mov w28, w30\n- ; CHECK-NEXT:    mov w3, #-7680 // =0xffffe200\n--; CHECK-NEXT:    b .LBB0_36\n-+; CHECK-NEXT:    b .LBB0_39\n- ; CHECK-NEXT:    .p2align 5, , 16\n--; CHECK-NEXT:  .LBB0_34: // %if.then466.us\n--; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n-+; CHECK-NEXT:  .LBB0_37: // %if.then466.us\n-+; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n- ; CHECK-NEXT:    ldr x28, [sp, #152] // 8-byte Reload\n- ; CHECK-NEXT:    ldr x3, [sp, #136] // 8-byte Reload\n- ; CHECK-NEXT:    sxtb w4, w4\n- ; CHECK-NEXT:    bic w4, w4, w4, asr #31\n- ; CHECK-NEXT:    str x3, [x28]\n- ; CHECK-NEXT:    mov w3, #-7680 // =0xffffe200\n--; CHECK-NEXT:  .LBB0_35: // %for.inc505.us\n--; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n-+; CHECK-NEXT:  .LBB0_38: // %for.inc505.us\n-+; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n- ; CHECK-NEXT:    add x22, x22, #1\n- ; CHECK-NEXT:    add x27, x27, #1\n- ; CHECK-NEXT:    mov w28, wzr\n- ; CHECK-NEXT:    cmp x27, #0\n- ; CHECK-NEXT:    b.hs .LBB0_9\n--; CHECK-NEXT:  .LBB0_36: // %for.body380.us\n-+; CHECK-NEXT:  .LBB0_39: // %for.body380.us\n- ; CHECK-NEXT:    // Parent Loop BB0_4 Depth=1\n- ; CHECK-NEXT:    // Parent Loop BB0_6 Depth=2\n- ; CHECK-NEXT:    // Parent Loop BB0_8 Depth=3\n-@@ -364,18 +372,18 @@\n- ; CHECK-NEXT:    strh w28, [x11]\n- ; CHECK-NEXT:    csel w28, w21, w3, ne\n- ; CHECK-NEXT:    str w28, [x20]\n--; CHECK-NEXT:    cbz x15, .LBB0_35\n--; CHECK-NEXT:  // %bb.37: // %if.then436.us\n--; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n-+; CHECK-NEXT:    cbz x15, .LBB0_38\n-+; CHECK-NEXT:  // %bb.40: // %if.then436.us\n-+; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n- ; CHECK-NEXT:    ldrh w28, [x14]\n--; CHECK-NEXT:    cbnz w28, .LBB0_34\n--; CHECK-NEXT:  // %bb.38: // in Loop: Header=BB0_36 Depth=5\n-+; CHECK-NEXT:    cbnz w28, .LBB0_37\n-+; CHECK-NEXT:  // %bb.41: // in Loop: Header=BB0_39 Depth=5\n- ; CHECK-NEXT:    mov w4, wzr\n--; CHECK-NEXT:    b .LBB0_35\n--; CHECK-NEXT:  .LBB0_39: // %for.body41\n-+; CHECK-NEXT:    b .LBB0_38\n-+; CHECK-NEXT:  .LBB0_42: // %for.body41\n- ; CHECK-NEXT:    strb wzr, [x4]\n- ; CHECK-NEXT:    strb wzr, [x14]\n--; CHECK-NEXT:  .LBB0_40: // %for.cond563.preheader\n-+; CHECK-NEXT:  .LBB0_43: // %for.cond563.preheader\n- ; CHECK-NEXT:    ldp x20, x19, [sp, #224] // 16-byte Folded Reload\n- ; CHECK-NEXT:    ldp x22, x21, [sp, #208] // 16-byte Folded Reload\n- ; CHECK-NEXT:    ldp x24, x23, [sp, #192] // 16-byte Folded Reload\n-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/pr166870.ll b/llvm/test/CodeGen/AArch64/pr166870.ll\n---- a/llvm/test/CodeGen/AArch64/pr166870.ll\n-+++ b/llvm/test/CodeGen/AArch64/pr166870.ll\n-@@ -26,11 +26,12 @@\n- ; CHECK-NEXT:    mov x21, x1\n- ; CHECK-NEXT:    bl baz\n- ; CHECK-NEXT:    mov w0, #0 // =0x0\n-+; CHECK-NEXT:  // %bb.5: // %bb6\n- ; CHECK-NEXT:    mov w10, #1 // =0x1\n-+; CHECK-NEXT:    cbnz w10, .LBB0_11\n-+; CHECK-NEXT:  // %bb.6: // %bb7\n- ; CHECK-NEXT:    cbnz w10, .LBB0_10\n--; CHECK-NEXT:  // %bb.5: // %bb7\n--; CHECK-NEXT:    cbnz w10, .LBB0_9\n--; CHECK-NEXT:  // %bb.6: // %bb8\n-+; CHECK-NEXT:  // %bb.7: // %bb8\n- ; CHECK-NEXT:    mov x8, x21\n- ; CHECK-NEXT:    mov x9, x20\n- ; CHECK-NEXT:    mov w20, #0 // =0x0\n-@@ -38,17 +39,17 @@\n- ; CHECK-NEXT:    mov x21, x9\n- ; CHECK-NEXT:    mov w8, w8\n- ; CHECK-NEXT:    mov x22, x8\n--; CHECK-NEXT:  .LBB0_7: // %bb10\n-+; CHECK-NEXT:  .LBB0_8: // %bb10\n- ; CHECK-NEXT:    // =>This Inner Loop Header: Depth=1\n- ; CHECK-NEXT:    strb w20, [x19]\n--; CHECK-NEXT:    cbnz x21, .LBB0_7\n--; CHECK-NEXT:  // %bb.8: // %bb12\n--; CHECK-NEXT:    // in Loop: Header=BB0_7 Depth=1\n-+; CHECK-NEXT:    cbnz x21, .LBB0_8\n-+; CHECK-NEXT:  // %bb.9: // %bb12\n-+; CHECK-NEXT:    // in Loop: Header=BB0_8 Depth=1\n- ; CHECK-NEXT:    bl snork\n--; CHECK-NEXT:    cbnz x22, .LBB0_7\n--; CHECK-NEXT:  .LBB0_9:\n--; CHECK-NEXT:    mov w0, #0 // =0x0\n-+; CHECK-NEXT:    cbnz x22, .LBB0_8\n- ; CHECK-NEXT:  .LBB0_10:\n-+; CHECK-NEXT:    mov w0, #0 // =0x0\n-+; CHECK-NEXT:  .LBB0_11:\n- ; CHECK-NEXT:    ldp x20, x19, [sp, #32] // 16-byte Folded Reload\n- ; CHECK-NEXT:    ldp x22, x21, [sp, #16] // 16-byte Folded Reload\n- ; CHECK-NEXT:    ldr x30, [sp], #48 // 8-byte Folded Reload\n-diff -ruN --strip-trailing-cr a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n---- a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n-+++ b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n-@@ -71,21 +71,27 @@\n- ; CHECK-NEXT:    .cfi_def_cfa w29, 16\n- ; CHECK-NEXT:    .cfi_offset w30, -8\n- ; CHECK-NEXT:    .cfi_offset w29, -16\n-+; CHECK-NEXT:    .cfi_remember_state\n- ; CHECK-NEXT:    mov w8, #1 // =0x1\n--; CHECK-NEXT:    mov w9, #2 // =0x2\n- ; CHECK-NEXT:    stur xzr, [x29, #-8]\n--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n--; CHECK-NEXT:    ldur w8, [x29, #-8]\n--; CHECK-NEXT:    cbz w8, .LBB0_2\n-+; CHECK-NEXT:    b .LBB0_3\n- ; CHECK-NEXT:  // %bb.1:\n--; CHECK-NEXT:    mov w8, #1 // =0x1\n- ; CHECK-NEXT:    str w8, [sp, #16]\n--; CHECK-NEXT:    b .LBB0_3\n-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n-+; CHECK-NEXT:    cbz w8, .LBB0_4\n- ; CHECK-NEXT:  .LBB0_2:\n-+; CHECK-NEXT:    .cfi_restore_state\n- ; CHECK-NEXT:    mov w8, #1 // =0x1\n--; CHECK-NEXT:    mov w9, #2 // =0x2\n--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+; CHECK-NEXT:    str w8, [sp, #16]\n-+; CHECK-NEXT:    b .LBB0_5\n- ; CHECK-NEXT:  .LBB0_3:\n-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n-+; CHECK-NEXT:    cbnz w8, .LBB0_2\n-+; CHECK-NEXT:  .LBB0_4:\n-+; CHECK-NEXT:    mov w8, #1 // =0x1\n-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+; CHECK-NEXT:  .LBB0_5:\n- ; CHECK-NEXT:    mov w0, wzr\n- ; CHECK-NEXT:    .cfi_def_cfa wsp, 48\n- ; CHECK-NEXT:    ldp x29, x30, [sp, #32] // 16-byte Folded Reload\n-@@ -128,6 +134,7 @@\n- ;\n- ; CHECK-LABEL: OUTLINED_FUNCTION_0:\n- ; CHECK:       // %bb.0:\n-+; CHECK-NEXT:    mov w9, #2 // =0x2\n- ; CHECK-NEXT:    stp w9, w8, [x29, #-12]\n- ; CHECK-NEXT:    mov w9, #3 // =0x3\n- ; CHECK-NEXT:    mov w8, #4 // =0x4\n-diff -ruN --strip-trailing-cr a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n---- a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n-+++ b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n-@@ -12,21 +12,27 @@\n- ; CHECK-NEXT:    .cfi_def_cfa w29, 16\n- ; CHECK-NEXT:    .cfi_offset w30, -8\n- ; CHECK-NEXT:    .cfi_offset w29, -16\n-+; CHECK-NEXT:    .cfi_remember_state\n- ; CHECK-NEXT:    mov w8, #1 // =0x1\n--; CHECK-NEXT:    mov w9, #2 // =0x2\n- ; CHECK-NEXT:    stur xzr, [x29, #-8]\n--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n--; CHECK-NEXT:    ldur w8, [x29, #-8]\n--; CHECK-NEXT:    cbz w8, .LBB0_2\n-+; CHECK-NEXT:    b .LBB0_3\n- ; CHECK-NEXT:  // %bb.1:\n--; CHECK-NEXT:    mov w8, #1 // =0x1\n- ; CHECK-NEXT:    str w8, [sp, #16]\n--; CHECK-NEXT:    b .LBB0_3\n-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n-+; CHECK-NEXT:    cbz w8, .LBB0_4\n- ; CHECK-NEXT:  .LBB0_2:\n-+; CHECK-NEXT:    .cfi_restore_state\n- ; CHECK-NEXT:    mov w8, #1 // =0x1\n--; CHECK-NEXT:    mov w9, #2 // =0x2\n--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+; CHECK-NEXT:    str w8, [sp, #16]\n-+; CHECK-NEXT:    b .LBB0_5\n- ; CHECK-NEXT:  .LBB0_3:\n-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n-+; CHECK-NEXT:    cbnz w8, .LBB0_2\n-+; CHECK-NEXT:  .LBB0_4:\n-+; CHECK-NEXT:    mov w8, #1 // =0x1\n-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+; CHECK-NEXT:  .LBB0_5:\n- ; CHECK-NEXT:    mov w0, wzr\n- ; CHECK-NEXT:    .cfi_def_cfa wsp, 48\n- ; CHECK-NEXT:    ldp x29, x30, [sp, #32] // 16-byte Folded Reload\n-diff -ruN --strip-trailing-cr a/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll b/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n---- a/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n-+++ b/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n-@@ -2,23 +2,29 @@\n- ; RUN: opt -p loop-vectorize -vectorize-memory-check-threshold=0 -S %s | FileCheck --check-prefix=LIMIT0 %s\n- ; RUN: opt -p loop-vectorize -vectorize-memory-check-threshold=1 -S %s | FileCheck --check-prefix=LIMIT1 %s\n- \n--; Make sure we do not incorrectly vectorize with -vectorize-memory-check-threshold=0;\n--; no runtime check is generated and the loop should not be vectorized.\n-+; FIXME: Currently this miscompiles with -vectorize-memory-check-threshold=0;\n-+; no runtime check is generated even though one is needed and !noalias\n-+; annotations are added.\n- define i16 @runtime_checks_needed(ptr %src, ptr %dst) {\n- ; LIMIT0-LABEL: define i16 @runtime_checks_needed(\n- ; LIMIT0-SAME: ptr [[SRC:%.*]], ptr [[DST:%.*]]) {\n--; LIMIT0-NEXT:  [[ENTRY:.*]]:\n--; LIMIT0-NEXT:    br label %[[LOOP:.*]]\n--; LIMIT0:       [[LOOP]]:\n--; LIMIT0-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[ENTRY]] ], [ [[INDEX_NEXT:%.*]], %[[LOOP]] ]\n--; LIMIT0-NEXT:    [[L:%.*]] = load i16, ptr [[SRC]], align 1\n-+; LIMIT0-NEXT:  [[ENTRY:.*:]]\n-+; LIMIT0-NEXT:    br label %[[VECTOR_PH:.*]]\n-+; LIMIT0:       [[VECTOR_PH]]:\n-+; LIMIT0-NEXT:    [[TMP0:%.*]] = load i16, ptr [[SRC]], align 1, !alias.scope [[META0:![0-9]+]]\n-+; LIMIT0-NEXT:    [[BROADCAST_SPLATINSERT:%.*]] = insertelement <2 x i16> poison, i16 [[TMP0]], i64 0\n-+; LIMIT0-NEXT:    [[BROADCAST_SPLAT:%.*]] = shufflevector <2 x i16> [[BROADCAST_SPLATINSERT]], <2 x i16> poison, <2 x i32> zeroinitializer\n-+; LIMIT0-NEXT:    br label %[[VECTOR_BODY:.*]]\n-+; LIMIT0:       [[VECTOR_BODY]]:\n-+; LIMIT0-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[VECTOR_PH]] ], [ [[INDEX_NEXT:%.*]], %[[VECTOR_BODY]] ]\n- ; LIMIT0-NEXT:    [[TMP1:%.*]] = getelementptr inbounds i16, ptr [[DST]], i64 [[INDEX]]\n--; LIMIT0-NEXT:    store i16 [[L]], ptr [[TMP1]], align 1\n--; LIMIT0-NEXT:    [[INDEX_NEXT]] = add nuw nsw i64 [[INDEX]], 1\n-+; LIMIT0-NEXT:    store <2 x i16> [[BROADCAST_SPLAT]], ptr [[TMP1]], align 1, !alias.scope [[META3:![0-9]+]], !noalias [[META0]]\n-+; LIMIT0-NEXT:    [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 2\n- ; LIMIT0-NEXT:    [[TMP2:%.*]] = icmp eq i64 [[INDEX_NEXT]], 1000\n--; LIMIT0-NEXT:    br i1 [[TMP2]], label %[[EXIT:.*]], label %[[LOOP]], !llvm.loop [[LOOP0:![0-9]+]]\n-+; LIMIT0-NEXT:    br i1 [[TMP2]], label %[[MIDDLE_BLOCK:.*]], label %[[VECTOR_BODY]], !llvm.loop [[LOOP5:![0-9]+]]\n-+; LIMIT0:       [[MIDDLE_BLOCK]]:\n-+; LIMIT0-NEXT:    br label %[[EXIT:.*]]\n- ; LIMIT0:       [[EXIT]]:\n--; LIMIT0-NEXT:    [[TMP0:%.*]] = phi i16 [ [[L]], %[[LOOP]] ]\n- ; LIMIT0-NEXT:    ret i16 [[TMP0]]\n- ;\n- ; LIMIT1-LABEL: define i16 @runtime_checks_needed(\n-@@ -82,9 +88,14 @@\n- !3 = !{!\"llvm.loop.vectorize.enable\", i1 true}\n- \n- ;.\n--; LIMIT0: [[LOOP0]] = distinct !{[[LOOP0]], [[META1:![0-9]+]], [[META2:![0-9]+]]}\n--; LIMIT0: [[META1]] = !{!\"llvm.loop.vectorize.width\", i32 2}\n--; LIMIT0: [[META2]] = !{!\"llvm.loop.vectorize.enable\", i1 true}\n-+; LIMIT0: [[META0]] = !{[[META1:![0-9]+]]}\n-+; LIMIT0: [[META1]] = distinct !{[[META1]], [[META2:![0-9]+]]}\n-+; LIMIT0: [[META2]] = distinct !{[[META2]], !\"LVerDomain\"}\n-+; LIMIT0: [[META3]] = !{[[META4:![0-9]+]]}\n-+; LIMIT0: [[META4]] = distinct !{[[META4]], [[META2]]}\n-+; LIMIT0: [[LOOP5]] = distinct !{[[LOOP5]], [[META6:![0-9]+]], [[META7:![0-9]+]]}\n-+; LIMIT0: [[META6]] = !{!\"llvm.loop.isvectorized\", i32 1}\n-+; LIMIT0: [[META7]] = !{!\"llvm.loop.unroll.runtime.disable\"}\n- ;.\n- ; LIMIT1: [[META0]] = !{[[META1:![0-9]+]]}\n- ; LIMIT1: [[META1]] = distinct !{[[META1]], [[META2:![0-9]+]]}\n-diff -ruN --strip-trailing-cr a/mlir/lib/Bytecode/Reader/BytecodeReader.cpp b/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n---- a/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n-+++ b/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n-@@ -1320,8 +1320,9 @@\n- }\n- \n- template <typename T>\n--T AttrTypeReader::resolveEntry(SmallVectorImpl<Entry<T>> &entries, size_t index,\n--                               StringRef entryType, uint64_t depth) {\n-+T AttrTypeReader::resolveEntry(SmallVectorImpl<Entry<T>> &entries,\n-+                               uint64_t index, StringRef entryType,\n-+                               uint64_t depth) {\n-   if (index >= entries.size()) {\n-     emitError(fileLoc) << \"invalid \" << entryType << \" index: \" << index;\n-     return {};"
        },
        {
            "sha": "3c9c005f2315d3daa50eb2dffbc15f10f23244e3",
            "filename": "third_party/xla/third_party/llvm/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl?ref=52178014a650ee63df1791f0c023e437a1e7033e",
            "patch": "@@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\")\n \n def repo(name):\n     \"\"\"Imports LLVM.\"\"\"\n-    LLVM_COMMIT = \"87bf5ee23863bc0b467ee44b2184b2c134a98464\"\n-    LLVM_SHA256 = \"9d0bca271bfb266de8453cd34156741fd41f64b911f580262d187ce4d4d9b6d9\"\n+    LLVM_COMMIT = \"48d942c7158af43094db1b5e6c59c6e6fcf1b5aa\"\n+    LLVM_SHA256 = \"6ce4ac276a4687625e9f57e53715285d99b60c6553e0cde4db9b7e74f2179f69\"\n \n     tf_http_archive(\n         name = name,"
        },
        {
            "sha": "4caadcc3b73011d43af7c10f12db5b824d7fba5f",
            "filename": "third_party/xla/third_party/shardy/temporary.patch",
            "status": "modified",
            "additions": 1080,
            "deletions": 1080,
            "changes": 2160,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch?ref=52178014a650ee63df1791f0c023e437a1e7033e",
            "patch": "@@ -1,1094 +1,1094 @@\n diff --git a/third_party/llvm/generated.patch b/third_party/llvm/generated.patch\n-index 509398d..2948da4 100644\n+index 2948da4..509398d 100644\n --- a/third_party/llvm/generated.patch\n +++ b/third_party/llvm/generated.patch\n-@@ -1 +1,1074 @@\n+@@ -1,1074 +1 @@\n  Auto generated patch. Do not edit or delete it, even if empty.\n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/ClangdLSPServer.cpp b/clang-tools-extra/clangd/ClangdLSPServer.cpp\n-+--- a/clang-tools-extra/clangd/ClangdLSPServer.cpp\n-++++ b/clang-tools-extra/clangd/ClangdLSPServer.cpp\n-+@@ -554,8 +554,6 @@\n-+     if (const auto &Dir = Params.initializationOptions.compilationDatabasePath)\n-+       CDBOpts.CompileCommandsDir = Dir;\n-+     CDBOpts.ContextProvider = Opts.ContextProvider;\n-+-    if (Opts.StrongWorkspaceMode)\n-+-      CDBOpts.applyFallbackWorkingDirectory(Opts.WorkspaceRoot);\n-+     BaseCDB =\n-+         std::make_unique<DirectoryBasedGlobalCompilationDatabase>(CDBOpts);\n-+   }\n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/ClangdServer.h b/clang-tools-extra/clangd/ClangdServer.h\n-+--- a/clang-tools-extra/clangd/ClangdServer.h\n-++++ b/clang-tools-extra/clangd/ClangdServer.h\n-+@@ -152,11 +152,6 @@\n-+     /// FIXME: If not set, should use the current working directory.\n-+     std::optional<std::string> WorkspaceRoot;\n-+ \n-+-    /// Sets an alternate mode of operation. Current effects are:\n-+-    /// - Using the current working directory as the working directory for\n-+-    ///   fallback commands\n-+-    bool StrongWorkspaceMode;\n-+-\n-+     /// The resource directory is used to find internal headers, overriding\n-+     /// defaults and -resource-dir compiler flag).\n-+     /// If std::nullopt, ClangdServer calls\n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp b/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n-+--- a/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n-++++ b/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n-+@@ -64,9 +64,7 @@\n-+   if (FileExtension.empty() || FileExtension == \".h\")\n-+     Argv.push_back(\"-xobjective-c++-header\");\n-+   Argv.push_back(std::string(File));\n-+-  tooling::CompileCommand Cmd(FallbackWorkingDirectory\n-+-                                  ? *FallbackWorkingDirectory\n-+-                                  : llvm::sys::path::parent_path(File),\n-++  tooling::CompileCommand Cmd(llvm::sys::path::parent_path(File),\n-+                               llvm::sys::path::filename(File), std::move(Argv),\n-+                               /*Output=*/\"\");\n-+   Cmd.Heuristic = \"clangd fallback\";\n-+@@ -351,8 +349,7 @@\n-+ \n-+ DirectoryBasedGlobalCompilationDatabase::\n-+     DirectoryBasedGlobalCompilationDatabase(const Options &Opts)\n-+-    : GlobalCompilationDatabase(Opts.FallbackWorkingDirectory), Opts(Opts),\n-+-      Broadcaster(std::make_unique<BroadcastThread>(*this)) {\n-++    : Opts(Opts), Broadcaster(std::make_unique<BroadcastThread>(*this)) {\n-+   if (!this->Opts.ContextProvider)\n-+     this->Opts.ContextProvider = [](llvm::StringRef) {\n-+       return Context::current().clone();\n-+@@ -463,21 +460,6 @@\n-+   return Result;\n-+ }\n-+ \n-+-void DirectoryBasedGlobalCompilationDatabase::Options::\n-+-    applyFallbackWorkingDirectory(\n-+-        std::optional<std::string> FallbackWorkingDirectory) {\n-+-  if (FallbackWorkingDirectory)\n-+-    this->FallbackWorkingDirectory = *FallbackWorkingDirectory;\n-+-  else {\n-+-    // Clangd is running in strong workspace mode but the client didn't\n-+-    // specify a workspace path in the `initialize` request.\n-+-    // Fallback to current working directory.\n-+-    SmallString<256> CWD;\n-+-    llvm::sys::fs::current_path(CWD);\n-+-    this->FallbackWorkingDirectory = std::string(CWD);\n-+-  }\n-+-}\n-+-\n-+ // The broadcast thread announces files with new compile commands to the world.\n-+ // Primarily this is used to enqueue them for background indexing.\n-+ //\n-+@@ -777,10 +759,9 @@\n-+ \n-+ OverlayCDB::OverlayCDB(const GlobalCompilationDatabase *Base,\n-+                        std::vector<std::string> FallbackFlags,\n-+-                       CommandMangler Mangler,\n-+-                       std::optional<std::string> FallbackWorkingDirectory)\n-+-    : DelegatingCDB(Base, FallbackWorkingDirectory),\n-+-      Mangler(std::move(Mangler)), FallbackFlags(std::move(FallbackFlags)) {}\n-++                       CommandMangler Mangler)\n-++    : DelegatingCDB(Base), Mangler(std::move(Mangler)),\n-++      FallbackFlags(std::move(FallbackFlags)) {}\n-+ \n-+ std::optional<tooling::CompileCommand>\n-+ OverlayCDB::getCompileCommand(PathRef File) const {\n-+@@ -863,20 +844,16 @@\n-+   return MDB;\n-+ }\n-+ \n-+-DelegatingCDB::DelegatingCDB(\n-+-    const GlobalCompilationDatabase *Base,\n-+-    std::optional<std::string> FallbackWorkingDirectory)\n-+-    : GlobalCompilationDatabase(FallbackWorkingDirectory), Base(Base) {\n-++DelegatingCDB::DelegatingCDB(const GlobalCompilationDatabase *Base)\n-++    : Base(Base) {\n-+   if (Base)\n-+     BaseChanged = Base->watch([this](const std::vector<std::string> Changes) {\n-+       OnCommandChanged.broadcast(Changes);\n-+     });\n-+ }\n-+ \n-+-DelegatingCDB::DelegatingCDB(\n-+-    std::unique_ptr<GlobalCompilationDatabase> Base,\n-+-    std::optional<std::string> FallbackWorkingDirectory)\n-+-    : DelegatingCDB(Base.get(), FallbackWorkingDirectory) {\n-++DelegatingCDB::DelegatingCDB(std::unique_ptr<GlobalCompilationDatabase> Base)\n-++    : DelegatingCDB(Base.get()) {\n-+   BaseOwner = std::move(Base);\n-+ }\n-+ \n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/GlobalCompilationDatabase.h b/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n-+--- a/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n-++++ b/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n-+@@ -35,9 +35,6 @@\n-+ /// Provides compilation arguments used for parsing C and C++ files.\n-+ class GlobalCompilationDatabase {\n-+ public:\n-+-  GlobalCompilationDatabase(\n-+-      std::optional<std::string> FallbackWorkingDirectory = std::nullopt)\n-+-      : FallbackWorkingDirectory(FallbackWorkingDirectory) {}\n-+   virtual ~GlobalCompilationDatabase() = default;\n-+ \n-+   /// If there are any known-good commands for building this file, returns one.\n-+@@ -72,19 +69,14 @@\n-+   }\n-+ \n-+ protected:\n-+-  std::optional<std::string> FallbackWorkingDirectory;\n-+   mutable CommandChanged OnCommandChanged;\n-+ };\n-+ \n-+ // Helper class for implementing GlobalCompilationDatabases that wrap others.\n-+ class DelegatingCDB : public GlobalCompilationDatabase {\n-+ public:\n-+-  DelegatingCDB(\n-+-      const GlobalCompilationDatabase *Base,\n-+-      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n-+-  DelegatingCDB(\n-+-      std::unique_ptr<GlobalCompilationDatabase> Base,\n-+-      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n-++  DelegatingCDB(const GlobalCompilationDatabase *Base);\n-++  DelegatingCDB(std::unique_ptr<GlobalCompilationDatabase> Base);\n-+ \n-+   std::optional<tooling::CompileCommand>\n-+   getCompileCommand(PathRef File) const override;\n-+@@ -125,12 +117,6 @@\n-+     // Only look for a compilation database in this one fixed directory.\n-+     // FIXME: fold this into config/context mechanism.\n-+     std::optional<Path> CompileCommandsDir;\n-+-    // Working directory for fallback commands\n-+-    // If unset, parent directory of file should be used\n-+-    std::optional<std::string> FallbackWorkingDirectory;\n-+-\n-+-    void applyFallbackWorkingDirectory(\n-+-        std::optional<std::string> FallbackWorkingDirectory);\n-+   };\n-+ \n-+   DirectoryBasedGlobalCompilationDatabase(const Options &Opts);\n-+@@ -208,11 +194,9 @@\n-+   // Base may be null, in which case no entries are inherited.\n-+   // FallbackFlags are added to the fallback compile command.\n-+   // Adjuster is applied to all commands, fallback or not.\n-+-  OverlayCDB(\n-+-      const GlobalCompilationDatabase *Base,\n-+-      std::vector<std::string> FallbackFlags = {},\n-+-      CommandMangler Mangler = nullptr,\n-+-      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n-++  OverlayCDB(const GlobalCompilationDatabase *Base,\n-++             std::vector<std::string> FallbackFlags = {},\n-++             CommandMangler Mangler = nullptr);\n-+ \n-+   std::optional<tooling::CompileCommand>\n-+   getCompileCommand(PathRef File) const override;\n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/tool/Check.cpp b/clang-tools-extra/clangd/tool/Check.cpp\n-+--- a/clang-tools-extra/clangd/tool/Check.cpp\n-++++ b/clang-tools-extra/clangd/tool/Check.cpp\n-+@@ -169,8 +169,6 @@\n-+   bool buildCommand(const ThreadsafeFS &TFS) {\n-+     log(\"Loading compilation database...\");\n-+     DirectoryBasedGlobalCompilationDatabase::Options CDBOpts(TFS);\n-+-    if (Opts.StrongWorkspaceMode)\n-+-      CDBOpts.applyFallbackWorkingDirectory(Opts.WorkspaceRoot);\n-+     CDBOpts.CompileCommandsDir =\n-+         Config::current().CompileFlags.CDBSearch.FixedCDBPath;\n-+     BaseCDB =\n-+@@ -180,10 +178,8 @@\n-+         getSystemIncludeExtractor(llvm::ArrayRef(Opts.QueryDriverGlobs));\n-+     if (Opts.ResourceDir)\n-+       Mangler.ResourceDir = *Opts.ResourceDir;\n-+-\n-+     CDB = std::make_unique<OverlayCDB>(\n-+-        BaseCDB.get(), std::vector<std::string>{}, std::move(Mangler),\n-+-        CDBOpts.FallbackWorkingDirectory);\n-++        BaseCDB.get(), std::vector<std::string>{}, std::move(Mangler));\n-+ \n-+     if (auto TrueCmd = CDB->getCompileCommand(File)) {\n-+       Cmd = std::move(*TrueCmd);\n-+@@ -506,7 +502,7 @@\n-+                  config::DiagnosticCallback Diag) const override {\n-+       config::Fragment F;\n-+       // If we're timing clang-tidy checks, implicitly disabling the slow ones\n-+-      // is counterproductive!\n-++      // is counterproductive! \n-+       if (CheckTidyTime.getNumOccurrences())\n-+         F.Diagnostics.ClangTidy.FastCheckFilter.emplace(\"None\");\n-+       return {std::move(F).compile(Diag)};\n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/tool/ClangdMain.cpp b/clang-tools-extra/clangd/tool/ClangdMain.cpp\n-+--- a/clang-tools-extra/clangd/tool/ClangdMain.cpp\n-++++ b/clang-tools-extra/clangd/tool/ClangdMain.cpp\n-+@@ -500,17 +500,6 @@\n-+     init(true),\n-+ };\n-+ \n-+-opt<bool> StrongWorkspaceMode{\n-+-    \"strong-workspace-mode\",\n-+-    cat(Features),\n-+-    desc(\"An alternate mode of operation for clangd, where the clangd instance \"\n-+-         \"is used to edit a single workspace.\\n\"\n-+-         \"When enabled, fallback commands use the workspace directory as their \"\n-+-         \"working directory instead of the parent folder.\"),\n-+-    init(false),\n-+-    Hidden,\n-+-};\n-+-\n-+ opt<bool> UseDirtyHeaders{\"use-dirty-headers\", cat(Misc),\n-+                           desc(\"Use files open in the editor when parsing \"\n-+                                \"headers instead of reading from the disk\"),\n-+@@ -918,7 +907,6 @@\n-+   }\n-+   if (!ResourceDir.empty())\n-+     Opts.ResourceDir = ResourceDir;\n-+-  Opts.StrongWorkspaceMode = StrongWorkspaceMode;\n-+   Opts.BuildDynamicSymbolIndex = true;\n-+ #if CLANGD_ENABLE_REMOTE\n-+   if (RemoteIndexAddress.empty() != ProjectRoot.empty()) {\n-+diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp b/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n-+--- a/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n-++++ b/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n-+@@ -55,20 +55,6 @@\n-+                                            testPath(\"foo/bar\")));\n-+ }\n-+ \n-+-TEST(GlobalCompilationDatabaseTest, FallbackWorkingDirectory) {\n-+-  MockFS TFS;\n-+-  DirectoryBasedGlobalCompilationDatabase::Options CDBOpts(TFS);\n-+-  CDBOpts.applyFallbackWorkingDirectory(testPath(\"foo\"));\n-+-  EXPECT_EQ(CDBOpts.FallbackWorkingDirectory, testPath(\"foo\"));\n-+-\n-+-  DirectoryBasedGlobalCompilationDatabase DB(CDBOpts);\n-+-  auto Cmd = DB.getFallbackCommand(testPath(\"foo/src/bar.cc\"));\n-+-  EXPECT_EQ(Cmd.Directory, testPath(\"foo\"));\n-+-  EXPECT_THAT(Cmd.CommandLine,\n-+-              ElementsAre(\"clang\", testPath(\"foo/src/bar.cc\")));\n-+-  EXPECT_EQ(Cmd.Output, \"\");\n-+-}\n-+-\n-+ static tooling::CompileCommand cmd(llvm::StringRef File, llvm::StringRef Arg) {\n-+   return tooling::CompileCommand(\n-+       testRoot(), File, {\"clang\", std::string(Arg), std::string(File)}, \"\");\n-+diff -ruN --strip-trailing-cr a/llvm/lib/CodeGen/ShrinkWrap.cpp b/llvm/lib/CodeGen/ShrinkWrap.cpp\n-+--- a/llvm/lib/CodeGen/ShrinkWrap.cpp\n-++++ b/llvm/lib/CodeGen/ShrinkWrap.cpp\n-+@@ -618,8 +618,6 @@\n-+ \n-+   DenseSet<const MachineBasicBlock *> DirtyBBs;\n-+   for (MachineBasicBlock &MBB : MF) {\n-+-    if (!MDT->isReachableFromEntry(&MBB))\n-+-      continue;\n-+     if (MBB.isEHPad()) {\n-+       DirtyBBs.insert(&MBB);\n-+       continue;\n-+diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp b/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n-+--- a/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n-++++ b/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n-+@@ -708,53 +708,6 @@\n-+   return 2;\n-+ }\n-+ \n-+-bool llvm::optimizeTerminators(MachineBasicBlock *MBB,\n-+-                               const TargetInstrInfo &TII) {\n-+-  for (MachineInstr &MI : MBB->terminators()) {\n-+-    unsigned Opc = MI.getOpcode();\n-+-    switch (Opc) {\n-+-    case AArch64::CBZW:\n-+-    case AArch64::CBZX:\n-+-    case AArch64::TBZW:\n-+-    case AArch64::TBZX:\n-+-      // CBZ/TBZ with WZR/XZR -> unconditional B\n-+-      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n-+-          MI.getOperand(0).getReg() == AArch64::XZR) {\n-+-        DEBUG_WITH_TYPE(\"optimizeTerminators\",\n-+-                        dbgs() << \"Removing always taken branch: \" << MI);\n-+-        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n-+-        SmallVector<MachineBasicBlock *> Succs(MBB->successors());\n-+-        for (auto *S : Succs)\n-+-          if (S != Target)\n-+-            MBB->removeSuccessor(S);\n-+-        DebugLoc DL = MI.getDebugLoc();\n-+-        while (MBB->rbegin() != &MI)\n-+-          MBB->rbegin()->eraseFromParent();\n-+-        MI.eraseFromParent();\n-+-        BuildMI(MBB, DL, TII.get(AArch64::B)).addMBB(Target);\n-+-        return true;\n-+-      }\n-+-      break;\n-+-    case AArch64::CBNZW:\n-+-    case AArch64::CBNZX:\n-+-    case AArch64::TBNZW:\n-+-    case AArch64::TBNZX:\n-+-      // CBNZ/TBNZ with WZR/XZR -> never taken, remove branch and successor\n-+-      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n-+-          MI.getOperand(0).getReg() == AArch64::XZR) {\n-+-        DEBUG_WITH_TYPE(\"optimizeTerminators\",\n-+-                        dbgs() << \"Removing never taken branch: \" << MI);\n-+-        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n-+-        MI.getParent()->removeSuccessor(Target);\n-+-        MI.eraseFromParent();\n-+-        return true;\n-+-      }\n-+-      break;\n-+-    }\n-+-  }\n-+-  return false;\n-+-}\n-+-\n-+ // Find the original register that VReg is copied from.\n-+ static unsigned removeCopies(const MachineRegisterInfo &MRI, unsigned VReg) {\n-+   while (Register::isVirtualRegister(VReg)) {\n-+diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64InstrInfo.h b/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n-+--- a/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n-++++ b/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n-+@@ -705,8 +705,6 @@\n-+                               unsigned *OutUnscaledOp = nullptr,\n-+                               int64_t *EmittableOffset = nullptr);\n-+ \n-+-bool optimizeTerminators(MachineBasicBlock *MBB, const TargetInstrInfo &TII);\n-+-\n-+ static inline bool isUncondBranchOpcode(int Opc) { return Opc == AArch64::B; }\n-+ \n-+ static inline bool isCondBranchOpcode(int Opc) {\n-+diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp b/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n-+--- a/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n-++++ b/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n-+@@ -14,7 +14,6 @@\n-+ //===----------------------------------------------------------------------===//\n-+ \n-+ #include \"AArch64.h\"\n-+-#include \"AArch64InstrInfo.h\"\n-+ #include \"llvm/CodeGen/MachineFunctionPass.h\"\n-+ #include \"llvm/CodeGen/MachineInstrBuilder.h\"\n-+ #include \"llvm/CodeGen/TargetInstrInfo.h\"\n-+@@ -46,6 +45,51 @@\n-+                 \"AArch64 Redundant Conditional Branch Elimination pass\", false,\n-+                 false)\n-+ \n-++static bool optimizeTerminators(MachineBasicBlock *MBB,\n-++                                const TargetInstrInfo &TII) {\n-++  for (MachineInstr &MI : make_early_inc_range(MBB->terminators())) {\n-++    unsigned Opc = MI.getOpcode();\n-++    switch (Opc) {\n-++    case AArch64::CBZW:\n-++    case AArch64::CBZX:\n-++    case AArch64::TBZW:\n-++    case AArch64::TBZX:\n-++      // CBZ/TBZ with WZR/XZR -> unconditional B\n-++      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n-++          MI.getOperand(0).getReg() == AArch64::XZR) {\n-++        LLVM_DEBUG(dbgs() << \"Removing redundant branch: \" << MI);\n-++        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n-++        SmallVector<MachineBasicBlock *> Succs(MBB->successors());\n-++        for (auto *S : Succs)\n-++          if (S != Target)\n-++            MBB->removeSuccessor(S);\n-++        DebugLoc DL = MI.getDebugLoc();\n-++        while (MBB->rbegin() != &MI)\n-++          MBB->rbegin()->eraseFromParent();\n-++        MI.eraseFromParent();\n-++        BuildMI(MBB, DL, TII.get(AArch64::B)).addMBB(Target);\n-++        return true;\n-++      }\n-++      break;\n-++    case AArch64::CBNZW:\n-++    case AArch64::CBNZX:\n-++    case AArch64::TBNZW:\n-++    case AArch64::TBNZX:\n-++      // CBNZ/TBNZ with WZR/XZR -> never taken, remove branch and successor\n-++      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n-++          MI.getOperand(0).getReg() == AArch64::XZR) {\n-++        LLVM_DEBUG(dbgs() << \"Removing redundant branch: \" << MI);\n-++        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n-++        MI.getParent()->removeSuccessor(Target);\n-++        MI.eraseFromParent();\n-++        return true;\n-++      }\n-++      break;\n-++    }\n-++  }\n-++  return false;\n-++}\n-++\n-+ bool AArch64RedundantCondBranch::runOnMachineFunction(MachineFunction &MF) {\n-+   if (skipFunction(MF.getFunction()))\n-+     return false;\n-+diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp b/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n-+--- a/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n-++++ b/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n-+@@ -50,7 +50,6 @@\n-+ //        to use WZR/XZR directly in some cases.\n-+ //===----------------------------------------------------------------------===//\n-+ #include \"AArch64.h\"\n-+-#include \"AArch64InstrInfo.h\"\n-+ #include \"llvm/ADT/SetVector.h\"\n-+ #include \"llvm/ADT/Statistic.h\"\n-+ #include \"llvm/ADT/iterator_range.h\"\n-+@@ -476,7 +475,6 @@\n-+     return false;\n-+   TRI = MF.getSubtarget().getRegisterInfo();\n-+   MRI = &MF.getRegInfo();\n-+-  const TargetInstrInfo &TII = *MF.getSubtarget().getInstrInfo();\n-+ \n-+   // Resize the clobbered and used register unit trackers.  We do this once per\n-+   // function.\n-+@@ -486,10 +484,8 @@\n-+   OptBBUsedRegs.init(*TRI);\n-+ \n-+   bool Changed = false;\n-+-  for (MachineBasicBlock &MBB : MF) {\n-+-    Changed |= optimizeTerminators(&MBB, TII);\n-++  for (MachineBasicBlock &MBB : MF)\n-+     Changed |= optimizeBlock(&MBB);\n-+-  }\n-+   return Changed;\n-+ }\n-+ \n-+diff -ruN --strip-trailing-cr a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n-+--- a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n-++++ b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n-+@@ -1827,12 +1827,8 @@\n-+     // profile info.\n-+     CostTooHigh =\n-+         LAI.getNumRuntimePointerChecks() > VectorizeMemoryCheckThreshold;\n-+-    if (CostTooHigh) {\n-+-      // Mark runtime checks as never succeeding when they exceed the threshold.\n-+-      MemRuntimeCheckCond = ConstantInt::getTrue(L->getHeader()->getContext());\n-+-      SCEVCheckCond = ConstantInt::getTrue(L->getHeader()->getContext());\n-++    if (CostTooHigh)\n-+       return;\n-+-    }\n-+ \n-+     BasicBlock *LoopHeader = L->getHeader();\n-+     BasicBlock *Preheader = L->getLoopPreheader();\n-+diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll b/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n-+--- a/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n-++++ b/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n-+@@ -735,15 +735,21 @@\n-+ ; ENABLE-NEXT:    .cfi_offset w29, -16\n-+ ; ENABLE-NEXT:    .cfi_offset w19, -24\n-+ ; ENABLE-NEXT:    .cfi_offset w20, -32\n-++; ENABLE-NEXT:  ; %bb.1: ; %if.then\n-+ ; ENABLE-NEXT:    sub x19, sp, #16\n-+ ; ENABLE-NEXT:    mov sp, x19\n-+ ; ENABLE-NEXT:    mov w20, wzr\n-+-; ENABLE-NEXT:  LBB10_1: ; %for.body\n-++; ENABLE-NEXT:  LBB10_2: ; %for.body\n-+ ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n-+ ; ENABLE-NEXT:    bl _something\n-+ ; ENABLE-NEXT:    add w20, w0, w20\n-+ ; ENABLE-NEXT:    str w20, [x19]\n-+-; ENABLE-NEXT:    b LBB10_1\n-++; ENABLE-NEXT:    b LBB10_2\n-++; ENABLE-NEXT:  ; %bb.3: ; %if.end\n-++; ENABLE-NEXT:    sub sp, x29, #16\n-++; ENABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-++; ENABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-++; ENABLE-NEXT:    ret\n-+ ;\n-+ ; DISABLE-LABEL: infiniteloop:\n-+ ; DISABLE:       ; %bb.0: ; %entry\n-+@@ -755,15 +761,21 @@\n-+ ; DISABLE-NEXT:    .cfi_offset w29, -16\n-+ ; DISABLE-NEXT:    .cfi_offset w19, -24\n-+ ; DISABLE-NEXT:    .cfi_offset w20, -32\n-++; DISABLE-NEXT:  ; %bb.1: ; %if.then\n-+ ; DISABLE-NEXT:    sub x19, sp, #16\n-+ ; DISABLE-NEXT:    mov sp, x19\n-+ ; DISABLE-NEXT:    mov w20, wzr\n-+-; DISABLE-NEXT:  LBB10_1: ; %for.body\n-++; DISABLE-NEXT:  LBB10_2: ; %for.body\n-+ ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n-+ ; DISABLE-NEXT:    bl _something\n-+ ; DISABLE-NEXT:    add w20, w0, w20\n-+ ; DISABLE-NEXT:    str w20, [x19]\n-+-; DISABLE-NEXT:    b LBB10_1\n-++; DISABLE-NEXT:    b LBB10_2\n-++; DISABLE-NEXT:  ; %bb.3: ; %if.end\n-++; DISABLE-NEXT:    sub sp, x29, #16\n-++; DISABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-++; DISABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-++; DISABLE-NEXT:    ret\n-+ entry:\n-+   br i1 undef, label %if.then, label %if.end\n-+ \n-+@@ -794,10 +806,11 @@\n-+ ; ENABLE-NEXT:    .cfi_offset w29, -16\n-+ ; ENABLE-NEXT:    .cfi_offset w19, -24\n-+ ; ENABLE-NEXT:    .cfi_offset w20, -32\n-++; ENABLE-NEXT:  ; %bb.1: ; %if.then\n-+ ; ENABLE-NEXT:    sub x8, sp, #16\n-+ ; ENABLE-NEXT:    mov sp, x8\n-+ ; ENABLE-NEXT:    mov w9, wzr\n-+-; ENABLE-NEXT:  LBB11_1: ; %for.body\n-++; ENABLE-NEXT:  LBB11_2: ; %for.body\n-+ ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n-+ ; ENABLE-NEXT:    ; InlineAsm Start\n-+ ; ENABLE-NEXT:    mov x10, #0 ; =0x0\n-+@@ -808,7 +821,12 @@\n-+ ; ENABLE-NEXT:    ; InlineAsm Start\n-+ ; ENABLE-NEXT:    nop\n-+ ; ENABLE-NEXT:    ; InlineAsm End\n-+-; ENABLE-NEXT:    b LBB11_1\n-++; ENABLE-NEXT:    b LBB11_2\n-++; ENABLE-NEXT:  ; %bb.3: ; %if.end\n-++; ENABLE-NEXT:    sub sp, x29, #16\n-++; ENABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-++; ENABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-++; ENABLE-NEXT:    ret\n-+ ;\n-+ ; DISABLE-LABEL: infiniteloop2:\n-+ ; DISABLE:       ; %bb.0: ; %entry\n-+@@ -820,10 +838,11 @@\n-+ ; DISABLE-NEXT:    .cfi_offset w29, -16\n-+ ; DISABLE-NEXT:    .cfi_offset w19, -24\n-+ ; DISABLE-NEXT:    .cfi_offset w20, -32\n-++; DISABLE-NEXT:  ; %bb.1: ; %if.then\n-+ ; DISABLE-NEXT:    sub x8, sp, #16\n-+ ; DISABLE-NEXT:    mov sp, x8\n-+ ; DISABLE-NEXT:    mov w9, wzr\n-+-; DISABLE-NEXT:  LBB11_1: ; %for.body\n-++; DISABLE-NEXT:  LBB11_2: ; %for.body\n-+ ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n-+ ; DISABLE-NEXT:    ; InlineAsm Start\n-+ ; DISABLE-NEXT:    mov x10, #0 ; =0x0\n-+@@ -834,7 +853,12 @@\n-+ ; DISABLE-NEXT:    ; InlineAsm Start\n-+ ; DISABLE-NEXT:    nop\n-+ ; DISABLE-NEXT:    ; InlineAsm End\n-+-; DISABLE-NEXT:    b LBB11_1\n-++; DISABLE-NEXT:    b LBB11_2\n-++; DISABLE-NEXT:  ; %bb.3: ; %if.end\n-++; DISABLE-NEXT:    sub sp, x29, #16\n-++; DISABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n-++; DISABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n-++; DISABLE-NEXT:    ret\n-+ entry:\n-+   br i1 undef, label %if.then, label %if.end\n-+ \n-+@@ -865,43 +889,49 @@\n-+ define void @infiniteloop3() {\n-+ ; ENABLE-LABEL: infiniteloop3:\n-+ ; ENABLE:       ; %bb.0: ; %entry\n-++; ENABLE-NEXT:  ; %bb.1: ; %loop2a.preheader\n-+ ; ENABLE-NEXT:    mov x8, xzr\n-+ ; ENABLE-NEXT:    mov x9, xzr\n-+ ; ENABLE-NEXT:    mov x11, xzr\n-+-; ENABLE-NEXT:    b LBB12_2\n-+-; ENABLE-NEXT:  LBB12_1: ; %loop2b\n-+-; ENABLE-NEXT:    ; in Loop: Header=BB12_2 Depth=1\n-++; ENABLE-NEXT:    b LBB12_3\n-++; ENABLE-NEXT:  LBB12_2: ; %loop2b\n-++; ENABLE-NEXT:    ; in Loop: Header=BB12_3 Depth=1\n-+ ; ENABLE-NEXT:    str x10, [x11]\n-+ ; ENABLE-NEXT:    mov x11, x10\n-+-; ENABLE-NEXT:  LBB12_2: ; %loop1\n-++; ENABLE-NEXT:  LBB12_3: ; %loop1\n-+ ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n-+ ; ENABLE-NEXT:    mov x10, x9\n-+ ; ENABLE-NEXT:    ldr x9, [x8]\n-+-; ENABLE-NEXT:    cbnz x8, LBB12_1\n-+-; ENABLE-NEXT:  ; %bb.3: ; in Loop: Header=BB12_2 Depth=1\n-++; ENABLE-NEXT:    cbnz x8, LBB12_2\n-++; ENABLE-NEXT:  ; %bb.4: ; in Loop: Header=BB12_3 Depth=1\n-+ ; ENABLE-NEXT:    mov x8, x10\n-+ ; ENABLE-NEXT:    mov x11, x10\n-+-; ENABLE-NEXT:    b LBB12_2\n-++; ENABLE-NEXT:    b LBB12_3\n-++; ENABLE-NEXT:  ; %bb.5: ; %end\n-++; ENABLE-NEXT:    ret\n-+ ;\n-+ ; DISABLE-LABEL: infiniteloop3:\n-+ ; DISABLE:       ; %bb.0: ; %entry\n-++; DISABLE-NEXT:  ; %bb.1: ; %loop2a.preheader\n-+ ; DISABLE-NEXT:    mov x8, xzr\n-+ ; DISABLE-NEXT:    mov x9, xzr\n-+ ; DISABLE-NEXT:    mov x11, xzr\n-+-; DISABLE-NEXT:    b LBB12_2\n-+-; DISABLE-NEXT:  LBB12_1: ; %loop2b\n-+-; DISABLE-NEXT:    ; in Loop: Header=BB12_2 Depth=1\n-++; DISABLE-NEXT:    b LBB12_3\n-++; DISABLE-NEXT:  LBB12_2: ; %loop2b\n-++; DISABLE-NEXT:    ; in Loop: Header=BB12_3 Depth=1\n-+ ; DISABLE-NEXT:    str x10, [x11]\n-+ ; DISABLE-NEXT:    mov x11, x10\n-+-; DISABLE-NEXT:  LBB12_2: ; %loop1\n-++; DISABLE-NEXT:  LBB12_3: ; %loop1\n-+ ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n-+ ; DISABLE-NEXT:    mov x10, x9\n-+ ; DISABLE-NEXT:    ldr x9, [x8]\n-+-; DISABLE-NEXT:    cbnz x8, LBB12_1\n-+-; DISABLE-NEXT:  ; %bb.3: ; in Loop: Header=BB12_2 Depth=1\n-++; DISABLE-NEXT:    cbnz x8, LBB12_2\n-++; DISABLE-NEXT:  ; %bb.4: ; in Loop: Header=BB12_3 Depth=1\n-+ ; DISABLE-NEXT:    mov x8, x10\n-+ ; DISABLE-NEXT:    mov x11, x10\n-+-; DISABLE-NEXT:    b LBB12_2\n-++; DISABLE-NEXT:    b LBB12_3\n-++; DISABLE-NEXT:  ; %bb.5: ; %end\n-++; DISABLE-NEXT:    ret\n-+ entry:\n-+   br i1 undef, label %loop2a, label %body\n-+ \n-+diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll b/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n-+--- a/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n-++++ b/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n-+@@ -8,14 +8,20 @@\n-+ define i8 @foo_optsize(i32 %v4) optsize {\n-+ ; CHECK-LABEL: foo_optsize:\n-+ ; CHECK:       // %bb.0: // %entry\n-+-; CHECK-NEXT:    cbnz w0, .LBB0_2\n-+-; CHECK-NEXT:  // %bb.1: // %b2\n-+-; CHECK-NEXT:    mov w0, #1 // =0x1\n-++; CHECK-NEXT:    b .LBB0_2\n-++; CHECK-NEXT:  .LBB0_1:\n-++; CHECK-NEXT:    mov w0, wzr\n-+ ; CHECK-NEXT:    ret\n-+ ; CHECK-NEXT:  .LBB0_2: // %b1\n-+-; CHECK-NEXT:    cmp w0, #1\n-+-; CHECK-NEXT:    mov w0, wzr\n-++; CHECK-NEXT:    cbnz w0, .LBB0_4\n-++; CHECK-NEXT:  // %bb.3: // %b2\n-++; CHECK-NEXT:    mov w0, #1 // =0x1\n-+ ; CHECK-NEXT:    ret\n-++; CHECK-NEXT:  .LBB0_4: // %b1\n-++; CHECK-NEXT:    cmp w0, #1\n-++; CHECK-NEXT:    b.ne .LBB0_1\n-++; CHECK-NEXT:  // %bb.5: // %b3\n-++; CHECK-NEXT:    b .LBB0_1\n-+ entry:\n-+   %v2 = icmp eq i32 0, 0\n-+   br i1 %v2, label %b1, label %b4\n-+@@ -41,14 +47,20 @@\n-+ define i8 @foo_optspeed(i32 %v4) {\n-+ ; CHECK-LABEL: foo_optspeed:\n-+ ; CHECK:       // %bb.0: // %entry\n-+-; CHECK-NEXT:    cbnz w0, .LBB1_2\n-+-; CHECK-NEXT:  // %bb.1: // %b2\n-+-; CHECK-NEXT:    mov w0, #1 // =0x1\n-++; CHECK-NEXT:    b .LBB1_2\n-++; CHECK-NEXT:  .LBB1_1:\n-++; CHECK-NEXT:    mov w0, wzr\n-+ ; CHECK-NEXT:    ret\n-+ ; CHECK-NEXT:  .LBB1_2: // %b1\n-+-; CHECK-NEXT:    cmp w0, #1\n-+-; CHECK-NEXT:    mov w0, wzr\n-++; CHECK-NEXT:    cbnz w0, .LBB1_4\n-++; CHECK-NEXT:  // %bb.3: // %b2\n-++; CHECK-NEXT:    mov w0, #1 // =0x1\n-+ ; CHECK-NEXT:    ret\n-++; CHECK-NEXT:  .LBB1_4: // %b1\n-++; CHECK-NEXT:    cmp w0, #1\n-++; CHECK-NEXT:    b.ne .LBB1_1\n-++; CHECK-NEXT:  // %bb.5: // %b3\n-++; CHECK-NEXT:    b .LBB1_1\n-+ entry:\n-+   %v2 = icmp eq i32 0, 0\n-+   br i1 %v2, label %b1, label %b4\n-+diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll b/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n-+--- a/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n-++++ b/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n-+@@ -21,8 +21,10 @@\n-+   ; CHECK-NEXT:   B %bb.3\n-+   ; CHECK-NEXT: {{  $}}\n-+   ; CHECK-NEXT: bb.1.bb:\n-++  ; CHECK-NEXT:   successors: %bb.3(0x2aaaaaab), %bb.2(0x55555555)\n-+   ; CHECK-NEXT:   liveins: $w0, $lr\n-+   ; CHECK-NEXT: {{  $}}\n-++  ; CHECK-NEXT:   CBNZW $wzr, %bb.3\n-+   ; CHECK-NEXT:   B %bb.2\n-+   ; CHECK-NEXT: {{  $}}\n-+   ; CHECK-NEXT: bb.2.bb1:\n-+diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/pr164181.ll b/llvm/test/CodeGen/AArch64/pr164181.ll\n-+--- a/llvm/test/CodeGen/AArch64/pr164181.ll\n-++++ b/llvm/test/CodeGen/AArch64/pr164181.ll\n-+@@ -29,11 +29,11 @@\n-+ ; CHECK-NEXT:    str w4, [sp, #72] // 4-byte Spill\n-+ ; CHECK-NEXT:    str w3, [sp, #112] // 4-byte Spill\n-+ ; CHECK-NEXT:    str w5, [sp, #36] // 4-byte Spill\n-+-; CHECK-NEXT:    tbz w5, #0, .LBB0_40\n-++; CHECK-NEXT:    tbz w5, #0, .LBB0_43\n-+ ; CHECK-NEXT:  // %bb.1: // %for.body41.lr.ph\n-+ ; CHECK-NEXT:    ldr x4, [sp, #312]\n-+ ; CHECK-NEXT:    ldr x14, [sp, #280]\n-+-; CHECK-NEXT:    tbz w0, #0, .LBB0_39\n-++; CHECK-NEXT:    tbz w0, #0, .LBB0_42\n-+ ; CHECK-NEXT:  // %bb.2: // %for.body41.us.preheader\n-+ ; CHECK-NEXT:    ldrb w8, [sp, #368]\n-+ ; CHECK-NEXT:    ldrb w12, [sp, #256]\n-+@@ -92,7 +92,7 @@\n-+ ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n-+ ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n-+ ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n-+-; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-++; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n-+ ; CHECK-NEXT:    ldr w8, [sp, #20] // 4-byte Reload\n-+ ; CHECK-NEXT:    mov x12, x24\n-+ ; CHECK-NEXT:    str x24, [sp, #48] // 8-byte Spill\n-+@@ -117,7 +117,7 @@\n-+ ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n-+ ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n-+ ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n-+-; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-++; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n-+ ; CHECK-NEXT:    str x12, [sp, #40] // 8-byte Spill\n-+ ; CHECK-NEXT:    cmn x24, #30\n-+ ; CHECK-NEXT:    mov x12, #-30 // =0xffffffffffffffe2\n-+@@ -142,7 +142,7 @@\n-+ ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n-+ ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n-+ ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n-+-; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-++; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n-+ ; CHECK-NEXT:    ldr x8, [sp, #64] // 8-byte Reload\n-+ ; CHECK-NEXT:    mov w14, #1152 // =0x480\n-+ ; CHECK-NEXT:    mov w24, #1 // =0x1\n-+@@ -176,7 +176,7 @@\n-+ ; CHECK-NEXT:    // => This Loop Header: Depth=4\n-+ ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n-+ ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n-+-; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n-++; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n-+ ; CHECK-NEXT:    ldr w8, [sp, #116] // 4-byte Reload\n-+ ; CHECK-NEXT:    and w8, w8, w8, asr #31\n-+ ; CHECK-NEXT:    str w8, [sp, #128] // 4-byte Spill\n-+@@ -281,23 +281,31 @@\n-+ ; CHECK-NEXT:    mov x24, xzr\n-+ ; CHECK-NEXT:    mul w12, w12, w22\n-+ ; CHECK-NEXT:    mov x22, x5\n-+-; CHECK-NEXT:    tbz w0, #0, .LBB0_33\n-+-; CHECK-NEXT:  .LBB0_28: // %if.then222.us\n-++; CHECK-NEXT:    tbz w0, #0, .LBB0_36\n-++; CHECK-NEXT:  .LBB0_28: // %for.body194.us\n-+ ; CHECK-NEXT:    // Parent Loop BB0_4 Depth=1\n-+ ; CHECK-NEXT:    // Parent Loop BB0_6 Depth=2\n-+ ; CHECK-NEXT:    // Parent Loop BB0_8 Depth=3\n-+ ; CHECK-NEXT:    // Parent Loop BB0_10 Depth=4\n-+ ; CHECK-NEXT:    // => This Inner Loop Header: Depth=5\n-++; CHECK-NEXT:  // %bb.29: // %if.then222.us\n-++; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n-+ ; CHECK-NEXT:    adrp x27, :got:var_32\n-+ ; CHECK-NEXT:    ldur w8, [x19, #-12]\n-+ ; CHECK-NEXT:    ldr x27, [x27, :got_lo12:var_32]\n-+ ; CHECK-NEXT:    strh w8, [x27]\n-+ ; CHECK-NEXT:    sxtb w8, w25\n-+-; CHECK-NEXT:    strb w3, [x16]\n-+ ; CHECK-NEXT:    bic w25, w8, w8, asr #31\n-++; CHECK-NEXT:    b .LBB0_31\n-++; CHECK-NEXT:    .p2align 5, , 16\n-++; CHECK-NEXT:  // %bb.30:\n-++; CHECK-NEXT:    mov w25, wzr\n-++; CHECK-NEXT:  .LBB0_31: // %if.end239.us\n-++; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n-++; CHECK-NEXT:    strb w3, [x16]\n-+ ; CHECK-NEXT:    tst w13, #0xff\n-+-; CHECK-NEXT:    b.eq .LBB0_30\n-+-; CHECK-NEXT:  // %bb.29: // %if.then254.us\n-++; CHECK-NEXT:    b.eq .LBB0_33\n-++; CHECK-NEXT:  // %bb.32: // %if.then254.us\n-+ ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n-+ ; CHECK-NEXT:    ldrh w8, [x26, x14, lsl #1]\n-+ ; CHECK-NEXT:    adrp x27, :got:var_35\n-+@@ -306,7 +314,7 @@\n-+ ; CHECK-NEXT:    csel x8, xzr, x7, eq\n-+ ; CHECK-NEXT:    str x8, [x27]\n-+ ; CHECK-NEXT:    strh w1, [x17]\n-+-; CHECK-NEXT:  .LBB0_30: // %if.end282.us\n-++; CHECK-NEXT:  .LBB0_33: // %if.end282.us\n-+ ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n-+ ; CHECK-NEXT:    orr x27, x24, x4\n-+ ; CHECK-NEXT:    adrp x8, :got:var_39\n-+@@ -317,14 +325,14 @@\n-+ ; CHECK-NEXT:    str x8, [x18]\n-+ ; CHECK-NEXT:    mov w8, #1 // =0x1\n-+ ; CHECK-NEXT:    cbnz x2, .LBB0_27\n-+-; CHECK-NEXT:  // %bb.31: // %if.then327.us\n-++; CHECK-NEXT:  // %bb.34: // %if.then327.us\n-+ ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n-+ ; CHECK-NEXT:    cbz w8, .LBB0_25\n-+-; CHECK-NEXT:  // %bb.32: // in Loop: Header=BB0_28 Depth=5\n-++; CHECK-NEXT:  // %bb.35: // in Loop: Header=BB0_28 Depth=5\n-+ ; CHECK-NEXT:    mov w4, wzr\n-+ ; CHECK-NEXT:    b .LBB0_26\n-+ ; CHECK-NEXT:    .p2align 5, , 16\n-+-; CHECK-NEXT:  .LBB0_33: // %for.cond376.preheader.us\n-++; CHECK-NEXT:  .LBB0_36: // %for.cond376.preheader.us\n-+ ; CHECK-NEXT:    // in Loop: Header=BB0_10 Depth=4\n-+ ; CHECK-NEXT:    mov w3, #1152 // =0x480\n-+ ; CHECK-NEXT:    mov x22, xzr\n-+@@ -335,24 +343,24 @@\n-+ ; CHECK-NEXT:    madd x14, x14, x3, x11\n-+ ; CHECK-NEXT:    mov w28, w30\n-+ ; CHECK-NEXT:    mov w3, #-7680 // =0xffffe200\n-+-; CHECK-NEXT:    b .LBB0_36\n-++; CHECK-NEXT:    b .LBB0_39\n-+ ; CHECK-NEXT:    .p2align 5, , 16\n-+-; CHECK-NEXT:  .LBB0_34: // %if.then466.us\n-+-; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n-++; CHECK-NEXT:  .LBB0_37: // %if.then466.us\n-++; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n-+ ; CHECK-NEXT:    ldr x28, [sp, #152] // 8-byte Reload\n-+ ; CHECK-NEXT:    ldr x3, [sp, #136] // 8-byte Reload\n-+ ; CHECK-NEXT:    sxtb w4, w4\n-+ ; CHECK-NEXT:    bic w4, w4, w4, asr #31\n-+ ; CHECK-NEXT:    str x3, [x28]\n-+ ; CHECK-NEXT:    mov w3, #-7680 // =0xffffe200\n-+-; CHECK-NEXT:  .LBB0_35: // %for.inc505.us\n-+-; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n-++; CHECK-NEXT:  .LBB0_38: // %for.inc505.us\n-++; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n-+ ; CHECK-NEXT:    add x22, x22, #1\n-+ ; CHECK-NEXT:    add x27, x27, #1\n-+ ; CHECK-NEXT:    mov w28, wzr\n-+ ; CHECK-NEXT:    cmp x27, #0\n-+ ; CHECK-NEXT:    b.hs .LBB0_9\n-+-; CHECK-NEXT:  .LBB0_36: // %for.body380.us\n-++; CHECK-NEXT:  .LBB0_39: // %for.body380.us\n-+ ; CHECK-NEXT:    // Parent Loop BB0_4 Depth=1\n-+ ; CHECK-NEXT:    // Parent Loop BB0_6 Depth=2\n-+ ; CHECK-NEXT:    // Parent Loop BB0_8 Depth=3\n-+@@ -364,18 +372,18 @@\n-+ ; CHECK-NEXT:    strh w28, [x11]\n-+ ; CHECK-NEXT:    csel w28, w21, w3, ne\n-+ ; CHECK-NEXT:    str w28, [x20]\n-+-; CHECK-NEXT:    cbz x15, .LBB0_35\n-+-; CHECK-NEXT:  // %bb.37: // %if.then436.us\n-+-; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n-++; CHECK-NEXT:    cbz x15, .LBB0_38\n-++; CHECK-NEXT:  // %bb.40: // %if.then436.us\n-++; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n-+ ; CHECK-NEXT:    ldrh w28, [x14]\n-+-; CHECK-NEXT:    cbnz w28, .LBB0_34\n-+-; CHECK-NEXT:  // %bb.38: // in Loop: Header=BB0_36 Depth=5\n-++; CHECK-NEXT:    cbnz w28, .LBB0_37\n-++; CHECK-NEXT:  // %bb.41: // in Loop: Header=BB0_39 Depth=5\n-+ ; CHECK-NEXT:    mov w4, wzr\n-+-; CHECK-NEXT:    b .LBB0_35\n-+-; CHECK-NEXT:  .LBB0_39: // %for.body41\n-++; CHECK-NEXT:    b .LBB0_38\n-++; CHECK-NEXT:  .LBB0_42: // %for.body41\n-+ ; CHECK-NEXT:    strb wzr, [x4]\n-+ ; CHECK-NEXT:    strb wzr, [x14]\n-+-; CHECK-NEXT:  .LBB0_40: // %for.cond563.preheader\n-++; CHECK-NEXT:  .LBB0_43: // %for.cond563.preheader\n-+ ; CHECK-NEXT:    ldp x20, x19, [sp, #224] // 16-byte Folded Reload\n-+ ; CHECK-NEXT:    ldp x22, x21, [sp, #208] // 16-byte Folded Reload\n-+ ; CHECK-NEXT:    ldp x24, x23, [sp, #192] // 16-byte Folded Reload\n-+diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/pr166870.ll b/llvm/test/CodeGen/AArch64/pr166870.ll\n-+--- a/llvm/test/CodeGen/AArch64/pr166870.ll\n-++++ b/llvm/test/CodeGen/AArch64/pr166870.ll\n-+@@ -26,11 +26,12 @@\n-+ ; CHECK-NEXT:    mov x21, x1\n-+ ; CHECK-NEXT:    bl baz\n-+ ; CHECK-NEXT:    mov w0, #0 // =0x0\n-++; CHECK-NEXT:  // %bb.5: // %bb6\n-+ ; CHECK-NEXT:    mov w10, #1 // =0x1\n-++; CHECK-NEXT:    cbnz w10, .LBB0_11\n-++; CHECK-NEXT:  // %bb.6: // %bb7\n-+ ; CHECK-NEXT:    cbnz w10, .LBB0_10\n-+-; CHECK-NEXT:  // %bb.5: // %bb7\n-+-; CHECK-NEXT:    cbnz w10, .LBB0_9\n-+-; CHECK-NEXT:  // %bb.6: // %bb8\n-++; CHECK-NEXT:  // %bb.7: // %bb8\n-+ ; CHECK-NEXT:    mov x8, x21\n-+ ; CHECK-NEXT:    mov x9, x20\n-+ ; CHECK-NEXT:    mov w20, #0 // =0x0\n-+@@ -38,17 +39,17 @@\n-+ ; CHECK-NEXT:    mov x21, x9\n-+ ; CHECK-NEXT:    mov w8, w8\n-+ ; CHECK-NEXT:    mov x22, x8\n-+-; CHECK-NEXT:  .LBB0_7: // %bb10\n-++; CHECK-NEXT:  .LBB0_8: // %bb10\n-+ ; CHECK-NEXT:    // =>This Inner Loop Header: Depth=1\n-+ ; CHECK-NEXT:    strb w20, [x19]\n-+-; CHECK-NEXT:    cbnz x21, .LBB0_7\n-+-; CHECK-NEXT:  // %bb.8: // %bb12\n-+-; CHECK-NEXT:    // in Loop: Header=BB0_7 Depth=1\n-++; CHECK-NEXT:    cbnz x21, .LBB0_8\n-++; CHECK-NEXT:  // %bb.9: // %bb12\n-++; CHECK-NEXT:    // in Loop: Header=BB0_8 Depth=1\n-+ ; CHECK-NEXT:    bl snork\n-+-; CHECK-NEXT:    cbnz x22, .LBB0_7\n-+-; CHECK-NEXT:  .LBB0_9:\n-+-; CHECK-NEXT:    mov w0, #0 // =0x0\n-++; CHECK-NEXT:    cbnz x22, .LBB0_8\n-+ ; CHECK-NEXT:  .LBB0_10:\n-++; CHECK-NEXT:    mov w0, #0 // =0x0\n-++; CHECK-NEXT:  .LBB0_11:\n-+ ; CHECK-NEXT:    ldp x20, x19, [sp, #32] // 16-byte Folded Reload\n-+ ; CHECK-NEXT:    ldp x22, x21, [sp, #16] // 16-byte Folded Reload\n-+ ; CHECK-NEXT:    ldr x30, [sp], #48 // 8-byte Folded Reload\n-+diff -ruN --strip-trailing-cr a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n-+--- a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n-++++ b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n-+@@ -71,21 +71,27 @@\n-+ ; CHECK-NEXT:    .cfi_def_cfa w29, 16\n-+ ; CHECK-NEXT:    .cfi_offset w30, -8\n-+ ; CHECK-NEXT:    .cfi_offset w29, -16\n-++; CHECK-NEXT:    .cfi_remember_state\n-+ ; CHECK-NEXT:    mov w8, #1 // =0x1\n-+-; CHECK-NEXT:    mov w9, #2 // =0x2\n-+ ; CHECK-NEXT:    stur xzr, [x29, #-8]\n-+-; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+-; CHECK-NEXT:    ldur w8, [x29, #-8]\n-+-; CHECK-NEXT:    cbz w8, .LBB0_2\n-++; CHECK-NEXT:    b .LBB0_3\n-+ ; CHECK-NEXT:  // %bb.1:\n-+-; CHECK-NEXT:    mov w8, #1 // =0x1\n-+ ; CHECK-NEXT:    str w8, [sp, #16]\n-+-; CHECK-NEXT:    b .LBB0_3\n-++; CHECK-NEXT:    ldur w8, [x29, #-8]\n-++; CHECK-NEXT:    cbz w8, .LBB0_4\n-+ ; CHECK-NEXT:  .LBB0_2:\n-++; CHECK-NEXT:    .cfi_restore_state\n-+ ; CHECK-NEXT:    mov w8, #1 // =0x1\n-+-; CHECK-NEXT:    mov w9, #2 // =0x2\n-+-; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-++; CHECK-NEXT:    str w8, [sp, #16]\n-++; CHECK-NEXT:    b .LBB0_5\n-+ ; CHECK-NEXT:  .LBB0_3:\n-++; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-++; CHECK-NEXT:    ldur w8, [x29, #-8]\n-++; CHECK-NEXT:    cbnz w8, .LBB0_2\n-++; CHECK-NEXT:  .LBB0_4:\n-++; CHECK-NEXT:    mov w8, #1 // =0x1\n-++; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-++; CHECK-NEXT:  .LBB0_5:\n-+ ; CHECK-NEXT:    mov w0, wzr\n-+ ; CHECK-NEXT:    .cfi_def_cfa wsp, 48\n-+ ; CHECK-NEXT:    ldp x29, x30, [sp, #32] // 16-byte Folded Reload\n-+@@ -128,6 +134,7 @@\n-+ ;\n-+ ; CHECK-LABEL: OUTLINED_FUNCTION_0:\n-+ ; CHECK:       // %bb.0:\n-++; CHECK-NEXT:    mov w9, #2 // =0x2\n-+ ; CHECK-NEXT:    stp w9, w8, [x29, #-12]\n-+ ; CHECK-NEXT:    mov w9, #3 // =0x3\n-+ ; CHECK-NEXT:    mov w8, #4 // =0x4\n-+diff -ruN --strip-trailing-cr a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n-+--- a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n-++++ b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n-+@@ -12,21 +12,27 @@\n-+ ; CHECK-NEXT:    .cfi_def_cfa w29, 16\n-+ ; CHECK-NEXT:    .cfi_offset w30, -8\n-+ ; CHECK-NEXT:    .cfi_offset w29, -16\n-++; CHECK-NEXT:    .cfi_remember_state\n-+ ; CHECK-NEXT:    mov w8, #1 // =0x1\n-+-; CHECK-NEXT:    mov w9, #2 // =0x2\n-+ ; CHECK-NEXT:    stur xzr, [x29, #-8]\n-+-; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-+-; CHECK-NEXT:    ldur w8, [x29, #-8]\n-+-; CHECK-NEXT:    cbz w8, .LBB0_2\n-++; CHECK-NEXT:    b .LBB0_3\n-+ ; CHECK-NEXT:  // %bb.1:\n-+-; CHECK-NEXT:    mov w8, #1 // =0x1\n-+ ; CHECK-NEXT:    str w8, [sp, #16]\n-+-; CHECK-NEXT:    b .LBB0_3\n-++; CHECK-NEXT:    ldur w8, [x29, #-8]\n-++; CHECK-NEXT:    cbz w8, .LBB0_4\n-+ ; CHECK-NEXT:  .LBB0_2:\n-++; CHECK-NEXT:    .cfi_restore_state\n-+ ; CHECK-NEXT:    mov w8, #1 // =0x1\n-+-; CHECK-NEXT:    mov w9, #2 // =0x2\n-+-; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-++; CHECK-NEXT:    str w8, [sp, #16]\n-++; CHECK-NEXT:    b .LBB0_5\n-+ ; CHECK-NEXT:  .LBB0_3:\n-++; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-++; CHECK-NEXT:    ldur w8, [x29, #-8]\n-++; CHECK-NEXT:    cbnz w8, .LBB0_2\n-++; CHECK-NEXT:  .LBB0_4:\n-++; CHECK-NEXT:    mov w8, #1 // =0x1\n-++; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n-++; CHECK-NEXT:  .LBB0_5:\n-+ ; CHECK-NEXT:    mov w0, wzr\n-+ ; CHECK-NEXT:    .cfi_def_cfa wsp, 48\n-+ ; CHECK-NEXT:    ldp x29, x30, [sp, #32] // 16-byte Folded Reload\n-+diff -ruN --strip-trailing-cr a/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll b/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n-+--- a/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n-++++ b/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n-+@@ -2,23 +2,29 @@\n-+ ; RUN: opt -p loop-vectorize -vectorize-memory-check-threshold=0 -S %s | FileCheck --check-prefix=LIMIT0 %s\n-+ ; RUN: opt -p loop-vectorize -vectorize-memory-check-threshold=1 -S %s | FileCheck --check-prefix=LIMIT1 %s\n-+ \n-+-; Make sure we do not incorrectly vectorize with -vectorize-memory-check-threshold=0;\n-+-; no runtime check is generated and the loop should not be vectorized.\n-++; FIXME: Currently this miscompiles with -vectorize-memory-check-threshold=0;\n-++; no runtime check is generated even though one is needed and !noalias\n-++; annotations are added.\n-+ define i16 @runtime_checks_needed(ptr %src, ptr %dst) {\n-+ ; LIMIT0-LABEL: define i16 @runtime_checks_needed(\n-+ ; LIMIT0-SAME: ptr [[SRC:%.*]], ptr [[DST:%.*]]) {\n-+-; LIMIT0-NEXT:  [[ENTRY:.*]]:\n-+-; LIMIT0-NEXT:    br label %[[LOOP:.*]]\n-+-; LIMIT0:       [[LOOP]]:\n-+-; LIMIT0-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[ENTRY]] ], [ [[INDEX_NEXT:%.*]], %[[LOOP]] ]\n-+-; LIMIT0-NEXT:    [[L:%.*]] = load i16, ptr [[SRC]], align 1\n-++; LIMIT0-NEXT:  [[ENTRY:.*:]]\n-++; LIMIT0-NEXT:    br label %[[VECTOR_PH:.*]]\n-++; LIMIT0:       [[VECTOR_PH]]:\n-++; LIMIT0-NEXT:    [[TMP0:%.*]] = load i16, ptr [[SRC]], align 1, !alias.scope [[META0:![0-9]+]]\n-++; LIMIT0-NEXT:    [[BROADCAST_SPLATINSERT:%.*]] = insertelement <2 x i16> poison, i16 [[TMP0]], i64 0\n-++; LIMIT0-NEXT:    [[BROADCAST_SPLAT:%.*]] = shufflevector <2 x i16> [[BROADCAST_SPLATINSERT]], <2 x i16> poison, <2 x i32> zeroinitializer\n-++; LIMIT0-NEXT:    br label %[[VECTOR_BODY:.*]]\n-++; LIMIT0:       [[VECTOR_BODY]]:\n-++; LIMIT0-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[VECTOR_PH]] ], [ [[INDEX_NEXT:%.*]], %[[VECTOR_BODY]] ]\n-+ ; LIMIT0-NEXT:    [[TMP1:%.*]] = getelementptr inbounds i16, ptr [[DST]], i64 [[INDEX]]\n-+-; LIMIT0-NEXT:    store i16 [[L]], ptr [[TMP1]], align 1\n-+-; LIMIT0-NEXT:    [[INDEX_NEXT]] = add nuw nsw i64 [[INDEX]], 1\n-++; LIMIT0-NEXT:    store <2 x i16> [[BROADCAST_SPLAT]], ptr [[TMP1]], align 1, !alias.scope [[META3:![0-9]+]], !noalias [[META0]]\n-++; LIMIT0-NEXT:    [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 2\n-+ ; LIMIT0-NEXT:    [[TMP2:%.*]] = icmp eq i64 [[INDEX_NEXT]], 1000\n-+-; LIMIT0-NEXT:    br i1 [[TMP2]], label %[[EXIT:.*]], label %[[LOOP]], !llvm.loop [[LOOP0:![0-9]+]]\n-++; LIMIT0-NEXT:    br i1 [[TMP2]], label %[[MIDDLE_BLOCK:.*]], label %[[VECTOR_BODY]], !llvm.loop [[LOOP5:![0-9]+]]\n-++; LIMIT0:       [[MIDDLE_BLOCK]]:\n-++; LIMIT0-NEXT:    br label %[[EXIT:.*]]\n-+ ; LIMIT0:       [[EXIT]]:\n-+-; LIMIT0-NEXT:    [[TMP0:%.*]] = phi i16 [ [[L]], %[[LOOP]] ]\n-+ ; LIMIT0-NEXT:    ret i16 [[TMP0]]\n-+ ;\n-+ ; LIMIT1-LABEL: define i16 @runtime_checks_needed(\n-+@@ -82,9 +88,14 @@\n-+ !3 = !{!\"llvm.loop.vectorize.enable\", i1 true}\n-+ \n-+ ;.\n-+-; LIMIT0: [[LOOP0]] = distinct !{[[LOOP0]], [[META1:![0-9]+]], [[META2:![0-9]+]]}\n-+-; LIMIT0: [[META1]] = !{!\"llvm.loop.vectorize.width\", i32 2}\n-+-; LIMIT0: [[META2]] = !{!\"llvm.loop.vectorize.enable\", i1 true}\n-++; LIMIT0: [[META0]] = !{[[META1:![0-9]+]]}\n-++; LIMIT0: [[META1]] = distinct !{[[META1]], [[META2:![0-9]+]]}\n-++; LIMIT0: [[META2]] = distinct !{[[META2]], !\"LVerDomain\"}\n-++; LIMIT0: [[META3]] = !{[[META4:![0-9]+]]}\n-++; LIMIT0: [[META4]] = distinct !{[[META4]], [[META2]]}\n-++; LIMIT0: [[LOOP5]] = distinct !{[[LOOP5]], [[META6:![0-9]+]], [[META7:![0-9]+]]}\n-++; LIMIT0: [[META6]] = !{!\"llvm.loop.isvectorized\", i32 1}\n-++; LIMIT0: [[META7]] = !{!\"llvm.loop.unroll.runtime.disable\"}\n-+ ;.\n-+ ; LIMIT1: [[META0]] = !{[[META1:![0-9]+]]}\n-+ ; LIMIT1: [[META1]] = distinct !{[[META1]], [[META2:![0-9]+]]}\n-+diff -ruN --strip-trailing-cr a/mlir/lib/Bytecode/Reader/BytecodeReader.cpp b/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n-+--- a/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n-++++ b/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n-+@@ -1320,8 +1320,9 @@\n-+ }\n-+ \n-+ template <typename T>\n-+-T AttrTypeReader::resolveEntry(SmallVectorImpl<Entry<T>> &entries, size_t index,\n-+-                               StringRef entryType, uint64_t depth) {\n-++T AttrTypeReader::resolveEntry(SmallVectorImpl<Entry<T>> &entries,\n-++                               uint64_t index, StringRef entryType,\n-++                               uint64_t depth) {\n-+   if (index >= entries.size()) {\n-+     emitError(fileLoc) << \"invalid \" << entryType << \" index: \" << index;\n-+     return {};\n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/ClangdLSPServer.cpp b/clang-tools-extra/clangd/ClangdLSPServer.cpp\n+---- a/clang-tools-extra/clangd/ClangdLSPServer.cpp\n+-+++ b/clang-tools-extra/clangd/ClangdLSPServer.cpp\n+-@@ -554,8 +554,6 @@\n+-     if (const auto &Dir = Params.initializationOptions.compilationDatabasePath)\n+-       CDBOpts.CompileCommandsDir = Dir;\n+-     CDBOpts.ContextProvider = Opts.ContextProvider;\n+--    if (Opts.StrongWorkspaceMode)\n+--      CDBOpts.applyFallbackWorkingDirectory(Opts.WorkspaceRoot);\n+-     BaseCDB =\n+-         std::make_unique<DirectoryBasedGlobalCompilationDatabase>(CDBOpts);\n+-   }\n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/ClangdServer.h b/clang-tools-extra/clangd/ClangdServer.h\n+---- a/clang-tools-extra/clangd/ClangdServer.h\n+-+++ b/clang-tools-extra/clangd/ClangdServer.h\n+-@@ -152,11 +152,6 @@\n+-     /// FIXME: If not set, should use the current working directory.\n+-     std::optional<std::string> WorkspaceRoot;\n+- \n+--    /// Sets an alternate mode of operation. Current effects are:\n+--    /// - Using the current working directory as the working directory for\n+--    ///   fallback commands\n+--    bool StrongWorkspaceMode;\n+--\n+-     /// The resource directory is used to find internal headers, overriding\n+-     /// defaults and -resource-dir compiler flag).\n+-     /// If std::nullopt, ClangdServer calls\n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp b/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n+---- a/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n+-+++ b/clang-tools-extra/clangd/GlobalCompilationDatabase.cpp\n+-@@ -64,9 +64,7 @@\n+-   if (FileExtension.empty() || FileExtension == \".h\")\n+-     Argv.push_back(\"-xobjective-c++-header\");\n+-   Argv.push_back(std::string(File));\n+--  tooling::CompileCommand Cmd(FallbackWorkingDirectory\n+--                                  ? *FallbackWorkingDirectory\n+--                                  : llvm::sys::path::parent_path(File),\n+-+  tooling::CompileCommand Cmd(llvm::sys::path::parent_path(File),\n+-                               llvm::sys::path::filename(File), std::move(Argv),\n+-                               /*Output=*/\"\");\n+-   Cmd.Heuristic = \"clangd fallback\";\n+-@@ -351,8 +349,7 @@\n+- \n+- DirectoryBasedGlobalCompilationDatabase::\n+-     DirectoryBasedGlobalCompilationDatabase(const Options &Opts)\n+--    : GlobalCompilationDatabase(Opts.FallbackWorkingDirectory), Opts(Opts),\n+--      Broadcaster(std::make_unique<BroadcastThread>(*this)) {\n+-+    : Opts(Opts), Broadcaster(std::make_unique<BroadcastThread>(*this)) {\n+-   if (!this->Opts.ContextProvider)\n+-     this->Opts.ContextProvider = [](llvm::StringRef) {\n+-       return Context::current().clone();\n+-@@ -463,21 +460,6 @@\n+-   return Result;\n+- }\n+- \n+--void DirectoryBasedGlobalCompilationDatabase::Options::\n+--    applyFallbackWorkingDirectory(\n+--        std::optional<std::string> FallbackWorkingDirectory) {\n+--  if (FallbackWorkingDirectory)\n+--    this->FallbackWorkingDirectory = *FallbackWorkingDirectory;\n+--  else {\n+--    // Clangd is running in strong workspace mode but the client didn't\n+--    // specify a workspace path in the `initialize` request.\n+--    // Fallback to current working directory.\n+--    SmallString<256> CWD;\n+--    llvm::sys::fs::current_path(CWD);\n+--    this->FallbackWorkingDirectory = std::string(CWD);\n+--  }\n+--}\n+--\n+- // The broadcast thread announces files with new compile commands to the world.\n+- // Primarily this is used to enqueue them for background indexing.\n+- //\n+-@@ -777,10 +759,9 @@\n+- \n+- OverlayCDB::OverlayCDB(const GlobalCompilationDatabase *Base,\n+-                        std::vector<std::string> FallbackFlags,\n+--                       CommandMangler Mangler,\n+--                       std::optional<std::string> FallbackWorkingDirectory)\n+--    : DelegatingCDB(Base, FallbackWorkingDirectory),\n+--      Mangler(std::move(Mangler)), FallbackFlags(std::move(FallbackFlags)) {}\n+-+                       CommandMangler Mangler)\n+-+    : DelegatingCDB(Base), Mangler(std::move(Mangler)),\n+-+      FallbackFlags(std::move(FallbackFlags)) {}\n+- \n+- std::optional<tooling::CompileCommand>\n+- OverlayCDB::getCompileCommand(PathRef File) const {\n+-@@ -863,20 +844,16 @@\n+-   return MDB;\n+- }\n+- \n+--DelegatingCDB::DelegatingCDB(\n+--    const GlobalCompilationDatabase *Base,\n+--    std::optional<std::string> FallbackWorkingDirectory)\n+--    : GlobalCompilationDatabase(FallbackWorkingDirectory), Base(Base) {\n+-+DelegatingCDB::DelegatingCDB(const GlobalCompilationDatabase *Base)\n+-+    : Base(Base) {\n+-   if (Base)\n+-     BaseChanged = Base->watch([this](const std::vector<std::string> Changes) {\n+-       OnCommandChanged.broadcast(Changes);\n+-     });\n+- }\n+- \n+--DelegatingCDB::DelegatingCDB(\n+--    std::unique_ptr<GlobalCompilationDatabase> Base,\n+--    std::optional<std::string> FallbackWorkingDirectory)\n+--    : DelegatingCDB(Base.get(), FallbackWorkingDirectory) {\n+-+DelegatingCDB::DelegatingCDB(std::unique_ptr<GlobalCompilationDatabase> Base)\n+-+    : DelegatingCDB(Base.get()) {\n+-   BaseOwner = std::move(Base);\n+- }\n+- \n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/GlobalCompilationDatabase.h b/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n+---- a/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n+-+++ b/clang-tools-extra/clangd/GlobalCompilationDatabase.h\n+-@@ -35,9 +35,6 @@\n+- /// Provides compilation arguments used for parsing C and C++ files.\n+- class GlobalCompilationDatabase {\n+- public:\n+--  GlobalCompilationDatabase(\n+--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt)\n+--      : FallbackWorkingDirectory(FallbackWorkingDirectory) {}\n+-   virtual ~GlobalCompilationDatabase() = default;\n+- \n+-   /// If there are any known-good commands for building this file, returns one.\n+-@@ -72,19 +69,14 @@\n+-   }\n+- \n+- protected:\n+--  std::optional<std::string> FallbackWorkingDirectory;\n+-   mutable CommandChanged OnCommandChanged;\n+- };\n+- \n+- // Helper class for implementing GlobalCompilationDatabases that wrap others.\n+- class DelegatingCDB : public GlobalCompilationDatabase {\n+- public:\n+--  DelegatingCDB(\n+--      const GlobalCompilationDatabase *Base,\n+--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n+--  DelegatingCDB(\n+--      std::unique_ptr<GlobalCompilationDatabase> Base,\n+--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n+-+  DelegatingCDB(const GlobalCompilationDatabase *Base);\n+-+  DelegatingCDB(std::unique_ptr<GlobalCompilationDatabase> Base);\n+- \n+-   std::optional<tooling::CompileCommand>\n+-   getCompileCommand(PathRef File) const override;\n+-@@ -125,12 +117,6 @@\n+-     // Only look for a compilation database in this one fixed directory.\n+-     // FIXME: fold this into config/context mechanism.\n+-     std::optional<Path> CompileCommandsDir;\n+--    // Working directory for fallback commands\n+--    // If unset, parent directory of file should be used\n+--    std::optional<std::string> FallbackWorkingDirectory;\n+--\n+--    void applyFallbackWorkingDirectory(\n+--        std::optional<std::string> FallbackWorkingDirectory);\n+-   };\n+- \n+-   DirectoryBasedGlobalCompilationDatabase(const Options &Opts);\n+-@@ -208,11 +194,9 @@\n+-   // Base may be null, in which case no entries are inherited.\n+-   // FallbackFlags are added to the fallback compile command.\n+-   // Adjuster is applied to all commands, fallback or not.\n+--  OverlayCDB(\n+--      const GlobalCompilationDatabase *Base,\n+--      std::vector<std::string> FallbackFlags = {},\n+--      CommandMangler Mangler = nullptr,\n+--      std::optional<std::string> FallbackWorkingDirectory = std::nullopt);\n+-+  OverlayCDB(const GlobalCompilationDatabase *Base,\n+-+             std::vector<std::string> FallbackFlags = {},\n+-+             CommandMangler Mangler = nullptr);\n+- \n+-   std::optional<tooling::CompileCommand>\n+-   getCompileCommand(PathRef File) const override;\n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/tool/Check.cpp b/clang-tools-extra/clangd/tool/Check.cpp\n+---- a/clang-tools-extra/clangd/tool/Check.cpp\n+-+++ b/clang-tools-extra/clangd/tool/Check.cpp\n+-@@ -169,8 +169,6 @@\n+-   bool buildCommand(const ThreadsafeFS &TFS) {\n+-     log(\"Loading compilation database...\");\n+-     DirectoryBasedGlobalCompilationDatabase::Options CDBOpts(TFS);\n+--    if (Opts.StrongWorkspaceMode)\n+--      CDBOpts.applyFallbackWorkingDirectory(Opts.WorkspaceRoot);\n+-     CDBOpts.CompileCommandsDir =\n+-         Config::current().CompileFlags.CDBSearch.FixedCDBPath;\n+-     BaseCDB =\n+-@@ -180,10 +178,8 @@\n+-         getSystemIncludeExtractor(llvm::ArrayRef(Opts.QueryDriverGlobs));\n+-     if (Opts.ResourceDir)\n+-       Mangler.ResourceDir = *Opts.ResourceDir;\n+--\n+-     CDB = std::make_unique<OverlayCDB>(\n+--        BaseCDB.get(), std::vector<std::string>{}, std::move(Mangler),\n+--        CDBOpts.FallbackWorkingDirectory);\n+-+        BaseCDB.get(), std::vector<std::string>{}, std::move(Mangler));\n+- \n+-     if (auto TrueCmd = CDB->getCompileCommand(File)) {\n+-       Cmd = std::move(*TrueCmd);\n+-@@ -506,7 +502,7 @@\n+-                  config::DiagnosticCallback Diag) const override {\n+-       config::Fragment F;\n+-       // If we're timing clang-tidy checks, implicitly disabling the slow ones\n+--      // is counterproductive!\n+-+      // is counterproductive! \n+-       if (CheckTidyTime.getNumOccurrences())\n+-         F.Diagnostics.ClangTidy.FastCheckFilter.emplace(\"None\");\n+-       return {std::move(F).compile(Diag)};\n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/tool/ClangdMain.cpp b/clang-tools-extra/clangd/tool/ClangdMain.cpp\n+---- a/clang-tools-extra/clangd/tool/ClangdMain.cpp\n+-+++ b/clang-tools-extra/clangd/tool/ClangdMain.cpp\n+-@@ -500,17 +500,6 @@\n+-     init(true),\n+- };\n+- \n+--opt<bool> StrongWorkspaceMode{\n+--    \"strong-workspace-mode\",\n+--    cat(Features),\n+--    desc(\"An alternate mode of operation for clangd, where the clangd instance \"\n+--         \"is used to edit a single workspace.\\n\"\n+--         \"When enabled, fallback commands use the workspace directory as their \"\n+--         \"working directory instead of the parent folder.\"),\n+--    init(false),\n+--    Hidden,\n+--};\n+--\n+- opt<bool> UseDirtyHeaders{\"use-dirty-headers\", cat(Misc),\n+-                           desc(\"Use files open in the editor when parsing \"\n+-                                \"headers instead of reading from the disk\"),\n+-@@ -918,7 +907,6 @@\n+-   }\n+-   if (!ResourceDir.empty())\n+-     Opts.ResourceDir = ResourceDir;\n+--  Opts.StrongWorkspaceMode = StrongWorkspaceMode;\n+-   Opts.BuildDynamicSymbolIndex = true;\n+- #if CLANGD_ENABLE_REMOTE\n+-   if (RemoteIndexAddress.empty() != ProjectRoot.empty()) {\n+-diff -ruN --strip-trailing-cr a/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp b/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n+---- a/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n+-+++ b/clang-tools-extra/clangd/unittests/GlobalCompilationDatabaseTests.cpp\n+-@@ -55,20 +55,6 @@\n+-                                            testPath(\"foo/bar\")));\n+- }\n+- \n+--TEST(GlobalCompilationDatabaseTest, FallbackWorkingDirectory) {\n+--  MockFS TFS;\n+--  DirectoryBasedGlobalCompilationDatabase::Options CDBOpts(TFS);\n+--  CDBOpts.applyFallbackWorkingDirectory(testPath(\"foo\"));\n+--  EXPECT_EQ(CDBOpts.FallbackWorkingDirectory, testPath(\"foo\"));\n+--\n+--  DirectoryBasedGlobalCompilationDatabase DB(CDBOpts);\n+--  auto Cmd = DB.getFallbackCommand(testPath(\"foo/src/bar.cc\"));\n+--  EXPECT_EQ(Cmd.Directory, testPath(\"foo\"));\n+--  EXPECT_THAT(Cmd.CommandLine,\n+--              ElementsAre(\"clang\", testPath(\"foo/src/bar.cc\")));\n+--  EXPECT_EQ(Cmd.Output, \"\");\n+--}\n+--\n+- static tooling::CompileCommand cmd(llvm::StringRef File, llvm::StringRef Arg) {\n+-   return tooling::CompileCommand(\n+-       testRoot(), File, {\"clang\", std::string(Arg), std::string(File)}, \"\");\n+-diff -ruN --strip-trailing-cr a/llvm/lib/CodeGen/ShrinkWrap.cpp b/llvm/lib/CodeGen/ShrinkWrap.cpp\n+---- a/llvm/lib/CodeGen/ShrinkWrap.cpp\n+-+++ b/llvm/lib/CodeGen/ShrinkWrap.cpp\n+-@@ -618,8 +618,6 @@\n+- \n+-   DenseSet<const MachineBasicBlock *> DirtyBBs;\n+-   for (MachineBasicBlock &MBB : MF) {\n+--    if (!MDT->isReachableFromEntry(&MBB))\n+--      continue;\n+-     if (MBB.isEHPad()) {\n+-       DirtyBBs.insert(&MBB);\n+-       continue;\n+-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp b/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n+---- a/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n+-+++ b/llvm/lib/Target/AArch64/AArch64InstrInfo.cpp\n+-@@ -708,53 +708,6 @@\n+-   return 2;\n+- }\n+- \n+--bool llvm::optimizeTerminators(MachineBasicBlock *MBB,\n+--                               const TargetInstrInfo &TII) {\n+--  for (MachineInstr &MI : MBB->terminators()) {\n+--    unsigned Opc = MI.getOpcode();\n+--    switch (Opc) {\n+--    case AArch64::CBZW:\n+--    case AArch64::CBZX:\n+--    case AArch64::TBZW:\n+--    case AArch64::TBZX:\n+--      // CBZ/TBZ with WZR/XZR -> unconditional B\n+--      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n+--          MI.getOperand(0).getReg() == AArch64::XZR) {\n+--        DEBUG_WITH_TYPE(\"optimizeTerminators\",\n+--                        dbgs() << \"Removing always taken branch: \" << MI);\n+--        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n+--        SmallVector<MachineBasicBlock *> Succs(MBB->successors());\n+--        for (auto *S : Succs)\n+--          if (S != Target)\n+--            MBB->removeSuccessor(S);\n+--        DebugLoc DL = MI.getDebugLoc();\n+--        while (MBB->rbegin() != &MI)\n+--          MBB->rbegin()->eraseFromParent();\n+--        MI.eraseFromParent();\n+--        BuildMI(MBB, DL, TII.get(AArch64::B)).addMBB(Target);\n+--        return true;\n+--      }\n+--      break;\n+--    case AArch64::CBNZW:\n+--    case AArch64::CBNZX:\n+--    case AArch64::TBNZW:\n+--    case AArch64::TBNZX:\n+--      // CBNZ/TBNZ with WZR/XZR -> never taken, remove branch and successor\n+--      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n+--          MI.getOperand(0).getReg() == AArch64::XZR) {\n+--        DEBUG_WITH_TYPE(\"optimizeTerminators\",\n+--                        dbgs() << \"Removing never taken branch: \" << MI);\n+--        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n+--        MI.getParent()->removeSuccessor(Target);\n+--        MI.eraseFromParent();\n+--        return true;\n+--      }\n+--      break;\n+--    }\n+--  }\n+--  return false;\n+--}\n+--\n+- // Find the original register that VReg is copied from.\n+- static unsigned removeCopies(const MachineRegisterInfo &MRI, unsigned VReg) {\n+-   while (Register::isVirtualRegister(VReg)) {\n+-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64InstrInfo.h b/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n+---- a/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n+-+++ b/llvm/lib/Target/AArch64/AArch64InstrInfo.h\n+-@@ -705,8 +705,6 @@\n+-                               unsigned *OutUnscaledOp = nullptr,\n+-                               int64_t *EmittableOffset = nullptr);\n+- \n+--bool optimizeTerminators(MachineBasicBlock *MBB, const TargetInstrInfo &TII);\n+--\n+- static inline bool isUncondBranchOpcode(int Opc) { return Opc == AArch64::B; }\n+- \n+- static inline bool isCondBranchOpcode(int Opc) {\n+-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp b/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n+---- a/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n+-+++ b/llvm/lib/Target/AArch64/AArch64RedundantCondBranchPass.cpp\n+-@@ -14,7 +14,6 @@\n+- //===----------------------------------------------------------------------===//\n+- \n+- #include \"AArch64.h\"\n+--#include \"AArch64InstrInfo.h\"\n+- #include \"llvm/CodeGen/MachineFunctionPass.h\"\n+- #include \"llvm/CodeGen/MachineInstrBuilder.h\"\n+- #include \"llvm/CodeGen/TargetInstrInfo.h\"\n+-@@ -46,6 +45,51 @@\n+-                 \"AArch64 Redundant Conditional Branch Elimination pass\", false,\n+-                 false)\n+- \n+-+static bool optimizeTerminators(MachineBasicBlock *MBB,\n+-+                                const TargetInstrInfo &TII) {\n+-+  for (MachineInstr &MI : make_early_inc_range(MBB->terminators())) {\n+-+    unsigned Opc = MI.getOpcode();\n+-+    switch (Opc) {\n+-+    case AArch64::CBZW:\n+-+    case AArch64::CBZX:\n+-+    case AArch64::TBZW:\n+-+    case AArch64::TBZX:\n+-+      // CBZ/TBZ with WZR/XZR -> unconditional B\n+-+      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n+-+          MI.getOperand(0).getReg() == AArch64::XZR) {\n+-+        LLVM_DEBUG(dbgs() << \"Removing redundant branch: \" << MI);\n+-+        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n+-+        SmallVector<MachineBasicBlock *> Succs(MBB->successors());\n+-+        for (auto *S : Succs)\n+-+          if (S != Target)\n+-+            MBB->removeSuccessor(S);\n+-+        DebugLoc DL = MI.getDebugLoc();\n+-+        while (MBB->rbegin() != &MI)\n+-+          MBB->rbegin()->eraseFromParent();\n+-+        MI.eraseFromParent();\n+-+        BuildMI(MBB, DL, TII.get(AArch64::B)).addMBB(Target);\n+-+        return true;\n+-+      }\n+-+      break;\n+-+    case AArch64::CBNZW:\n+-+    case AArch64::CBNZX:\n+-+    case AArch64::TBNZW:\n+-+    case AArch64::TBNZX:\n+-+      // CBNZ/TBNZ with WZR/XZR -> never taken, remove branch and successor\n+-+      if (MI.getOperand(0).getReg() == AArch64::WZR ||\n+-+          MI.getOperand(0).getReg() == AArch64::XZR) {\n+-+        LLVM_DEBUG(dbgs() << \"Removing redundant branch: \" << MI);\n+-+        MachineBasicBlock *Target = TII.getBranchDestBlock(MI);\n+-+        MI.getParent()->removeSuccessor(Target);\n+-+        MI.eraseFromParent();\n+-+        return true;\n+-+      }\n+-+      break;\n+-+    }\n+-+  }\n+-+  return false;\n+-+}\n+-+\n+- bool AArch64RedundantCondBranch::runOnMachineFunction(MachineFunction &MF) {\n+-   if (skipFunction(MF.getFunction()))\n+-     return false;\n+-diff -ruN --strip-trailing-cr a/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp b/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n+---- a/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n+-+++ b/llvm/lib/Target/AArch64/AArch64RedundantCopyElimination.cpp\n+-@@ -50,7 +50,6 @@\n+- //        to use WZR/XZR directly in some cases.\n+- //===----------------------------------------------------------------------===//\n+- #include \"AArch64.h\"\n+--#include \"AArch64InstrInfo.h\"\n+- #include \"llvm/ADT/SetVector.h\"\n+- #include \"llvm/ADT/Statistic.h\"\n+- #include \"llvm/ADT/iterator_range.h\"\n+-@@ -476,7 +475,6 @@\n+-     return false;\n+-   TRI = MF.getSubtarget().getRegisterInfo();\n+-   MRI = &MF.getRegInfo();\n+--  const TargetInstrInfo &TII = *MF.getSubtarget().getInstrInfo();\n+- \n+-   // Resize the clobbered and used register unit trackers.  We do this once per\n+-   // function.\n+-@@ -486,10 +484,8 @@\n+-   OptBBUsedRegs.init(*TRI);\n+- \n+-   bool Changed = false;\n+--  for (MachineBasicBlock &MBB : MF) {\n+--    Changed |= optimizeTerminators(&MBB, TII);\n+-+  for (MachineBasicBlock &MBB : MF)\n+-     Changed |= optimizeBlock(&MBB);\n+--  }\n+-   return Changed;\n+- }\n+- \n+-diff -ruN --strip-trailing-cr a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n+---- a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n+-+++ b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n+-@@ -1827,12 +1827,8 @@\n+-     // profile info.\n+-     CostTooHigh =\n+-         LAI.getNumRuntimePointerChecks() > VectorizeMemoryCheckThreshold;\n+--    if (CostTooHigh) {\n+--      // Mark runtime checks as never succeeding when they exceed the threshold.\n+--      MemRuntimeCheckCond = ConstantInt::getTrue(L->getHeader()->getContext());\n+--      SCEVCheckCond = ConstantInt::getTrue(L->getHeader()->getContext());\n+-+    if (CostTooHigh)\n+-       return;\n+--    }\n+- \n+-     BasicBlock *LoopHeader = L->getHeader();\n+-     BasicBlock *Preheader = L->getLoopPreheader();\n+-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll b/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n+---- a/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n+-+++ b/llvm/test/CodeGen/AArch64/arm64-shrink-wrapping.ll\n+-@@ -735,15 +735,21 @@\n+- ; ENABLE-NEXT:    .cfi_offset w29, -16\n+- ; ENABLE-NEXT:    .cfi_offset w19, -24\n+- ; ENABLE-NEXT:    .cfi_offset w20, -32\n+-+; ENABLE-NEXT:  ; %bb.1: ; %if.then\n+- ; ENABLE-NEXT:    sub x19, sp, #16\n+- ; ENABLE-NEXT:    mov sp, x19\n+- ; ENABLE-NEXT:    mov w20, wzr\n+--; ENABLE-NEXT:  LBB10_1: ; %for.body\n+-+; ENABLE-NEXT:  LBB10_2: ; %for.body\n+- ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n+- ; ENABLE-NEXT:    bl _something\n+- ; ENABLE-NEXT:    add w20, w0, w20\n+- ; ENABLE-NEXT:    str w20, [x19]\n+--; ENABLE-NEXT:    b LBB10_1\n+-+; ENABLE-NEXT:    b LBB10_2\n+-+; ENABLE-NEXT:  ; %bb.3: ; %if.end\n+-+; ENABLE-NEXT:    sub sp, x29, #16\n+-+; ENABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n+-+; ENABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n+-+; ENABLE-NEXT:    ret\n+- ;\n+- ; DISABLE-LABEL: infiniteloop:\n+- ; DISABLE:       ; %bb.0: ; %entry\n+-@@ -755,15 +761,21 @@\n+- ; DISABLE-NEXT:    .cfi_offset w29, -16\n+- ; DISABLE-NEXT:    .cfi_offset w19, -24\n+- ; DISABLE-NEXT:    .cfi_offset w20, -32\n+-+; DISABLE-NEXT:  ; %bb.1: ; %if.then\n+- ; DISABLE-NEXT:    sub x19, sp, #16\n+- ; DISABLE-NEXT:    mov sp, x19\n+- ; DISABLE-NEXT:    mov w20, wzr\n+--; DISABLE-NEXT:  LBB10_1: ; %for.body\n+-+; DISABLE-NEXT:  LBB10_2: ; %for.body\n+- ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n+- ; DISABLE-NEXT:    bl _something\n+- ; DISABLE-NEXT:    add w20, w0, w20\n+- ; DISABLE-NEXT:    str w20, [x19]\n+--; DISABLE-NEXT:    b LBB10_1\n+-+; DISABLE-NEXT:    b LBB10_2\n+-+; DISABLE-NEXT:  ; %bb.3: ; %if.end\n+-+; DISABLE-NEXT:    sub sp, x29, #16\n+-+; DISABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n+-+; DISABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n+-+; DISABLE-NEXT:    ret\n+- entry:\n+-   br i1 undef, label %if.then, label %if.end\n+- \n+-@@ -794,10 +806,11 @@\n+- ; ENABLE-NEXT:    .cfi_offset w29, -16\n+- ; ENABLE-NEXT:    .cfi_offset w19, -24\n+- ; ENABLE-NEXT:    .cfi_offset w20, -32\n+-+; ENABLE-NEXT:  ; %bb.1: ; %if.then\n+- ; ENABLE-NEXT:    sub x8, sp, #16\n+- ; ENABLE-NEXT:    mov sp, x8\n+- ; ENABLE-NEXT:    mov w9, wzr\n+--; ENABLE-NEXT:  LBB11_1: ; %for.body\n+-+; ENABLE-NEXT:  LBB11_2: ; %for.body\n+- ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n+- ; ENABLE-NEXT:    ; InlineAsm Start\n+- ; ENABLE-NEXT:    mov x10, #0 ; =0x0\n+-@@ -808,7 +821,12 @@\n+- ; ENABLE-NEXT:    ; InlineAsm Start\n+- ; ENABLE-NEXT:    nop\n+- ; ENABLE-NEXT:    ; InlineAsm End\n+--; ENABLE-NEXT:    b LBB11_1\n+-+; ENABLE-NEXT:    b LBB11_2\n+-+; ENABLE-NEXT:  ; %bb.3: ; %if.end\n+-+; ENABLE-NEXT:    sub sp, x29, #16\n+-+; ENABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n+-+; ENABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n+-+; ENABLE-NEXT:    ret\n+- ;\n+- ; DISABLE-LABEL: infiniteloop2:\n+- ; DISABLE:       ; %bb.0: ; %entry\n+-@@ -820,10 +838,11 @@\n+- ; DISABLE-NEXT:    .cfi_offset w29, -16\n+- ; DISABLE-NEXT:    .cfi_offset w19, -24\n+- ; DISABLE-NEXT:    .cfi_offset w20, -32\n+-+; DISABLE-NEXT:  ; %bb.1: ; %if.then\n+- ; DISABLE-NEXT:    sub x8, sp, #16\n+- ; DISABLE-NEXT:    mov sp, x8\n+- ; DISABLE-NEXT:    mov w9, wzr\n+--; DISABLE-NEXT:  LBB11_1: ; %for.body\n+-+; DISABLE-NEXT:  LBB11_2: ; %for.body\n+- ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n+- ; DISABLE-NEXT:    ; InlineAsm Start\n+- ; DISABLE-NEXT:    mov x10, #0 ; =0x0\n+-@@ -834,7 +853,12 @@\n+- ; DISABLE-NEXT:    ; InlineAsm Start\n+- ; DISABLE-NEXT:    nop\n+- ; DISABLE-NEXT:    ; InlineAsm End\n+--; DISABLE-NEXT:    b LBB11_1\n+-+; DISABLE-NEXT:    b LBB11_2\n+-+; DISABLE-NEXT:  ; %bb.3: ; %if.end\n+-+; DISABLE-NEXT:    sub sp, x29, #16\n+-+; DISABLE-NEXT:    ldp x29, x30, [sp, #16] ; 16-byte Folded Reload\n+-+; DISABLE-NEXT:    ldp x20, x19, [sp], #32 ; 16-byte Folded Reload\n+-+; DISABLE-NEXT:    ret\n+- entry:\n+-   br i1 undef, label %if.then, label %if.end\n+- \n+-@@ -865,43 +889,49 @@\n+- define void @infiniteloop3() {\n+- ; ENABLE-LABEL: infiniteloop3:\n+- ; ENABLE:       ; %bb.0: ; %entry\n+-+; ENABLE-NEXT:  ; %bb.1: ; %loop2a.preheader\n+- ; ENABLE-NEXT:    mov x8, xzr\n+- ; ENABLE-NEXT:    mov x9, xzr\n+- ; ENABLE-NEXT:    mov x11, xzr\n+--; ENABLE-NEXT:    b LBB12_2\n+--; ENABLE-NEXT:  LBB12_1: ; %loop2b\n+--; ENABLE-NEXT:    ; in Loop: Header=BB12_2 Depth=1\n+-+; ENABLE-NEXT:    b LBB12_3\n+-+; ENABLE-NEXT:  LBB12_2: ; %loop2b\n+-+; ENABLE-NEXT:    ; in Loop: Header=BB12_3 Depth=1\n+- ; ENABLE-NEXT:    str x10, [x11]\n+- ; ENABLE-NEXT:    mov x11, x10\n+--; ENABLE-NEXT:  LBB12_2: ; %loop1\n+-+; ENABLE-NEXT:  LBB12_3: ; %loop1\n+- ; ENABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n+- ; ENABLE-NEXT:    mov x10, x9\n+- ; ENABLE-NEXT:    ldr x9, [x8]\n+--; ENABLE-NEXT:    cbnz x8, LBB12_1\n+--; ENABLE-NEXT:  ; %bb.3: ; in Loop: Header=BB12_2 Depth=1\n+-+; ENABLE-NEXT:    cbnz x8, LBB12_2\n+-+; ENABLE-NEXT:  ; %bb.4: ; in Loop: Header=BB12_3 Depth=1\n+- ; ENABLE-NEXT:    mov x8, x10\n+- ; ENABLE-NEXT:    mov x11, x10\n+--; ENABLE-NEXT:    b LBB12_2\n+-+; ENABLE-NEXT:    b LBB12_3\n+-+; ENABLE-NEXT:  ; %bb.5: ; %end\n+-+; ENABLE-NEXT:    ret\n+- ;\n+- ; DISABLE-LABEL: infiniteloop3:\n+- ; DISABLE:       ; %bb.0: ; %entry\n+-+; DISABLE-NEXT:  ; %bb.1: ; %loop2a.preheader\n+- ; DISABLE-NEXT:    mov x8, xzr\n+- ; DISABLE-NEXT:    mov x9, xzr\n+- ; DISABLE-NEXT:    mov x11, xzr\n+--; DISABLE-NEXT:    b LBB12_2\n+--; DISABLE-NEXT:  LBB12_1: ; %loop2b\n+--; DISABLE-NEXT:    ; in Loop: Header=BB12_2 Depth=1\n+-+; DISABLE-NEXT:    b LBB12_3\n+-+; DISABLE-NEXT:  LBB12_2: ; %loop2b\n+-+; DISABLE-NEXT:    ; in Loop: Header=BB12_3 Depth=1\n+- ; DISABLE-NEXT:    str x10, [x11]\n+- ; DISABLE-NEXT:    mov x11, x10\n+--; DISABLE-NEXT:  LBB12_2: ; %loop1\n+-+; DISABLE-NEXT:  LBB12_3: ; %loop1\n+- ; DISABLE-NEXT:    ; =>This Inner Loop Header: Depth=1\n+- ; DISABLE-NEXT:    mov x10, x9\n+- ; DISABLE-NEXT:    ldr x9, [x8]\n+--; DISABLE-NEXT:    cbnz x8, LBB12_1\n+--; DISABLE-NEXT:  ; %bb.3: ; in Loop: Header=BB12_2 Depth=1\n+-+; DISABLE-NEXT:    cbnz x8, LBB12_2\n+-+; DISABLE-NEXT:  ; %bb.4: ; in Loop: Header=BB12_3 Depth=1\n+- ; DISABLE-NEXT:    mov x8, x10\n+- ; DISABLE-NEXT:    mov x11, x10\n+--; DISABLE-NEXT:    b LBB12_2\n+-+; DISABLE-NEXT:    b LBB12_3\n+-+; DISABLE-NEXT:  ; %bb.5: ; %end\n+-+; DISABLE-NEXT:    ret\n+- entry:\n+-   br i1 undef, label %loop2a, label %body\n+- \n+-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll b/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n+---- a/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n+-+++ b/llvm/test/CodeGen/AArch64/block-placement-optimize-branches.ll\n+-@@ -8,14 +8,20 @@\n+- define i8 @foo_optsize(i32 %v4) optsize {\n+- ; CHECK-LABEL: foo_optsize:\n+- ; CHECK:       // %bb.0: // %entry\n+--; CHECK-NEXT:    cbnz w0, .LBB0_2\n+--; CHECK-NEXT:  // %bb.1: // %b2\n+--; CHECK-NEXT:    mov w0, #1 // =0x1\n+-+; CHECK-NEXT:    b .LBB0_2\n+-+; CHECK-NEXT:  .LBB0_1:\n+-+; CHECK-NEXT:    mov w0, wzr\n+- ; CHECK-NEXT:    ret\n+- ; CHECK-NEXT:  .LBB0_2: // %b1\n+--; CHECK-NEXT:    cmp w0, #1\n+--; CHECK-NEXT:    mov w0, wzr\n+-+; CHECK-NEXT:    cbnz w0, .LBB0_4\n+-+; CHECK-NEXT:  // %bb.3: // %b2\n+-+; CHECK-NEXT:    mov w0, #1 // =0x1\n+- ; CHECK-NEXT:    ret\n+-+; CHECK-NEXT:  .LBB0_4: // %b1\n+-+; CHECK-NEXT:    cmp w0, #1\n+-+; CHECK-NEXT:    b.ne .LBB0_1\n+-+; CHECK-NEXT:  // %bb.5: // %b3\n+-+; CHECK-NEXT:    b .LBB0_1\n+- entry:\n+-   %v2 = icmp eq i32 0, 0\n+-   br i1 %v2, label %b1, label %b4\n+-@@ -41,14 +47,20 @@\n+- define i8 @foo_optspeed(i32 %v4) {\n+- ; CHECK-LABEL: foo_optspeed:\n+- ; CHECK:       // %bb.0: // %entry\n+--; CHECK-NEXT:    cbnz w0, .LBB1_2\n+--; CHECK-NEXT:  // %bb.1: // %b2\n+--; CHECK-NEXT:    mov w0, #1 // =0x1\n+-+; CHECK-NEXT:    b .LBB1_2\n+-+; CHECK-NEXT:  .LBB1_1:\n+-+; CHECK-NEXT:    mov w0, wzr\n+- ; CHECK-NEXT:    ret\n+- ; CHECK-NEXT:  .LBB1_2: // %b1\n+--; CHECK-NEXT:    cmp w0, #1\n+--; CHECK-NEXT:    mov w0, wzr\n+-+; CHECK-NEXT:    cbnz w0, .LBB1_4\n+-+; CHECK-NEXT:  // %bb.3: // %b2\n+-+; CHECK-NEXT:    mov w0, #1 // =0x1\n+- ; CHECK-NEXT:    ret\n+-+; CHECK-NEXT:  .LBB1_4: // %b1\n+-+; CHECK-NEXT:    cmp w0, #1\n+-+; CHECK-NEXT:    b.ne .LBB1_1\n+-+; CHECK-NEXT:  // %bb.5: // %b3\n+-+; CHECK-NEXT:    b .LBB1_1\n+- entry:\n+-   %v2 = icmp eq i32 0, 0\n+-   br i1 %v2, label %b1, label %b4\n+-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll b/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n+---- a/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n+-+++ b/llvm/test/CodeGen/AArch64/lr-reserved-for-ra-live-in.ll\n+-@@ -21,8 +21,10 @@\n+-   ; CHECK-NEXT:   B %bb.3\n+-   ; CHECK-NEXT: {{  $}}\n+-   ; CHECK-NEXT: bb.1.bb:\n+-+  ; CHECK-NEXT:   successors: %bb.3(0x2aaaaaab), %bb.2(0x55555555)\n+-   ; CHECK-NEXT:   liveins: $w0, $lr\n+-   ; CHECK-NEXT: {{  $}}\n+-+  ; CHECK-NEXT:   CBNZW $wzr, %bb.3\n+-   ; CHECK-NEXT:   B %bb.2\n+-   ; CHECK-NEXT: {{  $}}\n+-   ; CHECK-NEXT: bb.2.bb1:\n+-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/pr164181.ll b/llvm/test/CodeGen/AArch64/pr164181.ll\n+---- a/llvm/test/CodeGen/AArch64/pr164181.ll\n+-+++ b/llvm/test/CodeGen/AArch64/pr164181.ll\n+-@@ -29,11 +29,11 @@\n+- ; CHECK-NEXT:    str w4, [sp, #72] // 4-byte Spill\n+- ; CHECK-NEXT:    str w3, [sp, #112] // 4-byte Spill\n+- ; CHECK-NEXT:    str w5, [sp, #36] // 4-byte Spill\n+--; CHECK-NEXT:    tbz w5, #0, .LBB0_40\n+-+; CHECK-NEXT:    tbz w5, #0, .LBB0_43\n+- ; CHECK-NEXT:  // %bb.1: // %for.body41.lr.ph\n+- ; CHECK-NEXT:    ldr x4, [sp, #312]\n+- ; CHECK-NEXT:    ldr x14, [sp, #280]\n+--; CHECK-NEXT:    tbz w0, #0, .LBB0_39\n+-+; CHECK-NEXT:    tbz w0, #0, .LBB0_42\n+- ; CHECK-NEXT:  // %bb.2: // %for.body41.us.preheader\n+- ; CHECK-NEXT:    ldrb w8, [sp, #368]\n+- ; CHECK-NEXT:    ldrb w12, [sp, #256]\n+-@@ -92,7 +92,7 @@\n+- ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n+- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n+- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n+--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n+-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n+- ; CHECK-NEXT:    ldr w8, [sp, #20] // 4-byte Reload\n+- ; CHECK-NEXT:    mov x12, x24\n+- ; CHECK-NEXT:    str x24, [sp, #48] // 8-byte Spill\n+-@@ -117,7 +117,7 @@\n+- ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n+- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n+- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n+--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n+-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n+- ; CHECK-NEXT:    str x12, [sp, #40] // 8-byte Spill\n+- ; CHECK-NEXT:    cmn x24, #30\n+- ; CHECK-NEXT:    mov x12, #-30 // =0xffffffffffffffe2\n+-@@ -142,7 +142,7 @@\n+- ; CHECK-NEXT:    // Child Loop BB0_10 Depth 4\n+- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n+- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n+--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n+-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n+- ; CHECK-NEXT:    ldr x8, [sp, #64] // 8-byte Reload\n+- ; CHECK-NEXT:    mov w14, #1152 // =0x480\n+- ; CHECK-NEXT:    mov w24, #1 // =0x1\n+-@@ -176,7 +176,7 @@\n+- ; CHECK-NEXT:    // => This Loop Header: Depth=4\n+- ; CHECK-NEXT:    // Child Loop BB0_11 Depth 5\n+- ; CHECK-NEXT:    // Child Loop BB0_28 Depth 5\n+--; CHECK-NEXT:    // Child Loop BB0_36 Depth 5\n+-+; CHECK-NEXT:    // Child Loop BB0_39 Depth 5\n+- ; CHECK-NEXT:    ldr w8, [sp, #116] // 4-byte Reload\n+- ; CHECK-NEXT:    and w8, w8, w8, asr #31\n+- ; CHECK-NEXT:    str w8, [sp, #128] // 4-byte Spill\n+-@@ -281,23 +281,31 @@\n+- ; CHECK-NEXT:    mov x24, xzr\n+- ; CHECK-NEXT:    mul w12, w12, w22\n+- ; CHECK-NEXT:    mov x22, x5\n+--; CHECK-NEXT:    tbz w0, #0, .LBB0_33\n+--; CHECK-NEXT:  .LBB0_28: // %if.then222.us\n+-+; CHECK-NEXT:    tbz w0, #0, .LBB0_36\n+-+; CHECK-NEXT:  .LBB0_28: // %for.body194.us\n+- ; CHECK-NEXT:    // Parent Loop BB0_4 Depth=1\n+- ; CHECK-NEXT:    // Parent Loop BB0_6 Depth=2\n+- ; CHECK-NEXT:    // Parent Loop BB0_8 Depth=3\n+- ; CHECK-NEXT:    // Parent Loop BB0_10 Depth=4\n+- ; CHECK-NEXT:    // => This Inner Loop Header: Depth=5\n+-+; CHECK-NEXT:  // %bb.29: // %if.then222.us\n+-+; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n+- ; CHECK-NEXT:    adrp x27, :got:var_32\n+- ; CHECK-NEXT:    ldur w8, [x19, #-12]\n+- ; CHECK-NEXT:    ldr x27, [x27, :got_lo12:var_32]\n+- ; CHECK-NEXT:    strh w8, [x27]\n+- ; CHECK-NEXT:    sxtb w8, w25\n+--; CHECK-NEXT:    strb w3, [x16]\n+- ; CHECK-NEXT:    bic w25, w8, w8, asr #31\n+-+; CHECK-NEXT:    b .LBB0_31\n+-+; CHECK-NEXT:    .p2align 5, , 16\n+-+; CHECK-NEXT:  // %bb.30:\n+-+; CHECK-NEXT:    mov w25, wzr\n+-+; CHECK-NEXT:  .LBB0_31: // %if.end239.us\n+-+; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n+-+; CHECK-NEXT:    strb w3, [x16]\n+- ; CHECK-NEXT:    tst w13, #0xff\n+--; CHECK-NEXT:    b.eq .LBB0_30\n+--; CHECK-NEXT:  // %bb.29: // %if.then254.us\n+-+; CHECK-NEXT:    b.eq .LBB0_33\n+-+; CHECK-NEXT:  // %bb.32: // %if.then254.us\n+- ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n+- ; CHECK-NEXT:    ldrh w8, [x26, x14, lsl #1]\n+- ; CHECK-NEXT:    adrp x27, :got:var_35\n+-@@ -306,7 +314,7 @@\n+- ; CHECK-NEXT:    csel x8, xzr, x7, eq\n+- ; CHECK-NEXT:    str x8, [x27]\n+- ; CHECK-NEXT:    strh w1, [x17]\n+--; CHECK-NEXT:  .LBB0_30: // %if.end282.us\n+-+; CHECK-NEXT:  .LBB0_33: // %if.end282.us\n+- ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n+- ; CHECK-NEXT:    orr x27, x24, x4\n+- ; CHECK-NEXT:    adrp x8, :got:var_39\n+-@@ -317,14 +325,14 @@\n+- ; CHECK-NEXT:    str x8, [x18]\n+- ; CHECK-NEXT:    mov w8, #1 // =0x1\n+- ; CHECK-NEXT:    cbnz x2, .LBB0_27\n+--; CHECK-NEXT:  // %bb.31: // %if.then327.us\n+-+; CHECK-NEXT:  // %bb.34: // %if.then327.us\n+- ; CHECK-NEXT:    // in Loop: Header=BB0_28 Depth=5\n+- ; CHECK-NEXT:    cbz w8, .LBB0_25\n+--; CHECK-NEXT:  // %bb.32: // in Loop: Header=BB0_28 Depth=5\n+-+; CHECK-NEXT:  // %bb.35: // in Loop: Header=BB0_28 Depth=5\n+- ; CHECK-NEXT:    mov w4, wzr\n+- ; CHECK-NEXT:    b .LBB0_26\n+- ; CHECK-NEXT:    .p2align 5, , 16\n+--; CHECK-NEXT:  .LBB0_33: // %for.cond376.preheader.us\n+-+; CHECK-NEXT:  .LBB0_36: // %for.cond376.preheader.us\n+- ; CHECK-NEXT:    // in Loop: Header=BB0_10 Depth=4\n+- ; CHECK-NEXT:    mov w3, #1152 // =0x480\n+- ; CHECK-NEXT:    mov x22, xzr\n+-@@ -335,24 +343,24 @@\n+- ; CHECK-NEXT:    madd x14, x14, x3, x11\n+- ; CHECK-NEXT:    mov w28, w30\n+- ; CHECK-NEXT:    mov w3, #-7680 // =0xffffe200\n+--; CHECK-NEXT:    b .LBB0_36\n+-+; CHECK-NEXT:    b .LBB0_39\n+- ; CHECK-NEXT:    .p2align 5, , 16\n+--; CHECK-NEXT:  .LBB0_34: // %if.then466.us\n+--; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n+-+; CHECK-NEXT:  .LBB0_37: // %if.then466.us\n+-+; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n+- ; CHECK-NEXT:    ldr x28, [sp, #152] // 8-byte Reload\n+- ; CHECK-NEXT:    ldr x3, [sp, #136] // 8-byte Reload\n+- ; CHECK-NEXT:    sxtb w4, w4\n+- ; CHECK-NEXT:    bic w4, w4, w4, asr #31\n+- ; CHECK-NEXT:    str x3, [x28]\n+- ; CHECK-NEXT:    mov w3, #-7680 // =0xffffe200\n+--; CHECK-NEXT:  .LBB0_35: // %for.inc505.us\n+--; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n+-+; CHECK-NEXT:  .LBB0_38: // %for.inc505.us\n+-+; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n+- ; CHECK-NEXT:    add x22, x22, #1\n+- ; CHECK-NEXT:    add x27, x27, #1\n+- ; CHECK-NEXT:    mov w28, wzr\n+- ; CHECK-NEXT:    cmp x27, #0\n+- ; CHECK-NEXT:    b.hs .LBB0_9\n+--; CHECK-NEXT:  .LBB0_36: // %for.body380.us\n+-+; CHECK-NEXT:  .LBB0_39: // %for.body380.us\n+- ; CHECK-NEXT:    // Parent Loop BB0_4 Depth=1\n+- ; CHECK-NEXT:    // Parent Loop BB0_6 Depth=2\n+- ; CHECK-NEXT:    // Parent Loop BB0_8 Depth=3\n+-@@ -364,18 +372,18 @@\n+- ; CHECK-NEXT:    strh w28, [x11]\n+- ; CHECK-NEXT:    csel w28, w21, w3, ne\n+- ; CHECK-NEXT:    str w28, [x20]\n+--; CHECK-NEXT:    cbz x15, .LBB0_35\n+--; CHECK-NEXT:  // %bb.37: // %if.then436.us\n+--; CHECK-NEXT:    // in Loop: Header=BB0_36 Depth=5\n+-+; CHECK-NEXT:    cbz x15, .LBB0_38\n+-+; CHECK-NEXT:  // %bb.40: // %if.then436.us\n+-+; CHECK-NEXT:    // in Loop: Header=BB0_39 Depth=5\n+- ; CHECK-NEXT:    ldrh w28, [x14]\n+--; CHECK-NEXT:    cbnz w28, .LBB0_34\n+--; CHECK-NEXT:  // %bb.38: // in Loop: Header=BB0_36 Depth=5\n+-+; CHECK-NEXT:    cbnz w28, .LBB0_37\n+-+; CHECK-NEXT:  // %bb.41: // in Loop: Header=BB0_39 Depth=5\n+- ; CHECK-NEXT:    mov w4, wzr\n+--; CHECK-NEXT:    b .LBB0_35\n+--; CHECK-NEXT:  .LBB0_39: // %for.body41\n+-+; CHECK-NEXT:    b .LBB0_38\n+-+; CHECK-NEXT:  .LBB0_42: // %for.body41\n+- ; CHECK-NEXT:    strb wzr, [x4]\n+- ; CHECK-NEXT:    strb wzr, [x14]\n+--; CHECK-NEXT:  .LBB0_40: // %for.cond563.preheader\n+-+; CHECK-NEXT:  .LBB0_43: // %for.cond563.preheader\n+- ; CHECK-NEXT:    ldp x20, x19, [sp, #224] // 16-byte Folded Reload\n+- ; CHECK-NEXT:    ldp x22, x21, [sp, #208] // 16-byte Folded Reload\n+- ; CHECK-NEXT:    ldp x24, x23, [sp, #192] // 16-byte Folded Reload\n+-diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/pr166870.ll b/llvm/test/CodeGen/AArch64/pr166870.ll\n+---- a/llvm/test/CodeGen/AArch64/pr166870.ll\n+-+++ b/llvm/test/CodeGen/AArch64/pr166870.ll\n+-@@ -26,11 +26,12 @@\n+- ; CHECK-NEXT:    mov x21, x1\n+- ; CHECK-NEXT:    bl baz\n+- ; CHECK-NEXT:    mov w0, #0 // =0x0\n+-+; CHECK-NEXT:  // %bb.5: // %bb6\n+- ; CHECK-NEXT:    mov w10, #1 // =0x1\n+-+; CHECK-NEXT:    cbnz w10, .LBB0_11\n+-+; CHECK-NEXT:  // %bb.6: // %bb7\n+- ; CHECK-NEXT:    cbnz w10, .LBB0_10\n+--; CHECK-NEXT:  // %bb.5: // %bb7\n+--; CHECK-NEXT:    cbnz w10, .LBB0_9\n+--; CHECK-NEXT:  // %bb.6: // %bb8\n+-+; CHECK-NEXT:  // %bb.7: // %bb8\n+- ; CHECK-NEXT:    mov x8, x21\n+- ; CHECK-NEXT:    mov x9, x20\n+- ; CHECK-NEXT:    mov w20, #0 // =0x0\n+-@@ -38,17 +39,17 @@\n+- ; CHECK-NEXT:    mov x21, x9\n+- ; CHECK-NEXT:    mov w8, w8\n+- ; CHECK-NEXT:    mov x22, x8\n+--; CHECK-NEXT:  .LBB0_7: // %bb10\n+-+; CHECK-NEXT:  .LBB0_8: // %bb10\n+- ; CHECK-NEXT:    // =>This Inner Loop Header: Depth=1\n+- ; CHECK-NEXT:    strb w20, [x19]\n+--; CHECK-NEXT:    cbnz x21, .LBB0_7\n+--; CHECK-NEXT:  // %bb.8: // %bb12\n+--; CHECK-NEXT:    // in Loop: Header=BB0_7 Depth=1\n+-+; CHECK-NEXT:    cbnz x21, .LBB0_8\n+-+; CHECK-NEXT:  // %bb.9: // %bb12\n+-+; CHECK-NEXT:    // in Loop: Header=BB0_8 Depth=1\n+- ; CHECK-NEXT:    bl snork\n+--; CHECK-NEXT:    cbnz x22, .LBB0_7\n+--; CHECK-NEXT:  .LBB0_9:\n+--; CHECK-NEXT:    mov w0, #0 // =0x0\n+-+; CHECK-NEXT:    cbnz x22, .LBB0_8\n+- ; CHECK-NEXT:  .LBB0_10:\n+-+; CHECK-NEXT:    mov w0, #0 // =0x0\n+-+; CHECK-NEXT:  .LBB0_11:\n+- ; CHECK-NEXT:    ldp x20, x19, [sp, #32] // 16-byte Folded Reload\n+- ; CHECK-NEXT:    ldp x22, x21, [sp, #16] // 16-byte Folded Reload\n+- ; CHECK-NEXT:    ldr x30, [sp], #48 // 8-byte Folded Reload\n+-diff -ruN --strip-trailing-cr a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n+---- a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n+-+++ b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.generated.expected\n+-@@ -71,21 +71,27 @@\n+- ; CHECK-NEXT:    .cfi_def_cfa w29, 16\n+- ; CHECK-NEXT:    .cfi_offset w30, -8\n+- ; CHECK-NEXT:    .cfi_offset w29, -16\n+-+; CHECK-NEXT:    .cfi_remember_state\n+- ; CHECK-NEXT:    mov w8, #1 // =0x1\n+--; CHECK-NEXT:    mov w9, #2 // =0x2\n+- ; CHECK-NEXT:    stur xzr, [x29, #-8]\n+--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+--; CHECK-NEXT:    ldur w8, [x29, #-8]\n+--; CHECK-NEXT:    cbz w8, .LBB0_2\n+-+; CHECK-NEXT:    b .LBB0_3\n+- ; CHECK-NEXT:  // %bb.1:\n+--; CHECK-NEXT:    mov w8, #1 // =0x1\n+- ; CHECK-NEXT:    str w8, [sp, #16]\n+--; CHECK-NEXT:    b .LBB0_3\n+-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n+-+; CHECK-NEXT:    cbz w8, .LBB0_4\n+- ; CHECK-NEXT:  .LBB0_2:\n+-+; CHECK-NEXT:    .cfi_restore_state\n+- ; CHECK-NEXT:    mov w8, #1 // =0x1\n+--; CHECK-NEXT:    mov w9, #2 // =0x2\n+--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+-+; CHECK-NEXT:    str w8, [sp, #16]\n+-+; CHECK-NEXT:    b .LBB0_5\n+- ; CHECK-NEXT:  .LBB0_3:\n+-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n+-+; CHECK-NEXT:    cbnz w8, .LBB0_2\n+-+; CHECK-NEXT:  .LBB0_4:\n+-+; CHECK-NEXT:    mov w8, #1 // =0x1\n+-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+-+; CHECK-NEXT:  .LBB0_5:\n+- ; CHECK-NEXT:    mov w0, wzr\n+- ; CHECK-NEXT:    .cfi_def_cfa wsp, 48\n+- ; CHECK-NEXT:    ldp x29, x30, [sp, #32] // 16-byte Folded Reload\n+-@@ -128,6 +134,7 @@\n+- ;\n+- ; CHECK-LABEL: OUTLINED_FUNCTION_0:\n+- ; CHECK:       // %bb.0:\n+-+; CHECK-NEXT:    mov w9, #2 // =0x2\n+- ; CHECK-NEXT:    stp w9, w8, [x29, #-12]\n+- ; CHECK-NEXT:    mov w9, #3 // =0x3\n+- ; CHECK-NEXT:    mov w8, #4 // =0x4\n+-diff -ruN --strip-trailing-cr a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n+---- a/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n+-+++ b/llvm/test/tools/UpdateTestChecks/update_llc_test_checks/Inputs/aarch64_generated_funcs.ll.nogenerated.expected\n+-@@ -12,21 +12,27 @@\n+- ; CHECK-NEXT:    .cfi_def_cfa w29, 16\n+- ; CHECK-NEXT:    .cfi_offset w30, -8\n+- ; CHECK-NEXT:    .cfi_offset w29, -16\n+-+; CHECK-NEXT:    .cfi_remember_state\n+- ; CHECK-NEXT:    mov w8, #1 // =0x1\n+--; CHECK-NEXT:    mov w9, #2 // =0x2\n+- ; CHECK-NEXT:    stur xzr, [x29, #-8]\n+--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+--; CHECK-NEXT:    ldur w8, [x29, #-8]\n+--; CHECK-NEXT:    cbz w8, .LBB0_2\n+-+; CHECK-NEXT:    b .LBB0_3\n+- ; CHECK-NEXT:  // %bb.1:\n+--; CHECK-NEXT:    mov w8, #1 // =0x1\n+- ; CHECK-NEXT:    str w8, [sp, #16]\n+--; CHECK-NEXT:    b .LBB0_3\n+-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n+-+; CHECK-NEXT:    cbz w8, .LBB0_4\n+- ; CHECK-NEXT:  .LBB0_2:\n+-+; CHECK-NEXT:    .cfi_restore_state\n+- ; CHECK-NEXT:    mov w8, #1 // =0x1\n+--; CHECK-NEXT:    mov w9, #2 // =0x2\n+--; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+-+; CHECK-NEXT:    str w8, [sp, #16]\n+-+; CHECK-NEXT:    b .LBB0_5\n+- ; CHECK-NEXT:  .LBB0_3:\n+-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+-+; CHECK-NEXT:    ldur w8, [x29, #-8]\n+-+; CHECK-NEXT:    cbnz w8, .LBB0_2\n+-+; CHECK-NEXT:  .LBB0_4:\n+-+; CHECK-NEXT:    mov w8, #1 // =0x1\n+-+; CHECK-NEXT:    bl OUTLINED_FUNCTION_0\n+-+; CHECK-NEXT:  .LBB0_5:\n+- ; CHECK-NEXT:    mov w0, wzr\n+- ; CHECK-NEXT:    .cfi_def_cfa wsp, 48\n+- ; CHECK-NEXT:    ldp x29, x30, [sp, #32] // 16-byte Folded Reload\n+-diff -ruN --strip-trailing-cr a/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll b/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n+---- a/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n+-+++ b/llvm/test/Transforms/LoopVectorize/runtime-check-threshold-with-force-metadata.ll\n+-@@ -2,23 +2,29 @@\n+- ; RUN: opt -p loop-vectorize -vectorize-memory-check-threshold=0 -S %s | FileCheck --check-prefix=LIMIT0 %s\n+- ; RUN: opt -p loop-vectorize -vectorize-memory-check-threshold=1 -S %s | FileCheck --check-prefix=LIMIT1 %s\n+- \n+--; Make sure we do not incorrectly vectorize with -vectorize-memory-check-threshold=0;\n+--; no runtime check is generated and the loop should not be vectorized.\n+-+; FIXME: Currently this miscompiles with -vectorize-memory-check-threshold=0;\n+-+; no runtime check is generated even though one is needed and !noalias\n+-+; annotations are added.\n+- define i16 @runtime_checks_needed(ptr %src, ptr %dst) {\n+- ; LIMIT0-LABEL: define i16 @runtime_checks_needed(\n+- ; LIMIT0-SAME: ptr [[SRC:%.*]], ptr [[DST:%.*]]) {\n+--; LIMIT0-NEXT:  [[ENTRY:.*]]:\n+--; LIMIT0-NEXT:    br label %[[LOOP:.*]]\n+--; LIMIT0:       [[LOOP]]:\n+--; LIMIT0-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[ENTRY]] ], [ [[INDEX_NEXT:%.*]], %[[LOOP]] ]\n+--; LIMIT0-NEXT:    [[L:%.*]] = load i16, ptr [[SRC]], align 1\n+-+; LIMIT0-NEXT:  [[ENTRY:.*:]]\n+-+; LIMIT0-NEXT:    br label %[[VECTOR_PH:.*]]\n+-+; LIMIT0:       [[VECTOR_PH]]:\n+-+; LIMIT0-NEXT:    [[TMP0:%.*]] = load i16, ptr [[SRC]], align 1, !alias.scope [[META0:![0-9]+]]\n+-+; LIMIT0-NEXT:    [[BROADCAST_SPLATINSERT:%.*]] = insertelement <2 x i16> poison, i16 [[TMP0]], i64 0\n+-+; LIMIT0-NEXT:    [[BROADCAST_SPLAT:%.*]] = shufflevector <2 x i16> [[BROADCAST_SPLATINSERT]], <2 x i16> poison, <2 x i32> zeroinitializer\n+-+; LIMIT0-NEXT:    br label %[[VECTOR_BODY:.*]]\n+-+; LIMIT0:       [[VECTOR_BODY]]:\n+-+; LIMIT0-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[VECTOR_PH]] ], [ [[INDEX_NEXT:%.*]], %[[VECTOR_BODY]] ]\n+- ; LIMIT0-NEXT:    [[TMP1:%.*]] = getelementptr inbounds i16, ptr [[DST]], i64 [[INDEX]]\n+--; LIMIT0-NEXT:    store i16 [[L]], ptr [[TMP1]], align 1\n+--; LIMIT0-NEXT:    [[INDEX_NEXT]] = add nuw nsw i64 [[INDEX]], 1\n+-+; LIMIT0-NEXT:    store <2 x i16> [[BROADCAST_SPLAT]], ptr [[TMP1]], align 1, !alias.scope [[META3:![0-9]+]], !noalias [[META0]]\n+-+; LIMIT0-NEXT:    [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 2\n+- ; LIMIT0-NEXT:    [[TMP2:%.*]] = icmp eq i64 [[INDEX_NEXT]], 1000\n+--; LIMIT0-NEXT:    br i1 [[TMP2]], label %[[EXIT:.*]], label %[[LOOP]], !llvm.loop [[LOOP0:![0-9]+]]\n+-+; LIMIT0-NEXT:    br i1 [[TMP2]], label %[[MIDDLE_BLOCK:.*]], label %[[VECTOR_BODY]], !llvm.loop [[LOOP5:![0-9]+]]\n+-+; LIMIT0:       [[MIDDLE_BLOCK]]:\n+-+; LIMIT0-NEXT:    br label %[[EXIT:.*]]\n+- ; LIMIT0:       [[EXIT]]:\n+--; LIMIT0-NEXT:    [[TMP0:%.*]] = phi i16 [ [[L]], %[[LOOP]] ]\n+- ; LIMIT0-NEXT:    ret i16 [[TMP0]]\n+- ;\n+- ; LIMIT1-LABEL: define i16 @runtime_checks_needed(\n+-@@ -82,9 +88,14 @@\n+- !3 = !{!\"llvm.loop.vectorize.enable\", i1 true}\n+- \n+- ;.\n+--; LIMIT0: [[LOOP0]] = distinct !{[[LOOP0]], [[META1:![0-9]+]], [[META2:![0-9]+]]}\n+--; LIMIT0: [[META1]] = !{!\"llvm.loop.vectorize.width\", i32 2}\n+--; LIMIT0: [[META2]] = !{!\"llvm.loop.vectorize.enable\", i1 true}\n+-+; LIMIT0: [[META0]] = !{[[META1:![0-9]+]]}\n+-+; LIMIT0: [[META1]] = distinct !{[[META1]], [[META2:![0-9]+]]}\n+-+; LIMIT0: [[META2]] = distinct !{[[META2]], !\"LVerDomain\"}\n+-+; LIMIT0: [[META3]] = !{[[META4:![0-9]+]]}\n+-+; LIMIT0: [[META4]] = distinct !{[[META4]], [[META2]]}\n+-+; LIMIT0: [[LOOP5]] = distinct !{[[LOOP5]], [[META6:![0-9]+]], [[META7:![0-9]+]]}\n+-+; LIMIT0: [[META6]] = !{!\"llvm.loop.isvectorized\", i32 1}\n+-+; LIMIT0: [[META7]] = !{!\"llvm.loop.unroll.runtime.disable\"}\n+- ;.\n+- ; LIMIT1: [[META0]] = !{[[META1:![0-9]+]]}\n+- ; LIMIT1: [[META1]] = distinct !{[[META1]], [[META2:![0-9]+]]}\n+-diff -ruN --strip-trailing-cr a/mlir/lib/Bytecode/Reader/BytecodeReader.cpp b/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n+---- a/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n+-+++ b/mlir/lib/Bytecode/Reader/BytecodeReader.cpp\n+-@@ -1320,8 +1320,9 @@\n+- }\n+- \n+- template <typename T>\n+--T AttrTypeReader::resolveEntry(SmallVectorImpl<Entry<T>> &entries, size_t index,\n+--                               StringRef entryType, uint64_t depth) {\n+-+T AttrTypeReader::resolveEntry(SmallVectorImpl<Entry<T>> &entries,\n+-+                               uint64_t index, StringRef entryType,\n+-+                               uint64_t depth) {\n+-   if (index >= entries.size()) {\n+-     emitError(fileLoc) << \"invalid \" << entryType << \" index: \" << index;\n+-     return {};\n diff --git a/third_party/llvm/workspace.bzl b/third_party/llvm/workspace.bzl\n-index dd3d4e4..e573782 100644\n+index e573782..3c9c005 100644\n --- a/third_party/llvm/workspace.bzl\n +++ b/third_party/llvm/workspace.bzl\n @@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\")\n  \n  def repo(name):\n      \"\"\"Imports LLVM.\"\"\"\n--    LLVM_COMMIT = \"c6e23ab80753a01dce270f5f8a133fbec942315d\"\n--    LLVM_SHA256 = \"5a6b8aacd2d87ce9c4456843a76d0a54fd7cd0ae788ed3f19e7487ecd2ce4326\"\n-+    LLVM_COMMIT = \"87bf5ee23863bc0b467ee44b2184b2c134a98464\"\n-+    LLVM_SHA256 = \"9d0bca271bfb266de8453cd34156741fd41f64b911f580262d187ce4d4d9b6d9\"\n+-    LLVM_COMMIT = \"87bf5ee23863bc0b467ee44b2184b2c134a98464\"\n+-    LLVM_SHA256 = \"9d0bca271bfb266de8453cd34156741fd41f64b911f580262d187ce4d4d9b6d9\"\n++    LLVM_COMMIT = \"48d942c7158af43094db1b5e6c59c6e6fcf1b5aa\"\n++    LLVM_SHA256 = \"6ce4ac276a4687625e9f57e53715285d99b60c6553e0cde4db9b7e74f2179f69\"\n  \n      tf_http_archive(\n          name = name,"
        },
        {
            "sha": "230123596f420e966953fed851926f9089d7dd3c",
            "filename": "third_party/xla/third_party/shardy/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/52178014a650ee63df1791f0c023e437a1e7033e/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl?ref=52178014a650ee63df1791f0c023e437a1e7033e",
            "patch": "@@ -3,8 +3,8 @@\n load(\"//third_party:repo.bzl\", \"tf_http_archive\", \"tf_mirror_urls\")\n \n def repo():\n-    SHARDY_COMMIT = \"879ea7b95f957a2fc66da58b10d21390eb5f449a\"\n-    SHARDY_SHA256 = \"222ec7b6c591888207d4de5795e03fe81ec94b3acb59a421ce02ff7ace38dc07\"\n+    SHARDY_COMMIT = \"d9023f29bb8ad1fcb72b8183de06f8bc86fc195d\"\n+    SHARDY_SHA256 = \"2b8951f25c0c1e6c1569b842ef3f68a3cefdcc2a1a53eb6f4970d5bf1df91eb5\"\n \n     tf_http_archive(\n         name = \"shardy\","
        }
    ],
    "stats": {
        "total": 3241,
        "additions": 1084,
        "deletions": 2157
    }
}