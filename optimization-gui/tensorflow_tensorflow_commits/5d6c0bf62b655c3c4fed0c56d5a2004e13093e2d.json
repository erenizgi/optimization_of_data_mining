{
    "author": "dsharletg",
    "message": "Unconditionally include YNNPACK\n\nThis was disabled on windows due to lack of compatibility, it is hopefully now compatible.\n\nPiperOrigin-RevId: 843870100",
    "sha": "5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
    "files": [
        {
            "sha": "6fd59cdf1d6bd9e5560555bbd6433cda31bb02a7",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 9,
            "deletions": 15,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -4,7 +4,6 @@ load(\"//xla/tsl:tsl.bzl\", \"if_google\", \"if_windows\", \"internal_visibility\")\n load(\"//xla/tsl:tsl.default.bzl\", \"filegroup\")\n load(\"//xla/tsl/platform:build_config.bzl\", \"tf_proto_library\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n-load(\"//xla/tsl/xnnpack:build_defs.bzl\", \"if_ynnpack\")\n \n package(\n     # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n@@ -169,14 +168,15 @@ cc_library(\n     name = \"thunk\",\n     srcs = [\"thunk.cc\"],\n     hdrs = [\"thunk.h\"],\n-    defines = if_ynnpack([\"XLA_YNNPACK\"]),\n     deps = [\n         \":buffer_allocations\",\n         \":function_library\",\n         \":xfeed_manager\",\n         \"//xla:executable_run_options\",\n         \"//xla/backends/cpu/collectives:cpu_collectives\",\n         \"//xla/backends/cpu/collectives:in_process_collectives\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_interop\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_threadpool\",\n         \"//xla/ffi:execution_context\",\n         \"//xla/runtime:buffer_use\",\n         \"//xla/runtime:device_id\",\n@@ -196,10 +196,7 @@ cc_library(\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@local_tsl//tsl/profiler/lib:traceme\",\n         \"@local_tsl//tsl/profiler/lib:traceme_encode\",\n-    ] + if_ynnpack([\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_interop\",\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_threadpool\",\n-    ]),\n+    ],\n )\n \n cc_library(\n@@ -1250,7 +1247,10 @@ cc_library(\n         \":while_thunk\",\n         \"//xla:shape_util\",\n         \"//xla:util\",\n+        \"//xla/backends/cpu:ynn_emitter\",\n         \"//xla/backends/cpu:ynn_fusion_options_proto_cc\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_fusion_thunk\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_interop\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/runtime:resource_use\",\n         \"//xla/runtime:work_group\",\n@@ -1271,11 +1271,7 @@ cc_library(\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n         \"@local_tsl//tsl/platform:casts\",\n-    ] + if_ynnpack([\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_fusion_thunk\",\n-        \"//xla/backends/cpu:ynn_emitter\",\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_interop\",\n-    ]),\n+    ],\n )\n \n cc_library(\n@@ -1310,7 +1306,6 @@ xla_cc_test(\n xla_cc_test(\n     name = \"thunk_sequence_serdes_test\",\n     srcs = [\"thunk_sequence_serdes_test.cc\"],\n-    local_defines = if_ynnpack([\"XLA_YNNPACK\"]),\n     deps = [\n         \":all_gather_thunk\",\n         \":all_reduce_thunk\",\n@@ -1345,6 +1340,7 @@ xla_cc_test(\n         \"//xla:shape_util\",\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_fusion_thunk\",\n         \"//xla/ffi\",\n         \"//xla/ffi:ffi_api\",\n         \"//xla/runtime:resource_use\",\n@@ -1365,9 +1361,7 @@ xla_cc_test(\n         \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@local_tsl//tsl/platform:casts\",\n-    ] + if_ynnpack([\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_fusion_thunk\",\n-    ]),\n+    ],\n )\n \n cc_library("
        },
        {
            "sha": "0468b0c3e84b11fb7b427d0014623c19f2a5da79",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -29,6 +29,8 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/backends/cpu/collectives/cpu_collectives.h\"\n #include \"xla/backends/cpu/collectives/in_process_collectives.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_threadpool.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/runtime/device_id.h\"\n #include \"xla/service/cpu/cpu_executable_run_options.h\"\n@@ -41,11 +43,6 @@ limitations under the License.\n #include \"tsl/profiler/lib/traceme.h\"\n #include \"tsl/profiler/lib/traceme_encode.h\"\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_threadpool.h\"\n-#endif  // XLA_YNNPACK\n-\n namespace xla::cpu {\n \n // Ok execute event allocated with the static storage duration.\n@@ -161,7 +158,6 @@ Thunk::CustomCallExecuteParams::CustomCallExecuteParams(\n       intra_op_thread_pool(intra_op_thread_pool),\n       ffi_execution_context(ffi_execution_context) {}\n \n-#ifdef XLA_YNNPACK\n absl::StatusOr<Thunk::YnnParams> Thunk::YnnParams::Create(\n     const ExecutableRunOptions* run_options) {\n   TF_ASSIGN_OR_RETURN(YnnThreadpool threadpool,\n@@ -171,7 +167,6 @@ absl::StatusOr<Thunk::YnnParams> Thunk::YnnParams::Create(\n \n Thunk::YnnParams::YnnParams(YnnThreadpool threadpool)\n     : threadpool(std::move(threadpool)) {}\n-#endif  // XLA_YNNPACK\n \n Thunk::ExecuteSession::ExecuteSession(int64_t max_workers,\n                                       int64_t split_threshold)"
        },
        {
            "sha": "a30eb2b27f76dd113e1b3e90f55397bacaf29642",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk.h",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk.h?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -35,6 +35,8 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/buffer_allocations.h\"\n #include \"xla/backends/cpu/runtime/function_library.h\"\n #include \"xla/backends/cpu/runtime/xfeed_manager.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_threadpool.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/ffi/execution_context.h\"\n #include \"xla/runtime/buffer_use.h\"\n@@ -45,11 +47,6 @@ limitations under the License.\n #include \"xla/tsl/platform/logging.h\"\n #include \"xla/tsl/platform/statusor.h\"\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_threadpool.h\"\n-#endif  // XLA_YNNPACK\n-\n namespace Eigen {\n struct ThreadPoolDevice;\n }  // namespace Eigen\n@@ -255,7 +252,6 @@ class Thunk {\n   // YnnParams\n   //===--------------------------------------------------------------------===//\n \n-#ifdef XLA_YNNPACK\n   // Parameters capturing all the details required for running XNNPACK fusions.\n   struct YnnParams {\n     static absl::StatusOr<YnnParams> Create(\n@@ -265,10 +261,6 @@ class Thunk {\n \n     explicit YnnParams(YnnThreadpool threadpool);\n   };\n-#else\n-  // Use XnnParams for placeholder. The parameter won't be used anyway.\n-  struct YnnParams {};\n-#endif  // XLA_YNNPACK\n \n   //===--------------------------------------------------------------------===//\n   // ExecuteParams"
        },
        {
            "sha": "d8381b601813d1da9d6c92d117e7295e358dff1b",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_proto_serdes.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 14,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -61,6 +61,9 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n #include \"xla/backends/cpu/runtime/topk_thunk.h\"\n #include \"xla/backends/cpu/runtime/while_thunk.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n+#include \"xla/backends/cpu/ynn_emitter.h\"\n #include \"xla/backends/cpu/ynn_fusion_options.pb.h\"\n #include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n@@ -77,12 +80,6 @@ limitations under the License.\n #include \"xla/util.h\"\n #include \"tsl/platform/casts.h\"\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.h\"\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n-#include \"xla/backends/cpu/ynn_emitter.h\"\n-#endif  // XLA_YNNPACK\n-\n namespace xla::cpu {\n \n void ForEachThunkProto(const ThunkSequenceProto& proto,\n@@ -716,7 +713,6 @@ static absl::Status ToProto(const WhileThunk& thunk, ThunkProto& proto) {\n   return absl::OkStatus();\n }\n \n-#ifdef XLA_YNNPACK\n static absl::Status ToProto(const YnnFusionThunk& thunk, ThunkProto& proto) {\n   YnnFusionThunkProto* ynn_fusion_proto = proto.mutable_ynn_fusion_thunk();\n   ynn_fusion_proto->mutable_options()->set_use_threadpool(\n@@ -736,7 +732,6 @@ static absl::Status ToProto(const YnnFusionThunk& thunk, ThunkProto& proto) {\n \n   return absl::OkStatus();\n }\n-#endif  // XLA_YNNPACK\n \n static absl::Status ToProto(const FftThunk& thunk, ThunkProto& proto) {\n   FftThunkProto* fft_thunk_proto = proto.mutable_fft_thunk();\n@@ -919,12 +914,10 @@ absl::StatusOr<ThunkProto> ThunkSerDesProtobuf::ToProto(\n                   internal::LogicalIdKind::kReplicaId>&>(thunk)),\n           proto));\n       break;\n-#ifdef XLA_YNNPACK\n     case Thunk::Kind::kYnnFusion:\n       TF_RETURN_IF_ERROR(::xla::cpu::ToProto(\n           tsl::down_cast<const YnnFusionThunk&>(thunk), proto));\n       break;\n-#endif  // XLA_YNNPACK\n     default:\n       return absl::UnimplementedError(\n           absl::StrFormat(\"ToProto is not implemented for thunk kind: %s\",\n@@ -1455,7 +1448,6 @@ static absl::StatusOr<std::unique_ptr<WhileThunk>> WhileThunkFromProto(\n                             std::move(*body_sequence), trip_count);\n }\n \n-#ifdef XLA_YNNPACK\n static absl::StatusOr<std::unique_ptr<YnnFusionThunk>> YnnFusionThunkFromProto(\n     const ThunkProto& proto, const HloModule* hlo_module,\n     const std::vector<BufferAllocation>& buffer_allocations) {\n@@ -1533,7 +1525,6 @@ static absl::StatusOr<std::unique_ptr<YnnFusionThunk>> YnnFusionThunkFromProto(\n       },\n       captured_arguments_ids);\n }\n-#endif  // XLA_YNNPACK\n \n static absl::StatusOr<std::unique_ptr<Thunk>> PartitionIdThunkFromProto(\n     const ThunkProto& proto,\n@@ -1633,10 +1624,8 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n       return PartitionIdThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kReplicaId:\n       return ReplicaIdThunkFromProto(proto, *buffer_allocations_);\n-#ifdef XLA_YNNPACK\n     case Thunk::Kind::kYnnFusion:\n       return YnnFusionThunkFromProto(proto, hlo_module_, *buffer_allocations_);\n-#endif  // XLA_YNNPACK\n     default:\n       return absl::Status(absl::StatusCode::kInvalidArgument,\n                           absl::StrFormat(\"Unsupported thunk kind: %s\","
        },
        {
            "sha": "f4720cd7756d99198a63c4ad00f21ae94cb7dd1e",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_sequence_serdes_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -59,6 +59,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk_testlib.h\"\n #include \"xla/backends/cpu/runtime/topk_thunk.h\"\n #include \"xla/backends/cpu/runtime/while_thunk.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.h\"\n #include \"xla/ffi/ffi.h\"\n #include \"xla/ffi/ffi_api.h\"\n #include \"xla/literal.h\"\n@@ -77,10 +78,6 @@ limitations under the License.\n #include \"xla/xla_data.pb.h\"\n #include \"tsl/platform/casts.h\"\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.h\"\n-#endif  // XLA_YNNPACK\n-\n namespace xla::cpu {\n namespace {\n \n@@ -1028,14 +1025,12 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n            thunk_1.trip_count() == thunk_2.trip_count();\n   }\n \n-#ifdef XLA_YNNPACK\n   bool VerifyYnnFusionThunkEquality(const YnnFusionThunk& thunk_1,\n                                     const YnnFusionThunk& thunk_2) {\n     // TODO(ashaposhnikov) assume this is always false until we implement\n     // serialization of YnnFusionThunk.\n     return false;\n   }\n-#endif  // XLA_YNNPACK\n \n   bool VerifyKernelThunkEquality(const KernelThunkBase& thunk_1,\n                                  const KernelThunkBase& thunk_2) {\n@@ -1231,7 +1226,6 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n             tsl::down_cast<const WhileThunk&>(thunk_1),\n             tsl::down_cast<const WhileThunk&>(thunk_2));\n       case Thunk::Kind::kYnnFusion: {\n-#ifdef XLA_YNNPACK\n         const YnnFusionThunk& ynn_fusion_thunk_1 =\n             tsl::down_cast<const YnnFusionThunk&>(thunk_1);\n         const YnnFusionThunk& ynn_fusion_thunk_2 =\n@@ -1243,10 +1237,6 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n         return VerifyYnnFusionThunkEquality(\n             tsl::down_cast<const YnnFusionThunk&>(thunk_1),\n             tsl::down_cast<const YnnFusionThunk&>(thunk_2));\n-#else\n-        CHECK(false) << \"Unsupported YNN fusion thunk type\";\n-        return false;\n-#endif  // XLA_YNNPACK\n       }\n       case Thunk::Kind::kKernel:\n         return VerifyKernelThunkEquality("
        },
        {
            "sha": "2c07477fc16b25bf3fad52851c576bda68ead0f1",
            "filename": "third_party/xla/xla/backends/cpu/runtime/ynnpack/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2FBUILD?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -1,5 +1,5 @@\n+load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n-load(\"//xla/tsl/xnnpack:build_defs.bzl\", \"ynn_cc_test\")\n \n package(\n     # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n@@ -30,7 +30,7 @@ cc_library(\n     ],\n )\n \n-ynn_cc_test(\n+xla_cc_test(\n     name = \"slinky_threadpool_test\",\n     srcs = [\"slinky_threadpool_test.cc\"],\n     deps = [\n@@ -110,7 +110,7 @@ cc_library(\n     ],\n )\n \n-ynn_cc_test(\n+xla_cc_test(\n     name = \"ynn_fusion_thunk_test\",\n     srcs = [\"ynn_fusion_thunk_test.cc\"],\n     deps = ["
        },
        {
            "sha": "67603bc203cdac19b650839f4ea09a29e89577e1",
            "filename": "third_party/xla/xla/backends/cpu/transforms/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -3,7 +3,6 @@ load(\"//xla/tsl:tsl.bzl\", \"internal_visibility\")\n load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\")\n load(\"//xla/tsl/mkl:graph.bzl\", \"onednn_graph_cc_library\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n-load(\"//xla/tsl/xnnpack:build_defs.bzl\", \"if_ynnpack\")\n \n package(\n     # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n@@ -22,10 +21,11 @@ cc_library(\n     name = \"library_rewriter\",\n     srcs = [\"library_rewriter.cc\"],\n     hdrs = [\"library_rewriter.h\"],\n-    defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]) + if_ynnpack([\"XLA_YNNPACK\"]),\n+    defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":library_matcher\",\n         \":onednn_matcher\",\n+        \":ynn_matcher\",\n         \"//xla:shape_util\",\n         \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n@@ -42,13 +42,13 @@ cc_library(\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@local_tsl//tsl/platform:protobuf\",\n-    ] + if_ynnpack([\":ynn_matcher\"]),\n+    ],\n )\n \n xla_cc_test(\n     name = \"library_rewriter_test\",\n     srcs = [\"library_rewriter_test.cc\"],\n-    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]) + if_ynnpack([\"XLA_YNNPACK\"]),\n+    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":library_rewriter\",\n         \"//xla:xla_data_proto_cc\",\n@@ -103,12 +103,13 @@ cc_library(\n     hdrs = [\"ynn_matcher.h\"],\n     deps = [\n         \":library_matcher\",\n+        \"//xla/backends/cpu:ynn_support\",\n         \"//xla/backends/cpu/codegen:target_machine_features\",\n         \"//xla/hlo/ir:hlo\",\n         \"@com_google_absl//absl/base:no_destructor\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@local_tsl//tsl/platform:protobuf\",\n-    ] + if_ynnpack([\"//xla/backends/cpu:ynn_support\"]),\n+    ],\n )"
        },
        {
            "sha": "5dfae6ee54a6411bf145578f8a02c6d8d22ca702",
            "filename": "third_party/xla/xla/backends/cpu/transforms/library_rewriter.h",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter.h?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -28,6 +28,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/backends/cpu/codegen/target_machine_features.h\"\n #include \"xla/backends/cpu/transforms/library_matcher.h\"\n+#include \"xla/backends/cpu/transforms/ynn_matcher.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n@@ -38,9 +39,6 @@ limitations under the License.\n #include \"xla/backends/cpu/transforms/onednn_matcher.h\"\n #endif  // XLA_ONEDNN_USE_GRAPH_API\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/transforms/ynn_matcher.h\"\n-#endif\n \n namespace xla::cpu {\n \n@@ -72,13 +70,11 @@ class LibraryRewriter : public HloModulePass {\n           target_machine_features_, options_.onednn_fusion_types));\n     }\n #endif  // XLA_ONEDNN_USE_GRAPH_API\n-#ifdef XLA_YNNPACK\n     if (options_.use_ynnpack && options_.ynn_fusion_types != nullptr &&\n         !options_.ynn_fusion_types->empty()) {\n       libs_.push_back(std::make_unique<YnnMatcher>(target_machine_features_,\n                                                    options_.ynn_fusion_types));\n     }\n-#endif  // XLA_YNNPACK\n \n     for (std::unique_ptr<LibraryMatcher>& lib : libs_) {\n       supported_ops_.merge(lib->SupportedOps());"
        },
        {
            "sha": "dc02e86a829da6c6fa28c26012def3e65d561921",
            "filename": "third_party/xla/xla/backends/cpu/transforms/library_rewriter_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Flibrary_rewriter_test.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -443,10 +443,8 @@ std::vector<DotRewriteTestSpec> GetDotRewriteTestSpecs() {\n   // Fusion modes to test for each library.\n   absl::flat_hash_map<std::string, std::vector<std::string>> fusion_modes;\n \n-#if XLA_YNNPACK\n   // Don't test YNNPACK if we don't build with it.\n   fusion_modes[\"ynn\"] = {\"dot\", \"greedy\"};\n-#endif\n \n #if XLA_ONEDNN_USE_GRAPH_API\n   // Don't test oneDNN if we don't build with it."
        },
        {
            "sha": "125ef05f15c00a635157734934a521ae8e8817bc",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -1648,12 +1648,10 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n           cpu::Thunk::CustomCallExecuteParams::Create(&run_options));\n \n       std::optional<cpu::Thunk::YnnParams> ynn_params;\n-#ifdef XLA_YNNPACK\n       if (cpu_executable->has_ynn_fusions()) {\n         TF_ASSIGN_OR_RETURN(ynn_params,\n                             cpu::Thunk::YnnParams::Create(&run_options));\n       }\n-#endif  // XLA_YNNPACK\n \n       cpu::ThreadPoolTaskRunner task_runner(\n           run_options.intra_op_thread_pool()->getPool());\n@@ -1793,11 +1791,9 @@ absl::StatusOr<PjRtLoadedExecutable::Result> PjRtCpuExecutable::ExecuteHelper(\n \n             absl::StatusOr<std::optional<cpu::Thunk::YnnParams>> ynn_params(\n                 std::nullopt);\n-#ifdef XLA_YNNPACK\n             if (cpu_executable->has_ynn_fusions()) {\n               ynn_params = cpu::Thunk::YnnParams::Create(&run_options);\n             }\n-#endif  // XLA_YNNPACK\n \n             cpu::ThreadPoolTaskRunner task_runner(\n                 run_options.intra_op_thread_pool()->getPool());"
        },
        {
            "sha": "af4a362ded3a28713a72d290996787916ce01650",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -17,7 +17,6 @@ load(\n     \"if_llvm_x86_available\",\n )\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n-load(\"//xla/tsl/xnnpack:build_defs.bzl\", \"if_ynnpack\")\n load(\":build_defs.bzl\", \"runtime_copts\")\n \n package(\n@@ -158,6 +157,7 @@ cc_library(\n         \"//xla/backends/cpu:alignment\",\n         \"//xla/backends/cpu:constant_allocation\",\n         \"//xla/backends/cpu:target_machine_options\",\n+        \"//xla/backends/cpu:ynn_support\",\n         \"//xla/backends/cpu/codegen:builtin_definition_generator\",\n         \"//xla/backends/cpu/codegen:compiled_function_library\",\n         \"//xla/backends/cpu/codegen:cpu_features\",\n@@ -354,8 +354,6 @@ cc_library(\n         \":onednn_contraction_rewriter\",\n         \":onednn_float_support\",\n         \":onednn_ops_rewriter\",\n-    ]) + if_ynnpack([\n-        \"//xla/backends/cpu:ynn_support\",\n     ]),\n )\n \n@@ -803,7 +801,7 @@ cc_library(\n     srcs = [\"thunk_emitter.cc\"],\n     hdrs = [\"thunk_emitter.h\"],\n     copts = tsl_copts(),\n-    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]) + if_ynnpack([\"XLA_YNNPACK\"]),\n+    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":backend_config_proto_cc\",\n         \":cpu_options\",\n@@ -819,6 +817,8 @@ cc_library(\n         \"//xla/backends/cpu:alignment\",\n         \"//xla/backends/cpu:onednn_emitter\",\n         \"//xla/backends/cpu:onednn_support\",\n+        \"//xla/backends/cpu:ynn_emitter\",\n+        \"//xla/backends/cpu:ynn_support\",\n         \"//xla/backends/cpu/codegen:computation_kernel_emitter\",\n         \"//xla/backends/cpu/codegen:fusion_compiler\",\n         \"//xla/backends/cpu/codegen:fusion_emitter\",\n@@ -851,6 +851,8 @@ cc_library(\n         \"//xla/backends/cpu/runtime:topk_thunk\",\n         \"//xla/backends/cpu/runtime:while_thunk\",\n         \"//xla/backends/cpu/runtime/onednn:onednn_fusion_thunk\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_fusion_thunk\",\n+        \"//xla/backends/cpu/runtime/ynnpack:ynn_interop\",\n         \"//xla/codegen:kernel_definition\",\n         \"//xla/codegen:kernel_spec\",\n         \"//xla/codegen:llvm_kernel_source\",\n@@ -890,11 +892,6 @@ cc_library(\n         \"@local_tsl//tsl/profiler/lib:traceme\",\n     ] + if_onednn([\n         \"//xla/backends/cpu/runtime/onednn:onednn_op_thunk\",\n-    ]) + if_ynnpack([\n-        \"//xla/backends/cpu:ynn_emitter\",\n-        \"//xla/backends/cpu:ynn_support\",\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_interop\",\n-        \"//xla/backends/cpu/runtime/ynnpack:ynn_fusion_thunk\",\n     ]),\n )\n "
        },
        {
            "sha": "19538cd5831074c6c5af704ee7e4f0bee3e83d81",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 14,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -98,6 +98,7 @@ limitations under the License.\n #include \"xla/backends/cpu/target_machine_options.h\"\n #include \"xla/backends/cpu/transforms/collectives/all_reduce_combiner.h\"\n #include \"xla/backends/cpu/transforms/library_rewriter.h\"\n+#include \"xla/backends/cpu/ynn_support.h\"\n #include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/analysis/hlo_ordering.h\"\n #include \"xla/hlo/ir/dfs_hlo_visitor_with_default.h\"\n@@ -249,10 +250,6 @@ limitations under the License.\n #include \"xla/service/cpu/onednn_ops_rewriter.h\"\n #endif  // XLA_ONEDNN\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/ynn_support.h\"\n-#endif  // XLA_YNNPACK\n-\n namespace xla {\n namespace {\n \n@@ -497,7 +494,6 @@ std::unique_ptr<HloPassFix<HloPassPipeline>> CreateSimplificationPipeline(\n     pipeline->AddPass<TreeReductionRewriter>();\n   }\n \n-#ifdef XLA_YNNPACK\n   if (absl::c_contains(module->config()\n                            .debug_options()\n                            .xla_cpu_experimental_ynn_fusion_type(),\n@@ -507,7 +503,6 @@ std::unique_ptr<HloPassFix<HloPassPipeline>> CreateSimplificationPipeline(\n           return !IsReduceOpOffloadedToYnn(hlo);\n         });\n   }\n-#endif\n \n   // BatchNormExpander can create zero-sized ops, so zero-sized HLO\n   // elimination has to come after that pass.\n@@ -534,24 +529,19 @@ std::unique_ptr<HloPassFix<HloPassPipeline>> CreateSimplificationPipeline(\n \n auto LibrarySupportsConvolution(\n     HloModule* module, TargetMachineFeatures* target_machine_features) {\n-#ifdef XLA_YNNPACK\n   const bool ynnpack_convolution_enabled = absl::c_linear_search(\n       module->config().debug_options().xla_cpu_experimental_ynn_fusion_type(),\n       DebugOptions::LIBRARY_FUSION_TYPE_INDIVIDUAL_CONVOLUTION);\n   return [=](const HloInstruction& instr) {\n     return ynnpack_convolution_enabled && IsConvolutionOpSupportedByYnn(&instr);\n   };\n-#else\n-  return [](const HloInstruction&) { return false; };\n-#endif  // XLA_YNNPACK\n }\n \n auto LibrarySupportsDot(HloModule* module,\n                         TargetMachineFeatures* target_machine_features) {\n   // TODO(b/406806134): Stop calling XNNPACK from regular Dot thunks. All XNN\n   // Dots should be wrapped in an `__xnn_fusion` fusion region and processed in\n   // `XnnFusionThunk`.\n-#ifdef XLA_YNNPACK\n   const bool ynnpack_dot_enabled = absl::c_linear_search(\n       module->config().debug_options().xla_cpu_experimental_ynn_fusion_type(),\n       DebugOptions::LIBRARY_FUSION_TYPE_INDIVIDUAL_DOT);\n@@ -566,9 +556,6 @@ auto LibrarySupportsDot(HloModule* module,\n \n     return false;\n   };\n-#else\n-  return [](const HloInstruction&) { return false; };\n-#endif  // XLA_YNNPACK\n }\n \n }  // namespace"
        },
        {
            "sha": "e04c3205a92c0e64655f7b62460e723cc426172d",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -258,11 +258,9 @@ absl::Status CpuExecutable::ExecuteThunks(\n \n   // Prepare for executing YNNPACK fusions.\n   std::optional<Thunk::YnnParams> ynn_params;\n-#ifdef XLA_YNNPACK\n   if (has_ynn_fusions()) {\n     TF_ASSIGN_OR_RETURN(ynn_params, Thunk::YnnParams::Create(run_options));\n   }\n-#endif  // XLA_YNNPACK\n \n   // Use the intra-op thread pool to offload thunk executor tasks.\n   auto* intra_op_thread_pool = run_options->intra_op_thread_pool();"
        },
        {
            "sha": "5a77a764108d54e844948ac31e1a9c4aa31b73f2",
            "filename": "third_party/xla/xla/service/cpu/thunk_emitter.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 17,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fthunk_emitter.cc?ref=5d6c0bf62b655c3c4fed0c56d5a2004e13093e2d",
            "patch": "@@ -69,6 +69,10 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/topk_thunk.h\"\n #include \"xla/backends/cpu/runtime/while_thunk.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.h\"\n+#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n+#include \"xla/backends/cpu/ynn_emitter.h\"\n+#include \"xla/backends/cpu/ynn_support.h\"\n #include \"xla/codegen/emitters/computation_fingerprint.h\"\n #include \"xla/codegen/emitters/kernel_api_builder.h\"\n #include \"xla/codegen/emitters/kernel_arguments.h\"\n@@ -121,13 +125,6 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/onednn/onednn_fusion_thunk.h\"\n #endif  // XLA_ONEDNN_USE_GRAPH_API\n \n-#ifdef XLA_YNNPACK\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.h\"\n-#include \"xla/backends/cpu/runtime/ynnpack/ynn_interop.h\"\n-#include \"xla/backends/cpu/ynn_emitter.h\"\n-#include \"xla/backends/cpu/ynn_support.h\"\n-#endif  // XLA_YNNPACK\n-\n namespace xla::cpu {\n \n namespace {\n@@ -441,11 +438,9 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitHloInstruction(\n         }\n #endif  // XLA_ONEDNN_USE_GRAPH_API\n \n-#ifdef XLA_YNNPACK\n         if (backend_config.fusion_config().kind() == kYnnFusionKind) {\n           return EmitYnnFusionThunk(instruction);\n         }\n-#endif  // XLA_YNNPACK\n \n         return Internal(\"Unsupported custom fusion kind: %s\",\n                         backend_config.DebugString());\n@@ -762,7 +757,6 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitConvolutionThunk(\n       /*supported_types=*/\n       {PRED, S8, U8, S16, U16, S32, U32, S64, U64, F16, F32, F64, C64, C128}));\n \n-#ifdef XLA_YNNPACK\n   const bool use_ynn = absl::c_linear_search(\n       hlo_module_config_.debug_options().xla_cpu_experimental_ynn_fusion_type(),\n       DebugOptions::LIBRARY_FUSION_TYPE_INDIVIDUAL_CONVOLUTION);\n@@ -771,7 +765,6 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitConvolutionThunk(\n       return EmitYnnFusionThunk(instruction);\n     }\n   }\n-#endif  // XLA_YNNPACK\n \n   // TODO(tonywy): Add PotentiallyImplementedAsMKLConvolution to support\n   // different data layouts.\n@@ -1090,7 +1083,6 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitDotThunk(\n       TF_ASSIGN_OR_RETURN(BufferAllocation::Slice out_slice,\n                           GetAllocationSlice(instruction));\n \n-#ifdef XLA_YNNPACK\n       const bool use_ynn = absl::c_linear_search(\n           hlo_module_config_.debug_options()\n               .xla_cpu_experimental_ynn_fusion_type(),\n@@ -1104,7 +1096,6 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitDotThunk(\n           return EmitYnnFusionThunk(instruction);\n         }\n       }\n-#endif  // XLA_YNNPACK\n \n       return ThunkSequence::Of<DotThunk>(\n           ThunkInfo(instruction), dnums, lhs_slice, lhs->shape(), rhs_slice,\n@@ -1474,7 +1465,6 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitOneDnnFusionThunk(\n \n absl::StatusOr<ThunkSequence> ThunkEmitter::EmitYnnFusionThunk(\n     const HloInstruction* instruction) {\n-#ifdef XLA_YNNPACK\n   // Collect YNNPACK fusion arguments.\n   std::vector<YnnFusionThunk::Argument> arguments;\n   for (HloInstruction* operand : instruction->operands()) {\n@@ -1530,9 +1520,6 @@ absl::StatusOr<ThunkSequence> ThunkEmitter::EmitYnnFusionThunk(\n         return b(arg_buffers);\n       },\n       captured_arguments_ids);\n-#else\n-  return Unimplemented(\"XLA is not built with YNNPACK.\");\n-#endif  // XLA_YNNPACK\n }\n \n absl::StatusOr<ThunkEmitter::HostKernelAllocationSlices>"
        },
        {
            "sha": "5aab05cadd11327f3fab0862ecb4089687933b55",
            "filename": "third_party/xla/xla/tsl/xnnpack/build_defs.bzl",
            "status": "removed",
            "additions": 0,
            "deletions": 38,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e5edcc5c018d1d3825b55e56dd65f92b32e7aeea/third_party%2Fxla%2Fxla%2Ftsl%2Fxnnpack%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e5edcc5c018d1d3825b55e56dd65f92b32e7aeea/third_party%2Fxla%2Fxla%2Ftsl%2Fxnnpack%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fxnnpack%2Fbuild_defs.bzl?ref=e5edcc5c018d1d3825b55e56dd65f92b32e7aeea",
            "patch": "@@ -1,38 +0,0 @@\n-\"\"\"Macros for XNNPACK and YNNPACK.\"\"\"\n-\n-load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n-load(\"//xla/tsl:package_groups.bzl\", \"DEFAULT_LOAD_VISIBILITY\")\n-\n-visibility(DEFAULT_LOAD_VISIBILITY)\n-\n-def if_ynnpack(if_true, if_false = []):\n-    \"\"\"Selection based on whether we are building XLA with YNNPACK integration.\n-\n-    Args:\n-      if_true: Expression to evaluate if building with YNNPACK.\n-      if_false: Expression to evaluate if building without YNNPACK.\n-\n-    Returns:\n-      A select evaluating to either if_true or if_false as appropriate.\n-    \"\"\"\n-    return select({\n-        # YNNPACK is not tested on Windows.\n-        \"//xla/tsl:windows\": if_false,\n-        \"//conditions:default\": if_true,\n-    })\n-\n-def ynn_cc_test(\n-        srcs = [],\n-        deps = [],\n-        **kwargs):\n-    \"\"\"xla_cc_test rule with empty src and deps if not building with YNNPACK.\"\"\"\n-    xla_cc_test(\n-        # CC_TEST_OK=Just defining `xla_cc_test` rule to be used in XLA.\n-        srcs = if_ynnpack(srcs),\n-        deps = if_ynnpack(if_true = deps, if_false = [\"@com_google_googletest//:gtest_main\"]),\n-        # If not building with YNNPACK, we don't have any tests linked.\n-        fail_if_no_test_linked = False,\n-        # If not building with YNNPACK, we don't have any tests defined either.\n-        fail_if_no_test_selected = False,\n-        **kwargs\n-    )"
        }
    ],
    "stats": {
        "total": 194,
        "additions": 38,
        "deletions": 156
    }
}