{
    "author": "pifon2a",
    "message": "[XLA:GPU][ScaledDot] Add output->input indexing for scaled-dot HLO.\n\nPiperOrigin-RevId: 800160161",
    "sha": "60bb2701d8c664c6a32568722192feb3767e25c0",
    "files": [
        {
            "sha": "a5597b18e103e3770c44f463b3b499892922bd43",
            "filename": "third_party/xla/xla/hlo/analysis/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60bb2701d8c664c6a32568722192feb3767e25c0/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60bb2701d8c664c6a32568722192feb3767e25c0/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2FBUILD?ref=60bb2701d8c664c6a32568722192feb3767e25c0",
            "patch": "@@ -643,7 +643,6 @@ cc_library(\n         \"//xla/hlo/utils:hlo_traversal\",\n         \"//xla/service:matmul_indexing_utils\",\n         \"@com_google_absl//absl/algorithm:container\",\n-        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/container:inlined_vector\","
        },
        {
            "sha": "1abd4b4f500c7009a0c9d7e74bea59ccfc2df270",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_analysis.cc",
            "status": "modified",
            "additions": 67,
            "deletions": 15,
            "changes": 82,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60bb2701d8c664c6a32568722192feb3767e25c0/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60bb2701d8c664c6a32568722192feb3767e25c0/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis.cc?ref=60bb2701d8c664c6a32568722192feb3767e25c0",
            "patch": "@@ -331,10 +331,9 @@ HloInstructionIndexing ComputeOutputToInputFusionOpIndexing(\n   return fusion_indexing;\n }\n \n-HloInstructionIndexing ComputeOutputToInputDotOpIndexing(\n-    const HloDotInstruction* dot, MLIRContext* mlir_context) {\n-  CHECK_NE(dot, nullptr);\n-  const DotDimensionNumbers& dim_numbers = dot->dot_dimension_numbers();\n+std::pair<IndexingMap, IndexingMap> ComputeDotOperandsIndexingImpl(\n+    const Shape& lhs_shape, const Shape& rhs_shape, const Shape& output_shape,\n+    const DotDimensionNumbers& dim_numbers, MLIRContext* mlir_context) {\n   absl::Span<const int64_t> lhs_contracting_dims(\n       dim_numbers.lhs_contracting_dimensions());\n   absl::Span<const int64_t> rhs_contracting_dims =\n@@ -343,8 +342,6 @@ HloInstructionIndexing ComputeOutputToInputDotOpIndexing(\n   absl::Span<const int64_t> lhs_batch_dims = dim_numbers.lhs_batch_dimensions();\n   absl::Span<const int64_t> rhs_batch_dims = dim_numbers.rhs_batch_dimensions();\n \n-  const Shape& lhs_shape = dot->operand(0)->shape();\n-  const Shape& rhs_shape = dot->operand(1)->shape();\n   // According to the StableHLO specification, the dimensions of the output\n   // shape are ordered as follows:\n   //   lhs_batch_dims | lhs_non_contracting_dims | rhs_non_contracting_dims\n@@ -396,17 +393,69 @@ HloInstructionIndexing ComputeOutputToInputDotOpIndexing(\n     input_dim_sizes.push_back(lhs_shape.dimensions(lhs_contracting_dim));\n   }\n \n-  IndexingMap lhs_indexing_map = IndexingMap::FromTensorSizes(\n-      AffineMap::get(dot->shape().dimensions().size(), input_dim_sizes.size(),\n-                     lhs_exprs, mlir_context),\n-      dot->shape().dimensions(), input_dim_sizes);\n+  int64_t output_rank = output_shape.dimensions().size();\n+  return std::make_pair(IndexingMap::FromTensorSizes(\n+                            AffineMap::get(output_rank, input_dim_sizes.size(),\n+                                           lhs_exprs, mlir_context),\n+                            output_shape.dimensions(), input_dim_sizes),\n+                        IndexingMap::FromTensorSizes(\n+                            AffineMap::get(output_rank, input_dim_sizes.size(),\n+                                           rhs_exprs, mlir_context),\n+                            output_shape.dimensions(), input_dim_sizes));\n+}\n+\n+// Returns the new map with the results scaled by (operand_shape / scale_shape).\n+IndexingMap RescaleIndexingMap(const IndexingMap& operand_map,\n+                               const Shape& operand_shape,\n+                               const Shape& scale_shape) {\n+  SmallVector<AffineExpr> exprs;\n+  exprs.reserve(operand_shape.dimensions().size());\n+  AffineMap affine_map = operand_map.GetAffineMap();\n+  for (const auto& [scale_dim, operand_dim, expr] :\n+       llvm::zip(scale_shape.dimensions(), operand_shape.dimensions(),\n+                 affine_map.getResults())) {\n+    CHECK_EQ(operand_dim % scale_dim, 0)\n+        << \"Scale dimension must divide the operand dimension.\";\n+    exprs.push_back(scale_dim == operand_dim\n+                        ? expr\n+                        : expr.floorDiv(operand_dim / scale_dim));\n+  }\n+  return IndexingMap{\n+      AffineMap::get(affine_map.getNumDims(), affine_map.getNumSymbols(), exprs,\n+                     affine_map.getContext()),\n+      operand_map.GetDimVars(), operand_map.GetRangeVars(),\n+      operand_map.GetRTVars()};\n+}\n+\n+HloInstructionIndexing ComputeOutputToInputDotOpIndexing(\n+    const HloDotInstruction* dot, MLIRContext* mlir_context) {\n+  const Shape& lhs_shape = dot->operand(0)->shape();\n+  const Shape& rhs_shape = dot->operand(1)->shape();\n+\n+  auto [lhs_map, rhs_map] = ComputeDotOperandsIndexingImpl(\n+      lhs_shape, rhs_shape, dot->shape(), dot->dot_dimension_numbers(),\n+      mlir_context);\n+  return HloInstructionIndexing::FromIndexingMaps({lhs_map, rhs_map});\n+}\n+\n+HloInstructionIndexing ComputeOutputToInputScaledDotOpIndexing(\n+    const HloScaledDotInstruction* scaled_dot, MLIRContext* mlir_context) {\n+  const Shape& lhs_shape = scaled_dot->operand(0)->shape();\n+  const Shape& lhs_scale_shape = scaled_dot->operand(1)->shape();\n+  const Shape& rhs_shape = scaled_dot->operand(2)->shape();\n+  const Shape& rhs_scale_shape = scaled_dot->operand(3)->shape();\n+\n+  auto [lhs_map, rhs_map] = ComputeDotOperandsIndexingImpl(\n+      lhs_shape, rhs_shape, scaled_dot->shape(),\n+      scaled_dot->dot_dimension_numbers(), mlir_context);\n+\n+  IndexingMap lhs_scale_map =\n+      RescaleIndexingMap(lhs_map, lhs_shape, lhs_scale_shape);\n+  IndexingMap rhs_scale_map =\n+      RescaleIndexingMap(rhs_map, rhs_shape, rhs_scale_shape);\n \n-  IndexingMap rhs_indexing_map = IndexingMap::FromTensorSizes(\n-      AffineMap::get(dot->shape().dimensions().size(), input_dim_sizes.size(),\n-                     rhs_exprs, mlir_context),\n-      dot->shape().dimensions(), input_dim_sizes);\n   return HloInstructionIndexing::FromIndexingMaps(\n-      {lhs_indexing_map, rhs_indexing_map});\n+      {lhs_map, lhs_scale_map, rhs_map, rhs_scale_map});\n }\n \n HloInstructionIndexing ComputeOutputToInputDynamicSliceOpIndexing(\n@@ -1598,6 +1647,9 @@ HloInstructionIndexing ComputeOutputToInputIndexing(const HloInstruction* instr,\n   if (auto reverse = DynCast<HloReverseInstruction>(instr)) {\n     return ComputeReverseOpIndexing(reverse, ctx);\n   }\n+  if (auto scaled_dot = DynCast<HloScaledDotInstruction>(instr)) {\n+    return ComputeOutputToInputScaledDotOpIndexing(scaled_dot, ctx);\n+  }\n   if (auto slice = DynCast<HloSliceInstruction>(instr)) {\n     return ComputeOutputToInputSliceOpIndexing(slice, ctx);\n   }"
        },
        {
            "sha": "7916966ac5ba238094a0924b99321a61ac81304d",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_analysis_test.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60bb2701d8c664c6a32568722192feb3767e25c0/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60bb2701d8c664c6a32568722192feb3767e25c0/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_analysis_test.cc?ref=60bb2701d8c664c6a32568722192feb3767e25c0",
            "patch": "@@ -2455,6 +2455,47 @@ TEST_F(IndexingAnalysisTest, DotOp) {\n               )\"));\n }\n \n+TEST_F(IndexingAnalysisTest, ScaledDotOp) {\n+  auto input_indexing = GetOutputToInputIndexing(ParseAndGetRoot(R\"(\n+    HloModule m\n+    ENTRY e {\n+      a = f32[2,10] parameter(0)\n+      b = f32[10,2] parameter(1)\n+      a_scale = f32[2,2] parameter(2)\n+      b_scale = f32[2,2] parameter(3)\n+      ROOT dot = f32[2,2] scaled-dot(a, a_scale, b, b_scale),\n+        lhs_contracting_dims={1},\n+        rhs_contracting_dims={0}\n+    }\n+  )\"));\n+  EXPECT_THAT(input_indexing.ToString(), MatchIndexingString(R\"(\n+    operand id = 0\n+      (d0, d1)[s0] -> (d0, s0),\n+      domain:\n+      d0 in [0, 1],\n+      d1 in [0, 1],\n+      s0 in [0, 9]\n+    operand id = 1\n+      (d0, d1)[s0] -> (d0, s0 floordiv 5),\n+      domain:\n+      d0 in [0, 1],\n+      d1 in [0, 1],\n+      s0 in [0, 9]\n+    operand id = 2\n+      (d0, d1)[s0] -> (s0, d1),\n+      domain:\n+      d0 in [0, 1],\n+      d1 in [0, 1],\n+      s0 in [0, 9]\n+    operand id = 3\n+      (d0, d1)[s0] -> (s0 floordiv 5, d1),\n+      domain:\n+      d0 in [0, 1],\n+      d1 in [0, 1],\n+      s0 in [0, 9]\n+  )\"));\n+}\n+\n TEST_F(IndexingAnalysisTest, UnsupportedOps) {\n   auto root = ParseAndGetRoot(R\"(\n     HloModule m"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 108,
        "deletions": 16
    }
}