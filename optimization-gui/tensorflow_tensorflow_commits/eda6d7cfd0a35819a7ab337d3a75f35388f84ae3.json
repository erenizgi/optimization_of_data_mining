{
    "author": "tensorflower-gardener",
    "message": "Update interpreter and subgraph to provide external buffer id and tensor mapping\n\nPiperOrigin-RevId: 827258831",
    "sha": "eda6d7cfd0a35819a7ab337d3a75f35388f84ae3",
    "files": [
        {
            "sha": "aab15e3a854bb6be8f038e9d8a60a755042487ad",
            "filename": "tensorflow/lite/core/interpreter_builder.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/eda6d7cfd0a35819a7ab337d3a75f35388f84ae3/tensorflow%2Flite%2Fcore%2Finterpreter_builder.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/eda6d7cfd0a35819a7ab337d3a75f35388f84ae3/tensorflow%2Flite%2Fcore%2Finterpreter_builder.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fcore%2Finterpreter_builder.cc?ref=eda6d7cfd0a35819a7ab337d3a75f35388f84ae3",
            "patch": "@@ -725,7 +725,8 @@ TfLiteStatus InterpreterBuilder::ParseTensors(\n       if (subgraph->SetTensorParametersReadOnly(\n               i, type, get_name(tensor), dims, quantization, buffer_ptr,\n               buffer_size, allocation_, sparsity,\n-              /*buffer_identifier=*/tensor->buffer()) != kTfLiteOk) {\n+              /*buffer_identifier=*/tensor->buffer(),\n+              /*external_buffer_id=*/tensor->external_buffer()) != kTfLiteOk) {\n         TF_LITE_REPORT_ERROR(error_reporter_,\n                              \"Tensor %d is invalidly specified in schema.\\n\",\n                              i);"
        },
        {
            "sha": "d4f135887c1e2fb91a21f16345a508f51b92e7fd",
            "filename": "tensorflow/lite/core/subgraph.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/eda6d7cfd0a35819a7ab337d3a75f35388f84ae3/tensorflow%2Flite%2Fcore%2Fsubgraph.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/eda6d7cfd0a35819a7ab337d3a75f35388f84ae3/tensorflow%2Flite%2Fcore%2Fsubgraph.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fcore%2Fsubgraph.cc?ref=eda6d7cfd0a35819a7ab337d3a75f35388f84ae3",
            "patch": "@@ -1917,7 +1917,7 @@ TfLiteStatus Subgraph::SetTensorParametersReadOnly(\n     int tensor_index, TfLiteType type, const char* name, const size_t ndims,\n     const int* dims, TfLiteQuantization quantization, const char* buffer,\n     size_t bytes, const Allocation* allocation, TfLiteSparsity* sparsity,\n-    const size_t buffer_identifier) {\n+    const size_t buffer_identifier, const size_t external_buffer_id) {\n   // Ensure quantization cleanup on failure.\n   ScopedTfLiteQuantization scoped_quantization(&quantization);\n   ScopedTfLiteSparsity scoped_sparsity(sparsity);\n@@ -1968,6 +1968,10 @@ TfLiteStatus Subgraph::SetTensorParametersReadOnly(\n   if (buffer_identifier != kTfLiteNoBufferIdentifier) {\n     tensor_buffer_identifiers_[tensor_index] = buffer_identifier;\n   }\n+  if (external_buffer_id != kTfLiteNoBufferIdentifier &&\n+      external_buffer_id != 0) {\n+    tensor_external_buffer_ids_[tensor_index] = external_buffer_id;\n+  }\n   return kTfLiteOk;\n }\n "
        },
        {
            "sha": "ba952c431bc3fa219c74f7ea9a915cb6ddf8bd7e",
            "filename": "tensorflow/lite/core/subgraph.h",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/eda6d7cfd0a35819a7ab337d3a75f35388f84ae3/tensorflow%2Flite%2Fcore%2Fsubgraph.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/eda6d7cfd0a35819a7ab337d3a75f35388f84ae3/tensorflow%2Flite%2Fcore%2Fsubgraph.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fcore%2Fsubgraph.h?ref=eda6d7cfd0a35819a7ab337d3a75f35388f84ae3",
            "patch": "@@ -130,22 +130,32 @@ class Subgraph {\n   // This variant assumes an external buffer has been allocated of size\n   // bytes. The lifetime of buffer must be ensured to be greater or equal\n   // to Interpreter. `quantization` ownership is passed to the subgraph.\n+  // `buffer_identifier`: An optional value to identify the buffer. If set to\n+  // a value other than kTfLiteNoBufferIdentifier, this tensor is considered a\n+  // constant tensor shared across multiple subgraphs / interpreters.\n+  // `external_buffer_id`: An optional value to identify the external buffer. If\n+  // set to a value other than kTfLiteNoBufferIdentifier, this tensor is\n+  // considered a tensor using an external buffer shared across multiple\n+  // subgraphs / interpreters.\n   inline TfLiteStatus SetTensorParametersReadOnly(\n       int tensor_index, TfLiteType type, const char* name,\n       const std::vector<int>& dims, TfLiteQuantization quantization,\n       const char* buffer, size_t bytes, const Allocation* allocation = nullptr,\n       TfLiteSparsity* sparsity = nullptr,\n-      size_t buffer_identifier = kTfLiteNoBufferIdentifier) {\n+      size_t buffer_identifier = kTfLiteNoBufferIdentifier,\n+      size_t external_buffer_id = kTfLiteNoBufferIdentifier) {\n     return SetTensorParametersReadOnly(tensor_index, type, name, dims.size(),\n                                        dims.data(), quantization, buffer, bytes,\n-                                       allocation, sparsity, buffer_identifier);\n+                                       allocation, sparsity, buffer_identifier,\n+                                       external_buffer_id);\n   }\n   TfLiteStatus SetTensorParametersReadOnly(\n       int tensor_index, TfLiteType type, const char* name, size_t ndims,\n       const int* dims, TfLiteQuantization quantization, const char* buffer,\n       size_t bytes, const Allocation* allocation = nullptr,\n       TfLiteSparsity* sparsity = nullptr,\n-      size_t buffer_identifier = kTfLiteNoBufferIdentifier);\n+      size_t buffer_identifier = kTfLiteNoBufferIdentifier,\n+      size_t external_buffer_id = kTfLiteNoBufferIdentifier);\n \n   // Set description of inputs/outputs/data/fptrs for node `node_index`.\n   // This variant assumes an external buffer has been allocated of size\n@@ -611,6 +621,11 @@ class Subgraph {\n     return tensor_buffer_identifiers_;\n   }\n \n+  const std::unordered_map<size_t, size_t>& GetExternalTensorBufferIdentifiers()\n+      const {\n+    return tensor_external_buffer_ids_;\n+  }\n+\n   // Replaces the node for the given execution index with the subgraph.\n   //\n   // - The node and subgraph tensor counts must match.\n@@ -1220,6 +1235,10 @@ class Subgraph {\n   // Maps tensor constant buffers used in the subgraph to a model-wide\n   // identifiers.\n   std::unordered_map<size_t, size_t> tensor_buffer_identifiers_;\n+\n+  // Maps tensor external buffer ids used in the subgraph to a model-wide\n+  // identifiers.\n+  std::unordered_map<size_t, size_t> tensor_external_buffer_ids_;\n };\n \n }  // namespace tflite"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 29,
        "deletions": 5
    }
}