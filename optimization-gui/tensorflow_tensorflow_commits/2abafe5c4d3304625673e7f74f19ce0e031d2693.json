{
    "author": "WillFroom",
    "message": "[XLA][XTile] Make squeeze dims work with xtile extract/insert.\n\nPiperOrigin-RevId: 822087994",
    "sha": "2abafe5c4d3304625673e7f74f19ce0e031d2693",
    "files": [
        {
            "sha": "bd1b2204267cec407410a6fe606f023b024da231",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/compilation_pipeline.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fcompilation_pipeline.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fcompilation_pipeline.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fcompilation_pipeline.cc?ref=2abafe5c4d3304625673e7f74f19ce0e031d2693",
            "patch": "@@ -33,8 +33,8 @@ void CreateTritonXlaPipeline(\n     mlir::OpPassManager* pm,\n     const stream_executor::GpuComputeCapability& gpu_cc, bool rewrite_int4,\n     bool allow_tma) {\n-  pm->addPass(mlir::triton::xla::CreateTritonXLALowerXTilePass());\n   pm->addPass(mlir::triton::xla::CreateTritonXLASqueezeDimsPass());\n+  pm->addPass(mlir::triton::xla::CreateTritonXLALowerXTilePass());\n   pm->addPass(mlir::triton::xla::CreateTritonXLAFoldTransposePass());\n \n   auto* cuda_cc = gpu_cc.cuda_compute_capability();"
        },
        {
            "sha": "ea08cb4cf2cc9eae595885dbbde5fd36ab3a0c6f",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2FBUILD?ref=2abafe5c4d3304625673e7f74f19ce0e031d2693",
            "patch": "@@ -62,6 +62,7 @@ cc_library(\n         \"//xla/stream_executor/gpu:collective_kernel_metadata\",\n         \"//xla/stream_executor/gpu:tma_metadata\",\n         \"@com_google_absl//absl/algorithm:container\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\","
        },
        {
            "sha": "534a7e9f9abf1baff76ef6d2fc1f2380f3d7d2f7",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/passes.td",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fpasses.td?ref=2abafe5c4d3304625673e7f74f19ce0e031d2693",
            "patch": "@@ -43,7 +43,9 @@ def TritonXLASqueezeDimsPass : Pass<\"triton-xla-squeeze-dims\", \"mlir::ModuleOp\">\n   }];\n   let dependentDialects = [\n     \"::mlir::triton::xla::XlaTritonDialect\",\n-    \"triton::TritonDialect\"\n+    \"::mlir::triton::TritonDialect\",\n+    \"::xla::xtile::XTileDialect\",\n+    \"::mlir::memref::MemRefDialect\",\n   ];\n   let options = [\n     Option<\"finalize_\", \"finalize\", \"bool\", \"true\","
        },
        {
            "sha": "66e67d43cd14e94e425fa7e908c1b1aa41b906f9",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/tests/triton_xla_squeeze_dims.mlir",
            "status": "modified",
            "additions": 32,
            "deletions": 23,
            "changes": 55,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftests%2Ftriton_xla_squeeze_dims.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftests%2Ftriton_xla_squeeze_dims.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftests%2Ftriton_xla_squeeze_dims.mlir?ref=2abafe5c4d3304625673e7f74f19ce0e031d2693",
            "patch": "@@ -137,41 +137,50 @@ func.func @reshape_with_encoding(%arg0: tensor<1x32xf32, #arg_enc>) -> tensor<32\n // -----\n \n // CHECK-LABEL: func @fold_squeeze_dims_of_extract\n-func.func @fold_squeeze_dims_of_extract(%arg0: !tt.ptr<f32>, %arg1: i32) -> tensor<4x8xf32> {\n-  // CHECK: %[[EXTRACT:.*]] = triton_xla.extract from %arg0\n-  // CHECK-SAME: as memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>\n-  // CHECK-SAME: [0, 3, 0] [4, 1, 8] [1, 1, 1] : tensor<4x8xf32>\n-  %0 = triton_xla.extract from %arg0\n-    as memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>\n-    [0, 3, 0] [4, 1, 8] [1, 1, 1] : tensor<4x1x8xf32>\n-  %1 = triton_xla.squeeze_dims %0 {axis = 1 : i32} : tensor<4x1x8xf32> -> tensor<4x8xf32>\n+// CHECK-SAME: (%[[INPUT:.*]]: memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>,\n+func.func @fold_squeeze_dims_of_extract(\n+  %input: memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>, %offset: index)  -> tensor<4x8xf32>\n+{\n+  // CHECK: %[[EXTRACT:.*]] = xtile.extract %[[INPUT]]\n+  // CHECK-SAME: memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>> -> tensor<4x8xf32>\n+  %tile = xtile.extract %input[%offset, %offset, %offset][4, 1, 8][1, 1, 1]\n+    : memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>> -> tensor<4x1x8xf32>\n+  // CHECK-NOT: triton_xla.squeeze_dims\n+  %squeezed = triton_xla.squeeze_dims %tile {axis = 1 : i32} : tensor<4x1x8xf32> -> tensor<4x8xf32>\n   // CHECK: return %[[EXTRACT]]\n-  return %1 : tensor<4x8xf32>\n+  return %squeezed : tensor<4x8xf32>\n }\n \n+\n // -----\n \n-// CHECK-LABEL: func @squeeze_insert\n-func.func @squeeze_insert(%arg0: !tt.ptr<f32>, %arg1: tensor<4x1x8xf32>) {\n-  // CHECK: %[[SRC:.*]] = triton_xla.squeeze_dims %arg1 {axis = 1 : i32}\n-  // CHECK: triton_xla.insert %[[SRC]] into %arg0\n-  // CHECK-SAME: as memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>\n-  // CHECK-SAME: [0, 3, 0] [4, 1, 8] [1, 1, 1] : tensor<4x8xf32>\n-  triton_xla.insert %arg1 into %arg0\n-    as memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>\n-    [0, 3, 0] [4, 1, 8] [1, 1, 1] : tensor<4x1x8xf32>\n+// CHECK-LABEL: func @squeeze_insert(\n+// CHECK-SAME: %[[BUFFER:.*]]: memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>,\n+// CHECK-SAME: %[[TILE:.*]]: tensor<4x1x8xf32>\n+func.func @squeeze_insert(\n+  %arg0: memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>,\n+  %arg1: tensor<4x1x8xf32>,\n+  %offset: index) {\n+  // CHECK: %[[REDUCED:.*]] = triton_xla.squeeze_dims %[[TILE]]\n+  // CHECK-SAME: {axis = 1 : i32} : tensor<4x1x8xf32> -> tensor<4x8xf32>\n+  // CHECK: xtile.insert %[[REDUCED]] into %[[BUFFER]]\n+  // CHECK-SAME: tensor<4x8xf32> -> memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>\n+  xtile.insert %arg1 into %arg0[%offset, %offset, %offset][4, 1, 8][1, 1, 1]\n+    : tensor<4x1x8xf32> -> memref<4x16x8xf32, #triton_xla.layout<[2, 1, 0]>>\n   return\n }\n \n // -----\n \n // CHECK-LABEL: func @squeeze_insert_unit_tensor\n-func.func @squeeze_insert_unit_tensor(%arg0: !tt.ptr<f32>, %arg1: tensor<1x1xf32>) {\n+func.func @squeeze_insert_unit_tensor(\n+  %arg0: memref<1x1xf32,#triton_xla.layout<[0, 1]>>,\n+  %arg1: tensor<1x1xf32>,\n+  %offset: index) {\n   // CHECK: triton_xla.squeeze_dims\n-  // CHECK: triton_xla.insert {{.*}} : tensor<1xf32>\n-  triton_xla.insert %arg1 into %arg0\n-    as memref<1x1xf32,#triton_xla.layout<[0, 1]>> \n-    [0, 0] [1, 1] [1, 1] : tensor<1x1xf32>\n+  // CHECK: xtile.insert {{.*}} : tensor<1xf32>\n+  xtile.insert %arg1 into %arg0[%offset, %offset] [1, 1] [1, 1]\n+    : tensor<1x1xf32> -> memref<1x1xf32,#triton_xla.layout<[0, 1]>>\n   return\n }\n "
        },
        {
            "sha": "a7959c81b9c584452fee368a8c3cee7ba59acb99",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/triton_xla_squeeze_dims_pass.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 18,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftriton_xla_squeeze_dims_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2abafe5c4d3304625673e7f74f19ce0e031d2693/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftriton_xla_squeeze_dims_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Ftriton_xla_squeeze_dims_pass.cc?ref=2abafe5c4d3304625673e7f74f19ce0e031d2693",
            "patch": "@@ -21,13 +21,14 @@ limitations under the License.\n #include <utility>\n \n #include \"absl/algorithm/container.h\"\n+#include \"absl/container/flat_hash_set.h\"\n #include \"absl/log/check.h\"\n #include \"llvm/ADT/ArrayRef.h\"\n #include \"llvm/ADT/STLExtras.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"mlir/Analysis/SliceAnalysis.h\"\n-#include \"mlir/Dialect/Arith/IR/Arith.h\"\n #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n+#include \"mlir/Dialect/MemRef/IR/MemRef.h\"\n #include \"mlir/Dialect/SCF/IR/SCF.h\"\n #include \"mlir/IR/Attributes.h\"\n #include \"mlir/IR/BuiltinAttributes.h\"\n@@ -44,6 +45,7 @@ limitations under the License.\n #include \"mlir/Transforms/WalkPatternRewriteDriver.h\"\n #include \"xla/backends/gpu/codegen/triton/ir/triton_xla_ops.h\"\n #include \"xla/backends/gpu/codegen/triton/transforms/passes.h\"\n+#include \"xla/codegen/xtile/ir/xtile_ops.h\"\n #include \"triton/Dialect/Triton/IR/Dialect.h\"\n \n namespace mlir::triton::xla {\n@@ -150,38 +152,38 @@ Value SqueezeTensorValue(PatternRewriter& rewriter, Value value,\n   return value;\n }\n \n-// Folds squeeze_dims into extract.\n-LogicalResult FoldSqueezeDimsOfExtract(ExtractOp op,\n-                                       PatternRewriter& rewriter) {\n+LogicalResult FoldSqueezeDimsOfExtractTile(::xla::xtile::ExtractTileOp op,\n+                                           PatternRewriter& rewriter) {\n   std::optional<uint32_t> axis = GetSqueezeDimsUserAxis(op);\n   if (!axis) {\n     return rewriter.notifyMatchFailure(op, \"No squeeze_dims users.\");\n   }\n \n-  Value new_op = rewriter.create<ExtractOp>(\n-      op.getLoc(), SqueezeTensorType(op.getType(), *axis), op.getSrc(),\n-      op.getMixedOffsets(), op.getStaticSizes(), op.getStaticStrides(),\n-      op.getSrcShape(), op.getSrcLayout());\n+  auto squeezed_type = SqueezeTensorType(op.getType(), *axis);\n+\n+  Value new_op = rewriter.create<::xla::xtile::ExtractTileOp>(\n+      op.getLoc(), squeezed_type, op.getSource(), op.getOffsets(),\n+      op.getFullTileShape(), op.getStrides());\n   ReplaceOpWithExpandDimsOf(rewriter, op, new_op, *axis);\n   rewriter.eraseOp(op);\n   return success();\n }\n \n-// Extracts unit dimensions from insert and prepends them as squeeze_dims.\n-LogicalResult SqueezeInsert(InsertOp op, PatternRewriter& rewriter) {\n-  if (op.getSrc().getType().getRank() == 0) {\n+LogicalResult SqueezeInsertTile(::xla::xtile::InsertTileOp op,\n+                                PatternRewriter& rewriter) {\n+  if (op.getSource().getType().getRank() == 0) {\n     return rewriter.notifyMatchFailure(op, \"Expected non-scalar source.\");\n   }\n \n-  auto squeeze_dims = GetDimsToSqueeze(op.getSrc().getType());\n+  auto squeeze_dims = GetDimsToSqueeze(op.getSource().getType());\n   if (squeeze_dims.empty()) {\n     return rewriter.notifyMatchFailure(op, \"No dimensions to squeeze.\");\n   }\n \n-  Value src = SqueezeTensorValue(rewriter, op.getSrc(), squeeze_dims);\n-  rewriter.replaceOpWithNewOp<InsertOp>(\n-      op, src, op.getDst(), op.getMixedOffsets(), op.getStaticSizes(),\n-      op.getStaticStrides(), op.getDstShape(), op.getDstLayout());\n+  Value src = SqueezeTensorValue(rewriter, op.getSource(), squeeze_dims);\n+  rewriter.replaceOpWithNewOp<::xla::xtile::InsertTileOp>(\n+      op, src, op.getDestination(), op.getOffsets(), op.getFullTileShape(),\n+      op.getStrides());\n   return success();\n }\n \n@@ -512,8 +514,8 @@ class TritonXLASqueezeDimsPass\n  private:\n   void runOnOperation() override {\n     RewritePatternSet patterns(&getContext());\n-    patterns.add(FoldSqueezeDimsOfExtract);\n-    patterns.add(SqueezeInsert);\n+    patterns.add(FoldSqueezeDimsOfExtractTile);\n+    patterns.add(SqueezeInsertTile);\n     patterns.add(SqueezeReshapeOperand);\n     patterns.add(ExpandReshapeResult);\n     patterns.add<PushSqueezeDimsUpThroughElementwise>(&getContext());"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 57,
        "deletions": 43
    }
}