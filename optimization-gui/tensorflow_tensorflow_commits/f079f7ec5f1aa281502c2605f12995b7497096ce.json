{
    "author": "basioli-k",
    "message": "[XLA:GPU][host offloading] Use `ForAllThunks` to load executables for host offloading thunks.\n\nPiperOrigin-RevId: 813723809",
    "sha": "f079f7ec5f1aa281502c2605f12995b7497096ce",
    "files": [
        {
            "sha": "89438047d2ffaf728e1fc1b55eb15d95e911a4bd",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f079f7ec5f1aa281502c2605f12995b7497096ce/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f079f7ec5f1aa281502c2605f12995b7497096ce/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=f079f7ec5f1aa281502c2605f12995b7497096ce",
            "patch": "@@ -2582,22 +2582,24 @@ GpuCompiler::CompileToBackendResult(\n   // Host executable has to be compiled the GPU compilation is done to\n   // avoid a deadlock on the LLVM command line options lock. We can then load\n   // it.\n-  for (auto& thunk : compile_module_results.executable->thunks()) {\n+  compile_module_results.executable->ForAllThunksMutable([&](Thunk* thunk) {\n     if (thunk->kind() == Thunk::Kind::kHostExecuteStart) {\n       auto* host_execute_start_thunk =\n-          tsl::down_cast<HostExecuteStartThunk*>(thunk.get());\n-      TF_ASSIGN_OR_RETURN(\n-          xla::cpu::CompilationResultProto cpu_compilation_result,\n+          tsl::down_cast<HostExecuteStartThunk*>(thunk);\n+      absl::StatusOr<xla::cpu::CompilationResultProto> cpu_compilation_result =\n           GetCpuCompilationResult(\n-              host_execute_start_thunk->executable_proto().hlo_module()));\n+              host_execute_start_thunk->executable_proto().hlo_module());\n+\n+      CHECK_OK(cpu_compilation_result) << \"Failed to compile host executable.\";\n \n       *host_execute_start_thunk->mutable_executable_proto()\n            ->mutable_aot_compilation_result() =\n-          std::move(cpu_compilation_result);\n+          std::move(cpu_compilation_result.value());\n \n-      TF_RETURN_IF_ERROR(host_execute_start_thunk->LoadExecutable());\n+      CHECK_OK(host_execute_start_thunk->LoadExecutable())\n+          << \"Failed to load host executable.\";\n     }\n-  }\n+  });\n \n   return CompileResultWithMetadata{std::move(backend_result),\n                                    std::move(compile_module_results)};"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 10,
        "deletions": 8
    }
}