{
    "author": "tensorflower-gardener",
    "message": "[Auto Sharding] Add Sharding_config dump for duebgging.\n\nPiperOrigin-RevId: 798410650",
    "sha": "9d2765591d3fc42e86e18f40b336d7340372bf84",
    "files": [
        {
            "sha": "b38999b37d1d6ccc0ccd721b3fbfd25fe638569b",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=9d2765591d3fc42e86e18f40b336d7340372bf84",
            "patch": "@@ -6170,6 +6170,7 @@ cc_library(\n     srcs = [\"sharding_config.cc\"],\n     hdrs = [\"sharding_config.h\"],\n     deps = [\n+        \"//xla:printer\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla:xla_proto_cc\",\n         \"//xla/hlo/ir:hlo_sharding\","
        },
        {
            "sha": "3558c6e18eafd3ddc4bd2a1e4a6a7f2f4c743d9f",
            "filename": "third_party/xla/xla/service/sharding_config.cc",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config.cc?ref=9d2765591d3fc42e86e18f40b336d7340372bf84",
            "patch": "@@ -16,13 +16,69 @@ limitations under the License.\n #include \"xla/service/sharding_config.h\"\n \n #include <functional>\n+#include <string>\n+#include <utility>\n \n #include \"xla/hlo/ir/hlo_sharding.h\"\n+#include \"xla/printer.h\"\n #include \"xla/xla.pb.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n \n+void NodeShardingConfig::Print(Printer* printer, int indent) const {\n+  std::string i0 = Indent(indent);\n+  printer->Append(i0);\n+  printer->Append(\"NodeShardingConfig {\\n\");\n+\n+  std::string i1 = Indent(indent + 1);\n+  printer->Append(i1);\n+  printer->Append(\"sharding: \");\n+  if (sharding.has_value()) {\n+    printer->Append(sharding->ToString());\n+    printer->Append(\"\\n\");\n+  } else {\n+    printer->Append(\"nullopt\\n\");\n+  }\n+\n+  if (!nodes.empty()) {\n+    printer->Append(i1);\n+    printer->Append(\"nodes: [\\n\");\n+    for (const auto& node : nodes) {\n+      node.Print(printer, indent + 2);\n+    }\n+    printer->Append(i1);\n+    printer->Append(\"]\\n\");\n+  }\n+  printer->Append(i0);\n+  printer->Append(\"}\\n\");\n+}\n+\n+std::string NodeShardingConfig::ToString() const {\n+  StringPrinter printer;\n+  Print(&printer);\n+  return std::move(printer).ToString();\n+}\n+\n+void ShardingConfig::Print(Printer* printer, int indent) const {\n+  std::string i0 = NodeShardingConfig::Indent(indent);\n+  printer->Append(i0);\n+  printer->Append(\"ShardingConfig {\\n\");\n+  if (!nodes.empty()) {\n+    for (const auto& node : nodes) {\n+      node.Print(printer, indent + 1);\n+    }\n+  }\n+  printer->Append(i0);\n+  printer->Append(\"}\\n\");\n+}\n+\n+std::string ShardingConfig::ToString() const {\n+  StringPrinter printer;\n+  Print(&printer);\n+  return std::move(printer).ToString();\n+}\n+\n ShardingConfigProto ShardingConfig::ToProto(const ShardingConfig& config) {\n   ShardingConfigProto sharding_config_proto;\n   std::function<NodeShardingConfigProto(const NodeShardingConfig&)> convert;"
        },
        {
            "sha": "31b65cd0dbbf93dad7450ab12dc3d99b73104761",
            "filename": "third_party/xla/xla/service/sharding_config.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config.h?ref=9d2765591d3fc42e86e18f40b336d7340372bf84",
            "patch": "@@ -17,9 +17,11 @@ limitations under the License.\n #define XLA_SERVICE_SHARDING_CONFIG_H_\n \n #include <optional>\n+#include <string>\n #include <vector>\n \n #include \"xla/hlo/ir/hlo_sharding.h\"\n+#include \"xla/printer.h\"\n #include \"xla/xla.pb.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -33,6 +35,10 @@ struct NodeShardingConfig {\n   bool operator==(const NodeShardingConfig& other) const {\n     return sharding == other.sharding && nodes == other.nodes;\n   }\n+  static std::string Indent(int level) { return std::string(level * 2, ' '); }\n+  void Print(Printer* printer, int indent = 0) const;\n+\n+  std::string ToString() const;\n };\n \n // Program's sharding configuration.\n@@ -43,6 +49,10 @@ struct ShardingConfig {\n   }\n   static ShardingConfig FromProto(const ShardingConfigProto& proto);\n   static ShardingConfigProto ToProto(const ShardingConfig& config);\n+\n+  void Print(Printer* printer, int indent = 0) const;\n+\n+  std::string ToString() const;\n };\n \n }  // namespace xla"
        },
        {
            "sha": "5d62b5d6d450fb05550bc4c6330c5a18146c0592",
            "filename": "third_party/xla/xla/service/sharding_config_test.cc",
            "status": "modified",
            "additions": 36,
            "deletions": 5,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9d2765591d3fc42e86e18f40b336d7340372bf84/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fsharding_config_test.cc?ref=9d2765591d3fc42e86e18f40b336d7340372bf84",
            "patch": "@@ -15,6 +15,8 @@ limitations under the License.\n \n #include \"xla/service/sharding_config.h\"\n \n+#include <string>\n+\n #include <gtest/gtest.h>\n #include \"xla/hlo/ir/hlo_sharding.h\"\n #include \"xla/shape.h\"\n@@ -23,14 +25,43 @@ limitations under the License.\n namespace xla {\n namespace {\n \n-TEST(ShardingConfigTest, ConfigToProtoToConfigMatchesOriginal) {\n-  const Shape shape = ShapeUtil::MakeShape(F32, {1024});\n-  const ShardingConfig config = {\n+class ShardingConfigTest : public ::testing::Test {\n+ protected:\n+  const Shape kShape = ShapeUtil::MakeShape(F32, {1024});\n+  const ShardingConfig kTestConfig{\n       {{HloSharding::Manual()},\n        {HloSharding::Replicate()},\n        {{},\n-        {{HloSharding::Tile1D(shape, 2)}, {HloSharding::Tile1D(shape, 4)}}}}};\n-  EXPECT_EQ(ShardingConfig::FromProto(ShardingConfig::ToProto(config)), config);\n+        {{HloSharding::Tile1D(kShape, 2)}, {HloSharding::Tile1D(kShape, 4)}}}}};\n+};\n+\n+TEST_F(ShardingConfigTest, ConfigToProtoToConfigMatchesOriginal) {\n+  EXPECT_EQ(ShardingConfig::FromProto(ShardingConfig::ToProto(kTestConfig)),\n+            kTestConfig);\n+}\n+\n+TEST_F(ShardingConfigTest, ConfigToString) {\n+  const std::string kExpectedConfigStr = R\"(ShardingConfig {\n+  NodeShardingConfig {\n+    sharding: {manual}\n+  }\n+  NodeShardingConfig {\n+    sharding: {replicated}\n+  }\n+  NodeShardingConfig {\n+    sharding: nullopt\n+    nodes: [\n+      NodeShardingConfig {\n+        sharding: {devices=[2]<=[2]}\n+      }\n+      NodeShardingConfig {\n+        sharding: {devices=[4]<=[4]}\n+      }\n+    ]\n+  }\n+}\n+)\";\n+  EXPECT_EQ(kTestConfig.ToString(), kExpectedConfigStr);\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 103,
        "deletions": 5
    }
}