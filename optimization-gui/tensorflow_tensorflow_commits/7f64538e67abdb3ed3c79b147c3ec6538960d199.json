{
    "author": "WillFroom",
    "message": "[XLA:CPU] Make tiled kernel test deterministic.\n\nPiperOrigin-RevId: 822018419",
    "sha": "7f64538e67abdb3ed3c79b147c3ec6538960d199",
    "files": [
        {
            "sha": "ac5995353fa45a002c108f8d65888fec98372ed6",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/tiled_kernel_test.py",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7f64538e67abdb3ed3c79b147c3ec6538960d199/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_kernel_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7f64538e67abdb3ed3c79b147c3ec6538960d199/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_kernel_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_kernel_test.py?ref=7f64538e67abdb3ed3c79b147c3ec6538960d199",
            "patch": "@@ -26,6 +26,11 @@\n create_literal = testlib_utilities.create_literal_from_np\n \n \n+def get_random_array(shape: tuple[int, ...], dtype: np.dtype) -> np.ndarray:\n+  rng = np.random.default_rng()\n+  return rng.uniform(low=-5, high=5, size=shape).astype(dtype)\n+\n+\n def compare_kernel(\n     ir: str,\n     kernel_name: str,\n@@ -45,14 +50,13 @@ def compare_kernel(\n       kernel_definition,\n       cpu_testlib.JitCompiler(base_testlib.HloModuleConfig()),\n   )\n-  inputs = [np.random.rand(*shape).astype(dtype) for shape in input_shapes]\n+\n+  # Simply use a all-ones arrays as inputs to make it easy to debug the kernel.\n+  inputs = [np.ones(shape=shape, dtype=dtype) for shape in input_shapes]\n \n   input_tensors = [create_literal(input) for input in inputs]\n-  output_tensor = create_literal(\n-      np.zeros(shape=output_shape, dtype=dtype)\n-      if output_shape\n-      else np.array(0, dtype=dtype)\n-  )\n+  # Use a random array as the output to ensure all values are written to.\n+  output_tensor = create_literal(get_random_array(output_shape, dtype))\n   runner.call(input_tensors + [output_tensor])\n \n   output_np = np.asarray(output_tensor)"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 10,
        "deletions": 6
    }
}