{
    "author": "golechwierowicz",
    "message": "[XLA:GPU] Add method for printing unsatisfied Constraints for ConstraintExpression.\n\nHelps with narrowing down which constraints are unsat. There can be many constraints (e.g. WGMMA in Mosaic), and while debugging it's unclear which one is violated at a glance.\n\nAs a follow up, we can also introduce names to each Constraint to make the identification even easier.\n\nPiperOrigin-RevId: 846168559",
    "sha": "90f6a0227660e4cf7997607f71c033ec36a5234c",
    "files": [
        {
            "sha": "612dee3a700cb2116d6b4e15b339204bf81370ba",
            "filename": "third_party/xla/xla/codegen/tiling/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2FBUILD?ref=90f6a0227660e4cf7997607f71c033ec36a5234c",
            "patch": "@@ -208,7 +208,6 @@ xla_cc_test(\n     srcs = [\"constraint_expression_test.cc\"],\n     deps = [\n         \":constraint_expression\",\n-        \"//xla/hlo/analysis:indexing_analysis\",\n         \"//xla/hlo/analysis:indexing_test_utils\",\n         \"//xla/tests:xla_internal_test_main\",\n         \"@com_google_absl//absl/types:span\","
        },
        {
            "sha": "8226932ba80bbb2aaf544e0a6efc248fe6161d73",
            "filename": "third_party/xla/xla/codegen/tiling/constraint_expression.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 3,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression.cc?ref=90f6a0227660e4cf7997607f71c033ec36a5234c",
            "patch": "@@ -184,6 +184,31 @@ bool ConstraintExpression::IsSatisfiedBy(\n       });\n }\n \n+void ConstraintExpression::PrintUnsatisfiedConstraints(\n+    absl::Span<const int64_t> dim_values, std::ostream& out) const {\n+  auto is_conjunction_satisfied = [&](const auto& conjunction) {\n+    return absl::c_all_of(conjunction, [&](const Constraint& constraint) {\n+      int64_t value = EvaluateAffineExpr(constraint.expr, dim_values);\n+      return constraint.interval.Contains(value);\n+    });\n+  };\n+\n+  for (const auto& [i, conjunction] :\n+       llvm::enumerate(disjoint_conjoint_constraints_)) {\n+    if (is_conjunction_satisfied(conjunction)) {\n+      continue;\n+    }\n+    out << \"Unsatisfied conjunction: #\" << i << \"\\n\";\n+    for (const Constraint& constraint : conjunction) {\n+      int64_t value = EvaluateAffineExpr(constraint.expr, dim_values);\n+      if (!constraint.interval.Contains(value)) {\n+        out << \" -- \" << constraint.expr << \" in \"\n+            << constraint.interval.ToString() << \". Value: \" << value << \"\\n\";\n+      }\n+    }\n+  }\n+}\n+\n std::string ConstraintExpression::ToString() const {\n   std::stringstream ss;\n   Print(ss);\n@@ -204,10 +229,10 @@ void ConstraintExpression::Print(std::ostream& out) const {\n   // order and to get deterministic output.\n   std::vector<std::string> conjunction_strings;\n   conjunction_strings.reserve(disjoint_conjoint_constraints_.size());\n-  for (const auto& disjunction : disjoint_conjoint_constraints_) {\n+  for (const auto& conjunction : disjoint_conjoint_constraints_) {\n     std::vector<std::string> constraint_strings;\n-    constraint_strings.reserve(disjunction.size());\n-    for (const auto& [expr, interval] : disjunction) {\n+    constraint_strings.reserve(conjunction.size());\n+    for (const auto& [expr, interval] : conjunction) {\n       constraint_strings.push_back(\n           absl::StrCat(xla::ToString(expr), \" in \", interval.ToString()));\n     }"
        },
        {
            "sha": "86c180695b21c17f56e17cf96957a77c039378aa",
            "filename": "third_party/xla/xla/codegen/tiling/constraint_expression.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression.h?ref=90f6a0227660e4cf7997607f71c033ec36a5234c",
            "patch": "@@ -99,6 +99,11 @@ class ConstraintExpression {\n   // constraints.\n   bool IsSatisfiedBy(absl::Span<const int64_t> dim_values) const;\n \n+  // Prints unsatisfied constraints which are not satisfied by the provided\n+  // `dim_values`.\n+  void PrintUnsatisfiedConstraints(absl::Span<const int64_t> dim_values,\n+                                   std::ostream& out) const;\n+\n   std::string ToString() const;\n \n   void Print(std::ostream& out) const;"
        },
        {
            "sha": "d671d6aad7f51600184d876d6649c0e207d127a1",
            "filename": "third_party/xla/xla/codegen/tiling/constraint_expression_test.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/90f6a0227660e4cf7997607f71c033ec36a5234c/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fconstraint_expression_test.cc?ref=90f6a0227660e4cf7997607f71c033ec36a5234c",
            "patch": "@@ -16,19 +16,21 @@ limitations under the License.\n #include \"xla/codegen/tiling/constraint_expression.h\"\n \n #include <cstdint>\n+#include <sstream>\n #include <string>\n #include <vector>\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/types/span.h\"\n-#include \"xla/hlo/analysis/indexing_map.h\"\n #include \"xla/hlo/analysis/indexing_test_utils.h\"\n \n namespace xla {\n namespace {\n \n using ::testing::ExplainMatchResult;\n+using ::testing::HasSubstr;\n+using ::testing::Not;\n \n using Constraint = ConstraintExpression::Constraint;\n \n@@ -96,6 +98,34 @@ TEST_F(ConstraintExpressionTest, PrettyPrintingTest) {\n                                \"d0 in [1, 2] && d1 in [3, 4] || d2 in [5, 6]\"));\n }\n \n+TEST_F(ConstraintExpressionTest, PrintUnsatisfiedConstraints) {\n+  Constraint c0 = GetConstraint(\"d0 mod 6\", 0, 0);\n+  Constraint c1 = GetConstraint(\"d1 mod 8\", 0, 0);\n+  Constraint c2 = GetConstraint(\"d0 mod 13\", 0, 0);\n+  ConstraintExpression constraints = (c0 && c1) || (c1 && c2);\n+\n+  // (c0 && c1) is satisfied.\n+  std::vector<int64_t> lhs_satisfied({6, 8});\n+  ASSERT_TRUE(constraints.IsSatisfiedBy(lhs_satisfied));\n+  std::stringstream ss;\n+  constraints.PrintUnsatisfiedConstraints(lhs_satisfied, ss);\n+\n+  EXPECT_THAT(ss.str(), HasSubstr(\"Unsatisfied conjunction: #1\"));\n+  EXPECT_THAT(ss.str(), HasSubstr(\"d0 mod 13 in [0, 0]. Value: 6\"));\n+  EXPECT_THAT(ss.str(), Not(HasSubstr(\"d1 mod 8 in [0, 0]\")));\n+  EXPECT_THAT(ss.str(), Not(HasSubstr(\"d0 mod 6 in [0, 0]\")));\n+\n+  // (c1 && c2) is satisfied.\n+  std::vector<int64_t> rhs_satisfied({13, 8});\n+  ASSERT_TRUE(constraints.IsSatisfiedBy(rhs_satisfied));\n+  ss.str(\"\");\n+  constraints.PrintUnsatisfiedConstraints(rhs_satisfied, ss);\n+  EXPECT_THAT(ss.str(), HasSubstr(\"Unsatisfied conjunction: #0\"));\n+  EXPECT_THAT(ss.str(), HasSubstr(\"d0 mod 6 in [0, 0]. Value: 1\"));\n+  EXPECT_THAT(ss.str(), Not(HasSubstr(\"d0 mod 13 in [0, 0]\")));\n+  EXPECT_THAT(ss.str(), Not(HasSubstr(\"d1 mod 8 in [0, 0]\")));\n+}\n+\n TEST_F(ConstraintExpressionTest,\n        ConjunctionOfConstraintsOnTheSameExpressionAreIntersected) {\n   ConstraintExpression constraints{GetConstraint(\"d0\", 0, 5)};"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 64,
        "deletions": 5
    }
}