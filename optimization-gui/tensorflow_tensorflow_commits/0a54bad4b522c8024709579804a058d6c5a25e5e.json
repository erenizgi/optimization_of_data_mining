{
    "author": "tensorflower-gardener",
    "message": "Check that the compiler finished successfully.\n\nPiperOrigin-RevId: 806187692",
    "sha": "0a54bad4b522c8024709579804a058d6c5a25e5e",
    "files": [
        {
            "sha": "4675360a9c64dc0e50f043daf85963e188fdb7bf",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler_test.cc",
            "status": "modified",
            "additions": 66,
            "deletions": 74,
            "changes": 140,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/0a54bad4b522c8024709579804a058d6c5a25e5e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/0a54bad4b522c8024709579804a058d6c5a25e5e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler_test.cc?ref=0a54bad4b522c8024709579804a058d6c5a25e5e",
            "patch": "@@ -157,15 +157,14 @@ ENTRY main {\n )\";\n   auto module = ParseAndReturnVerifiedModule(hlo_text).value();\n   auto before = GetCompiledProgramsCount();\n-  std::unique_ptr<Executable> executable =\n-      backend()\n-          .compiler()\n-          ->RunBackend(std::move(module), backend().default_stream_executor(),\n-                       {/*device_allocator=*/nullptr,\n-                        /*thread_pool=*/nullptr,\n-                        /*layout_canonicalization_callback=*/{},\n-                        /*is_autotuning_compilation=*/false})\n-          .value();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/false}));\n   EXPECT_EQ(GetCompiledProgramsCount(), before + 1);\n }\n \n@@ -253,15 +252,14 @@ ENTRY main {\n \n   auto module = ParseAndReturnVerifiedModule(hlo_text).value();\n \n-  std::unique_ptr<Executable> executable =\n-      backend()\n-          .compiler()\n-          ->RunBackend(std::move(module), backend().default_stream_executor(),\n-                       {/*device_allocator=*/nullptr,\n-                        /*thread_pool=*/nullptr,\n-                        /*layout_canonicalization_callback=*/{},\n-                        /*is_autotuning_compilation=*/false})\n-          .value();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/false}));\n \n   const std::string kGpuCompilerStacktraceMetricName =\n       \"/xla/service/gpu/compiler_stacktrace_count\";\n@@ -289,15 +287,14 @@ ENTRY main {\n }\n )\";\n   auto module = ParseAndReturnVerifiedModule(hlo_text).value();\n-  std::unique_ptr<Executable> executable =\n-      backend()\n-          .compiler()\n-          ->RunBackend(std::move(module), backend().default_stream_executor(),\n-                       {/*device_allocator=*/nullptr,\n-                        /*thread_pool=*/nullptr,\n-                        /*layout_canonicalization_callback=*/{},\n-                        /*is_autotuning_compilation=*/false})\n-          .value();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/false}));\n   EXPECT_TRUE(XlaDebugInfoManager::Get()->TracksModule(\n       executable->module().unique_id()));\n }\n@@ -313,15 +310,14 @@ ENTRY main {\n )\";\n   auto module = ParseAndReturnVerifiedModule(hlo_text).value();\n   int module_id = module->unique_id();\n-  std::unique_ptr<Executable> executable =\n-      backend()\n-          .compiler()\n-          ->RunBackend(std::move(module), backend().default_stream_executor(),\n-                       {/*device_allocator=*/nullptr,\n-                        /*thread_pool=*/nullptr,\n-                        /*layout_canonicalization_callback=*/{},\n-                        /*is_autotuning_compilation=*/true})\n-          .value();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/true}));\n   EXPECT_FALSE(XlaDebugInfoManager::Get()->TracksModule(module_id));\n }\n \n@@ -373,15 +369,14 @@ ENTRY e {\n                                                        config));\n \n   config.set_debug_options(debug_options);\n-  std::unique_ptr<Executable> executable =\n-      backend()\n-          .compiler()\n-          ->RunBackend(std::move(module), backend().default_stream_executor(),\n-                       {/*device_allocator=*/nullptr,\n-                        /*thread_pool=*/nullptr,\n-                        /*layout_canonicalization_callback=*/{},\n-                        /*is_autotuning_compilation=*/false})\n-          .value();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/false}));\n \n   HloModule& compiled_module = executable->module();\n   const HloInstruction* entry_root =\n@@ -1256,16 +1251,14 @@ ENTRY entry {\n                              backend().default_stream_executor(),\n                              /*device_allocator=*/nullptr)\n               .value();\n-      std::unique_ptr<Executable> executable =\n-          backend()\n-              .compiler()\n-              ->RunBackend(std::move(compiled_module),\n-                           backend().default_stream_executor(),\n-                           {/*device_allocator=*/nullptr,\n-                            /*thread_pool=*/nullptr,\n-                            /*layout_canonicalization_callback=*/{},\n-                            /*is_autotuning_compilation=*/false})\n-              .value();\n+      TF_ASSERT_OK_AND_ASSIGN(\n+          std::unique_ptr<Executable> executable,\n+          backend().compiler()->RunBackend(\n+              std::move(compiled_module), backend().default_stream_executor(),\n+              {/*device_allocator=*/nullptr,\n+               /*thread_pool=*/nullptr,\n+               /*layout_canonicalization_callback=*/{},\n+               /*is_autotuning_compilation=*/false}));\n     });\n   }\n }\n@@ -1315,7 +1308,6 @@ ENTRY main {\n   std::unique_ptr<GpuExecutable> gpu_exec(\n       static_cast<GpuExecutable*>(executable.release()));\n \n-  EXPECT_EQ(gpu_exec->GetThunk().thunks().size(), 3);\n   EXPECT_THAT(gpu_exec->GetThunk().thunks(),\n               ::testing::ElementsAre(ThunkKindIs(Thunk::kWaitForStreams),\n                                      ThunkKindIs(Thunk::kSequential),\n@@ -1984,14 +1976,16 @@ TEST_F(GpuCompilerTest, CompilingAndCollectingMetadata) {\n     EXPECT_LE(pass_metadata.start_timestamp_usec(),\n               pass_metadata.end_timestamp_usec());\n   }\n-  auto status_or_executable = backend().compiler()->RunBackend(\n-      std::move(opt_module), backend().default_stream_executor(),\n-      {/*device_allocator=*/nullptr,\n-       /*thread_pool=*/nullptr,\n-       /*layout_canonicalization_callback=*/{},\n-       /*is_autotuning_compilation=*/false});\n-\n-  auto& exe_module = status_or_executable.value()->module();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(opt_module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/false}));\n+\n+  auto& exe_module = executable->module();\n   const HloModuleMetadataProto& exe_metadata = exe_module.metadata()->proto();\n   for (int pass = 0; pass < exe_metadata.pass_metadata().size(); pass++) {\n     const HloPassMetadata& pass_metadata = exe_metadata.pass_metadata(pass);\n@@ -2026,16 +2020,14 @@ ENTRY main {\n \n   hlo_module->mutable_config().set_debug_options(debug_options);\n \n-  std::unique_ptr<Executable> executable =\n-      backend()\n-          .compiler()\n-          ->RunBackend(std::move(hlo_module),\n-                       backend().default_stream_executor(),\n-                       {/*device_allocator=*/nullptr,\n-                        /*thread_pool=*/nullptr,\n-                        /*layout_canonicalization_callback=*/{},\n-                        /*is_autotuning_compilation=*/false})\n-          .value();\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<Executable> executable,\n+      backend().compiler()->RunBackend(std::move(hlo_module),\n+                                       backend().default_stream_executor(),\n+                                       {/*device_allocator=*/nullptr,\n+                                        /*thread_pool=*/nullptr,\n+                                        /*layout_canonicalization_callback=*/{},\n+                                        /*is_autotuning_compilation=*/false}));\n   std::unique_ptr<GpuExecutable> gpu_exec(\n       static_cast<GpuExecutable*>(executable.release()));\n   const ThunkSequence& thunks = gpu_exec->GetThunk().thunks();"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 66,
        "deletions": 74
    }
}