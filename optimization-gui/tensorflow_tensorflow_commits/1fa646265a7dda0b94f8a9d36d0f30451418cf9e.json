{
    "author": "akuegel",
    "message": "[XLA:GPU] Avoid a segfault in StreamAttributeAnnotator\n\nCurrently it is assumed that GetTupleElement is never the root of a\ncomputation. That assumption is not necessarily true, e.g. during autotuning of\nCublas Gemm calls we can have a GetTupleElement op as root.\n\nPiperOrigin-RevId: 825932301",
    "sha": "1fa646265a7dda0b94f8a9d36d0f30451418cf9e",
    "files": [
        {
            "sha": "9837cf9f35b1bfd3712135db01b26e3f91b7f449",
            "filename": "third_party/xla/xla/service/gpu/transforms/stream_attribute_annotator.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1fa646265a7dda0b94f8a9d36d0f30451418cf9e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fstream_attribute_annotator.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1fa646265a7dda0b94f8a9d36d0f30451418cf9e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fstream_attribute_annotator.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fstream_attribute_annotator.cc?ref=1fa646265a7dda0b94f8a9d36d0f30451418cf9e",
            "patch": "@@ -156,6 +156,9 @@ absl::StatusOr<bool> AnnotateStreamAttributesForUsers(\n   std::vector<HloInstruction*> all_consumers;\n   for (auto user : instr->users()) {\n     if (HloPredicateIsOp<HloOpcode::kGetTupleElement>(user)) {\n+      if (user->user_count() == 0) {\n+        continue;\n+      }\n       user = user->users()[0];\n     }\n     all_consumers.push_back(user);"
        },
        {
            "sha": "a15c4d04c7b0e4d041f945bcbce01138311d1e80",
            "filename": "third_party/xla/xla/service/gpu/transforms/stream_attribute_annotator_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1fa646265a7dda0b94f8a9d36d0f30451418cf9e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fstream_attribute_annotator_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1fa646265a7dda0b94f8a9d36d0f30451418cf9e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fstream_attribute_annotator_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fstream_attribute_annotator_test.cc?ref=1fa646265a7dda0b94f8a9d36d0f30451418cf9e",
            "patch": "@@ -159,6 +159,28 @@ TEST_F(StreamAttributeAnnotatorTest, GTEUserIsAnnotated) {\n   EXPECT_EQ(gpu_config.wait_on_operation_queues()[0], 1);\n }\n \n+TEST_F(StreamAttributeAnnotatorTest, GTENoUserIsHandled) {\n+  constexpr absl::string_view kHloString = R\"(\n+  HloModule ModuleWithAsync\n+\n+  ENTRY entry {\n+    p1_32 = f32[16,32] parameter(0)\n+    p2_32 = f32[32,16] parameter(1)\n+\n+    custom-call.3 = (f32[16,16], s8[1028]{0}) custom-call(p1_32, p2_32), custom_call_target=\"__cublas$gemm\", backend_config={\"operation_queue_id\":\"1\",\"wait_on_operation_queues\":[],\"gemm_backend_config\":{\"alpha_real\":1,\"alpha_imag\":0,\"beta\":0,\"dot_dimension_numbers\":{\"lhs_contracting_dimensions\":[\"1\"],\"rhs_contracting_dimensions\":[\"0\"],\"lhs_batch_dimensions\":[],\"rhs_batch_dimensions\":[]},\"precision_config\":{\"operand_precision\":[\"DEFAULT\",\"DEFAULT\"]},\"epilogue\":\"DEFAULT\",\"grad_x\":false,\"grad_y\":false}}\n+    ROOT get-tuple-element.24 = f32[16,16] get-tuple-element(custom-call.3), index=0\n+  }\n+  )\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(kHloString));\n+\n+  StreamAttributeAnnotator attr_annotator{device_description()};\n+  bool changed;\n+  TF_ASSERT_OK_AND_ASSIGN(changed, attr_annotator.Run(module.get()));\n+  EXPECT_FALSE(changed);\n+}\n+\n TEST_F(StreamAttributeAnnotatorTest, FusionIsAnnotated) {\n   constexpr absl::string_view kHloString = R\"(\n   HloModule ModuleWithFusion"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 25,
        "deletions": 0
    }
}