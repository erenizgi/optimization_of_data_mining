{
    "author": "alekstheod",
    "message": "PR #35108: [ROCm] Fix crashes in hermetic build tests\n\nImported from GitHub PR https://github.com/openxla/xla/pull/35108\n\nüìù Summary of Changes\nFixing crash due to conflicting llvm in rocm vs llvm-project symbols\n\nüéØ Justification\nnew versions of rocm are linked agains an internal version of llvm\nthe symbols of this library are hidden behind the libamd_comgr_loader.so library.\nIt is wrong to link libamd_comgr.so directoy to any xla target. Instead we have to link\nlibamd_comgr_loader.so and a specific stub file. This will ensure that internal\nrocm llvm is loaded dynamically and calls are propagated to it through the loader.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nExisting u-tests in hermetic build with rocm 7.10.0\n\nüß™ Execution Tests:\nRocm CI hermetic tests + //xla/service/gpu:gpu_offloading_test_amdgpu_any locally\n\nCopybara import of the project:\n\n--\nbec3e66474a0a611f69265fdbf6f672566ad3a15 by Alexandros Theodoridis <atheodor@amd.com>:\n\nFix crashes in hermetic build tests\n\nMerging this change closes #35108\n\nPiperOrigin-RevId: 843090382",
    "sha": "fe87a77274ede90f62f422628926939eec9ef5be",
    "files": [
        {
            "sha": "d3b6f87a4adf183f7f3a4c0b60fd8ae3e7c0e22e",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 35,
            "deletions": 17,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fe87a77274ede90f62f422628926939eec9ef5be/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fe87a77274ede90f62f422628926939eec9ef5be/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=fe87a77274ede90f62f422628926939eec9ef5be",
            "patch": "@@ -116,12 +116,8 @@ cc_library(\n         \":rocsolver\",\n         \":rocsparse\",\n         \":roctracer\",\n-    ] + select_threshold(\n-        above_or_eq = [\":hipfft\"],\n-        below = [\":rocfft\"],\n-        threshold = 40100,\n-        value = rocm_version_number(),\n-    ),\n+        \":hipfft\",\n+    ],\n )\n \n cc_library(\n@@ -535,8 +531,9 @@ cc_library(\n )\n \n cc_library(\n-    name = \"amd_comgr\",\n+    name = \"amd_comgr_dynamic\",\n     hdrs = glob([\"%{rocm_root}/include/amd_comgr/**\"]),\n+    srcs = [\"%{rocm_root}/lib/libamd_comgr_stub.a\"],\n     data = glob([\n         \"%{rocm_root}/lib/libamd_comgr_loader.so*\",\n         \"%{rocm_root}/lib/libamd_comgr.so*\",\n@@ -546,24 +543,45 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include\",\n     ],\n-    linkopts = select({\n-        \":build_hermetic\": [\n-            \"-lamd_comgr_loader\",\n-            \"-lamd_comgr\",\n-        ],\n-        \"//conditions:default\": [\n-            \"-lamd_comgr\",\n-        ],\n-    }),\n+    linkopts = [\"-lamd_comgr_loader\"],\n+    strip_include_prefix = \"%{rocm_root}\",\n+    deps = [\n+        \":rocm_config\",\n+        \":rocm_rpath\",\n+        \":system_libs\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"amd_comgr_static\",\n+    hdrs = glob([\"%{rocm_root}/include/amd_comgr/**\"]),\n+    data = glob([\n+        \"%{rocm_root}/lib/libamd_comgr.so*\",\n+    ]),\n+    include_prefix = \"rocm\",\n+    includes = [\n+        \"%{rocm_root}/include\",\n+    ],\n+    linkopts = [\"-lamd_comgr\"],\n     strip_include_prefix = \"%{rocm_root}\",\n-    visibility = [\"//visibility:public\"],\n     deps = [\n         \":rocm_config\",\n         \":rocm_rpath\",\n         \":system_libs\",\n     ],\n )\n \n+alias(\n+    name = \"amd_comgr\",\n+    actual = select_threshold(\n+        above_or_eq = \":amd_comgr_dynamic\",\n+        below = \":amd_comgr_static\",\n+        threshold = 71000,\n+        value = rocm_version_number(),\n+    ),\n+    visibility = [\"//visibility:public\"],\n+)\n+\n cc_library(\n     name = \"rocm_smi\",\n     srcs = glob(["
        }
    ],
    "stats": {
        "total": 52,
        "additions": 35,
        "deletions": 17
    }
}