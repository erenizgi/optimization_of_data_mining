{
    "author": "tensorflower-gardener",
    "message": "Allow hlo runner to profile multiple repeats.\n- If `num_repeats_with_profiler=3 recreate_profiler_session_between_repeats=false`,\n  then a single profiling session is created for the last 3 repeats\n- If `num_repeats_with_profiler=3 recreate_profiler_session_between_repeats=false`,\n  then we profile the last 3 repeats with 3 separated profiling sessions.\n\nPiperOrigin-RevId: 802933912",
    "sha": "d0b02e932f52f7e520ea8b87828729d1139b0f56",
    "files": [
        {
            "sha": "56ebd400bec6f2b3a1b5fda146ccae9a977f7c59",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2FBUILD?ref=d0b02e932f52f7e520ea8b87828729d1139b0f56",
            "patch": "@@ -259,6 +259,7 @@ xla_test(\n         \"//xla/service:computation_layout\",\n         \"//xla/service:hlo_proto_cc\",\n         \"//xla/tests:xla_test_backend_predicates\",\n+        \"//xla/tools/multihost_hlo_runner:profiler_interface\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\","
        },
        {
            "sha": "1702259e25419b73de9085560f8dbf3e02deae40",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.cc?ref=d0b02e932f52f7e520ea8b87828729d1139b0f56",
            "patch": "@@ -578,10 +578,15 @@ absl::StatusOr<PerDeviceLiteralVecType> RunInternal(\n   futures.emplace();\n   std::vector<std::vector<std::unique_ptr<PjRtBuffer>>> device_buffers;\n   std::vector<std::vector<PjRtBuffer*>> argument_ptrs;\n+\n+  bool has_active_profiler_session = false;\n   for (int repeat = 0; repeat < running_options.num_repeats; ++repeat) {\n     const bool is_last_repeat = (repeat == running_options.num_repeats - 1);\n     const bool profile_current_repeat =\n-        (running_options.profiler != nullptr) && is_last_repeat;\n+        (running_options.profiler != nullptr) &&\n+        (repeat >= running_options.num_repeats -\n+                       running_options.num_repeats_with_profiler);\n+\n     VLOG(1) << \"FunctionalHloRunner: ExecuteOnDevices started (repeat = \"\n             << repeat << \").\";\n     {\n@@ -605,8 +610,9 @@ absl::StatusOr<PerDeviceLiteralVecType> RunInternal(\n         execute_options.execution_profile->set_warmup_run_executed(repeat > 0);\n       }\n \n-      if (profile_current_repeat) {\n+      if (profile_current_repeat && !has_active_profiler_session) {\n         running_options.profiler->CreateSession();\n+        has_active_profiler_session = true;\n       }\n       futures->clear();\n       TF_ASSIGN_OR_RETURN(\n@@ -615,8 +621,13 @@ absl::StatusOr<PerDeviceLiteralVecType> RunInternal(\n       for (auto& future : *futures) {\n         TF_RETURN_IF_ERROR(future.Await());\n       }\n-      if (profile_current_repeat) {\n+\n+      const bool upload_active_profiler_session =\n+          running_options.recreate_profiler_session_between_repeats ||\n+          is_last_repeat;\n+      if (has_active_profiler_session && upload_active_profiler_session) {\n         running_options.profiler->UploadSession();\n+        has_active_profiler_session = false;\n       }\n     }\n     VLOG(1) << \"FunctionalHloRunner: ExecuteOnDevices succeeded (repeat = \""
        },
        {
            "sha": "57e38a4919951297bd8ce0ebbb8d4010ad35a9d6",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner.h?ref=d0b02e932f52f7e520ea8b87828729d1139b0f56",
            "patch": "@@ -249,6 +249,12 @@ struct RunningOptions {\n   ModuleOutputMode module_output_mode = ModuleOutputMode::kReturnOutputs;\n   // Repeatedly execute the HLO for this many times.\n   size_t num_repeats = 1;\n+  // The last `num_repeats_with_profiler` repeats out of `num_repeats` will be\n+  // profiled. Default is 1, i.e., the last repeat will be profiled.\n+  size_t num_repeats_with_profiler = 1;\n+  // If true, we recreate the profiler session between repeats when profiling\n+  // more than one repeat.\n+  bool recreate_profiler_session_between_repeats = false;\n   size_t base_run_id = 0;\n   // If true, we recreate the buffers between repeats to reset of effect of\n   // buffer donation."
        },
        {
            "sha": "2f7782a14b173a077b0bea9e99f170deca89ef0b",
            "filename": "third_party/xla/xla/tools/multihost_hlo_runner/functional_hlo_runner_test.cc",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0b02e932f52f7e520ea8b87828729d1139b0f56/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fmultihost_hlo_runner%2Ffunctional_hlo_runner_test.cc?ref=d0b02e932f52f7e520ea8b87828729d1139b0f56",
            "patch": "@@ -43,6 +43,7 @@ limitations under the License.\n #include \"xla/status_macros.h\"\n #include \"xla/tools/multihost_hlo_runner/create_client.h\"\n #include \"xla/tools/multihost_hlo_runner/hlo_input_output_format.h\"\n+#include \"xla/tools/multihost_hlo_runner/profiler_interface.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/errors.h\"\n@@ -868,6 +869,56 @@ TEST_F(FunctionalHloRunnerTest, DumpsUnoptimizedHLOInUnoptimizedSnapshot) {\n   EXPECT_FALSE(snapshot.hlo_module().has_schedule());\n }\n \n+class MockProfiler : public ProfilerInterface {\n+ public:\n+  MOCK_METHOD(void, CreateSession, (), (override));\n+  MOCK_METHOD(void, UploadSession, (), (override));\n+};\n+\n+TEST_F(FunctionalHloRunnerTest, ProfileMultipleRepeatsSingleSession) {\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::PjRtClient> client,\n+                          GetPjRtClient());\n+  xla::DebugOptions debug_options;\n+  FunctionalHloRunner::PreprocessingOptions preproc_options;\n+  CompileOptions compile_options;\n+\n+  FunctionalHloRunner::RunningOptions running_options;\n+  MockProfiler mock_profiler;\n+  running_options.profiler = &mock_profiler;\n+  running_options.num_repeats = 5;\n+  running_options.num_repeats_with_profiler = 3;\n+  running_options.recreate_profiler_session_between_repeats = false;\n+\n+  EXPECT_CALL(mock_profiler, CreateSession()).Times(1);\n+  EXPECT_CALL(mock_profiler, UploadSession()).Times(1);\n+\n+  TF_EXPECT_OK(FunctionalHloRunner::LoadAndRun(\n+      *client, debug_options, preproc_options, compile_options, running_options,\n+      {GetHloPath(\"single_device.hlo\")}, InputFormat::kText));\n+}\n+\n+TEST_F(FunctionalHloRunnerTest, ProfileMultipleRepeatsSessionPerRepeat) {\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<xla::PjRtClient> client,\n+                          GetPjRtClient());\n+  xla::DebugOptions debug_options;\n+  FunctionalHloRunner::PreprocessingOptions preproc_options;\n+  CompileOptions compile_options;\n+\n+  FunctionalHloRunner::RunningOptions running_options;\n+  MockProfiler mock_profiler;\n+  running_options.profiler = &mock_profiler;\n+  running_options.num_repeats = 5;\n+  running_options.num_repeats_with_profiler = 3;\n+  running_options.recreate_profiler_session_between_repeats = true;\n+\n+  EXPECT_CALL(mock_profiler, CreateSession()).Times(3);\n+  EXPECT_CALL(mock_profiler, UploadSession()).Times(3);\n+\n+  TF_EXPECT_OK(FunctionalHloRunner::LoadAndRun(\n+      *client, debug_options, preproc_options, compile_options, running_options,\n+      {GetHloPath(\"single_device.hlo\")}, InputFormat::kText));\n+}\n+\n }  // namespace\n }  // namespace xla\n "
        }
    ],
    "stats": {
        "total": 75,
        "additions": 72,
        "deletions": 3
    }
}