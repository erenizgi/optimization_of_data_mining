{
    "author": "frgossen",
    "message": "[XLA:GPU] Support merging of perf tables based on individual files.\n\nPiperOrigin-RevId: 808297760",
    "sha": "8c8af27ea108486310f00d6836fa69f40ac1f571",
    "files": [
        {
            "sha": "541d691cce6af26296c380524f33d26a32343918",
            "filename": "third_party/xla/xla/tools/collective_perf_table_gen.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8c8af27ea108486310f00d6836fa69f40ac1f571/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8c8af27ea108486310f00d6836fa69f40ac1f571/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.cc?ref=8c8af27ea108486310f00d6836fa69f40ac1f571",
            "patch": "@@ -455,21 +455,16 @@ absl::Status CollectivePerfTableGen::Dump(\n }\n \n DeviceHloInstructionProfiles CollectivePerfTableGen::Merge(\n-    absl::string_view merge_path) {\n+    const std::vector<std::string>& files) {\n   DeviceHloInstructionProfiles result;\n-  std::vector<std::string> filenames;\n-  CHECK_OK(\n-      tsl::Env::Default()->GetChildren(std::string(merge_path), &filenames));\n \n   absl::flat_hash_set<ProfilingResult, ProfilingResult::Hash,\n                       ProfilingResult::Eq>\n       profiling_results;\n   uint64_t profiling_results_counter = 0;\n-  for (const std::string& filename : filenames) {\n+  for (const std::string& profile_path : files) {\n     // Read file.\n-    std::string profile_path = absl::StrCat(merge_path, \"/\", filename);\n     DeviceHloInstructionProfiles partial_profile;\n-\n     CHECK_OK(tsl::Env::Default()->FileExists(profile_path));\n     if (!tsl::ReadTextOrBinaryProto(tsl::Env::Default(), profile_path,\n                                     &partial_profile)\n@@ -529,4 +524,17 @@ DeviceHloInstructionProfiles CollectivePerfTableGen::Merge(\n   return result;\n }\n \n+DeviceHloInstructionProfiles CollectivePerfTableGen::Merge(\n+    absl::string_view merge_path) {\n+  std::vector<std::string> file_paths;\n+  std::vector<std::string> filenames;\n+  CHECK_OK(\n+      tsl::Env::Default()->GetChildren(std::string(merge_path), &filenames));\n+  for (const std::string& fname : filenames) {\n+    std::string file_path = absl::StrCat(merge_path, \"/\", fname);\n+    file_paths.push_back(file_path);\n+  }\n+  return Merge(file_paths);\n+}\n+\n }  // namespace xla::gpu"
        },
        {
            "sha": "2ed042d306ddf6f647796c7e3c49625e01134d38",
            "filename": "third_party/xla/xla/tools/collective_perf_table_gen.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8c8af27ea108486310f00d6836fa69f40ac1f571/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8c8af27ea108486310f00d6836fa69f40ac1f571/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen.h?ref=8c8af27ea108486310f00d6836fa69f40ac1f571",
            "patch": "@@ -94,6 +94,11 @@ class CollectivePerfTableGen {\n   // content (but not deduplicating).\n   absl::Status Dump(const DeviceHloInstructionProfiles& table);\n \n+  // Merges all of the profile files, deduplicates them\n+  // based on fingerprint and writes them to a single\n+  // `DeviceHloInstructionProfiles` proto.\n+  DeviceHloInstructionProfiles Merge(const std::vector<std::string>& files);\n+\n   // Merges all of the profiled files under `merge_path`, deduplicates them\n   // based on fingerprint and writes them to a single\n   // `DeviceHloInstructionProfiles` proto."
        },
        {
            "sha": "151c7dc0bc6c11308b28ff7673afb5276dfeed05",
            "filename": "third_party/xla/xla/tools/collective_perf_table_gen_main.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8c8af27ea108486310f00d6836fa69f40ac1f571/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8c8af27ea108486310f00d6836fa69f40ac1f571/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fcollective_perf_table_gen_main.cc?ref=8c8af27ea108486310f00d6836fa69f40ac1f571",
            "patch": "@@ -173,6 +173,7 @@ int main(int argc, char* argv[]) {\n   std::string coordinator_address = std::string(kDefaultCoordinatorAddress);\n   std::string output = std::string(CollectivePerfTableGen::Config::kStdout);\n   std::string merge_path;\n+  std::vector<std::string> merge_files;\n \n   // Parse flags.\n   std::vector<tsl::Flag> flag_list = {\n@@ -205,6 +206,15 @@ int main(int argc, char* argv[]) {\n                 \"Path to DeviceHloInstructionProfiles files. When specified it \"\n                 \"will merge all of the profiled files and write them to a \"\n                 \"single file specified by `output`.\"),\n+      tsl::Flag(\n+          \"merge\",\n+          [&merge_files](std::string file) {\n+            merge_files.push_back(file);\n+            return true;\n+          },\n+          \"none\",\n+          \"Path to individual DeviceHloInstructionProfiles files. If \"\n+          \"specified, these files will be merged into a single one.\"),\n   };\n \n   std::string kUsageString =\n@@ -229,11 +239,13 @@ int main(int argc, char* argv[]) {\n   std::unique_ptr<CollectivePerfTableGen> gen =\n       CollectivePerfTableGen::Create(cfg);\n   DeviceHloInstructionProfiles profiles;\n-  if (merge_path.empty()) {\n-    profiles = gen->ComputeTable();\n-  } else {\n+  if (!merge_path.empty()) {\n     profiles = gen->Merge(merge_path);\n-  };\n+  } else if (!merge_files.empty()) {\n+    profiles = gen->Merge(merge_files);\n+  } else {\n+    profiles = gen->ComputeTable();\n+  }\n   CHECK_OK(gen->Dump(profiles));\n   return 0;\n }"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 36,
        "deletions": 11
    }
}