{
    "author": "ermilovmaxim",
    "message": "Port more BufferUse users to provide shape\n\nPiperOrigin-RevId: 833660963",
    "sha": "8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
    "files": [
        {
            "sha": "c7db83c873d76a716f9d9e03049a49a3880cf56b",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -834,9 +834,8 @@ xla_cc_test(\n         \"//xla/runtime:buffer_use\",\n         \"//xla/runtime:resource_use\",\n         \"//xla/service:buffer_assignment\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:statusor\",\n-        \"@local_tsl//tsl/platform:test\",\n     ],\n )\n "
        },
        {
            "sha": "908fad230246dd920dacad468529abd75d188e83",
            "filename": "third_party/xla/xla/backends/cpu/runtime/collective_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcollective_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcollective_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcollective_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -91,11 +91,13 @@ CollectiveThunk::CollectiveThunk(CollectiveKind collective_kind,\n Thunk::BufferUses CollectiveThunk::buffer_uses() const {\n   BufferUses uses;\n   uses.reserve(source_buffers().size() + destination_buffers().size());\n-  for (auto& source_buffer : source_buffers()) {\n-    uses.push_back(BufferUse::Read(source_buffer));\n+  for (int i = 0; i < source_buffers().size(); i++) {\n+    uses.push_back(BufferUse::Read(op_buffers_.source_buffers[i],\n+                                   op_buffers_.source_shapes[i]));\n   }\n-  for (auto& destination_buffer : destination_buffers()) {\n-    uses.push_back(BufferUse::Write(destination_buffer));\n+  for (int i = 0; i < destination_buffers().size(); i++) {\n+    uses.push_back(BufferUse::Write(op_buffers_.destination_buffers[i],\n+                                    op_buffers_.destination_shapes[i]));\n   }\n   return uses;\n }"
        },
        {
            "sha": "ce9c274da7b2a1023c3a3b846b02d98016a86761",
            "filename": "third_party/xla/xla/backends/cpu/runtime/copy_thunk.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcopy_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcopy_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcopy_thunk.h?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -46,7 +46,8 @@ class CopyThunk final : public Thunk {\n   tsl::AsyncValueRef<ExecuteEvent> Execute(const ExecuteParams& params) final;\n \n   BufferUses buffer_uses() const final {\n-    return {BufferUse::Read(src_buffer_), BufferUse::Write(dst_buffer_)};\n+    return {BufferUse::Read(src_buffer_, src_shape_),\n+            BufferUse::Write(dst_buffer_, dst_shape_)};\n   }\n \n   const Shape& src_shape() const { return src_shape_; }"
        },
        {
            "sha": "a1bd9e28b80d7c765c3d84eeef076558f95cd80c",
            "filename": "third_party/xla/xla/backends/cpu/runtime/custom_call_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcustom_call_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcustom_call_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fcustom_call_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -396,11 +396,13 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> CustomCallThunk::CallUntypedAPI(\n \n CustomCallThunk::BufferUses CustomCallThunk::buffer_uses() const {\n   BufferUses buffer_uses;\n-  for (const auto& argument : op_buffers_.arguments_buffers) {\n-    buffer_uses.emplace_back(BufferUse::Read(argument));\n+  for (int i = 0; i < op_buffers_.arguments_buffers.size(); i++) {\n+    buffer_uses.emplace_back(BufferUse::Read(op_buffers_.arguments_buffers[i],\n+                                             op_buffers_.arguments_shapes[i]));\n   }\n-  for (const auto& result : op_buffers_.results_buffers) {\n-    buffer_uses.emplace_back(BufferUse::Write(result));\n+  for (int i = 0; i < op_buffers_.results_buffers.size(); i++) {\n+    buffer_uses.emplace_back(BufferUse::Write(op_buffers_.results_buffers[i],\n+                                              op_buffers_.results_shapes[i]));\n   }\n   return buffer_uses;\n }"
        },
        {
            "sha": "2f6ac18d0694726a7e707cc9f415abe259cc45d0",
            "filename": "third_party/xla/xla/backends/cpu/runtime/fft_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ffft_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ffft_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Ffft_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -197,7 +197,8 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> FftThunk::Execute(\n }\n \n Thunk::BufferUses FftThunk::buffer_uses() const {\n-  return {BufferUse::Read(input_buffer_), BufferUse::Write(output_buffer_)};\n+  return {BufferUse::Read(input_buffer_, input_shape_),\n+          BufferUse::Write(output_buffer_, output_shape_)};\n }\n \n }  // namespace xla::cpu"
        },
        {
            "sha": "95af21510e81069f37703226a35024537c083130",
            "filename": "third_party/xla/xla/backends/cpu/runtime/onednn/onednn_op_thunk.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fonednn%2Fonednn_op_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fonednn%2Fonednn_op_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fonednn%2Fonednn_op_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -142,11 +142,13 @@ OneDnnOpThunk::~OneDnnOpThunk() = default;\n \n OneDnnOpThunk::BufferUses OneDnnOpThunk::buffer_uses() const {\n   BufferUses buffer_uses;\n-  for (const auto& argument : op_buffers_.arguments_buffers) {\n-    buffer_uses.emplace_back(BufferUse::Read(argument));\n+  for (int i = 0; i < op_buffers_.arguments_buffers.size(); i++) {\n+    buffer_uses.emplace_back(BufferUse::Read(op_buffers_.arguments_buffers[i],\n+                                             op_buffers_.arguments_shapes[i]));\n   }\n-  for (const auto& result : op_buffers_.results_buffers) {\n-    buffer_uses.emplace_back(BufferUse::Write(result));\n+  for (int i = 0; i < op_buffers_.results_buffers.size(); i++) {\n+    buffer_uses.emplace_back(BufferUse::Write(op_buffers_.results_buffers[i],\n+                                              op_buffers_.results_shapes[i]));\n   }\n   return buffer_uses;\n }"
        },
        {
            "sha": "d7308550cb1171b5774aa195829c6b7c2dd33c7b",
            "filename": "third_party/xla/xla/backends/cpu/runtime/outfeed_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Foutfeed_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Foutfeed_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Foutfeed_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -99,7 +99,8 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> OutfeedThunk::Execute(\n OutfeedThunk::BufferUses OutfeedThunk::buffer_uses() const {\n   BufferUses buffer_uses;\n   for (const OutfeedBuffer& outfeed_buffer : outfeed_buffers_) {\n-    buffer_uses.emplace_back(BufferUse::Read(outfeed_buffer.slice));\n+    buffer_uses.emplace_back(\n+        BufferUse::Read(outfeed_buffer.slice, outfeed_buffer.shape));\n   }\n   return buffer_uses;\n }"
        },
        {
            "sha": "28b5f6a58ca33e87d0a1f6a3a081bd758c65df54",
            "filename": "third_party/xla/xla/backends/cpu/runtime/outfeed_thunk_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Foutfeed_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Foutfeed_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Foutfeed_thunk_test.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -22,21 +22,22 @@ limitations under the License.\n #include \"xla/runtime/buffer_use.h\"\n #include \"xla/runtime/resource_use.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/xla_data.pb.h\"\n-#include \"tsl/platform/statusor.h\"\n-#include \"tsl/platform/test.h\"\n \n namespace xla::cpu {\n namespace {\n \n TEST(OutfeedThunkTest, BufferAndResourceUses) {\n   BufferAllocation alloc(0, 1024, 0);\n   BufferAllocation::Slice outfeed_slice(&alloc, 10, 40);\n+  Shape outfeed_shape = ShapeUtil::MakeShape(F32, {10});\n \n   OutfeedThunk::OutfeedBuffer outfeed_buffer = {\n       outfeed_slice,\n-      ShapeUtil::MakeShape(F32, {10}),\n+      outfeed_shape,\n   };\n \n   auto consume_token = Resource::Create(Resource::kToken);\n@@ -47,7 +48,8 @@ TEST(OutfeedThunkTest, BufferAndResourceUses) {\n                                                {consume_token, produce_token}));\n \n   EXPECT_EQ(thunk->buffer_uses().size(), 1);\n-  EXPECT_EQ(thunk->buffer_uses()[0], BufferUse::Read(outfeed_slice));\n+  EXPECT_EQ(thunk->buffer_uses()[0],\n+            BufferUse::Read(outfeed_slice, outfeed_shape));\n \n   EXPECT_EQ(thunk->resource_uses().size(), 2);\n   EXPECT_EQ(thunk->resource_uses()[0], ResourceUse::Read(consume_token));"
        },
        {
            "sha": "3071e055abb3d1b5416e0214b02d6e0cec6895cc",
            "filename": "third_party/xla/xla/backends/cpu/runtime/xnnpack/xnn_fusion_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fxnnpack%2Fxnn_fusion_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fxnnpack%2Fxnn_fusion_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fxnnpack%2Fxnn_fusion_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -272,10 +272,10 @@ XnnFusionThunk::~XnnFusionThunk() = default;\n XnnFusionThunk::BufferUses XnnFusionThunk::buffer_uses() const {\n   BufferUses buffer_uses;\n   for (const Argument& argument : arguments_) {\n-    buffer_uses.push_back(BufferUse::Read(argument.slice));\n+    buffer_uses.push_back(BufferUse::Read(argument.slice, argument.shape));\n   }\n   for (const Result& result : results_) {\n-    buffer_uses.push_back(BufferUse::Write(result.slice));\n+    buffer_uses.push_back(BufferUse::Write(result.slice, result.shape));\n   }\n \n   return buffer_uses;"
        },
        {
            "sha": "d87974ed7053912b03a0608fd86db6eecffc60ed",
            "filename": "third_party/xla/xla/backends/cpu/runtime/ynnpack/ynn_fusion_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fynn_fusion_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8abddaee0313c32b2fcbe3a285fe43f38b5c83e4/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fynn_fusion_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fynnpack%2Fynn_fusion_thunk.cc?ref=8abddaee0313c32b2fcbe3a285fe43f38b5c83e4",
            "patch": "@@ -287,10 +287,10 @@ YnnFusionThunk::~YnnFusionThunk() = default;\n YnnFusionThunk::BufferUses YnnFusionThunk::buffer_uses() const {\n   BufferUses buffer_uses;\n   for (const Argument& argument : arguments_) {\n-    buffer_uses.push_back(BufferUse::Read(argument.slice));\n+    buffer_uses.push_back(BufferUse::Read(argument.slice, argument.shape));\n   }\n   for (const Result& result : results_) {\n-    buffer_uses.push_back(BufferUse::Write(result.slice));\n+    buffer_uses.push_back(BufferUse::Write(result.slice, result.shape));\n   }\n \n   return buffer_uses;"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 35,
        "deletions": 25
    }
}