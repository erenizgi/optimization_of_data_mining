{
    "author": "majnemer",
    "message": "[XLA] Reuse abseil's macros\n\nNo need to reinvent the wheel.\n\nPiperOrigin-RevId: 811769096",
    "sha": "fbd325f0a1b7962b426995bdaaf1986d0c69b704",
    "files": [
        {
            "sha": "0d0c9861bd145a47525217b52f93a62832e26aae",
            "filename": "tensorflow/core/platform/macros.h",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd325f0a1b7962b426995bdaaf1986d0c69b704/tensorflow%2Fcore%2Fplatform%2Fmacros.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd325f0a1b7962b426995bdaaf1986d0c69b704/tensorflow%2Fcore%2Fplatform%2Fmacros.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fplatform%2Fmacros.h?ref=fbd325f0a1b7962b426995bdaaf1986d0c69b704",
            "patch": "@@ -18,12 +18,4 @@ limitations under the License.\n \n #include \"tsl/platform/macros.h\"  // IWYU pragma: export\n \n-namespace tensorflow {\n-namespace internal {\n-template <typename T>\n-constexpr auto remove_unused_variable_compiler_warning =\n-    tsl::internal::remove_unused_variable_compiler_warning<T>;\n-}  // namespace internal\n-}  // namespace tensorflow\n-\n #endif  // TENSORFLOW_CORE_PLATFORM_MACROS_H_"
        },
        {
            "sha": "cd5d588b35b5aad0d0d2a27d4cb51c72c6b142b4",
            "filename": "third_party/xla/xla/tsl/platform/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd325f0a1b7962b426995bdaaf1986d0c69b704/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd325f0a1b7962b426995bdaaf1986d0c69b704/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2FBUILD?ref=fbd325f0a1b7962b426995bdaaf1986d0c69b704",
            "patch": "@@ -531,6 +531,7 @@ cc_library(\n     name = \"macros\",\n     hdrs = [\"macros.h\"],\n     compatible_with = get_compatible_with_portable(),\n+    deps = [\"@com_google_absl//absl/base:core_headers\"],\n )\n \n cc_library("
        },
        {
            "sha": "d957c2253f92b6bfc51cfe4b034f42089574fc01",
            "filename": "third_party/xla/xla/tsl/platform/macros.h",
            "status": "modified",
            "additions": 16,
            "deletions": 81,
            "changes": 97,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd325f0a1b7962b426995bdaaf1986d0c69b704/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fmacros.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd325f0a1b7962b426995bdaaf1986d0c69b704/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fmacros.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fplatform%2Fmacros.h?ref=fbd325f0a1b7962b426995bdaaf1986d0c69b704",
            "patch": "@@ -16,46 +16,17 @@ limitations under the License.\n #ifndef XLA_TSL_PLATFORM_MACROS_H_\n #define XLA_TSL_PLATFORM_MACROS_H_\n \n+#include \"absl/base/attributes.h\"\n+#include \"absl/base/macros.h\"\n+#include \"absl/base/optimization.h\"\n+\n // Compiler attributes\n-#if (defined(__GNUC__) || defined(__APPLE__)) && !defined(SWIG)\n-// Compiler supports GCC-style attributes\n-#define TF_ATTRIBUTE_NORETURN __attribute__((noreturn))\n-#define TF_ATTRIBUTE_ALWAYS_INLINE __attribute__((always_inline))\n-#define TF_ATTRIBUTE_NOINLINE __attribute__((noinline))\n-#define TF_ATTRIBUTE_UNUSED __attribute__((unused))\n-#define TF_ATTRIBUTE_COLD __attribute__((cold))\n-#define TF_ATTRIBUTE_WEAK __attribute__((weak))\n-#define TF_PACKED __attribute__((packed))\n-#define TF_MUST_USE_RESULT __attribute__((warn_unused_result))\n-#define TF_PRINTF_ATTRIBUTE(string_index, first_to_check) \\\n-  __attribute__((__format__(__printf__, string_index, first_to_check)))\n-#define TF_SCANF_ATTRIBUTE(string_index, first_to_check) \\\n-  __attribute__((__format__(__scanf__, string_index, first_to_check)))\n-#elif defined(_MSC_VER)\n-// Non-GCC equivalents\n-#define TF_ATTRIBUTE_NORETURN __declspec(noreturn)\n-#define TF_ATTRIBUTE_ALWAYS_INLINE __forceinline\n-#define TF_ATTRIBUTE_NOINLINE\n-#define TF_ATTRIBUTE_UNUSED\n-#define TF_ATTRIBUTE_COLD\n-#define TF_ATTRIBUTE_WEAK\n-#define TF_MUST_USE_RESULT\n-#define TF_PACKED\n-#define TF_PRINTF_ATTRIBUTE(string_index, first_to_check)\n-#define TF_SCANF_ATTRIBUTE(string_index, first_to_check)\n-#else\n-// Non-GCC equivalents\n-#define TF_ATTRIBUTE_NORETURN\n-#define TF_ATTRIBUTE_ALWAYS_INLINE\n-#define TF_ATTRIBUTE_NOINLINE\n-#define TF_ATTRIBUTE_UNUSED\n-#define TF_ATTRIBUTE_COLD\n-#define TF_ATTRIBUTE_WEAK\n-#define TF_MUST_USE_RESULT\n-#define TF_PACKED\n-#define TF_PRINTF_ATTRIBUTE(string_index, first_to_check)\n-#define TF_SCANF_ATTRIBUTE(string_index, first_to_check)\n-#endif\n+#define TF_ATTRIBUTE_ALWAYS_INLINE ABSL_ATTRIBUTE_ALWAYS_INLINE\n+#define TF_ATTRIBUTE_NOINLINE ABSL_ATTRIBUTE_NOINLINE\n+#define TF_ATTRIBUTE_UNUSED ABSL_ATTRIBUTE_UNUSED\n+#define TF_PACKED ABSL_ATTRIBUTE_PACKED\n+#define TF_MUST_USE_RESULT ABSL_MUST_USE_RESULT\n+#define TF_PRINTF_ATTRIBUTE ABSL_PRINTF_ATTRIBUTE\n \n // Control visibility outside .so\n #if defined(_WIN32)\n@@ -68,26 +39,11 @@ limitations under the License.\n #define TF_EXPORT __attribute__((visibility(\"default\")))\n #endif  // _WIN32\n \n-#ifdef __has_builtin\n-#define TF_HAS_BUILTIN(x) __has_builtin(x)\n-#else\n-#define TF_HAS_BUILTIN(x) 0\n-#endif\n-\n-// C++11-style attributes (N2761)\n-#if defined(__has_cpp_attribute)\n-// Safely checks if an attribute is supported. Equivalent to\n-// ABSL_HAVE_CPP_ATTRIBUTE.\n-#define TF_HAS_CPP_ATTRIBUTE(n) __has_cpp_attribute(n)\n-#else\n-#define TF_HAS_CPP_ATTRIBUTE(n) 0\n-#endif\n-\n // [[clang::annotate(\"x\")]] allows attaching custom strings (e.g. \"x\") to\n // declarations (variables, functions, fields, etc.) for use by tools. They are\n // represented in the Clang AST (as AnnotateAttr nodes) and in LLVM IR, but not\n // in final output.\n-#if TF_HAS_CPP_ATTRIBUTE(clang::annotate)\n+#if ABSL_HAVE_CPP_ATTRIBUTE(clang::annotate)\n #define TF_ATTRIBUTE_ANNOTATE(str) [[clang::annotate(str)]]\n #else\n #define TF_ATTRIBUTE_ANNOTATE(str)\n@@ -96,24 +52,15 @@ limitations under the License.\n // A variable declaration annotated with the `TF_CONST_INIT` attribute will\n // not compile (on supported platforms) unless the variable has a constant\n // initializer.\n-#if TF_HAS_CPP_ATTRIBUTE(clang::require_constant_initialization)\n-#define TF_CONST_INIT [[clang::require_constant_initialization]]\n-#else\n-#define TF_CONST_INIT\n-#endif\n+#define TF_CONST_INIT ABSL_CONST_INIT\n \n // Compilers can be told that a certain branch is not likely to be taken\n // (for instance, a CHECK failure), and use that information in static\n // analysis. Giving it this information can help it optimize for the\n // common case in the absence of better information (ie.\n // -fprofile-arcs).\n-#if TF_HAS_BUILTIN(__builtin_expect) || (defined(__GNUC__) && __GNUC__ >= 3)\n-#define TF_PREDICT_FALSE(x) (__builtin_expect(x, 0))\n-#define TF_PREDICT_TRUE(x) (__builtin_expect(!!(x), 1))\n-#else\n-#define TF_PREDICT_FALSE(x) (x)\n-#define TF_PREDICT_TRUE(x) (x)\n-#endif\n+#define TF_PREDICT_FALSE ABSL_PREDICT_FALSE\n+#define TF_PREDICT_TRUE ABSL_PREDICT_TRUE\n \n // DEPRECATED: directly use the macro implementation instead.\n // A macro to disallow the copy constructor and operator= functions\n@@ -126,9 +73,7 @@ limitations under the License.\n //\n // The expression TF_ARRAYSIZE(a) is a compile-time constant of type\n // size_t.\n-#define TF_ARRAYSIZE(a)         \\\n-  ((sizeof(a) / sizeof(*(a))) / \\\n-   static_cast<size_t>(!(sizeof(a) % sizeof(*(a)))))\n+#define TF_ARRAYSIZE ABSL_ARRAYSIZE\n \n #if defined(__GXX_EXPERIMENTAL_CXX0X__) || __cplusplus >= 201103L || \\\n     (defined(_MSC_VER) && _MSC_VER >= 1900)\n@@ -138,17 +83,7 @@ limitations under the License.\n #define LANG_CXX11 1\n #endif\n \n-#if defined(__clang__) && defined(LANG_CXX11) && defined(__has_warning)\n-#if __has_feature(cxx_attributes) && __has_warning(\"-Wimplicit-fallthrough\")\n-#define TF_FALLTHROUGH_INTENDED [[clang::fallthrough]]  // NOLINT\n-#endif\n-#endif\n-\n-#ifndef TF_FALLTHROUGH_INTENDED\n-#define TF_FALLTHROUGH_INTENDED \\\n-  do {                          \\\n-  } while (0)\n-#endif\n+#define TF_FALLTHROUGH_INTENDED ABSL_FALLTHROUGH_INTENDED\n \n namespace tsl {\n namespace internal {"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 17,
        "deletions": 89
    }
}