{
    "author": "loislo",
    "message": "[XLA:GPU] Ignore reductions over dimensions of size 1 in UnstableReductionDetect\n\nThe UnstableReductionDetector now considers reductions where all reduced dimensions have a size of 1 to be stable, as these operations are effectively no-ops and do not introduce numerical instability. A test case is added to verify this behavior.\n\nPiperOrigin-RevId: 825045042",
    "sha": "ffca28bcf875269d1d89c677388bb6633491b447",
    "files": [
        {
            "sha": "5e131c612a34ab227bbfc4537b5c49de65585098",
            "filename": "third_party/xla/xla/service/debug/unstable_reduction_detector_test.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ffca28bcf875269d1d89c677388bb6633491b447/third_party%2Fxla%2Fxla%2Fservice%2Fdebug%2Funstable_reduction_detector_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ffca28bcf875269d1d89c677388bb6633491b447/third_party%2Fxla%2Fxla%2Fservice%2Fdebug%2Funstable_reduction_detector_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdebug%2Funstable_reduction_detector_test.cc?ref=ffca28bcf875269d1d89c677388bb6633491b447",
            "patch": "@@ -62,6 +62,22 @@ static constexpr absl::string_view kUnstableReductionNoMetadataHloModule = R\"(\n   }\n )\";\n \n+static constexpr absl::string_view kNoOpUnstableReductionHloModule = R\"(\n+  red {\n+      p0 = bf16[] parameter(0)\n+      p1 = bf16[] parameter(1)\n+      ROOT red = bf16[] add(p0, p1)\n+  }\n+\n+  ENTRY main {\n+      p0 = bf16[1] parameter(0)\n+      init = bf16[] constant(1.0)\n+      ROOT red = bf16[] reduce(p0, init),\n+          to_apply=red,\n+          dimensions={0}\n+  }\n+)\";\n+\n using ::absl::LogSeverity;\n using ::absl_testing::IsOkAndHolds;\n using ::absl_testing::StatusIs;\n@@ -153,5 +169,22 @@ TEST(UnstableReductionDetectorTest, DoNothingOnUnstableReduction) {\n               IsOkAndHolds(false));\n }\n \n+TEST(UnstableReductionDetectorTest, NoOpUnstableReduction) {\n+  TF_ASSERT_OK_AND_ASSIGN(auto module, ParseAndReturnUnverifiedModule(\n+                                           kNoOpUnstableReductionHloModule));\n+  module->mutable_config()\n+      .mutable_debug_options()\n+      .set_xla_detect_unstable_reductions(\n+          DebugOptions::UNSTABLE_REDUCTION_DETECTION_MODE_WARNING);\n+  UnstableReductionDetector detector;\n+  ::absl::ScopedMockLog log;\n+  EXPECT_CALL(log, Log(LogSeverity::kWarning, _, _)).Times(0);\n+  EXPECT_CALL(log, Log(LogSeverity::kError, _, _)).Times(0);\n+  log.StartCapturingLogs();\n+  EXPECT_THAT(detector.Run(module.get(), /*execution_threads=*/{}),\n+              IsOkAndHolds(false));\n+  log.StopCapturingLogs();\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "07f866c4a007aeadc42e87bdcd2f229516d6e50b",
            "filename": "third_party/xla/xla/service/debug/unstable_reduction_finder.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ffca28bcf875269d1d89c677388bb6633491b447/third_party%2Fxla%2Fxla%2Fservice%2Fdebug%2Funstable_reduction_finder.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ffca28bcf875269d1d89c677388bb6633491b447/third_party%2Fxla%2Fxla%2Fservice%2Fdebug%2Funstable_reduction_finder.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdebug%2Funstable_reduction_finder.cc?ref=ffca28bcf875269d1d89c677388bb6633491b447",
            "patch": "@@ -24,6 +24,7 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/primitive_util.h\"\n #include \"xla/service/pattern_matcher.h\"\n+#include \"xla/shape.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -62,7 +63,13 @@ bool IsKnownStableReduction(const HloReduceInstruction* reduction) {\n     return true;\n   }\n \n-  return false;\n+  Shape operand_shape = reduction->operand(0)->shape();\n+  for (auto dim : reduction->dimensions()) {\n+    if (operand_shape.dimensions(dim) != 1) {\n+      return false;\n+    }\n+  }\n+  return true;\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 41,
        "deletions": 1
    }
}