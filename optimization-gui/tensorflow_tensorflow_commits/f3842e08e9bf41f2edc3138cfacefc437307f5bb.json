{
    "author": "chsigg",
    "message": "Enable new Triton emitter features and switch to nested GEMM fusion in tests.\n\nThe generic emitter uses this input and is the new default path. The legacy emitter will be removed soon.\n\nChange fusion kind from `__triton_scaled_dot_fusion` to `__triton_nested_gemm_fusion` in one test so that `GemmFusionAutotunerRewriterVisitor::HandleFusion` does not add a `triton_gemm_config` which would then trigger NestGemmFusion to double nest and break tiling analysis. The plan here is to remove `__triton_scaled_dot_fusion` in the near future, so we don't need to do anything else.\n\nPiperOrigin-RevId: 829261702",
    "sha": "f3842e08e9bf41f2edc3138cfacefc437307f5bb",
    "files": [
        {
            "sha": "d1f748027bba561c9f024babda2f9b21b4547d01",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter_device_test.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 41,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f3842e08e9bf41f2edc3138cfacefc437307f5bb/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f3842e08e9bf41f2edc3138cfacefc437307f5bb/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc?ref=f3842e08e9bf41f2edc3138cfacefc437307f5bb",
            "patch": "@@ -4785,6 +4785,12 @@ class TritonScaledDotGemmTest\n     debug_options.set_xla_gpu_cublas_fallback(false);\n     debug_options.add_xla_gpu_unsupported_generic_triton_emitter_features(\n         DebugOptions::GENERIC_TRITON_EMITTER_ENABLE_NESTED_GEMM);\n+    debug_options.add_xla_gpu_unsupported_generic_triton_emitter_features(\n+        DebugOptions::GENERIC_TRITON_EMITTER_DISABLE_LEGACY_GEMM);\n+    debug_options.add_xla_gpu_unsupported_generic_triton_emitter_features(\n+        DebugOptions::GENERIC_TRITON_EMITTER_ALLOW_ALL_OPS_IN_GEMM_FUSION);\n+    debug_options.add_xla_gpu_unsupported_generic_triton_emitter_features(\n+        DebugOptions::GENERIC_TRITON_EMITTER_ALLOW_ALL_GEMM_SHAPES);\n     return debug_options;\n   }\n };\n@@ -4883,7 +4889,7 @@ ENTRY e {\n     calls=triton_dot,\n     backend_config={\n       \"fusion_backend_config\": {\n-        kind: \"__triton_scaled_dot_fusion\",\n+        kind: \"__triton_nested_gemm_fusion\",\n         \"block_level_fusion_config\":{\n           \"output_tiles\":[{\"sizes\":[\"128\", \"256\"]}],\n           \"num_warps\":\"4\",\n@@ -4909,16 +4915,8 @@ ENTRY e {\n   auto expected_triton_ir = absl::StrReplaceAll(\n       kExpectedTritonIrTmpl, {{\"$triton_type\", params.expected_triton_type}});\n   EXPECT_THAT(\n-      CreateTritonIrAndFileCheck(*module->GetComputationWithName(\"triton_dot\"),\n-                                 /*block_level_parameters=*/\n-                                 {\n-                                     {{128, 256}},\n-                                     4,\n-                                     1,\n-                                     1,\n-                                     true,\n-                                 },\n-                                 expected_triton_ir),\n+      CreateTritonIrAndFileCheckForDot(\n+          *module->GetComputationWithName(\"triton_dot\"), expected_triton_ir),\n       absl_testing::IsOk());\n   if (GetCudaComputeCapability().IsAtLeastBlackwell()) {\n     CompileAndOptionallyVerifyPtx(\n@@ -5047,16 +5045,8 @@ ENTRY e {\n       CHECK: tensor<128x16xf8E4M3FN>, tensor<16x4xi8>\n       CHECK: -> tensor<16x16xf32>\n   )\";\n-  EXPECT_THAT(CreateTritonIrAndFileCheck(*scaled_dot_computation,\n-                                         /*block_level_parameters=*/\n-                                         {\n-                                             {{1, 16, 16}},\n-                                             4,\n-                                             1,\n-                                             1,\n-                                             false,\n-                                         },\n-                                         kExpectedTritonIr),\n+  EXPECT_THAT(CreateTritonIrAndFileCheckForDot(*scaled_dot_computation,\n+                                               kExpectedTritonIr),\n               absl_testing::IsOk());\n \n   EXPECT_TRUE(RunAndCompareNoHloPasses(\n@@ -5104,16 +5094,8 @@ ENTRY e {\n       CHECK: tensor<128x16xf8E4M3FN>, tensor<16x4xi8>\n       CHECK: -> tensor<16x16xf32>\n   )\";\n-  EXPECT_THAT(CreateTritonIrAndFileCheck(*scaled_dot_computation,\n-                                         /*block_level_parameters=*/\n-                                         {\n-                                             {{1, 16, 16}},\n-                                             4,\n-                                             1,\n-                                             1,\n-                                             false,\n-                                         },\n-                                         kExpectedTritonIr),\n+  EXPECT_THAT(CreateTritonIrAndFileCheckForDot(*scaled_dot_computation,\n+                                               kExpectedTritonIr),\n               absl_testing::IsOk());\n \n   EXPECT_TRUE(RunAndCompareNoHloPasses(\n@@ -5177,16 +5159,8 @@ ENTRY e {\n       CHECK: tensor<128x16xf8E4M3FN>, tensor<16x4xi8>\n       CHECK: -> tensor<16x16xf32>\n   )\";\n-  EXPECT_THAT(CreateTritonIrAndFileCheck(*scaled_dot_computation,\n-                                         /*block_level_parameters=*/\n-                                         {\n-                                             {{1, 16, 16}},\n-                                             4,\n-                                             1,\n-                                             1,\n-                                             false,\n-                                         },\n-                                         kExpectedTritonIr),\n+  EXPECT_THAT(CreateTritonIrAndFileCheckForDot(*scaled_dot_computation,\n+                                               kExpectedTritonIr),\n               absl_testing::IsOk());\n \n   EXPECT_TRUE(RunAndCompareNoHloPasses("
        }
    ],
    "stats": {
        "total": 56,
        "additions": 15,
        "deletions": 41
    }
}