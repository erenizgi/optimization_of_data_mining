{
    "author": "ZixuanJiang",
    "message": "Refactor shardy_xla_pass.\n\nRemove unused code.\n\nPiperOrigin-RevId: 820872613",
    "sha": "1a142dab0a183993660ef066792dec4f1be916b6",
    "files": [
        {
            "sha": "ac957b3b95a7f2eb8389d8076280cf80db0f03a3",
            "filename": "third_party/xla/xla/service/spmd/shardy/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2FBUILD?ref=1a142dab0a183993660ef066792dec4f1be916b6",
            "patch": "@@ -61,6 +61,7 @@ cc_library(\n         \"@llvm-project//mlir:Support\",\n         \"@local_tsl//tsl/platform:path\",\n         \"@shardy//shardy/common:file_utils\",\n+        \"@shardy//shardy/dialect/sdy/transforms/common:propagation_options\",\n         \"@shardy//shardy/dialect/sdy/transforms/propagation:passes\",\n     ],\n )\n@@ -121,7 +122,6 @@ xla_cc_test(\n         \"//xla/hlo/utils:hlo_matchers\",\n         \"//xla/service:computation_layout\",\n         \"//xla/tsl/platform:statusor\",\n-        \"@com_google_absl//absl/log\",\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "91fec537d9a971aea466ec56d6762915b79e8182",
            "filename": "third_party/xla/xla/service/spmd/shardy/shardy_xla_pass.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.cc?ref=1a142dab0a183993660ef066792dec4f1be916b6",
            "patch": "@@ -42,6 +42,7 @@ limitations under the License.\n #include \"mlir/Pass/PassManager.h\"\n #include \"mlir/Support/LLVM.h\"\n #include \"shardy/common/file_utils.h\"\n+#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n #include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n #include \"re2/re2.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n@@ -367,10 +368,8 @@ absl::Status runShardingPropagation(HloModule* hloModule,\n \n     addStablehloImportPipeline(\n         pm,\n-        /* allowPropagationToArgs=*/\n         spanToArrayRef(hloModule->config()\n                            .allow_spmd_sharding_propagation_to_parameters()),\n-        /*allowPropagationToResults=*/\n         spanToArrayRef(\n             hloModule->config().allow_spmd_sharding_propagation_to_output()),\n         /*importFuncCalls=*/true);"
        },
        {
            "sha": "ece691ec4b6c4916b7144c82452e671787f6c5e2",
            "filename": "third_party/xla/xla/service/spmd/shardy/shardy_xla_pass.h",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass.h?ref=1a142dab0a183993660ef066792dec4f1be916b6",
            "patch": "@@ -19,7 +19,7 @@ limitations under the License.\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n-#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/pass/hlo_pass_interface.h\"\n \n@@ -45,10 +45,6 @@ class ShardyXLA : public xla::HloModulePass {\n       xla::HloModule* hloModule,\n       const absl::flat_hash_set<absl::string_view>& executionThreads) override;\n \n-  void setRunSdyShardingPropagation(bool runSdyShardingPropagation) {\n-    this->runSdyShardingPropagation = runSdyShardingPropagation;\n-  }\n-\n  private:\n   bool runSdyShardingPropagation;\n   mlir::sdy::PropagationOptions defaultOptions;"
        },
        {
            "sha": "9e2c4d2fe9401f4e91c69d12c89fcfec26b53ef5",
            "filename": "third_party/xla/xla/service/spmd/shardy/shardy_xla_pass_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a142dab0a183993660ef066792dec4f1be916b6/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fshardy_xla_pass_test.cc?ref=1a142dab0a183993660ef066792dec4f1be916b6",
            "patch": "@@ -20,7 +20,6 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n-#include \"absl/log/log.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n@@ -53,12 +52,7 @@ void runShardy(VerifiedHloModule* module, bool stablehloImport,\n   }\n   TF_ASSERT_OK_AND_ASSIGN(bool changed,\n                           ShardyXLA(runSdyShardingPropagation).Run(module));\n-  VLOG(1) << module->ToString();\n-  if (expectChanged) {\n-    EXPECT_TRUE(changed);\n-  } else {\n-    EXPECT_FALSE(changed);\n-  }\n+  EXPECT_EQ(changed, expectChanged);\n }\n \n void runShardyWithStablehloImport(VerifiedHloModule* module,\n@@ -924,8 +918,6 @@ TEST_F(ShardyXLATest, TestRunShardingPropagationFalseUseTuplesTrue) {\n                           ParseAndReturnVerifiedModule(hloString));\n   runShardyWithStablehloImport(module.get(),\n                                /*runSdyShardingPropagation=*/false);\n-  LOG(INFO) << module->ToString(\n-      HloPrintOptions{}.set_include_layout_in_shapes(false));\n   EXPECT_TRUE(*RunFileCheck(\n       module->ToString(HloPrintOptions{}.set_include_layout_in_shapes(false)),\n       expected));\n@@ -955,8 +947,6 @@ ENTRY %main.0 (Arg_0.0: s64[2]) -> s64[2] {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<VerifiedHloModule> module,\n                           ParseAndReturnVerifiedModule(hloString));\n   runShardyWithSdyImport(module.get());\n-  LOG(INFO) << module->ToString(\n-      HloPrintOptions{}.set_include_layout_in_shapes(false));\n   EXPECT_TRUE(*RunFileCheck(\n       module->ToString(HloPrintOptions{}.set_include_layout_in_shapes(false)),\n       expected));"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 4,
        "deletions": 19
    }
}