{
    "author": "subhamsoni-google",
    "message": "Add session_id support to ProfilerSessionWrapper and ExportToTensorBoard.\n\nPiperOrigin-RevId: 839805430",
    "sha": "50ec49e2bca7a757cc704ce56ef6b10591096de3",
    "files": [
        {
            "sha": "7b141248168629afb1d14cbe34da93095812c529",
            "filename": "third_party/xla/xla/python/profiler.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/50ec49e2bca7a757cc704ce56ef6b10591096de3/third_party%2Fxla%2Fxla%2Fpython%2Fprofiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/50ec49e2bca7a757cc704ce56ef6b10591096de3/third_party%2Fxla%2Fxla%2Fpython%2Fprofiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fprofiler.cc?ref=50ec49e2bca7a757cc704ce56ef6b10591096de3",
            "patch": "@@ -122,7 +122,12 @@ struct ProfilerSessionWrapper {\n   explicit ProfilerSessionWrapper(std::unique_ptr<tsl::ProfilerSession> session)\n       : session(std::move(session)) {}\n \n+  ProfilerSessionWrapper(std::unique_ptr<tsl::ProfilerSession> session,\n+                         std::string session_id)\n+      : session(std::move(session)), session_id(std::move(session_id)) {}\n+\n   std::unique_ptr<tsl::ProfilerSession> session;\n+  std::string session_id;\n };\n \n static std::string GetFdoProfile(const std::string& xspace,\n@@ -172,17 +177,23 @@ NB_MODULE(_profiler, m) {\n       .def(\"__init__\",\n            [](ProfilerSessionWrapper* wrapper,\n               const tensorflow::ProfileOptions& options) {\n-             new (wrapper)\n-                 ProfilerSessionWrapper(tsl::ProfilerSession::Create(options));\n+             new (wrapper) ProfilerSessionWrapper(\n+                 tsl::ProfilerSession::Create(options), options.session_id());\n            })\n       .def(\n           \"stop_and_export\",\n           [](ProfilerSessionWrapper* sess, const std::string& tensorboard_dir) {\n             tensorflow::profiler::XSpace xspace;\n             // Disables the ProfilerSession\n             xla::ThrowIfError(sess->session->CollectData(&xspace));\n-            xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n-                xspace, tensorboard_dir, /* also_export_trace_json= */ true));\n+            if (sess->session_id.empty()) {\n+              xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n+                  xspace, tensorboard_dir, /* also_export_trace_json= */ true));\n+            } else {\n+              xla::ThrowIfError(tsl::profiler::ExportToTensorBoard(\n+                  xspace, tensorboard_dir, sess->session_id,\n+                  /* also_export_trace_json= */ true));\n+            }\n           },\n           nb::call_guard<nb::gil_scoped_release>())\n       .def(\"stop\",\n@@ -275,7 +286,10 @@ NB_MODULE(_profiler, m) {\n           \"repository_path\", &tensorflow::ProfileOptions::repository_path,\n           [](tensorflow::ProfileOptions* options, const std::string& path) {\n             options->set_repository_path(path);\n-          });\n+          })\n+      .def_prop_rw(\"session_id\", &tensorflow::ProfileOptions::session_id,\n+                   [](tensorflow::ProfileOptions* options,\n+                      const std::string& id) { options->set_session_id(id); });\n \n   nb::class_<TraceMeWrapper> traceme_class(m, \"TraceMe\");\n   traceme_class.def(nb::init<nb::str, nb::kwargs>())"
        },
        {
            "sha": "9a2cd27e288e6588fc490e3bf779eed19df37e82",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/client/capture_profile.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/50ec49e2bca7a757cc704ce56ef6b10591096de3/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fcapture_profile.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/50ec49e2bca7a757cc704ce56ef6b10591096de3/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fcapture_profile.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fcapture_profile.cc?ref=50ec49e2bca7a757cc704ce56ef6b10591096de3",
            "patch": "@@ -258,10 +258,10 @@ absl::Status Monitor(const std::string& service_addr, int duration_ms,\n \n absl::Status ExportToTensorBoard(const XSpace& xspace,\n                                  const std::string& logdir,\n+                                 const std::string& run,\n                                  bool also_export_trace_json) {\n   std::string repository_root =\n       tsl::profiler::GetTensorBoardProfilePluginDir(logdir);\n-  std::string run = tsl::profiler::GetCurrentTimeStampAsString();\n   std::string host = tsl::port::Hostname();\n   TF_RETURN_IF_ERROR(\n       tsl::profiler::SaveXSpace(repository_root, run, host, xspace));\n@@ -275,6 +275,14 @@ absl::Status ExportToTensorBoard(const XSpace& xspace,\n   return absl::OkStatus();\n }\n \n+absl::Status ExportToTensorBoard(const XSpace& xspace,\n+                                 const std::string& logdir,\n+                                 bool also_export_trace_json) {\n+  return ExportToTensorBoard(xspace, logdir,\n+                             tsl::profiler::GetCurrentTimeStampAsString(),\n+                             also_export_trace_json);\n+}\n+\n absl::Status CaptureRemoteTrace(\n     const char* service_addr, const char* logdir, const char* worker_list,\n     bool include_dataset_ops, int duration_ms, int num_tracing_attempts,"
        },
        {
            "sha": "c1f6564fc5ad4f94bab0ccf9a062f189460c9864",
            "filename": "third_party/xla/xla/tsl/profiler/rpc/client/capture_profile.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/50ec49e2bca7a757cc704ce56ef6b10591096de3/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fcapture_profile.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/50ec49e2bca7a757cc704ce56ef6b10591096de3/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fcapture_profile.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Frpc%2Fclient%2Fcapture_profile.h?ref=50ec49e2bca7a757cc704ce56ef6b10591096de3",
            "patch": "@@ -34,6 +34,12 @@ absl::Status ExportToTensorBoard(const tensorflow::profiler::XSpace& xspace,\n                                  const std::string& logdir,\n                                  bool also_export_trace_json = false);\n \n+// The run is the directory which contains the xplane.pb files.\n+absl::Status ExportToTensorBoard(const tensorflow::profiler::XSpace& xspace,\n+                                 const std::string& logdir,\n+                                 const std::string& run,\n+                                 bool also_export_trace_json = false);\n+\n // Collects one sample of monitoring profile and shows user-friendly metrics.\n // If timestamp flag is true, timestamp will be displayed in \"%H:%M:%S\" format.\n absl::Status Monitor(const std::string& service_addr, int duration_ms,"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 34,
        "deletions": 6
    }
}