{
    "author": "protobird-git",
    "message": "Add an option for mmap allocation with MAP_PRIVATE & PROT_WRITE\n\nPiperOrigin-RevId: 809264177",
    "sha": "8758d85967245d8c099b8153a8941aea9b7e8bdb",
    "files": [
        {
            "sha": "e2c22a2bbeea9b5d134f89f73bbc570acafb443c",
            "filename": "tensorflow/compiler/mlir/lite/allocation.h",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fallocation.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fallocation.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fallocation.h?ref=8758d85967245d8c099b8153a8941aea9b7e8bdb",
            "patch": "@@ -64,24 +64,34 @@ class Allocation {\n class MMAPAllocation : public Allocation {\n  public:\n   /// Loads and maps the provided file to a memory region.\n-  MMAPAllocation(const char* filename, ErrorReporter* error_reporter);\n+  /// If map_private is true, the mapping is private and writeable. Otherwise,\n+  /// the mapping is shared and read-only.\n+  MMAPAllocation(const char* filename, ErrorReporter* error_reporter,\n+                 bool map_private = false);\n \n   /// Loads and maps the provided file to a memory region at the given\n-  // offset and length (both in bytes).\n+  /// offset and length (both in bytes).\n+  /// If map_private is true, the mapping is private and writeable. Otherwise,\n+  /// the mapping is shared and read-only.\n   MMAPAllocation(const char* filename, size_t offset, size_t length,\n-                 ErrorReporter* error_reporter);\n+                 ErrorReporter* error_reporter, bool map_private = false);\n \n   /// Maps the provided file descriptor to a memory region.\n+  /// If map_private is true, the mapping is private and writeable. Otherwise,\n+  /// the mapping is shared and read-only.\n   /// Note: The provided file descriptor will be dup'ed for usage; the caller\n   /// retains ownership of the provided descriptor and should close accordingly.\n-  MMAPAllocation(int fd, ErrorReporter* error_reporter);\n+  MMAPAllocation(int fd, ErrorReporter* error_reporter,\n+                 bool map_private = false);\n \n   /// Maps the provided file descriptor, with the given offset and length (both\n   /// in bytes), to a memory region.\n+  /// If map_private is true, the mapping is private and writeable. Otherwise,\n+  /// the mapping is shared and read-only.\n   /// Note: The provided file descriptor will be dup'ed for usage; the caller\n   /// retains ownership of the provided descriptor and should close accordingly.\n   MMAPAllocation(int fd, size_t offset, size_t length,\n-                 ErrorReporter* error_reporter);\n+                 ErrorReporter* error_reporter, bool map_private = false);\n \n   ~MMAPAllocation() override;\n   const void* base() const override;\n@@ -115,12 +125,12 @@ class MMAPAllocation : public Allocation {\n \n  private:\n   // Assumes ownership of the provided `owned_fd` instance.\n-  MMAPAllocation(ErrorReporter* error_reporter, int owned_fd);\n+  MMAPAllocation(ErrorReporter* error_reporter, int owned_fd, bool map_private);\n \n   // Assumes ownership of the provided `owned_fd` instance, and uses the given\n   // offset and length (both in bytes) for memory mapping.\n   MMAPAllocation(ErrorReporter* error_reporter, int owned_fd, size_t offset,\n-                 size_t length);\n+                 size_t length, bool map_private);\n };\n \n class FileCopyAllocation : public Allocation {"
        },
        {
            "sha": "1999d947867bcd5d544f7c4d6e1c228267d2e9cc",
            "filename": "tensorflow/compiler/mlir/lite/core/model_builder_base.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fcore%2Fmodel_builder_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fcore%2Fmodel_builder_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fcore%2Fmodel_builder_base.cc?ref=8758d85967245d8c099b8153a8941aea9b7e8bdb",
            "patch": "@@ -28,11 +28,13 @@ namespace tflite {\n #ifndef TFLITE_MCU\n // Loads a model from `filename`. If `mmap_file` is true then use mmap,\n // otherwise make a copy of the model in a buffer.\n-std::unique_ptr<Allocation> GetAllocationFromFile(\n-    const char* filename, ErrorReporter* error_reporter) {\n+std::unique_ptr<Allocation> GetAllocationFromFile(const char* filename,\n+                                                  ErrorReporter* error_reporter,\n+                                                  bool allow_modifications) {\n   std::unique_ptr<Allocation> allocation;\n   if (MMAPAllocation::IsSupported()) {\n-    allocation = std::make_unique<MMAPAllocation>(filename, error_reporter);\n+    allocation = std::make_unique<MMAPAllocation>(filename, error_reporter,\n+                                                  allow_modifications);\n   } else {\n     allocation = std::make_unique<FileCopyAllocation>(filename, error_reporter);\n   }\n@@ -41,11 +43,13 @@ std::unique_ptr<Allocation> GetAllocationFromFile(\n \n // Loads a model from `fd`. If `mmap_file` is true then use mmap,\n // otherwise make a copy of the model in a buffer.\n-std::unique_ptr<Allocation> GetAllocationFromFile(\n-    int fd, ErrorReporter* error_reporter) {\n+std::unique_ptr<Allocation> GetAllocationFromFile(int fd,\n+                                                  ErrorReporter* error_reporter,\n+                                                  bool allow_modifications) {\n   std::unique_ptr<Allocation> allocation;\n   if (MMAPAllocation::IsSupported()) {\n-    allocation = std::make_unique<MMAPAllocation>(fd, error_reporter);\n+    allocation = std::make_unique<MMAPAllocation>(fd, error_reporter,\n+                                                  allow_modifications);\n   } else {\n     allocation = std::make_unique<FileCopyAllocation>(\n         absl::StrCat(\"/proc/self/fd/\", fd).c_str(), error_reporter);"
        },
        {
            "sha": "b6aac0faefbe71f40827e1b59c23c861a0be9e6d",
            "filename": "tensorflow/compiler/mlir/lite/core/model_builder_base.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fcore%2Fmodel_builder_base.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fcore%2Fmodel_builder_base.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fcore%2Fmodel_builder_base.h?ref=8758d85967245d8c099b8153a8941aea9b7e8bdb",
            "patch": "@@ -49,10 +49,11 @@ limitations under the License.\n namespace tflite {\n \n std::unique_ptr<Allocation> GetAllocationFromFile(\n-    const char* filename, ErrorReporter* error_reporter);\n+    const char* filename, ErrorReporter* error_reporter,\n+    bool allow_modifications = false);\n \n std::unique_ptr<Allocation> GetAllocationFromFile(\n-    int fd, ErrorReporter* error_reporter);\n+    int fd, ErrorReporter* error_reporter, bool allow_modifications = false);\n \n namespace impl {\n "
        },
        {
            "sha": "c555666b251d45696fc05c88683d8b7961974696",
            "filename": "tensorflow/compiler/mlir/lite/mmap_allocation.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 14,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fmmap_allocation.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fmmap_allocation.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fmmap_allocation.cc?ref=8758d85967245d8c099b8153a8941aea9b7e8bdb",
            "patch": "@@ -43,44 +43,48 @@ size_t GetFdSizeBytes(int fd) {\n }  // namespace\n \n MMAPAllocation::MMAPAllocation(const char* filename,\n-                               ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, open(filename, O_RDONLY)) {\n+                               ErrorReporter* error_reporter, bool map_private)\n+    : MMAPAllocation(error_reporter, open(filename, O_RDONLY), map_private) {\n   if (mmap_fd_ == -1) {\n     TF_LITE_REPORT_ERROR(error_reporter, \"Could not open '%s'.\", filename);\n   }\n }\n \n-MMAPAllocation::MMAPAllocation(int fd, ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, dup(fd)) {\n+MMAPAllocation::MMAPAllocation(int fd, ErrorReporter* error_reporter,\n+                               bool map_private)\n+    : MMAPAllocation(error_reporter, dup(fd), map_private) {\n   if (mmap_fd_ == -1) {\n     TF_LITE_REPORT_ERROR(error_reporter, \"Failed to dup '%d' file descriptor.\",\n                          fd);\n   }\n }\n \n MMAPAllocation::MMAPAllocation(const char* filename, size_t offset,\n-                               size_t length, ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, open(filename, O_RDONLY), offset, length) {\n+                               size_t length, ErrorReporter* error_reporter,\n+                               bool map_private)\n+    : MMAPAllocation(error_reporter, open(filename, O_RDONLY), offset, length,\n+                     map_private) {\n   if (mmap_fd_ == -1) {\n     TF_LITE_REPORT_ERROR(error_reporter, \"Could not open '%s'.\", filename);\n   }\n }\n \n MMAPAllocation::MMAPAllocation(int fd, size_t offset, size_t length,\n-                               ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, dup(fd), offset, length) {\n+                               ErrorReporter* error_reporter, bool map_private)\n+    : MMAPAllocation(error_reporter, dup(fd), offset, length, map_private) {\n   if (mmap_fd_ == -1) {\n     TF_LITE_REPORT_ERROR(error_reporter, \"Failed to dup '%d' file descriptor.\",\n                          fd);\n   }\n }\n \n-MMAPAllocation::MMAPAllocation(ErrorReporter* error_reporter, int owned_fd)\n+MMAPAllocation::MMAPAllocation(ErrorReporter* error_reporter, int owned_fd,\n+                               bool map_private)\n     : MMAPAllocation(error_reporter, owned_fd, /*offset=*/0,\n-                     /*length=*/GetFdSizeBytes(owned_fd)) {}\n+                     /*length=*/GetFdSizeBytes(owned_fd), map_private) {}\n \n MMAPAllocation::MMAPAllocation(ErrorReporter* error_reporter, int owned_fd,\n-                               size_t offset, size_t length)\n+                               size_t offset, size_t length, bool map_private)\n     : Allocation(error_reporter, Allocation::Type::kMMap),\n       mmap_fd_(owned_fd),\n       mmapped_buffer_(MAP_FAILED),\n@@ -103,9 +107,10 @@ MMAPAllocation::MMAPAllocation(ErrorReporter* error_reporter, int owned_fd,\n     return;\n   }\n \n-  mmapped_buffer_ =\n-      mmap(nullptr, /*__len=*/length + offset_in_buffer_, PROT_READ, MAP_SHARED,\n-           mmap_fd_, /*__offset=*/offset - offset_in_buffer_);\n+  mmapped_buffer_ = mmap(nullptr, /*__len=*/length + offset_in_buffer_,\n+                         map_private ? (PROT_READ | PROT_WRITE) : PROT_READ,\n+                         map_private ? MAP_PRIVATE : MAP_SHARED, mmap_fd_,\n+                         /*__offset=*/offset_of_buffer_in_file_);\n   if (mmapped_buffer_ == MAP_FAILED) {\n     TF_LITE_REPORT_ERROR(error_reporter,\n                          \"Mmap of '%d' at offset '%d' failed with error '%d'.\","
        },
        {
            "sha": "480cd240d527a1983b0f38929e83aaf3c43f9837",
            "filename": "tensorflow/compiler/mlir/lite/mmap_allocation_disabled.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fmmap_allocation_disabled.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8758d85967245d8c099b8153a8941aea9b7e8bdb/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fmmap_allocation_disabled.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fmmap_allocation_disabled.cc?ref=8758d85967245d8c099b8153a8941aea9b7e8bdb",
            "patch": "@@ -20,21 +20,24 @@ limitations under the License.\n namespace tflite {\n \n MMAPAllocation::MMAPAllocation(const char* filename,\n-                               ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, -1) {}\n+                               ErrorReporter* error_reporter, bool map_private)\n+    : MMAPAllocation(error_reporter, -1, map_private) {}\n \n-MMAPAllocation::MMAPAllocation(int fd, ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, -1) {}\n+MMAPAllocation::MMAPAllocation(int fd, ErrorReporter* error_reporter,\n+                               bool map_private)\n+    : MMAPAllocation(error_reporter, -1, map_private) {}\n \n MMAPAllocation::MMAPAllocation(int fd, size_t offset, size_t length,\n-                               ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, -1) {}\n+                               ErrorReporter* error_reporter, bool map_private)\n+    : MMAPAllocation(error_reporter, -1, map_private) {}\n \n MMAPAllocation::MMAPAllocation(const char* filename, size_t offset,\n-                               size_t length, ErrorReporter* error_reporter)\n-    : MMAPAllocation(error_reporter, -1) {}\n+                               size_t length, ErrorReporter* error_reporter,\n+                               bool map_private)\n+    : MMAPAllocation(error_reporter, -1, map_private) {}\n \n-MMAPAllocation::MMAPAllocation(ErrorReporter* error_reporter, int owned_fd)\n+MMAPAllocation::MMAPAllocation(ErrorReporter* error_reporter, int owned_fd,\n+                               bool map_private)\n     : Allocation(error_reporter, Allocation::Type::kMMap),\n       mmapped_buffer_(nullptr) {\n   // The disabled variant should never be created."
        }
    ],
    "stats": {
        "total": 99,
        "additions": 61,
        "deletions": 38
    }
}