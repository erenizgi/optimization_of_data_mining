{
    "author": "tensorflower-gardener",
    "message": "Allow IFRT-proxy to expand error-status payloads that are specific to Pathways.\n\nPiperOrigin-RevId: 826656416",
    "sha": "15e235f79b007952c16a2e1dee83d5bdabe613da",
    "files": [
        {
            "sha": "ddadc0af788536ac94f068a00abeb716451cde66",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -1153,7 +1153,11 @@ cc_library(\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/base:no_destructor\",\n         \"@com_google_absl//absl/base:nullability\",\n+        \"@com_google_absl//absl/container:btree\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/synchronization\",\n     ],\n )\n@@ -1194,6 +1198,7 @@ cc_library(\n         \"@com_google_absl//absl/strings:cord\",\n         \"@com_google_absl//absl/strings:string_view\",\n     ],\n+    alwayslink = True,\n )\n \n cc_library("
        },
        {
            "sha": "6d19f6424c20986fd8bceb60b93accea2898ee0e",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.cc?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -15,12 +15,18 @@ limitations under the License.\n \n #include \"xla/python/ifrt/user_context_registry.h\"\n \n+#include <limits>\n #include <memory>\n+#include <optional>\n+#include <string>\n #include <utility>\n #include <vector>\n \n #include \"absl/base/no_destructor.h\"\n #include \"absl/base/nullability.h\"\n+#include \"absl/log/check.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"xla/python/ifrt/user_context.h\"\n \n@@ -97,5 +103,27 @@ void UserContextRegistry::Unregister(\n   }\n }\n \n+CustomStatusExpanderRegistry& CustomStatusExpanderRegistry::Get() {\n+  static absl::NoDestructor<CustomStatusExpanderRegistry> registry;\n+  return *registry;\n+}\n+\n+void CustomStatusExpanderRegistry::Register(absl::string_view payload_name,\n+                                            PayloadExpanderFn expander,\n+                                            std::optional<int> process_order) {\n+  absl::WriterMutexLock lock(mu_);\n+  std::pair<int, std::string> key = {\n+      process_order.value_or(std::numeric_limits<int>::max()),\n+      std::string(payload_name)};\n+  CHECK(registry_.insert({std::move(key), std::move(expander)}).second);\n+}\n+\n+void CustomStatusExpanderRegistry::Process(absl::Status& status) {\n+  absl::ReaderMutexLock lock(mu_);\n+  for (const auto& [_, expander] : registry_) {\n+    expander(status);\n+  }\n+}\n+\n }  // namespace ifrt\n }  // namespace xla"
        },
        {
            "sha": "acff474af6dc9781cf91c692aee8b4fc70618cd1",
            "filename": "third_party/xla/xla/python/ifrt/user_context_registry.h",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_registry.h?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -16,13 +16,19 @@ limitations under the License.\n #ifndef XLA_PYTHON_IFRT_USER_CONTEXT_REGISTRY_H_\n #define XLA_PYTHON_IFRT_USER_CONTEXT_REGISTRY_H_\n \n+#include <functional>\n #include <memory>\n+#include <optional>\n+#include <string>\n #include <utility>\n #include <vector>\n \n #include \"absl/base/nullability.h\"\n #include \"absl/base/thread_annotations.h\"\n+#include \"absl/container/btree_map.h\"\n #include \"absl/container/flat_hash_map.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"xla/python/ifrt/user_context.h\"\n \n@@ -122,6 +128,36 @@ class TrackedUserContext {\n   absl_nonnull const UserContextRef user_context_;\n };\n \n+// CustomStatusExpanderRegistry allows registering 'payload expanders' that\n+// errors returned by the IFRT backend are processed through before the error\n+// message is returned to IFRT users.\n+class CustomStatusExpanderRegistry {\n+ public:\n+  static CustomStatusExpanderRegistry& Get();\n+\n+  using PayloadExpanderFn = std::function<void(absl::Status&)>;\n+  // Registers a payload expander. `expander` is expected to take the entire\n+  // `absl::Status` object, remove the payload from the object, and modify the\n+  // contents of the `absl::Status` accordingly.\n+  //\n+  // The optional `process_order`, if supplied, determines the order in which\n+  // the expander is processed in relation to other expanders. Expanders with\n+  // lower process orders are processed first; please use a positive value\n+  // unless you have discussed with IFRT maintainers about writing a\n+  // a critical expander function that needs to be processed earlier. Order\n+  // among expanders of the same `process_order` is unspecified.\n+  void Register(absl::string_view payload_name, PayloadExpanderFn expander,\n+                std::optional<int> process_order = std::nullopt);\n+\n+  // Invokes all registered expanders on the given status.\n+  void Process(absl::Status& status);\n+\n+ private:\n+  mutable absl::Mutex mu_;\n+  absl::btree_map<std::pair<int, std::string>, PayloadExpanderFn> registry_\n+      ABSL_GUARDED_BY(mu_);\n+};\n+\n }  // namespace ifrt\n }  // namespace xla\n "
        },
        {
            "sha": "1a7722feae2a02b56d5ea4c458d63f7609ffd55d",
            "filename": "third_party/xla/xla/python/ifrt/user_context_status_util.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_status_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_status_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fuser_context_status_util.cc?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -100,14 +100,15 @@ absl::Status ReattachUserContextRefs(absl::Status status) {\n   return status;\n }\n \n-absl::Status ExpandUserContexts(absl::Status status) {\n+static void ExpandStandardUserContext(absl::Status& status) {\n   if (status.ok()) {\n-    return status;\n+    return;\n   }\n+\n   std::optional<absl::Cord> payload =\n       status.GetPayload(kIfrtUserContextPayloadUrl);\n   if (!payload.has_value()) {\n-    return status;\n+    return;\n   }\n \n   status.ErasePayload(kIfrtUserContextPayloadUrl);\n@@ -117,20 +118,31 @@ absl::Status ExpandUserContexts(absl::Status status) {\n     tsl::errors::AppendToMessage(\n         &status, \"\\n(failed to parse a user context ID: \", payload->Flatten(),\n         \")\");\n-    return status;\n+    return;\n   }\n   TrackedUserContextRef user_context =\n       UserContextRegistry::Get().Lookup(UserContextId(user_context_id));\n   if (user_context == nullptr) {\n     tsl::errors::AppendToMessage(\n         &status, \"\\n(failed to find a user context for ID: \", user_context_id,\n         \")\");\n-    return status;\n+    return;\n   }\n   tsl::errors::AppendToMessage(&status, \"\\n\",\n                                user_context->user_context()->DebugString());\n+}\n+\n+absl::Status ExpandUserContexts(absl::Status status) {\n+  CustomStatusExpanderRegistry::Get().Process(status);\n   return status;\n }\n \n+static const bool register_standard_user_context = []() {\n+  xla::ifrt::CustomStatusExpanderRegistry::Get().Register(\n+      kIfrtUserContextPayloadUrl, ExpandStandardUserContext,\n+      /*process_order=*/-1);\n+  return true;\n+}();\n+\n }  // namespace ifrt\n }  // namespace xla"
        },
        {
            "sha": "10149e1d4644c5bd49327448a5d7d11b40eb8739",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -174,6 +174,7 @@ cc_library(\n         \"//xla/python/ifrt_proxy/common:ifrt_service_proto_cc\",\n         \"//xla/python/ifrt_proxy/common:types\",\n         \"//xla/python/ifrt_proxy/common:versions\",\n+        \"//xla/python/ifrt_proxy/contrib/pathways:status_annotator_util\",  # build_cleaner: keep\n         \"//xla/python/pjrt_ifrt:pjrt_attribute_map_util\",\n         \"//xla/tsl/concurrency:future\",\n         \"//xla/tsl/concurrency:ref_count\","
        },
        {
            "sha": "0cba5d467ad172a77807a293edf6a9922f12d6cf",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/BUILD",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2FBUILD?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -0,0 +1,65 @@\n+# Copyright 2025 The OpenXLA Authors.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+load(\"//xla/python/ifrt_proxy/common:ifrt_proxy.bzl\", \"cc_library\", \"default_ifrt_proxy_visibility\", \"ifrt_proxy_cc_test\")\n+load(\"//xla/tsl/platform:build_config.bzl\", \"tf_proto_library\")\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = default_ifrt_proxy_visibility,\n+)\n+\n+cc_library(\n+    name = \"status_annotator_util\",\n+    srcs = [\"status_annotator_util.cc\"],\n+    hdrs = [\"status_annotator_util.h\"],\n+    deps = [\n+        \":status_annotator_proto_cc\",\n+        \"//xla/python/ifrt:user_context\",\n+        \"//xla/python/ifrt:user_context_registry\",\n+        \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:status_to_from_proto\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:cord\",\n+        \"@com_google_absl//absl/strings:str_format\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_absl//absl/time\",\n+    ],\n+    alwayslink = 1,\n+)\n+\n+ifrt_proxy_cc_test(\n+    name = \"status_annotator_util_test\",\n+    srcs = [\"status_annotator_util_test.cc\"],\n+    deps = [\n+        \":status_annotator_proto_cc\",\n+        \":status_annotator_util\",\n+        \"//xla/python/ifrt:test_util\",\n+        \"//xla/python/ifrt:user_context_registry\",\n+        \"//xla/python/ifrt:user_context_status_util\",\n+        \"//xla/tsl/platform:status_to_from_proto\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n+tf_proto_library(\n+    name = \"status_annotator_proto\",\n+    srcs = [\"status_annotator.proto\"],\n+    visibility = default_ifrt_proxy_visibility,\n+    deps = [\"//xla/tsl/protobuf:status_proto\"],\n+)"
        },
        {
            "sha": "8e978c3f2a6f5aa93929b0f26a205583ea810923",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator.proto",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator.proto?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -0,0 +1,49 @@\n+// Copyright 2025 The OpenXLA Authors.\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+edition = \"2023\";\n+\n+package ifrt_proxy_contrib_pathways;\n+\n+import \"xla/tsl/protobuf/status.proto\";\n+\n+option java_multiple_files = true;\n+\n+// Summarizes a Pathways worker-side ObjectStore in a way relevant to users\n+// debugging an HBM OOM.\n+message ObjectStoreDumpProto {\n+  // TODO(b/456800998): Rename 'ErrorContext' to 'UserContext'.\n+  message PerErrorContext {\n+    message PerCreator {\n+      string creator = 1;  // The kind of operation that created this object.\n+\n+      // Count and size of all objects whose `GetReadyFuture().ready()` is true.\n+      uint64 ready_obj_count = 2;\n+      uint64 ready_total_size = 3;\n+\n+      // Count and size of objects whose `GetReadyFuture().ready()` is false.\n+      uint64 not_ready_obj_count = 4;\n+      uint64 not_ready_total_size = 5;\n+    }\n+    uint64 error_context_id = 1;\n+    repeated PerCreator per_creator = 2;\n+  }\n+\n+  string device = 1;\n+  fixed64 dump_timestamp_ns = 2;\n+\n+  // One of 'dump_failed' or 'per_error_context' is filled.\n+  tensorflow.StatusProto dump_failed = 3;\n+  repeated PerErrorContext per_error_context = 4;\n+}"
        },
        {
            "sha": "e42ceb2d0d953fa56558f14122e546569ee265ad",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.cc",
            "status": "added",
            "additions": 118,
            "deletions": 0,
            "changes": 118,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.cc?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -0,0 +1,118 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.h\"\n+\n+#include <memory>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+#include \"absl/log/check.h\"\n+#include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/strings/cord.h\"\n+#include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_format.h\"\n+#include \"absl/strings/str_replace.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"absl/time/time.h\"\n+#include \"xla/python/ifrt/user_context.h\"\n+#include \"xla/python/ifrt/user_context_registry.h\"\n+#include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator.pb.h\"\n+#include \"xla/tsl/platform/errors.h\"\n+#include \"xla/tsl/platform/status_to_from_proto.h\"\n+\n+namespace ifrt_proxy_contrib_pathways {\n+\n+static constexpr absl::string_view kObjectStoreDumpPayloadUrl =\n+    \"type.googleapis.com/ifrt_proxy_contrib_pathways.ObjectStoreDumpProto\";\n+\n+static void ExpandObjectStoreDump(absl::Status& status) {\n+  std::optional<absl::Cord> payload =\n+      status.GetPayload(kObjectStoreDumpPayloadUrl);\n+  if (!payload.has_value()) {\n+    return;\n+  }\n+  ObjectStoreDumpProto object_store_dump;\n+  if (!object_store_dump.ParseFromString(payload->Flatten())) {\n+    LOG(WARNING) << \"Unable to expand string to ObjectStoreDumpProto: \"\n+                 << payload->Flatten();\n+    tsl::errors::AppendToMessage(\n+        &status,\n+        \"\\nWARNING: Unable to parse attached payload string to \"\n+        \"ObjectStoreDumpProto. Please see logs for the actual payload string.\");\n+    return;\n+  }\n+  status.ErasePayload(kObjectStoreDumpPayloadUrl);\n+\n+  std::string header = absl::StrCat(\n+      \"Pathways object-store summary for device \", object_store_dump.device(),\n+      \" at \", absl::FromUnixNanos(object_store_dump.dump_timestamp_ns()));\n+  absl::Status error = tsl::StatusFromProto(object_store_dump.dump_failed());\n+  if (!error.ok()) {\n+    tsl::errors::AppendToMessage(\n+        &status, \"\\n\", header, \" got error while dumping: \", error.ToString());\n+    return;\n+  }\n+\n+  std::vector<std::string> cited_traces;\n+  tsl::errors::AppendToMessage(&status, \"\\n\", header, \":\");\n+  for (const auto& per_error_context : object_store_dump.per_error_context()) {\n+    xla::ifrt::TrackedUserContextRef tracked_user_context =\n+        xla::ifrt::UserContextRegistry::Get().Lookup(\n+            xla::ifrt::UserContextId(per_error_context.error_context_id()));\n+    if (tracked_user_context != nullptr) {\n+      std::string trace = tracked_user_context->user_context()->DebugString();\n+      absl::StrReplaceAll({{\"\\n\", \"\\t\"}}, &trace);\n+      absl::StrReplaceAll({{\"\\t\", \"\\n                \"}}, &trace);\n+      cited_traces.push_back(trace);\n+      tsl::errors::AppendToMessage(\n+          &status, \"  - The following entries arise from user stack [\",\n+          cited_traces.size(), \"]:\");\n+    } else {\n+      tsl::errors::AppendToMessage(\n+          &status,\n+          \"  - The following entries arise from an unknown user stack:\");\n+    }\n+    for (const auto& per_creator : per_error_context.per_creator()) {\n+      tsl::errors::AppendToMessage(&status, \"      + \", per_creator.creator(),\n+                                   \" with \", per_creator.ready_obj_count(),\n+                                   \" 'ready' buffers of total size \",\n+                                   per_creator.ready_total_size(), \" and \",\n+                                   per_creator.not_ready_obj_count(),\n+                                   \" 'not ready' buffers of total size \",\n+                                   per_creator.not_ready_total_size());\n+    }\n+  }\n+  for (int i = 0; i < cited_traces.size(); ++i) {\n+    tsl::errors::AppendToMessage(\n+        &status, absl::StrFormat(\"[%3d]   %s\", i + 1, cited_traces[i]));\n+  }\n+}\n+\n+void AnnotateIfrtUserStatusWithObjectStoreDump(\n+    absl::Status& status, const ObjectStoreDumpProto& object_store_dump) {\n+  status.SetPayload(kObjectStoreDumpPayloadUrl,\n+                    object_store_dump.SerializeAsCord());\n+}\n+\n+static const bool register_expanders = []() {\n+  xla::ifrt::CustomStatusExpanderRegistry::Get().Register(\n+      kObjectStoreDumpPayloadUrl, ExpandObjectStoreDump);\n+  return true;\n+}();\n+\n+}  // namespace ifrt_proxy_contrib_pathways"
        },
        {
            "sha": "ca1f0a64d9be43d19f44592c1b7c7bb69c680fe4",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.h",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util.h?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -0,0 +1,30 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PYTHON_IFRT_PROXY_CONTRIB_PATHWAYS_STATUS_ANNOTATOR_UTIL_H_\n+#define XLA_PYTHON_IFRT_PROXY_CONTRIB_PATHWAYS_STATUS_ANNOTATOR_UTIL_H_\n+\n+#include \"absl/status/status.h\"\n+#include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator.pb.h\"\n+\n+namespace ifrt_proxy_contrib_pathways {\n+\n+// Attaches the given `object_store_dump` to the given `status` as a payload.\n+void AnnotateIfrtUserStatusWithObjectStoreDump(\n+    absl::Status& status, const ObjectStoreDumpProto& object_store_dump);\n+\n+}  // namespace ifrt_proxy_contrib_pathways\n+\n+#endif  // XLA_PYTHON_IFRT_PROXY_CONTRIB_PATHWAYS_STATUS_ANNOTATOR_UTIL_H_"
        },
        {
            "sha": "708b638debeb9806379ab39c950d8fc2a7bd1e9d",
            "filename": "third_party/xla/xla/python/ifrt_proxy/contrib/pathways/status_annotator_util_test.cc",
            "status": "added",
            "additions": 108,
            "deletions": 0,
            "changes": 108,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/15e235f79b007952c16a2e1dee83d5bdabe613da/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcontrib%2Fpathways%2Fstatus_annotator_util_test.cc?ref=15e235f79b007952c16a2e1dee83d5bdabe613da",
            "patch": "@@ -0,0 +1,108 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator_util.h\"\n+\n+#include <string>\n+#include <vector>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/status/status.h\"\n+#include \"absl/strings/str_cat.h\"\n+#include \"xla/python/ifrt/test_util.h\"\n+#include \"xla/python/ifrt/user_context_registry.h\"\n+#include \"xla/python/ifrt/user_context_status_util.h\"\n+#include \"xla/python/ifrt_proxy/contrib/pathways/status_annotator.pb.h\"\n+#include \"xla/tsl/platform/status_to_from_proto.h\"\n+\n+namespace ifrt_proxy_contrib_pathways {\n+namespace {\n+\n+using ::testing::HasSubstr;\n+\n+TEST(StatusAnnotatorUtilTest, SimpleAnnotateAndExpand) {\n+  ObjectStoreDumpProto object_store_dump;\n+  object_store_dump.set_device(\"tpu:0\");\n+\n+  absl::Status status = absl::InternalError(\"test error\");\n+  AnnotateIfrtUserStatusWithObjectStoreDump(status, object_store_dump);\n+\n+  EXPECT_THAT(xla::ifrt::ExpandUserContexts(status).message(),\n+              HasSubstr(\"tpu:0\"));\n+}\n+\n+TEST(StatusAnnotatorUtilTest, ExpandFailedDump) {\n+  ObjectStoreDumpProto object_store_dump;\n+  *object_store_dump.mutable_dump_failed() =\n+      tsl::StatusToProto(absl::InternalError(\"dump failed\"));\n+  object_store_dump.set_device(\"tpu:0\");\n+\n+  absl::Status status = absl::InternalError(\"test error\");\n+  AnnotateIfrtUserStatusWithObjectStoreDump(status, object_store_dump);\n+\n+  EXPECT_THAT(xla::ifrt::ExpandUserContexts(status).message(),\n+              HasSubstr(\"tpu:0\"));\n+  EXPECT_THAT(xla::ifrt::ExpandUserContexts(status).message(),\n+              HasSubstr(\"dump failed\"));\n+}\n+\n+TEST(StatusAnnotatorUtilTest, DumpWithManyContentsExpandsToAllDetails) {\n+  ObjectStoreDumpProto object_store_dump;\n+  object_store_dump.set_device(\"tpu:0\");\n+\n+  std::vector<xla::ifrt::TrackedUserContextRef> user_context_refs;\n+\n+  for (int context : {1000, 2000, 3000}) {\n+    user_context_refs.push_back(xla::ifrt::UserContextRegistry::Get().Register(\n+        xla::ifrt::test_util::MakeUserContext(context)));\n+\n+    auto* per_error_context = object_store_dump.add_per_error_context();\n+    per_error_context->set_error_context_id(context);\n+\n+    for (int creator : {100, 200}) {\n+      auto* per_creator = per_error_context->add_per_creator();\n+      *per_creator->mutable_creator() = absl::StrCat(\"creator\", creator);\n+      per_creator->set_ready_obj_count(context + creator + 1);\n+      per_creator->set_ready_total_size(context + creator + 2);\n+      per_creator->set_not_ready_obj_count(context + creator + 3);\n+      per_creator->set_not_ready_total_size(context + creator + 4);\n+    }\n+  }\n+\n+  absl::Status status = absl::InternalError(\"test error\");\n+  AnnotateIfrtUserStatusWithObjectStoreDump(status, object_store_dump);\n+\n+  std::string expanded(xla::ifrt::ExpandUserContexts(status).message());\n+\n+  for (int context : {1000, 2000, 3000}) {\n+    EXPECT_THAT(expanded,\n+                HasSubstr(absl::StrCat(\"TestUserContext(\", context, \")\")));\n+    for (int creator : {100, 200}) {\n+      EXPECT_THAT(expanded, HasSubstr(absl::StrCat(\"creator\", creator)));\n+      EXPECT_THAT(expanded,\n+                  HasSubstr(absl::StrCat(context + creator + 1,\n+                                         \" 'ready' buffers of total size \",\n+                                         context + creator + 2)));\n+      EXPECT_THAT(expanded,\n+                  HasSubstr(absl::StrCat(context + creator + 3,\n+                                         \" 'not ready' buffers of total size \",\n+                                         context + creator + 4)));\n+    }\n+  }\n+}\n+\n+}  // namespace\n+}  // namespace ifrt_proxy_contrib_pathways"
        }
    ],
    "stats": {
        "total": 462,
        "additions": 457,
        "deletions": 5
    }
}