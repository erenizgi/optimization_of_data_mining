{
    "author": "nvgrw",
    "message": "Migrate pad_test to use PjRt.\n\nPiperOrigin-RevId: 824545233",
    "sha": "7257c66fae0711c0cc00c9a3e9db0fcc4a503685",
    "files": [
        {
            "sha": "6d6bbb5287a7a1950d140aad3172b13c4f22d7a6",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7257c66fae0711c0cc00c9a3e9db0fcc4a503685/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7257c66fae0711c0cc00c9a3e9db0fcc4a503685/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=7257c66fae0711c0cc00c9a3e9db0fcc4a503685",
            "patch": "@@ -2335,13 +2335,18 @@ xla_test(\n xla_test(\n     name = \"pad_test\",\n     srcs = [\"pad_test.cc\"],\n+    tags = [\"test_migrated_to_hlo_runner_pjrt\"],\n     deps = [\n-        \":client_library_test_base\",\n-        \":xla_internal_test_main\",\n+        \":client_library_test_runner_mixin\",\n+        \":hlo_pjrt_interpreter_reference_mixin\",\n+        \":hlo_pjrt_test_base\",\n+        \":xla_internal_test_main\",  # fixdeps: keep\n+        \"//xla:array\",\n         \"//xla:array2d\",\n         \"//xla:array3d\",\n         \"//xla:array4d\",\n         \"//xla:error_spec\",\n+        \"//xla:literal\",\n         \"//xla:literal_util\",\n         \"//xla:reference_util\",\n         \"//xla:shape_util\",\n@@ -2350,7 +2355,8 @@ xla_test(\n         \"//xla/hlo/builder:xla_builder\",\n         \"//xla/hlo/builder:xla_computation\",\n         \"//xla/hlo/builder/lib:arithmetic\",\n-        \"@local_tsl//tsl/platform:test\",\n+        \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/types:span\",\n     ],\n )\n "
        },
        {
            "sha": "33a11a0df5e3491d05e66b582e08f6a086a749c8",
            "filename": "third_party/xla/xla/tests/pad_test.cc",
            "status": "modified",
            "additions": 81,
            "deletions": 27,
            "changes": 108,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7257c66fae0711c0cc00c9a3e9db0fcc4a503685/third_party%2Fxla%2Fxla%2Ftests%2Fpad_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7257c66fae0711c0cc00c9a3e9db0fcc4a503685/third_party%2Fxla%2Fxla%2Ftests%2Fpad_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fpad_test.cc?ref=7257c66fae0711c0cc00c9a3e9db0fcc4a503685",
            "patch": "@@ -16,8 +16,11 @@ limitations under the License.\n #include <array>\n #include <cstdint>\n #include <memory>\n+#include <utility>\n #include <vector>\n \n+#include \"absl/types/span.h\"\n+#include \"xla/array.h\"\n #include \"xla/array2d.h\"\n #include \"xla/array3d.h\"\n #include \"xla/array4d.h\"\n@@ -27,20 +30,26 @@ limitations under the License.\n #include \"xla/hlo/builder/xla_computation.h\"\n #include \"xla/layout.h\"\n #include \"xla/layout_util.h\"\n+#include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/reference_util.h\"\n-#include \"xla/tests/client_library_test_base.h\"\n+#include \"xla/tests/client_library_test_runner_mixin.h\"\n+#include \"xla/tests/hlo_pjrt_interpreter_reference_mixin.h\"\n+#include \"xla/tests/hlo_pjrt_test_base.h\"\n+#include \"xla/tsl/platform/test.h\"\n #include \"xla/util.h\"\n #include \"xla/xla_data.pb.h\"\n-#include \"tsl/platform/test.h\"\n \n namespace xla {\n namespace {\n \n-static std::array<PrimitiveType, 4> test_type_params{F32, BF16, F8E5M2,\n-                                                     F8E4M3FN};\n+constexpr std::array<PrimitiveType, 4> test_type_params{F32, BF16, F8E5M2,\n+                                                        F8E4M3FN};\n \n-class PadTest : public ClientLibraryTestBase {\n+constexpr ErrorSpec kErrorSpec(1e-5, 1e-5);\n+\n+class PadTest : public ClientLibraryTestRunnerMixin<\n+                    HloPjRtInterpreterReferenceMixin<HloPjRtTestBase>> {\n  protected:\n   PadTest() {\n     // Initializes the padding configuration used for R4 tests.\n@@ -64,16 +73,50 @@ class PadTest : public ClientLibraryTestBase {\n     dimension3->set_interior_padding(0);\n   }\n \n+  void TearDown() override {\n+    ASSERT_FALSE(!params_were_used_ && !params_.empty())\n+        << \"AddParam() was used to add parameters, but those parameters were \"\n+           \"never used for execution. Please remove the AddParam() calls or \"\n+           \"ensure that you call AddParamArgumentPointers().\";\n+  }\n+\n+  // Convenience function to help us port tests from ClientLibraryTestBase.\n+  // Usually AddParam should be replaced with Parameter() and an appropriate\n+  // literal, but there are too many of these in this test.\n+  XlaOp AddParam(Literal literal, XlaBuilder* builder) {\n+    Literal converted_literal = MaybeConvertLiteralToTestType(literal);\n+    const Shape shape = converted_literal.shape();\n+    params_.push_back(std::move(converted_literal));\n+    return Parameter(builder, params_.size() - 1, shape, \"\");\n+  }\n+\n+  template <class T>\n+  XlaOp AddParam(const Array<T>& argument, XlaBuilder* builder) {\n+    return AddParam(LiteralUtil::CreateFromArray(argument), builder);\n+  }\n+\n+  std::vector<const Literal*> AddParamArgumentPointers() {\n+    params_were_used_ = true;\n+    std::vector<const Literal*> ptrs;\n+    ptrs.reserve(params_.size());\n+    for (const Literal& param : params_) {\n+      ptrs.push_back(&param);\n+    }\n+    return ptrs;\n+  }\n+\n   // Padding configuration for R4 that only pads dimension 0 and 1.\n   PaddingConfig r4_padding_on_dim0_dim1_;\n+\n+ private:\n+  std::vector<Literal> params_;\n+  bool params_were_used_ = false;\n };\n \n class PadTestFloat : public PadTest,\n                      public ::testing::WithParamInterface<PrimitiveType> {\n  protected:\n   PadTestFloat() { set_float_type(GetParam()); }\n-\n-  ErrorSpec DefaultErrorSpec() const { return ErrorSpec(1e-5, 1e-5); }\n };\n \n // Tests a Pad() with a zero-element input and output.\n@@ -88,7 +131,7 @@ TEST_P(PadTestFloat, Pad1DS0ToS0Array) {\n \n   Pad(AddParam(LiteralUtil::CreateR1<float>({}), &b),\n       AddParam(LiteralUtil::CreateR0<float>(0.1), &b), padding_config);\n-  ComputeAndCompareR1<float>(&b, {}, {}, DefaultErrorSpec());\n+  ComputeAndCompareR1<float>(&b, {}, AddParamArgumentPointers(), kErrorSpec);\n }\n \n // Tests a Pad() with a zero-element input but a non-zero-element output.\n@@ -103,8 +146,8 @@ TEST_P(PadTestFloat, Pad1DS0ToS5Array) {\n \n   Pad(AddParam(LiteralUtil::CreateR1<float>({}), &b),\n       AddParam(LiteralUtil::CreateR0<float>(0.1), &b), padding_config);\n-  ComputeAndCompareR1<float>(&b, std::vector<float>(5, 0.1), {},\n-                             DefaultErrorSpec());\n+  ComputeAndCompareR1<float>(&b, std::vector<float>(5, 0.1),\n+                             AddParamArgumentPointers(), kErrorSpec);\n }\n \n TEST_P(PadTestFloat, Pad1DS3Array) {\n@@ -119,16 +162,17 @@ TEST_P(PadTestFloat, Pad1DS3Array) {\n   Pad(AddParam(LiteralUtil::CreateR1<float>({1, 2, 3}), &b),\n       AddParam(LiteralUtil::CreateR0<float>(0.1), &b), padding_config);\n   std::vector<float> expected({0.1, 0.1, 0.1, 1, 0.1, 2, 0.1, 3});\n-  ComputeAndCompareR1<float>(&b, expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR1<float>(&b, expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n TEST_P(PadTestFloat, Pad4D_2x0x3x2_FloatArray) {\n   XlaBuilder b(TestName());\n   Pad(AddParam(Array4D<float>(2, 0, 3, 2), &b),\n       AddParam(LiteralUtil::CreateR0<float>(1.5), &b),\n       r4_padding_on_dim0_dim1_);\n-  ComputeAndCompareR4<float>(&b, Array4D<float>(5, 2, 3, 2, 1.5f), {},\n-                             DefaultErrorSpec());\n+  ComputeAndCompareR4<float>(&b, Array4D<float>(5, 2, 3, 2, 1.5f),\n+                             AddParamArgumentPointers(), kErrorSpec);\n }\n \n TEST_P(PadTestFloat, Pad4DFloat_1x1x3x2_Array) {\n@@ -152,7 +196,8 @@ TEST_P(PadTestFloat, Pad4DFloat_1x1x3x2_Array) {\n   (*expected)(1, 0, 1, 1) = 4.0f;\n   (*expected)(1, 0, 2, 0) = 5.0f;\n   (*expected)(1, 0, 2, 1) = 6.0f;\n-  ComputeAndCompareR4<float>(&b, *expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR4<float>(&b, *expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n TEST_P(PadTestFloat, Pad4DFloatArrayWithInteriorPadding) {\n@@ -172,7 +217,8 @@ TEST_P(PadTestFloat, Pad4DFloatArrayWithInteriorPadding) {\n   (*expected)(4, 2, 0, 0) = 4.0f;\n   (*expected)(7, 0, 0, 0) = 5.0f;\n   (*expected)(7, 2, 0, 0) = 6.0f;\n-  ComputeAndCompareR4<float>(&b, *expected, {}, ErrorSpec(0.0001));\n+  ComputeAndCompareR4<float>(&b, *expected, AddParamArgumentPointers(),\n+                             ErrorSpec(0.0001));\n }\n \n TEST_P(PadTestFloat, Pad4DFloatArrayMinorFirstSmall) {\n@@ -203,7 +249,7 @@ TEST_P(PadTestFloat, Pad4DFloatArrayMinorFirstSmall) {\n   auto input = LiteralUtil::CreateR4FromArray4D<float>(input_array);\n   input = input.Relayout(layout);\n \n-  Pad(AddParam(input, &b),\n+  Pad(AddParam(std::move(input), &b),\n       AddParam(LiteralUtil::CreateR0<float>(pad_value), &b), padding_config);\n \n   Array4D<float> expected_array(1, 1, 5, 8);\n@@ -214,7 +260,8 @@ TEST_P(PadTestFloat, Pad4DFloatArrayMinorFirstSmall) {\n   expected_array(0, 0, 3, 2) = 4.0f;\n   expected_array(0, 0, 3, 3) = 5.0f;\n   expected_array(0, 0, 3, 4) = 6.0f;\n-  ComputeAndCompareR4<float>(&b, expected_array, {}, ErrorSpec(0.0001));\n+  ComputeAndCompareR4<float>(&b, expected_array, AddParamArgumentPointers(),\n+                             ErrorSpec(0.0001));\n }\n \n TEST_P(PadTestFloat, Pad4DFloatArrayMinorFirstNonTrivialMinorDimensions) {\n@@ -249,15 +296,16 @@ TEST_P(PadTestFloat, Pad4DFloatArrayMinorFirstNonTrivialMinorDimensions) {\n   auto input = LiteralUtil::CreateR4FromArray4D<float>(input_array);\n   input = input.Relayout(layout);\n \n-  Pad(AddParam(input, &b),\n+  Pad(AddParam(std::move(input), &b),\n       AddParam(LiteralUtil::CreateR0<float>(pad_value), &b), padding_config);\n \n   Array4D<float> expected_array(1, 25, 17, 11);\n   expected_array.Fill(pad_value);\n   expected_array(0, 0, 2, 2) = 1.0f;\n   expected_array(0, 24, 14, 8) = 2.0f;\n   expected_array(0, 17, 6, 7) = 3.0f;\n-  ComputeAndCompareR4<float>(&b, expected_array, {}, ErrorSpec(0.0001));\n+  ComputeAndCompareR4<float>(&b, expected_array, AddParamArgumentPointers(),\n+                             ErrorSpec(0.0001));\n }\n \n TEST_F(PadTest, Pad4DU8Array) {\n@@ -281,7 +329,7 @@ TEST_F(PadTest, Pad4DU8Array) {\n   (*expected)(1, 0, 1, 1) = 4;\n   (*expected)(1, 0, 2, 0) = 5;\n   (*expected)(1, 0, 2, 1) = 6;\n-  ComputeAndCompareR4<uint8_t>(&b, *expected, {});\n+  ComputeAndCompareR4<uint8_t>(&b, *expected, AddParamArgumentPointers());\n }\n \n TEST_F(PadTest, Pad4DPredArray) {\n@@ -308,7 +356,7 @@ TEST_F(PadTest, Pad4DPredArray) {\n   (*expected)(1, 0, 1, 1) = 1;\n   (*expected)(1, 0, 2, 0) = 1;\n   (*expected)(1, 0, 2, 1) = 1;\n-  ComputeAndCompareR4<int32_t>(&b, *expected, {});\n+  ComputeAndCompareR4<int32_t>(&b, *expected, AddParamArgumentPointers());\n }\n \n TEST_P(PadTestFloat, Large2DPad) {\n@@ -327,7 +375,8 @@ TEST_P(PadTestFloat, Large2DPad) {\n   Pad(input, AddParam(LiteralUtil::CreateR0<float>(0.0f), &b), padding_config);\n \n   auto expected = ReferenceUtil::PadArray2D(*ones, padding_config, 0.0f);\n-  ComputeAndCompareR2<float>(&b, *expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR2<float>(&b, *expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n TEST_P(PadTestFloat, AllTypes2DPad) {\n@@ -349,7 +398,8 @@ TEST_P(PadTestFloat, AllTypes2DPad) {\n   Pad(input, AddParam(LiteralUtil::CreateR0<float>(3.14f), &b), padding_config);\n \n   auto expected = ReferenceUtil::PadArray2D(*operand, padding_config, 3.14f);\n-  ComputeAndCompareR2<float>(&b, *expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR2<float>(&b, *expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n TEST_P(PadTestFloat, High2DPad) {\n@@ -376,7 +426,8 @@ TEST_P(PadTestFloat, High2DPad) {\n \n   auto expected = ReferenceUtil::PadArray2D(*operand, padding_config, 2.718f);\n \n-  ComputeAndCompareR2<float>(&b, *expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR2<float>(&b, *expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n TEST_P(PadTestFloat, NegativePadding2D) {\n@@ -404,7 +455,8 @@ TEST_P(PadTestFloat, NegativePadding2D) {\n \n   auto expected = ReferenceUtil::PadArray2D(*operand, padding_config, 2.718f);\n \n-  ComputeAndCompareR2<float>(&b, *expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR2<float>(&b, *expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n TEST_P(PadTestFloat, NegativeAndInteriorPadding2D) {\n@@ -432,7 +484,8 @@ TEST_P(PadTestFloat, NegativeAndInteriorPadding2D) {\n \n   auto expected = ReferenceUtil::PadArray2D(*operand, padding_config, 2.718f);\n \n-  ComputeAndCompareR2<float>(&b, *expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR2<float>(&b, *expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n // Regression test for b/31827337.\n@@ -455,7 +508,8 @@ TEST_P(PadTestFloat, ReducePad) {\n                            {{2.0, 2.0}, {2.0, 2.0}},\n                            {{2.0, 2.0}, {2.0, 2.0}},\n                            {{0.0, 0.0}, {0.0, 0.0}}});\n-  ComputeAndCompareR3<float>(&b, expected, {}, DefaultErrorSpec());\n+  ComputeAndCompareR3<float>(&b, expected, AddParamArgumentPointers(),\n+                             kErrorSpec);\n }\n \n INSTANTIATE_TEST_CASE_P(PadTestFloatInstantiation, PadTestFloat,"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 90,
        "deletions": 30
    }
}