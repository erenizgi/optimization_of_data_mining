{
    "author": "tensorflower-gardener",
    "message": "Use hostcallback for h2d\n\nPiperOrigin-RevId: 819459051",
    "sha": "95340a0066d8801b62894f62d1e55d2a649efab0",
    "files": [
        {
            "sha": "1b112a19e5cbc0c24259ab58709ed05e7a6b71e3",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_async_host_to_device_transfer_manager.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/95340a0066d8801b62894f62d1e55d2a649efab0/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_async_host_to_device_transfer_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/95340a0066d8801b62894f62d1e55d2a649efab0/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_async_host_to_device_transfer_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_async_host_to_device_transfer_manager.cc?ref=95340a0066d8801b62894f62d1e55d2a649efab0",
            "patch": "@@ -235,11 +235,7 @@ absl::Status TfrtGpuAsyncHostToDeviceTransferManager::TransferLiteralToBuffer(\n     TF_CHECK_OK(transfer_manager->TransferLiteralToDeviceAsync(stream, literal,\n                                                                shaped_buffer));\n \n-    absl::Status status;\n-    {\n-      tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-      status = stream->BlockHostUntilDone();\n-    }\n+    absl::Status status = BlockHostUntilDoneWithHostCallback(stream);\n     VLOG(3) << \"Finish transfer h2d for literal with shape \"\n             << literal.shape().ToString() << \" on device \"\n             << device_->DebugString() << \" with status \" << status;"
        },
        {
            "sha": "a3c0359df3b3a378923243d4444d9baf1528dadd",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/utils.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/95340a0066d8801b62894f62d1e55d2a649efab0/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/95340a0066d8801b62894f62d1e55d2a649efab0/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc?ref=95340a0066d8801b62894f62d1e55d2a649efab0",
            "patch": "@@ -41,6 +41,7 @@ limitations under the License.\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n+#include \"absl/synchronization/notification.h\"\n #include \"absl/time/time.h\"\n #include \"absl/types/span.h\"\n #include \"unsupported/Eigen/CXX11/Tensor\"\n@@ -957,4 +958,19 @@ GetLatestIncarnations(\n   return device_incarnations;\n }\n \n+absl::Status BlockHostUntilDoneWithHostCallback(se::Stream* stream) {\n+  absl::Notification event;\n+\n+  tsl::profiler::TraceMe traceme(\"BlockHostUntilDoneWithHostCallback\");\n+  auto status = stream->DoHostCallback([&event]() {\n+    tsl::profiler::TraceMe traceme(\n+        \"BlockHostUntilDoneWithHostCallback::Callback\");\n+    event.Notify();\n+  });\n+\n+  event.WaitForNotification();\n+\n+  return status;\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "77f23cf2fc0ed2b332a73289cf24b22b7257c88b",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/utils.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/95340a0066d8801b62894f62d1e55d2a649efab0/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/95340a0066d8801b62894f62d1e55d2a649efab0/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.h?ref=95340a0066d8801b62894f62d1e55d2a649efab0",
            "patch": "@@ -184,6 +184,8 @@ GetLatestIncarnations(\n     absl::Span<PjRtDevice* const> devices,\n     const absl::flat_hash_map<int, IncarnationId>& incarnations);\n \n+absl::Status BlockHostUntilDoneWithHostCallback(se::Stream* stream);\n+\n }  // namespace xla\n \n #endif  // XLA_PJRT_GPU_TFRT_UTILS_H_"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 19,
        "deletions": 5
    }
}