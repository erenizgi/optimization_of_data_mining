{
    "author": "sergachev",
    "message": "PR #33205: [GPU] Fix reduce-precision simplification.\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33205\n\nüìù Summary of Changes\nThe simplification was unintentionally disabled in\nhttps://github.com/openxla/xla/commit/2accf052cb7964224c46745682aecdb8cedabb43.\n\nüéØ Justification\nBug fix.\n\nüöÄ Kind of Contribution\nüêõ Bug Fix, ‚ö°Ô∏è Performance Improvement\n\nüìä Benchmark (for Performance Improvements)\nNo\n\nüß™ Unit Tests:\nYes.\n\nüß™ Execution Tests:\nNo.\nCopybara import of the project:\n\n--\n2fb682c10ff49212044dd995ba97aa329e52bb71 by Ilia Sergachev <isergachev@nvidia.com>:\n\n[GPU] Fix reduce-precision simplification.\n\nWas unintentionally disabled in\nhttps://github.com/openxla/xla/commit/2accf052cb7964224c46745682aecdb8cedabb43.\n\nMerging this change closes #33205\n\nPiperOrigin-RevId: 825449067",
    "sha": "2e53225273285868d33d19d9316bde2c037ea8a8",
    "files": [
        {
            "sha": "44cdb0899e8e533325a491d87ed2223c419cd9ac",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e53225273285868d33d19d9316bde2c037ea8a8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e53225273285868d33d19d9316bde2c037ea8a8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=2e53225273285868d33d19d9316bde2c037ea8a8",
            "patch": "@@ -563,8 +563,8 @@ GpuCompiler::GpuCompiler(se::Platform::Id platform_id,\n \n namespace {\n // Adds the HloVerifier for GPU to the given pipeline.\n-void AddHloVerifier(HloPassPipeline* pipeline,\n-                    HloVerifierOpts&& opts = {}, bool debug_only = false) {\n+void AddHloVerifier(HloPassPipeline* pipeline, HloVerifierOpts&& opts = {},\n+                    bool debug_only = false) {\n   opts.verify_no_collective_deadlocks = true;\n   std::unique_ptr<TargetVerifierMetadata> verifier_metadata =\n       std::make_unique<CpuGpuVerifierMetadata>(std::move(opts));\n@@ -1477,6 +1477,7 @@ AlgebraicSimplifierOptions GpuCompiler::GetAlgebraicSimplifierOptions(\n   }\n \n   switch (mode) {\n+    case AlgebraicSimplifierMode::kAfterSimplifyFPConversions:\n     case AlgebraicSimplifierMode::kPostFusionSimplification:\n     case AlgebraicSimplifierMode::kLayoutNormalization:\n     case AlgebraicSimplifierMode::kPostLayoutAssignment:\n@@ -1934,7 +1935,7 @@ absl::Status GpuCompiler::OptimizeHloPostLayoutAssignment(\n         pipeline.AddPass<HloPassPipeline>(\n             \"remove-no-op-reduce-precision-algebraic-simplifier\");\n     AlgebraicSimplifierOptions options = GetAlgebraicSimplifierOptions(\n-        AlgebraicSimplifierMode::kPostFusionSimplification, debug_options,\n+        AlgebraicSimplifierMode::kAfterSimplifyFPConversions, debug_options,\n         gpu_target_config.platform_name == \"ROCM\");\n     remove_no_op_reduce_precision_pipeline\n         .AddPass<HloPassFix<GpuAlgebraicSimplifier>>(options, gpu_version);"
        },
        {
            "sha": "98d842092eed0f2d1a93e3d48ed2754c52af8d9b",
            "filename": "third_party/xla/xla/service/gpu/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e53225273285868d33d19d9316bde2c037ea8a8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e53225273285868d33d19d9316bde2c037ea8a8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2FBUILD?ref=2e53225273285868d33d19d9316bde2c037ea8a8",
            "patch": "@@ -627,6 +627,7 @@ lit_test_suite_for_gpus(\n             \"offload_scan_output.hlo\",\n             \"pad_to_static.hlo\",\n             \"reduce_fold_zero_add.hlo\",\n+            \"reduce-precision.hlo\",\n             \"rng_get_and_update_state.hlo\",\n             \"single_instruction.hlo\",\n             \"slice_to_dynamic.hlo\","
        },
        {
            "sha": "94752f8871c81eb41bea2a56716d97f0940ca7b3",
            "filename": "third_party/xla/xla/service/gpu/tests/reduce-precision.hlo",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e53225273285868d33d19d9316bde2c037ea8a8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Freduce-precision.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e53225273285868d33d19d9316bde2c037ea8a8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Freduce-precision.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Freduce-precision.hlo?ref=2e53225273285868d33d19d9316bde2c037ea8a8",
            "patch": "@@ -0,0 +1,8 @@\n+// RUN: hlo-opt %s --platform=gpu --xla_gpu_target_config_filename=%S/../../../tools/hlo_opt/gpu_specs/%{GPU}.txtpb | FileCheck  %s\n+\n+e {\n+  a = bf16[] parameter(0)\n+  b = bf16[] reduce-precision(a), exponent_bits=8, mantissa_bits=7\n+}\n+\n+// CHECK-NOT: reduce-precision"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 13,
        "deletions": 3
    }
}