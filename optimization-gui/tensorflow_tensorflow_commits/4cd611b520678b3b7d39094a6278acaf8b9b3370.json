{
    "author": "krishnaharidasan",
    "message": "Add ForEach method to IFRT AttributeMap\n\nPiperOrigin-RevId: 841969101",
    "sha": "4cd611b520678b3b7d39094a6278acaf8b9b3370",
    "files": [
        {
            "sha": "c411c99ab65d9c00ae8e2d365b00f59ccb5693cb",
            "filename": "third_party/xla/xla/python/ifrt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2FBUILD?ref=4cd611b520678b3b7d39094a6278acaf8b9b3370",
            "patch": "@@ -160,11 +160,11 @@ cc_library(\n         \":serdes_version\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n+        \"@com_google_absl//absl/functional:function_ref\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n-        \"@com_google_absl//absl/types:span\",\n     ],\n )\n "
        },
        {
            "sha": "e53be413eb1c4ad20a5733d9bab690bb2d1affb5",
            "filename": "third_party/xla/xla/python/ifrt/attribute_map.h",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map.h?ref=4cd611b520678b3b7d39094a6278acaf8b9b3370",
            "patch": "@@ -26,11 +26,10 @@ limitations under the License.\n \n #include \"absl/base/attributes.h\"\n #include \"absl/container/flat_hash_map.h\"\n+#include \"absl/functional/function_ref.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_cat.h\"\n-#include \"absl/strings/string_view.h\"\n-#include \"absl/types/span.h\"\n #include \"xla/python/ifrt/attribute_map.pb.h\"\n #include \"xla/python/ifrt/serdes_default_version_accessor.h\"\n #include \"xla/python/ifrt/serdes_version.h\"\n@@ -141,6 +140,20 @@ class AttributeMap {\n \n   bool IsEmpty() const { return map_.empty(); }\n \n+  // Invokes `f` for each key-value pair in the attribute map.\n+  void ForEach(\n+      absl::FunctionRef<void(const std::string&, const Value&)> f) const {\n+    for (const auto& [key, value] : map_) {\n+      f(key, value);\n+    }\n+  }\n+\n+  bool operator==(const AttributeMap& other) const {\n+    return map_ == other.map_;\n+  }\n+\n+  size_t size() const { return map_.size(); }\n+\n  private:\n   template <typename T, typename V>\n   absl::StatusOr<T> Get(const std::string& key) const {"
        },
        {
            "sha": "c658838e2af1c3a84c38607a5f63549ac8bb26cf",
            "filename": "third_party/xla/xla/python/ifrt/attribute_map_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fattribute_map_test.cc?ref=4cd611b520678b3b7d39094a6278acaf8b9b3370",
            "patch": "@@ -45,14 +45,14 @@ TEST(AttributeMapTest, MapElements) {\n       {\"float\", AttributeMap::FloatValue(1.23f)},\n   });\n \n-  EXPECT_EQ(map.map(), AttributeMap::Map({\n-                           {\"string\", AttributeMap::StringValue(\"value\")},\n-                           {\"bool\", AttributeMap::BoolValue(true)},\n-                           {\"int64\", AttributeMap::Int64Value(123)},\n-                           {\"int64_list\", AttributeMap::Int64ListValue(\n-                                              {int64_t{1}, int64_t{2}})},\n-                           {\"float\", AttributeMap::FloatValue(1.23f)},\n-                       }))\n+  EXPECT_EQ(map, AttributeMap({\n+                     {\"string\", AttributeMap::StringValue(\"value\")},\n+                     {\"bool\", AttributeMap::BoolValue(true)},\n+                     {\"int64\", AttributeMap::Int64Value(123)},\n+                     {\"int64_list\",\n+                      AttributeMap::Int64ListValue({int64_t{1}, int64_t{2}})},\n+                     {\"float\", AttributeMap::FloatValue(1.23f)},\n+                 }))\n       << map.DebugString();\n }\n \n@@ -101,7 +101,7 @@ TEST_P(AttributeMapSerDesTest, ToFromProto) {\n \n   TF_ASSERT_OK_AND_ASSIGN(auto map_copy,\n                           AttributeMap::FromProto(map.ToProto(version())));\n-  EXPECT_EQ(map_copy.map(), map.map()) << map_copy.DebugString();\n+  EXPECT_EQ(map_copy, map) << map_copy.DebugString();\n }\n \n INSTANTIATE_TEST_SUITE_P("
        },
        {
            "sha": "a28a1cfa8cf4812fc1bf69402b126140c010a122",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_attribute_map_util.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_attribute_map_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_attribute_map_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_attribute_map_util.cc?ref=4cd611b520678b3b7d39094a6278acaf8b9b3370",
            "patch": "@@ -59,12 +59,12 @@ AttributeMap FromPjRtAttributeMap(\n absl::flat_hash_map<std::string, xla::PjRtValueType> ToPjRtAttributeMap(\n     AttributeMap attributes) {\n   absl::flat_hash_map<std::string, xla::PjRtValueType> result;\n-  result.reserve(attributes.map().size());\n-  for (auto& item : attributes.map()) {\n+  result.reserve(attributes.size());\n+  attributes.ForEach([&](const std::string& key,\n+                         const AttributeMap::Value& value) {\n     std::visit(\n         [&](auto& value) {\n           using T = std::decay_t<decltype(value)>;\n-          const auto& key = item.first;\n           if constexpr (std::is_same_v<T, AttributeMap::StringValue>) {\n             result.insert({key, std::move(value.value)});\n           } else if constexpr (std::is_same_v<T, AttributeMap::BoolValue>) {\n@@ -78,8 +78,8 @@ absl::flat_hash_map<std::string, xla::PjRtValueType> ToPjRtAttributeMap(\n             result.insert({key, value.value});\n           }\n         },\n-        item.second);\n-  }\n+        value);\n+  });\n   return result;\n }\n "
        },
        {
            "sha": "dd8742d16610adb74a7fee03a397ab4ac464c496",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_attribute_map_util_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_attribute_map_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_attribute_map_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_attribute_map_util_test.cc?ref=4cd611b520678b3b7d39094a6278acaf8b9b3370",
            "patch": "@@ -38,8 +38,8 @@ TEST(PjRtAttributeMapUtilTest, FromPjRtAttributeMap) {\n       {\"float\", xla::PjRtValueType(1.23f)},\n   });\n \n-  EXPECT_EQ(FromPjRtAttributeMap(pjrt_map).map(),\n-            AttributeMap::Map({\n+  EXPECT_EQ(FromPjRtAttributeMap(pjrt_map),\n+            AttributeMap({\n                 {\"string\", AttributeMap::StringValue(\"value\")},\n                 {\"bool\", AttributeMap::BoolValue(true)},\n                 {\"int64\", AttributeMap::Int64Value(123)},"
        },
        {
            "sha": "5400791747827921a9330b0b3e997826e647fa56",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/xla_executable_impl_test_lib.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_impl_test_lib.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4cd611b520678b3b7d39094a6278acaf8b9b3370/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_impl_test_lib.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fxla_executable_impl_test_lib.cc?ref=4cd611b520678b3b7d39094a6278acaf8b9b3370",
            "patch": "@@ -294,7 +294,7 @@ TEST_P(LoadedExecutableImplTest, Analysis) {\n \n   TF_ASSERT_OK_AND_ASSIGN(const auto cost_analysis,\n                           executable->GetCostAnalysis());\n-  EXPECT_THAT(cost_analysis.map(), Not(IsEmpty()));\n+  EXPECT_FALSE(cost_analysis.IsEmpty());\n }\n \n TEST_P(LoadedExecutableImplTest, GetDonatableInputIndices) {"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 33,
        "deletions": 20
    }
}