{
    "author": "d4n1elchen",
    "message": "[HLO Diff] Refactor HLO diff HTML rendering to write directly to output stream.\n\nThis change modifies `RenderHtml` to accept `std::ostream` instead of `std::ostringstream`, allowing direct writing to the output file stream and avoiding buffering the entire HTML content in memory. Additional logging is added to track the progress of HTML generation.\n\nPiperOrigin-RevId: 814118543",
    "sha": "2f0f6764a9a03a616474c1a496daa53502cd7169",
    "files": [
        {
            "sha": "a446c93c004abac612237a51ba8b61665221e0a7",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2f0f6764a9a03a616474c1a496daa53502cd7169/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2f0f6764a9a03a616474c1a496daa53502cd7169/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD?ref=2f0f6764a9a03a616474c1a496daa53502cd7169",
            "patch": "@@ -76,6 +76,7 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/functional:function_ref\",\n+        \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\","
        },
        {
            "sha": "c5962b29ba5c7825310a5e0b8d8a1e88938910d9",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2f0f6764a9a03a616474c1a496daa53502cd7169/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2f0f6764a9a03a616474c1a496daa53502cd7169/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=2f0f6764a9a03a616474c1a496daa53502cd7169",
            "patch": "@@ -18,6 +18,7 @@\n #include <cstdint>\n #include <functional>\n #include <optional>\n+#include <ostream>\n #include <sstream>\n #include <string>\n #include <utility>\n@@ -27,6 +28,7 @@\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/functional/function_ref.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/log/log.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n@@ -1507,6 +1509,7 @@ std::string PrintRepetitiveDiffPatterns(\n         return a_diff_size > b_diff_size;\n       });\n   std::string computation_group_list;\n+  LOG(INFO) << \"Found \" << sorted_diff_patterns.size() << \" patterns.\";\n   for (const ComputationDiffPattern& diff_pattern : sorted_diff_patterns) {\n     absl::StrAppend(\n         &computation_group_list,\n@@ -1520,8 +1523,8 @@ std::string PrintRepetitiveDiffPatterns(\n void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n                 GraphUrlGenerator* url_generator,\n                 OpMetricGetter* left_op_metric_getter,\n-                OpMetricGetter* right_op_metric_getter,\n-                std::ostringstream& out) {\n+                OpMetricGetter* right_op_metric_getter, std::ostream& out) {\n+  LOG(INFO) << \"Starting HTML generation...\";\n   const absl::flat_hash_set<HloOpcode> ignored_opcodes(kIgnoredOpcodes.begin(),\n                                                        kIgnoredOpcodes.end());\n \n@@ -1541,6 +1544,7 @@ void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n \n   // Print profile metrics diff\n   if (left_op_metric_getter != nullptr && right_op_metric_getter != nullptr) {\n+    LOG(INFO) << \"Printing profile metrics diff...\";\n     out << PrintSectionWithHeader(\n         \"XProf Op Metrics Diff by Instructions (Ordered by absolute execution \"\n         \"time difference in descending order)\",\n@@ -1567,16 +1571,20 @@ void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n                              filtered_diff_result.unchanged_instructions,\n                              *left_op_metric_getter, *right_op_metric_getter,\n                              url_generator))));\n+    LOG(INFO) << \"Finished printing profile metrics diff.\";\n   }\n \n   // Print repetitive computation groups\n+  LOG(INFO) << \"Printing repetitive computation groups...\";\n   out << PrintSectionWithHeader(\n       \"Diffs grouped by computation (Ordered by # of different instructions) \" +\n           PrintButton(\"toggleButton\", \"Hide Unchanged Instructions\"),\n       PrintRepetitiveDiffPatterns(diff_summary.computation_diff_patterns,\n                                   span_attributes, url_generator));\n+  LOG(INFO) << \"Finished printing repetitive computation groups.\";\n \n   // Print full diff results\n+  LOG(INFO) << \"Printing full diff results...\";\n   out << PrintSectionWithHeader(\n       \"Full Diff Results\",\n       absl::StrCat(\n@@ -1601,10 +1609,12 @@ void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n                               filtered_diff_result.changed_instructions.size()),\n               PrintChangedInstructions(\n                   filtered_diff_result.changed_instructions, url_generator))));\n+  LOG(INFO) << \"Finished printing full diff results.\";\n \n   out << PrintSystemMessagePlaceholder();\n   out << PrintJavascriptForHoverEvent();\n   out << PrintJavascriptForToggleButton();\n+  LOG(INFO) << \"HTML generation finished.\";\n }\n \n }  // namespace hlo_diff"
        },
        {
            "sha": "f986128f401a35cd2ed260c1d97e3aad14dbed6e",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.h",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2f0f6764a9a03a616474c1a496daa53502cd7169/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2f0f6764a9a03a616474c1a496daa53502cd7169/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.h?ref=2f0f6764a9a03a616474c1a496daa53502cd7169",
            "patch": "@@ -17,7 +17,7 @@\n #ifndef XLA_HLO_TOOLS_HLO_DIFF_RENDER_HLO_GUMGRAPH_HTML_RENDERER_H_\n #define XLA_HLO_TOOLS_HLO_DIFF_RENDER_HLO_GUMGRAPH_HTML_RENDERER_H_\n \n-#include <sstream>\n+#include <ostream>\n \n #include \"xla/hlo/tools/hlo_diff/hlo_diff_result.h\"\n #include \"xla/hlo/tools/hlo_diff/hlo_diff_summary.h\"\n@@ -33,19 +33,16 @@ namespace hlo_diff {\n void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n                 GraphUrlGenerator* url_generator,\n                 OpMetricGetter* left_op_metric_getter,\n-                OpMetricGetter* right_op_metric_getter,\n-                std::ostringstream& out);\n+                OpMetricGetter* right_op_metric_getter, std::ostream& out);\n inline void RenderHtml(const DiffResult& diff_result,\n                        const DiffSummary& diff_summary,\n-                       GraphUrlGenerator* url_generator,\n-                       std::ostringstream& out) {\n+                       GraphUrlGenerator* url_generator, std::ostream& out) {\n   RenderHtml(diff_result, diff_summary, url_generator,\n              /*left_op_metric_getter=*/nullptr,\n              /*right_op_metric_getter=*/nullptr, out);\n }\n inline void RenderHtml(const DiffResult& diff_result,\n-                       const DiffSummary& diff_summary,\n-                       std::ostringstream& out) {\n+                       const DiffSummary& diff_summary, std::ostream& out) {\n   RenderHtml(diff_result, diff_summary, /*url_generator=*/nullptr,\n              /*left_op_metric_getter=*/nullptr,\n              /*right_op_metric_getter=*/nullptr, out);"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 17,
        "deletions": 9
    }
}