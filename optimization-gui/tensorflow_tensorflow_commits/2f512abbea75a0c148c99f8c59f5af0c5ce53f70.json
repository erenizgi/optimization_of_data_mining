{
    "author": "cezheng",
    "message": "[PJRT:IFRT] Fix ASAN error when CrossHostReceiveBuffers's notifier loop races with buffer's onready future becoming available.\n\nPiperOrigin-RevId: 799348685",
    "sha": "2f512abbea75a0c148c99f8c59f5af0c5ce53f70",
    "files": [
        {
            "sha": "23e569444b528654ac0a79c0206b5bb0fa688aeb",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_client.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2f512abbea75a0c148c99f8c59f5af0c5ce53f70/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2f512abbea75a0c148c99f8c59f5af0c5ce53f70/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.cc?ref=2f512abbea75a0c148c99f8c59f5af0c5ce53f70",
            "patch": "@@ -1337,7 +1337,8 @@ PjRtClient::CopyArraysForCrossHost(absl::Span<ArrayRef> arrays,\n               \"PjRtClient::CopyArraysForCrossHost\");\n         }\n       }\n-      TF_RETURN_IF_ERROR(CrossHostSendBuffers(send_buffers, transfer_keys));\n+      TF_RETURN_IF_ERROR(\n+          CrossHostSendBuffers(send_buffers, std::move(transfer_keys)));\n       ++j;\n     } else if (dst_devices->devices()[i]->IsAddressable()) {\n       std::vector<xla::Shape> recv_shapes;\n@@ -1362,9 +1363,9 @@ PjRtClient::CopyArraysForCrossHost(absl::Span<ArrayRef> arrays,\n           GetPjRtGlobalDeviceId(dst_devices->devices()[i]->Id()));\n       TF_ASSIGN_OR_RETURN(xla::PjRtDevice * pjrt_device,\n                           pjrt_client_->LookupDevice(pjrt_global_device_id));\n-      TF_ASSIGN_OR_RETURN(\n-          recv_buffers.emplace_back(),\n-          CrossHostReceiveBuffers(recv_shapes, pjrt_device, transfer_keys));\n+      TF_ASSIGN_OR_RETURN(recv_buffers.emplace_back(),\n+                          CrossHostReceiveBuffers(recv_shapes, pjrt_device,\n+                                                  std::move(transfer_keys)));\n     }\n   }\n \n@@ -1515,8 +1516,8 @@ absl::Status PjRtClient::CrossHostSendBuffers(\n \n absl::StatusOr<PjRtArray::PjRtBuffers> PjRtClient::CrossHostReceiveBuffers(\n     absl::Span<const xla::Shape> shapes, xla::PjRtDevice* device,\n-    const std::vector<int64_t>& keys) {\n-  auto notifier = [this, keys](\n+    std::vector<int64_t> keys) {\n+  auto notifier = [this, keys = std::move(keys)](\n                       absl::StatusOr<xla::PjRtCrossHostRecvState> recv_state) {\n     if (!recv_state.ok()) {\n       LOG(FATAL) << \"Invalid PjRtCrossHostRecvState passed to \"\n@@ -1544,7 +1545,7 @@ absl::StatusOr<PjRtArray::PjRtBuffers> PjRtClient::CrossHostReceiveBuffers(\n       }\n       return;\n     }\n-    for (int i = 0; i < keys.size(); ++i) {\n+    for (int i = 0, n = keys.size(); i < n; ++i) {\n       std::string key = absl::StrCat(kKeyPrefix, keys[i]);\n       absl::Status kv_status = kv_store_->Set(\n           key, recv_state->descriptors[i].serialized_descriptors.front());"
        },
        {
            "sha": "265b1a13eb0861ba9557066d1b31d02273a638ca",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2f512abbea75a0c148c99f8c59f5af0c5ce53f70/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2f512abbea75a0c148c99f8c59f5af0c5ce53f70/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_client.h?ref=2f512abbea75a0c148c99f8c59f5af0c5ce53f70",
            "patch": "@@ -361,7 +361,7 @@ class PjRtClient final\n   // from a cross-host send onto device.\n   absl::StatusOr<PjRtBuffers> CrossHostReceiveBuffers(\n       absl::Span<const xla::Shape> shapes, xla::PjRtDevice* device,\n-      const std::vector<int64_t>& keys);\n+      std::vector<int64_t> keys);\n \n   // Copies arrays from source to destination devices when at least one of the\n   // (source, destination) pairs is cross-host using an experimental DCN"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 9,
        "deletions": 8
    }
}