{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Value Tracking] Print the entire instruction for mismatch tuple structures\n\nThis prints the entire instruction instead of instruction name when the original value has a different tuple structure with the instruction shape in HLO verifier pass. The instruction name is not reliable and could be different from its name in the HLO dump.\n\nPiperOrigin-RevId: 825241833",
    "sha": "8e130fe8be9a5c20559d5e208e5ccd0b9d770f93",
    "files": [
        {
            "sha": "8e77b596d0fb923efcf8949fc3b9f18e9c9f3f3f",
            "filename": "third_party/xla/xla/service/hlo_verifier.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8e130fe8be9a5c20559d5e208e5ccd0b9d770f93/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8e130fe8be9a5c20559d5e208e5ccd0b9d770f93/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc?ref=8e130fe8be9a5c20559d5e208e5ccd0b9d770f93",
            "patch": "@@ -2868,7 +2868,7 @@ absl::Status VerifyLayoutConstrainedAllReduce(const HloModule& module) {\n \n namespace {\n std::string FormatShapeIndexValidationError(\n-    absl::string_view instruction_name,\n+    const HloInstruction* instruction,\n     const absl::flat_hash_set<ShapeIndex>& shape_leaf_indices,\n     const absl::flat_hash_set<ShapeIndex>& ov_leaf_indices) {\n   std::vector<ShapeIndex> shape_only;\n@@ -2892,7 +2892,8 @@ std::string FormatShapeIndexValidationError(\n       \"Mismatched tuple structure in original_value for \"\n       \"instruction %s. Leaf indices in shape and original_value \"\n       \"do not match.\\nIn shape only: {%s}\\nIn original_value only: {%s}\",\n-      instruction_name, absl::StrJoin(shape_only, \", \", shape_index_formatter),\n+      instruction->ToString(),\n+      absl::StrJoin(shape_only, \", \", shape_index_formatter),\n       absl::StrJoin(ov_only, \", \", shape_index_formatter));\n }\n \n@@ -2921,9 +2922,9 @@ absl::Status VerifyOriginalValue(const HloModule& module) {\n         }\n \n         if (shape_leaf_indices != ov_leaf_indices) {\n-          return Internal(\"%s\", FormatShapeIndexValidationError(\n-                                    instruction->name(), shape_leaf_indices,\n-                                    ov_leaf_indices));\n+          return Internal(\n+              \"%s\", FormatShapeIndexValidationError(\n+                        instruction, shape_leaf_indices, ov_leaf_indices));\n         }\n       }\n     }"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 6,
        "deletions": 5
    }
}