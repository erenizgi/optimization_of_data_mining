{
    "author": "tensorflower-gardener",
    "message": "[XLA:GPU] Don't fail Autotuner::GetSupportedConfigs if one of the backend fails\n\nPiperOrigin-RevId: 820303427",
    "sha": "83c407040ae83bd0e6d69a8cca8119f4f6ab731b",
    "files": [
        {
            "sha": "fe8aa1e5a7780c3978d75689277a3659cef34eb4",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83c407040ae83bd0e6d69a8cca8119f4f6ab731b/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83c407040ae83bd0e6d69a8cca8119f4f6ab731b/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner.cc?ref=83c407040ae83bd0e6d69a8cca8119f4f6ab731b",
            "patch": "@@ -248,10 +248,12 @@ absl::StatusOr<std::vector<Autotuner::Config>> Autotuner::GetSupportedConfigs(\n     HloInstruction* instr) {\n   std::vector<Config> configs;\n   for (auto& codegen_backend : codegen_backends_) {\n-    std::vector<std::unique_ptr<BackendConfig>> per_backend_configs;\n-    TF_ASSIGN_OR_RETURN(per_backend_configs,\n-                        codegen_backend->GetSupportedConfigs(*instr));\n-    for (auto& config : per_backend_configs) {\n+    absl::StatusOr<std::vector<std::unique_ptr<BackendConfig>>>\n+        per_backend_configs = codegen_backend->GetSupportedConfigs(*instr);\n+    if (!per_backend_configs.ok()) {\n+      continue;\n+    }\n+    for (auto& config : *per_backend_configs) {\n       configs.push_back({codegen_backend.get(), std::move(config)});\n     }\n   }"
        },
        {
            "sha": "a8a472cb3efc4fbd281d9cf90874e43884de7d92",
            "filename": "third_party/xla/xla/backends/autotuner/autotuner_test.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83c407040ae83bd0e6d69a8cca8119f4f6ab731b/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83c407040ae83bd0e6d69a8cca8119f4f6ab731b/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fautotuner%2Fautotuner_test.cc?ref=83c407040ae83bd0e6d69a8cca8119f4f6ab731b",
            "patch": "@@ -393,6 +393,43 @@ TEST_F(AutotunerTest, AutotuneModuleWithDuplicateInstructions) {\n   EXPECT_THAT(autotuner->Autotune(module.get(), should_autotune), IsOk());\n }\n \n+TEST_F(AutotunerTest, AutotuneButOneBackendFails) {\n+  auto cache_manager = std::make_unique<MockAutotunerCache>();\n+  EXPECT_CALL(*cache_manager, Lookup(_)).WillOnce(Return(std::nullopt));\n+  EXPECT_CALL(*cache_manager, Insert(_, _)).WillOnce(Return(absl::OkStatus()));\n+\n+  std::vector<std::unique_ptr<BackendConfig>> configs;\n+  configs.push_back(GetTestConfig(\"test_config\"));\n+\n+  auto good_backend = std::make_unique<MockCodegenBackend>();\n+  EXPECT_CALL(*good_backend, GetSupportedConfigs)\n+      .WillOnce(Return(std::move(configs)));\n+  EXPECT_CALL(*good_backend, Compile(_, _))\n+      .WillOnce(Return(std::unique_ptr<Executable>()));\n+  EXPECT_CALL(*good_backend, ApplyConfig(_, ConfigMatcher(\"test_config\")))\n+      .Times(1)\n+      .WillRepeatedly(Return(absl::OkStatus()));\n+  auto bad_backend = std::make_unique<MockCodegenBackend>();\n+  EXPECT_CALL(*bad_backend, GetSupportedConfigs)\n+      .WillOnce(Return(absl::InternalError(\"test error\")));\n+\n+  auto profiler = std::make_unique<MockProfiler>();\n+  auto device_description = CreateDummyDeviceDescription();\n+  EXPECT_CALL(*profiler, CreateInputBuffers(_))\n+      .WillOnce(Return(std::make_unique<InputBuffers>()));\n+  EXPECT_CALL(*profiler, Profile(_, _))\n+      .WillOnce(Return(ProfileResult({absl::Seconds(1)})));\n+  std::vector<std::unique_ptr<CodegenBackend>> backends;\n+  backends.push_back(std::move(good_backend));\n+  backends.push_back(std::move(bad_backend));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto autotuner,\n+      Autotuner::Create(std::move(backends), std::move(profiler), config_,\n+                        std::move(cache_manager)));\n+  auto dummy_instr = HloInstruction::CreateConstant(LiteralUtil::CreateR0(1));\n+  EXPECT_THAT(autotuner->Autotune(dummy_instr.get()), absl_testing::IsOk());\n+}\n+\n TEST_F(AutotunerTest, CacheHit) {\n   auto cache_manager = std::make_unique<MockAutotunerCache>();\n   AutotunerCacheInterface::Config config;"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 43,
        "deletions": 4
    }
}