{
    "author": "alekstheod",
    "message": "PR #32139: [ROCm] make toolchain hermetic compatible with rbe for rocm CI\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32139\n\nüìù Summary of Changes\nEnsures hipcc toolchain is hermetic, preparation for rbe workflows\n\nüéØ Justification\nRequired to be able to support distributed builds\n\nüöÄ Kind of Contribution\n‚ú® New Feature\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nNot relevant\n\nüß™ Execution Tests:\nNot relevant\n\nCopybara import of the project:\n\n--\nc84a1f086aee838edb1afdd835c7cba92370ad48 by Alexandros Theodoridis <atheodor@amd.com>:\n\nUse toolchain files from within local_config_rocm\n\n--\nfa951e210ecb9ce99d437903e1ac1d8e03a5852f by Alexandros Theodoridis <atheodor@amd.com>:\n\nUse only relative paths\n\n--\neb5a4bfa5e6ad1b2cca2f8713c4bd192df6c4433 by Alexandros Theodoridis <atheodor@amd.com>:\n\nClean-up\n\nMerging this change closes #32139\n\nPiperOrigin-RevId: 814263025",
    "sha": "727d61e7f8188b6a93b177bac3ad39430b96e87f",
    "files": [
        {
            "sha": "c61f1fb8fc702324140bf52ba98a374bb5512545",
            "filename": "third_party/xla/third_party/gpus/crosstool/BUILD.rocm.tpl",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Fcrosstool%2FBUILD.rocm.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Fcrosstool%2FBUILD.rocm.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Fcrosstool%2FBUILD.rocm.tpl?ref=727d61e7f8188b6a93b177bac3ad39430b96e87f",
            "patch": "@@ -35,7 +35,7 @@ cc_toolchain_suite(\n \n cc_toolchain(\n     name = \"cc-compiler-local\",\n-    all_files = \":crosstool_wrapper_driver_is_not_gcc\",\n+    all_files = \"@local_config_rocm//rocm:all_files\",\n     compiler_files = \":crosstool_wrapper_driver_is_not_gcc\",\n     ar_files = \":crosstool_wrapper_driver_is_not_gcc\",\n     as_files = \":crosstool_wrapper_driver_is_not_gcc\",\n@@ -112,6 +112,8 @@ filegroup(\n \n filegroup(\n   name = \"crosstool_wrapper_driver_is_not_gcc\",\n-  srcs = [\":clang/bin/crosstool_wrapper_driver_is_not_gcc\"],\n-  data = [\"@local_config_rocm//rocm:all_files\"],\n+  srcs = [\n+      \":clang/bin/crosstool_wrapper_driver_is_not_gcc\", \n+      \"@local_config_rocm//rocm:toolchain_data\",\n+  ],\n )"
        },
        {
            "sha": "e4e0c53e83999f2a52619388412137d621b71dad",
            "filename": "third_party/xla/third_party/gpus/crosstool/clang/bin/crosstool_wrapper_driver_rocm.tpl",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Fcrosstool%2Fclang%2Fbin%2Fcrosstool_wrapper_driver_rocm.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Fcrosstool%2Fclang%2Fbin%2Fcrosstool_wrapper_driver_rocm.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Fcrosstool%2Fclang%2Fbin%2Fcrosstool_wrapper_driver_rocm.tpl?ref=727d61e7f8188b6a93b177bac3ad39430b96e87f",
            "patch": "@@ -26,12 +26,11 @@ import shlex\n CPU_COMPILER = ('%{cpu_compiler}')\n HOST_COMPILER_PATH = ('%{host_compiler_path}')\n \n-HIPCC_PATH = '%{hipcc_path}'\n-PREFIX_DIR = os.path.dirname(HOST_COMPILER_PATH)\n+HIPCC_PATH = '%{rocm_root}/bin/hipcc'\n HIPCC_ENV = '%{hipcc_env}'\n-HIP_RUNTIME_PATH = '%{hip_runtime_path}'\n-HIP_RUNTIME_LIBRARY = '%{hip_runtime_library}'\n-ROCR_RUNTIME_PATH = '%{rocr_runtime_path}'\n+HIP_RUNTIME_PATH = '%{rocm_root}/lib'\n+HIP_RUNTIME_LIBRARY = '%{rocm_root}/lib'\n+ROCR_RUNTIME_PATH = '%{rocm_root}/lib'\n ROCR_RUNTIME_LIBRARY = '%{rocr_runtime_library}'\n VERBOSE = '%{crosstool_verbose}'=='1'\n \n@@ -206,7 +205,7 @@ def InvokeHipcc(argv, log=False):\n   hipccopts += defines\n   hipccopts += std_options\n   hipccopts += m_options\n-  hipccopts += ' --rocm-path=\"%{rocm_path}\" '\n+  hipccopts += ' --rocm-path=\"%{rocm_root}\" '\n \n   if depfiles:\n     # Generate the dependency file"
        },
        {
            "sha": "a4d256831716f1406dab05a3347d2cff3eddab4f",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=727d61e7f8188b6a93b177bac3ad39430b96e87f",
            "patch": "@@ -170,6 +170,7 @@ cc_library(\n         \"%{rocm_root}/include\",\n     ],\n     strip_include_prefix = \"%{rocm_root}\",\n+    visibility = [\"//visibility:public\"],\n     deps = [\n         \":amd_comgr\",\n         \":hsa_rocr\",\n@@ -258,6 +259,7 @@ cc_library(\n \n cc_library(\n     name = \"miopen\",\n+    srcs = glob([\"%{rocm_root}/lib/libMIOpen*.so*\"]),\n     hdrs = glob([\"%{rocm_root}/include/miopen/**\"]),\n     data = glob([\n         \"%{rocm_root}/lib/libMIOpen*.so*\",\n@@ -515,6 +517,17 @@ filegroup(\n     visibility = [\"//visibility:public\"],\n )\n \n+filegroup(\n+    name = \"toolchain_data\",\n+    srcs = glob([\n+        \"%{rocm_root}/bin/hipcc\",\n+        \"%{rocm_root}/lib/llvm/**\",\n+        \"%{rocm_root}/share/hip/**\",\n+        \"%{rocm_root}/amdgcn/**\",\n+    ]),\n+    visibility = [\"//visibility:public\"],\n+)\n+\n filegroup(\n     name = \"all_files\",\n     srcs = glob([\"%{rocm_root}/**\"]),"
        },
        {
            "sha": "9e6692ce9434389efc544d090834f8b6da2513ff",
            "filename": "third_party/xla/third_party/gpus/rocm_configure.bzl",
            "status": "modified",
            "additions": 7,
            "deletions": 10,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/727d61e7f8188b6a93b177bac3ad39430b96e87f/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl?ref=727d61e7f8188b6a93b177bac3ad39430b96e87f",
            "patch": "@@ -83,14 +83,13 @@ def verify_build_defines(params):\n             \".\",\n         )\n \n-def find_cc(repository_ctx, use_rocm_clang):\n+def find_cc(repository_ctx):\n     \"\"\"Find the C++ compiler.\"\"\"\n \n     target_cc_name = \"clang\"\n-    cc_path_envvar = _CLANG_COMPILER_PATH\n     cc_name = target_cc_name\n \n-    cc_name_from_env = get_host_environ(repository_ctx, cc_path_envvar)\n+    cc_name_from_env = get_host_environ(repository_ctx, _CLANG_COMPILER_PATH)\n     if cc_name_from_env:\n         cc_name = cc_name_from_env\n     if cc_name.startswith(\"/\"):\n@@ -99,7 +98,7 @@ def find_cc(repository_ctx, use_rocm_clang):\n     cc = which(repository_ctx, cc_name)\n     if cc == None:\n         fail((\"Cannot find {}, either correct your path or set the {}\" +\n-              \" environment variable\").format(target_cc_name, cc_path_envvar))\n+              \" environment variable\").format(target_cc_name, _CLANG_COMPILER_PATH))\n     return cc\n \n def auto_configure_fail(msg):\n@@ -633,7 +632,8 @@ def _create_local_rocm_repository(repository_ctx):\n     )\n \n     # Set up crosstool/\n-    cc = find_cc(repository_ctx, is_rocm_clang)\n+    cc = find_cc(repository_ctx)\n+\n     host_compiler_includes = get_cxx_inc_directories(\n         repository_ctx,\n         cc,\n@@ -688,13 +688,10 @@ def _create_local_rocm_repository(repository_ctx):\n         tpl_paths[\"crosstool:clang/bin/crosstool_wrapper_driver_rocm\"],\n         {\n             \"%{cpu_compiler}\": str(cc),\n-            \"%{compiler_is_clang}\": \"True\" if is_rocm_clang else \"False\",\n-            \"%{hipcc_path}\": str(repository_ctx.path(rocm_config.rocm_toolkit_path + \"/bin/hipcc\")),\n+            \"%{compiler_is_clang}\": \"True\",\n+            \"%{rocm_root}\": \"external/local_config_rocm/\" + str(rocm_config.rocm_toolkit_path),\n             \"%{hipcc_env}\": _hipcc_env(repository_ctx),\n-            \"%{rocm_path}\": str(repository_ctx.path(rocm_config.rocm_toolkit_path)),\n-            \"%{rocr_runtime_path}\": str(repository_ctx.path(rocm_config.rocm_toolkit_path + \"/lib\")),\n             \"%{rocr_runtime_library}\": \"hsa-runtime64\",\n-            \"%{hip_runtime_path}\": str(repository_ctx.path(rocm_config.rocm_toolkit_path + \"/lib\")),\n             \"%{hip_runtime_library}\": \"amdhip64\",\n             \"%{crosstool_verbose}\": _crosstool_verbose(repository_ctx),\n             \"%{gcc_host_compiler_path}\": str(cc),"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 30,
        "deletions": 19
    }
}