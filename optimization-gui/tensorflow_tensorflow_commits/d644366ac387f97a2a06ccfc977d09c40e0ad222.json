{
    "author": "tensorflower-gardener",
    "message": "IFRT proxy: Allow large data transfers via files when proxy-client and\nproxy-server have access to a shared filesystem.\n\nPiperOrigin-RevId: 810216020",
    "sha": "d644366ac387f97a2a06ccfc977d09c40e0ad222",
    "files": [
        {
            "sha": "17283da68b7c6249bcd78083f691b57330f55c30",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2FBUILD?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -494,14 +494,19 @@ cc_library(\n         \"//xla/python/ifrt_proxy/common:grpc_ifrt_service_proto_cc\",\n         \"//xla/python/ifrt_proxy/common:ifrt_service_proto_cc\",\n         \"//xla/python/ifrt_proxy/common:prof_util\",\n+        \"//xla/python/ifrt_proxy/common:transfer_util\",\n+        \"//xla/python/ifrt_proxy/common:versions\",\n+        \"//xla/tsl/platform:env\",\n         \"//xla/tsl/protobuf:status_proto_cc\",\n         \"@com_github_grpc_grpc//:grpc++\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:cord\",\n         \"@com_google_absl//absl/strings:string_view\",\n+        \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:unbounded_work_queue\",\n         \"@local_tsl//tsl/profiler/lib:traceme\",\n     ],"
        },
        {
            "sha": "0a0a0ce0286b5d89f02e94b3963d6019adeb3e08",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/global_flags.h",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #ifndef XLA_PYTHON_IFRT_PROXY_CLIENT_GLOBAL_FLAGS_H_\n #define XLA_PYTHON_IFRT_PROXY_CLIENT_GLOBAL_FLAGS_H_\n \n+#include <cstdint>\n #include <ostream>\n \n namespace xla {\n@@ -40,6 +41,8 @@ struct GlobalClientFlags {\n   // Zero or negative values are interpreted as no maximum.\n   int grpc_max_ongoing_host_buffer_stores;\n   int grpc_max_ongoing_host_buffer_lookups;\n+\n+  int64_t grpc_large_transfer_optimization_threshold_bytes;\n };\n \n GlobalClientFlags* GetGlobalClientFlags();\n@@ -52,7 +55,9 @@ inline std::ostream& operator<<(std::ostream& os, GlobalClientFlags flags) {\n             << \"grpc_max_ongoing_host_buffer_stores=\"\n             << flags.grpc_max_ongoing_host_buffer_stores << \",\"\n             << \"grpc_max_ongoing_host_buffer_lookups=\"\n-            << flags.grpc_max_ongoing_host_buffer_lookups << \"}\";\n+            << flags.grpc_max_ongoing_host_buffer_lookups << \",\"\n+            << \"grpc_large_transfer_optimization_threshold_bytes=\"\n+            << flags.grpc_large_transfer_optimization_threshold_bytes << \"}\";\n }\n \n }  // namespace proxy"
        },
        {
            "sha": "5c819a4dc8b14690382ddc27c047059277e6d861",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/global_flags_oss.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags_oss.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags_oss.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fglobal_flags_oss.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -13,7 +13,9 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include <cstdint>\n #include <cstdlib>\n+#include <limits>\n #include <string>\n \n #include \"absl/debugging/leak_check.h\"\n@@ -27,24 +29,25 @@ namespace proxy {\n \n namespace {\n \n-bool GetBoolFromEnv(const char* key) {\n+bool GetBoolFromEnv(const char* key, bool default_value) {\n   if (const char* valptr = std::getenv(key)) {\n     std::string val(valptr);\n     bool result;\n     QCHECK(absl::SimpleAtob(val, &result)) << \" \" << key << \": '\" << val << \"'\";\n     return result;\n   }\n-  return false;\n+  return default_value;\n }\n \n-int GetIntFromEnv(const char* key) {\n+template <typename IntType>\n+IntType GetIntFromEnv(const char* key, IntType default_value) {\n   if (const char* valptr = std::getenv(key)) {\n     std::string val(valptr);\n-    int result;\n+    IntType result;\n     QCHECK(absl::SimpleAtoi(val, &result)) << \" \" << key << \": '\" << val << \"'\";\n     return result;\n   }\n-  return 0;\n+  return default_value;\n }\n \n }  // namespace\n@@ -53,11 +56,15 @@ static GlobalClientFlags DefaultGlobalClientFlags() {\n   GlobalClientFlags result;\n   result.synchronous_host_buffer_store = false;\n   result.array_is_deleted_hack =\n-      GetBoolFromEnv(\"IFRT_PROXY_ARRAY_IS_DELETED_HACK\");\n+      GetBoolFromEnv(\"IFRT_PROXY_ARRAY_IS_DELETED_HACK\", false);\n   result.grpc_max_ongoing_host_buffer_stores =\n-      GetIntFromEnv(\"IFRT_PROXY_GRPC_MAX_ONGOING_HOST_BUFFER_STORES\");\n+      GetIntFromEnv<int>(\"IFRT_PROXY_GRPC_MAX_ONGOING_HOST_BUFFER_STORES\", 0);\n   result.grpc_max_ongoing_host_buffer_lookups =\n-      GetIntFromEnv(\"IFRT_PROXY_GRPC_MAX_ONGOING_HOST_BUFFER_LOOKUPS\");\n+      GetIntFromEnv<int>(\"IFRT_PROXY_GRPC_MAX_ONGOING_HOST_BUFFER_LOOKUPS\", 0);\n+  result.grpc_large_transfer_optimization_threshold_bytes =\n+      GetIntFromEnv<int64_t>(\n+          \"IFRT_PROXY_GRPC_LARGE_TRANSFER_OPTIMIZATION_THRESHOLD_BYTES\",\n+          std::numeric_limits<int64_t>::max());\n   return result;\n };\n "
        },
        {
            "sha": "44e02550b85633e9135d6e0167d611e2c7daacc2",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/grpc_host_buffer.cc",
            "status": "modified",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -20,6 +20,7 @@\n #include <string>\n #include <utility>\n \n+#include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n@@ -36,6 +37,9 @@\n #include \"xla/python/ifrt_proxy/common/grpc_ifrt_service.grpc.pb.h\"\n #include \"xla/python/ifrt_proxy/common/grpc_ifrt_service.pb.h\"\n #include \"xla/python/ifrt_proxy/common/prof_util.h\"\n+#include \"xla/python/ifrt_proxy/common/transfer_util.h\"\n+#include \"xla/python/ifrt_proxy/common/versions.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/protobuf/status.pb.h\"\n #include \"tsl/platform/unbounded_work_queue.h\"\n #include \"tsl/profiler/lib/traceme.h\"\n@@ -90,8 +94,58 @@ GrpcClientHostBufferStore::~GrpcClientHostBufferStore() {\n   LOG(INFO) << \"Destructed HostBufferStoreLookupsWorkQueue.\";\n }\n \n+Future<> GrpcClientHostBufferStore::StoreToDisk(uint64_t handle,\n+                                                absl::string_view data) {\n+  auto [promise, future] = Future<>::MakePromise();\n+\n+  XFlowHelper flow(\"GrpcClientHostBufferStore::StoreToDisk\");\n+  flow.InstantActivity<XFlowHelper::kSend>();\n+\n+  work_queue_->Schedule([this, handle, promise = std::move(promise).ToShared(),\n+                         data, flow]() mutable -> void {\n+    auto span = flow.Span<XFlowHelper::kRecv>();\n+\n+    GrpcHostBufferReadFromDiskRequest request;\n+    request.mutable_metadata()->set_session_id(session_id_);\n+    request.mutable_metadata()->set_handle(handle);\n+    request.mutable_metadata()->set_buffer_size(data.size());\n+    VLOG(3) << \"GrpcClientHostBufferStore::StoreToDisk start \"\n+            << request.ShortDebugString();\n+\n+    auto file_path = LargeTransferFilePath(handle);\n+    if (file_path == std::nullopt) {\n+      promise->Set(absl::FailedPreconditionError(\n+          \"IFRT proxy: cannot retrieve file path for StoreToDisk().\"));\n+      return;\n+    }\n+    if (auto s = tsl::WriteStringToFile(tsl::Env::Default(), *file_path, data);\n+        !s.ok()) {\n+      LOG(WARNING) << \"Failed to write to file \" << *file_path << \": \" << s;\n+      promise->Set(std::move(s));\n+      return;\n+    }\n+\n+    ::grpc::ClientContext context;\n+    GrpcHostBufferReadFromDiskResponse response;\n+    promise->Set(xla::FromGrpcStatus(\n+        stub_->HostBufferReadFromDisk(&context, request, &response)));\n+    VLOG(3) << \"GrpcClientHostBufferStore::StoreToDisk done \"\n+            << request.ShortDebugString();\n+  });\n+  return std::move(future);\n+}\n+\n Future<> GrpcClientHostBufferStore::Store(uint64_t handle,\n                                           absl::string_view data) {\n+  if (version_.protocol_version() >=\n+      protocol_version::kGrpcAllowLargeTransferOptimizationViaSharedDirectory) {\n+    int64_t threshold = GetGlobalClientFlags()\n+                            ->grpc_large_transfer_optimization_threshold_bytes;\n+    if (data.size() >= threshold) {\n+      return StoreToDisk(handle, data);\n+    }\n+  }\n+\n   auto [promise, future] = Future<>::MakePromise();\n \n   XFlowHelper flow(\"GrpcClientHostBufferStore::StoreAsync\");"
        },
        {
            "sha": "38ea15fe48a7bc24e04c727b3ba01a8849ccde60",
            "filename": "third_party/xla/xla/python/ifrt_proxy/client/grpc_host_buffer.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fclient%2Fgrpc_host_buffer.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -50,6 +50,8 @@ class GrpcClientHostBufferStore : public ClientHostBufferStore {\n   Future<> Delete(uint64_t handle) override;\n \n  private:\n+  Future<> StoreToDisk(uint64_t handle, absl::string_view data);\n+\n   const std::shared_ptr<grpc::GrpcIfrtService::StubInterface> stub_;\n   const IfrtProxyVersion version_;\n   const uint64_t session_id_;"
        },
        {
            "sha": "6ee21094dcae5cd0849dca9b66617d90e45e87c7",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/BUILD",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2FBUILD?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -246,6 +246,20 @@ cc_library(\n     hdrs = [\"versions.h\"],\n )\n \n+cc_library(\n+    name = \"transfer_util\",\n+    srcs = [\"transfer_util.cc\"],\n+    hdrs = [\"transfer_util.h\"],\n+    deps = [\n+        \"//xla/tsl/platform:env\",\n+        \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+    ],\n+)\n+\n # copybara:uncomment_begin\n # bzl_library(\n #     name = \"ifrt_proxy_bzl\","
        },
        {
            "sha": "b08ecc63f706e0395b0e43511c2068ffba87cea2",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/VERSION.md",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2FVERSION.md",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2FVERSION.md",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2FVERSION.md?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -97,3 +97,10 @@\n *   Added date: 2025-07-18\n *   Changes:\n     *   Added support for `LoadedExecutable::devices()`.\n+\n+## Version kGrpcAllowLargeTransferOptimizationViaSharedDirectory\n+\n+*   Added date: 2025-10-22\n+*   Changes:\n+    *   Optimize large transfers with the proxy-server and client in the same\n+    machine to by using the file system."
        },
        {
            "sha": "6a6e2f732489259e2e35896d8f7962dcf21bc7d0",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/array_util.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Farray_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Farray_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Farray_util.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -172,7 +172,7 @@ absl::StatusOr<std::unique_ptr<std::string>> SerializeStringHostBuffer(\n }\n \n absl::StatusOr<std::vector<absl::Cord>> DeserializeStringHostBufferFromString(\n-    const std::string& serialized_string_buffer) {\n+    absl::string_view serialized_string_buffer) {\n   proto::StringArrayContents string_array_proto;\n   if (!string_array_proto.ParseFromString(serialized_string_buffer)) {\n     return absl::InvalidArgumentError("
        },
        {
            "sha": "2cd9b2049ddc4782c746e6d47e08eccc60f4a519",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/array_util.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Farray_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Farray_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Farray_util.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -88,7 +88,7 @@ absl::StatusOr<std::unique_ptr<std::string>> SerializeStringHostBuffer(\n     absl::Span<const absl::Cord> cords);\n \n absl::StatusOr<std::vector<absl::Cord>> DeserializeStringHostBufferFromString(\n-    const std::string& serialized_string_buffer);\n+    absl::string_view serialized_string_buffer);\n \n // Callers must ensure that the `preallocated_buffer` consists of `N`\n // `absl::Cord` objects, where N is the number of string elements in the"
        },
        {
            "sha": "bd4141a2ec33b43687703ff4ba88c50ef0bfffd1",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/grpc_ifrt_service.proto",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Fgrpc_ifrt_service.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Fgrpc_ifrt_service.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Fgrpc_ifrt_service.proto?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -52,6 +52,10 @@ service GrpcIfrtService {\n   // Deletes a host buffer from the server.\n   rpc HostBufferDelete(GrpcHostBufferDeleteRequest)\n       returns (GrpcHostBufferDeleteResponse);\n+\n+  // Sends a host buffer from the client to the server as a file.\n+  rpc HostBufferReadFromDisk(GrpcHostBufferReadFromDiskRequest)\n+      returns (GrpcHostBufferReadFromDiskResponse);\n }\n \n message GrpcGetVersionRequest {\n@@ -87,6 +91,12 @@ message GrpcHostBufferStoreRequest {\n \n message GrpcHostBufferStoreResponse {}\n \n+message GrpcHostBufferReadFromDiskRequest {\n+  GrpcHostBufferStoreMetadata metadata = 1;\n+}\n+\n+message GrpcHostBufferReadFromDiskResponse {}\n+\n // `Lookup` request that specifies which host buffer in the server to read.\n message GrpcHostBufferLookupRequest {\n   fixed64 session_id = 1;"
        },
        {
            "sha": "382aadb33e40b58860d2beed1c43d48ffb10f967",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/transfer_util.cc",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Ftransfer_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Ftransfer_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Ftransfer_util.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -0,0 +1,78 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/python/ifrt_proxy/common/transfer_util.h\"\n+\n+#include <cstdlib>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+#include \"absl/base/no_destructor.h\"\n+#include \"absl/log/check.h\"\n+#include \"absl/log/log.h\"\n+#include \"absl/strings/match.h\"\n+#include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_replace.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/tsl/platform/env.h\"\n+\n+namespace xla {\n+namespace ifrt {\n+namespace proxy {\n+\n+constexpr char kLargeTransferOptimizationDirectoryEnv[] =\n+    \"IFRT_PROXY_GRPC_LARGE_TRANSFER_OPTIMIZATION_DIRECTORY\";\n+\n+// Returns the environmental variable kLargeTransferOptimizationDirectoryEnv\n+// with `$$TEST_TMPDIR$$` substituted by any temporary directory.\n+static std::string UncachedLargeTransferOptimizationDirectory() {\n+  const char* valptr = std::getenv(kLargeTransferOptimizationDirectoryEnv);\n+  if (valptr == nullptr) {\n+    return \"\";\n+  }\n+\n+  std::string result = valptr;\n+  if (!absl::StrContains(result, \"$$TEST_TMPDIR$$\")) {\n+    return result;\n+  }\n+\n+  std::vector<std::string> tmp_dirs;\n+  tsl::Env::Default()->GetLocalTempDirectories(&tmp_dirs);\n+  CHECK(!tmp_dirs.empty())\n+      << \"Environmental variable \" << kLargeTransferOptimizationDirectoryEnv\n+      << \" contains $$TEST_TMPDIR$$ but unable to find a temporary directory.\";\n+\n+  return absl::StrReplaceAll(result, {{\"$$TEST_TMPDIR$$\", tmp_dirs[0]}});\n+}\n+\n+static absl::string_view LargeTransferOptimizationDirectory() {\n+  static absl::NoDestructor<std::string> result(\n+      UncachedLargeTransferOptimizationDirectory());\n+  LOG_EVERY_N(INFO, 1) << kLargeTransferOptimizationDirectoryEnv << \"=\"\n+                       << *result;\n+  return *result;\n+}\n+\n+std::optional<std::string> LargeTransferFilePath(int handle) {\n+  if (LargeTransferOptimizationDirectory().empty()) {\n+    return std::nullopt;\n+  }\n+  return absl::StrCat(LargeTransferOptimizationDirectory(), \"/lt_\", handle);\n+}\n+\n+}  // namespace proxy\n+}  // namespace ifrt\n+}  // namespace xla"
        },
        {
            "sha": "1f5f2dfd348d75d3f44786a8300d30c710354425",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/transfer_util.h",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Ftransfer_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Ftransfer_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Ftransfer_util.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -0,0 +1,35 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PYTHON_IFRT_PROXY_COMMON_TRANSFER_UTIL_H_\n+#define XLA_PYTHON_IFRT_PROXY_COMMON_TRANSFER_UTIL_H_\n+\n+#include <optional>\n+#include <string>\n+\n+namespace xla {\n+namespace ifrt {\n+namespace proxy {\n+\n+// Returns the file path that may be used by HostBuffer implementations for\n+// sending a buffer with `handle`. Returns `std::nullopt` if such file-paths\n+// have not been configured via startup options.\n+std::optional<std::string> LargeTransferFilePath(int handle);\n+\n+}  // namespace proxy\n+}  // namespace ifrt\n+}  // namespace xla\n+\n+#endif  // XLA_PYTHON_IFRT_PROXY_COMMON_TRANSFER_UTIL_H_"
        },
        {
            "sha": "60d1487b605ce7b1933ed4ed0da4abd2ba8d722c",
            "filename": "third_party/xla/xla/python/ifrt_proxy/common/versions.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Fversions.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Fversions.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fcommon%2Fversions.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -48,7 +48,11 @@ enum {\n   kSerDesVersioning = 15,\n \n   // kExecutableDevices adds a devices() method to Executable.\n-  kExecutableDevices,\n+  kExecutableDevices = 16,\n+\n+  // Optimize large transfers with the proxy-server and client in the same\n+  // machine to by using the file system.\n+  kGrpcAllowLargeTransferOptimizationViaSharedDirectory = 17,\n \n   // kSentiel is used to derive kCurrent below. Keep this as the last value of\n   // the enum."
        },
        {
            "sha": "2e3dc820823d2c552e6aee699e6de417ad194413",
            "filename": "third_party/xla/xla/python/ifrt_proxy/integration_tests/BUILD",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fintegration_tests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fintegration_tests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fintegration_tests%2FBUILD?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -68,6 +68,25 @@ ifrt_proxy_cc_test(\n     ],\n )\n \n+ifrt_proxy_cc_test(\n+    name = \"array_impl_test_tfrt_cpu_with_grpc_large_transfer_optimization\",\n+    srcs = [\"array_impl_test_tfrt_cpu.cc\"],\n+    args = [\n+        \"--ifrt_proxy_grpc_large_transfer_optimization_threshold_bytes=0\",\n+    ],\n+    env = {\n+        \"IFRT_PROXY_GRPC_LARGE_TRANSFER_OPTIMIZATION_DIRECTORY\": \"$$$$TEST_TMPDIR$$$$\",\n+    },\n+    # TODO(b/396205547): Remove `linkstatic = False`.\n+    linkstatic = False,\n+    deps = [\n+        \":register_pjrt_cpu_for_ifrt_api_tests\",\n+        \"//xla/python/ifrt:array_impl_test_lib\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_googletest//:gtest\",\n+    ],\n+)\n+\n ifrt_proxy_cc_test(\n     name = \"executable_impl_test_tfrt_cpu\",\n     timeout = \"moderate\","
        },
        {
            "sha": "728e97d6a89a7729bda843c8d54f3cf97994f04d",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2FBUILD?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -89,6 +89,7 @@ cc_library(\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/synchronization\",\n+        \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/profiler/lib:traceme\",\n     ],\n )\n@@ -251,6 +252,9 @@ cc_library(\n     srcs = [\"host_buffer.cc\"],\n     hdrs = [\"host_buffer.h\"],\n     deps = [\n+        \"//xla/python/ifrt_proxy/common:transfer_util\",\n+        \"//xla/tsl/platform:env\",\n+        \"//xla/tsl/platform:errors\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\","
        },
        {
            "sha": "19950a5ac5120982608d37b7a369410853700b55",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/grpc_service_impl.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fgrpc_service_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fgrpc_service_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fgrpc_service_impl.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -269,6 +269,19 @@ ::grpc::Status GrpcServiceImpl::HostBufferDelete(\n   return xla::ToGrpcStatus((*store)->Delete(request->handle()));\n }\n \n+::grpc::Status GrpcServiceImpl::HostBufferReadFromDisk(\n+    ::grpc::ServerContext* context,\n+    const GrpcHostBufferReadFromDiskRequest* request,\n+    GrpcHostBufferReadFromDiskResponse* response) {\n+  tsl::profiler::TraceMe traceme(\"HostBufferReadFromDisk\");\n+  auto store = GetHostBufferStore(request->metadata().session_id());\n+  if (!store.ok()) {\n+    return xla::ToGrpcStatus(store.status());\n+  }\n+  return xla::ToGrpcStatus(\n+      (*store)->ReadFromDisk(request->metadata().handle()));\n+}\n+\n bool GrpcServiceImpl::Test_InsertHostBufferStore(\n     uint64_t session_id,\n     std::shared_ptr<xla::ifrt::proxy::HostBufferStore> store) {"
        },
        {
            "sha": "62d0091535c47a67d627a8416fa1af1f2cca65e2",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/grpc_service_impl.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fgrpc_service_impl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fgrpc_service_impl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fgrpc_service_impl.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -77,6 +77,11 @@ class GrpcServiceImpl : public grpc::GrpcIfrtService::Service {\n       const GrpcHostBufferDeleteRequest* request,\n       GrpcHostBufferDeleteResponse* response) override;\n \n+  ::grpc::Status HostBufferReadFromDisk(\n+      ::grpc::ServerContext* context,\n+      const GrpcHostBufferReadFromDiskRequest* request,\n+      GrpcHostBufferReadFromDiskResponse* response) override;\n+\n   // Test-only method that adds a new session in the host buffer store map.\n   // Returns false if the session id already exists.\n   bool Test_InsertHostBufferStore("
        },
        {
            "sha": "02c2320f94520d0669ba11f17c0ffac7d0e5d19b",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/host_buffer.cc",
            "status": "modified",
            "additions": 59,
            "deletions": 4,
            "changes": 63,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -16,6 +16,7 @@\n \n #include <cstdint>\n #include <memory>\n+#include <optional>\n #include <string>\n #include <utility>\n \n@@ -25,8 +26,13 @@\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/time/time.h\"\n+#include \"xla/python/ifrt_proxy/common/transfer_util.h\"\n+#include \"xla/tsl/platform/env.h\"\n+#include \"xla/tsl/platform/errors.h\"\n+#include \"xla/tsl/platform/file_system.h\"\n #include \"tsl/profiler/lib/traceme.h\"\n \n namespace xla {\n@@ -39,22 +45,71 @@ absl::Status HostBufferStore::Store(uint64_t handle, std::string data) {\n   if (shutdown_msg_.has_value()) {\n     return absl::CancelledError(*shutdown_msg_);\n   }\n+\n+  auto contents = std::make_unique<std::string>(std::move(data));\n+  auto* ptr = new absl::string_view(*contents);\n+  auto deleter = [contents = std::move(contents)](absl::string_view* ptr) {\n+    delete ptr;\n+  };\n+\n   const bool inserted =\n-      buffers_.insert({handle, std::make_shared<std::string>(std::move(data))})\n-          .second;\n+      buffers_.insert({handle, MemRegion(ptr, std::move(deleter))}).second;\n+  if (!inserted) {\n+    return absl::AlreadyExistsError(\n+        absl::StrCat(\"Host buffer handle \", handle, \" already exists\"));\n+  }\n+  return absl::OkStatus();\n+}\n+\n+absl::Status HostBufferStore::ReadFromDisk(uint64_t handle) {\n+  std::optional<std::string> file_path = LargeTransferFilePath(handle);\n+  CHECK(file_path != std::nullopt) << absl::NotFoundError(\n+      \"IFRT proxy: cannot retrieve file path for ReadFromDisk().\");\n+  VLOG(3) << \"HostBuffer::StoreViaFilePath \" << handle << \" \" << *file_path;\n+\n+  tsl::profiler::TraceMe traceme(\"HostBufferStore::ReadFromDisk\");\n+  MemRegion value;\n+  {\n+    std::unique_ptr<tsl::ReadOnlyMemoryRegion> tsl_mmaped;\n+    TF_RETURN_IF_ERROR(tsl::Env::Default()->NewReadOnlyMemoryRegionFromFile(\n+        *file_path, &tsl_mmaped));\n+\n+    auto view_ptr = new absl::string_view(\n+        static_cast<const char*>(tsl_mmaped->data()), tsl_mmaped->length());\n+\n+    auto deleter = [tsl_mmaped = std::move(tsl_mmaped),\n+                    file_path](absl::string_view* ptr) mutable {\n+      tsl_mmaped = nullptr;\n+      auto status = tsl::Env::Default()->DeleteFile(*file_path);\n+      if (!status.ok()) {\n+        LOG(WARNING) << \"Failed to delete file \" << *file_path << \": \"\n+                     << status;\n+      }\n+      delete ptr;\n+    };\n+\n+    value = MemRegion(view_ptr, std::move(deleter));\n+  }\n+\n+  absl::MutexLock lock(mu_);\n+  if (shutdown_msg_.has_value()) {\n+    return absl::CancelledError(*shutdown_msg_);\n+  }\n+\n+  const bool inserted = buffers_.insert({handle, std::move(value)}).second;\n   if (!inserted) {\n     return absl::AlreadyExistsError(\n         absl::StrCat(\"Host buffer handle \", handle, \" already exists\"));\n   }\n   return absl::OkStatus();\n }\n \n-absl::StatusOr<std::shared_ptr<const std::string>> HostBufferStore::Lookup(\n+absl::StatusOr<HostBufferStore::MemRegion> HostBufferStore::Lookup(\n     uint64_t handle, absl::Duration timeout) {\n   VLOG(3) << \"HostBufferStore::Lookup \" << handle\n           << \" start, timeout=\" << timeout;\n   tsl::profiler::TraceMe traceme(\"HostBufferStore::Lookup\");\n-  auto result = [&]() -> absl::StatusOr<std::shared_ptr<const std::string>> {\n+  auto result = [&]() -> absl::StatusOr<MemRegion> {\n     absl::MutexLock lock(mu_);\n     auto cond = [&]() ABSL_SHARED_LOCKS_REQUIRED(mu_) {\n       return shutdown_msg_.has_value() || buffers_.contains(handle);"
        },
        {
            "sha": "66a5c0145624ac7a93d1efa8e5e86ed93e865486",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/host_buffer.h",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer.h?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -45,10 +45,15 @@ class HostBufferStore {\n   // handle already exists.\n   absl::Status Store(uint64_t handle, std::string data);\n \n+  // Reads the data associated with the given handle from storage and stores it.\n+  // Returns an error if the handle already exists.\n+  absl::Status ReadFromDisk(uint64_t handle);\n+\n   // Retrieves the data associated with the handle. Returns an error if the\n   // handle does not exist within the given timeout or if `Shutdown()` is\n   // called.\n-  absl::StatusOr<std::shared_ptr<const std::string>> Lookup(\n+  using MemRegion = std::shared_ptr<const absl::string_view>;\n+  absl::StatusOr<MemRegion> Lookup(\n       uint64_t handle, absl::Duration timeout = absl::ZeroDuration());\n \n   // Deletes the host buffer associated with the handle. Returns an error if the\n@@ -62,8 +67,8 @@ class HostBufferStore {\n \n  private:\n   absl::Mutex mu_;\n-  absl::flat_hash_map<uint64_t, std::shared_ptr<const std::string>> buffers_\n-      ABSL_GUARDED_BY(mu_);\n+\n+  absl::flat_hash_map<uint64_t, MemRegion> buffers_ ABSL_GUARDED_BY(mu_);\n   std::optional<std::string> shutdown_msg_ ABSL_GUARDED_BY(mu_);\n };\n "
        },
        {
            "sha": "d35c4debbc4feaf3de188c015c3a483d80f764d0",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/host_buffer_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fhost_buffer_test.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -15,7 +15,6 @@\n #include \"xla/python/ifrt_proxy/server/host_buffer.h\"\n \n #include <cstdint>\n-#include <memory>\n #include <string>\n #include <utility>\n \n@@ -59,7 +58,7 @@ TEST(HostBufferStoreTest, WriteAfterReadStarted) {\n   const uint64_t kHandle = 1;\n \n   auto [lookup_promise, lookup_fut] =\n-      Future<std::shared_ptr<const std::string>>::MakePromise();\n+      Future<HostBufferStore::MemRegion>::MakePromise();\n \n   absl::Notification closure_started;\n   tsl::Env::Default()->SchedClosure(\n@@ -81,7 +80,7 @@ TEST(HostBufferStoreTest, ShutdownAfterReadStarted) {\n   const uint64_t kHandle = 1;\n \n   auto [lookup_promise, lookup_fut] =\n-      Future<std::shared_ptr<const std::string>>::MakePromise();\n+      Future<HostBufferStore::MemRegion>::MakePromise();\n \n   absl::Notification closure_started;\n   tsl::Env::Default()->SchedClosure([&, promise = std::move("
        },
        {
            "sha": "fb199b0463891791b6341a435ab59fa1babf110f",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -95,7 +95,7 @@ namespace {\n using IfrtArrayRef = xla::ifrt::ArrayRef;\n \n absl::StatusOr<IfrtArrayRef> MakeStringArrayFromHostBuffer(\n-    Client* client, std::shared_ptr<const std::string> host_buffer, DType dtype,\n+    Client* client, HostBufferStore::MemRegion host_buffer, DType dtype,\n     Shape shape, std::optional<absl::Span<const int64_t>> byte_strides,\n     ShardingRef sharding) {\n   TF_ASSIGN_OR_RETURN(std::vector<absl::Cord> string_host_buffer,\n@@ -143,7 +143,7 @@ ParseMakeArraysFromHostBufferShardsSpecHostBufferProto(\n     byte_strides = FromByteStridesProto(host_buffer_proto.byte_strides());\n   }\n   TF_ASSIGN_OR_RETURN(\n-      std::shared_ptr<const std::string> host_buffer,\n+      HostBufferStore::MemRegion host_buffer,\n       host_buffer_store->Lookup(host_buffer_proto.host_buffer_handle(),\n                                 /*timeout=*/absl::InfiniteDuration()));\n   const void* data;\n@@ -862,7 +862,7 @@ IfrtBackend::HandleMakeArrayFromHostBufferRequest(\n     host_buffer_store_->Delete(host_buffer_handle).IgnoreError();\n   };\n   TF_ASSIGN_OR_RETURN(\n-      std::shared_ptr<const std::string> host_buffer,\n+      HostBufferStore::MemRegion host_buffer,\n       host_buffer_store_->Lookup(host_buffer_handle,\n                                  /*timeout=*/absl::InfiniteDuration()));\n   std::move(cleanup).Invoke();\n@@ -1927,7 +1927,7 @@ IfrtBackend::HandleLoadedHostCallbackReturnRequest(\n   absl::Status status;\n   if (ret.has_result_host_buffer_handle()) {\n     TF_ASSIGN_OR_RETURN(\n-        std::shared_ptr<const std::string> buffer,\n+        HostBufferStore::MemRegion buffer,\n         host_buffer_store_->Lookup(ret.result_host_buffer_handle(),\n                                    /*timeout=*/absl::InfiniteDuration()));\n     absl::Cleanup cleanup = [&] {"
        },
        {
            "sha": "26936a3279c437559b692015c219b6bed5b7558f",
            "filename": "third_party/xla/xla/python/ifrt_proxy/server/ifrt_backend_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d644366ac387f97a2a06ccfc977d09c40e0ad222/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt_proxy%2Fserver%2Fifrt_backend_test.cc?ref=d644366ac387f97a2a06ccfc977d09c40e0ad222",
            "patch": "@@ -1610,7 +1610,7 @@ TEST_P(IfrtBackendHandlerTest, LoadedHostCallbackExecute) {\n         poll_response.host_callback_execution_handle();\n \n     TF_ASSERT_OK_AND_ASSIGN(\n-        const std::shared_ptr<const std::string> operands,\n+        const HostBufferStore::MemRegion operands,\n         host_buffer_store_->Lookup(operand_host_buffer_handle));\n     EXPECT_EQ(xla::BorrowingLiteral(operands->data(),\n                                     xla::ShapeUtil::MakeShape(xla::F32, {})),"
        }
    ],
    "stats": {
        "total": 375,
        "additions": 348,
        "deletions": 27
    }
}