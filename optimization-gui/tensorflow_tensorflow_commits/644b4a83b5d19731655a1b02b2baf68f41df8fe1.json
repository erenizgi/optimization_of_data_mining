{
    "author": "tensorflower-gardener",
    "message": "Replace `stream->BlockHostUntilDone()` with `BlockHostUntilDoneWithHostCallback()`.\n\nBlockHostUntilDone calls `cuStreamSynchronize`, which has some performance issues.\n\nPiperOrigin-RevId: 819924678",
    "sha": "644b4a83b5d19731655a1b02b2baf68f41df8fe1",
    "files": [
        {
            "sha": "84896e1fd16d53e21427bc9a3c20c4cbd432a643",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_async_host_to_device_transfer_manager.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_async_host_to_device_transfer_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_async_host_to_device_transfer_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_async_host_to_device_transfer_manager.cc?ref=644b4a83b5d19731655a1b02b2baf68f41df8fe1",
            "patch": "@@ -335,11 +335,7 @@ TfrtGpuAsyncHostToDeviceTransferManager::TransferRawDataToSubBuffer(\n       TF_CHECK_OK(stream->Memcpy(&sub_buffer, host_data_ptr, transfer_size))\n           << \"Failed to copy data to GPU\";\n \n-      absl::Status status;\n-      {\n-        tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-        status = stream->BlockHostUntilDone();\n-      }\n+      absl::Status status = BlockHostUntilDoneWithHostCallback(stream);\n       VLOG(3) << \"H2D copy done: \" << status;\n       CHECK_OK(status) << \"Failed to block host until done\";\n     }"
        },
        {
            "sha": "820537ccfa0714bcd0438ef21d623bfd8aabb2c8",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_buffer.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 16,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_buffer.cc?ref=644b4a83b5d19731655a1b02b2baf68f41df8fe1",
            "patch": "@@ -148,10 +148,7 @@ absl::StatusOr<Shape> TfrtGpuBuffer::logical_on_device_shape() {\n     auto stream = device_->stream();\n     TF_RETURN_IF_ERROR(transfer_manager->ReadDynamicShapes(\n         stream, &shaped_buffer, &ret_shape));\n-    {\n-      tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-      TF_RETURN_IF_ERROR(stream->BlockHostUntilDone());\n-    }\n+    TF_RETURN_IF_ERROR(BlockHostUntilDoneWithHostCallback(stream));\n     return ret_shape;\n   };\n \n@@ -479,14 +476,12 @@ Future<> TfrtGpuBuffer::ToLiteralHelper(Future<MutableLiteralBase*> literal) {\n                 buffer_ptr, device_buffer->buffer()->buffer(), byte_size))\n                 << \"stream->Memcpy failed copying from GPU to host\";\n \n-            absl::Status status;\n-            {\n-              tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-              status = d2h_stream->BlockHostUntilDone();\n-            }\n+            absl::Status status =\n+                BlockHostUntilDoneWithHostCallback(d2h_stream);\n             VLOG(3) << \"D2H copy done. \" << status;\n             if (!status.ok()) {\n-              VLOG(3) << \"stream->BlockHostUntilDone failed: \" << status;\n+              VLOG(3) << \"stream BlockHostUntilDoneWithHostCallback failed: \"\n+                      << status;\n               promise.Set(status);\n               return;\n             }\n@@ -624,10 +619,11 @@ Future<> TfrtGpuBuffer::CopyRawToHostFuture(Future<void*> dst_future,\n       return;\n     }\n \n-    status = d2h_stream->BlockHostUntilDone();\n+    status = BlockHostUntilDoneWithHostCallback(d2h_stream);\n \n     if (!status.ok()) {\n-      LOG(ERROR) << \"d2h_stream->BlockHostUntilDone() failed: \" << status;\n+      LOG(ERROR) << \"d2h_stream BlockHostUntilDoneWithHostCallback failed: \"\n+                 << status;\n       promise.Set(status);\n       return;\n     }\n@@ -830,10 +826,8 @@ absl::StatusOr<std::unique_ptr<PjRtBuffer>> TfrtGpuBuffer::CopyToMemorySpace(\n           dst_definition_event.SetError(status);\n           return;\n         }\n-        {\n-          tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-          status = stream->BlockHostUntilDone();\n-        }\n+\n+        status = BlockHostUntilDoneWithHostCallback(stream);\n         if (status.ok()) {\n           VLOG(3) << \"D2D copy done. dst: \" << dst.opaque();\n           dst_definition_event.SetStateConcrete();"
        },
        {
            "sha": "da95f8e36d7ee14f6f46b23e492c906be7f695b3",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_client.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_client.cc?ref=644b4a83b5d19731655a1b02b2baf68f41df8fe1",
            "patch": "@@ -978,10 +978,7 @@ absl::StatusOr<std::unique_ptr<PjRtBuffer>> TfrtGpuClient::BufferFromHostBuffer(\n       return;\n     }\n \n-    {\n-      tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-      status = stream->BlockHostUntilDone();\n-    }\n+    status = BlockHostUntilDoneWithHostCallback(stream);\n     VLOG(3) << \"H2D copy done. \" << status;\n \n     if (status.ok()) {\n@@ -1114,11 +1111,7 @@ TfrtGpuClient::BufferFromHostLiteral(const LiteralSlice& literal,\n         TF_CHECK_OK(transfer_manager->TransferLiteralToDeviceAsync(\n             stream, literal, shaped_buffer));\n \n-        absl::Status status;\n-        {\n-          tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-          status = stream->BlockHostUntilDone();\n-        }\n+        absl::Status status = BlockHostUntilDoneWithHostCallback(stream);\n         CHECK_OK(status) << \"Failed to block host until done\";\n         VLOG(3) << \"BufferFromHostLiteral done for device_buffer: \"\n                 << device_buffer;"
        },
        {
            "sha": "588227432b216aadb7aa830871ab41eaeca3c189",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_device.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_device.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_device.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_device.cc?ref=644b4a83b5d19731655a1b02b2baf68f41df8fe1",
            "patch": "@@ -109,13 +109,13 @@ TfrtGpuDevice::~TfrtGpuDevice() {\n   // Block the host until all pending work on the stream is done. This is to\n   // avoid user-after-free errors in host callbacks.\n   if (stream_ != nullptr) {\n-    absl::Status status = stream_->BlockHostUntilDone();\n+    absl::Status status = BlockHostUntilDoneWithHostCallback(stream_.get());\n     if (!status.ok()) {\n       LOG(ERROR) << \"Failed to wait for stream to finish: \" << status;\n     }\n   }\n   if (d2h_stream_ != nullptr) {\n-    absl::Status status = d2h_stream_->BlockHostUntilDone();\n+    absl::Status status = BlockHostUntilDoneWithHostCallback(d2h_stream_.get());\n     if (!status.ok()) {\n       LOG(ERROR) << \"Failed to wait for d2h stream to finish: \" << status;\n     }"
        },
        {
            "sha": "ce0a913bd317da8f76ea6f82509ca379fd25c306",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/tfrt_gpu_executable.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Ftfrt_gpu_executable.cc?ref=644b4a83b5d19731655a1b02b2baf68f41df8fe1",
            "patch": "@@ -775,15 +775,12 @@ absl::StatusOr<PjRtLoadedExecutable::Result> TfrtGpuExecutable::ExecuteHelper(\n         // has completed, so that the next execute_fn can start.\n         scheduled_event.SetStateConcrete();\n \n-        absl::Status status;\n-        {\n-          tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-          status = stream->BlockHostUntilDone();\n-        }\n+        absl::Status status = BlockHostUntilDoneWithHostCallback(stream);\n         if (!status.ok()) {\n-          LOG(ERROR) << \"BlockHostUntilDone failed for executable \"\n-                     << executable_name << \" on device \"\n-                     << device->DebugString() << \", status = \" << status;\n+          LOG(ERROR)\n+              << \"BlockHostUntilDoneWithHostCallback failed for executable \"\n+              << executable_name << \" on device \" << device->DebugString()\n+              << \", status = \" << status;\n           complete_event.SetError(status);\n         } else {\n           complete_event.SetStateConcrete();"
        },
        {
            "sha": "e1eccfd767ae347a4168b1740ccb3121afafa2fd",
            "filename": "third_party/xla/xla/pjrt/gpu/tfrt/utils.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/644b4a83b5d19731655a1b02b2baf68f41df8fe1/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Ftfrt%2Futils.cc?ref=644b4a83b5d19731655a1b02b2baf68f41df8fe1",
            "patch": "@@ -459,10 +459,7 @@ SendDeviceMemoryFunction ConvertSendCallbacksToSendFunction(\n       }\n \n       // Wait for the data to be available on the host.\n-      {\n-        tsl::profiler::TraceMe traceme(\"BlockHostUntilDone\");\n-        status = stream->BlockHostUntilDone();\n-      }\n+      status = BlockHostUntilDoneWithHostCallback(stream);\n       VLOG(3) << \"D2H copy done. \" << status;\n       if (!status.ok()) {\n         done_event.SetError(absl::InternalError(absl::StrFormat("
        }
    ],
    "stats": {
        "total": 65,
        "additions": 21,
        "deletions": 44
    }
}