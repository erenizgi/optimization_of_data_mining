{
    "author": "tensorflower-gardener",
    "message": "Fix installation of local wheels by adjusting the wheel module names in the merged lock files.\n\nSome wheels like `jax-cuda12-plugin` have `-` symbol in the name, but `_` symbol in the filename (e.g. `jax_cuda12_plugin-0.8.0.dev0+selfbuilt-cp313-cp313t-manylinux_2_27_x86_64.whl`). Older `rules_python` implementation didn't make a difference whether the lock file had `jax-cuda12-plugin` or `jax_cuda12_plugin` records. `rules_python` v1.6 treats them differently: if there are records like below, then the local wheel doesn't override the one that should be downloaded from pypi.\n\n```\njax-cuda12-plugin==0.7.2 ; sys_platform == \"linux\" and python_version < \"3.14\" \\\n    --hash=sha256:05b6942985f015be82becd2cec363f0aceb25311981821d7613a51f630490e8c \\\n    --hash=sha256:1d00f9f5c5f68ae0f41cb7b589005ed5cb556517d65bbab5a891be46ed7a781c \\\n    --hash=sha256:23b8f1050c48b4020610fb818930d3cbe0304c6681b069687e5416ee349bd734 \\\n    --hash=sha256:2a727a89ae69ac21c1f5093d8d5aef89a0e692e66b034fc934c8accc72e40290 \\\n    --hash=sha256:45d5a1cbf0b9d05318722382fc71c4cede0c028bad6aa8e53f7a7032392f719c \\\n    --hash=sha256:5e3e2aa4d721fb02dd1028262aaeaec2958e45bca5c4d3512b29151b570cb425 \\\n    --hash=sha256:7212c12d75b7dc51275f271827df4a6d378430c06f650e6c31c162fe9579ff12 \\\n    --hash=sha256:7ad3afc51bcbc4e8117845d359e5d02cbc5ca2b152efdebd3c55fb9e4c2f848e \\\n    --hash=sha256:8284e7cf7f544906604f111702a6f0011a96df7f0113878b381bec0905172536 \\\n    --hash=sha256:98a975655382858d874d6471ce97194310609d0a2a7c4283c6e07e37933b7768 \\\n    --hash=sha256:adc924ebc7a45c8d3400ea0118dc70a7082b2a86e35711738d403dd3815d09bf \\\n    --hash=sha256:e881b56fe27e6870db2f2e9c574b81965fe1102b1532eae60e240a40c065daf5\n    # via -r build/requirements.in\n\njax_cuda12_plugin @ file:///jax_cuda12_plugin-0.8.0.dev0+selfbuilt-cp311-cp311-manylinux_2_27_x86_64.whl\n\n```\n\nTo fix this, `python_repo()` implementation was changed to add the local wheels with exactly the same module names as in the original lock file.\n\nPiperOrigin-RevId: 809147267",
    "sha": "bde9934322b2842f2a6db451a178fa11a2316a2c",
    "files": [
        {
            "sha": "3b67625aa526708e33b812f1691af2702469b4bc",
            "filename": "third_party/py/python_repo.bzl",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bde9934322b2842f2a6db451a178fa11a2316a2c/third_party%2Fpy%2Fpython_repo.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bde9934322b2842f2a6db451a178fa11a2316a2c/third_party%2Fpy%2Fpython_repo.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fpy%2Fpython_repo.bzl?ref=bde9934322b2842f2a6db451a178fa11a2316a2c",
            "patch": "@@ -55,12 +55,14 @@ Please check python_init_repositories() in your WORKSPACE file.\n             ctx.read(custom_requirements_path),\n         )\n     elif ctx.attr.local_wheel_workspaces:\n+        base_requirements = ctx.read(requirements)\n         local_wheel_requirements = _get_injected_local_wheels(\n             ctx,\n             version,\n             ctx.attr.local_wheel_workspaces,\n+            base_requirements,\n         )\n-        requirements_content = [ctx.read(requirements)] + local_wheel_requirements\n+        requirements_content = [base_requirements] + local_wheel_requirements\n         merged_requirements_content = \"\\n\".join(requirements_content)\n \n         requirements_with_local_wheels = \"@{repo}//:{label}\".format(\n@@ -176,7 +178,8 @@ def _parse_python_version(version_str):\n def _get_injected_local_wheels(\n         ctx,\n         py_version,\n-        local_wheel_workspaces):\n+        local_wheel_workspaces,\n+        base_requirements):\n     local_wheel_requirements = []\n     py_ver_marker = \"-cp%s-\" % py_version.replace(\".\", \"\")\n     py_major_ver_marker = \"-py%s-\" % py_version.split(\".\")[0]\n@@ -199,9 +202,17 @@ def _get_injected_local_wheels(\n                 )\n \n     for wheel_name, wheel_path in wheels.items():\n+        # Normalize `foo_bar` to `foo-bar`. We assume that, if `foo_bar`\n+        # isn't present in requirements, it must be named `foo-bar`. The\n+        # exact same distribution name needs to be used to ensure it is\n+        # correctly overridden.\n+        if \"_\" in wheel_name and wheel_name not in base_requirements:\n+            local_package_name = wheel_name.replace(\"_\", \"-\")\n+        else:\n+            local_package_name = wheel_name\n         local_wheel_requirements.append(\n-            \"{wheel_name} @ file://{wheel_path}\".format(\n-                wheel_name = wheel_name,\n+            \"{pypi_package_name} @ file://{wheel_path}\".format(\n+                pypi_package_name = local_package_name,\n                 wheel_path = wheel_path.realpath,\n             ),\n         )"
        },
        {
            "sha": "3b67625aa526708e33b812f1691af2702469b4bc",
            "filename": "third_party/xla/third_party/py/python_repo.bzl",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bde9934322b2842f2a6db451a178fa11a2316a2c/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_repo.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bde9934322b2842f2a6db451a178fa11a2316a2c/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_repo.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fpy%2Fpython_repo.bzl?ref=bde9934322b2842f2a6db451a178fa11a2316a2c",
            "patch": "@@ -55,12 +55,14 @@ Please check python_init_repositories() in your WORKSPACE file.\n             ctx.read(custom_requirements_path),\n         )\n     elif ctx.attr.local_wheel_workspaces:\n+        base_requirements = ctx.read(requirements)\n         local_wheel_requirements = _get_injected_local_wheels(\n             ctx,\n             version,\n             ctx.attr.local_wheel_workspaces,\n+            base_requirements,\n         )\n-        requirements_content = [ctx.read(requirements)] + local_wheel_requirements\n+        requirements_content = [base_requirements] + local_wheel_requirements\n         merged_requirements_content = \"\\n\".join(requirements_content)\n \n         requirements_with_local_wheels = \"@{repo}//:{label}\".format(\n@@ -176,7 +178,8 @@ def _parse_python_version(version_str):\n def _get_injected_local_wheels(\n         ctx,\n         py_version,\n-        local_wheel_workspaces):\n+        local_wheel_workspaces,\n+        base_requirements):\n     local_wheel_requirements = []\n     py_ver_marker = \"-cp%s-\" % py_version.replace(\".\", \"\")\n     py_major_ver_marker = \"-py%s-\" % py_version.split(\".\")[0]\n@@ -199,9 +202,17 @@ def _get_injected_local_wheels(\n                 )\n \n     for wheel_name, wheel_path in wheels.items():\n+        # Normalize `foo_bar` to `foo-bar`. We assume that, if `foo_bar`\n+        # isn't present in requirements, it must be named `foo-bar`. The\n+        # exact same distribution name needs to be used to ensure it is\n+        # correctly overridden.\n+        if \"_\" in wheel_name and wheel_name not in base_requirements:\n+            local_package_name = wheel_name.replace(\"_\", \"-\")\n+        else:\n+            local_package_name = wheel_name\n         local_wheel_requirements.append(\n-            \"{wheel_name} @ file://{wheel_path}\".format(\n-                wheel_name = wheel_name,\n+            \"{pypi_package_name} @ file://{wheel_path}\".format(\n+                pypi_package_name = local_package_name,\n                 wheel_path = wheel_path.realpath,\n             ),\n         )"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 30,
        "deletions": 8
    }
}