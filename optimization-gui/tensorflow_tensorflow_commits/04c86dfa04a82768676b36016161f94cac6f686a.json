{
    "author": "alekstheod",
    "message": "PR #34150: [ROCm] Consider runfiles in lit tests\n\nImported from GitHub PR https://github.com/openxla/xla/pull/34150\n\nüìù Summary of Changes\nFixing lit tests in rocm config\n\nüéØ Justification\nrocm provides its libs in the runfiles directory hence\nwhen running the lit test they are missing and gpu_test_correctness fails\nwith an error that one of the rocm libs is not found. This PR ensures\nthat runfiles are provided under the lit test execution directory so the libs are there.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nlit tests on CI\n\nüß™ Execution Tests:\nlit tests on CI\n\nCopybara import of the project:\n\n--\ne08b8b27fba1c3d102adea33937e8ca3e59c8c7c by Alexandros Theodoridis <atheodor@amd.com>:\n\nConsider runfiles in lit tests\n\n--\n850da0a8449078c096619975f4ad30cc1c898830 by Alexandros Theodoridis <atheodor@amd.com>:\n\nAddress review comments\n\nMerging this change closes #34150\n\nPiperOrigin-RevId: 838771687",
    "sha": "04c86dfa04a82768676b36016161f94cac6f686a",
    "files": [
        {
            "sha": "0f19bd015784fa4350bba7da3b7061f2435c761a",
            "filename": "third_party/xla/xla/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2FBUILD?ref=04c86dfa04a82768676b36016161f94cac6f686a",
            "patch": "@@ -19,6 +19,10 @@ package(\n     licenses = [\"notice\"],\n )\n \n+exports_files([\n+    \"sh_test_with_runfiles.py\",\n+])\n+\n exports_files([\n     \"lit.cfg.py\",\n ] + if_google([\"lit_google_cfg.py\"]))"
        },
        {
            "sha": "f6e64729fc532515b196af02eb75f3c17d82717c",
            "filename": "third_party/xla/xla/lit.bzl",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2Flit.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2Flit.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Flit.bzl?ref=04c86dfa04a82768676b36016161f94cac6f686a",
            "patch": "@@ -298,7 +298,7 @@ def lit_test(\n     See https://llvm.org/docs/CommandGuide/lit.html for details on lit\n     \"\"\"\n     args = args or []\n-    data = data or []\n+    data = (data or []) + [\"//xla:sh_test_with_runfiles.py\"]\n     tools = tools or []\n     env = env or {}\n "
        },
        {
            "sha": "2a173c904d56db8ff5e2b461b1b3682f1e222a4d",
            "filename": "third_party/xla/xla/lit.cfg.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2Flit.cfg.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2Flit.cfg.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Flit.cfg.py?ref=04c86dfa04a82768676b36016161f94cac6f686a",
            "patch": "@@ -23,6 +23,8 @@\n # from xla.lit_google_cfg import ENV_FLAGS as google_env_flags\n # copybara:uncomment_end\n \n+from xla.sh_test_with_runfiles import ShTestWithRunfiles\n+\n # pylint: disable=undefined-variable\n \n extra_env_flags = []\n@@ -36,7 +38,6 @@\n \n config.test_format = lit.formats.ShTest(execute_external=True)\n \n-\n for env in [\n     # Passthrough XLA_FLAGS.\n     \"XLA_FLAGS\",\n@@ -75,3 +76,6 @@\n config.substitutions.extend(\n     (\"%%{%s}\" % key, val) for key, val in lit_config.params.items()\n )\n+\n+# Replace the default test format with our wrapped version\n+config.test_format = ShTestWithRunfiles(execute_external=True)"
        },
        {
            "sha": "2d08eaa7a9dd1d515c2a172e4b6ba95229b53635",
            "filename": "third_party/xla/xla/sh_test_with_runfiles.py",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2Fsh_test_with_runfiles.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/04c86dfa04a82768676b36016161f94cac6f686a/third_party%2Fxla%2Fxla%2Fsh_test_with_runfiles.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fsh_test_with_runfiles.py?ref=04c86dfa04a82768676b36016161f94cac6f686a",
            "patch": "@@ -0,0 +1,48 @@\n+# Copyright 2025 The OpenXLA Authors.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\"\"\"Lit runner configuration.\"\"\"\n+\n+import os\n+import pathlib\n+\n+import lit.formats\n+\n+\n+class ShTestWithRunfiles(lit.formats.ShTest):\n+  \"\"\"Used to symlink bazels runfiles subdirs into the lit tmp test dir.\"\"\"\n+\n+  def execute(self, test, lit_config):\n+    runfiles = os.environ.get(\"RUNFILES_DIR\")\n+    if not runfiles:\n+      return super().execute(test, lit_config)\n+\n+    runfiles_dir = pathlib.Path(runfiles) / \"xla\"\n+    if not runfiles_dir.is_dir():\n+      return super().execute(test, lit_config)\n+\n+    dst = pathlib.Path(test.getExecPath()).parent\n+    dst.mkdir(parents=True, exist_ok=True)\n+    runfiles = []\n+    for item in runfiles_dir.iterdir():\n+      target = dst / item.name\n+      try:\n+        target.symlink_to(item, target_is_directory=item.is_dir())\n+        runfiles.append(target)\n+      except FileExistsError:\n+        pass\n+\n+    result = super().execute(test, lit_config)\n+    for target in runfiles:\n+      target.unlink()\n+    return result"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 58,
        "deletions": 2
    }
}