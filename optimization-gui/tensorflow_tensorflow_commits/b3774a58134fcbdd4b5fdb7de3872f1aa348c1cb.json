{
    "author": "unknown",
    "message": "[XLA] Add DumpPerExecutionProtobufToFile\n\nA function that writes a protobuf to a file with name derived from module name\nand the number of times it was executed so far.\n\nPiperOrigin-RevId: 817273822",
    "sha": "b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb",
    "files": [
        {
            "sha": "29bffac8757af00ca4d0b570da76db4cdf8e6362",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb",
            "patch": "@@ -524,15 +524,18 @@ cc_library(\n         \"//xla/tsl/platform:errors\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/base:nullability\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/synchronization\",\n+        \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:Transforms\",\n@@ -567,8 +570,11 @@ xla_cc_test(\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"//xla/tsl/testing:temporary_directory\",\n+        \"//xla/tsl/util/proto:proto_matchers\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_googletest//:gtest\",\n+        \"@com_google_protobuf//:protobuf\",\n         \"@local_tsl//tsl/platform\",\n         \"@local_tsl//tsl/platform:path\",\n         \"@local_tsl//tsl/platform:protobuf\","
        },
        {
            "sha": "c5e490b3c1b22f0c7f38403ae145dc591ca6b45f",
            "filename": "third_party/xla/xla/service/dump.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2Fdump.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2Fdump.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdump.cc?ref=b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb",
            "patch": "@@ -32,6 +32,7 @@ limitations under the License.\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/container/flat_hash_set.h\"\n #include \"absl/functional/any_invocable.h\"\n+#include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n@@ -777,6 +778,25 @@ void DumpPerModuleProtobufToFile(const HloModule& module,\n   DumpProtobufToFile(proto, debug_options, filename, std::move(text_formatter));\n }\n \n+void DumpPerExecutionProtobufToFile(\n+    const HloModule& module, const tsl::protobuf::Message& proto,\n+    const DebugOptions& debug_options, absl::string_view name,\n+    absl::AnyInvocable<\n+        absl::StatusOr<std::string>(tsl::Env*, const tsl::protobuf::Message&)>\n+        text_formatter) {\n+  int64_t execution_count = 0;\n+  {\n+    static auto& module_id_to_execution_count ABSL_GUARDED_BY(mu) =\n+        *new absl::flat_hash_map<int64_t, int64_t>();\n+    absl::MutexLock lock(mu);\n+    execution_count = module_id_to_execution_count[module.unique_id()]++;\n+  }\n+\n+  const std::string filename = FilenameFor(\n+      module, name, absl::StrFormat(\"execution_%04d\", execution_count));\n+  DumpProtobufToFile(proto, debug_options, filename, std::move(text_formatter));\n+}\n+\n std::string GetRepeatedValueAsString(\n     const tsl::protobuf::Reflection* reflection,\n     const DebugOptions& debug_options,"
        },
        {
            "sha": "717426ac6271ce9fd63be04986ee71ff919336fe",
            "filename": "third_party/xla/xla/service/dump.h",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2Fdump.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2Fdump.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdump.h?ref=b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #ifndef XLA_SERVICE_DUMP_H_\n #define XLA_SERVICE_DUMP_H_\n \n+#include <optional>\n #include <string>\n #include <vector>\n \n@@ -121,6 +122,16 @@ void DumpPerModuleProtobufToFile(const HloModule& module,\n                                      tsl::Env*, const tsl::protobuf::Message&)>\n                                      text_formatter = nullptr);\n \n+// Similar to above, but the filename depends on module's information, the\n+// given name, and the number of times the module has been executed so far. Also\n+// allows for the optional serialization function.\n+void DumpPerExecutionProtobufToFile(\n+    const HloModule& module, const tsl::protobuf::Message& proto,\n+    const DebugOptions& debug_options, absl::string_view name,\n+    absl::AnyInvocable<\n+        absl::StatusOr<std::string>(tsl::Env*, const tsl::protobuf::Message&)>\n+        text_formatter = nullptr);\n+\n // Dumps the given HLO module if dumping is enabled for the module. Exactly\n // where and in what formats it's dumped is determined by the module's config.\n // Returns the full file paths of all dumps of the module, or an empty vector if"
        },
        {
            "sha": "543c1804eea1e0549b1d0805054fb77a8ec0cc9e",
            "filename": "third_party/xla/xla/service/dump_test.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2Fdump_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb/third_party%2Fxla%2Fxla%2Fservice%2Fdump_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdump_test.cc?ref=b3774a58134fcbdd4b5fdb7de3872f1aa348c1cb",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"absl/strings/match.h\"\n #include \"absl/strings/numbers.h\"\n+#include \"google/protobuf/text_format.h\"\n #include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/analysis/alias_info.h\"\n #include \"xla/hlo/analysis/hlo_ordering.h\"\n@@ -37,6 +38,8 @@ limitations under the License.\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n+#include \"xla/tsl/testing/temporary_directory.h\"\n+#include \"xla/tsl/util/proto/proto_matchers.h\"\n #include \"xla/xla.pb.h\"\n #include \"tsl/platform/path.h\"\n #include \"tsl/platform/platform.h\"\n@@ -45,7 +48,10 @@ limitations under the License.\n namespace xla {\n namespace {\n \n+using ::testing::HasSubstr;\n using ::testing::IsEmpty;\n+using ::testing::SizeIs;\n+using ::tsl::proto_testing::EqualsProto;\n \n TEST(DumpHloIfEnabled, LargeConstantElided) {\n   HloModuleConfig config;\n@@ -491,5 +497,41 @@ TEST(DumpTest, DumpRepeatedStringTest) {\n       testing::HasSubstr(\"xla_disable_hlo_passes: \\\"layout-assignment\\\"\\n\"));\n }\n \n+TEST(DumpTest, DumpPerExecutionProtoToFile) {\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      tsl::testing::TemporaryDirectory dump_folder,\n+      tsl::testing::TemporaryDirectory::CreateForCurrentTestcase());\n+  const HloModule hlo_module(\"test_module\", HloModuleConfig());\n+  DebugOptions debug_options = DefaultDebugOptionsIgnoringFlags();\n+  debug_options.set_xla_dump_to(dump_folder.path());\n+  // Arbitrary proto.\n+  HloModuleProto proto;\n+  tsl::Env* env = tsl::Env::Default();\n+\n+  proto.set_name(\"test_module_1\");\n+  DumpPerExecutionProtobufToFile(hlo_module, proto, debug_options,\n+                                 /*name=*/\"test_name\",\n+                                 /*text_formatter=*/nullptr);\n+  proto.set_name(\"test_module_2\");\n+  DumpPerExecutionProtobufToFile(hlo_module, proto, debug_options,\n+                                 /*name=*/\"test_name\",\n+                                 /*text_formatter=*/nullptr);\n+\n+  std::vector<std::string> matches;\n+  TF_ASSERT_OK(tsl::Env::Default()->GetMatchingPaths(\n+      tsl::io::JoinPath(dump_folder.path(), \"*test_name*execution_*\"),\n+      &matches));\n+  ASSERT_THAT(matches, SizeIs(2));\n+  EXPECT_THAT(matches[0], HasSubstr(\"execution_0000\"));\n+  EXPECT_THAT(matches[1], HasSubstr(\"execution_0001\"));\n+\n+  HloModuleProto loaded_proto1;\n+  HloModuleProto loaded_proto2;\n+  TF_ASSERT_OK(tsl::ReadTextOrBinaryProto(env, matches[0], &loaded_proto1));\n+  TF_ASSERT_OK(tsl::ReadTextOrBinaryProto(env, matches[1], &loaded_proto2));\n+  EXPECT_THAT(loaded_proto1, EqualsProto(R\"pb(name: \"test_module_1\")pb\"));\n+  EXPECT_THAT(loaded_proto2, EqualsProto(R\"pb(name: \"test_module_2\")pb\"));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 79,
        "deletions": 0
    }
}