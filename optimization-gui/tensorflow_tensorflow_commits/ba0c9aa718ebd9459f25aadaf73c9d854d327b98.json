{
    "author": "ezhulenev",
    "message": "[xla:cpu] Implement all-reduce combiner for CPU backend\n\nPiperOrigin-RevId: 799233634",
    "sha": "ba0c9aa718ebd9459f25aadaf73c9d854d327b98",
    "files": [
        {
            "sha": "aae721bdfe710161276825f33bb7a83352ee7598",
            "filename": "third_party/xla/xla/backends/cpu/transforms/collectives/BUILD",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2FBUILD?ref=ba0c9aa718ebd9459f25aadaf73c9d854d327b98",
            "patch": "@@ -0,0 +1,52 @@\n+load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n+load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = [\":friends\"],\n+    licenses = [\"notice\"],\n+)\n+\n+package_group(\n+    name = \"friends\",\n+    includes = [\n+        \"//xla:friends\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"all_reduce_combiner\",\n+    srcs = [\"all_reduce_combiner.cc\"],\n+    hdrs = [\"all_reduce_combiner.h\"],\n+    deps = [\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/pass:hlo_pass\",\n+        \"//xla/hlo/transforms/collectives:all_reduce_combiner\",\n+        \"//xla/service:hlo_domain_map\",\n+        \"//xla/service/gpu:backend_configs_cc\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+    ],\n+)\n+\n+xla_cc_test(\n+    name = \"all_reduce_combiner_test\",\n+    srcs = [\"all_reduce_combiner_test.cc\"],\n+    deps = [\n+        \":all_reduce_combiner\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/testlib:filecheck\",\n+        \"//xla/hlo/testlib:hlo_hardware_independent_test_base\",\n+        \"//xla/hlo/utils:hlo_matchers\",\n+        \"//xla/service:collective_utils\",\n+        \"//xla/tsl/platform:status_matchers\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)"
        },
        {
            "sha": "105ad861eff106faa556ddc17403059235d22fb3",
            "filename": "third_party/xla/xla/backends/cpu/transforms/collectives/all_reduce_combiner.cc",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner.cc?ref=ba0c9aa718ebd9459f25aadaf73c9d854d327b98",
            "patch": "@@ -0,0 +1,33 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/cpu/transforms/collectives/all_reduce_combiner.h\"\n+\n+#include \"absl/container/flat_hash_set.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n+#include \"xla/hlo/transforms/collectives/all_reduce_combiner.h\"\n+\n+namespace xla::cpu {\n+\n+absl::StatusOr<bool> CpuAllReduceCombiner::Run(\n+    HloModule* module,\n+    const absl::flat_hash_set<absl::string_view>& execution_threads) {\n+  return RunWithKeyCombiner(module, execution_threads,\n+                            AllReduceCombiner::CombineKey);\n+}\n+\n+}  // namespace xla::cpu"
        },
        {
            "sha": "85d8560337e325962dc78a0ef42860009bbfe674",
            "filename": "third_party/xla/xla/backends/cpu/transforms/collectives/all_reduce_combiner.h",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner.h?ref=ba0c9aa718ebd9459f25aadaf73c9d854d327b98",
            "patch": "@@ -0,0 +1,44 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_BACKENDS_CPU_TRANSFORMS_COLLECTIVES_ALL_REDUCE_COMBINER_H_\n+#define XLA_BACKENDS_CPU_TRANSFORMS_COLLECTIVES_ALL_REDUCE_COMBINER_H_\n+\n+#include \"absl/container/flat_hash_set.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n+#include \"xla/hlo/pass/hlo_pass_interface.h\"\n+#include \"xla/hlo/transforms/collectives/all_reduce_combiner.h\"\n+\n+namespace xla::cpu {\n+\n+// Combines `AllReduce` ops into a single larger `AllReduce` op to maximize\n+// network bandwidth usage.\n+class CpuAllReduceCombiner : public AllReduceCombiner {\n+ public:\n+  using AllReduceCombiner::AllReduceCombiner;\n+\n+  absl::string_view name() const override { return \"cpu-all-reduce-combiner\"; }\n+\n+  using HloPassInterface::Run;\n+  absl::StatusOr<bool> Run(\n+      HloModule* module,\n+      const absl::flat_hash_set<absl::string_view>& execution_threads) override;\n+};\n+\n+}  // namespace xla::cpu\n+\n+#endif  // XLA_BACKENDS_CPU_TRANSFORMS_COLLECTIVES_ALL_REDUCE_COMBINER_H_"
        },
        {
            "sha": "8f3422bc405940009fc0d24720be5f6e9f9bce2f",
            "filename": "third_party/xla/xla/backends/cpu/transforms/collectives/all_reduce_combiner_test.cc",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ba0c9aa718ebd9459f25aadaf73c9d854d327b98/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fcollectives%2Fall_reduce_combiner_test.cc?ref=ba0c9aa718ebd9459f25aadaf73c9d854d327b98",
            "patch": "@@ -0,0 +1,103 @@\n+/* Copyright 2024 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+\n+You may obtain a copy of the License at\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/cpu/transforms/collectives/all_reduce_combiner.h\"\n+\n+#include <cstdint>\n+#include <limits>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/log/log.h\"\n+#include \"absl/status/status_matchers.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_instruction.h\"\n+#include \"xla/hlo/ir/hlo_print_options.h\"\n+#include \"xla/hlo/testlib/filecheck.h\"\n+#include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+\n+namespace xla::cpu {\n+namespace {\n+\n+using CpuAllReduceCombinerTest = HloHardwareIndependentTestBase;\n+\n+absl::StatusOr<bool> RunCombiner(HloModule* module) {\n+  return CpuAllReduceCombiner(std::numeric_limits<int64_t>::max(),\n+                              std::numeric_limits<int64_t>::max())\n+      .Run(module);\n+}\n+\n+TEST_F(CpuAllReduceCombinerTest, CombinesCollectivesUpToSpecifiedThreshold) {\n+  constexpr absl::string_view kHloString = R\"(\n+HloModule m\n+\n+add {\n+  a = f32[] parameter(0)\n+  b = f32[] parameter(1)\n+  ROOT add = f32[] add(a, b)\n+}\n+\n+ENTRY main {\n+  p0 = f32[16,256,8,128]{3,2,1,0} parameter(0)\n+  p1 = f32[32,256,2,128]{3,2,1,0} parameter(1)\n+  p2 = f32[16,8,128,256]{3,2,1,0} parameter(2)\n+  p3 = f32[32,256,3072]{2,1,0} parameter(3)\n+  p4 = f32[16,3072,256]{2,1,0} parameter(4)\n+  p5 = f32[66,1024]{1,0} parameter(5)\n+  p6 = f32[2,32768,256]{2,1,0} parameter(6)\n+  r0 = f32[16,256,8,128]{3,2,1,0} all-reduce(p0), channel_id=1, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  r1 = f32[32,256,2,128]{3,2,1,0} all-reduce(p1), channel_id=2, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  r2 = f32[16,8,128,256]{3,2,1,0} all-reduce(p2), channel_id=3, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  r3 = f32[32,256,3072]{2,1,0} all-reduce(p3), channel_id=4, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  r4 = f32[16,3072,256]{2,1,0} all-reduce(p4), channel_id=5, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  r5 = f32[66,1024]{1,0} all-reduce(p5), channel_id=6, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  r6 = f32[2,32768,256]{2,1,0} all-reduce(p6), channel_id=7, replica_groups={{0,1,2,3}}, use_global_device_ids=true, to_apply=add\n+  ROOT tuple = tuple(r0, r1, r2, r3, r4, r5, r6)\n+}\n+)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto module,\n+                          ParseAndReturnVerifiedModule(kHloString));\n+  EXPECT_THAT(RunCombiner(module.get()), absl_testing::IsOkAndHolds(true));\n+\n+  constexpr absl::string_view kExpected = R\"('\n+    // CHECK:      ENTRY\n+    // CHECK-DAG:  %[[P0:.*]] = parameter(0)\n+    // CHECK-DAG:  %[[P1:.*]] = parameter(1)\n+    // CHECK-DAG:  %[[P2:.*]] = parameter(2)\n+    // CHECK-DAG:  %[[P3:.*]] = parameter(3)\n+    // CHECK-DAG:  %[[P4:.*]] = parameter(4)\n+    // CHECK-DAG:  %[[P5:.*]] = parameter(5)\n+    // CHECK-DAG:  %[[P6:.*]] = parameter(6)\n+    // CHECK:      all-reduce(%[[P0]], %[[P1]], %[[P2]], %[[P3]], %[[P4]], %[[P5]], %[[P6]])\n+    // CHECK-SAME: channel_id=1,\n+    // CHECK-SAME: replica_groups={\n+    // CHECK-SAME:   {0,1,2,3}\n+    // CHECK-SAME: },\n+    // CHECK-SAME: use_global_device_ids=true,\n+    // CHECK-SAME: to_apply=%add\n+  )\";\n+\n+  EXPECT_TRUE(*RunFileCheck(\n+      module->ToString(HloPrintOptions()\n+                           .set_print_operand_index_annotation_interval(false)\n+                           .set_print_operand_shape(false)\n+                           .set_print_result_shape(false)),\n+      kExpected));\n+}\n+\n+}  // namespace\n+}  // namespace xla::cpu"
        }
    ],
    "stats": {
        "total": 232,
        "additions": 232,
        "deletions": 0
    }
}