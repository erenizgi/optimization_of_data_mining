{
    "author": "tensorflower-gardener",
    "message": "Reverts 16710c5780ea92f0434d86ce66d48727982eaf2e\n\nPiperOrigin-RevId: 809102428",
    "sha": "88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4",
    "files": [
        {
            "sha": "c5c036c143883061e42c36c8a5a0c093b816ebd4",
            "filename": "third_party/xla/xla/python/ifrt/ir/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2FBUILD?ref=88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4",
            "patch": "@@ -482,6 +482,7 @@ cc_library(\n         \"//xla/python/ifrt/support:module_parsing\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/cleanup\",\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\","
        },
        {
            "sha": "88f8f93d6a8e62ed04045de996d0a7c9a8fffc6b",
            "filename": "third_party/xla/xla/python/ifrt/ir/compiled_ifrt_ir_program.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fifrt%2Fir%2Fcompiled_ifrt_ir_program.cc?ref=88b3581f99a7e0ead0dc2b7a13cff0df6d39adc4",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include <variant>\n #include <vector>\n \n+#include \"absl/cleanup/cleanup.h\"\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n@@ -311,7 +312,9 @@ absl::StatusOr<CompiledIfrtIrProgram> CompiledIfrtIrProgram::Create(\n   }\n \n   mlir::ModuleOp mlir_module = ifrt_ir_program->mlir_module;\n+  // Load the dialects necessary to compile the IFRT IR module.\n   mlir::MLIRContext* context = mlir_module.getContext();\n+  xla::ifrt::support::RegisterMlirDialects(*context);\n \n   // Add the bounded executables to the atom program executable map so that\n   // they can be used by the interpreter\n@@ -335,6 +338,20 @@ absl::StatusOr<CompiledIfrtIrProgram> CompiledIfrtIrProgram::Create(\n                     compile_options->mlir_dump_pass_re,\n                     compile_options->mlir_dump_func_re,\n                     compile_options->mlir_enable_timing);\n+    // We need to ensure that Multithreading is enabled in order to be able\n+    // to dispatch compilations from multiple threads. Otherwise, we would\n+    // trigger data races while printing the ModuleOps for creating the\n+    // compilation cache keys\n+    // (see llvm/llvm-project/mlir/lib/Support/StorageUniquer.cpp).\n+    // JAX currently disables Multithreading for all contexts, but temporarily\n+    // enabling multithreading here is safe because the context is not shared\n+    // across JAX ModuleOps.\n+    bool wasMultithreaded = context->isMultithreadingEnabled();\n+    context->enableMultithreading(true);\n+    absl::Cleanup reset_multithreading = [&]() {\n+      context->enableMultithreading(wasMultithreaded);\n+    };\n+\n     xla::ifrt::IfrtToOutlinedAtomProgramsPipelineOptions\n         outline_pipeline_options;\n     outline_pipeline_options.propagate_shardings ="
        }
    ],
    "stats": {
        "total": 18,
        "additions": 18,
        "deletions": 0
    }
}