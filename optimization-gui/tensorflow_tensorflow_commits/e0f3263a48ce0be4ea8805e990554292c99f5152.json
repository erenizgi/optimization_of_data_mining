{
    "author": "GleasonK",
    "message": "[StableHLO Builder] Add API to set frontend attributes\n\nPiperOrigin-RevId: 820455957",
    "sha": "e0f3263a48ce0be4ea8805e990554292c99f5152",
    "files": [
        {
            "sha": "91923cfc56a70c9c6b1a5a2f4f8d43004bc910df",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 123,
            "deletions": 0,
            "changes": 123,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e0f3263a48ce0be4ea8805e990554292c99f5152/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e0f3263a48ce0be4ea8805e990554292c99f5152/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=e0f3263a48ce0be4ea8805e990554292c99f5152",
            "patch": "@@ -640,6 +640,71 @@ diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/MlirBuilderTest.cpp b/\n  #include \"llvm/Support/raw_ostream.h\"\n  #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n  #include \"mlir/IR/BuiltinOps.h\"\n+diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.cpp b/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.cpp\n+--- stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.cpp\n++++ stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.cpp\n+@@ -29,9 +29,35 @@\n+ #include \"stablehlo/dialect/TypeInference.h\"\n+ #include \"stablehlo/integrations/cpp/builder/AttrTypeBuilderUtil.h\"\n+ #include \"stablehlo/integrations/cpp/builder/MlirBuilder.h\"\n++#include \"third_party/llvm/llvm-project/mlir/include/mlir/IR/Attributes.h\"\n+ \n+ namespace mlir {\n+ namespace stablehlo {\n++\n++///////////////\n++// Dialect Helpers\n++///////////////\n++\n++MlirOp AttachFrontendAttribute(MlirBuilder& builder, MlirOp op, StringRef name,\n++                               Attribute value) {\n++  constexpr char kFrontendAttrName[] = \"mhlo.frontend_attributes\";\n++  Operation* mlirOp = unwrap(op).getDefiningOp();\n++  SmallVector<NamedAttribute> attrs;\n++  DictionaryAttr frontendAttr =\n++      mlirOp->getAttrOfType<DictionaryAttr>(kFrontendAttrName);\n++  if (frontendAttr) {\n++    for (NamedAttribute attr : frontendAttr.getValue()) {\n++      // Populate all non-conflicting names.\n++      if (attr.getName() != name) {\n++        attrs.push_back(attr);\n++      }\n++    }\n++  }\n++  attrs.emplace_back(name, value);\n++  mlirOp->setAttr(kFrontendAttrName,\n++                  DictionaryAttr::get(&builder.getContext(), attrs));\n++  return op;\n++}\n+ \n+ /////////////////\n+ // MANUAL APIs\n+diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.h b/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.h\n+--- stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.h\n++++ stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilder.h\n+@@ -27,9 +27,22 @@\n+ #include \"stablehlo/dialect/StablehloOps.h\"\n+ #include \"stablehlo/integrations/cpp/builder/AttrTypeBuilderUtil.h\"\n+ #include \"stablehlo/integrations/cpp/builder/MlirBuilder.h\"\n++#include \"third_party/llvm/llvm-project/mlir/include/mlir/IR/Attributes.h\"\n+ \n+ namespace mlir {\n+ namespace stablehlo {\n++\n++///////////////\n++// Dialect Helpers\n++///////////////\n++\n++// Appends or overwrites an entry in the `mhlo.frontend_attributes` attribute\n++//\n++// of the given op.\n++// Ex:\n++//   stablehlo.abs %0 { mhlo.frontend_attributes = { \"foo\" = 123 } }\n++MlirOp AttachFrontendAttribute(MlirBuilder& builder, MlirOp op, StringRef name,\n++                               Attribute value);\n+ \n+ /////////////////\n+ // MANUAL APIs\n diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp b/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp\n --- stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp\n +++ stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp\n@@ -652,6 +717,64 @@ diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.c\n  #include \"mlir/IR/BuiltinAttributes.h\"\n  #include \"mlir/IR/BuiltinOps.h\"\n  #include \"mlir/IR/DialectRegistry.h\"\n+@@ -1592,5 +1592,57 @@\n+   EXPECT_EQ(expected, debugString(*module));\n+ }\n+ \n++TEST(MlirBuilderTest, FrontendAttributesAppend) {\n++  std::string expected = R\"mlir(module {\n++  func.func @main(%arg0: tensor<2xf32>) -> tensor<2xf32> {\n++    %0 = stablehlo.exponential %arg0 {mhlo.frontend_attributes = {bar = \"hello\", foo = 123 : i32}} : tensor<2xf32>\n++    return %0 : tensor<2xf32>\n++  }\n++})mlir\";\n++\n++  StablehloModuleBuilder mb;\n++  {\n++    Location funcLoc = fileLineColLoc(mb->getContext(), \"main.mlir\", 1, 1);\n++    func::FunctionBuilder fb(mb.get(), \"main\", funcLoc);\n++    auto type = makeTensorType(fb.getContext(), {2}, ElementType::F32);\n++    auto arg0 = func::Argument(fb, type);\n++    auto exp = Exp(arg0);\n++    stablehlo::AttachFrontendAttribute(\n++        fb, exp, \"foo\", fb.getOpBuilder().getI32IntegerAttr(123));\n++    stablehlo::AttachFrontendAttribute(\n++        fb, exp, \"bar\", fb.getOpBuilder().getStringAttr(\"hello\"));\n++    func::Return(fb, {exp});\n++  }\n++\n++  OwningOpRef<ModuleOp> module = mb->build();\n++  EXPECT_EQ(expected, debugString(*module));\n++}\n++\n++TEST(MlirBuilderTest, FrontendAttributesOverwrite) {\n++  std::string expected = R\"mlir(module {\n++  func.func @main(%arg0: tensor<2xf32>) -> tensor<2xf32> {\n++    %0 = stablehlo.exponential %arg0 {mhlo.frontend_attributes = {foo = 456 : i32}} : tensor<2xf32>\n++    return %0 : tensor<2xf32>\n++  }\n++})mlir\";\n++\n++  StablehloModuleBuilder mb;\n++  {\n++    Location funcLoc = fileLineColLoc(mb->getContext(), \"main.mlir\", 1, 1);\n++    func::FunctionBuilder fb(mb.get(), \"main\", funcLoc);\n++    auto type = makeTensorType(fb.getContext(), {2}, ElementType::F32);\n++    auto arg0 = func::Argument(fb, type);\n++    auto exp = Exp(arg0);\n++    stablehlo::AttachFrontendAttribute(\n++        fb, exp, \"foo\", fb.getOpBuilder().getI32IntegerAttr(123));\n++    stablehlo::AttachFrontendAttribute(\n++        fb, exp, \"foo\", fb.getOpBuilder().getI32IntegerAttr(456));\n++    func::Return(fb, {exp});\n++  }\n++\n++  OwningOpRef<ModuleOp> module = mb->build();\n++  EXPECT_EQ(expected, debugString(*module));\n++}\n++\n+ }  // namespace stablehlo\n+ }  // namespace mlir\n diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir b/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n --- stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir\n +++ stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.mlir"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 123,
        "deletions": 0
    }
}