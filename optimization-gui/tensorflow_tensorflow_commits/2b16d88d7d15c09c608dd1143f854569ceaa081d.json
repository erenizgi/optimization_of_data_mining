{
    "author": "dubstack",
    "message": "Update Error Status Factory methods capture source location.\n\nPiperOrigin-RevId: 814820363",
    "sha": "2b16d88d7d15c09c608dd1143f854569ceaa081d",
    "files": [
        {
            "sha": "96cf5e14ec66790b881e62856607f721596b9826",
            "filename": "third_party/xla/xla/error/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2b16d88d7d15c09c608dd1143f854569ceaa081d/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2b16d88d7d15c09c608dd1143f854569ceaa081d/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2FBUILD?ref=2b16d88d7d15c09c608dd1143f854569ceaa081d",
            "patch": "@@ -1,4 +1,5 @@\n load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n+load(\"//xla/tsl:tsl.bzl\", \"if_google\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n \n package(\n@@ -14,7 +15,10 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:str_format\",\n-    ],\n+        \"@local_tsl//tsl/platform\",\n+    ] + if_google([\n+        \"@com_google_absl//absl/types:source_location\",\n+    ]),\n )\n \n xla_cc_test(\n@@ -26,6 +30,7 @@ xla_cc_test(\n         \"//xla/tsl/platform:debug_me_context\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform\",\n     ],\n )\n "
        },
        {
            "sha": "de348666b8b4734fc76542446c34aba5055632c8",
            "filename": "third_party/xla/xla/error/error_codes.h",
            "status": "modified",
            "additions": 81,
            "deletions": 17,
            "changes": 98,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2b16d88d7d15c09c608dd1143f854569ceaa081d/third_party%2Fxla%2Fxla%2Ferror%2Ferror_codes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2b16d88d7d15c09c608dd1143f854569ceaa081d/third_party%2Fxla%2Fxla%2Ferror%2Ferror_codes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ferror_codes.h?ref=2b16d88d7d15c09c608dd1143f854569ceaa081d",
            "patch": "@@ -17,12 +17,18 @@ limitations under the License.\n #define XLA_ERROR_ERROR_CODES_H_\n \n #include <string>\n+#include <utility>\n \n #include \"absl/status/status.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/error/debug_me_context_util.h\"\n+#include \"tsl/platform/platform.h\"\n+\n+#if defined(PLATFORM_GOOGLE)\n+#include \"absl/types/source_location.h\"\n+#endif  // PLATFORM_GOOGLE\n \n namespace xla::error {\n \n@@ -146,25 +152,83 @@ inline std::string GetErrorUrl(ErrorCode code) {\n                       ErrorCodeToStringIdentifier(code));\n }\n \n-// === ErrorCode specific absl::Status factory functions ===\n-// Automatically generates a factory function for each error code\n-// to easily create a properly formatted absl::Status object.\n-// e.g. can be used as:\n-// error::InvalidArgument(\"Compilation failed with error: %s\", my_message);\n-#define DEFINE_ERROR_FACTORY_FUNCTION(string_id, enum_name, status_code) \\\n-  template <typename... Args>                                            \\\n-  inline absl::Status enum_name(const absl::FormatSpec<Args...>& format, \\\n-                                const Args&... args) {                   \\\n-    auto status = absl::Status(                                          \\\n-        status_code,                                                     \\\n-        absl::StrCat(GetErrorCodeAndName(ErrorCode::k##enum_name), \": \", \\\n-                     absl::StrFormat(format, args...), \"\\n\",             \\\n-                     GetErrorUrl(ErrorCode::k##enum_name)));             \\\n-    error::AttachDebugMeContextPayload(status);                          \\\n-    return status;                                                       \\\n-  }\n+// The following three macros implement a factory pattern for creating\n+// absl::Status objects. This pattern is necessary to reliably capture the\n+// caller's source location while supporting variadic arguments.\n+//\n+// It is split into three parts (PREFIX, SUFFIX, and the main macro) for\n+// modularity and readability - separating the boilerplate of the\n+// struct definition from the implementation of its constructor.\n+#define DEFINE_ERROR_FACTORY_FUNCTION_PREFIX(enum_name) \\\n+  template <typename... Args>                           \\\n+  struct enum_name {                                    \\\n+    absl::Status status;\n+\n+// The SUFFIX macro defines the end of the error-generating struct. It provides\n+// A class template deduction guide (CTAD), which is essential for making the\n+// factory's calling syntax work. It tells the compiler how to deduce the\n+// template arguments `Args...` from the constructor call.\n+#define DEFINE_ERROR_FACTORY_FUNCTION_SUFFIX(enum_name)                       \\\n+  /* NOLINTNEXTLINE(google-explicit-constructor) */                           \\\n+  operator absl::Status() const& { return status; }                           \\\n+  operator absl::Status() && { return std::move(status); }                    \\\n+  }                                                                           \\\n+  ;                                                                           \\\n+  /* Deduction guide to make variadic arguments play nice with the default */ \\\n+  /* absl::SourceLocation argument. */                                        \\\n+  template <typename... Args>                                                 \\\n+  enum_name(const absl::FormatSpec<Args...>&, Args&&...)                      \\\n+      -> enum_name<Args...>;\n+\n+// Main macro that generates a status factory function for each error code that\n+// can be used to create an absl::Status object with an error code and a\n+// formatted error message. Additionally attaches a payload with DebugMeContext\n+// details if present. e.g. can be used as: error::InvalidArgument(\"Compilation\n+// failed with error: %s\", my_message);\n+#if defined(PLATFORM_GOOGLE)\n+// This version captures the caller's source location and attaches it to the\n+// absl::Status object on platforms that support it.\n+#define DEFINE_ERROR_FACTORY_FUNCTION(string_id, enum_name, status_code)      \\\n+  DEFINE_ERROR_FACTORY_FUNCTION_PREFIX(enum_name)                             \\\n+  /* NOLINTNEXTLINE(google-explicit-constructor) */                           \\\n+  enum_name(const absl::FormatSpec<Args...>& format, Args&&... args,          \\\n+            absl::SourceLocation location = absl::SourceLocation::current())  \\\n+      : status([&] {                                                          \\\n+          auto s = absl::Status(                                              \\\n+              status_code,                                                    \\\n+              absl::StrCat(                                                   \\\n+                  GetErrorCodeAndName(ErrorCode::k##enum_name), \": \",         \\\n+                  absl::StrFormat(format, std::forward<Args>(args)...), \"\\n\", \\\n+                  GetErrorUrl(ErrorCode::k##enum_name)),                      \\\n+              location);                                                      \\\n+          error::AttachDebugMeContextPayload(s);                              \\\n+          return s;                                                           \\\n+        }()) {}                                                               \\\n+  DEFINE_ERROR_FACTORY_FUNCTION_SUFFIX(enum_name)\n+#else  // !PLATFORM_GOOGLE\n+// Absl::SourceLocation is not yet open-source. This version does NOT capture\n+// the source location.\n+#define DEFINE_ERROR_FACTORY_FUNCTION(string_id, enum_name, status_code)      \\\n+  DEFINE_ERROR_FACTORY_FUNCTION_PREFIX(enum_name)                             \\\n+  /* NOLINTNEXTLINE(google-explicit-constructor) */                           \\\n+  enum_name(const absl::FormatSpec<Args...>& format, Args&&... args)          \\\n+      : status([&] {                                                          \\\n+          auto s = absl::Status(                                              \\\n+              status_code,                                                    \\\n+              absl::StrCat(                                                   \\\n+                  GetErrorCodeAndName(ErrorCode::k##enum_name), \": \",         \\\n+                  absl::StrFormat(format, std::forward<Args>(args)...), \"\\n\", \\\n+                  GetErrorUrl(ErrorCode::k##enum_name)));                     \\\n+          error::AttachDebugMeContextPayload(s);                              \\\n+          return s;                                                           \\\n+        }()) {}                                                               \\\n+  DEFINE_ERROR_FACTORY_FUNCTION_SUFFIX(enum_name)\n+#endif  // PLATFORM_GOOGLE\n \n XLA_ERROR_CODE_LIST(DEFINE_ERROR_FACTORY_FUNCTION)\n+\n+#undef DEFINE_ERROR_FACTORY_FUNCTION_PREFIX\n+#undef DEFINE_ERROR_FACTORY_FUNCTION_SUFFIX\n #undef DEFINE_ERROR_FACTORY_FUNCTION\n \n }  // namespace xla::error"
        },
        {
            "sha": "748ca81fb7acf557c4674ef9206b17684ee96673",
            "filename": "third_party/xla/xla/error/error_codes_test.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2b16d88d7d15c09c608dd1143f854569ceaa081d/third_party%2Fxla%2Fxla%2Ferror%2Ferror_codes_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2b16d88d7d15c09c608dd1143f854569ceaa081d/third_party%2Fxla%2Fxla%2Ferror%2Ferror_codes_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ferror_codes_test.cc?ref=2b16d88d7d15c09c608dd1143f854569ceaa081d",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"xla/error/debug_me_context_util.h\"\n #include \"xla/tsl/platform/debug_me_context.h\"\n+#include \"tsl/platform/platform.h\"\n \n namespace xla::error {\n namespace {\n@@ -51,18 +52,38 @@ TEST(ErrorCodesTest, GetErrorUrl) {\n   EXPECT_EQ(GetErrorUrl(kTestCode), \"https://openxla.org/xla/errors/E0002\");\n }\n \n-TEST(ErrorCodesTest, FactoryFunction) {\n+TEST(ErrorCodesTest, FactoryFunctionWithNoArgs) {\n+  // Test one of the generated factory functions.\n+  absl::Status status = InvalidArgument(\"My Test error\");\n+\n+  // Check the absl::StatusCode defined in the macro.\n+  EXPECT_EQ(status.code(), absl::StatusCode::kInvalidArgument);\n+  // Check the full formatted error message.\n+  EXPECT_EQ(status.message(),\n+            \"E0002: InvalidArgument: My Test \"\n+            \"error\\nhttps://openxla.org/xla/errors/E0002\");\n+#if defined(PLATFORM_GOOGLE)\n+  auto location = status.GetSourceLocations().front();\n+  EXPECT_THAT(location.file_name(), testing::EndsWith(\"error_codes_test.cc\"));\n+#endif  // PLATFORM_GOOGLE\n+}\n+\n+TEST(ErrorCodesTest, FactoryFunctionWithArgs) {\n   // Test one of the generated factory functions.\n   std::string detail = \"Something was wrong\";\n   absl::Status status = InvalidArgument(\"Test error: %s\", detail);\n \n   // Check the absl::StatusCode defined in the macro.\n   EXPECT_EQ(status.code(), absl::StatusCode::kInvalidArgument);\n-\n   // Check the full formatted error message.\n   EXPECT_EQ(status.message(),\n             \"E0002: InvalidArgument: Test error: Something was \"\n             \"wrong\\nhttps://openxla.org/xla/errors/E0002\");\n+\n+#if defined(PLATFORM_GOOGLE)\n+  auto location = status.GetSourceLocations().front();\n+  EXPECT_THAT(location.file_name(), testing::EndsWith(\"error_codes_test.cc\"));\n+#endif  // PLATFORM_GOOGLE\n }\n \n TEST(ErrorCodesTest, FactoryFunctionNoDebugPayloadIfContextIsEmpty) {"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 110,
        "deletions": 20
    }
}