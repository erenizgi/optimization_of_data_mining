{
    "author": "WillFroom",
    "message": "[XLA:GPU] Add CreateSafeIntegerArithmeticPass to lowering pass.\n\nPiperOrigin-RevId: 838680555",
    "sha": "d5f86991fef36e22bf482bb527acf1b7b990842b",
    "files": [
        {
            "sha": "b23a7dfe498e48e7a5d49c9a39e43a6588955c55",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/compilation_pipeline.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5f86991fef36e22bf482bb527acf1b7b990842b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fcompilation_pipeline.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5f86991fef36e22bf482bb527acf1b7b990842b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fcompilation_pipeline.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Fcompilation_pipeline.cc?ref=d5f86991fef36e22bf482bb527acf1b7b990842b",
            "patch": "@@ -39,6 +39,8 @@ void CreateTritonXlaPipeline(\n   pm->addPass(mlir::triton::xla::CreateTritonXLALowerXTilePass());\n   pm->addPass(mlir::triton::xla::CreateStableHLOLowerToTritonPass());\n \n+  pm->addPass(emitters::CreateSafeIntegerArithmeticPass());\n+\n   auto* cuda_cc = gpu_cc.cuda_compute_capability();\n   bool is_at_least_hopper = cuda_cc != nullptr && cuda_cc->IsAtLeastHopper();\n "
        },
        {
            "sha": "fc02b658b1c6075a1f425da15bacc0847680e5a1",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/fusion_emitter_device_test.cc",
            "status": "modified",
            "additions": 108,
            "deletions": 0,
            "changes": 108,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d5f86991fef36e22bf482bb527acf1b7b990842b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d5f86991fef36e22bf482bb527acf1b7b990842b/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ffusion_emitter_device_test.cc?ref=d5f86991fef36e22bf482bb527acf1b7b990842b",
            "patch": "@@ -310,6 +310,114 @@ ENTRY entry_computation {\n   EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n }\n \n+TEST_F(TritonEmitterTest, DivByZeroIsEmittedCorrectly) {\n+  constexpr absl::string_view kHloText = R\"(\n+HloModule m\n+\n+fused_div {\n+  param_0 = s32[] parameter(0)\n+  param_1 = s32[] parameter(1)\n+  ROOT div = s32[] divide(param_0, param_1)\n+}\n+\n+ENTRY main {\n+  numerator = s32[] constant(10)\n+  denominator = s32[] constant(0)\n+  ROOT div = s32[] fusion(numerator, denominator), kind=kCustom, calls=fused_div,\n+    backend_config={\"fusion_backend_config\":{\n+      \"kind\":\"__triton\",\n+      \"block_level_fusion_config\":{\n+        \"num_warps\":\"1\",\"output_tiles\":[{\"sizes\":[]}],\n+        \"num_ctas\":1,\"num_stages\":1,\"is_tma_allowed\":false}}}\n+}\n+)\";\n+  TF_EXPECT_OK(CreateTritonIrAndFileCheck(this, kHloText, \"fused_div\", R\"(\n+CHECK-NOT: arith.constant\n+CHECK: arith.divsi {{.*}} : i32\n+)\"));\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n+}\n+\n+TEST_F(TritonEmitterTest, DivConstantDenominatorByZeroIsEmittedCorrectly) {\n+  constexpr absl::string_view kHloText = R\"(\n+HloModule m\n+\n+fused_div {\n+  param_0 = s32[] parameter(0)\n+  denominator = s32[] constant(0)\n+  ROOT div = s32[] divide(param_0, denominator)\n+}\n+\n+ENTRY main {\n+  numerator = s32[] constant(10)\n+  ROOT div = s32[] fusion(numerator), kind=kCustom, calls=fused_div,\n+    backend_config={\"fusion_backend_config\":{\n+      \"kind\":\"__triton\",\n+      \"block_level_fusion_config\":{\n+        \"num_warps\":\"1\",\"output_tiles\":[{\"sizes\":[]}],\n+        \"num_ctas\":1,\"num_stages\":1,\"is_tma_allowed\":false}}}\n+}\n+)\";\n+  TF_EXPECT_OK(CreateTritonIrAndFileCheck(this, kHloText, \"fused_div\", R\"(\n+CHECK-COUNT-1: arith.constant\n+CHECK: arith.divsi {{.*}} : i32\n+)\"));\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n+}\n+\n+TEST_F(TritonEmitterTest, DivConstantsByZeroIsEmittedCorrectly) {\n+  constexpr absl::string_view kHloText = R\"(\n+HloModule m\n+\n+fused_div {\n+  numerator = s32[] constant(10)\n+  denominator = s32[] constant(0)\n+  ROOT div = s32[] divide(numerator, denominator)\n+}\n+\n+ENTRY main {\n+  ROOT div = s32[] fusion(), kind=kCustom, calls=fused_div,\n+    backend_config={\"fusion_backend_config\":{\n+      \"kind\":\"__triton\",\n+      \"block_level_fusion_config\":{\n+        \"num_warps\":\"1\",\"output_tiles\":[{\"sizes\":[]}],\n+        \"num_ctas\":1,\"num_stages\":1,\"is_tma_allowed\":false}}}\n+}\n+)\";\n+  TF_EXPECT_OK(CreateTritonIrAndFileCheck(this, kHloText, \"fused_div\", R\"(\n+CHECK-COUNT-2: arith.constant\n+CHECK: arith.divsi {{.*}} : i32\n+)\"));\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n+}\n+\n+TEST_F(TritonEmitterTest, DivOverflowIsEmittedCorrectly) {\n+  constexpr absl::string_view kHloText = R\"(\n+HloModule m\n+\n+fused_div {\n+  param_0 = s32[] parameter(0)\n+  param_1 = s32[] parameter(1)\n+  ROOT div = s32[] divide(param_0, param_1)\n+}\n+\n+ENTRY main {\n+  int_min = s32[] constant(-2147483648)\n+  denominator = s32[] constant(-1)\n+  ROOT div = s32[] fusion(int_min, denominator), kind=kCustom, calls=fused_div,\n+    backend_config={\"fusion_backend_config\":{\n+      \"kind\":\"__triton\",\n+      \"block_level_fusion_config\":{\n+        \"num_warps\":\"1\",\"output_tiles\":[{\"sizes\":[]}],\n+        \"num_ctas\":1,\"num_stages\":1,\"is_tma_allowed\":false}}}\n+}\n+)\";\n+  TF_EXPECT_OK(CreateTritonIrAndFileCheck(this, kHloText, \"fused_div\", R\"(\n+CHECK: arith.divsi {{.*}} : i32\n+)\"));\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(kHloText, kExactMatch));\n+}\n+\n TEST_F(TritonEmitterTest, ReductionOnMinormostAxisIsEmittedCorrectly) {\n   constexpr absl::string_view kHloText = R\"(\n HloModule m"
        }
    ],
    "stats": {
        "total": 110,
        "additions": 110,
        "deletions": 0
    }
}