{
    "author": "hyeontaek",
    "message": "[JAX] Refresh a custom layout if a buffer is copied across clients or memories\n\nThis change retrieves a new custom layout if a buffer is copied across PjRt clients or memory spaces because the detail of the buffer layout often changes (e.g., tiling is added if a buffer is copied from a CPU client to a TPU client).\n\nWithout this change, the newly added test would fail with an error: `AssertionError: Layou[14 chars]or=(1, 0), tiling=(), sub_byte_element_size_in_bits=0) != Layou[14 chars]or=(1, 0), tiling=((8, 128),), sub_byte_element_size_in_bits=0)`\n\nPiperOrigin-RevId: 846472304",
    "sha": "46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a",
    "files": [
        {
            "sha": "ac9bc1ace446ad2995454ab7d73190c56184b0ea",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_array.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_array.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_array.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_array.cc?ref=46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a",
            "patch": "@@ -550,15 +550,15 @@ absl::StatusOr<ArrayRef> PjRtArray::Copy(\n   if (new_client == nullptr) {\n     new_client = client_;\n   }\n-  std::shared_ptr<const xla::PjRtLayout> layout;\n-  static MemoryKind kUnpinnedHostMemoryKind(UnpinnedHostMemorySpace::kKind);\n-  // Unpinned host supports default layouts only; a custom layout would be\n-  // ignored.\n-  // TODO(hyeontaek): This behavior should be informed by the underlying PjRt\n-  // client instead of following a convention.\n-  if (layout_ != nullptr &&\n-      canonicalized_sharding_memory_kind != kUnpinnedHostMemoryKind) {\n-    layout = layout_;\n+  std::shared_ptr<const xla::PjRtLayout> layout = layout_;\n+  // If a copy has happened across clients or across different memory spaces,\n+  // the layout of a new buffer may be different from that of the original\n+  // buffer. Refreshing the custom layout using the new buffer layout makes sure\n+  // that `PjRtArray` tracks a valid custom layout.\n+  if (layout != nullptr &&\n+      (client_ != new_client ||\n+       sharding_->memory_kind() != canonicalized_sharding_memory_kind)) {\n+    layout = buffers.front()->layout();\n   }\n   return std::visit(\n       [this, new_client, &new_sharding, &buffers,"
        },
        {
            "sha": "96eadc39b1eeb26bddb23620f3a28bfbfa7bbbba",
            "filename": "third_party/xla/xla/python/version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h?ref=46f4c9ab9f8d71faa9f9f86b69868236c65d5c6a",
            "patch": "@@ -19,6 +19,6 @@ limitations under the License.\n // An increasing version number to protect jax code against breaking changes.\n // In JAX, reference this via jax._src.lib.ifrt_version.\n #define JAX_IFRT_VERSION_NUMBER \\\n-  44  // xla::ifrt::Device has a new PlatformName() API.\n+  45  // Refresh custom layouts when copying an array across clients.\n \n #endif  // XLA_PYTHON_VERSION_H_"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 10,
        "deletions": 10
    }
}