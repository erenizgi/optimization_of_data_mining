{
    "author": "mrguenther",
    "message": "Don't translate StableHLO to MHLO when serving saved models.\n\nPiperOrigin-RevId: 835399512",
    "sha": "4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1",
    "files": [
        {
            "sha": "bb50d530484b10e077eb276b5336e9b9c63a3279",
            "filename": "tensorflow/compiler/tf2xla/kernels/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1/tensorflow%2Fcompiler%2Ftf2xla%2Fkernels%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1/tensorflow%2Fcompiler%2Ftf2xla%2Fkernels%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Ftf2xla%2Fkernels%2FBUILD?ref=4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1",
            "patch": "@@ -371,7 +371,6 @@ cc_library(\n         \"@local_xla//xla/hlo/translate:stablehlo\",\n         \"@local_xla//xla/mlir/utils:error_util\",\n         \"@local_xla//xla/mlir/utils:type_util\",\n-        \"@local_xla//xla/mlir_hlo:mhlo_passes\",\n         \"@local_xla//xla/python:refine_polymorphic_shapes\",\n         \"@local_xla//xla/service:hlo_proto_cc\",\n         \"@local_xla//xla/service/spmd/shardy/sdy_round_trip:pipelines\",\n@@ -382,6 +381,7 @@ cc_library(\n         \"@stablehlo//:chlo_ops\",\n         \"@stablehlo//:stablehlo_ops\",\n         \"@stablehlo//:stablehlo_passes\",\n+        \"@stablehlo//:stablehlo_passes_optimization\",\n         \"@stablehlo//:stablehlo_serialization\",\n         \"@stablehlo//:vhlo_ops\",\n     ],"
        },
        {
            "sha": "1ac01a4c172cfe030124d4fabdb08dcae4de235a",
            "filename": "tensorflow/compiler/tf2xla/kernels/xla_call_module_loader.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 17,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1/tensorflow%2Fcompiler%2Ftf2xla%2Fkernels%2Fxla_call_module_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1/tensorflow%2Fcompiler%2Ftf2xla%2Fkernels%2Fxla_call_module_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Ftf2xla%2Fkernels%2Fxla_call_module_loader.cc?ref=4ccc0c9ec3413c3097c049c4e54f9ed29bbc77c1",
            "patch": "@@ -61,13 +61,13 @@ limitations under the License.\n #include \"stablehlo/dialect/StablehloOps.h\"  // from @stablehlo\n #include \"stablehlo/dialect/VhloOps.h\"  // from @stablehlo\n #include \"stablehlo/transforms/StablehloRefineShapes.h\"  // from @stablehlo\n+#include \"stablehlo/transforms/optimization/Passes.h\"  // from @stablehlo\n #include \"tensorflow/compiler/jit/flags.h\"\n #include \"tensorflow/compiler/mlir/tensorflow/utils/dump_mlir_util.h\"\n #include \"tensorflow/compiler/mlir/tensorflow/utils/error_util.h\"\n #include \"xla/hlo/builder/xla_computation.h\"\n #include \"xla/hlo/translate/stablehlo.h\"\n #include \"xla/mlir/utils/type_util.h\"\n-#include \"xla/mlir_hlo/mhlo/transforms/passes.h\"\n #include \"xla/python/refine_polymorphic_shapes.h\"\n #include \"xla/service/hlo.pb.h\"\n #include \"xla/service/spmd/shardy/sdy_round_trip/pipelines.h\"\n@@ -121,7 +121,7 @@ bool IsTokenType(mlir::Type type) {\n }\n \n absl::StatusOr<std::unique_ptr<XlaCallModuleLoader>>\n-XlaCallModuleLoader::Create(mlir::MLIRContext *context, int version,\n+XlaCallModuleLoader::Create(mlir::MLIRContext* context, int version,\n                             mlir::StringRef module_str,\n                             std::vector<std::string> disabled_checks,\n                             std::vector<std::string> platforms,\n@@ -165,7 +165,7 @@ absl::Status XlaCallModuleLoader::SetPlatformIndex(\n   if (platform_index < 0) return absl::OkStatus();\n   VLOG(3) << \"XlaCallModule setting the platform_index to \" << platform_index\n           << \" for platform \" << compilation_platform << \".\";\n-  mlir::Block &main_body = main_.front();\n+  mlir::Block& main_body = main_.front();\n \n   if (main_.getNumArguments() < 1) {\n     return absl::InvalidArgumentError(absl::StrCat(\n@@ -241,19 +241,19 @@ absl::Status XlaCallModuleLoader::RefineDynamicShapes(\n         \" non-token and non-platform-index arguments. The input \",\n         \"shapes are (\",\n         absl::StrJoin(input_shapes, \", \",\n-                      [](std::string *out, const xla::Shape &s) {\n+                      [](std::string* out, const xla::Shape& s) {\n                         absl::StrAppend(out, s.ToString());\n                       }),\n         \") and the main function argument types are \",\n         absl::StrJoin(InputTypes(), \", \",\n-                      [](std::string *out, const mlir::Type &t) {\n+                      [](std::string* out, const mlir::Type& t) {\n                         absl::StrAppend(out, mlir::debugString(t));\n                       }),\n         \")\"));\n   }\n \n   // Derive static input types to use for main.\n-  mlir::Block &main_body = main_.front();\n+  mlir::Block& main_body = main_.front();\n   mlir::Builder builder(module_->getContext());\n   std::vector<mlir::Type> static_array_input_types(nr_inputs);\n   int next_actual_input = 0;\n@@ -272,7 +272,7 @@ absl::Status XlaCallModuleLoader::RefineDynamicShapes(\n     }\n \n     // Get static MLIR Type from xla Shape.\n-    const xla::Shape &xla_shape = input_shapes[next_actual_input++];\n+    const xla::Shape& xla_shape = input_shapes[next_actual_input++];\n     std::vector<int64_t> xla_dimensions;\n     if (xla_shape.IsArray()) {\n       xla_dimensions = std::vector<int64_t>(xla_shape.dimensions().begin(),\n@@ -370,7 +370,7 @@ absl::Status XlaCallModuleLoader::RefineDynamicShapes(\n }\n \n absl::Status XlaCallModuleLoader::LoadModule(\n-    mlir::MLIRContext *context, int version, mlir::StringRef module_str,\n+    mlir::MLIRContext* context, int version, mlir::StringRef module_str,\n     std::vector<std::string> disabled_checks,\n     std::vector<std::string> platforms, int num_invocation_args,\n     bool main_has_token_input_output, bool use_shardy_partitioner) {\n@@ -457,7 +457,7 @@ absl::Status XlaCallModuleLoader::LoadModule(\n     return absl::InvalidArgumentError(\"Cannot find 'main' in module\");\n   }\n \n-  mlir::Block &main_body = main_.front();\n+  mlir::Block& main_body = main_.front();\n \n   int nr_token_arguments = llvm::count_if(InputTypes(), IsTokenType);\n   if (version < kVersionStartSupportEffects) {\n@@ -489,7 +489,7 @@ absl::Status XlaCallModuleLoader::ValidateXlaCallModuleInvariants() {\n   mlir::StatusScopedDiagnosticHandler diag_handler(module_->getContext());\n   bool moduleValidationFailed = false;\n \n-  module_->walk([&](mlir::Operation *op) {\n+  module_->walk([&](mlir::Operation* op) {\n     // StableHLO programs created by jax2tf only contain operations\n     // from Builtin, Func, StableHLO, Shardy dialects.\n     if (!llvm::isa<mlir::BuiltinDialect, mlir::chlo::ChloDialect,\n@@ -526,13 +526,9 @@ absl::Status XlaCallModuleLoader::ValidateStaticShapes() {\n absl::Status XlaCallModuleLoader::PrepareStablehloForLowering() {\n   mlir::StatusScopedDiagnosticHandler diag_handler(module_->getContext());\n \n-  // TODO (b/410057228): Replace MHLO canonicalization with StableHLO.\n-  // This code requires MHLO CaseOp canonicalization to remove unreachable\n-  // branches, else `tf.call_tf_function` inlining can fail.\n   mlir::PassManager pm(module_->getContext());\n-  pm.addPass(mlir::mhlo::createStablehloLegalizeToHloPass());\n-  pm.addNestedPass<mlir::func::FuncOp>(mlir::createCanonicalizerPass());\n-  pm.addPass(mlir::mhlo::createHloLegalizeToStablehloPass());\n+  pm.addNestedPass<mlir::func::FuncOp>(\n+      mlir::stablehlo::createStablehloTargetIndependentOptimizationPass());\n   if (use_shardy_partitioner_) {\n     // We need to export shardings because the lowering path go directly to\n     // HLO but not the MLIR to HLO path that invokes SdyRoundTripExport.\n@@ -543,7 +539,7 @@ absl::Status XlaCallModuleLoader::PrepareStablehloForLowering() {\n \n   if (failed(pm.run(*module_))) {\n     return absl::InternalError(\n-        absl::StrCat(\"MHLO->HLO lowering passes failed: \",\n+        absl::StrCat(\"StableHLO->HLO lowering passes failed: \",\n                      diag_handler.ConsumeStatus().ToString()));\n   }\n "
        }
    ],
    "stats": {
        "total": 32,
        "additions": 14,
        "deletions": 18
    }
}