{
    "author": "hhb",
    "message": "Implement `CreateErrorBuffer` in pjrt c api\n\nPiperOrigin-RevId: 836881069",
    "sha": "dcf61a605a325be9e02c15da5b2417324474b3d4",
    "files": [
        {
            "sha": "9906e9b6698830dc11b2c2ecf25b62e340e98482",
            "filename": "third_party/xla/xla/pjrt/c/CHANGELOG.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2FCHANGELOG.md?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -1,5 +1,9 @@\n # PJRT C API changelog\n \n+## 0.82\n+\n+* Add `PJRT_Client_CreateErrorBuffer`.\n+\n ## 0.81\n \n * Added `PJRT_Layouts_PJRT_Executable_GetOutputLayouts`."
        },
        {
            "sha": "ab3d899ce016b916adb003ba38214c9cb4257b53",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api.h",
            "status": "modified",
            "additions": 31,
            "deletions": 2,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api.h?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -104,7 +104,7 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Extension_Base, next);\n // Changes include:\n // * Adding a new field to the PJRT_Api or argument structs\n // * Renaming a method or argument (doesn't affect ABI)\n-#define PJRT_API_MINOR 81\n+#define PJRT_API_MINOR 82\n \n // The plugin should set the major_version and minor_version of\n // PJRT_Api.pjrt_api_version to be the `PJRT_API_MAJOR` and `PJRT_API_MINOR` in\n@@ -994,6 +994,34 @@ PJRT_DEFINE_STRUCT_TRAITS(PJRT_Client_CreateUninitializedBuffer_Args, buffer);\n typedef PJRT_Error* PJRT_Client_CreateUninitializedBuffer(\n     PJRT_Client_CreateUninitializedBuffer_Args* args);\n \n+struct PJRT_Client_CreateErrorBuffer_Args {\n+  size_t struct_size;\n+  PJRT_Extension_Base* extension_start;\n+  PJRT_Client* client;\n+\n+  // Status fields.\n+  PJRT_Error_Code error_code;\n+  const char* error_message;\n+  size_t error_message_size;\n+\n+  // Shape fields.\n+  const int64_t* shape_dims;\n+  size_t shape_num_dims;\n+  PJRT_Buffer_Type shape_element_type;\n+  PJRT_Buffer_MemoryLayout* shape_layout;\n+\n+  // Destination memory space for the error buffer.\n+  PJRT_Memory* memory;\n+\n+  // Output device buffer. The caller is responsible for calling\n+  // PJRT_Buffer_Destroy.\n+  PJRT_Buffer* buffer;  // out\n+};\n+PJRT_DEFINE_STRUCT_TRAITS(PJRT_Client_CreateErrorBuffer_Args, buffer);\n+\n+typedef PJRT_Error* PJRT_Client_CreateErrorBuffer(\n+    PJRT_Client_CreateErrorBuffer_Args* args);\n+\n struct PJRT_Client_CreateAliasBuffer_Args {\n   size_t struct_size;\n   PJRT_Extension_Base* extension_start;\n@@ -2679,11 +2707,12 @@ typedef struct PJRT_Api {\n   _PJRT_API_STRUCT_FIELD(PJRT_Client_CreateAliasBuffer);\n   _PJRT_API_STRUCT_FIELD(PJRT_Client_FulfillAliasBuffer);\n   _PJRT_API_STRUCT_FIELD(PJRT_LoadedExecutable_GetDeviceAssignment);\n+  _PJRT_API_STRUCT_FIELD(PJRT_Client_CreateErrorBuffer);\n } PJRT_Api;\n \n enum {\n   PJRT_Api_STRUCT_SIZE =\n-      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_LoadedExecutable_GetDeviceAssignment)\n+      PJRT_STRUCT_SIZE(PJRT_Api, PJRT_Client_CreateErrorBuffer)\n };\n \n #undef _PJRT_API_STRUCT_FIELD"
        },
        {
            "sha": "2f17fe4a02a09e4ab3cd5bbe365db2902e5c4d52",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_test.cc?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -945,6 +945,9 @@ FieldOffsetsAndSizesForVersion(int major_version, int minor_version) {\n     if (minor_version >= 79) {\n       add_field(\"PJRT_LoadedExecutable_GetDeviceAssignment\", kFnPtrSize);\n     }\n+    if (minor_version >= 82) {\n+      add_field(\"PJRT_Client_CreateErrorBuffer\", kFnPtrSize);\n+    }\n     return version_offsets_and_sizes;\n   }\n   LOG(FATAL) << \"Unsupported API version: \" << major_version << \".\"\n@@ -1336,6 +1339,9 @@ TEST_F(PjrtCAbiTestBase, FieldOffsetsAndSizes) {\n           {\"PJRT_LoadedExecutable_GetDeviceAssignment\",\n            {offsetof(PJRT_Api, PJRT_LoadedExecutable_GetDeviceAssignment),\n             sizeof(PJRT_Api::PJRT_LoadedExecutable_GetDeviceAssignment)}},\n+          {\"PJRT_Client_CreateErrorBuffer\",\n+           {offsetof(PJRT_Api, PJRT_Client_CreateErrorBuffer),\n+            sizeof(PJRT_Api::PJRT_Client_CreateErrorBuffer)}},\n       };\n   ASSERT_EQ(api_->pjrt_api_version.major_version, PJRT_API_MAJOR);\n   ASSERT_EQ(api_->pjrt_api_version.minor_version, PJRT_API_MINOR);"
        },
        {
            "sha": "a09f325572fb52e372a562df4864f8ba8fb62636",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_wrapper_impl.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_wrapper_impl.cc?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -977,6 +977,29 @@ PJRT_Error* PJRT_Client_CreateUninitializedBuffer(\n   return nullptr;\n }\n \n+PJRT_Error* PJRT_Client_CreateErrorBuffer(\n+    PJRT_Client_CreateErrorBuffer_Args* args) {\n+  PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n+      \"PJRT_Client_CreateErrorBuffer_Args\",\n+      PJRT_Client_CreateErrorBuffer_Args_STRUCT_SIZE, args->struct_size));\n+\n+  absl::Status error = absl::Status(\n+      pjrt::PjrtErrorCodeToStatusCode(args->error_code),\n+      absl::string_view(args->error_message, args->error_message_size));\n+\n+  PJRT_ASSIGN_OR_RETURN(\n+      xla::Shape shape,\n+      pjrt::BuildXlaShapeFromC(args->shape_element_type, args->shape_dims,\n+                               args->shape_num_dims, args->shape_layout));\n+\n+  PJRT_ASSIGN_OR_RETURN(auto error_buffer,\n+                        args->client->client->CreateErrorBuffer(\n+                            error, shape, args->memory->memory_space));\n+\n+  args->buffer = new PJRT_Buffer{std::move(error_buffer), args->client};\n+  return nullptr;\n+}\n+\n PJRT_Error* PJRT_Client_CreateAliasBuffer(\n     PJRT_Client_CreateAliasBuffer_Args* args) {\n   PJRT_RETURN_IF_ERROR(ActualStructSizeIsGreaterOrEqual(\n@@ -3124,6 +3147,8 @@ PJRT_Api CreatePjrtApi(PJRT_Client_Create* create_fn,\n       pjrt::PJRT_Client_FulfillAliasBuffer,\n       /*PJRT_LoadedExecutable_GetDeviceAssignment=*/\n       pjrt::PJRT_LoadedExecutable_GetDeviceAssignment,\n+      /*PJRT_Client_CreateErrorBuffer=*/\n+      pjrt::PJRT_Client_CreateErrorBuffer,\n   };\n }\n "
        },
        {
            "sha": "3653412e29e1c86075eee270f726176d4ab1a4ec",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -611,6 +611,48 @@ PjRtCApiClient::CreateUninitializedBuffer(const Shape& shape,\n   return buffer;\n }\n \n+absl::StatusOr<std::unique_ptr<PjRtBuffer>> PjRtCApiClient::CreateErrorBuffer(\n+    absl::Status error, const Shape& shape, PjRtMemorySpace* memory) {\n+  if (c_api_->pjrt_api_version.major_version == 0 &&\n+      c_api_->pjrt_api_version.minor_version < 82) {\n+    return absl::UnimplementedError(\n+        \"PJRT_Client_CreateErrorBuffer requires PJRT C API version 0.82 or \"\n+        \"higher.\");\n+  }\n+\n+  PJRT_Client_CreateErrorBuffer_Args args;\n+  args.struct_size = PJRT_Client_CreateErrorBuffer_Args_STRUCT_SIZE;\n+  args.extension_start = nullptr;\n+  args.client = c_client_.get();\n+\n+  args.error_code = pjrt::StatusCodeToPjrtErrorCode(error.code());\n+  args.error_message = error.message().data();\n+  args.error_message_size = error.message().size();\n+\n+  args.shape_dims = shape.dimensions().data();\n+  args.shape_num_dims = shape.dimensions().size();\n+  args.shape_element_type = pjrt::ConvertToPjRtBufferType(shape.element_type());\n+\n+  pjrt::BufferMemoryLayoutData c_layout_data;\n+  if (shape.has_layout()) {\n+    TF_ASSIGN_OR_RETURN(c_layout_data,\n+                        pjrt::ConvertToBufferMemoryLayoutData(shape.layout()));\n+    args.shape_layout = &c_layout_data.c_layout;\n+  } else {\n+    args.shape_layout = nullptr;\n+  }\n+\n+  args.memory = tensorflow::down_cast<PjRtCApiMemorySpace*>(memory)->c_memory();\n+\n+  RETURN_STATUS_IF_PJRT_ERROR(c_api_->PJRT_Client_CreateErrorBuffer(&args),\n+                              c_api_);\n+\n+  auto buffer = std::unique_ptr<PjRtBuffer>(\n+      std::make_unique<PjRtCApiBuffer>(this, args.buffer));\n+\n+  return buffer;\n+}\n+\n absl::Status FulfillAliasBuffer(\n     const PJRT_Api* pjrt_c_api, absl::StatusOr<PjRtBuffer*> real_buffer_or,\n     PJRT_FulfillAliasBufferCallback* fulfill_alias_buffer_cb) {"
        },
        {
            "sha": "9cf8cb1f124fc0def8643461e9d0d80e0b3e2cf2",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -386,6 +386,9 @@ class PjRtCApiClient : public PjRtClient {\n       std::pair<std::unique_ptr<PjRtBuffer>, PjRtFulfillAliasBufferCallback>>\n   CreateAliasBuffer(const Shape& shape, PjRtMemorySpace* memory_space) override;\n \n+  absl::StatusOr<std::unique_ptr<PjRtBuffer>> CreateErrorBuffer(\n+      absl::Status error, const Shape& shape, PjRtMemorySpace* memory) override;\n+\n   absl::StatusOr<const PjRtTopologyDescription*> GetTopologyDescription()\n       const override;\n \n@@ -470,6 +473,9 @@ class PjRtCApiClient : public PjRtClient {\n   void InitAttributes();\n   PJRT_Extension_Base* FindExtensionImpl(PJRT_Extension_Type type) const;\n \n+  std::unique_ptr<PJRT_Error, ::pjrt::PJRT_ErrorDeleter> CreatePjRtError(\n+      const absl::Status& error) const;\n+\n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> BufferFromHostBufferInternalImpl(\n       const void* data, PrimitiveType type, absl::Span<int64_t const> dims,\n       std::optional<absl::Span<int64_t const>> byte_strides,"
        },
        {
            "sha": "973afaa2271320228f4dbd7839ec2ccea3df9b14",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dcf61a605a325be9e02c15da5b2417324474b3d4/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc?ref=dcf61a605a325be9e02c15da5b2417324474b3d4",
            "patch": "@@ -65,6 +65,7 @@ limitations under the License.\n #include \"xla/types.h\"\n \n using ::testing::ElementsAreArray;\n+using ::testing::HasSubstr;\n \n namespace xla {\n namespace {\n@@ -132,6 +133,23 @@ TEST(PjRtCApiClientTest, FulfillAliasBuffer) {\n       LiteralUtil::CreateR2<int32_t>({{2, 3, 4}, {5, 6, 7}}), *alias_literal));\n }\n \n+TEST(PjRtCApiClientTest, CreateErrorBuffer) {\n+  SetUpCpuPjRtApi();\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                          GetCApiClient(\"cpu\"));\n+\n+  absl::Status error = absl::InternalError(\"Test Error\");\n+  Shape shape = ShapeUtil::MakeShape(S32, {2, 3});\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto error_buffer,\n+      client->CreateErrorBuffer(error, shape, client->memory_spaces()[0]));\n+\n+  absl::Status awaited_status = error_buffer->GetReadyFuture().Await();\n+  EXPECT_TRUE(absl::IsInternal(awaited_status));\n+  EXPECT_THAT(awaited_status.message(), HasSubstr(\"Test Error\"));\n+}\n+\n TEST(PjRtCApiClientTest, ConcurrentGetReadyFuture) {\n   const PJRT_Api* c_api = ::pjrt::cpu_plugin::GetCpuPjrtApi();\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 132,
        "deletions": 2
    }
}