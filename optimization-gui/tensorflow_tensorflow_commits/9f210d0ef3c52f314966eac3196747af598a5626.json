{
    "author": "nvgrw",
    "message": "Use a deterministic device assignment for split compilation.\n\nThe big gap in split comp adoption so far has been the inability to run\nmulti-device tests (ExecuteReplicated). This was in part caused our inconsistent\ntreatment of device assignments (fixed in #35535). The other reason (addressed\nhere) is that the default device assignments returned by PjRt may not be\ndeterministic. Device assignments obtained during compilation and execution can\ndiffer, which matters e.g. if the test overrides the static device assignments\nmanually with the default. With this change we always return an iota assignment\nfor split compilation.\n\nPiperOrigin-RevId: 846425397",
    "sha": "9f210d0ef3c52f314966eac3196747af598a5626",
    "files": [
        {
            "sha": "dd569941286ce79148c5f124654e07d3a3925913",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f210d0ef3c52f314966eac3196747af598a5626/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f210d0ef3c52f314966eac3196747af598a5626/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc?ref=9f210d0ef3c52f314966eac3196747af598a5626",
            "patch": "@@ -980,6 +980,14 @@ std::string MakeFilename(const HloModule& module, const bool run_hlo_passes) {\n                                                  fingerprint_bytes.size());\n   return absl::StrCat(absl::BytesToHexString(fingerprint_bytes_view), \".bin\");\n }\n+\n+inline absl::StatusOr<DeviceAssignment> SplitPhaseDefaultDeviceAssignment(\n+    int num_replicas, int num_partitions) {\n+  DeviceAssignment device_assignment(num_replicas, num_partitions);\n+  device_assignment.FillIota(0);\n+  return device_assignment;\n+}\n+\n }  // namespace\n \n absl::StatusOr<std::unique_ptr<OpaqueExecutable>>\n@@ -1001,6 +1009,12 @@ CompilePhaseHloRunnerPjRt::CreateExecutable(std::unique_ptr<HloModule> module,\n   return wrapped_executable;\n }\n \n+absl::StatusOr<DeviceAssignment>\n+CompilePhaseHloRunnerPjRt::GetDefaultDeviceAssignment(\n+    int num_replicas, int num_partitions) const {\n+  return SplitPhaseDefaultDeviceAssignment(num_replicas, num_partitions);\n+}\n+\n absl::StatusOr<std::unique_ptr<OpaqueExecutable>>\n ExecutePhaseHloRunnerPjRt::CreateExecutable(std::unique_ptr<HloModule> module,\n                                             const bool run_hlo_passes) {\n@@ -1045,4 +1059,10 @@ ExecutePhaseHloRunnerPjRt::CreateExecutable(std::unique_ptr<HloModule> module,\n   return DeserializeExecutable(serialized_executable);\n }\n \n+absl::StatusOr<DeviceAssignment>\n+ExecutePhaseHloRunnerPjRt::GetDefaultDeviceAssignment(\n+    int num_replicas, int num_partitions) const {\n+  return SplitPhaseDefaultDeviceAssignment(num_replicas, num_partitions);\n+}\n+\n }  // namespace xla"
        },
        {
            "sha": "bb698a64bbe786825a32026c1b4a145198d847ba",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9f210d0ef3c52f314966eac3196747af598a5626/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9f210d0ef3c52f314966eac3196747af598a5626/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.h?ref=9f210d0ef3c52f314966eac3196747af598a5626",
            "patch": "@@ -192,6 +192,9 @@ class CompilePhaseHloRunnerPjRt : public HloRunnerPjRt {\n         \"expected.\");\n   }\n \n+  absl::StatusOr<DeviceAssignment> GetDefaultDeviceAssignment(\n+      int num_replicas, int num_partitions) const override;\n+\n  private:\n   std::string artifact_dir_;\n };\n@@ -221,6 +224,9 @@ class ExecutePhaseHloRunnerPjRt : public HloRunnerPjRt {\n   absl::StatusOr<std::unique_ptr<OpaqueExecutable>> CreateExecutable(\n       std::unique_ptr<HloModule> module, bool run_hlo_passes) override;\n \n+  absl::StatusOr<DeviceAssignment> GetDefaultDeviceAssignment(\n+      int num_replicas, int num_partitions) const override;\n+\n  private:\n   std::string artifact_dir_;\n   bool compile_if_not_found_;"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 26,
        "deletions": 0
    }
}