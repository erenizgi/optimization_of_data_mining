{
    "author": "apivovarov",
    "message": "Patch xla/third_party/raft to support bfloat16 type\n\nPiperOrigin-RevId: 802663060",
    "sha": "1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281",
    "files": [
        {
            "sha": "e3a5e229e79df1c3329c602356b7693409e70f58",
            "filename": "third_party/xla/third_party/raft/cudart_utils.hpp.patch",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fthird_party%2Fraft%2Fcudart_utils.hpp.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fthird_party%2Fraft%2Fcudart_utils.hpp.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fraft%2Fcudart_utils.hpp.patch?ref=1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281",
            "patch": "@@ -0,0 +1,39 @@\n+diff --git a/cpp/include/raft/util/cudart_utils.hpp b/cpp/include/raft/util/cudart_utils.hpp\n+--- a/cpp/include/raft/util/cudart_utils.hpp\n++++ b/cpp/include/raft/util/cudart_utils.hpp\n+@@ -21,6 +21,7 @@\n+ \n+ #include <rmm/cuda_stream_view.hpp>\n+ \n++#include <cuda_bf16.h>\n+ #include <cuda_fp16.h>\n+ #include <cuda_runtime_api.h>\n+ \n+@@ -456,4 +457,27 @@ constexpr inline auto upper_bound<half>(\n+   return static_cast<half>(__half_constexpr{0x7c00u});\n+ }\n+ \n++/**\n++ * This is a hack to allow constexpr definition of `bfloat16` constants.\n++ *\n++ * Same reasoning as for `half`: CUDAâ€™s `__nv_bfloat16` has no constexpr constructor.\n++ */\n++struct __bfloat16_constexpr : __nv_bfloat16 {  // NOLINT\n++  constexpr explicit inline __bfloat16_constexpr(uint16_t u) : __nv_bfloat16() { __x = u; }\n++};\n++\n++template <>\n++constexpr inline auto lower_bound<__nv_bfloat16>() -> __nv_bfloat16\n++{\n++  // Negative infinity in bfloat16 (sign=1, exp=all ones, mantissa=0)\n++  return static_cast<__nv_bfloat16>(__bfloat16_constexpr{0xff80u});\n++}\n++\n++template <>\n++constexpr inline auto upper_bound<__nv_bfloat16>() -> __nv_bfloat16\n++{\n++  // Positive infinity in bfloat16 (sign=0, exp=all ones, mantissa=0)\n++  return static_cast<__nv_bfloat16>(__bfloat16_constexpr{0x7f80u});\n++}\n++\n+ }  // namespace raft"
        },
        {
            "sha": "614d94dc657d1028d5008d9c4c50bd0521c0f949",
            "filename": "third_party/xla/third_party/raft/vectorized.cuh.patch",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fthird_party%2Fraft%2Fvectorized.cuh.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fthird_party%2Fraft%2Fvectorized.cuh.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fraft%2Fvectorized.cuh.patch?ref=1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281",
            "patch": "@@ -0,0 +1,45 @@\n+diff --git a/cpp/include/raft/util/vectorized.cuh b/cpp/include/raft/util/vectorized.cuh\n+--- a/cpp/include/raft/util/vectorized.cuh\n++++ b/cpp/include/raft/util/vectorized.cuh\n+@@ -134,6 +134,22 @@ struct IOType<__half, 8> {\n+   typedef uint4 Type;\n+ };\n+ template <>\n++struct IOType<__nv_bfloat16, 1> {\n++  typedef __nv_bfloat16 Type;\n++};\n++template <>\n++struct IOType<__nv_bfloat16, 2> {\n++  typedef __nv_bfloat162 Type;\n++};\n++template <>\n++struct IOType<__nv_bfloat16, 4> {\n++  typedef uint2 Type;\n++};\n++template <>\n++struct IOType<__nv_bfloat16, 8> {\n++  typedef uint4 Type;\n++};\n++template <>\n+ struct IOType<__half2, 1> {\n+   typedef __half2 Type;\n+ };\n+@@ -146,6 +162,18 @@ struct IOType<__half2, 4> {\n+   typedef uint4 Type;\n+ };\n+ template <>\n++struct IOType<__nv_bfloat162, 1> {\n++  typedef __nv_bfloat162 Type;\n++};\n++template <>\n++struct IOType<__nv_bfloat162, 2> {\n++  typedef uint2 Type;\n++};\n++template <>\n++struct IOType<__nv_bfloat162, 4> {\n++  typedef uint4 Type;\n++};\n++template <>\n+ struct IOType<int32_t, 1> {\n+   typedef int32_t Type;\n+ };"
        },
        {
            "sha": "674c0a57083d57908b7f7bcf850b5999243b26bf",
            "filename": "third_party/xla/third_party/raft/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fthird_party%2Fraft%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fthird_party%2Fraft%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fraft%2Fworkspace.bzl?ref=1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281",
            "patch": "@@ -15,6 +15,8 @@ def repo():\n         urls = tf_mirror_urls(\"https://github.com/rapidsai/raft/archive/refs/tags/v{version}.tar.gz\".format(version = RAFT_VERSION)),\n         build_file = \"//third_party/raft:raft.BUILD\",\n         patch_file = [\n+            \"//third_party/raft:cudart_utils.hpp.patch\",\n+            \"//third_party/raft:vectorized.cuh.patch\",\n             \"//third_party/raft:logger_macros.hpp.patch\",\n             \"//third_party/raft:select_k_runner.hpp.patch\",\n             \"//third_party/raft:select_k_runner.cu.cc.patch\","
        },
        {
            "sha": "ecdb6f81deae30daa5502755821d15ef4c46b79b",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281",
            "patch": "@@ -870,14 +870,14 @@ cuda_library(\n         \"-DLIBCUDACXX_ENABLE_EXPERIMENTAL_MEMORY_RESOURCE\",\n     ],\n     tags = [\"cuda-only\"],\n-    textual_hdrs = [\"raft_vectorized_bf16.h\"],\n     deps = [\n         \"//xla:status_macros\",\n         \"//xla:types\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/stream_executor:device_memory_allocator\",\n         \"//xla/stream_executor:scratch_allocator\",\n         \"//xla/stream_executor:stream\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\","
        },
        {
            "sha": "13920c71beef38d9a18ebc82ac4c8267ed515188",
            "filename": "third_party/xla/xla/backends/gpu/runtime/raft_vectorized_bf16.h",
            "status": "removed",
            "additions": 0,
            "deletions": 56,
            "changes": 56,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/783d5e31f4ae6488a7074bf1dcd04e26a606e2b6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fraft_vectorized_bf16.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/783d5e31f4ae6488a7074bf1dcd04e26a606e2b6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fraft_vectorized_bf16.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fraft_vectorized_bf16.h?ref=783d5e31f4ae6488a7074bf1dcd04e26a606e2b6",
            "patch": "@@ -1,56 +0,0 @@\n-/* Copyright 2025 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#ifndef XLA_BACKENDS_GPU_RUNTIME_RAFT_VECTORIZED_BF16_H_\n-#define XLA_BACKENDS_GPU_RUNTIME_RAFT_VECTORIZED_BF16_H_\n-\n-#pragma once\n-#include \"third_party/gpus/cuda/include/cuda_bf16.h\"\n-#include \"raft/util/vectorized.cuh\"\n-\n-namespace raft {\n-\n-template <>\n-struct IOType<__nv_bfloat16, 1> {\n-  typedef __nv_bfloat16 Type;\n-};\n-template <>\n-struct IOType<__nv_bfloat16, 2> {\n-  typedef __nv_bfloat162 Type;\n-};\n-template <>\n-struct IOType<__nv_bfloat16, 4> {\n-  typedef uint2 Type;\n-};\n-template <>\n-struct IOType<__nv_bfloat16, 8> {\n-  typedef uint4 Type;\n-};\n-template <>\n-struct IOType<__nv_bfloat162, 1> {\n-  typedef __nv_bfloat162 Type;\n-};\n-template <>\n-struct IOType<__nv_bfloat162, 2> {\n-  typedef uint2 Type;\n-};\n-template <>\n-struct IOType<__nv_bfloat162, 4> {\n-  typedef uint4 Type;\n-};\n-\n-}  // namespace raft\n-\n-#endif  // XLA_BACKENDS_GPU_RUNTIME_RAFT_VECTORIZED_BF16_H_"
        },
        {
            "sha": "ad734835cada8b2aa5d6292049712b6f0bc946cd",
            "filename": "third_party/xla/xla/backends/gpu/runtime/select_k_exec_raft.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_exec_raft.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_exec_raft.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fselect_k_exec_raft.cc?ref=1858e7fb05b8b2b149d9d6eb31c85d6aaccfb281",
            "patch": "@@ -36,9 +36,6 @@ limitations under the License.\n #include \"raft/matrix/select_k.cuh\"\n #include \"raft/matrix/select_k_types.hpp\"\n #include \"xla/backends/gpu/runtime/select_k_exec.h\"\n-// NOTE: This include is required for vectorized BF16 GPU runtime support.\n-// It will no longer be needed after upgrading to raft v25.10.00.\n-#include \"xla/backends/gpu/runtime/raft_vectorized_bf16.h\"\n #include \"xla/status_macros.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/device_memory_allocator.h\""
        }
    ],
    "stats": {
        "total": 147,
        "additions": 87,
        "deletions": 60
    }
}