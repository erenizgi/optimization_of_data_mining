{
    "author": "ggawryal",
    "message": "Fix test breakage when address/memory/thread sanitizer was enabled also on Apple.\n\nTsan seems not to work with `mstats()` (other sanitizers are fine).\nAs per `lite/profiling/BUILD:160`, this could happen, but due to how `tflite_portable_test_suite_combined` rule works, this test will be included if the tsan flag is passed, even if the test itself is `notsan`.\n\nPiperOrigin-RevId: 831261356",
    "sha": "b9f5ea7f218793cbbb853f4a1d49e0057a591d53",
    "files": [
        {
            "sha": "0cd3abf60f725538896fd8989cffc7c3914eff88",
            "filename": "tensorflow/lite/profiling/memory_info_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b9f5ea7f218793cbbb853f4a1d49e0057a591d53/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b9f5ea7f218793cbbb853f4a1d49e0057a591d53/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fprofiling%2Fmemory_info_test.cc?ref=b9f5ea7f218793cbbb853f4a1d49e0057a591d53",
            "patch": "@@ -74,26 +74,30 @@ TEST(MemoryUsage, GetMemoryUsage) {\n   }\n \n   EXPECT_GE(result.mem_footprint_kb, size / 1024);\n-#if !defined(__linux__) ||                                        \\\n-    (!defined(ADDRESS_SANITIZER) && !defined(MEMORY_SANITIZER) && \\\n-     !defined(THREAD_SANITIZER))\n+#if (defined(__linux__) && !defined(ADDRESS_SANITIZER) &&         \\\n+     !defined(MEMORY_SANITIZER) && !defined(THREAD_SANITIZER)) || \\\n+    (defined(__APPLE__) && !defined(THREAD_SANITIZER)) || defined(_WIN32)\n   EXPECT_GE(result.total_allocated_bytes, size);\n+  EXPECT_NE(result.total_allocated_bytes, -1);\n   EXPECT_GE(result.in_use_allocated_bytes, size);\n+  EXPECT_NE(result.in_use_allocated_bytes, -1);\n #else\n   // The mallinfo() function, which is used on Linux, returns invalid\n   // results when address/memory/thread sanitizer is enabled, e.g.\n   // <https://github.com/google/sanitizers/issues/1845>, so the\n   // *_allocated_bytes fields are not supported in those cases,\n   // and should be set to either -1 or kValueNotSet(0).\n+  // For Apple platforms, the mstats() function returns invalid results when\n+  // thread sanitizer is enabled.\n   if (result.total_allocated_bytes != -1) {\n     EXPECT_EQ(result.total_allocated_bytes, MemoryUsage::kValueNotSet);\n   }\n   if (result.in_use_allocated_bytes != -1) {\n     EXPECT_EQ(result.in_use_allocated_bytes, MemoryUsage::kValueNotSet);\n   }\n-#endif  // !defined(__linux__) ||                                        \\\n-        // (!defined(ADDRESS_SANITIZER) && !defined(MEMORY_SANITIZER) && \\\n-        //  !defined(THREAD_SANITIZER))\n+#endif  // (defined(__linux__) && !defined(ADDRESS_SANITIZER) && \\\n+        // !defined(MEMORY_SANITIZER) && !defined(THREAD_SANITIZER)) || \\\n+        // (defined(__APPLE__) && !defined(THREAD_SANITIZER)) || defined(_WIN32)\n   EXPECT_GE(result.private_footprint_bytes, size);\n #endif  // defined(__linux__) || defined(__APPLE__) || defined(_WIN32)\n }"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 10,
        "deletions": 6
    }
}