{
    "author": "WillFroom",
    "message": "[XLA:CPU] Only add reassoc flag to reductions with a single floating point op.\n\nPiperOrigin-RevId: 822598746",
    "sha": "3353eeeab7c82b73ce06c91ab1af66899295deca",
    "files": [
        {
            "sha": "4580afb61e44c43175df95d4bd46face566458bc",
            "filename": "third_party/xla/xla/backends/cpu/codegen/emitters/transforms/add_reduction_fast_math_flags.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3353eeeab7c82b73ce06c91ab1af66899295deca/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Fadd_reduction_fast_math_flags.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3353eeeab7c82b73ce06c91ab1af66899295deca/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Fadd_reduction_fast_math_flags.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Fadd_reduction_fast_math_flags.cc?ref=3353eeeab7c82b73ce06c91ab1af66899295deca",
            "patch": "@@ -55,6 +55,13 @@ struct RewriteCallPattern\n       return rewriter.notifyMatchFailure(call_op, \"Could not resolve callee.\");\n     }\n \n+    // Adding reassoc flags to reductions with more than one fast math op\n+    // can result in unexpected behaviour as they can reassociate between\n+    // themselves.\n+    if (FastMathOpCount(callee) > 1) {\n+      return rewriter.notifyMatchFailure(call_op, \"Too many fast math ops.\");\n+    }\n+\n     callee->walk([&rewriter](mlir::Operation* op) {\n       if (auto fm_op =\n               mlir::dyn_cast_or_null<mlir::arith::ArithFastMathInterface>(op)) {\n@@ -74,6 +81,13 @@ struct RewriteCallPattern\n \n     return mlir::success();\n   }\n+\n+ private:\n+  static int FastMathOpCount(mlir::func::FuncOp callee) {\n+    int count = 0;\n+    callee.walk([&](mlir::arith::ArithFastMathInterface op) { count++; });\n+    return count;\n+  }\n };\n \n class AddReductionFastMathFlagsPass"
        },
        {
            "sha": "742ebb6382a515b23c131d29d2fadf63ea552b4a",
            "filename": "third_party/xla/xla/backends/cpu/codegen/emitters/transforms/tests/add_reduction_fast_math.mlir",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3353eeeab7c82b73ce06c91ab1af66899295deca/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Ftests%2Fadd_reduction_fast_math.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3353eeeab7c82b73ce06c91ab1af66899295deca/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Ftests%2Fadd_reduction_fast_math.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Ftests%2Fadd_reduction_fast_math.mlir?ref=3353eeeab7c82b73ce06c91ab1af66899295deca",
            "patch": "@@ -14,4 +14,24 @@ func.func @reducer(%x: f32, %y: f32) -> f32\n \n // CHECK-LABEL: func.func @caller\n // CHECK-LABEL: func.func @reducer\n-// CHECK arith.addf {{.*}} fastmath<reassoc> : f32\n+// CHECK: arith.addf {{.*}} fastmath<reassoc> : f32\n+\n+// -----\n+\n+\n+func.func @caller(%x: f32, %y: f32) -> f32\n+{\n+  %z = func.call @reducer(%x, %y) { xla.is_reduction }: (f32, f32) -> f32\n+  func.return %z : f32\n+}\n+\n+func.func @reducer(%x: f32, %y: f32) -> f32\n+{\n+  %w = arith.addf %x, %y : f32\n+  %z = arith.mulf %w, %y : f32\n+  func.return %z : f32\n+}\n+\n+// CHECK-LABEL: func.func @caller\n+// CHECK-LABEL: func.func @reducer\n+// CHECK-NOT: fastmath"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 35,
        "deletions": 1
    }
}