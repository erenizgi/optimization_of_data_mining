{
    "author": "alekstheod",
    "message": "PR #34520: [ROCm] Use rocminfo instead of lspci as it will report all connected gpus ev‚Ä¶\n\nImported from GitHub PR https://github.com/openxla/xla/pull/34520\n\n‚Ä¶en inside docker container\n\nüìù Summary of Changes\nUse rocminfo to detect number of gpus visible to xla\n\nüéØ Justification\nlspci will report all the gpus connected to bus\neven inside the docker container with a limited visibility,\nhence the number of available gpus will be invalid for\nthe tests synchonization\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nNot relevant\n\nüß™ Execution Tests:\nNot relevant\n\nCopybara import of the project:\n\n--\nbfd4a77bf896d61301ccf8b349b723c3ea4329a5 by Alexandros Theodoridis <atheodor@amd.com>:\n\nUse rocminfo instead of lspci as it will report all connected gpus even inside docker container\n\n--\nae0878665cf93f8cae2e17107a69874b1b241b72 by Alexandros Theodoridis <atheodor@amd.com>:\n\nUse rocminfo from local_config_rocm\n\n--\nbb2183349a6e077004344350c5faa85988e84f96 by Alexandros Theodoridis <atheodor@amd.com>:\n\nTrigger CI/CD pipeline\n\n--\nb4e8784db773ea4be63c6577f4aa0b7ffabd885b by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd missing rocminfo dependencies\n\nMerging this change closes #34520\n\nPiperOrigin-RevId: 840181896",
    "sha": "fac179173efae666451da464d7c902da561519bd",
    "files": [
        {
            "sha": "4031aa564ebdb550321b3b3e5a69cd1f4e972011",
            "filename": "third_party/xla/build_tools/rocm/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fac179173efae666451da464d7c902da561519bd/third_party%2Fxla%2Fbuild_tools%2Frocm%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fac179173efae666451da464d7c902da561519bd/third_party%2Fxla%2Fbuild_tools%2Frocm%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2FBUILD?ref=fac179173efae666451da464d7c902da561519bd",
            "patch": "@@ -77,6 +77,9 @@ sh_binary(\n sh_binary(\n     name = \"parallel_gpu_execute\",\n     srcs = [\"parallel_gpu_execute.sh\"],\n-    data = [\":sanitizer_ignore_lists\"],\n+    data = [\n+        \":sanitizer_ignore_lists\",\n+        \"@local_config_rocm//rocm:rocminfo\",\n+    ],\n     visibility = [\"//visibility:public\"],\n )"
        },
        {
            "sha": "03507dea47e15935ebbe171ad7b5d9101a5ce377",
            "filename": "third_party/xla/build_tools/rocm/parallel_gpu_execute.sh",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fac179173efae666451da464d7c902da561519bd/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fparallel_gpu_execute.sh",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fac179173efae666451da464d7c902da561519bd/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fparallel_gpu_execute.sh",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fbuild_tools%2Frocm%2Fparallel_gpu_execute.sh?ref=fac179173efae666451da464d7c902da561519bd",
            "patch": "@@ -21,7 +21,8 @@\n # Required environment variables:\n #     TF_GPU_COUNT = Number of GPUs available.\n \n-TF_GPU_COUNT=$(lspci | grep -e 'controller' -e 'accelerators' | grep 'AMD/ATI' | wc -l)\n+ROCMINFO=$(find \"external/local_config_rocm/rocm/rocm_dist/\" -name \"rocminfo\" -path \"*/bin/rocminfo\")\n+TF_GPU_COUNT=$($ROCMINFO | grep \"Name: *gfx*\" | wc -l)\n TF_TESTS_PER_GPU=${TF_TESTS_PER_GPU:-8}\n \n # This function is used below in rlocation to check that a path is absolute"
        },
        {
            "sha": "c95f9a95933fbcfac7bd9fa315f2cdd9444a129d",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fac179173efae666451da464d7c902da561519bd/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fac179173efae666451da464d7c902da561519bd/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=fac179173efae666451da464d7c902da561519bd",
            "patch": "@@ -92,9 +92,9 @@ cc_library(\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n+        \":rocm_config\",\n         \":rocm_headers_includes\",\n         \":rocm_rpath\",\n-        \":rocm_config\",\n     ],\n )\n \n@@ -244,8 +244,8 @@ cc_library(\n     deps = [\n         \":hipblaslt\",\n         \":rocm_config\",\n-        \":roctracer\",\n         \":rocm_rpath\",\n+        \":roctracer\",\n     ],\n )\n \n@@ -614,6 +614,17 @@ filegroup(\n     visibility = [\"//visibility:public\"],\n )\n \n+filegroup(\n+    name = \"rocminfo\",\n+    srcs = glob([\n+        \"%{rocm_root}/bin/rocminfo\",\n+        \"%{rocm_root}/lib/libhsa-runtime64.so*\",\n+        \"%{rocm_root}/lib/rocm_sysdeps/lib/*\",\n+        \"%{rocm_root}/lib/librocprofiler-register.so.0*\",\n+    ]),\n+    visibility = [\"//visibility:public\"],\n+)\n+\n platform(\n     name = \"linux_x64\",\n     constraint_values = ["
        }
    ],
    "stats": {
        "total": 23,
        "additions": 19,
        "deletions": 4
    }
}