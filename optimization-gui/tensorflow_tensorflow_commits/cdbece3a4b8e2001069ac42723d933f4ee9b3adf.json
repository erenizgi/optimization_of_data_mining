{
    "author": "vsytch",
    "message": "[XLA] Make LHS fragmentation estimate more accurate\n\n...by only considering the default memory space, as that is the only one that we consider when tracking memory pressure.\n\nAdditionally clarify that we're trying to achieve the initial memory limit by consistently lowering the target.\n\nPiperOrigin-RevId: 828216781",
    "sha": "cdbece3a4b8e2001069ac42723d933f4ee9b3adf",
    "files": [
        {
            "sha": "eda270b4c3e56e007046783e9ffbd7e5ca31edda",
            "filename": "third_party/xla/xla/service/latency_hiding_scheduler.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/cdbece3a4b8e2001069ac42723d933f4ee9b3adf/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/cdbece3a4b8e2001069ac42723d933f4ee9b3adf/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc?ref=cdbece3a4b8e2001069ac42723d933f4ee9b3adf",
            "patch": "@@ -54,6 +54,7 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/ir/hlo_schedule.h\"\n+#include \"xla/layout.h\"\n #include \"xla/map_util.h\"\n #include \"xla/service/buffer_value.h\"\n #include \"xla/service/dump.h\"\n@@ -221,6 +222,12 @@ int64_t EstimateFragmentationSize(HloModule* module,\n     if (!shape.IsArray()) {\n       return 0;\n     }\n+    if (!shape.has_layout()) {\n+      return 0;\n+    }\n+    if (shape.layout().memory_space() != Layout::kDefaultMemorySpace) {\n+      return 0;\n+    }\n     return ShapeUtil::ByteSizeOf(shape);\n   };\n   auto result =\n@@ -3674,9 +3681,8 @@ absl::StatusOr<bool> LatencyHidingScheduler::RunImpl(\n        iter++) {\n     LOG(INFO) << \"LatencyHidingScheduler current memory usage: \"\n               << scheduler_core_->GetMemoryPeak() + fragmentation_size\n-              << \" bytes, does not fit in limit: \"\n-              << scheduler_core_->GetMemoryLimit()\n-              << \". Setting the new limit to \"\n+              << \" bytes, does not fit in initial limit: \"\n+              << initial_memory_limit << \". Setting the new limit to \"\n               << static_cast<uint64_t>(scheduler_core_->GetMemoryLimit() * 0.9);\n     TF_RETURN_IF_ERROR(scheduler_core_->InitializeScheduler(module));\n     scheduler_core_->SetMemoryLimit(scheduler_core_->GetMemoryLimit() * 0.9);"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 9,
        "deletions": 3
    }
}