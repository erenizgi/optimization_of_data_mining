{
    "author": "thomasjoerg",
    "message": "[XLA:GPU] Test that DotDecomposer canonicalizes batch dims.\n\nExisting tests do not cover this.\n\nPiperOrigin-RevId: 826006833",
    "sha": "fbaeea227bd4858fd82ab2b15f24e301536c44a7",
    "files": [
        {
            "sha": "2c508759fef7b49a12c9fbdffbf6f30f75823e00",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/dot_decomposer_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbaeea227bd4858fd82ab2b15f24e301536c44a7/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbaeea227bd4858fd82ab2b15f24e301536c44a7/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer_test.cc?ref=fbaeea227bd4858fd82ab2b15f24e301536c44a7",
            "patch": "@@ -239,6 +239,30 @@ TEST_F(DotDecomposerTest, AddRhsNonContractingDimIfZero) {\n                                 op::Shape(\"f32[64,0]\"))));\n }\n \n+TEST_F(DotDecomposerTest, CanonicalizeBatchDims) {\n+  absl::string_view module_string = R\"(\n+  ENTRY main {\n+    p0 = f32[64,4,32,8] parameter(0)\n+    p1 = f32[128,4,8,32] parameter(1)\n+    ROOT dot = f32[32,8,64,128] dot(p0, p1), lhs_batch_dims={2,3},\n+                                             lhs_contracting_dims={1},\n+                                             rhs_batch_dims={3,2},\n+                                             rhs_contracting_dims={1}\n+  })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(module_string));\n+  TF_ASSERT_OK_AND_ASSIGN(bool canonicalized,\n+                          DotDecomposer().Run(module.get()));\n+  EXPECT_TRUE(canonicalized);\n+\n+  EXPECT_THAT(module->entry_computation()->root_instruction(),\n+              op::Reshape(AllOf(op::Dot(op::Reshape(), op::Reshape(),\n+                                        /*lhs_contracting_dim=*/3,\n+                                        /*rhs_contracting_dim=*/2),\n+                                op::Shape(\"f32[32,8,64,128]\"))));\n+}\n+\n template <typename Arg0, typename Arg1, typename Arg2>\n auto SparseDotMatcher(Arg0&& arg0, Arg1&& arg1, Arg2&& arg2) {\n   return match::Op()"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 24,
        "deletions": 0
    }
}