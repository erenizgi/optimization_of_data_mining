{
    "author": "ZixuanJiang",
    "message": "Disable `StablehloCanonicalizeFromHloImportPass` in the Shardy `StablehloImportPipeline`.\n\n`stablehlo-import` is not in production and only used in auto-sharding and deprecated tests. This cl intends to resolve b/459908800.\n\nPiperOrigin-RevId: 834494610",
    "sha": "ac10fd5f606a98acd6b808f392b0788b38cb2f74",
    "files": [
        {
            "sha": "840f67674593b1f16f944f0213c753d90164c40f",
            "filename": "third_party/xla/xla/hlo/experimental/auto_sharding/auto_sharding_stablehlo_pass_test.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fauto_sharding_stablehlo_pass_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fauto_sharding_stablehlo_pass_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fauto_sharding_stablehlo_pass_test.cc?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -82,7 +82,9 @@ TEST_F(AutoShardingTest, OpenDimensionsInputSharding) {\n   CHECK: %arg0: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{}, {}]>}\n   CHECK-SAME: %arg1: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{}, {}]>}\n   CHECK-SAME: -> (tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{\"x\"}, {\"y\"}]>}\n-  CHECK: %0 = stablehlo.dot %arg0, %arg1, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {\"y\"}]>]>}\n+  CHECK: %0 = stablehlo.reshape %arg0 {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {}]>]>}\n+  CHECK: %1 = stablehlo.reshape %arg1 {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{}, {\"y\"}]>]>}\n+  CHECK: %2 = stablehlo.dot %0, %1, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {\"y\"}]>]>}\n   )\";\n \n   mlir::OwningOpRef<mlir::ModuleOp> module =\n@@ -106,7 +108,9 @@ TEST_F(AutoShardingTest, ClosedDimensionsInputSharding) {\n   CHECK: %arg0: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{}, {}]>}\n   CHECK-SAME: %arg1: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{}, {}]>}\n   CHECK-SAME: -> (tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{\"x\"}, {\"y\"}]>}\n-  CHECK: %0 = stablehlo.dot %arg0, %arg1, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {\"y\"}]>]>}\n+  CHECK: %0 = stablehlo.reshape %arg0 {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {}]>]>}\n+  CHECK: %1 = stablehlo.reshape %arg1 {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{}, {\"y\"}]>]>}\n+  CHECK: %2 = stablehlo.dot %0, %1, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {\"y\"}]>]>}\n   )\";\n \n   mlir::OwningOpRef<mlir::ModuleOp> module =\n@@ -130,7 +134,8 @@ TEST_F(AutoShardingTest, HybridDimensionsInputSharding) {\n   CHECK: %arg0: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{\"x\"}, {}]>}\n   CHECK-SAME: %arg1: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{}, {}]>}\n   CHECK-SAME: -> (tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh_0, [{\"x\"}, {\"y\"}]>}\n-  CHECK: %0 = stablehlo.dot %arg0, %arg1, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {\"y\"}]>]>}\n+  CHECK: %0 = stablehlo.reshape %arg1 {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{}, {\"y\"}]>]>}\n+  CHECK: %1 = stablehlo.dot %arg0, %0, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh_0, [{\"x\"}, {\"y\"}]>]>}\n   )\";\n \n   mlir::OwningOpRef<mlir::ModuleOp> module ="
        },
        {
            "sha": "3fe242e52294de81c43ca49bafd84a688dac84ee",
            "filename": "third_party/xla/xla/hlo/experimental/auto_sharding/stablehlo_utils.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fstablehlo_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fstablehlo_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fstablehlo_utils.cc?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -73,7 +73,9 @@ absl::StatusOr<mlir::OwningOpRef<mlir::ModuleOp>> ConvertHloToShardyStablehlo(\n   mlir::PassManager pm(context);\n   llvm::SmallVector<bool> prop_args = {false};\n   llvm::SmallVector<bool> prop_results = {false};\n-  xla::sdy::addStablehloImportPipeline(pm, prop_args, prop_results);\n+  xla::sdy::addStablehloImportPipeline(\n+      pm, prop_args, prop_results,\n+      /*enableStablehloCanonicalizeFromHloImport=*/false);\n   // TODO(hanruobing): Explore reinserting the original mesh and calling\n   // xla::sdy::createDedupMeshesPass\n   if (mlir::failed(pm.run(stablehlo_module.get()))) {"
        },
        {
            "sha": "1770af3588ae477cb23d2ae3c672d56ad3b021a8",
            "filename": "third_party/xla/xla/hlo/experimental/auto_sharding/stablehlo_utils_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fstablehlo_utils_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fstablehlo_utils_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fexperimental%2Fauto_sharding%2Fstablehlo_utils_test.cc?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -184,7 +184,8 @@ ENTRY %main.4 (Arg_0.1: f32[400,400], Arg_1.2: f32[400,400]) -> f32[400,400] {\n   CHECK: %arg0: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh, [{}, {}]>}\n   CHECK-SAME: %arg1: tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh, [{}, {}]>}\n   CHECK-SAME: -> (tensor<400x400xf32> {sdy.sharding = #sdy.sharding<@mesh, [{\"_axis_0\"}, {}]>})\n-  CHECK: %0 = stablehlo.dot %arg0, %arg1, {{.*}} {sdy.sharding = #sdy.sharding_per_value<[<@mesh, [{\"_axis_0\"}, {}]>]>}\n+  CHECK: %0 = stablehlo.reshape %arg0 {sdy.sharding = #sdy.sharding_per_value<[<@mesh, [{\"_axis_0\"}, {}]>]>}\n+  CHECK: %1 = stablehlo.dot %0, %arg1, precision = [DEFAULT, DEFAULT] {sdy.sharding = #sdy.sharding_per_value<[<@mesh, [{\"_axis_0\"}, {}]>]>}\n   )\";\n \n   ConvertHloAndCompare(kHloString, kExpectedShardyPattern);"
        },
        {
            "sha": "6fc7be12e0627e0aa31e227f24881d8560f4c25f",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/pipeline_passes.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fpipeline_passes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fpipeline_passes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fpipeline_passes.cc?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -30,7 +30,8 @@ namespace sdy {\n using ::mlir::func::FuncOp;\n \n void addCommonPreImportPasses(mlir::OpPassManager& pm,\n-                              bool enableConstantImport) {\n+                              bool enableConstantImport,\n+                              bool enableStablehloCanonicalizeFromHloImport) {\n   pm.addPass(mlir::createSymbolDCEPass());\n   // TODO(b/333505182): remove when partitioning is done in SDY.\n   // We call prepare-for-export pass before SDY propagation, so that all IR\n@@ -47,8 +48,10 @@ void addCommonPreImportPasses(mlir::OpPassManager& pm,\n   if (enableConstantImport) {\n     pm.addNestedPass<FuncOp>(createImportConstantsPass());\n   }\n-  pm.addNestedPass<FuncOp>(\n-      mlir::stablehlo_ext::createStablehloCanonicalizeFromHloImportPass());\n+  if (enableStablehloCanonicalizeFromHloImport) {\n+    pm.addNestedPass<FuncOp>(\n+        mlir::stablehlo_ext::createStablehloCanonicalizeFromHloImportPass());\n+  }\n }\n \n void addCommonPostImportPasses(mlir::OpPassManager& pm, bool importFuncCalls) {"
        },
        {
            "sha": "3108a098e10486cda91caa4296b4cbf99f9cc917",
            "filename": "third_party/xla/xla/service/spmd/shardy/round_trip_common/pipeline_passes.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fpipeline_passes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fpipeline_passes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fround_trip_common%2Fpipeline_passes.h?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -24,8 +24,9 @@ namespace sdy {\n // Adds the common import passes for both the SDY and StableHLO import\n // pipelines that need to be called before each pipeline converts an HLO\n // sharding/SDY sharding string into an `sdy.sharding` attribute.\n-void addCommonPreImportPasses(mlir::OpPassManager& pm,\n-                              bool enableConstantImport = true);\n+void addCommonPreImportPasses(\n+    mlir::OpPassManager& pm, bool enableConstantImport = true,\n+    bool enableStablehloCanonicalizeFromHloImport = true);\n \n // Adds the common import passes for both the SDY and StableHLO import\n // pipelines that need to be called after each pipeline converts an HLO"
        },
        {
            "sha": "0e2980e1e91997d8abac7934067d037757960714",
            "filename": "third_party/xla/xla/service/spmd/shardy/stablehlo_round_trip/stablehlo_import.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_import.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_import.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_import.cc?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -750,8 +750,10 @@ void registerStablehloImportShardingsPass() {\n \n void addStablehloImportPipeline(mlir::OpPassManager& pm,\n                                 ArrayRef<bool> allowPropagationToArgs,\n-                                ArrayRef<bool> allowPropagationToResults) {\n-  addCommonPreImportPasses(pm);\n+                                ArrayRef<bool> allowPropagationToResults,\n+                                bool enableStablehloCanonicalizeFromHloImport) {\n+  addCommonPreImportPasses(pm, /*enableConstantImport=*/true,\n+                           enableStablehloCanonicalizeFromHloImport);\n   pm.addPass(createImportShardingsPass(allowPropagationToArgs,\n                                        allowPropagationToResults));\n   pm.addPass(createStablehloRoundTripShardMapImportPass());\n@@ -764,7 +766,7 @@ void registerStablehloImportPipeline() {\n       \"Run passes to import a StableHLO module with `mhlo.shardings` into the \"\n       \"SDY (Shardy) dialect.\",\n       std::bind(addStablehloImportPipeline, std::placeholders::_1,\n-                ArrayRef<bool>(), ArrayRef<bool>()));\n+                ArrayRef<bool>(), ArrayRef<bool>(), true));\n }\n \n }  // namespace sdy"
        },
        {
            "sha": "46dc70ac8fdaa0216206be12caed54927d8aaf66",
            "filename": "third_party/xla/xla/service/spmd/shardy/stablehlo_round_trip/stablehlo_import.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_import.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ac10fd5f606a98acd6b808f392b0788b38cb2f74/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_import.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fshardy%2Fstablehlo_round_trip%2Fstablehlo_import.h?ref=ac10fd5f606a98acd6b808f392b0788b38cb2f74",
            "patch": "@@ -73,9 +73,10 @@ void registerStablehloImportPipeline();\n // - be empty, in which case the default is false for all args/results.\n // - have a single element, in which case the value applies to all args/results.\n // - have the same number of elements as the number of args/results.\n-void addStablehloImportPipeline(mlir::OpPassManager& pm,\n-                                mlir::ArrayRef<bool> allowPropagationToArgs,\n-                                mlir::ArrayRef<bool> allowPropagationToResults);\n+void addStablehloImportPipeline(\n+    mlir::OpPassManager& pm, mlir::ArrayRef<bool> allowPropagationToArgs,\n+    mlir::ArrayRef<bool> allowPropagationToResults,\n+    bool enableStablehloCanonicalizeFromHloImport = true);\n \n // Creates ImportShardingsPass that converts `mhlo.sharding` to `mesh` and\n // `sdy.sharding`."
        }
    ],
    "stats": {
        "total": 47,
        "additions": 31,
        "deletions": 16
    }
}