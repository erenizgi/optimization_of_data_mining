{
    "author": "zzzaries",
    "message": "Skip adding CUPTI events for NaN metric values.\n\nPiperOrigin-RevId: 800978214",
    "sha": "313f58ae85278ced9ccc7f90ee630bdf8735c52f",
    "files": [
        {
            "sha": "28d652582be5afb2ecf081e4962055a749e9deb5",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_collector.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/313f58ae85278ced9ccc7f90ee630bdf8735c52f/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/313f58ae85278ced9ccc7f90ee630bdf8735c52f/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector.cc?ref=313f58ae85278ced9ccc7f90ee630bdf8735c52f",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #include \"xla/backends/profiler/gpu/cupti_collector.h\"\n \n #include <climits>\n+#include <cmath>\n #include <cstddef>\n #include <cstdint>\n #include <cstring>\n@@ -688,6 +689,9 @@ void PmSamples::PopulateCounterLine(XPlaneBuilder* plane,\n   for (auto& sampler_range : sampler_ranges_) {\n     DCHECK_EQ(metrics_.size(), sampler_range.metric_values.size());\n     for (int i = 0; i < sampler_range.metric_values.size(); ++i) {\n+      if (std::isnan(sampler_range.metric_values[i])) {\n+        continue;\n+      }\n       XEventBuilder event = line.AddEvent(\n           tsl::profiler::Timespan(\n               tsl::profiler::NanoToPico(sampler_range.start_timestamp_ns -"
        },
        {
            "sha": "fdf4e48a3d7f3a4bfa3f6046de3e4857d0c90ee7",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_collector_test.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/313f58ae85278ced9ccc7f90ee630bdf8735c52f/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/313f58ae85278ced9ccc7f90ee630bdf8735c52f/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector_test.cc?ref=313f58ae85278ced9ccc7f90ee630bdf8735c52f",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #include \"xla/backends/profiler/gpu/cupti_collector.h\"\n \n #include <cstdint>\n+#include <limits>\n #include <memory>\n #include <string>\n \n@@ -151,6 +152,32 @@ TEST(CuptiCollectorTest, ExportCallbackActivityAndNvtxEvents) {\n   }\n }\n \n+TEST(PmSamplesTest, PopulateCounterLineSkipsNan) {\n+  tensorflow::profiler::XSpace space;\n+  tsl::profiler::XPlaneBuilder plane_builder(space.add_planes());\n+  PmSamples pm_samples({\"metric1\", \"metric2\"},\n+                       {{/*range_index=*/0,\n+                         /*start_timestamp_ns=*/100,\n+                         /*end_timestamp_ns=*/200,\n+                         {123.0, std::numeric_limits<double>::quiet_NaN()}}},\n+                       /*device_id=*/0);\n+\n+  uint64_t start_gpu_time_ns = 50;\n+  pm_samples.PopulateCounterLine(&plane_builder, start_gpu_time_ns);\n+\n+  const auto& plane = space.planes(0);\n+  ASSERT_EQ(plane.lines_size(), 1);\n+  const auto& line = plane.lines(0);\n+\n+  ASSERT_EQ(line.events_size(), 1);\n+  const auto& event = line.events(0);\n+  // metric2 is skipped because it's NaN.\n+  ASSERT_EQ(event.stats_size(), 1);\n+  const auto& stat = event.stats(0);\n+  EXPECT_EQ(plane.stat_metadata().at(stat.metadata_id()).name(), \"metric1\");\n+  EXPECT_EQ(stat.double_value(), 123.0);\n+}\n+\n }  // namespace\n }  // namespace profiler\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 31,
        "deletions": 0
    }
}