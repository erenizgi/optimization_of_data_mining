{
    "author": "ezhulenev",
    "message": "[xla] Add BufferAssignment::Finalize to free internal data structures not needed at run time\n\nPiperOrigin-RevId: 797937803",
    "sha": "fa35159d89c9fef9ad80c26cfd83f2263115da6c",
    "files": [
        {
            "sha": "59fd376f3ddf1ca937e53828698f9430d5b0d8fe",
            "filename": "third_party/xla/xla/service/buffer_assignment.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.cc?ref=fa35159d89c9fef9ad80c26cfd83f2263115da6c",
            "patch": "@@ -1307,6 +1307,16 @@ absl::StatusOr<std::unique_ptr<BufferAssignment>> BufferAssignment::FromProto(\n   return buffer_assignment;\n }\n \n+void BufferAssignment::Finalize() {\n+  hlo_ordering_.reset();\n+  hlo_live_range_.reset();\n+\n+  for (BufferAllocation& allocation : allocations_) {\n+    allocation.heap_traces_.clear();\n+    allocation.heap_traces_.shrink_to_fit();\n+  }\n+}\n+\n /* static */\n absl::StatusOr<std::unique_ptr<BufferAssignment>> BufferAssigner::Run(\n     const HloModule* module, std::unique_ptr<HloOrdering> hlo_ordering,"
        },
        {
            "sha": "76bda2ed7eee71e5b82cdabbc74abaaf4cf65d64",
            "filename": "third_party/xla/xla/service/buffer_assignment.h",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fbuffer_assignment.h?ref=fa35159d89c9fef9ad80c26cfd83f2263115da6c",
            "patch": "@@ -514,10 +514,18 @@ class BufferAssignment {\n \n   HloAliasAnalysis& alias_analysis() const { return *alias_analysis_; }\n \n-  const HloOrdering& hlo_ordering() const { return *hlo_ordering_; }\n+  const HloOrdering& hlo_ordering() const {\n+    DCHECK(hlo_ordering_) << \"BufferAssignment was finalized and does not have \"\n+                             \"an HloOrdering anymore.\";\n+    return *hlo_ordering_;\n+  }\n \n   // Returns the HloLiveRange object used to construct this assignment.\n-  const HloLiveRange& hlo_live_range() const { return *hlo_live_range_; }\n+  const HloLiveRange& hlo_live_range() const {\n+    DCHECK(hlo_ordering_) << \"BufferAssignment was finalized and does not have \"\n+                             \"an HloLiveRange anymore.\";\n+    return *hlo_live_range_;\n+  }\n \n   // Is in use by many compilers to dump the buffer-assignment info.\n   std::string ToString() const;\n@@ -562,6 +570,13 @@ class BufferAssignment {\n   };\n   const Stats& GetStats() const { return stats_; }\n \n+  // Once HLO graph has all buffers assigned, finalizes the BufferAssignment by\n+  // freeing the internal data structures that are no longer needed at run time.\n+  //\n+  // WARNING: Accessing HloOrdering or HloLiveRange after calling this method\n+  // will result in a crash.\n+  void Finalize();\n+\n  private:\n   // Only BufferAssigner can build or modify BufferAssignments.\n   friend class BufferAssigner;\n@@ -651,7 +666,7 @@ class BufferAssignment {\n \n   const HloModule* module_;\n \n-  const std::unique_ptr<HloOrdering> hlo_ordering_;\n+  std::unique_ptr<HloOrdering> hlo_ordering_;\n \n   // Function which returns the buffer size for a given logical buffer (shape).\n   BufferValue::SizeFunction buffer_size_;"
        },
        {
            "sha": "640adc3ce00eb32e339f3aa61985bdbaaaaf8ee8",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=fa35159d89c9fef9ad80c26cfd83f2263115da6c",
            "patch": "@@ -1816,7 +1816,10 @@ absl::StatusOr<std::unique_ptr<Executable>> CpuCompiler::RunBackend(\n   AliasInfo alias_info;\n   cpu_executable->set_debug_info(\n       cpu_executable->buffer_assignment().StatsString(&alias_info));\n+\n   VLOG(1) << \"Compilation finished\";\n+  cpu_executable->Finalize();\n+\n   return std::unique_ptr<Executable>(std::move(cpu_executable));\n }\n "
        },
        {
            "sha": "d77f30b33a901f473e16b3ca9f73473c3bac155a",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.cc?ref=fa35159d89c9fef9ad80c26cfd83f2263115da6c",
            "patch": "@@ -85,7 +85,7 @@ namespace cpu {\n \n absl::StatusOr<std::unique_ptr<CpuExecutable>> CpuExecutable::Create(\n     std::unique_ptr<FunctionLibrary> function_library,\n-    std::unique_ptr<const BufferAssignment> assignment,\n+    std::unique_ptr<BufferAssignment> assignment,\n     std::unique_ptr<HloModule> hlo_module,\n     const std::string& entry_function_name,\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n@@ -113,7 +113,7 @@ absl::StatusOr<std::unique_ptr<CpuExecutable>> CpuExecutable::Create(\n \n absl::StatusOr<std::unique_ptr<CpuExecutable>> CpuExecutable::Create(\n     std::unique_ptr<FunctionLibrary> function_library,\n-    std::unique_ptr<const BufferAssignment> assignment,\n+    std::unique_ptr<BufferAssignment> assignment,\n     std::unique_ptr<HloModule> hlo_module, ThunkSequence thunks,\n     std::vector<ConstantAllocation> constants,\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n@@ -153,7 +153,7 @@ CpuExecutable::CpuExecutable(\n     std::unique_ptr<HloModule> hlo_module,\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     std::unique_ptr<HloProfileIndexMap> hlo_profile_index_map,\n-    std::unique_ptr<const BufferAssignment> assignment)\n+    std::unique_ptr<BufferAssignment> assignment)\n     : Executable(std::move(hlo_module), std::move(hlo_profile_printer_data),\n                  std::move(hlo_profile_index_map)),\n       assignment_(std::move(assignment)) {\n@@ -561,5 +561,7 @@ int64_t CpuExecutable::SizeOfGeneratedCodeInBytes() const {\n   return 0;\n }\n \n+void CpuExecutable::Finalize() { assignment_->Finalize(); }\n+\n }  // namespace cpu\n }  // namespace xla"
        },
        {
            "sha": "5dc42dd69acfee70168c6814c25bb8cee2b090e7",
            "filename": "third_party/xla/xla/service/cpu/cpu_executable.h",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fa35159d89c9fef9ad80c26cfd83f2263115da6c/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_executable.h?ref=fa35159d89c9fef9ad80c26cfd83f2263115da6c",
            "patch": "@@ -59,7 +59,7 @@ class CpuExecutable : public Executable {\n   // `entry_function_name` in the `jit`.\n   static absl::StatusOr<std::unique_ptr<CpuExecutable>> Create(\n       std::unique_ptr<FunctionLibrary> function_library,\n-      std::unique_ptr<const BufferAssignment> assignment,\n+      std::unique_ptr<BufferAssignment> assignment,\n       std::unique_ptr<HloModule> hlo_module,\n       const std::string& entry_function_name,\n       std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n@@ -68,7 +68,7 @@ class CpuExecutable : public Executable {\n   // Creates a CpuExecutable from a thunk sequence.\n   static absl::StatusOr<std::unique_ptr<CpuExecutable>> Create(\n       std::unique_ptr<FunctionLibrary> function_library,\n-      std::unique_ptr<const BufferAssignment> assignment,\n+      std::unique_ptr<BufferAssignment> assignment,\n       std::unique_ptr<HloModule> hlo_module, ThunkSequence thunks,\n       std::vector<ConstantAllocation> constants,\n       std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n@@ -169,6 +169,10 @@ class CpuExecutable : public Executable {\n     return std::move(function_library_);\n   }\n \n+  // Finalize construction of the CpuExecutable and finalize all internal data\n+  // structures that might have been used at compile time.\n+  void Finalize();\n+\n  private:\n   // Creates an array suitable for passing as the \"buffer_table\" argument to the\n   // JIT compiled function pointer.\n@@ -220,7 +224,7 @@ class CpuExecutable : public Executable {\n       symbol_type_id_to_function_type_id_;\n \n   // Buffer assignment for the buffers we need to allocate.\n-  std::shared_ptr<const BufferAssignment> assignment_;\n+  std::shared_ptr<BufferAssignment> assignment_;\n \n   // The LLVM IR, in string format, of the unoptimized module generated for this\n   // CpuExecutable. We save a string instead of an llvm::Module* because leaving\n@@ -258,7 +262,7 @@ class CpuExecutable : public Executable {\n   CpuExecutable(std::unique_ptr<HloModule> hlo_module,\n                 std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n                 std::unique_ptr<HloProfileIndexMap> hlo_profile_index_map,\n-                std::unique_ptr<const BufferAssignment> assignment);\n+                std::unique_ptr<BufferAssignment> assignment);\n   CpuExecutable(const CpuExecutable&) = delete;\n   CpuExecutable& operator=(const CpuExecutable&) = delete;\n };"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 44,
        "deletions": 10
    }
}