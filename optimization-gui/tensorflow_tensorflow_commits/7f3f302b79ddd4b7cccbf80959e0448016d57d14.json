{
    "author": "junjiang-lab",
    "message": "Relax tfl.slice and strided_slice op check to allow 6D inputs.\n\nPiperOrigin-RevId: 805891454",
    "sha": "7f3f302b79ddd4b7cccbf80959e0448016d57d14",
    "files": [
        {
            "sha": "89fcef700e10b68f778a30048b2d6a19ebf7e9b8",
            "filename": "tensorflow/compiler/mlir/lite/ir/tfl_ops.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.cc?ref=7f3f302b79ddd4b7cccbf80959e0448016d57d14",
            "patch": "@@ -4615,7 +4615,7 @@ bool VerifyStridedSliceOpInputRankConstraints(StridedSliceOp op) {\n   const int num_input_dims = ranked_input_type.getRank();\n \n   // The kernel will reshape the input tensor with new axis, it only supports\n-  // this reshaped tensor up to 5D.\n+  // this reshaped tensor up to 6D.\n   const uint32_t ellipsis_mask = op.getEllipsisMask();\n   const uint32_t new_axis_mask = op.getNewAxisMask();\n   int num_added_axis = 0;\n@@ -4624,7 +4624,7 @@ bool VerifyStridedSliceOpInputRankConstraints(StridedSliceOp op) {\n       num_added_axis++;\n     }\n   }\n-  return (num_input_dims + num_added_axis <= 5);\n+  return (num_input_dims + num_added_axis <= 6);\n }\n \n LogicalResult StridedSliceOp::verify() {"
        },
        {
            "sha": "e025dd30cb0dee6ffccaf0e2a8da16247b34b05e",
            "filename": "tensorflow/compiler/mlir/lite/ir/tfl_ops.td",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.td",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.td",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Fir%2Ftfl_ops.td?ref=7f3f302b79ddd4b7cccbf80959e0448016d57d14",
            "patch": "@@ -2455,8 +2455,8 @@ def TFL_SliceOp : TFL_Op<\"slice\", [\n       TFL_TCresVTEtIsSameAsOp<0, 0>>,\n     Pure,\n     SameOperandsAndResultsScale,\n-    TFL_RuntimePredOpTrait<\"input must have rank at most 5\",\n-      TFL_OperandHasRankAtMostPred<0, 5>>,\n+    TFL_RuntimePredOpTrait<\"input must have rank at most 6\",\n+      TFL_OperandHasRankAtMostPred<0, 6>>,\n     TFL_OperandHasRankAtMost<1, 1>,\n     TFL_OperandHasRankAtMost<2, 1>]> {\n   let summary = \"Return a slice from 'input'.\";\n@@ -4020,7 +4020,7 @@ def TFL_StridedSliceOp: TFL_Op<\"strided_slice\", [\n     PredOpTrait<\"input and output must have same element type\",\n       TFL_TCresVTEtIsSameAsOp<0, 0>>,\n     SameOperandsAndResultsScale,\n-    TFL_RuntimePredOpTrait<\"input (with new_axis) must have rank at most 5\",\n+    TFL_RuntimePredOpTrait<\"input (with new_axis) must have rank at most 6\",\n       CPred<\"TFL::VerifyStridedSliceOpInputRankConstraints(llvm::cast<StridedSliceOp>($_op))\">>,\n     TFL_OperandHasRank<1, 1>,\n     TFL_OperandHasRank<2, 1>,"
        },
        {
            "sha": "704428f899d7d8251ddd383ab39a8e93317c13bb",
            "filename": "tensorflow/compiler/mlir/lite/tests/legalize-tf.mlir",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Ftests%2Flegalize-tf.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Ftests%2Flegalize-tf.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Ftests%2Flegalize-tf.mlir?ref=7f3f302b79ddd4b7cccbf80959e0448016d57d14",
            "patch": "@@ -1432,7 +1432,7 @@ func.func @strided_slice_big_dims(%arg0: tensor<5x6x7xf32>, %arg1: tensor<3xi32>\n   %0 = \"tf.StridedSlice\"(%arg0, %arg1, %arg2, %arg3) {begin_mask = 0 : i64, ellipsis_mask = 0 : i64, end_mask = 0 : i64, new_axis_mask = 7 : i64, shrink_axis_mask = 0 : i64, offset = false} : (tensor<5x6x7xf32>, tensor<3xi32>, tensor<3xi32>, tensor<3xi32>) -> tensor<1x1x5x6x7xf32>\n   func.return %0 : tensor<1x1x5x6x7xf32>\n   // CHECK-LABEL: strided_slice_big_dims\n-  // CHECK: %0 = \"tf.StridedSlice\"(%arg0, %arg1, %arg2, %arg3) <{begin_mask = 0 : i64, ellipsis_mask = 0 : i64, end_mask = 0 : i64, new_axis_mask = 7 : i64, shrink_axis_mask = 0 : i64}> {offset = false} : (tensor<5x6x7xf32>, tensor<3xi32>, tensor<3xi32>, tensor<3xi32>) -> tensor<1x1x5x6x7xf32>\n+  // CHECK: %0 = \"tfl.strided_slice\"(%arg0, %arg1, %arg2, %arg3) <{begin_mask = 0 : i32, ellipsis_mask = 0 : i32, end_mask = 0 : i32, new_axis_mask = 7 : i32, offset = false, shrink_axis_mask = 0 : i32}> : (tensor<5x6x7xf32>, tensor<3xi32>, tensor<3xi32>, tensor<3xi32>) -> tensor<1x1x5x6x7xf32>\n }\n \n func.func @slice1Tensor(%arg0: tensor<2x3x5xf32>, %arg1: tensor<3xi32>, %arg2: tensor<3xi32>) -> tensor<?x3x5xf32> {"
        },
        {
            "sha": "6bd32635556e27bac47791417b14ae8a3fd1636d",
            "filename": "tensorflow/compiler/mlir/lite/tests/ops.mlir",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Ftests%2Fops.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7f3f302b79ddd4b7cccbf80959e0448016d57d14/tensorflow%2Fcompiler%2Fmlir%2Flite%2Ftests%2Fops.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Flite%2Ftests%2Fops.mlir?ref=7f3f302b79ddd4b7cccbf80959e0448016d57d14",
            "patch": "@@ -1771,10 +1771,20 @@ func.func @testStridedSliceWithInvalidOutputType(%arg0: tensor<12x2x2x5xf32>, %a\n \n // -----\n \n-func.func @testStridedSliceWithInvalidInputRank(%arg0: tensor<12x2x2x5xf32>, %arg1: tensor<1xi32>, %arg2: tensor<1xi32>, %arg3: tensor<1xi32>) -> tensor<1x1x1x2x2x5xf32> {\n-  // expected-error @+1 {{op failed to verify that input (with new_axis) must have rank at most 5}}\n-  %0 = \"tfl.strided_slice\"(%arg0, %arg1, %arg2, %arg3) {begin_mask = 0 : i32, ellipsis_mask = 0 : i32, end_mask = 0 : i32, new_axis_mask = 6 : i32, shrink_axis_mask = 0 : i32, offset = false} : (tensor<12x2x2x5xf32>, tensor<1xi32>, tensor<1xi32>, tensor<1xi32>) -> tensor<1x1x1x2x2x5xf32>\n-  func.return %0 : tensor<1x1x1x2x2x5xf32>\n+// CHECK-LABEL: testStridedSliceWith6DInputRank\n+func.func @testStridedSliceWith6DInputRank(%arg0: tensor<12x2x2x5xf32>, %arg1: tensor<1xi32>, %arg2: tensor<1xi32>, %arg3: tensor<1xi32>) -> tensor<1x1x12x2x2x5xf32> {\n+  // CHECK: \"tfl.strided_slice\"\n+  %0 = \"tfl.strided_slice\"(%arg0, %arg1, %arg2, %arg3) {begin_mask = 0 : i32, ellipsis_mask = 0 : i32, end_mask = 0 : i32, new_axis_mask = 3 : i32, shrink_axis_mask = 0 : i32, offset = false} : (tensor<12x2x2x5xf32>, tensor<1xi32>, tensor<1xi32>, tensor<1xi32>) -> tensor<1x1x12x2x2x5xf32>\n+  func.return %0 : tensor<1x1x12x2x2x5xf32>\n+}\n+\n+// -----\n+\n+// test invalid strided slice input rank (exceeds 6)\n+func.func @testStridedSliceWithInvalidInputRank(%arg0: tensor<12x2x2x5xf32>, %arg1: tensor<1xi32>, %arg2: tensor<1xi32>, %arg3: tensor<1xi32>) -> tensor<1x1x1x12x2x2x5xf32> {\n+  // expected-error @+1 {{op failed to verify that input (with new_axis) must have rank at most 6}}\n+  %0 = \"tfl.strided_slice\"(%arg0, %arg1, %arg2, %arg3) {begin_mask = 0 : i32, ellipsis_mask = 0 : i32, end_mask = 0 : i32, new_axis_mask = 7 : i32, shrink_axis_mask = 0 : i32, offset = false} : (tensor<12x2x2x5xf32>, tensor<1xi32>, tensor<1xi32>, tensor<1xi32>) -> tensor<1x1x1x12x2x2x5xf32>\n+  func.return %0 : tensor<1x1x1x12x2x2x5xf32>\n }\n \n // -----"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 20,
        "deletions": 10
    }
}