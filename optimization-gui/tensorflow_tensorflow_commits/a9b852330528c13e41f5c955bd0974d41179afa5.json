{
    "author": "LarryLansing",
    "message": "Add move constructor and assignment for tstring from std::string.\n\nThis change introduces explicit tstring(std::string&& str) and tstring& operator=(std::string&& str) to enable zero-copy conversion from rvalue std::string objects. For strings larger than the small capacity, tstring now takes ownership of the std::string's data, effectively becoming a view. Small strings are still copied.\n\nComments are also updated to clarify that absl::Cord constructors and assignments also perform zero-copy by holding a reference. Unit tests are added to verify the behavior of the new move operations for both short and long strings. An existing test expectation in TStringTest.LargeToSmall was updated to reflect the new VIEW type for large strings.\n\nPiperOrigin-RevId: 840443437",
    "sha": "a9b852330528c13e41f5c955bd0974d41179afa5",
    "files": [
        {
            "sha": "c191c5077342d2539630aa5f4ee690a513d01d8a",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/tstring.h",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a9b852330528c13e41f5c955bd0974d41179afa5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a9b852330528c13e41f5c955bd0974d41179afa5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring.h?ref=a9b852330528c13e41f5c955bd0974d41179afa5",
            "patch": "@@ -140,12 +140,13 @@ class tstring {\n   // Ctor\n   tstring();\n   tstring(const std::string& str);  // NOLINT TODO(b/147740521): Make explicit.\n+  explicit tstring(std::string&& str);  // Zero-copy, takes rvalue ownership.\n   tstring(const char* str, size_t len);\n   tstring(const char* str);  // NOLINT TODO(b/147740521): Make explicit.\n   tstring(size_t n, char c);\n   explicit tstring(const absl::string_view str);\n #ifdef PLATFORM_GOOGLE\n-  explicit tstring(const absl::Cord& cord);\n+  explicit tstring(const absl::Cord& cord);  // Zero-copy, holds reference.\n #endif  // PLATFORM_GOOGLE\n \n   // Copy\n@@ -160,11 +161,12 @@ class tstring {\n   // Copy Assignment\n   tstring& operator=(const tstring& str);\n   tstring& operator=(const std::string& str);\n+  tstring& operator=(std::string&& str);  // Zero-copy, takes rvalue ownership.\n   tstring& operator=(const char* str);\n   tstring& operator=(char ch);\n   tstring& operator=(const absl::string_view str);\n #ifdef PLATFORM_GOOGLE\n-  tstring& operator=(const absl::Cord& cord);\n+  tstring& operator=(const absl::Cord& cord);  // Zero-copy, holds reference.\n #endif  // PLATFORM_GOOGLE\n \n   // View Assignment\n@@ -304,6 +306,17 @@ inline tstring::tstring(size_t n, char c) {\n inline tstring::tstring(const std::string& str)\n     : tstring(str.data(), str.size()) {}\n \n+inline tstring::tstring(std::string&& str) {\n+  TF_TString_Init(&tstr_);\n+  if (str.size() > TF_TString_SmallCapacity) {\n+    auto* str_owner = new tstring::owner<std::string>(std::move(str));\n+    assign_as_shared_view(absl::string_view(str_owner->value()), str_owner);\n+    str_owner->Unref();\n+  } else {\n+    TF_TString_Copy(&tstr_, str.data(), str.size());\n+  }\n+}\n+\n inline tstring::tstring(const absl::string_view str)\n     : tstring(str.data(), str.size()) {}\n \n@@ -355,6 +368,17 @@ inline tstring& tstring::operator=(const std::string& str) {\n   return *this;\n }\n \n+inline tstring& tstring::operator=(std::string&& str) {\n+  if (str.size() > TF_TString_SmallCapacity) {\n+    auto* str_owner = new tstring::owner<std::string>(std::move(str));\n+    assign_as_shared_view(absl::string_view(str_owner->value()), str_owner);\n+    str_owner->Unref();\n+  } else {\n+    TF_TString_Copy(&tstr_, str.data(), str.size());\n+  }\n+  return *this;\n+}\n+\n inline tstring& tstring::operator=(const char* str) {\n   TF_TString_Copy(&tstr_, str, ::strlen(str));\n "
        },
        {
            "sha": "436d36684a966e34b20d2da323b5c3113ff3480e",
            "filename": "third_party/xla/third_party/tsl/tsl/platform/tstring_test.cc",
            "status": "modified",
            "additions": 61,
            "deletions": 1,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a9b852330528c13e41f5c955bd0974d41179afa5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a9b852330528c13e41f5c955bd0974d41179afa5/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Ftsl%2Ftsl%2Fplatform%2Ftstring_test.cc?ref=a9b852330528c13e41f5c955bd0974d41179afa5",
            "patch": "@@ -111,7 +111,7 @@ TEST(TF_TStringTest, Assignment) {\n   s32 = std::string(kLongString);\n \n   EXPECT_EQ(kLongString, s32);\n-  EXPECT_EQ(tstring::Type::LARGE, s32.type());\n+  EXPECT_EQ(tstring::Type::VIEW, s32.type());\n   EXPECT_EQ(kLongStringLen, s32.size());\n \n   // LARGE -> SMALL\n@@ -484,3 +484,63 @@ TEST(OwnerTest, Assign) {\n   s3.clear();\n   EXPECT_TRUE(deleted);\n }\n+\n+TEST(TStringStdStringRvalueTest, ConstructShort) {\n+  std::string s = \"short\";\n+  tsl::tstring ts(std::move(s));\n+  EXPECT_EQ(ts, \"short\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::SMALL);\n+}\n+\n+TEST(TStringStdStringRvalueTest, AssignShort) {\n+  std::string s = \"short\";\n+  tsl::tstring ts;\n+  ts = std::move(s);\n+  EXPECT_EQ(ts, \"short\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::SMALL);\n+}\n+\n+TEST(TStringStdStringRvalueTest, ConstructLong) {\n+  std::string s = \"this is a long string that will not fit in small capacity\";\n+  tsl::tstring ts(std::move(s));\n+  EXPECT_EQ(ts, \"this is a long string that will not fit in small capacity\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::VIEW);\n+}\n+\n+TEST(TStringStdStringRvalueTest, AssignLong) {\n+  std::string s = \"this is a long string that will not fit in small capacity\";\n+  tsl::tstring ts;\n+  ts = std::move(s);\n+  EXPECT_EQ(ts, \"this is a long string that will not fit in small capacity\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::VIEW);\n+}\n+\n+TEST(TStringStdStringLvalueTest, ConstructLvalueLong) {\n+  std::string s = \"this is a long string that will not fit in small capacity\";\n+  tsl::tstring ts(s);\n+  EXPECT_EQ(ts, \"this is a long string that will not fit in small capacity\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::LARGE);\n+}\n+\n+TEST(TStringStdStringLvalueTest, AssignLvalueLong) {\n+  std::string s = \"this is a long string that will not fit in small capacity\";\n+  tsl::tstring ts;\n+  ts = s;\n+  EXPECT_EQ(ts, \"this is a long string that will not fit in small capacity\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::LARGE);\n+}\n+\n+TEST(TStringStdStringLvalueTest, ConstructLvalueShort) {\n+  std::string s = \"short\";\n+  tsl::tstring ts(s);\n+  EXPECT_EQ(ts, \"short\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::SMALL);\n+}\n+\n+TEST(TStringStdStringLvalueTest, AssignLvalueShort) {\n+  std::string s = \"short\";\n+  tsl::tstring ts;\n+  ts = s;\n+  EXPECT_EQ(ts, \"short\");\n+  EXPECT_EQ(ts.type(), tsl::tstring::Type::SMALL);\n+}"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 87,
        "deletions": 3
    }
}