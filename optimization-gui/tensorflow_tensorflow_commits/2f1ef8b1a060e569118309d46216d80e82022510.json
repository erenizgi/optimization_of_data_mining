{
    "author": "alekstheod",
    "message": "PR #33188: [ROCm] Fix hermetic tests when executing on rbe worker\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33188\n\nüìù Summary of Changes\nFix tests when executing on rbe\n\nüéØ Justification\nFix hermetic dependencies so right libs are loaded.\nLibs are put as a data dependency as many of the rocm libs may have their own\nRPATH=$ORIGIN/..., they will try to load the libs from the place where they are.\nThis leads to a situation that one lib located in _solid_data dir will try to find its\ndependencies in the same dir. However dependency might be located in the data\ndirectory. Then either test can't load the lib or tries to load one from the system libs.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nBuild fix\n\nüß™ Unit Tests:\nBuild fix\n\nüß™ Execution Tests:\nBuild fix\n\nCopybara import of the project:\n\n--\n43913bfbacc042c7a81e692cfa28e0a0733c3989 by Alexandros Theodoridis <atheodor@amd.com>:\n\nAdd minimal hip runtime deps to kernel_headers\n\n--\nffb62f536608b00445fda4fce0a3323c5bf6fe9d by Alexandros Theodoridis <atheodor@amd.com>:\n\nFix hermetic build invalid local rpath\n\nMerging this change closes #33188\n\nPiperOrigin-RevId: 826014075",
    "sha": "2f1ef8b1a060e569118309d46216d80e82022510",
    "files": [
        {
            "sha": "257d370208ed45d78253d7a1b160ccf681d18011",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 23,
            "deletions": 14,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2f1ef8b1a060e569118309d46216d80e82022510/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2f1ef8b1a060e569118309d46216d80e82022510/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=2f1ef8b1a060e569118309d46216d80e82022510",
            "patch": "@@ -140,7 +140,7 @@ cc_library(\n     name = \"rocm_rpath\",\n     linkopts = select({\n         \":build_hermetic\": [\n-            \"-Wl,-rpath,%{rocm_toolkit_path}/lib\",\n+            \"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\",\n         ],\n         \":multiple_rocm_paths\": [\n             \"-Wl,-rpath=%{rocm_lib_paths}\",\n@@ -164,7 +164,7 @@ cc_library(\n cc_library(\n     name = \"rocm_hip\",\n     srcs = glob([\n-        \"%{rocm_root}/lib/libamdhip*.so\",\n+        \"%{rocm_root}/lib/libamdhip*.so*\",\n         \"%{rocm_root}/lib/libhiprtc.so*\",\n         \"%{rocm_root}/lib/libhiprtc-builtins.so*\",\n     ]),\n@@ -189,9 +189,10 @@ cc_library(\n cc_library(\n     name = \"hip_runtime\",\n     srcs = glob([\n-        \"%{rocm_root}/lib/libamdhip*.so\",\n+        \"%{rocm_root}/lib/libamdhip*.so*\",\n         \"%{rocm_root}/lib/libhiprtc.so*\",\n         \"%{rocm_root}/lib/libhiprtc-builtins.so*\",\n+        \"%{rocm_root}/lib/libamd_comgr.so*\",\n     ]),\n     hdrs = glob([\"%{rocm_root}/include/hip/**\"]),\n     include_prefix = \"rocm\",\n@@ -204,6 +205,7 @@ cc_library(\n         \":rocm_config\",\n         \":rocprofiler_register\",\n         \":system_libs\",\n+        \":amd_comgr\",\n     ],\n )\n \n@@ -220,15 +222,19 @@ cc_library(\n     ],\n     # workaround to  bring tensile files to the same fs layout as expected in the lib\n     # rocblas assumes that tensile files are located in ../roblas/libraries directory\n-    linkopts = [\"-Wl,-rpath,local_config_rocm/rocm/rocm_dis/lib\"],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":hipblaslt\"\n+    ],\n )\n \n cc_library(\n     name = \"rocfft\",\n-    srcs = glob([\"%{rocm_root}/lib/librocfft*.so*\"]),\n+    data = glob([\"%{rocm_root}/lib/librocfft*.so*\"]),\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include\",\n@@ -240,7 +246,8 @@ cc_library(\n \n cc_library(\n     name = \"hipfft\",\n-    srcs = glob([\"%{rocm_root}/lib/libhipfft*.so*\"]),\n+    data = glob([\"%{rocm_root}/lib/libhipfft*.so*\"]),\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include\",\n@@ -278,12 +285,12 @@ cc_library(\n     ],\n     # workaround to  bring miopen db files to the same fs layout as expected in the lib\n     # rocblas assumes that miopen db files are located in ../share/miopen/db directory\n-    linkopts = [\"-Wl,-rpath,local_config_rocm/rocm/rocm_dis/lib\"],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":rocm_config\",\n         \":rocm-core\",\n+        \":rocm_config\",\n     ],\n )\n \n@@ -369,7 +376,7 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n-    linkopts = [\"-Wl,-rpath,local_config_rocm/rocm/rocm_dis/lib\"],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\":rocm_config\"],\n@@ -408,9 +415,9 @@ cc_library(\n     includes = [\n         \"%{rocm_root}/include/\",\n     ],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n-    linkopts = [\"-Wl,-rpath,local_config_rocm/rocm/rocm_dis/lib\"],\n     deps = [\n         \":hipblas-common\",\n         \":rocm_config\",\n@@ -429,7 +436,6 @@ cc_library(\n     deps = [\":rocm_config\"],\n )\n \n-\n cc_library(\n     name = \"rocm-core\",\n     srcs = glob([\n@@ -452,10 +458,13 @@ cc_library(\n     ],\n     # workaround to  bring tensile files to the same fs layout as expected in the lib\n     # hibplatslt assumes that tensile files are located in ../hipblaslt/library directory\n-    linkopts = [\"-Wl,-rpath,local_config_rocm/rocm/rocm_dis/lib\"],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n-    deps = [\":rocm_config\"],\n+    deps = [\n+        \":rocm_config\",\n+        \":hip_runtime\",\n+    ],\n )\n \n cc_library("
        }
    ],
    "stats": {
        "total": 37,
        "additions": 23,
        "deletions": 14
    }
}