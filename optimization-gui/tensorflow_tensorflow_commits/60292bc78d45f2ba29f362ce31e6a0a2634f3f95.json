{
    "author": "ezhulenev",
    "message": "[xla:cpu] Move JitMemoryMaper to xla/backends/cpu/codegen\n\nPiperOrigin-RevId: 835319917",
    "sha": "60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
    "files": [
        {
            "sha": "ee7a7c00b8e4c2503b585fc4d7328b9c9f8becc8",
            "filename": "third_party/xla/xla/backends/cpu/codegen/BUILD",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD?ref=60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
            "patch": "@@ -270,10 +270,10 @@ cc_library(\n         \":cpu_features\",\n         \":execution_engine\",\n         \":ir_compiler\",\n+        \":jit_memory_mapper\",\n         \":object_loader\",\n         \"//xla:util\",\n         \"//xla/backends/cpu/runtime:function_library\",\n-        \"//xla/service/cpu:orc_jit_memory_mapper\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/base\",\n@@ -311,7 +311,7 @@ cc_library(\n         \"@llvm-project//llvm:SystemZCodeGen\",  # fixdeps: keep\n     ]) + if_llvm_x86_available([\n         \"@llvm-project//llvm:X86CodeGen\",  # fixdeps: keep\n-    ]) + xla_internal([\"service/cpu:named_orc_jit_memory_mapper\"]),\n+    ]) + xla_internal([\"service/cpu:named_jit_memory_mapper\"]),\n )\n \n xla_cc_test(\n@@ -343,6 +343,22 @@ xla_cc_test(\n     ],\n )\n \n+cc_library(\n+    name = \"jit_memory_mapper\",\n+    srcs = [\"jit_memory_mapper.cc\"],\n+    hdrs = [\"jit_memory_mapper.h\"],\n+    deps = [\n+        \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/container:flat_hash_map\",\n+        \"@com_google_absl//absl/functional:any_invocable\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/strings:string_view\",\n+        \"@com_google_absl//absl/synchronization\",\n+        \"@llvm-project//llvm:ExecutionEngine\",\n+    ],\n+)\n+\n cc_library(\n     name = \"polynomial_approximations\",\n     srcs = [\"polynomial_approximations.cc\"],\n@@ -543,8 +559,8 @@ cc_library(\n         \":compiled_function_library\",\n         \":contiguous_section_memory_manager\",\n         \":execution_engine\",\n+        \":jit_memory_mapper\",\n         \"//xla/backends/cpu/runtime:function_library\",\n-        \"//xla/service/cpu:orc_jit_memory_mapper\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\",\n@@ -567,7 +583,7 @@ cc_library(\n     hdrs = [\"execution_engine.h\"],\n     deps = [\n         \":contiguous_section_memory_manager\",\n-        \"//xla/service/cpu:orc_jit_memory_mapper\",\n+        \":jit_memory_mapper\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\","
        },
        {
            "sha": "ec5bfbb34536cc70d54c789174976de11acaf8b3",
            "filename": "third_party/xla/xla/backends/cpu/codegen/execution_engine.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fexecution_engine.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fexecution_engine.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fexecution_engine.cc?ref=60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
            "patch": "@@ -29,7 +29,7 @@ limitations under the License.\n #include \"llvm/Support/Error.h\"\n #include \"llvm/Support/MemoryBuffer.h\"\n #include \"xla/backends/cpu/codegen/contiguous_section_memory_manager.h\"\n-#include \"xla/service/cpu/orc_jit_memory_mapper.h\"\n+#include \"xla/backends/cpu/codegen/jit_memory_mapper.h\"\n \n namespace xla::cpu {\n \n@@ -38,7 +38,7 @@ CreateObjectLinkingLayer(llvm::orc::ExecutionSession& execution_session) {\n   return std::make_unique<llvm::orc::RTDyldObjectLinkingLayer>(\n       execution_session, [](const llvm::MemoryBuffer& obj) {\n         return std::make_unique<ContiguousSectionMemoryManager>(\n-            orc_jit_memory_mapper::GetInstance(obj.getBufferIdentifier()));\n+            GetJitMemoryMapper(obj.getBufferIdentifier()));\n       });\n }\n "
        },
        {
            "sha": "ef518190305d343957fa81243ae66b9f67d6d378",
            "filename": "third_party/xla/xla/backends/cpu/codegen/jit_memory_mapper.cc",
            "status": "renamed",
            "additions": 24,
            "deletions": 35,
            "changes": 59,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_memory_mapper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_memory_mapper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_memory_mapper.cc?ref=60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
            "patch": "@@ -13,41 +13,49 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/service/cpu/orc_jit_memory_mapper.h\"\n+#include \"xla/backends/cpu/codegen/jit_memory_mapper.h\"\n \n #include <atomic>\n #include <memory>\n #include <string>\n \n #include \"absl/base/const_init.h\"\n+#include \"absl/base/no_destructor.h\"\n #include \"absl/base/thread_annotations.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/log/check.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"llvm/ExecutionEngine/SectionMemoryManager.h\"\n \n-namespace xla {\n-namespace cpu {\n-namespace orc_jit_memory_mapper {\n+namespace xla::cpu {\n \n-static std::atomic<Registrar::MemoryMapperGetter*> mapper_getter_ptr{nullptr};\n+static absl::NoDestructor<\n+    std::atomic<internal::JitMemoryMapperRegistration::MemoryMapperGetter*>>\n+    mapper_getter(nullptr);\n \n static absl::Mutex mapper_instances_mutex(absl::kConstInit);\n-static absl::flat_hash_map<std::string,\n-                           llvm::SectionMemoryManager::MemoryMapper*>*\n-    mapper_instances ABSL_GUARDED_BY(mapper_instances_mutex) = nullptr;\n+static absl::NoDestructor<\n+    absl::flat_hash_map<std::string, llvm::SectionMemoryManager::MemoryMapper*>>\n+    mapper_instances ABSL_GUARDED_BY(mapper_instances_mutex);\n+\n+internal::JitMemoryMapperRegistration::JitMemoryMapperRegistration(\n+    JitMemoryMapperRegistration::MemoryMapperGetter* getter) {\n+  JitMemoryMapperRegistration::MemoryMapperGetter* expected_nullptr = nullptr;\n+  CHECK(mapper_getter->compare_exchange_strong(expected_nullptr, getter,\n+                                               std::memory_order_release,\n+                                               std::memory_order_acquire));\n+}\n \n-llvm::SectionMemoryManager::MemoryMapper* GetInstance(\n+llvm::SectionMemoryManager::MemoryMapper* GetJitMemoryMapper(\n     absl::string_view allocation_region_name) {\n-  Registrar::MemoryMapperGetter* getter =\n-      mapper_getter_ptr.load(std::memory_order_acquire);\n+  internal::JitMemoryMapperRegistration::MemoryMapperGetter* getter =\n+      mapper_getter->load(std::memory_order_acquire);\n \n-  {\n-    if (getter == nullptr) {\n-      return nullptr;\n-    }\n+  if (getter == nullptr) {\n+    return nullptr;\n   }\n+\n   absl::MutexLock lock(mapper_instances_mutex);\n   auto it = mapper_instances->find(allocation_region_name);\n   if (it == mapper_instances->end()) {\n@@ -60,23 +68,4 @@ llvm::SectionMemoryManager::MemoryMapper* GetInstance(\n   return it->second;\n }\n \n-Registrar::Registrar(Registrar::MemoryMapperGetter* mapper_getter) {\n-  Registrar::MemoryMapperGetter* expected_nullptr = nullptr;\n-\n-  CHECK(mapper_getter_ptr.compare_exchange_strong(\n-      expected_nullptr, mapper_getter, std::memory_order_release,\n-      std::memory_order_acquire));\n-\n-  {\n-    absl::MutexLock lock(mapper_instances_mutex);\n-    if (mapper_instances == nullptr) {\n-      mapper_instances =\n-          new absl::flat_hash_map<std::string,\n-                                  llvm::SectionMemoryManager::MemoryMapper*>();\n-    }\n-  }\n-}\n-\n-}  // namespace orc_jit_memory_mapper\n-}  // namespace cpu\n-}  // namespace xla\n+}  // namespace xla::cpu",
            "previous_filename": "third_party/xla/xla/service/cpu/orc_jit_memory_mapper.cc"
        },
        {
            "sha": "c573c8e5f6c795db042110e38199c9accc68b64f",
            "filename": "third_party/xla/xla/backends/cpu/codegen/jit_memory_mapper.h",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_memory_mapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_memory_mapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fjit_memory_mapper.h?ref=60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
            "patch": "@@ -0,0 +1,57 @@\n+/* Copyright 2017 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_BACKENDS_CPU_CODEGEN_JIT_MEMORY_MAPPER_H_\n+#define XLA_BACKENDS_CPU_CODEGEN_JIT_MEMORY_MAPPER_H_\n+\n+#include <memory>\n+\n+#include \"absl/strings/string_view.h\"\n+#include \"llvm/ExecutionEngine/SectionMemoryManager.h\"\n+\n+namespace xla::cpu {\n+\n+// Registers (if needed) a memory mapper by name and returns it if the\n+// memory mapper getter has been set. Otherwise returns nullptr.\n+llvm::SectionMemoryManager::MemoryMapper* GetJitMemoryMapper(\n+    absl::string_view allocation_region_name);\n+\n+namespace internal {\n+// Registers the `mapper_getter`.  This is a no-op if `mapper_getter` is\n+// null. Precondition:  no other memory mapper getter has been registered yet.\n+class JitMemoryMapperRegistration {\n+ public:\n+  using MemoryMapperGetter =\n+      std::unique_ptr<llvm::SectionMemoryManager::MemoryMapper>(\n+          absl::string_view allocation_region_name);\n+  explicit JitMemoryMapperRegistration(MemoryMapperGetter* mapper_getter);\n+};\n+\n+}  // namespace internal\n+}  // namespace xla::cpu\n+\n+#define XLA_CPU_INTERNAL_REGISTER_JIT_MEMORY_MAPPER_GETTER(INSTANCE, COUNT)  \\\n+  static absl::NoDestructor<xla::cpu::internal::JitMemoryMapperRegistration> \\\n+  XLA_CPU_INTERNAL_REGISTER_JIT_MEMORY_MAPPER_GETTER_NAME(COUNT)(INSTANCE)\n+\n+// __COUNTER__ must go through another macro to be properly expanded\n+#define XLA_CPU_INTERNAL_REGISTER_JIT_MEMORY_MAPPER_GETTER_NAME(COUNT) \\\n+  __xla_cpu_jit_memory_mapper_registration_##COUNT\n+\n+// Registers the MemoryMapperGetter.\n+#define XLA_CPU_REGISTER_JIT_MEMORY_MAPPER_GETTER(factory) \\\n+  XLA_CPU_INTERNAL_REGISTER_JIT_MEMORY_MAPPER_GETTER(factory, __COUNTER__)\n+\n+#endif  // XLA_BACKENDS_CPU_CODEGEN_JIT_MEMORY_MAPPER_H_"
        },
        {
            "sha": "16a35da816f8ef0d2560623d0106dc6dcddb7848",
            "filename": "third_party/xla/xla/codegen/intrinsic/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Fintrinsic%2FBUILD?ref=60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
            "patch": "@@ -128,8 +128,6 @@ cc_library(\n     deps = [\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n-        \"//xla/backends/cpu/codegen:contiguous_section_memory_manager\",\n-        \"//xla/service/cpu:orc_jit_memory_mapper\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/util:safe_reinterpret_cast\",\n         \"@com_google_absl//absl/base\","
        },
        {
            "sha": "e58542fe2679106e8c82f7977ac9ee0c2acba52a",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60292bc78d45f2ba29f362ce31e6a0a2634f3f95/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=60292bc78d45f2ba29f362ce31e6a0a2634f3f95",
            "patch": "@@ -1309,21 +1309,6 @@ cc_library(\n     ],\n )\n \n-cc_library(\n-    name = \"orc_jit_memory_mapper\",\n-    srcs = [\"orc_jit_memory_mapper.cc\"],\n-    hdrs = [\"orc_jit_memory_mapper.h\"],\n-    deps = [\n-        \"@com_google_absl//absl/base:core_headers\",\n-        \"@com_google_absl//absl/container:flat_hash_map\",\n-        \"@com_google_absl//absl/functional:any_invocable\",\n-        \"@com_google_absl//absl/log:check\",\n-        \"@com_google_absl//absl/strings:string_view\",\n-        \"@com_google_absl//absl/synchronization\",\n-        \"@llvm-project//llvm:ExecutionEngine\",\n-    ],\n-)\n-\n xla_cc_test(\n     name = \"cpu_eigen_tensor_alignment_test\",\n     size = \"small\","
        },
        {
            "sha": "52b1bf0cc0062fbdf38318f956c6d30cb3c0bf6a",
            "filename": "third_party/xla/xla/service/cpu/orc_jit_memory_mapper.h",
            "status": "removed",
            "additions": 0,
            "deletions": 61,
            "changes": 61,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7107850218d10650c5f81fe7d2727d845c1cda66/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Forc_jit_memory_mapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7107850218d10650c5f81fe7d2727d845c1cda66/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Forc_jit_memory_mapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Forc_jit_memory_mapper.h?ref=7107850218d10650c5f81fe7d2727d845c1cda66",
            "patch": "@@ -1,61 +0,0 @@\n-/* Copyright 2017 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#ifndef XLA_SERVICE_CPU_ORC_JIT_MEMORY_MAPPER_H_\n-#define XLA_SERVICE_CPU_ORC_JIT_MEMORY_MAPPER_H_\n-\n-#include <memory>\n-\n-#include \"absl/strings/string_view.h\"\n-#include \"llvm/ExecutionEngine/SectionMemoryManager.h\"\n-\n-namespace xla {\n-namespace cpu {\n-\n-namespace orc_jit_memory_mapper {\n-// Registers (if needed) a memory mapper by name and returns it if the\n-// memory mapper getter has been set.  Otherwise returns nullptr.\n-llvm::SectionMemoryManager::MemoryMapper* GetInstance(\n-    absl::string_view allocation_region_name);\n-\n-class Registrar {\n- public:\n-  using MemoryMapperGetter =\n-      std::unique_ptr<llvm::SectionMemoryManager::MemoryMapper>(\n-          absl::string_view allocation_region_name);\n-  // Registers the `mapper_getter`.  This is a no-op if `mapper_getter` is\n-  // null.  Precondition:  no other memory mapper getter has been registered\n-  // yet.\n-  explicit Registrar(MemoryMapperGetter* mapper_getter);\n-};\n-}  // namespace orc_jit_memory_mapper\n-\n-#define XLA_INTERNAL_REGISTER_ORC_JIT_MEMORY_MAPPER_GETTER(mapper_instance, \\\n-                                                           ctr)             \\\n-  static ::xla::cpu::orc_jit_memory_mapper::Registrar                       \\\n-  XLA_INTERNAL_REGISTER_ORC_JIT_MEMORY_MAPPER_GETTER_NAME(ctr)(             \\\n-      mapper_instance)\n-\n-// __COUNTER__ must go through another macro to be properly expanded\n-#define XLA_INTERNAL_REGISTER_ORC_JIT_MEMORY_MAPPER_GETTER_NAME(ctr) \\\n-  __orc_jit_memory_mapper_registrar_##ctr\n-\n-// Registers the MemoryMapperGetter.\n-#define XLA_REGISTER_ORC_JIT_MEMORY_MAPPER_GETTER(factory) \\\n-  XLA_INTERNAL_REGISTER_ORC_JIT_MEMORY_MAPPER_GETTER(factory, __COUNTER__)\n-}  // namespace cpu\n-}  // namespace xla\n-\n-#endif  // XLA_SERVICE_CPU_ORC_JIT_MEMORY_MAPPER_H_"
        }
    ],
    "stats": {
        "total": 222,
        "additions": 103,
        "deletions": 119
    }
}