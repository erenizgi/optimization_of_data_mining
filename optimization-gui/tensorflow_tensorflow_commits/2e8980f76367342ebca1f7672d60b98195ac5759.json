{
    "author": "yangustc07",
    "message": "#tf-data-service Add a test for sampling with `replicate_on_split`.\n\nPiperOrigin-RevId: 812994177",
    "sha": "2e8980f76367342ebca1f7672d60b98195ac5759",
    "files": [
        {
            "sha": "3e97562e283c43d0d6ea1476253d10d44e80e1f3",
            "filename": "tensorflow/python/data/experimental/kernel_tests/service/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e8980f76367342ebca1f7672d60b98195ac5759/tensorflow%2Fpython%2Fdata%2Fexperimental%2Fkernel_tests%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e8980f76367342ebca1f7672d60b98195ac5759/tensorflow%2Fpython%2Fdata%2Fexperimental%2Fkernel_tests%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Fdata%2Fexperimental%2Fkernel_tests%2Fservice%2FBUILD?ref=2e8980f76367342ebca1f7672d60b98195ac5759",
            "patch": "@@ -137,6 +137,7 @@ tf_py_strict_test(\n         \"//tensorflow/python/data/ops:dataset_ops\",\n         \"//tensorflow/python/data/ops:readers\",\n         \"//tensorflow/python/framework:combinations\",\n+        \"//tensorflow/python/framework:dtypes\",\n         \"//tensorflow/python/framework:errors\",\n         \"//tensorflow/python/ops:math_ops\",\n         \"//tensorflow/python/ops:random_ops\","
        },
        {
            "sha": "708a5123359e835bb9c50e50be28fda5bfc6834e",
            "filename": "tensorflow/python/data/experimental/kernel_tests/service/dynamic_sharding_test.py",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2e8980f76367342ebca1f7672d60b98195ac5759/tensorflow%2Fpython%2Fdata%2Fexperimental%2Fkernel_tests%2Fservice%2Fdynamic_sharding_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2e8980f76367342ebca1f7672d60b98195ac5759/tensorflow%2Fpython%2Fdata%2Fexperimental%2Fkernel_tests%2Fservice%2Fdynamic_sharding_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Fdata%2Fexperimental%2Fkernel_tests%2Fservice%2Fdynamic_sharding_test.py?ref=2e8980f76367342ebca1f7672d60b98195ac5759",
            "patch": "@@ -14,6 +14,7 @@\n # ==============================================================================\n \"\"\"Tests for dynamic sharding.\"\"\"\n import collections\n+\n from absl.testing import parameterized\n import numpy as np\n \n@@ -24,6 +25,7 @@\n from tensorflow.python.data.ops import dataset_ops\n from tensorflow.python.data.ops import readers\n from tensorflow.python.framework import combinations\n+from tensorflow.python.framework import dtypes\n from tensorflow.python.framework import errors\n from tensorflow.python.ops import math_ops\n from tensorflow.python.ops import random_ops\n@@ -321,8 +323,7 @@ def testChooseFromDatasets(self, num_workers):\n     self.assertDatasetProduces(\n         ds, expected, assert_items_equal=assert_items_equal)\n \n-  @combinations.generate(\n-      combinations.times(test_base.default_test_combinations()))\n+  @combinations.generate(test_base.default_test_combinations())\n   def testEnumerateReplicateOnSplit(self):\n     num_workers = 3\n     cluster = data_service_test_base.TestCluster(num_workers)\n@@ -342,6 +343,26 @@ def testEnumerateReplicateOnSplit(self):\n     for i in range(10):\n       self.assertEqual(counts[i], num_workers)\n \n+  @combinations.generate(test_base.default_test_combinations())\n+  def testZipReplicateOnSplit(self):\n+    num_workers = 3\n+    cluster = data_service_test_base.TestCluster(num_workers)\n+\n+    ds1 = dataset_ops.Dataset.range(100, 1000, output_type=dtypes.int32)\n+    ds2 = dataset_ops.Dataset.from_tensor_slices(range(0, 5))\n+    ds2 = dataset_ops._apply_rewrite(ds2, \"replicate_on_split\")\n+\n+    ds = dataset_ops.Dataset.zip(ds1, ds2)\n+    ds = ds.apply(\n+        data_service_ops.distribute(\n+            data_service_ops.ShardingPolicy.DYNAMIC,\n+            cluster.dispatcher_address(),\n+            job_name=\"shared_job\",\n+        )\n+    )\n+    ds2_output = [y for x, y in self.getDatasetOutput(ds)]\n+    self.assertCountEqual(ds2_output, [0, 1, 2, 3, 4] * num_workers)\n+\n   @combinations.generate(\n       combinations.times(test_base.default_test_combinations(),\n                          combinations.combine(num_workers=[1, 3])))"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 24,
        "deletions": 2
    }
}