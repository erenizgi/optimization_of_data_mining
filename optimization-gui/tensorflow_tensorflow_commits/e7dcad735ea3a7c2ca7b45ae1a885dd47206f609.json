{
    "author": "KanishAnand",
    "message": "Add equality operator for `NamedSharding`\n\nPiperOrigin-RevId: 826442714",
    "sha": "e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
    "files": [
        {
            "sha": "f00e2e65212b360fbff5b3ef6a72167d8ee1648e",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
            "patch": "@@ -199,6 +199,7 @@ cc_library(\n     deps = [\n         \":mesh_and_axis\",\n         \"//xla:xla_data_proto_cc\",\n+        \"@com_google_absl//absl/types:span\",\n     ],\n )\n \n@@ -438,6 +439,17 @@ xla_cc_test(\n     ],\n )\n \n+xla_cc_test(\n+    name = \"named_sharding_test\",\n+    srcs = [\"named_sharding_test.cc\"],\n+    deps = [\n+        \":mesh_and_axis\",\n+        \":named_sharding\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n xla_cc_test(\n     name = \"hlo_casting_utils_test\",\n     srcs = [\"hlo_casting_utils_test.cc\"],"
        },
        {
            "sha": "c6ffee0d8afa03489cf93649dc3c91d5cb50dbd8",
            "filename": "third_party/xla/xla/hlo/ir/hlo_sharding.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_sharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_sharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_sharding.h?ref=e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
            "patch": "@@ -447,7 +447,8 @@ class HloSharding {\n            tuple_elements_ == other.tuple_elements_ &&\n            replicate_on_last_tile_dim_ == other.replicate_on_last_tile_dim_ &&\n            subgroup_types_ == other.subgroup_types_ &&\n-           shard_group_ == other.shard_group_;\n+           shard_group_ == other.shard_group_ &&\n+           named_sharding_ == other.named_sharding_;\n   }\n   bool operator!=(const HloSharding& other) const { return !(*this == other); }\n "
        },
        {
            "sha": "77544458d6dc400230ec21ac5cb3f60bd4b8fa86",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis.h?ref=e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
            "patch": "@@ -75,6 +75,10 @@ class Mesh {\n \n   bool operator!=(const Mesh& other) const { return !(*this == other); }\n \n+  bool DeviceAssignmentEquals(const Mesh& other) const {\n+    return device_assignment_ == other.device_assignment_;\n+  }\n+\n   MeshProto ToProto() const;\n \n   static Mesh FromProto(const MeshProto& proto);"
        },
        {
            "sha": "564e93c73c599bd7b3fef74fbd31ceb220acb397",
            "filename": "third_party/xla/xla/hlo/ir/mesh_and_axis_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fmesh_and_axis_test.cc?ref=e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
            "patch": "@@ -51,6 +51,16 @@ TEST(MeshAndAxisTest, MeshEquality) {\n   EXPECT_NE(Mesh({1, 2, 3}, axes_abc), Mesh({1, 2, 3, 4}, axes_abcd));\n }\n \n+TEST(MeshAndAxisTest, DeviceAssignmentEquality) {\n+  std::vector<std::string> axes_abcd = {\"a\", \"b\", \"c\", \"d\"};\n+  std::vector<std::string> axes_efgh = {\"e\", \"f\", \"g\", \"h\"};\n+  Mesh mesh({1, 2, 3, 4}, axes_abcd);\n+  Mesh mesh_diff_axis_names({1, 2, 3, 4}, axes_efgh);\n+  EXPECT_TRUE(mesh.DeviceAssignmentEquals(mesh_diff_axis_names));\n+  Mesh mesh_other({2, 1, 4, 3}, axes_efgh);\n+  EXPECT_FALSE(mesh.DeviceAssignmentEquals(mesh_other));\n+}\n+\n TEST(MeshAndAxisTest, AxesToProto) {\n   AxisRefProto expected;\n   expected.set_mesh_axis_index(123);"
        },
        {
            "sha": "6cedbf0aed690807d212611af16efa6836c49fcc",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding.h",
            "status": "modified",
            "additions": 40,
            "deletions": 3,
            "changes": 43,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding.h?ref=e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
            "patch": "@@ -16,8 +16,10 @@ limitations under the License.\n #ifndef XLA_HLO_IR_NAMED_SHARDING_H_\n #define XLA_HLO_IR_NAMED_SHARDING_H_\n \n+#include <utility>\n #include <vector>\n \n+#include \"absl/types/span.h\"\n #include \"xla/hlo/ir/mesh_and_axis.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -26,11 +28,46 @@ namespace xla {\n // C++ representation for corresponding `OpSharding::NamedSharding` proto so\n // same documentation applies.\n class NamedSharding {\n-  struct DimensionSharding {\n-    std::vector<AxisRef> axes;\n-    bool is_closed;\n+ public:\n+  class DimensionSharding {\n+   public:\n+    bool operator==(const DimensionSharding& other) const {\n+      return axes_ == other.axes_ && is_closed_ == other.is_closed_;\n+    }\n+\n+    explicit DimensionSharding(std::vector<AxisRef> axes, bool is_closed)\n+        : axes_(std::move(axes)), is_closed_(is_closed) {}\n+\n+   private:\n+    std::vector<AxisRef> axes_;\n+    bool is_closed_;\n   };\n \n+  // Shardings using mesh with similar device assignment should compare equal\n+  bool operator==(const NamedSharding& other) const {\n+    return mesh_.DeviceAssignmentEquals(other.mesh_) &&\n+           dim_shardings_ == other.dim_shardings_ &&\n+           replicated_axes_ == other.replicated_axes_ &&\n+           unreduced_axes_ == other.unreduced_axes_;\n+  }\n+\n+  bool operator!=(const NamedSharding& other) const {\n+    return !(*this == other);\n+  }\n+\n+  // TODO(b/456212087): Add some validation checks\n+  explicit NamedSharding(Mesh mesh,\n+                         absl::Span<const DimensionSharding> dim_shardings = {},\n+                         absl::Span<const AxisRef> replicated_axes = {},\n+                         absl::Span<const AxisRef> unreduced_axes = {},\n+                         absl::Span<const OpMetadata> metadata = {})\n+      : mesh_(std::move(mesh)),\n+        dim_shardings_(dim_shardings.begin(), dim_shardings.end()),\n+        replicated_axes_(replicated_axes.begin(), replicated_axes.end()),\n+        unreduced_axes_(unreduced_axes.begin(), unreduced_axes.end()),\n+        metadata_(metadata.begin(), metadata.end()) {}\n+\n+ private:\n   Mesh mesh_;\n   std::vector<DimensionSharding> dim_shardings_;\n   std::vector<AxisRef> replicated_axes_;"
        },
        {
            "sha": "36e9cfbbba67bb065eedfe6293566c055adf7f72",
            "filename": "third_party/xla/xla/hlo/ir/named_sharding_test.cc",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e7dcad735ea3a7c2ca7b45ae1a885dd47206f609/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fnamed_sharding_test.cc?ref=e7dcad735ea3a7c2ca7b45ae1a885dd47206f609",
            "patch": "@@ -0,0 +1,75 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/hlo/ir/named_sharding.h\"\n+\n+#include <gtest/gtest.h>\n+#include \"xla/hlo/ir/mesh_and_axis.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+namespace {\n+\n+using DimensionSharding = NamedSharding::DimensionSharding;\n+\n+TEST(NamedShardingTest, Equality) {\n+  Mesh mesh_abcd({2, 4, 3, 8}, {\"a\", \"b\", \"c\", \"d\"});\n+\n+  AxisRef axis_a(0);\n+  AxisRef axis_b(1, {2, 2});\n+  AxisRef axis_c(2);\n+  AxisRef axis_d(3, {4, 2});\n+\n+  DimensionSharding ds_ab({axis_a, axis_b}, /*is_closed=*/true);\n+  DimensionSharding ds_ab_open({axis_a, axis_b}, /*is_closed=*/false);\n+  DimensionSharding ds_dc({axis_d, axis_c}, /*is_closed=*/true);\n+\n+  NamedSharding base(mesh_abcd, /*dim_shardings=*/{ds_ab, ds_dc},\n+                     /*replicated_axes=*/{axis_b},\n+                     /*unreduced_axes=*/{axis_c});\n+\n+  EXPECT_EQ(base, NamedSharding(mesh_abcd, {ds_ab, ds_dc}, {axis_b}, {axis_c}));\n+\n+  // Equal even with different mesh axis names\n+  Mesh mesh_cadb({2, 4, 3, 8}, {\"c\", \"a\", \"d\", \"b\"});\n+  EXPECT_EQ(base,\n+            NamedSharding(mesh_cadb, {ds_ab, ds_dc}, {axis_b}, {axis_c}, {}));\n+\n+  // Equal even with different metadata.\n+  OpMetadata metadata;\n+  metadata.set_op_name(\"foo\");\n+  EXPECT_EQ(base, NamedSharding(mesh_abcd, {ds_ab, ds_dc}, {axis_b}, {axis_c},\n+                                {metadata}));\n+\n+  // Different dim_shardings\n+  EXPECT_NE(base,\n+            NamedSharding(mesh_abcd, {ds_ab_open, ds_dc}, {axis_b}, {axis_c}));\n+  EXPECT_NE(base, NamedSharding(mesh_abcd, {ds_dc, ds_ab}, {axis_b}, {axis_c}));\n+  EXPECT_NE(base, NamedSharding(mesh_abcd, {ds_ab}, {axis_b}, {axis_c}));\n+\n+  // Different replicated_axes\n+  EXPECT_NE(base, NamedSharding(mesh_abcd, {ds_ab, ds_dc}, {axis_d}, {axis_c}));\n+\n+  // Different unreduced_axes\n+  EXPECT_NE(base, NamedSharding(mesh_abcd, {ds_ab, ds_dc}, {axis_b}, {axis_a}));\n+\n+  // Different mesh shape\n+  Mesh mesh_diff_shape({2, 4, 3, 9}, {\"a\", \"b\", \"c\", \"d\"});\n+  EXPECT_NE(base,\n+            NamedSharding(mesh_diff_shape, {ds_ab, ds_dc}, {axis_b}, {axis_c}));\n+}\n+\n+}  // namespace\n+}  // namespace xla"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 143,
        "deletions": 4
    }
}