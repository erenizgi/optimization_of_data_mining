{
    "author": "basioli-k",
    "message": "[XLA:CPU] Add ToProto and FromProto functions for CpuTopologyDescription\n\nPiperOrigin-RevId: 816666891",
    "sha": "94c2e2505375465f549fb17c4d5edc034f30d0ce",
    "files": [
        {
            "sha": "91c879b20469204e60230f4b5e1f877f4e0dfb06",
            "filename": "third_party/xla/xla/pjrt/plugin/xla_cpu/BUILD",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/94c2e2505375465f549fb17c4d5edc034f30d0ce/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/94c2e2505375465f549fb17c4d5edc034f30d0ce/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2FBUILD?ref=94c2e2505375465f549fb17c4d5edc034f30d0ce",
            "patch": "@@ -109,6 +109,19 @@ cc_library(\n     ],\n )\n \n+xla_cc_test(\n+    name = \"cpu_topology_description_test\",\n+    srcs = [\"cpu_topology_description_test.cc\"],\n+    deps = [\n+        \":cpu_topology\",\n+        \":cpu_topology_description\",\n+        \"//xla/pjrt:pjrt_compiler\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n xla_cc_test(\n     name = \"cpu_topology_test\",\n     srcs = [\"cpu_topology_test.cc\"],"
        },
        {
            "sha": "87b7ac4f8c77a0a666990cc5a91e9cbb9f1b4f21",
            "filename": "third_party/xla/xla/pjrt/plugin/xla_cpu/cpu_topology_description_test.cc",
            "status": "added",
            "additions": 104,
            "deletions": 0,
            "changes": 104,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/94c2e2505375465f549fb17c4d5edc034f30d0ce/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/94c2e2505375465f549fb17c4d5edc034f30d0ce/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fplugin%2Fxla_cpu%2Fcpu_topology_description_test.cc?ref=94c2e2505375465f549fb17c4d5edc034f30d0ce",
            "patch": "@@ -0,0 +1,104 @@\n+/* Copyright 2024 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/pjrt/plugin/xla_cpu/cpu_topology_description.h\"\n+\n+#include <memory>\n+#include <string>\n+#include <vector>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"xla/pjrt/pjrt_compiler.h\"\n+#include \"xla/pjrt/plugin/xla_cpu/cpu_topology.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+\n+namespace xla {\n+namespace {\n+\n+using ::testing::ElementsAre;\n+\n+TEST(CpuTopologyDescriptionTest, ToProto) {\n+  std::vector<CpuTopology::CpuDevice> cpu_devices = {{0, 0}, {0, 1}};\n+  std::vector<std::string> machine_attributes = {\"attr1\", \"attr2\"};\n+  CpuTopologyDescription topology(xla::CpuId(), \"cpu\", \"1.0\", cpu_devices,\n+                                  machine_attributes);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(PjRtTopologyDescriptionProto proto,\n+                          topology.ToProto());\n+\n+  EXPECT_EQ(proto.platform_id(), xla::CpuId());\n+  EXPECT_EQ(proto.platform_name(), \"cpu\");\n+  EXPECT_EQ(proto.platform_version(), \"1.0\");\n+\n+  CpuTopologyProto cpu_topology_proto;\n+  ASSERT_TRUE(proto.platform_specific_topology().UnpackTo(&cpu_topology_proto));\n+\n+  for (int i = 0; i < cpu_devices.size(); ++i) {\n+    const auto& cpu_device = cpu_devices[i];\n+    EXPECT_EQ(cpu_device.process_id,\n+              cpu_topology_proto.cpu_devices(i).process_index());\n+    EXPECT_EQ(cpu_device.local_device_id,\n+              cpu_topology_proto.cpu_devices(i).local_hardware_id());\n+  }\n+\n+  for (int i = 0; i < machine_attributes.size(); ++i) {\n+    EXPECT_EQ(machine_attributes[i], cpu_topology_proto.machine_attributes(i));\n+  }\n+}\n+\n+TEST(CpuTopologyDescriptionTest, FromProto) {\n+  PjRtTopologyDescriptionProto proto;\n+  proto.set_platform_id(xla::CpuId());\n+  proto.set_platform_name(\"cpu\");\n+  proto.set_platform_version(\"2.0\");\n+\n+  CpuTopologyProto cpu_topology_proto;\n+  auto* device1 = cpu_topology_proto.add_cpu_devices();\n+  device1->set_process_index(0);\n+  device1->set_local_hardware_id(0);\n+  auto* device2 = cpu_topology_proto.add_cpu_devices();\n+  device2->set_process_index(1);\n+  device2->set_local_hardware_id(1);\n+  cpu_topology_proto.add_machine_attributes(\"attrA\");\n+  cpu_topology_proto.add_machine_attributes(\"attrB\");\n+\n+  proto.mutable_platform_specific_topology()->PackFrom(cpu_topology_proto);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<PjRtTopologyDescription> topology_desc,\n+      CpuTopologyDescription::FromProto(proto));\n+\n+  CpuTopologyDescription* cpu_topology =\n+      dynamic_cast<CpuTopologyDescription*>(topology_desc.get());\n+  ASSERT_NE(cpu_topology, nullptr);\n+\n+  EXPECT_EQ(cpu_topology->platform_id(), xla::CpuId());\n+  EXPECT_EQ(cpu_topology->platform_name(), \"cpu\");\n+  EXPECT_EQ(cpu_topology->platform_version(), \"2.0\");\n+\n+  const auto& devices = cpu_topology->cpu_topology().devices();\n+  ASSERT_EQ(devices.size(), 2);\n+  EXPECT_EQ(devices[0].process_id, 0);\n+  EXPECT_EQ(devices[0].local_device_id, 0);\n+  EXPECT_EQ(devices[1].process_id, 1);\n+  EXPECT_EQ(devices[1].local_device_id, 1);\n+\n+  EXPECT_THAT(cpu_topology->cpu_topology().machine_attributes(),\n+              ElementsAre(\"attrA\", \"attrB\"));\n+}\n+\n+}  // namespace\n+}  // namespace xla"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 117,
        "deletions": 0
    }
}