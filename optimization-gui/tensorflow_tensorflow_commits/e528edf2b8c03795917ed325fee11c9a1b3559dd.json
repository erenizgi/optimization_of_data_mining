{
    "author": "ezhulenev",
    "message": "[xla:cpu] Remove unused runtime_lightweight_check\n\nPiperOrigin-RevId: 834839651",
    "sha": "e528edf2b8c03795917ed325fee11c9a1b3559dd",
    "files": [
        {
            "sha": "8fc542509fd5bb617642dae709fcf2bbb2834525",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=e528edf2b8c03795917ed325fee11c9a1b3559dd",
            "patch": "@@ -66,7 +66,6 @@ filegroup(\n         # Single-threaded support.\n         \"runtime_single_threaded_matmul.h\",\n         # Multi-threaded support.\n-        \"runtime_lightweight_check.h\",\n         \"//xla/backends/cpu/runtime:runtime_hdrs\",\n     ],\n     visibility = internal_visibility([\":friends\"]),\n@@ -534,13 +533,6 @@ tf_proto_library(\n     ],\n )\n \n-cc_library(\n-    name = \"runtime_lightweight_check\",\n-    hdrs = [\"runtime_lightweight_check.h\"],\n-    compatible_with = get_compatible_with_portable(),\n-    copts = runtime_copts(),\n-)\n-\n cc_library(\n     name = \"cpu_executable\",\n     srcs = [\"cpu_executable.cc\"],\n@@ -1440,14 +1432,14 @@ onednn_cc_library(\n     copts = runtime_copts() + tsl_copts(),\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":runtime_lightweight_check\",\n         \"//xla:literal\",\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/service/llvm_ir:ir_array\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/mkl:onednn\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/types:span\",\n@@ -1466,7 +1458,6 @@ onednn_cc_library(\n         \":onednn_config_proto_cc\",\n         \":onednn_memory_util\",\n         \":onednn_util\",\n-        \":runtime_lightweight_check\",\n         \"//xla:executable_run_options\",\n         \"//xla:literal\",\n         \"//xla:shape_util\",\n@@ -1475,6 +1466,7 @@ onednn_cc_library(\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/types:span\",\n         \"@eigen_archive//:eigen3\",\n@@ -1493,12 +1485,12 @@ onednn_cc_library(\n         \":onednn_config_proto_cc\",\n         \":onednn_memory_util\",\n         \":onednn_util\",\n-        \":runtime_lightweight_check\",\n         \"//xla:executable_run_options\",\n         \"//xla:shape_util\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/tsl/mkl:onednn\",\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@eigen_archive//:eigen3\",\n     ],\n@@ -1516,11 +1508,11 @@ onednn_cc_library(\n         \":backend_config_proto_cc\",\n         \":onednn_config_proto_cc\",\n         \":onednn_memory_util\",\n-        \":runtime_lightweight_check\",\n         \"//xla:executable_run_options\",\n         \"//xla/tsl/mkl:onednn\",\n         \"//xla/tsl/platform:env\",\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@eigen_archive//:eigen3\",\n         \"@local_tsl//tsl/platform:platform_port\",\n@@ -1539,11 +1531,11 @@ onednn_cc_library(\n         \":backend_config_proto_cc\",\n         \":onednn_config_proto_cc\",\n         \":onednn_memory_util\",\n-        \":runtime_lightweight_check\",\n         \"//xla:executable_run_options\",\n         \"//xla/tsl/mkl:onednn\",\n         \"//xla/tsl/platform:env\",\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@eigen_archive//:eigen3\",\n         \"@local_tsl//tsl/platform:platform_port\","
        },
        {
            "sha": "ca30c115bb9314bc8e2d2492d163e05d64b75e5c",
            "filename": "third_party/xla/xla/service/cpu/onednn_convolution.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_convolution.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_convolution.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_convolution.cc?ref=e528edf2b8c03795917ed325fee11c9a1b3559dd",
            "patch": "@@ -23,6 +23,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/base/attributes.h\"\n+#include \"absl/log/check.h\"\n #include \"absl/status/statusor.h\"\n #include \"unsupported/Eigen/CXX11/Tensor\"\n #include \"oneapi/dnnl/dnnl.hpp\"\n@@ -38,7 +39,6 @@ limitations under the License.\n #include \"xla/service/cpu/onednn_config.pb.h\"\n #include \"xla/service/cpu/onednn_memory_util.h\"\n #include \"xla/service/cpu/onednn_util.h\"\n-#include \"xla/service/cpu/runtime_lightweight_check.h\"\n #include \"xla/shape.h\"\n #include \"xla/tsl/util/onednn_threadpool.h\"\n \n@@ -330,12 +330,12 @@ void ExecuteOneDnnConvolution(absl::Span<MemrefInfoHandler> arguments,\n       {DNNL_ARG_DST, resources.dst_mem}};\n \n   if (conv_config.optimization_config().user_scratchpad()) {\n-    XLA_LIGHTWEIGHT_CHECK(results.size() > 1);\n+    CHECK_GT(results.size(), 1);\n     MemrefInfo scratch_minfo(results[1].get());\n \n     size_t required_size = conv_pd->scratchpad_desc().get_size();\n     size_t provided_size = scratch_minfo.GetOneDnnDims()[0];  // bytes (u8)\n-    XLA_LIGHTWEIGHT_CHECK(required_size <= provided_size);\n+    CHECK_LE(required_size, provided_size);\n \n     resources.scratch_mem =\n         memory(conv_pd->scratchpad_desc(), cpu_engine, scratch_minfo.Data());"
        },
        {
            "sha": "3a3f881e0a0e33ff1d6228976500a088fdd99411",
            "filename": "third_party/xla/xla/service/cpu/onednn_layer_norm.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_layer_norm.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_layer_norm.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_layer_norm.cc?ref=e528edf2b8c03795917ed325fee11c9a1b3559dd",
            "patch": "@@ -26,7 +26,6 @@ limitations under the License.\n #include \"oneapi/dnnl/dnnl_types.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n-#include \"xla/service/cpu/runtime_lightweight_check.h\"\n \n // Eigen Tensor must come after `onednn_threadpool.h`\n #include \"unsupported/Eigen/CXX11/Tensor\"  // NOLINT"
        },
        {
            "sha": "86e39519354d588f4125b4dc57909c9f9057f98d",
            "filename": "third_party/xla/xla/service/cpu/onednn_matmul.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_matmul.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_matmul.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_matmul.cc?ref=e528edf2b8c03795917ed325fee11c9a1b3559dd",
            "patch": "@@ -28,6 +28,7 @@ limitations under the License.\n \n #include \"absl/algorithm/container.h\"\n #include \"absl/base/attributes.h\"\n+#include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/types/span.h\"\n@@ -45,7 +46,6 @@ limitations under the License.\n #include \"xla/service/cpu/onednn_config.pb.h\"\n #include \"xla/service/cpu/onednn_memory_util.h\"\n #include \"xla/service/cpu/onednn_util.h\"\n-#include \"xla/service/cpu/runtime_lightweight_check.h\"\n #include \"xla/shape.h\"\n #include \"tsl/platform/cpu_info.h\"\n \n@@ -111,7 +111,7 @@ dnnl::memory::desc OneDnnMatMulOptWeightsDesc(\n \n   // extend bias rank to match result rank\n   auto missed_rank = output_md.get_ndims() - bias_md.get_ndims();\n-  XLA_LIGHTWEIGHT_CHECK(missed_rank >= 0);\n+  CHECK_GE(missed_rank, 0);\n   if (!bias_md.is_zero() && missed_rank > 0) {\n     auto bias_dims = bias_md.get_dims();\n     bias_dims.insert(bias_dims.begin(), missed_rank, 1);\n@@ -368,7 +368,7 @@ ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_OneDnnMatMul(\n     // extend bias rank to match result rank\n     if (!bias_md.is_zero()) {\n       auto missed_rank = output_md.get_ndims() - bias_md.get_ndims();\n-      XLA_LIGHTWEIGHT_CHECK(missed_rank >= 0);\n+      CHECK_GE(missed_rank, 0);\n       if (missed_rank > 0) {\n         auto bias_dims = bias_md.get_dims();\n         bias_dims.insert(bias_dims.begin(), missed_rank, 1);\n@@ -408,7 +408,7 @@ ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_OneDnnMatMul(\n       CreateMatMulPrimDesc(cpu_engine, input_md, weights_md, output_md,\n                            fused_mds, matmul_config, &fused_operands_ref);\n \n-  XLA_LIGHTWEIGHT_CHECK(num_args == arg_indx);\n+  CHECK_EQ(num_args, arg_indx);\n \n   auto lhs_mem = memory(input_md, cpu_engine, input_minfo.Data());\n   auto rhs_mem = memory(matmul_pd->weights_desc(), cpu_engine, rhs_data);\n@@ -425,7 +425,7 @@ ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_OneDnnMatMul(\n                                               {DNNL_ARG_DST, result_mem}};\n \n   if (matmul_config.optimization_config().user_scratchpad()) {\n-    XLA_LIGHTWEIGHT_CHECK(scratch != nullptr);\n+    CHECK(scratch != nullptr);\n     MemrefInfo scratch_minfo(scratch);\n     auto scratchpad_md = matmul_pd->scratchpad_desc();\n     auto scratch_mem = memory(scratchpad_md, cpu_engine, scratch_minfo.Data());\n@@ -479,7 +479,7 @@ ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_OneDnnMatMulReorder(\n     bias_md = bias_minfo.GetOneDnnMemDesc();\n   }\n \n-  XLA_LIGHTWEIGHT_CHECK(num_args >= arg_indx);\n+  CHECK_GE(num_args, arg_indx);\n \n   // Update dims and strides for transposed inputs.\n   TransposeIfNecessary(matmul_config.lhs().tensor().dimensions(),\n@@ -490,7 +490,7 @@ ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_OneDnnMatMulReorder(\n   // extend bias rank to match result rank\n   if (!bias_md.is_zero()) {\n     auto missed_rank = output_md.get_ndims() - bias_md.get_ndims();\n-    XLA_LIGHTWEIGHT_CHECK(missed_rank >= 0);\n+    CHECK_GE(missed_rank, 0);\n     if (missed_rank > 0) {\n       auto bias_dims = bias_md.get_dims();\n       bias_dims.insert(bias_dims.begin(), missed_rank, 1);\n@@ -501,8 +501,7 @@ ABSL_ATTRIBUTE_NO_SANITIZE_MEMORY void __xla_cpu_runtime_OneDnnMatMulReorder(\n   auto result_md = OneDnnMatMulOptWeightsDesc(cpu_engine, input_md, weight_md,\n                                               bias_md, output_md);\n \n-  XLA_LIGHTWEIGHT_CHECK(result_minfo.GetOneDnnMemDesc().get_size() ==\n-                        result_md.get_size());\n+  CHECK_EQ(result_minfo.GetOneDnnMemDesc().get_size(), result_md.get_size());\n \n   auto weight_mem = dnnl::memory{weight_md, cpu_engine, weight_minfo.Data()};\n   auto result_mem = dnnl::memory{result_md, cpu_engine, result_minfo.Data()};"
        },
        {
            "sha": "e920a9f5f9d40f7fa660e44d676936f2b8370189",
            "filename": "third_party/xla/xla/service/cpu/onednn_memory_util.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.h?ref=e528edf2b8c03795917ed325fee11c9a1b3559dd",
            "patch": "@@ -20,14 +20,14 @@ limitations under the License.\n #include <memory>\n #include <vector>\n \n+#include \"absl/log/check.h\"\n #include \"absl/status/statusor.h\"\n #include \"oneapi/dnnl/dnnl.hpp\"\n #include \"oneapi/dnnl/dnnl_common_types.h\"\n #include \"llvm/IR/IRBuilder.h\"\n #include \"llvm/IR/Instructions.h\"\n #include \"llvm/IR/Value.h\"\n #include \"xla/literal.h\"\n-#include \"xla/service/cpu/runtime_lightweight_check.h\"\n #include \"xla/service/llvm_ir/ir_array.h\"\n #include \"xla/shape.h\"\n #include \"xla/xla_data.pb.h\"\n@@ -127,7 +127,7 @@ absl::StatusOr<dnnl::memory::desc> TransposeLastTwoDims(\n #define TRANSPOSE_LAST_TWO_DIMS_IF(pred, mem_desc)        \\\n   if (pred) {                                             \\\n     auto trans_mem_desc = TransposeLastTwoDims(mem_desc); \\\n-    XLA_LIGHTWEIGHT_CHECK(trans_mem_desc.ok());           \\\n+    CHECK(trans_mem_desc.ok());                           \\\n     mem_desc = *trans_mem_desc;                           \\\n   }\n "
        },
        {
            "sha": "4cee18c193800213d642b47c802f2361fe7bb9fc",
            "filename": "third_party/xla/xla/service/cpu/onednn_softmax.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_softmax.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e528edf2b8c03795917ed325fee11c9a1b3559dd/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_softmax.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_softmax.cc?ref=e528edf2b8c03795917ed325fee11c9a1b3559dd",
            "patch": "@@ -25,7 +25,6 @@ limitations under the License.\n #include \"oneapi/dnnl/dnnl_types.h\"\n #include \"xla/executable_run_options.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n-#include \"xla/service/cpu/runtime_lightweight_check.h\"\n // Below must come after `onednn_threadpool.h`\n #include \"unsupported/Eigen/CXX11/Tensor\"  // NOLINT\n "
        },
        {
            "sha": "49fc9cb3457a5c4269196a036f99779757058082",
            "filename": "third_party/xla/xla/service/cpu/runtime_lightweight_check.h",
            "status": "removed",
            "additions": 0,
            "deletions": 36,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2ec7037bdf8d6ddff232674899b1f89b954a23a9/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_lightweight_check.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2ec7037bdf8d6ddff232674899b1f89b954a23a9/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_lightweight_check.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fruntime_lightweight_check.h?ref=2ec7037bdf8d6ddff232674899b1f89b954a23a9",
            "patch": "@@ -1,36 +0,0 @@\n-/* Copyright 2019 The OpenXLA Authors.\n-\n-Licensed under the Apache License, Version 2.0 (the \"License\");\n-you may not use this file except in compliance with the License.\n-You may obtain a copy of the License at\n-\n-    http://www.apache.org/licenses/LICENSE-2.0\n-\n-Unless required by applicable law or agreed to in writing, software\n-distributed under the License is distributed on an \"AS IS\" BASIS,\n-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-See the License for the specific language governing permissions and\n-limitations under the License.\n-==============================================================================*/\n-\n-#ifndef XLA_SERVICE_CPU_RUNTIME_LIGHTWEIGHT_CHECK_H_\n-#define XLA_SERVICE_CPU_RUNTIME_LIGHTWEIGHT_CHECK_H_\n-\n-#include <cstdlib>\n-#include <iostream>\n-\n-// Aborts the program if the condition is false.\n-//\n-// This is like QCHECK, except it doesn't pull in the TF/XLA logging framework.\n-// This makes it suitable for use from within the XLA:CPU runtime files, which\n-// need to be lightweight.\n-#define XLA_LIGHTWEIGHT_CHECK(cond)                                         \\\n-  do {                                                                      \\\n-    if (!(cond)) {                                                          \\\n-      std::cerr << __FILE__ << \":\" << __LINE__                              \\\n-                << \" Failed XLA_LIGHTWEIGHT_QCHECK \" << #cond << std::endl; \\\n-      std::abort();                                                         \\\n-    }                                                                       \\\n-  } while (0)\n-\n-#endif  // XLA_SERVICE_CPU_RUNTIME_LIGHTWEIGHT_CHECK_H_"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 18,
        "deletions": 65
    }
}