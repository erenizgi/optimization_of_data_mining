{
    "author": "bmass02",
    "message": "Add fix for TPU idleness attribution due to input pipeline slowness for host loop based scheduling.\n\nPiperOrigin-RevId: 804489013",
    "sha": "12696694146b1c5949412ead3cc0c81d5939b88c",
    "files": [
        {
            "sha": "b693dcfebe9579cc6d5475183309d5a964ab6afa",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_test_utils.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 9,
            "changes": 37,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/12696694146b1c5949412ead3cc0c81d5939b88c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_test_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/12696694146b1c5949412ead3cc0c81d5939b88c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_test_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_test_utils.cc?ref=12696694146b1c5949412ead3cc0c81d5939b88c",
            "patch": "@@ -14,6 +14,8 @@ limitations under the License.\n ==============================================================================*/\n #include \"xla/tsl/profiler/utils/xplane_test_utils.h\"\n \n+#include <cstdint>\n+#include <initializer_list>\n #include <string>\n #include <utility>\n #include <variant>\n@@ -30,18 +32,20 @@ namespace tsl {\n namespace profiler {\n namespace {\n \n+template <typename T>\n class XStatValueVisitor {\n  public:\n-  XStatValueVisitor(XEventBuilder* event, const XStatMetadata* stat_metadata)\n-      : event_(event), stat_metadata_(stat_metadata) {}\n+  XStatValueVisitor(XStatsBuilder<T>& stats_owner,\n+                    const XStatMetadata* stat_metadata)\n+      : stats_owner_(stats_owner), stat_metadata_(stat_metadata) {}\n \n-  template <typename T>\n-  void operator()(const T& value) {\n-    event_->AddStatValue(*stat_metadata_, value);\n+  template <typename V>\n+  void operator()(const V& value) {\n+    stats_owner_.SetOrAddStatValue(*stat_metadata_, value);\n   }\n \n  private:\n-  XEventBuilder* event_;\n+  XStatsBuilder<T>& stats_owner_;\n   const XStatMetadata* stat_metadata_;\n };\n \n@@ -86,10 +90,10 @@ void CreateXEvent(\n   for (const auto& stat_type_and_value : stats) {\n     StatType stat_type = stat_type_and_value.first;\n     const XStatValue& stat_value = stat_type_and_value.second;\n-    XStatValueVisitor stat_value_visitor(\n-        &event_builder,\n+    XStatValueVisitor<XEvent> event_stat_visitor(\n+        event_builder,\n         plane_builder->GetOrCreateStatMetadata(GetStatTypeStr(stat_type)));\n-    std::visit(stat_value_visitor, stat_value);\n+    std::visit(event_stat_visitor, stat_value);\n   }\n }\n \n@@ -101,6 +105,21 @@ void CreateXEvent(\n                offset_ps, duration_ps, stats);\n }\n \n+void CreateXEventMetadata(\n+    XPlaneBuilder* plane_builder, absl::string_view event_name,\n+    std::initializer_list<std::pair<StatType, XStatValue>> stats) {\n+  XEventMetadata* event_metadata =\n+      plane_builder->GetOrCreateEventMetadata(event_name);\n+  XStatsBuilder<XEventMetadata> event_metadata_stats(event_metadata,\n+                                                     plane_builder);\n+  for (const auto& [stat_type, stat_value] : stats) {\n+    XStatValueVisitor<XEventMetadata> event_metadata_stat_visitor(\n+        event_metadata_stats,\n+        plane_builder->GetOrCreateStatMetadata(GetStatTypeStr(stat_type)));\n+    std::visit(event_metadata_stat_visitor, stat_value);\n+  }\n+}\n+\n void CreateTfFunctionCallEvent(XPlaneBuilder* plane_builder,\n                                XLineBuilder* line_builder,\n                                absl::string_view function_name,"
        },
        {
            "sha": "fd75840788c04c83050c30f800be3c14f58227a9",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_test_utils.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/12696694146b1c5949412ead3cc0c81d5939b88c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_test_utils.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/12696694146b1c5949412ead3cc0c81d5939b88c/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_test_utils.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_test_utils.h?ref=12696694146b1c5949412ead3cc0c81d5939b88c",
            "patch": "@@ -49,6 +49,10 @@ void CreateXEvent(\n     HostEventType event_type, int64_t offset_ps, int64_t duration_ps,\n     std::initializer_list<std::pair<StatType, XStatValue>> stats = {});\n \n+void CreateXEventMetadata(\n+    XPlaneBuilder* plane_builder, absl::string_view event_name,\n+    std::initializer_list<std::pair<StatType, XStatValue>> stats = {});\n+\n void CreateTfFunctionCallEvent(XPlaneBuilder* plane_builder,\n                                XLineBuilder* line_builder,\n                                absl::string_view function_name,"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 32,
        "deletions": 9
    }
}