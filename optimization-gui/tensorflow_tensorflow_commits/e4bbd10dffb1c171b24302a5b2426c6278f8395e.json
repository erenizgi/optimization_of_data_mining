{
    "author": "nvgrw",
    "message": "Include compilation environment in split compilation fingerprints.\n\nPiperOrigin-RevId: 833827012",
    "sha": "e4bbd10dffb1c171b24302a5b2426c6278f8395e",
    "files": [
        {
            "sha": "262d2a8f3482550a95a0e2397b494cd7b2f95435",
            "filename": "third_party/xla/xla/service/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4bbd10dffb1c171b24302a5b2426c6278f8395e/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4bbd10dffb1c171b24302a5b2426c6278f8395e/third_party%2Fxla%2Fxla%2Fservice%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2FBUILD?ref=e4bbd10dffb1c171b24302a5b2426c6278f8395e",
            "patch": "@@ -4503,7 +4503,9 @@ xla_cc_test(\n         \":computation_placer_hdr\",\n         \":hlo_runner_interface\",\n         \":hlo_runner_pjrt\",\n+        \":test_compilation_environment_proto_cc\",\n         \"//xla:util\",\n+        \"//xla:xla_proto_cc\",\n         \"//xla/hlo/builder:xla_computation\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/parser:hlo_parser\",\n@@ -4522,6 +4524,7 @@ xla_cc_test(\n         \"@com_google_absl//absl/time\",\n         \"@com_google_absl//absl/types:span\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform:casts\",\n         \"@local_tsl//tsl/platform:fingerprint\",\n         \"@local_tsl//tsl/platform:path\",\n     ],"
        },
        {
            "sha": "2227aa2842c2a771405d6fa6b1646fb35bb584ec",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 12,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4bbd10dffb1c171b24302a5b2426c6278f8395e/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4bbd10dffb1c171b24302a5b2426c6278f8395e/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt.cc?ref=e4bbd10dffb1c171b24302a5b2426c6278f8395e",
            "patch": "@@ -16,6 +16,7 @@ limitations under the License.\n #include \"xla/service/hlo_runner_pjrt.h\"\n \n #include <array>\n+#include <cstddef>\n #include <cstdint>\n #include <memory>\n #include <optional>\n@@ -891,20 +892,33 @@ absl::StatusOr<DeviceAssignment> HloRunnerPjRt::GetDefaultDeviceAssignment(\n // Split-phase HloRunnerPjRt implementations:\n \n namespace {\n+\n+std::string SerializeDeterministically(const tsl::protobuf::Message& message) {\n+  const size_t size = message.ByteSizeLong();\n+  std::string buffer;\n+  buffer.resize(size);\n+  tsl::protobuf::io::StringOutputStream string_stream(&buffer);\n+  tsl::protobuf::io::CodedOutputStream coded_stream(&string_stream);\n+  coded_stream.SetSerializationDeterministic(true);\n+  message.SerializeWithCachedSizes(&coded_stream);\n+  return buffer;\n+}\n+\n std::string MakeFilename(const HloModule& module, const bool run_hlo_passes) {\n-  // TODO: b/415841352 - We need a better way to calculate this fingerprint.\n-  // Right now, this fingerprint does not take into account the compilation\n-  // environment, flags, etc. Since we don't intend to re-use the compilation\n-  // artifacts across test runs, this should probably be fine. Each environment\n-  // gets a fresh artifact directory. The fingerprint may need to be generated\n-  // within PjRt itself since the environment is not easily accessed at this\n-  // level of abstraction.\n-  const tsl::Fprint128 module_fingerprint =\n+  // Fingerprint the HLO module, including its names.\n+  tsl::Fprint128 fingerprint =\n       tsl::Fingerprint128(module.ToString(HloPrintOptions::Default()));\n-  const tsl::Fprint128 run_hlo_passes_fingerprint =\n-      tsl::Fingerprint128(run_hlo_passes ? \"true\" : \"false\");\n-  const tsl::Fprint128 fingerprint =\n-      tsl::FingerprintCat128(module_fingerprint, run_hlo_passes_fingerprint);\n+  // Fingerprint the run_hlo_passes flag, as this is an input from the test.\n+  fingerprint = tsl::FingerprintCat128(\n+      fingerprint, tsl::Fingerprint128(run_hlo_passes ? \"true\" : \"false\"));\n+  // Fingerprint the HLO module's compilation environment, as this is not\n+  // captured in the HLO module fingerprint.\n+  fingerprint = tsl::FingerprintCat128(\n+      fingerprint, tsl::Fingerprint128(SerializeDeterministically(\n+                       module.comp_envs().ToProto())));\n+\n+  // Convert the fingerprint into a hex string and concatenate it with the .bin\n+  // extension.\n   const std::array<char, 16> fingerprint_bytes =\n       tsl::Fprint128ToBytes(fingerprint);\n   const absl::string_view fingerprint_bytes_view(fingerprint_bytes.data(),"
        },
        {
            "sha": "6da73a7740b0856bfe3762da1025285dfb94ff5f",
            "filename": "third_party/xla/xla/service/hlo_runner_pjrt_test.cc",
            "status": "modified",
            "additions": 54,
            "deletions": 1,
            "changes": 55,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e4bbd10dffb1c171b24302a5b2426c6278f8395e/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e4bbd10dffb1c171b24302a5b2426c6278f8395e/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_runner_pjrt_test.cc?ref=e4bbd10dffb1c171b24302a5b2426c6278f8395e",
            "patch": "@@ -38,12 +38,15 @@ limitations under the License.\n #include \"xla/pjrt/pjrt_executable.h\"\n #include \"xla/service/computation_placer.h\"\n #include \"xla/service/hlo_runner_interface.h\"\n+#include \"xla/service/test_compilation_environment.pb.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/status_matchers.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n #include \"xla/util.h\"\n+#include \"xla/xla.pb.h\"\n+#include \"tsl/platform/casts.h\"\n #include \"tsl/platform/fingerprint.h\"\n #include \"tsl/platform/path.h\"\n \n@@ -131,8 +134,15 @@ ENTRY %constant_s32 () -> s32[] {\n )\");\n }\n \n+// Fake module with run_hlo_passes=false.\n constexpr absl::string_view kModuleSerializedName =\n-    \"7a8f4b1ac78966508b85e1d9a0bc8f21.bin\";\n+    \"a83d1d9a594b0f1fbc4227408abcdc6a.bin\";\n+// Fake module with run_hlo_passes=true.\n+constexpr absl::string_view kModuleWithRunHloPassesSerializedName =\n+    \"1f51ba5f389ad07cbe268573dd21a94e.bin\";\n+// Fake module with a compilation environment set.\n+constexpr absl::string_view kModuleWithCompEnvSerializedName =\n+    \"9385c25a58e7d6d47e56af1dd950b7d1.bin\";\n \n class ArtifactDirTest : public ::testing::Test {\n  public:\n@@ -166,6 +176,49 @@ TEST_F(CompilePhaseHloRunnerPjRtTest, CreateExecutablePlacesFileCorrectly) {\n   ASSERT_EQ(children[0], kModuleSerializedName);\n }\n \n+// Tests that a CreateExecutable call with different run_hlo_passes value places\n+// the file in a different location.\n+TEST_F(CompilePhaseHloRunnerPjRtTest,\n+       CreateExecutablePlacesFilesCorrectlyWithDifferentRunHloPasses) {\n+  CompilePhaseHloRunnerPjRt runner(std::make_unique<FakeClient>(),\n+                                   artifact_dir_);\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> m, CreateFakeModule());\n+  TF_ASSERT_OK(runner.CreateExecutable(std::move(m), /*run_hlo_passes=*/true));\n+\n+  std::vector<std::string> children;\n+  TF_ASSERT_OK(tsl::Env::Default()->GetChildren(artifact_dir_, &children));\n+  ASSERT_EQ(children.size(), 1);\n+  ASSERT_EQ(children[0], kModuleWithRunHloPassesSerializedName);\n+}\n+\n+// Tests that a CreateExecutable call with a different compilation\n+// environment places the file in a different location.\n+TEST_F(CompilePhaseHloRunnerPjRtTest,\n+       CreateExecutablePlacesFilesCorrectlyWithCompilationEnvironment) {\n+  CompilePhaseHloRunnerPjRt runner(std::make_unique<FakeClient>(),\n+                                   artifact_dir_);\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> m, CreateFakeModule());\n+  m->comp_envs().RegisterProcessNewEnvFn(\n+      test::TestCompilationEnvironment1::GetDescriptor(),\n+      [](std::unique_ptr<tsl::protobuf::Message> msg) {\n+        std::unique_ptr<test::TestCompilationEnvironment1> env(\n+            tensorflow::down_cast<test::TestCompilationEnvironment1*>(\n+                msg.release()));\n+        if (env == nullptr) {\n+          env = std::make_unique<test::TestCompilationEnvironment1>();\n+        }\n+        env->set_some_flag(42);\n+        return env;\n+      });\n+  TF_ASSERT_OK(m->comp_envs().InitializeAllKnownEnvs());\n+  TF_ASSERT_OK(runner.CreateExecutable(std::move(m), /*run_hlo_passes=*/false));\n+\n+  std::vector<std::string> children;\n+  TF_ASSERT_OK(tsl::Env::Default()->GetChildren(artifact_dir_, &children));\n+  ASSERT_EQ(children.size(), 1);\n+  ASSERT_EQ(children[0], kModuleWithCompEnvSerializedName);\n+}\n+\n using ExecutePhaseHloRunnerPjRtTest = ArtifactDirTest;\n \n // Tests that a call to CreateExecutable reads the file from the correct path"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 83,
        "deletions": 13
    }
}