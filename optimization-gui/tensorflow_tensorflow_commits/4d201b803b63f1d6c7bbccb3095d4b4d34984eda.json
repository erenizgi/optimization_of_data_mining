{
    "author": "chsigg",
    "message": "Refine func::FuncOp legality checks in int4_passes.\n\nSplit the dynamic legality check for func::FuncOp to explicitly check both the function signature and the op's internal legality. Remove the conversion pattern for mt::FuncOp.\n\nPiperOrigin-RevId: 840135741",
    "sha": "4d201b803b63f1d6c7bbccb3095d4b4d34984eda",
    "files": [
        {
            "sha": "a5adf3a2bdd05dbbd55e592ad5a14e40fdd9ff51",
            "filename": "third_party/xla/xla/backends/gpu/codegen/triton/transforms/int4_passes.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 19,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4d201b803b63f1d6c7bbccb3095d4b4d34984eda/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fint4_passes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4d201b803b63f1d6c7bbccb3095d4b4d34984eda/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fint4_passes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fcodegen%2Ftriton%2Ftransforms%2Fint4_passes.cc?ref=4d201b803b63f1d6c7bbccb3095d4b4d34984eda",
            "patch": "@@ -631,30 +631,17 @@ class LoadInt4RewritePass\n \n     ConversionTarget target(*ctx);\n     I4ToI8Converter converter(packed_dimension);\n-    target.markUnknownOpDynamicallyLegal([&](Operation* op) {\n-      if (auto func_op = dyn_cast<mlir::FunctionOpInterface>(op)) {\n-        VLOG(5) << \"check funcOp: \" << DumpToString(func_op);\n-        if (func_op.getFunctionType() !=\n-            converter.convertType(func_op.getFunctionType())) {\n-          VLOG(5) << \"funcOp not legal: \" << DumpToString(func_op);\n-          return false;\n-        }\n-      }\n-      bool is_legal = converter.isLegal(op);\n-      VLOG(5) << \"is_legal: \" << is_legal << \" for \" << DumpToString(op);\n-      return is_legal;\n+    target.addDynamicallyLegalOp<func::FuncOp>([&](func::FuncOp op) {\n+      return converter.isSignatureLegal(op.getFunctionType()) &&\n+             converter.isLegal(op);\n     });\n+    target.markUnknownOpDynamicallyLegal(\n+        [&](Operation* op) { return converter.isLegal(op); });\n+\n     RewritePatternSet patterns(ctx);\n     scf::populateSCFStructuralTypeConversions(converter, patterns);\n     patterns.add<ExtSIInt4ToInt8Pattern>(converter, ctx, enable_bf16x2_);\n-\n     patterns.add<TritonXlaExtractOpConversionPattern>(converter, ctx);\n-\n-    // TODO(b/393299275): Remove mt::FuncOp once the legacy Triton emitter is\n-    // deprecated.\n-    populateFunctionOpInterfaceTypeConversionPattern<mt::FuncOp>(patterns,\n-                                                                 converter);\n-\n     populateFunctionOpInterfaceTypeConversionPattern<mlir::func::FuncOp>(\n         patterns, converter);\n     if (failed(applyPartialConversion(module, target, std::move(patterns)))) {"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 6,
        "deletions": 19
    }
}