{
    "author": "penpornk",
    "message": "[xla:cpu] Make `onednn_matcher` a `onednn_graph_cc_library` target.\n\nPiperOrigin-RevId: 804724266",
    "sha": "842bdf489b761308a7858390e0b9a1cafc1c9ff0",
    "files": [
        {
            "sha": "eb56ece3679eb923a2908515289bb37ae2ac8d50",
            "filename": "third_party/xla/xla/backends/cpu/transforms/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/842bdf489b761308a7858390e0b9a1cafc1c9ff0/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/842bdf489b761308a7858390e0b9a1cafc1c9ff0/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD?ref=842bdf489b761308a7858390e0b9a1cafc1c9ff0",
            "patch": "@@ -1,5 +1,7 @@\n load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n load(\"//xla/tsl:tsl.bzl\", \"internal_visibility\")\n+load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\")\n+load(\"//xla/tsl/mkl:graph.bzl\", \"onednn_graph_cc_library\")\n load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n \n package(\n@@ -19,6 +21,7 @@ cc_library(\n     name = \"dot_library_rewriter\",\n     srcs = [\"dot_library_rewriter.cc\"],\n     hdrs = [\"dot_library_rewriter.h\"],\n+    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":library_matcher\",\n         \":onednn_matcher\",\n@@ -45,6 +48,7 @@ cc_library(\n xla_cc_test(\n     name = \"dot_library_rewriter_test\",\n     srcs = [\"dot_library_rewriter_test.cc\"],\n+    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":dot_library_rewriter\",\n         \"//xla:xla_data_proto_cc\",\n@@ -79,9 +83,10 @@ cc_library(\n     ],\n )\n \n-cc_library(\n+onednn_graph_cc_library(\n     name = \"onednn_matcher\",\n     hdrs = [\"onednn_matcher.h\"],\n+    # copybara:uncomment compatible_with = [\"//buildenv/target:non_prod\"],\n     deps = [\n         \":library_matcher\",\n         \"//xla/backends/cpu:onednn_support\","
        },
        {
            "sha": "8880f3c928c478ac031566b1b95670a7981cc737",
            "filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter.h",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/842bdf489b761308a7858390e0b9a1cafc1c9ff0/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/842bdf489b761308a7858390e0b9a1cafc1c9ff0/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter.h?ref=842bdf489b761308a7858390e0b9a1cafc1c9ff0",
            "patch": "@@ -28,14 +28,17 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"xla/backends/cpu/codegen/target_machine_features.h\"\n #include \"xla/backends/cpu/transforms/library_matcher.h\"\n-#include \"xla/backends/cpu/transforms/onednn_matcher.h\"\n #include \"xla/backends/cpu/transforms/xnn_matcher.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/pass/hlo_pass_interface.h\"\n #include \"tsl/platform/protobuf.h\"\n \n+#if XLA_ONEDNN_USE_GRAPH_API\n+#include \"xla/backends/cpu/transforms/onednn_matcher.h\"\n+#endif  // XLA_ONEDNN_USE_GRAPH_API\n+\n namespace xla::cpu {\n \n enum class FusionDirection {\n@@ -60,11 +63,13 @@ class DotLibraryRewriter : public HloModulePass {\n       : target_machine_features_(target_machine_features),\n         options_(std::move(options)) {\n     // Initialize library matchers.\n+#if XLA_ONEDNN_USE_GRAPH_API\n     if (options_.use_onednn && options_.onednn_fusion_types != nullptr &&\n         !options_.onednn_fusion_types->empty()) {\n       libs_.push_back(std::make_unique<OneDnnMatcher>(\n           target_machine_features_, options_.onednn_fusion_types));\n     }\n+#endif  // XLA_ONEDNN_USE_GRAPH_API\n     if (options_.use_xnnpack && options_.xnn_fusion_types != nullptr &&\n         !options_.xnn_fusion_types->empty()) {\n       libs_.push_back(std::make_unique<XnnMatcher>(target_machine_features_,"
        },
        {
            "sha": "76792d7bd0b6bf5f9a9945634799b1acdfce458a",
            "filename": "third_party/xla/xla/backends/cpu/transforms/dot_library_rewriter_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/842bdf489b761308a7858390e0b9a1cafc1c9ff0/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/842bdf489b761308a7858390e0b9a1cafc1c9ff0/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2Fdot_library_rewriter_test.cc?ref=842bdf489b761308a7858390e0b9a1cafc1c9ff0",
            "patch": "@@ -372,16 +372,19 @@ std::vector<DotRewriteTestSpec> GetDotRewriteTestSpecs() {\n       {{\"xnn\", \"znver3\"}, {{\"f32\", \"f32\"}, {\"bf16\", \"f32\"}}},\n       {{\"xnn\", \"sapphirerapids\"},\n        {{\"f32\", \"f32\"}, {\"bf16\", \"f32\"}, {\"bf16\", \"bf16\"}}},\n-      {{\"onednn\", \"sapphirerapids\"}, {{\"f32\", \"f32\"}}},\n   };\n \n   // Fusion modes to test for each library.\n   // We temporarily use XNN_GRAPH_FUSION_MODE_DISABLED to denote the dot fusion\n   // mode (starting fusion nodes with dots).\n   absl::flat_hash_map<std::string, std::vector<std::string>> fusion_modes = {\n-      {\"xnn\", {\"dot\", \"greedy\"}},\n-      {\"onednn\", {\"dot\"}},\n-  };\n+      {\"xnn\", {\"dot\", \"greedy\"}}};\n+\n+#if XLA_ONEDNN_USE_GRAPH_API\n+  // Don't test oneDNN if we don't build with it.\n+  dtype_map[{\"onednn\", \"sapphirerapids\"}] = {{\"f32\", \"f32\"}};\n+  fusion_modes[\"onednn\"] = {\"dot\"};\n+#endif  // XLA_ONEDNN_USE_GRAPH_API\n \n   std::vector<DotRewriteTestSpec> specs;\n   for (auto& [lib_cpu, dtype_pairs] : dtype_map) {"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 19,
        "deletions": 6
    }
}