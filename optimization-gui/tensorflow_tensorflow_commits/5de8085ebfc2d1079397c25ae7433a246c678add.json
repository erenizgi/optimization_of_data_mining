{
    "author": "alinas",
    "message": "Integrate LLVM at llvm/llvm-project@fd9a1dcc0176\n\nUpdates LLVM usage to match\n[fd9a1dcc0176](https://github.com/llvm/llvm-project/commit/fd9a1dcc0176)\n\nPiperOrigin-RevId: 815727839",
    "sha": "5de8085ebfc2d1079397c25ae7433a246c678add",
    "files": [
        {
            "sha": "7731e088166a209d3b66c9a6b0d8e0b3057d27e0",
            "filename": "third_party/xla/third_party/llvm/generated.patch",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fllvm%2Fgenerated.patch?ref=5de8085ebfc2d1079397c25ae7433a246c678add",
            "patch": "@@ -1 +1,45 @@\n Auto generated patch. Do not edit or delete it, even if empty.\n+diff -ruN --strip-trailing-cr a/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp b/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp\n+--- a/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp\n++++ b/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp\n+@@ -46,8 +46,8 @@\n+     MAM.registerPass([VocabVector = std::move(VocabVector)]() mutable {\n+       return IR2VecVocabAnalysis(std::move(VocabVector));\n+     });\n+-    IR2VecVocab =\n+-        new ir2vec::Vocabulary(ir2vec::Vocabulary::createDummyVocabForTest(1));\n++    IR2VecVocab = std::make_unique<ir2vec::Vocabulary>(\n++        ir2vec::Vocabulary::createDummyVocabForTest(1));\n+     MAM.registerPass([&] { return PassInstrumentationAnalysis(); });\n+     FAM.registerPass([&] { return ModuleAnalysisManagerFunctionProxy(MAM); });\n+     FAM.registerPass([&] { return DominatorTreeAnalysis(); });\n+@@ -69,7 +69,7 @@\n+   std::unique_ptr<LoopInfo> LI;\n+   FunctionAnalysisManager FAM;\n+   ModuleAnalysisManager MAM;\n+-  ir2vec::Vocabulary *IR2VecVocab;\n++  std::unique_ptr<ir2vec::Vocabulary> IR2VecVocab;\n+ \n+   void TearDown() override {\n+     // Restore original IR2Vec weights\n+diff -ruN --strip-trailing-cr a/llvm/unittests/Analysis/IR2VecTest.cpp b/llvm/unittests/Analysis/IR2VecTest.cpp\n+--- a/llvm/unittests/Analysis/IR2VecTest.cpp\n++++ b/llvm/unittests/Analysis/IR2VecTest.cpp\n+@@ -295,7 +295,7 @@\n+ // Fixture for IR2Vec tests requiring IR setup.\n+ class IR2VecTestFixture : public ::testing::Test {\n+ protected:\n+-  Vocabulary *V;\n++  std::unique_ptr<Vocabulary> V;\n+   LLVMContext Ctx;\n+   std::unique_ptr<Module> M;\n+   Function *F = nullptr;\n+@@ -304,7 +304,7 @@\n+   Instruction *RetInst = nullptr;\n+ \n+   void SetUp() override {\n+-    V = new Vocabulary(Vocabulary::createDummyVocabForTest(2));\n++    V = std::make_unique<Vocabulary>(Vocabulary::createDummyVocabForTest(2));\n+ \n+     // Setup IR\n+     M = std::make_unique<Module>(\"TestM\", Ctx);"
        },
        {
            "sha": "c407321c0032ed23fe34df02b0df8963b94a6c47",
            "filename": "third_party/xla/third_party/llvm/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fllvm%2Fworkspace.bzl?ref=5de8085ebfc2d1079397c25ae7433a246c678add",
            "patch": "@@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\")\n \n def repo(name):\n     \"\"\"Imports LLVM.\"\"\"\n-    LLVM_COMMIT = \"ca84f2aa3be6e46a4dccb1bec56b93f2bb3d8ef0\"\n-    LLVM_SHA256 = \"5cea44df2e0c3dcb6119c2ca5d7a900001e93ec43369ed1b58eb4ed4d4c9f9f0\"\n+    LLVM_COMMIT = \"fd9a1dcc01766c71932898e9643ce28bf2801bad\"\n+    LLVM_SHA256 = \"85b7a4524078549ef1b3271569241a14deec1b7f4c42048877601166f3d1fee9\"\n \n     tf_http_archive(\n         name = name,"
        },
        {
            "sha": "aa19187be26907a0f73b9b44ecb0fa9ad63eeb3f",
            "filename": "third_party/xla/third_party/shardy/temporary.patch",
            "status": "modified",
            "additions": 403,
            "deletions": 1101,
            "changes": 1504,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fshardy%2Ftemporary.patch?ref=5de8085ebfc2d1079397c25ae7433a246c678add",
            "patch": "@@ -1,1139 +1,441 @@\n-diff --git a/shardy/dialect/mpmd/transforms/optimize/optimize_pipeline.cc b/shardy/dialect/mpmd/transforms/optimize/optimize_pipeline.cc\n-index 291749c..6a5596c 100644\n---- a/shardy/dialect/mpmd/transforms/optimize/optimize_pipeline.cc\n-+++ b/shardy/dialect/mpmd/transforms/optimize/optimize_pipeline.cc\n-@@ -31,15 +31,6 @@ namespace mlir::mpmd {\n+diff --git a/shardy/dialect/mpmd/ir/utils.cc b/shardy/dialect/mpmd/ir/utils.cc\n+index 67724a9..2d4a5de 100644\n+--- a/shardy/dialect/mpmd/ir/utils.cc\n++++ b/shardy/dialect/mpmd/ir/utils.cc\n+@@ -58,6 +58,7 @@ namespace {\n+ \n  using ::mlir::func::FuncOp;\n  \n- void addOptimizePipeline(OpPassManager& pm, OptimizeOptions options) {\n--  // Adds pipeline scheduling pass.\n--  if (!options.fragmentScheduleRules.empty()) {\n--    pm.addNestedPass<FuncOp>(\n--        createRuleBasedSchedulePass(RuleBasedSchedulePassOptions{\n--            std::move(options.fragmentScheduleRules)}));\n--  } else {\n--    AddSchedulingPass(pm, options.pipelineSchedule);\n++\n+ SpmdTensorPartitionSpec ExtractTensorPartitionSpec(MeshTensorType type) {\n+   if (!type.getSharding()) {\n+     return {};\n+@@ -486,60 +487,13 @@ bool IsExecutedImmediatelyAfter(FragmentOp fragment1, FragmentOp fragment2) {\n+   return false;\n+ }\n+ \n+-namespace {\n+-\n+-// Returns true if two meshes are equal, ignoring axes of size 1.\n+-bool IsEquivalentMesh(sdy::MeshAttr mesh1, sdy::MeshAttr mesh2) {\n+-  if (mesh1.getDeviceIds() != mesh2.getDeviceIds()) {\n+-    return false;\n -  }\n -\n-   // Merge fragments according to the user-specified rules. Do this before other\n-   // merge passes since those modify the origins of fragments, invalidating the\n-   // rules.\n-@@ -48,6 +39,9 @@ void addOptimizePipeline(OpPassManager& pm, OptimizeOptions options) {\n-         RuleBasedMergePassOptions{std::move(options.fragmentMergeRules)}));\n-   }\n+-  const auto* it1 = mesh1.getAxes().begin();\n+-  const auto* end1 = mesh1.getAxes().end();\n+-  const auto* it2 = mesh2.getAxes().begin();\n+-  const auto* end2 = mesh2.getAxes().end();\n+-\n+-  while (it1 != end1 && it2 != end2) {\n+-    if (it1->getSize() == 1) {\n+-      ++it1;\n+-      continue;\n+-    }\n+-    if (it2->getSize() == 1) {\n+-      ++it2;\n+-      continue;\n+-    }\n+-    if (*it1 != *it2) {\n+-      return false;\n+-    }\n+-    ++it1;\n+-    ++it2;\n+-  }\n+-\n+-  while (it1 != end1) {\n+-    if (it1->getSize() != 1) {\n+-      return false;\n+-    }\n+-    ++it1;\n+-  }\n+-\n+-  while (it2 != end2) {\n+-    if (it2->getSize() != 1) {\n+-      return false;\n+-    }\n+-    ++it2;\n+-  }\n+-\n+-  return true;\n+-}\n+-\n+-}  // namespace\n+-\n+ bool HasHomogeneousTopology(FuncOp func) {\n+   ArrayRef<NamedMeshAttr> named_meshes = GetTopologyMeshes(func);\n+-  return llvm::all_of(named_meshes, [&](NamedMeshAttr named_mesh) {\n+-    return IsEquivalentMesh(named_mesh.getMesh(),\n+-                            named_meshes.front().getMesh());\n+-  });\n++  DenseSet<sdy::MeshAttr> meshes;\n++  for (NamedMeshAttr named_mesh : named_meshes) {\n++    meshes.insert(named_mesh.getMesh());\n++  }\n++  return meshes.size() == 1;\n+ }\n  \n-+  // Adds pipeline scheduling pass.\n-+  AddSchedulingPass(pm, options.pipelineSchedule);\n+ ArrayAttr GetFragmentOriginUnion(FragmentOp fragment1, FragmentOp fragment2,\n+@@ -720,3 +674,4 @@ std::optional<ReductionType> ComputeReductionType(Block& block) {\n+ }\n+ \n+ }  // namespace mlir::mpmd\n +\n-   // The remat passes will run after inlining the call ops and scheduling.\n-   // The reason why we choose to remat after scheduling is so that we don't need\n-   // to schedule the remat fragments. For example, given the following fragments\n-diff --git a/shardy/dialect/mpmd/transforms/optimize/passes.h b/shardy/dialect/mpmd/transforms/optimize/passes.h\n-index fb48d9c..7d4f111 100644\n---- a/shardy/dialect/mpmd/transforms/optimize/passes.h\n-+++ b/shardy/dialect/mpmd/transforms/optimize/passes.h\n-@@ -42,8 +42,6 @@ namespace mlir::mpmd {\n- struct OptimizeOptions {\n-   // A list of fragment merge rules.\n-   SmallVector<FragmentMergeRule> fragmentMergeRules;\n--  // A list of fragment schedule rules.\n--  SmallVector<FragmentScheduleRule> fragmentScheduleRules;\n-   // Whether to merge inferred fragments only after scheduling.\n-   bool mergeAfterScheduling = false;\n-   // Whether to identify matching forward and backward fragments and clone the\n-diff --git a/shardy/dialect/sdy/transforms/export/test/insert_explicit_reshards/dot_dot_general.mlir b/shardy/dialect/sdy/transforms/export/test/insert_explicit_reshards/dot_dot_general.mlir\n-index 6bc02eb..e7545f9 100644\n---- a/shardy/dialect/sdy/transforms/export/test/insert_explicit_reshards/dot_dot_general.mlir\n-+++ b/shardy/dialect/sdy/transforms/export/test/insert_explicit_reshards/dot_dot_general.mlir\n-@@ -572,15 +572,3 @@ func.func @dot_genaral_overlaps_and_trimmable_on_subaxis_multiple_axes(%arg0: te\n-   %0 = stablehlo.dot_general %arg0, %arg1, batching_dims = [0] x [0], contracting_dims = [2] x [1] {sdy.sharding = #sdy.sharding_per_value<[<@mesh_xyzt, [{}, {\"x\",\"y\",\"z\"}, {}]>]>} : (tensor<64x8x32xf32>, tensor<64x32x16xf32>) -> tensor<64x8x16xf32>\n-   return %0 : tensor<64x8x16xf32>\n+diff --git a/shardy/dialect/mpmd/transforms/import/test/call_op_set_topology.mlir b/shardy/dialect/mpmd/transforms/import/test/call_op_set_topology.mlir\n+index 9122ee7..2a83989 100644\n+--- a/shardy/dialect/mpmd/transforms/import/test/call_op_set_topology.mlir\n++++ b/shardy/dialect/mpmd/transforms/import/test/call_op_set_topology.mlir\n+@@ -1,4 +1,4 @@\n+-// RUN: mpmd_opt %s -mpmd-copy-topology-from-main -split-input-file 2>&1 | FileCheck %s\n++// RUN: mpmd_opt %s -mpmd-copy-topology-from-main 2>&1 | FileCheck %s\n+ \n+ // CHECK-LABEL: sdy.mesh @mesh = <[\"a\"=4, \"b\"=2]>\n+ #topology = #mpmd.topology<<\"mesh1\": <[\"a\"=4, \"b\"=2]>>, <\"mesh2\": <[\"a\"=4, \"b\"=2]>>>\n+@@ -38,18 +38,3 @@ func.func @shardy_mpmd_i(%arg0: tensor<5xf32>, %arg1: tensor<5xf32>) -> tensor<5\n+   %0 = stablehlo.add %arg0, %arg1 : tensor<5xf32>\n+   return %0 : tensor<5xf32>\n  }\n -\n--// CHECK-LABEL: func @dot_only_contracting_dims_sharded_and_has_same_shardings\n--func.func @dot_only_contracting_dims_sharded_and_has_same_shardings(\n--    %arg0: tensor<8x32xf32> {sdy.sharding = #sdy.sharding<@mesh, [{}, {\"y\"}]>},\n--    %arg1: tensor<32x16xf32> {sdy.sharding = #sdy.sharding<@mesh, [{\"y\"}, {}]>})\n--    -> tensor<8x16xf32> {\n--  // CHECK-NEXT: %[[DOT:.*]] = stablehlo.dot %arg0, %arg1\n--  // CHECK-NEXT: %[[ALL_REDUCE:.*]] = sdy.all_reduce {\"y\"} %[[DOT]] out_sharding=<@mesh, [{}, {}]>\n--  // CHECK: return %[[ALL_REDUCE]]\n--  %0 = stablehlo.dot %arg0, %arg1 : (tensor<8x32xf32>, tensor<32x16xf32>) -> tensor<8x16xf32>\n--  return %0 : tensor<8x16xf32>\n+-// -----\n+-\n+-// Verify that the homogeneous topology check ignores axes of size 1.\n+-// CHECK-LABEL: func.func public @main(%arg0: tensor<8xf32>) -> tensor<8xf32>\n+-func.func public @main(%arg0: tensor<8xf32>) -> tensor<8xf32> attributes {\n+-  topology=#mpmd.topology<\n+-    <\"mesh1\": <[\"a\"=4, \"b\"=2]>>,\n+-    <\"mesh2\": <[\"x\"=1, \"a\"=4, \"b\"=2]>>,\n+-    <\"mesh3\": <[\"a\"=4, \"b\"=2, \"y\"=1]>>,\n+-    <\"mesh4\": <[\"a\"=4, \"z\"=1, \"b\"=2]>>\n+-  >\n+-}{\n+-  return %arg0 : tensor<8xf32>\n -}\n-diff --git a/shardy/integrations/python/jax/mpmd/jaxlib/mpmd_program.h b/shardy/integrations/python/jax/mpmd/jaxlib/mpmd_program.h\n-index 65166c5..da4da35 100644\n---- a/shardy/integrations/python/jax/mpmd/jaxlib/mpmd_program.h\n-+++ b/shardy/integrations/python/jax/mpmd/jaxlib/mpmd_program.h\n-@@ -48,9 +48,8 @@ namespace mlir::mpmd {\n- enum PartitioningPhase : int32_t {\n-   kNone = 0,\n-   kImport = 1 << 0,\n--  kOptimize = 1 << 1,\n--  kPartition = 1 << 2,\n--  kAll = kImport | kOptimize | kPartition,\n-+  kPartition = 1 << 1,\n-+  kAll = kImport | kPartition,\n- };\n- \n- struct PartitioningResult {\n-diff --git a/shardy/integrations/python/jax/mpmd/types.py b/shardy/integrations/python/jax/mpmd/types.py\n-index 7dfa3aa..1facb95 100644\n---- a/shardy/integrations/python/jax/mpmd/types.py\n-+++ b/shardy/integrations/python/jax/mpmd/types.py\n-@@ -73,7 +73,6 @@ class FragmentInfo:\n-   split_type: SplitFragmentType | None = None\n-   mesh_name: str = ''\n+diff --git a/shardy/dialect/mpmd/transforms/optimize/utils.cc b/shardy/dialect/mpmd/transforms/optimize/utils.cc\n+index 39e05f0..d3fd142 100644\n+--- a/shardy/dialect/mpmd/transforms/optimize/utils.cc\n++++ b/shardy/dialect/mpmd/transforms/optimize/utils.cc\n+@@ -76,9 +76,9 @@ SmallVector<mpmd::NamedMeshAttr> GetSchedulableMeshes(func::FuncOp func) {\n+   auto all_meshes = mpmd::GetTopologyMeshes(func);\n+   SmallVector<mpmd::NamedMeshAttr> hbm_meshes;\n+   llvm::copy_if(all_meshes, std::back_inserter(hbm_meshes),\n+-                [](const mpmd::NamedMeshAttr& mesh) {\n+-                  return !mesh.getName().ends_with(mpmd::kCpuMeshSuffix);\n+-                });\n++                  [](const mpmd::NamedMeshAttr& mesh) {\n++                    return !mesh.getName().ends_with(\"#cpu\");\n++                  });\n+   return hbm_meshes;\n+ }\n  \n--\n- @dataclasses.dataclass(frozen=True)\n- class FragmentMergeRule:\n-   \"\"\"A rule for merging fragments of a computation.\"\"\"\n-@@ -85,16 +84,6 @@ class FragmentMergeRule:\n- FragmentMergeRules = Sequence[FragmentMergeRule]\n+diff --git a/shardy/dialect/sdy/ir/dialect.cc b/shardy/dialect/sdy/ir/dialect.cc\n+index 5113b47..008bb20 100644\n+--- a/shardy/dialect/sdy/ir/dialect.cc\n++++ b/shardy/dialect/sdy/ir/dialect.cc\n+@@ -972,11 +972,11 @@ bool TensorShardingAttr::isEquivalent(TensorShardingAttr otherSharding) const {\n+   if (!otherSharding) {\n+     return false;\n+   }\n++  ArrayRef<DimensionShardingAttr> left = getDimShardings();\n++  ArrayRef<DimensionShardingAttr> right = otherSharding.getDimShardings();\n+   if (getMeshOrRef() != otherSharding.getMeshOrRef()) {\n+     return false;\n+   }\n+-  ArrayRef<DimensionShardingAttr> left = getDimShardings();\n+-  ArrayRef<DimensionShardingAttr> right = otherSharding.getDimShardings();\n+   return left.size() == right.size() &&\n+          llvm::all_of(llvm::zip_equal(left, right), [](auto&& pair) {\n+            return std::get<0>(pair).getAxes() == std::get<1>(pair).getAxes();\n+diff --git a/shardy/dialect/sdy/transforms/export/insert_explicit_reshards.cc b/shardy/dialect/sdy/transforms/export/insert_explicit_reshards.cc\n+index 2f21374..a109df3 100644\n+--- a/shardy/dialect/sdy/transforms/export/insert_explicit_reshards.cc\n++++ b/shardy/dialect/sdy/transforms/export/insert_explicit_reshards.cc\n+@@ -158,7 +158,7 @@ void insertExplicitReshardsOnDataFlowOp(ShardableDataFlowOpInterface& op,\n+ // return %reshard  : tensor<4x8xf32>\n+ // ```\n+ template <class OpTy>\n+-void processDot(OpTy op, ShardingProjection& shardingProjection,\n++void processDot(OpTy op, ArrayRef<TensorShardingAttr> inShardings,\n+                 ArrayRef<TensorShardingAttr> outShardings, IRRewriter& rewriter,\n+                 const SymbolTable& symbolTable, OpShardingRuleAttr shardingRule,\n+                 const Mesh& mesh) {\n+@@ -166,6 +166,10 @@ void processDot(OpTy op, ShardingProjection& shardingProjection,\n+     // Result doesn't have a sharding.\n+     return;\n+   }\n++  ShardingProjection shardingProjection =\n++      ShardingProjection::build(inShardings, outShardings, shardingRule,\n++                                mesh.attr(), /*closedIfMissing=*/true);\n++\n+   const TensorFactorShardings& lhsSharding = shardingProjection.getOperand(0);\n+   const TensorFactorShardings& rhsSharding = shardingProjection.getOperand(1);\n+   TensorFactorShardings& resultSharding =\n+@@ -445,11 +449,11 @@ SmallVector<AxisRefAttr> processOp(Operation* op,\n  \n+   TypeSwitch<Operation*>(op)\n+       .Case<stablehlo::DotOp>([&](stablehlo::DotOp dotOp) {\n+-        processDot(dotOp, shardingProjection, outShardings, rewriter,\n+-                   symbolTable, shardingRule, mesh);\n++        processDot(dotOp, inShardings, outShardings, rewriter, symbolTable,\n++                   shardingRule, mesh);\n+       })\n+       .Case<stablehlo::DotGeneralOp>([&](stablehlo::DotGeneralOp dotGeneralOp) {\n+-        processDot(dotGeneralOp, shardingProjection, outShardings, rewriter,\n++        processDot(dotGeneralOp, inShardings, outShardings, rewriter,\n+                    symbolTable, shardingRule, mesh);\n+       });\n  \n--@dataclasses.dataclass(frozen=True)\n--class FragmentScheduleRule:\n--  \"\"\"A rule for scheduling fragments of a computation.\"\"\"\n--\n--  ordered_fragments: Sequence[FragmentInfo]\n--\n--\n--FragmentScheduleRules = Sequence[FragmentScheduleRule]\n--\n--\n- @dataclasses.dataclass(frozen=True)\n- class MpmdConfig:\n-   \"\"\"Config for constructing an MPMD program with PartIR.\n-@@ -131,9 +120,6 @@ class MpmdConfig:\n-     fragment_merge_rules: A sequence of fragment merge rules. Each merge rule\n-       contains a sequence of fragment metadata objects that should be merged\n-       into a single fragment, together with metadata for the resulting fragment.\n--    fragment_schedule_rules: A sequence of fragment schedule rules. Each\n--      schedule rule contains a sequence of fragment metadata objects in the\n--      order that they should be scheduled.\n-   \"\"\"\n+diff --git a/shardy/dialect/sdy/transforms/export/reshard_to_collectives.cc b/shardy/dialect/sdy/transforms/export/reshard_to_collectives.cc\n+index 845eeab..4e6c593 100644\n+--- a/shardy/dialect/sdy/transforms/export/reshard_to_collectives.cc\n++++ b/shardy/dialect/sdy/transforms/export/reshard_to_collectives.cc\n+@@ -469,8 +469,8 @@ class CollectiveInserter {\n+       collectiveAxes = AxisRefListAttr::get(getContext(), gatheringAxes);\n+     }\n+     if (hasGatheringAxes) {\n+-      result = AllGatherOp::create(rewriter, loc, result, collectiveAxesPerDim,\n+-                                   getCurrentSharding());\n++      result = rewriter.create<AllGatherOp>(loc, result, collectiveAxesPerDim,\n++                                            getCurrentSharding());\n+     }\n+   }\n  \n-   topology: Topology\n-@@ -144,7 +130,6 @@ class MpmdConfig:\n-   partitioning_options: PartitioningOptions | None\n-   read_input_output_mesh_from_shardings: bool\n-   fragment_merge_rules: FragmentMergeRules | None\n--  fragment_schedule_rules: FragmentScheduleRules | None\n+@@ -484,7 +484,7 @@ class CollectiveInserter {\n+   // - Splits A into two sub-axes A1 and A2, such that\n+   //   `size(A1) == capacityPerDim[d]`, adds A1 to `inAxesPerDim[d]`, and adds\n+   //   A2 back to the front of `getAvailableAxes(d)`.\n+-  // - Skips A if it isn't divisible by `capacityPerDim[d]` or vice versa, and\n++  // - Skips A if it isn't divisible by `capacityPerDim[d]` or visa versa, and\n+   //   adds it back to the front of `getAvailableAxes(d)`.\n+   //\n+   // For each axis A that is added to `inAxesPerDim[d]`, calls\n+@@ -861,8 +861,8 @@ class CollectiveInserter {\n+            llvm::zip_equal(collectiveAxesPerDim, *slicingAxesPerDim)) {\n+         collectiveAxes = AxisRefListAttr::get(getContext(), slicingAxes);\n+       }\n+-      result = AllSliceOp::create(rewriter, loc, result, collectiveAxesPerDim,\n+-                                  getCurrentSharding());\n++      result = rewriter.create<AllSliceOp>(loc, result, collectiveAxesPerDim,\n++                                           getCurrentSharding());\n+     }\n+   }\n  \n-   @property\n-   def _spmd_mesh(self) -> jax.sharding.Mesh:\n-@@ -213,7 +198,6 @@ def make_config(\n-     partitioning_options: PartitioningOptions | None = None,\n-     read_input_output_mesh_from_shardings: bool = False,\n-     fragment_merge_rules: FragmentMergeRules | None = None,\n--    fragment_schedule_rules: FragmentScheduleRules | None = None,\n- ) -> MpmdConfig:\n-   \"\"\"Creates a `MpmdConfig`, inferring the tpu topology if not provided.\n+@@ -1148,8 +1148,8 @@ class CollectiveInserter {\n+     // TODO(b/392797233): if the order of device ids changes, but the input or\n+     // output sharding is fully replicated, we can skip the collective permute.\n  \n-@@ -229,7 +213,6 @@ def make_config(\n-     partitioning_options: See `MpmdConfig`.\n-     read_input_output_mesh_from_shardings: see `MpmdConfig`.\n-     fragment_merge_rules: See `MpmdConfig`.\n--    fragment_schedule_rules: See `MpmdConfig`.\n+-    result = CollectivePermuteOp::create(rewriter, loc, result,\n+-                                         getCurrentSharding());\n++    result =\n++        rewriter.create<CollectivePermuteOp>(loc, result, getCurrentSharding());\n+   }\n  \n-   Returns:\n-     An `MpmdConfig` object.\n-@@ -260,10 +243,6 @@ def make_config(\n-     fragment_merge_rules = []\n-   validate_fragment_merge_rules(fragment_merge_rules)\n+   // TODO(b/392952931): currently we are greedily all-to-all-ing axes even if\n+@@ -1291,8 +1291,8 @@ class CollectiveInserter {\n+   void tryAllToAlls(bool allowOutOfOrderTarget) {\n+     for (int64_t srcDim = 0; srcDim < getRank(); ++srcDim) {\n+       while (auto info = getAllToAllInfo(srcDim, allowOutOfOrderTarget)) {\n+-        result = AllToAllOp::create(\n+-            rewriter, loc, result,\n++        result = rewriter.create<AllToAllOp>(\n++            loc, result,\n+             AllToAllParamAttr::get(rewriter.getContext(), info->axes, srcDim,\n+                                    info->tgtDim),\n+             getCurrentSharding());\n+diff --git a/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.cc b/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.cc\n+index 30a4324..a800444 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.cc\n++++ b/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.cc\n+@@ -25,9 +25,9 @@ limitations under the License.\n+ #include \"mlir/Pass/PassRegistry.h\"\n+ #include \"mlir/Support/LLVM.h\"\n+ #include \"mlir/Support/LogicalResult.h\"\n+-#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/factor_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n  \n--  if fragment_schedule_rules is None:\n--    fragment_schedule_rules = []\n--  validate_fragment_schedule_rules(fragment_schedule_rules)\n--\n-   return MpmdConfig(\n-       topology,\n-       name_to_mesh_assignment,\n-@@ -273,7 +252,6 @@ def make_config(\n-       partitioning_options,\n-       read_input_output_mesh_from_shardings,\n-       fragment_merge_rules,\n--      fragment_schedule_rules,\n-   )\n+ namespace mlir {\n+diff --git a/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.h b/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.h\n+index 7b3835e..941cd0e 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.h\n++++ b/shardy/dialect/sdy/transforms/propagation/aggressive_propagation.h\n+@@ -24,9 +24,9 @@ limitations under the License.\n+ #include \"mlir/Pass/Pass.h\"\n+ #include \"mlir/Support/LLVM.h\"\n+ #include \"mlir/Support/LogicalResult.h\"\n+-#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/aggressive_factor_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n  \n+ namespace mlir {\n+diff --git a/shardy/dialect/sdy/transforms/propagation/basic_propagation.cc b/shardy/dialect/sdy/transforms/propagation/basic_propagation.cc\n+index 336748e..1c5a9ca 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/basic_propagation.cc\n++++ b/shardy/dialect/sdy/transforms/propagation/basic_propagation.cc\n+@@ -23,6 +23,7 @@ limitations under the License.\n+ #include <utility>\n  \n-@@ -344,30 +322,6 @@ def validate_input_output_mesh_assignments(\n-       )\n+ #include \"llvm/ADT/STLExtras.h\"\n++#include \"llvm/Support/Threading.h\"\n+ #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n+ #include \"mlir/IR/BuiltinAttributes.h\"\n+ #include \"mlir/IR/BuiltinOps.h\"\n+@@ -41,8 +42,8 @@ limitations under the License.\n+ #include \"mlir/Pass/PassRegistry.h\"\n+ #include \"mlir/Support/LLVM.h\"\n+ #include \"mlir/Support/LogicalResult.h\"\n+-#include \"mlir/Support/WalkResult.h\"\n+ #include \"mlir/Transforms/GreedyPatternRewriteDriver.h\"\n++#include \"shardy/common/file_utils.h\"\n+ #include \"shardy/dialect/sdy/ir/dialect.h\"\n+ #include \"shardy/dialect/sdy/ir/enums.h\"\n+ #include \"shardy/dialect/sdy/ir/utils.h\"\n+@@ -51,6 +52,7 @@ limitations under the License.\n+ #include \"shardy/dialect/sdy/transforms/propagation/factor_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/op_sharding_rule_builder.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/op_sharding_rule_registry.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_projection.h\"\n  \n+diff --git a/shardy/dialect/sdy/transforms/propagation/basic_propagation.h b/shardy/dialect/sdy/transforms/propagation/basic_propagation.h\n+index de1527e..bfda43c 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/basic_propagation.h\n++++ b/shardy/dialect/sdy/transforms/propagation/basic_propagation.h\n+@@ -34,6 +34,7 @@ limitations under the License.\n+ #include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_factor_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/factor_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n  \n--def validate_fragment_rule_origins(\n--    fragment_sequence: Sequence[FragmentInfo],\n--) -> None:\n--  for fragment in fragment_sequence:\n--    if not fragment.origins:\n--      raise ValueError(\n--          f'Each fragment must have at least one origin, but got {fragment} in'\n--          f' {fragment_sequence}.'\n--      )\n--\n--\n--def validate_fragment_rule_meshes(\n--    fragment_sequence: Sequence[FragmentInfo],\n--) -> None:\n--  first_mesh = fragment_sequence[0].mesh_name\n--  if not all(\n--      fragment.mesh_name == first_mesh for fragment in fragment_sequence\n--  ):\n--    raise ValueError(\n--        'Fragments being merged/scheduled must be on the same mesh, but got'\n--        f' {fragment_sequence}.'\n--    )\n--\n--\n- def validate_fragment_merge_rules(\n-     fragment_merge_rules: FragmentMergeRules,\n- ) -> None:\n-@@ -379,8 +333,12 @@ def validate_fragment_merge_rules(\n-           'Fragment merge rule must contain at least two source fragments, but'\n-           f' got {rule}.'\n-       )\n--    validate_fragment_rule_origins(rule.sources)\n--    validate_fragment_rule_meshes(rule.sources)\n-+    for fragment in rule.sources:\n-+      if not fragment.origins:\n-+        raise ValueError(\n-+            'Each source fragment must have at least one origin, but got'\n-+            f' {rule}.'\n-+        )\n+ namespace mlir {\n+diff --git a/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.cc b/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.cc\n+index 81d9858..ff05e4f 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.cc\n++++ b/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.cc\n+@@ -34,9 +34,9 @@ limitations under the License.\n+ #include \"shardy/dialect/sdy/ir/dialect.h\"\n+ #include \"shardy/dialect/sdy/ir/utils.h\"\n+ #include \"shardy/dialect/sdy/transforms/common/op_properties.h\"\n+-#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/aggressive_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/utils.h\"\n+ #include \"stablehlo/dialect/StablehloOps.h\"\n+diff --git a/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.h b/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.h\n+index b0eecb6..ebd91d8 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.h\n++++ b/shardy/dialect/sdy/transforms/propagation/op_priority_propagation.h\n+@@ -24,9 +24,9 @@ limitations under the License.\n+ #include \"mlir/Pass/Pass.h\"\n+ #include \"mlir/Support/LLVM.h\"\n+ #include \"mlir/Support/LogicalResult.h\"\n+-#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/aggressive_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n  \n-     if not rule.target.origins:\n-       raise ValueError(\n-@@ -388,21 +346,6 @@ def validate_fragment_merge_rules(\n-       )\n+ namespace mlir {\n+diff --git a/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.cc b/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.cc\n+index f7571a6..7c3f9fa 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.cc\n++++ b/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.cc\n+@@ -37,10 +37,10 @@ limitations under the License.\n+ #include \"mlir/Support/LogicalResult.h\"\n+ #include \"shardy/common/file_utils.h\"\n+ #include \"shardy/dialect/sdy/ir/dialect.h\"\n+-#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/common/sharding_walker.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/op_priority_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n  \n+ namespace mlir {\n+diff --git a/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.h b/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.h\n+index 061d7ad..c59c923 100644\n+--- a/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.h\n++++ b/shardy/dialect/sdy/transforms/propagation/user_priority_propagation.h\n+@@ -23,9 +23,9 @@ limitations under the License.\n+ #include \"mlir/Pass/Pass.h\"\n+ #include \"mlir/Support/LLVM.h\"\n+ #include \"mlir/Support/LogicalResult.h\"\n+-#include \"shardy/dialect/sdy/transforms/common/propagation_options.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/basic_propagation.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/op_priority_propagation.h\"\n++#include \"shardy/dialect/sdy/transforms/propagation/passes.h\"\n+ #include \"shardy/dialect/sdy/transforms/propagation/sharding_group_map.h\"\n  \n--def validate_fragment_schedule_rules(\n--    fragment_schedule_rules: FragmentScheduleRules,\n--) -> None:\n--  \"\"\"Validates the fragment schedule rules.\"\"\"\n--  for rule in fragment_schedule_rules:\n--    if len(rule.ordered_fragments) < 2:\n--      raise ValueError(\n--          'Fragment schedule rule must contain at least two fragments, but'\n--          f' got {rule}.'\n--      )\n--\n--    validate_fragment_rule_origins(rule.ordered_fragments)\n--    validate_fragment_rule_meshes(rule.ordered_fragments)\n--\n--\n- def mesh_names(\n-     pytree: PyTree[\n-         jax.Array\n+ namespace mlir {\n diff --git a/third_party/llvm/generated.patch b/third_party/llvm/generated.patch\n-index 9fa7155..509398d 100644\n+index 509398d..7731e08 100644\n --- a/third_party/llvm/generated.patch\n +++ b/third_party/llvm/generated.patch\n-@@ -1,877 +1 @@\n+@@ -1 +1,45 @@\n  Auto generated patch. Do not edit or delete it, even if empty.\n--diff -ruN --strip-trailing-cr a/libcxx/include/ext/hash_set b/libcxx/include/ext/hash_set\n----- a/libcxx/include/ext/hash_set\n--+++ b/libcxx/include/ext/hash_set\n--@@ -534,10 +534,7 @@\n-- }\n-- \n-- template <class _Value, class _Hash, class _Pred, class _Alloc>\n---hash_multiset<_Value, _Hash, _Pred, _Alloc>::hash_multiset(const hash_multiset& __u) : __table_(__u.__table_) {\n---  __table_.__rehash_multi(__u.bucket_count());\n---  insert(__u.begin(), __u.end());\n---}\n--+hash_multiset<_Value, _Hash, _Pred, _Alloc>::hash_multiset(const hash_multiset& __u) : __table_(__u.__table_) {}\n-- \n-- template <class _Value, class _Hash, class _Pred, class _Alloc>\n-- template <class _InputIterator>\n--diff -ruN --strip-trailing-cr a/libcxx/test/extensions/gnu/hash_multiset/copy.pass.cpp b/libcxx/test/extensions/gnu/hash_multiset/copy.pass.cpp\n----- a/libcxx/test/extensions/gnu/hash_multiset/copy.pass.cpp\n--+++ b/libcxx/test/extensions/gnu/hash_multiset/copy.pass.cpp\n--@@ -0,0 +1,27 @@\n--+//===----------------------------------------------------------------------===//\n--+//\n--+// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.\n--+// See https://llvm.org/LICENSE.txt for license information.\n--+// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception\n--+//\n--+//===----------------------------------------------------------------------===//\n--+\n--+// ADDITIONAL_COMPILE_FLAGS: -Wno-deprecated\n--+\n--+// hash_multiset::hash_multiset(const hash_multiset&)\n--+\n--+#include <cassert>\n--+#include <ext/hash_set>\n--+\n--+int main(int, char**) {\n--+  __gnu_cxx::hash_multiset<int> set;\n--+\n--+  set.insert(1);\n--+  set.insert(1);\n--+\n--+  auto set2 = set;\n--+\n--+  assert(set2.size() == 2);\n--+\n--+  return 0;\n--+}\n--diff -ruN --strip-trailing-cr a/llvm/lib/CodeGen/AsmPrinter/DwarfExpression.cpp b/llvm/lib/CodeGen/AsmPrinter/DwarfExpression.cpp\n----- a/llvm/lib/CodeGen/AsmPrinter/DwarfExpression.cpp\n--+++ b/llvm/lib/CodeGen/AsmPrinter/DwarfExpression.cpp\n--@@ -154,7 +154,7 @@\n--     unsigned Size = TRI.getSubRegIdxSize(Idx);\n--     unsigned Offset = TRI.getSubRegIdxOffset(Idx);\n--     Reg = TRI.getDwarfRegNum(SR, false);\n---    if (Reg < 0)\n--+    if (Reg < 0 || Offset + Size > RegSize)\n--       continue;\n-- \n--     // Used to build the intersection between the bits we already\n--diff -ruN --strip-trailing-cr a/llvm/lib/Transforms/Vectorize/VPlan.h b/llvm/lib/Transforms/Vectorize/VPlan.h\n----- a/llvm/lib/Transforms/Vectorize/VPlan.h\n--+++ b/llvm/lib/Transforms/Vectorize/VPlan.h\n--@@ -705,6 +705,9 @@\n--   VPIRFlags(WrapFlagsTy WrapFlags)\n--       : OpType(OperationType::OverflowingBinOp), WrapFlags(WrapFlags) {}\n-- \n--+  VPIRFlags(TruncFlagsTy TruncFlags)\n--+      : OpType(OperationType::Trunc), TruncFlags(TruncFlags) {}\n--+\n--   VPIRFlags(FastMathFlags FMFs) : OpType(OperationType::FPMathOp), FMFs(FMFs) {}\n-- \n--   VPIRFlags(DisjointFlagsTy DisjointFlags)\n--@@ -1494,9 +1497,10 @@\n-- \n--   VPWidenCastRecipe(Instruction::CastOps Opcode, VPValue *Op, Type *ResultTy,\n--                     const VPIRFlags &Flags = {},\n--+                    const VPIRMetadata &Metadata = {},\n--                     DebugLoc DL = DebugLoc::getUnknown())\n--       : VPRecipeWithIRFlags(VPDef::VPWidenCastSC, Op, Flags, DL),\n---        VPIRMetadata(), Opcode(Opcode), ResultTy(ResultTy) {\n--+        VPIRMetadata(Metadata), Opcode(Opcode), ResultTy(ResultTy) {\n--     assert(flagsValidForOpcode(Opcode) &&\n--            \"Set flags not supported for the provided opcode\");\n--   }\n--@@ -1504,11 +1508,11 @@\n--   ~VPWidenCastRecipe() override = default;\n-- \n--   VPWidenCastRecipe *clone() override {\n--+    auto *New = new VPWidenCastRecipe(Opcode, getOperand(0), ResultTy, *this,\n--+                                      *this, getDebugLoc());\n--     if (auto *UV = getUnderlyingValue())\n---      return new VPWidenCastRecipe(Opcode, getOperand(0), ResultTy,\n---                                   *cast<CastInst>(UV));\n---\n---    return new VPWidenCastRecipe(Opcode, getOperand(0), ResultTy);\n--+      New->setUnderlyingValue(UV);\n--+    return New;\n--   }\n-- \n--   VP_CLASSOF_IMPL(VPDef::VPWidenCastSC)\n--diff -ruN --strip-trailing-cr a/llvm/lib/Transforms/Vectorize/VPlanRecipes.cpp b/llvm/lib/Transforms/Vectorize/VPlanRecipes.cpp\n----- a/llvm/lib/Transforms/Vectorize/VPlanRecipes.cpp\n--+++ b/llvm/lib/Transforms/Vectorize/VPlanRecipes.cpp\n--@@ -2016,13 +2016,13 @@\n--     return Opcode == Instruction::FAdd || Opcode == Instruction::FMul ||\n--            Opcode == Instruction::FSub || Opcode == Instruction::FNeg ||\n--            Opcode == Instruction::FDiv || Opcode == Instruction::FRem ||\n--+           Opcode == Instruction::FPExt || Opcode == Instruction::FPTrunc ||\n--            Opcode == Instruction::FCmp || Opcode == Instruction::Select ||\n--            Opcode == VPInstruction::WideIVStep ||\n--            Opcode == VPInstruction::ReductionStartVector ||\n--            Opcode == VPInstruction::ComputeReductionResult;\n--   case OperationType::NonNegOp:\n---    return Opcode == Instruction::ZExt;\n---    break;\n--+    return Opcode == Instruction::ZExt || Opcode == Instruction::UIToFP;\n--   case OperationType::Cmp:\n--     return Opcode == Instruction::FCmp || Opcode == Instruction::ICmp;\n--   case OperationType::Other:\n--diff -ruN --strip-trailing-cr a/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp b/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp\n----- a/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp\n--+++ b/llvm/lib/Transforms/Vectorize/VPlanTransforms.cpp\n--@@ -2195,7 +2195,8 @@\n--         auto [ProcessedIter, IterIsEmpty] = ProcessedTruncs.try_emplace(Op);\n--         VPWidenCastRecipe *NewOp =\n--             IterIsEmpty\n---                ? new VPWidenCastRecipe(Instruction::Trunc, Op, NewResTy)\n--+                ? new VPWidenCastRecipe(Instruction::Trunc, Op, NewResTy,\n--+                                        VPIRFlags::TruncFlagsTy(false, false))\n--                 : ProcessedIter->second;\n--         R.setOperand(Idx, NewOp);\n--         if (!IterIsEmpty)\n--@@ -3566,13 +3567,13 @@\n--                                    Mul, Ext0, Ext1, Ext)) {\n--       auto *NewExt0 = new VPWidenCastRecipe(\n--           Ext0->getOpcode(), Ext0->getOperand(0), Ext->getResultType(), *Ext0,\n---          Ext0->getDebugLoc());\n--+          *Ext0, Ext0->getDebugLoc());\n--       NewExt0->insertBefore(Ext0);\n-- \n--       VPWidenCastRecipe *NewExt1 = NewExt0;\n--       if (Ext0 != Ext1) {\n--         NewExt1 = new VPWidenCastRecipe(Ext1->getOpcode(), Ext1->getOperand(0),\n---                                        Ext->getResultType(), *Ext1,\n--+                                        Ext->getResultType(), *Ext1, *Ext1,\n--                                         Ext1->getDebugLoc());\n--         NewExt1->insertBefore(Ext1);\n--       }\n--diff -ruN --strip-trailing-cr a/llvm/test/CodeGen/AArch64/debug-info-sve-pair.mir b/llvm/test/CodeGen/AArch64/debug-info-sve-pair.mir\n----- a/llvm/test/CodeGen/AArch64/debug-info-sve-pair.mir\n--+++ b/llvm/test/CodeGen/AArch64/debug-info-sve-pair.mir\n--@@ -0,0 +1,344 @@\n--+# RUN: llc -start-before=aarch64-asm-printer -o - %s | FileCheck %s\n--+\n--+# Check that z30_z31 debug info does not crash.\n--+\n--+# CHECK: .Ldebug_loc0:\n--+# CHECK:        .byte   4                               // DW_LLE_offset_pair\n--+# CHECK:        .uleb128 .Ltmp2-.Lfunc_begin0           //   starting offset\n--+# CHECK:        .uleb128 .Ltmp3-.Lfunc_begin0           //   ending offset\n--+# CHECK:        .byte   2                               // Loc expr size\n--+# CHECK:        .byte   144                             // DW_OP_regx\n--+# CHECK:        .byte   126                             // 126\n--+# CHECK:        .byte   4                               // DW_LLE_offset_pair\n--+# CHECK:        .uleb128 .Ltmp3-.Lfunc_begin0           //   starting offset\n--+# CHECK:        .uleb128 .Lfunc_end0-.Lfunc_begin0      //   ending offset\n--+# CHECK:        .byte   6                               // Loc expr size\n--+# CHECK:        .byte   144                             // sub-register DW_OP_regx\n--+# CHECK:        .byte   94                              // 94\n--+# CHECK:        .byte   147                             // DW_OP_piece\n--+# CHECK:        .byte   16                              // 16\n--+# CHECK:        .byte   147                             // DW_OP_piece\n--+# CHECK:        .byte   31                              // 31\n--+# CHECK:        .byte   0                               // DW_LLE_end_of_list\n--+\n--+\n--+--- |\n--+  target datalayout = \"e-m:e-p270:32:32-p271:32:32-p272:64:64-i8:8:32-i16:16:32-i64:64-i128:128-n32:64-S128-Fn32\"\n--+  target triple = \"aarch64\"\n--+\n--+  define void @_Z10Sort16RowsILi6EEv12SharedTraitsI10TraitsLaneEP22Trans_NS_hwy_float16_tiS4_(i8 %st.coerce, ptr noundef %keys, i32 noundef %0, ptr noundef %1) #2 !dbg !2 {\n--+      unreachable\n--+  }\n--+\n--+  attributes #2 = { mustprogress uwtable vscale_range(1,16) \"frame-pointer\"=\"non-leaf\" \"no-trapping-math\"=\"true\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"neoverse-n1\" \"target-features\"=\"+aes,+crc,+dotprod,+fp-armv8,+fullfp16,+lse,+neon,+perfmon,+ras,+rcpc,+rdm,+sha2,+spe,+ssbs,+sve,+sve-aes,+sve2,+sve2-aes,+v8.1a,+v8.2a,+v8a,-fmv\" \"tune-cpu\"=\"generic\" }\n--+\n--+  !llvm.dbg.cu = !{!3}\n--+  !llvm.module.flags = !{!4, !5, !6, !7, !8, !9}\n--+  !llvm.ident = !{!10}\n--+\n--+  !2 = distinct !DISubprogram(name: \"Sort16Rows<6>\", linkageName: \"_Z10Sort16RowsILi6EEv12SharedTraitsI10TraitsLaneEP22Trans_NS_hwy_float16_tiS4_\", scope: !12, file: !12, line: 369, type: !18, scopeLine: 370, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !19, retainedNodes: !20, keyInstructions: true)\n--+  !3 = distinct !DICompileUnit(language: DW_LANG_C_plus_plus_14, file: !14, producer: \"clang version 22.0.0git (https://github.com/llvm/llvm-project.git)\", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, splitDebugInlining: false, nameTableKind: None)\n--+  !4 = !{i32 7, !\"Dwarf Version\", i32 5}\n--+  !5 = !{i32 2, !\"Debug Info Version\", i32 3}\n--+  !6 = !{i32 1, !\"wchar_size\", i32 4}\n--+  !7 = !{i32 7, !\"uwtable\", i32 2}\n--+  !8 = !{i32 7, !\"frame-pointer\", i32 1}\n--+  !9 = !{i32 7, !\"debug-info-assignment-tracking\", i1 true}\n--+  !10 = !{!\"clang version 22.0.0git (https://github.com/llvm/llvm-project.git)\"}\n--+  !12 = !DIFile(filename: \"example.cpp\", directory: \"/app\", checksumkind: CSK_MD5, checksum: \"5fbaafea0ede06ddd1ffc371aeee276e\")\n--+  !14 = !DIFile(filename: \"/app/example.cpp\", directory: \"/app\", checksumkind: CSK_MD5, checksum: \"5fbaafea0ede06ddd1ffc371aeee276e\")\n--+  !17 = !DIBasicType(name: \"__fp16\", size: 16, encoding: DW_ATE_float)\n--+  !18 = !DISubroutineType(types: !21)\n--+  !19 = !{!120}\n--+  !20 = !{!77, !78, !79, !80, !81, !82, !83, !84, !85, !86, !87, !88, !89, !90, !91, !92, !93, !94, !95, !96, !97, !98, !99, !100, !101, !102, !103, !104, !105}\n--+  !21 = !{null, !22, !23, !24, !23}\n--+  !22 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"SharedTraits<TraitsLane>\", file: !12, line: 272, size: 8, flags: DIFlagTypePassByValue, elements: !25, templateParams: !26, identifier: \"_ZTS12SharedTraitsI10TraitsLaneE\")\n--+  !23 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !55, size: 64)\n--+  !24 = !DIBasicType(name: \"int\", size: 32, encoding: DW_ATE_signed)\n--+  !25 = !{!27}\n--+  !26 = !{!76}\n--+  !27 = !DIDerivedType(tag: DW_TAG_inheritance, scope: !22, baseType: !28, extraData: i32 0)\n--+  !28 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"TraitsLane\", file: !12, line: 325, size: 8, flags: DIFlagTypePassByValue, elements: !29, identifier: \"_ZTS10TraitsLane\")\n--+  !29 = !{!30, !31, !32, !33}\n--+  !30 = !DIDerivedType(tag: DW_TAG_inheritance, scope: !28, baseType: !34, extraData: i32 0)\n--+  !31 = !DISubprogram(name: \"Sort2\", linkageName: \"_ZN10TraitsLane5Sort2E4SimdI22Trans_NS_hwy_float16_tLi1ELi0EERu13__SVFloat16_tS4_\", scope: !28, file: !12, line: 326, type: !70, scopeLine: 326, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)\n--+  !32 = !DISubprogram(name: \"SortPairsDistance1\", linkageName: \"_ZN10TraitsLane18SortPairsDistance1E4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEu13__SVFloat16_t\", scope: !28, file: !12, line: 344, type: !74, scopeLine: 344, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)\n--+  !33 = !DISubprogram(name: \"SortPairsDistance4\", linkageName: \"_ZN10TraitsLane18SortPairsDistance4E4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEu13__SVFloat16_t\", scope: !28, file: !12, line: 352, type: !74, scopeLine: 352, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)\n--+  !34 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"KeyLane\", file: !12, line: 307, size: 8, flags: DIFlagTypePassByValue, elements: !35, identifier: \"_ZTS7KeyLane\")\n--+  !35 = !{!36, !37, !38}\n--+  !36 = !DISubprogram(name: \"SwapAdjacentPairs\", linkageName: \"_ZN7KeyLane17SwapAdjacentPairsE4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEu13__SVFloat16_t\", scope: !34, file: !12, line: 309, type: !39, scopeLine: 309, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)\n--+  !37 = !DISubprogram(name: \"SwapAdjacentPairs\", linkageName: \"_ZN7KeyLane17SwapAdjacentPairsEu13__SVFloat32_t\", scope: !34, file: !12, line: 314, type: !58, scopeLine: 314, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)\n--+  !38 = !DISubprogram(name: \"OddEvenPairs\", linkageName: \"_ZN7KeyLane12OddEvenPairsE4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEu13__SVFloat16_tS3_\", scope: !34, file: !12, line: 318, type: !68, scopeLine: 318, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)\n--+  !39 = !DISubroutineType(types: !40)\n--+  !40 = !{!41, !42, !43, !41}\n--+  !41 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Vec<Simd<Trans_NS_hwy_float16_t, 1, 0> >\", file: !12, line: 270, baseType: !44)\n--+  !42 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !34, size: 64, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !43 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"Simd<Trans_NS_hwy_float16_t, 1, 0>\", file: !12, line: 83, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !51, identifier: \"_ZTS4SimdI22Trans_NS_hwy_float16_tLi1ELi0EE\")\n--+  !44 = !DIDerivedType(tag: DW_TAG_typedef, name: \"VFromD<Simd<Trans_NS_hwy_float16_t, 1, 0> >\", file: !12, line: 142, baseType: !45)\n--+  !45 = !DIDerivedType(tag: DW_TAG_typedef, name: \"svfloat16_t\", file: !12, line: 26, baseType: !46)\n--+  !46 = !DIDerivedType(tag: DW_TAG_typedef, name: \"__SVFloat16_t\", file: !12, baseType: !47)\n--+  !47 = !DICompositeType(tag: DW_TAG_array_type, baseType: !17, flags: DIFlagVector, elements: !48)\n--+  !48 = !{!49}\n--+  !49 = !DISubrange(lowerBound: 0, upperBound: !DIExpression(DW_OP_constu, 4, DW_OP_bregx, 46, 0, DW_OP_mul, DW_OP_constu, 1, DW_OP_minus))\n--+  !50 = !{}\n--+  !51 = !{!52, !53, !54}\n--+  !52 = !DITemplateTypeParameter(name: \"Lane\", type: !55)\n--+  !53 = !DITemplateValueParameter(type: !24, value: i32 1)\n--+  !54 = !DITemplateValueParameter(name: \"kPow2\", type: !24, value: i32 0)\n--+  !55 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"Trans_NS_hwy_float16_t\", file: !12, line: 6, size: 16, flags: DIFlagTypePassByValue, elements: !56, identifier: \"_ZTS22Trans_NS_hwy_float16_t\")\n--+  !56 = !{!57}\n--+  !57 = !DIDerivedType(tag: DW_TAG_member, name: \"native\", scope: !55, file: !12, line: 7, baseType: !17, size: 16)\n--+  !58 = !DISubroutineType(types: !59)\n--+  !59 = !{!60, !42, !60}\n--+  !60 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Vec<Simd<float, 0, 0> >\", file: !12, line: 270, baseType: !61)\n--+  !61 = !DIDerivedType(tag: DW_TAG_typedef, name: \"VFromD<Simd<float, 0, 0> >\", file: !12, line: 142, baseType: !62)\n--+  !62 = !DIDerivedType(tag: DW_TAG_typedef, name: \"svfloat32_t\", file: !12, line: 27, baseType: !63)\n--+  !63 = !DIDerivedType(tag: DW_TAG_typedef, name: \"__SVFloat32_t\", file: !12, baseType: !64)\n--+  !64 = !DICompositeType(tag: DW_TAG_array_type, baseType: !65, flags: DIFlagVector, elements: !66)\n--+  !65 = !DIBasicType(name: \"float\", size: 32, encoding: DW_ATE_float)\n--+  !66 = !{!67}\n--+  !67 = !DISubrange(lowerBound: 0, upperBound: !DIExpression(DW_OP_constu, 2, DW_OP_bregx, 46, 0, DW_OP_mul, DW_OP_constu, 1, DW_OP_minus))\n--+  !68 = !DISubroutineType(types: !69)\n--+  !69 = !{!41, !42, !43, !41, !41}\n--+  !70 = !DISubroutineType(types: !71)\n--+  !71 = !{null, !72, !43, !73, !73}\n--+  !72 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !28, size: 64, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !73 = !DIDerivedType(tag: DW_TAG_reference_type, baseType: !41, size: 64)\n--+  !74 = !DISubroutineType(types: !75)\n--+  !75 = !{!41, !72, !43, !41}\n--+  !76 = !DITemplateTypeParameter(name: \"Base\", type: !28)\n--+  !77 = !DILocalVariable(name: \"st\", arg: 1, scope: !2, file: !12, line: 369, type: !22)\n--+  !78 = !DILocalVariable(name: \"keys\", arg: 2, scope: !2, file: !12, line: 369, type: !23)\n--+  !79 = !DILocalVariable(arg: 3, scope: !2, file: !12, line: 369, type: !24)\n--+  !80 = !DILocalVariable(arg: 4, scope: !2, file: !12, line: 370, type: !23)\n--+  !81 = !DILocalVariable(name: \"d\", scope: !2, file: !12, line: 371, type: !106)\n--+  !82 = !DILocalVariable(name: \"v8\", scope: !2, file: !12, line: 373, type: !112)\n--+  !83 = !DILocalVariable(name: \"v9\", scope: !2, file: !12, line: 373, type: !112)\n--+  !84 = !DILocalVariable(name: \"va\", scope: !2, file: !12, line: 373, type: !112)\n--+  !85 = !DILocalVariable(name: \"vb\", scope: !2, file: !12, line: 373, type: !112)\n--+  !86 = !DILocalVariable(name: \"vc\", scope: !2, file: !12, line: 373, type: !112)\n--+  !87 = !DILocalVariable(name: \"vd\", scope: !2, file: !12, line: 373, type: !112)\n--+  !88 = !DILocalVariable(name: \"ve\", scope: !2, file: !12, line: 373, type: !112)\n--+  !89 = !DILocalVariable(name: \"vf\", scope: !2, file: !12, line: 373, type: !112)\n--+  !90 = !DILocalVariable(name: \"v2\", scope: !2, file: !12, line: 373, type: !112)\n--+  !91 = !DILocalVariable(name: \"v4\", scope: !2, file: !12, line: 373, type: !112)\n--+  !92 = !DILocalVariable(name: \"v7\", scope: !2, file: !12, line: 373, type: !112)\n--+  !93 = !DILocalVariable(name: \"v0\", scope: !2, file: !12, line: 374, type: !112)\n--+  !94 = !DILocalVariable(name: \"v3\", scope: !2, file: !12, line: 375, type: !112)\n--+  !95 = !DILocalVariable(name: \"v5\", scope: !2, file: !12, line: 376, type: !112)\n--+  !96 = !DILocalVariable(name: \"v6\", scope: !2, file: !12, line: 377, type: !112)\n--+  !97 = !DILocalVariable(name: \"kIota\", scope: !2, file: !12, line: 378, type: !112)\n--+  !98 = !DILocalVariable(name: \"m8\", scope: !2, file: !12, line: 379, type: !113)\n--+  !99 = !DILocalVariable(name: \"m9\", scope: !2, file: !12, line: 380, type: !113)\n--+  !100 = !DILocalVariable(name: \"ma\", scope: !2, file: !12, line: 381, type: !113)\n--+  !101 = !DILocalVariable(name: \"mb\", scope: !2, file: !12, line: 382, type: !113)\n--+  !102 = !DILocalVariable(name: \"mc\", scope: !2, file: !12, line: 383, type: !113)\n--+  !103 = !DILocalVariable(name: \"md\", scope: !2, file: !12, line: 384, type: !113)\n--+  !104 = !DILocalVariable(name: \"me\", scope: !2, file: !12, line: 385, type: !113)\n--+  !105 = !DILocalVariable(name: \"mf\", scope: !2, file: !12, line: 386, type: !113)\n--+  !106 = !DIDerivedType(tag: DW_TAG_typedef, name: \"CappedTag<Trans_NS_hwy_float16_t, 6>\", file: !12, line: 97, baseType: !107)\n--+  !107 = !DIDerivedType(tag: DW_TAG_typedef, name: \"type\", scope: !108, file: !12, line: 89, baseType: !43)\n--+  !108 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"ClampNAndPow2<Trans_NS_hwy_float16_t, 1>\", file: !12, line: 88, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !109, identifier: \"_ZTS13ClampNAndPow2I22Trans_NS_hwy_float16_tLi1EE\")\n--+  !109 = !{!110, !111}\n--+  !110 = !DITemplateTypeParameter(name: \"T\", type: !55)\n--+  !111 = !DITemplateValueParameter(name: \"N\", type: !24, value: i32 1)\n--+  !112 = !DIDerivedType(tag: DW_TAG_typedef, name: \"V\", scope: !2, file: !12, line: 372, baseType: !41)\n--+  !113 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Mask<Simd<Trans_NS_hwy_float16_t, 1, 0> >\", file: !12, line: 271, baseType: !114)\n--+  !114 = !DIDerivedType(tag: DW_TAG_typedef, name: \"svbool_t\", file: !12, line: 28, baseType: !115)\n--+  !115 = !DIDerivedType(tag: DW_TAG_typedef, name: \"__SVBool_t\", file: !12, baseType: !116)\n--+  !116 = !DICompositeType(tag: DW_TAG_array_type, baseType: !117, flags: DIFlagVector, elements: !118)\n--+  !117 = !DIBasicType(name: \"unsigned char\", size: 8, encoding: DW_ATE_unsigned_char)\n--+  !118 = !{!119}\n--+  !119 = !DISubrange(lowerBound: 0, upperBound: !DIExpression(DW_OP_constu, 1, DW_OP_bregx, 46, 0, DW_OP_mul, DW_OP_constu, 1, DW_OP_minus))\n--+  !120 = !DITemplateValueParameter(name: \"kKeysPerRow\", type: !24, value: i32 6)\n--+  !121 = !DILocalVariable(name: \"this\", arg: 1, scope: !122, type: !123, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !122 = distinct !DISubprogram(name: \"Sort2\", linkageName: \"_ZN10TraitsLane5Sort2E4SimdI22Trans_NS_hwy_float16_tLi1ELi0EERu13__SVFloat16_tS4_\", scope: !28, file: !12, line: 326, type: !70, scopeLine: 328, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, declaration: !31, retainedNodes: !124, keyInstructions: true)\n--+  !123 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !28, size: 64)\n--+  !124 = !{!121, !125, !126, !127, !128, !129, !130, !131, !132}\n--+  !125 = !DILocalVariable(name: \"d\", arg: 2, scope: !122, file: !12, line: 326, type: !43)\n--+  !126 = !DILocalVariable(name: \"a\", arg: 3, scope: !122, file: !12, line: 327, type: !73)\n--+  !127 = !DILocalVariable(name: \"b\", arg: 4, scope: !122, file: !12, line: 328, type: !73)\n--+  !128 = !DILocalVariable(name: \"__trans_tmp_52\", scope: !122, file: !12, line: 329, type: !41)\n--+  !129 = !DILocalVariable(name: \"a_copy\", scope: !122, file: !12, line: 329, type: !41)\n--+  !130 = !DILocalVariable(name: \"__trans_tmp_45\", scope: !122, file: !12, line: 330, type: !41)\n--+  !131 = !DILocalVariable(name: \"__trans_tmp_53\", scope: !133, file: !12, line: 334, type: !41)\n--+  !132 = !DILocalVariable(name: \"__trans_tmp_29\", scope: !134, file: !12, line: 336, type: !45)\n--+  !133 = distinct !DILexicalBlock(scope: !122, file: !12, line: 333, column: 5)\n--+  !134 = distinct !DILexicalBlock(scope: !133, file: !12, line: 335, column: 7)\n--+  !137 = distinct !DISubprogram(name: \"SortPairsDistance1\", linkageName: \"_ZN10TraitsLane18SortPairsDistance1E4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEu13__SVFloat16_t\", scope: !28, file: !12, line: 344, type: !74, scopeLine: 345, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, declaration: !32, retainedNodes: !139, keyInstructions: true)\n--+  !139 = !{!140, !141, !142, !143}\n--+  !140 = !DILocalVariable(name: \"this\", arg: 1, scope: !137, type: !123, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !141 = !DILocalVariable(name: \"d\", arg: 2, scope: !137, file: !12, line: 344, type: !43)\n--+  !142 = !DILocalVariable(name: \"v\", arg: 3, scope: !137, file: !12, line: 345, type: !41)\n--+  !143 = !DILocalVariable(name: \"__trans_tmp_48\", scope: !137, file: !12, line: 346, type: !41)\n--+  !144 = distinct !DISubprogram(name: \"Merge16x16<6, SharedTraits<TraitsLane>, __SVFloat16_t>\", linkageName: \"_Z10Merge16x16ILi6E12SharedTraitsI10TraitsLaneEu13__SVFloat16_tEvT0_RT1_S6_S6_S6_S6_S6_S6_S6_S6_S6_S6_S6_\", scope: !12, file: !12, line: 286, type: !146, scopeLine: 288, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !147, retainedNodes: !148, keyInstructions: true)\n--+  !145 = distinct !DILocation(line: 388, column: 3, scope: !2)\n--+  !146 = !DISubroutineType(types: !149)\n--+  !147 = !{!164, !165, !166}\n--+  !148 = !{!151, !152, !153, !154, !155, !156, !157, !158, !159, !160, !161, !162, !163}\n--+  !149 = !{null, !22, !150, !150, !150, !150, !150, !150, !150, !150, !150, !150, !150, !150}\n--+  !150 = !DIDerivedType(tag: DW_TAG_reference_type, baseType: !47, size: 64)\n--+  !151 = !DILocalVariable(name: \"st\", arg: 1, scope: !144, file: !12, line: 286, type: !22)\n--+  !152 = !DILocalVariable(name: \"v0\", arg: 2, scope: !144, file: !12, line: 286, type: !150)\n--+  !153 = !DILocalVariable(name: \"v2\", arg: 3, scope: !144, file: !12, line: 286, type: !150)\n--+  !154 = !DILocalVariable(name: \"v5\", arg: 4, scope: !144, file: !12, line: 286, type: !150)\n--+  !155 = !DILocalVariable(name: \"v6\", arg: 5, scope: !144, file: !12, line: 287, type: !150)\n--+  !156 = !DILocalVariable(name: \"v7\", arg: 6, scope: !144, file: !12, line: 287, type: !150)\n--+  !157 = !DILocalVariable(name: \"v9\", arg: 7, scope: !144, file: !12, line: 287, type: !150)\n--+  !158 = !DILocalVariable(name: \"va\", arg: 8, scope: !144, file: !12, line: 287, type: !150)\n--+  !159 = !DILocalVariable(name: \"vb\", arg: 9, scope: !144, file: !12, line: 287, type: !150)\n--+  !160 = !DILocalVariable(name: \"vc\", arg: 10, scope: !144, file: !12, line: 288, type: !150)\n--+  !161 = !DILocalVariable(name: \"vd\", arg: 11, scope: !144, file: !12, line: 288, type: !150)\n--+  !162 = !DILocalVariable(name: \"ve\", arg: 12, scope: !144, file: !12, line: 288, type: !150)\n--+  !163 = !DILocalVariable(name: \"vf\", arg: 13, scope: !144, file: !12, line: 288, type: !150)\n--+  !164 = !DITemplateValueParameter(type: !24, value: i32 6)\n--+  !165 = !DITemplateTypeParameter(name: \"Traits\", type: !22)\n--+  !166 = !DITemplateTypeParameter(name: \"V\", type: !47)\n--+  !184 = !DILocalVariable(name: \"this\", arg: 1, scope: !185, type: !186, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !185 = distinct !DISubprogram(name: \"SortPairsDistance2<Simd<Trans_NS_hwy_float16_t, 1, 0> >\", linkageName: \"_ZN12SharedTraitsI10TraitsLaneE18SortPairsDistance2I4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEEEDTcl4ZerocvT__EEES6_S7_\", scope: !22, file: !12, line: 273, type: !187, scopeLine: 273, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !188, declaration: !189, retainedNodes: !190, keyInstructions: true)\n--+  !186 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !22, size: 64)\n--+  !187 = !DISubroutineType(types: !191)\n--+  !188 = !{!193}\n--+  !189 = !DISubprogram(name: \"SortPairsDistance2<Simd<Trans_NS_hwy_float16_t, 1, 0> >\", linkageName: \"_ZN12SharedTraitsI10TraitsLaneE18SortPairsDistance2I4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEEEDTcl4ZerocvT__EEES6_S7_\", scope: !22, file: !12, line: 273, type: !187, scopeLine: 273, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized, templateParams: !188)\n--+  !190 = !{!184, !194, !195, !196, !197}\n--+  !191 = !{!41, !192, !43, !41}\n--+  !192 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !22, size: 64, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !193 = !DITemplateTypeParameter(name: \"D\", type: !43)\n--+  !194 = !DILocalVariable(name: \"d\", arg: 2, scope: !185, file: !12, line: 273, type: !43)\n--+  !195 = !DILocalVariable(name: \"v\", arg: 3, scope: !185, file: !12, line: 273, type: !41)\n--+  !196 = !DILocalVariable(name: \"base\", scope: !185, file: !12, line: 274, type: !28)\n--+  !197 = !DILocalVariable(name: \"swapped\", scope: !185, file: !12, line: 275, type: !41)\n--+  !200 = !DILocation(line: 0, scope: !122, inlinedAt: !201)\n--+  !201 = distinct !DILocation(line: 358, column: 5, scope: !202, inlinedAt: !203)\n--+  !202 = distinct !DISubprogram(name: \"SortPairsDistance4\", linkageName: \"_ZN10TraitsLane18SortPairsDistance4E4SimdI22Trans_NS_hwy_float16_tLi1ELi0EEu13__SVFloat16_t\", scope: !28, file: !12, line: 352, type: !74, scopeLine: 353, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, declaration: !33, retainedNodes: !204, keyInstructions: true)\n--+  !203 = distinct !DILocation(line: 298, column: 11, scope: !144, inlinedAt: !145)\n--+  !204 = !{!205, !206, !207, !208, !209, !210, !211}\n--+  !205 = !DILocalVariable(name: \"this\", arg: 1, scope: !202, type: !123, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !206 = !DILocalVariable(name: \"d\", arg: 2, scope: !202, file: !12, line: 352, type: !43)\n--+  !207 = !DILocalVariable(name: \"v\", arg: 3, scope: !202, file: !12, line: 353, type: !41)\n--+  !208 = !DILocalVariable(name: \"__trans_tmp_42\", scope: !202, file: !12, line: 354, type: !41)\n--+  !209 = !DILocalVariable(name: \"__trans_tmp_39\", scope: !202, file: !12, line: 354, type: !41)\n--+  !210 = !DILocalVariable(name: \"dw\", scope: !202, file: !12, line: 355, type: !212)\n--+  !211 = !DILocalVariable(name: \"__trans_tmp_51\", scope: !219, file: !12, line: 360, type: !44)\n--+  !212 = !DIDerivedType(tag: DW_TAG_typedef, name: \"RepartitionToWide<Simd<Trans_NS_hwy_float16_t, 1, 0> >\", file: !12, line: 103, baseType: !213)\n--+  !213 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Repartition<float, Simd<Trans_NS_hwy_float16_t, 1, 0> >\", file: !12, line: 101, baseType: !214)\n--+  !214 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Repartition<float>\", scope: !43, file: !12, line: 86, baseType: !215)\n--+  !215 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"Simd<float, 0, 0>\", file: !12, line: 83, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !216, identifier: \"_ZTS4SimdIfLi0ELi0EE\")\n--+  !216 = !{!217, !218, !54}\n--+  !217 = !DITemplateTypeParameter(name: \"Lane\", type: !65)\n--+  !218 = !DITemplateValueParameter(type: !24, value: i32 0)\n--+  !219 = distinct !DILexicalBlock(scope: !202, file: !12, line: 359, column: 5)\n--+  !220 = !DILocalVariable(name: \"this\", arg: 1, scope: !221, type: !222, flags: DIFlagArtificial | DIFlagObjectPointer)\n--+  !221 = distinct !DISubprogram(name: \"SwapAdjacentPairs\", linkageName: \"_ZN7KeyLane17SwapAdjacentPairsEu13__SVFloat32_t\", scope: !34, file: !12, line: 314, type: !58, scopeLine: 314, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, declaration: !37, retainedNodes: !223, keyInstructions: true)\n--+  !222 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !34, size: 64)\n--+  !223 = !{!220, !224}\n--+  !224 = !DILocalVariable(name: \"v\", arg: 2, scope: !221, file: !12, line: 314, type: !60)\n--+  !225 = distinct !DILocation(line: 357, column: 38, scope: !202, inlinedAt: !203)\n--+  !226 = !DILocalVariable(name: \"v\", arg: 1, scope: !227, file: !12, line: 264, type: !64)\n--+  !227 = distinct !DISubprogram(name: \"Shuffle1032<__SVFloat32_t>\", linkageName: \"_Z11Shuffle1032Iu13__SVFloat32_tET_S1_\", scope: !12, file: !12, line: 264, type: !228, scopeLine: 264, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !229, retainedNodes: !230, keyInstructions: true)\n--+  !228 = !DISubroutineType(types: !231)\n--+  !229 = !{!262}\n--+  !230 = !{!226, !232, !233, !234}\n--+  !231 = !{!64, !64}\n--+  !232 = !DILocalVariable(name: \"d\", scope: !227, file: !12, line: 265, type: !235)\n--+  !233 = !DILocalVariable(name: \"d8\", scope: !227, file: !12, line: 266, type: !252)\n--+  !234 = !DILocalVariable(name: \"v8\", scope: !227, file: !12, line: 267, type: !257)\n--+  !235 = !DIDerivedType(tag: DW_TAG_typedef, name: \"DFromV<__SVFloat32_t>\", file: !12, line: 108, baseType: !236)\n--+  !236 = !DIDerivedType(tag: DW_TAG_typedef, name: \"type\", scope: !237, file: !12, line: 116, baseType: !238)\n--+  !237 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"DFromV_t<__SVFloat32_t>\", file: !12, line: 115, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !239, identifier: \"_ZTS8DFromV_tIu13__SVFloat32_tE\")\n--+  !238 = !DIDerivedType(tag: DW_TAG_typedef, name: \"ScalableTag<float>\", file: !12, line: 95, baseType: !241)\n--+  !239 = !{!240}\n--+  !240 = !DITemplateTypeParameter(type: !64)\n--+  !241 = !DIDerivedType(tag: DW_TAG_typedef, name: \"type\", scope: !242, file: !12, line: 92, baseType: !243)\n--+  !242 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"ScalableTagChecker<float>\", file: !12, line: 91, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !244, identifier: \"_ZTS18ScalableTagCheckerIfE\")\n--+  !243 = !DIDerivedType(tag: DW_TAG_typedef, name: \"type\", scope: !246, file: !12, line: 89, baseType: !247)\n--+  !244 = !{!245}\n--+  !245 = !DITemplateTypeParameter(name: \"T\", type: !65)\n--+  !246 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"ClampNAndPow2<float, 64>\", file: !12, line: 88, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !248, identifier: \"_ZTS13ClampNAndPow2IfLi64EE\")\n--+  !247 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"Simd<float, 64, 0>\", file: !12, line: 83, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !250, identifier: \"_ZTS4SimdIfLi64ELi0EE\")\n--+  !248 = !{!245, !249}\n--+  !249 = !DITemplateValueParameter(name: \"N\", type: !24, value: i32 64)\n--+  !250 = !{!217, !251, !54}\n--+  !251 = !DITemplateValueParameter(type: !24, value: i32 64)\n--+  !252 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Repartition<unsigned char, Simd<float, 64, 0> >\", file: !12, line: 101, baseType: !253)\n--+  !253 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Repartition<unsigned char>\", scope: !247, file: !12, line: 86, baseType: !254)\n--+  !254 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"Simd<unsigned char, 0, 0>\", file: !12, line: 83, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !255, identifier: \"_ZTS4SimdIhLi0ELi0EE\")\n--+  !255 = !{!256, !218, !54}\n--+  !256 = !DITemplateTypeParameter(name: \"Lane\", type: !117)\n--+  !257 = !DIDerivedType(tag: DW_TAG_typedef, name: \"svuint8_t\", file: !12, line: 22, baseType: !258)\n--+  !258 = !DIDerivedType(tag: DW_TAG_typedef, name: \"__SVUint8_t\", file: !12, baseType: !259)\n--+  !259 = !DICompositeType(tag: DW_TAG_array_type, baseType: !117, flags: DIFlagVector, elements: !260)\n--+  !260 = !{!261}\n--+  !261 = !DISubrange(lowerBound: 0, upperBound: !DIExpression(DW_OP_constu, 8, DW_OP_bregx, 46, 0, DW_OP_mul, DW_OP_constu, 1, DW_OP_minus))\n--+  !262 = !DITemplateTypeParameter(name: \"V\", type: !64)\n--+  !263 = !DILocalVariable(name: \"hi\", arg: 1, scope: !264, file: !12, line: 248, type: !259)\n--+  !264 = distinct !DISubprogram(name: \"CombineShiftRightBytes<8, __SVUint8_t>\", linkageName: \"_Z22CombineShiftRightBytesILi8Eu11__SVUint8_tET0_S1_S1_\", scope: !12, file: !12, line: 248, type: !265, scopeLine: 248, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !266, retainedNodes: !267, keyInstructions: true)\n--+  !265 = !DISubroutineType(types: !268)\n--+  !266 = !{!283, !284}\n--+  !267 = !{!263, !269, !270, !271, !272, !273, !274, !275, !276}\n--+  !268 = !{!259, !259, !259}\n--+  !269 = !DILocalVariable(name: \"lo\", arg: 2, scope: !264, file: !12, line: 248, type: !259)\n--+  !270 = !DILocalVariable(name: \"__trans_tmp_33\", scope: !264, file: !12, line: 249, type: !257)\n--+  !271 = !DILocalVariable(name: \"__trans_tmp_15\", scope: !264, file: !12, line: 249, type: !257)\n--+  !272 = !DILocalVariable(name: \"__trans_tmp_32\", scope: !264, file: !12, line: 250, type: !257)\n--+  !273 = !DILocalVariable(name: \"d8\", scope: !264, file: !12, line: 251, type: !277)\n--+  !274 = !DILocalVariable(name: \"__trans_tmp_16\", scope: !264, file: !12, line: 252, type: !114)\n--+  !275 = !DILocalVariable(name: \"lo_down\", scope: !264, file: !12, line: 254, type: !257)\n--+  !276 = !DILocalVariable(name: \"__trans_tmp_34\", scope: !264, file: !12, line: 255, type: !114)\n--+  !277 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Repartition<unsigned char, Simd<char, 0, 0> >\", file: !12, line: 101, baseType: !278)\n--+  !278 = !DIDerivedType(tag: DW_TAG_typedef, name: \"Repartition<unsigned char>\", scope: !279, file: !12, line: 86, baseType: !254)\n--+  !279 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: \"Simd<char, 0, 0>\", file: !12, line: 83, size: 8, flags: DIFlagTypePassByValue, elements: !50, templateParams: !280, identifier: \"_ZTS4SimdIcLi0ELi0EE\")\n--+  !280 = !{!281, !218, !54}\n--+  !281 = !DITemplateTypeParameter(name: \"Lane\", type: !282)\n--+  !282 = !DIBasicType(name: \"char\", size: 8, encoding: DW_ATE_unsigned_char)\n--+  !283 = !DITemplateValueParameter(name: \"kBytes\", type: !24, value: i32 8)\n--+  !284 = !DITemplateTypeParameter(name: \"V\", type: !259)\n--+  !285 = !DILocalVariable(name: \"hi\", arg: 1, scope: !286, file: !12, line: 216, type: !257)\n--+  !286 = distinct !DISubprogram(name: \"Ext<8>\", linkageName: \"_Z3ExtILi8EEu11__SVUint8_tS0_S0_\", scope: !12, file: !12, line: 216, type: !287, scopeLine: 216, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !288, retainedNodes: !289, keyInstructions: true)\n--+  !287 = !DISubroutineType(types: !290)\n--+  !288 = !{!292}\n--+  !289 = !{!285, !291}\n--+  !290 = !{!257, !257, !257}\n--+  !291 = !DILocalVariable(name: \"lo\", arg: 2, scope: !286, file: !12, line: 216, type: !257)\n--+  !292 = !DITemplateValueParameter(name: \"kIndex\", type: !24, value: i32 8)\n--+  !293 = !DILocalVariable(name: \"a\", arg: 1, scope: !294, file: !12, line: 180, type: !47)\n--+  !294 = distinct !DISubprogram(name: \"Min<__SVFloat16_t>\", linkageName: \"_Z3MinIu13__SVFloat16_tET_S1_S1_\", scope: !12, file: !12, line: 180, type: !295, scopeLine: 180, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !3, templateParams: !296, retainedNodes: !297, keyInstructions: true)\n--+  !295 = !DISubroutineType(types: !298)\n--+  !296 = !{!166}\n--+  !297 = !{!293, !299, !300, !301, !302, !303, !304}\n--+  !298 = !{!47, !47, !47}\n--+  !299 = !DILocalVariable(name: \"b\", arg: 2, scope: !294, file: !12, line: 180, type: !47)\n--+  !300 = !DILocalVariable(name: \"__trans_tmp_36\", scope: !294, file: !12, line: 181, type: !45)\n--+  !301 = !DILocalVariable(name: \"__trans_tmp_25\", scope: !294, file: !12, line: 181, type: !45)\n--+  !302 = !DILocalVariable(name: \"__trans_tmp_27\", scope: !294, file: !12, line: 182, type: !114)\n--+  !303 = !DILocalVariable(name: \"__trans_tmp_24\", scope: !294, file: !12, line: 183, type: !114)\n--+  !304 = !DILocalVariable(name: \"__trans_tmp_19\", scope: !294, file: !12, line: 184, type: !114)\n--+  !308 = distinct !DILocation(line: 315, column: 12, scope: !221, inlinedAt: !225)\n--+  !309 = distinct !DILocation(line: 268, column: 21, scope: !227, inlinedAt: !308)\n--+  !311 = distinct !DILocation(line: 254, column: 18, scope: !264, inlinedAt: !309)\n--+  !312 = !DILocation(line: 217, column: 10, scope: !286, inlinedAt: !311, atomGroup: 1, atomRank: 2)\n--+  !313 = !DILocation(line: 257, column: 20, scope: !264, inlinedAt: !309, atomGroup: 5, atomRank: 2)\n--+  !314 = !DILocation(line: 0, scope: !294, inlinedAt: !315)\n--+  !315 = distinct !DILocation(line: 331, column: 22, scope: !122, inlinedAt: !201)\n--+  !316 = !DILocation(line: 185, column: 20, scope: !294, inlinedAt: !315)\n--+  !317 = !DILocation(line: 403, column: 1, scope: !2, atomGroup: 19449, atomRank: 1)\n--+\n--+...\n--+---\n--+name:            _Z10Sort16RowsILi6EEv12SharedTraitsI10TraitsLaneEP22Trans_NS_hwy_float16_tiS4_\n--+body:             |\n--+  bb.0:\n--+    liveins: $x1, $z0, $z1, $p0\n--+\n--+    $z30 = LDR_ZXI $x1, -14\n--+    $z31 = LDR_ZXI $x1, -13\n--+    $z23 = ORR_ZZZ $z30, $z30\n--+    renamable $z2 = EXT_ZZI_B renamable $z30_z31, 8,  debug-location !312\n--+    renamable $z7 = SEL_ZPZZ_B renamable $p0, renamable $z0, killed renamable $z1,  debug-location !313\n--+    DBG_VALUE $z30, $noreg, !129, !DIExpression(),  debug-location !200\n--+    renamable $p3 = nofpexcept FCMGT_PPzZZ_H renamable $p0, renamable $z0, undef renamable $z1,  debug-location !316\n--+    DBG_VALUE $z30_z31, $noreg, !129, !DIExpression(),  debug-location !200\n--+    DBG_VALUE $z30_z31, $noreg, !293, !DIExpression(),  debug-location !314\n--+    RET undef $lr,  debug-location !317\n--+...\n--+\n--diff -ruN --strip-trailing-cr a/llvm/test/Transforms/LoopVectorize/cse-casts.ll b/llvm/test/Transforms/LoopVectorize/cse-casts.ll\n----- a/llvm/test/Transforms/LoopVectorize/cse-casts.ll\n--+++ b/llvm/test/Transforms/LoopVectorize/cse-casts.ll\n--@@ -0,0 +1,351 @@\n--+; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --check-globals none --filter-out-after \"scalar.ph:\" --version 6\n--+; RUN: opt -p loop-vectorize -force-vector-width=4 -force-vector-interleave=2 -S %s | FileCheck %s\n--+\n--+define i8 @preserve_flags_when_cloning_trunc(i8 %start, ptr noalias %src, ptr noalias %dst) {\n--+; CHECK-LABEL: define i8 @preserve_flags_when_cloning_trunc(\n--+; CHECK-SAME: i8 [[START:%.*]], ptr noalias [[SRC:%.*]], ptr noalias [[DST:%.*]]) {\n--+; CHECK-NEXT:  [[ENTRY:.*:]]\n--+; CHECK-NEXT:    br label %[[VECTOR_PH:.*]]\n--+; CHECK:       [[VECTOR_PH]]:\n--+; CHECK-NEXT:    [[TMP0:%.*]] = insertelement <4 x i8> splat (i8 1), i8 [[START]], i32 0\n--+; CHECK-NEXT:    br label %[[VECTOR_BODY:.*]]\n--+; CHECK:       [[VECTOR_BODY]]:\n--+; CHECK-NEXT:    [[INDEX:%.*]] = phi i64 [ 0, %[[VECTOR_PH]] ], [ [[INDEX_NEXT:%.*]], %[[VECTOR_BODY]] ]\n--+; CHECK-NEXT:    [[VEC_PHI:%.*]] = phi <4 x i8> [ [[TMP0]], %[[VECTOR_PH]] ], [ [[TMP6:%.*]], %[[VECTOR_BODY]] ]\n--+; CHECK-NEXT:    [[VEC_PHI1:%.*]] = phi <4 x i8> [ splat (i8 1), %[[VECTOR_PH]] ], [ [[TMP7:%.*]], %[[VECTOR_BODY]] ]\n--+; CHECK-NEXT:    [[TMP1:%.*]] = load i32, ptr [[SRC]], align 4\n--+; CHECK-NEXT:    [[BROADCAST_SPLATINSERT:%.*]] = insertelement <4 x i32> poison, i32 [[TMP1]], i64 0\n--+; CHECK-NEXT:    [[BROADCAST_SPLAT:%.*]] = shufflevector <4 x i32> [[BROADCAST_SPLATINSERT]], <4 x i32> poison, <4 x i32> zeroinitializer\n--+; CHECK-NEXT:    [[TMP2:%.*]] = icmp ne <4 x i32> [[BROADCAST_SPLAT]], zeroinitializer\n--+; CHECK-NEXT:    [[TMP3:%.*]] = zext <4 x i1> [[TMP2]] to <4 x i16>\n--+; CHECK-NEXT:    [[TMP4:%.*]] = getelementptr i16, ptr [[DST]], i64 [[INDEX]]\n--+; CHECK-NEXT:    [[TMP5:%.*]] = getelementptr i16, ptr [[TMP4]], i32 4\n--+; CHECK-NEXT:    store <4 x i16> [[TMP3]], ptr [[TMP4]], align 2\n--+; CHECK-NEXT:    store <4 x i16> [[TMP3]], ptr [[TMP5]], align 2\n--+; CHECK-NEXT:    [[TMP6]] = mul <4 x i8> [[VEC_PHI]], splat (i8 3)\n--+; CHECK-NEXT:    [[TMP7]] = mul <4 x i8> [[VEC_PHI1]], splat (i8 3)\n--+; CHECK-NEXT:    [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 8\n--+; CHECK-NEXT:    [[TMP8:%.*]] = icmp eq i64 [[INDEX_NEXT]], 416\n--+; CHECK-NEXT:    br i1 [[TMP8]], label %[[MIDDLE_BLOCK:.*]], label %[[VECTOR_BODY]], !llvm.loop [[LOOP0:![0-9]+]]\n--+; CHECK:       [[MIDDLE_BLOCK]]:\n--+; CHECK-NEXT:    [[BIN_RDX:%.*]] = mul <4 x i8> [[TMP7]], [[TMP6]]\n--+; CHECK-NEXT:    [[TMP9:%.*]] = call i8 @llvm.vector.reduce.mul.v4i8(<4 x i8> [[BIN_RDX]])\n--+; CHECK-NEXT:    br label %[[SCALAR_PH:.*]]\n--+; CHECK:       [[SCALAR_PH]]:\n--+;\n--+entry:\n--+  br label %loop\n--+\n--+loop:\n--+  %iv = phi i64 [ %iv.next, %loop ], [ 0, %entry ]\n--+  %red = phi i8 [ %red.next, %loop ], [ %start, %entry ]\n--+  %l = load i32, ptr %src, align 4\n--+  %cmp = icmp ne i32 %l, 0\n--+  %cmp.ext = zext i1 %cmp to i64\n--+  %cmp.trunc = trunc i64 %cmp.ext to i16\n--+  %gep.dst = getelementptr i16, ptr %dst, i64 %iv\n--+  store i16 %cmp.trunc, ptr %gep.dst, align 2\n--+  %red.next = mul i8 %red, 3\n--+  %iv.next = add i64 %iv, 1\n--+  %ec = icmp ult i64 %iv, 416\n--+  br i1 %ec, label %loop, label %exit\n--+\n--+exit:\n--+  ret i8 %red.next\n--+}\n--+\n--+\n--+define void @preserve_flags_narrowing_extends_and_truncs(ptr noalias %A, ptr noalias %B, ptr noalias %C) {\n--+; CHECK-LABEL: define void @preserve_flags_narrowing_extends_and_truncs(\n--+; CHECK-SAME: ptr noalias [[A:%.*]], ptr noalias [[B:%.*]], ptr noalias [[C:%.*]]) {\n--+; CHECK-NEXT:  [[ENTRY:.*:]]\n--+; CHECK-NEXT:    br label %[[VECTOR_PH:.*]]\n--+; CHECK:       [[VECTOR_PH]]:\n--+; CHECK-NEXT:    br label %[[VECTOR_BODY:.*]]\n--+; CHECK:       [[VECTOR_BODY]]:\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_LOAD_IF:.*]], label %[[PRED_LOAD_CONTINUE:.*]]\n--+; CHECK:       [[PRED_LOAD_IF]]:\n--+; CHECK-NEXT:    [[TMP0:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 0\n--+; CHECK-NEXT:    [[TMP1:%.*]] = load i8, ptr [[TMP0]], align 1\n--+; CHECK-NEXT:    [[TMP2:%.*]] = insertelement <4 x i8> poison, i8 [[TMP1]], i32 0\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE]]:\n--+; CHECK-NEXT:    [[TMP3:%.*]] = phi <4 x i8> [ poison, %[[VECTOR_BODY]] ], [ [[TMP2]], %[[PRED_LOAD_IF]] ]\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_LOAD_IF1:.*]], label %[[PRED_LOAD_CONTINUE2:.*]]\n--+; CHECK:       [[PRED_LOAD_IF1]]:\n--+; CHECK-NEXT:    [[TMP4:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 1\n--+; CHECK-NEXT:    [[TMP5:%.*]] = load i8, ptr [[TMP4]], align 1\n--+; CHECK-NEXT:    [[TMP6:%.*]] = insertelement <4 x i8> [[TMP3]], i8 [[TMP5]], i32 1\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE2]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE2]]:\n--+; CHECK-NEXT:    [[TMP7:%.*]] = phi <4 x i8> [ [[TMP3]], %[[PRED_LOAD_CONTINUE]] ], [ [[TMP6]], %[[PRED_LOAD_IF1]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF3:.*]], label %[[PRED_LOAD_CONTINUE4:.*]]\n--+; CHECK:       [[PRED_LOAD_IF3]]:\n--+; CHECK-NEXT:    [[TMP8:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 2\n--+; CHECK-NEXT:    [[TMP9:%.*]] = load i8, ptr [[TMP8]], align 1\n--+; CHECK-NEXT:    [[TMP10:%.*]] = insertelement <4 x i8> [[TMP7]], i8 [[TMP9]], i32 2\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE4]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE4]]:\n--+; CHECK-NEXT:    [[TMP11:%.*]] = phi <4 x i8> [ [[TMP7]], %[[PRED_LOAD_CONTINUE2]] ], [ [[TMP10]], %[[PRED_LOAD_IF3]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF5:.*]], label %[[PRED_LOAD_CONTINUE6:.*]]\n--+; CHECK:       [[PRED_LOAD_IF5]]:\n--+; CHECK-NEXT:    [[TMP12:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 3\n--+; CHECK-NEXT:    [[TMP13:%.*]] = load i8, ptr [[TMP12]], align 1\n--+; CHECK-NEXT:    [[TMP14:%.*]] = insertelement <4 x i8> [[TMP11]], i8 [[TMP13]], i32 3\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE6]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE6]]:\n--+; CHECK-NEXT:    [[TMP15:%.*]] = phi <4 x i8> [ [[TMP11]], %[[PRED_LOAD_CONTINUE4]] ], [ [[TMP14]], %[[PRED_LOAD_IF5]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF7:.*]], label %[[PRED_LOAD_CONTINUE8:.*]]\n--+; CHECK:       [[PRED_LOAD_IF7]]:\n--+; CHECK-NEXT:    [[TMP16:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 4\n--+; CHECK-NEXT:    [[TMP17:%.*]] = load i8, ptr [[TMP16]], align 1\n--+; CHECK-NEXT:    [[TMP18:%.*]] = insertelement <4 x i8> poison, i8 [[TMP17]], i32 0\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE8]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE8]]:\n--+; CHECK-NEXT:    [[TMP19:%.*]] = phi <4 x i8> [ poison, %[[PRED_LOAD_CONTINUE6]] ], [ [[TMP18]], %[[PRED_LOAD_IF7]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF9:.*]], label %[[PRED_LOAD_CONTINUE10:.*]]\n--+; CHECK:       [[PRED_LOAD_IF9]]:\n--+; CHECK-NEXT:    [[TMP20:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 5\n--+; CHECK-NEXT:    [[TMP21:%.*]] = load i8, ptr [[TMP20]], align 1\n--+; CHECK-NEXT:    [[TMP22:%.*]] = insertelement <4 x i8> [[TMP19]], i8 [[TMP21]], i32 1\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE10]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE10]]:\n--+; CHECK-NEXT:    [[TMP23:%.*]] = phi <4 x i8> [ [[TMP19]], %[[PRED_LOAD_CONTINUE8]] ], [ [[TMP22]], %[[PRED_LOAD_IF9]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF11:.*]], label %[[PRED_LOAD_CONTINUE12:.*]]\n--+; CHECK:       [[PRED_LOAD_IF11]]:\n--+; CHECK-NEXT:    [[TMP24:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 6\n--+; CHECK-NEXT:    [[TMP25:%.*]] = load i8, ptr [[TMP24]], align 1\n--+; CHECK-NEXT:    [[TMP26:%.*]] = insertelement <4 x i8> [[TMP23]], i8 [[TMP25]], i32 2\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE12]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE12]]:\n--+; CHECK-NEXT:    [[TMP27:%.*]] = phi <4 x i8> [ [[TMP23]], %[[PRED_LOAD_CONTINUE10]] ], [ [[TMP26]], %[[PRED_LOAD_IF11]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF13:.*]], label %[[PRED_LOAD_CONTINUE14:.*]]\n--+; CHECK:       [[PRED_LOAD_IF13]]:\n--+; CHECK-NEXT:    [[TMP28:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 7\n--+; CHECK-NEXT:    [[TMP29:%.*]] = load i8, ptr [[TMP28]], align 1\n--+; CHECK-NEXT:    [[TMP30:%.*]] = insertelement <4 x i8> [[TMP27]], i8 [[TMP29]], i32 3\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE14]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE14]]:\n--+; CHECK-NEXT:    [[TMP31:%.*]] = phi <4 x i8> [ [[TMP27]], %[[PRED_LOAD_CONTINUE12]] ], [ [[TMP30]], %[[PRED_LOAD_IF13]] ]\n--+; CHECK-NEXT:    [[TMP32:%.*]] = zext <4 x i8> [[TMP15]] to <4 x i64>\n--+; CHECK-NEXT:    [[TMP33:%.*]] = zext <4 x i8> [[TMP31]] to <4 x i64>\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_STORE_IF:.*]], label %[[PRED_STORE_CONTINUE:.*]]\n--+; CHECK:       [[PRED_STORE_IF]]:\n--+; CHECK-NEXT:    [[TMP34:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 0\n--+; CHECK-NEXT:    [[TMP35:%.*]] = extractelement <4 x i64> [[TMP32]], i32 0\n--+; CHECK-NEXT:    store i64 [[TMP35]], ptr [[TMP34]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE]]\n--+; CHECK:       [[PRED_STORE_CONTINUE]]:\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_STORE_IF15:.*]], label %[[PRED_STORE_CONTINUE16:.*]]\n--+; CHECK:       [[PRED_STORE_IF15]]:\n--+; CHECK-NEXT:    [[TMP36:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 1\n--+; CHECK-NEXT:    [[TMP37:%.*]] = extractelement <4 x i64> [[TMP32]], i32 1\n--+; CHECK-NEXT:    store i64 [[TMP37]], ptr [[TMP36]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE16]]\n--+; CHECK:       [[PRED_STORE_CONTINUE16]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF17:.*]], label %[[PRED_STORE_CONTINUE18:.*]]\n--+; CHECK:       [[PRED_STORE_IF17]]:\n--+; CHECK-NEXT:    [[TMP38:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 2\n--+; CHECK-NEXT:    [[TMP39:%.*]] = extractelement <4 x i64> [[TMP32]], i32 2\n--+; CHECK-NEXT:    store i64 [[TMP39]], ptr [[TMP38]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE18]]\n--+; CHECK:       [[PRED_STORE_CONTINUE18]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF19:.*]], label %[[PRED_STORE_CONTINUE20:.*]]\n--+; CHECK:       [[PRED_STORE_IF19]]:\n--+; CHECK-NEXT:    [[TMP40:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 3\n--+; CHECK-NEXT:    [[TMP41:%.*]] = extractelement <4 x i64> [[TMP32]], i32 3\n--+; CHECK-NEXT:    store i64 [[TMP41]], ptr [[TMP40]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE20]]\n--+; CHECK:       [[PRED_STORE_CONTINUE20]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF21:.*]], label %[[PRED_STORE_CONTINUE22:.*]]\n--+; CHECK:       [[PRED_STORE_IF21]]:\n--+; CHECK-NEXT:    [[TMP42:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 4\n--+; CHECK-NEXT:    [[TMP43:%.*]] = extractelement <4 x i64> [[TMP33]], i32 0\n--+; CHECK-NEXT:    store i64 [[TMP43]], ptr [[TMP42]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE22]]\n--+; CHECK:       [[PRED_STORE_CONTINUE22]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF23:.*]], label %[[PRED_STORE_CONTINUE24:.*]]\n--+; CHECK:       [[PRED_STORE_IF23]]:\n--+; CHECK-NEXT:    [[TMP44:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 5\n--+; CHECK-NEXT:    [[TMP45:%.*]] = extractelement <4 x i64> [[TMP33]], i32 1\n--+; CHECK-NEXT:    store i64 [[TMP45]], ptr [[TMP44]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE24]]\n--+; CHECK:       [[PRED_STORE_CONTINUE24]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF25:.*]], label %[[PRED_STORE_CONTINUE26:.*]]\n--+; CHECK:       [[PRED_STORE_IF25]]:\n--+; CHECK-NEXT:    [[TMP46:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 6\n--+; CHECK-NEXT:    [[TMP47:%.*]] = extractelement <4 x i64> [[TMP33]], i32 2\n--+; CHECK-NEXT:    store i64 [[TMP47]], ptr [[TMP46]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE26]]\n--+; CHECK:       [[PRED_STORE_CONTINUE26]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF27:.*]], label %[[PRED_STORE_CONTINUE28:.*]]\n--+; CHECK:       [[PRED_STORE_IF27]]:\n--+; CHECK-NEXT:    [[TMP48:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 7\n--+; CHECK-NEXT:    [[TMP49:%.*]] = extractelement <4 x i64> [[TMP33]], i32 3\n--+; CHECK-NEXT:    store i64 [[TMP49]], ptr [[TMP48]], align 4\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE28]]\n--+; CHECK:       [[PRED_STORE_CONTINUE28]]:\n--+; CHECK-NEXT:    [[TMP50:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 0\n--+; CHECK-NEXT:    [[TMP51:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 1\n--+; CHECK-NEXT:    [[TMP52:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 2\n--+; CHECK-NEXT:    [[TMP53:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 3\n--+; CHECK-NEXT:    [[TMP54:%.*]] = insertelement <4 x ptr> poison, ptr [[TMP50]], i32 0\n--+; CHECK-NEXT:    [[TMP55:%.*]] = insertelement <4 x ptr> [[TMP54]], ptr [[TMP51]], i32 1\n--+; CHECK-NEXT:    [[TMP56:%.*]] = insertelement <4 x ptr> [[TMP55]], ptr [[TMP52]], i32 2\n--+; CHECK-NEXT:    [[TMP57:%.*]] = insertelement <4 x ptr> [[TMP56]], ptr [[TMP53]], i32 3\n--+; CHECK-NEXT:    [[TMP58:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 4\n--+; CHECK-NEXT:    [[TMP59:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 5\n--+; CHECK-NEXT:    [[TMP60:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 6\n--+; CHECK-NEXT:    [[TMP61:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 7\n--+; CHECK-NEXT:    [[TMP62:%.*]] = insertelement <4 x ptr> poison, ptr [[TMP58]], i32 0\n--+; CHECK-NEXT:    [[TMP63:%.*]] = insertelement <4 x ptr> [[TMP62]], ptr [[TMP59]], i32 1\n--+; CHECK-NEXT:    [[TMP64:%.*]] = insertelement <4 x ptr> [[TMP63]], ptr [[TMP60]], i32 2\n--+; CHECK-NEXT:    [[TMP65:%.*]] = insertelement <4 x ptr> [[TMP64]], ptr [[TMP61]], i32 3\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_LOAD_IF29:.*]], label %[[PRED_LOAD_CONTINUE30:.*]]\n--+; CHECK:       [[PRED_LOAD_IF29]]:\n--+; CHECK-NEXT:    [[TMP66:%.*]] = load i8, ptr [[TMP50]], align 1\n--+; CHECK-NEXT:    [[TMP67:%.*]] = insertelement <4 x i8> poison, i8 [[TMP66]], i32 0\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE30]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE30]]:\n--+; CHECK-NEXT:    [[TMP68:%.*]] = phi <4 x i8> [ poison, %[[PRED_STORE_CONTINUE28]] ], [ [[TMP67]], %[[PRED_LOAD_IF29]] ]\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_LOAD_IF31:.*]], label %[[PRED_LOAD_CONTINUE32:.*]]\n--+; CHECK:       [[PRED_LOAD_IF31]]:\n--+; CHECK-NEXT:    [[TMP69:%.*]] = load i8, ptr [[TMP51]], align 1\n--+; CHECK-NEXT:    [[TMP70:%.*]] = insertelement <4 x i8> [[TMP68]], i8 [[TMP69]], i32 1\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE32]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE32]]:\n--+; CHECK-NEXT:    [[TMP71:%.*]] = phi <4 x i8> [ [[TMP68]], %[[PRED_LOAD_CONTINUE30]] ], [ [[TMP70]], %[[PRED_LOAD_IF31]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF33:.*]], label %[[PRED_LOAD_CONTINUE34:.*]]\n--+; CHECK:       [[PRED_LOAD_IF33]]:\n--+; CHECK-NEXT:    [[TMP72:%.*]] = load i8, ptr [[TMP52]], align 1\n--+; CHECK-NEXT:    [[TMP73:%.*]] = insertelement <4 x i8> [[TMP71]], i8 [[TMP72]], i32 2\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE34]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE34]]:\n--+; CHECK-NEXT:    [[TMP74:%.*]] = phi <4 x i8> [ [[TMP71]], %[[PRED_LOAD_CONTINUE32]] ], [ [[TMP73]], %[[PRED_LOAD_IF33]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF35:.*]], label %[[PRED_LOAD_CONTINUE36:.*]]\n--+; CHECK:       [[PRED_LOAD_IF35]]:\n--+; CHECK-NEXT:    [[TMP75:%.*]] = load i8, ptr [[TMP53]], align 1\n--+; CHECK-NEXT:    [[TMP76:%.*]] = insertelement <4 x i8> [[TMP74]], i8 [[TMP75]], i32 3\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE36]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE36]]:\n--+; CHECK-NEXT:    [[TMP77:%.*]] = phi <4 x i8> [ [[TMP74]], %[[PRED_LOAD_CONTINUE34]] ], [ [[TMP76]], %[[PRED_LOAD_IF35]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF37:.*]], label %[[PRED_LOAD_CONTINUE38:.*]]\n--+; CHECK:       [[PRED_LOAD_IF37]]:\n--+; CHECK-NEXT:    [[TMP78:%.*]] = load i8, ptr [[TMP58]], align 1\n--+; CHECK-NEXT:    [[TMP79:%.*]] = insertelement <4 x i8> poison, i8 [[TMP78]], i32 0\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE38]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE38]]:\n--+; CHECK-NEXT:    [[TMP80:%.*]] = phi <4 x i8> [ poison, %[[PRED_LOAD_CONTINUE36]] ], [ [[TMP79]], %[[PRED_LOAD_IF37]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF39:.*]], label %[[PRED_LOAD_CONTINUE40:.*]]\n--+; CHECK:       [[PRED_LOAD_IF39]]:\n--+; CHECK-NEXT:    [[TMP81:%.*]] = load i8, ptr [[TMP59]], align 1\n--+; CHECK-NEXT:    [[TMP82:%.*]] = insertelement <4 x i8> [[TMP80]], i8 [[TMP81]], i32 1\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE40]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE40]]:\n--+; CHECK-NEXT:    [[TMP83:%.*]] = phi <4 x i8> [ [[TMP80]], %[[PRED_LOAD_CONTINUE38]] ], [ [[TMP82]], %[[PRED_LOAD_IF39]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF41:.*]], label %[[PRED_LOAD_CONTINUE42:.*]]\n--+; CHECK:       [[PRED_LOAD_IF41]]:\n--+; CHECK-NEXT:    [[TMP84:%.*]] = load i8, ptr [[TMP60]], align 1\n--+; CHECK-NEXT:    [[TMP85:%.*]] = insertelement <4 x i8> [[TMP83]], i8 [[TMP84]], i32 2\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE42]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE42]]:\n--+; CHECK-NEXT:    [[TMP86:%.*]] = phi <4 x i8> [ [[TMP83]], %[[PRED_LOAD_CONTINUE40]] ], [ [[TMP85]], %[[PRED_LOAD_IF41]] ]\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_LOAD_IF43:.*]], label %[[PRED_LOAD_CONTINUE44:.*]]\n--+; CHECK:       [[PRED_LOAD_IF43]]:\n--+; CHECK-NEXT:    [[TMP87:%.*]] = load i8, ptr [[TMP61]], align 1\n--+; CHECK-NEXT:    [[TMP88:%.*]] = insertelement <4 x i8> [[TMP86]], i8 [[TMP87]], i32 3\n--+; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE44]]\n--+; CHECK:       [[PRED_LOAD_CONTINUE44]]:\n--+; CHECK-NEXT:    [[TMP89:%.*]] = phi <4 x i8> [ [[TMP86]], %[[PRED_LOAD_CONTINUE42]] ], [ [[TMP88]], %[[PRED_LOAD_IF43]] ]\n--+; CHECK-NEXT:    [[TMP90:%.*]] = trunc <4 x i8> [[TMP77]] to <4 x i1>\n--+; CHECK-NEXT:    [[TMP91:%.*]] = trunc <4 x i8> [[TMP89]] to <4 x i1>\n--+; CHECK-NEXT:    [[TMP92:%.*]] = and <4 x i1> [[TMP90]], splat (i1 true)\n--+; CHECK-NEXT:    [[TMP93:%.*]] = and <4 x i1> [[TMP91]], splat (i1 true)\n--+; CHECK-NEXT:    [[TMP94:%.*]] = select <4 x i1> [[TMP90]], <4 x float> splat (float 1.000000e+00), <4 x float> zeroinitializer\n--+; CHECK-NEXT:    [[TMP95:%.*]] = select <4 x i1> [[TMP91]], <4 x float> splat (float 1.000000e+00), <4 x float> zeroinitializer\n--+; CHECK-NEXT:    [[TMP96:%.*]] = select <4 x i1> [[TMP92]], <4 x float> splat (float 3.000000e+00), <4 x float> [[TMP94]]\n--+; CHECK-NEXT:    [[TMP97:%.*]] = select <4 x i1> [[TMP93]], <4 x float> splat (float 3.000000e+00), <4 x float> [[TMP95]]\n--+; CHECK-NEXT:    [[TMP98:%.*]] = bitcast <4 x float> [[TMP96]] to <4 x i32>\n--+; CHECK-NEXT:    [[TMP99:%.*]] = bitcast <4 x float> [[TMP97]] to <4 x i32>\n--+; CHECK-NEXT:    [[TMP100:%.*]] = trunc <4 x i32> [[TMP98]] to <4 x i8>\n--+; CHECK-NEXT:    [[TMP101:%.*]] = trunc <4 x i32> [[TMP99]] to <4 x i8>\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_STORE_IF45:.*]], label %[[PRED_STORE_CONTINUE46:.*]]\n--+; CHECK:       [[PRED_STORE_IF45]]:\n--+; CHECK-NEXT:    [[TMP102:%.*]] = extractelement <4 x i8> [[TMP100]], i32 0\n--+; CHECK-NEXT:    store i8 [[TMP102]], ptr [[TMP50]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE46]]\n--+; CHECK:       [[PRED_STORE_CONTINUE46]]:\n--+; CHECK-NEXT:    br i1 true, label %[[PRED_STORE_IF47:.*]], label %[[PRED_STORE_CONTINUE48:.*]]\n--+; CHECK:       [[PRED_STORE_IF47]]:\n--+; CHECK-NEXT:    [[TMP103:%.*]] = extractelement <4 x i8> [[TMP100]], i32 1\n--+; CHECK-NEXT:    store i8 [[TMP103]], ptr [[TMP51]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE48]]\n--+; CHECK:       [[PRED_STORE_CONTINUE48]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF49:.*]], label %[[PRED_STORE_CONTINUE50:.*]]\n--+; CHECK:       [[PRED_STORE_IF49]]:\n--+; CHECK-NEXT:    [[TMP104:%.*]] = extractelement <4 x i8> [[TMP100]], i32 2\n--+; CHECK-NEXT:    store i8 [[TMP104]], ptr [[TMP52]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE50]]\n--+; CHECK:       [[PRED_STORE_CONTINUE50]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF51:.*]], label %[[PRED_STORE_CONTINUE52:.*]]\n--+; CHECK:       [[PRED_STORE_IF51]]:\n--+; CHECK-NEXT:    [[TMP105:%.*]] = extractelement <4 x i8> [[TMP100]], i32 3\n--+; CHECK-NEXT:    store i8 [[TMP105]], ptr [[TMP53]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE52]]\n--+; CHECK:       [[PRED_STORE_CONTINUE52]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF53:.*]], label %[[PRED_STORE_CONTINUE54:.*]]\n--+; CHECK:       [[PRED_STORE_IF53]]:\n--+; CHECK-NEXT:    [[TMP106:%.*]] = extractelement <4 x i8> [[TMP101]], i32 0\n--+; CHECK-NEXT:    store i8 [[TMP106]], ptr [[TMP58]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE54]]\n--+; CHECK:       [[PRED_STORE_CONTINUE54]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF55:.*]], label %[[PRED_STORE_CONTINUE56:.*]]\n--+; CHECK:       [[PRED_STORE_IF55]]:\n--+; CHECK-NEXT:    [[TMP107:%.*]] = extractelement <4 x i8> [[TMP101]], i32 1\n--+; CHECK-NEXT:    store i8 [[TMP107]], ptr [[TMP59]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE56]]\n--+; CHECK:       [[PRED_STORE_CONTINUE56]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF57:.*]], label %[[PRED_STORE_CONTINUE58:.*]]\n--+; CHECK:       [[PRED_STORE_IF57]]:\n--+; CHECK-NEXT:    [[TMP108:%.*]] = extractelement <4 x i8> [[TMP101]], i32 2\n--+; CHECK-NEXT:    store i8 [[TMP108]], ptr [[TMP60]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE58]]\n--+; CHECK:       [[PRED_STORE_CONTINUE58]]:\n--+; CHECK-NEXT:    br i1 false, label %[[PRED_STORE_IF59:.*]], label %[[PRED_STORE_CONTINUE60:.*]]\n--+; CHECK:       [[PRED_STORE_IF59]]:\n--+; CHECK-NEXT:    [[TMP109:%.*]] = extractelement <4 x i8> [[TMP101]], i32 3\n--+; CHECK-NEXT:    store i8 [[TMP109]], ptr [[TMP61]], align 1\n--+; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE60]]\n--+; CHECK:       [[PRED_STORE_CONTINUE60]]:\n--+; CHECK-NEXT:    br label %[[MIDDLE_BLOCK:.*]]\n--+; CHECK:       [[MIDDLE_BLOCK]]:\n--+; CHECK-NEXT:    br [[EXIT:label %.*]]\n--+; CHECK:       [[SCALAR_PH:.*:]]\n--+;\n--+entry:\n--+  br label %loop\n--+\n--+loop:\n--+  %iv = phi i64 [ 0, %entry ], [ %iv.next, %loop ]\n--+  %gep.A = getelementptr inbounds i8, ptr %A, i64 %iv\n--+  %l = load i8, ptr %gep.A\n--+  %l.ext = zext i8 %l to i64\n--+  %gep.C = getelementptr inbounds i8, ptr %C, i64 %iv\n--+  store i64 %l.ext, ptr %gep.C\n--+  %gep.B = getelementptr inbounds i8, ptr %B, i64 %iv\n--+  %l.1 = load i8, ptr %gep.B, align 1\n--+  %masked = and i8 %l.1, 1\n--+  %l.1.trunc = trunc i8 %l.1 to i1\n--+  %sel.0 = select i1 %l.1.trunc, float 1.000000e+00, float 0.000000e+00\n--+  %masked.trunc = trunc i8 %masked to i1\n--+  %sel.1 = select i1 %masked.trunc, float 3.000000e+00, float %sel.0\n--+  %bc = bitcast float %sel.1 to i32\n--+  %bc.trunc = trunc i32 %bc to i8\n--+  store i8 %bc.trunc, ptr %gep.B, align 1\n--+  %iv.next = add i64 %iv, 1\n--+  %ec = icmp eq i64 %iv, 1\n--+  br i1 %ec, label %exit, label %loop\n--+\n--+exit:\n--+  ret void\n--+}\n--diff -ruN --strip-trailing-cr a/utils/bazel/llvm-project-overlay/llvm/BUILD.bazel b/utils/bazel/llvm-project-overlay/llvm/BUILD.bazel\n----- a/utils/bazel/llvm-project-overlay/llvm/BUILD.bazel\n--+++ b/utils/bazel/llvm-project-overlay/llvm/BUILD.bazel\n--@@ -4970,6 +4970,22 @@\n-- )\n-- \n-- cc_binary(\n--+    name = \"llvm-remarkutil\",\n--+    srcs = glob([\n--+        \"tools/llvm-remarkutil/**/*.cpp\",\n--+        \"tools/llvm-remarkutil/**/*.h\",\n--+    ]),\n--+    copts = llvm_copts,\n--+    includes = [\"tools/llvm-remarkutil\"],\n--+    stamp = 0,\n--+    deps = [\n--+        \":Demangle\",\n--+        \":Remarks\",\n--+        \":Support\",\n--+    ],\n--+)\n--+\n--+cc_binary(\n--     name = \"llvm-rtdyld\",\n--     srcs = glob([\n--         \"tools/llvm-rtdyld/*.cpp\",\n++diff -ruN --strip-trailing-cr a/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp b/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp\n++--- a/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp\n+++++ b/llvm/unittests/Analysis/FunctionPropertiesAnalysisTest.cpp\n++@@ -46,8 +46,8 @@\n++     MAM.registerPass([VocabVector = std::move(VocabVector)]() mutable {\n++       return IR2VecVocabAnalysis(std::move(VocabVector));\n++     });\n++-    IR2VecVocab =\n++-        new ir2vec::Vocabulary(ir2vec::Vocabulary::createDummyVocabForTest(1));\n+++    IR2VecVocab = std::make_unique<ir2vec::Vocabulary>(\n+++        ir2vec::Vocabulary::createDummyVocabForTest(1));\n++     MAM.registerPass([&] { return PassInstrumentationAnalysis(); });\n++     FAM.registerPass([&] { return ModuleAnalysisManagerFunctionProxy(MAM); });\n++     FAM.registerPass([&] { return DominatorTreeAnalysis(); });\n++@@ -69,7 +69,7 @@\n++   std::unique_ptr<LoopInfo> LI;\n++   FunctionAnalysisManager FAM;\n++   ModuleAnalysisManager MAM;\n++-  ir2vec::Vocabulary *IR2VecVocab;\n+++  std::unique_ptr<ir2vec::Vocabulary> IR2VecVocab;\n++ \n++   void TearDown() override {\n++     // Restore original IR2Vec weights\n++diff -ruN --strip-trailing-cr a/llvm/unittests/Analysis/IR2VecTest.cpp b/llvm/unittests/Analysis/IR2VecTest.cpp\n++--- a/llvm/unittests/Analysis/IR2VecTest.cpp\n+++++ b/llvm/unittests/Analysis/IR2VecTest.cpp\n++@@ -295,7 +295,7 @@\n++ // Fixture for IR2Vec tests requiring IR setup.\n++ class IR2VecTestFixture : public ::testing::Test {\n++ protected:\n++-  Vocabulary *V;\n+++  std::unique_ptr<Vocabulary> V;\n++   LLVMContext Ctx;\n++   std::unique_ptr<Module> M;\n++   Function *F = nullptr;\n++@@ -304,7 +304,7 @@\n++   Instruction *RetInst = nullptr;\n++ \n++   void SetUp() override {\n++-    V = new Vocabulary(Vocabulary::createDummyVocabForTest(2));\n+++    V = std::make_unique<Vocabulary>(Vocabulary::createDummyVocabForTest(2));\n++ \n++     // Setup IR\n++     M = std::make_unique<Module>(\"TestM\", Ctx);\n diff --git a/third_party/llvm/workspace.bzl b/third_party/llvm/workspace.bzl\n-index 1b17fe9..9431f26 100644\n+index 996e2ec..c407321 100644\n --- a/third_party/llvm/workspace.bzl\n +++ b/third_party/llvm/workspace.bzl\n @@ -4,8 +4,8 @@ load(\"//third_party:repo.bzl\", \"tf_http_archive\")\n  \n  def repo(name):\n      \"\"\"Imports LLVM.\"\"\"\n--    LLVM_COMMIT = \"113f01aa82d055410f22a9d03b3468fa68600589\"\n--    LLVM_SHA256 = \"9aee00a35aa76639746589c6d09e8c18249be16b5b6aa6b788a570a4bc6c4543\"\n-+    LLVM_COMMIT = \"d28c07b7550af47ff7adc068d6078388cdeed61d\"\n-+    LLVM_SHA256 = \"627cba3a53a992a67cddebdb2a6e849385444c3fdb5f71ccf230f28f840caf04\"\n+-    LLVM_COMMIT = \"ca84f2aa3be6e46a4dccb1bec56b93f2bb3d8ef0\"\n+-    LLVM_SHA256 = \"5cea44df2e0c3dcb6119c2ca5d7a900001e93ec43369ed1b58eb4ed4d4c9f9f0\"\n++    LLVM_COMMIT = \"fd9a1dcc01766c71932898e9643ce28bf2801bad\"\n++    LLVM_SHA256 = \"85b7a4524078549ef1b3271569241a14deec1b7f4c42048877601166f3d1fee9\"\n  \n      tf_http_archive(\n          name = name,\n-diff --git a/third_party/remote_config/remote_platform_configure.bzl b/third_party/remote_config/remote_platform_configure.bzl\n-index 068e09e..3368a16 100644\n---- a/third_party/remote_config/remote_platform_configure.bzl\n-+++ b/third_party/remote_config/remote_platform_configure.bzl\n-@@ -38,7 +38,7 @@ def _remote_platform_configure_impl(repository_ctx):\n- \n-     repository_ctx.template(\n-         \"BUILD\",\n--        Label(\"//third_party/remote_config:BUILD.tpl\"),\n-+        Label(\"@local_xla//third_party/remote_config:BUILD.tpl\"),\n-         {\n-             \"%{platform}\": platform,\n-             \"%{exec_properties}\": serialized_exec_properties,"
        },
        {
            "sha": "5544b22dce039d0930ce9dd005db24c92d776e05",
            "filename": "third_party/xla/third_party/shardy/workspace.bzl",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5de8085ebfc2d1079397c25ae7433a246c678add/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fshardy%2Fworkspace.bzl?ref=5de8085ebfc2d1079397c25ae7433a246c678add",
            "patch": "@@ -3,8 +3,8 @@\n load(\"//third_party:repo.bzl\", \"tf_http_archive\", \"tf_mirror_urls\")\n \n def repo():\n-    SHARDY_COMMIT = \"d7d2f4fcf0fd9ab07e7c43fccacf72a8a53534d4\"\n-    SHARDY_SHA256 = \"a4b77c59993316bd0cf45fc9b50164741ca0121bdc611404d7dc899a2c19549b\"\n+    SHARDY_COMMIT = \"7870392d914fac01bed1e3bf147249a6358b705c\"\n+    SHARDY_SHA256 = \"6f5f7994377d89a6bd1e546c36da2445869e7f417fb515ff8f7673a067a34827\"\n \n     tf_http_archive(\n         name = \"shardy\","
        }
    ],
    "stats": {
        "total": 1556,
        "additions": 451,
        "deletions": 1105
    }
}