{
    "author": "hhb",
    "message": "Implement PjRtCApiExecutable::GetOutputShapes.\n\nUsing `GetOutputElementTypes`, `GetOutputDimensions`, `GetOutputLayouts`.\n\nPiperOrigin-RevId: 837215957",
    "sha": "c8c54964cdd8153e5ae96a950d798932d2d392dd",
    "files": [
        {
            "sha": "51b25541d12053eb31dae79f2ea4aad0cfb6da5a",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8c54964cdd8153e5ae96a950d798932d2d392dd/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8c54964cdd8153e5ae96a950d798932d2d392dd/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=c8c54964cdd8153e5ae96a950d798932d2d392dd",
            "patch": "@@ -1825,6 +1825,46 @@ PjRtCApiExecutable::GetOutputElementTypes() const {\n   return std::vector<std::vector<PrimitiveType>>{std::move(out)};\n }\n \n+static absl::StatusOr<Shape> GetOutputShapeHelper(\n+    const std::vector<PrimitiveType>& element_types,\n+    const std::vector<DimensionVector>& dimensions,\n+    const std::vector<std::shared_ptr<const PjRtLayout>>& layouts) {\n+  CHECK_EQ(element_types.size(), dimensions.size());\n+  CHECK_EQ(element_types.size(), layouts.size());\n+\n+  std::vector<xla::Shape> shapes;\n+  shapes.reserve(element_types.size());\n+  for (int i = 0; i < element_types.size(); ++i) {\n+    TF_ASSIGN_OR_RETURN(xla::Shape shape, ShapeUtil::MakeValidatedShape(\n+                                              element_types[i], dimensions[i]));\n+    *shape.mutable_layout() = layouts[i]->xla_layout();\n+    shapes.push_back(std::move(shape));\n+  }\n+  if (shapes.size() == 1) {\n+    return shapes[0];\n+  }\n+  return ShapeUtil::MakeTupleShape(shapes);\n+}\n+\n+absl::StatusOr<std::vector<Shape>> PjRtCApiExecutable::GetOutputShapes() const {\n+  TF_ASSIGN_OR_RETURN(std::vector<std::vector<PrimitiveType>> element_types,\n+                      GetOutputElementTypes());\n+  TF_ASSIGN_OR_RETURN(std::vector<std::vector<DimensionVector>> dimensions,\n+                      GetOutputDimensions());\n+  TF_ASSIGN_OR_RETURN(std::vector<std::shared_ptr<const PjRtLayout>> layouts,\n+                      GetOutputLayouts());\n+\n+  // `PjRtExecutable::GetOutputLayouts` doesn't support MPMD executables.\n+  // Only one output is expected.\n+  CHECK_EQ(element_types.size(), 1);\n+  CHECK_EQ(dimensions.size(), 1);\n+\n+  TF_ASSIGN_OR_RETURN(\n+      Shape shape,\n+      GetOutputShapeHelper(element_types[0], dimensions[0], layouts));\n+  return std::vector<Shape>{shape};\n+}\n+\n absl::StatusOr<std::string>\n PjRtCApiExecutable::GetSerializedExecutableMetadata() const {\n   auto executable_metadata_extension ="
        },
        {
            "sha": "ea773cddabf832901bd78a9f3aab67bc1bbe0f02",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8c54964cdd8153e5ae96a950d798932d2d392dd/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8c54964cdd8153e5ae96a950d798932d2d392dd/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h?ref=c8c54964cdd8153e5ae96a950d798932d2d392dd",
            "patch": "@@ -639,11 +639,7 @@ class PjRtCApiExecutable : public PjRtExecutable {\n     return pjrt::GetCompiledMemoryStats(c_api_, executable_.get());\n   }\n \n-  absl::StatusOr<std::vector<Shape>> GetOutputShapes() const override {\n-    LOG(FATAL) << \"PjRtExecutable::GetOutputShapes() not implemented in PJRT C \"\n-                  \"API. Please use PjRtExecutable::GetOutputElementTypes() or \"\n-                  \"PjRtExecutable::GetOutputDimensions().\";\n-  }\n+  absl::StatusOr<std::vector<Shape>> GetOutputShapes() const override;\n \n   absl::StatusOr<std::vector<std::vector<PrimitiveType>>>\n   GetOutputElementTypes() const override;\n@@ -719,10 +715,7 @@ class PjRtCApiLoadedExecutable : public PjRtLoadedExecutable {\n   }\n \n   absl::StatusOr<std::vector<Shape>> GetOutputShapes() const override {\n-    LOG(FATAL)\n-        << \"PjRtLoadedExecutable::GetOutputShapes() not implemented in PJRT C \"\n-           \"API. Please use PjRtLoadedExecutable::GetOutputElementTypes() or \"\n-           \"PjRtLoadedExecutable::GetOutputDimensions().\";\n+    return executable_->GetOutputShapes();\n   }\n \n   absl::StatusOr<std::vector<std::vector<PrimitiveType>>>"
        },
        {
            "sha": "94b266d84876a837c193cfaaae98608e74971959",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c8c54964cdd8153e5ae96a950d798932d2d392dd/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c8c54964cdd8153e5ae96a950d798932d2d392dd/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc?ref=c8c54964cdd8153e5ae96a950d798932d2d392dd",
            "patch": "@@ -571,6 +571,32 @@ TEST(PjRtClientTest, DeserializeExecutableWithDifferentDeviceAssignment) {\n       deserialized_executable->addressable_devices()[0]->global_device_id(), 1);\n }\n \n+TEST(PjRtCApiClientTest, GetOutputShapes) {\n+  static constexpr char const* kProgram = R\"(\n+    HloModule ffi_handler\n+    ENTRY main {\n+      ROOT %custom-call = f32[4] custom-call(),\n+                          custom_call_target=\"MemsetFromValue\",\n+                          api_version=API_VERSION_TYPED_FFI\n+    })\";\n+\n+  const PJRT_Api* c_api = ::pjrt::cpu_plugin::GetCpuPjrtApi();\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                          WrapClientAroundCApi(c_api));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto hlo_module,\n+                          ParseAndReturnUnverifiedModule(kProgram, {}));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto executable,\n+      client->CompileAndLoad(XlaComputation(hlo_module->ToProto()), {}));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::vector<Shape> output_shapes,\n+                          executable->GetOutputShapes());\n+  EXPECT_EQ(output_shapes.size(), 1);\n+  Shape expected_shape = ShapeUtil::MakeShape(F32, {4});\n+  EXPECT_EQ(output_shapes[0], expected_shape);\n+}\n+\n TEST(PjRtClientTest, BufferFromLiteralInt4) {\n   SetUpCpuPjRtApi();\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 68,
        "deletions": 9
    }
}