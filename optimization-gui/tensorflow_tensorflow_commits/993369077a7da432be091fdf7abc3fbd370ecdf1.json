{
    "author": "tensorflower-gardener",
    "message": "Reverts bf23bf1b32c2fd668022159b22fbdfa0c69f18c5\n\nPiperOrigin-RevId: 826380939",
    "sha": "993369077a7da432be091fdf7abc3fbd370ecdf1",
    "files": [
        {
            "sha": "6f103e8060f1f364ba02f0ca80ebb7e3095841fb",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=993369077a7da432be091fdf7abc3fbd370ecdf1",
            "patch": "@@ -1203,7 +1203,6 @@ cc_library(\n         \"//xla/backends/cpu/runtime/xnnpack:xnn_convolution_thunk\",\n         \"//xla/backends/cpu/runtime/xnnpack:xnn_dot_thunk\",\n         \"//xla/backends/cpu/runtime/xnnpack:xnn_fusion_thunk\",\n-        \"//xla/hlo/ir:hlo\",\n         \"//xla/runtime:resource_use\",\n         \"//xla/runtime:work_group\",\n         \"//xla/service:buffer_assignment\","
        },
        {
            "sha": "e60e29f7abfa5d12f9e2ea2ed5cef2bc2172bb6f",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_proto_serdes.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 24,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc?ref=993369077a7da432be091fdf7abc3fbd370ecdf1",
            "patch": "@@ -356,8 +356,8 @@ class ThunkSerDesProtobuf : public SerDesBase<Thunk> {\n       const ThunkProto& proto) const;\n \n  private:\n-  const HloModule* hlo_module_;\n-  const std::vector<BufferAllocation>* buffer_allocations_;\n+  // TODO(basiol) remove NOLINT when this actually gets used\n+  const std::vector<BufferAllocation>* buffer_allocations_;  // NOLINT\n \n   const std::vector<std::shared_ptr<Resource>>* thunk_resources_;\n };\n@@ -1087,10 +1087,9 @@ ReduceScatterThunkFromProto(\n }\n \n static absl::StatusOr<std::unique_ptr<CallThunk>> CallThunkFromProto(\n-    const ThunkProto& proto, const HloModule* hlo_module,\n-    const std::vector<BufferAllocation>* buffer_allocations) {\n-  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(hlo_module,\n-                                                    buffer_allocations);\n+    const ThunkProto& proto,\n+    const std::vector<BufferAllocation>& buffer_allocations) {\n+  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(&buffer_allocations);\n \n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<ThunkSequence> call_sequence,\n@@ -1102,10 +1101,9 @@ static absl::StatusOr<std::unique_ptr<CallThunk>> CallThunkFromProto(\n \n static absl::StatusOr<std::unique_ptr<ConditionalThunk>>\n ConditionalThunkFromProto(\n-    const ThunkProto& proto, const HloModule* hlo_module,\n-    const std::vector<BufferAllocation>* buffer_allocations) {\n-  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(hlo_module,\n-                                                    buffer_allocations);\n+    const ThunkProto& proto,\n+    const std::vector<BufferAllocation>& buffer_allocations) {\n+  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(&buffer_allocations);\n \n   std::vector<ThunkSequence> branch_sequences;\n   for (const ThunkSequenceProto& branch_sequence_proto :\n@@ -1116,10 +1114,10 @@ ConditionalThunkFromProto(\n   }\n   TF_ASSIGN_OR_RETURN(Thunk::Info info, ThunkInfoFromProto(proto.info()));\n \n-  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice branch_index_buffer,\n-                      BufferAllocation::Slice::FromProto(\n-                          proto.conditional_thunk().branch_index_buffer(),\n-                          *buffer_allocations));\n+  TF_ASSIGN_OR_RETURN(\n+      BufferAllocation::Slice branch_index_buffer,\n+      BufferAllocation::Slice::FromProto(\n+          proto.conditional_thunk().branch_index_buffer(), buffer_allocations));\n \n   return ConditionalThunk::Create(std::move(info),\n                                   std::move(branch_index_buffer),\n@@ -1482,10 +1480,9 @@ static absl::StatusOr<std::unique_ptr<TopKThunk>> TopKThunkFromProto(\n }\n \n static absl::StatusOr<std::unique_ptr<WhileThunk>> WhileThunkFromProto(\n-    const ThunkProto& proto, const HloModule* hlo_module,\n-    const std::vector<BufferAllocation>* buffer_allocations) {\n-  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(hlo_module,\n-                                                    buffer_allocations);\n+    const ThunkProto& proto,\n+    const std::vector<BufferAllocation>& buffer_allocations) {\n+  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(&buffer_allocations);\n \n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<ThunkSequence> cond_sequence,\n@@ -1499,7 +1496,7 @@ static absl::StatusOr<std::unique_ptr<WhileThunk>> WhileThunkFromProto(\n   TF_ASSIGN_OR_RETURN(\n       BufferAllocation::Slice cond_buffer,\n       BufferAllocation::Slice::FromProto(proto.while_thunk().cond_buffer(),\n-                                         *buffer_allocations));\n+                                         buffer_allocations));\n \n   std::optional<int64_t> trip_count = std::nullopt;\n   if (proto.while_thunk().trip_count().contains_value()) {\n@@ -1665,9 +1662,9 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n       }\n     }\n     case Thunk::Kind::kCall:\n-      return CallThunkFromProto(proto, hlo_module_, buffer_allocations_);\n+      return CallThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kConditional:\n-      return ConditionalThunkFromProto(proto, hlo_module_, buffer_allocations_);\n+      return ConditionalThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kConvolution:\n       return ConvolutionThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kCopy:\n@@ -1691,7 +1688,7 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n     case Thunk::Kind::kTopK:\n       return TopKThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kWhile:\n-      return WhileThunkFromProto(proto, hlo_module_, buffer_allocations_);\n+      return WhileThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kXnnFusion: {\n       TF_ASSIGN_OR_RETURN(\n           auto xnn_fusion_kind,\n@@ -1718,9 +1715,8 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n }\n \n ThunkSequenceSerDesProtobuf::ThunkSequenceSerDesProtobuf(\n-    const HloModule* hlo_module,\n     const std::vector<BufferAllocation>* buffer_allocations)\n-    : hlo_module_(hlo_module), buffer_allocations_(buffer_allocations) {}\n+    : buffer_allocations_(buffer_allocations) {}\n \n absl::StatusOr<std::string> ThunkSequenceSerDesProtobuf::Serialize(\n     const ThunkSequence& thunk_sequence) {"
        },
        {
            "sha": "b18f727ccea94a3ae2a18ebb33748eb599605325",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_proto_serdes.h",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.h?ref=993369077a7da432be091fdf7abc3fbd370ecdf1",
            "patch": "@@ -25,7 +25,6 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/serdes_base.h\"\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n-#include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/service/buffer_assignment.h\"\n \n namespace xla::cpu {\n@@ -37,13 +36,10 @@ void ForEachThunkProto(const ThunkSequenceProto& proto,\n \n class ThunkSequenceSerDesProtobuf : public SerDesBase<ThunkSequence> {\n  public:\n-  // For serialization, `hlo_module` and `buffer_allocations` are optional. For\n-  // deserialization, both are required as we rely on the HLO module to resolve\n-  // thunks that were generated from `HloComputation`s, and we also need buffer\n-  // allocations to resolve buffer slices.\n   explicit ThunkSequenceSerDesProtobuf(\n-      const HloModule* hlo_module = nullptr,\n-      const std::vector<BufferAllocation>* buffer_allocations = nullptr);\n+      const std::vector<BufferAllocation>* buffer_allocations =\n+          nullptr);  // NOTE buffer allocations aren't\n+                     // needed for serialization.\n \n   absl::StatusOr<std::string> Serialize(\n       const ThunkSequence& thunk_sequence) override;\n@@ -56,7 +52,6 @@ class ThunkSequenceSerDesProtobuf : public SerDesBase<ThunkSequence> {\n       const ThunkSequenceProto& proto) const;\n \n  private:\n-  const HloModule* hlo_module_;\n   const std::vector<BufferAllocation>* buffer_allocations_;\n };\n "
        },
        {
            "sha": "8daa2cb544d363aeb1a9e9d78e7b04596c895738",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_sequence_serdes_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc?ref=993369077a7da432be091fdf7abc3fbd370ecdf1",
            "patch": "@@ -219,8 +219,8 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n \n  public:\n   void SetUp() override {\n-    thunk_sequence_serdes_ = std::make_unique<T>(\n-        nullptr, &buffer_allocations_.GetUnderlyingVector());\n+    thunk_sequence_serdes_ =\n+        std::make_unique<T>(&buffer_allocations_.GetUnderlyingVector());\n   }\n \n  protected:"
        },
        {
            "sha": "3107b59df3ffcc84bddbd1f7b8dcd95d2cc54d98",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compilation_result.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/993369077a7da432be091fdf7abc3fbd370ecdf1/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc?ref=993369077a7da432be091fdf7abc3fbd370ecdf1",
            "patch": "@@ -82,7 +82,7 @@ CpuAotCompilationResult::Create(\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     TargetMachineOptionsProto target_machine_options) {\n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n-      hlo_module, &buffer_assignment->Allocations());\n+      &buffer_assignment->Allocations());\n   TF_ASSIGN_OR_RETURN(ThunkSequenceProto thunk_proto,\n                       thunk_sequence_serdes.ToProto(thunks));\n \n@@ -143,7 +143,7 @@ CpuAotCompilationResult::CpuAotCompilationResult(\n   module_ = hlo_module->Clone();\n \n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n-      hlo_module, &buffer_assignment->Allocations());\n+      &buffer_assignment->Allocations());\n   *proto_.mutable_thunk_sequence() = thunks;\n }\n \n@@ -181,7 +181,7 @@ CpuAotCompilationResult::LoadExecutable(\n   }\n \n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n-      module.get(), &buffer_assignment->Allocations());\n+      &buffer_assignment->Allocations());\n   TF_ASSIGN_OR_RETURN(std::unique_ptr<ThunkSequence> thunks,\n                       thunk_sequence_serdes.FromProto(proto_.thunk_sequence()));\n "
        }
    ],
    "stats": {
        "total": 66,
        "additions": 28,
        "deletions": 38
    }
}