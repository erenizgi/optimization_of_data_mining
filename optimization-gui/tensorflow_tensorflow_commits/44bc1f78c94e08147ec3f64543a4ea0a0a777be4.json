{
    "author": "hyeontaek",
    "message": "[PjRt-IFRT] Tighten `PjRtExecutable::Create()` to take an MLIR module\n\n`xla::ifrt::PjRtExecutable::Create()` was taking already constructed `xla::PjRtExecutable`. This prevents `xla::ifrt::PjRtExecutable` from extracting useful information such as whether a default layout is used for outputs that is not available in the already constructed `xla::PjRtExecutable`. By taking a module and performing compilation inside, the `Create()` has access to the original MLIR module information.\n\nThis is a prerequisite for improving the serialization of `xla::ifrt::PjRtLoadedExecutable` and `xla::ifrt::PjRtExecutable` to use `xla::ifrt::SerializedXlaExecutableMetadata` header.\n\nUltimately, the richer executable metadata information will be used for unifying semantics for default layout handling across IFRT runtimes.\n\nPiperOrigin-RevId: 840491451",
    "sha": "44bc1f78c94e08147ec3f64543a4ea0a0a777be4",
    "files": [
        {
            "sha": "5e9db334fed922ae1fa55f49fbe1010feed252ba",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_compiler.cc?ref=44bc1f78c94e08147ec3f64543a4ea0a0a777be4",
            "patch": "@@ -119,11 +119,9 @@ absl::StatusOr<ExecutableRef> PjRtCompiler::Compile(\n   if (pjrt_topology == nullptr) {\n     return absl::InvalidArgumentError(\"PjRtCompiler requires a PjRtTopology\");\n   }\n-  TF_ASSIGN_OR_RETURN(\n-      auto executable,\n-      PjRtCompile(xla_compile_options->compile_options,\n-                  xla_program->mlir_module(), *pjrt_topology->description()));\n-  return PjRtExecutable::Create(std::move(executable));\n+  return PjRtExecutable::Create(xla_program->mlir_module(),\n+                                std::move(xla_compile_options->compile_options),\n+                                *pjrt_topology->description());\n }\n \n absl::StatusOr<LoadedExecutableRef> PjRtCompiler::DeserializeLoadedExecutable("
        },
        {
            "sha": "772bafc939652b2e69bd7bd4a3d87ba4ea905fde",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.cc?ref=44bc1f78c94e08147ec3f64543a4ea0a0a777be4",
            "patch": "@@ -268,6 +268,15 @@ absl::StatusOr<ExecutableRef> PjRtExecutable::Create(\n   return ExecutableRef(new PjRtExecutable(std::move(pjrt_executable)));\n }\n \n+absl::StatusOr<ExecutableRef> PjRtExecutable::Create(\n+    mlir::ModuleOp module, xla::CompileOptions compile_options,\n+    const xla::PjRtTopologyDescription& topology) {\n+  TF_ASSIGN_OR_RETURN(auto pjrt_executable,\n+                      PjRtCompile(std::move(compile_options), std::move(module),\n+                                  topology, /*client=*/nullptr));\n+  return ExecutableRef(new PjRtExecutable(std::move(pjrt_executable)));\n+}\n+\n absl::StatusOr<std::optional<std::string>> PjRtExecutable::Fingerprint() const {\n   DCHECK(this);\n   return pjrt_executable_->FingerprintExecutable();"
        },
        {
            "sha": "9dd2d445da4504dea9edd833e1ac3db3c9f0283d",
            "filename": "third_party/xla/xla/python/pjrt_ifrt/pjrt_executable.h",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fpjrt_ifrt%2Fpjrt_executable.h?ref=44bc1f78c94e08147ec3f64543a4ea0a0a777be4",
            "patch": "@@ -23,6 +23,7 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"absl/base/attributes.h\"\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n@@ -33,6 +34,7 @@ limitations under the License.\n #include \"mlir/IR/BuiltinOps.h\"\n #include \"xla/hlo/ir/hlo_sharding.h\"\n #include \"xla/pjrt/pjrt_client.h\"\n+#include \"xla/pjrt/pjrt_compiler.h\"\n #include \"xla/pjrt/pjrt_executable.h\"\n #include \"xla/pjrt/pjrt_layout.h\"\n #include \"xla/python/ifrt/array.h\"\n@@ -90,9 +92,18 @@ class PjRtExecutable final\n     : public llvm::RTTIExtends<PjRtExecutable, PjRtCompatibleExecutable> {\n  public:\n   // Creates PjRtExecutable from xla::PjRtExecutable.\n+  ABSL_DEPRECATED(\n+      \"Use the `Create()` that takes an MLIR module and compiles it \"\n+      \"internally.\")\n   static absl::StatusOr<ExecutableRef> Create(\n       std::shared_ptr<xla::PjRtExecutable> pjrt_executable);\n \n+  // Creates PjRtExecutable from an MLIR module. Internally, it compiles the\n+  // provided MLIR module into an `xla::PjRtExecutable`.\n+  static absl::StatusOr<ExecutableRef> Create(\n+      mlir::ModuleOp module, xla::CompileOptions compile_options,\n+      const xla::PjRtTopologyDescription& topology);\n+\n   // PjRtCompatibleExecutable implementation.\n \n   xla::PjRtExecutable* pjrt_executable() override {"
        },
        {
            "sha": "86f9d46b359be0b63e7f369b54015041b6adea18",
            "filename": "third_party/xla/xla/python/version.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/44bc1f78c94e08147ec3f64543a4ea0a0a777be4/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpython%2Fversion.h?ref=44bc1f78c94e08147ec3f64543a4ea0a0a777be4",
            "patch": "@@ -19,6 +19,7 @@ limitations under the License.\n // An increasing version number to protect jax code against breaking changes.\n // In JAX, reference this via jax._src.lib.ifrt_version.\n #define JAX_IFRT_VERSION_NUMBER \\\n-  37  // `LoadedExecutable::devices()` returns nullopt for portable executables.\n+  38  // `xla::ifrt::Executable::Create()` can directly take an MLIR module and\n+      // compile it.\n \n #endif  // XLA_PYTHON_VERSION_H_"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 25,
        "deletions": 6
    }
}