{
    "author": "WillFroom",
    "message": "[XLA:CPU][XTile] Wrap copy operation if tiling enabled.\n\nThis is significantly quicker than the existing implementation when tiled emitter is enabled (due to it being multithreaded)\n\nPiperOrigin-RevId: 841900416",
    "sha": "72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
    "files": [
        {
            "sha": "1ae35c6a56c63def6611193a3b523e9bbc090f1a",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/BUILD",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2FBUILD?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -34,7 +34,10 @@ cc_library(\n         [\"tiled_fusion_emitter_stub.cc\"],\n     ),\n     hdrs = [\"tiled_fusion_emitter.h\"],\n-    visibility = [\"//xla/backends/cpu/codegen:__pkg__\"],\n+    visibility = [\n+        \"//xla/backends/cpu/codegen:__pkg__\",\n+        \"//xla/service/cpu:__pkg__\",\n+    ],\n     deps = [\n         \"//xla:shape_util\",\n         \"//xla:util\","
        },
        {
            "sha": "74f951b2ef9d3b7a372608d51a88f5eafe986f13",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/tiled_fusion_emitter.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter.cc?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -113,7 +113,7 @@ absl::StatusOr<std::vector<FlatTiling>> GetTiling(\n }\n \n // We don't currently support sub-byte types in the tiled CPU emitter.\n-static bool IsSupportedType(PrimitiveType type) {\n+bool IsSupportedTilingType(PrimitiveType type) {\n   if (type == PRED) {\n     return true;\n   }\n@@ -144,7 +144,7 @@ static bool IsSupportedShape(const Shape& shape) {\n   ShapeUtil::ForEachSubshape(\n       shape, [&](const Shape& subshape, const ShapeIndex& index) {\n         if (subshape.IsArray()) {\n-          if (!IsSupportedType(subshape.element_type())) {\n+          if (!IsSupportedTilingType(subshape.element_type())) {\n             is_supported = false;\n           }\n         }"
        },
        {
            "sha": "6a8eaaf96b7ac2d23282df3f5bdb98f19b46f106",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/tiled_fusion_emitter.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter.h?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -32,6 +32,8 @@ limitations under the License.\n \n namespace xla::cpu {\n \n+bool IsSupportedTilingType(PrimitiveType type);\n+\n absl::StatusOr<std::vector<FlatTiling>> GetTilingIfSupported(\n     mlir::MLIRContext& context, const HloFusionInstruction& fusion);\n "
        },
        {
            "sha": "87e14516c1d740adf6671404639cdbe8aa60a6b8",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tiled/tiled_fusion_emitter_stub.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter_stub.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter_stub.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftiled%2Ftiled_fusion_emitter_stub.cc?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -30,6 +30,8 @@ limitations under the License.\n \n namespace xla::cpu {\n \n+bool IsSupportedTilingType(PrimitiveType type) { return false; }\n+\n absl::StatusOr<std::vector<FlatTiling>> GetTilingIfSupported(\n     mlir::MLIRContext& context, const HloFusionInstruction& fusion) {\n   return absl::UnimplementedError(\"not supported for this build configuration\");"
        },
        {
            "sha": "e3646f2fd624b20c0b19475fb1460e6215338b37",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner_extension.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -271,7 +271,8 @@ NB_MODULE(_extension, kernel_runner_module) {\n   kernel_runner_module.def(\n       \"run_fusion_wrapper_pass\",\n       [](std::unique_ptr<HloModule, nb::deleter<HloModule>> hlo_module) {\n-        FusionWrapper fusion_wrapper(true);\n+        FusionWrapper fusion_wrapper(/*using_new_fusion_emitter=*/true,\n+                                     /*use_tiled_emitter=*/true);\n         absl::StatusOr<bool> result = fusion_wrapper.Run(hlo_module.get());\n         if (!result.ok()) {\n           throw std::runtime_error(std::string(result.status().message()));"
        },
        {
            "sha": "7154ec3e7ff9c570347d3049b61dac164e2378f8",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -1097,6 +1097,7 @@ cc_library(\n     srcs = [\"fusion_wrapper.cc\"],\n     hdrs = [\"fusion_wrapper.h\"],\n     deps = [\n+        \"//xla/backends/cpu/codegen/tiled:tiled_fusion_emitter\",\n         \"//xla/codegen/emitters:fusion_wrapper_base\",\n         \"//xla/hlo/ir:hlo\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "12b1e38459b79e17adc42be3482bcf53f192ffec",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -1017,7 +1017,9 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n   if (is_fusion_emitters) {\n     bool use_experimental_loop_fusion =\n         options::UseExperimentalLoopFusion(module->config());\n-    pipeline.AddPass<FusionWrapper>(use_experimental_loop_fusion);\n+    bool use_tiled_emitter = options::EnableTiledEmitter(module->config());\n+    pipeline.AddPass<FusionWrapper>(use_experimental_loop_fusion,\n+                                    use_tiled_emitter);\n   }\n \n   AliasInfo alias_info;"
        },
        {
            "sha": "1bef382eff71fe2374b77cf27070cc27ec1a6862",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -15,6 +15,7 @@ limitations under the License.\n \n #include \"xla/service/cpu/fusion_wrapper.h\"\n \n+#include \"xla/backends/cpu/codegen/tiled/tiled_fusion_emitter.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n \n@@ -85,6 +86,12 @@ bool FusionWrapper::MustWrapInstruction(const HloInstruction& instruction) {\n     case HloOpcode::kTanh:\n     case HloOpcode::kXor:\n       return using_new_fusion_emitter_;\n+    case HloOpcode::kCopy:\n+      if (use_tiled_emitter_) {\n+        PrimitiveType type = instruction.shape().element_type();\n+        return IsSupportedTilingType(type);\n+      }\n+      return false;\n     // The following ops are supported but the performance is not as good as the\n     // non-fusion path.\n     // TODO(willfroom): Remove this once the performance is improved."
        },
        {
            "sha": "5da07c2f3efc3f047606d817c160e8909d8fd63a",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -28,8 +28,9 @@ namespace cpu {\n // kick in.\n class FusionWrapper : public emitters::FusionWrapperBase {\n  public:\n-  explicit FusionWrapper(bool using_new_fusion_emitter)\n-      : using_new_fusion_emitter_(using_new_fusion_emitter) {}\n+  explicit FusionWrapper(bool using_new_fusion_emitter, bool use_tiled_emitter)\n+      : using_new_fusion_emitter_(using_new_fusion_emitter),\n+        use_tiled_emitter_(use_tiled_emitter) {}\n   ~FusionWrapper() override = default;\n \n   absl::string_view name() const override { return \"fusion-wrapper\"; }\n@@ -38,6 +39,7 @@ class FusionWrapper : public emitters::FusionWrapperBase {\n \n  private:\n   bool using_new_fusion_emitter_;\n+  bool use_tiled_emitter_;\n };\n \n }  // namespace cpu"
        },
        {
            "sha": "c81369604eb75684a60da9694d154d23073f3605",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/72b1ad96d11b5cb8278667a57d5e8255ff82cfe5/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper_test.cc?ref=72b1ad96d11b5cb8278667a57d5e8255ff82cfe5",
            "patch": "@@ -56,7 +56,7 @@ TEST_F(FusionWrapperTest, Scatter) {\n   )\";\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> m,\n                           ParseAndReturnVerifiedModule(hlo_string));\n-  FusionWrapper wrapper(false);\n+  FusionWrapper wrapper(false, false);\n   TF_ASSERT_OK_AND_ASSIGN(bool changed, wrapper.Run(m.get()));\n   EXPECT_TRUE(changed);\n "
        }
    ],
    "stats": {
        "total": 36,
        "additions": 28,
        "deletions": 8
    }
}