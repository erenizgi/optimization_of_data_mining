{
    "author": "protobird-git",
    "message": "Test thread parallelism with timeout in code, not in BUILD flag.\n\nPiperOrigin-RevId: 829129336",
    "sha": "7ea57e1e64e7e4e376a5ff4548675b22f7927235",
    "files": [
        {
            "sha": "14f99e9ee9bb71f41e22b26376f2ed078ebdceb0",
            "filename": "tensorflow/core/lib/core/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7ea57e1e64e7e4e376a5ff4548675b22f7927235/tensorflow%2Fcore%2Flib%2Fcore%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7ea57e1e64e7e4e376a5ff4548675b22f7927235/tensorflow%2Fcore%2Flib%2Fcore%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Flib%2Fcore%2FBUILD?ref=7ea57e1e64e7e4e376a5ff4548675b22f7927235",
            "patch": "@@ -143,14 +143,14 @@ cc_library(\n \n tf_cc_test(\n     name = \"threadpool_test\",\n-    timeout = \"short\",\n     srcs = [\"threadpool_test.cc\"],\n     deps = [\n         \":threadpool\",\n         \"//tensorflow/core:framework_lite\",\n         \"//tensorflow/core:lib\",\n         \"//tensorflow/core:test\",\n         \"@com_google_absl//absl/synchronization\",\n+        \"@com_google_absl//absl/time\",\n         \"@local_xla//xla/tsl/platform:test_main\",\n     ],\n )"
        },
        {
            "sha": "5507dd0644e164a1f582d5ec8c33cf3bc1a8ef37",
            "filename": "tensorflow/core/lib/core/threadpool_test.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7ea57e1e64e7e4e376a5ff4548675b22f7927235/tensorflow%2Fcore%2Flib%2Fcore%2Fthreadpool_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7ea57e1e64e7e4e376a5ff4548675b22f7927235/tensorflow%2Fcore%2Flib%2Fcore%2Fthreadpool_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Flib%2Fcore%2Fthreadpool_test.cc?ref=7ea57e1e64e7e4e376a5ff4548675b22f7927235",
            "patch": "@@ -21,7 +21,8 @@ limitations under the License.\n #include <optional>\n \n #include \"absl/synchronization/barrier.h\"\n-#include \"absl/synchronization/blocking_counter.h\"\n+#include \"absl/synchronization/mutex.h\"\n+#include \"absl/time/time.h\"\n #include \"tensorflow/core/platform/context.h\"\n #include \"tensorflow/core/platform/env.h\"\n #include \"tensorflow/core/platform/mutex.h\"\n@@ -353,24 +354,30 @@ TEST(ThreadPool, ParallelForWithWorkerId) {\n }\n \n TEST(ThreadPool, Parallelism) {\n-  // TODO: b/433244133 - Re-enable this test once the flakiness is fixed.\n-#if defined(PLATFORM_WINDOWS)\n-  GTEST_SKIP() << \"Skipping test on Windows due to flakiness.\";\n-#endif\n   // Test that if we have N threads and schedule N tasks,\n   // all tasks will be scheduled at the same time.\n-  // Failure mode for this test will be episodic timeouts (does not terminate).\n+  // Failure mode for this test will be timeouts.\n   ThreadPool pool(Env::Default(), \"test\", kNumThreads);\n   for (int iter = 0; iter < 2000; iter++) {\n     absl::Barrier barrier(kNumThreads);\n-    absl::BlockingCounter counter(kNumThreads);\n+    // Expect each loop finishes less than 1s or much less. The semantic of\n+    // counter, mutex and done here is the same as absl::BlockingCounter except\n+    // that it waits for the condition with timeout.\n+    std::atomic<int> counter(kNumThreads);\n+    absl::Mutex mutex;\n+    bool done = false;\n     for (int t = 0; t < kNumThreads; ++t) {\n       pool.Schedule([&]() {\n         barrier.Block();\n-        counter.DecrementCount();\n+        if (--counter <= 0) {\n+          absl::MutexLock lock(mutex);\n+          done = true;\n+        }\n       });\n     }\n-    counter.Wait();\n+    absl::MutexLock lock(mutex);\n+    absl::Condition cond(+[](bool* done) { return *done; }, &done);\n+    EXPECT_TRUE(mutex.AwaitWithTimeout(cond, absl::Seconds(1)));\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 17,
        "deletions": 10
    }
}