{
    "author": "WillFroom",
    "message": "[XLA:CPU] Wrap elemental ops in fusions so that they use the new emitter.\n\nPiperOrigin-RevId: 808921801",
    "sha": "6534e9e7efdc478dba27766e36184933c6463d36",
    "files": [
        {
            "sha": "0f22197433d6e9b3fbd68433d117d911018f4d58",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner_extension.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -273,7 +273,7 @@ NB_MODULE(_extension, kernel_runner_module) {\n   kernel_runner_module.def(\n       \"run_fusion_wrapper_pass\",\n       [](std::unique_ptr<HloModule, nb::deleter<HloModule>> hlo_module) {\n-        FusionWrapper fusion_wrapper;\n+        FusionWrapper fusion_wrapper(true);\n         absl::StatusOr<bool> result = fusion_wrapper.Run(hlo_module.get());\n         if (!result.ok()) {\n           throw std::runtime_error(std::string(result.status().message()));"
        },
        {
            "sha": "06fdb581d2c965eb528ddf4cba37d7978489427d",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -955,15 +955,18 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n       options::UseMultiOutputFusion(module->config());\n   pipeline.AddPass<CpuInstructionFusion>(\n       /*may_duplicate=*/!use_multi_output_fusion);\n+\n+  if (is_fusion_emitters) {\n+    bool use_experimental_loop_fusion =\n+        options::UseExperimentalLoopFusion(module->config());\n+    pipeline.AddPass<FusionWrapper>(use_experimental_loop_fusion);\n+  }\n+\n   if (use_multi_output_fusion) {\n     pipeline.AddPass<CpuMultiOutputFusion>();\n     pipeline.AddPass<TupleSimplifier>();\n   }\n \n-  if (is_fusion_emitters) {\n-    pipeline.AddPass<FusionWrapper>();\n-  }\n-\n   if (flatten_after_fusion) {\n     pipeline.AddPass<FlattenCallGraph>();\n     pipeline.AddPass<CallInliner>(/*single_call_site=*/true);"
        },
        {
            "sha": "739f3701225052ef5852cb385de22f2a445c37c2",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper.cc",
            "status": "modified",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -25,6 +25,73 @@ bool FusionWrapper::MustWrapInstruction(HloOpcode opcode) {\n   switch (opcode) {\n     case HloOpcode::kScatter:\n       return true;\n+    case HloOpcode::kAbs:\n+    case HloOpcode::kAdd:\n+    case HloOpcode::kAnd:\n+    case HloOpcode::kAtan2:\n+    case HloOpcode::kBitcastConvert:\n+    case HloOpcode::kBroadcast:\n+    case HloOpcode::kCbrt:\n+    case HloOpcode::kCeil:\n+    case HloOpcode::kClamp:\n+    case HloOpcode::kClz:\n+    case HloOpcode::kCompare:\n+    case HloOpcode::kComplex:\n+    case HloOpcode::kConcatenate:\n+    case HloOpcode::kConvert:\n+    case HloOpcode::kCos:\n+    case HloOpcode::kDivide:\n+    case HloOpcode::kDynamicSlice:\n+    case HloOpcode::kErf:\n+    case HloOpcode::kExp:\n+    case HloOpcode::kExpm1:\n+    case HloOpcode::kFloor:\n+    case HloOpcode::kGather:\n+    case HloOpcode::kImag:\n+    case HloOpcode::kIota:\n+    case HloOpcode::kIsFinite:\n+    case HloOpcode::kLog:\n+    case HloOpcode::kLog1p:\n+    case HloOpcode::kMap:\n+    case HloOpcode::kMaximum:\n+    case HloOpcode::kMinimum:\n+    case HloOpcode::kMultiply:\n+    case HloOpcode::kNegate:\n+    case HloOpcode::kNot:\n+    case HloOpcode::kOr:\n+    case HloOpcode::kPad:\n+    case HloOpcode::kPopulationCount:\n+    case HloOpcode::kPower:\n+    case HloOpcode::kReal:\n+    case HloOpcode::kReduce:\n+    case HloOpcode::kReducePrecision:\n+    case HloOpcode::kReduceWindow:\n+    case HloOpcode::kRemainder:\n+    case HloOpcode::kReshape:\n+    case HloOpcode::kReverse:\n+    case HloOpcode::kRoundNearestAfz:\n+    case HloOpcode::kRoundNearestEven:\n+    case HloOpcode::kRsqrt:\n+    case HloOpcode::kSelect:\n+    case HloOpcode::kShiftLeft:\n+    case HloOpcode::kShiftRightArithmetic:\n+    case HloOpcode::kShiftRightLogical:\n+    case HloOpcode::kSign:\n+    case HloOpcode::kSin:\n+    case HloOpcode::kSlice:\n+    case HloOpcode::kSqrt:\n+    case HloOpcode::kSubtract:\n+    case HloOpcode::kTan:\n+    case HloOpcode::kTanh:\n+    case HloOpcode::kXor:\n+      return using_new_fusion_emitter_;\n+    // The following ops are supported but the performance is not as good as the\n+    // non-fusion path.\n+    // TODO(willfroom): Remove this once the performance is improved.\n+    case HloOpcode::kDynamicUpdateSlice:\n+    case HloOpcode::kTranspose:\n+    case HloOpcode::kDot:\n+      return false;\n     default:\n       return false;\n   }"
        },
        {
            "sha": "8b777bc250c389ffb1f0f964125469897431c01a",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -28,12 +28,16 @@ namespace cpu {\n // kick in.\n class FusionWrapper : public emitters::FusionWrapperBase {\n  public:\n-  explicit FusionWrapper() = default;\n+  explicit FusionWrapper(bool using_new_fusion_emitter)\n+      : using_new_fusion_emitter_(using_new_fusion_emitter) {}\n   ~FusionWrapper() override = default;\n \n   absl::string_view name() const override { return \"fusion-wrapper\"; }\n \n   bool MustWrapInstruction(HloOpcode opcode) override;\n+\n+ private:\n+  bool using_new_fusion_emitter_;\n };\n \n }  // namespace cpu"
        },
        {
            "sha": "b8e1438ef1dc34334d9706da8cf7656cfc2b1bd9",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper_test.cc?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -56,7 +56,7 @@ TEST_F(FusionWrapperTest, Scatter) {\n   )\";\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> m,\n                           ParseAndReturnVerifiedModule(hlo_string));\n-  FusionWrapper wrapper;\n+  FusionWrapper wrapper(false);\n   TF_ASSERT_OK_AND_ASSIGN(bool changed, wrapper.Run(m.get()));\n   EXPECT_TRUE(changed);\n "
        },
        {
            "sha": "7f9252f1f6a79b769ceebcbe722698fa78f140a9",
            "filename": "third_party/xla/xla/service/cpu/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -110,6 +110,7 @@ xla_cc_test(\n         \"//xla:shape_util\",\n         \"//xla:xla_data_proto_cc\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/service/cpu:cpu_options\",\n         \"//xla/tsl/platform:test\",\n     ],\n )"
        },
        {
            "sha": "4ffabe66cfa6cd4ea446e0c5ecdd6de1c7d91980",
            "filename": "third_party/xla/xla/service/cpu/tests/cpu_external_constants_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_external_constants_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_external_constants_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_external_constants_test.cc?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -23,6 +23,7 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/literal_util.h\"\n+#include \"xla/service/cpu/cpu_options.h\"\n #include \"xla/service/cpu/tests/cpu_codegen_test.h\"\n #include \"xla/shape_util.h\"\n #include \"xla/tsl/platform/test.h\"\n@@ -51,6 +52,10 @@ class CpuExternalConstantsTest : public CpuCodegenTest {\n         HloInstruction::CreateBinary(shape, HloOpcode::kAdd, param, constant));\n \n     std::unique_ptr<HloModule> module = CreateNewVerifiedModule();\n+    if (options::UseExperimentalLoopFusion(module->config())) {\n+      return;\n+    }\n+\n     module->AddEntryComputation(builder.Build());\n \n     CompileAndVerifyIr(std::move(module), filecheck_pattern,"
        },
        {
            "sha": "ae26a37a35a9e0e1ff1732608278e58db54f8fb0",
            "filename": "third_party/xla/xla/service/cpu/tests/cpu_intrinsic_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_intrinsic_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6534e9e7efdc478dba27766e36184933c6463d36/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_intrinsic_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fcpu_intrinsic_test.cc?ref=6534e9e7efdc478dba27766e36184933c6463d36",
            "patch": "@@ -168,7 +168,7 @@ IntrinsicTestSpec CpuUnaryIntrinsicTestCases[] = {\n     )\"},\n \n     IntrinsicTestSpec{HloOpcode::kExp, F64, false, kTriple_x86_64, \"\",\n-                      R\"(CHECK: call fast double @local_xla.exp.f64(double %4)\"},\n+                      R\"(CHECK: call fast double @local_xla.exp.f64(double)\"},\n \n     IntrinsicTestSpec{\n         HloOpcode::kExp, F32, true, kTriple_x86_64, \"+avx\","
        }
    ],
    "stats": {
        "total": 96,
        "additions": 88,
        "deletions": 8
    }
}