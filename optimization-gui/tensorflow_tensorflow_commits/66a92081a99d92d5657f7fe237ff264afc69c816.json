{
    "author": "tensorflower-gardener",
    "message": "Relax the check on situations where we cannot schedule all annotated nodes in the same group as a whole.\n\nPiperOrigin-RevId: 830616458",
    "sha": "66a92081a99d92d5657f7fe237ff264afc69c816",
    "files": [
        {
            "sha": "46ce63ae32296db10709c1e6f88c70606db9cf40",
            "filename": "third_party/xla/xla/service/latency_hiding_scheduler.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/66a92081a99d92d5657f7fe237ff264afc69c816/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/66a92081a99d92d5657f7fe237ff264afc69c816/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flatency_hiding_scheduler.cc?ref=66a92081a99d92d5657f7fe237ff264afc69c816",
            "patch": "@@ -2183,9 +2183,26 @@ absl::Status DefaultSchedulerCore::ScheduleAnnotation(\n     VLOG(2) << \"Scheduled annotated node (\" << num_scheduled << \"/\"\n             << annotation_size << \"): \" << node->GetInstr().name();\n   }\n-  // Check that we scheduled all the nodes in the annotation.\n-  TF_RET_CHECK(num_scheduled == annotation_size - non_ready_instr)\n-      << \"Couldn't schedule all annotated nodes in one go.\";\n+  // If for some reason we could not schedule all the instructions in the\n+  // annotation in one go, we clear the annotation for the remaining\n+  // instruction. Currently this should only happen for async-start\n+  // instructions.\n+  if (num_scheduled < annotation_size - non_ready_instr) {\n+    for (auto* inst :\n+         annotation_tracker_->GetInstructions(computation, annotation)) {\n+      HloGraphNode& node = sched_state->sched_graph.GetNode(inst);\n+      if (!node.IsScheduled()) {\n+        TF_RET_CHECK(\n+            scheduling_context_->GetAsyncTracker()->IsSupportedAsyncStart(\n+                node.GetInstr()));\n+        VLOG(2) << \"Could not schedule all annotated nodes with annotation ID \"\n+                << annotation << \" in one go; clearing annotation for \"\n+                << node.GetInstr().name();\n+        node.ClearAnnotation();\n+        sched_state->nodes_holding_annotations.insert(&node);\n+      }\n+    }\n+  }\n   return absl::OkStatus();\n }\n "
        }
    ],
    "stats": {
        "total": 23,
        "additions": 20,
        "deletions": 3
    }
}