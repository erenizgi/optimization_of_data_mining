{
    "author": "tensorflower-gardener",
    "message": "[SymbolicExpr] Add `Replace` method for single and multiple expressions\n\nPiperOrigin-RevId: 800065994",
    "sha": "17fdb5b615b537e358fc9a72d36e0dba38a9055b",
    "files": [
        {
            "sha": "3c9a4802b3a7375095004fb942c620b4b0dfc466",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2FBUILD?ref=17fdb5b615b537e358fc9a72d36e0dba38a9055b",
            "patch": "@@ -256,7 +256,7 @@ xla_cc_test(\n     deps = [\n         \":symbolic_expr\",\n         \"//xla/hlo/analysis:indexing_test_utils\",\n-        \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@llvm-project//llvm:Support\",\n     ],\n )"
        },
        {
            "sha": "7ea5d3ceeaa9389645de6919b11ce77bdfc749dc",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.cc?ref=17fdb5b615b537e358fc9a72d36e0dba38a9055b",
            "patch": "@@ -36,6 +36,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/strings/strip.h\"\n #include \"absl/types/span.h\"\n+#include \"llvm/ADT/DenseMap.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"llvm/Support/MathExtras.h\"\n #include \"mlir/Support/StorageUniquer.h\"\n@@ -683,6 +684,37 @@ SymbolicExpr SymbolicExpr::ReplaceVariables(\n   }\n }\n \n+SymbolicExpr SymbolicExpr::Replace(SymbolicExpr expr,\n+                                   SymbolicExpr replacement) const {\n+  llvm::DenseMap<SymbolicExpr, SymbolicExpr> replacements;\n+  replacements[expr] = replacement;\n+  return Replace(replacements);\n+}\n+\n+SymbolicExpr SymbolicExpr::Replace(\n+    const llvm::DenseMap<SymbolicExpr, SymbolicExpr>& replacements) const {\n+  auto it = replacements.find(*this);\n+  if (it != replacements.end()) {\n+    return it->second;\n+  }\n+\n+  SymbolicExprType type = GetType();\n+  if (type == SymbolicExprType::kConstant ||\n+      type == SymbolicExprType::kVariable) {\n+    return *this;\n+  }\n+\n+  SymbolicExpr lhs = GetLHS();\n+  SymbolicExpr rhs = GetRHS();\n+  SymbolicExpr new_lhs = lhs.Replace(replacements);\n+  SymbolicExpr new_rhs = rhs.Replace(replacements);\n+\n+  if (new_lhs == lhs && new_rhs == rhs) {\n+    return *this;\n+  }\n+  return GetContext()->CreateBinaryOp(type, new_lhs, new_rhs);\n+}\n+\n SymbolicExpr SymbolicExpr::Canonicalize() const {\n   if (!*this) {\n     return *this;"
        },
        {
            "sha": "fc05e9eb57bbb06e16e8145b3477a97cb9b56b5b",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr.h",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr.h?ref=17fdb5b615b537e358fc9a72d36e0dba38a9055b",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n \n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n+#include \"llvm/ADT/DenseMap.h\"\n #include \"llvm/ADT/DenseMapInfo.h\"\n #include \"llvm/ADT/Hashing.h\"\n #include \"mlir/Support/LLVM.h\"\n@@ -71,6 +72,16 @@ class SymbolicExpr {\n       absl::Span<const SymbolicExpr> substitutions) const;\n   SymbolicExpr Canonicalize() const;\n \n+  /// Sparse replace method. Replace `expr` by `replacement` and return the\n+  /// modified expression tree.\n+  SymbolicExpr Replace(SymbolicExpr expr, SymbolicExpr replacement) const;\n+\n+  /// Sparse replace method. If `*this` appears in `map` replaces it by\n+  /// `map[*this]` and return the modified expression tree. Otherwise traverse\n+  /// `*this` and apply replace with `map` on its subexpressions.\n+  SymbolicExpr Replace(\n+      const llvm::DenseMap<SymbolicExpr, SymbolicExpr>& replacements) const;\n+\n   SymbolicExpr operator+(int64_t v) const;\n   SymbolicExpr operator+(SymbolicExpr other) const;\n   SymbolicExpr operator-() const;"
        },
        {
            "sha": "9ec51aba490dd133ba68ac6559263adb0695283d",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_expr_test.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/17fdb5b615b537e358fc9a72d36e0dba38a9055b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_expr_test.cc?ref=17fdb5b615b537e358fc9a72d36e0dba38a9055b",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n \n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n+#include \"llvm/ADT/DenseMap.h\"\n #include \"xla/hlo/analysis/indexing_test_utils.h\"\n \n namespace xla {\n@@ -124,6 +125,49 @@ TEST_F(SymbolicExprTest, UniquingWorks) {\n   EXPECT_NE(add1, add3);\n }\n \n+TEST_F(SymbolicExprTest, Replace) {\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+  SymbolicExpr c2 = ctx.CreateConstant(2);\n+  SymbolicExpr c5 = ctx.CreateConstant(5);\n+\n+  SymbolicExpr expr = (d0 + c2) * (d1 + c2);\n+  EXPECT_EQ(expr.Replace(d0 + c2, c5), (c5 * (d1 + c2)));\n+  EXPECT_EQ(expr.Replace(d1, d0), (d0 + c2) * (d0 + c2));\n+  EXPECT_EQ(expr.Replace(c2, c5), (d0 + c5) * (d1 + c5));\n+  EXPECT_EQ(expr.Replace(expr, c2), c2);\n+  EXPECT_EQ(expr.Replace(d1, d1), expr);\n+  EXPECT_EQ(expr.Replace(ctx.CreateConstant(42), d1), expr);\n+}\n+\n+TEST_F(SymbolicExprTest, ReplaceWithMap) {\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+  SymbolicExpr c2 = ctx.CreateConstant(2);\n+  SymbolicExpr c5 = ctx.CreateConstant(5);\n+  SymbolicExpr c10 = ctx.CreateConstant(10);\n+\n+  SymbolicExpr expr = (d0 + c2) * (d1 + c2);\n+\n+  llvm::DenseMap<SymbolicExpr, SymbolicExpr> replace_expression;\n+  replace_expression[d0 + c2] = c5;\n+  replace_expression[d1] = c10;\n+  EXPECT_EQ(expr.Replace(replace_expression), c5 * (c10 + c2));\n+\n+  llvm::DenseMap<SymbolicExpr, SymbolicExpr> replace_constant;\n+  replace_constant[c2] = d0;\n+  EXPECT_EQ(expr.Replace(replace_constant), (d0 + d0) * (d1 + d0));\n+\n+  llvm::DenseMap<SymbolicExpr, SymbolicExpr> swap_variables;\n+  swap_variables[d0] = d1;\n+  swap_variables[d1] = d0;\n+  EXPECT_EQ(expr.Replace(swap_variables), (d1 + c2) * (d0 + c2));\n+\n+  llvm::DenseMap<SymbolicExpr, SymbolicExpr> no_change;\n+  no_change[ctx.CreateVariable(99)] = c5;\n+  EXPECT_EQ(expr.Replace(no_change), expr);\n+}\n+\n TEST_F(SymbolicExprTest, Canonicalization_Basic) {\n   SymbolicExpr constants = (c2 * 3) + 5;\n   EXPECT_EQ(constants.Canonicalize().ToString(), \"11\");"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 88,
        "deletions": 1
    }
}