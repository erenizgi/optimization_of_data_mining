{
    "author": "cota",
    "message": "[xla:codegen] deduplicate LowerToLLVM passes\n\nFollow-up work to \"349a1d4e00c: [xla:codegen] split LowerToLLVMPass\ninto CPU and GPU versions\".\n\nPiperOrigin-RevId: 845636364",
    "sha": "79e54e1d40fd40cd174b21b7307cd14a82706239",
    "files": [
        {
            "sha": "e39d3565a5edbf8b75a7ae72f759755fc2fa2756",
            "filename": "third_party/xla/xla/codegen/emitters/transforms/BUILD",
            "status": "modified",
            "additions": 21,
            "deletions": 9,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2FBUILD?ref=79e54e1d40fd40cd174b21b7307cd14a82706239",
            "patch": "@@ -43,31 +43,46 @@ gentbl_cc_library(\n )\n \n cc_library(\n-    name = \"lower_to_llvm_cpu_pass\",\n-    srcs = [\"lower_to_llvm_cpu.cc\"],\n-    hdrs = [\"lower_to_llvm_cpu.h\"],\n+    name = \"lower_to_llvm_common\",\n+    srcs = [\"lower_to_llvm_common.cc\"],\n+    hdrs = [\"lower_to_llvm_common.h\"],\n     deps = [\n-        \":lower_to_llvm_cpu_inc_gen\",\n+        \"@com_google_absl//absl/functional:function_ref\",\n         \"@llvm-project//mlir:ArithDialect\",\n         \"@llvm-project//mlir:ArithToLLVM\",\n         \"@llvm-project//mlir:ArithTransforms\",\n         \"@llvm-project//mlir:ComplexDialect\",\n         \"@llvm-project//mlir:ComplexToLLVM\",\n         \"@llvm-project//mlir:ControlFlowToLLVM\",\n+        \"@llvm-project//mlir:DataLayoutInterfaces\",\n         \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:FuncToLLVM\",\n+        \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:LLVMCommonConversion\",\n         \"@llvm-project//mlir:MathDialect\",\n         \"@llvm-project//mlir:MathToLLVM\",\n         \"@llvm-project//mlir:MemRefToLLVM\",\n-        \"@llvm-project//mlir:Pass\",\n         \"@llvm-project//mlir:SCFToControlFlow\",\n+        \"@llvm-project//mlir:Support\",\n         \"@llvm-project//mlir:TransformUtils\",\n         \"@llvm-project//mlir:UBToLLVM\",\n         \"@llvm-project//mlir:VectorToLLVM\",\n     ],\n )\n \n+cc_library(\n+    name = \"lower_to_llvm_cpu_pass\",\n+    srcs = [\"lower_to_llvm_cpu.cc\"],\n+    hdrs = [\"lower_to_llvm_cpu.h\"],\n+    deps = [\n+        \":lower_to_llvm_common\",\n+        \":lower_to_llvm_cpu_inc_gen\",\n+        \"@llvm-project//mlir:FuncDialect\",\n+        \"@llvm-project//mlir:Pass\",\n+        \"@llvm-project//mlir:Support\",\n+    ],\n+)\n+\n gentbl_cc_library(\n     name = \"lower_to_llvm_gpu_inc_gen\",\n     compatible_with = get_compatible_with_portable(),\n@@ -86,6 +101,7 @@ cc_library(\n     srcs = [\"lower_to_llvm_gpu.cc\"],\n     hdrs = [\"lower_to_llvm_gpu.h\"],\n     deps = [\n+        \":lower_to_llvm_common\",\n         \":lower_to_llvm_gpu_inc_gen\",\n         \"//xla/codegen:device_spec\",\n         \"//xla/stream_executor:device_description\",\n@@ -95,13 +111,10 @@ cc_library(\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:AMDGPUUtils\",\n         \"@llvm-project//mlir:AffineToStandard\",\n-        \"@llvm-project//mlir:ArithDialect\",\n         \"@llvm-project//mlir:ArithToLLVM\",\n         \"@llvm-project//mlir:ArithTransforms\",\n-        \"@llvm-project//mlir:ComplexDialect\",\n         \"@llvm-project//mlir:ComplexToLLVM\",\n         \"@llvm-project//mlir:ControlFlowToLLVM\",\n-        \"@llvm-project//mlir:DataLayoutInterfaces\",\n         \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:FuncToLLVM\",\n         \"@llvm-project//mlir:GPUToLLVMSPVTransforms\",\n@@ -110,7 +123,6 @@ cc_library(\n         \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:LLVMCommonConversion\",\n         \"@llvm-project//mlir:LLVMDialect\",\n-        \"@llvm-project//mlir:MathDialect\",\n         \"@llvm-project//mlir:MathToLLVM\",\n         \"@llvm-project//mlir:MemRefToLLVM\",\n         \"@llvm-project//mlir:NVVMDialect\","
        },
        {
            "sha": "bf1174b2eb930a15cbb296895cbdc956f3378b61",
            "filename": "third_party/xla/xla/codegen/emitters/transforms/lower_to_llvm_common.cc",
            "status": "added",
            "additions": 95,
            "deletions": 0,
            "changes": 95,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_common.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_common.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_common.cc?ref=79e54e1d40fd40cd174b21b7307cd14a82706239",
            "patch": "@@ -0,0 +1,95 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+#include \"xla/codegen/emitters/transforms/lower_to_llvm_common.h\"\n+\n+#include <utility>\n+\n+#include \"absl/functional/function_ref.h\"\n+#include \"mlir/Conversion/ArithToLLVM/ArithToLLVM.h\"\n+#include \"mlir/Conversion/ComplexToLLVM/ComplexToLLVM.h\"\n+#include \"mlir/Conversion/ControlFlowToLLVM/ControlFlowToLLVM.h\"\n+#include \"mlir/Conversion/FuncToLLVM/ConvertFuncToLLVM.h\"\n+#include \"mlir/Conversion/LLVMCommon/ConversionTarget.h\"\n+#include \"mlir/Conversion/LLVMCommon/TypeConverter.h\"\n+#include \"mlir/Conversion/MathToLLVM/MathToLLVM.h\"\n+#include \"mlir/Conversion/MemRefToLLVM/MemRefToLLVM.h\"\n+#include \"mlir/Conversion/SCFToControlFlow/SCFToControlFlow.h\"\n+#include \"mlir/Conversion/UBToLLVM/UBToLLVM.h\"\n+#include \"mlir/Conversion/VectorToLLVM/ConvertVectorToLLVM.h\"\n+#include \"mlir/Dialect/Arith/IR/Arith.h\"\n+#include \"mlir/Dialect/Arith/Transforms/Passes.h\"\n+#include \"mlir/Dialect/Complex/IR/Complex.h\"\n+#include \"mlir/Dialect/Func/IR/FuncOps.h\"\n+#include \"mlir/Dialect/Math/IR/Math.h\"\n+#include \"mlir/IR/BuiltinOps.h\"\n+#include \"mlir/IR/PatternMatch.h\"\n+#include \"mlir/Interfaces/DataLayoutInterfaces.h\"\n+#include \"mlir/Support/LLVM.h\"\n+#include \"mlir/Transforms/DialectConversion.h\"\n+\n+namespace xla {\n+namespace emitters {\n+\n+mlir::LogicalResult LowerToLLVM(\n+    mlir::ModuleOp op,\n+    absl::FunctionRef<mlir::LogicalResult(mlir::LLVMTypeConverter&,\n+                                          mlir::RewritePatternSet&,\n+                                          mlir::ConversionTarget&)>\n+        populate_platform_patterns) {\n+  // Populate type conversions.\n+  mlir::LowerToLLVMOptions llvm_opts(op.getContext(), mlir::DataLayout(op));\n+  mlir::LLVMTypeConverter type_converter(op.getContext(), llvm_opts);\n+  mlir::LLVMConversionTarget target(*op.getContext());\n+\n+  // Populate patterns.\n+  mlir::RewritePatternSet patterns(op.getContext());\n+  mlir::arith::populateArithExpandOpsPatterns(patterns);\n+  mlir::arith::populateArithToLLVMConversionPatterns(type_converter, patterns);\n+  if (mlir::failed(\n+          populate_platform_patterns(type_converter, patterns, target))) {\n+    return mlir::failure();\n+  }\n+  mlir::populateFuncToLLVMConversionPatterns(type_converter, patterns);\n+  mlir::populateFinalizeMemRefToLLVMConversionPatterns(type_converter,\n+                                                       patterns);\n+  mlir::ub::populateUBToLLVMConversionPatterns(type_converter, patterns);\n+  mlir::populateVectorToLLVMConversionPatterns(type_converter, patterns);\n+  mlir::cf::populateControlFlowToLLVMConversionPatterns(type_converter,\n+                                                        patterns);\n+  mlir::populateComplexToLLVMConversionPatterns(type_converter, patterns);\n+\n+  //  Set up target.\n+  target.addIllegalDialect<mlir::arith::ArithDialect, mlir::func::FuncDialect,\n+                           mlir::complex::ComplexDialect>();\n+  target.addLegalOp<mlir::ModuleOp>();\n+\n+  if (mlir::failed(applyPartialConversion(op, target, std::move(patterns)))) {\n+    return mlir::failure();\n+  }\n+\n+  // Clean up any leftover math ops.\n+  mlir::RewritePatternSet mathPatterns(op.getContext());\n+  mlir::populateMathToLLVMConversionPatterns(type_converter, mathPatterns,\n+                                             /*approximateLog1p=*/false);\n+  target.addIllegalDialect<mlir::math::MathDialect>();\n+\n+  if (mlir::failed(applyFullConversion(op, target, std::move(mathPatterns)))) {\n+    return mlir::failure();\n+  }\n+  return mlir::success();\n+}\n+\n+}  // namespace emitters\n+}  // namespace xla"
        },
        {
            "sha": "5aec57c5e65cc6f88f15d5df828dfe4e1c5b903c",
            "filename": "third_party/xla/xla/codegen/emitters/transforms/lower_to_llvm_common.h",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_common.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_common.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_common.h?ref=79e54e1d40fd40cd174b21b7307cd14a82706239",
            "patch": "@@ -0,0 +1,40 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+#ifndef XLA_CODEGEN_EMITTERS_TRANSFORMS_LOWER_TO_LLVM_COMMON_H_\n+#define XLA_CODEGEN_EMITTERS_TRANSFORMS_LOWER_TO_LLVM_COMMON_H_\n+\n+#include \"absl/functional/function_ref.h\"\n+#include \"mlir/Conversion/LLVMCommon/TypeConverter.h\"\n+#include \"mlir/IR/BuiltinOps.h\"\n+#include \"mlir/IR/PatternMatch.h\"\n+#include \"mlir/Support/LLVM.h\"\n+#include \"mlir/Transforms/DialectConversion.h\"\n+\n+namespace xla {\n+namespace emitters {\n+\n+mlir::LogicalResult LowerToLLVM(\n+    mlir::ModuleOp op,\n+    absl::FunctionRef<mlir::LogicalResult(mlir::LLVMTypeConverter&,\n+                                          mlir::RewritePatternSet&,\n+                                          mlir::ConversionTarget&)>\n+        populate_platform_patterns =\n+            [](mlir::LLVMTypeConverter&, mlir::RewritePatternSet&,\n+               mlir::ConversionTarget&) { return mlir::success(); });\n+\n+}  // namespace emitters\n+}  // namespace xla\n+\n+#endif  // XLA_CODEGEN_EMITTERS_TRANSFORMS_LOWER_TO_LLVM_COMMON_H_"
        },
        {
            "sha": "cbe400674ea2e5b82819a45ee6d904c9b026a7cb",
            "filename": "third_party/xla/xla/codegen/emitters/transforms/lower_to_llvm_cpu.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 60,
            "changes": 66,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_cpu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_cpu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_cpu.cc?ref=79e54e1d40fd40cd174b21b7307cd14a82706239",
            "patch": "@@ -13,27 +13,14 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n+#include \"xla/codegen/emitters/transforms/lower_to_llvm_cpu.h\"\n+\n #include <memory>\n-#include <utility>\n \n-#include \"mlir/Conversion/ArithToLLVM/ArithToLLVM.h\"\n-#include \"mlir/Conversion/ComplexToLLVM/ComplexToLLVM.h\"\n-#include \"mlir/Conversion/ControlFlowToLLVM/ControlFlowToLLVM.h\"\n-#include \"mlir/Conversion/FuncToLLVM/ConvertFuncToLLVM.h\"\n-#include \"mlir/Conversion/LLVMCommon/ConversionTarget.h\"\n-#include \"mlir/Conversion/LLVMCommon/TypeConverter.h\"\n-#include \"mlir/Conversion/MathToLLVM/MathToLLVM.h\"\n-#include \"mlir/Conversion/MemRefToLLVM/MemRefToLLVM.h\"\n-#include \"mlir/Conversion/SCFToControlFlow/SCFToControlFlow.h\"\n-#include \"mlir/Conversion/UBToLLVM/UBToLLVM.h\"\n-#include \"mlir/Conversion/VectorToLLVM/ConvertVectorToLLVM.h\"\n-#include \"mlir/Dialect/Arith/IR/Arith.h\"\n-#include \"mlir/Dialect/Arith/Transforms/Passes.h\"\n-#include \"mlir/Dialect/Complex/IR/Complex.h\"\n-#include \"mlir/Dialect/Func/IR/FuncOps.h\"\n-#include \"mlir/Dialect/Math/IR/Math.h\"\n+#include \"mlir/Dialect/Func/IR/FuncOps.h\"  // IWYU pragma: keep, needed by lower_to_llvm_cpu.h.inc.\n #include \"mlir/Pass/Pass.h\"\n-#include \"mlir/Transforms/DialectConversion.h\"\n+#include \"mlir/Support/LLVM.h\"\n+#include \"xla/codegen/emitters/transforms/lower_to_llvm_common.h\"\n \n namespace xla {\n namespace emitters {\n@@ -45,49 +32,8 @@ namespace {\n class LowerToLLVMCPUPass\n     : public impl::LowerToLLVMCPUPassBase<LowerToLLVMCPUPass> {\n  public:\n-  LowerToLLVMCPUPass() : LowerToLLVMCPUPassBase() {}\n-\n   void runOnOperation() override {\n-    // Populate type conversions.\n-    mlir::LowerToLLVMOptions llvm_opts(&getContext(),\n-                                       mlir::DataLayout(getOperation()));\n-    mlir::LLVMTypeConverter type_converter(getOperation().getContext(),\n-                                           llvm_opts);\n-    mlir::LLVMConversionTarget target(*getOperation().getContext());\n-\n-    // Populate patterns.\n-    mlir::RewritePatternSet patterns(&getContext());\n-    mlir::arith::populateArithExpandOpsPatterns(patterns);\n-    mlir::arith::populateArithToLLVMConversionPatterns(type_converter,\n-                                                       patterns);\n-    mlir::populateFuncToLLVMConversionPatterns(type_converter, patterns);\n-    mlir::populateFinalizeMemRefToLLVMConversionPatterns(type_converter,\n-                                                         patterns);\n-    mlir::ub::populateUBToLLVMConversionPatterns(type_converter, patterns);\n-    mlir::populateVectorToLLVMConversionPatterns(type_converter, patterns);\n-    mlir::cf::populateControlFlowToLLVMConversionPatterns(type_converter,\n-                                                          patterns);\n-    mlir::populateComplexToLLVMConversionPatterns(type_converter, patterns);\n-\n-    //  Set up target.\n-    target.addIllegalDialect<mlir::arith::ArithDialect, mlir::func::FuncDialect,\n-                             mlir::complex::ComplexDialect>();\n-    target.addLegalOp<mlir::ModuleOp>();\n-\n-    if (failed(applyPartialConversion(getOperation(), target,\n-                                      std::move(patterns)))) {\n-      signalPassFailure();\n-      return;\n-    }\n-\n-    // Clean up any leftover math ops.\n-    mlir::RewritePatternSet mathPatterns(&getContext());\n-    mlir::populateMathToLLVMConversionPatterns(type_converter, mathPatterns,\n-                                               /*approximateLog1p=*/false);\n-    target.addIllegalDialect<mlir::math::MathDialect>();\n-\n-    if (failed(applyFullConversion(getOperation(), target,\n-                                   std::move(mathPatterns)))) {\n+    if (mlir::failed(LowerToLLVM(getOperation()))) {\n       signalPassFailure();\n     }\n   }"
        },
        {
            "sha": "3a9091747ab33caa891a3c2ba700fb71e9df919e",
            "filename": "third_party/xla/xla/codegen/emitters/transforms/lower_to_llvm_gpu.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 76,
            "changes": 117,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_gpu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_gpu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_gpu.cc?ref=79e54e1d40fd40cd174b21b7307cd14a82706239",
            "patch": "@@ -18,7 +18,6 @@ limitations under the License.\n #include <cstdint>\n #include <memory>\n #include <string>\n-#include <utility>\n \n #include \"llvm/Support/LogicalResult.h\"\n #include \"mlir/Conversion/AffineToStandard/AffineToStandard.h\"\n@@ -29,30 +28,27 @@ limitations under the License.\n #include \"mlir/Conversion/GPUToLLVMSPV/GPUToLLVMSPVPass.h\"\n #include \"mlir/Conversion/GPUToNVVM/GPUToNVVMPass.h\"\n #include \"mlir/Conversion/GPUToROCDL/GPUToROCDLPass.h\"\n-#include \"mlir/Conversion/LLVMCommon/ConversionTarget.h\"\n #include \"mlir/Conversion/LLVMCommon/TypeConverter.h\"\n #include \"mlir/Conversion/MathToLLVM/MathToLLVM.h\"\n #include \"mlir/Conversion/MemRefToLLVM/MemRefToLLVM.h\"\n #include \"mlir/Conversion/SCFToControlFlow/SCFToControlFlow.h\"\n #include \"mlir/Conversion/UBToLLVM/UBToLLVM.h\"\n #include \"mlir/Conversion/VectorToLLVM/ConvertVectorToLLVM.h\"\n #include \"mlir/Dialect/AMDGPU/Utils/Chipset.h\"\n-#include \"mlir/Dialect/Arith/IR/Arith.h\"\n #include \"mlir/Dialect/Arith/Transforms/Passes.h\"\n-#include \"mlir/Dialect/Complex/IR/Complex.h\"\n #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n #include \"mlir/Dialect/LLVMIR/LLVMDialect.h\"  // IWYU pragma: keep\n #include \"mlir/Dialect/LLVMIR/NVVMDialect.h\"  // IWYU pragma: keep\n-#include \"mlir/Dialect/Math/IR/Math.h\"\n+#include \"mlir/IR/BuiltinOps.h\"\n #include \"mlir/IR/Diagnostics.h\"\n #include \"mlir/IR/Location.h\"\n #include \"mlir/IR/PatternMatch.h\"\n-#include \"mlir/Interfaces/DataLayoutInterfaces.h\"\n #include \"mlir/Pass/Pass.h\"\n #include \"mlir/Support/LLVM.h\"\n #include \"mlir/Transforms/DialectConversion.h\"\n #include \"google/protobuf/text_format.h\"\n #include \"xla/codegen/device_spec.h\"\n+#include \"xla/codegen/emitters/transforms/lower_to_llvm_common.h\"\n #include \"xla/stream_executor/device_description.h\"\n #include \"xla/stream_executor/device_description.pb.h\"\n #include \"xla/tsl/platform/logging.h\"\n@@ -86,78 +82,47 @@ class LowerToLLVMGPUPass\n       CHECK_OK(device_description.status());\n       *device_spec_.mutable_type() = *device_description;\n     }\n-    // Populate type conversions.\n-    mlir::LowerToLLVMOptions llvm_opts(&getContext(),\n-                                       mlir::DataLayout(getOperation()));\n-    mlir::LLVMTypeConverter type_converter(getOperation().getContext(),\n-                                           llvm_opts);\n-    mlir::LLVMConversionTarget target(*getOperation().getContext());\n-\n-    // Populate patterns.\n-    mlir::RewritePatternSet patterns(&getContext());\n-    mlir::arith::populateArithExpandOpsPatterns(patterns);\n-    mlir::arith::populateArithToLLVMConversionPatterns(type_converter,\n-                                                       patterns);\n-    if (device_spec_.IsAmdGpu()) {\n-      std::string chipset =\n-          device_spec_.gpu().rocm_compute_capability().gfx_version();\n-      llvm::FailureOr<mlir::amdgpu::Chipset> maybeChipset =\n-          mlir::amdgpu::Chipset::parse(chipset);\n-      if (failed(maybeChipset)) {\n-        mlir::emitError(mlir::UnknownLoc::get(&getContext()),\n-                        \"Invalid chipset name: \" + chipset);\n-        return signalPassFailure();\n-      }\n-      mlir::populateGpuToROCDLConversionPatterns(\n-          type_converter, patterns, mlir::gpu::amd::Runtime::Unknown,\n-          *maybeChipset);\n-      mlir::configureGpuToROCDLConversionLegality(target);\n-    } else if (device_spec_.IsIntelGpu()) {\n-      // Add sub-group-size attribute to functions.\n-      int32_t sub_group_size = device_spec_.gpu().threads_per_warp();\n-      if (auto module_op = mlir::dyn_cast<mlir::ModuleOp>(getOperation())) {\n-        module_op.walk([sub_group_size](mlir::func::FuncOp func) {\n-          if (!func.getBody().empty()) {\n-            mlir::OpBuilder b(func.getContext());\n-            auto sub_group_attr = b.getI32IntegerAttr(sub_group_size);\n-            func->setAttr(\"intel_reqd_sub_group_size\", sub_group_attr);\n-          }\n-        });\n-      }\n-      populateGpuToLLVMSPVConversionPatterns(type_converter, patterns);\n-      populateGpuMemorySpaceAttributeConversions(type_converter);\n-    } else {\n-      mlir::populateGpuToNVVMConversionPatterns(type_converter, patterns);\n-      mlir::configureGpuToNVVMConversionLegality(target);\n-    }\n-    mlir::populateFuncToLLVMConversionPatterns(type_converter, patterns);\n-    mlir::populateFinalizeMemRefToLLVMConversionPatterns(type_converter,\n-                                                         patterns);\n-    mlir::ub::populateUBToLLVMConversionPatterns(type_converter, patterns);\n-    mlir::populateVectorToLLVMConversionPatterns(type_converter, patterns);\n-    mlir::cf::populateControlFlowToLLVMConversionPatterns(type_converter,\n-                                                          patterns);\n-    mlir::populateComplexToLLVMConversionPatterns(type_converter, patterns);\n-\n-    // Set up target.\n-    target.addIllegalDialect<mlir::arith::ArithDialect, mlir::func::FuncDialect,\n-                             mlir::complex::ComplexDialect>();\n-    target.addLegalOp<mlir::ModuleOp>();\n-\n-    if (failed(applyPartialConversion(getOperation(), target,\n-                                      std::move(patterns)))) {\n-      signalPassFailure();\n-      return;\n-    }\n \n-    // Clean up any leftover math ops not handled NVVM or ROCDL lowering.\n-    mlir::RewritePatternSet mathPatterns(&getContext());\n-    mlir::populateMathToLLVMConversionPatterns(type_converter, mathPatterns,\n-                                               /*approximateLog1p=*/false);\n-    target.addIllegalDialect<mlir::math::MathDialect>();\n+    auto populate_patterns =\n+        [&](mlir::LLVMTypeConverter& converter,\n+            mlir::RewritePatternSet& patterns,\n+            mlir::ConversionTarget& target) -> mlir::LogicalResult {\n+      if (device_spec_.IsAmdGpu()) {\n+        std::string chipset =\n+            device_spec_.gpu().rocm_compute_capability().gfx_version();\n+        llvm::FailureOr<mlir::amdgpu::Chipset> maybeChipset =\n+            mlir::amdgpu::Chipset::parse(chipset);\n+        if (mlir::failed(maybeChipset)) {\n+          mlir::emitError(mlir::UnknownLoc::get(&getContext()),\n+                          \"Invalid chipset name: \" + chipset);\n+          return mlir::failure();\n+        }\n+        mlir::populateGpuToROCDLConversionPatterns(\n+            converter, patterns, mlir::gpu::amd::Runtime::Unknown,\n+            *maybeChipset);\n+        mlir::configureGpuToROCDLConversionLegality(target);\n+      } else if (device_spec_.IsIntelGpu()) {\n+        // Add sub-group-size attribute to functions.\n+        int32_t sub_group_size = device_spec_.gpu().threads_per_warp();\n+        if (auto module_op = mlir::dyn_cast<mlir::ModuleOp>(getOperation())) {\n+          module_op.walk([sub_group_size](mlir::func::FuncOp func) {\n+            if (!func.getBody().empty()) {\n+              mlir::OpBuilder b(func.getContext());\n+              auto sub_group_attr = b.getI32IntegerAttr(sub_group_size);\n+              func->setAttr(\"intel_reqd_sub_group_size\", sub_group_attr);\n+            }\n+          });\n+        }\n+        populateGpuToLLVMSPVConversionPatterns(converter, patterns);\n+        populateGpuMemorySpaceAttributeConversions(converter);\n+      } else {\n+        mlir::populateGpuToNVVMConversionPatterns(converter, patterns);\n+        mlir::configureGpuToNVVMConversionLegality(target);\n+      }\n+      return mlir::success();\n+    };\n \n-    if (failed(applyFullConversion(getOperation(), target,\n-                                   std::move(mathPatterns)))) {\n+    if (mlir::failed(LowerToLLVM(getOperation(), populate_patterns))) {\n       signalPassFailure();\n     }\n   }"
        },
        {
            "sha": "0bed290d078d4f212d5c08137a8232703284c64d",
            "filename": "third_party/xla/xla/codegen/emitters/transforms/lower_to_llvm_gpu.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_gpu.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/79e54e1d40fd40cd174b21b7307cd14a82706239/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_gpu.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ftransforms%2Flower_to_llvm_gpu.h?ref=79e54e1d40fd40cd174b21b7307cd14a82706239",
            "patch": "@@ -15,7 +15,6 @@ limitations under the License.\n #ifndef XLA_CODEGEN_EMITTERS_TRANSFORMS_LOWER_TO_LLVM_GPU_H_\n #define XLA_CODEGEN_EMITTERS_TRANSFORMS_LOWER_TO_LLVM_GPU_H_\n \n-#include <cstdint>\n #include <memory>\n #include <string>\n "
        }
    ],
    "stats": {
        "total": 349,
        "additions": 203,
        "deletions": 146
    }
}