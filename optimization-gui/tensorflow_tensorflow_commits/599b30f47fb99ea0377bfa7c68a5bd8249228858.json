{
    "author": "pifon2a",
    "message": "[XLA:CPU] Pass MLIRContext to EmitFusionKernel.\n\nPiperOrigin-RevId: 829416657",
    "sha": "599b30f47fb99ea0377bfa7c68a5bd8249228858",
    "files": [
        {
            "sha": "428383ed1e8104c2ab87a8af43dd23dcbaac5dad",
            "filename": "third_party/xla/xla/backends/cpu/codegen/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -678,7 +678,6 @@ cc_library(\n         \"//xla/codegen:hlo_fusion_spec\",\n         \"//xla/codegen:ir_emission_utils\",\n         \"//xla/codegen:kernel_definition\",\n-        \"//xla/codegen:kernel_spec\",\n         \"//xla/codegen:mlir_kernel_source\",\n         \"//xla/codegen/emitters:concatenate_kernel_emitter\",\n         \"//xla/codegen/emitters:dynamic_update_slice_kernel_emitter\",\n@@ -695,7 +694,6 @@ cc_library(\n         \"//xla/runtime:work_tile_size\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/service/cpu:backend_config_proto_cc\",\n-        \"//xla/service/gpu:ir_emission_utils\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/container:inlined_vector\","
        },
        {
            "sha": "d7c8ff759e87b13b051841091930211d2a0a93af",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_emitter.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.cc?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -32,6 +32,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/STLExtras.h\"\n #include \"mlir/IR/Builders.h\"\n+#include \"mlir/IR/MLIRContext.h\"\n #include \"xla/backends/cpu/alignment.h\"\n #include \"xla/backends/cpu/codegen/kernel_api_ir_builder.h\"\n #include \"xla/backends/cpu/codegen/symbol_name_util.h\"\n@@ -64,6 +65,8 @@ limitations under the License.\n \n namespace xla::cpu {\n \n+using ::mlir::MLIRContext;\n+\n static absl::StatusOr<std::string> GetName(const HloFusionInstruction& fusion,\n                                            bool use_unique_c_name) {\n   if (!use_unique_c_name) {\n@@ -279,15 +282,16 @@ EmitDynamicUpdateSliceFusionKernel(SymbolicExprContext& context,\n }\n \n absl::StatusOr<KernelDefinition<MlirKernelSource>> EmitFusionKernel(\n-    SymbolicExprContext& context, const HloFusionInstruction& fusion,\n+    MLIRContext& mlir_context, SymbolicExprContext& expr_context,\n+    const HloFusionInstruction& fusion,\n     const BufferAssignment* buffer_assignment, bool use_unique_c_name) {\n   if (fusion.fusion_kind() == HloFusionInstruction::FusionKind::kLoop) {\n     TF_ASSIGN_OR_RETURN(std::string name, GetName(fusion, use_unique_c_name));\n     const HloInstruction& hero =\n         FindNonTrivialHero(*fusion.fused_expression_root());\n     if (hero.opcode() == HloOpcode::kConcatenate) {\n-      return EmitConcatenateFusionKernel(context, fusion, buffer_assignment,\n-                                         name);\n+      return EmitConcatenateFusionKernel(expr_context, fusion,\n+                                         buffer_assignment, name);\n     }\n     auto fusion_spec = GetLoopFusionSpec(fusion);\n     if (IsDynamicUpdateSliceFusion(fusion_spec)) {\n@@ -296,11 +300,11 @@ absl::StatusOr<KernelDefinition<MlirKernelSource>> EmitFusionKernel(\n           CanEmitFusedDynamicUpdateSliceInPlace(fusion_spec.fusion(),\n                                                 buffer_assignment, &fusion));\n       if (dus_inplace) {\n-        return EmitDynamicUpdateSliceFusionKernel(context, fusion,\n+        return EmitDynamicUpdateSliceFusionKernel(expr_context, fusion,\n                                                   buffer_assignment, name);\n       }\n     }\n-    return EmitLoopFusionKernel(context, fusion, buffer_assignment, name);\n+    return EmitLoopFusionKernel(expr_context, fusion, buffer_assignment, name);\n   }\n \n   return absl::UnimplementedError(\"Fusion kind not supported.\");"
        },
        {
            "sha": "bef9ec6853c706a705ed19da0e6a7e79807f664a",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_emitter.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter.h?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -17,6 +17,7 @@ limitations under the License.\n #define XLA_BACKENDS_CPU_CODEGEN_FUSION_EMITTER_H_\n \n #include \"absl/status/statusor.h\"\n+#include \"mlir/IR/MLIRContext.h\"\n #include \"xla/codegen/emitters/kernel_arguments.h\"\n #include \"xla/codegen/kernel_definition.h\"\n #include \"xla/codegen/mlir_kernel_source.h\"\n@@ -29,7 +30,8 @@ namespace xla::cpu {\n emitters::KernelArguments::BufferAlignment GetDefaultBufferAlignment();\n \n absl::StatusOr<KernelDefinition<MlirKernelSource>> EmitFusionKernel(\n-    SymbolicExprContext& context, const HloFusionInstruction& fusion,\n+    mlir::MLIRContext& mlir_context, SymbolicExprContext& expr_context,\n+    const HloFusionInstruction& fusion,\n     const BufferAssignment* buffer_assignment, bool use_unique_c_name);\n \n }  // namespace xla::cpu"
        },
        {
            "sha": "90da5a8682aa051c98bc8a0c2341d0a41e3d9862",
            "filename": "third_party/xla/xla/backends/cpu/codegen/fusion_emitter_test.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter_test.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter_test.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ffusion_emitter_test.py?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -55,6 +55,7 @@ def test_basic_add_sub(self):\n     mlir_context = testlib_cpu.MLIRContext()\n     symbolic_expr_context = testlib_cpu.SymbolicExprContext(mlir_context)\n     kernel_definition = testlib_cpu.emit_fusion_kernel(\n+        mlir_context,\n         symbolic_expr_context,\n         hlo_module.get_root_instruction(),\n         buffer_assignment,\n@@ -116,6 +117,7 @@ def test_convert_f32_bf16_f32(self):\n     mlir_context = testlib_cpu.MLIRContext()\n     symbolic_expr_context = testlib_cpu.SymbolicExprContext(mlir_context)\n     kernel_definition = testlib_cpu.emit_fusion_kernel(\n+        mlir_context,\n         symbolic_expr_context,\n         hlo_module.get_root_instruction(),\n         buffer_assignment,\n@@ -172,6 +174,7 @@ def test_convert_f32_bf16_f32_nan(self):\n     mlir_context = testlib_cpu.MLIRContext()\n     symbolic_expr_context = testlib_cpu.SymbolicExprContext(mlir_context)\n     kernel_definition = testlib_cpu.emit_fusion_kernel(\n+        mlir_context,\n         symbolic_expr_context,\n         hlo_module.get_root_instruction(),\n         buffer_assignment,\n@@ -225,6 +228,7 @@ def test_constant_with_layout(self):\n     mlir_context = testlib_cpu.MLIRContext()\n     symbolic_expr_context = testlib_cpu.SymbolicExprContext(mlir_context)\n     kernel_definition = testlib_cpu.emit_fusion_kernel(\n+        mlir_context,\n         symbolic_expr_context,\n         hlo_module.get_root_instruction(),\n         buffer_assignment,\n@@ -275,6 +279,7 @@ def test_exp_nan_dce(self):\n     mlir_context = testlib_cpu.MLIRContext()\n     symbolic_expr_context = testlib_cpu.SymbolicExprContext(mlir_context)\n     kernel_definition = testlib_cpu.emit_fusion_kernel(\n+        mlir_context,\n         symbolic_expr_context,\n         hlo_module.get_root_instruction(),\n         buffer_assignment,"
        },
        {
            "sha": "8fe23f2259e1e26f44ff8a568f91932e4518acba",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tools/BUILD",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -82,7 +82,6 @@ xla_cc_binary(\n     deps = [\n         \"//xla/backends/cpu/codegen:fusion_compiler\",\n         \"//xla/backends/cpu/codegen:fusion_emitter\",\n-        \"//xla/codegen:mlir_kernel_source\",\n         \"//xla/codegen/tools:test_lib\",\n         \"//xla/hlo/analysis:symbolic_expr\",\n         \"//xla/hlo/ir:hlo\","
        },
        {
            "sha": "211a42e16eefe21b8b361947b2f1827f0c274594",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tools/fusion_to_mlir.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Ffusion_to_mlir.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Ffusion_to_mlir.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Ffusion_to_mlir.cc?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -32,15 +32,14 @@ namespace xla::cpu {\n \n absl::Status Run(const std::string& filename) {\n   auto mlir_context = FusionCompiler::CreateContext();\n-  auto symbolic_expr_context =\n-      std::make_unique<SymbolicExprContext>(mlir_context.get());\n+  auto expr_context = std::make_unique<SymbolicExprContext>(mlir_context.get());\n   TF_ASSIGN_OR_RETURN(auto module, LoadTestModule(filename));\n   auto fusion = DynCast<HloFusionInstruction>(\n       module->entry_computation()->root_instruction());\n   fusion->SetAndSanitizeName(\"main\");\n   TF_ASSIGN_OR_RETURN(\n       KernelDefinition kernel_definition,\n-      EmitFusionKernel(*symbolic_expr_context, *fusion, nullptr, false));\n+      EmitFusionKernel(*mlir_context, *expr_context, *fusion, nullptr, false));\n   llvm::outs() << kernel_definition.source().ToString();\n   return absl::OkStatus();\n }"
        },
        {
            "sha": "25fcfad5dcde536ead4833703829c171e43798e9",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner_extension.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner_extension.cc?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -203,11 +203,11 @@ NB_MODULE(_extension, kernel_runner_module) {\n \n   kernel_runner_module.def(\n       \"emit_fusion_kernel\",\n-      [](SymbolicExprContext& symbolic_expr_context,\n+      [](mlir::MLIRContext& mlir_context, SymbolicExprContext& expr_context,\n          const HloFusionInstruction& fusion,\n          const BufferAssignment* buffer_assignment) {\n-        auto kernel_definition = EmitFusionKernel(symbolic_expr_context, fusion,\n-                                                  buffer_assignment, false);\n+        auto kernel_definition = EmitFusionKernel(\n+            mlir_context, expr_context, fusion, buffer_assignment, false);\n         if (!kernel_definition.ok()) {\n           throw std::runtime_error(kernel_definition.status().ToString());\n         }"
        },
        {
            "sha": "201c7d5907e07c47b644a04f58140761e80323a8",
            "filename": "third_party/xla/xla/service/cpu/parallel_fusion_emitter.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/599b30f47fb99ea0377bfa7c68a5bd8249228858/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fparallel_fusion_emitter.cc?ref=599b30f47fb99ea0377bfa7c68a5bd8249228858",
            "patch": "@@ -172,7 +172,8 @@ absl::StatusOr<KernelSpec> ParallelFusionEmitter::AddFusion(\n   auto compiler_instance = fusion_compiler_pool_->GetInstance();\n   TF_ASSIGN_OR_RETURN(\n       KernelDefinition mlir_kernel_definition,\n-      EmitFusionKernel(*compiler_instance->symbolic_expr_context, *fusion,\n+      EmitFusionKernel(*compiler_instance->mlir_context,\n+                       *compiler_instance->symbolic_expr_context, *fusion,\n                        buffer_assignment_, use_unique_c_name_));\n \n   {"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 24,
        "deletions": 16
    }
}