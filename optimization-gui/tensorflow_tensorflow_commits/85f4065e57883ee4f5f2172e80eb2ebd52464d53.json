{
    "author": "DottsGit",
    "message": "Fix shape inference in decode_image for tf.data pipelines\n\n- Add tensor shape information when expand_animations=False\n- Resolves ValueError: 'images' contains no shape in resize operations\n- Maintains backward compatibility with existing behavior",
    "sha": "85f4065e57883ee4f5f2172e80eb2ebd52464d53",
    "files": [
        {
            "sha": "a60078e2223b23d710a873c2075c863754ada0aa",
            "filename": "tensorflow/python/ops/image_ops_impl.py",
            "status": "modified",
            "additions": 22,
            "deletions": 13,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/85f4065e57883ee4f5f2172e80eb2ebd52464d53/tensorflow%2Fpython%2Fops%2Fimage_ops_impl.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/85f4065e57883ee4f5f2172e80eb2ebd52464d53/tensorflow%2Fpython%2Fops%2Fimage_ops_impl.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fpython%2Fops%2Fimage_ops_impl.py?ref=85f4065e57883ee4f5f2172e80eb2ebd52464d53",
            "patch": "@@ -3323,21 +3323,30 @@ def decode_image(contents,\n   \"\"\"\n   with ops.name_scope(name, 'decode_image'):\n     channels = 0 if channels is None else channels\n+    original_dtype = dtype\n     if dtype not in [dtypes.float32, dtypes.uint8, dtypes.uint16]:\n-      dest_dtype = dtype\n-      dtype = dtypes.uint16\n-      return convert_image_dtype(\n-          gen_image_ops.decode_image(\n-              contents=contents,\n-              channels=channels,\n-              expand_animations=expand_animations,\n-              dtype=dtype), dest_dtype)\n+      dtype_for_decode = dtypes.uint16\n     else:\n-      return gen_image_ops.decode_image(\n-          contents=contents,\n-          channels=channels,\n-          expand_animations=expand_animations,\n-          dtype=dtype)\n+      dtype_for_decode = dtype\n+\n+    image = gen_image_ops.decode_image(\n+        contents=contents,\n+        channels=channels,\n+        expand_animations=expand_animations,\n+        dtype=dtype_for_decode)\n+\n+    if dtype_for_decode != original_dtype:\n+      image = convert_image_dtype(image, original_dtype)\n+\n+    if not expand_animations:\n+      # If not expanding animations, the output is always 3D.\n+      if channels != 0:\n+        image.set_shape([None, None, channels])\n+      else:\n+        # We can still set the rank, which is what matters for the resize op.\n+        image.set_shape([None, None, None])\n+\n+    return image\n \n \n @tf_export('image.total_variation')"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 22,
        "deletions": 13
    }
}