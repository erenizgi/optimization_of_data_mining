{
    "author": "SiqiaoWu1993",
    "message": "Support rewriting PartitionCall to XlaLaunchV2 so that function call on tf.PartitionCall with `_XlaMustCompile` attribute will be launched on XLA-CPU.\n\nPiperOrigin-RevId: 842430158",
    "sha": "7c723d06ce9f08be8823e2d5aedd80a90fac7dac",
    "files": [
        {
            "sha": "24e195dbc9dc4289b94ff33939c3fbf323a7b5a2",
            "filename": "tensorflow/compiler/mlir/tfrt/tests/xla_rewrite.mlir",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7c723d06ce9f08be8823e2d5aedd80a90fac7dac/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftests%2Fxla_rewrite.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7c723d06ce9f08be8823e2d5aedd80a90fac7dac/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftests%2Fxla_rewrite.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftests%2Fxla_rewrite.mlir?ref=7c723d06ce9f08be8823e2d5aedd80a90fac7dac",
            "patch": "@@ -27,7 +27,14 @@ func.func @xla_launch(%arg: tensor<i32>, %v0: tensor<*x!tf_type.resource>, %v1:\n       device = \"/device:GPU:0\", executor_type = \"\", f = @callee}\n       : (tensor<i32>, tensor<i32>, tensor<*x!tf_type.resource>, tensor<i32>, tensor<*x!tf_type.resource>) -> tensor<i32>\n \n-  func.return %r2 : tensor<i32>\n+  // CHECK: tf.XlaLaunchV2\n+  // CHECK-SAME: constants = [0, 3]\n+  // CHECK-SAME: resources = [2, 4]\n+  %r3 = \"tf.PartitionedCall\"(%c0, %r2, %v0, %c1, %v1) {_XlaMustCompile = true, config = \"\", config_proto = \"\",\n+      device = \"/device:CPU:0\", executor_type = \"\", f = @callee}\n+      : (tensor<i32>, tensor<i32>, tensor<*x!tf_type.resource>, tensor<i32>, tensor<*x!tf_type.resource>) -> tensor<i32>\n+\n+  func.return %r3 : tensor<i32>\n }\n \n func.func @callee(%c0: tensor<i32>, %arg: tensor<i32>, %v0: tensor<*x!tf_type.resource>, %c1: tensor<i32>, %v1: tensor<*x!tf_type.resource>) -> (tensor<i32>) {"
        },
        {
            "sha": "fea7a988bd40d71d55d42beac23d2330bedc9919",
            "filename": "tensorflow/compiler/mlir/tfrt/transforms/xla_rewrite_pass.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7c723d06ce9f08be8823e2d5aedd80a90fac7dac/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftransforms%2Fxla_rewrite_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7c723d06ce9f08be8823e2d5aedd80a90fac7dac/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftransforms%2Fxla_rewrite_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Ftransforms%2Fxla_rewrite_pass.cc?ref=7c723d06ce9f08be8823e2d5aedd80a90fac7dac",
            "patch": "@@ -38,15 +38,16 @@ namespace tensorflow {\n namespace tfrt_compiler {\n namespace {\n \n-struct RewriteStatefulPartitionedCallToXlaLaunchOnCpu\n-    : public mlir::OpRewritePattern<mlir::TF::StatefulPartitionedCallOp> {\n-  using OpRewritePattern::OpRewritePattern;\n+template <typename OpType>\n+struct RewriteFunctionCallToXlaLaunchOnCpu\n+    : public mlir::OpRewritePattern<OpType> {\n+ public:\n+  using mlir::OpRewritePattern<OpType>::OpRewritePattern;\n \n   mlir::LogicalResult matchAndRewrite(\n-      mlir::TF::StatefulPartitionedCallOp op,\n-      mlir::PatternRewriter& rewriter) const override {\n+      OpType op, mlir::PatternRewriter& rewriter) const override {\n     if (auto xla_must_compile =\n-            op->getAttrOfType<mlir::BoolAttr>(\"_XlaMustCompile\");\n+            op->template getAttrOfType<mlir::BoolAttr>(\"_XlaMustCompile\");\n         !xla_must_compile || !xla_must_compile.getValue()) {\n       return mlir::failure();\n     }\n@@ -92,7 +93,11 @@ struct TfrtXlaRewritePass\n   void runOnOperation() override {\n     mlir::RewritePatternSet patterns(&getContext());\n \n-    patterns.add<RewriteStatefulPartitionedCallToXlaLaunchOnCpu>(&getContext());\n+    patterns\n+        .add<RewriteFunctionCallToXlaLaunchOnCpu<mlir::TF::PartitionedCallOp>>(\n+            &getContext());\n+    patterns.add<RewriteFunctionCallToXlaLaunchOnCpu<\n+        mlir::TF::StatefulPartitionedCallOp>>(&getContext());\n \n     if (mlir::failed(\n             mlir::applyPatternsGreedily(getOperation(), std::move(patterns)))) {"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 20,
        "deletions": 8
    }
}