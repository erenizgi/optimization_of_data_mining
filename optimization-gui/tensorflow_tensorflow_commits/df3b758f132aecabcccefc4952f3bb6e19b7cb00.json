{
    "author": "d4n1elchen",
    "message": "[HLO Diff] Skip text diffing for very large HLO strings in HloGumGraphHtmlRenderer.\n\nAvoids performing a potentially expensive text diff when the HLO string representation of a node exceeds 10000 characters, instead just printing the current string.\n\nPiperOrigin-RevId: 809249158",
    "sha": "df3b758f132aecabcccefc4952f3bb6e19b7cb00",
    "files": [
        {
            "sha": "3e970bebfdcd95f0b478c44d4e75e22bfb4dcab3",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 26,
            "changes": 57,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/df3b758f132aecabcccefc4952f3bb6e19b7cb00/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/df3b758f132aecabcccefc4952f3bb6e19b7cb00/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=df3b758f132aecabcccefc4952f3bb6e19b7cb00",
            "patch": "@@ -693,7 +693,7 @@ std::string PrintHowToUseSection() {\n           <ul>\n             <li><span class=\"red-highlight\">&nbsp;Red&nbsp;</span>: Instruction only present in the left module.</li>\n             <li><span class=\"green-highlight\">&nbsp;Green&nbsp;</span>: Instruction only present in the right module.</li>\n-            <li><span class=\"yellow-highlight\">&nbsp;Yellow&nbsp;</span>: Instruction present in both modules but with differences.</li>\n+            <li><span class=\"yellow-highlight\">&nbsp;Yellow&nbsp;</span>: Instruction present in both modules but with differences. Character-level differences are highlighted in <span class=\"darker-yellow-highlight\">&nbsp;darker yellow&nbsp;</span> (this is skipped for instructions with >10k characters due to performance concern).</li>\n             <li>Instructions without highlights are identical in both modules.</li>\n           </ul>\n         </p>\n@@ -928,33 +928,38 @@ std::string PrintHloComputationToHtml(\n         std::string current_str = std::move(current_printer).ToString();\n         std::string mapped_str = std::move(mapped_printer).ToString();\n \n-        std::vector<TextDiffChunk> diff_chunks;\n-        if (is_left_node) {\n-          // Left side: diff current (left) vs mapped (right).\n-          diff_chunks = ComputeTextDiff(current_str, mapped_str);\n+        // Skip text diff if the two strings are longer than 10000 characters.\n+        if (current_str.size() > 10000 || mapped_str.size() > 10000) {\n+          printer.Append(current_str);\n         } else {\n-          // Right side: diff mapped (left) vs current (right).\n-          diff_chunks = ComputeTextDiff(mapped_str, current_str);\n-        }\n-\n-        for (const auto& chunk : diff_chunks) {\n-          if (chunk.type == TextDiffType::kUnchanged) {\n-            printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n-          } else if (is_left_node && chunk.type == TextDiffType::kRemoved) {\n-            // On the left side, highlight text REMOVED from left compared to\n-            // right.\n-            printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n-            printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n-            printer.Append(\"</span>\");\n-          } else if (!is_left_node && chunk.type == TextDiffType::kAdded) {\n-            // On the right side, highlight text ADDED to right compared to\n-            // left.\n-            printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n-            printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n-            printer.Append(\"</span>\");\n+          std::vector<TextDiffChunk> diff_chunks;\n+          if (is_left_node) {\n+            // Left side: diff current (left) vs mapped (right).\n+            diff_chunks = ComputeTextDiff(current_str, mapped_str);\n           } else {\n-            printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n-            printer.Append(\"</span>\");\n+            // Right side: diff mapped (left) vs current (right).\n+            diff_chunks = ComputeTextDiff(mapped_str, current_str);\n+          }\n+\n+          for (const auto& chunk : diff_chunks) {\n+            if (chunk.type == TextDiffType::kUnchanged) {\n+              printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n+            } else if (is_left_node && chunk.type == TextDiffType::kRemoved) {\n+              // On the left side, highlight text REMOVED from left compared to\n+              // right.\n+              printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n+              printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n+              printer.Append(\"</span>\");\n+            } else if (!is_left_node && chunk.type == TextDiffType::kAdded) {\n+              // On the right side, highlight text ADDED to right compared to\n+              // left.\n+              printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n+              printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n+              printer.Append(\"</span>\");\n+            } else {\n+              printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n+              printer.Append(\"</span>\");\n+            }\n           }\n         }\n       }"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 31,
        "deletions": 26
    }
}