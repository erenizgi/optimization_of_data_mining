{
    "author": "hhb",
    "message": "Implement `BufferFromHostLiteral` for `PjRtCApiClient`\n\nPiperOrigin-RevId: 834512994",
    "sha": "84217b5730c24179bd474ea108c790f384a73c09",
    "files": [
        {
            "sha": "2cbef75d3d30f91d102a91a3e04fe8958de269b2",
            "filename": "third_party/xla/xla/pjrt/c_api_client/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2FBUILD?ref=84217b5730c24179bd474ea108c790f384a73c09",
            "patch": "@@ -112,6 +112,7 @@ xla_cc_test(\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n         \"//xla:shape_util\",\n+        \"//xla:types\",\n         \"//xla/backends/cpu:alignment\",\n         \"//xla/ffi\",\n         \"//xla/ffi:ffi_api\","
        },
        {
            "sha": "98a1460fec0b4cafdc1ef630b125fcc5bbbf23e6",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.cc?ref=84217b5730c24179bd474ea108c790f384a73c09",
            "patch": "@@ -826,6 +826,25 @@ PjRtCApiClient::BufferFromHostBuffer(\n       std::move(on_done_with_host_buffer), memory_space, device_layout);\n }\n \n+absl::StatusOr<std::unique_ptr<PjRtBuffer>>\n+PjRtCApiClient::BufferFromHostLiteral(const LiteralSlice& literal,\n+                                      PjRtMemorySpace* memory_space,\n+                                      const Layout* device_layout) {\n+  if (literal.shape().is_dynamic()) {\n+    return Unimplemented(\n+        \"PJRT C API does not support dynamic shapes for \"\n+        \"BufferFromHostLiteral.\");\n+  }\n+  absl::InlinedVector<int64_t, 4> strides(literal.shape().dimensions().size());\n+  TF_RETURN_IF_ERROR(\n+      ShapeUtil::UnpackedByteStrides(literal.shape(), absl::MakeSpan(strides)));\n+  return BufferFromHostBufferInternalImpl(\n+      literal.untyped_data(), literal.shape().element_type(),\n+      literal.shape().dimensions(), strides,\n+      HostBufferSemantics::kImmutableUntilTransferCompletes,\n+      /*on_done_with_host_buffer=*/nullptr, memory_space, device_layout);\n+}\n+\n absl::StatusOr<std::unique_ptr<PjRtBuffer>>\n PjRtCApiClient::CreateViewOfDeviceBuffer(\n     void* device_ptr, const Shape& shape, PjRtMemorySpace* memory_space,"
        },
        {
            "sha": "264585c3826d549f48af6f313c1d97a5a46bba3c",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client.h?ref=84217b5730c24179bd474ea108c790f384a73c09",
            "patch": "@@ -356,12 +356,7 @@ class PjRtCApiClient : public PjRtClient {\n \n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> BufferFromHostLiteral(\n       const LiteralSlice& literal, PjRtMemorySpace* memory_space,\n-      const Layout* device_layout) override {\n-    return Unimplemented(\n-        \"PJRT C API does not support BufferFromHostLiteral. Please report an \"\n-        \"issue at https://github.com/google/jax/issues if you need this \"\n-        \"feature.\");\n-  }\n+      const Layout* device_layout) override;\n \n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> CreateViewOfDeviceBuffer(\n       void* device_ptr, const Shape& shape, PjRtMemorySpace* memory_space,"
        },
        {
            "sha": "d5718d6bed008d1a8aea56142134a02d809c3be4",
            "filename": "third_party/xla/xla/pjrt/c_api_client/pjrt_c_api_client_test.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/84217b5730c24179bd474ea108c790f384a73c09/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc_api_client%2Fpjrt_c_api_client_test.cc?ref=84217b5730c24179bd474ea108c790f384a73c09",
            "patch": "@@ -62,6 +62,9 @@ limitations under the License.\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n #include \"xla/tsl/platform/threadpool.h\"\n+#include \"xla/types.h\"\n+\n+using ::testing::ElementsAreArray;\n \n namespace xla {\n namespace {\n@@ -550,5 +553,19 @@ TEST(PjRtClientTest, DeserializeExecutableWithDifferentDeviceAssignment) {\n       deserialized_executable->addressable_devices()[0]->global_device_id(), 1);\n }\n \n+TEST(PjRtClientTest, BufferFromLiteralInt4) {\n+  SetUpCpuPjRtApi();\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtClient> client,\n+                          GetCApiClient(\"cpu\"));\n+  xla::Shape shape = xla::ShapeUtil::MakeShape(S4, {128, 256});\n+  TF_ASSERT_OK_AND_ASSIGN(auto literal, xla::MakeFakeLiteral(shape));\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto buffer,\n+      client->BufferFromHostLiteral(literal, client->memory_spaces()[0]));\n+  TF_ASSERT_OK_AND_ASSIGN(auto received_literal, buffer->ToLiteral().Await());\n+  EXPECT_THAT(received_literal->data<s4>(),\n+              ElementsAreArray(literal.data<s4>()));\n+}\n+\n }  // namespace\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 38,
        "deletions": 6
    }
}