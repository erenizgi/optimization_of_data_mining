{
    "author": "ezhulenev",
    "message": "[xla:cpu] Fix msan errors in sort_lib + tfcompile\n\nPiperOrigin-RevId: 833569008",
    "sha": "53dfa7e1aa10368666cca8b701572a964a2e8f25",
    "files": [
        {
            "sha": "818427d8b769ee6891168dbe7993c0117b6c8047",
            "filename": "tensorflow/compiler/aot/thunk_proto_execution_deserializer.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53dfa7e1aa10368666cca8b701572a964a2e8f25/tensorflow%2Fcompiler%2Faot%2Fthunk_proto_execution_deserializer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53dfa7e1aa10368666cca8b701572a964a2e8f25/tensorflow%2Fcompiler%2Faot%2Fthunk_proto_execution_deserializer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcompiler%2Faot%2Fthunk_proto_execution_deserializer.cc?ref=53dfa7e1aa10368666cca8b701572a964a2e8f25",
            "patch": "@@ -624,6 +624,7 @@ ThunkProtoExecutionDeserializer::GetSortThunkRunImpl(\n            [comparator](const void** data) {\n              bool result;\n              (*comparator)(&result, nullptr, data, nullptr, nullptr, nullptr);\n+             ABSL_ANNOTATE_MEMORY_IS_INITIALIZED(&result, sizeof(result));\n              return result;\n            };\n "
        },
        {
            "sha": "2a1b58741625bb15c57a3b096c3a922f72fe7c59",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53dfa7e1aa10368666cca8b701572a964a2e8f25/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53dfa7e1aa10368666cca8b701572a964a2e8f25/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=53dfa7e1aa10368666cca8b701572a964a2e8f25",
            "patch": "@@ -1036,6 +1036,7 @@ cc_library(\n     hdrs = [\"sort_lib.h\"],\n     deps = [\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/base:dynamic_annotations\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\","
        },
        {
            "sha": "df58a2a5371817ec33fbe8d2b6aafb78bbfe4e55",
            "filename": "third_party/xla/xla/backends/cpu/runtime/sort_lib.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53dfa7e1aa10368666cca8b701572a964a2e8f25/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fsort_lib.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53dfa7e1aa10368666cca8b701572a964a2e8f25/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fsort_lib.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fsort_lib.cc?ref=53dfa7e1aa10368666cca8b701572a964a2e8f25",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/base/attributes.h\"\n+#include \"absl/base/dynamic_annotations.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/types/span.h\"\n@@ -564,6 +565,12 @@ void SortInplace(const SortDims& sort_dims, absl::Span<std::byte* const> data,\n   // Iterate over all the 1-dimensional slices of the buffers and sort them.\n   int64_t num_iterations = sort_dims.outer_dim_size * sort_dims.inner_dim_size;\n \n+  // Annotate memory that might have been initialized by jit-compiled code.\n+  for (int64_t i = 0; i < data.size(); ++i) {\n+    ABSL_ANNOTATE_MEMORY_IS_INITIALIZED(\n+        data[i], primitive_sizes[i] * sort_dims.sort_dim_size * num_iterations);\n+  }\n+\n   for (int64_t i = 0; i < num_iterations; ++i) {\n     int64_t inner_idx = i % sort_dims.inner_dim_size;\n     int64_t offset = inner_idx + (i - inner_idx) * sort_dims.sort_dim_size;\n@@ -672,6 +679,10 @@ void SortInplace(const SortDims& sort_dims, T* data, bool is_stable,\n   // Iterate over all the 1-dimensional slices of the buffers and sort them.\n   int64_t num_iterations = sort_dims.outer_dim_size * sort_dims.inner_dim_size;\n \n+  // Annotate memory that might have been initialized by jit-compiled code.\n+  ABSL_ANNOTATE_MEMORY_IS_INITIALIZED(\n+      data, sizeof(T) * sort_dims.sort_dim_size * num_iterations);\n+\n   for (int64_t i = 0; i < num_iterations; ++i) {\n     int64_t inner_idx = i % sort_dims.inner_dim_size;\n     int64_t offset = inner_idx + (i - inner_idx) * sort_dims.sort_dim_size;"
        },
        {
            "sha": "3f753a6010ea0045930e9bfb9909e9c081579362",
            "filename": "third_party/xla/xla/backends/cpu/runtime/sort_thunk.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/53dfa7e1aa10368666cca8b701572a964a2e8f25/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fsort_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/53dfa7e1aa10368666cca8b701572a964a2e8f25/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fsort_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fsort_thunk.cc?ref=53dfa7e1aa10368666cca8b701572a964a2e8f25",
            "patch": "@@ -223,10 +223,6 @@ tsl::AsyncValueRef<SortThunk::ExecuteEvent> SortThunk::Execute(\n         params.buffer_allocations->GetDeviceAddress(input.slice));\n     shapes.push_back(input.shape);\n \n-    // Annotate memory that might have been initialized by jit-compiled code.\n-    ABSL_ANNOTATE_MEMORY_IS_INITIALIZED(data.back().opaque(),\n-                                        data.back().size());\n-\n     VLOG(3) << absl::StreamFormat(\"  sort input #%d: %s in slice %s (%p)\", idx,\n                                   input.shape.ToString(/*print_layout=*/true),\n                                   input.slice.ToString(), data.back().opaque());"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 13,
        "deletions": 4
    }
}