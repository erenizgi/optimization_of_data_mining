{
    "author": "tensorflower-gardener",
    "message": "Add tests for `ComposeIndexingMaps` with many dimensions\n\nDuring the refactor to use SymbolicExpr internally (cl/802100018), we had several crashes involving xla::SymbolicExpr::ReplaceDimsAndSymbols()/xla::ComposeIndexingMaps(),\n\nI still do not fully understand why they were not happening before, but they happened because the reference in SymbolicMap::GetResults() gets freed and I fixed by using GetResult(i) instead of iterating through GetResults()\n\nSo, in this CL I'm just adding test cases to `ComputationPartitionerTest` and `IndexingMapTest` that reproduce a crash when composing indexing maps with many dimensions. And I Change `SymbolicMap::GetResults()` to return `llvm::ArrayRef` to make it clear we are returning a reference there.\n\nPiperOrigin-RevId: 834275397",
    "sha": "402aeaf322152c834042189ecd3cd0d3b1688486",
    "files": [
        {
            "sha": "de2210732070b7905979a2f9271009b64eefd539",
            "filename": "third_party/xla/xla/codegen/emitters/computation_partitioner_test.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/402aeaf322152c834042189ecd3cd0d3b1688486/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Fcomputation_partitioner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/402aeaf322152c834042189ecd3cd0d3b1688486/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Fcomputation_partitioner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Fcomputation_partitioner_test.cc?ref=402aeaf322152c834042189ecd3cd0d3b1688486",
            "patch": "@@ -487,6 +487,23 @@ TEST_F(ComputationPartitionerTest, PartitioningIsDeterministic) {\n   EXPECT_EQ(computation.subgraphs().size(), 1);\n }\n \n+TEST_F(ComputationPartitionerTest, ScaleAndTranslateSamplerE2ETest) {\n+  // This is a simple fusion that used to result in a crash.\n+  auto module = ParseAndReturnVerifiedModule(R\"(\n+    HloModule test_module\n+    ENTRY fused_computation (param_0.1: f32[4,4,2]) -> f32[1,1,1,4,1,4,1,2]  {\n+      %param_0.1 = f32[4,4,2]{2,1,0} parameter(0)\n+      %bitcast.1 = f32[1,1,1,4,1,4,1,2]{7,5,3,6,4,2,1,0} bitcast(%param_0.1)\n+      ROOT %copy.1 = f32[1,1,1,4,1,4,1,2]{7,6,5,4,3,2,1,0} copy(%bitcast.1)\n+    })\")\n+                    .value();\n+\n+  auto* fusion = module->GetComputationWithName(\"fused_computation\");\n+  ASSERT_NE(fusion, nullptr);\n+  PartitionedComputation computation(fusion, &symbolic_expr_context_);\n+  EXPECT_EQ(computation.subgraphs().size(), 1);\n+}\n+\n }  // namespace\n }  // namespace emitters\n }  // namespace xla"
        },
        {
            "sha": "de8073cf67539f6565221890af460ad753978db6",
            "filename": "third_party/xla/xla/hlo/analysis/indexing_map_test.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/402aeaf322152c834042189ecd3cd0d3b1688486/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/402aeaf322152c834042189ecd3cd0d3b1688486/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Findexing_map_test.cc?ref=402aeaf322152c834042189ecd3cd0d3b1688486",
            "patch": "@@ -348,6 +348,24 @@ TEST_F(IndexingMapTest, Composition_OnlyRTVars) {\n   )\"));\n }\n \n+TEST_F(IndexingMapTest, ComposeIndexingMapsComputationPartitionerTestCrash) {\n+  // This is a simplification of a test case taken from ComputationPartitioner\n+  // that used to crash when calling ComposeIndexingMaps.\n+  auto indexing_map_identity_7_variables = Parse(R\"(\n+    (d0, d1, d2, d3, d4, d5, d6)->(d0, d1, d2, d3, d4, d5, d6),\n+        domain : d0 in[0, 3],\n+                d1 in[0, 3],\n+                d2 in[0, 3],\n+                d3 in[0, 3],\n+                d4 in[0, 3],\n+                d5 in[0, 3],\n+                d6 in[0, 3]\n+  )\");\n+  auto composed = ComposeIndexingMaps(indexing_map_identity_7_variables,\n+                                      indexing_map_identity_7_variables);\n+  EXPECT_EQ(composed, indexing_map_identity_7_variables);\n+}\n+\n TEST_F(IndexingMapTest, KnownEmpty_CreatingIndexingMapWithInfeasibleRange) {\n   auto indexing_map = Parse(R\"(\n     (d0) -> (d0),"
        },
        {
            "sha": "2dd3fea5e5b939e81afb1afd0e8401ccf6e785b0",
            "filename": "third_party/xla/xla/hlo/analysis/symbolic_map.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/402aeaf322152c834042189ecd3cd0d3b1688486/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/402aeaf322152c834042189ecd3cd0d3b1688486/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fanalysis%2Fsymbolic_map.h?ref=402aeaf322152c834042189ecd3cd0d3b1688486",
            "patch": "@@ -80,7 +80,7 @@ class SymbolicMap {\n     return CreateSymbolExpr(idx, num_dimensions_, ctx_);\n   }\n   int64_t GetNumResults() const { return exprs_.size(); }\n-  const llvm::SmallVector<SymbolicExpr>& GetResults() const { return exprs_; }\n+  llvm::ArrayRef<SymbolicExpr> GetResults() const { return exprs_; }\n   SymbolicExpr GetResult(unsigned idx) const { return exprs_[idx]; }\n   std::string ToString() const;\n "
        }
    ],
    "stats": {
        "total": 37,
        "additions": 36,
        "deletions": 1
    }
}