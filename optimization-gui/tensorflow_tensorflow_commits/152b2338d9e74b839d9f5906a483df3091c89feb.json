{
    "author": "felixwqp",
    "message": "Refactor xla codebase to avoid the dynamic_cast, use `ClassOf` or `DynCast` instead.\n\nPiperOrigin-RevId: 825773229",
    "sha": "152b2338d9e74b839d9f5906a483df3091c89feb",
    "files": [
        {
            "sha": "4a24466e898384f4643aecff332ea4feddb12b64",
            "filename": "third_party/xla/xla/codegen/tiling/symbolic_tile_analysis_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fsymbolic_tile_analysis_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fsymbolic_tile_analysis_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Ftiling%2Fsymbolic_tile_analysis_test.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -46,6 +46,7 @@ limitations under the License.\n #include \"xla/codegen/tiling/tiling_specification.h\"\n #include \"xla/hlo/analysis/indexing_test_utils.h\"\n #include \"xla/hlo/analysis/symbolic_expr.h\"\n+#include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n@@ -104,7 +105,7 @@ absl::flat_hash_map<int64_t, const TiledHloInstruction*> GetParametersTiling(\n   absl::flat_hash_map<int64_t, const TiledHloInstruction*> result;\n   for (const auto& instruction : tiled_hlo_computation->instructions()) {\n     const HloParameterInstruction* parameter =\n-        dynamic_cast<const HloParameterInstruction*>(instruction->hlo());\n+        DynCast<const HloParameterInstruction>(instruction->hlo());\n     if (!parameter) {\n       continue;\n     }"
        },
        {
            "sha": "28ae9585271f692744e7ced1430dce6739d3e051",
            "filename": "third_party/xla/xla/hlo/ir/hlo_computation.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_computation.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -1964,15 +1964,15 @@ void SortClonedInstructions(\n       continue;\n     }\n     ++num_mapped_instructions;\n-    if (!dynamic_cast<const HloParameterInstruction*>(instruction.get())) {\n+    if (!HloParameterInstruction::ClassOf(instruction.get())) {\n       continue;\n     }\n     mapped_index_of_last_parameter_plus_one = num_mapped_instructions;\n   }\n   auto unmapped_ptr_index =\n       [num_mapped_instructions,\n        mapped_index_of_last_parameter_plus_one](const HloInstruction* i) {\n-        if (dynamic_cast<const HloParameterInstruction*>(i)) {\n+        if (HloParameterInstruction::ClassOf(i)) {\n           if (num_mapped_instructions > 0 &&\n               mapped_index_of_last_parameter_plus_one > 0) {\n             return mapped_index_of_last_parameter_plus_one - 1;"
        },
        {
            "sha": "eea2c44bff74e8376c48a575fdde3bd4294a1d64",
            "filename": "third_party/xla/xla/hlo/ir/hlo_instructions.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fhlo_instructions.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -848,7 +848,7 @@ HloSendDoneInstruction::CloneWithNewOperandsImpl(\n     const Shape& shape, absl::Span<HloInstruction* const> new_operands,\n     HloCloneContext* context) const {\n   CHECK_EQ(new_operands.size(), 1);\n-  HloSendInstruction* send = dynamic_cast<HloSendInstruction*>(new_operands[0]);\n+  HloSendInstruction* send = DynCast<HloSendInstruction>(new_operands[0]);\n   if (send != nullptr) {\n     return std::make_unique<HloSendDoneInstruction>(send, is_host_transfer());\n   }\n@@ -907,7 +907,7 @@ HloRecvDoneInstruction::CloneWithNewOperandsImpl(\n     const Shape& shape, absl::Span<HloInstruction* const> new_operands,\n     HloCloneContext* context) const {\n   CHECK_EQ(new_operands.size(), 1);\n-  HloRecvInstruction* recv = dynamic_cast<HloRecvInstruction*>(new_operands[0]);\n+  HloRecvInstruction* recv = DynCast<HloRecvInstruction>(new_operands[0]);\n   if (recv != nullptr) {\n     return std::make_unique<HloRecvDoneInstruction>(recv, is_host_transfer());\n   }"
        },
        {
            "sha": "6779cd744bcdcf41d55f734711fa6b4ac00b479e",
            "filename": "third_party/xla/xla/hlo/parser/hlo_parser.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fparser%2Fhlo_parser.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -2296,7 +2296,7 @@ HloInstruction* HloParserImpl::CreateInstruction(  // NOLINT\n         return nullptr;\n       }\n \n-      if (dynamic_cast<const HloChannelInstruction*>(operands[0]) != nullptr) {\n+      if (HloChannelInstruction::ClassOf(operands[0])) {\n         if (channel_id != operands[0]->channel_id()) {\n           return nullptr;\n         }\n@@ -2333,7 +2333,7 @@ HloInstruction* HloParserImpl::CreateInstruction(  // NOLINT\n         return nullptr;\n       }\n \n-      if (dynamic_cast<const HloChannelInstruction*>(operands[0]) != nullptr) {\n+      if (DynCast<const HloChannelInstruction>(operands[0]) != nullptr) {\n         if (channel_id != operands[0]->channel_id()) {\n           return nullptr;\n         }"
        },
        {
            "sha": "74252ed62e01480fda59c4a26a2b8464df8eeadf",
            "filename": "third_party/xla/xla/service/call_inliner.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -33,6 +33,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"xla/hlo/ir/dfs_hlo_visitor_with_default.h\"\n+#include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -421,13 +422,13 @@ absl::StatusOr<bool> CallInliner::InlineAndLegalize(\n   }\n   if (did_node_mutate && uniquify_channel_ids_) {\n     for (HloInstruction* instruction : computation->instructions()) {\n-      if (!dynamic_cast<HloChannelInstruction*>(instruction)) {\n+      if (!HloChannelInstruction::ClassOf(instruction)) {\n         continue;\n       }\n       // Channel IDs for host transfers are part of the ABI, and can never be\n       // uniquified.\n       HloSendRecvInstruction* send_recv =\n-          dynamic_cast<HloSendRecvInstruction*>(instruction);\n+          DynCast<HloSendRecvInstruction>(instruction);\n       if (send_recv && send_recv->is_host_transfer()) {\n         continue;\n       }\n@@ -448,7 +449,7 @@ absl::StatusOr<bool> CallInliner::RunWithInlineMap(\n     for (HloComputation* computation : module->computations()) {\n       for (HloInstruction* instruction : computation->instructions()) {\n         HloChannelInstruction* channel_instruction =\n-            dynamic_cast<HloChannelInstruction*>(instruction);\n+            DynCast<HloChannelInstruction>(instruction);\n         if (channel_instruction &&\n             channel_instruction->channel_id().has_value()) {\n           next_unique_channel_id_ ="
        },
        {
            "sha": "a5fd9fbae7f7ec48fb75945022ff5a8a89e001eb",
            "filename": "third_party/xla/xla/service/call_inliner_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcall_inliner_test.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -26,6 +26,7 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/status/status_matchers.h\"\n #include \"absl/strings/string_view.h\"\n+#include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n@@ -980,8 +981,7 @@ ENTRY main {\n   ASSERT_THAT(call_inliner.Run(m.get()), absl_testing::IsOkAndHolds(true));\n   HloComputation* entry = m->entry_computation();\n   for (HloInstruction* inst : entry->instructions()) {\n-    HloSendRecvInstruction* send_recv =\n-        dynamic_cast<HloSendRecvInstruction*>(inst);\n+    HloSendRecvInstruction* send_recv = DynCast<HloSendRecvInstruction>(inst);\n     if (send_recv && send_recv->is_host_transfer()) {\n       EXPECT_EQ(send_recv->channel_id(), 1);\n     }\n@@ -1025,8 +1025,7 @@ ENTRY main {\n   absl::flat_hash_set<int64_t> channel_ids;\n   for (HloComputation* comp : m->computations()) {\n     for (HloInstruction* inst : comp->instructions()) {\n-      HloChannelInstruction* channel =\n-          dynamic_cast<HloChannelInstruction*>(inst);\n+      HloChannelInstruction* channel = DynCast<HloChannelInstruction>(inst);\n       if (channel && channel->channel_id().has_value()) {\n         channel_ids.insert(channel->channel_id().value());\n       }"
        },
        {
            "sha": "2391e3f3454c1794140f0d12a55e210ec7f73f96",
            "filename": "third_party/xla/xla/service/collective_pipeliner_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -2812,7 +2812,7 @@ TEST_F(CollectivePipelinerTest, TransformRecvSendBackwards) {\n   auto should_pipeline = [](const HloInstruction* instruction) {\n     if (!HloPredicateIsOp<HloOpcode::kRecvDone>(instruction)) return false;\n     const HloRecvDoneInstruction* recv_done =\n-        dynamic_cast<const HloRecvDoneInstruction*>(instruction);\n+        DynCast<const HloRecvDoneInstruction>(instruction);\n     if (recv_done->is_host_transfer()) return false;\n     // Check that the recv-done is used for non-trivial computation, which can\n     // also help avoid repeatedly pipelining a loop.\n@@ -2910,7 +2910,7 @@ TEST_F(CollectivePipelinerTest,\n         !HloPredicateIsOp<HloOpcode::kSend>(instr))\n       return false;\n     const HloSendRecvInstruction* send_recv =\n-        dynamic_cast<const HloSendRecvInstruction*>(instr);\n+        DynCast<const HloSendRecvInstruction>(instr);\n     // Check that the Send or Recv is used for non-trivial computation, which\n     // also help avoid repeatedly pipelining a loop.\n     return (send_recv->user_count() == 1 && send_recv->parent() != nullptr &&"
        },
        {
            "sha": "c320df672ee8387dcb12a6f4c1b398c70fe061d8",
            "filename": "third_party/xla/xla/service/gpu/transforms/collectives/collective_ops_utils.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcollectives%2Fcollective_ops_utils.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcollectives%2Fcollective_ops_utils.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fcollectives%2Fcollective_ops_utils.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n@@ -69,8 +70,8 @@ absl::StatusOr<CommunicationMetadata> CommunicationContext(\n     const HloChannelInstruction& instr, int num_devices_per_host) {\n   absl::flat_hash_map<int64_t, size_t> node_to_participant_count;\n \n-  if (auto* collective =\n-          dynamic_cast<const HloCollectiveInstruction*>(&instr)) {\n+  if (const HloCollectiveInstruction* collective =\n+          DynCast<HloCollectiveInstruction>(&instr)) {\n     for (const ReplicaGroup& replica_group :\n          collective->device_list().replica_groups()) {\n       absl::flat_hash_map<int64_t, size_t> buffer;\n@@ -88,9 +89,10 @@ absl::StatusOr<CommunicationMetadata> CommunicationContext(\n         node_to_participant_count = buffer;\n       }\n     }\n-  } else if (auto* permute =\n-                 dynamic_cast<const HloCollectivePermuteInstruction*>(&instr)) {\n-    for (const auto& [source, target] : permute->source_target_pairs()) {\n+  } else if (const HloCollectivePermuteInstruction* collective_permute =\n+                 DynCast<HloCollectivePermuteInstruction>(&instr)) {\n+    for (const auto& [source, target] :\n+         collective_permute->source_target_pairs()) {\n       int64_t source_node = source / num_devices_per_host;\n       int64_t target_node = target / num_devices_per_host;\n       node_to_participant_count[source_node]++;"
        },
        {
            "sha": "de7d4c804f8ea8fa2b5e778b685597b65da542c9",
            "filename": "third_party/xla/xla/service/gpu/transforms/gemm_rewriter.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_rewriter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_rewriter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Fgemm_rewriter.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -2572,8 +2572,8 @@ class GemmWorkspaceRewriteVisitor : public DfsHloRewriteVisitor {\n \n     if (instr->shape().IsTuple()) {\n       for (auto user : instr->users()) {\n-        auto user_get_tuple =\n-            dynamic_cast<HloGetTupleElementInstruction*>(user);\n+        HloGetTupleElementInstruction* user_get_tuple =\n+            DynCast<HloGetTupleElementInstruction>(user);\n         TF_RET_CHECK(user_get_tuple);\n         HloInstruction* get_output =\n             instr->AddInstruction(HloInstruction::CreateGetTupleElement("
        },
        {
            "sha": "3a65f7a64b757a29b923cddd38489aab35e8d3ce",
            "filename": "third_party/xla/xla/service/hlo_verifier.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -3210,7 +3210,7 @@ int64_t CountWriters(const HloInstruction* inst,\n int64_t CountWritersInUser(const HloInstruction* inst,\n                            absl::Span<const int64_t> shape_index,\n                            const HloInstruction* user) {\n-  if (dynamic_cast<const HloCallableInstruction*>(user) ||\n+  if (HloCallableInstruction::ClassOf(user) ||\n       user->opcode() == HloOpcode::kWhile ||\n       user->opcode() == HloOpcode::kConditional) {\n     // For HloCallableInstruction, we may overcount here if we will allow"
        },
        {
            "sha": "204d1425ce6404b17b4989fb948c43acfa2cedba",
            "filename": "third_party/xla/xla/service/layout_assignment.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/152b2338d9e74b839d9f5906a483df3091c89feb/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Flayout_assignment.cc?ref=152b2338d9e74b839d9f5906a483df3091c89feb",
            "patch": "@@ -309,7 +309,7 @@ absl::Status LayoutAssignment::SetBufferLayout(const Layout& layout,\n           << buffer_constraint->ToString();\n   PushAddedConstraints(buffer_constraint.get());\n   const HloInstruction* instruction = buffer.instruction();\n-  if (dynamic_cast<const HloCallableInstruction*>(instruction) != nullptr) {\n+  if (HloCallableInstruction::ClassOf(instruction)) {\n     // Check and propagate via output-operand aliasing\n     VLOG(3) << \"Propagating aliasing:\" << instruction->ToString() << \"\\n\";\n     for (const std::pair<ShapeIndex, std::pair<int64_t, ShapeIndex>>&"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 28,
        "deletions": 25
    }
}