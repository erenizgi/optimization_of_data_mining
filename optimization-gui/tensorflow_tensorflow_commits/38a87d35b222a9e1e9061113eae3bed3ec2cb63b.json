{
    "author": "tensorflower-gardener",
    "message": "[SymbolicMap] Add method to replace an expression inside SymbolicMap\n\nPiperOrigin-RevId: 800426363",
    "sha": "38a87d35b222a9e1e9061113eae3bed3ec2cb63b",
    "files": [
        {
            "sha": "f52e5938a9a2c3c06a8c437627262c4990117bff",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/38a87d35b222a9e1e9061113eae3bed3ec2cb63b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/38a87d35b222a9e1e9061113eae3bed3ec2cb63b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.cc?ref=38a87d35b222a9e1e9061113eae3bed3ec2cb63b",
            "patch": "@@ -135,6 +135,23 @@ SymbolicMap SymbolicMap::Compose(const SymbolicMap& other) const {\n                                this_symbol_replacements, new_dims, new_syms);\n }\n \n+SymbolicMap SymbolicMap::Replace(SymbolicExpr expr,\n+                                 SymbolicExpr replacement) const {\n+  std::vector<SymbolicExpr> new_exprs;\n+  new_exprs.reserve(exprs_.size());\n+  bool changed = false;\n+  for (const auto& e : exprs_) {\n+    SymbolicExpr new_expr = e.Replace(expr, replacement);\n+    changed |= new_expr != e;\n+    new_exprs.push_back(std::move(new_expr));\n+  }\n+\n+  if (!changed) {\n+    return *this;\n+  }\n+  return SymbolicMap(ctx_, num_dimensions_, num_symbols_, std::move(new_exprs));\n+}\n+\n bool SymbolicMap::operator==(const SymbolicMap& other) const {\n   return ctx_ == other.ctx_ && num_dimensions_ == other.num_dimensions_ &&\n          num_symbols_ == other.num_symbols_ && exprs_ == other.exprs_;"
        },
        {
            "sha": "a8831417dccb1e72fbcf9dce63b6296f3a0e1474",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/38a87d35b222a9e1e9061113eae3bed3ec2cb63b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/38a87d35b222a9e1e9061113eae3bed3ec2cb63b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map.h?ref=38a87d35b222a9e1e9061113eae3bed3ec2cb63b",
            "patch": "@@ -79,6 +79,8 @@ class SymbolicMap {\n   // this.compose(other): (d0, s0, s1, s2) -> (d0 * 2 + 3 * s1 + s0, d0 + s2)\n   SymbolicMap Compose(const SymbolicMap& other) const;\n \n+  SymbolicMap Replace(SymbolicExpr expr, SymbolicExpr replacement) const;\n+\n   bool operator==(const SymbolicMap& other) const;\n   bool operator!=(const SymbolicMap& other) const { return !(*this == other); }\n "
        },
        {
            "sha": "658ba614bc7a4138f2b1eab043d0341506ecfe7f",
            "filename": "third_party/xla/xla/service/gpu/model/experimental/symbolic_map_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/38a87d35b222a9e1e9061113eae3bed3ec2cb63b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/38a87d35b222a9e1e9061113eae3bed3ec2cb63b/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fmodel%2Fexperimental%2Fsymbolic_map_test.cc?ref=38a87d35b222a9e1e9061113eae3bed3ec2cb63b",
            "patch": "@@ -163,6 +163,28 @@ TEST(SymbolicMapTest, Compose) {\n               ElementsAre(d0 + reindexed_map1_s0, d1 * 2));\n }\n \n+TEST(SymbolicMapTest, Replace) {\n+  SymbolicExprContext ctx;\n+  SymbolicExpr d0 = ctx.CreateVariable(0);\n+  SymbolicExpr d1 = ctx.CreateVariable(1);\n+  SymbolicExpr c2 = ctx.CreateConstant(2);\n+  SymbolicExpr c5 = ctx.CreateConstant(5);\n+\n+  SymbolicExpr expr0 = (d0 + c2) * d1;\n+  SymbolicExpr expr1 = d1 + c2;\n+  SymbolicMap map = SymbolicMap::Get(&ctx, 2, 0, {expr0, expr1});\n+\n+  SymbolicMap replaced_both_exprs = map.Replace(c2, d0);\n+  EXPECT_THAT(replaced_both_exprs.GetResults(),\n+              ElementsAre((d0 + d0) * d1, d1 + d0));\n+\n+  SymbolicMap replaced_just_one = map.Replace(d1 + c2, c5);\n+  EXPECT_THAT(replaced_just_one.GetResults(), ElementsAre(expr0, c5));\n+\n+  SymbolicMap no_replacement_map = map.Replace(ctx.CreateVariable(99), c5);\n+  EXPECT_EQ(no_replacement_map, map);\n+}\n+\n }  // namespace\n }  // namespace gpu\n }  // namespace xla"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 41,
        "deletions": 0
    }
}