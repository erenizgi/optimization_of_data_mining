{
    "author": "ezhulenev",
    "message": "[xla:ffi] Remove deprecated deleter field from XLA_FFI_State_Set_Args\n\nThis is an ABI breaking change, but the only user of this API was migrated to the new TypeInfo registration and it should not break anyone.\n\nPiperOrigin-RevId: 832099963",
    "sha": "9a65af12b816440f9fba7db2deb9b7ca06e465a8",
    "files": [
        {
            "sha": "00c400b79eecf8185db2485f07560ddc3b916173",
            "filename": "third_party/xla/xla/ffi/api/c_api.h",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fc_api.h?ref=9a65af12b816440f9fba7db2deb9b7ca06e465a8",
            "patch": "@@ -547,10 +547,9 @@ struct XLA_FFI_State_Set_Args {\n   XLA_FFI_ExecutionContext* ctx;\n   XLA_FFI_TypeId* type_id;\n   void* state;\n-  void (*deleter)(void* state);\n };\n \n-XLA_FFI_DEFINE_STRUCT_TRAITS(XLA_FFI_State_Set_Args, deleter);\n+XLA_FFI_DEFINE_STRUCT_TRAITS(XLA_FFI_State_Set_Args, state);\n \n // Sets execution state to the `state` of type `type_id`. Returns an error if\n // state already set."
        },
        {
            "sha": "0ec081f89baabf5c29b8056179d99c5b53e1be6b",
            "filename": "third_party/xla/xla/ffi/api/ffi.h",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h?ref=9a65af12b816440f9fba7db2deb9b7ca06e465a8",
            "patch": "@@ -1230,7 +1230,6 @@ struct ResultEncoding<ExecutionStage::kInstantiate,\n       args.ctx = ctx;\n       args.type_id = &T::id;\n       args.state = state.value().release();\n-      args.deleter = +[](void* state) { delete reinterpret_cast<T*>(state); };\n       return api->XLA_FFI_State_Set(&args);\n     }\n \n@@ -1515,7 +1514,7 @@ inline ThreadPool::ThreadPool(const XLA_FFI_Api* api,\n //===----------------------------------------------------------------------===//\n \n template <typename T>\n-inline constexpr XLA_FFI_TypeInfo MakeTypeInfo() {\n+constexpr XLA_FFI_TypeInfo MakeTypeInfo() {\n   return XLA_FFI_TypeInfo{\n       XLA_FFI_TypeInfo_STRUCT_SIZE,\n       /*extension_start=*/nullptr,"
        },
        {
            "sha": "2aabbb0a1ce1aa998169fec37d30cb1750572a9a",
            "filename": "third_party/xla/xla/ffi/api/ffi_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi_test.cc?ref=9a65af12b816440f9fba7db2deb9b7ca06e465a8",
            "patch": "@@ -1353,15 +1353,16 @@ TEST(FfiTest, UserData) {\n \n struct MyState {\n   static TypeId id;\n+  static TypeInfo info;\n \n   explicit MyState(int32_t value) : value(value) {}\n   int32_t value;\n };\n \n TypeId MyState::id = {};  // zero-initialize type id\n-static constexpr auto kMyStateTypeInfo = MakeTypeInfo<MyState>();\n+TypeInfo MyState::info = MakeTypeInfo<MyState>();\n \n-XLA_FFI_REGISTER_TYPE(GetXlaFfiApi(), \"state\", &MyState::id, &kMyStateTypeInfo);\n+XLA_FFI_REGISTER_TYPE(GetXlaFfiApi(), \"state\", &MyState::id, &MyState::info);\n \n TEST(FfiTest, StatefulHandler) {\n   ExecutionState execution_state;"
        },
        {
            "sha": "d5fce70fc8a2a2982dd574d163cf2b35976d653c",
            "filename": "third_party/xla/xla/ffi/execution_state.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fexecution_state.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fexecution_state.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fexecution_state.cc?ref=9a65af12b816440f9fba7db2deb9b7ca06e465a8",
            "patch": "@@ -15,7 +15,6 @@ limitations under the License.\n \n #include \"xla/ffi/execution_state.h\"\n \n-#include \"absl/base/attributes.h\"\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n@@ -44,12 +43,6 @@ absl::Status ExecutionState::Set(TypeId type_id, void* state) {\n   return Set(type_id, type_info, state);\n }\n \n-ABSL_DEPRECATED(\"FFI users must rely in TypeInfo registration\")\n-absl::Status ExecutionState::Set(TypeId type_id, void* state,\n-                                 void (*deleter)(void*)) {\n-  return Set(type_id, TypeInfo{deleter}, state);\n-}\n-\n absl::Status ExecutionState::Set(TypeId type_id, TypeInfo type_info,\n                                  void* state) {\n   DCHECK(state && type_info.deleter) << \"State and deleter must not be null\";"
        },
        {
            "sha": "549823fcd24bc978d9c61896cdaf170d57e17ad1",
            "filename": "third_party/xla/xla/ffi/execution_state.h",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fexecution_state.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fexecution_state.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fexecution_state.h?ref=9a65af12b816440f9fba7db2deb9b7ca06e465a8",
            "patch": "@@ -54,10 +54,6 @@ class ExecutionState {\n   // already set, or if type id is not supported as a state.\n   absl::Status Set(TypeId type_id, void* state);\n \n-  // Sets opaque state with a given type id and custom deleter. Returns an error\n-  // if state is already set, or if type id is not supported as a state.\n-  absl::Status Set(TypeId type_id, void* state, void (*deleter)(void*));\n-\n   // Returns opaque state of the given type id. If set state type id does not\n   // match the requested one, returns an error.\n   absl::StatusOr<void*> Get(TypeId type_id) const;"
        },
        {
            "sha": "d0e65a84299e340088cf68d09b8536165e60db22",
            "filename": "third_party/xla/xla/ffi/ffi_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fffi_api.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9a65af12b816440f9fba7db2deb9b7ca06e465a8/third_party%2Fxla%2Fxla%2Fffi%2Fffi_api.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fffi_api.cc?ref=9a65af12b816440f9fba7db2deb9b7ca06e465a8",
            "patch": "@@ -739,16 +739,8 @@ static XLA_FFI_Error* XLA_FFI_State_Set(XLA_FFI_State_Set_Args* args) {\n \n   DCHECK(args->ctx->execution_state) << \"ExecutionState must be set\";\n \n-  absl::Status status;\n-  if (args->deleter == nullptr) {\n-    status = args->ctx->execution_state->Set(\n-        TypeRegistry::TypeId(args->type_id->type_id), args->state);\n-  } else {\n-    status = args->ctx->execution_state->Set(\n-        TypeRegistry::TypeId(args->type_id->type_id), args->state,\n-        args->deleter);\n-  }\n-\n+  absl::Status status = args->ctx->execution_state->Set(\n+      TypeRegistry::TypeId(args->type_id->type_id), args->state);\n   if (!status.ok()) {\n     return new XLA_FFI_Error{std::move(status)};\n   }"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 7,
        "deletions": 27
    }
}