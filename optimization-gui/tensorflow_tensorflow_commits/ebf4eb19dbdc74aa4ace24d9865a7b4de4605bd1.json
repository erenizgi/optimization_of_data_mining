{
    "author": "hanrach9",
    "message": " Move dlpack_types and strides out of xla/python to xla/util.\n\nPiperOrigin-RevId: 839995550",
    "sha": "ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1",
    "files": [
        {
            "sha": "3e503bd2dded2e499919623e7c577baa03064831",
            "filename": "third_party/xla/xla/util/BUILD",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil%2FBUILD?ref=ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1",
            "patch": "@@ -0,0 +1,49 @@\n+load(\n+    \"//xla/tsl:tsl.bzl\",\n+    \"internal_visibility\",\n+)\n+load(\"//xla/tsl:tsl.default.bzl\", \"get_compatible_with_libtpu_portable\")\n+load(\"//xla/tsl/platform:rules_cc.bzl\", \"cc_library\")\n+\n+package_group(\n+    name = \"friends\",\n+    includes = [\n+        \"//xla:friends\",\n+        \"//xla:internal\",\n+    ],\n+)\n+\n+package(\n+    # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n+    default_visibility = internal_visibility([\"//xla:internal\"]),\n+    licenses = [\"notice\"],\n+)\n+\n+cc_library(\n+    name = \"dlpack_types\",\n+    srcs = [\"dlpack_types.cc\"],\n+    hdrs = [\"dlpack_types.h\"],\n+    compatible_with = get_compatible_with_libtpu_portable(),\n+    visibility = internal_visibility([\":friends\"]),\n+    deps = [\n+        \"//xla:util\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@dlpack\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"strides\",\n+    srcs = [\"strides.cc\"],\n+    hdrs = [\"strides.h\"],\n+    compatible_with = get_compatible_with_libtpu_portable(),\n+    visibility = internal_visibility([\":friends\"]),\n+    deps = [\n+        \"//xla:shape_util\",\n+        \"//xla:xla_data_proto_cc\",\n+        \"//xla/tsl/platform:logging\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)"
        },
        {
            "sha": "393e6e99c11e55815a9d54ee48f0fbe4a9502aad",
            "filename": "third_party/xla/xla/util/dlpack_types.cc",
            "status": "added",
            "additions": 223,
            "deletions": 0,
            "changes": 223,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fdlpack_types.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fdlpack_types.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil%2Fdlpack_types.cc?ref=ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1",
            "patch": "@@ -0,0 +1,223 @@\n+/* Copyright 2025 The JAX Authors\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/util/dlpack_types.h\"\n+\n+#include \"absl/status/statusor.h\"\n+#include \"include/dlpack/dlpack.h\"\n+#include \"xla/util.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+absl::StatusOr<DLDataType> PrimitiveTypeToDLDataType(PrimitiveType type) {\n+  switch (type) {\n+    case S8:\n+      return DLDataType{kDLInt, 8, 1};\n+    case S16:\n+      return DLDataType{kDLInt, 16, 1};\n+    case S32:\n+      return DLDataType{kDLInt, 32, 1};\n+    case S64:\n+      return DLDataType{kDLInt, 64, 1};\n+    case U8:\n+      return DLDataType{kDLUInt, 8, 1};\n+    case U16:\n+      return DLDataType{kDLUInt, 16, 1};\n+    case U32:\n+      return DLDataType{kDLUInt, 32, 1};\n+    case U64:\n+      return DLDataType{kDLUInt, 64, 1};\n+    case F4E2M1FN:\n+      return DLDataType{kDLFloat4_e2m1fn, 4, 1};\n+    case F8E3M4:\n+      return DLDataType{kDLFloat8_e3m4, 8, 1};\n+    case F8E4M3:\n+      return DLDataType{kDLFloat8_e4m3, 8, 1};\n+    case F8E4M3B11FNUZ:\n+      return DLDataType{kDLFloat8_e4m3b11fnuz, 8, 1};\n+    case F8E4M3FN:\n+      return DLDataType{kDLFloat8_e4m3fn, 8, 1};\n+    case F8E4M3FNUZ:\n+      return DLDataType{kDLFloat8_e4m3fnuz, 8, 1};\n+    case F8E5M2:\n+      return DLDataType{kDLFloat8_e5m2, 8, 1};\n+    case F8E5M2FNUZ:\n+      return DLDataType{kDLFloat8_e5m2fnuz, 8, 1};\n+    case F8E8M0FNU:\n+      return DLDataType{kDLFloat8_e8m0fnu, 8, 1};\n+    case BF16:\n+      return DLDataType{kDLBfloat, 16, 1};\n+    case F16:\n+      return DLDataType{kDLFloat, 16, 1};\n+    case F32:\n+      return DLDataType{kDLFloat, 32, 1};\n+    case F64:\n+      return DLDataType{kDLFloat, 64, 1};\n+    case PRED:\n+      return DLDataType{kDLBool, 8, 1};\n+    case C64:\n+      return DLDataType{kDLComplex, 64, 1};\n+    case C128:\n+      return DLDataType{kDLComplex, 128, 1};\n+    default:\n+      return Unimplemented(\"XLA type %s has no DLPack equivalent\",\n+                           PrimitiveType_Name(type));\n+  }\n+}\n+\n+absl::StatusOr<PrimitiveType> DLDataTypeToPrimitiveType(DLDataType type) {\n+  if (type.lanes != 1) {\n+    return Unimplemented(\"DLPack types with lanes != 1 not implemented, got %d\",\n+                         type.lanes);\n+  }\n+  switch (type.code) {\n+    case kDLBool:\n+      switch (type.bits) {\n+        case 8:\n+          return PRED;\n+        default:\n+          return Unimplemented(\n+              \"Only 8-bit DLPack booleans are supported, got %d bits\",\n+              type.bits);\n+      }\n+    case kDLInt:\n+      switch (type.bits) {\n+        case 8:\n+          return S8;\n+        case 16:\n+          return S16;\n+        case 32:\n+          return S32;\n+        case 64:\n+          return S64;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack integer width: %d bits\",\n+              type.bits);\n+      }\n+    case kDLUInt:\n+      switch (type.bits) {\n+        case 8:\n+          return U8;\n+        case 16:\n+          return U16;\n+        case 32:\n+          return U32;\n+        case 64:\n+          return U64;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack unsigned integer width: %d bits\",\n+              type.bits);\n+      }\n+    case kDLFloat4_e2m1fn:\n+      if (type.bits == 4) {\n+        return F4E2M1FN;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float4_e2m1fn width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e3m4:\n+      if (type.bits == 8) {\n+        return F8E3M4;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e3m4 width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3:\n+      if (type.bits == 8) {\n+        return F8E4M3;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3 width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3b11fnuz:\n+      if (type.bits == 8) {\n+        return F8E4M3B11FNUZ;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3b11fnuz width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3fn:\n+      if (type.bits == 8) {\n+        return F8E4M3FN;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3fn width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e4m3fnuz:\n+      if (type.bits == 8) {\n+        return F8E4M3FNUZ;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e4m3fnuz width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e5m2:\n+      if (type.bits == 8) {\n+        return F8E5M2;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e5m2 width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e5m2fnuz:\n+      if (type.bits == 8) {\n+        return F8E5M2FNUZ;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e5m2fnuz width: %d bits\",\n+          type.bits);\n+    case kDLFloat8_e8m0fnu:\n+      if (type.bits == 8) {\n+        return F8E8M0FNU;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack float8_e8m0fnu width: %d bits\",\n+          type.bits);\n+    case kDLBfloat:\n+      if (type.bits == 16) {\n+        return BF16;\n+      }\n+      return Unimplemented(\n+          \"Invalid or unsupported DLPack bfloat width: %d bits\", type.bits);\n+    case kDLFloat:\n+      switch (type.bits) {\n+        case 16:\n+          return F16;\n+        case 32:\n+          return F32;\n+        case 64:\n+          return F64;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack float width: %d bits\", type.bits);\n+      }\n+    case kDLComplex:\n+      switch (type.bits) {\n+        case 64:\n+          return C64;\n+        case 128:\n+          return C128;\n+        default:\n+          return Unimplemented(\n+              \"Invalid or unsupported DLPack complex width: %d bits\",\n+              type.bits);\n+      }\n+    default:\n+      return Unimplemented(\"Unknown or invalid DLPack type code %d\", type.code);\n+  }\n+}\n+\n+}  // namespace xla"
        },
        {
            "sha": "ac1acf89afc4cf72c3823d3aa0f41d67bf38cccd",
            "filename": "third_party/xla/xla/util/dlpack_types.h",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fdlpack_types.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fdlpack_types.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil%2Fdlpack_types.h?ref=ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1",
            "patch": "@@ -0,0 +1,31 @@\n+/* Copyright 2025 The JAX Authors\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_UTIL_DLPACK_TYPES_H_\n+#define XLA_UTIL_DLPACK_TYPES_H_\n+\n+#include \"absl/status/statusor.h\"\n+#include \"include/dlpack/dlpack.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+absl::StatusOr<DLDataType> PrimitiveTypeToDLDataType(PrimitiveType type);\n+absl::StatusOr<PrimitiveType> DLDataTypeToPrimitiveType(DLDataType type);\n+\n+\n+}  // namespace xla\n+\n+#endif  // XLA_UTIL_DLPACK_TYPES_H_"
        },
        {
            "sha": "1d1fff4062ac814893fd28d280b07f42fbc1dc03",
            "filename": "third_party/xla/xla/util/strides.cc",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fstrides.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fstrides.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil%2Fstrides.cc?ref=ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1",
            "patch": "@@ -0,0 +1,68 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/util/strides.h\"\n+\n+#include <cstdint>\n+#include <vector>\n+\n+#include \"absl/types/span.h\"\n+#include \"xla/layout.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n+#include \"xla/tsl/platform/logging.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+// Returns the strides for `shape`.\n+std::vector<int64_t> ByteStridesForShape(const Shape& shape) {\n+  std::vector<int64_t> strides;\n+  CHECK(shape.IsArray());\n+  CHECK(shape.has_layout());\n+  return ByteStridesForShape(shape.element_type(), shape.dimensions(),\n+                             shape.layout());\n+}\n+\n+static std::vector<int64_t> StridesForShapeHelper(\n+    PrimitiveType element_type, absl::Span<const int64_t> dimensions,\n+    const xla::Layout& layout, int64_t innermost_stride_size) {\n+  CHECK_EQ(dimensions.size(), layout.minor_to_major().size());\n+  std::vector<int64_t> strides;\n+  strides.resize(dimensions.size());\n+  int64_t stride = innermost_stride_size;\n+  for (int i : layout.minor_to_major()) {\n+    strides[i] = stride;\n+    stride *= dimensions[i];\n+  }\n+  return strides;\n+}\n+\n+std::vector<int64_t> ByteStridesForShape(PrimitiveType element_type,\n+                                         absl::Span<const int64_t> dimensions,\n+                                         const xla::Layout& layout) {\n+  return StridesForShapeHelper(\n+      element_type, dimensions, layout,\n+      ShapeUtil::ByteSizeOfPrimitiveType(element_type));\n+}\n+\n+std::vector<int64_t> StridesForShape(PrimitiveType element_type,\n+                                     absl::Span<const int64_t> dimensions,\n+                                     const xla::Layout& layout) {\n+  return StridesForShapeHelper(element_type, dimensions, layout,\n+                               /*innermost_stride_size=*/1);\n+}\n+\n+}  // namespace xla"
        },
        {
            "sha": "b201ad3cd325a7f84e5a27aee888bdee0581fb61",
            "filename": "third_party/xla/xla/util/strides.h",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fstrides.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1/third_party%2Fxla%2Fxla%2Futil%2Fstrides.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Futil%2Fstrides.h?ref=ebf4eb19dbdc74aa4ace24d9865a7b4de4605bd1",
            "patch": "@@ -0,0 +1,40 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_UTIL_STRIDES_H_\n+#define XLA_UTIL_STRIDES_H_\n+\n+#include <cstdint>\n+#include <vector>\n+\n+#include \"absl/types/span.h\"\n+#include \"xla/layout.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/xla_data.pb.h\"\n+\n+namespace xla {\n+\n+// Returns the strides for `shape`.\n+std::vector<int64_t> ByteStridesForShape(const Shape& shape);\n+std::vector<int64_t> ByteStridesForShape(PrimitiveType element_type,\n+                                         absl::Span<const int64_t> dimensions,\n+                                         const xla::Layout& layout);\n+std::vector<int64_t> StridesForShape(PrimitiveType element_type,\n+                                     absl::Span<const int64_t> dimensions,\n+                                     const xla::Layout& layout);\n+\n+}  // namespace xla\n+\n+#endif  // XLA_UTIL_STRIDES_H_"
        }
    ],
    "stats": {
        "total": 411,
        "additions": 411,
        "deletions": 0
    }
}