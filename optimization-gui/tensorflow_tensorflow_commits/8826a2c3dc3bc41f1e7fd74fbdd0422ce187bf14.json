{
    "author": "tensorflower-gardener",
    "message": "[XLA:GPU] add a unit test from spmd_partitioner_test to collective_ops_e2e_test\n\nPiperOrigin-RevId: 834022184",
    "sha": "8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14",
    "files": [
        {
            "sha": "d486552e75de646ed08e53e062140825bf9ff557",
            "filename": "third_party/xla/xla/service/spmd/spmd_partitioner_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fspmd%2Fspmd_partitioner_test.cc?ref=8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14",
            "patch": "@@ -14915,8 +14915,6 @@ ENTRY entry {\n                                _, _, _, _));\n }\n \n-// TODO: fix this test; right now it breaks in collective_ops_e2e_test.cc, even\n-// though it passes the SPMD partitioner unit test.\n TEST_P(SpmdPartitioningTest,\n        KeepPartitionedNonSlicedDimensionWithConstantIndices) {\n   const char* const hlo_string = R\"("
        },
        {
            "sha": "7faa61e850c319b4b61aa30bc41c6d5685ff0fff",
            "filename": "third_party/xla/xla/tests/collective_ops_e2e_test.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_ops_e2e_test.cc?ref=8826a2c3dc3bc41f1e7fd74fbdd0422ce187bf14",
            "patch": "@@ -1764,6 +1764,30 @@ TEST_F(CollectiveOpsTestE2EShardedUnsharded,\n                                        /*enable_enzyme_comms_opt=*/false);\n }\n \n+TEST_F(CollectiveOpsTestE2EShardedUnsharded,\n+       KeepPartitionedNonSlicedDimensionWithConstantIndices) {\n+  const std::string hlo_text = R\"(\n+    HloModule module, entry_computation_layout={(bf16[16,192,192,384]{3,2,1,0}, bf16[16,128,128,384]{3,2,1,0})->bf16[16,224,224,384]{3,2,1,0}}, num_partitions=8\n+\n+    ENTRY entry {\n+      p1 = bf16[16,192,192,384]{3,2,1,0} parameter(0), sharding={replicated}\n+      p2 = bf16[16,128,128,384]{3,2,1,0} parameter(1), sharding={replicated}\n+      c1 = bf16[16,192,192,384]{3,2,1,0} copy(p1), sharding={devices=[2,2,2,1]<=[8]}\n+      c2 = bf16[16,128,128,384]{3,2,1,0} copy(p2), sharding={devices=[2,2,2,1]<=[8]}\n+      constant.1163 = bf16[] constant(0), sharding={replicated}\n+      constant.1165 = s32[] constant(0), sharding={replicated}\n+      pad.179 = bf16[16,224,224,384]{3,2,1,0} pad(c1, constant.1163), padding=0_0x16_16x16_16x0_0, sharding={devices=[2,2,2,1]<=[8]}\n+      add.439 = bf16[16,128,128,384]{3,2,1,0} add(c2, c2), sharding={devices=[2,2,2,1]<=[8]}\n+      constant.1070 = s32[] constant(48), sharding={replicated}\n+      dynamic-update-slice.128 = bf16[16,224,224,384]{3,2,1,0} dynamic-update-slice(pad.179, add.439, constant.1165, constant.1070, constant.1070, /*index=5*/constant.1165), sharding={devices=[2,2,2,1]<=[8]}\n+      ROOT c = bf16[16,224,224,384]{3,2,1,0} copy(dynamic-update-slice.128), sharding={devices=[2,2,2,1]<=[8]}\n+    })\";\n+  CollectiveOpsCompareShardedUnsharded(hlo_text, /*num_partitions=*/8,\n+                                       /*enable_enzyme_comms_opt=*/true);\n+  CollectiveOpsCompareShardedUnsharded(hlo_text, /*num_partitions=*/8,\n+                                       /*enable_enzyme_comms_opt=*/false);\n+}\n+\n TEST_F(CollectiveOpsTestE2EShardedUnsharded, DotBatchAndNonContracting) {\n   const std::string hlo_text = R\"(\n HloModule module, entry_computation_layout={(f32[4,16,8]{2,1,0}, f32[4,4,8]{2,1,0})->f32[4,16,4]{2,1,0}}, num_partitions=2"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 24,
        "deletions": 2
    }
}