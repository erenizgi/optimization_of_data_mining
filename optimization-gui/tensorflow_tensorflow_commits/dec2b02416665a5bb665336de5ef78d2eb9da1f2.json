{
    "author": "amd-songpiao",
    "message": "PR #31348:  [ROCm] added rocm7 support to EnablePeerAccess\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31348\n\nSince rocm7, hipGetLastError returns last error even if last call was successful. This change makes it possible to work correctly with rocm7. We need to call hipGetLastError to reset per thread error state.\n\nEspecially, it fixed the failed test in TransformerEngine compiled with rocm7, `pytest -vvv -s tests/jax/test_distributed_layernorm_mlp.py::TestDistributedLayernormMLP::test_layernorm_fp8_mlp_primitive[True-bfloat16-activation_type0-input_shape0-mesh_config1]`\n\n@xla-rotation could you review my PR, please?\n\nCopybara import of the project:\n\n--\n0b72c66a759147a9f85ca0e3bc7c59e33d0ac9b8 by songlin <Songlin.Piao@amd.com>:\n\nadded rocm7 support to EnablePeerAccess\n\n--\n5166268be4e1246a960b4bef687bb8e4122ed9bf by songlin <Songlin.Piao@amd.com>:\n\nuse wrap namespace, clang-format and add comments\n\nMerging this change closes #31348\n\nPiperOrigin-RevId: 831263261",
    "sha": "dec2b02416665a5bb665336de5ef78d2eb9da1f2",
    "files": [
        {
            "sha": "83064ef830fef624d15be5113ff559db6e8a72ce",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_driver_wrapper.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dec2b02416665a5bb665336de5ef78d2eb9da1f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_driver_wrapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dec2b02416665a5bb665336de5ef78d2eb9da1f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_driver_wrapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_driver_wrapper.h?ref=dec2b02416665a5bb665336de5ef78d2eb9da1f2",
            "patch": "@@ -49,8 +49,8 @@ namespace wrap {\n   auto hipSymbolName(Args... args) -> decltype(::hipSymbolName(args...)) {  \\\n     using FuncPtrT = std::add_pointer<decltype(::hipSymbolName)>::type;     \\\n     static FuncPtrT loaded = []() -> FuncPtrT {                             \\\n-      static const char *kName = TO_STR(hipSymbolName);                     \\\n-      void *f;                                                              \\\n+      static const char* kName = TO_STR(hipSymbolName);                     \\\n+      void* f;                                                              \\\n       auto s = tsl::Env::Default()->GetSymbolFromLibrary(                   \\\n           tsl::internal::CachedDsoLoader::GetHipDsoHandle().value(), kName, \\\n           &f);                                                              \\\n@@ -100,6 +100,7 @@ namespace wrap {\n   __macro(hipGetDeviceCount)                        \\\n   __macro(hipGetDeviceProperties)                   \\\n   __macro(hipGetErrorString)                        \\\n+  __macro(hipGetLastError)                          \\\n   __macro(hipGraphAddKernelNode)                    \\\n   __macro(hipGraphAddChildGraphNode)                \\\n   __macro(hipGraphAddEmptyNode)                     \\"
        },
        {
            "sha": "d8a797664e084c85304b3d527f594a2176ad4d60",
            "filename": "third_party/xla/xla/stream_executor/rocm/rocm_executor.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dec2b02416665a5bb665336de5ef78d2eb9da1f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_executor.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dec2b02416665a5bb665336de5ef78d2eb9da1f2/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_executor.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Frocm%2Frocm_executor.cc?ref=dec2b02416665a5bb665336de5ef78d2eb9da1f2",
            "patch": "@@ -381,11 +381,16 @@ absl::Status EnablePeerAccess(Context* from, Context* to) {\n   hipError_t result =\n       wrap::hipDeviceEnablePeerAccess(to->device_ordinal(), 0 /* = flags */);\n \n-  if (result != hipSuccess && result != hipErrorPeerAccessAlreadyEnabled) {\n+  if (result == hipErrorPeerAccessAlreadyEnabled) {\n+    // hipGetLastError is used to reset per thread error state,\n+    // as hipGetLastError would get the recent error code since rocm7 even the\n+    // last call is successful.\n+    (void)wrap::hipGetLastError();\n+  } else if (result != hipSuccess) {\n     return absl::InternalError(\n         absl::StrFormat(\"failed to enable peer access from %d to %d: %s\",\n                         from->device_ordinal(), to->device_ordinal(),\n-                        ToString(result).c_str()));\n+                        wrap::hipGetErrorString(result)));\n   }\n \n   return absl::OkStatus();"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 10,
        "deletions": 4
    }
}