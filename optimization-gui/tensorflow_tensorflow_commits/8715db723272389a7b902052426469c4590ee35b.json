{
    "author": "yimeisun123",
    "message": "PR #31810: [XLA:CPU][oneDNN] Select rewriting pass for dot operation based on runtime flags for oneDNN\n\nImported from GitHub PR https://github.com/openxla/xla/pull/31810\n\nWhen runtime flag, xla_cpu_use_onednn, is enabled for oneDNN, rewrite the dot operation through DotLibraryRewriter instead of OneDnnContractionRewriter.\nCopybara import of the project:\n\n--\n36579cad54ea07b74e6029b75673a7392cb912d3 by Yimei Sun <yimei.sun@intel.com>:\n\n[XLA:CPU][oneDNN] Select rewriting pass for dot operation based on runtime flags for oneDNN\n\nMerging this change closes #31810\n\nPiperOrigin-RevId: 816128431",
    "sha": "8715db723272389a7b902052426469c4590ee35b",
    "files": [
        {
            "sha": "a1340d72d42d7ad4820fb968e73d57fe6b70495f",
            "filename": "third_party/xla/xla/backends/cpu/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftransforms%2FBUILD?ref=8715db723272389a7b902052426469c4590ee35b",
            "patch": "@@ -21,7 +21,7 @@ cc_library(\n     name = \"library_rewriter\",\n     srcs = [\"library_rewriter.cc\"],\n     hdrs = [\"library_rewriter.h\"],\n-    local_defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n+    defines = if_graph_api([\"XLA_ONEDNN_USE_GRAPH_API=1\"]),\n     deps = [\n         \":library_matcher\",\n         \":onednn_matcher\","
        },
        {
            "sha": "96a998e9a536282631b9ff688ef1392cfe78f903",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=8715db723272389a7b902052426469c4590ee35b",
            "patch": "@@ -910,15 +910,18 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n   bool use_onednn_custom_call =\n       debug_options.xla_cpu_experimental_onednn_custom_call() &&\n       is_onednn_compatible;\n+  bool use_onednn_graph =\n+      debug_options.xla_cpu_use_onednn() &&\n+      (!debug_options.xla_cpu_experimental_onednn_fusion_type().empty());\n   if (use_onednn_custom_call) {\n     // Run SimplifyFPConversions pass to simplify the BF16 pattern and make it\n     // easier to match.\n     // Remove `f32 -> bf16 -> f32` casts inserted by bf16 normalization.\n     if (debug_options.xla_allow_excess_precision()) {\n       pipeline.AddPass<SimplifyFPConversions>();\n     }\n-    pipeline.AddPass<OneDnnContractionRewriter>(max_parallelism,\n-                                                compile_options.thread_pool);\n+    pipeline.AddPass<OneDnnContractionRewriter>(\n+        max_parallelism, compile_options.thread_pool, use_onednn_graph);\n     // Run SimplifyFPConversions pass again to remove redundant Convert ops\n     // that may exist as a result of running OneDnnContractionRewriter pass.\n     if (debug_options.xla_allow_excess_precision()) {"
        },
        {
            "sha": "95a70cdbe3dee84adfabc008d8d6f52782fb67e0",
            "filename": "third_party/xla/xla/service/cpu/onednn_contraction_rewriter.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_contraction_rewriter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_contraction_rewriter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_contraction_rewriter.cc?ref=8715db723272389a7b902052426469c4590ee35b",
            "patch": "@@ -591,9 +591,15 @@ bool OneDnnContractionRewriter::ShouldRewriteConv(\n \n class OneDnnContractionRewriteVisitor : public DfsHloRewriteVisitor {\n  public:\n+  OneDnnContractionRewriteVisitor(bool graph_enabled)\n+      : graph_enabled_(graph_enabled) {}\n+\n   // Matches patterns for possible MatMul fusions that are supported by oneDNN\n   // library. Matched HLO instruction(s) are replaced by custom call.\n   absl::Status HandleDot(HloInstruction* instr) override {\n+    // When oneDNN graph is enabled, dot will be handled via DotLibraryRewriter\n+    if (graph_enabled_) return absl::OkStatus();\n+\n     HloInstruction* dot_instr;\n     auto pattern = m::Op(&dot_instr).WithOpcode(HloOpcode::kDot);\n     if (!Match(instr, pattern)) {\n@@ -1269,6 +1275,9 @@ class OneDnnContractionRewriteVisitor : public DfsHloRewriteVisitor {\n     TF_RETURN_IF_ERROR(ReplaceInstruction(dot_instr, replacement_instr));\n     return absl::OkStatus();\n   }\n+\n+ private:\n+  bool graph_enabled_;\n };\n \n class OneDnnPostRewriteVisitor : public DfsHloRewriteVisitor {\n@@ -1522,7 +1531,7 @@ absl::StatusOr<bool> OneDnnContractionRewriter::Run(\n     const absl::flat_hash_set<absl::string_view>& execution_threads) {\n   XLA_VLOG_LINES(\n       3, \"OneDnnContractionRewriter::Run(), before:\\n\" + module->ToString());\n-  OneDnnContractionRewriteVisitor visitor;\n+  OneDnnContractionRewriteVisitor visitor(graph_enabled_);\n   TF_ASSIGN_OR_RETURN(auto result,\n                       visitor.RunOnModule(module, execution_threads));\n "
        },
        {
            "sha": "61d4d35bcb2bc6c0d89d96497eca28d21a037bf2",
            "filename": "third_party/xla/xla/service/cpu/onednn_contraction_rewriter.h",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_contraction_rewriter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8715db723272389a7b902052426469c4590ee35b/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_contraction_rewriter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_contraction_rewriter.h?ref=8715db723272389a7b902052426469c4590ee35b",
            "patch": "@@ -38,9 +38,11 @@ namespace cpu {\n class OneDnnContractionRewriter : public HloModulePass {\n  public:\n   OneDnnContractionRewriter(int intra_op_parallelism,\n-                            const tsl::thread::ThreadPool* compile_threadpool)\n+                            const tsl::thread::ThreadPool* compile_threadpool,\n+                            bool graph_enabled)\n       : intra_op_parallelism_(intra_op_parallelism),\n-        compile_threadpool_(compile_threadpool) {}\n+        compile_threadpool_(compile_threadpool),\n+        graph_enabled_(graph_enabled) {}\n   OneDnnContractionRewriter() = default;\n   absl::string_view name() const override {\n     return \"onednn-contraction-rewriter\";\n@@ -63,6 +65,7 @@ class OneDnnContractionRewriter : public HloModulePass {\n  private:\n   int intra_op_parallelism_;\n   const tsl::thread::ThreadPool* compile_threadpool_;\n+  bool graph_enabled_;\n };\n \n using OneDnnContractionVariant ="
        }
    ],
    "stats": {
        "total": 27,
        "additions": 21,
        "deletions": 6
    }
}