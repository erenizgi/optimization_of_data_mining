{
    "author": "ezhulenev",
    "message": "[xla:ffi] Add iterator to traverse Dictionary\n\nPiperOrigin-RevId: 827731173",
    "sha": "bdf0a2817a817814430b5192f4665f798da25a61",
    "files": [
        {
            "sha": "d440584009e53ff50738095d78026a4946503e7b",
            "filename": "third_party/xla/xla/ffi/api/api.h",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bdf0a2817a817814430b5192f4665f798da25a61/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bdf0a2817a817814430b5192f4665f798da25a61/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fapi.h?ref=bdf0a2817a817814430b5192f4665f798da25a61",
            "patch": "@@ -1356,10 +1356,42 @@ class DictionaryBase {\n  public:\n   explicit DictionaryBase(const XLA_FFI_Attrs* attrs) : attrs_(attrs) {}\n \n+  // Iterator for iterating over dictionary attribute names.\n+  class Iterator {\n+   public:\n+    using iterator_category = std::forward_iterator_tag;\n+    using difference_type = ptrdiff_t;\n+    using value_type = std::string_view;\n+\n+    bool operator==(const Iterator& it) const { return idx_ == it.idx_; }\n+    bool operator!=(const Iterator& it) const { return idx_ != it.idx_; }\n+\n+    std::string_view operator*() const {\n+      return std::string_view{attrs_->names[idx_]->ptr,\n+                              attrs_->names[idx_]->len};\n+    }\n+\n+    Iterator& operator++() {\n+      ++idx_;\n+      return *this;\n+    }\n+\n+   private:\n+    friend class DictionaryBase;\n+    Iterator(const XLA_FFI_Attrs* attrs, size_t idx)\n+        : attrs_(attrs), idx_(idx) {}\n+\n+    const XLA_FFI_Attrs* attrs_;\n+    size_t idx_ = 0;\n+  };\n+\n   size_t size() const { return attrs_->size; }\n \n   bool contains(std::string_view name) const { return Find(name).has_value(); }\n \n+  Iterator begin() const { return Iterator(attrs_, 0); }\n+  Iterator end() const { return Iterator(attrs_, size()); }\n+\n   template <typename T>\n   bool contains(std::string_view name) const {\n     std::optional<size_t> idx = Find(name);\n@@ -1372,10 +1404,25 @@ class DictionaryBase {\n     return AttrDecoding<T>::Isa(attr_type, attr);\n   }\n \n+  template <typename T>\n+  bool isa(const Iterator& it) const {\n+    XLA_FFI_AttrType attr_type = attrs_->types[it.idx_];\n+    void* attr = attrs_->attrs[it.idx_];\n+    return AttrDecoding<T>::Isa(attr_type, attr);\n+  }\n+\n  protected:\n   template <typename T, typename... Ts>\n   friend struct DecodeDictionaryAttr;\n \n+  template <typename T>\n+  std::optional<size_t> get(const Iterator& it,\n+                            DiagnosticEngine& diagnostic) const {\n+    XLA_FFI_AttrType attr_type = attrs_->types[it.idx_];\n+    void* attr = attrs_->attrs[it.idx_];\n+    return AttrDecoding<T>::Decode(attr_type, attr, diagnostic);\n+  }\n+\n   template <typename T>\n   std::optional<T> get(std::string_view name,\n                        DiagnosticEngine& diagnostic) const {"
        },
        {
            "sha": "7de9a6bee6a667e6fd60a4cad10f6be2a0a04c5d",
            "filename": "third_party/xla/xla/ffi/api/ffi.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bdf0a2817a817814430b5192f4665f798da25a61/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bdf0a2817a817814430b5192f4665f798da25a61/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi.h?ref=bdf0a2817a817814430b5192f4665f798da25a61",
            "patch": "@@ -1080,6 +1080,16 @@ class Dictionary : public internal::DictionaryBase {\n  public:\n   using internal::DictionaryBase::DictionaryBase;\n \n+  template <typename T>\n+  ErrorOr<T> get(const Iterator& it) const {\n+    DiagnosticEngine diagnostic;\n+    auto value = internal::DictionaryBase::get<T>(it, diagnostic);\n+    if (XLA_FFI_PREDICT_FALSE(!value.has_value())) {\n+      return Unexpected(Error::Internal(diagnostic.Result()));\n+    }\n+    return *value;\n+  }\n+\n   template <typename T>\n   ErrorOr<T> get(std::string_view name) const {\n     DiagnosticEngine diagnostic;"
        },
        {
            "sha": "b39b7ef84c1dbb1d28f1909caf2da30d800923f9",
            "filename": "third_party/xla/xla/ffi/api/ffi_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bdf0a2817a817814430b5192f4665f798da25a61/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bdf0a2817a817814430b5192f4665f798da25a61/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fffi%2Fapi%2Fffi_test.cc?ref=bdf0a2817a817814430b5192f4665f798da25a61",
            "patch": "@@ -912,6 +912,17 @@ TEST(FfiTest, AutoBindingDictionary) {\n     EXPECT_EQ(*attrs.get<int32_t>(\"i32\"), 42);\n     EXPECT_EQ(*attrs.get<float>(\"f32\"), 42.0f);\n \n+    auto it = attrs.begin();\n+    EXPECT_EQ(*it, \"f32\");\n+    EXPECT_TRUE(attrs.isa<float>(it));\n+    EXPECT_EQ(*attrs.get<float>(it), 42.0f);\n+\n+    EXPECT_EQ(*++it, \"i32\");\n+    EXPECT_TRUE(attrs.isa<int32_t>(it));\n+    EXPECT_EQ(*attrs.get<int32_t>(it), 42);\n+\n+    EXPECT_EQ(++it, attrs.end());\n+\n     return Error::Success();\n   });\n "
        }
    ],
    "stats": {
        "total": 68,
        "additions": 68,
        "deletions": 0
    }
}