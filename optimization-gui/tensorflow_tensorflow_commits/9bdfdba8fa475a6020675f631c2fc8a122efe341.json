{
    "author": "penpornk",
    "message": "[xla:cpu:onednn] Remove INTEL_MKL ifdef guards from `onednn_memory_util`.\n\n+ Fix ClangTidy/Linter errors/warnings.\n\nPiperOrigin-RevId: 811474767",
    "sha": "9bdfdba8fa475a6020675f631c2fc8a122efe341",
    "files": [
        {
            "sha": "b056d2c4dc1a56936f38d122ca717ee34884dfd4",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 20,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -13,12 +13,8 @@ load(\n load(\"//xla/tests:build_defs.bzl\", \"xla_test\")\n load(\"//xla/tsl:tsl.bzl\", \"internal_visibility\", \"tsl_copts\")\n load(\"//xla/tsl:tsl.default.bzl\", \"filegroup\", \"get_compatible_with_portable\")\n-load(\n-    \"//xla/tsl/mkl:build_defs.bzl\",\n-    \"if_graph_api\",\n-    \"if_onednn\",\n-    \"onednn_cc_library\",\n-)\n+load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\", \"if_onednn\")\n+load(\"//xla/tsl/mkl:graph.bzl\", \"onednn_cc_library\")\n load(\"//xla/tsl/platform:build_config.bzl\", \"tf_proto_library\")\n load(\n     \"//xla/tsl/platform:build_config_root.bzl\",\n@@ -833,7 +829,6 @@ cc_library(\n         \":ir_emission_utils\",\n         \":ir_function\",\n         \":onednn_config_proto_cc\",\n-        \":onednn_memory_util\",\n         \":parallel_loop_emitter\",\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n@@ -881,7 +876,7 @@ cc_library(\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:TargetParser\",\n         \"@llvm-project//mlir:IR\",\n-    ],\n+    ] + if_onednn([\":onednn_memory_util\"]),\n )\n \n cc_library(\n@@ -1731,7 +1726,7 @@ onednn_cc_library(\n     ],\n )\n \n-cc_library(\n+onednn_cc_library(\n     name = \"onednn_memory_util\",\n     srcs = [\"onednn_memory_util.cc\"],\n     hdrs = [\"onednn_memory_util.h\"],\n@@ -1741,24 +1736,15 @@ cc_library(\n         \":runtime_lightweight_check\",\n         \"//xla:literal\",\n         \"//xla:shape_util\",\n-        \"//xla:status_macros\",\n-        \"//xla:types\",\n-        \"//xla:util\",\n         \"//xla:xla_data_proto_cc\",\n-        \"//xla/hlo/ir:hlo\",\n         \"//xla/service/llvm_ir:ir_array\",\n-        \"//xla/service/llvm_ir:ir_builder_mixin\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/mkl:onednn\",\n-        \"@com_google_absl//absl/base:core_headers\",\n-        \"@com_google_absl//absl/base:dynamic_annotations\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Core\",\n-        \"@llvm-project//llvm:TargetParser\",\n-        \"@llvm-project//mlir:IR\",\n-        \"@local_tsl//tsl/platform:errors\",\n-        \"@local_tsl//tsl/platform:logging\",\n     ],\n )\n "
        },
        {
            "sha": "833c221aedbf9f2a0a9c5068bfe7cc167a8ea962",
            "filename": "third_party/xla/xla/service/cpu/onednn_memory_util.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 20,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.cc?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -13,29 +13,31 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#if defined(INTEL_MKL)\n-\n #include \"xla/service/cpu/onednn_memory_util.h\"\n \n #include <algorithm>\n-#include <cmath>\n+#include <cstdint>\n #include <initializer_list>\n #include <iostream>\n+#include <numeric>\n+#include <utility>\n #include <vector>\n \n-#include \"llvm/IR/BasicBlock.h\"\n+#include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/types/span.h\"\n+#include \"oneapi/dnnl/dnnl.hpp\"\n #include \"llvm/IR/Constants.h\"\n-#include \"llvm/IR/FMF.h\"\n-#include \"llvm/IR/GlobalVariable.h\"\n+#include \"llvm/IR/DerivedTypes.h\"\n #include \"llvm/IR/IRBuilder.h\"\n #include \"llvm/IR/Instructions.h\"\n #include \"llvm/IR/Intrinsics.h\"\n-#include \"llvm/IR/IntrinsicsX86.h\"\n-#include \"llvm/IR/LLVMContext.h\"\n #include \"llvm/IR/Value.h\"\n-#include \"xla/service/cpu/runtime_lightweight_check.h\"\n+#include \"xla/literal.h\"\n #include \"xla/service/llvm_ir/ir_array.h\"\n #include \"xla/service/llvm_ir/llvm_util.h\"\n+#include \"xla/shape.h\"\n \n namespace xla {\n namespace cpu {\n@@ -45,17 +47,17 @@ namespace cpu {\n struct MemrefInfoPOD {\n   int64_t dtype;\n   int64_t rank;\n-  void* data;\n+  const void* data;\n   int64_t unused;  // This unused value pads the struct to align with a 64-byte\n                    // cacheline\n   int64_t dims[kOneDnnMaxNDims];\n   int64_t strides[kOneDnnMaxNDims];\n };\n \n-MemrefInfoHandler CreateMemrefFromShape(const Shape& shape, void* const buf) {\n+MemrefInfoHandler CreateMemrefFromShape(const Shape& shape, const void* buf) {\n   MemrefInfoHandler result(new MemrefInfoPOD);\n   result->dtype = shape.element_type();\n-  result->rank = shape.dimensions_size();\n+  result->rank = shape.dimensions().size();\n   auto dimensions = shape.dimensions();\n   std::copy(dimensions.begin(), dimensions.end(),\n             absl::MakeSpan(result->dims).begin());\n@@ -71,15 +73,14 @@ MemrefInfoHandler CreateMemrefFromShape(const Shape& shape, void* const buf) {\n \n MemrefInfoHandler CreateMemrefInfoFromLiteral(const Literal* literal) {\n   const auto& shape = literal->shape();\n-  void* const buf = const_cast<void*>(literal->untyped_data());\n-  return CreateMemrefFromShape(shape, buf);\n+  return CreateMemrefFromShape(shape, literal->untyped_data());\n }\n \n std::pair<std::vector<int64_t>, std::vector<int64_t>> GetDimsStrides(\n     const Shape& shape) {\n   // oneDNN handles scalar as a vector of size 1.\n-  const bool is_scalar = shape.dimensions_size() == 0;\n-  int64_t rank = is_scalar ? 1 : shape.dimensions_size();\n+  const bool is_scalar = shape.dimensions().empty();\n+  int64_t rank = is_scalar ? 1 : shape.dimensions().size();\n   std::vector<int64_t> strides(rank);\n   std::vector<int64_t> scalar_shape(1, 1);\n   absl::Span<const int64_t> dimensions =\n@@ -101,7 +102,7 @@ StackAlloca GetAllocaAndEmitMemrefInfo(llvm::IRBuilderBase& builder,\n                                        const llvm_ir::IrArray& ir_array) {\n   const Shape& shape = ir_array.GetShape();\n   // oneDNN handles scalar as a vector of size 1.\n-  int64_t rank = shape.dimensions_size() == 0 ? 1 : shape.dimensions_size();\n+  int64_t rank = shape.dimensions().empty() ? 1 : shape.dimensions().size();\n   auto [dims, strides] = GetDimsStrides(shape);\n \n   // Type of struct\n@@ -170,7 +171,10 @@ dnnl::memory::desc MemrefInfo::GetOneDnnMemDesc() const {\n   return dnnl::memory::desc{dims, dtype, strides};\n }\n \n-void* MemrefInfo::Data() { return pod_->data; }\n+void* MemrefInfo::Data() {\n+  // NOLINTNEXTLINE: For dnnl::memory constructor.\n+  return const_cast<void*>(pod_->data);\n+}\n \n void MemrefInfo::Print() {\n   std::cout << \"Data type: \" << pod_->dtype << \"\\t\";\n@@ -226,5 +230,3 @@ Shape MemDescToXlaShapeFlattened(const dnnl::memory::desc& md) {\n \n }  // namespace cpu\n }  // namespace xla\n-\n-#endif  // INTEL_MKL"
        },
        {
            "sha": "af17ce0a75b15d70847bbabba82302f1be46bcea",
            "filename": "third_party/xla/xla/service/cpu/onednn_memory_util.h",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fonednn_memory_util.h?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -15,18 +15,21 @@ limitations under the License.\n \n #ifndef XLA_SERVICE_CPU_ONEDNN_MEMORY_UTIL_H_\n #define XLA_SERVICE_CPU_ONEDNN_MEMORY_UTIL_H_\n-#if defined(INTEL_MKL)\n \n+#include <cstdint>\n #include <memory>\n+#include <vector>\n \n-#include \"dnnl.hpp\"\n+#include \"absl/status/statusor.h\"\n+#include \"oneapi/dnnl/dnnl.hpp\"\n+#include \"oneapi/dnnl/dnnl_common_types.h\"\n #include \"llvm/IR/IRBuilder.h\"\n #include \"llvm/IR/Instructions.h\"\n-#include \"llvm/IR/LLVMContext.h\"\n #include \"llvm/IR/Value.h\"\n #include \"xla/literal.h\"\n #include \"xla/service/cpu/runtime_lightweight_check.h\"\n #include \"xla/service/llvm_ir/ir_array.h\"\n+#include \"xla/shape.h\"\n #include \"xla/xla_data.pb.h\"\n \n namespace xla {\n@@ -46,7 +49,7 @@ using MemrefInfoHandler = std::shared_ptr<MemrefInfoPOD>;\n \n MemrefInfoHandler CreateMemrefInfoFromLiteral(const Literal* literal);\n \n-MemrefInfoHandler CreateMemrefFromShape(const Shape& shape, void* buf);\n+MemrefInfoHandler CreateMemrefFromShape(const Shape& shape, const void* buf);\n \n StackAlloca GetAllocaAndEmitMemrefInfo(llvm::IRBuilderBase& builder,\n                                        const llvm_ir::IrArray& ir_array);\n@@ -165,5 +168,4 @@ struct OneDnnResources {\n }  // namespace cpu\n }  // namespace xla\n \n-#endif  // INTEL_MKL\n #endif  // XLA_SERVICE_CPU_ONEDNN_MEMORY_UTIL_H_"
        },
        {
            "sha": "9d6ddc2d405392f3e092dd604ec46976bc64c89d",
            "filename": "third_party/xla/xla/service/cpu/tests/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2FBUILD?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -7,6 +7,7 @@ load(\"//xla/tests:build_defs.bzl\", \"xla_test\")\n load(\"//xla/tsl:tsl.bzl\", \"tsl_copts\")\n load(\"//xla/tsl:tsl.default.bzl\", \"filegroup\")\n load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\")\n+load(\"//xla/tsl/mkl:graph.bzl\", \"onednn_cc_test\")\n \n package(\n     # copybara:uncomment default_applicable_licenses = [\"//tensorflow:license\"],\n@@ -347,23 +348,25 @@ xla_cc_test(\n     ],\n )\n \n-xla_cc_test(\n+onednn_cc_test(\n     name = \"onednn_memory_util_test\",\n     srcs = [\"onednn_memory_util_test.cc\"],\n     copts = tsl_copts(),\n-    fail_if_no_test_linked = False,  # NOLINT=There are only tests for Intel MKL.\n-    fail_if_no_test_selected = False,  # NOLINT=There are only tests for Intel MKL.\n     deps = [\n         \"//xla:shape_util\",\n         \"//xla/hlo/testlib:filecheck\",\n         \"//xla/service:cpu_plugin\",\n         \"//xla/service/cpu:onednn_memory_util\",\n+        \"//xla/service/llvm_ir:ir_array\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tests:xla_internal_test_main\",\n         \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/algorithm:container\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:ir_headers\",\n-        \"@local_tsl//tsl/platform:test\",\n     ],\n )\n "
        },
        {
            "sha": "fb013dd5e8729c2a9acc234a2f56224328b57a0a",
            "filename": "third_party/xla/xla/service/cpu/tests/onednn_memory_util_test.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fonednn_memory_util_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fonednn_memory_util_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ftests%2Fonednn_memory_util_test.cc?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -13,12 +13,16 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#if defined(INTEL_MKL)\n-\n #include \"xla/service/cpu/onednn_memory_util.h\"\n \n+#include <cstdint>\n+#include <sstream>\n #include <string>\n+#include <vector>\n \n+#include \"absl/algorithm/container.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_cat.h\"\n #include \"llvm/ADT/ArrayRef.h\"\n #include \"llvm/IR/Argument.h\"\n #include \"llvm/IR/BasicBlock.h\"\n@@ -27,7 +31,10 @@ limitations under the License.\n #include \"llvm/IR/IRBuilder.h\"\n #include \"llvm/IR/Type.h\"\n #include \"llvm/IR/Value.h\"\n+#include \"llvm/Support/raw_ostream.h\"\n #include \"xla/hlo/testlib/filecheck.h\"\n+#include \"xla/layout_util.h\"\n+#include \"xla/service/llvm_ir/ir_array.h\"\n #include \"xla/service/llvm_ir/llvm_util.h\"\n #include \"xla/shape.h\"\n #include \"xla/shape_util.h\"\n@@ -106,5 +113,3 @@ INSTANTIATE_TEST_SUITE_P(\n }  // namespace\n }  // namespace cpu\n }  // namespace xla\n-\n-#endif  // INTEL_MKL"
        },
        {
            "sha": "1027ff6deecb9a2549ed54ffeea2fab9c65f6456",
            "filename": "third_party/xla/xla/tsl/mkl/build_defs.bzl",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fbuild_defs.bzl?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -15,8 +15,6 @@ mkl_repository depends on the following environment variables:\n   * `TF_MKL_ROOT`: The root folder where a copy of libmkl is located.\n \"\"\"\n \n-load(\"@rules_cc//cc:cc_library.bzl\", \"cc_library\")\n-\n _TF_MKL_ROOT = \"TF_MKL_ROOT\"\n \n def if_mkl(if_true, if_false = []):\n@@ -47,15 +45,6 @@ def if_mkl(if_true, if_false = []):\n # XLA in the future.\n if_onednn = if_mkl\n \n-def onednn_cc_library(srcs = [], hdrs = [], deps = [], **kwargs):\n-    \"\"\"cc_library rule with empty src/hdrs/deps if not building with oneDNN.\"\"\"\n-    cc_library(\n-        srcs = if_onednn(srcs),\n-        hdrs = if_onednn(hdrs),\n-        deps = if_onednn(deps),\n-        **kwargs\n-    )\n-\n def if_mkl_ml(if_true, if_false = []):\n     \"\"\"Shorthand for select()'ing on whether we're building with MKL-ML.\n "
        },
        {
            "sha": "3b73a45bdf840208bd0ee1086a9cd360b444afe9",
            "filename": "third_party/xla/xla/tsl/mkl/graph.bzl",
            "status": "modified",
            "additions": 32,
            "deletions": 4,
            "changes": 36,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fgraph.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9bdfdba8fa475a6020675f631c2fc8a122efe341/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fgraph.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fmkl%2Fgraph.bzl?ref=9bdfdba8fa475a6020675f631c2fc8a122efe341",
            "patch": "@@ -1,14 +1,16 @@\n \"\"\"Starlark macros for oneDNN Graph API.\n \n-Contains build rules that builds with empty srcs, hdrs, and deps if not build with Graph API.\n-These rules have to be outside of mkl/build_defs.bzl, otherwise we would have cyclic dependency\n-(xla.bzl depends on tsl which depends on mkl/build_defs.bzl).\n+Contains library and test rules that builds with empty srcs, hdrs, and deps if not build with Graph\n+API or oneDNN. These rules have to be outside of mkl/build_defs.bzl, otherwise we would have cyclic\n+dependency (xla.bzl depends on tsl which depends on mkl/build_defs.bzl).\n+\n+TODO(penporn): Rename this file to build_rules.bzl since it's not just about graph API anymore.\n \"\"\"\n \n load(\"@rules_cc//cc:cc_library.bzl\", \"cc_library\")\n load(\"//xla:xla.default.bzl\", \"xla_cc_test\")\n load(\"//xla/tsl:package_groups.bzl\", \"DEFAULT_LOAD_VISIBILITY\")\n-load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\")\n+load(\"//xla/tsl/mkl:build_defs.bzl\", \"if_graph_api\", \"if_onednn\")\n \n visibility(DEFAULT_LOAD_VISIBILITY)\n \n@@ -35,3 +37,29 @@ def onednn_graph_cc_test(\n         fail_if_no_test_selected = False,\n         **kwargs\n     )\n+\n+def onednn_cc_library(srcs = [], hdrs = [], deps = [], **kwargs):\n+    \"\"\"cc_library rule with empty src/hdrs/deps if not building with oneDNN.\"\"\"\n+    cc_library(\n+        srcs = if_onednn(srcs),\n+        hdrs = if_onednn(hdrs),\n+        deps = if_onednn(deps),\n+        # copybara:uncomment compatible_with = [\"//buildenv/target:non_prod\"],\n+        **kwargs\n+    )\n+\n+def onednn_cc_test(\n+        srcs = [],\n+        deps = [],\n+        **kwargs):\n+    \"\"\"xla_cc_test rule with empty src and deps if not building with Graph API.\"\"\"\n+    xla_cc_test(\n+        # CC_TEST_OK=This rule is used in XLA.\n+        srcs = if_onednn(srcs),\n+        deps = if_onednn(if_true = deps, if_false = [\"@com_google_googletest//:gtest_main\"]),\n+        # If not building with Graph API, we don't have any tests linked.\n+        fail_if_no_test_linked = False,\n+        # If not building with Graph API, we don't have any tests defined either.\n+        fail_if_no_test_selected = False,\n+        **kwargs\n+    )"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 83,
        "deletions": 68
    }
}