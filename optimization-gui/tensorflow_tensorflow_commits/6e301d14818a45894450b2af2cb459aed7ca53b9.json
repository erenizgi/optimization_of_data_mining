{
    "author": "tensorflower-gardener",
    "message": "#HLODiff Add character-level diff highlighting for changed HLO instructions in HLODiff HTML renderer.\n\nPiperOrigin-RevId: 801048785",
    "sha": "6e301d14818a45894450b2af2cb459aed7ca53b9",
    "files": [
        {
            "sha": "0594799425be89930d06e19f27e5ba6a8e78fc15",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e301d14818a45894450b2af2cb459aed7ca53b9/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e301d14818a45894450b2af2cb459aed7ca53b9/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2FBUILD?ref=6e301d14818a45894450b2af2cb459aed7ca53b9",
            "patch": "@@ -72,6 +72,7 @@ cc_library(\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/hlo/tools/hlo_diff:hlo_diff_result\",\n         \"//xla/hlo/tools/hlo_diff:hlo_diff_summary\",\n+        \"//xla/hlo/tools/hlo_diff/utils:text_diff\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/functional:function_ref\","
        },
        {
            "sha": "c5c0b6c51ff262584cb57442e1944aa3913d64c9",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 92,
            "deletions": 13,
            "changes": 105,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6e301d14818a45894450b2af2cb459aed7ca53b9/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6e301d14818a45894450b2af2cb459aed7ca53b9/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=6e301d14818a45894450b2af2cb459aed7ca53b9",
            "patch": "@@ -41,6 +41,7 @@\n #include \"xla/hlo/tools/hlo_diff/render/graph_url_generator.h\"\n #include \"xla/hlo/tools/hlo_diff/render/hlo_gumgraph_renderer_util.h\"\n #include \"xla/hlo/tools/hlo_diff/render/op_metric_getter.h\"\n+#include \"xla/hlo/tools/hlo_diff/utils/text_diff.h\"\n #include \"xla/printer.h\"\n #include \"xla/shape_util.h\"\n #include \"tsl/platform/fingerprint.h\"\n@@ -237,6 +238,16 @@ std::string PrintCss() {\n     span.yellow-highlight {\n       background-color: #feefc3;\n     }\n+    span.darker-yellow-highlight {\n+      background-color: #FAD67F;\n+      /* Ensure empty or minimal content spans are visible as a thin line */\n+      display: inline-block;\n+      min-width: 2px; /* Thin darker yellow line */\n+      height: 1em; /* Approximately line height */\n+      vertical-align: middle;\n+      line-height: 1; /* Prevent extra space */\n+      overflow: hidden; /* Hide any overflow */\n+    }\n     span.temp-highlight {\n       background-color: #a8c7fa;\n       opacity: 0.7;\n@@ -623,42 +634,60 @@ std::string PrintTextbox(absl::string_view title, absl::string_view content,\n // The attributes of an instruction that will be applied to the corresponding\n // span element in the HTML output.\n struct Attributes {\n+  // The class name of the highlight. Empty if no highlight.\n   std::string highlight;\n+  // The diffid attribute of the span. Empty if no mapping to another span.\n   std::string diffid;\n+  // The mapped instruction of the span. Null if no mapping to another span.\n+  const HloInstruction* mapped_instruction;\n };\n \n // Generate span attributes for all instructions given diff result.\n absl::flat_hash_map<const HloInstruction*, Attributes> GenerateSpanAttributes(\n     const DiffResult& diff_result) {\n   absl::flat_hash_map<const HloInstruction*, Attributes> span_attributes;\n   for (auto& instruction : diff_result.left_module_unmatched_instructions) {\n-    span_attributes[instruction] = {\"red-highlight\"};\n+    span_attributes[instruction] = {.highlight = \"red-highlight\",\n+                                    .diffid = \"\",\n+                                    .mapped_instruction = nullptr};\n   }\n   for (auto& instruction : diff_result.right_module_unmatched_instructions) {\n-    span_attributes[instruction] = {\"green-highlight\"};\n+    span_attributes[instruction] = {.highlight = \"green-highlight\",\n+                                    .diffid = \"\",\n+                                    .mapped_instruction = nullptr};\n   }\n   for (const auto& [l_instruction, r_instruction] :\n        diff_result.changed_instructions) {\n     span_attributes[l_instruction] = {\n-        \"yellow-highlight\",\n-        absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+        .highlight = \"yellow-highlight\",\n+        .diffid =\n+            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n+        .mapped_instruction = r_instruction};\n     span_attributes[r_instruction] = {\n-        \"yellow-highlight\",\n-        absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+        .highlight = \"yellow-highlight\",\n+        .diffid =\n+            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n+        .mapped_instruction = l_instruction};\n   }\n   for (const auto& [l_instruction, r_instruction] :\n        diff_result.unchanged_instructions) {\n     span_attributes[l_instruction] = {\n-        \"\", absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+        .highlight = \"\",\n+        .diffid =\n+            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n+        .mapped_instruction = r_instruction};\n     span_attributes[r_instruction] = {\n-        \"\", absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+        .highlight = \"\",\n+        .diffid =\n+            absl::StrCat(l_instruction->name(), \"::\", r_instruction->name()),\n+        .mapped_instruction = l_instruction};\n   }\n   return span_attributes;\n };\n \n // Generates HTML for a single HloComputation with diff highlights.\n std::string PrintHloComputationToHtml(\n-    const HloComputation* comp,\n+    const HloComputation* comp, DiffSide side,\n     const absl::flat_hash_map<const HloInstruction*, Attributes>&\n         span_attributes) {\n   if (comp == nullptr) {\n@@ -709,8 +738,56 @@ std::string PrintHloComputationToHtml(\n       if (instruction == comp->root_instruction()) {\n         printer.Append(\"ROOT \");\n       }\n-      instruction->PrintWithCanonicalNameMap(\n-          &printer, instruction_print_options, &name_map);\n+      if (it == span_attributes.end() ||\n+          it->second.mapped_instruction == nullptr ||\n+          it->second.highlight.empty()) {\n+        instruction->PrintWithCanonicalNameMap(\n+            &printer, instruction_print_options, &name_map);\n+      } else {\n+        // Instruction is part of a changed pair. Show character-level diff.\n+        const HloInstruction* mapped_instruction =\n+            it->second.mapped_instruction;\n+        bool is_left_node = side == DiffSide::kLeft;\n+\n+        StringPrinter current_printer, mapped_printer;\n+        instruction->PrintWithCanonicalNameMap(\n+            &current_printer, instruction_print_options, &name_map);\n+        mapped_instruction->PrintWithCanonicalNameMap(\n+            &mapped_printer, instruction_print_options, &name_map);\n+\n+        std::string current_str = std::move(current_printer).ToString();\n+        std::string mapped_str = std::move(mapped_printer).ToString();\n+\n+        std::vector<TextDiffChunk> diff_chunks;\n+        if (is_left_node) {\n+          // Left side: diff current (left) vs mapped (right).\n+          diff_chunks = ComputeTextDiff(current_str, mapped_str);\n+        } else {\n+          // Right side: diff mapped (left) vs current (right).\n+          diff_chunks = ComputeTextDiff(mapped_str, current_str);\n+        }\n+\n+        for (const auto& chunk : diff_chunks) {\n+          if (chunk.type == TextDiffType::kUnchanged) {\n+            printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n+          } else if (is_left_node && chunk.type == TextDiffType::kRemoved) {\n+            // On the left side, highlight text REMOVED from left compared to\n+            // right.\n+            printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n+            printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n+            printer.Append(\"</span>\");\n+          } else if (!is_left_node && chunk.type == TextDiffType::kAdded) {\n+            // On the right side, highlight text ADDED to right compared to\n+            // left.\n+            printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n+            printer.Append(EscapeStringForHtmlAttribute(chunk.text));\n+            printer.Append(\"</span>\");\n+          } else {\n+            printer.Append(\"<span class=\\\"darker-yellow-highlight\\\">\");\n+            printer.Append(\"</span>\");\n+          }\n+        }\n+      }\n       printer.Append(\"</span>\");\n     }\n   }\n@@ -737,15 +814,17 @@ std::string PrintHloTextboxPair(\n   if (left_node != nullptr) {\n     left_title = left_node->name();\n     if constexpr (std::is_same_v<T, HloComputation>) {\n-      left_text = PrintHloComputationToHtml(left_node, span_attributes);\n+      left_text = PrintHloComputationToHtml(left_node, DiffSide::kLeft,\n+                                            span_attributes);\n     } else {\n       left_text = left_node->ToString();\n     }\n   }\n   if (right_node != nullptr) {\n     right_title = right_node->name();\n     if constexpr (std::is_same_v<T, HloComputation>) {\n-      right_text = PrintHloComputationToHtml(right_node, span_attributes);\n+      right_text = PrintHloComputationToHtml(right_node, DiffSide::kRight,\n+                                             span_attributes);\n     } else {\n       right_text = right_node->ToString();\n     }"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 93,
        "deletions": 13
    }
}