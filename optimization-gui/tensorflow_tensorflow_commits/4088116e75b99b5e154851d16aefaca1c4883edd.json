{
    "author": "ezhulenev",
    "message": "[tsl:concurrency] Add support for nullability annotations to tsl::RCReference\n\nPiperOrigin-RevId: 798312315",
    "sha": "4088116e75b99b5e154851d16aefaca1c4883edd",
    "files": [
        {
            "sha": "c71f809622f49bfd470365ba5127eb325e3db821",
            "filename": "third_party/xla/xla/tsl/concurrency/BUILD",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4088116e75b99b5e154851d16aefaca1c4883edd/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4088116e75b99b5e154851d16aefaca1c4883edd/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2FBUILD?ref=4088116e75b99b5e154851d16aefaca1c4883edd",
            "patch": "@@ -130,4 +130,17 @@ cc_library(\n     name = \"ref_count\",\n     hdrs = [\"ref_count.h\"],\n     compatible_with = get_compatible_with_portable(),\n+    deps = [\"@com_google_absl//absl/base:nullability\"],\n+)\n+\n+tsl_cc_test(\n+    name = \"ref_count_test\",\n+    srcs = [\"ref_count_test.cc\"],\n+    deps = [\n+        \":ref_count\",\n+        \"//xla/tsl/platform:test\",\n+        \"//xla/tsl/platform:test_benchmark\",\n+        \"//xla/tsl/platform:test_main\",\n+        \"@com_google_absl//absl/base:nullability\",\n+    ],\n )"
        },
        {
            "sha": "d9463a368acfe0beac8370294889e8e34f531084",
            "filename": "third_party/xla/xla/tsl/concurrency/ref_count.h",
            "status": "modified",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4088116e75b99b5e154851d16aefaca1c4883edd/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2Fref_count.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4088116e75b99b5e154851d16aefaca1c4883edd/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2Fref_count.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2Fref_count.h?ref=4088116e75b99b5e154851d16aefaca1c4883edd",
            "patch": "@@ -23,6 +23,8 @@ limitations under the License.\n #include <type_traits>\n #include <utility>\n \n+#include \"absl/base/nullability.h\"\n+\n namespace tsl {\n \n namespace internal {\n@@ -120,7 +122,7 @@ class ReferenceCounted {\n // This is a smart pointer that keeps the specified reference counted value\n // around.\n template <typename T>\n-class RCReference {\n+class ABSL_NULLABILITY_COMPATIBLE RCReference {\n  public:\n   RCReference() : pointer_(nullptr) {}\n \n@@ -129,7 +131,9 @@ class RCReference {\n   }\n \n   RCReference(const RCReference& other) : pointer_(other.pointer_) {\n-    if (pointer_) pointer_->AddRef();\n+    if (pointer_) {\n+      pointer_->AddRef();\n+    }\n   }\n \n   RCReference& operator=(RCReference&& other) noexcept {\n@@ -140,7 +144,9 @@ class RCReference {\n \n   RCReference& operator=(const RCReference& other) {\n     reset(other.pointer_);\n-    if (pointer_) pointer_->AddRef();\n+    if (pointer_) {\n+      pointer_->AddRef();\n+    }\n     return *this;\n   }\n \n@@ -151,15 +157,21 @@ class RCReference {\n   }\n   template <typename Derived, internal::DerivedFrom<Derived, T>* = nullptr>\n   RCReference(const RCReference<Derived>& u) : pointer_(u.pointer_) {  // NOLINT\n-    if (pointer_) pointer_->AddRef();\n+    if (pointer_) {\n+      pointer_->AddRef();\n+    }\n   }\n \n   ~RCReference() {\n-    if (pointer_ != nullptr) pointer_->DropRef();\n+    if (pointer_ != nullptr) {\n+      pointer_->DropRef();\n+    }\n   }\n \n   void reset(T* pointer = nullptr) {\n-    if (pointer_ != nullptr) pointer_->DropRef();\n+    if (pointer_ != nullptr) {\n+      pointer_->DropRef();\n+    }\n     pointer_ = pointer;\n   }\n \n@@ -244,7 +256,9 @@ RCReference<T> TakeRef(T* pointer) {\n \n template <typename T>\n RCReference<T> RCReference<T>::CopyRef() const {\n-  if (!pointer_) return RCReference();\n+  if (!pointer_) {\n+    return RCReference();\n+  }\n   return FormRef(get());\n }\n "
        },
        {
            "sha": "f02edc170d72564d2cacb9f14bb819eb995ec368",
            "filename": "third_party/xla/xla/tsl/concurrency/ref_count_test.cc",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4088116e75b99b5e154851d16aefaca1c4883edd/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2Fref_count_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4088116e75b99b5e154851d16aefaca1c4883edd/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2Fref_count_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fconcurrency%2Fref_count_test.cc?ref=4088116e75b99b5e154851d16aefaca1c4883edd",
            "patch": "@@ -0,0 +1,42 @@\n+/* Copyright 2025 Google LLC. All Rights Reserved.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/tsl/concurrency/ref_count.h\"\n+\n+#include <cstdint>\n+\n+#include \"absl/base/nullability.h\"\n+#include \"xla/tsl/platform/test.h\"\n+\n+namespace tsl {\n+\n+struct Value : public ReferenceCounted<Value> {\n+  explicit Value(int32_t value) : value(value) {}\n+  int32_t value;\n+};\n+\n+TEST(RefCountTest, NullableRef) {\n+  absl_nullable RCReference<Value> ref;\n+  EXPECT_EQ(ref, nullptr);\n+}\n+\n+TEST(RefCountTest, NonnullRef) {\n+  absl_nonnull auto ref = MakeRef<Value>(123);\n+  EXPECT_EQ(1, ref->NumRef());\n+  EXPECT_TRUE(ref->IsUnique());\n+  EXPECT_EQ(123, ref->value);\n+}\n+\n+}  // namespace tsl"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 76,
        "deletions": 7
    }
}