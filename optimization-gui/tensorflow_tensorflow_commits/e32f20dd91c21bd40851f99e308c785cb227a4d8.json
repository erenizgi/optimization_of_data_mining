{
    "author": "EusebioDM",
    "message": "Use factory function to create `CubSortThunk`\n\nThe `CubSortThunk` constructor was calling a function that returns a `absl::StatusOr`, and ignoring non-ok statuses and just accessing the value.\n\nPresumably in prod the status is always ok, but making this failure case explicit.\n\nPiperOrigin-RevId: 826410861",
    "sha": "e32f20dd91c21bd40851f99e308c785cb227a4d8",
    "files": [
        {
            "sha": "023bf01cad4caf4041063e187c604f0cec20492c",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=e32f20dd91c21bd40851f99e308c785cb227a4d8",
            "patch": "@@ -684,6 +684,7 @@ cc_library(\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:str_format\","
        },
        {
            "sha": "915fc76b963061a3d6a6b82908252242446111d1",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cub_sort_thunk.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcub_sort_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcub_sort_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcub_sort_thunk.cc?ref=e32f20dd91c21bd40851f99e308c785cb227a4d8",
            "patch": "@@ -26,6 +26,7 @@ limitations under the License.\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n+#include \"absl/memory/memory.h\"\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n@@ -283,16 +284,29 @@ CubSortRunnerInterface::Create(PrimitiveType type,\n              : CreateCubSortRunner(type, platform_name);\n }\n \n-CubSortThunk::CubSortThunk(\n+absl::StatusOr<std::unique_ptr<CubSortThunk>> CubSortThunk::Create(\n     ThunkInfo thunk_info, PrimitiveType type,\n     std::optional<PrimitiveType> value_type,\n     absl::InlinedVector<BufferAllocation::Slice, 2> operands,\n     absl::InlinedVector<BufferAllocation::Slice, 2> results,\n     BufferAllocation::Slice scratch, bool descending, int64_t batch_size,\n-    absl::string_view platform_name)\n+    absl::string_view platform_name) {\n+  TF_ASSIGN_OR_RETURN(\n+      std::unique_ptr<CubSortRunnerInterface> runner,\n+      CubSortRunnerInterface::Create(type, value_type, platform_name));\n+\n+  return absl::WrapUnique<CubSortThunk>(\n+      new CubSortThunk(thunk_info, std::move(runner), std::move(operands),\n+                       std::move(results), scratch, descending, batch_size));\n+}\n+\n+CubSortThunk::CubSortThunk(\n+    ThunkInfo thunk_info, std::unique_ptr<CubSortRunnerInterface> runner,\n+    absl::InlinedVector<BufferAllocation::Slice, 2> operands,\n+    absl::InlinedVector<BufferAllocation::Slice, 2> results,\n+    BufferAllocation::Slice scratch, bool descending, int64_t batch_size)\n     : Thunk(Thunk::kCubSort, thunk_info),\n-      runner_(CubSortRunnerInterface::Create(type, value_type, platform_name)\n-                  .value()),\n+      runner_(std::move(runner)),\n       operands_(std::move(operands)),\n       results_(std::move(results)),\n       scratch_(scratch),"
        },
        {
            "sha": "ef483b495d51f4bfaf66c89213e60f57c2af1caa",
            "filename": "third_party/xla/xla/backends/gpu/runtime/cub_sort_thunk.h",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcub_sort_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcub_sort_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcub_sort_thunk.h?ref=e32f20dd91c21bd40851f99e308c785cb227a4d8",
            "patch": "@@ -54,12 +54,13 @@ class CubSortRunnerInterface {\n \n class CubSortThunk : public Thunk {\n  public:\n-  CubSortThunk(ThunkInfo thunk_info, PrimitiveType type,\n-               std::optional<PrimitiveType> value_type,\n-               absl::InlinedVector<BufferAllocation::Slice, 2> operands,\n-               absl::InlinedVector<BufferAllocation::Slice, 2> results,\n-               BufferAllocation::Slice scratch, bool descending,\n-               int64_t batch_size, absl::string_view platform_name);\n+  static absl::StatusOr<std::unique_ptr<CubSortThunk>> Create(\n+      ThunkInfo thunk_info, PrimitiveType type,\n+      std::optional<PrimitiveType> value_type,\n+      absl::InlinedVector<BufferAllocation::Slice, 2> operands,\n+      absl::InlinedVector<BufferAllocation::Slice, 2> results,\n+      BufferAllocation::Slice scratch, bool descending, int64_t batch_size,\n+      absl::string_view platform_name);\n \n   absl::Status ExecuteOnStream(const ExecuteParams& params) override {\n     return runner_->Run(params, this);\n@@ -72,6 +73,12 @@ class CubSortThunk : public Thunk {\n   int64_t batch_size() const { return batch_size_; }\n \n  private:\n+  CubSortThunk(ThunkInfo thunk_info,\n+               std::unique_ptr<CubSortRunnerInterface> runner,\n+               absl::InlinedVector<BufferAllocation::Slice, 2> operands,\n+               absl::InlinedVector<BufferAllocation::Slice, 2> results,\n+               BufferAllocation::Slice scratch, bool descending,\n+               int64_t batch_size);\n   std::unique_ptr<CubSortRunnerInterface> runner_;\n   absl::InlinedVector<BufferAllocation::Slice, 2> operands_;\n   absl::InlinedVector<BufferAllocation::Slice, 2> results_;"
        },
        {
            "sha": "f65f6bd6c2a08135f8727f8324d9090b38046197",
            "filename": "third_party/xla/xla/service/gpu/ir_emitter_unnested.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e32f20dd91c21bd40851f99e308c785cb227a4d8/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc?ref=e32f20dd91c21bd40851f99e308c785cb227a4d8",
            "patch": "@@ -1072,17 +1072,19 @@ absl::Status IrEmitterUnnested::EmitCubDeviceRadixSort(\n   TF_ASSIGN_OR_RETURN(xla::SortOptions options,\n                       instr->backend_config<xla::SortOptions>());\n   const Shape& operand_shape = instr->operand(0)->shape();\n-  auto thunk = std::make_unique<CubSortThunk>(\n-      Thunk::ThunkInfo::WithProfileAnnotation(\n-          instr, ir_emitter_context_->GetNextThunkId()),\n-      operand_shape.element_type(),\n-      instr->operand_count() == 2\n-          ? std::optional(instr->operand(1)->shape().element_type())\n-          : std::nullopt,\n-      operands, results, scratch, options.descending(),\n-      Product(operand_shape.dimensions()) /\n-          operand_shape.dimensions(operand_shape.dimensions().size() - 1),\n-      ir_emitter_context_->platform_name());\n+  TF_ASSIGN_OR_RETURN(\n+      std::unique_ptr<CubSortThunk> thunk,\n+      CubSortThunk::Create(\n+          Thunk::ThunkInfo::WithProfileAnnotation(\n+              instr, ir_emitter_context_->GetNextThunkId()),\n+          operand_shape.element_type(),\n+          instr->operand_count() == 2\n+              ? std::optional(instr->operand(1)->shape().element_type())\n+              : std::nullopt,\n+          operands, results, scratch, options.descending(),\n+          Product(operand_shape.dimensions()) /\n+              operand_shape.dimensions(operand_shape.dimensions().size() - 1),\n+          ir_emitter_context_->platform_name()));\n   AddThunkToThunkSequence(std::move(thunk));\n   return absl::OkStatus();\n }"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 45,
        "deletions": 21
    }
}