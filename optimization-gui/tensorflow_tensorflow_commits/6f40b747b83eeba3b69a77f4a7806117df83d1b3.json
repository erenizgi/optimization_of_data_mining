{
    "author": "alekstheod",
    "message": "PR #33681: [ROCm] Fix hermetic build\n\nImported from GitHub PR https://github.com/openxla/xla/pull/33681\n\nüìù Summary of Changes\nFix build after got broken by this pr merge: [https://github.com/openxla/xla/pull/29769](https://github.com/openxla/xla/pull/29769/files)\n\nüéØ Justification\nAdd back missing dependencies and make hipblaslt mandatory\n\nüöÄ Kind of Contribution\nPlease remove what does not apply: üêõ Bug Fix,\n\nüìä Benchmark (for Performance Improvements)\nBuild fix for rocm config, not relevant\n\nüß™ Unit Tests:\nBuild fix for rocm config, not relevant\n\nüß™ Execution Tests:\nBuild fix for rocm config, not relevant\n\nCopybara import of the project:\n\n--\n436d89a3aef19f4823f446e354eb64d615fa8fbb by Alexandros Theodoridis <atheodor@amd.com>:\n\nFix hermetic build\n\nMerging this change closes #33681\n\nPiperOrigin-RevId: 829335746",
    "sha": "6f40b747b83eeba3b69a77f4a7806117df83d1b3",
    "files": [
        {
            "sha": "d6022c80d816f277df793748d8fd905c7701cf2f",
            "filename": "third_party/xla/third_party/gpus/rocm/BUILD.tpl",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2FBUILD.tpl?ref=6f40b747b83eeba3b69a77f4a7806117df83d1b3",
            "patch": "@@ -202,10 +202,10 @@ cc_library(\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n+        \":amd_comgr\",\n         \":rocm_config\",\n         \":rocprofiler_register\",\n         \":system_libs\",\n-        \":amd_comgr\",\n     ],\n )\n \n@@ -226,19 +226,20 @@ cc_library(\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n+        \":hipblaslt\",\n         \":rocm_config\",\n-        \":hipblaslt\"\n+        \":roctracer\",\n     ],\n )\n \n cc_library(\n     name = \"rocfft\",\n     data = glob([\"%{rocm_root}/lib/librocfft*.so*\"]),\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include\",\n     ],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     linkstatic = 1,\n     visibility = [\"//visibility:public\"],\n     deps = [\":rocm_config\"],\n@@ -247,11 +248,11 @@ cc_library(\n cc_library(\n     name = \"hipfft\",\n     data = glob([\"%{rocm_root}/lib/libhipfft*.so*\"]),\n-    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include\",\n     ],\n+    linkopts = [\"-Wl,-rpath,external/local_config_rocm/rocm/%{rocm_root}/lib\"],\n     linkstatic = 1,\n     visibility = [\"//visibility:public\"],\n     deps = [\":rocm_config\"],\n@@ -358,7 +359,10 @@ cc_library(\n cc_library(\n     name = \"roctracer\",\n     hdrs = glob([\"%{rocm_root}/include/roctracer/**\"]),\n-    data = glob([\"%{rocm_root}/lib/libroctracer*.so*\"]),\n+    data = glob([\n+        \"%{rocm_root}/lib/libroctracer*.so*\",\n+        \"%{rocm_root}/lib/libroctx64.so*\",\n+    ]),\n     include_prefix = \"rocm\",\n     includes = [\n         \"%{rocm_root}/include/\",\n@@ -475,8 +479,8 @@ cc_library(\n     strip_include_prefix = \"%{rocm_root}\",\n     visibility = [\"//visibility:public\"],\n     deps = [\n-        \":rocm_config\",\n         \":hip_runtime\",\n+        \":rocm_config\",\n     ],\n )\n "
        },
        {
            "sha": "31eb2b2b66e354188c10d74fd58a8852ef2e4406",
            "filename": "third_party/xla/third_party/gpus/rocm/rocm_redist_ubuntu_22_04.bzl",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist_ubuntu_22_04.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist_ubuntu_22_04.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist_ubuntu_22_04.bzl?ref=6f40b747b83eeba3b69a77f4a7806117df83d1b3",
            "patch": "@@ -17,6 +17,14 @@ rocm_redist_ubuntu_22_04 = {\n                 url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblas/hipblas_2.4.0.60401-83~22.04_amd64.deb\",\n                 sha256 = \"9d1bb3a5006a5b69655abbd890efaad1d347b3cd66b5d0a7fe60a6885494b19b\",\n             ),\n+            struct(\n+                url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblaslt6.4.1/hipblaslt6.4.1_0.12.1.60401-83~22.04_amd64.deb\",\n+                sha256 = \"b53019fa5e46dc1ec4725960da9c30c6564db7adc10eb176f00d6dc99f565f3a\",\n+            ),\n+            struct(\n+                url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblaslt-dev6.4.1/hipblaslt-dev6.4.1_0.12.1.60401-83~22.04_amd64.deb\",\n+                sha256 = \"23a8ed2da0d56cf79336eef3d502c57daf06934e8ca7225b4e6b449e59de3dab\",\n+            ),\n             struct(\n                 url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblas-dev/hipblas-dev_2.4.0.60401-83~22.04_amd64.deb\",\n                 sha256 = \"df5dd894a6840693f060fcdd1e96c0e8cf9eed16b2763643f17a5a9c4baa69a5\",\n@@ -218,6 +226,14 @@ rocm_redist_ubuntu_22_04 = {\n                 url = \"https://repo.radeon.com/rocm/apt/6.2/pool/main/h/hipblas6.2.0/hipblas6.2.0_2.2.0.60200-66~22.04_amd64.deb\",\n                 sha256 = \"fbd647e1b13e7aa2c14c9581f9102c069ddab9ecb47a4b226d433ec37b19e92d\",\n             ),\n+            struct(\n+                url = \"https://repo.radeon.com/rocm/apt/6.2/pool/main/h/hipblaslt6.2.0/hipblaslt6.2.0_0.8.0.60200-66~22.04_amd64.deb\",\n+                sha256 = \"af3bea7cda7c1af147c3baae1cb3a8846ff571fe713c3a83d0924810bee734fe\",\n+            ),\n+            struct(\n+                url = \"https://repo.radeon.com/rocm/apt/6.2/pool/main/h/hipblaslt-dev6.2.0/hipblaslt-dev6.2.0_0.8.0.60200-66~22.04_amd64.deb\",\n+                sha256 = \"d9d2c80228ebfe74ebb98fc74fda57be498ab84ca40358355c616dfd38efded2\",\n+            ),\n             struct(\n                 url = \"https://repo.radeon.com/rocm/apt/6.2/pool/main/h/hipblas-dev6.2.0/hipblas-dev6.2.0_2.2.0.60200-66~22.04_amd64.deb\",\n                 sha256 = \"885cf3f3a52ebde9caadf6348a6cda28fd15e3bc52bab0c90b587d72b29ff7ef\","
        },
        {
            "sha": "3658342c5d98aafacb993f04a427b55c51452f4f",
            "filename": "third_party/xla/third_party/gpus/rocm/rocm_redist_ubuntu_24_04.bzl",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist_ubuntu_24_04.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist_ubuntu_24_04.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist_ubuntu_24_04.bzl?ref=6f40b747b83eeba3b69a77f4a7806117df83d1b3",
            "patch": "@@ -21,6 +21,14 @@ rocm_redist_ubuntu_24_04 = {\n                 url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblas-dev/hipblas-dev_2.4.0.60401-83~24.04_amd64.deb\",\n                 sha256 = \"4503107e2979b014870781067e2ad7976b9981e0a84fdde288a6247187e36725\",\n             ),\n+            struct(\n+                url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblaslt6.4.1/hipblaslt6.4.1_0.12.1.60401-83~24.04_amd64.deb\",\n+                sha256 = \"f3b3b5456f0b69b82c7ab1ccc9762a3a09e2ddc42b73cfa38a4c060755d5fb91\",\n+            ),\n+            struct(\n+                url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblaslt-dev6.4.1/hipblaslt-dev6.4.1_0.12.1.60401-83~22.04_amd64.deb\",\n+                sha256 = \"23a8ed2da0d56cf79336eef3d502c57daf06934e8ca7225b4e6b449e59de3dab\",\n+            ),\n             struct(\n                 url = \"https://repo.radeon.com/rocm/apt/6.4.1/pool/main/h/hipblas-common-dev/hipblas-common-dev_1.0.0.60401-83~24.04_amd64.deb\",\n                 sha256 = \"cc68c954a933b63727b9503fd55d83ca334387c5edf5bb8ba5143d04a9e6deaa\","
        },
        {
            "sha": "1c2289e60bc4dde36c2860ab9c43d1bc3e28b860",
            "filename": "third_party/xla/third_party/gpus/rocm_configure.bzl",
            "status": "modified",
            "additions": 22,
            "deletions": 35,
            "changes": 57,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6f40b747b83eeba3b69a77f4a7806117df83d1b3/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl?ref=6f40b747b83eeba3b69a77f4a7806117df83d1b3",
            "patch": "@@ -240,6 +240,7 @@ def _rocm_lib_paths(repository_ctx, lib, basedir):\n         repository_ctx.path(\"%s/lib64/stubs/%s\" % (basedir, file_name)),\n         repository_ctx.path(\"%s/lib/x86_64-linux-gnu/%s\" % (basedir, file_name)),\n         repository_ctx.path(\"%s/lib/%s\" % (basedir, file_name)),\n+        repository_ctx.path(\"%s/lib/%s.0\" % (basedir, file_name)),  # hipblaslt has this pattern\n         repository_ctx.path(\"%s/%s\" % (basedir, file_name)),\n     ]\n \n@@ -310,7 +311,7 @@ def _select_rocm_lib_paths(repository_ctx, libs_paths, bash_bin):\n \n     return libs\n \n-def _find_libs(repository_ctx, rocm_config, miopen_path, rccl_path, bash_bin):\n+def _find_libs(repository_ctx, rocm_config, bash_bin):\n     \"\"\"Returns the ROCm libraries on the system.\n \n     Args:\n@@ -321,29 +322,28 @@ def _find_libs(repository_ctx, rocm_config, miopen_path, rccl_path, bash_bin):\n     Returns:\n       Map of library names to structs of filename and path\n     \"\"\"\n+    repo_path = str(repository_ctx.path(rocm_config.rocm_toolkit_path))\n     libs_paths = [\n         (name, _rocm_lib_paths(repository_ctx, name, path))\n         for name, path in [\n-            (\"amdhip64\", rocm_config.rocm_toolkit_path),\n-            (\"rocblas\", rocm_config.rocm_toolkit_path),\n-            (\"hiprand\", rocm_config.rocm_toolkit_path),\n-            (\"MIOpen\", miopen_path),\n-            (\"rccl\", rccl_path),\n-            (\"hipsparse\", rocm_config.rocm_toolkit_path),\n-            (\"roctracer64\", rocm_config.rocm_toolkit_path),\n-            (\"rocsolver\", rocm_config.rocm_toolkit_path),\n-            (\"hipfft\", rocm_config.rocm_toolkit_path),\n-            (\"rocrand\", rocm_config.rocm_toolkit_path),\n-            (\"rocprofiler-sdk\", rocm_config.rocm_toolkit_path),\n+            (\"amdhip64\", repo_path),\n+            (\"rocblas\", repo_path),\n+            (\"hiprand\", repo_path),\n+            (\"MIOpen\", repo_path),\n+            (\"rccl\", repo_path),\n+            (\"hipsparse\", repo_path),\n+            (\"roctracer64\", repo_path),\n+            (\"rocsolver\", repo_path),\n+            (\"rocsolver\", repo_path),\n+            (\"hipsolver\", repo_path),\n+            (\"hipfft\", repo_path),\n+            (\"rocrand\", repo_path),\n+            (\"hipblas\", repo_path),\n+            (\"hipblaslt\", repo_path),\n+            (\"rocprofiler-sdk\", repo_path),\n         ]\n     ]\n-    if int(rocm_config.rocm_version_number) >= 40500:\n-        libs_paths.append((\"hipsolver\", _rocm_lib_paths(repository_ctx, \"hipsolver\", rocm_config.rocm_toolkit_path)))\n-        libs_paths.append((\"hipblas\", _rocm_lib_paths(repository_ctx, \"hipblas\", rocm_config.rocm_toolkit_path)))\n \n-    # hipblaslt may be absent even in versions of ROCm where it exists\n-    # (it is not installed by default in some containers). Autodetect.\n-    libs_paths.append((\"hipblaslt\", _rocm_lib_paths(repository_ctx, \"hipblaslt\", rocm_config.rocm_toolkit_path), True))\n     return _select_rocm_lib_paths(repository_ctx, libs_paths, bash_bin)\n \n def find_rocm_config(repository_ctx, rocm_path):\n@@ -584,16 +584,12 @@ def _create_local_rocm_repository(repository_ctx):\n     rocm_config = _setup_rocm_distro_dir(repository_ctx)\n     rocm_version_number = int(rocm_config.rocm_version_number)\n \n-    # For ROCm 5.2 and above, find MIOpen and RCCL in the main rocm lib path\n-    miopen_path = rocm_config.rocm_toolkit_path + \"/miopen\" if rocm_version_number < 50200 else rocm_config.rocm_toolkit_path\n-    rccl_path = rocm_config.rocm_toolkit_path + \"/rccl\" if rocm_version_number < 50200 else rocm_config.rocm_toolkit_path\n-\n     # Copy header and library files to execroot.\n     # rocm_toolkit_path\n     rocm_toolkit_path = _remove_root_dir(rocm_config.rocm_toolkit_path, \"rocm\")\n \n     bash_bin = get_bash_bin(repository_ctx)\n-    rocm_libs = _find_libs(repository_ctx, rocm_config, miopen_path, rccl_path, bash_bin)\n+    rocm_libs = _find_libs(repository_ctx, rocm_config, bash_bin)\n     rocm_lib_srcs = []\n     rocm_lib_outs = []\n     for lib in rocm_libs.values():\n@@ -603,8 +599,6 @@ def _create_local_rocm_repository(repository_ctx):\n \n     clang_offload_bundler_path = rocm_toolkit_path + \"/llvm/bin/clang-offload-bundler\"\n \n-    have_hipblaslt = \"1\" if rocm_libs[\"hipblaslt\"] != None else \"0\"\n-\n     # Set up BUILD file for rocm/\n     repository_ctx.template(\n         \"rocm/build_defs.bzl\",\n@@ -619,7 +613,7 @@ def _create_local_rocm_repository(repository_ctx):\n             ),\n             \"%{rocm_gpu_architectures}\": str(rocm_config.amdgpu_targets),\n             \"%{rocm_version_number}\": str(rocm_version_number),\n-            \"%{rocm_hipblaslt}\": \"True\" if rocm_libs[\"hipblaslt\"] != None else \"False\",\n+            \"%{rocm_hipblaslt}\": \"True\",\n         },\n     )\n \n@@ -632,13 +626,6 @@ def _create_local_rocm_repository(repository_ctx):\n     is_rocm_clang = _use_rocm_clang(repository_ctx)\n     tf_sysroot = _tf_sysroot(repository_ctx)\n \n-    if rocm_libs[\"hipblaslt\"] != None:\n-        repository_dict[\"%{hipblaslt_lib}\"] = rocm_libs[\"hipblaslt\"].file_name\n-\n-    if rocm_version_number >= 40500:\n-        repository_dict[\"%{hipsolver_lib}\"] = rocm_libs[\"hipsolver\"].file_name\n-        repository_dict[\"%{hipblas_lib}\"] = rocm_libs[\"hipblas\"].file_name\n-\n     multiple_paths = repository_ctx.os.environ.get(_TF_ROCM_MULTIPLE_PATHS)\n     if multiple_paths:\n         paths_list = multiple_paths.split(\":\")\n@@ -743,7 +730,7 @@ def _create_local_rocm_repository(repository_ctx):\n             \"%{rocm_version_number}\": rocm_config.rocm_version_number,\n             \"%{miopen_version_number}\": rocm_config.miopen_version_number,\n             \"%{hipruntime_version_number}\": rocm_config.hipruntime_version_number,\n-            \"%{hipblaslt_flag}\": have_hipblaslt,\n+            \"%{hipblaslt_flag}\": \"1\",\n             \"%{hip_soversion_number}\": rocm_libs[\"amdhip64\"].soversion,\n             \"%{rocblas_soversion_number}\": rocm_libs[\"rocblas\"].soversion,\n             \"%{hipblaslt_soversion_number}\": rocm_libs[\"hipblaslt\"].soversion if rocm_libs[\"hipblaslt\"] != None else \"\",\n@@ -770,7 +757,7 @@ def _create_local_rocm_repository(repository_ctx):\n             \"%{rocm_version_number}\": rocm_config.rocm_version_number,\n             \"%{miopen_version_number}\": rocm_config.miopen_version_number,\n             \"%{hipruntime_version_number}\": rocm_config.hipruntime_version_number,\n-            \"%{hipblaslt_flag}\": have_hipblaslt,\n+            \"%{hipblaslt_flag}\": \"1\",\n             \"%{hip_soversion_number}\": rocm_libs[\"amdhip64\"].soversion,\n             \"%{rocblas_soversion_number}\": rocm_libs[\"rocblas\"].soversion,\n             \"%{hipblaslt_soversion_number}\": rocm_libs[\"hipblaslt\"].soversion if rocm_libs[\"hipblaslt\"] != None else \"\","
        }
    ],
    "stats": {
        "total": 97,
        "additions": 56,
        "deletions": 41
    }
}