{
    "author": "shawnwang18",
    "message": "PR #32688: [XLA:GPU] Enable command buffer DynamicSliceCopyFusion command unrolling\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32688\n\nüìù Summary of Changes\nThis PR enables command buffer DynamicSliceCopy command to be recorded into an unrolled cuda-graph, when it is surrounded by WhileCmd\n\nüéØ Justification\nThis feature is required if we want to fully command buffer WhileCmd into an unrolled cuda-graph.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply:\n‚ú® New Feature\n\nüß™ Unit Tests:\nxla/backends/gpu/runtime/command_buffer_cmd_test.cc: CommandBufferCmdTest:DynamicSliceCopyFusionCmd\n\nCopybara import of the project:\n\n--\nfeb2902fca397360460f6b9788ac0f7482cb547c by Shawn Wang <shawnw@nvidia.com>:\n\nEnable command buffer DynamicSliceCopyFusion command unrolling\n\nMerging this change closes #32688\n\nPiperOrigin-RevId: 822104580",
    "sha": "97c777acc42ccfedce4693ad27ab4f795a6c2513",
    "files": [
        {
            "sha": "9421c6a697b45e550d8bc8382b032b9552d718c3",
            "filename": "third_party/xla/xla/backends/gpu/runtime/command_buffer_cmd.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.cc?ref=97c777acc42ccfedce4693ad27ab4f795a6c2513",
            "patch": "@@ -2730,8 +2730,12 @@ DynamicSliceCopyFusionCmd::Record(const Thunk::ExecuteParams& execute_params,\n       [&](const se::CommandBuffer::Command* command) {\n         int64_t iteration_index = 0;\n         if (offsets_.depends_on_loop) {\n-          TF_ASSIGN_OR_RETURN(iteration_index,\n-                              WhileThunk::CurrentLoopIteration());\n+          if (WhileThunk::RunningWhileThunkLoop()) {\n+            TF_ASSIGN_OR_RETURN(iteration_index,\n+                                WhileThunk::CurrentLoopIteration());\n+          } else {\n+            iteration_index = record_params.unroll_iteration;\n+          }\n         }\n         int64_t src_offset = offsets_.src_offsets[iteration_index];\n         int64_t dst_offset = offsets_.dst_offsets[iteration_index];"
        },
        {
            "sha": "927f1819a539621200bb3f8eef3453cd9e7d6550",
            "filename": "third_party/xla/xla/backends/gpu/runtime/command_buffer_cmd.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_cmd.h?ref=97c777acc42ccfedce4693ad27ab4f795a6c2513",
            "patch": "@@ -1298,7 +1298,7 @@ class DynamicSliceCopyFusionCmd : public CommandBufferCmd {\n \n   bool force_update() override { return offsets_.depends_on_loop; }\n \n-  bool support_loop_unroll() override { return false; }\n+  bool support_loop_unroll() override { return true; }\n \n   BufferUseVector buffers() const override;\n "
        },
        {
            "sha": "d3bf9bf87d62b153f092e69042891be056399804",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.cc?ref=97c777acc42ccfedce4693ad27ab4f795a6c2513",
            "patch": "@@ -61,6 +61,8 @@ static std::list<RunningLoop>& RunningLoops() {\n   return loops;\n }\n \n+bool WhileThunk::RunningWhileThunkLoop() { return RunningLoops().size() > 0; }\n+\n absl::StatusOr<int64_t> WhileThunk::CurrentLoopIteration(int64_t depth) {\n   if (depth >= RunningLoops().size()) {\n     return absl::InvalidArgumentError(absl::StrFormat("
        },
        {
            "sha": "3eee1134927d245c07b03eb4316910b938dc80e5",
            "filename": "third_party/xla/xla/backends/gpu/runtime/while_thunk.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fwhile_thunk.h?ref=97c777acc42ccfedce4693ad27ab4f795a6c2513",
            "patch": "@@ -87,6 +87,7 @@ class WhileThunk : public Thunk {\n   //\n   // Implementation relies on thread local storage, be careful when call it from\n   // code running on multiple threads.\n+  static bool RunningWhileThunkLoop();\n   static absl::StatusOr<int64_t> CurrentLoopIteration(int64_t depth = 0);\n   static absl::StatusOr<int64_t> CurrentLoopIteration(\n       const HloInstruction* while_instr);"
        },
        {
            "sha": "9f6b05bfe5f3d5cdc1da5fb4538f0cc3c878dbc6",
            "filename": "third_party/xla/xla/service/gpu/tests/command_buffer_test.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fcommand_buffer_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/97c777acc42ccfedce4693ad27ab4f795a6c2513/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fcommand_buffer_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftests%2Fcommand_buffer_test.cc?ref=97c777acc42ccfedce4693ad27ab4f795a6c2513",
            "patch": "@@ -576,6 +576,28 @@ TEST_P(CommandBufferTest, DynamicSliceCopyFusionCmd) {\n \n   EXPECT_TRUE(\n       RunAndCompareNoHloPasses(std::move(module), ErrorSpec{1e-3, 2e-3}));\n+\n+  if (!IsAtLeastCuda12900(GpuExecutor())) {\n+    GTEST_SKIP() << \"While loop unrolling is not supported for CUDA < 12.9\";\n+  }\n+\n+  debug_options.add_xla_gpu_enable_command_buffer(\n+      DebugOptions::DYNAMIC_SLICE_COPY_FUSION);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::FUSION);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::CUBLAS);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::CUBLASLT);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::CUSTOM_CALL);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::CUDNN);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::COLLECTIVES);\n+  debug_options.add_xla_gpu_enable_command_buffer(DebugOptions::WHILE);\n+  debug_options.set_xla_gpu_command_buffer_unroll_loops(true);\n+  config.set_debug_options(debug_options);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto unrolled_module,\n+                          ParseAndReturnVerifiedModule(hlo_text, config));\n+\n+  EXPECT_TRUE(RunAndCompareNoHloPasses(std::move(unrolled_module),\n+                                       ErrorSpec{1e-3, 2e-3}));\n }\n \n TEST_P(CommandBufferUnrollTest, WhileLoop) {"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 32,
        "deletions": 3
    }
}