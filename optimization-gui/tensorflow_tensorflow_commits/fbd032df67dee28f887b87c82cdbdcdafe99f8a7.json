{
    "author": "ezhulenev",
    "message": "[xla:cpu] Pass HloModule pointer to Thunk SerDes\n\nReverts 993369077a7da432be091fdf7abc3fbd370ecdf1\n\nPiperOrigin-RevId: 826675119",
    "sha": "fbd032df67dee28f887b87c82cdbdcdafe99f8a7",
    "files": [
        {
            "sha": "48a7c4d797768935917fbe7504d3d01a0574c4aa",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=fbd032df67dee28f887b87c82cdbdcdafe99f8a7",
            "patch": "@@ -1203,6 +1203,7 @@ cc_library(\n         \"//xla/backends/cpu/runtime/xnnpack:xnn_convolution_thunk\",\n         \"//xla/backends/cpu/runtime/xnnpack:xnn_dot_thunk\",\n         \"//xla/backends/cpu/runtime/xnnpack:xnn_fusion_thunk\",\n+        \"//xla/hlo/ir:hlo\",\n         \"//xla/runtime:resource_use\",\n         \"//xla/runtime:work_group\",\n         \"//xla/service:buffer_assignment\","
        },
        {
            "sha": "c611b356c7ce3ce5fe0b84b9092c0fc74c6f26e6",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_proto_serdes.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 23,
            "changes": 53,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.cc?ref=fbd032df67dee28f887b87c82cdbdcdafe99f8a7",
            "patch": "@@ -344,6 +344,7 @@ class ThunkSerDesProtobuf : public SerDesBase<Thunk> {\n  public:\n   // Buffer allocations and resources are not needed for serialization.\n   explicit ThunkSerDesProtobuf(\n+      const HloModule* hlo_module = nullptr,\n       const std::vector<BufferAllocation>* buffer_allocations = nullptr,\n       const std::vector<std::shared_ptr<Resource>>* thunk_resources = nullptr);\n   absl::StatusOr<std::string> Serialize(const Thunk& thunk) override;\n@@ -356,16 +357,18 @@ class ThunkSerDesProtobuf : public SerDesBase<Thunk> {\n       const ThunkProto& proto) const;\n \n  private:\n-  // TODO(basiol) remove NOLINT when this actually gets used\n-  const std::vector<BufferAllocation>* buffer_allocations_;  // NOLINT\n+  const HloModule* hlo_module_;\n+  const std::vector<BufferAllocation>* buffer_allocations_;\n \n   const std::vector<std::shared_ptr<Resource>>* thunk_resources_;\n };\n \n ThunkSerDesProtobuf::ThunkSerDesProtobuf(\n+    const HloModule* hlo_module,\n     const std::vector<BufferAllocation>* buffer_allocations,\n     const std::vector<std::shared_ptr<Resource>>* thunk_resources)\n-    : buffer_allocations_(buffer_allocations),\n+    : hlo_module_(hlo_module),\n+      buffer_allocations_(buffer_allocations),\n       thunk_resources_(thunk_resources) {}\n \n absl::StatusOr<std::string> ThunkSerDesProtobuf::Serialize(const Thunk& thunk) {\n@@ -1087,9 +1090,10 @@ ReduceScatterThunkFromProto(\n }\n \n static absl::StatusOr<std::unique_ptr<CallThunk>> CallThunkFromProto(\n-    const ThunkProto& proto,\n-    const std::vector<BufferAllocation>& buffer_allocations) {\n-  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(&buffer_allocations);\n+    const ThunkProto& proto, const HloModule* hlo_module,\n+    const std::vector<BufferAllocation>* buffer_allocations) {\n+  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(hlo_module,\n+                                                    buffer_allocations);\n \n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<ThunkSequence> call_sequence,\n@@ -1101,9 +1105,10 @@ static absl::StatusOr<std::unique_ptr<CallThunk>> CallThunkFromProto(\n \n static absl::StatusOr<std::unique_ptr<ConditionalThunk>>\n ConditionalThunkFromProto(\n-    const ThunkProto& proto,\n-    const std::vector<BufferAllocation>& buffer_allocations) {\n-  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(&buffer_allocations);\n+    const ThunkProto& proto, const HloModule* hlo_module,\n+    const std::vector<BufferAllocation>* buffer_allocations) {\n+  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(hlo_module,\n+                                                    buffer_allocations);\n \n   std::vector<ThunkSequence> branch_sequences;\n   for (const ThunkSequenceProto& branch_sequence_proto :\n@@ -1114,10 +1119,10 @@ ConditionalThunkFromProto(\n   }\n   TF_ASSIGN_OR_RETURN(Thunk::Info info, ThunkInfoFromProto(proto.info()));\n \n-  TF_ASSIGN_OR_RETURN(\n-      BufferAllocation::Slice branch_index_buffer,\n-      BufferAllocation::Slice::FromProto(\n-          proto.conditional_thunk().branch_index_buffer(), buffer_allocations));\n+  TF_ASSIGN_OR_RETURN(BufferAllocation::Slice branch_index_buffer,\n+                      BufferAllocation::Slice::FromProto(\n+                          proto.conditional_thunk().branch_index_buffer(),\n+                          *buffer_allocations));\n \n   return ConditionalThunk::Create(std::move(info),\n                                   std::move(branch_index_buffer),\n@@ -1480,9 +1485,10 @@ static absl::StatusOr<std::unique_ptr<TopKThunk>> TopKThunkFromProto(\n }\n \n static absl::StatusOr<std::unique_ptr<WhileThunk>> WhileThunkFromProto(\n-    const ThunkProto& proto,\n-    const std::vector<BufferAllocation>& buffer_allocations) {\n-  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(&buffer_allocations);\n+    const ThunkProto& proto, const HloModule* hlo_module,\n+    const std::vector<BufferAllocation>* buffer_allocations) {\n+  ThunkSequenceSerDesProtobuf thunk_sequence_serdes(hlo_module,\n+                                                    buffer_allocations);\n \n   TF_ASSIGN_OR_RETURN(\n       std::unique_ptr<ThunkSequence> cond_sequence,\n@@ -1496,7 +1502,7 @@ static absl::StatusOr<std::unique_ptr<WhileThunk>> WhileThunkFromProto(\n   TF_ASSIGN_OR_RETURN(\n       BufferAllocation::Slice cond_buffer,\n       BufferAllocation::Slice::FromProto(proto.while_thunk().cond_buffer(),\n-                                         buffer_allocations));\n+                                         *buffer_allocations));\n \n   std::optional<int64_t> trip_count = std::nullopt;\n   if (proto.while_thunk().trip_count().contains_value()) {\n@@ -1662,9 +1668,9 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n       }\n     }\n     case Thunk::Kind::kCall:\n-      return CallThunkFromProto(proto, *buffer_allocations_);\n+      return CallThunkFromProto(proto, hlo_module_, buffer_allocations_);\n     case Thunk::Kind::kConditional:\n-      return ConditionalThunkFromProto(proto, *buffer_allocations_);\n+      return ConditionalThunkFromProto(proto, hlo_module_, buffer_allocations_);\n     case Thunk::Kind::kConvolution:\n       return ConvolutionThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kCopy:\n@@ -1688,7 +1694,7 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n     case Thunk::Kind::kTopK:\n       return TopKThunkFromProto(proto, *buffer_allocations_);\n     case Thunk::Kind::kWhile:\n-      return WhileThunkFromProto(proto, *buffer_allocations_);\n+      return WhileThunkFromProto(proto, hlo_module_, buffer_allocations_);\n     case Thunk::Kind::kXnnFusion: {\n       TF_ASSIGN_OR_RETURN(\n           auto xnn_fusion_kind,\n@@ -1715,8 +1721,9 @@ absl::StatusOr<std::unique_ptr<Thunk>> ThunkSerDesProtobuf::FromProto(\n }\n \n ThunkSequenceSerDesProtobuf::ThunkSequenceSerDesProtobuf(\n+    const HloModule* hlo_module,\n     const std::vector<BufferAllocation>* buffer_allocations)\n-    : buffer_allocations_(buffer_allocations) {}\n+    : hlo_module_(hlo_module), buffer_allocations_(buffer_allocations) {}\n \n absl::StatusOr<std::string> ThunkSequenceSerDesProtobuf::Serialize(\n     const ThunkSequence& thunk_sequence) {\n@@ -1736,7 +1743,7 @@ ThunkSequenceSerDesProtobuf::Deserialize(const std::string& serialized) {\n \n absl::StatusOr<ThunkSequenceProto> ThunkSequenceSerDesProtobuf::ToProto(\n     const ThunkSequence& thunk_sequence) const {\n-  ThunkSerDesProtobuf thunk_serdes(buffer_allocations_);\n+  ThunkSerDesProtobuf thunk_serdes(hlo_module_, buffer_allocations_);\n   ThunkSequenceProto proto;\n   proto.mutable_thunks()->Reserve(thunk_sequence.size());\n \n@@ -1798,7 +1805,7 @@ ThunkSequenceSerDesProtobuf::FromProto(const ThunkSequenceProto& proto) const {\n \n   size_t thunk_index = 0;\n   for (const ThunkProto& thunk_proto : proto.thunks()) {\n-    ThunkSerDesProtobuf thunk_serdes(buffer_allocations_,\n+    ThunkSerDesProtobuf thunk_serdes(hlo_module_, buffer_allocations_,\n                                      &thunk_resources[thunk_index++]);\n     TF_ASSIGN_OR_RETURN(std::unique_ptr<Thunk> thunk,\n                         thunk_serdes.FromProto(thunk_proto));"
        },
        {
            "sha": "08b4deaaf91838265d1ccf6dbf52b3326fcc99e0",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_proto_serdes.h",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_proto_serdes.h?ref=fbd032df67dee28f887b87c82cdbdcdafe99f8a7",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/serdes_base.h\"\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n+#include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/service/buffer_assignment.h\"\n \n namespace xla::cpu {\n@@ -36,10 +37,13 @@ void ForEachThunkProto(const ThunkSequenceProto& proto,\n \n class ThunkSequenceSerDesProtobuf : public SerDesBase<ThunkSequence> {\n  public:\n+  // For serialization, `hlo_module` and `buffer_allocations` are optional. For\n+  // deserialization, both are required as we rely on the HLO module to resolve\n+  // thunks that were generated from `HloComputation`s, and we also need buffer\n+  // allocations to resolve buffer slices.\n   explicit ThunkSequenceSerDesProtobuf(\n-      const std::vector<BufferAllocation>* buffer_allocations =\n-          nullptr);  // NOTE buffer allocations aren't\n-                     // needed for serialization.\n+      const HloModule* hlo_module = nullptr,\n+      const std::vector<BufferAllocation>* buffer_allocations = nullptr);\n \n   absl::StatusOr<std::string> Serialize(\n       const ThunkSequence& thunk_sequence) override;\n@@ -52,6 +56,7 @@ class ThunkSequenceSerDesProtobuf : public SerDesBase<ThunkSequence> {\n       const ThunkSequenceProto& proto) const;\n \n  private:\n+  const HloModule* hlo_module_;\n   const std::vector<BufferAllocation>* buffer_allocations_;\n };\n "
        },
        {
            "sha": "2fc4d850d1078e61af72d69b300e92f9db777560",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_sequence_serdes_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc?ref=fbd032df67dee28f887b87c82cdbdcdafe99f8a7",
            "patch": "@@ -219,8 +219,8 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n \n  public:\n   void SetUp() override {\n-    thunk_sequence_serdes_ =\n-        std::make_unique<T>(&buffer_allocations_.GetUnderlyingVector());\n+    thunk_sequence_serdes_ = std::make_unique<T>(\n+        nullptr, &buffer_allocations_.GetUnderlyingVector());\n   }\n \n  protected:"
        },
        {
            "sha": "959cde89ffa095b23877caa5332deb9075c93e7c",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compilation_result.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/fbd032df67dee28f887b87c82cdbdcdafe99f8a7/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compilation_result.cc?ref=fbd032df67dee28f887b87c82cdbdcdafe99f8a7",
            "patch": "@@ -82,7 +82,7 @@ CpuAotCompilationResult::Create(\n     std::unique_ptr<HloProfilePrinterData> hlo_profile_printer_data,\n     TargetMachineOptionsProto target_machine_options) {\n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n-      &buffer_assignment->Allocations());\n+      hlo_module, &buffer_assignment->Allocations());\n   TF_ASSIGN_OR_RETURN(ThunkSequenceProto thunk_proto,\n                       thunk_sequence_serdes.ToProto(thunks));\n \n@@ -143,7 +143,7 @@ CpuAotCompilationResult::CpuAotCompilationResult(\n   module_ = hlo_module->Clone();\n \n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n-      &buffer_assignment->Allocations());\n+      hlo_module, &buffer_assignment->Allocations());\n   *proto_.mutable_thunk_sequence() = thunks;\n }\n \n@@ -181,7 +181,7 @@ CpuAotCompilationResult::LoadExecutable(\n   }\n \n   ThunkSequenceSerDesProtobuf thunk_sequence_serdes(\n-      &buffer_assignment->Allocations());\n+      module.get(), &buffer_assignment->Allocations());\n   TF_ASSIGN_OR_RETURN(std::unique_ptr<ThunkSequence> thunks,\n                       thunk_sequence_serdes.FromProto(proto_.thunk_sequence()));\n "
        }
    ],
    "stats": {
        "total": 75,
        "additions": 44,
        "deletions": 31
    }
}