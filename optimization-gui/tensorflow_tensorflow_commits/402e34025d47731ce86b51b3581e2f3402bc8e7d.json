{
    "author": "tensorflower-gardener",
    "message": "#HLODiff Add unique identifiers and hover effects to HLO diff HTML rendering.\n\nPiperOrigin-RevId: 797510270",
    "sha": "402e34025d47731ce86b51b3581e2f3402bc8e7d",
    "files": [
        {
            "sha": "48f42e647a2cab6dd73ff8315e50c716920b37d6",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/render/hlo_gumgraph_html_renderer.cc",
            "status": "modified",
            "additions": 60,
            "deletions": 3,
            "changes": 63,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/402e34025d47731ce86b51b3581e2f3402bc8e7d/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/402e34025d47731ce86b51b3581e2f3402bc8e7d/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Frender%2Fhlo_gumgraph_html_renderer.cc?ref=402e34025d47731ce86b51b3581e2f3402bc8e7d",
            "patch": "@@ -216,6 +216,10 @@ std::string PrintCss() {\n       border: 1px solid #4285F4;\n     }\n \n+    span.bordered {\n+      border: 1px solid #4285F4;\n+    }\n+\n     span.red-highlight {\n       background-color: #fad2cf;\n     }\n@@ -256,6 +260,39 @@ std::string PrintJavascript() {\n   )html\";\n }\n \n+std::string PrintJavascriptForHoverEvent() {\n+  return R\"html(\n+  <script>\n+  const allSpans = document.querySelectorAll('span[data-diffid]');\n+  allSpans.forEach(span => {\n+      span.addEventListener('mouseover', handleMouseOver);\n+      span.addEventListener('mouseout', handleMouseOut);\n+  });\n+  function handleMouseOver(event) {\n+      const diffId = event.target.getAttribute('data-diffid');\n+      if (!diffId) {\n+          return;\n+      }\n+      const relatedSpans = document.querySelectorAll(`span[data-diffid=\"${diffId}\"]`);\n+      relatedSpans.forEach(relatedSpan => {\n+          relatedSpan.classList.add('bordered');\n+      });\n+  }\n+\n+  function handleMouseOut(event) {\n+      const diffId = event.target.getAttribute('data-diffid');\n+      if (!diffId) {\n+          return;\n+      }\n+      const relatedSpans = document.querySelectorAll(`span[data-diffid=\"${diffId}\"]`);\n+      relatedSpans.forEach(relatedSpan => {\n+          relatedSpan.classList.remove('bordered');\n+      });\n+  }\n+  </script>\n+  )html\";\n+}\n+\n // Escapes the string for html attribute.\n std::string EscapeStringForHtmlAttribute(absl::string_view str) {\n   std::string escaped_str;\n@@ -383,6 +420,7 @@ std::string PrintTextbox(absl::string_view title, absl::string_view content,\n // span element in the HTML output.\n struct Attributes {\n   std::string highlight;\n+  std::string diffid;\n };\n \n // Generate span attributes for all instructions given diff result.\n@@ -397,8 +435,19 @@ absl::flat_hash_map<const HloInstruction*, Attributes> GenerateSpanAttributes(\n   }\n   for (const auto& [l_instruction, r_instruction] :\n        diff_result.changed_instructions) {\n-    span_attributes[l_instruction] = {\"yellow-highlight\"};\n-    span_attributes[r_instruction] = {\"yellow-highlight\"};\n+    span_attributes[l_instruction] = {\n+        \"yellow-highlight\",\n+        absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+    span_attributes[r_instruction] = {\n+        \"yellow-highlight\",\n+        absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+  }\n+  for (const auto& [l_instruction, r_instruction] :\n+       diff_result.unchanged_instructions) {\n+    span_attributes[l_instruction] = {\n+        \"\", absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n+    span_attributes[r_instruction] = {\n+        \"\", absl::StrCat(l_instruction->name(), \"::\", r_instruction->name())};\n   }\n   return span_attributes;\n };\n@@ -445,8 +494,14 @@ std::string PrintHloComputationToHtml(\n           it != span_attributes.end() && !it->second.highlight.empty()\n               ? std::string(it->second.highlight)\n               : \"\";\n+      std::string diffid =\n+          it != span_attributes.end() && !it->second.diffid.empty()\n+              ? absl::StrCat(\"data-diffid=\\\"\",\n+                             EscapeStringForHtmlAttribute(it->second.diffid),\n+                             \"\\\"\")\n+              : \"\";\n       printer.Append(absl::StrCat(\"<span class=\\\"hlo-instruction \",\n-                                  highlight_class, \"\\\" >\"));\n+                                  highlight_class, \"\\\"\", diffid, \" >\"));\n \n       if (instruction == comp->root_instruction()) {\n         printer.Append(\"ROOT \");\n@@ -1046,6 +1101,8 @@ void RenderHtml(const DiffResult& diff_result, const DiffSummary& diff_summary,\n                               filtered_diff_result.changed_instructions.size()),\n               PrintChangedInstructions(\n                   filtered_diff_result.changed_instructions, url_generator))));\n+\n+  out << PrintJavascriptForHoverEvent();\n }\n \n }  // namespace hlo_diff"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 60,
        "deletions": 3
    }
}