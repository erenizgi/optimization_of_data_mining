{
    "author": "d4n1elchen",
    "message": "[XLA:HLO Diff] Add diff codes to diff result.\n\nAdd diff codes to diff result to be able to use them in summary.\nMove the diff code enum to hlo_diff_result.h.\nMove the helper functions to update the diff result to the class.\n\nPiperOrigin-RevId: 803087034",
    "sha": "60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
    "files": [
        {
            "sha": "17b23bdc9d4630d1136bb933d001c305d7020ea3",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_result.cc",
            "status": "modified",
            "additions": 50,
            "deletions": 18,
            "changes": 68,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result.cc?ref=60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
            "patch": "@@ -42,6 +42,39 @@ bool IsChangedInstruction(const HloInstructionNode* left_node,\n \n }  // namespace\n \n+void DiffResult::AddUnchangedInstruction(const HloInstruction* left,\n+                                         const HloInstruction* right) {\n+  unchanged_instructions[left] = right;\n+  left_diff_codes[left] = DiffCode::kUnchanged;\n+  right_diff_codes[right] = DiffCode::kUnchanged;\n+}\n+\n+void DiffResult::AddChangedInstruction(const HloInstruction* left,\n+                                       const HloInstruction* right) {\n+  changed_instructions[left] = right;\n+  left_diff_codes[left] = DiffCode::kChanged;\n+  right_diff_codes[right] = DiffCode::kChanged;\n+}\n+\n+void DiffResult::AddMovedInstruction(const HloInstruction* left,\n+                                     const HloInstruction* right) {\n+  moved_instructions[left] = right;\n+  left_diff_codes[left] = DiffCode::kUnchanged;\n+  right_diff_codes[right] = DiffCode::kUnchanged;\n+}\n+\n+void DiffResult::AddUnmatchedInstruction(const HloInstruction* left,\n+                                         const HloInstruction* right) {\n+  if (left != nullptr) {\n+    left_module_unmatched_instructions.insert(left);\n+    left_diff_codes[left] = DiffCode::kUnmatched;\n+  }\n+  if (right != nullptr) {\n+    right_module_unmatched_instructions.insert(right);\n+    right_diff_codes[right] = DiffCode::kUnmatched;\n+  }\n+}\n+\n std::unique_ptr<const DiffResult> ConstructDiffResult(\n     const HloGumgraph& left_graph, const HloGumgraph& right_graph,\n     const HloGumgraphMappings& mappings) {\n@@ -64,8 +97,7 @@ std::unique_ptr<const DiffResult> ConstructDiffResult(\n \n     // The node is unmatched\n     if (!mappings.InstructionMapContainsLeft(left_node)) {\n-      diff_result->left_module_unmatched_instructions.insert(\n-          left_node->instruction);\n+      diff_result->AddUnmatchedInstruction(left_node->instruction, nullptr);\n       continue;\n     }\n \n@@ -84,19 +116,19 @@ std::unique_ptr<const DiffResult> ConstructDiffResult(\n         mapping_props->matcher_debug_info;\n \n     if (IsChangedInstruction(left_node, right_node)) {\n-      diff_result->changed_instructions[left_node->instruction] =\n-          right_node->instruction;\n+      diff_result->AddChangedInstruction(left_node->instruction,\n+                                         right_node->instruction);\n       continue;\n     }\n     // If node position is unchanged, add to unchanged instructions.\n     if (mapping_props->unchanged) {\n-      diff_result->unchanged_instructions[left_node->instruction] =\n-          right_node->instruction;\n+      diff_result->AddUnchangedInstruction(left_node->instruction,\n+                                           right_node->instruction);\n       continue;\n     }\n     // TODO(b/369851244): Add moved instructions to diff result.\n-    diff_result->unchanged_instructions[left_node->instruction] =\n-        right_node->instruction;\n+    diff_result->AddUnchangedInstruction(left_node->instruction,\n+                                         right_node->instruction);\n   }\n \n   for (const HloInstructionNode* right_node : right_all_nodes) {\n@@ -106,8 +138,7 @@ std::unique_ptr<const DiffResult> ConstructDiffResult(\n     diff_result->node_props_right.insert(\n         {right_node->instruction, right_node->props});\n     if (!mappings.InstructionMapContainsRight(right_node)) {\n-      diff_result->right_module_unmatched_instructions.insert(\n-          right_node->instruction);\n+      diff_result->AddUnmatchedInstruction(nullptr, right_node->instruction);\n     }\n   }\n \n@@ -160,20 +191,21 @@ DiffResult DiffResult::FromProto(const DiffResultProto& proto,\n   DiffResult diff_result;\n   for (const MatchedInstructionPairProto& pair :\n        proto.unchanged_instructions()) {\n-    diff_result.unchanged_instructions[left_instructions_by_name[pair.left()]] =\n-        right_instructions_by_name[pair.right()];\n+    diff_result.AddUnchangedInstruction(\n+        left_instructions_by_name[pair.left()],\n+        right_instructions_by_name[pair.right()]);\n   }\n   for (const MatchedInstructionPairProto& pair : proto.changed_instructions()) {\n-    diff_result.changed_instructions[left_instructions_by_name[pair.left()]] =\n-        right_instructions_by_name[pair.right()];\n+    diff_result.AddChangedInstruction(left_instructions_by_name[pair.left()],\n+                                      right_instructions_by_name[pair.right()]);\n   }\n   for (const std::string& name : proto.left_unmatched_instructions()) {\n-    diff_result.left_module_unmatched_instructions.insert(\n-        left_instructions_by_name[name]);\n+    diff_result.AddUnmatchedInstruction(left_instructions_by_name[name],\n+                                        nullptr);\n   }\n   for (const std::string& name : proto.right_unmatched_instructions()) {\n-    diff_result.right_module_unmatched_instructions.insert(\n-        right_instructions_by_name[name]);\n+    diff_result.AddUnmatchedInstruction(nullptr,\n+                                        right_instructions_by_name[name]);\n   }\n \n   return diff_result;"
        },
        {
            "sha": "1e7019b98babf72e3df4495e70fb5322ba641be3",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_result.h",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result.h?ref=60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
            "patch": "@@ -17,6 +17,7 @@\n #ifndef XLA_HLO_TOOLS_HLO_DIFF_HLO_DIFF_RESULT_H_\n #define XLA_HLO_TOOLS_HLO_DIFF_HLO_DIFF_RESULT_H_\n \n+#include <cstdint>\n #include <memory>\n #include <string>\n #include <utility>\n@@ -32,6 +33,12 @@\n namespace xla {\n namespace hlo_diff {\n \n+enum DiffCode : uint8_t {\n+  kUnchanged,\n+  kChanged,\n+  kUnmatched,\n+};\n+\n // Result of diff'ng the left and right HLO modules. Contains the matched and\n // unmatched instructions in the two modules.\n struct DiffResult {\n@@ -48,6 +55,10 @@ struct DiffResult {\n   absl::flat_hash_set<const HloInstruction*>\n       right_module_unmatched_instructions;\n \n+  // Diff codes.\n+  absl::flat_hash_map<const HloInstruction*, DiffCode> left_diff_codes;\n+  absl::flat_hash_map<const HloInstruction*, DiffCode> right_diff_codes;\n+\n   // Debug info.\n   absl::flat_hash_map<std::pair<const HloInstruction*, const HloInstruction*>,\n                       MatcherType>\n@@ -60,6 +71,16 @@ struct DiffResult {\n   absl::flat_hash_map<const HloInstruction*, HloInstructionNodeProps>\n       node_props_right;\n \n+  // Methods to add diffs.\n+  void AddUnchangedInstruction(const HloInstruction* left,\n+                               const HloInstruction* right);\n+  void AddChangedInstruction(const HloInstruction* left,\n+                             const HloInstruction* right);\n+  void AddMovedInstruction(const HloInstruction* left,\n+                           const HloInstruction* right);\n+  void AddUnmatchedInstruction(const HloInstruction* left,\n+                               const HloInstruction* right);\n+\n   // Converts the diff result to a proto.\n   DiffResultProto ToProto() const;\n "
        },
        {
            "sha": "fb7f2e00ea15b064d10f68fda6da95103946b85e",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_result_test.cc",
            "status": "modified",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_result_test.cc?ref=60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
            "patch": "@@ -102,6 +102,23 @@ ENTRY entry {\n               UnorderedElementsAre(Pair(\n                   Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n                   Pointee(Property(&HloInstruction::name, \"parameter.1\")))));\n+\n+  EXPECT_THAT(diff_result->left_diff_codes,\n+              UnorderedElementsAre(\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+                       DiffCode::kChanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n+                       DiffCode::kUnchanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+                       DiffCode::kChanged)));\n+  EXPECT_THAT(diff_result->right_diff_codes,\n+              UnorderedElementsAre(\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+                       DiffCode::kChanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n+                       DiffCode::kUnchanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+                       DiffCode::kChanged)));\n }\n \n TEST_F(HloDiffTest, MatchedDifferentFingerprintMarkAsChanged) {\n@@ -169,6 +186,23 @@ ENTRY entry {\n   //             UnorderedElementsAre(\n   //                 Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n   //                      Pointee(Property(&HloInstruction::name, \"add.0\")))));\n+\n+  EXPECT_THAT(diff_result->left_diff_codes,\n+              UnorderedElementsAre(\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+                       DiffCode::kChanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n+                       DiffCode::kChanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+                       DiffCode::kChanged)));\n+  EXPECT_THAT(diff_result->right_diff_codes,\n+              UnorderedElementsAre(\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+                       DiffCode::kChanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n+                       DiffCode::kChanged),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+                       DiffCode::kChanged)));\n }\n \n TEST_F(HloDiffTest, UnmatchedInstructionsMarkAsUnmatched) {\n@@ -226,6 +260,23 @@ ENTRY entry {\n               UnorderedElementsAre(\n                   Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n                   Pointee(Property(&HloInstruction::name, \"parameter.1\"))));\n+\n+  EXPECT_THAT(diff_result->left_diff_codes,\n+              UnorderedElementsAre(\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+                       DiffCode::kUnmatched),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n+                       DiffCode::kUnmatched),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+                       DiffCode::kUnchanged)));\n+  EXPECT_THAT(diff_result->right_diff_codes,\n+              UnorderedElementsAre(\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+                       DiffCode::kUnmatched),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"parameter.1\")),\n+                       DiffCode::kUnmatched),\n+                  Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+                       DiffCode::kUnchanged)));\n }\n \n TEST_F(HloDiffTest, ShortFormConstantsMatched) {\n@@ -298,6 +349,25 @@ ENTRY entry {\n                Pointee(Property(&HloInstruction::name, \"parameter.0\"))),\n           Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n                Pointee(Property(&HloInstruction::name, \"add.0\")))));\n+\n+  EXPECT_THAT(\n+      diff_result->left_diff_codes,\n+      UnorderedElementsAre(\n+          Pair(Pointee(Property(&HloInstruction::name, \"constant.2958\")),\n+               DiffCode::kUnchanged),\n+          Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+               DiffCode::kUnchanged),\n+          Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+               DiffCode::kUnchanged)));\n+  EXPECT_THAT(\n+      diff_result->right_diff_codes,\n+      UnorderedElementsAre(\n+          Pair(Pointee(Property(&HloInstruction::name, \"constant.2958\")),\n+               DiffCode::kUnchanged),\n+          Pair(Pointee(Property(&HloInstruction::name, \"parameter.0\")),\n+               DiffCode::kUnchanged),\n+          Pair(Pointee(Property(&HloInstruction::name, \"add.0\")),\n+               DiffCode::kUnchanged)));\n }\n \n TEST_F(HloDiffTest, DiffResultToAndFromProtoWorks) {"
        },
        {
            "sha": "f565a6e166d62b214b7471b3bb0fcd5f104d5446",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 52,
            "changes": 81,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.cc?ref=60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
            "patch": "@@ -116,34 +116,22 @@ MainMatchedComputationResult FindMainMatchedComputation(\n   return result;\n }\n \n-uint64_t GetDiffTypeFingerprint(\n-    const HloInstruction* instruction,\n-    const absl::flat_hash_set<const HloInstruction*>& changed_instructions,\n-    const absl::flat_hash_set<const HloInstruction*>& unmatched_instructions) {\n-  if (changed_instructions.contains(instruction)) {\n-    return DiffCode::kChanged;\n-  }\n-  if (unmatched_instructions.contains(instruction)) {\n-    return DiffCode::kUnmatched;\n-  }\n-  return DiffCode::kUnchanged;\n-}\n-\n struct DiffFingerprint {\n   bool all_unchanged;\n   uint64_t diff_fingerprint;\n };\n \n DiffFingerprint ComputationDiffFingerprint(\n     const xla::HloComputation* computation,\n-    const absl::flat_hash_set<const HloInstruction*>& changed_instructions,\n-    const absl::flat_hash_set<const HloInstruction*>& unmatched_instructions) {\n+    const absl::flat_hash_map<const HloInstruction*, DiffCode>& diff_codes) {\n   absl::flat_hash_map<const HloInstruction*, uint64_t> subgraph_fingerprint;\n   bool all_unchanged = true;\n   for (auto* instruction : computation->MakeInstructionPostOrder()) {\n     uint64_t fp = static_cast<uint64_t>(instruction->opcode());\n-    uint64_t diff_type_fp = GetDiffTypeFingerprint(\n-        instruction, changed_instructions, unmatched_instructions);\n+    uint64_t diff_type_fp = DiffCode::kUnchanged;\n+    if (auto it = diff_codes.find(instruction); it != diff_codes.end()) {\n+      diff_type_fp = it->second;\n+    }\n     all_unchanged = all_unchanged && (diff_type_fp == DiffCode::kUnchanged);\n     fp = tsl::FingerprintCat64(fp, diff_type_fp);\n     for (const HloInstruction* operand : instruction->operands()) {\n@@ -162,8 +150,7 @@ DiffFingerprint ComputationDiffFingerprint(\n // Split the computations into left and right computations.\n ComputationGroup SplitComputations(\n     const std::vector<const HloComputation*>& computations,\n-    const absl::flat_hash_map<const HloComputation*, const ComputationSummary>&\n-        computation_summaries) {\n+    const ComputationSummaryMap& computation_summaries) {\n   ComputationGroup result;\n   for (const HloComputation* computation : computations) {\n     if (auto it = computation_summaries.find(computation);\n@@ -180,9 +167,7 @@ ComputationGroup SplitComputations(\n \n // Returns the connected components of the given computation summary.\n absl::flat_hash_map<uint64_t, std::vector<ComputationGroup>>\n-FindConnectedComponents(\n-    absl::flat_hash_map<const HloComputation*, const ComputationSummary>\n-        computation_summary) {\n+FindConnectedComponents(const ComputationSummaryMap& computation_summary) {\n   ConnectedComponentsFinder cc;\n   std::vector<std::vector<const HloComputation*>> unmatched_computations;\n   absl::flat_hash_map<uint64_t, std::vector<ComputationGroup>> result;\n@@ -258,8 +243,7 @@ DiffMetrics GetDiffMetrics(const ComputationGroup& computation_group,\n }\n \n std::vector<ComputationDiffPattern> FindComputationDiffPatterns(\n-    const absl::flat_hash_map<const HloComputation*, const ComputationSummary>&\n-        computation_summary,\n+    const ComputationSummaryMap& computation_summary,\n     const DiffResult& diff_result) {\n   std::vector<ComputationDiffPattern> result;\n   absl::flat_hash_map<uint64_t, std::vector<ComputationGroup>>\n@@ -276,18 +260,15 @@ std::vector<ComputationDiffPattern> FindComputationDiffPatterns(\n }\n \n // Summarizes all computations in the given graph.\n-absl::flat_hash_map<const HloComputation*, const ComputationSummary>\n-SummarizeAllComputationsInGraph(\n+ComputationSummaryMap SummarizeAllComputationsInGraph(\n     const HloModule& module, const InstructionBimap& mapping,\n-    const absl::flat_hash_set<const HloInstruction*>& changed_instructions,\n-    const absl::flat_hash_set<const HloInstruction*>& unmatched_instructions,\n+    const absl::flat_hash_map<const HloInstruction*, DiffCode>& diff_codes,\n     DiffSide side) {\n-  absl::flat_hash_map<const HloComputation*, const ComputationSummary> result;\n+  ComputationSummaryMap result;\n   for (const HloComputation* computation : module.computations()) {\n     const MainMatchedComputationResult mmc =\n         FindMainMatchedComputation(computation, mapping, side);\n-    DiffFingerprint dfp = ComputationDiffFingerprint(\n-        computation, changed_instructions, unmatched_instructions);\n+    DiffFingerprint dfp = ComputationDiffFingerprint(computation, diff_codes);\n     ComputationSummary summary;\n     summary.side = side;\n     summary.main_matched_computation = mmc.main_matched_computation;\n@@ -301,6 +282,19 @@ SummarizeAllComputationsInGraph(\n   return result;\n }\n \n+// Returns the computation summary.\n+ComputationSummaryMap GetComputationSummary(const HloModule& left_module,\n+                                            const HloModule& right_module,\n+                                            const DiffResult& diff_result) {\n+  ComputationSummaryMap summary;\n+  InstructionBimap mapping = ConstructInstructionBimap(diff_result);\n+  summary.merge(SummarizeAllComputationsInGraph(\n+      left_module, mapping, diff_result.left_diff_codes, DiffSide::kLeft));\n+  summary.merge(SummarizeAllComputationsInGraph(\n+      right_module, mapping, diff_result.right_diff_codes, DiffSide::kRight));\n+  return summary;\n+}\n+\n // Logs the computation group.\n void LogComputationGroup(const ComputationGroup& computation_group) {\n   std::vector<std::string> computations_str(\n@@ -340,27 +334,10 @@ std::unique_ptr<const DiffSummary> ConstructDiffSummary(\n     const HloModule& left_module, const HloModule& right_module,\n     const DiffResult& diff_result) {\n   auto summary = std::make_unique<DiffSummary>();\n-  absl::flat_hash_set<const HloInstruction*> left_changed_instructions;\n-  absl::flat_hash_set<const HloInstruction*> right_changed_instructions;\n-  absl::flat_hash_set<const HloInstruction*> left_unmatched_instructions;\n-  absl::flat_hash_set<const HloInstruction*> right_unmatched_instructions;\n-  for (auto const& [left, right] : diff_result.changed_instructions) {\n-    left_changed_instructions.insert(left);\n-    right_changed_instructions.insert(right);\n-  }\n-  InstructionBimap mapping = ConstructInstructionBimap(diff_result);\n-  left_unmatched_instructions.insert(\n-      diff_result.left_module_unmatched_instructions.begin(),\n-      diff_result.left_module_unmatched_instructions.end());\n-  right_unmatched_instructions.insert(\n-      diff_result.right_module_unmatched_instructions.begin(),\n-      diff_result.right_module_unmatched_instructions.end());\n-  summary->computation_summary.merge(SummarizeAllComputationsInGraph(\n-      left_module, mapping, left_changed_instructions,\n-      left_unmatched_instructions, DiffSide::kLeft));\n-  summary->computation_summary.merge(SummarizeAllComputationsInGraph(\n-      right_module, mapping, right_changed_instructions,\n-      right_unmatched_instructions, DiffSide::kRight));\n+\n+  // Summarize the computations.\n+  summary->computation_summary =\n+      GetComputationSummary(left_module, right_module, diff_result);\n \n   // Group the computations by their diff fingerprint.\n   summary->computation_diff_patterns ="
        },
        {
            "sha": "772ab30e359615836b216a983107a13b40bd006a",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary.h",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary.h?ref=60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
            "patch": "@@ -29,12 +29,6 @@\n namespace xla {\n namespace hlo_diff {\n \n-enum DiffCode : uint8_t {\n-  kUnchanged,\n-  kChanged,\n-  kUnmatched,\n-};\n-\n enum class DiffSide : std::uint8_t { kLeft, kRight };\n \n struct ComputationSummary {\n@@ -83,14 +77,16 @@ struct ComputationDiffPattern {\n // Teach the gunit to print the diff pattern.\n void PrintTo(const ComputationDiffPattern& diff_pattern, std::ostream* os);\n \n+using ComputationSummaryMap =\n+    absl::flat_hash_map<const HloComputation*, const ComputationSummary>;\n+\n //  Summary of the diff result of the left and right HLO modules.\n struct DiffSummary {\n   // The computation diff patterns found in the diff result.\n   std::vector<ComputationDiffPattern> computation_diff_patterns;\n \n   // Summary of each computation.\n-  absl::flat_hash_map<const HloComputation*, const ComputationSummary>\n-      computation_summary;\n+  ComputationSummaryMap computation_summary;\n };\n \n // Constructs the diff summary from the diff result."
        },
        {
            "sha": "ae69c53460a02dfb49adcabeeab41d8c29e8fc2c",
            "filename": "third_party/xla/xla/hlo/tools/hlo_diff/hlo_diff_summary_test.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/60d6e810b0b0ce358488590dfeacb5e52f20d5c3/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftools%2Fhlo_diff%2Fhlo_diff_summary_test.cc?ref=60d6e810b0b0ce358488590dfeacb5e52f20d5c3",
            "patch": "@@ -522,16 +522,16 @@ TEST_F(HloDiffTest, DiffSummaryFromDiffResultProtoWorks) {\n     add.0 = f32[] add(parameter.1, parameter.0)\n   }\n   )\"));\n-  diff_result.unchanged_instructions.insert(\n-      {module_l->entry_computation()->root_instruction(),\n-       module_r->entry_computation()->root_instruction()});\n-  diff_result.changed_instructions.insert(\n-      {module_l->entry_computation()->parameter_instruction(0),\n-       module_r->entry_computation()->parameter_instruction(1)});\n-  diff_result.left_module_unmatched_instructions.insert(\n-      module_l->entry_computation()->parameter_instruction(1));\n-  diff_result.right_module_unmatched_instructions.insert(\n-      module_r->entry_computation()->parameter_instruction(0));\n+  diff_result.AddUnchangedInstruction(\n+      module_l->entry_computation()->root_instruction(),\n+      module_r->entry_computation()->root_instruction());\n+  diff_result.AddChangedInstruction(\n+      module_l->entry_computation()->parameter_instruction(0),\n+      module_r->entry_computation()->parameter_instruction(1));\n+  diff_result.AddUnmatchedInstruction(\n+      module_l->entry_computation()->parameter_instruction(1), nullptr);\n+  diff_result.AddUnmatchedInstruction(\n+      nullptr, module_r->entry_computation()->parameter_instruction(0));\n \n   DiffResultProto proto = diff_result.ToProto();\n   DiffResult diff_result_from_proto ="
        }
    ],
    "stats": {
        "total": 272,
        "additions": 184,
        "deletions": 88
    }
}