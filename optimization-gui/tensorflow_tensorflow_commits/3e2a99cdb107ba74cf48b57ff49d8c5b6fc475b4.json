{
    "author": "qukhan",
    "message": "Add an overload for `IsCompatibleCacheFile` that takes a file descriptor.\n\nPiperOrigin-RevId: 844749188",
    "sha": "3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4",
    "files": [
        {
            "sha": "94b0b76ab4b4cded47fef53251ce0d7085fbed35",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4",
            "patch": "@@ -682,6 +682,16 @@ bool IsCompatibleCacheFile(const char* path) {\n   FileDescriptor fd = FileDescriptor::Open(path, O_RDONLY);\n   XNNPACK_RETURN_CHECK(fd.IsValid(), \"Could not open file: %s: %s.\", path,\n                        strerror(errno));\n+  return IsCompatibleCacheFile(std::move(fd));\n+}\n+\n+bool IsCompatibleCacheFile(const FileDescriptor& fd) {\n+  XNNPACK_RETURN_CHECK(fd.IsValid(), \"Invalid file descriptor: %d.\",\n+                       fd.Value());\n+  const size_t current_pos = fd.GetPos();\n+  ScopeGuard reset_pos_on_return(\n+      [current_pos, &fd] { fd.SetPos(current_pos); });\n+\n   XNNPackCacheHeader header;\n   XNNPACK_RETURN_CHECK(fd.Read(&header, sizeof(header)),\n                        \"Couldn't read file header.\");"
        },
        {
            "sha": "270b48bb4092af1ea236b71ad8d1f813d00f375e",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.h",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.h?ref=3e2a99cdb107ba74cf48b57ff49d8c5b6fc475b4",
            "patch": "@@ -63,8 +63,19 @@ struct XNNPackCacheHeader {\n   uint64_t buffer_list_size;\n };\n \n+// Checks if the file at the given path is compatible with the current XNNPack\n+// weight cache.\n bool IsCompatibleCacheFile(const char* path);\n \n+// Checks if the opened file is compatible with the current XNNPack weight\n+// cache.\n+//\n+// Position in the file may be changed during the function execution but is\n+// restored upon exiting.\n+//\n+// Note: the file descriptor must be open and valid.\n+bool IsCompatibleCacheFile(const FileDescriptor& fd);\n+\n struct PackIdentifier {\n   enum { kNoId = SIZE_MAX };\n   uint64_t pack_algorithm_id = kNoId;"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 21,
        "deletions": 0
    }
}