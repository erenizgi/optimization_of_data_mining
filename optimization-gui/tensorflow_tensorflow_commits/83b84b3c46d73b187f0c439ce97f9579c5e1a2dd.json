{
    "author": "thomasjoerg",
    "message": "[XLA:GPU] Add tests for transpose ops inserted by DotDecomposer.\n\nAlso be more precise about what is considered normal form and what is not.\n\nPiperOrigin-RevId: 822554350",
    "sha": "83b84b3c46d73b187f0c439ce97f9579c5e1a2dd",
    "files": [
        {
            "sha": "99bc6dd8342e4612f298f54c905ca16c8986272c",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83b84b3c46d73b187f0c439ce97f9579c5e1a2dd/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83b84b3c46d73b187f0c439ce97f9579c5e1a2dd/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2FBUILD?ref=83b84b3c46d73b187f0c439ce97f9579c5e1a2dd",
            "patch": "@@ -366,6 +366,7 @@ xla_cc_test(\n         \"//xla/hlo/testlib:pattern_matcher_gmock\",\n         \"//xla/hlo/utils:hlo_matchers\",\n         \"//xla/service:pattern_matcher\",\n+        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest\",\n         \"@com_google_googletest//:gtest_main\",  # fixdeps: keep"
        },
        {
            "sha": "37b61f14abbcf5ac1415dd6ae4840a6e8732ecdc",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/dot_decomposer.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83b84b3c46d73b187f0c439ce97f9579c5e1a2dd/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83b84b3c46d73b187f0c439ce97f9579c5e1a2dd/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer.cc?ref=83b84b3c46d73b187f0c439ce97f9579c5e1a2dd",
            "patch": "@@ -89,6 +89,7 @@ absl::Status CanonicalizeDot(HloDotInstruction* original_dot) {\n   }\n   // The canonical form of the lhs is\n   // [BatchDims, NonContractingDimsProduct, ContractingsDimsProduct]\n+  // However, [ContractingDim, NonContractingDim] is considered canonical too.\n   // If NonContractingDimsProduct is 1, it is omitted.\n   std::vector<int64_t> lhs_transpose;\n   lhs_transpose.reserve(lhs_rank);\n@@ -147,6 +148,7 @@ absl::Status CanonicalizeDot(HloDotInstruction* original_dot) {\n \n   // The canonical form of the rhs is\n   // [BatchDims, ContractingsDimsProduct, NonContractingDimsProduct]\n+  // However, [NonContractingDim, ContractingDim] is considered canonical too.\n   // If NonContractingDimsProduct is 1, it is omitted.\n   std::vector<int64_t> rhs_transpose;\n   rhs_transpose.reserve(rhs_rank);"
        },
        {
            "sha": "c1ab8cdae28406d1443bdb3d2af8dfe2a12ad353",
            "filename": "third_party/xla/xla/hlo/transforms/expanders/dot_decomposer_test.cc",
            "status": "modified",
            "additions": 50,
            "deletions": 5,
            "changes": 55,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/83b84b3c46d73b187f0c439ce97f9579c5e1a2dd/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/83b84b3c46d73b187f0c439ce97f9579c5e1a2dd/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fexpanders%2Fdot_decomposer_test.cc?ref=83b84b3c46d73b187f0c439ce97f9579c5e1a2dd",
            "patch": "@@ -20,17 +20,13 @@ limitations under the License.\n #include <gmock/gmock.h>\n #include <gtest/gtest.h>\n #include \"absl/strings/string_view.h\"\n-#include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n-#include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/hlo/ir/hlo_opcode.h\"\n #include \"xla/hlo/testlib/hlo_hardware_independent_test_base.h\"\n-#include \"xla/hlo/testlib/pattern_matcher_gmock.h\"\n #include \"xla/hlo/utils/hlo_matchers.h\"\n #include \"xla/service/pattern_matcher.h\"\n-#include \"tsl/platform/statusor.h\"\n-#include \"tsl/platform/test.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n \n namespace xla {\n namespace {\n@@ -63,6 +59,55 @@ TEST_F(DotDecomposerTest, CanonicalizeMultipleNonContractingDims) {\n                                 op::Shape(\"f32[4032,512]\"))));\n }\n \n+TEST_F(DotDecomposerTest,\n+       DontCanonicalizeLhsContractingDim0AndRhsContractingDim1) {\n+  absl::string_view module_string = R\"(\n+  HloModule module\n+\n+  ENTRY main {\n+    p0 = f32[512,64]{1,0} parameter(0)\n+    p1 = f32[1024,512]{1,0} parameter(1)\n+    ROOT dot = f32[64,1024]{1,0} dot(p0, p1), lhs_contracting_dims={0},\n+                                              rhs_contracting_dims={1}\n+  })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(module_string));\n+  TF_ASSERT_OK_AND_ASSIGN(bool canonicalized,\n+                          DotDecomposer().Run(module.get()));\n+  EXPECT_FALSE(canonicalized) << module->ToString();\n+}\n+\n+TEST_F(DotDecomposerTest, TransposeContractingDimsUponCanonicalization) {\n+  absl::string_view module_string = R\"(\n+  HloModule module\n+\n+  ENTRY main {\n+    p0 = f32[512,32,32]{2,1,0} parameter(0)\n+    p1 = f32[1024,512]{1,0} parameter(1)\n+    // This dot is considered non-canonical because the LHS has two\n+    // non-contracting dimensions. Both, LHS and RHS operands are canonicalized,\n+    // which involves transposing the contracting dimensions to be 1 and 0 on\n+    // the LHS and RHS, respectively.\n+    // TODO(tjoerg): Consider leaving the RHS alone, since it is canonical.\n+    ROOT dot = f32[32,32,1024]{2,1,0} dot(p0, p1), lhs_contracting_dims={0},\n+                                                   rhs_contracting_dims={1}\n+  })\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> module,\n+                          ParseAndReturnVerifiedModule(module_string));\n+  TF_ASSERT_OK_AND_ASSIGN(bool canonicalized,\n+                          DotDecomposer().Run(module.get()));\n+  EXPECT_TRUE(canonicalized) << module->ToString();\n+  EXPECT_THAT(module->entry_computation()->root_instruction(),\n+              op::Reshape(AllOf(op::Dot(op::Reshape(op::Transpose()),\n+                                        op::Reshape(op::Transpose()),\n+                                        /*lhs_contracting_dim=*/1,\n+                                        /*rhs_contracting_dim=*/0),\n+                                op::Shape(\"f32[1024,1024]\"))))\n+      << module->ToString();\n+}\n+\n TEST_F(DotDecomposerTest, DontCanonicalizeIfNoNoncontractingDims) {\n   absl::string_view module_string = R\"(\n   HloModule module"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 53,
        "deletions": 5
    }
}