{
    "author": "pschuh",
    "message": "Refactor CreateOutputLeafTpuBuffer to call DefineBuffer instead. Because of\nerror buffers this needs to take memory_space.\n\nPiperOrigin-RevId: 835421848",
    "sha": "4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
    "files": [
        {
            "sha": "4a843d1080ea161ce8e0e3ed4e5f2074da5291cd",
            "filename": "third_party/xla/xla/pjrt/common_pjrt_client.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 22,
            "changes": 46,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.cc?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -152,7 +152,7 @@ CommonPjRtClient::BufferFromHostLiteral(const LiteralSlice& literal,\n       LinearizeInto(literal, device_shape,\n                     HostBufferSemantics::kImmutableUntilTransferCompletes,\n                     raw_buffer));\n-  return DefineBuffer(device_shape, std::move(raw_buffer),\n+  return DefineBuffer(device_shape, memory_space, std::move(raw_buffer),\n                       {std::move(definition_event)},\n                       /*raw_buffer_is_mutable=*/true);\n }\n@@ -186,10 +186,10 @@ CommonPjRtClient::CreateUninitializedBuffer(const Shape& shape,\n                                         /*allocate_after=*/{}));\n   TF_ASSIGN_OR_RETURN(auto definition_event,\n                       raw_buffer->MakeAllocationReadyEvent());\n-  TF_ASSIGN_OR_RETURN(\n-      auto output_buffer,\n-      DefineBuffer(device_shape, raw_buffer, {std::move(definition_event)},\n-                   /*raw_buffer_is_mutable=*/true));\n+  TF_ASSIGN_OR_RETURN(auto output_buffer,\n+                      DefineBuffer(device_shape, memory_space, raw_buffer,\n+                                   {std::move(definition_event)},\n+                                   /*raw_buffer_is_mutable=*/true));\n   return output_buffer;\n }\n \n@@ -259,10 +259,10 @@ CommonPjRtClient::CreateAliasBuffer(const Shape& shape,\n         return absl::OkStatus();\n       };\n \n-  TF_ASSIGN_OR_RETURN(\n-      auto result_buffer,\n-      DefineBuffer(shape, std::move(raw_buffer), {std::move(definition_event)},\n-                   /*raw_buffer_is_mutable=*/true));\n+  TF_ASSIGN_OR_RETURN(auto result_buffer,\n+                      DefineBuffer(shape, memory_space, std::move(raw_buffer),\n+                                   {std::move(definition_event)},\n+                                   /*raw_buffer_is_mutable=*/true));\n \n   return std::make_pair(std::move(result_buffer), std::move(fulfill_cb));\n }\n@@ -297,7 +297,7 @@ CommonPjRtClient::BufferFromHostBuffer(\n       TF_ASSIGN_OR_RETURN(\n           auto output_buffer,\n           DefineBuffer(\n-              device_shape, raw_buffer,\n+              device_shape, memory_space, raw_buffer,\n               absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>{},\n               /*raw_buffer_is_mutable=*/host_buffer_semantics ==\n                   PjRtClient::HostBufferSemantics::kMutableZeroCopy));\n@@ -316,10 +316,10 @@ CommonPjRtClient::BufferFromHostBuffer(\n       LinearizeHostBufferInto(\n           data, type, dims, byte_strides, host_buffer_semantics,\n           std::move(on_done_with_host_buffer), device_shape, raw_buffer));\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<PjRtBuffer> output_buffer,\n-      DefineBuffer(device_shape, raw_buffer, {std::move(definition_event)},\n-                   /*raw_buffer_is_mutable=*/true));\n+  TF_ASSIGN_OR_RETURN(std::unique_ptr<PjRtBuffer> output_buffer,\n+                      DefineBuffer(device_shape, memory_space, raw_buffer,\n+                                   {std::move(definition_event)},\n+                                   /*raw_buffer_is_mutable=*/true));\n   return output_buffer;\n }\n \n@@ -345,7 +345,7 @@ CommonPjRtClient::CreateViewOfDeviceBuffer(\n                           on_device_bytes_count, memory_space));\n   TF_ASSIGN_OR_RETURN(\n       auto output_buffer,\n-      DefineBuffer(device_shape, raw_buffer,\n+      DefineBuffer(device_shape, memory_space, raw_buffer,\n                    absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>{},\n                    /*raw_buffer_is_mutable=*/false));\n   return output_buffer;\n@@ -447,10 +447,11 @@ CommonPjRtBufferImpl::CopyToCpuMemorySpace(const xla::Shape& dst_shape,\n   TF_ASSIGN_OR_RETURN(\n       std::tie(definition_event_promise, definition_event),\n       dst_client->CreateLinkedEventPromise(dst_memory_space, \"\"));\n-  TF_ASSIGN_OR_RETURN(auto buffer,\n-                      dst_client->DefineBuffer(dst_shape, dst_raw_buffer,\n-                                               {std::move(definition_event)},\n-                                               /*raw_buffer_is_mutable=*/true));\n+  TF_ASSIGN_OR_RETURN(\n+      auto buffer,\n+      dst_client->DefineBuffer(dst_shape, dst_memory_space, dst_raw_buffer,\n+                               {std::move(definition_event)},\n+                               /*raw_buffer_is_mutable=*/true));\n   auto* base_ptr = dst_raw_buffer->GetHostPointer();\n   std::unique_ptr<MutableLiteralBase> literal;\n   bool needs_second_copy = false;\n@@ -558,9 +559,10 @@ static absl::Status CommonCopyToMemorySpace(\n         dst_client->AllocateRawBuffer(dst_memory_space, on_device_bytes_count,\n                                       /*retry_on_oom=*/true, allocation_event));\n     TF_ASSIGN_OR_RETURN(\n-        dst_buffer, dst_client->DefineBuffer(dst_shape, dst_raw_buffer,\n-                                             {std::move(definition_event)},\n-                                             /*raw_buffer_is_mutable=*/true));\n+        dst_buffer,\n+        dst_client->DefineBuffer(dst_shape, dst_memory_space, dst_raw_buffer,\n+                                 {std::move(definition_event)},\n+                                 /*raw_buffer_is_mutable=*/true));\n     TF_RETURN_IF_ERROR(src_buffer->AcquireScopedRawBuffer(\n         [&](tsl::RCReference<CommonPjRtRawBuffer> buf_raw_buffer,\n             std::vector<tsl::RCReference<tsl::AsyncValue>>"
        },
        {
            "sha": "5bdf12b09d45c03eb800a4934054e8876c1e5877",
            "filename": "third_party/xla/xla/pjrt/common_pjrt_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcommon_pjrt_client.h?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -99,7 +99,7 @@ class CommonPjRtClient : public PjRtClient {\n \n   // Defines a pjrt buffer from a shape, raw_buffer and definition events.\n   virtual absl::StatusOr<std::unique_ptr<PjRtBuffer>> DefineBuffer(\n-      const Shape& on_device_shape,\n+      const Shape& on_device_shape, PjRtMemorySpace* memory_space,\n       tsl::RCReference<CommonPjRtRawBuffer> raw_buffer,\n       absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>\n           definition_device_events,"
        },
        {
            "sha": "030069f818db0eb9f97d93c24846678720be49fe",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -974,17 +974,22 @@ PjRtCpuClient::CreateLinkedEventPromise(PjRtMemorySpace* memory_space,\n }\n \n absl::StatusOr<std::unique_ptr<PjRtBuffer>> PjRtCpuClient::DefineBuffer(\n-    const Shape& on_device_shape,\n+    const Shape& on_device_shape, PjRtMemorySpace* memory_space,\n     tsl::RCReference<CommonPjRtRawBuffer> raw_buffer,\n     absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>\n         definition_device_events,\n     bool raw_buffer_is_mutable) {\n+  if (raw_buffer && raw_buffer->memory_space() != memory_space) {\n+    return absl::InvalidArgumentError(\n+        absl::StrFormat(\"DefineBuffer: Mismatch in memory spaces: %s vs %s\",\n+                        raw_buffer->memory_space()->DebugString(),\n+                        memory_space->DebugString()));\n+  }\n   absl::InlinedVector<tsl::AsyncValueRef<CpuEvent>, 4> definition_events;\n   for (auto& ev : definition_device_events) {\n     definition_events.push_back(\n         tsl::down_cast<CpuTrackedDeviceEvent*>(ev.get())->event());\n   }\n-  auto memory_space = raw_buffer->memory_space();\n   return std::unique_ptr<PjRtBuffer>(std::make_unique<CommonPjRtBufferImpl>(\n       on_device_shape,\n       std::make_unique<TrackedCpuDeviceBuffer>("
        },
        {
            "sha": "7bd65e1b9e8314233443a9689fa826c84f98495a",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.h?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -218,7 +218,7 @@ class PjRtCpuClient final : public CommonPjRtClient {\n                            absl::string_view debug_info) override;\n \n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> DefineBuffer(\n-      const Shape& on_device_shape,\n+      const Shape& on_device_shape, PjRtMemorySpace* memory_space,\n       tsl::RCReference<CommonPjRtRawBuffer> raw_buffer,\n       absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>\n           definition_device_events,"
        },
        {
            "sha": "e7ab47b0149673aabe885b987b984448006c4493",
            "filename": "third_party/xla/xla/pjrt/gpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2FBUILD?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -264,6 +264,7 @@ xla_test(\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:subprocess\",\n         \"//xla/tsl/util:command_line_flags\",\n+        \"@com_google_absl//absl/cleanup\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\","
        },
        {
            "sha": "f64d9b6fc0db0c6249a239d97a6fd41615d36517",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_pjrt_client.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client.cc?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -567,7 +567,7 @@ StreamExecutorGpuClient::PrepareReceiveBuffer(PjRtDevice* device, Shape shape) {\n   TF_ASSIGN_OR_RETURN(\n       auto buffer,\n       DefineBuffer(\n-          on_device_shape, raw_buffer,\n+          on_device_shape, memory_space, raw_buffer,\n           {tsl::MakeRef<PjRtStreamExecutorDeviceEvent>(definition_event)},\n           /*raw_buffer_is_mutable=*/true));\n "
        },
        {
            "sha": "5637b0929958456c4f9e49f198574be779788472",
            "filename": "third_party/xla/xla/pjrt/gpu/se_gpu_pjrt_client_test.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fgpu%2Fse_gpu_pjrt_client_test.cc?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -2871,9 +2871,9 @@ TEST(StreamExecutorGpuClientTest, LinkedEventPromise) {\n   TF_ASSERT_OK_AND_ASSIGN(std::tie(promise, event),\n                           client->CreateLinkedEventPromise(memory_space, \"\"));\n   TF_ASSERT_OK_AND_ASSIGN(\n-      auto buffer,\n-      client->DefineBuffer(device_shape, raw_buffer, {std::move(event)},\n-                           /*raw_buffer_is_mutable=*/true));\n+      auto buffer, client->DefineBuffer(device_shape, memory_space, raw_buffer,\n+                                        {std::move(event)},\n+                                        /*raw_buffer_is_mutable=*/true));\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto definition_event,"
        },
        {
            "sha": "b01c428036110dd81905c9291503fd1fdc7b2f22",
            "filename": "third_party/xla/xla/pjrt/host_to_device_transfer_manager.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_to_device_transfer_manager.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_to_device_transfer_manager.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fhost_to_device_transfer_manager.cc?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -151,10 +151,11 @@ class CommonAsyncHostToDeviceTransferManager\n       }\n       definition_events.push_back(std::move(definition_event_promise));\n \n-      TF_ASSIGN_OR_RETURN(auto buffer,\n-                          client->DefineBuffer(device_shape, raw_buffer,\n-                                               {std::move(definition_event)},\n-                                               /*raw_buffer_is_mutable=*/true));\n+      TF_ASSIGN_OR_RETURN(\n+          auto buffer,\n+          client->DefineBuffer(device_shape, memory_space, raw_buffer,\n+                               {std::move(definition_event)},\n+                               /*raw_buffer_is_mutable=*/true));\n       device_shapes.push_back(std::move(device_shape));\n       buffers.push_back(std::move(buffer));\n       undispatched_buffer_refs.push_back(raw_buffer);"
        },
        {
            "sha": "290820c9a1b22e605bd04132bdcd70edbb5fa1bf",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -508,19 +508,24 @@ PjRtStreamExecutorClient::AllocateRawBuffer(\n \n absl::StatusOr<std::unique_ptr<PjRtBuffer>>\n PjRtStreamExecutorClient::DefineBuffer(\n-    const Shape& on_device_shape,\n+    const Shape& on_device_shape, PjRtMemorySpace* memory_space,\n     tsl::RCReference<CommonPjRtRawBuffer> raw_buffer,\n     absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>\n         definition_device_events,\n     bool raw_buffer_is_mutable) {\n+  if (raw_buffer && raw_buffer->memory_space() != memory_space) {\n+    return absl::InvalidArgumentError(\n+        absl::StrFormat(\"DefineBuffer: Mismatch in memory spaces: %s vs %s\",\n+                        raw_buffer->memory_space()->DebugString(),\n+                        memory_space->DebugString()));\n+  }\n   absl::InlinedVector<BufferSequencingEventRef, 2> definition_events;\n   definition_events.reserve(definition_device_events.size());\n   for (auto& ev : definition_device_events) {\n     definition_events.push_back(\n         tensorflow::down_cast<PjRtStreamExecutorDeviceEvent*>(ev.get())\n             ->event());\n   }\n-  auto* memory_space = raw_buffer->memory_space();\n   auto* device = tensorflow::down_cast<PjRtStreamExecutorDevice*>(\n       memory_space->devices()[0]);\n "
        },
        {
            "sha": "5d69ea692412a7964d528240448a1f7610544b76",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4fe5d49f8e1a9cf2feca56ba25147f42be761aa3/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h?ref=4fe5d49f8e1a9cf2feca56ba25147f42be761aa3",
            "patch": "@@ -392,7 +392,7 @@ class PjRtStreamExecutorClient : public CommonPjRtClient {\n       bool retry_on_oom, tsl::AsyncValueRef<bool> allocate_after) override;\n \n   absl::StatusOr<std::unique_ptr<PjRtBuffer>> DefineBuffer(\n-      const Shape& on_device_shape,\n+      const Shape& on_device_shape, PjRtMemorySpace* memory_space,\n       tsl::RCReference<CommonPjRtRawBuffer> raw_buffer,\n       absl::InlinedVector<tsl::RCReference<PjRtDeviceEvent>, 4>\n           definition_device_events,"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 51,
        "deletions": 37
    }
}