{
    "author": "dsharletg",
    "message": "Enable more elementwise ops to fuse in YNNPACK\n\nPiperOrigin-RevId: 845107315",
    "sha": "5373efd36023abfb481a175e6bce5bf19bc2069f",
    "files": [
        {
            "sha": "4903ef04530452a9aa6c5b4ec5360e0eeaeccefd",
            "filename": "third_party/xla/xla/backends/cpu/tests/ynn_fusion_test.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5373efd36023abfb481a175e6bce5bf19bc2069f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftests%2Fynn_fusion_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5373efd36023abfb481a175e6bce5bf19bc2069f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftests%2Fynn_fusion_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftests%2Fynn_fusion_test.cc?ref=5373efd36023abfb481a175e6bce5bf19bc2069f",
            "patch": "@@ -61,16 +61,16 @@ TEST_P(YnnFusionTest, AddAndMultiply) {\n     HloModule add_and_multiply\n \n     ynn_fusion {\n-      %lhs = $dtype[4] parameter(0)\n-      %rhs = $dtype[4] parameter(1)\n-      %add = $dtype[4] add(%lhs, %rhs)\n-      ROOT %mul = $in_dtype[4] multiply(%add, %add)\n+      %lhs = $dtype[100] parameter(0)\n+      %rhs = $dtype[100] parameter(1)\n+      %add = $dtype[100] add(%lhs, %rhs)\n+      ROOT %mul = $in_dtype[100] multiply(%add, %add)\n     }\n \n     ENTRY entry {\n-      %p0 = $dtype[4] parameter(0)\n-      %p1 = $dtype[4] parameter(1)\n-      ROOT %fusion = $dtype[4] fusion(%p0, %p1), kind=kCustom, calls=ynn_fusion,\n+      %p0 = $dtype[100] parameter(0)\n+      %p1 = $dtype[100] parameter(1)\n+      ROOT %fusion = $dtype[100] fusion(%p0, %p1), kind=kCustom, calls=ynn_fusion,\n         backend_config={\"fusion_config\": {kind: \"__ynn_fusion\"}}\n     })\";\n "
        },
        {
            "sha": "a42810882980880acd4350df81c8ac9a3f48026c",
            "filename": "third_party/xla/xla/backends/cpu/ynn_support.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5373efd36023abfb481a175e6bce5bf19bc2069f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5373efd36023abfb481a175e6bce5bf19bc2069f/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fynn_support.cc?ref=5373efd36023abfb481a175e6bce5bf19bc2069f",
            "patch": "@@ -48,10 +48,13 @@ const absl::flat_hash_map<HloOpcode, ynn_unary_operator>& GetYnnUnaryOpMap() {\n           {HloOpcode::kCeil, ynn_unary_ceil},\n           {HloOpcode::kConvert, ynn_unary_convert},\n           {HloOpcode::kCos, ynn_unary_cosine},\n+          {HloOpcode::kErf, ynn_unary_erf},\n           {HloOpcode::kExp, ynn_unary_exp},\n+          {HloOpcode::kExpm1, ynn_unary_expm1},\n           {HloOpcode::kCbrt, ynn_unary_cube_root},\n           {HloOpcode::kFloor, ynn_unary_floor},\n           {HloOpcode::kLog, ynn_unary_log},\n+          {HloOpcode::kLog1p, ynn_unary_log1p},\n           {HloOpcode::kLogistic, ynn_unary_sigmoid},\n           {HloOpcode::kNegate, ynn_unary_negate},\n           {HloOpcode::kRoundNearestEven, ynn_unary_round},\n@@ -141,6 +144,15 @@ bool IsElementwiseOpSupportedByYnn(const HloInstruction* hlo) {\n     return false;\n   }\n \n+  // We don't want to handle ops that are too small, overhead will be\n+  // significant.\n+  // TODO(b/469236467): This threshold is probably too small in some cases and\n+  // too big in others.\n+  constexpr int64_t kMinElements = 64;\n+  if (ShapeUtil::ElementsIn(hlo->shape()) < kMinElements) {\n+    return false;\n+  }\n+\n   switch (hlo->operand_count()) {\n     case 1:\n       return YnnUnaryOperator(hlo->opcode()).ok();"
        },
        {
            "sha": "c7b6b231e5a7db26a2c302409be045d5f58b0eaa",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client_test.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 12,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5373efd36023abfb481a175e6bce5bf19bc2069f/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5373efd36023abfb481a175e6bce5bf19bc2069f/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client_test.cc?ref=5373efd36023abfb481a175e6bce5bf19bc2069f",
            "patch": "@@ -14,6 +14,7 @@ limitations under the License.\n ==============================================================================*/\n \n #include <array>\n+#include <numeric>\n \n #include \"mlir/IR/BuiltinOps.h\"\n #include \"mlir/IR/MLIRContext.h\"\n@@ -1037,16 +1038,16 @@ TEST(PjRtCpuClientTest, SerializeYnnFusions) {\n     HloModule add_and_multiply\n \n     ynn_fusion {\n-      %lhs = f32[4] parameter(0)\n-      %rhs = f32[4] parameter(1)\n-      %add = f32[4] add(%lhs, %rhs)\n-      ROOT %mul = f32[4] multiply(%add, %add)\n+      %lhs = f32[100] parameter(0)\n+      %rhs = f32[100] parameter(1)\n+      %add = f32[100] add(%lhs, %rhs)\n+      ROOT %mul = f32[100] multiply(%add, %add)\n     }\n \n     ENTRY entry {\n-      %p0 = f32[4] parameter(0)\n-      %p1 = f32[4] parameter(1)\n-      ROOT %fusion = f32[4] fusion(%p0, %p1), kind=kCustom, calls=ynn_fusion,\n+      %p0 = f32[100] parameter(0)\n+      %p1 = f32[100] parameter(1)\n+      ROOT %fusion = f32[100] fusion(%p0, %p1), kind=kCustom, calls=ynn_fusion,\n         backend_config={\"fusion_config\": {kind: \"__ynn_fusion\"}}\n     })\";\n \n@@ -1057,7 +1058,15 @@ TEST(PjRtCpuClientTest, SerializeYnnFusions) {\n   TF_ASSERT_OK_AND_ASSIGN(auto executable,\n                           client->CompileAndLoad(xla_computation, {}));\n \n-  Literal literal = LiteralUtil::CreateR1<float>({1.0f, 2.0f, 3.0f, 4.0f});\n+  std::vector<float> literal_data(100);\n+  std::iota(literal_data.begin(), literal_data.end(), 1.0f);\n+\n+  std::vector<float> literal_data_x2_squared(literal_data);\n+  for (float& i : literal_data_x2_squared) {\n+    i = 4 * i * i;\n+  }\n+\n+  Literal literal = LiteralUtil::CreateR1<float>(literal_data);\n   TF_ASSERT_OK_AND_ASSIGN(auto buf, client->BufferFromHostLiteral(\n                                         literal, client->memory_spaces()[0]));\n \n@@ -1067,8 +1076,7 @@ TEST(PjRtCpuClientTest, SerializeYnnFusions) {\n   TF_ASSERT_OK_AND_ASSIGN(std::shared_ptr<xla::Literal> result_literal,\n                           result->at(0).at(0)->ToLiteralSync());\n   EXPECT_TRUE(LiteralTestUtil::Equal(\n-      LiteralUtil::CreateR1<float>({4.0f, 16.0f, 36.0f, 64.0f}),\n-      *result_literal));\n+      LiteralUtil::CreateR1<float>(literal_data_x2_squared), *result_literal));\n \n   // Check that serialized/deserialized executable works and produces the same\n   // result.\n@@ -1081,8 +1089,7 @@ TEST(PjRtCpuClientTest, SerializeYnnFusions) {\n   result = executable->Execute({{buf.get(), buf.get()}}, opts);\n   TF_ASSERT_OK_AND_ASSIGN(result_literal, result->at(0).at(0)->ToLiteralSync());\n   EXPECT_TRUE(LiteralTestUtil::Equal(\n-      LiteralUtil::CreateR1<float>({4.0f, 16.0f, 36.0f, 64.0f}),\n-      *result_literal));\n+      LiteralUtil::CreateR1<float>(literal_data_x2_squared), *result_literal));\n }\n \n }  // namespace"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 38,
        "deletions": 19
    }
}