{
    "author": "derdrdirk",
    "message": "[Autotuner] Add default config for cudnn convolutions.\n\nPiperOrigin-RevId: 814155618",
    "sha": "74d769e5f23b451ccdf6375a5ebe58a899f79cef",
    "files": [
        {
            "sha": "b6dca810ca57aa6bf6840c8e03f15b229a6f71bf",
            "filename": "third_party/xla/xla/backends/gpu/autotuner/cudnn.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/74d769e5f23b451ccdf6375a5ebe58a899f79cef/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Fcudnn.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/74d769e5f23b451ccdf6375a5ebe58a899f79cef/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Fcudnn.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Fcudnn.cc?ref=74d769e5f23b451ccdf6375a5ebe58a899f79cef",
            "patch": "@@ -340,6 +340,16 @@ absl::Status ApplyConfigToCudnnCustomCall(HloInstruction& instr,\n \n absl::StatusOr<std::unique_ptr<BackendConfig>> CudnnBackend::GetDefaultConfig(\n     const HloInstruction& instr) {\n+  if (IsCustomCallToDnnConvolution(instr)) {\n+    // If the instruction is a custom call to a DnnConvolution, we can return\n+    // the default config.\n+    CudnnBackendConfig config;\n+    config.set_algo_id(-1);\n+    auto any = std::make_unique<google::protobuf::Any>();\n+    any->PackFrom(config);\n+    return any;\n+  }\n+\n   // Default config would require stream_executor to check if the fusion is\n   // supported by Cudnn.\n   return absl::InvalidArgumentError(\n@@ -354,7 +364,7 @@ CudnnBackend::GetSupportedConfigs(const HloInstruction& instr) {\n   if (instr.opcode() == HloOpcode::kFusion) {\n     return GetCudnnFusionConfigs(instr, stream_executor());\n   }\n-  if (instr.opcode() == HloOpcode::kCustomCall) {\n+  if (IsCustomCallToDnnConvolution(instr)) {\n     auto custom_call_instr = Cast<HloCustomCallInstruction>(&instr);\n     return GetConvolutionCustomCallConfigs(custom_call_instr,\n                                            stream_executor());"
        },
        {
            "sha": "240a15cd5be83eca3f563abac1ce451fe5368890",
            "filename": "third_party/xla/xla/backends/gpu/autotuner/cudnn_test.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/74d769e5f23b451ccdf6375a5ebe58a899f79cef/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Fcudnn_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/74d769e5f23b451ccdf6375a5ebe58a899f79cef/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Fcudnn_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fautotuner%2Fcudnn_test.cc?ref=74d769e5f23b451ccdf6375a5ebe58a899f79cef",
            "patch": "@@ -174,6 +174,18 @@ TEST_F(CudnnBackendTest, GetDefaultConfigFromCudnnFusionFails) {\n               absl_testing::StatusIs(absl::StatusCode::kInvalidArgument));\n }\n \n+TEST_F(CudnnBackendTest, GetDefaultConfigFromCudnnCustomCall) {\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> hlo_module,\n+                          ParseAndReturnVerifiedModule(kCudnnCustomCallHlo));\n+  absl::StatusOr<std::unique_ptr<BackendConfig>> config =\n+      backend_.GetDefaultConfig(\n+          (*hlo_module->entry_computation()->root_instruction()->operand(0)));\n+  TF_ASSERT_OK(config);\n+  CudnnBackendConfig algorithm_config;\n+  ASSERT_TRUE(config->get()->UnpackTo(&algorithm_config));\n+  EXPECT_EQ(algorithm_config.algo_id(), -1);\n+}\n+\n TEST_F(CudnnBackendTest, ApplyConfigToCudnnFusion) {\n   TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> hlo_module,\n                           ParseAndReturnVerifiedModule(kCudnnFusionHlo));"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 23,
        "deletions": 1
    }
}