{
    "author": "basioli-k",
    "message": "[XLA:CPU][pjrt] Factor out shared HLO module creation code\n\nPiperOrigin-RevId: 832043792",
    "sha": "6346abe6039ff1e113a5c90e6a64eb3ca21a7475",
    "files": [
        {
            "sha": "7ec224d20533793ad4fe517f410cb65073349857",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 59,
            "changes": 88,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/6346abe6039ff1e113a5c90e6a64eb3ca21a7475/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/6346abe6039ff1e113a5c90e6a64eb3ca21a7475/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=6346abe6039ff1e113a5c90e6a64eb3ca21a7475",
            "patch": "@@ -540,31 +540,10 @@ PjRtCpuClient::LoadSerializedExecutable(absl::string_view serialized,\n }\n \n static absl::StatusOr<std::unique_ptr<xla::Executable>> JitCompile(\n-    const XlaComputation& computation,\n-    const absl::Span<const Shape* const> argument_layouts,\n+    std::unique_ptr<HloModule> hlo_module,\n     const ExecutableBuildOptions& build_options,\n     const ExecutionOptions& execution_options,\n-    const xla::Compiler::CompileOptions& compile_options, int num_threads,\n-    std::function<void(HloModuleConfig&)> customize_hlo_module_config) {\n-  TF_ASSIGN_OR_RETURN(ProgramShape program_shape,\n-                      computation.GetProgramShape());\n-  // Unoptimized HloModuleConfig.\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<HloModuleConfig> hlo_module_config,\n-      CreateModuleConfig(program_shape, argument_layouts, &execution_options,\n-                         execution_options.num_replicas(), num_threads,\n-                         /*aot_options=*/nullptr));\n-\n-  // Apply the user-provided callback to customize the HloModuleConfig.\n-  if (customize_hlo_module_config) {\n-    customize_hlo_module_config(*hlo_module_config);\n-  }\n-\n-  // Unoptimized HloModule.\n-  const xla::HloModuleProto& hlo_module_proto = computation.proto();\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<HloModule> hlo_module,\n-      xla::HloModule::CreateFromProto(hlo_module_proto, *hlo_module_config));\n+    const xla::Compiler::CompileOptions& compile_options) {\n   VLOG(3) << \"Unoptimized HLO module: \" << hlo_module->ToString();\n   static constexpr char kBeforeOptimizationsDumpName[] = \"before_optimizations\";\n   DumpHloModuleIfEnabled(*hlo_module, kBeforeOptimizationsDumpName);\n@@ -589,32 +568,10 @@ static absl::StatusOr<std::unique_ptr<xla::Executable>> JitCompile(\n }\n \n static absl::StatusOr<std::unique_ptr<xla::Executable>> CompileAheadOfTime(\n-    const XlaComputation& computation,\n-    const absl::Span<const Shape* const> argument_layouts,\n+    std::unique_ptr<HloModule> hlo_module,\n     const ExecutableBuildOptions& build_options,\n     const ExecutionOptions& execution_options,\n-    const xla::AotCompilationOptions& compile_options, int num_threads,\n-    std::function<void(HloModuleConfig&)> customize_hlo_module_config) {\n-  TF_ASSIGN_OR_RETURN(ProgramShape program_shape,\n-                      computation.GetProgramShape());\n-  // Unoptimized HloModuleConfig.\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<HloModuleConfig> hlo_module_config,\n-      CreateModuleConfig(program_shape, argument_layouts, &execution_options,\n-                         execution_options.num_replicas(), num_threads,\n-                         /*aot_options=*/&compile_options));\n-\n-  // Apply the user-provided callback to customize the HloModuleConfig.\n-  if (customize_hlo_module_config) {\n-    customize_hlo_module_config(*hlo_module_config);\n-  }\n-\n-  // Unoptimized HloModule.\n-  const xla::HloModuleProto& hlo_module_proto = computation.proto();\n-  TF_ASSIGN_OR_RETURN(\n-      std::unique_ptr<HloModule> hlo_module,\n-      xla::HloModule::CreateFromProto(hlo_module_proto, *hlo_module_config));\n-\n+    const xla::AotCompilationOptions& compile_options) {\n   cpu::CpuCompiler compiler;\n   // TODO (basioli): honor build_options.run_backend_only() for AOT.\n   // Compile AOT.\n@@ -814,26 +771,39 @@ PjRtCpuClient::CompileInternal(\n   ExecutionOptions execution_options =\n       CreateExecutionOptions(build_options, &program_shape);\n \n+  // Unoptimized HloModuleConfig.\n+  TF_ASSIGN_OR_RETURN(\n+      std::unique_ptr<HloModuleConfig> hlo_module_config,\n+      CreateModuleConfig(program_shape, argument_layout_pointers,\n+                         &execution_options, execution_options.num_replicas(),\n+                         eigen_intraop_device()->getPool()->NumThreads(),\n+                         aot_options));\n+\n+  // Apply the user-provided callback to customize the HloModuleConfig.\n+  if (customize_hlo_module_config_) {\n+    customize_hlo_module_config_(*hlo_module_config);\n+  }\n+\n+  // Unoptimized HloModule.\n+  const xla::HloModuleProto& hlo_module_proto = computation.proto();\n+  TF_ASSIGN_OR_RETURN(\n+      std::unique_ptr<HloModule> hlo_module,\n+      xla::HloModule::CreateFromProto(hlo_module_proto, *hlo_module_config));\n+\n   if (aot_options) {\n-    TF_ASSIGN_OR_RETURN(\n-        cpu_executable,\n-        CompileAheadOfTime(computation, argument_layout_pointers, build_options,\n-                           execution_options, *aot_options,\n-                           eigen_intraop_device()->getPool()->NumThreads(),\n-                           customize_hlo_module_config_));\n+    TF_ASSIGN_OR_RETURN(cpu_executable,\n+                        CompileAheadOfTime(std::move(hlo_module), build_options,\n+                                           execution_options, *aot_options));\n   } else {\n     xla::Compiler::CompileOptions compile_options{\n         build_options.device_allocator(), build_options.compile_thread_pool(),\n         build_options.layout_canonicalization_callback()};\n     if (!compile_options.thread_pool) {\n       compile_options.thread_pool = pjrt_client_thread_pool();\n     }\n-    TF_ASSIGN_OR_RETURN(\n-        cpu_executable,\n-        JitCompile(computation, argument_layout_pointers, build_options,\n-                   execution_options, compile_options,\n-                   eigen_intraop_device()->getPool()->NumThreads(),\n-                   customize_hlo_module_config_));\n+    TF_ASSIGN_OR_RETURN(cpu_executable,\n+                        JitCompile(std::move(hlo_module), build_options,\n+                                   execution_options, compile_options));\n   }\n \n   auto cpu_executable_ptr ="
        }
    ],
    "stats": {
        "total": 88,
        "additions": 29,
        "deletions": 59
    }
}