{
    "author": "GleasonK",
    "message": "[StableHLO builder] Update default output shape parameter for StableHLO builder.\n\nPiperOrigin-RevId: 834013905",
    "sha": "bea6bfe64eceeaf5b6bf8bb132d5214a8e92227c",
    "files": [
        {
            "sha": "21bfeeca3bfa2c59c913ea2c62a43dc6ceac913f",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/bea6bfe64eceeaf5b6bf8bb132d5214a8e92227c/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/bea6bfe64eceeaf5b6bf8bb132d5214a8e92227c/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=bea6bfe64eceeaf5b6bf8bb132d5214a8e92227c",
            "patch": "@@ -144,6 +144,83 @@ diff --ruN a/stablehlo/stablehlo/dialect/StablehloOps.h b/stablehlo/stablehlo/di\n  // PrecisionConfigAttr is a constraint attribute on ArrayAttrs.\n  // Create this class to allow for building this attr similar to other\n  // attributes.\n+diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/MlirBuilderTblgen.cpp b/stablehlo/stablehlo/integrations/cpp/builder/MlirBuilderTblgen.cpp\n+--- stablehlo/stablehlo/integrations/cpp/builder/MlirBuilderTblgen.cpp\n++++ stablehlo/stablehlo/integrations/cpp/builder/MlirBuilderTblgen.cpp\n+@@ -203,6 +203,9 @@\n+   // If the op does not support type inference, return a default output shape\n+   // parameter that must be injected.\n+   MethodParameter getDefaultOutputShape() {\n++    if (hasSingleVariadicResult(getOp()) || getOp().getNumResults() > 1) {\n++      return MethodParameter(\"TypeRange\", \"resultTypes\");\n++    }\n+     return MethodParameter(\"Type\", \"resultType\");\n+   }\n+ \n+@@ -276,7 +279,7 @@\n+     BuilderParams params = getOpBuilderParameters();\n+     SmallVector<MethodParameter> parameters;\n+     if (params.outputShape.has_value()) {\n+-      parameters.push_back(getDefaultOutputShape());\n++      parameters.push_back(params.outputShape.value());\n+     }\n+     for (auto& operand : params.operands) {\n+       parameters.push_back(\n+diff --ruN a/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp b/stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp\n+--- stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp\n++++ stablehlo/stablehlo/integrations/cpp/builder/StablehloBuilderTest.cpp\n+@@ -17,12 +17,12 @@\n+ #include <cstdint>\n+ #include <string>\n+ \n+-#include \"gtest/gtest.h\"\n+ #include \"mlir/IR/BuiltinAttributes.h\"\n+ #include \"mlir/IR/BuiltinOps.h\"\n+ #include \"mlir/IR/DialectRegistry.h\"\n+ #include \"mlir/IR/MLIRContext.h\"\n+ #include \"mlir/IR/OwningOpRef.h\"\n++#include \"mlir/IR/Types.h\"\n+ #include \"mlir/IR/Verifier.h\"\n+ #include \"mlir/Support/DebugStringHelper.h\"\n+ #include \"mlir/Support/LLVM.h\"\n+@@ -32,6 +32,7 @@\n+ #include \"stablehlo/integrations/cpp/builder/FuncBuilder.h\"\n+ #include \"stablehlo/integrations/cpp/builder/MlirBuilder.h\"\n+ #include \"stablehlo/integrations/cpp/builder/StablehloBuilder.h\"\n++#include \"gtest/gtest.h\"\n+ \n+ namespace mlir {\n+ namespace stablehlo {\n+@@ -1517,6 +1518,29 @@\n+   EXPECT_EQ(expected, debugString(*module));\n+ }\n+ \n++TEST(MlirBuilderTest, VariadicResult) {\n++  std::string expected = R\"mlir(module {\n++  func.func @main() -> (tensor<f64>, tensor<f64>) {\n++    %0:2 = stablehlo.custom_call @two_outs() : () -> (tensor<f64>, tensor<f64>)\n++    return %0#0, %0#1 : tensor<f64>, tensor<f64>\n++  }\n++})mlir\";\n++\n++  StablehloModuleBuilder mb;\n++  {\n++    Location funcLoc = fileLineColLoc(mb->getContext(), \"main.mlir\", 1, 1);\n++    func::FunctionBuilder fb(mb.get(), \"main\", funcLoc);\n++    auto type = makeTensorType(fb.getContext(), {}, ElementType::F64);\n++    SmallVector<Type> resultTypes = {type, type};\n++    // Pass double data with i64 type.\n++    auto cc = stablehlo::CustomCall(fb, resultTypes, {}, \"two_outs\");\n++    func::Return(fb, {cc});\n++  }\n++\n++  OwningOpRef<ModuleOp> module = mb->build();\n++  EXPECT_EQ(expected, debugString(*module));\n++}\n++\n+ ////////\n+ // Custom Attribute Tests\n+ ////////\n diff --ruN a/stablehlo/stablehlo/integrations/python/mlir/dialects/InterpreterOps.td b/stablehlo/stablehlo/integrations/python/mlir/dialects/InterpreterOps.td\n --- stablehlo/stablehlo/integrations/python/mlir/dialects/InterpreterOps.td\n +++ stablehlo/stablehlo/integrations/python/mlir/dialects/InterpreterOps.td"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 77,
        "deletions": 0
    }
}