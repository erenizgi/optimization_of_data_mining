{
    "author": "zzzaries",
    "message": "Add (nan value) skipped trace metadata to xplane stats\n\nPiperOrigin-RevId: 803270278",
    "sha": "7905d805c88e034c314baba0a00a216ea202f4ee",
    "files": [
        {
            "sha": "268beec5c3b832d9249c63d6188a8f8cb0f8d0fc",
            "filename": "third_party/xla/xla/backends/profiler/gpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD?ref=7905d805c88e034c314baba0a00a216ea202f4ee",
            "patch": "@@ -482,6 +482,7 @@ cc_library(\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n         \"@local_tsl//tsl/platform:abi\","
        },
        {
            "sha": "eef2447d9140189c3785ffa34efcd012a9d79008",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_collector.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_collector.cc?ref=7905d805c88e034c314baba0a00a216ea202f4ee",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/strings/str_cat.h\"\n+#include \"absl/strings/str_format.h\"\n #include \"absl/strings/str_join.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n@@ -679,6 +680,7 @@ class EventInQueue {\n \n void PmSamples::PopulateCounterLine(XPlaneBuilder* plane,\n                                     uint64_t start_gpu_time_ns) {\n+  absl::flat_hash_map<std::string, int> skipped_nan_count_per_metric;\n   XLineBuilder line = plane->GetOrCreateCounterLine();\n   std::vector<std::pair<XEventMetadata*, XStatMetadata*>> counter_metadata;\n   counter_metadata.reserve(metrics_.size());\n@@ -690,6 +692,7 @@ void PmSamples::PopulateCounterLine(XPlaneBuilder* plane,\n     DCHECK_EQ(metrics_.size(), sampler_range.metric_values.size());\n     for (int i = 0; i < sampler_range.metric_values.size(); ++i) {\n       if (std::isnan(sampler_range.metric_values[i])) {\n+        ++skipped_nan_count_per_metric[counter_metadata[i].first->name()];\n         continue;\n       }\n       XEventBuilder event = line.AddEvent(\n@@ -702,6 +705,13 @@ void PmSamples::PopulateCounterLine(XPlaneBuilder* plane,\n                          sampler_range.metric_values[i]);\n     }\n   }\n+  for (const auto& [metric, count] : skipped_nan_count_per_metric) {\n+    plane->AddStatValue(\n+        *plane->GetOrCreateStatMetadata(tsl::profiler::GetStatTypeStr(\n+            tsl::profiler::StatType::kNanCounterEvents)),\n+        absl::StrFormat(\"Skipped %d NaN counter events for %s: \", count,\n+                        metric));\n+  }\n }\n \n size_t PmSamples::GetNumSamples() const { return sampler_ranges_.size(); }"
        },
        {
            "sha": "03d4614d9d08a2e57475ef20cf743841fcf0b768",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_schema.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_schema.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_schema.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_schema.cc?ref=7905d805c88e034c314baba0a00a216ea202f4ee",
            "patch": "@@ -364,6 +364,7 @@ const StatTypeMap& GetStatTypeMap() {\n        {\"dcn_chunk\", kDcnChunk},\n        {\"dcn_loop_index\", kDcnLoopIndex},\n        {\"dropped_traces\", kDroppedTraces},\n+       {\"nan_counter_events\", kNanCounterEvents},\n        {\"cuda_graph_id\", kCudaGraphId},\n        {\"cuda_graph_exec_id\", kCudaGraphExecId},\n        {\"cuda_graph_orig_id\", kCudaGraphOrigId},"
        },
        {
            "sha": "ee06b349ae3d17ca723cd634a3b9caa1e0df8b9b",
            "filename": "third_party/xla/xla/tsl/profiler/utils/xplane_schema.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_schema.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/7905d805c88e034c314baba0a00a216ea202f4ee/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_schema.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprofiler%2Futils%2Fxplane_schema.h?ref=7905d805c88e034c314baba0a00a216ea202f4ee",
            "patch": "@@ -346,6 +346,7 @@ enum StatType {\n   kEdgeTpuModelProfileInfo,\n   kEdgeTpuMlir,\n   kDroppedTraces,\n+  kNanCounterEvents,\n   kCudaGraphId,\n   // Many events have kCudaGraphId, such as graph sub events when tracing is in\n   // node level. Yet kCudaGraphExecId is used only for CudaGraphExecution events"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 13,
        "deletions": 0
    }
}