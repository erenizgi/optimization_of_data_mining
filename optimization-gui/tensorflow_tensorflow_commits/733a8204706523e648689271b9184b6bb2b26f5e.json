{
    "author": "unknown",
    "message": "[XLA:GPU] SdcXorChecksumKernel: move trait to stream_executor/gpu\n\nUse GpuKernelRegistry for loading the kernel rather than `TypedKernelFactory`.\nThe new header will help prevent errors related to use of \"gpu\"-tagged targets\nin non-\"gpu\"-tagged ones.\n\nAlso, avoid using atomic fetch_add to prevent JAX build failures on <sm60.\nWe're going to ensure that with a runtime check.\n\nPiperOrigin-RevId: 819098591",
    "sha": "733a8204706523e648689271b9184b6bb2b26f5e",
    "files": [
        {
            "sha": "e02a1e5e9b3ab7e3f3519b4bb19f3f36c26da6b3",
            "filename": "third_party/xla/xla/stream_executor/cuda/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 16,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2FBUILD?ref=733a8204706523e648689271b9184b6bb2b26f5e",
            "patch": "@@ -344,8 +344,6 @@ cc_library(\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n-        \"@local_tsl//tsl/platform:errors\",\n-        \"@local_tsl//tsl/platform:logging\",\n     ],\n     alwayslink = 1,\n )\n@@ -471,24 +469,23 @@ xla_test(\n cuda_library(\n     name = \"sdc_xor_checksum_kernel_cuda\",\n     srcs = [\"sdc_xor_checksum_kernel_cuda.cu.cc\"],\n-    hdrs = [\"sdc_xor_checksum_kernel_cuda.h\"],\n+    # copybara:uncomment compatible_with = [\"//buildenv/target:non_prod\"],\n     tags = [\n         \"cuda-only\",\n         \"gpu\",\n     ],\n     deps = [\n-        \":cuda_platform_id\",\n+        \":cuda_platform\",\n         \"//xla/backends/gpu/runtime:sdc_buffer_id\",\n         \"//xla/backends/gpu/runtime:sdc_log_structs\",\n-        \"//xla/stream_executor:device_memory\",\n-        \"//xla/stream_executor:kernel\",\n         \"//xla/stream_executor:kernel_spec\",\n         \"//xla/stream_executor/gpu:gpu_kernel_registry\",\n+        \"//xla/stream_executor/gpu:sdc_xor_checksum_kernel\",\n         \"//xla/tsl/platform:logging\",\n         \"@com_google_absl//absl/base\",\n-        \"@com_google_absl//absl/status:statusor\",\n         \"@local_config_cuda//cuda:cuda_headers\",\n     ],\n+    alwayslink = True,\n )\n \n xla_test(\n@@ -503,14 +500,15 @@ xla_test(\n         \"//xla/backends/gpu/runtime:sdc_log_structs\",\n         \"//xla/backends/gpu/runtime:thunk_id\",\n         \"//xla/stream_executor:device_memory\",\n-        \"//xla/stream_executor:kernel_spec\",\n         \"//xla/stream_executor:launch_dim\",\n         \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:platform_manager\",\n         \"//xla/stream_executor:stream\",\n         \"//xla/stream_executor:stream_executor_h\",\n         \"//xla/stream_executor:stream_executor_memory_allocator\",\n         \"//xla/stream_executor:typed_kernel_factory\",\n+        \"//xla/stream_executor/gpu:gpu_kernel_registry\",\n+        \"//xla/stream_executor/gpu:sdc_xor_checksum_kernel\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n@@ -642,9 +640,7 @@ cc_library(\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/functional:function_ref\",\n         \"@com_google_absl//absl/status\",\n-        \"@com_google_absl//absl/status:statusor\",\n         \"@cudnn_frontend_archive//:cudnn_frontend\",\n-        \"@local_config_cuda//cuda:cudnn_header\",\n     ],\n )\n \n@@ -663,12 +659,10 @@ xla_cc_test(\n         \"//xla/hlo/parser:hlo_parser\",\n         \"//xla/tsl/cuda:cudart\",  # build_cleaner: keep\n         \"//xla/tsl/cuda:cudnn\",  # build_cleaner: keep\n-        \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@cudnn_frontend_archive//:cudnn_frontend\",\n         \"@jsoncpp_git//:jsoncpp\",\n-        \"@local_config_cuda//cuda:cudnn_header\",\n         \"@local_tsl//tsl/platform:status_matchers\",\n         \"@local_tsl//tsl/platform:test\",\n     ],\n@@ -1267,6 +1261,7 @@ cc_library(\n         \":ragged_all_to_all_kernel_cuda\",\n         \":redzone_allocator_kernel_cuda\",\n         \":repeat_buffer_kernel_cuda\",\n+        \":sdc_xor_checksum_kernel_cuda\",\n         \":topk_kernel_cuda\",\n         \"//xla/tsl/cuda:cusolver\",\n         \"//xla/tsl/cuda:cusparse\",\n@@ -1714,7 +1709,6 @@ xla_cc_test(\n         \"@com_google_absl//absl/container:flat_hash_set\",\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_googletest//:gtest_main\",\n-        \"@local_tsl//tsl/platform:test\",\n     ],\n )\n \n@@ -1759,13 +1753,11 @@ cc_library(\n         \":cuda_compute_capability\",\n         \":ptx_compiler_helpers\",\n         \":subprocess_compilation\",\n-        \"//xla/stream_executor:device_description\",\n         \"//xla/stream_executor/gpu:gpu_asm_opts\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:subprocess\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n-        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:str_format\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n@@ -1863,7 +1855,6 @@ cc_library(\n         \":nvjitlink\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/stream_executor/gpu:gpu_asm_opts\",\n-        \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/strings:string_view\","
        },
        {
            "sha": "6a7f9ee225b4191f4e01710f9b153375d4abba59",
            "filename": "third_party/xla/xla/stream_executor/cuda/sdc_xor_checksum_kernel_cuda.cu.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 15,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_xor_checksum_kernel_cuda.cu.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_xor_checksum_kernel_cuda.cu.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_xor_checksum_kernel_cuda.cu.cc?ref=733a8204706523e648689271b9184b6bb2b26f5e",
            "patch": "@@ -13,9 +13,6 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/stream_executor/cuda/sdc_xor_checksum_kernel_cuda.h\"\n-\n-#include <algorithm>\n #include <cstdint>\n #include <cstdlib>\n #include <cstring>\n@@ -24,8 +21,9 @@ limitations under the License.\n #include \"third_party/gpus/cuda/include/cuda/atomic\"\n #include \"xla/backends/gpu/runtime/sdc_buffer_id.h\"\n #include \"xla/backends/gpu/runtime/sdc_log_structs.h\"\n-#include \"xla/stream_executor/cuda/cuda_platform_id.h\"\n+#include \"xla/stream_executor/cuda/cuda_platform.h\"\n #include \"xla/stream_executor/gpu/gpu_kernel_registry.h\"\n+#include \"xla/stream_executor/gpu/sdc_xor_checksum_kernel.h\"\n #include \"xla/stream_executor/kernel_spec.h\"\n #include \"xla/tsl/platform/logging.h\"\n \n@@ -185,27 +183,28 @@ __global__ void AppendChecksum(xla::gpu::SdcBufferId entry_id,\n \n     cuda::atomic_ref<uint32_t, cuda::thread_scope_system>\n         checksum_log_write_idx(log_header->write_idx);\n+#if __CUDA_ARCH__ >= 600\n     const uint32_t write_idx = checksum_log_write_idx.fetch_add(1);\n     if (write_idx < log_header->capacity) {\n       log_entries[write_idx] = {entry_id, checksum};\n     }\n+#else\n+    // Our toolchains generate a fetch_add PTX instructions with system scope,\n+    // which is not supported on pre-Pascal architectures.\n+    assert(false);\n+#endif\n   }\n }\n \n-}  // namespace\n-\n-GPU_KERNEL_REGISTRY_REGISTER_KERNEL_STATICALLY(\n-    SdcXorChecksumKernel, se::cuda::SdcXorChecksumKernel,\n-    se::cuda::kCudaPlatformId, ([](size_t _arity) {\n-      return se::cuda::GetSdcXorChecksumKernelSpec().value();\n-    }));\n-\n-namespace stream_executor::cuda {\n-\n absl::StatusOr<se::KernelLoaderSpec> GetSdcXorChecksumKernelSpec() {\n   return se::KernelLoaderSpec::CreateInProcessSymbolSpec(\n       absl::bit_cast<void*>(&AppendChecksum), \"SdcXorChecksumKernel\",\n       /*arity=*/5);\n }\n \n-}  // namespace stream_executor::cuda\n+}  // namespace\n+\n+GPU_KERNEL_REGISTRY_REGISTER_KERNEL_STATICALLY(\n+    SdcXorChecksumKernel, se::gpu::SdcXorChecksumKernel,\n+    se::cuda::kCudaPlatformId,\n+    ([](size_t _arity) { return GetSdcXorChecksumKernelSpec().value(); }));"
        },
        {
            "sha": "8040c86f5b7021439e4719727a39bd23dcb5ee3c",
            "filename": "third_party/xla/xla/stream_executor/cuda/sdc_xor_checksum_kernel_cuda_test.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_xor_checksum_kernel_cuda_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_xor_checksum_kernel_cuda_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fcuda%2Fsdc_xor_checksum_kernel_cuda_test.cc?ref=733a8204706523e648689271b9184b6bb2b26f5e",
            "patch": "@@ -13,8 +13,6 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#include \"xla/stream_executor/cuda/sdc_xor_checksum_kernel_cuda.h\"\n-\n #include <array>\n #include <cstdint>\n #include <memory>\n@@ -33,7 +31,8 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/thunk_id.h\"\n #include \"xla/stream_executor/cuda/sdc_log.h\"\n #include \"xla/stream_executor/device_memory.h\"\n-#include \"xla/stream_executor/kernel_spec.h\"\n+#include \"xla/stream_executor/gpu/gpu_kernel_registry.h\"\n+#include \"xla/stream_executor/gpu/sdc_xor_checksum_kernel.h\"\n #include \"xla/stream_executor/launch_dim.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/platform_manager.h\"\n@@ -64,6 +63,13 @@ class ChecksumKernelTest : public ::testing::Test {\n     TF_ASSERT_OK_AND_ASSIGN(stream_, executor_->CreateStream(std::nullopt));\n     allocator_ =\n         std::make_unique<se::StreamExecutorMemoryAllocator>(stream_->parent());\n+\n+    if (!executor_->GetDeviceDescription()\n+             .cuda_compute_capability()\n+             .IsAtLeastPascal()) {\n+      GTEST_SKIP() << \"SDC checksumming is not supported on CUDA architectures \"\n+                      \"older than Pascal due to missing atomic fetch_add\";\n+    }\n   }\n \n   template <typename T>\n@@ -81,12 +87,10 @@ class ChecksumKernelTest : public ::testing::Test {\n       SdcBufferId entry_id, const T& input, se::cuda::SdcLog& sdc_log,\n       stream_executor::ThreadDim dim = stream_executor::ThreadDim(1, 1, 1)) {\n     // Load kernel\n-    TF_ASSIGN_OR_RETURN(se::KernelLoaderSpec spec,\n-                        se::cuda::GetSdcXorChecksumKernelSpec());\n+    gpu::GpuKernelRegistry registry =\n+        gpu::GpuKernelRegistry::GetGlobalRegistry();\n     TF_ASSIGN_OR_RETURN(\n-        auto kernel,\n-        se::cuda::SdcXorChecksumKernel::KernelType::FactoryType::Create(\n-            executor_, spec));\n+        auto kernel, registry.LoadKernel<gpu::SdcXorChecksumKernel>(executor_));\n \n     // Setup device buffers\n     TF_ASSIGN_OR_RETURN(se::DeviceMemory<uint8_t> device_input,"
        },
        {
            "sha": "42b45d18631f25b7e6cfb5e9cae1a4ff725d60f8",
            "filename": "third_party/xla/xla/stream_executor/gpu/BUILD",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2FBUILD?ref=733a8204706523e648689271b9184b6bb2b26f5e",
            "patch": "@@ -940,3 +940,14 @@ xla_cc_test(\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )\n+\n+cc_library(\n+    name = \"sdc_xor_checksum_kernel\",\n+    hdrs = [\"sdc_xor_checksum_kernel.h\"],\n+    deps = [\n+        \"//xla/backends/gpu/runtime:sdc_buffer_id\",\n+        \"//xla/backends/gpu/runtime:sdc_log_structs\",\n+        \"//xla/stream_executor:device_memory\",\n+        \"//xla/stream_executor:kernel\",\n+    ],\n+)"
        },
        {
            "sha": "d03a6b96a37d131c3d2ae68c35336e4735131fb2",
            "filename": "third_party/xla/xla/stream_executor/gpu/sdc_xor_checksum_kernel.h",
            "status": "renamed",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fsdc_xor_checksum_kernel.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/733a8204706523e648689271b9184b6bb2b26f5e/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fsdc_xor_checksum_kernel.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fstream_executor%2Fgpu%2Fsdc_xor_checksum_kernel.h?ref=733a8204706523e648689271b9184b6bb2b26f5e",
            "patch": "@@ -13,19 +13,17 @@ See the License for the specific language governing permissions and\n limitations under the License.\n ==============================================================================*/\n \n-#ifndef XLA_STREAM_EXECUTOR_CUDA_SDC_XOR_CHECKSUM_KERNEL_CUDA_H_\n-#define XLA_STREAM_EXECUTOR_CUDA_SDC_XOR_CHECKSUM_KERNEL_CUDA_H_\n+#ifndef XLA_STREAM_EXECUTOR_GPU_SDC_XOR_CHECKSUM_KERNEL_H_\n+#define XLA_STREAM_EXECUTOR_GPU_SDC_XOR_CHECKSUM_KERNEL_H_\n \n #include <cstdint>\n \n-#include \"absl/status/statusor.h\"\n #include \"xla/backends/gpu/runtime/sdc_buffer_id.h\"\n #include \"xla/backends/gpu/runtime/sdc_log_structs.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/stream_executor/kernel.h\"\n-#include \"xla/stream_executor/kernel_spec.h\"\n \n-namespace stream_executor::cuda {\n+namespace stream_executor::gpu {\n \n // Trait for a kernel that computes the checksum of given input buffer and\n // appends it to the SDC log.\n@@ -37,8 +35,6 @@ struct SdcXorChecksumKernel {\n                                  DeviceMemory<xla::gpu::SdcLogEntry>>;\n };\n \n-absl::StatusOr<KernelLoaderSpec> GetSdcXorChecksumKernelSpec();\n+}  // namespace stream_executor::gpu\n \n-}  // namespace stream_executor::cuda\n-\n-#endif  // XLA_STREAM_EXECUTOR_CUDA_SDC_XOR_CHECKSUM_KERNEL_CUDA_H_\n+#endif  // XLA_STREAM_EXECUTOR_GPU_SDC_XOR_CHECKSUM_KERNEL_H_",
            "previous_filename": "third_party/xla/xla/stream_executor/cuda/sdc_xor_checksum_kernel_cuda.h"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 49,
        "deletions": 48
    }
}