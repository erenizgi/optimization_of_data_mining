{
    "author": "tensorflower-gardener",
    "message": "Create FilteredDfsHloVisitor to selectively visit certain HLOs.\n\nPiperOrigin-RevId: 809208428",
    "sha": "1a9f3aa3c02c71b2527beb5e24aaa7903278a472",
    "files": [
        {
            "sha": "955ae8a52c8964635eb1956655259ee6a5bac430",
            "filename": "third_party/xla/xla/hlo/ir/BUILD",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a9f3aa3c02c71b2527beb5e24aaa7903278a472/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a9f3aa3c02c71b2527beb5e24aaa7903278a472/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2FBUILD?ref=1a9f3aa3c02c71b2527beb5e24aaa7903278a472",
            "patch": "@@ -404,6 +404,20 @@ xla_cc_test(\n     ],\n )\n \n+xla_cc_test(\n+    name = \"dfs_hlo_visitor_test\",\n+    srcs = [\"dfs_hlo_visitor_test.cc\"],\n+    deps = [\n+        \":hlo\",\n+        \"//xla:literal_util\",\n+        \"//xla/service:hlo_module_config\",\n+        \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n xla_cc_test(\n     name = \"hlo_original_value_test\",\n     srcs = [\"hlo_original_value_test.cc\"],"
        },
        {
            "sha": "8f3b7299b620bf8e1b8bd8856977d84401d5e4d3",
            "filename": "third_party/xla/xla/hlo/ir/dfs_hlo_visitor_test.cc",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a9f3aa3c02c71b2527beb5e24aaa7903278a472/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a9f3aa3c02c71b2527beb5e24aaa7903278a472/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_test.cc?ref=1a9f3aa3c02c71b2527beb5e24aaa7903278a472",
            "patch": "@@ -0,0 +1,72 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ ==============================================================================*/\n+#include \"xla/hlo/ir/dfs_hlo_visitor.h\"\n+\n+#include <memory>\n+#include <utility>\n+#include <vector>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/status/status.h\"\n+#include \"xla/hlo/ir/dfs_hlo_visitor_with_default.h\"\n+#include \"xla/hlo/ir/hlo_instruction.h\"\n+#include \"xla/hlo/ir/hlo_opcode.h\"\n+#include \"xla/literal_util.h\"\n+#include \"xla/service/hlo_module_config.h\"\n+#include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/test.h\"\n+\n+namespace xla {\n+namespace {\n+\n+using ::testing::ElementsAre;\n+\n+TEST(FilteredDfsHloVisitorTest, FiltersInstructions) {\n+  // Create a module with a few instructions.\n+  auto builder = HloComputation::Builder(\"test\");\n+  auto constant1 = builder.AddInstruction(\n+      HloInstruction::CreateConstant(LiteralUtil::CreateR0<float>(1.0)));\n+  auto constant2 = builder.AddInstruction(\n+      HloInstruction::CreateConstant(LiteralUtil::CreateR0<float>(2.0)));\n+  auto add = builder.AddInstruction(HloInstruction::CreateBinary(\n+      constant1->shape(), HloOpcode::kAdd, constant1, constant2));\n+  builder.AddInstruction(\n+      HloInstruction::CreateUnary(add->shape(), HloOpcode::kNegate, add));\n+\n+  auto module = std::make_unique<HloModule>(\"test\", HloModuleConfig());\n+  auto computation = module->AddEntryComputation(builder.Build());\n+\n+  std::vector<HloInstruction*> visited_instructions;\n+  auto action = [&visited_instructions](HloInstruction* instruction) {\n+    visited_instructions.push_back(instruction);\n+    return absl::OkStatus();\n+  };\n+\n+  // Create a filtered visitor that only visits Add instructions.\n+  FilteredDfsHloVisitor filtered_visitor(\n+      std::move(action), [](const HloInstruction* instruction) {\n+        return instruction->opcode() == HloOpcode::kAdd;\n+      });\n+\n+  // Run the filtered visitor on the computation.\n+  TF_EXPECT_OK(computation->Accept(&filtered_visitor));\n+\n+  // Check that the recording visitor only visited the Add instruction.\n+  EXPECT_THAT(visited_instructions, ElementsAre(add));\n+}\n+\n+}  // namespace\n+}  // namespace xla"
        },
        {
            "sha": "f0d2ae2e1b105e3e84e216cd2f74642eb2145452",
            "filename": "third_party/xla/xla/hlo/ir/dfs_hlo_visitor_with_default.h",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1a9f3aa3c02c71b2527beb5e24aaa7903278a472/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_with_default.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1a9f3aa3c02c71b2527beb5e24aaa7903278a472/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_with_default.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Fir%2Fdfs_hlo_visitor_with_default.h?ref=1a9f3aa3c02c71b2527beb5e24aaa7903278a472",
            "patch": "@@ -16,11 +16,13 @@ limitations under the License.\n #ifndef XLA_HLO_IR_DFS_HLO_VISITOR_WITH_DEFAULT_H_\n #define XLA_HLO_IR_DFS_HLO_VISITOR_WITH_DEFAULT_H_\n \n+#include <functional>\n #include <memory>\n #include <utility>\n \n #include \"absl/base/optimization.h\"\n #include \"absl/log/log.h\"\n+#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/string_view.h\"\n #include \"xla/hlo/ir/dfs_hlo_visitor.h\"\n@@ -393,6 +395,27 @@ class DfsHloRewriteVisitor : public DfsHloVisitorWithDefault {\n   bool changed_ = false;\n };\n \n+// A visitor that visits only HLO instructions that match the filter.\n+class FilteredDfsHloVisitor : public DfsHloVisitorWithDefault {\n+ public:\n+  FilteredDfsHloVisitor(\n+      std::function<absl::Status(HloInstruction*)> action,\n+      std::function<bool(const HloInstruction*)> filter) noexcept\n+      : action_(std::move(action)), filter_(std::move(filter)) {}\n+\n+  // Filter and call the child visitor if appropriate.\n+  absl::Status DefaultAction(HloInstruction* hlo_instruction) override {\n+    if (filter_(hlo_instruction)) {\n+      return action_(hlo_instruction);\n+    }\n+    return absl::OkStatus();\n+  }\n+\n+ private:\n+  std::function<absl::Status(HloInstruction*)> action_;\n+  std::function<bool(const HloInstruction*)> filter_;\n+};\n+\n // (Const)FunctionVisitor lets you transform an\n // std::function<absl::Status((const) HloInstruction*)> into a\n // (Const)DfsHloVisitor."
        }
    ],
    "stats": {
        "total": 109,
        "additions": 109,
        "deletions": 0
    }
}