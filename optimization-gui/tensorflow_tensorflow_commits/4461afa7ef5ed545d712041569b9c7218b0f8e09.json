{
    "author": "basioli-k",
    "message": "[XLA:CPU] Compare host cpu features when loading AOT result to the compilation machine features\n\nPiperOrigin-RevId: 826043058",
    "sha": "4461afa7ef5ed545d712041569b9c7218b0f8e09",
    "files": [
        {
            "sha": "af339d467b34439eed42eda0704a05ef11ee0fb3",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=4461afa7ef5ed545d712041569b9c7218b0f8e09",
            "patch": "@@ -538,7 +538,6 @@ xla_test(\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n         \"//xla/hlo/ir:hlo\",\n-        \"//xla/hlo/ir:hlo_module_group\",\n         \"//xla/service:compiler\",\n         \"//xla/service:executable\",\n         \"//xla/service:hlo_runner\",\n@@ -551,6 +550,7 @@ xla_test(\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n         \"@com_google_absl//absl/strings:string_view\",\n+        \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:TargetParser\",\n         \"@local_tsl//tsl/platform:casts\",\n     ],\n@@ -2176,9 +2176,11 @@ cc_library(\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/types:span\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:Target\",\n+        \"@llvm-project//llvm:TargetParser\",\n         \"@llvm-project//llvm:ir_headers\",\n     ] + if_llvm_aarch64_available([\n         \"@llvm-project//llvm:AArch64CodeGen\",  # fixdeps: keep"
        },
        {
            "sha": "e869d323087ac7158a74812e8edb1ef31e447761",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compiler_test.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc?ref=4461afa7ef5ed545d712041569b9c7218b0f8e09",
            "patch": "@@ -18,9 +18,10 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/strings/string_view.h\"\n+#include \"llvm/ADT/StringMap.h\"  // IWYU pragma: keep\n+#include \"llvm/TargetParser/Host.h\"\n #include \"llvm/TargetParser/Triple.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n-#include \"xla/hlo/ir/hlo_module_group.h\"\n #include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n #include \"xla/service/compiler.h\"\n@@ -169,6 +170,17 @@ ENTRY main {\n       llvm::Triple(cpu_aot_result->proto().target_machine_options().triple())\n           .getArchName(),\n       llvm::Triple(kTargetTripleForHost).getArchName());\n+\n+  auto host_machine_features = llvm::sys::getHostCPUFeatures();\n+  std::vector<absl::string_view> enabled_features;\n+  for (const auto& feature : host_machine_features) {\n+    if (feature.getValue()) {\n+      enabled_features.push_back(feature.getKey());\n+    }\n+  }\n+\n+  EXPECT_EQ(cpu_aot_result->proto().target_machine_options().features(),\n+            absl::StrJoin(enabled_features, \",\"));\n }\n \n }  // namespace"
        },
        {
            "sha": "a4595bec665277a00bfbe709aabec1f2da6c1092",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc?ref=4461afa7ef5ed545d712041569b9c7218b0f8e09",
            "patch": "@@ -22,13 +22,14 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/log/log.h\"\n-#include \"absl/status/status.h\"\n #include \"absl/status/statusor.h\"\n+#include \"absl/strings/str_split.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/StringRef.h\"\n #include \"llvm/IR/DataLayout.h\"\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/Target/TargetOptions.h\"\n+#include \"llvm/TargetParser/Host.h\"\n #include \"xla/backends/cpu/codegen/cpu_features.h\"\n #include \"xla/backends/cpu/codegen/execution_engine.h\"\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n@@ -184,6 +185,21 @@ CpuAotLoader::LoadAotCompilationResult(\n                     expected_triple.getArchName(), triple.getArchName());\n   }\n \n+  auto compile_machine_features =\n+      absl::StrSplit(aot_result_proto.target_machine_options().features(), ',');\n+\n+  auto host_machine_features = llvm::sys::getHostCPUFeatures();\n+\n+  for (const auto& feature : compile_machine_features) {\n+    if (!host_machine_features.contains(feature) ||\n+        !host_machine_features[feature]) {\n+      return Internal(\n+          \"Cannot load AOT result. Target machine feature %s is not supported \"\n+          \"on the host machine.\",\n+          feature);\n+    }\n+  }\n+\n   std::vector<SymbolProto> compiled_symbols_proto;\n   for (const auto& symbol_proto : aot_result_proto.compiled_symbols()) {\n     compiled_symbols_proto.push_back(symbol_proto);"
        },
        {
            "sha": "ceb9275be7908c609ffd823bedc9d614de38a0e4",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4461afa7ef5ed545d712041569b9c7218b0f8e09/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=4461afa7ef5ed545d712041569b9c7218b0f8e09",
            "patch": "@@ -1988,8 +1988,20 @@ CpuCompiler::CompileCpuExecutable(\n   target_machine_options_proto.set_triple(\n       target_machine->getTargetTriple().getTriple());\n   target_machine_options_proto.set_cpu(target_machine->getTargetCPU());\n+\n+  // TODO(basioli): Target machine features are returning an empty string at the\n+  // moment so for now we are using the host CPU features. This should be\n+  // updated to use the target machine features of the target we are actually\n+  // compiling for as we might want to support cross-compilation.\n+  auto host_machine_features = llvm::sys::getHostCPUFeatures();\n+  std::vector<absl::string_view> enabled_features;\n+  for (const auto& feature : host_machine_features) {\n+    if (feature.getValue()) {\n+      enabled_features.push_back(feature.getKey());\n+    }\n+  }\n   target_machine_options_proto.set_features(\n-      target_machine->getTargetFeatureString());\n+      absl::StrJoin(enabled_features, \",\"));\n \n   TF_ASSIGN_OR_RETURN(\n       auto cpu_executable,"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 46,
        "deletions": 4
    }
}