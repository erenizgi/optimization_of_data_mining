{
    "author": "mooskagh",
    "message": "[XLA:GPU] Do not normalize start_index_map in gather simplifier\n\nNow emitter supports non-normalized index maps, and it saves from needing of transpose.\n\nPiperOrigin-RevId: 831824245",
    "sha": "a577696dba3e93719593dbe64466206031159760",
    "files": [
        {
            "sha": "49e83965bee11ad975b4057f705d11768d413790",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/gather_simplifier.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 25,
            "changes": 33,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a577696dba3e93719593dbe64466206031159760/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a577696dba3e93719593dbe64466206031159760/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier.cc?ref=a577696dba3e93719593dbe64466206031159760",
            "patch": "@@ -24,11 +24,9 @@ limitations under the License.\n #include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_instructions.h\"\n #include \"xla/literal_util.h\"\n-#include \"xla/permutation_util.h\"\n #include \"xla/service/gather_scatter_utils.h\"\n #include \"xla/service/hlo_creation_utils.h\"\n #include \"xla/shape_util.h\"\n-#include \"tsl/platform/statusor.h\"\n \n namespace xla {\n \n@@ -47,44 +45,33 @@ absl::StatusOr<HloInstruction*> GatherSimplifier::ExpandInstruction(\n   const auto& dims = gather->gather_dimension_numbers();\n   int operand_rank =\n       dims.collapsed_slice_dims().size() + dims.offset_dims().size();\n-\n-  // Make the operand conform to start_index_map.\n-  auto [operand_permutation, operand_permutation_inverse] =\n-      MakeOperandStartIndexPermutations(dims.start_index_map(), operand_rank);\n   auto* operand = gather->operands()[0];\n   auto* start_indices = gather->operands()[1];\n-  TF_ASSIGN_OR_RETURN(operand, MaybeTranspose(operand, operand_permutation));\n+\n+  // Make the start_indices a two-dimensional tensor.\n   TF_ASSIGN_OR_RETURN(\n       start_indices,\n       TransformStartIndices(start_indices, dims.index_vector_dim()));\n \n   // Permute the slice sizes according to start_index_map and compute the new\n   // output shape for the Gather op.\n-  auto slice_sizes = Permute(gather->gather_slice_sizes(), operand_permutation);\n+  const auto slice_sizes = gather->gather_slice_sizes();\n   std::vector<int64_t> output_dims = {start_indices->shape().dimensions(0)};\n   absl::c_copy(slice_sizes, std::back_inserter(output_dims));\n   Shape output_shape =\n       ShapeUtil::MakeShape(operand->shape().element_type(), output_dims);\n \n   std::vector<int64_t> offset_dims(operand_rank);\n   absl::c_iota(offset_dims, 1);\n-  std::vector<int64_t> start_index_map(dims.start_index_map().size());\n-  absl::c_iota(start_index_map, 0);\n \n   auto* result = gather->AddInstruction(HloInstruction::CreateGather(\n       output_shape, operand, start_indices,\n-      HloGatherInstruction::MakeGatherDimNumbers(\n-          offset_dims,\n-          /*collapsed_slice_dims=*/{}, start_index_map, /*index_vector_dim=*/1),\n+      HloGatherInstruction::MakeGatherDimNumbers(offset_dims,\n+                                                 /*collapsed_slice_dims=*/{},\n+                                                 dims.start_index_map(),\n+                                                 /*index_vector_dim=*/1),\n       slice_sizes, gather->indices_are_sorted()));\n \n-  // Undo the start_index_map transpose.\n-  std::vector<int64_t> output_permutation(1 +  // start index dimension.\n-                                          operand_rank);\n-  absl::c_transform(operand_permutation_inverse, output_permutation.begin() + 1,\n-                    [](int64_t dim) { return dim + 1; });\n-  TF_ASSIGN_OR_RETURN(result, MaybeTranspose(result, output_permutation));\n-\n   // Collapse the requested slice dimensions.\n   if (!dims.collapsed_slice_dims().empty()) {\n     std::vector<int64_t> collapsed_slice_dims(\n@@ -138,11 +125,7 @@ bool GatherSimplifier::IsSimplifiedGather(const HloGatherInstruction* gather) {\n \n bool GatherSimplifier::InstructionMatchesPattern(HloInstruction* inst) {\n   auto* gather = DynCast<HloGatherInstruction>(inst);\n-  // TODO(crem): Remove the IsIdentityPermutation check once the\n-  // GatherSimplifier pass is updated to handle non-trivial start_index_maps.\n-  return gather && !(IsSimplifiedGather(gather) &&\n-                     IsIdentityPermutation(\n-                         gather->gather_dimension_numbers().start_index_map()));\n+  return gather && !IsSimplifiedGather(gather);\n }\n \n }  // namespace xla"
        },
        {
            "sha": "a264bcba8574cdfb6808bce8e96e34b5fbfc5bfe",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/gather_simplifier.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a577696dba3e93719593dbe64466206031159760/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a577696dba3e93719593dbe64466206031159760/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier.h?ref=a577696dba3e93719593dbe64466206031159760",
            "patch": "@@ -29,7 +29,6 @@ namespace xla {\n // The output gather's attributes will have the following characteristics:\n // - start_indices is a two-dimensional tensor\n // - index_vector_dim is 1\n-// - start_index_map is [0, 1, ...]\n // - collapsed_slice_dims is []\n // - offset_dims is [1, 2, ...]\n //"
        },
        {
            "sha": "b7a530f0cf1b2490425821092ecc8802199a4ede",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/gather_simplifier_test.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/a577696dba3e93719593dbe64466206031159760/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/a577696dba3e93719593dbe64466206031159760/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Fgather_simplifier_test.cc?ref=a577696dba3e93719593dbe64466206031159760",
            "patch": "@@ -84,8 +84,8 @@ TEST_F(GatherSimplifierTest, RemovesCollapsedSliceDims) {\n   )\");\n }\n \n-TEST_F(GatherSimplifierTest, MakesStartIndexMapIdentity) {\n-  // Verifies that GatherSimplifier ensures start_index_map is {0, 1, ...}.\n+TEST_F(GatherSimplifierTest, KeepsStartIndexIntact) {\n+  // Verifies that GatherSimplifier does not change the start_index_map.\n   constexpr absl::string_view kModuleStr = R\"(\n     HloModule gather_simplifier\n \n@@ -100,13 +100,8 @@ TEST_F(GatherSimplifierTest, MakesStartIndexMapIdentity) {\n           slice_sizes={1,2,3}\n     })\";\n \n-  RunAndFilecheckHloRewrite(kModuleStr, GatherSimplifier(), R\"(\n-  %operand = f32[33,34,35]{2,1,0} parameter(0)\n-           CHECK: %[[OPERAND:.*]] = f32[35,33,34]{2,1,0} transpose(%operand)\n-           CHECK: %[[GATHER:.*]] = f32[42,3,1,2]{{.*}} gather(%[[OPERAND]],\n-      CHECK-SAME:    start_index_map={0,1,2},\n-           CHECK: ROOT {{.*}} = f32[42,1,2,3]{{.*}} transpose(%[[GATHER]])\n-  )\");\n+  // Expect unchanged.\n+  RunAndFilecheckHloRewrite(kModuleStr, GatherSimplifier(), std::nullopt);\n }\n \n TEST_F(GatherSimplifierTest, CollapsesSomeDims) {\n@@ -176,8 +171,8 @@ TEST_F(GatherSimplifierTest, ZeroSizeSlice) {\n \n   // The shape check is sufficient.\n   RunAndFilecheckHloRewrite(kModuleStr, GatherSimplifier(), R\"(\n-      CHECK: %[[ZERO:.*]] = f32[] constant(0) \n-      CHECK: ROOT {{.*}} = f32[3,2]{1,0} broadcast(%[[ZERO]]), dimensions={} \n+      CHECK: %[[ZERO:.*]] = f32[] constant(0)\n+      CHECK: ROOT {{.*}} = f32[3,2]{1,0} broadcast(%[[ZERO]]), dimensions={}\n   )\");\n }\n "
        }
    ],
    "stats": {
        "total": 51,
        "additions": 14,
        "deletions": 37
    }
}