{
    "author": "EusebioDM",
    "message": "Refractor nchw filter dimension parsing in `ConvolutionReorderThunk`\n\nInstead of inputing the filter dimensions as a span of integers, which we implicitly expect to be of size 4, we pass this a proto.\n\nUsing a proto instead of a struct since we'll need the `ConvolutionFilterDimensions` to serialize the `ConvolutionReorderThunk`. (We don't want to serialize the `FilterDescriptor` since most of its fields are only written during execution, so we'll serialize the `ConvolutionFilterDimensions` instead).\n\nNot sure where the best place for the `ConvolutionFilterDimensions` proto to live is. Other options would be to define it in:\n* In the thunk.proto, or;\n* In some other file more closely related to convolution filters (not sure where that could be).\n\nPiperOrigin-RevId: 818726237",
    "sha": "056f0130722db01bfb3ca402c9d9761edcf37046",
    "files": [
        {
            "sha": "6f7f5ceeb60a3d302c9214e555eae1708ffa0fca",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=056f0130722db01bfb3ca402c9d9761edcf37046",
            "patch": "@@ -554,6 +554,7 @@ cc_library(\n     srcs = [\"convolution_reorder_thunk.cc\"],\n     hdrs = [\"convolution_reorder_thunk.h\"],\n     deps = [\n+        \":convolution_filter_thunk_proto_cc\",\n         \":thunk\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/stream_executor:device_memory\",\n@@ -562,10 +563,14 @@ cc_library(\n         \"@com_google_absl//absl/container:inlined_vector\",\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/status\",\n-        \"@com_google_absl//absl/types:span\",\n     ],\n )\n \n+tf_proto_library(\n+    name = \"convolution_filter_thunk_proto\",\n+    srcs = [\"convolution_filter_thunk.proto\"],\n+)\n+\n cc_library(\n     name = \"copy_thunk\",\n     srcs = [\"copy_thunk.cc\"],"
        },
        {
            "sha": "b8c4323af2ef44e8f9704297f56056a97910909d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/convolution_filter_thunk.proto",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_filter_thunk.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_filter_thunk.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_filter_thunk.proto?ref=056f0130722db01bfb3ca402c9d9761edcf37046",
            "patch": "@@ -0,0 +1,16 @@\n+syntax = \"proto3\";\n+\n+package xla.gpu;\n+\n+// Dimensions of the convolution filter.\n+// See stream_executor::dnn::FilterDescriptor for more details.\n+message ConvolutionFilterDimensions {\n+  // Number of output features (a.k.a. channels).\n+  int64 output_feature_map_count = 1;\n+  // Number of input features (a.k.a. channels).\n+  int64 input_feature_map_count = 2;\n+  // Height of the filter.\n+  int64 input_filter_height = 3;\n+  // Width of the filter.\n+  int64 input_filter_width = 4;\n+}"
        },
        {
            "sha": "bbabc8e6d48df8ecb84d52e3030bc408db553d9d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/convolution_reorder_thunk.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_reorder_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_reorder_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_reorder_thunk.cc?ref=056f0130722db01bfb3ca402c9d9761edcf37046",
            "patch": "@@ -22,7 +22,7 @@ limitations under the License.\n #include \"absl/container/inlined_vector.h\"\n #include \"absl/log/check.h\"\n #include \"absl/status/status.h\"\n-#include \"absl/types/span.h\"\n+#include \"xla/backends/gpu/runtime/convolution_filter_thunk.pb.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/stream_executor/device_memory.h\"\n@@ -32,12 +32,25 @@ limitations under the License.\n namespace xla {\n namespace gpu {\n \n+static se::dnn::FilterDescriptor CreateFilterDescriptor(\n+    const ConvolutionFilterDimensions& filter_dimensions) {\n+  se::dnn::FilterDescriptor filter_desc(/*ndims=*/2);\n+  filter_desc.set_layout(se::dnn::FilterLayout::kOutputInputYX32);\n+  filter_desc.set_output_feature_map_count(\n+      filter_dimensions.output_feature_map_count());\n+  filter_desc.set_input_feature_map_count(\n+      filter_dimensions.input_feature_map_count());\n+  filter_desc.set_input_filter_height(filter_dimensions.input_filter_height());\n+  filter_desc.set_input_filter_width(filter_dimensions.input_filter_width());\n+  return filter_desc;\n+}\n+\n ConvolutionReorderThunk::ConvolutionReorderThunk(\n-    ThunkInfo thunk_info, absl::Span<int64_t> filter_nchw,\n+    ThunkInfo thunk_info, ConvolutionFilterDimensions filter_dimensions,\n     absl::InlinedVector<BufferAllocation::Slice, 2> operand_slices,\n     absl::InlinedVector<BufferAllocation::Slice, 2> result_slices)\n     : Thunk(Kind::kConvolutionReorder, thunk_info),\n-      filter_descriptor_(CreateFilterDescriptor(filter_nchw)),\n+      filter_descriptor_(CreateFilterDescriptor(filter_dimensions)),\n       operand_buffers_(operand_slices),\n       result_buffers_(result_slices) {}\n \n@@ -70,17 +83,5 @@ absl::Status ConvolutionReorderThunk::ExecuteOnStream(\n       std::move(bias_input), std::move(bias_output));\n }\n \n-se::dnn::FilterDescriptor ConvolutionReorderThunk::CreateFilterDescriptor(\n-    absl::Span<int64_t> filter_nchw) {\n-  CHECK_EQ(filter_nchw.size(), 4);\n-  se::dnn::FilterDescriptor filter_desc(2);\n-  filter_desc.set_layout(se::dnn::FilterLayout::kOutputInputYX32);\n-  filter_desc.set_output_feature_map_count(filter_nchw[0]);\n-  filter_desc.set_input_feature_map_count(filter_nchw[1]);\n-  filter_desc.set_input_filter_height(filter_nchw[2]);\n-  filter_desc.set_input_filter_width(filter_nchw[3]);\n-  return filter_desc;\n-}\n-\n }  // namespace gpu\n }  // namespace xla"
        },
        {
            "sha": "20241c7f1077e04010ca4f9577fc73144e8b4069",
            "filename": "third_party/xla/xla/backends/gpu/runtime/convolution_reorder_thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_reorder_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_reorder_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fconvolution_reorder_thunk.h?ref=056f0130722db01bfb3ca402c9d9761edcf37046",
            "patch": "@@ -16,11 +16,10 @@ limitations under the License.\n #ifndef XLA_BACKENDS_GPU_RUNTIME_CONVOLUTION_REORDER_THUNK_H_\n #define XLA_BACKENDS_GPU_RUNTIME_CONVOLUTION_REORDER_THUNK_H_\n \n-#include <cstdint>\n \n #include \"absl/container/inlined_vector.h\"\n #include \"absl/status/status.h\"\n-#include \"absl/types/span.h\"\n+#include \"xla/backends/gpu/runtime/convolution_filter_thunk.pb.h\"\n #include \"xla/backends/gpu/runtime/thunk.h\"\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/stream_executor/dnn.h\"\n@@ -32,7 +31,7 @@ namespace gpu {\n class ConvolutionReorderThunk : public Thunk {\n  public:\n   ConvolutionReorderThunk(\n-      ThunkInfo thunk_info, absl::Span<int64_t> filter_nchw,\n+      ThunkInfo thunk_info, ConvolutionFilterDimensions filter_dimensions,\n       absl::InlinedVector<BufferAllocation::Slice, 2> operand_slices,\n       absl::InlinedVector<BufferAllocation::Slice, 2> result_slices);\n \n@@ -42,9 +41,7 @@ class ConvolutionReorderThunk : public Thunk {\n   absl::Status ExecuteOnStream(const ExecuteParams& params) override;\n \n  private:\n-  static se::dnn::FilterDescriptor CreateFilterDescriptor(\n-      absl::Span<int64_t> filter_nchw);\n-\n+  // TODO: b/431980836 - Store the filter dimensions to use for serialization.\n   const se::dnn::FilterDescriptor filter_descriptor_;\n   absl::InlinedVector<BufferAllocation::Slice, 2> operand_buffers_;\n   absl::InlinedVector<BufferAllocation::Slice, 2> result_buffers_;"
        },
        {
            "sha": "b7c983e49ab08926934c02a66ff848e55782fa08",
            "filename": "third_party/xla/xla/service/gpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2FBUILD?ref=056f0130722db01bfb3ca402c9d9761edcf37046",
            "patch": "@@ -535,6 +535,7 @@ cc_library(\n         \"//xla/stream_executor/platform:platform_object_registry\",\n         \"//xla/tools:hlo_decomposer_lib\",\n         \"//xla/tsl/platform:errors\",\n+        \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/protobuf:dnn_proto_cc\",\n         \"@com_google_absl//absl/container:flat_hash_map\","
        },
        {
            "sha": "ec92702d30d85a1d279ef41cfedca9cc16f75270",
            "filename": "third_party/xla/xla/service/gpu/ir_emitter_unnested.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/056f0130722db01bfb3ca402c9d9761edcf37046/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fir_emitter_unnested.cc?ref=056f0130722db01bfb3ca402c9d9761edcf37046",
            "patch": "@@ -91,7 +91,6 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/copy_thunk.h\"\n #include \"xla/backends/gpu/runtime/cub_sort_thunk.h\"\n #include \"xla/backends/gpu/runtime/cudnn_thunk.h\"\n-#include \"xla/backends/gpu/runtime/custom_call_target.h\"\n #include \"xla/backends/gpu/runtime/custom_call_thunk.h\"\n #include \"xla/backends/gpu/runtime/fft_thunk.h\"\n #include \"xla/backends/gpu/runtime/gemm_thunk.h\"\n@@ -120,9 +119,7 @@ limitations under the License.\n #include \"xla/backends/gpu/runtime/wait_for_streams_thunk.h\"\n #include \"xla/backends/gpu/runtime/while_thunk.h\"\n #include \"xla/codegen/emitters/kernel_arguments.h\"\n-#include \"xla/ffi/api/c_api.h\"\n #include \"xla/ffi/attribute_map.h\"\n-#include \"xla/ffi/ffi_api.h\"\n #include \"xla/hlo/ir/hlo_casting_utils.h\"\n #include \"xla/hlo/ir/hlo_computation.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n@@ -140,8 +137,6 @@ limitations under the License.\n #include \"xla/service/buffer_assignment.h\"\n #include \"xla/service/call_graph.h\"\n #include \"xla/service/collective_ops_utils.h\"\n-#include \"xla/service/custom_call_status.h\"\n-#include \"xla/service/custom_call_target_registry.h\"\n #include \"xla/service/global_device_id.h\"\n #include \"xla/service/gpu/backend_configs.pb.h\"\n #include \"xla/service/gpu/cublas_cudnn.h\"\n@@ -182,7 +177,6 @@ limitations under the License.\n #include \"xla/stream_executor/launch_dim.h\"\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/platform/platform_object_registry.h\"\n-#include \"xla/stream_executor/stream.h\"\n #include \"xla/stream_executor/stream_executor.h\"\n #include \"xla/tools/hlo_decomposer.h\"\n #include \"xla/tsl/platform/errors.h\"\n@@ -192,7 +186,6 @@ limitations under the License.\n #include \"xla/xla_data.pb.h\"\n #include \"tsl/platform/casts.h\"\n #include \"tsl/platform/human_readable_json.h\"\n-#include \"tsl/platform/platform.h\"\n #include \"triton/Dialect/Triton/IR/Dialect.h\"\n \n namespace xla {\n@@ -898,9 +891,11 @@ absl::Status IrEmitterUnnested::EmitConvolutionReorderThunk(\n     return Internal(\"Unexpected shape for convolution reorder: %s\",\n                     instr->ToString());\n   }\n-  absl::InlinedVector<int64_t, 4> filter_dims = {\n-      shape.dimensions(0), shape.dimensions(1) * 32, shape.dimensions(2),\n-      shape.dimensions(3)};\n+  ConvolutionFilterDimensions filter_dimensions;\n+  filter_dimensions.set_output_feature_map_count(shape.dimensions(0));\n+  filter_dimensions.set_input_feature_map_count(shape.dimensions(1) * 32);\n+  filter_dimensions.set_input_filter_height(shape.dimensions(2));\n+  filter_dimensions.set_input_filter_width(shape.dimensions(3));\n \n   absl::InlinedVector<BufferAllocation::Slice, 2> operand_slices;\n   TF_ASSIGN_OR_RETURN(BufferAllocation::Slice filter_input,\n@@ -929,7 +924,7 @@ absl::Status IrEmitterUnnested::EmitConvolutionReorderThunk(\n   auto thunk = std::make_unique<ConvolutionReorderThunk>(\n       Thunk::ThunkInfo::WithProfileAnnotation(\n           instr, ir_emitter_context_->GetNextThunkId()),\n-      absl::MakeSpan(filter_dims), operand_slices, result_slices);\n+      std::move(filter_dimensions), operand_slices, result_slices);\n   AddThunkToThunkSequence(std::move(thunk));\n   return absl::OkStatus();\n }"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 48,
        "deletions": 33
    }
}