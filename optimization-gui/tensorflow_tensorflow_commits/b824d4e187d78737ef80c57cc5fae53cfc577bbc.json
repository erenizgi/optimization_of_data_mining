{
    "author": "mkuperst",
    "message": "[XLA] Remove verify_unique_channel_ids verifier option.\n\nThe functionality has been removed previously, but the option was never cleaned up. This does not remove the xla_ignore_channel_id debug option because it also has a non-verifier use.\n\nPiperOrigin-RevId: 821737613",
    "sha": "b824d4e187d78737ef80c57cc5fae53cfc577bbc",
    "files": [
        {
            "sha": "95a2f28edf744546c90dfc686fdf1b564f9507df",
            "filename": "third_party/xla/xla/service/gpu/fusion_pipeline.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ffusion_pipeline.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ffusion_pipeline.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ffusion_pipeline.cc?ref=b824d4e187d78737ef80c57cc5fae53cfc577bbc",
            "patch": "@@ -53,7 +53,6 @@ HloPassPipeline FusionPipeline(\n   HloVerifierOpts opts =\n       HloVerifierOpts().MakeLayoutSensitive().WithInstructionCanChangeLayout(\n           LayoutAssignment::InstructionCanChangeLayout);\n-  opts.verify_unique_channel_ids = !debug_options.xla_ignore_channel_id();\n   fusion.AddInvariantCheckerDebug<HloVerifier>(\n       std::make_unique<CpuGpuVerifierMetadata>(std::move(opts)),\n       \"hlo verifier (debug)\");"
        },
        {
            "sha": "95510e93899337af854e6050546db2356942b42e",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=b824d4e187d78737ef80c57cc5fae53cfc577bbc",
            "patch": "@@ -571,9 +571,7 @@ GpuCompiler::GpuCompiler(se::Platform::Id platform_id,\n namespace {\n // Adds the HloVerifier for GPU to the given pipeline.\n void AddHloVerifier(HloPassPipeline* pipeline,\n-                    bool verify_unique_channel_ids = false,\n                     HloVerifierOpts&& opts = {}, bool debug_only = false) {\n-  opts.verify_unique_channel_ids = verify_unique_channel_ids;\n   opts.verify_no_collective_deadlocks = true;\n   std::unique_ptr<TargetVerifierMetadata> verifier_metadata =\n       std::make_unique<CpuGpuVerifierMetadata>(std::move(opts));\n@@ -746,7 +744,7 @@ absl::Status RunOptimizationPasses(\n       gpu_target_config.device_description.gpu_compute_capability();\n \n   HloPassPipeline pipeline(\"optimization\");\n-  AddHloVerifier(&pipeline, !debug_options.xla_ignore_channel_id());\n+  AddHloVerifier(&pipeline);\n   if (debug_options.xla_detect_unstable_reductions() !=\n       DebugOptions::UNSTABLE_REDUCTION_DETECTION_MODE_NONE) {\n     pipeline.AddPass<UnstableReductionDetector>();\n@@ -902,8 +900,7 @@ absl::Status RunOptimizationPasses(\n   // point.\n   [&, &pipeline =\n           pipeline.AddPass<HloPassFix<HloPassPipeline>>(\"simplification\")] {\n-    AddHloVerifier(&pipeline, !debug_options.xla_ignore_channel_id(),\n-                   HloVerifierOpts{}, /*debug_only=*/true);\n+    AddHloVerifier(&pipeline, HloVerifierOpts{}, /*debug_only=*/true);\n \n     // BatchNormExpander can create zero-sized ops, so zero-sized HLO\n     // elimination has to come after that pass.\n@@ -1856,7 +1853,7 @@ absl::Status GpuCompiler::OptimizeHloPostLayoutAssignment(\n   }\n \n   HloPassPipeline pipeline(\"post-layout_assignment\");\n-  AddHloVerifier(&pipeline, !debug_options.xla_ignore_channel_id(),\n+  AddHloVerifier(&pipeline,\n                  HloVerifierOpts{}\n                      .MakeLayoutSensitive()\n                      .WithInstructionCanChangeLayout(\n@@ -1963,7 +1960,6 @@ absl::Status GpuCompiler::OptimizeHloPostLayoutAssignment(\n                                  LayoutAssignment::InstructionCanChangeLayout)\n                              .VerifyBroadcastDimensionsOrder()\n                              .VerifyReshapeIsBitcast();\n-  opts.verify_unique_channel_ids = !debug_options.xla_ignore_channel_id();\n   pipeline.AddPass<HloVerifier>(\n       std::make_unique<DefaultVerifierMetadata>(std::move(opts)),\n       \"end-of-post-layout_assignment\");\n@@ -3056,7 +3052,6 @@ absl::Status GpuCompiler::RunPostSchedulingPipelines(\n   if (module->config().debug_options().xla_gpu_pgle_accuracy_checker() ==\n       DebugOptions::PGLE_STRICTNESS_LEVEL_ERROR) {\n     AddHloVerifier(&main_pipeline,\n-                   module->config().debug_options().xla_ignore_channel_id(),\n                    HloVerifierOpts{}.VerifyInstructionNameUnchanged());\n   }\n   return main_pipeline.Run(module, {HloInstruction::kMainExecutionThread})"
        },
        {
            "sha": "9bb0242f03b43fc6a8f277d6d22806315932ee46",
            "filename": "third_party/xla/xla/service/gpu/pre_scheduling_copy_insertion_pipeline.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fpre_scheduling_copy_insertion_pipeline.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fpre_scheduling_copy_insertion_pipeline.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fpre_scheduling_copy_insertion_pipeline.cc?ref=b824d4e187d78737ef80c57cc5fae53cfc577bbc",
            "patch": "@@ -52,7 +52,6 @@ HloPassPipeline PreSchedulingCopyInsertionPipeline(\n   HloVerifierOpts opts =\n       HloVerifierOpts{}.MakeLayoutSensitive().WithInstructionCanChangeLayout(\n           LayoutAssignment::InstructionCanChangeLayout);\n-  opts.verify_unique_channel_ids = !debug_options.xla_ignore_channel_id();\n   std::unique_ptr<TargetVerifierMetadata> verifier_metadata =\n       std::make_unique<CpuGpuVerifierMetadata>(std::move(opts));\n   pipeline.AddInvariantCheckerDebug<HloVerifier>(std::move(verifier_metadata),"
        },
        {
            "sha": "100abb8df8dced29b199e7e375ff3f09e2c13af5",
            "filename": "third_party/xla/xla/service/hlo_verifier.h",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier.h?ref=b824d4e187d78737ef80c57cc5fae53cfc577bbc",
            "patch": "@@ -175,9 +175,6 @@ struct HloVerifierOpts {\n   // cloned (\".clone\" suffix) or rematted (\".remat\");\n   bool verify_instruction_name_unchanged = false;\n \n-  // Check if channel instructions all have unique channel ids.\n-  bool verify_unique_channel_ids = true;\n-\n   // Check if a shape has a host memory space color\n   bool verify_no_host_memory_space = false;\n "
        },
        {
            "sha": "f237f70b138cfb2c8c092256774d820b26c46f2e",
            "filename": "third_party/xla/xla/service/hlo_verifier_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b824d4e187d78737ef80c57cc5fae53cfc577bbc/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fhlo_verifier_test.cc?ref=b824d4e187d78737ef80c57cc5fae53cfc577bbc",
            "patch": "@@ -3658,7 +3658,6 @@ TEST_F(HloVerifierTest, NoErrorOnDuplicateChannelId) {\n   TF_ASSERT_OK_AND_ASSIGN(auto module,\n                           ParseAndReturnUnverifiedModule(hlo_string));\n   HloVerifierOpts opts{};\n-  opts.verify_unique_channel_ids = false;\n   HloVerifier verifier(std::move(opts));\n   ASSERT_IS_OK(verifier.Run(module.get()).status());\n }"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 3,
        "deletions": 14
    }
}