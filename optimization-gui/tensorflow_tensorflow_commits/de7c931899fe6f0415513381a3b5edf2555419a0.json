{
    "author": "zvikinoza",
    "message": "`UnflattenCallGraph` assumed graph was flat, but we can get rid of assumption and use the pass for general deduplication. For this we should only hash unique computations, to avoid redundant work for performance.\n\nPiperOrigin-RevId: 829442682",
    "sha": "de7c931899fe6f0415513381a3b5edf2555419a0",
    "files": [
        {
            "sha": "ec1deade87cd63c4cefb0810d58c63408686d191",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/unflatten_call_graph.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de7c931899fe6f0415513381a3b5edf2555419a0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Funflatten_call_graph.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de7c931899fe6f0415513381a3b5edf2555419a0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Funflatten_call_graph.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Funflatten_call_graph.cc?ref=de7c931899fe6f0415513381a3b5edf2555419a0",
            "patch": "@@ -49,7 +49,7 @@ namespace {\n // Struct to hold all call instructions and called computations in a module.\n struct HloCalls {\n   std::vector<HloInstruction*> call_sites;\n-  std::vector<HloComputation*> targets;\n+  absl::flat_hash_set<HloComputation*> targets;\n };\n \n // Iterates through all instructions in the module's computations\n@@ -64,7 +64,7 @@ HloCalls CollectHloCalls(\n     for (const CallSite& callsite : node.callsites()) {\n       if (callsite.instruction()->opcode() == HloOpcode::kCall) {\n         calls.call_sites.push_back(callsite.instruction());\n-        calls.targets.push_back(callsite.instruction()->to_apply());\n+        calls.targets.insert(callsite.instruction()->to_apply());\n       }\n     }\n   }\n@@ -74,7 +74,7 @@ HloCalls CollectHloCalls(\n \n absl::StatusOr<std::vector<UnflattenCallGraph::ComputationHashResult>>\n UnflattenCallGraph::HashComputations(\n-    const std::vector<HloComputation*>& called_computations) {\n+    const absl::flat_hash_set<HloComputation*>& called_computations) {\n   auto hash_computation =\n       [&](HloComputation* computation) -> ComputationHashResult {\n     // Secret key used for hashing. Since we're not worried about attackers,"
        },
        {
            "sha": "792915df4fc77d43b1668f32d6118def6928a580",
            "filename": "third_party/xla/xla/hlo/transforms/simplifiers/unflatten_call_graph.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/de7c931899fe6f0415513381a3b5edf2555419a0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Funflatten_call_graph.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/de7c931899fe6f0415513381a3b5edf2555419a0/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Funflatten_call_graph.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftransforms%2Fsimplifiers%2Funflatten_call_graph.h?ref=de7c931899fe6f0415513381a3b5edf2555419a0",
            "patch": "@@ -67,7 +67,7 @@ class UnflattenCallGraph : public HloModulePass {\n   // Hashes computations to produce a fingerprint and hash value.\n   // Uses canonical HLO text without IDs for stable, content-based hashing.\n   absl::StatusOr<std::vector<ComputationHashResult>> HashComputations(\n-      const std::vector<HloComputation*>& called_computations);\n+      const absl::flat_hash_set<HloComputation*>& called_computations);\n \n   // Verifies that computations with the same hash are identical to prevent\n   // incorrect merging due to hash collisions, using progressively more"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 4,
        "deletions": 4
    }
}