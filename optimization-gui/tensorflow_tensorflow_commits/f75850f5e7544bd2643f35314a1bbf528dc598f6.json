{
    "author": "khasanovaa",
    "message": "Mark command buffers in xprof trace view as disabled if they are.\n\nCurrently command buffers are disabled by default when profiling.\n\n\\+ cleaning the BUILD file\n\nPiperOrigin-RevId: 814156917",
    "sha": "f75850f5e7544bd2643f35314a1bbf528dc598f6",
    "files": [
        {
            "sha": "eeed2e6ac57233e80100e70b9fe608d018c8bed6",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f75850f5e7544bd2643f35314a1bbf528dc598f6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f75850f5e7544bd2643f35314a1bbf528dc598f6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=f75850f5e7544bd2643f35314a1bbf528dc598f6",
            "patch": "@@ -138,7 +138,6 @@ xla_test(\n         \":command_buffer_cmd\",\n         \":thunk\",\n         \"//xla/runtime:buffer_use\",\n-        \"//xla/runtime:resource_use\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/service:executable\",\n         \"//xla/service:platform_util\",\n@@ -728,7 +727,6 @@ cc_library(\n     hdrs = [\"gpublas_lt_matmul_thunk.h\"],\n     deps = [\n         \":thunk\",\n-        \"//xla/hlo/ir:hlo\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/service/gpu:buffer_allocations\",\n         \"//xla/service/gpu:matmul_utils\",\n@@ -737,7 +735,6 @@ cc_library(\n         \"//xla/stream_executor/gpu:gpu_blas_lt\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\",\n-        \"@com_google_absl//absl/base:core_headers\",\n         \"@com_google_absl//absl/log\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n@@ -1573,7 +1570,6 @@ xla_cc_test(\n         \":thunk\",\n         \":thunk_id\",\n         \":thunk_proto_cc\",\n-        \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:statusor\",\n@@ -1894,7 +1890,6 @@ xla_cc_test(\n         \"//xla/tsl/platform:status_matchers\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/util/proto:proto_matchers\",\n-        \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_googletest//:gtest_main\",\n         \"@local_tsl//tsl/platform:protobuf\",\n     ],\n@@ -2271,7 +2266,6 @@ xla_cc_test(\n         \":thunk\",\n         \":thunk_proto_cc\",\n         \":thunk_proto_deserialization\",\n-        \":wait_for_streams_thunk\",\n         \":while_thunk\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/tsl/platform:status_matchers\",\n@@ -2549,10 +2543,9 @@ xla_cc_test(\n     name = \"thunk_pass_pipeline_test\",\n     srcs = [\"thunk_pass_pipeline_test.cc\"],\n     deps = [\n+        \":sequential_thunk\",\n+        \":thunk\",\n         \":thunk_pass_pipeline\",\n-        \"//xla/backends/gpu/runtime:sequential_thunk\",\n-        \"//xla/backends/gpu/runtime:thunk\",\n-        \"//xla/service:hlo_module_config\",\n         \"//xla/stream_executor:device_description\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/status:statusor\",\n@@ -2591,6 +2584,7 @@ cc_library(\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n         \"@local_tsl//tsl/platform\",\n+        \"@local_tsl//tsl/profiler/lib:profiler_lock\",\n         \"@local_tsl//tsl/profiler/lib:traceme\",\n     ],\n )"
        },
        {
            "sha": "04e57dbe0c53e87e065c789e1298569bc812fd05",
            "filename": "third_party/xla/xla/backends/gpu/runtime/command_buffer_conversion_pass.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f75850f5e7544bd2643f35314a1bbf528dc598f6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_conversion_pass.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f75850f5e7544bd2643f35314a1bbf528dc598f6/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_conversion_pass.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcommand_buffer_conversion_pass.cc?ref=f75850f5e7544bd2643f35314a1bbf528dc598f6",
            "patch": "@@ -49,6 +49,7 @@ limitations under the License.\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n #include \"tsl/platform/platform.h\"\n+#include \"tsl/profiler/lib/profiler_lock.h\"\n #include \"tsl/profiler/lib/traceme.h\"\n \n namespace xla {\n@@ -350,6 +351,10 @@ ConvertThunksToCommandBuffer(\n \n   Thunk::ThunkInfo thunk_info;\n   thunk_info.profile_annotation = \"command_buffer\";\n+  if (tsl::profiler::ProfilerLock::HasActiveSession() &&\n+      !debug_options.xla_enable_command_buffers_during_profiling()) {\n+    thunk_info.profile_annotation += \" (disabled for profiling)\";\n+  }\n   return std::make_unique<CommandBufferThunk>(\n       std::move(cmd_executor), std::move(thunk_info),\n       std::make_unique<SequentialThunk>(Thunk::ThunkInfo(),"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 8,
        "deletions": 9
    }
}