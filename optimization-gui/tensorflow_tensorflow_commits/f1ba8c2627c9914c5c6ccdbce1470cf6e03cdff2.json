{
    "author": "olupton",
    "message": "PR #28928: Dump optimized HLO when deserializing\n\nImported from GitHub PR https://github.com/openxla/xla/pull/28928\n\nThis makes HLO dumps available when using the JAX compilation cache.\nCopybara import of the project:\n\n--\ne2f1acbeb819c6c9abd4e5dae122e2b0eb1e84cb by Olli Lupton <olupton@nvidia.com>:\n\nDump optimized HLO when deserializing\n\nThis makes HLOs available when using the JAX compilation cache.\n\nMerging this change closes #28928\n\nPiperOrigin-RevId: 798135779",
    "sha": "f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
    "files": [
        {
            "sha": "c4d0cafd0c0405aef769e6da383de6bca8c68cd9",
            "filename": "third_party/xla/xla/pjrt/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD?ref=f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
            "patch": "@@ -713,13 +713,15 @@ xla_cc_test(\n         \"//xla/stream_executor:platform\",\n         \"//xla/stream_executor:stream_executor_h\",\n         \"//xla/tsl/lib/core:status_test_util\",\n+        \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/functional:any_invocable\",\n         \"@com_google_absl//absl/status\",\n         \"@com_google_absl//absl/status:status_matchers\",\n         \"@com_google_absl//absl/status:statusor\",\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_googletest//:gtest_main\",\n+        \"@local_tsl//tsl/platform:path\",\n     ],\n )\n "
        },
        {
            "sha": "4ffcd7eb025cb68dde7739592248b2156e142684",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.cc?ref=f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
            "patch": "@@ -3825,14 +3825,14 @@ PjRtStreamExecutorClient::LoadSerializedExecutable(\n                       DeserializeToLocalExecutable(serialized, options));\n   return LoadInternal(/*unoptimized_hlo_module_proto=*/std::nullopt,\n                       std::move(local_executables_and_options.first),\n-                      local_executables_and_options.second);\n+                      local_executables_and_options.second, /*dump=*/true);\n }\n \n absl::StatusOr<std::unique_ptr<PjRtLoadedExecutable>>\n PjRtStreamExecutorClient::LoadInternal(\n     std::optional<HloModuleProto> unoptimized_hlo_module_proto,\n     std::vector<std::unique_ptr<LocalExecutable>> local_executables,\n-    CompileOptions compile_options) {\n+    CompileOptions compile_options, bool dump) {\n   auto input_options = compile_options;\n \n   TF_RETURN_IF_ERROR(compile_options.ApplyAllOptionOverrides());\n@@ -3850,6 +3850,24 @@ PjRtStreamExecutorClient::LoadInternal(\n   const bool xla_dump_hlo_unoptimized_snapshots =\n       ex_options.has_debug_options() &&\n       ex_options.debug_options().xla_dump_hlo_unoptimized_snapshots();\n+  if (dump) {\n+    for (std::unique_ptr<LocalExecutable>& local_executable :\n+         local_executables) {\n+      VLOG(1) << \"Dumping deserialized executable\";\n+      // Override the debug_options() embedded in the module with those\n+      // explicitly passed in when deserializing. This allows options such as\n+      // --xla_dump_to to be changed. Does not quite match the naming convention\n+      // of the dump during compilation, which includes a backend-specific\n+      // prefix.\n+      if (local_executable->executable()->has_module()) {\n+        DumpHloModuleIfEnabled(local_executable->executable()->module(),\n+                               kAfterOptimizationsDumpName,\n+                               ex_options.has_debug_options()\n+                                   ? &ex_options.debug_options()\n+                                   : nullptr);\n+      }\n+    }\n+  }\n \n   auto executable = std::make_unique<PjRtStreamExecutorLoadedExecutable>(\n       std::move(local_executables),\n@@ -3882,7 +3900,8 @@ PjRtStreamExecutorClient::Load(std::unique_ptr<PjRtExecutable> executable,\n   TF_ASSIGN_OR_RETURN(auto local_executables, se_executable->ConsumeExecutable(\n                                                   client(), compile_options));\n   return LoadInternal(se_executable->unoptimized_hlo_module_proto(),\n-                      std::move(local_executables), compile_options);\n+                      std::move(local_executables), compile_options,\n+                      /*dump=*/false);\n }\n \n bool PjRtStreamExecutorClient::IsDmaMapped(const void* data_start,"
        },
        {
            "sha": "ff035b628eb671181b2d68bbb3a35931041dd32b",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client.h?ref=f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
            "patch": "@@ -508,7 +508,7 @@ class PjRtStreamExecutorClient : public CommonPjRtClient {\n   absl::StatusOr<std::unique_ptr<PjRtLoadedExecutable>> LoadInternal(\n       std::optional<HloModuleProto> unoptimized_hlo_module_proto,\n       std::vector<std::unique_ptr<LocalExecutable>> local_executables,\n-      CompileOptions compile_options);\n+      CompileOptions compile_options, bool dump);\n \n   const PjRtPlatformId platform_id_;\n   const std::string platform_name_;"
        },
        {
            "sha": "b69289ad62d376db59acb9befd6c905b9a92e291",
            "filename": "third_party/xla/xla/pjrt/pjrt_stream_executor_client_test.cc",
            "status": "modified",
            "additions": 57,
            "deletions": 2,
            "changes": 59,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_stream_executor_client_test.cc?ref=f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
            "patch": "@@ -45,8 +45,10 @@ limitations under the License.\n #include \"xla/stream_executor/platform.h\"\n #include \"xla/stream_executor/stream_executor.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n+#include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/xla_data.pb.h\"\n+#include \"tsl/platform/path.h\"\n \n namespace xla {\n namespace {\n@@ -83,8 +85,8 @@ absl::StatusOr<std::unique_ptr<PjRtStreamExecutorClient>> GetClient() {\n \n absl::StatusOr<std::unique_ptr<PjRtLoadedExecutable>> ToyExecutable(\n     PjRtStreamExecutorClient& client, Shape shape,\n-    absl::AnyInvocable<void(XlaBuilder&)> set_up_aliases) {\n-  CompileOptions compile_options;\n+    absl::AnyInvocable<void(XlaBuilder&)> set_up_aliases,\n+    CompileOptions compile_options = {}) {\n   XlaBuilder builder(\"Add\");\n   auto a = Parameter(&builder, 0, shape, \"a\");\n   auto b = Parameter(&builder, 1, shape, \"b\");\n@@ -210,5 +212,58 @@ TEST(PjRtStreamExecutorClientTest, ExecuteWithInputError) {\n   }\n }\n \n+TEST(PjRtStreamExecutorClientTest, DeserializeAndDump) {\n+  tsl::Env* env = tsl::Env::Default();\n+  EXPECT_TRUE(env);\n+  Shape shape = xla::ShapeUtil::MakeScalarShape(F32);\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<PjRtStreamExecutorClient> client,\n+                          GetClient());\n+  std::string compile_dump_dir;\n+  EXPECT_TRUE(env->LocalTempFilename(&compile_dump_dir));\n+  CompileOptions compile_options;\n+  compile_options.executable_build_options.mutable_debug_options()\n+      ->set_xla_dump_to(compile_dump_dir);\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<PjRtLoadedExecutable> executable,\n+      ToyExecutable(\n+          *client, shape, [](XlaBuilder& builder) {}, compile_options));\n+  std::string compile_dump_name, compile_dump_contents;\n+  {\n+    std::vector<std::string> matches;\n+    TF_ASSERT_OK(env->GetMatchingPaths(\n+        tsl::io::JoinPath(compile_dump_dir, \"*after_optimizations.txt\"),\n+        &matches));\n+    EXPECT_THAT(matches, testing::SizeIs(1));\n+    compile_dump_name = std::move(matches.front());\n+    TF_ASSERT_OK(\n+        tsl::ReadFileToString(env, compile_dump_name, &compile_dump_contents));\n+  }\n+  TF_ASSERT_OK_AND_ASSIGN(std::string serialized,\n+                          client->SerializeExecutable(*executable));\n+  std::string deserialize_dump_dir;\n+  EXPECT_TRUE(env->LocalTempFilename(&deserialize_dump_dir));\n+  EXPECT_NE(compile_dump_dir, deserialize_dump_dir);\n+  CompileOptions deserialize_options;\n+  deserialize_options.executable_build_options.mutable_debug_options()\n+      ->set_xla_dump_to(deserialize_dump_dir);\n+  LoadOptions load_options;\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      std::unique_ptr<PjRtLoadedExecutable> reloaded_executable,\n+      client->LoadSerializedExecutable(serialized, deserialize_options,\n+                                       load_options));\n+  std::string deserialize_dump_name, deserialize_dump_contents;\n+  {\n+    std::vector<std::string> matches;\n+    TF_ASSERT_OK(env->GetMatchingPaths(\n+        tsl::io::JoinPath(deserialize_dump_dir, \"*after_optimizations.txt\"),\n+        &matches));\n+    EXPECT_THAT(matches, testing::SizeIs(1));\n+    deserialize_dump_name = std::move(matches.front());\n+    TF_ASSERT_OK(tsl::ReadFileToString(env, deserialize_dump_name,\n+                                       &deserialize_dump_contents));\n+  }\n+  EXPECT_EQ(compile_dump_contents, deserialize_dump_contents);\n+}\n+\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "06a662dd516b4e056596b006080dd0d42ea26526",
            "filename": "third_party/xla/xla/service/dump.cc",
            "status": "modified",
            "additions": 53,
            "deletions": 25,
            "changes": 78,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fservice%2Fdump.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fservice%2Fdump.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdump.cc?ref=f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
            "patch": "@@ -124,12 +124,14 @@ absl::Status CreateDirIfNeeded(const std::string& dir, tsl::Env* env) {\n \n std::string RenderGraph(absl::string_view label, const HloModule& module,\n                         RenderedGraphFormat format,\n-                        bool show_fusion_subcomputations) {\n+                        bool show_fusion_subcomputations,\n+                        const DebugOptions* dump_options) {\n   HloRenderOptions hlo_render_options;\n   hlo_render_options.show_fusion_subcomputations = show_fusion_subcomputations;\n-  absl::StatusOr<std::string> rendered_graph =\n-      RenderGraph(*module.entry_computation(), label,\n-                  module.config().debug_options(), format, hlo_render_options);\n+  const DebugOptions& opts =\n+      dump_options ? *dump_options : module.config().debug_options();\n+  absl::StatusOr<std::string> rendered_graph = RenderGraph(\n+      *module.entry_computation(), label, opts, format, hlo_render_options);\n   if (rendered_graph.ok()) {\n     return std::move(rendered_graph).value();\n   }\n@@ -465,7 +467,8 @@ static bool IsTrivial(const HloComputation& computation) {\n // Returns full file paths of all dumps of the module.\n static std::vector<std::string> DumpHloModuleImpl(\n     const HloModule& module, const BufferAssignment* buffer_assn,\n-    string_view prefix, string_view suffix, const CanonicalDebugOptions& opts) {\n+    string_view prefix, string_view suffix, const CanonicalDebugOptions& opts,\n+    const DebugOptions& debug_options) {\n   tsl::profiler::ScopedAnnotation annotation([&] {\n     return absl::StrFormat(\"XlaDumpHloModule:#module=%s,program_id=%d#\",\n                            module.name(), module.unique_id());\n@@ -507,17 +510,22 @@ static std::vector<std::string> DumpHloModuleImpl(\n   if (opts.dump_as_dot) {\n     file_paths.push_back(DumpToFileInDirImpl(\n         StrFormat(\"%s.dot\", filename),\n-        RenderGraph(filename, module, RenderedGraphFormat::kDot), opts));\n+        RenderGraph(filename, module, RenderedGraphFormat::kDot,\n+                    /*show_fusion_subcomputations=*/true, &debug_options),\n+        opts));\n   }\n \n   if (opts.dump_as_html) {\n     file_paths.push_back(DumpToFileInDirImpl(\n         StrFormat(\"%s.html\", filename),\n-        RenderGraph(filename, module, RenderedGraphFormat::kHtml), opts));\n+        RenderGraph(filename, module, RenderedGraphFormat::kHtml,\n+                    /*show_fusion_subcomputations=*/true, &debug_options),\n+        opts));\n     if (absl::StrContains(filename, kAfterOptimizationsDumpName)) {\n       file_paths.push_back(DumpToFileInDirImpl(\n           StrFormat(\"%s.top_level.html\", filename),\n-          RenderGraph(filename, module, RenderedGraphFormat::kHtml, false),\n+          RenderGraph(filename, module, RenderedGraphFormat::kHtml,\n+                      /*show_fusion_subcomputations=*/false, &debug_options),\n           opts));\n     }\n   }\n@@ -554,7 +562,9 @@ static std::vector<std::string> DumpHloModuleImpl(\n   // Special case for rendering graphs as URLs.  We'll dump them to a file\n   // because why not, but we always log them to stdout as well.\n   if (opts.dump_as_url) {\n-    std::string url = RenderGraph(filename, module, RenderedGraphFormat::kUrl);\n+    std::string url =\n+        RenderGraph(filename, module, RenderedGraphFormat::kUrl,\n+                    /*show_fusion_subcomputations=*/true, &debug_options);\n     std::cout << filename << \" --> \" << url << std::endl;\n     if (!opts.dumping_to_stdout()) {\n       file_paths.push_back(\n@@ -601,13 +611,18 @@ static void DumpHloModuleMetadata(\n \n std::vector<std::string> DumpHloModuleIfEnabledImpl(\n     const HloModule& module, const BufferAssignment* buffer_assn,\n-    string_view name) {\n-  CanonicalDebugOptions opts(module.config().debug_options());\n+    const DebugOptions* maybe_dump_options, string_view name) {\n+  const DebugOptions& dump_options = maybe_dump_options\n+                                         ? *maybe_dump_options\n+                                         : module.config().debug_options();\n+  CanonicalDebugOptions opts(dump_options);\n   if (opts.should_dump_module(module.name())) {\n     std::vector<std::string> filepaths = DumpHloModuleImpl(\n-        module, /*buffer_assn=*/buffer_assn, TimestampFor(module), name, opts);\n+        module, /*buffer_assn=*/buffer_assn,\n+        TimestampFor(module, &dump_options), name, opts, dump_options);\n     std::optional<std::string> maybe_debug_options_filepath =\n-        DumpNonDefaultDebugOptions(module, kNonDefaultDebugOptionsDumpSuffix);\n+        DumpNonDefaultDebugOptions(module, kNonDefaultDebugOptionsDumpSuffix,\n+                                   maybe_dump_options);\n     if (maybe_debug_options_filepath.has_value()) {\n       filepaths.push_back(*maybe_debug_options_filepath);\n     }\n@@ -620,8 +635,12 @@ std::vector<std::string> DumpHloModuleIfEnabledImpl(\n \n // Get a timestamp which we can use as a filename prefix specific to this\n // module.\n-std::string TimestampFor(const HloModule& module) {\n-  if (!module.config().debug_options().xla_dump_include_timestamp()) {\n+std::string TimestampFor(const HloModule& module,\n+                         const DebugOptions* debug_options_override) {\n+  const DebugOptions& opts = debug_options_override\n+                                 ? *debug_options_override\n+                                 : module.config().debug_options();\n+  if (!opts.xla_dump_include_timestamp()) {\n     return \"\";\n   }\n   absl::MutexLock lock(&mu);\n@@ -901,23 +920,30 @@ std::string GetNonDefaultDebugOptions(const DebugOptions& debug_options) {\n }\n \n std::optional<std::string> DumpNonDefaultDebugOptions(\n-    const HloModule& module, absl::string_view suffix) {\n+    const HloModule& module, absl::string_view suffix,\n+    const DebugOptions* dump_options) {\n+  // Substance of the which-options-have-non-default-values logic always based\n+  // on the options embedded in the HloModule\n   const DebugOptions& debug_options = module.config().debug_options();\n   std::string filename = FilenameFor(module, \"\", suffix);\n   std::string nonDefaultDebugOptions = GetNonDefaultDebugOptions(debug_options);\n-  return DumpToFileInDirImpl(filename, nonDefaultDebugOptions,\n-                             CanonicalDebugOptions(debug_options));\n+  // Options steering where the dump is actually written to can be overriden\n+  CanonicalDebugOptions opts(dump_options ? *dump_options : debug_options);\n+  return DumpToFileInDirImpl(filename, nonDefaultDebugOptions, opts);\n }\n \n-std::vector<std::string> DumpHloModuleIfEnabled(const HloModule& module,\n-                                                string_view name) {\n-  return DumpHloModuleIfEnabledImpl(module, /*buffer_assn=*/nullptr, name);\n+std::vector<std::string> DumpHloModuleIfEnabled(\n+    const HloModule& module, string_view name,\n+    const DebugOptions* dump_options) {\n+  return DumpHloModuleIfEnabledImpl(module, /*buffer_assn=*/nullptr,\n+                                    dump_options, name);\n }\n \n std::vector<std::string> DumpHloModuleIfEnabled(\n     const HloModule& module, const BufferAssignment& buffer_assn,\n     string_view name) {\n-  return DumpHloModuleIfEnabledImpl(module, &buffer_assn, name);\n+  return DumpHloModuleIfEnabledImpl(module, &buffer_assn,\n+                                    /*maybe_dump_options=*/nullptr, name);\n }\n \n std::vector<std::string> DumpHloModuleProtoIfEnabled(\n@@ -931,7 +957,8 @@ std::vector<std::string> DumpHloModuleProtoIfEnabled(\n   CanonicalDebugOptions opts(module->config().debug_options());\n   if (opts.should_dump_module(module->name())) {\n     return DumpHloModuleImpl(*module, /*buffer_assn=*/nullptr,\n-                             TimestampFor(*module), name, opts);\n+                             TimestampFor(*module), name, opts,\n+                             module->config().debug_options());\n   }\n   return {};\n }\n@@ -996,7 +1023,8 @@ std::vector<std::string> DumpHloModuleBetweenPassesIfEnabled(\n       StrFormat(\"%04d.%s.after_%s.before_%s\", step_number, pipeline_name,\n                 after_pass_name, before_pass_name);\n   return DumpHloModuleImpl(module, /*buffer_assn=*/nullptr, timestamp,\n-                           filename_suffix, opts);\n+                           filename_suffix, opts,\n+                           module.config().debug_options());\n }\n \n void DumpHloModuleDuringPassIfEnabled(string_view pass_name,\n@@ -1014,7 +1042,7 @@ void DumpHloModuleDuringPassIfEnabled(string_view pass_name,\n   std::string filename_suffix =\n       StrFormat(\"%04d.%s.%s\", step_number, pass_name, step_name);\n   DumpHloModuleImpl(module, /*buffer_assn=*/nullptr, timestamp, filename_suffix,\n-                    opts);\n+                    opts, module.config().debug_options());\n }\n \n void DumpHloSnapshotIfEnabled(const HloModule& module,"
        },
        {
            "sha": "b7048c116536686193a0178f13bfbb4949c76c74",
            "filename": "third_party/xla/xla/service/dump.h",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fservice%2Fdump.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2/third_party%2Fxla%2Fxla%2Fservice%2Fdump.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fdump.h?ref=f1ba8c2627c9914c5c6ccdbce1470cf6e03cdff2",
            "patch": "@@ -52,7 +52,8 @@ absl::Status CreateDirIfNeeded(const std::string& dir, tsl::Env* env);\n \n // Get a timestamp which we can use as a filename prefix specific to this\n // module.\n-std::string TimestampFor(const HloModule& module);\n+std::string TimestampFor(const HloModule& module,\n+                         const DebugOptions* debug_options_override = nullptr);\n \n // Create the filename we will use to dump in DumpToFileInDir.\n std::string FilenameFor(int unique_id, absl::string_view module_name,\n@@ -107,7 +108,8 @@ void DumpProtobufToFile(const tsl::protobuf::Message& proto,\n // Render graph in a given format.\n std::string RenderGraph(absl::string_view label, const HloModule& module,\n                         RenderedGraphFormat format,\n-                        bool show_fusion_subcomputations = true);\n+                        bool show_fusion_subcomputations = true,\n+                        const DebugOptions* dump_options = nullptr);\n \n // Similar to above, but the filename depends on module's information and the\n // given name. Also allows for the optional serialization function.\n@@ -122,9 +124,11 @@ void DumpPerModuleProtobufToFile(const HloModule& module,\n // Dumps the given HLO module if dumping is enabled for the module. Exactly\n // where and in what formats it's dumped is determined by the module's config.\n // Returns the full file paths of all dumps of the module, or an empty vector if\n-// nothing was dumped.\n-std::vector<std::string> DumpHloModuleIfEnabled(const HloModule& module,\n-                                                absl::string_view name);\n+// nothing was dumped. If not null, `dump_options` are used to determine the\n+// dump directory, file formats, and so on.\n+std::vector<std::string> DumpHloModuleIfEnabled(\n+    const HloModule& module, absl::string_view name,\n+    const DebugOptions* dump_options = nullptr);\n std::vector<std::string> DumpHloModuleIfEnabled(\n     const HloModule& module, const BufferAssignment& buffer_assn,\n     absl::string_view name);\n@@ -205,8 +209,9 @@ void DumpHloConfigIfEnabled(const HloModule& module);\n // Dumps the non-default debug options to a file in the xla_dump_to directory\n // specified by the module's DebugOptions. Returns the full file path of the\n // dump. If unable to dump, returns std::nullopt.\n-std::optional<std::string> DumpNonDefaultDebugOptions(const HloModule& module,\n-                                                      absl::string_view suffix);\n+std::optional<std::string> DumpNonDefaultDebugOptions(\n+    const HloModule& module, absl::string_view suffix,\n+    const DebugOptions* dump_options = nullptr);\n \n // Returns the non-default debug options as a string. The default debug options\n // are received from DefaultDebugOptionsIgnoringFlags()."
        }
    ],
    "stats": {
        "total": 185,
        "additions": 147,
        "deletions": 38
    }
}