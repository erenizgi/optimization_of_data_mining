{
    "author": "alekstheod",
    "message": "PR #34945: [ROCm] Add support for parametrized rocm hermetic dependency\n\nImported from GitHub PR https://github.com/openxla/xla/pull/34945\n\nüìù Summary of Changes\nThis change adds support of parametrized\nhermetic rocm dependency through the environment variables.\nOne can set these 3 environment variables:\n```\n--repo_env=\"ROCM_DISTRO_URL=https://therock-nightly-tarball.s3.amazonaws.com/therock-dist-linux-gfx94X-dcgpu-7.10.0a20251107.tar.gz\"\n--repo_env=\"ROCM_DISTRO_HASH=486dbf647bcf9b78f21d7477f43addc7b2075b1a322a119045db9cdc5eb98380\"\n--repo_env=\"ROCM_DISTRO_LINKS=llvm/amdgcn:amdgcn\"\n```\nWhere ROCM_DISTRO_LINKS is a list of pairs formed like:\n\"target:link,target2:link2\" that will create symlinks after the extraction of the tar file.\n\nüéØ Justification\nThis change adds more flexibility to rocm hermetic builds and eliminates the need\nto modify the rocm_redist.bzl file.\n\nüöÄ Kind of Contribution\nPlease remove what does not apply:\n‚ú® New Feature\n\nüìä Benchmark (for Performance Improvements)\nNot relevant\n\nüß™ Unit Tests:\nNot relevant\n\nüß™ Execution Tests:\nNot relevant\n\nCopybara import of the project:\n\n--\n8a9522d97fb0514ef4c16e205be75d0817a7f5d6 by Alex Theodoridis <alekstheod@gmail.com>:\n\nAdd support for parametrized rocm hermetic dependency\n\n--\n6dcf113b25ab4530372ed9b7d6c04124a1ce09ba by Alexandros Theodoridis <atheodor@amd.com>:\n\nClean up\n\nMerging this change closes #34945\n\nPiperOrigin-RevId: 845830426",
    "sha": "356223b183a386eb95e4206c6fb485388d7aee6c",
    "files": [
        {
            "sha": "c933ef4fb1072e9f411b832265d7489d00a6ea91",
            "filename": "third_party/xla/tensorflow.bazelrc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/356223b183a386eb95e4206c6fb485388d7aee6c/third_party%2Fxla%2Ftensorflow.bazelrc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/356223b183a386eb95e4206c6fb485388d7aee6c/third_party%2Fxla%2Ftensorflow.bazelrc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Ftensorflow.bazelrc?ref=356223b183a386eb95e4206c6fb485388d7aee6c",
            "patch": "@@ -287,7 +287,9 @@ common:rocm_ci --config=rocm\n \n common:rocm_ci_hermetic --dynamic_mode=off\n common:rocm_ci_hermetic --config=rocm_clang_official\n-common:rocm_ci_hermetic --repo_env=\"ROCM_DISTRO_VERSION=rocm_7.10.0_gfx94X\"\n+common:rocm_ci_hermetic --repo_env=\"ROCM_DISTRO_URL=https://therock-nightly-tarball.s3.amazonaws.com/therock-dist-linux-gfx94X-dcgpu-7.10.0a20251107.tar.gz\"\n+common:rocm_ci_hermetic --repo_env=\"ROCM_DISTRO_HASH=486dbf647bcf9b78f21d7477f43addc7b2075b1a322a119045db9cdc5eb98380\"\n+common:rocm_ci_hermetic --repo_env=\"ROCM_DISTRO_LINKS=llvm/amdgcn:amdgcn\"\n common:rocm_ci_hermetic --@local_config_rocm//rocm:rocm_path_type=hermetic\n \n # This config option is used for SYCL as GPU backend."
        },
        {
            "sha": "6f7db647259a84961c5d889797201552b042654c",
            "filename": "third_party/xla/third_party/gpus/rocm/rocm_redist.bzl",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/356223b183a386eb95e4206c6fb485388d7aee6c/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/356223b183a386eb95e4206c6fb485388d7aee6c/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm%2Frocm_redist.bzl?ref=356223b183a386eb95e4206c6fb485388d7aee6c",
            "patch": "@@ -39,3 +39,22 @@ rocm_redist = {\n         rocm_root = \"_rocm_sdk_devel\",\n     ),\n }\n+\n+def _parse_rocm_distro_links(distro_links):\n+    result = []\n+    for pair in distro_links.split(\",\"):\n+        link = pair.split(\":\")\n+        result.append(struct(target = link[0], link = link[1]))\n+    return result\n+\n+def create_rocm_distro(distro_url, distro_hash, symlinks):\n+    return struct(\n+        packages = [\n+            {\n+                \"url\": distro_url,\n+                \"sha256\": distro_hash,\n+            },\n+        ],\n+        required_softlinks = _parse_rocm_distro_links(symlinks),\n+        rocm_root = \"\",\n+    )"
        },
        {
            "sha": "9415b7c86db5dde1f813191147f7f93fbe4d4078",
            "filename": "third_party/xla/third_party/gpus/rocm_configure.bzl",
            "status": "modified",
            "additions": 30,
            "deletions": 10,
            "changes": 40,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/356223b183a386eb95e4206c6fb485388d7aee6c/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/356223b183a386eb95e4206c6fb485388d7aee6c/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fgpus%2Frocm_configure.bzl?ref=356223b183a386eb95e4206c6fb485388d7aee6c",
            "patch": "@@ -17,6 +17,7 @@\n load(\"@bazel_skylib//lib:paths.bzl\", \"paths\")\n load(\n     \"//third_party/gpus/rocm:rocm_redist.bzl\",\n+    \"create_rocm_distro\",\n     \"rocm_redist\",\n )\n load(\n@@ -54,6 +55,9 @@ _TF_ROCM_AMDGPU_TARGETS = \"TF_ROCM_AMDGPU_TARGETS\"\n _TF_ROCM_CONFIG_REPO = \"TF_ROCM_CONFIG_REPO\"\n _DISTRIBUTION_PATH = \"rocm/rocm_dist\"\n _ROCM_DISTRO_VERSION = \"ROCM_DISTRO_VERSION\"\n+_ROCM_DISTRO_URL = \"ROCM_DISTRO_URL\"\n+_ROCM_DISTRO_HASH = \"ROCM_DISTRO_HASH\"\n+_ROCM_DISTRO_LINKS = \"ROCM_DISTRO_LINKS\"\n _TMPDIR = \"TMPDIR\"\n \n _DEFAULT_ROCM_TOOLKIT_PATH = \"/opt/rocm\"\n@@ -545,23 +549,36 @@ def _remove_root_dir(path, root_dir):\n         return path[len(root_dir) + 1:]\n     return path\n \n+def _setup_rocm_distro_dir_impl(repository_ctx, rocm_distro):\n+    repository_ctx.file(\"rocm/.index\")\n+    for pkg in rocm_distro.packages:\n+        _download_package(repository_ctx, pkg)\n+\n+    for entry in rocm_distro.required_softlinks:\n+        repository_ctx.symlink(\n+            \"{}/{}\".format(_DISTRIBUTION_PATH, entry.target),\n+            \"{}/{}\".format(_DISTRIBUTION_PATH, entry.link),\n+        )\n+    bash_bin = get_bash_bin(repository_ctx)\n+    return _get_rocm_config(repository_ctx, bash_bin, _canonical_path(\"{}/{}\".format(_DISTRIBUTION_PATH, rocm_distro.rocm_root)), \"\")\n+\n def _setup_rocm_distro_dir(repository_ctx):\n     \"\"\"Sets up the rocm hermetic installation directory to be used in hermetic build\"\"\"\n     bash_bin = get_bash_bin(repository_ctx)\n+    rocm_distro_url = repository_ctx.os.environ.get(_ROCM_DISTRO_URL)\n+    if rocm_distro_url:\n+        rocm_distro_hash = repository_ctx.os.environ.get(_ROCM_DISTRO_HASH)\n+        if not rocm_distro_hash:\n+            fail(\"{} environment variable is required\", _ROCM_DISTRO_HASH)\n+        rocm_distro_links = repository_ctx.os.environ.get(_ROCM_DISTRO_LINKS, \"\")\n+        rocm_distro = create_rocm_distro(rocm_distro_url, rocm_distro_hash, rocm_distro_links)\n+        return _setup_rocm_distro_dir_impl(repository_ctx, rocm_distro)\n+\n     rocm_distro = repository_ctx.os.environ.get(_ROCM_DISTRO_VERSION)\n     multiple_paths = repository_ctx.os.environ.get(_TF_ROCM_MULTIPLE_PATHS)\n     if rocm_distro:\n         redist = rocm_redist[rocm_distro]\n-        repository_ctx.file(\"rocm/.index\")\n-        for pkg in redist.packages:\n-            _download_package(repository_ctx, pkg)\n-\n-        for entry in redist.required_softlinks:\n-            repository_ctx.symlink(\n-                \"{}/{}\".format(_DISTRIBUTION_PATH, entry.target),\n-                \"{}/{}\".format(_DISTRIBUTION_PATH, entry.link),\n-            )\n-        return _get_rocm_config(repository_ctx, bash_bin, _canonical_path(\"{}/{}\".format(_DISTRIBUTION_PATH, redist.rocm_root)), \"\")\n+        return _setup_rocm_distro_dir_impl(repository_ctx, rocm_distro)\n     elif multiple_paths:\n         paths_list = multiple_paths.split(\":\")\n         for rocm_custom_path in paths_list:\n@@ -855,6 +872,9 @@ _ENVIRONS = [\n     _ROCM_TOOLKIT_PATH,\n     _TF_ROCM_AMDGPU_TARGETS,\n     _ROCM_DISTRO_VERSION,\n+    _ROCM_DISTRO_URL,\n+    _ROCM_DISTRO_HASH,\n+    _ROCM_DISTRO_LINKS,\n     _TF_ROCM_RBE_DOCKER_IMAGE,\n     _TF_ROCM_RBE_SINGLE_GPU_POOL,\n     _TF_ROCM_RBE_MULTI_GPU_POOL,"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 52,
        "deletions": 11
    }
}