{
    "author": "olegshyshkov",
    "message": "[XLA:GPU] Pass HloInstruction to MustWrapInstruction.\n\nIn the following changes I'll need to wrap custom-call into fusions, but only conditionally based on custom call type.\n\nPiperOrigin-RevId: 836574465",
    "sha": "1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
    "files": [
        {
            "sha": "48980f8de9f80be2d5f9db57b5ea3eedbfd86765",
            "filename": "third_party/xla/xla/codegen/emitters/fusion_wrapper_base.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ffusion_wrapper_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ffusion_wrapper_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ffusion_wrapper_base.cc?ref=1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
            "patch": "@@ -47,7 +47,7 @@ absl::StatusOr<bool> FusionWrapperBase::RunImpl(\n       }\n       return absl::OkStatus();\n     }\n-    if (!MustWrapInstruction(opcode)) {\n+    if (!MustWrapInstruction(*instruction)) {\n       return absl::OkStatus();\n     }\n     auto* computation = instruction->parent();"
        },
        {
            "sha": "a444559ee4a659c337a785d078e99fd615e2f574",
            "filename": "third_party/xla/xla/codegen/emitters/fusion_wrapper_base.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ffusion_wrapper_base.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ffusion_wrapper_base.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fcodegen%2Femitters%2Ffusion_wrapper_base.h?ref=1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
            "patch": "@@ -29,7 +29,7 @@ namespace emitters {\n // the type of the wrapper.\n class FusionWrapperBase : public HloModulePass {\n  public:\n-  virtual bool MustWrapInstruction(HloOpcode opcode) = 0;\n+  virtual bool MustWrapInstruction(const HloInstruction& instruction) = 0;\n   virtual HloInstruction::FusionKind ChooseFusionKind(\n       const HloInstruction& producer, const HloInstruction& consumer) {\n     return HloInstruction::FusionKind::kLoop;"
        },
        {
            "sha": "af4cf569643a951a1194a1511fd2e0b8e313427b",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.cc?ref=1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
            "patch": "@@ -21,7 +21,8 @@ limitations under the License.\n namespace xla {\n namespace cpu {\n \n-bool FusionWrapper::MustWrapInstruction(HloOpcode opcode) {\n+bool FusionWrapper::MustWrapInstruction(const HloInstruction& instruction) {\n+  const HloOpcode opcode = instruction.opcode();\n   switch (opcode) {\n     case HloOpcode::kScatter:\n       return true;"
        },
        {
            "sha": "5f430f93afa8c799326efceb6d8cede0b2167a1a",
            "filename": "third_party/xla/xla/service/cpu/fusion_wrapper.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Ffusion_wrapper.h?ref=1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
            "patch": "@@ -34,7 +34,7 @@ class FusionWrapper : public emitters::FusionWrapperBase {\n \n   absl::string_view name() const override { return \"fusion-wrapper\"; }\n \n-  bool MustWrapInstruction(HloOpcode opcode) override;\n+  bool MustWrapInstruction(const HloInstruction& instruction) override;\n \n  private:\n   bool using_new_fusion_emitter_;"
        },
        {
            "sha": "3a9f3c7ec8112a7c9b9f0b7cd89afea7a898fa42",
            "filename": "third_party/xla/xla/service/gpu/transforms/fusion_wrapper.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ffusion_wrapper.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ffusion_wrapper.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ffusion_wrapper.cc?ref=1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
            "patch": "@@ -21,7 +21,8 @@ limitations under the License.\n namespace xla {\n namespace gpu {\n \n-bool FusionWrapper::MustWrapInstruction(HloOpcode opcode) {\n+bool FusionWrapper::MustWrapInstruction(const HloInstruction& instruction) {\n+  const HloOpcode opcode = instruction.opcode();\n   switch (opcode) {\n     case HloOpcode::kAbs:\n     case HloOpcode::kAcos:"
        },
        {
            "sha": "daab6020dcf832cabcb3f2af0e2c6d7ede5a02b9",
            "filename": "third_party/xla/xla/service/gpu/transforms/fusion_wrapper.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ffusion_wrapper.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/1dd823a05d4b7a01d84a83070679f4dfee7a1a30/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ffusion_wrapper.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Ftransforms%2Ffusion_wrapper.h?ref=1dd823a05d4b7a01d84a83070679f4dfee7a1a30",
            "patch": "@@ -33,7 +33,7 @@ class FusionWrapper : public emitters::FusionWrapperBase {\n \n   absl::string_view name() const override { return \"fusion-wrapper\"; }\n \n-  bool MustWrapInstruction(HloOpcode opcode) override;\n+  bool MustWrapInstruction(const HloInstruction& instruction) override;\n   HloInstruction::FusionKind ChooseFusionKind(\n       const HloInstruction& producer, const HloInstruction& consumer) override;\n "
        }
    ],
    "stats": {
        "total": 14,
        "additions": 8,
        "deletions": 6
    }
}