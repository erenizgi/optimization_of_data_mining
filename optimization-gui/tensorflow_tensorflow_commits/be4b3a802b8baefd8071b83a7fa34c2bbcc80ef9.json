{
    "author": "tensorflower-gardener",
    "message": "Add support for running HloRunnerAgnosticTestBase with a provided BufferAssignmentProto.\n\nPiperOrigin-RevId: 840446365",
    "sha": "be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9",
    "files": [
        {
            "sha": "39b45cbcddcc601aa834d05ffa009d7eb51b14d0",
            "filename": "third_party/xla/xla/tests/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9/third_party%2Fxla%2Fxla%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2FBUILD?ref=be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9",
            "patch": "@@ -223,6 +223,7 @@ cc_library(\n         \"//xla/service:computation_placer_hdr\",\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service:hlo_module_util\",\n+        \"//xla/service:hlo_proto_cc\",\n         \"//xla/service:hlo_runner_interface\",\n         \"//xla/service:hlo_verifier\",\n         \"//xla/service:interpreter_plugin\",  # reference backend\n@@ -241,6 +242,7 @@ cc_library(\n         \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/types:span\",\n+        \"@com_google_protobuf//:protobuf\",\n         \"@llvm-project//llvm:Support\",\n         \"@local_tsl//tsl/platform:protobuf\",\n     ],"
        },
        {
            "sha": "db5fd00500278aadace73ee551916db7619a8252",
            "filename": "third_party/xla/xla/tests/hlo_runner_agnostic_test_base.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9/third_party%2Fxla%2Fxla%2Ftests%2Fhlo_runner_agnostic_test_base.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9/third_party%2Fxla%2Fxla%2Ftests%2Fhlo_runner_agnostic_test_base.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fhlo_runner_agnostic_test_base.cc?ref=be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9",
            "patch": "@@ -34,6 +34,7 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/types/span.h\"\n #include \"llvm/ADT/STLExtras.h\"\n+#include \"google/protobuf/message.h\"\n #include \"xla/error_spec.h\"\n #include \"xla/hlo/builder/xla_builder.h\"\n #include \"xla/hlo/builder/xla_computation.h\"\n@@ -218,7 +219,8 @@ HloRunnerAgnosticTestBase::ExecuteReplicated(\n \n ::testing::AssertionResult HloRunnerAgnosticTestBase::Run(\n     std::unique_ptr<HloModule> module, const bool run_hlo_passes,\n-    const std::function<void(HloModule*)>& test_preprocessor) {\n+    const std::function<void(HloModule*)>& test_preprocessor,\n+    BufferAssignmentProto* buffer_assignment_proto) {\n   const std::vector<Literal> fake_arguments =\n       MakeFakeArguments(module.get()).value();\n   if (const absl::StatusOr<bool> change = verifier().Run(module.get());\n@@ -234,7 +236,13 @@ ::testing::AssertionResult HloRunnerAgnosticTestBase::Run(\n   }\n \n   const absl::StatusOr<Literal> output =\n-      test_runner_->Execute(std::move(module), fake_arguments, run_hlo_passes);\n+      buffer_assignment_proto == nullptr\n+          ? test_runner_->Execute(std::move(module), fake_arguments,\n+                                  run_hlo_passes)\n+          : test_runner_->ExecuteWithBufferAssignment(\n+                std::move(module), buffer_assignment_proto, fake_arguments,\n+                run_hlo_passes);\n+\n   return swallow_execution_errors_ || output.ok()\n              ? ::testing::AssertionSuccess()\n              : ::testing::AssertionFailure() << output.status().message();\n@@ -459,7 +467,8 @@ ::testing::AssertionResult HloRunnerAgnosticTestBase::RunAndCompareTwoModules(\n \n ::testing::AssertionResult HloRunnerAgnosticTestBase::Run(\n     const absl::string_view hlo_string, const bool run_hlo_passes,\n-    const tsl::protobuf::Message* backend_config, const bool use_random_data) {\n+    const tsl::protobuf::Message* backend_config, const bool use_random_data,\n+    BufferAssignmentProto* buffer_assignment_proto) {\n   absl::StatusOr<std::unique_ptr<VerifiedHloModule>> module =\n       ParseAndReturnVerifiedModule(hlo_string);\n   if (!module.ok()) {\n@@ -490,8 +499,12 @@ ::testing::AssertionResult HloRunnerAgnosticTestBase::Run(\n   }\n \n   const absl::StatusOr<Literal> output =\n-      test_runner_->Execute(*std::move(module), fake_argument_ptrs,\n-                            /*run_hlo_passes=*/run_hlo_passes);\n+      buffer_assignment_proto == nullptr\n+          ? test_runner_->Execute(*std::move(module), fake_argument_ptrs,\n+                                  /*run_hlo_passes=*/run_hlo_passes)\n+          : test_runner_->ExecuteWithBufferAssignment(\n+                *std::move(module), buffer_assignment_proto, fake_argument_ptrs,\n+                /*run_hlo_passes=*/run_hlo_passes);\n   return swallow_execution_errors_ || output.ok()\n              ? ::testing::AssertionSuccess()\n              : ::testing::AssertionFailure() << output.status().message();"
        },
        {
            "sha": "fc1fc3ccc75c0e61d8d5d5135c774e206a1a0ff8",
            "filename": "third_party/xla/xla/tests/hlo_runner_agnostic_test_base.h",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9/third_party%2Fxla%2Fxla%2Ftests%2Fhlo_runner_agnostic_test_base.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9/third_party%2Fxla%2Fxla%2Ftests%2Fhlo_runner_agnostic_test_base.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fhlo_runner_agnostic_test_base.h?ref=be4b3a802b8baefd8071b83a7fa34c2bbcc80ef9",
            "patch": "@@ -43,6 +43,7 @@ limitations under the License.\n #include \"xla/hlo/testlib/verified_hlo_module.h\"\n #include \"xla/literal.h\"\n #include \"xla/service/computation_placer.h\"\n+#include \"xla/service/hlo.pb.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/service/hlo_runner_interface.h\"\n #include \"xla/shape.h\"\n@@ -194,15 +195,17 @@ class HloRunnerAgnosticTestBase : public HloHardwareIndependentTestBase {\n   // successful.\n   ::testing::AssertionResult Run(\n       std::unique_ptr<HloModule> module, bool run_hlo_passes,\n-      const std::function<void(HloModule*)>& test_preprocessor = nullptr);\n+      const std::function<void(HloModule*)>& test_preprocessor = nullptr,\n+      BufferAssignmentProto* buffer_assignment_proto = nullptr);\n \n   // Convenient wrapper for executing and comparing an hlo module with fake\n   // input. Module can be passed in directly, or parsed from an hlo_string,\n   // or loaded from a file.\n   ::testing::AssertionResult Run(\n       absl::string_view hlo_string, bool run_hlo_passes = true,\n       const tsl::protobuf::Message* backend_config = nullptr,\n-      bool use_random_data = true);\n+      bool use_random_data = true,\n+      BufferAssignmentProto* buffer_assignment_proto = nullptr);\n \n   // Same as below, except that it requires all the options to be passed.\n   ::testing::AssertionResult RunAndCompareTwoModulesReplicated("
        }
    ],
    "stats": {
        "total": 32,
        "additions": 25,
        "deletions": 7
    }
}