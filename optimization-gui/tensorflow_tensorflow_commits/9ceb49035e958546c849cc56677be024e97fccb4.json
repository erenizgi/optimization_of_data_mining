{
    "author": "metaflow",
    "message": "[XLA:GPU] improve logging in gemm fusion autotuner\n\nHaving the config and timing in fixed units and on one line makes it easier to analyze autotuner log.\nAlso time how long it took to compile every config / all.\n\nPiperOrigin-RevId: 816131098",
    "sha": "9ceb49035e958546c849cc56677be024e97fccb4",
    "files": [
        {
            "sha": "e85c4f3b863e16fcafb24125c4b5a370b3dce005",
            "filename": "third_party/xla/xla/service/gpu/autotuning/gemm_fusion_autotuner.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 15,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9ceb49035e958546c849cc56677be024e97fccb4/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9ceb49035e958546c849cc56677be024e97fccb4/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fautotuning%2Fgemm_fusion_autotuner.cc?ref=9ceb49035e958546c849cc56677be024e97fccb4",
            "patch": "@@ -120,7 +120,7 @@ limitations under the License.\n // VLOG(2): Autotuning progress\n // VLOG(3): Autotuning progress - more frequent\n // VLOG(4): Print all fusions\n-// VLOG(5): Profiling information for every tiling\n+// VLOG(5): Profiling information for every configuration\n // VLOG(10): Print fusion computations and each configuration\n \n namespace xla {\n@@ -1023,6 +1023,7 @@ absl::StatusOr<absl::flat_hash_map<\n     std::vector<GemmFusionAutotunerImpl::ExecutableCandidate>>>\n GemmFusionAutotunerImpl::CompileAll(AutotunerCompileUtil& compile_util,\n                                     const BackendConfigs& task) {\n+  XLA_SCOPED_LOGGING_TIMER_LEVEL(\"CompileAll\", 5);\n   tsl::profiler::TraceMe traceme(\"CompileAll\");\n   tsl::profiler::ScopedAnnotation annotation(\"XlaAutotunerCompilation\");\n \n@@ -1055,6 +1056,8 @@ GemmFusionAutotunerImpl::CompileAll(AutotunerCompileUtil& compile_util,\n                      const BackendConfig& config,\n                      bool allow_filtering_kernels_spilling_registers)\n       -> absl::StatusOr<std::unique_ptr<Executable>> {\n+    XLA_SCOPED_LOGGING_TIMER_LEVEL(\n+        absl::StrCat(\"compile config \", ConfigToString(config)), 5);\n     tsl::profiler::TraceMe traceme(\"Compile\");\n     if (std::holds_alternative<TritonGemmConfig>(config)) {\n       auto executable_or = compile_util.Compile([&](const DebugOptions& opts) {\n@@ -1137,15 +1140,15 @@ GemmFusionAutotunerImpl::CompileAll(AutotunerCompileUtil& compile_util,\n       VLOG(10) << \"Compiling fusion: \" << fusion->name();\n       VLOG(10) << \"Dumping fusion computation: \"\n                << fusion->called_computation()->ToString();\n+      VLOG(5) << \"WARNING: you are running in multithreaded-mode, the last \"\n+                 \"configuration printed out might not be the one causing \"\n+                 \"issues! Use --xla_gpu_force_compilation_parallelism=1 to run \"\n+                 \"sequentially.\";\n       for (const BackendConfig& config : gemm_config_set) {\n         thread_pool_->Schedule([&, fusion] {\n-          VLOG(10) << \"Trying configuration forceable through: \"\n-                      \"--xla_gpu_override_gemm_autotuner='\"\n-                   << Serialize(config) << \"'\";\n-          VLOG(10) << \"WARNING: you are running in multithreaded-mode, the \"\n-                      \"last configuration printed out might not be the one \"\n-                      \"causing issues! Use \"\n-                      \"--xla_gpu_force_compilation_parallelism=1 to fix.\";\n+          VLOG(5) << \"Trying configuration forceable through: \"\n+                     \"--xla_gpu_override_gemm_autotuner='\"\n+                  << Serialize(config) << \"'\";\n           absl::StatusOr<std::unique_ptr<Executable>> executable =\n               compile(fusion, config, gemm_config_set.size() > 1);\n           TF_CHECK_OK(executable.status())\n@@ -1180,9 +1183,9 @@ GemmFusionAutotunerImpl::CompileAll(AutotunerCompileUtil& compile_util,\n       VLOG(10) << \"Dumping fusion computation: \"\n                << fusion->called_computation()->ToString();\n       for (const BackendConfig& config : gemm_config_set) {\n-        VLOG(10) << \"Trying configuration forceable through: \"\n-                    \"--xla_gpu_override_gemm_autotuner='\"\n-                 << Serialize(config) << \"'\";\n+        VLOG(5) << \"Trying configuration forceable through: \"\n+                   \"--xla_gpu_override_gemm_autotuner='\"\n+                << Serialize(config) << \"'\";\n         TF_ASSIGN_OR_RETURN(\n             std::unique_ptr<Executable> executable,\n             compile(fusion, config, gemm_config_set.size() > 1));\n@@ -1254,7 +1257,6 @@ absl::StatusOr<AutotuneResult> GemmFusionAutotunerImpl::MeasurePerformance(\n     }\n   }\n \n-  VLOG(5) << \"Trying : \" << ConfigToString(candidate.config);\n   AutotuneResult res = FromConfig(candidate.config);\n \n   const HloComputation* fusion_computation = fusion.called_computation();\n@@ -1280,7 +1282,9 @@ absl::StatusOr<AutotuneResult> GemmFusionAutotunerImpl::MeasurePerformance(\n                                      rz_buffers.input_buffers(),\n                                      rz_buffers.input_shapes()));\n \n-  VLOG(5) << \"Running the kernel took: \" << profiling_output.duration;\n+  VLOG(5) << \"Config \" << ConfigToString(candidate.config) << \" took \"\n+          << profiling_output.duration / absl::Nanoseconds(1) << \" ns\";\n+\n   LOG_IF(WARNING, profiling_output.duration >= absl::Seconds(1))\n       << \"Slow kernel for \" << fusion.called_computation()->ToString()\n       << \" took: \" << profiling_output.duration << \". \"\n@@ -1407,8 +1411,12 @@ absl::Status GemmFusionAutotunerImpl::Autotune(\n     TF_ASSIGN_OR_RETURN(AutotuneResult best,\n                         PickBestResult(results, fusion->ToString(),\n                                        root->GetModule()->config()));\n-    VLOG(2) << \"Best time: \"\n-            << tsl::proto_utils::FromDurationProto(best.run_time());\n+    if (VLOG_IS_ON(2)) {\n+      absl::Duration best_time =\n+          tsl::proto_utils::FromDurationProto(best.run_time());\n+      VLOG(2) << \"Best time: \" << best_time << \" (\"\n+              << (best_time / absl::Nanoseconds(1)) << \" ns)\";\n+    }\n \n     std::unique_ptr<HloModule> module;\n     if (debug_options_.xla_gpu_dump_autotuned_gemm_fusions() ||"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 23,
        "deletions": 15
    }
}