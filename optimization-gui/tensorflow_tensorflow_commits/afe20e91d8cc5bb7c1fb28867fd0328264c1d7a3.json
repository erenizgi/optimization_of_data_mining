{
    "author": "basioli-k",
    "message": "[XLA:CPU] TargetMachine contains all target information\n\n1. Makes sure features detected in PjRT are used by the CPU compiler\n2. Ensures target machine is initialized with requested features\n\nThis is also a good step towards cross compilation.\n\nPiperOrigin-RevId: 833727906",
    "sha": "afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
    "files": [
        {
            "sha": "d5444e625faa78232d26f546c9eb2565d0c529a4",
            "filename": "third_party/xla/xla/backends/cpu/codegen/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2FBUILD?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -107,6 +107,7 @@ cc_library(\n         \"//xla/service:hlo_module_config\",\n         \"//xla/service/cpu:backend_config_proto_cc\",\n         \"//xla/service/cpu:cpu_options\",\n+        \"//xla/service/cpu:executable_proto_cc\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/platform:statusor\",\n         \"@com_google_absl//absl/algorithm:container\",\n@@ -145,6 +146,8 @@ xla_cc_test(\n         \":kernel_api_ir_builder\",\n         \"//xla:util\",\n         \"//xla/service/cpu:backend_config_proto_cc\",\n+        \"//xla/service/cpu:cpu_compiler_pure\",\n+        \"//xla/service/cpu:test_header_helper\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:statusor\","
        },
        {
            "sha": "8824e40a64f6220c8af1b38e3ba6b6f2880ddb59",
            "filename": "third_party/xla/xla/backends/cpu/codegen/ir_compiler.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 46,
            "changes": 63,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -192,9 +192,9 @@ std::unique_ptr<IrCompiler> IrCompiler::Create(\n     llvm::TargetOptions target_options, Options options,\n     CompilationHooks hooks) {\n   TargetMachineBuilder target_machine_builder =\n-      IrCompiler::InferTargetMachineBuilder(std::move(target_options),\n-                                            options.opt_level,\n-                                            options.max_cpu_feature);\n+      IrCompiler::InferTargetMachineBuilder(\n+          std::move(target_options), options.opt_level,\n+          options.target_machine_options_proto);\n \n   return std::make_unique<IrCompiler>(target_machine_builder,\n                                       std::move(options), std::move(hooks));\n@@ -218,41 +218,36 @@ absl::once_flag initialize_llvm_flag;\n absl::StatusOr<std::unique_ptr<llvm::TargetMachine>>\n IrCompiler::InferTargetMachine(\n     const llvm::TargetOptions& target_options, llvm::CodeGenOptLevel opt_level,\n-    std::optional<tsl::port::CPUFeature> max_cpu_feature) {\n-  // Detect machine attributes for the target CPU.\n-  auto result = DetectMachineAttributes(max_cpu_feature);\n-  llvm::SmallVector<std::string> attrs(result.features.begin(),\n-                                       result.features.end());\n-\n-  // If `max_cpu_feature` is newer than the host CPU, we should keep the host\n-  // CPU name, e.g., we don't want to set the target CPU to Skylake when we are\n-  // on a Broadwell host.\n-  absl::string_view cpu = result.num_filtered_features\n-                              ? CpuTargetFromMaxFeature(*max_cpu_feature)\n-                              : absl::string_view(llvm::sys::getHostCPUName());\n+    const TargetMachineOptionsProto& target_machine_options_proto) {\n+  llvm::SmallVector<std::string> attrs =\n+      absl::StrSplit(target_machine_options_proto.features(), ',');\n \n   absl::call_once(initialize_llvm_flag, InitializeLLVMTarget);\n   std::unique_ptr<llvm::TargetMachine> target_machine(\n       llvm::EngineBuilder()\n           .setTargetOptions(target_options)\n           .setOptLevel(opt_level)\n           .selectTarget(\n-              /*TargetTriple=*/llvm::Triple(), /*MArch=*/\"\",\n-              /*MCPU=*/cpu,\n+              /*TargetTriple=*/llvm::Triple(\n+                  target_machine_options_proto.triple()),\n+              /*MArch=*/\"\",\n+              /*MCPU=*/target_machine_options_proto.cpu(),\n               /*MAttrs=*/attrs));\n \n   if (target_machine == nullptr) {\n-    return Internal(\"Failed to create target machine for CPU %s\", cpu);\n+    return Internal(\"Failed to create target machine for CPU %s\",\n+                    target_machine_options_proto.cpu());\n   }\n \n   return std::move(target_machine);\n }\n \n IrCompiler::TargetMachineBuilder IrCompiler::InferTargetMachineBuilder(\n     const llvm::TargetOptions& target_options, llvm::CodeGenOptLevel opt_level,\n-    std::optional<tsl::port::CPUFeature> max_cpu_feature) {\n-  return [target_options, opt_level, max_cpu_feature] {\n-    return InferTargetMachine(target_options, opt_level, max_cpu_feature);\n+    const TargetMachineOptionsProto& target_machine_options_proto) {\n+  return [target_options, opt_level, target_machine_options_proto] {\n+    return InferTargetMachine(target_options, opt_level,\n+                              target_machine_options_proto);\n   };\n }\n \n@@ -474,31 +469,7 @@ llvm::CodeGenOptLevel IrCompiler::GetCodeGenOptLevel(\n \n absl::StatusOr<std::unique_ptr<llvm::TargetMachine>>\n IrCompiler::build_target_machine() const {\n-  TF_ASSIGN_OR_RETURN(auto target_machine, target_machine_builder_());\n-\n-  absl::string_view current_features(target_machine->getTargetFeatureString());\n-\n-  std::vector<std::string> additional_features;\n-  for (absl::string_view feature : absl::StrSplit(current_features, ',')) {\n-    // Scatter & gather can result in very poor performance.\n-    if (absl::StartsWith(feature, \"+avx512\")) {\n-      additional_features.push_back(\"+prefer-no-scatter\");\n-      additional_features.push_back(\"+prefer-no-gather\");\n-    }\n-  }\n-\n-  if (additional_features.empty()) {\n-    return target_machine;\n-  }\n-  std::string additional_features_str = absl::StrJoin(additional_features, \",\");\n-  if (current_features.empty()) {\n-    target_machine->setTargetFeatureString(additional_features_str);\n-  } else {\n-    target_machine->setTargetFeatureString(\n-        absl::StrCat(current_features, \",\", additional_features_str));\n-  }\n-\n-  return target_machine;\n+  return target_machine_builder_();\n }\n \n }  // namespace xla::cpu"
        },
        {
            "sha": "23b3e2b3f082c7e991b52eff23e77224f92f113b",
            "filename": "third_party/xla/xla/backends/cpu/codegen/ir_compiler.h",
            "status": "modified",
            "additions": 8,
            "deletions": 13,
            "changes": 21,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler.h?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -36,6 +36,7 @@ limitations under the License.\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/Target/TargetOptions.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n+#include \"xla/service/cpu/executable.pb.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"tsl/platform/cpu_info.h\"\n \n@@ -64,10 +65,7 @@ class IrCompiler : public llvm::orc::IRCompileLayer::IRCompiler {\n     llvm::CodeGenOptLevel opt_level = llvm::CodeGenOptLevel::None;\n     bool optimize_for_size = false;\n \n-    // Maximum CPU instruction set for wich the compiler should generate code.\n-    // If instruction set is empty, compiler will generate code for all ISA\n-    // extensions detected on the current machine.\n-    std::optional<tsl::port::CPUFeature> max_cpu_feature;\n+    TargetMachineOptionsProto target_machine_options_proto;\n \n     llvm::FastMathFlags fast_math_flags;\n \n@@ -96,22 +94,19 @@ class IrCompiler : public llvm::orc::IRCompileLayer::IRCompiler {\n   IrCompiler(TargetMachineBuilder target_machine_builder, Options options,\n              CompilationHooks hooks);\n \n-  // Infers the `llvm::TargetMachine` for the current host. If `max_cpu_feature`\n-  // is provided, it will be used to constrain the set of features that LLVM\n-  // codegen (instruction selection) is allowed to use, e.g. it can be used to\n-  // explicitly disable certain AVX512 extensions, in case the compiled\n-  // executable will be serialized and later loaded on a different machine.\n+  // Infers the `llvm::TargetMachine` for the targeted host.\n   static absl::StatusOr<std::unique_ptr<llvm::TargetMachine>>\n-  InferTargetMachine(const llvm::TargetOptions& target_options,\n-                     llvm::CodeGenOptLevel opt_level,\n-                     std::optional<tsl::port::CPUFeature> max_cpu_feature);\n+  InferTargetMachine(\n+      const llvm::TargetOptions& target_options,\n+      llvm::CodeGenOptLevel opt_level,\n+      const TargetMachineOptionsProto& target_machine_options_proto);\n \n   // Returns a target machine builder that uses `InferTargetMachine` defined\n   // above to infer the target machine for the given options.\n   static TargetMachineBuilder InferTargetMachineBuilder(\n       const llvm::TargetOptions& target_options,\n       llvm::CodeGenOptLevel opt_level,\n-      std::optional<tsl::port::CPUFeature> max_cpu_feature);\n+      const TargetMachineOptionsProto& target_machine_options_proto);\n \n   // Compiles a `module` to an ObjectFile.\n   llvm::Expected<std::unique_ptr<llvm::MemoryBuffer>> operator()("
        },
        {
            "sha": "1f9f7d6d048bce4b49b17a60eb6446f9c536f9f1",
            "filename": "third_party/xla/xla/backends/cpu/codegen/ir_compiler_test.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 1,
            "changes": 39,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Fir_compiler_test.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -40,6 +40,8 @@ limitations under the License.\n #include \"llvm/TargetParser/Triple.h\"\n #include \"xla/backends/cpu/codegen/kernel_api_ir_builder.h\"\n #include \"xla/service/cpu/backend_config.pb.h\"\n+#include \"xla/service/cpu/cpu_compiler.h\"\n+#include \"xla/service/cpu/test_target_triple_helper.h\"\n #include \"xla/service/llvm_ir/llvm_util.h\"\n #include \"xla/tsl/lib/core/status_test_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -189,9 +191,18 @@ TEST(IrCompilerTest, TestAdditionalFeatures) {\n       return absl::InternalError(\"Failed to lookup target: \" + error);\n     }\n \n+    TargetMachineOptionsProto target_machine_options_proto;\n+    target_machine_options_proto.set_cpu(cpu_name);\n+    target_machine_options_proto.set_triple(triple);\n+    target_machine_options_proto.set_features(features);\n+\n+    cpu::AddAdditionalFeaturesIfAVX512(target_machine_options_proto);\n+\n     llvm::TargetOptions target_options;\n     return absl::WrapUnique(target->createTargetMachine(\n-        target_triple, cpu_name, features, target_options,\n+        llvm::Triple(target_machine_options_proto.triple()),\n+        target_machine_options_proto.cpu(),\n+        target_machine_options_proto.features(), target_options,\n         /*RM=*/std::nullopt));\n   };\n \n@@ -219,6 +230,32 @@ TEST(IrCompilerTest, TestAdditionalFeatures) {\n   }\n }\n \n+TEST(IrCompilerTest, TargetMachineOptionsAreCorrectlySet) {\n+  auto context = std::make_unique<llvm::LLVMContext>();\n+  IrCompiler::CompilationHooks compilation_hooks;\n+\n+  TargetMachineOptionsProto target_machine_options_proto;\n+  target_machine_options_proto.set_cpu(kTargetCpuForHost);\n+  target_machine_options_proto.set_triple(kTargetTripleForHost);\n+  target_machine_options_proto.set_features(\"+foo-feature,-bar-feature\");\n+\n+  std::unique_ptr<IrCompiler> ir_compiler = IrCompiler::Create(\n+      llvm::TargetOptions(),\n+      IrCompiler::Options{/*opt_level=*/llvm::CodeGenOptLevel::Aggressive,\n+                          /*optimize_for_size=*/false,\n+                          target_machine_options_proto},\n+      compilation_hooks);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto target_machine,\n+                          ir_compiler->build_target_machine());\n+\n+  EXPECT_EQ(target_machine->getTargetCPU(), kTargetCpuForHost);\n+  EXPECT_EQ(target_machine->getTargetTriple().getTriple(),\n+            kTargetTripleForHost);\n+  EXPECT_EQ(target_machine->getTargetFeatureString(),\n+            \"+foo-feature,-bar-feature\");\n+}\n+\n }  // namespace\n \n }  // namespace xla::cpu"
        },
        {
            "sha": "70df23bbfbe28259b22f693cb340e8ace46d68e9",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tools/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2FBUILD?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -20,7 +20,9 @@ cc_library(\n     testonly = True,\n     srcs = [\"ir_compiler_opt_main.cc\"],\n     deps = [\n+        \"//xla:debug_options_flags\",\n         \"//xla/backends/cpu/codegen:ir_compiler\",\n+        \"//xla/service/cpu:cpu_compiler_pure\",\n         \"//xla/tsl/platform:env\",\n         \"//xla/tsl/platform:errors\",\n         \"//xla/tsl/platform:statusor\","
        },
        {
            "sha": "a4d7d119ac4690bc53f78f691d7cec5555050015",
            "filename": "third_party/xla/xla/backends/cpu/codegen/tools/ir_compiler_opt_main.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Fir_compiler_opt_main.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Fir_compiler_opt_main.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Ftools%2Fir_compiler_opt_main.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -40,6 +40,8 @@ limitations under the License.\n #include \"llvm/Target/TargetMachine.h\"\n #include \"llvm/Target/TargetOptions.h\"\n #include \"xla/backends/cpu/codegen/ir_compiler.h\"\n+#include \"xla/debug_options_flags.h\"\n+#include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/tsl/platform/env.h\"\n #include \"xla/tsl/platform/errors.h\"\n #include \"xla/tsl/platform/statusor.h\"\n@@ -133,7 +135,7 @@ absl::StatusOr<std::string> RunIrCompilerPasses(const IrCompilerOptConfig& opts,\n       std::unique_ptr<llvm::TargetMachine> target_machine,\n       ir_compiler->InferTargetMachine(\n           target_options, static_cast<llvm::CodeGenOptLevel>(opts.opt_level),\n-          std::nullopt));\n+          GetDefaultHostTargetMachineOptions(GetDebugOptionsFromFlags())));\n \n   llvm::Error error = ir_compiler->RunIrPasses(*module, target_machine.get());\n   if (error) {"
        },
        {
            "sha": "a0440b4ded04c3e1fc9ec4186388fc1edbb704d6",
            "filename": "third_party/xla/xla/backends/cpu/testlib/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2FBUILD?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -41,6 +41,7 @@ cc_library(\n         \"//xla/codegen/testlib:kernel_runner\",\n         \"//xla/runtime:work_group\",\n         \"//xla/service:hlo_module_config\",\n+        \"//xla/service/cpu:cpu_compiler\",\n         \"//xla/service/cpu:cpu_options\",\n         \"//xla/service/llvm_ir:llvm_util\",\n         \"//xla/tsl/platform:errors\","
        },
        {
            "sha": "1226108e6aafed31332c6652cd385179d8bddf80",
            "filename": "third_party/xla/xla/backends/cpu/testlib/kernel_runner.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Ftestlib%2Fkernel_runner.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -41,6 +41,7 @@ limitations under the License.\n #include \"xla/codegen/llvm_kernel_source.h\"\n #include \"xla/codegen/mlir_kernel_source.h\"\n #include \"xla/runtime/work_group.h\"\n+#include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/service/cpu/cpu_options.h\"\n #include \"xla/service/hlo_module_config.h\"\n #include \"xla/service/llvm_ir/llvm_util.h\"\n@@ -103,7 +104,8 @@ absl::StatusOr<JitCompiler> KernelRunner::CreateJitCompiler(\n   IrCompiler::Options ir_compiler_options{\n       /*optimization_level=*/IrCompiler::GetCodeGenOptLevel(config),\n       /*optimize_for_size=*/options::OptimizeForSizeRequested(config),\n-      /*max_cpu_isa=*/CpuFeatureFromString(debug_options.xla_cpu_max_isa()),\n+      /*target_machine_options_proto=*/\n+      GetDefaultHostTargetMachineOptions(debug_options),\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(config),\n       /*disable_expensive_passes=*/\n       debug_options.xla_llvm_disable_expensive_passes(),"
        },
        {
            "sha": "4a3fffc56bdb03964fccd3d711781bb67a4843b1",
            "filename": "third_party/xla/xla/pjrt/cpu/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2FBUILD?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -202,6 +202,7 @@ cc_library(\n         \"//xla/service/cpu:cpu_compiler\",\n         \"//xla/service/cpu:cpu_executable\",\n         \"//xla/service/cpu:cpu_executable_run_options\",\n+        \"//xla/service/cpu:executable_proto_cc\",\n         \"//xla/service/llvm_ir:llvm_command_line_options\",\n         \"//xla/stream_executor:device_memory\",\n         \"//xla/tsl/concurrency:async_value\",\n@@ -225,6 +226,7 @@ cc_library(\n         \"@com_google_absl//absl/synchronization\",\n         \"@com_google_absl//absl/types:span\",\n         \"@eigen_archive//:eigen3\",  # TODO(zhangqiaorjc): Remove if use TFRT threadpool.\n+        \"@llvm-project//llvm:TargetParser\",\n         \"@llvm-project//mlir:IR\",\n         \"@local_tsl//tsl/platform:casts\",\n         \"@local_tsl//tsl/platform:denormal\","
        },
        {
            "sha": "e87c68ae31dbd0b5ded814624ec9e88419d09bd8",
            "filename": "third_party/xla/xla/pjrt/cpu/cpu_client.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fcpu%2Fcpu_client.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -40,6 +40,7 @@ limitations under the License.\n #include \"absl/status/status.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n+#include \"absl/strings/str_join.h\"\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n@@ -103,6 +104,7 @@ limitations under the License.\n #include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/service/cpu/cpu_executable.h\"\n #include \"xla/service/cpu/cpu_executable_run_options.h\"\n+#include \"xla/service/cpu/executable.pb.h\"\n #include \"xla/service/dump.h\"\n #include \"xla/service/executable.h\"\n #include \"xla/service/hlo.pb.h\"\n@@ -250,7 +252,11 @@ PjRtCpuClient::PjRtCpuClient(\n       transpose_cache_(1024),\n       collectives_(std::move(collectives)),\n       topology_(platform_id(), platform_name(), platform_version(),\n-                GetCpuDevices(owned_devices_), cpu::DetectMachineAttributes()),\n+                GetCpuDevices(owned_devices_),\n+                cpu::DetectMachineAttributes(\n+                    cpu::CpuFeatureFromString(\n+                        GetDebugOptionsFromFlags().xla_cpu_max_isa()))\n+                    .features),\n       asynchronous_(asynchronous),\n       customize_hlo_module_config_(std::move(customize_hlo_module_config)),\n       eigen_intraop_pool_(new tsl::thread::ThreadPool(\n@@ -801,6 +807,18 @@ PjRtCpuClient::CompileInternal(\n     if (!compile_options.thread_pool) {\n       compile_options.thread_pool = pjrt_client_thread_pool();\n     }\n+\n+    cpu::TargetMachineOptionsProto target_machine_options =\n+        cpu::GetDefaultHostTargetMachineOptions(\n+            hlo_module->config().debug_options());\n+    // Overwrite the features with the machine attributes from the topology.\n+    target_machine_options.set_features(\n+        absl::StrJoin(topology_.cpu_topology().machine_attributes(), \",\"));\n+\n+    compile_options.cpu_target_config.emplace(target_machine_options);\n+\n+    cpu::AddAdditionalFeaturesIfAVX512(target_machine_options);\n+\n     TF_ASSIGN_OR_RETURN(cpu_executable,\n                         JitCompile(std::move(hlo_module), build_options,\n                                    execution_options, compile_options));"
        },
        {
            "sha": "3a279e08a2ba0de392386f279a3550c048e02580",
            "filename": "third_party/xla/xla/service/compiler.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcompiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcompiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcompiler.h?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -161,11 +161,12 @@ class Compiler {\n   // Description of a target CPU for compilation.\n   struct CpuTargetConfig {\n     explicit CpuTargetConfig(\n-        cpu::TargetMachineOptionsProto& target_machine_options_proto)\n+        const cpu::TargetMachineOptionsProto& target_machine_options_proto)\n         : cpu_target_machine_options_proto(target_machine_options_proto) {};\n \n     // If not set, we default to the options inferred from the host machine.\n-    cpu::TargetMachineOptionsProto cpu_target_machine_options_proto;\n+    std::optional<cpu::TargetMachineOptionsProto>\n+        cpu_target_machine_options_proto = std::nullopt;\n   };\n \n   struct CompileOptions {"
        },
        {
            "sha": "814ae3cf890282d2aac270f926a1d3aef44f7579",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -512,8 +512,10 @@ xla_test(\n     deps = [\n         \":cpu_aot_compilation_result\",\n         \":test_header_helper\",\n+        \"//xla:debug_options_flags\",\n         \"//xla:literal\",\n         \"//xla:literal_util\",\n+        \"//xla/backends/cpu/codegen:cpu_features\",\n         \"//xla/hlo/ir:hlo\",\n         \"//xla/service:compiler\",\n         \"//xla/service:executable\",\n@@ -526,6 +528,7 @@ xla_test(\n         \"//xla/tests:xla_internal_test_main\",\n         \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/platform:test\",\n+        \"@com_google_absl//absl/strings\",\n         \"@com_google_absl//absl/strings:string_view\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//llvm:TargetParser\","
        },
        {
            "sha": "e2807295074d795765e71f7b13a3ccd0ec67fedc",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_compiler_test.cc",
            "status": "modified",
            "additions": 83,
            "deletions": 6,
            "changes": 89,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_compiler_test.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -17,10 +17,14 @@ limitations under the License.\n #include <utility>\n #include <vector>\n \n+#include \"absl/strings/match.h\"\n+#include \"absl/strings/str_split.h\"\n #include \"absl/strings/string_view.h\"\n #include \"llvm/ADT/StringMap.h\"  // IWYU pragma: keep\n #include \"llvm/TargetParser/Host.h\"\n #include \"llvm/TargetParser/Triple.h\"\n+#include \"xla/backends/cpu/codegen/cpu_features.h\"\n+#include \"xla/debug_options_flags.h\"\n #include \"xla/hlo/ir/hlo_module.h\"\n #include \"xla/literal.h\"\n #include \"xla/literal_util.h\"\n@@ -172,15 +176,88 @@ ENTRY main {\n       llvm::Triple(kTargetTripleForHost).getArchName());\n \n   auto host_machine_features = llvm::sys::getHostCPUFeatures();\n-  std::vector<absl::string_view> enabled_features;\n-  for (const auto& feature : host_machine_features) {\n-    if (feature.getValue()) {\n-      enabled_features.push_back(feature.getKey());\n+\n+  for (const auto& [feature, supported] : host_machine_features) {\n+    if (supported && absl::StartsWith(feature, \"avx512\")) {\n+      host_machine_features[\"prefer-no-scatter\"] = true;\n+      host_machine_features[\"prefer-no-gather\"] = true;\n+    }\n+  }\n+\n+  for (const auto& feature : absl::StrSplit(\n+           cpu_aot_result->proto().target_machine_options().features(), ',')) {\n+    if (feature[0] == '+') {\n+      EXPECT_TRUE(host_machine_features[feature.substr(1)]);\n+    } else {\n+      EXPECT_EQ(feature[0], '-');\n+      // On some architectures, we disable features - like \"sve\" on AArch64\n+      // depending on the max isa. Once a cpp encapsulation of target options\n+      // lands we can remove this hack.\n+      auto xla_cpu_max_isa =\n+          CpuFeatureFromString(GetDebugOptionsFromFlags().xla_cpu_max_isa());\n+      EXPECT_FALSE(\n+          host_machine_features[feature.substr(1)] &&\n+          (xla_cpu_max_isa &&\n+           ShouldEnableCpuFeature(feature.substr(1), xla_cpu_max_isa.value())));\n     }\n   }\n+}\n+\n+TEST_F(CpuAotCompilerTest,\n+       ExportedExecutableTargetMachineOptionsMatchTheOptionsSetInTargetConfig) {\n+  absl::string_view module_string = R\"(\n+HloModule module\n+\n+ENTRY main {\n+  a = f32[] parameter(0)\n+  b = f32[] parameter(1)\n+  a_plus_b = f32[] add(a, b)\n+  ROOT result = f32[] add(a_plus_b, b)\n+})\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(se::Platform * platform,\n+                          se::PlatformManager::PlatformWithName(\"host\"));\n+  TF_ASSERT_OK_AND_ASSIGN(se::StreamExecutor * stream_exec,\n+                          platform->ExecutorForDevice(0));\n+\n+  Compiler* compiler = backend().compiler();\n+  ASSERT_NE(compiler, nullptr);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(std::unique_ptr<HloModule> hlo_module,\n+                          ParseAndReturnVerifiedModule(module_string));\n+\n+  xla::Compiler::CompileOptions compile_options;\n+  TargetMachineOptionsProto target_machine_options_proto;\n+  target_machine_options_proto.set_triple(kTargetTripleForHost);\n+  target_machine_options_proto.set_cpu(kTargetCpuForHost);\n+  target_machine_options_proto.set_features(\"+foo-feature,-bar-feature\");\n+  compile_options.cpu_target_config.emplace(target_machine_options_proto);\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      hlo_module, compiler->RunHloPasses(std::move(hlo_module), stream_exec,\n+                                         compile_options));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto executable, compiler->RunBackend(std::move(hlo_module), stream_exec,\n+                                            compile_options));\n+\n+  TF_ASSERT_OK_AND_ASSIGN(auto aot_result, compiler->Export(executable.get()));\n+\n+  CpuAotCompilationResult* cpu_aot_result =\n+      tsl::down_cast<CpuAotCompilationResult*>(aot_result.get());\n+  ASSERT_NE(cpu_aot_result, nullptr);\n+\n+  EXPECT_EQ(\n+      llvm::Triple(cpu_aot_result->proto().target_machine_options().triple())\n+          .getArchName(),\n+      llvm::Triple(kTargetTripleForHost).getArchName());\n+\n+  std::vector<absl::string_view> aot_result_features = absl::StrSplit(\n+      cpu_aot_result->proto().target_machine_options().features(), ',');\n \n-  EXPECT_EQ(cpu_aot_result->proto().target_machine_options().features(),\n-            absl::StrJoin(enabled_features, \",\"));\n+  EXPECT_EQ(aot_result_features.size(), 2);\n+  EXPECT_EQ(aot_result_features[0], \"+foo-feature\");\n+  EXPECT_EQ(aot_result_features[1], \"-bar-feature\");\n }\n \n }  // namespace"
        },
        {
            "sha": "fd31e719d2c4833dc64aa2346adbc9f807893c59",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -89,9 +89,9 @@ GetCompiledSymbolsFromProto(\n \n absl::StatusOr<std::unique_ptr<FunctionLibrary>> LoadFunctionLibrary(\n     const std::vector<FunctionLibrary::Symbol>& compiled_symbols,\n-    absl::Span<const ObjFileProto> obj_files, const HloModule* hlo_module) {\n+    absl::Span<const ObjFileProto> obj_files, const HloModule* hlo_module,\n+    const TargetMachineOptionsProto& target_machine_options_proto) {\n   const HloModuleConfig& config = hlo_module->config();\n-  const DebugOptions& debug_options = config.debug_options();\n \n   auto llvm_options = llvm_ir::ExtractXlaBackendExtraOptions(\n       config.debug_options().xla_backend_extra_options());\n@@ -102,7 +102,7 @@ absl::StatusOr<std::unique_ptr<FunctionLibrary>> LoadFunctionLibrary(\n       IrCompiler::InferTargetMachine(\n           std::move(CompilerTargetOptions(hlo_module->config())),\n           IrCompiler::GetCodeGenOptLevel(config),\n-          CpuFeatureFromString(debug_options.xla_cpu_max_isa())));\n+          target_machine_options_proto));\n \n   // Definition generator to link with XLA:CPU host runtime symbols.\n   ExecutionEngine::DefinitionGenerator definition_generator =\n@@ -177,8 +177,7 @@ CpuAotLoader::LoadAotCompilationResult(\n       IrCompiler::InferTargetMachine(\n           std::move(CompilerTargetOptions(hlo_module->config())),\n           IrCompiler::GetCodeGenOptLevel(hlo_module->config()),\n-          CpuFeatureFromString(\n-              hlo_module->config().debug_options().xla_cpu_max_isa())));\n+          aot_result_proto.target_machine_options()));\n \n   llvm::Triple triple(aot_result_proto.target_machine_options().triple());\n   llvm::Triple expected_triple(target_machine->getTargetTriple());\n@@ -188,8 +187,11 @@ CpuAotLoader::LoadAotCompilationResult(\n   }\n \n   llvm::StringMap<bool> host_machine_features = llvm::sys::getHostCPUFeatures();\n-  auto compile_machine_features =\n-      absl::StrSplit(aot_result_proto.target_machine_options().features(), ',');\n+  std::vector<absl::string_view> compile_machine_features =\n+      aot_result_proto.target_machine_options().features().empty()\n+          ? std::vector<absl::string_view>()\n+          : absl::StrSplit(aot_result_proto.target_machine_options().features(),\n+                           ',');\n   // Convert the supported features to a vector of strings.\n   std::vector<std::string> host_machine_features_vector;\n   for (const auto& [feature, supported] : host_machine_features) {\n@@ -199,8 +201,9 @@ CpuAotLoader::LoadAotCompilationResult(\n   }\n \n   for (const absl::string_view feature : compile_machine_features) {\n-    if (!host_machine_features.contains(feature) ||\n-        !host_machine_features[feature]) {\n+    if (feature[0] == '+' &&\n+        (!host_machine_features.contains(feature.substr(1)) ||\n+         !host_machine_features[feature.substr(1)])) {\n       // TODO: b/457415427 - Turn this warning into an error once a mechanism\n       // for passing target machine features to the CPU compiler is implemented.\n       LOG(ERROR)\n@@ -230,7 +233,8 @@ CpuAotLoader::LoadAotCompilationResult(\n \n   TF_ASSIGN_OR_RETURN(\n       auto function_library,\n-      LoadFunctionLibrary(compiled_symbols, obj_files, hlo_module.get()));\n+      LoadFunctionLibrary(compiled_symbols, obj_files, hlo_module.get(),\n+                          aot_result_proto.target_machine_options()));\n \n   return CpuAotCompilationResult::FromProto(aot_result_proto,\n                                             std::move(function_library));"
        },
        {
            "sha": "b6279d5cadc6035d22fead0d4944cf257a7eb104",
            "filename": "third_party/xla/xla/service/cpu/cpu_aot_loader.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_aot_loader.h?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -36,7 +36,8 @@ llvm::TargetOptions CompilerTargetOptions(const HloModuleConfig& module_config);\n \n absl::StatusOr<std::unique_ptr<FunctionLibrary>> LoadFunctionLibrary(\n     const std::vector<FunctionLibrary::Symbol>& compiled_symbols,\n-    absl::Span<const ObjFileProto> obj_files, const HloModule* hlo_module);\n+    absl::Span<const ObjFileProto> obj_files, const HloModule* hlo_module,\n+    const TargetMachineOptionsProto& target_machine_options_proto);\n \n absl::StatusOr<std::vector<FunctionLibrary::Symbol>>\n GetCompiledSymbolsFromProto("
        },
        {
            "sha": "7beec6d74ee815f0025a59ddcd77fc26427a04aa",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 82,
            "deletions": 25,
            "changes": 107,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -370,6 +370,47 @@ absl::StatusOr<std::vector<std::unique_ptr<Executable>>> CpuCompiler::Compile(\n   llvm::InitializeNativeTargetAsmPrinter();\n }\n \n+void AddAdditionalFeaturesIfAVX512(\n+    TargetMachineOptionsProto& target_machine_options_proto) {\n+  if (absl::StrContains(target_machine_options_proto.features(), \"+avx512\")) {\n+    std::string new_features = target_machine_options_proto.features();\n+\n+    constexpr absl::string_view kPreferNoScatter = \"+prefer-no-scatter\";\n+    constexpr absl::string_view kPreferNoGather = \"+prefer-no-gather\";\n+    if (new_features.find(kPreferNoScatter) == std::string::npos) {\n+      new_features = absl::StrJoin({new_features, kPreferNoScatter}, \",\");\n+    }\n+    if (new_features.find(kPreferNoGather) == std::string::npos) {\n+      new_features = absl::StrJoin({new_features, kPreferNoGather}, \",\");\n+    }\n+    target_machine_options_proto.set_features(new_features);\n+  }\n+}\n+\n+TargetMachineOptionsProto GetDefaultHostTargetMachineOptions(\n+    const DebugOptions& debug_options) {\n+  TargetMachineOptionsProto target_machine_options_proto;\n+  // Fallback to the default target machine options.\n+  target_machine_options_proto.set_triple(llvm::sys::getDefaultTargetTriple());\n+\n+  auto xla_cpu_max_isa = CpuFeatureFromString(debug_options.xla_cpu_max_isa());\n+  auto detected_machine_attributes = DetectMachineAttributes(xla_cpu_max_isa);\n+  target_machine_options_proto.set_features(\n+      absl::StrJoin(detected_machine_attributes.features, \",\"));\n+\n+  // If `max_cpu_feature` is newer than the host CPU, we should keep the host\n+  // CPU name, e.g., we don't want to set the target CPU to Skylake when we\n+  // are on a Broadwell host.\n+  auto cpu_host_name = detected_machine_attributes.num_filtered_features\n+                           ? CpuTargetFromMaxFeature(*xla_cpu_max_isa)\n+                           : absl::string_view(llvm::sys::getHostCPUName());\n+  target_machine_options_proto.set_cpu(cpu_host_name);\n+\n+  AddAdditionalFeaturesIfAVX512(target_machine_options_proto);\n+\n+  return target_machine_options_proto;\n+}\n+\n namespace {\n \n // This visitor records which HLO instructions should have profiling information\n@@ -1225,12 +1266,20 @@ absl::StatusOr<std::unique_ptr<HloModule>> CpuCompiler::RunHloPasses(\n         module->config().debug_options().xla_backend_extra_options());\n     llvm_ir::LLVMCommandLineOptionsLock llvm_lock(llvm_options);\n \n+    // Use default target machine options if not specified in the target config.\n+    auto target_machine_options_proto =\n+        GetDefaultHostTargetMachineOptions(module->config().debug_options());\n+    if (options.cpu_target_config &&\n+        options.cpu_target_config->cpu_target_machine_options_proto) {\n+      target_machine_options_proto =\n+          options.cpu_target_config->cpu_target_machine_options_proto.value();\n+    }\n+\n     TF_ASSIGN_OR_RETURN(\n         jit_target_machine,\n-        IrCompiler::InferTargetMachine(\n-            CompilerTargetOptions(config),\n-            IrCompiler::GetCodeGenOptLevel(config),\n-            CpuFeatureFromString(config.debug_options().xla_cpu_max_isa())));\n+        IrCompiler::InferTargetMachine(CompilerTargetOptions(config),\n+                                       IrCompiler::GetCodeGenOptLevel(config),\n+                                       target_machine_options_proto));\n   }\n \n   TF_RETURN_IF_ERROR(RunHloPasses(module.get(), /*is_aot_compile=*/false,\n@@ -2006,24 +2055,16 @@ CpuCompiler::CompileCpuExecutable(\n   TF_ASSIGN_OR_RETURN(std::vector<ConstantAllocation> constants,\n                       CreateConstantAllocations(*assignment));\n \n+  // We don't use the target machine options from the\n+  // CompileOptions::target_config field as we consider TargetMachine to be the\n+  // source of truth at this point. This is because the AOT path might set its\n+  // own target machine options.\n   TargetMachineOptionsProto target_machine_options_proto;\n   target_machine_options_proto.set_triple(\n-      target_machine->getTargetTriple().getTriple());\n+      target_machine->getTargetTriple().normalize());\n   target_machine_options_proto.set_cpu(target_machine->getTargetCPU());\n-\n-  // TODO(basioli): Target machine features are returning an empty string at the\n-  // moment so for now we are using the host CPU features. This should be\n-  // updated to use the target machine features of the target we are actually\n-  // compiling for as we might want to support cross-compilation.\n-  auto host_machine_features = llvm::sys::getHostCPUFeatures();\n-  std::vector<absl::string_view> enabled_features;\n-  for (const auto& feature : host_machine_features) {\n-    if (feature.getValue()) {\n-      enabled_features.push_back(feature.getKey());\n-    }\n-  }\n   target_machine_options_proto.set_features(\n-      absl::StrJoin(enabled_features, \",\"));\n+      target_machine->getTargetFeatureString());\n \n   TF_ASSIGN_OR_RETURN(\n       auto cpu_executable,\n@@ -2072,12 +2113,20 @@ absl::StatusOr<std::unique_ptr<Executable>> CpuCompiler::RunBackend(\n       module->config().debug_options().xla_backend_extra_options());\n   llvm_ir::LLVMCommandLineOptionsLock llvm_lock(llvm_options);\n \n+  auto target_machine_options_proto =\n+      GetDefaultHostTargetMachineOptions(module->config().debug_options());\n+  if (options.cpu_target_config &&\n+      options.cpu_target_config->cpu_target_machine_options_proto) {\n+    target_machine_options_proto =\n+        options.cpu_target_config->cpu_target_machine_options_proto.value();\n+  }\n+\n   // Options for compiling LLVM IR to machine code.\n   IrCompiler::Options ir_compiler_options{\n       /*optimization_level=*/IrCompiler::GetCodeGenOptLevel(module->config()),\n       /*optimize_for_size=*/options::OptimizeForSizeRequested(module->config()),\n-      /*max_cpu_isa=*/\n-      CpuFeatureFromString(module->config().debug_options().xla_cpu_max_isa()),\n+      /*target_machine_options_proto=*/\n+      target_machine_options_proto,\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(module->config()),\n       /*disable_expensive_passes=*/\n       module->config().debug_options().xla_llvm_disable_expensive_passes(),\n@@ -2215,12 +2264,18 @@ CpuCompiler::CompileAheadOfTimeThunks(\n       /*compile_copy_as_llvm_kernel=*/aot_options.compile_copy_as_llvm_kernel(),\n       /*is_aot_compilation=*/true};\n \n+  TargetMachineOptionsProto target_machine_options_proto;\n+  target_machine_options_proto.set_triple(\n+      target_machine->getTargetTriple().normalize());\n+  target_machine_options_proto.set_cpu(target_machine->getTargetCPU());\n+  target_machine_options_proto.set_features(\n+      target_machine->getTargetFeatureString());\n+\n   IrCompiler::Options ir_compiler_options = {\n       /*optimization_level=*/target_machine->getOptLevel(),\n       /*optimize_for_size=*/\n       options::OptimizeForSizeRequested(module->config()),\n-      /*max_cpu_isa=*/\n-      CpuFeatureFromString(module->config().debug_options().xla_cpu_max_isa()),\n+      /*target_machine_options_proto=*/target_machine_options_proto,\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(module->config()),\n       /*disable_expensive_passes=*/\n       module->config().debug_options().xla_llvm_disable_expensive_passes(),\n@@ -2310,9 +2365,11 @@ absl::StatusOr<std::unique_ptr<AotCompilationResult>> CpuCompiler::Export(\n   TF_ASSIGN_OR_RETURN(auto compiled_symbols,\n                       GetCompiledSymbolsFromProto(compiled_symbols_proto));\n \n-  TF_ASSIGN_OR_RETURN(auto function_library,\n-                      LoadFunctionLibrary(compiled_symbols, obj_files,\n-                                          &cpu_executable->module()));\n+  TF_ASSIGN_OR_RETURN(\n+      auto function_library,\n+      LoadFunctionLibrary(compiled_symbols, obj_files,\n+                          &cpu_executable->module(),\n+                          cpu_executable->target_machine_options()));\n \n   return CpuAotCompilationResult::Create(\n       &cpu_executable->module(), &cpu_executable->buffer_assignment(),"
        },
        {
            "sha": "b2a65272431d7b8c1bd7cef6fa443c241dfd118e",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.h?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -50,6 +50,12 @@ class DialectRegistry;\n namespace xla {\n namespace cpu {\n \n+void AddAdditionalFeaturesIfAVX512(\n+    TargetMachineOptionsProto& target_machine_options_proto);\n+\n+TargetMachineOptionsProto GetDefaultHostTargetMachineOptions(\n+    const DebugOptions& debug_options);\n+\n // CPU-targeting implementation of the XLA Compiler interface.\n //\n // The compiler translates XLA HLO code into LLVM IR and uses LLVM's JIT"
        },
        {
            "sha": "14f4a4da153c3cafe13e91d1a61abc42db651c65",
            "filename": "third_party/xla/xla/service/cpu/ir_emitter_test.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fir_emitter_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fir_emitter_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fir_emitter_test.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -232,7 +232,8 @@ CreateIrEmitterForConstantEmissionTests(HloModule& module,\n   IrCompiler::Options ir_compiler_options{\n       /*optimization_level=*/llvm::CodeGenOptLevel::Default,\n       /*optimize_for_size=*/options::OptimizeForSizeRequested(config),\n-      /*max_cpu_isa=*/CpuFeatureFromString(debug_options.xla_cpu_max_isa()),\n+      /*target_machine_options_proto=*/\n+      GetDefaultHostTargetMachineOptions(module.config().debug_options()),\n       /*fast_math_flags=*/llvm_ir::GetCpuFastMathFlags(config),\n       /*disable_expensive_passes=*/\n       debug_options.xla_llvm_disable_expensive_passes(),"
        },
        {
            "sha": "a311e290c7d0558f04ca709ee09f7d6477d911ff",
            "filename": "third_party/xla/xla/tools/hlo_opt/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2FBUILD?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -187,6 +187,7 @@ cc_library(\n         \"//xla/service:sharding_propagation\",\n         \"//xla/service:transpose_folding\",\n         \"//xla/service/cpu:conv_canonicalization\",\n+        \"//xla/service/cpu:cpu_compiler\",\n         \"//xla/service/cpu:cpu_executable\",\n         \"//xla/service/cpu:cpu_instruction_fusion\",\n         \"//xla/service/cpu:cpu_layout_assignment\","
        },
        {
            "sha": "e4b9100adc5574bfb749cc16602afad65626580b",
            "filename": "third_party/xla/xla/tools/hlo_opt/cpu_opt.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2Fcpu_opt.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2Fcpu_opt.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftools%2Fhlo_opt%2Fcpu_opt.cc?ref=afe20e91d8cc5bb7c1fb28867fd0328264c1d7a3",
            "patch": "@@ -44,6 +44,7 @@ limitations under the License.\n #include \"xla/service/change_op_data_type.h\"\n #include \"xla/service/copy_insertion.h\"\n #include \"xla/service/cpu/conv_canonicalization.h\"\n+#include \"xla/service/cpu/cpu_compiler.h\"\n #include \"xla/service/cpu/cpu_executable.h\"\n #include \"xla/service/cpu/cpu_instruction_fusion.h\"\n #include \"xla/service/cpu/cpu_layout_assignment.h\"\n@@ -125,8 +126,8 @@ class CpuOptProvider : public CompiledOptProvider {\n         cpu::IrCompiler::InferTargetMachine(\n             CompilerTargetOptions(module_config),\n             CodeGenOptLevel(module_config),\n-            cpu::CpuFeatureFromString(\n-                module_config.debug_options().xla_cpu_max_isa()));\n+            cpu::GetDefaultHostTargetMachineOptions(\n+                module_config.debug_options()));\n     if (!jit_target_machine.ok()) {\n       LOG(ERROR) << \"Failed to infer target machine: \"\n                  << jit_target_machine.status();"
        }
    ],
    "stats": {
        "total": 405,
        "additions": 295,
        "deletions": 110
    }
}