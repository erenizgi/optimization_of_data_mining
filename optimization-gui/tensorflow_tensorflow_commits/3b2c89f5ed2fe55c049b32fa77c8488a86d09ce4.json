{
    "author": "qukhan",
    "message": "Always write a valid initial cache file when starting a cache build.\n\nBefore this change, if the XNNPack delegate is used but no operation is\ndelegated, then an invalid cache file is created.\n\nPiperOrigin-RevId: 845763378",
    "sha": "3b2c89f5ed2fe55c049b32fa77c8488a86d09ce4",
    "files": [
        {
            "sha": "4ceb2df985c989b0e760ff7acc543facced9bc0c",
            "filename": "tensorflow/lite/delegates/xnnpack/weight_cache.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3b2c89f5ed2fe55c049b32fa77c8488a86d09ce4/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3b2c89f5ed2fe55c049b32fa77c8488a86d09ce4/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Flite%2Fdelegates%2Fxnnpack%2Fweight_cache.cc?ref=3b2c89f5ed2fe55c049b32fa77c8488a86d09ce4",
            "patch": "@@ -120,12 +120,17 @@ bool WeightCacheBuilder::Start(const char* path, const FileDescriptor& fd) {\n   XNNPackCacheHeader header{XNNPackCacheHeader::kInvalidHeader};\n   header.buffer_list_offset = sizeof(header);\n \n-  XNNPACK_RETURN_CHECK(fd_.Truncate(0), \"could not truncate weight cache\");\n+  XNNPACK_RETURN_CHECK(fd_.Truncate(0), \"could not truncate weight cache.\");\n+  XNNPACK_RETURN_CHECK(fd_.SetPos(0) == 0, \"couldn't move to file start.\");\n   XNNPACK_RETURN_CHECK(fd_.Write(&header, sizeof(header)),\n                        \"could not write initial cache header in %s: %s.\",\n                        file_path_.c_str(), strerror(errno));\n \n   schema_.base_offset = Align(sizeof(header), kMinAlignment);\n+\n+  XNNPACK_RETURN_CHECK(StartBuildStep(), \"failed to start initial write step.\");\n+  XNNPACK_RETURN_CHECK(StopBuildStep(), \"failed to write initial step.\");\n+\n   return true;\n }\n "
        }
    ],
    "stats": {
        "total": 7,
        "additions": 6,
        "deletions": 1
    }
}