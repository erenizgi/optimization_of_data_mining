{
    "author": "dubstack",
    "message": "Add FatalLogSink infra which logs Debug Context on FATAL errors.\n\nPiperOrigin-RevId: 813912948",
    "sha": "e45df70989c31fa3782b774ce8dbf2af36e2b22f",
    "files": [
        {
            "sha": "a6dbce0c043f1878e7eace42c3058c50f3a4b8be",
            "filename": "third_party/xla/xla/error/BUILD",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2FBUILD?ref=e45df70989c31fa3782b774ce8dbf2af36e2b22f",
            "patch": "@@ -41,6 +41,17 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"fatal_error_sink\",\n+    hdrs = [\"fatal_error_sink.h\"],\n+    deps = [\n+        \":debug_me_context_util\",\n+        \"@com_google_absl//absl/base:log_severity\",\n+        \"@com_google_absl//absl/log:log_entry\",\n+        \"@com_google_absl//absl/log:log_sink\",\n+    ],\n+)\n+\n xla_cc_test(\n     name = \"debug_me_context_util_test\",\n     srcs = [\"debug_me_context_util_test.cc\"],\n@@ -51,3 +62,17 @@ xla_cc_test(\n         \"@com_google_googletest//:gtest_main\",\n     ],\n )\n+\n+xla_cc_test(\n+    name = \"fatal_error_sink_test\",\n+    srcs = [\"fatal_error_sink_test.cc\"],\n+    deps = [\n+        \":debug_me_context_util\",\n+        \":fatal_error_sink\",\n+        \"//xla/tsl/platform:debug_me_context\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/log:log_sink_registry\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)"
        },
        {
            "sha": "1d432b0bfa49b6fa63c2dfe94f0a0793cc0e7efc",
            "filename": "third_party/xla/xla/error/debug_me_context_util.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Fdebug_me_context_util.cc?ref=e45df70989c31fa3782b774ce8dbf2af36e2b22f",
            "patch": "@@ -46,22 +46,29 @@ std::string DebugMeContextToErrorMessageString() {\n     const std::vector<std::string> compiler_values =\n         tsl::DebugMeContext<DebugMeContextKey>::GetValues(\n             DebugMeContextKey::kCompiler);\n-    absl::StrAppend(&error_message,\n-                    \"Compiler: \", absl::StrJoin(compiler_values, \"/\"), \"\\n\");\n+    if (!compiler_values.empty()) {\n+      absl::StrAppend(&error_message,\n+                      \"Compiler: \", absl::StrJoin(compiler_values, \"/\"), \"\\n\");\n+    }\n   }\n   {\n     const std::vector<std::string> hlo_pass_values =\n         tsl::DebugMeContext<DebugMeContextKey>::GetValues(\n             DebugMeContextKey::kHloPass);\n-    absl::StrAppend(&error_message,\n-                    \"HLO Passes: \", absl::StrJoin(hlo_pass_values, \"/\"), \"\\n\");\n+    if (!hlo_pass_values.empty()) {\n+      absl::StrAppend(&error_message,\n+                      \"HLO Passes: \", absl::StrJoin(hlo_pass_values, \"/\"),\n+                      \"\\n\");\n+    }\n   }\n   {\n     const std::vector<std::string> hlo_instruction_values =\n         tsl::DebugMeContext<DebugMeContextKey>::GetValues(\n             DebugMeContextKey::kHloInstruction);\n-    absl::StrAppend(&error_message, \"HLO Instructions: \",\n-                    absl::StrJoin(hlo_instruction_values, \"/\"), \"\\n\");\n+    if (!hlo_instruction_values.empty()) {\n+      absl::StrAppend(&error_message, \"HLO Instructions: \",\n+                      absl::StrJoin(hlo_instruction_values, \"/\"), \"\\n\");\n+    }\n   }\n   return error_message;\n }"
        },
        {
            "sha": "7cd5d611790f31a4b329948f361f77b840489dfe",
            "filename": "third_party/xla/xla/error/fatal_error_sink.h",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink.h?ref=e45df70989c31fa3782b774ce8dbf2af36e2b22f",
            "patch": "@@ -0,0 +1,51 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_ERROR_FATAL_ERROR_SINK_H_\n+#define XLA_ERROR_FATAL_ERROR_SINK_H_\n+\n+#include <iostream>\n+\n+#include \"absl/base/log_severity.h\"\n+#include \"absl/log/log_entry.h\"\n+#include \"absl/log/log_sink.h\"\n+#include \"xla/error/debug_me_context_util.h\"\n+\n+namespace xla::error {\n+\n+// An absl::LogSink that selectively handles FATAL errors to add additional\n+// XLA-specific debugging context.\n+class FatalErrorSink : public absl::LogSink {\n+ public:\n+  void Send(const absl::LogEntry& entry) override {\n+    if (entry.log_severity() != absl::LogSeverity::kFatal) {\n+      return;\n+    }\n+\n+    // A LogSink receives two copies of each FATAL message: one without a\n+    // stacktrace, and then one with. We only want to inject the context once,\n+    // hence we only do it on the first message.\n+    if (entry.stacktrace().empty()) {\n+      auto debug_me_context = DebugMeContextToErrorMessageString();\n+      if (!debug_me_context.empty()) {\n+        std::cerr << debug_me_context << std::endl;\n+      }\n+    }\n+  }\n+};\n+\n+}  // namespace xla::error\n+\n+#endif  // XLA_ERROR_FATAL_ERROR_SINK_H_"
        },
        {
            "sha": "5cca806bf697e2f72d6b06068ee0068834305743",
            "filename": "third_party/xla/xla/error/fatal_error_sink_test.cc",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/e45df70989c31fa3782b774ce8dbf2af36e2b22f/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ferror%2Ffatal_error_sink_test.cc?ref=e45df70989c31fa3782b774ce8dbf2af36e2b22f",
            "patch": "@@ -0,0 +1,94 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/error/fatal_error_sink.h\"\n+\n+#include <string>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/log/check.h\"\n+#include \"absl/log/log.h\"\n+#include \"absl/log/log_sink_registry.h\"\n+#include \"xla/error/debug_me_context_util.h\"\n+#include \"xla/tsl/platform/debug_me_context.h\"\n+\n+namespace xla::error {\n+namespace {\n+\n+using ::testing::HasSubstr;\n+using ::testing::Not;\n+\n+// A matcher that counts the number of times a substring appears in a reference\n+// string.\n+MATCHER_P2(CountSubstr, substr, expected_count, \"\") {\n+  const std::string substr_as_string(substr);\n+  int count = 0;\n+  std::string::size_type pos = 0;\n+\n+  // Use the guaranteed std::string in the loop.\n+  while ((pos = arg.find(substr_as_string, pos)) != std::string::npos) {\n+    ++count;\n+    pos += substr_as_string.length();\n+  }\n+\n+  return count == expected_count;\n+}\n+\n+// Test fixture for FatalErrorSink tests.\n+class FatalErrorSinkTest : public ::testing::Test {\n+ protected:\n+  void SetUp() override { absl::AddLogSink(&sink_); }\n+  void TearDown() override { absl::RemoveLogSink(&sink_); }\n+\n+ private:\n+  FatalErrorSink sink_;\n+};\n+\n+TEST_F(FatalErrorSinkTest, ContextPresent_NonFatalIsIgnored) {\n+  tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+                                                 \"MyTestPass\");\n+  testing::internal::CaptureStderr();\n+\n+  LOG(ERROR) << \"This is a test error.\";\n+\n+  std::string stderr_output = testing::internal::GetCapturedStderr();\n+  EXPECT_THAT(stderr_output, Not(HasSubstr(\"DebugMeContext\")));\n+  EXPECT_THAT(stderr_output, Not(HasSubstr(\"MyTestPass\")));\n+  EXPECT_THAT(stderr_output, HasSubstr(\"This is a test error.\"));\n+}\n+\n+using FatalErrorSinkDeathTest = FatalErrorSinkTest;\n+\n+TEST_F(FatalErrorSinkDeathTest, NoContextPresent_NoLog) {\n+  EXPECT_DEATH(LOG(FATAL) << \"test\", Not(HasSubstr(\"DebugMeContext\")));\n+}\n+\n+TEST_F(FatalErrorSinkDeathTest, ContextPresent_LogExactlyOnce) {\n+  tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+                                                 \"MyTestPass\");\n+\n+  EXPECT_DEATH(LOG(FATAL) << \"test\", CountSubstr(\"MyTestPass\", 1));\n+}\n+\n+TEST_F(FatalErrorSinkDeathTest, ContextPresent_CHECK_LogExactlyOnce) {\n+  tsl::DebugMeContext<DebugMeContextKey> context(DebugMeContextKey::kHloPass,\n+                                                 \"MyTestPass\");\n+\n+  EXPECT_DEATH(CHECK(false) << \"test\", CountSubstr(\"MyTestPass\", 1));\n+}\n+\n+}  // namespace\n+}  // namespace xla::error"
        }
    ],
    "stats": {
        "total": 189,
        "additions": 183,
        "deletions": 6
    }
}