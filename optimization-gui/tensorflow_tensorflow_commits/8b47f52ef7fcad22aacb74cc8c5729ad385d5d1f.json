{
    "author": "unknown",
    "message": "[XLA:GPU] Add BufferDebugLogEntryMetadataStore\n\nEncoding extra metadata about an debug log entry within its ID limits how much\ninformation we can pass. To remove the limitation without the need to pass\nextra data between host and device, introduce a metadata store that provides a\nopaque ID -> metadata mapping.\n\nFollow up patches will make checksum/NaN tracing use\nBufferDebugLogEntryMetadataStore shared between all thunks that operate on\nBufferDebugLog:\n\n- BuffersChecksumThunks put the metadata into the store and use the returned\n  entry_ids to identify the checksums from BufferDebugLog,\n- xla_gpu_buffer_debug_log_dump reads the BufferDebugLog and uses the store to\n  resolve the entry_ids into the metadata.\n\nPiperOrigin-RevId: 825462635",
    "sha": "8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f",
    "files": [
        {
            "sha": "9c92314edab9e54740168df728d058dc2d190f55",
            "filename": "third_party/xla/xla/backends/gpu/runtime/BUILD",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2FBUILD?ref=8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f",
            "patch": "@@ -3134,5 +3134,35 @@ cc_library(\n     compatible_with = get_compatible_with_portable(),\n     deps = [\n         \":thunk_buffer_id\",\n+        \"//xla/tsl/lib/gtl:int_type\",\n+    ],\n+)\n+\n+cc_library(\n+    name = \"buffer_debug_log_entry_metadata_store\",\n+    srcs = [\"buffer_debug_log_entry_metadata_store.cc\"],\n+    hdrs = [\"buffer_debug_log_entry_metadata_store.h\"],\n+    compatible_with = get_compatible_with_portable(),\n+    deps = [\n+        \":buffer_debug_log_proto_cc\",\n+        \":buffer_debug_log_structs\",\n+        \":thunk_id\",\n+        \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/log:check\",\n+        \"@com_google_absl//absl/synchronization\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)\n+\n+xla_cc_test(\n+    name = \"buffer_debug_log_entry_metadata_store_test\",\n+    srcs = [\"buffer_debug_log_entry_metadata_store_test.cc\"],\n+    deps = [\n+        \":buffer_debug_log_entry_metadata_store\",\n+        \":buffer_debug_log_structs\",\n+        \":thunk_buffer_id\",\n+        \":thunk_id\",\n+        \"//xla/tsl/util/proto:proto_matchers\",\n+        \"@com_google_googletest//:gtest_main\",\n     ],\n )"
        },
        {
            "sha": "02d974474579501f0b7b54eed8a7edac0b322eac",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.cc",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.cc?ref=8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f",
            "patch": "@@ -0,0 +1,83 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.h\"\n+\n+#include <cstddef>\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <utility>\n+#include <vector>\n+\n+#include \"absl/log/check.h\"\n+#include \"absl/synchronization/mutex.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/backends/gpu/runtime/buffer_debug_log.pb.h\"\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_structs.h\"\n+\n+namespace xla::gpu {\n+\n+BufferDebugLogEntryId BufferDebugLogEntryMetadataStore::AssignId(\n+    const BufferDebugLogEntryMetadataStore::Metadata& metadata) {\n+  absl::MutexLock lock{mutex_};\n+  size_t id = log_entry_metadata_.size();\n+  CHECK_LT(id, std::numeric_limits<uint32_t>::max())\n+      << \"BufferDebugLogEntryId overflowed\";\n+\n+  log_entry_metadata_.push_back(std::move(metadata));\n+  return BufferDebugLogEntryId{static_cast<uint32_t>(id)};\n+}\n+\n+std::optional<BufferDebugLogEntryMetadataStore::Metadata>\n+BufferDebugLogEntryMetadataStore::GetEntryMetadata(\n+    BufferDebugLogEntryId entry_id) {\n+  absl::MutexLock lock{mutex_};\n+  return GetEntryMetadataLocked(entry_id);\n+}\n+\n+std::optional<BufferDebugLogEntryMetadataStore::Metadata>\n+BufferDebugLogEntryMetadataStore::GetEntryMetadataLocked(\n+    BufferDebugLogEntryId entry_id) {\n+  if (entry_id >= log_entry_metadata_.size()) {\n+    return std::nullopt;\n+  }\n+  return log_entry_metadata_[entry_id.value()];\n+}\n+\n+BufferDebugLogProto BufferDebugLogEntryMetadataStore::EntriesToProto(\n+    absl::Span<const BufferDebugLogEntry> entries) {\n+  absl::MutexLock lock{mutex_};\n+\n+  BufferDebugLogProto proto;\n+  for (const BufferDebugLogEntry& entry : entries) {\n+    // TODO: b/447080910 - simplify once entry_id is a BufferDebugLogEntryId.\n+    std::optional<Metadata> metadata =\n+        GetEntryMetadataLocked(BufferDebugLogEntryId{entry.entry_id.value()});\n+    if (!metadata.has_value()) {\n+      continue;\n+    }\n+\n+    BufferDebugLogEntryProto* entry_proto = proto.add_entries();\n+    entry_proto->set_thunk_id(metadata->thunk_id.value());\n+    entry_proto->set_buffer_idx(metadata->buffer_idx);\n+    entry_proto->set_execution_id(metadata->execution_id);\n+    entry_proto->set_is_input_buffer(metadata->is_input);\n+    entry_proto->set_checksum(entry.value);\n+  }\n+  return proto;\n+}\n+\n+}  // namespace xla::gpu"
        },
        {
            "sha": "4fc1f28fd6346f4d2d129629b4ddce79da8880a9",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.h",
            "status": "added",
            "additions": 86,
            "deletions": 0,
            "changes": 86,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store.h?ref=8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f",
            "patch": "@@ -0,0 +1,86 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_BACKENDS_GPU_RUNTIME_BUFFER_DEBUG_LOG_ENTRY_METADATA_STORE_H_\n+#define XLA_BACKENDS_GPU_RUNTIME_BUFFER_DEBUG_LOG_ENTRY_METADATA_STORE_H_\n+\n+#include <cstddef>\n+#include <cstdint>\n+#include <optional>\n+#include <utility>\n+#include <vector>\n+\n+#include \"absl/base/thread_annotations.h\"\n+#include \"absl/synchronization/mutex.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/backends/gpu/runtime/buffer_debug_log.pb.h\"\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_structs.h\"\n+#include \"xla/backends/gpu/runtime/thunk_id.h\"\n+\n+namespace xla::gpu {\n+\n+// Provides unique mapping between `BufferDebugLogEntry::entry_id` and\n+// additional information about the entry.\n+//\n+// For checksumming, the entry_id is transferred between host and device to\n+// identify the context of checksummed buffer. This class provides a way to\n+// store additional data about the entry without passing excessive information\n+// back and forth.\n+class BufferDebugLogEntryMetadataStore {\n+ public:\n+  // Metadata stored for each entry.\n+  struct Metadata {\n+    // ID of the thunk the entry relates to.\n+    ThunkId thunk_id;\n+    // Index of the thunk's buffer within the array returned by\n+    // `Thunk::buffer_uses()`.\n+    size_t buffer_idx;\n+    // ID of the execution of the thunk, to distinguish between different\n+    // executions of the same thunk, e.g. when it's used in a loop.\n+    size_t execution_id;\n+    // True if the entry represents a check made before the thunk executes.\n+    bool is_input;\n+  };\n+\n+  // Inserts `metadata` into the store and returns an ID that can be used to\n+  // retrieve it with `GetEntryMetadata`.\n+  //\n+  // The returned ID is guaranteed to be unique within the lifetime of this\n+  // store, and stays valid until the store gets destroyed.\n+  BufferDebugLogEntryId AssignId(const Metadata& metadata)\n+      ABSL_LOCKS_EXCLUDED(mutex_);\n+\n+  // Returns the metadata for the entry with `entry_id` previously returned by\n+  // `AssignId`, or `std::nullopt` if the ID is invalid.\n+  std::optional<Metadata> GetEntryMetadata(BufferDebugLogEntryId entry_id)\n+      ABSL_LOCKS_EXCLUDED(mutex_);\n+\n+  // Converts a list of `entries` with IDs assigned by this store to a\n+  // `BufferDebugLogProto` with additional metadata.\n+  BufferDebugLogProto EntriesToProto(\n+      absl::Span<const BufferDebugLogEntry> entries)\n+      ABSL_LOCKS_EXCLUDED(mutex_);\n+\n+ private:\n+  std::optional<Metadata> GetEntryMetadataLocked(BufferDebugLogEntryId entry_id)\n+      ABSL_EXCLUSIVE_LOCKS_REQUIRED(mutex_);\n+\n+  absl::Mutex mutex_;\n+  std::vector<Metadata> log_entry_metadata_ ABSL_GUARDED_BY(mutex_);\n+};\n+\n+}  // namespace xla::gpu\n+\n+#endif  // XLA_BACKENDS_GPU_RUNTIME_BUFFER_DEBUG_LOG_ENTRY_METADATA_STORE_H_"
        },
        {
            "sha": "5be89b86729a3f649f1165ce5c9ee9a467e09e44",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store_test.cc",
            "status": "added",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_entry_metadata_store_test.cc?ref=8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f",
            "patch": "@@ -0,0 +1,111 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_entry_metadata_store.h\"\n+\n+#include <optional>\n+#include <vector>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"xla/backends/gpu/runtime/buffer_debug_log_structs.h\"\n+#include \"xla/backends/gpu/runtime/thunk_buffer_id.h\"\n+#include \"xla/backends/gpu/runtime/thunk_id.h\"\n+#include \"xla/tsl/util/proto/proto_matchers.h\"\n+\n+namespace xla::gpu {\n+namespace {\n+\n+using ::tsl::proto_testing::EqualsProto;\n+\n+TEST(BufferDebugLogEntryMetadataStoreTest, RoundTrip) {\n+  BufferDebugLogEntryMetadataStore store;\n+  BufferDebugLogEntryMetadataStore::Metadata metadata = {\n+      /*thunk_id=*/ThunkId(123),\n+      /*buffer_idx=*/4,\n+      /*execution_id=*/5,\n+      /*is_input=*/true,\n+  };\n+\n+  BufferDebugLogEntryId entry_id = store.AssignId(metadata);\n+  // Add a second entry to ensure mutating the store doesn't invalidate\n+  // previously assigned IDs.\n+  [[maybe_unused]] BufferDebugLogEntryId unused_id =\n+      store.AssignId(BufferDebugLogEntryMetadataStore::Metadata{});\n+  std::optional<BufferDebugLogEntryMetadataStore::Metadata> retrieved_metadata =\n+      store.GetEntryMetadata(entry_id);\n+\n+  ASSERT_TRUE(retrieved_metadata.has_value());\n+  EXPECT_EQ(retrieved_metadata->thunk_id, metadata.thunk_id);\n+  EXPECT_EQ(retrieved_metadata->buffer_idx, metadata.buffer_idx);\n+  EXPECT_EQ(retrieved_metadata->execution_id, metadata.execution_id);\n+  EXPECT_EQ(retrieved_metadata->is_input, metadata.is_input);\n+}\n+\n+TEST(BufferDebugLogEntryMetadataStoreTest, InvalidId) {\n+  BufferDebugLogEntryMetadataStore store;\n+\n+  EXPECT_EQ(store.GetEntryMetadata(BufferDebugLogEntryId{123}), std::nullopt);\n+}\n+\n+TEST(BufferDebugLogEntryMetadataStoreTest, EntriesToProto) {\n+  BufferDebugLogEntryMetadataStore store;\n+  const BufferDebugLogEntryId entry_id1 = store.AssignId({\n+      /*thunk_id=*/ThunkId(123),\n+      /*buffer_idx=*/4,\n+      /*execution_id=*/5,\n+      /*is_input=*/true,\n+  });\n+  const BufferDebugLogEntryId entry_id2 = store.AssignId({\n+      /*thunk_id=*/ThunkId(567),\n+      /*buffer_idx=*/8,\n+      /*execution_id=*/9,\n+      /*is_input=*/false,\n+  });\n+  std::vector<BufferDebugLogEntry> entries = {\n+      {\n+          // TODO: b/447080910 - use BufferDebugLogEntryId directly.\n+          /*entry_id=*/reinterpret_cast<const ThunkBufferId&>(entry_id1),\n+          /*checksum=*/12341234,\n+      },\n+      {\n+          // TODO: b/447080910 - use BufferDebugLogEntryId directly.\n+          /*entry_id=*/reinterpret_cast<const ThunkBufferId&>(entry_id2),\n+          /*checksum=*/56785678,\n+      },\n+  };\n+\n+  BufferDebugLogProto log_proto = store.EntriesToProto(entries);\n+\n+  EXPECT_THAT(log_proto, EqualsProto(R\"pb(\n+                entries {\n+                  thunk_id: 123\n+                  buffer_idx: 4\n+                  execution_id: 5\n+                  is_input_buffer: true\n+                  checksum: 12341234\n+                }\n+                entries {\n+                  thunk_id: 567\n+                  buffer_idx: 8\n+                  execution_id: 9\n+                  is_input_buffer: false\n+                  checksum: 56785678\n+                }\n+              )pb\"));\n+}\n+\n+}  // namespace\n+}  // namespace xla::gpu"
        },
        {
            "sha": "dd13791f2130e838d9d2d1be5c4ed76d3f7bde04",
            "filename": "third_party/xla/xla/backends/gpu/runtime/buffer_debug_log_structs.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_structs.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_structs.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fbuffer_debug_log_structs.h?ref=8b47f52ef7fcad22aacb74cc8c5729ad385d5d1f",
            "patch": "@@ -21,9 +21,13 @@ limitations under the License.\n #include <tuple>\n \n #include \"xla/backends/gpu/runtime/thunk_buffer_id.h\"\n+#include \"xla/tsl/lib/gtl/int_type.h\"\n \n namespace xla::gpu {\n \n+// TODO: b/447080910 - use this instead of ThunkBufferId.\n+TSL_LIB_GTL_DEFINE_INT_TYPE(BufferDebugLogEntryId, uint32_t)\n+\n struct BufferDebugLogEntry {\n   // An ID that uniquely identifies a thunk and its specific input or output\n   // buffer."
        }
    ],
    "stats": {
        "total": 314,
        "additions": 314,
        "deletions": 0
    }
}