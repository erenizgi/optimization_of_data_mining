{
    "author": "jcai19",
    "message": "[XLA][Numerics][HLO Value Tracking] Propagate HLO original value via MLIR location during Shardy passes\n\nThis ensures HLO original values in parameters got perserved during HLO and MLIR round trip for running Shardy passes.\n\nPiperOrigin-RevId: 804773889",
    "sha": "dc9840f59256095aea4f23e1ac3c49456c6b68ef",
    "files": [
        {
            "sha": "96ef44da6451fed64328a5d84aba8176efada4fc",
            "filename": "third_party/xla/xla/hlo/translate/hlo_to_mhlo/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2FBUILD?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -223,6 +223,7 @@ cc_library(\n         \"stack_location_utils\",\n         \":hlo_utils\",\n         \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/translate:attributes\",\n         \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:Support\",\n     ],"
        },
        {
            "sha": "2e7333cdd7b3a56e2e431fb93504bca69f304630",
            "filename": "third_party/xla/xla/hlo/translate/hlo_to_mhlo/hlo_function_importer.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Fhlo_function_importer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Fhlo_function_importer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Fhlo_function_importer.cc?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -568,7 +568,7 @@ absl::StatusOr<Value> HloFunctionImporter::ImportInstructionsImpl(\n   const int num_parameters = computation.num_parameters();\n \n   for (int i = 0; i < num_parameters; i++) {\n-    auto hlo_parameter = computation.parameter_instruction(i);\n+    auto* hlo_parameter = computation.parameter_instruction(i);\n     instruction_value_map_[hlo_parameter] = arguments[i];\n   }\n \n@@ -716,13 +716,6 @@ absl::StatusOr<mlir::Operation*> HloFunctionImporter::ImportInstructionImpl(\n         kShardingAttr, ConvertSharding(instruction->sharding(), builder_)));\n   }\n \n-  if (instruction->original_value()) {\n-    attributes.push_back(builder_->getNamedAttr(\n-        kOriginalValueAttr,\n-        builder_->getStringAttr(\n-            \"{\" + instruction->original_value()->ToString() + \"}\")));\n-  }\n-\n   llvm::SmallVector<NamedAttribute, 4> frontend_attributes;\n   for (const auto& [k, v] : instruction->frontend_attributes().map()) {\n     frontend_attributes.push_back("
        },
        {
            "sha": "a821bd8dfc1c87e10caabe597e6df0d0023634bb",
            "filename": "third_party/xla/xla/hlo/translate/hlo_to_mhlo/location_importer.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Flocation_importer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Flocation_importer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Flocation_importer.cc?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -22,6 +22,7 @@ limitations under the License.\n #include \"mlir/IR/MLIRContext.h\"\n #include \"mlir/Support/LLVM.h\"\n #include \"xla/hlo/ir/hlo_instruction.h\"\n+#include \"xla/hlo/translate/attributes.h\"\n #include \"xla/hlo/translate/hlo_to_mhlo/hlo_utils.h\"\n #include \"xla/hlo/translate/hlo_to_mhlo/stack_location_utils.h\"\n \n@@ -32,10 +33,20 @@ mlir::Location GenerateInstructionLocation(\n     const xla::HloInstruction* instruction, mlir::MLIRContext* context) {\n   mlir::Builder b(context);\n \n+  auto fuse_original_value_if_present = [&](mlir::Location loc) {\n+    auto original_value = instruction->original_value();\n+    if (original_value) {\n+      return b.getFusedLoc({loc, mlir::NameLoc::get(b.getStringAttr(\n+                                     std::string(kOriginalValueAttr) + \"={\" +\n+                                     original_value->ToString() + \"}\"))});\n+    }\n+    return loc;\n+  };\n+\n   const std::string& op_name = instruction->metadata().op_name();\n   if (op_name.empty()) {\n-    return mlir::NameLoc::get(\n-        b.getStringAttr(xla::ToStringRef(instruction->name())));\n+    return fuse_original_value_if_present(mlir::NameLoc::get(\n+        b.getStringAttr(xla::ToStringRef(instruction->name()))));\n   }\n \n   if (instruction->metadata().stack_frame_id() != 0) {\n@@ -44,20 +55,22 @@ mlir::Location GenerateInstructionLocation(\n                                   instruction->parent()->parent());\n \n     if (!isa<mlir::UnknownLoc>(frame_location)) {\n-      return mlir::NameLoc::get(b.getStringAttr(op_name), frame_location);\n+      return fuse_original_value_if_present(\n+          mlir::NameLoc::get(b.getStringAttr(op_name), frame_location));\n     }\n   }\n \n   mlir::Location op_name_loc = mlir::NameLoc::get(b.getStringAttr(op_name));\n   const std::string& source_file = instruction->metadata().source_file();\n+\n   if (source_file.empty()) {\n-    return op_name_loc;\n+    return fuse_original_value_if_present(op_name_loc);\n   }\n \n-  return b.getFusedLoc(\n+  return fuse_original_value_if_present(b.getFusedLoc(\n       {op_name_loc,\n        mlir::FileLineColLoc::get(b.getContext(), source_file,\n-                                 instruction->metadata().source_line(), 0)});\n+                                 instruction->metadata().source_line(), 0)}));\n }\n \n }  // namespace hlo"
        },
        {
            "sha": "92a11e4921b57724cd25cfb5b09a45017301bb9c",
            "filename": "third_party/xla/xla/hlo/translate/hlo_to_mhlo/tests/import.hlo",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Ftests%2Fimport.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Ftests%2Fimport.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Ftests%2Fimport.hlo?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -2093,12 +2093,4 @@ add {\n // CHECK:  mhlo.topk([[ARG]], k = 2) : tensor<4x4xf32> -> (tensor<4x2xf32>, tensor<4x2xi32>)\n \n // FLATTEN-CHECK-LABEL:  func private @test_topk\n-// FLATTEN-CHECK-SAME:  ([[ARG:%.*]]: tensor<4x4xf32>) -> (tensor<4x2xf32>, tensor<4x2xi32>)\n-\n-// Test HLO original value\n-// CHECK-LABEL:  func private @test_original_value\n-%test_original_value (Arg_0: f32[192]) -> f32[1,17,17,192] {\n-  %Arg_0 = f32[192]{0} parameter(0)\n-  // CHECK: \"mhlo.broadcast_in_dim\"(%arg0) <{broadcast_dimensions = dense<3> : tensor<1xi64>}> {mhlo.original_value = \"{{[{][{]}}\\22broadcast.2342\\22{{[}][}]}}\"} : (tensor<192xf32>) -> tensor<1x17x17x192xf32>\n-  ROOT %broadcast.2342 = f32[1,17,17,192]{3,2,1,0} broadcast(f32[192]{0} %Arg_0), dimensions={3}, origin={{\"broadcast.2342\"}}\n-}\n+// FLATTEN-CHECK-SAME:  ([[ARG:%.*]]: tensor<4x4xf32>) -> (tensor<4x2xf32>, tensor<4x2xi32>)\n\\ No newline at end of file"
        },
        {
            "sha": "fa4255e927a1d65a4f9a4b804f9ea27fccaa897a",
            "filename": "third_party/xla/xla/hlo/translate/hlo_to_mhlo/tests/location.hlo",
            "status": "modified",
            "additions": 20,
            "deletions": 18,
            "changes": 38,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Ftests%2Flocation.hlo",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Ftests%2Flocation.hlo",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fhlo_to_mhlo%2Ftests%2Flocation.hlo?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -2,24 +2,26 @@\n // TODO: hlo-translate does not set the metadata for arguments properly.\n \n HloModule Test\n-\n+// CHECK: #[[LOC1:.*]] = loc(\"x\")\n+// CHECK: #[[LOC2:.*]] = loc(\"mhlo.original_value={{[{][{]}}\\22x\\22{{[}][}]}}\")\n+// CHECK: #[[LOC3:.*]] = loc(\"y\")\n+// CHECK: #[[LOC4:.*]] = loc(\"mhlo.original_value={{[{][{]}}\\22y\\22{{[}][}]}}\")\n // CHECK-LABEL: func @main\n-ENTRY A {\n-  // CHECK: loc(\"x\")\n-  %arg0 = f32[4] parameter(0), metadata={op_name=\"x\"}\n-  // CHECK: loc(\"y\")\n-  %arg1 = f32[4] parameter(1), metadata={op_name=\"y\"}\n-\n-  // CHECK: loc(#[[LOC0:.*]])\n+ENTRY main {\n+  %arg0 = f32[4] parameter(0), metadata={op_name=\"x\"}, origin={{\"x\"}}\n+  %arg1 = f32[4] parameter(1), metadata={op_name=\"y\"}, origin={{\"y\"}}\n+  // CHECK-NEXT: loc(#[[LOC5:.*]])\n   %add0 = f32[4] add(f32[4] %arg0, f32[4] %arg1)\n-  // CHECK: loc(#[[LOC1:.*]])\n-  %add1 = f32[4] add(f32[4] %add0, f32[4] %arg1), metadata={op_type=\"Add\" op_name=\"embedded_inference/Add_0\"}\n-  // CHECK: loc(#[[LOC4:.*]])\n-  ROOT %add2 = f32[4] add(f32[4] %add1, f32[4] %arg1), metadata={op_type=\"Add\" op_name=\"embedded_inference/Add_1\", source_file=\"source.txt\", source_line=17}\n-\n-  // CHECK: #[[LOC0]] = loc(\"add0\")\n-  // CHECK: #[[LOC1]] = loc(\"embedded_inference/Add_0\")\n-  // CHECK: #[[LOC2:.*]] = loc(\"embedded_inference/Add_1\")\n-  // CHECK: #[[LOC3:.*]] = loc(\"source.txt\":17:0)\n-  // CHECK: #[[LOC4]] = loc(fused[#[[LOC2]], #[[LOC3]]])\n+  // CHECK-NEXT: loc(#[[LOC13:.*]])\n+  %add1 = f32[4] add(f32[4] %add0, f32[4] %arg1), metadata={op_type=\"Add\" op_name=\"embedded_inference/Add_0\"}, origin={{\"add1\"}}\n+  // CHECK-NEXT: loc(#[[LOC14:.*]])\n+  ROOT %add2 = f32[4] add(f32[4] %add1, f32[4] %arg1), metadata={op_type=\"Add\" op_name=\"embedded_inference/Add_1\", source_file=\"source.txt\", source_line=17}, origin={{\"add2\"}}\n }\n+// CHECK: #[[LOC5]] = loc(\"add0\")\n+// CHECK: #[[LOC6:.*]] = loc(\"embedded_inference/Add_0\")\n+// CHECK: #[[LOC7:.*]] = loc(\"mhlo.original_value={{[{][{]}}\\22add1\\22{{[}][}]}}\")\n+// CHECK: #[[LOC8:.*]] = loc(\"embedded_inference/Add_1\")\n+// CHECK: #[[LOC9:.*]] = loc(\"source.txt\":17:0)\n+// CHECK: #[[LOC10:.*]] = loc(\"mhlo.original_value={{[{][{]}}\\22add2\\22{{[}][}]}}\")\n+// CHECK: #[[LOC13]] = loc(fused[#[[LOC6]], #[[LOC7]]])\n+// CHECK: #[[LOC14]] = loc(fused[#[[LOC8]], #[[LOC9]], #[[LOC10]]])"
        },
        {
            "sha": "2c9fcbfa06af4867b4e2d27e042484b4b84efb68",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/BUILD",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2FBUILD?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -116,6 +116,9 @@ cc_library(\n     deps = [\n         \":stack_frame_index_builder\",\n         \"//xla:xla_data_proto_cc\",\n+        \"//xla/hlo/ir:hlo\",\n+        \"//xla/hlo/parser:hlo_parser\",\n+        \"//xla/hlo/translate:attributes\",\n         \"@llvm-project//llvm:Support\",\n         \"@llvm-project//mlir:IR\",\n         \"@llvm-project//mlir:Support\","
        },
        {
            "sha": "e8e0489f283eff68f9672078f300588cc948527d",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/gen_hlo_op_writer.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fgen_hlo_op_writer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fgen_hlo_op_writer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fgen_hlo_op_writer.cc?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -218,7 +218,7 @@ static bool OperatorWritersMain(raw_ostream& os, const RecordKeeper& records) {\n   // Create a scoped object to assign original values to generated XLA ops.\n   os << \"  xla::XlaScopedOriginalValueAssignment \"\n         \"original_value(lowering_context.builder, \"\n-        \"CreateOriginalValueFromOp(op));\\n\\n\";\n+        \"mlir::mhlo::CreateOriginalValueFromOp(op));\\n\\n\";\n \n   // Retrieve all the definitions derived from MHLO_Op and sort by record name.\n   for (auto dialect_def : dialect_defs) {"
        },
        {
            "sha": "d6033b74154363215e8f3d675eea184ef7c73dc4",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/location_exporter.cc",
            "status": "modified",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.cc?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -15,6 +15,8 @@ limitations under the License.\n \n #include \"xla/hlo/translate/mhlo_to_hlo/location_exporter.h\"\n \n+#include <memory>\n+#include <optional>\n #include <string>\n \n #include \"llvm/ADT/STLExtras.h\"\n@@ -26,6 +28,9 @@ limitations under the License.\n #include \"mlir/IR/Operation.h\"\n #include \"mlir/IR/Visitors.h\"\n #include \"mlir/Support/LLVM.h\"\n+#include \"xla/hlo/ir/hlo_original_value.h\"\n+#include \"xla/hlo/parser/hlo_parser.h\"\n+#include \"xla/hlo/translate/attributes.h\"\n #include \"xla/hlo/translate/mhlo_to_hlo/stack_frame_index_builder.h\"\n #include \"xla/xla_data.pb.h\"\n \n@@ -45,6 +50,9 @@ static std::string GetNameFromLocImpl(Location loc) {\n       // in functions where the op's name is first.\n       auto name = name_loc.getName().strref().split('@').first;\n       // Skip if the name is for op type.\n+      if (name.starts_with(kOriginalValueAttr)) {\n+        continue;\n+      }\n       if (name.ends_with(\":\")) {\n         locs.push_back(name_loc.getChildLoc());\n       } else {\n@@ -76,6 +84,9 @@ static std::string GetOpTypeFromLoc(Location loc) {\n       // Add name in NameLoc. For NameLoc we also account for names due to ops\n       // in functions where the op's name is first.\n       auto op_type = name_loc.getName().strref().split('@').first;\n+      if (op_type.starts_with(kOriginalValueAttr)) {\n+        continue;\n+      }\n       if (op_type.ends_with(\":\")) {\n         op_type = op_type.substr(0, op_type.size() - 1);\n         loc_op_types.push_back(op_type);\n@@ -95,6 +106,38 @@ static std::string GetOpTypeFromLoc(Location loc) {\n   return llvm::join(loc_op_types.begin(), loc_op_types.end(), \";\");\n }\n \n+static std::shared_ptr<xla::OriginalValue> GetOriginalValueFromLoc(\n+    Location loc) {\n+  llvm::StringRef loc_original_value;\n+  llvm::SmallVector<Location, 8> locs;\n+  locs.push_back(loc);\n+\n+  while (!locs.empty()) {\n+    Location curr_loc = locs.pop_back_val();\n+\n+    if (auto name_loc = mlir::dyn_cast<NameLoc>(curr_loc)) {\n+      auto original_value = name_loc.getName().strref().split('@').first;\n+      if (!original_value.starts_with(kOriginalValueAttr)) {\n+        continue;\n+      }\n+      loc_original_value = original_value.split('=').second;\n+      break;\n+    }\n+    if (auto fused_loc = mlir::dyn_cast<FusedLoc>(curr_loc)) {\n+      // Push all locations in FusedLoc in reverse order, so locations are\n+      // visited based on order in FusedLoc.\n+      auto reversed_fused_locs = llvm::reverse(fused_loc.getLocations());\n+      locs.append(reversed_fused_locs.begin(), reversed_fused_locs.end());\n+    }\n+  }\n+\n+  auto original_value = xla::ParseOriginalValue(loc_original_value);\n+  if (!original_value.ok()) {\n+    return nullptr;\n+  }\n+  return original_value.value();\n+}\n+\n static void SetSourceFileAndLine(Location loc, xla::OpMetadata& metadata) {\n   if (auto file_line_col_loc = mlir::dyn_cast<mlir::FileLineColLoc>(loc)) {\n     metadata.set_source_file(file_line_col_loc.getFilename().str());\n@@ -160,5 +203,25 @@ std::string GetDebugNameFromLocation(mlir::Location loc) {\n   return GetNameFromLocImpl(loc);\n }\n \n+std::optional<xla::OriginalValueProto> CreateOriginalValueFromOp(\n+    mlir::Operation* op) {\n+  mlir::Location loc = op->getLoc();\n+  return CreateOriginalValueFromLocation(loc);\n+}\n+\n+std::optional<xla::OriginalValueProto> CreateOriginalValueFromLocation(\n+    mlir::Location loc) {\n+  if (isa<mlir::UnknownLoc>(loc)) {\n+    return std::nullopt;\n+  }\n+\n+  if (std::shared_ptr<xla::OriginalValue> original_value =\n+          GetOriginalValueFromLoc(loc)) {\n+    return original_value->ToProto();\n+  }\n+\n+  return std::nullopt;\n+}\n+\n }  // namespace mhlo\n }  // namespace mlir"
        },
        {
            "sha": "d73050e31a64dbee923fa4d29859b32ae744d8dd",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/location_exporter.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Flocation_exporter.h?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -34,6 +34,14 @@ namespace mhlo {\n xla::OpMetadata CreateOpMetadataFromLocation(\n     Operation* op, StackFrameIndexBuilder* frame_index_builder);\n \n+// Returns an OriginalValueProto based on the location. If the location is\n+// unknown or the original value is not present, an empty proto is returned.\n+std::optional<xla::OriginalValueProto> CreateOriginalValueFromLocation(\n+    mlir::Location loc);\n+\n+// Returns an OriginalValueProto based on the location of the op.\n+std::optional<xla::OriginalValueProto> CreateOriginalValueFromOp(Operation* op);\n+\n // Returns a name that can be used for debugging purposes, e.g., naming\n // variable names in generated IR or producing logging output.\n std::string GetDebugNameFromLocation(Location location);"
        },
        {
            "sha": "c59e852810e5d54b12e3c904a548193cf652a76b",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/mlir_hlo_to_hlo.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.cc?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -6182,6 +6182,8 @@ LogicalResult ConvertToHloModule::LowerBasicBlockAsFunction(\n         // debugging.\n         xla::XlaScopedOpMetadataAssignment op_metadata(\n             builder, GetOpNameMetadataFromLocation(arg));\n+        xla::XlaScopedOriginalValueAssignment original_value(\n+            builder, mlir::mhlo::CreateOriginalValueFromLocation(arg.getLoc()));\n         // Use the user-specified op_name from the location if available,\n         // otherwise use the default prefix.\n         std::string name = mhlo::GetDebugNameFromLocation(arg.getLoc());\n@@ -6476,14 +6478,4 @@ absl::Status ConvertMlirHloToHlo(mlir::ModuleOp module,\n   return ConvertMlirHloToHlo(module, hlo_proto, options);\n }\n \n-std::optional<xla::OriginalValueProto> CreateOriginalValueFromOp(\n-    mlir::Operation* op) {\n-  auto original_value_attr =\n-      op->getAttrOfType<mlir::StringAttr>(kOriginalValueAttr);\n-  if (!original_value_attr) {\n-    return std::nullopt;\n-  }\n-  return xla::ConvertOriginalValue(original_value_attr.getValue());\n-}\n-\n }  // namespace mlir"
        },
        {
            "sha": "f61223f5d85a782e687ef6a6ccbbaa3a9098af6f",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/mlir_hlo_to_hlo.h",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Fmlir_hlo_to_hlo.h?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -101,11 +101,6 @@ absl::Status BuildHloFromMlirHlo(mlir::Block& block, xla::XlaBuilder& builder,\n                                  std::vector<xla::XlaOp>& returns,\n                                  MlirToHloConversionOptions options = {});\n \n-// Returns an OriginalValueProto from the \"original_value\" attribute of the op.\n-// Returns std::nullopt if the op doesn't have the attribute.\n-std::optional<xla::OriginalValueProto> CreateOriginalValueFromOp(\n-    mlir::Operation* op);\n-\n }  // namespace mlir\n \n #endif  // XLA_HLO_TRANSLATE_MHLO_TO_HLO_MLIR_HLO_TO_HLO_H_"
        },
        {
            "sha": "885d4eff873136157c06d1c3e3d297a083676a07",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2FBUILD?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -33,6 +33,7 @@ lit_test_suite(\n             \"int4.mlir\",\n             \"layouts_and_names.mlir\",\n             \"location_to_op_metadata.mlir\",\n+            \"location_to_original_value.mlir\",\n             \"location_to_stacktrace.mlir\",\n             \"missing_main.mlir\",\n             \"module_config.mlir\","
        },
        {
            "sha": "ea89b30054ed9a4cc3b2e809d46359b37b30ab34",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/export.mlir",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Fexport.mlir?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -3169,17 +3169,6 @@ func.func @main(%input0: tensor<16x16xf32>, %input1: tensor<16x16xi32>) {\n   func.return\n }\n \n-// -----\n-// CHECK: HloModule\n-// CHECK: ENTRY\n-// CHECK: %[[ARG0:.*]] = f32[192] parameter(0)\n-// CHECK: ROOT %[[RESULT:.*]] = f32[1,17,17,192] broadcast(%[[ARG0]]), dimensions={3}, origin={{[{][{]}}\"broadcast.2342\"{{[}][}]}}\n-\n-func.func @main(%arg0: tensor<192xf32>) -> tensor<1x17x17x192xf32> {\n-  %0 = \"mhlo.broadcast_in_dim\"(%arg0) <{broadcast_dimensions = dense<3> : tensor<1xi64>}> {mhlo.original_value = \"{{\\22broadcast.2342\\22}}\"} : (tensor<192xf32>) -> tensor<1x17x17x192xf32>\n-  return %0 : tensor<1x17x17x192xf32>\n-}\n-\n // -----\n \n // CHECK: HloModule"
        },
        {
            "sha": "b54c68dd787dbe303a0e587d75a29fcb13f5c39f",
            "filename": "third_party/xla/xla/hlo/translate/mhlo_to_hlo/tests/location_to_original_value.mlir",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_original_value.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_original_value.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Fmhlo_to_hlo%2Ftests%2Flocation_to_original_value.mlir?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -0,0 +1,35 @@\n+// RUN: xla-translate -split-input-file -mlir-hlo-to-hlo-text %s | FileCheck %s --dump-input=always --check-prefixes=CHECK\n+\n+\n+// CHECK-LABEL: main\n+// CHECK: %[[ARG0:.*]] = f32[4] parameter(0), origin={{[{][{]}}\"x\"{{[}][}]}}\n+// CHECK: %[[ARG1:.*]] = f32[4] parameter(1), origin={{[{][{]}}\"y\"{{[}][}]}}\n+// CHECK: %[[ADD0:.*]] = f32[4] add(%[[ARG0]], %[[ARG1]])\n+// CHECK-NOT: origin\n+// CHECK-SAME: metadata={op_name=\"add0\"}\n+// CHECK: %[[ADD1:.*]] = f32[4] add(%[[ADD0]], %[[ARG1]]), origin={{[{][{]}}\"add1\"{{[}][}]}}, metadata=\n+// CHECK: ROOT %[[ADD2:.*]] = f32[4] add(%[[ADD1]], %[[ARG1]]), origin={{[{][{]}}\"add2\"{{[}][}]}}, metadata=\n+\n+#loc1 = loc(\"x\")\n+#loc2 = loc(\"mhlo.original_value={{\\22x\\22}}\")\n+#loc3 = loc(\"y\")\n+#loc4 = loc(\"mhlo.original_value={{\\22y\\22}}\")\n+#loc11 = loc(fused[#loc1, #loc2])\n+#loc12 = loc(fused[#loc3, #loc4])\n+module @Test attributes {mhlo.cross_program_prefetches = [], mhlo.input_output_alias = [], mhlo.is_dynamic = false, mhlo.use_auto_spmd_partitioning = false} {\n+  func.func @main(%arg0: tensor<4xf32> loc(fused[#loc1, #loc2]), %arg1: tensor<4xf32> loc(fused[#loc3, #loc4])) -> tensor<4xf32> {\n+    %0 = mhlo.add %arg0, %arg1 : tensor<4xf32> loc(#loc5)\n+    %1 = mhlo.add %0, %arg1 : tensor<4xf32> loc(#loc13)\n+    %2 = mhlo.add %1, %arg1 : tensor<4xf32> loc(#loc14)\n+    return %2 : tensor<4xf32> loc(#loc)\n+  } loc(#loc)\n+} loc(#loc)\n+#loc = loc(unknown)\n+#loc5 = loc(\"add0\")\n+#loc6 = loc(\"embedded_inference/Add_0\")\n+#loc7 = loc(\"mhlo.original_value={{\\22add1\\22}}\")\n+#loc8 = loc(\"embedded_inference/Add_1\")\n+#loc9 = loc(\"source.txt\":17:0)\n+#loc10 = loc(\"mhlo.original_value={{\\22add2\\22}}\")\n+#loc13 = loc(fused[#loc6, #loc7])\n+#loc14 = loc(fused[#loc8, #loc9, #loc10])\n\\ No newline at end of file"
        },
        {
            "sha": "a24f78fefb005156da3aee836cdca8eb43404438",
            "filename": "third_party/xla/xla/hlo/translate/tests/stablehlo.mlir",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Ftests%2Fstablehlo.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/dc9840f59256095aea4f23e1ac3c49456c6b68ef/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Ftests%2Fstablehlo.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fhlo%2Ftranslate%2Ftests%2Fstablehlo.mlir?ref=dc9840f59256095aea4f23e1ac3c49456c6b68ef",
            "patch": "@@ -1950,21 +1950,6 @@ module {\n \n // -----\n \n-// CHECK-LABEL: HloModule main\n-\n-// CHECK: ENTRY\n-// CHECK: %[[ARG0:.*]] = f32[192] parameter(0)\n-// CHECK: ROOT %[[RESULT:.*]] = f32[1,17,17,192] broadcast(%[[ARG0]]), dimensions={3}, origin={{[{][{]}}\"broadcast.2342\"{{[}][}]}}\n-\n-module {\n-  func.func @main(%arg0: tensor<192xf32>) -> tensor<1x17x17x192xf32> {\n-    %0 = stablehlo.broadcast_in_dim %arg0, dims = [3] {mhlo.original_value = \"{{\\22broadcast.2342\\22}}\"} : (tensor<192xf32>) -> tensor<1x17x17x192xf32>\n-    return %0 : tensor<1x17x17x192xf32>\n-  }\n-}\n-\n-// -----\n-\n // CHECK-LABEL: HloModule main\n // CHECK: ENTRY\n func.func @main() -> tensor<128x2048xf32> {"
        }
    ],
    "stats": {
        "total": 238,
        "additions": 155,
        "deletions": 83
    }
}