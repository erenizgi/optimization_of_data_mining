{
    "author": "WillFroom",
    "message": "[XLA:CPU] Fix lowering of extracting memref from callframe.\n\nPiperOrigin-RevId: 811712701",
    "sha": "2feee6bae3d61e04bbbe332982804e4918c1c010",
    "files": [
        {
            "sha": "04f14554cce723523a5c4300ea91ddf74db050fe",
            "filename": "third_party/xla/xla/backends/cpu/codegen/emitters/transforms/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2feee6bae3d61e04bbbe332982804e4918c1c010/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2feee6bae3d61e04bbbe332982804e4918c1c010/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2FBUILD?ref=2feee6bae3d61e04bbbe332982804e4918c1c010",
            "patch": "@@ -83,6 +83,7 @@ cc_library(\n         \"@llvm-project//mlir:DataLayoutInterfaces\",\n         \"@llvm-project//mlir:FuncDialect\",\n         \"@llvm-project//mlir:IR\",\n+        \"@llvm-project//mlir:LLVMCommonConversion\",\n         \"@llvm-project//mlir:LLVMDialect\",\n         \"@llvm-project//mlir:Support\",\n         \"@llvm-project//mlir:TransformUtils\","
        },
        {
            "sha": "97d8b10ceeb43efc4167711fed016ed754c40a58",
            "filename": "third_party/xla/xla/backends/cpu/codegen/emitters/transforms/tests/lower_to_llvm.mlir",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2feee6bae3d61e04bbbe332982804e4918c1c010/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Ftests%2Flower_to_llvm.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2feee6bae3d61e04bbbe332982804e4918c1c010/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Ftests%2Flower_to_llvm.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Ftests%2Flower_to_llvm.mlir?ref=2feee6bae3d61e04bbbe332982804e4918c1c010",
            "patch": "@@ -57,6 +57,36 @@ func.func @extract_workgroup_id(%call_frame: !xla_cpu.call_frame) -> (index, ind\n // CHECK: %[[WORKGROUP_Z_IDX:.+]] = builtin.unrealized_conversion_cast %[[WORKGROUP_Z]] : i64 to index\n // CHECK: return %[[WORKGROUP_X_IDX]], %[[WORKGROUP_Y_IDX]], %[[WORKGROUP_Z_IDX]] : index, index, index\n \n+// -----\n+\n+func.func @load_memref(%call_frame: !xla_cpu.call_frame) -> memref<2x4xi32> {\n+  %loaded = xla_cpu.load %call_frame, 0 : memref<2x4xi32>\n+  return %loaded : memref<2x4xi32>\n+}\n+\n+// CHECK-LABEL: @load_memref(\n+// CHECK-SAME:    %[[CALLFRAME:.*]]: !xla_cpu.call_frame) -> memref<2x4xi32> {\n+// CHECK-DAG:  %[[C_1:.*]] = llvm.mlir.constant(1 : index) : i64\n+// CHECK-DAG:  %[[C_4:.*]] = llvm.mlir.constant(4 : index) : i64\n+// CHECK-DAG:  %[[C_2:.*]] = llvm.mlir.constant(2 : index) : i64\n+// CHECK-DAG:  %[[C_0:.*]] = llvm.mlir.constant(0 : index) : i64\n+// CHECK-DAG:  %[[INIT:.*]] = llvm.mlir.poison : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[CALLFRAME_PTR:.*]] = builtin.unrealized_conversion_cast %[[CALLFRAME]] : !xla_cpu.call_frame to !llvm.ptr\n+// CHECK-DAG:  %[[ARGS_GEP:.*]] = llvm.getelementptr inbounds %[[CALLFRAME_PTR]][0, 3] : (!llvm.ptr) -> !llvm.ptr, !llvm.struct<\"XLA_CPU_KernelCallFrame\", (ptr, ptr, i64, ptr)>\n+// CHECK-DAG:  %[[ARGS_PTR:.*]] = llvm.load %[[ARGS_GEP]] invariant : !llvm.ptr -> !llvm.ptr\n+// CHECK-DAG:  %[[INPUT_GEP:.*]] = llvm.getelementptr inbounds %[[ARGS_PTR]][0, 0] : (!llvm.ptr) -> !llvm.ptr, !llvm.struct<\"XLA_CPU_KernelArg\", (ptr, i64)>\n+// CHECK-DAG:  %[[INPUT_PTR:.*]] = llvm.load %[[INPUT_GEP]] invariant : !llvm.ptr -> !llvm.ptr\n+// CHECK-DAG:  %[[INSERT_0:.*]] = llvm.insertvalue %[[INPUT_PTR]], %[[INIT]][0] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[INSERT_1:.*]] = llvm.insertvalue %[[INPUT_PTR]], %[[INSERT_0]][1] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[INSERT_2:.*]] = llvm.insertvalue %[[C_0]], %[[INSERT_1]][2] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[INSERT_3:.*]] = llvm.insertvalue %[[C_2]], %[[INSERT_2]][3, 0] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[INSERT_4:.*]] = llvm.insertvalue %[[C_4]], %[[INSERT_3]][4, 0] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[INSERT_5:.*]] = llvm.insertvalue %[[C_4]], %[[INSERT_4]][3, 1] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK-DAG:  %[[FINAL_DESC:.*]] = llvm.insertvalue %[[C_1]], %[[INSERT_5]][4, 1] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)>\n+// CHECK:  %[[MEMREF:.*]] = builtin.unrealized_conversion_cast %[[FINAL_DESC]] : !llvm.struct<(ptr, ptr, i64, array<2 x i64>, array<2 x i64>)> to memref<2x4xi32>\n+// CHECK:  return %[[MEMREF]] : memref<2x4xi32>\n+\n+\n // -----\n \n func.func private @wrap_entry("
        },
        {
            "sha": "08ac98c661aae40471e41c424ce8b84b3c387b34",
            "filename": "third_party/xla/xla/backends/cpu/codegen/emitters/transforms/xla_cpu_rewrite_patterns.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/2feee6bae3d61e04bbbe332982804e4918c1c010/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Fxla_cpu_rewrite_patterns.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/2feee6bae3d61e04bbbe332982804e4918c1c010/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Fxla_cpu_rewrite_patterns.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fcodegen%2Femitters%2Ftransforms%2Fxla_cpu_rewrite_patterns.cc?ref=2feee6bae3d61e04bbbe332982804e4918c1c010",
            "patch": "@@ -22,6 +22,8 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"llvm/ADT/STLExtras.h\"\n #include \"llvm/ADT/SmallVector.h\"\n+#include \"mlir/Conversion/LLVMCommon/MemRefBuilder.h\"\n+#include \"mlir/Conversion/LLVMCommon/TypeConverter.h\"\n #include \"mlir/Dialect/Func/IR/FuncOps.h\"\n #include \"mlir/Dialect/LLVMIR/LLVMAttrs.h\"\n #include \"mlir/Dialect/LLVMIR/LLVMDialect.h\"\n@@ -112,9 +114,18 @@ struct LowerLoadOp : public mlir::OpRewritePattern<LoadOp> {\n               dereferenceable.getInt(), false));\n     }\n \n-    auto arg_ptr_cast = b.create<mlir::UnrealizedConversionCastOp>(\n-        op.getLoc(), op->getResult(0).getType(), arg_ptr.getResult());\n-    rewriter.replaceOp(op, arg_ptr_cast.getResult(0));\n+    if (auto memref_type = mlir::dyn_cast<mlir::MemRefType>(op.getType())) {\n+      mlir::LLVMTypeConverter converter(rewriter.getContext());\n+      mlir::Value memref_desc = mlir::MemRefDescriptor::fromStaticShape(\n+          b, op.getLoc(), converter, memref_type, arg_ptr);\n+      auto memref_cast = b.create<mlir::UnrealizedConversionCastOp>(\n+          op.getLoc(), op.getResult().getType(), memref_desc);\n+      rewriter.replaceOp(op, memref_cast);\n+    } else {\n+      auto arg_ptr_cast = b.create<mlir::UnrealizedConversionCastOp>(\n+          op.getLoc(), op.getResult().getType(), arg_ptr.getResult());\n+      rewriter.replaceOp(op, arg_ptr_cast.getResult(0));\n+    }\n     return mlir::success();\n   }\n };"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 45,
        "deletions": 3
    }
}