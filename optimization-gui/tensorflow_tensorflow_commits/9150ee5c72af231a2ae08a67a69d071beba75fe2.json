{
    "author": "tensorflower-gardener",
    "message": "[StableHLO->HLO] Correct BroadcastInDim -> Transpose rewrite\n\nPiperOrigin-RevId: 811289186",
    "sha": "9150ee5c72af231a2ae08a67a69d071beba75fe2",
    "files": [
        {
            "sha": "772ead9058ef77fba26ead67d2e92a6885cb9e13",
            "filename": "third_party/xla/xla/mlir_hlo/mhlo/IR/hlo_ops.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9150ee5c72af231a2ae08a67a69d071beba75fe2/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Fmhlo%2FIR%2Fhlo_ops.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9150ee5c72af231a2ae08a67a69d071beba75fe2/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Fmhlo%2FIR%2Fhlo_ops.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Fmhlo%2FIR%2Fhlo_ops.cc?ref=9150ee5c72af231a2ae08a67a69d071beba75fe2",
            "patch": "@@ -2793,10 +2793,17 @@ class BroadcastInDimSimplifier : public OpRewritePattern<BroadcastInDimOp> {\n                                                op.getOperand());\n         return success();\n       }\n-      // BroadcastInDim equivalent to transpose\n+      // BroadcastInDim equivalent to transpose, except that the index values\n+      // are reversed; broadcast_dim[i] == j <=> transpose[j] == i\n       if (operandType.getRank() == resultType.getRank() && sameTotalElements) {\n+        SmallVector<int64_t> permutation(operandType.getRank());\n+        for (int64_t i = 0; i < operandType.getRank(); ++i) {\n+          permutation[bsDimIndices[i]] = i;\n+        }\n+        auto permutationAttr = DenseIntElementsAttr::get(\n+            op.getBroadcastDimensions().getType(), permutation);\n         rewriter.replaceOpWithNewOp<TransposeOp>(\n-            op, op.getType(), op.getOperand(), op.getBroadcastDimensions());\n+            op, op.getType(), op.getOperand(), permutationAttr);\n         return success();\n       }\n     }"
        },
        {
            "sha": "3a53ce495b2792731ec2a713ac6dfbeaf97844a7",
            "filename": "third_party/xla/xla/mlir_hlo/tests/Dialect/mhlo/canonicalize/canonicalize.mlir",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/9150ee5c72af231a2ae08a67a69d071beba75fe2/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fmhlo%2Fcanonicalize%2Fcanonicalize.mlir",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/9150ee5c72af231a2ae08a67a69d071beba75fe2/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fmhlo%2Fcanonicalize%2Fcanonicalize.mlir",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fmlir_hlo%2Ftests%2FDialect%2Fmhlo%2Fcanonicalize%2Fcanonicalize.mlir?ref=9150ee5c72af231a2ae08a67a69d071beba75fe2",
            "patch": "@@ -52,11 +52,11 @@ func.func @broadcast_in_dim_not_identity_because_it_actually_broadcasts(%arg0: t\n }\n \n // CHECK-LABEL: func @broadcast_in_dim_equivalent_transpose\n-func.func @broadcast_in_dim_equivalent_transpose(%arg0: tensor<2x2xf32>) -> tensor<2x2xf32> {\n+func.func @broadcast_in_dim_equivalent_transpose(%arg0: tensor<1x2x3x4xf32>) -> tensor<1x4x2x3xf32> {\n   // CHECK: mhlo.transpose\n-  // CHECK-SAME: permutation = dense<[1, 0]>\n-  %0 = \"mhlo.broadcast_in_dim\"(%arg0) <{broadcast_dimensions = dense<[1, 0]> : tensor<2xi64>}> : (tensor<2x2xf32>) -> tensor<2x2xf32>\n-  func.return %0 : tensor<2x2xf32>\n+  // CHECK-SAME: permutation = dense<[0, 3, 1, 2]> : tensor<4xi64>\n+  %0 = \"mhlo.broadcast_in_dim\"(%arg0) <{broadcast_dimensions = dense<[0, 2, 3, 1]> : tensor<4xi64>}> : (tensor<1x2x3x4xf32>) -> tensor<1x4x2x3xf32>\n+  func.return %0 : tensor<1x4x2x3xf32>\n }\n \n // CHECK-LABEL: @identity_broadcast_reshape"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 13,
        "deletions": 6
    }
}