{
    "author": "unknown",
    "message": "[XLA:GPU] Fix issues found by ASAN\n\n* `execution_context` passed down to `CustomCallThunk::BuildCallOptions`\n  is null when called for stages other than Execute, so `absl_nonnull`\n  annotation was incorrect.\n* Use locals instead of temporaries for the reference arguments passed\n  to calls in `CustomCallThunk` tests.\n\nPiperOrigin-RevId: 827937432",
    "sha": "5223c485d4d11c0e0047e85490793a0615c138ae",
    "files": [
        {
            "sha": "ebf0426e32c001d8d281d033d7e30a83108b155d",
            "filename": "third_party/xla/xla/backends/gpu/runtime/custom_call_thunk.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5223c485d4d11c0e0047e85490793a0615c138ae/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5223c485d4d11c0e0047e85490793a0615c138ae/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk.cc?ref=5223c485d4d11c0e0047e85490793a0615c138ae",
            "patch": "@@ -407,7 +407,7 @@ CustomCallThunk::BuildCallFrame(\n CallOptions CustomCallThunk::BuildCallOptions(\n     RunId run_id, se::Stream* absl_nullable stream,\n     const BufferAllocations* absl_nullable buffer_allocations,\n-    const ffi::ExecutionContext* absl_nonnull execution_context) {\n+    const ffi::ExecutionContext* absl_nullable execution_context) {\n   int32_t device_ordinal = -1;\n   se::DeviceMemoryAllocator* allocator = nullptr;\n   if (buffer_allocations != nullptr) {"
        },
        {
            "sha": "b5c15f946665f578be6fea2108e5b04cfcad5a05",
            "filename": "third_party/xla/xla/backends/gpu/runtime/custom_call_thunk.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5223c485d4d11c0e0047e85490793a0615c138ae/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5223c485d4d11c0e0047e85490793a0615c138ae/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk.h?ref=5223c485d4d11c0e0047e85490793a0615c138ae",
            "patch": "@@ -170,7 +170,7 @@ class CustomCallThunk : public Thunk {\n   xla::ffi::CallOptions BuildCallOptions(\n       RunId run_id, se::Stream* absl_nullable stream,\n       const BufferAllocations* absl_nullable buffer_allocations,\n-      const ffi::ExecutionContext* absl_nonnull execution_context);\n+      const ffi::ExecutionContext* absl_nullable execution_context);\n \n   absl::Status ExecuteFfiHandler(RunId run_id, XLA_FFI_Handler* handler,\n                                  XLA_FFI_ExecutionStage stage,"
        },
        {
            "sha": "00a8e15a53211549c7d106e42a1146932f20f266",
            "filename": "third_party/xla/xla/backends/gpu/runtime/custom_call_thunk_test.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/5223c485d4d11c0e0047e85490793a0615c138ae/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/5223c485d4d11c0e0047e85490793a0615c138ae/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcustom_call_thunk_test.cc?ref=5223c485d4d11c0e0047e85490793a0615c138ae",
            "patch": "@@ -236,8 +236,8 @@ TEST(CustomCallThunkTest, CustomCallWithOwnedHandlers) {\n   initialize_params.stream = stream.get();\n   initialize_params.buffer_allocations = &buffer_allocations;\n   Thunk::ExecuteParams execute_params = Thunk::ExecuteParams::Create(\n-      ServiceExecutableRunOptions(), BufferAllocations({}, 0, &allocator),\n-      stream.get(), stream.get(), nullptr, nullptr);\n+      ServiceExecutableRunOptions(), buffer_allocations, stream.get(),\n+      stream.get(), nullptr, nullptr);\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       std::unique_ptr<CustomCallThunk> thunk,\n@@ -284,9 +284,10 @@ TEST(CustomCallThunkTest, CustomCallWithOwnedHandlersWithoutOptionalOnes) {\n   Thunk::PrepareParams prepare_params = Thunk::PrepareParams{};\n   ResourceRequests resource_requests;\n   Thunk::InitializeParams initialize_params = Thunk::InitializeParams{};\n+  BufferAllocations buffer_allocations({}, 0, &allocator);\n   Thunk::ExecuteParams execute_params = Thunk::ExecuteParams::Create(\n-      ServiceExecutableRunOptions(), BufferAllocations({}, 0, &allocator),\n-      stream.get(), stream.get(), nullptr, nullptr);\n+      ServiceExecutableRunOptions(), buffer_allocations, stream.get(),\n+      stream.get(), nullptr, nullptr);\n \n   // Optional handlers are null and shouldn't be invoked.\n   TF_ASSERT_OK_AND_ASSIGN("
        }
    ],
    "stats": {
        "total": 13,
        "additions": 7,
        "deletions": 6
    }
}