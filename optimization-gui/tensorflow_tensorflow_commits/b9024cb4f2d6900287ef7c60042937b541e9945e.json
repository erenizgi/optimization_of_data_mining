{
    "author": "tensorflower-gardener",
    "message": "Rollback of PR #32389\n\nReverts 6e534c2dc1cd7ca12e2686cecdd845f138952d3c\n\nPiperOrigin-RevId: 819424613",
    "sha": "b9024cb4f2d6900287ef7c60042937b541e9945e",
    "files": [
        {
            "sha": "3dfb34cbe9740bbd560eb6f564fa0d2e48985e55",
            "filename": "third_party/xla/xla/service/collective_pipeliner.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b9024cb4f2d6900287ef7c60042937b541e9945e/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b9024cb4f2d6900287ef7c60042937b541e9945e/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner.cc?ref=b9024cb4f2d6900287ef7c60042937b541e9945e",
            "patch": "@@ -514,8 +514,7 @@ std::optional<std::vector<HloInstruction*>> CollectIndependentOperandChain(\n     HloPredicate should_allow_loop_variant_parameter_in_chain,\n     const absl::flat_hash_set<const HloInstruction*>&\n         loop_invariant_instructions,\n-    bool should_add_loop_invariant_op_in_chain,\n-    HloPredicate acceptable_formatting) {\n+    bool should_add_loop_invariant_op_in_chain) {\n   std::vector<HloInstruction*> chain;\n   absl::flat_hash_set<const HloInstruction*> visited_set({instr});\n   std::vector<std::pair<HloInstruction*, int>> stack(1, {instr, 0});\n@@ -550,9 +549,6 @@ std::optional<std::vector<HloInstruction*>> CollectIndependentOperandChain(\n     }\n   }\n   for (auto* chain_instr : chain) {\n-    if (!acceptable_formatting(chain_instr)) {\n-      return std::nullopt;\n-    }\n     // Allow tokens in the chain.\n     if (chain_instr->opcode() == HloOpcode::kAfterAll) {\n       continue;\n@@ -604,15 +600,14 @@ std::optional<std::vector<HloInstruction*>> CollectChainsToPushBackwards(\n     bool should_allow_control_dependencies,\n     const absl::flat_hash_set<const HloInstruction*>&\n         loop_invariant_instructions,\n-    bool should_add_loop_invariant_op_in_chain,\n-    HloPredicate acceptable_formatting) {\n+    bool should_add_loop_invariant_op_in_chain) {\n   if (instr->HasControlDependencies() && !should_allow_control_dependencies) {\n     return std::nullopt;\n   }\n   return CollectIndependentOperandChain(\n       instr, loop_iter, loop_invariant_params,\n       should_allow_loop_variant_parameter_in_chain, loop_invariant_instructions,\n-      should_add_loop_invariant_op_in_chain, acceptable_formatting);\n+      should_add_loop_invariant_op_in_chain);\n }\n \n // Given a dynamic-update-slice find the output index of the loop we feed into.\n@@ -1483,7 +1478,7 @@ void WhileLoopAnalysis::CollectCollectivesToMove(\n           invariant_loop_parameters_,\n           should_allow_loop_variant_parameter_in_chain,\n           should_allow_control_dependencies, invariant_loop_instructions_,\n-          should_add_loop_invariant_op_in_chain, acceptable_formatting);\n+          should_add_loop_invariant_op_in_chain);\n       if (!chain_collected.has_value()) {\n         VLOG(5) << \"Skipping \" << instr->name()\n                 << \" because didn't find compatible slice of parameter\";"
        },
        {
            "sha": "fbd8779fa9a668b6aba8d1fb692060cd27d8ba93",
            "filename": "third_party/xla/xla/service/collective_pipeliner_test.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 69,
            "changes": 69,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b9024cb4f2d6900287ef7c60042937b541e9945e/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b9024cb4f2d6900287ef7c60042937b541e9945e/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcollective_pipeliner_test.cc?ref=b9024cb4f2d6900287ef7c60042937b541e9945e",
            "patch": "@@ -5364,74 +5364,5 @@ ENTRY entry {\n   EXPECT_EQ(fusion_count, 4);\n }\n \n-TEST_F(CollectivePipelinerTest, barrier) {\n-  constexpr absl::string_view hlo_string = R\"(\n-HloModule module\n-\n-while_cond {\n-param = (s32[], bf16[1,8,2048,32768]{3,2,1,0}, bf16[1,8,2048,32768]{3,2,1,0}) parameter(0)\n-gte = s32[] get-tuple-element(param), index=0\n-constant.1 = s32[] constant(3)\n-ROOT cmp = pred[] compare(gte, constant.1), direction=LT\n-}\n-\n-while_body {\n-param = (s32[], bf16[1,8,2048,32768]{3,2,1,0}, bf16[1,8,2048,32768]{3,2,1,0}) parameter(0)\n-get-tuple-element.394 = s32[] get-tuple-element(param), index=0\n-get-tuple-element.395 = bf16[1,8,2048,32768]{3,2,1,0} get-tuple-element(param), index=1\n-get-tuple-element.397 = bf16[1,8,2048,32768]{3,2,1,0} get-tuple-element(param), index=2\n-\n-constant.1 = bf16[] constant(2)\n-broadcast.3593 = bf16[1,8,2048,32768]{3,2,1,0} broadcast(constant.1), dimensions={}\n-\n-add.2 = bf16[1,8,2048,32768]{3,2,1,0} add(broadcast.3593, get-tuple-element.395)\n-tuple.39 = (bf16[1,8,2048,32768]{3,2,1,0}) tuple(add.2)\n-opt-barrier.13 = (bf16[1,8,2048,32768]{3,2,1,0}) opt-barrier(%tuple.39)\n-get-tuple-element.937 = bf16[1,8,2048,32768]{3,2,1,0} get-tuple-element(%opt-barrier.13), index=0\n-\n-all-gather.1 = bf16[1,64,2048,32768]{3,2,1,0} all-gather(get-tuple-element.937), channel_id=1, dimensions={1}, replica_groups={}\n-slice.2 = bf16[1,8,2048,32768]{3,2,1,0} slice(all-gather.1), slice={[0:1], [8:16], [0:2048], [0:32768]}\n-tuple.40 = (bf16[1,8,2048,32768]{3,2,1,0}) tuple(slice.2)\n-opt-barrier.14 = (bf16[1,8,2048,32768]{3,2,1,0}) opt-barrier(tuple.40)\n-get-tuple-element.938 = bf16[1,8,2048,32768]{3,2,1,0} get-tuple-element(opt-barrier.14), index=0\n-\n-constant.2 = s32[] constant(1)\n-add.230 = s32[] add(get-tuple-element.394, constant.2)\n-ROOT tuple = (s32[], bf16[1,8,2048,32768]{3,2,1,0}, bf16[1,8,2048,32768]{3,2,1,0}) tuple(add.230, add.2, get-tuple-element.938)\n-}\n-\n-ENTRY entry {\n-c0 = s32[] constant(0)\n-p0 = bf16[1,8,2048,32768]{3,2,1,0} parameter(0)\n-p1 = bf16[1,8,2048,32768]{3,2,1,0} parameter(1)\n-\n-tuple = (s32[], bf16[1,8,2048,32768]{3,2,1,0}, bf16[1,8,2048,32768]{3,2,1,0}) tuple(c0, p0, p1)\n-while = (s32[], bf16[1,8,2048,32768]{3,2,1,0}, bf16[1,8,2048,32768]{3,2,1,0}) while(tuple), condition=while_cond, body=while_body\n-ROOT gte1 = bf16[1,8,2048,32768]{3,2,1,0} get-tuple-element(while), index=1\n-}\n-)\";\n-\n-  auto module = ParseAndReturnUnverifiedModule(hlo_string, config_).value();\n-\n-  // We don't expect the graph to change as the all-gather has an opt-barrier\n-  // in the producer chain.\n-  EXPECT_FALSE(\n-      RunOptimizer(\n-          module.get(), /*last_run=*/true, 0,\n-          /*pipeline_use_tree=*/false,\n-          /*process_different_sized_ops=*/false,\n-          /*direction=*/\n-          collective_pipeliner_utils::PipeliningDirection::kBackward,\n-          /*should_process=*/IsAllGather,\n-          /*acceptable_formatting=*/\n-          HloPredicateIsNotOp<HloOpcode::kOptimizationBarrier>,\n-          /*reuse_pipelined_op_buffer=*/HloPredicateTrue,\n-          /*should_allow_loop_variant_parameter_in_chain=*/HloPredicateTrue,\n-          /*postprocess_backward_peeled=*/{},\n-          /*postprocess_backward_rotated=*/{},\n-          /*postprocess_backward_peeled_trailing=*/{},\n-          /*should_add_loop_invariant_op_in_chain=*/true)\n-          .value());\n-}\n }  // namespace\n }  // namespace xla"
        },
        {
            "sha": "c619f93e314f9f1b2d5aaaaf6de9b2bc8dccf5a0",
            "filename": "third_party/xla/xla/service/gpu/gpu_compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b9024cb4f2d6900287ef7c60042937b541e9945e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b9024cb4f2d6900287ef7c60042937b541e9945e/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fgpu_compiler.cc?ref=b9024cb4f2d6900287ef7c60042937b541e9945e",
            "patch": "@@ -1046,8 +1046,7 @@ absl::Status RunCollectiveOptimizationPasses(\n         /*pipelining_direction=*/\n         collective_pipeliner_utils::PipeliningDirection::kForward,\n         /*should_process=*/HloPredicateIsOp<HloOpcode::kAllReduce>,\n-        /*acceptable_formatting=*/\n-        HloPredicateIsNotOp<HloOpcode::kOptimizationBarrier>,\n+        /*acceptable_formatting=*/HloPredicateTrue,\n         /*reuse_pipelined_op_buffer=*/HloPredicateFalse,\n         /*should_allow_loop_variant_parameter_in_chain=*/HloPredicateFalse,\n         /*should_allow_control_dependencies=*/false,\n@@ -1070,8 +1069,7 @@ absl::Status RunCollectiveOptimizationPasses(\n         /*pipelining_direction=*/\n         collective_pipeliner_utils::PipeliningDirection::kBackward,\n         /*should_process=*/HloPredicateIsOp<HloOpcode::kAllGather>,\n-        /*acceptable_formatting=*/\n-        HloPredicateIsNotOp<HloOpcode::kOptimizationBarrier>,\n+        /*acceptable_formatting=*/HloPredicateTrue,\n         /*reuse_pipelined_op_buffer=*/HloPredicateFalse,\n         /*should_allow_loop_variant_parameter_in_chain=*/HloPredicateFalse,\n         /*should_allow_control_dependencies=*/false,\n@@ -1094,8 +1092,7 @@ absl::Status RunCollectiveOptimizationPasses(\n         /*pipelining_direction=*/\n         collective_pipeliner_utils::PipeliningDirection::kForward,\n         /*should_process=*/HloPredicateIsOp<HloOpcode::kReduceScatter>,\n-        /*acceptable_formatting=*/\n-        HloPredicateIsNotOp<HloOpcode::kOptimizationBarrier>,\n+        /*acceptable_formatting=*/HloPredicateTrue,\n         /*reuse_pipelined_op_buffer=*/HloPredicateFalse,\n         /*should_allow_loop_variant_parameter_in_chain=*/HloPredicateFalse,\n         /*should_allow_control_dependencies=*/false,"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 7,
        "deletions": 84
    }
}