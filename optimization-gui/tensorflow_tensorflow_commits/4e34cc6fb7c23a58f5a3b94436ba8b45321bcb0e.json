{
    "author": "tensorflower-gardener",
    "message": "[XLA:GPU] Support partitioned across replicas modules\n\nPiperOrigin-RevId: 846238886",
    "sha": "4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e",
    "files": [
        {
            "sha": "e845aed3cc5b42611f17fb7697ada7458c1fe079",
            "filename": "third_party/xla/xla/backends/gpu/runtime/collective_metadata_thunk.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_metadata_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_metadata_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fruntime%2Fcollective_metadata_thunk.cc?ref=4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e",
            "patch": "@@ -72,8 +72,8 @@ CollectiveConfig CollectiveMetadataThunk::GetCollectiveConfig(\n     }\n   }\n \n-  config.group_mode =\n-      CollectiveOpGroupMode::COLLECTIVE_OP_GROUP_MODE_CROSS_REPLICA;\n+  config.group_mode = CollectiveOpGroupMode::\n+      COLLECTIVE_OP_GROUP_MODE_CROSS_REPLICA_AND_PARTITION;\n \n   return config;\n }"
        },
        {
            "sha": "836b0157f1bba4fc729ec291cf3dd16f894fd38c",
            "filename": "third_party/xla/xla/tests/collective_metadata_test.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_metadata_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_metadata_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftests%2Fcollective_metadata_test.cc?ref=4e34cc6fb7c23a58f5a3b94436ba8b45321bcb0e",
            "patch": "@@ -107,6 +107,47 @@ TEST_F(CollectiveMetadataTest, ConstructCollectiveMetadata) {\n   }\n }\n \n+TEST_F(CollectiveMetadataTest, ConstructCollectiveMetadataForPartitions) {\n+  const absl::string_view kModuleStr = R\"(\n+  HloModule test, allow_spmd_sharding_propagation_to_parameters={true}, allow_spmd_sharding_propagation_to_output={true}, num_partitions=2\n+\n+  ENTRY test_computation {\n+    param_0 = f32[4] parameter(0)\n+    param_1 = f32[4] parameter(1)\n+\n+    const_0 = f32[1] constant({10})\n+\n+    result_tuple = (f32[4], f32[4]{0}, f32[1], u64[9]) custom-call(param_0, param_1, const_0), custom_call_target=\"CollectiveMetadata\", output_to_operand_aliasing={{0}: (0, {}), {1}: (1, {})}\n+    ROOT get_tuple_element = u64[9] get-tuple-element(result_tuple), index=3\n+  })\";\n+\n+  constexpr int kNumPartitions = 2;\n+  ASSERT_GE(hlo_runner_->device_count(), kNumPartitions)\n+      << \"Test requires at least \" << kNumPartitions << \" devices (\"\n+      << hlo_runner_->device_count() << \" available)\";\n+\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      auto unoptimized_module,\n+      ParseAndReturnVerifiedModule(kModuleStr, /*replica_count=*/1,\n+                                   /*num_partitions=*/kNumPartitions));\n+\n+  Literal input_0 = LiteralUtil::CreateR1<float>({1.0f, 2.0f, 3.0f, 4.0f});\n+  Literal input_1 = LiteralUtil::CreateR1<float>({1.0f, 2.0f, 3.0f, 4.0f});\n+  TF_ASSERT_OK_AND_ASSIGN(\n+      ExecutionResult execution_result,\n+      ExecuteReplicated(std::move(unoptimized_module),\n+                        /*arguments=*/std::vector<Literal*>{&input_0, &input_1},\n+                        /*run_hlo_passes=*/false));\n+  const std::vector<Literal>& result = execution_result.results;\n+  ASSERT_EQ(result.size(), kNumPartitions);\n+\n+  absl::Span<const uint64_t> first_result_data = result[0].data<uint64_t>();\n+  absl::Span<const uint64_t> second_result_data = result[1].data<uint64_t>();\n+  constexpr int kNumElements = 9;\n+  ASSERT_EQ(first_result_data.size(), kNumElements);\n+  ASSERT_EQ(second_result_data.size(), kNumElements);\n+}\n+\n TEST_F(CollectiveMetadataTest, BuildMultimemOnlyOncePerModuleExecution) {\n   const absl::string_view kModuleStr = R\"(\n   HloModule test, replica_count=2"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 43,
        "deletions": 2
    }
}