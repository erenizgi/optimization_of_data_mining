{
    "author": "hhb",
    "message": "Add `PjRtDeviceDimensions` struct and proto.\n\nPiperOrigin-RevId: 820440467",
    "sha": "c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
    "files": [
        {
            "sha": "19e87152ef84aa1d3f8c9f28e7ea410438336887",
            "filename": "third_party/xla/xla/pjrt/BUILD",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2FBUILD?ref=c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
            "patch": "@@ -369,6 +369,34 @@ cc_library(\n     alwayslink = 1,\n )\n \n+cc_library(\n+    name = \"pjrt_device_dimensions\",\n+    srcs = [\"pjrt_device_dimensions.cc\"],\n+    hdrs = [\"pjrt_device_dimensions.h\"],\n+    visibility = internal_visibility([\"//xla:friends\"]),\n+    deps = [\n+        \"//xla/pjrt/proto:pjrt_device_dimensions_proto_cc\",\n+        \"@com_google_absl//absl/container:inlined_vector\",\n+        \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:statusor\",\n+        \"@com_google_absl//absl/strings\",\n+        \"@com_google_absl//absl/strings:str_format\",\n+        \"@com_google_absl//absl/types:span\",\n+    ],\n+)\n+\n+xla_cc_test(\n+    name = \"pjrt_device_dimensions_test\",\n+    srcs = [\"pjrt_device_dimensions_test.cc\"],\n+    deps = [\n+        \":pjrt_device_dimensions\",\n+        \"//xla/pjrt/proto:pjrt_device_dimensions_proto_cc\",\n+        \"//xla/tsl/platform:statusor\",\n+        \"@com_google_absl//absl/container:flat_hash_set\",\n+        \"@com_google_googletest//:gtest_main\",\n+    ],\n+)\n+\n cc_library(\n     name = \"pjrt_executable\",\n     srcs = [\"pjrt_executable.cc\"],"
        },
        {
            "sha": "16e78be6d062e465d1e9a92a865ea02b9e2905c5",
            "filename": "third_party/xla/xla/pjrt/pjrt_device_dimensions.cc",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions.cc?ref=c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
            "patch": "@@ -0,0 +1,83 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/pjrt/pjrt_device_dimensions.h\"\n+\n+#include <cstdint>\n+#include <string>\n+#include <vector>\n+\n+#include \"absl/container/inlined_vector.h\"\n+#include \"absl/status/status.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/numbers.h\"\n+#include \"absl/strings/str_format.h\"\n+#include \"absl/strings/str_join.h\"\n+#include \"absl/strings/str_split.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"absl/types/span.h\"\n+\n+namespace xla {\n+\n+PjRtDeviceDimensionsProto PjRtDeviceDimensions::ToProto() const {\n+  PjRtDeviceDimensionsProto proto;\n+  for (int32_t dim : dimensions_) {\n+    proto.add_dimensions(dim);\n+  }\n+  return proto;\n+}\n+\n+std::string PjRtDeviceDimensions::ToString(absl::string_view sep) const {\n+  return absl::StrJoin(dimensions_, sep);\n+}\n+\n+absl::StatusOr<PjRtDeviceDimensions> PjRtDeviceDimensions::FromString(\n+    absl::string_view text) {\n+  if (text.empty()) {\n+    return PjRtDeviceDimensions({});\n+  }\n+  std::vector<std::string> bounds_str = absl::StrSplit(text, ',');\n+\n+  absl::InlinedVector<int32_t, 3> dims;\n+  for (auto const& b : bounds_str) {\n+    int32_t bound;\n+    if (!absl::SimpleAtoi(b, &bound)) {\n+      return absl::InvalidArgumentError(\n+          absl::StrFormat(\"Number parsing error for pjrt device dimensions %s \"\n+                          \"while parsing %s.\",\n+                          text, b));\n+    }\n+    dims.push_back(bound);\n+  }\n+\n+  return PjRtDeviceDimensions(dims);\n+}\n+\n+bool AbslParseFlag(absl::string_view text, PjRtDeviceDimensions* bounds,\n+                   std::string* err) {\n+  const auto status_or_dimensions = PjRtDeviceDimensions::FromString(text);\n+  if (!status_or_dimensions.ok()) {\n+    *err = status_or_dimensions.status().ToString();\n+    return false;\n+  }\n+  *bounds = status_or_dimensions.value();\n+  return true;\n+}\n+\n+std::string AbslUnparseFlag(PjRtDeviceDimensions bounds) {\n+  return bounds.ToString();\n+}\n+\n+}  // namespace xla"
        },
        {
            "sha": "f6b2e4fcf46956871078616391ee0eb8186817ff",
            "filename": "third_party/xla/xla/pjrt/pjrt_device_dimensions.h",
            "status": "added",
            "additions": 91,
            "deletions": 0,
            "changes": 91,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions.h?ref=c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
            "patch": "@@ -0,0 +1,91 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_PJRT_PJRT_DEVICE_DIMENSIONS_H_\n+#define XLA_PJRT_PJRT_DEVICE_DIMENSIONS_H_\n+\n+#include <cstddef>\n+#include <cstdint>\n+#include <initializer_list>\n+#include <ostream>\n+#include <string>\n+#include <utility>\n+\n+#include \"absl/container/inlined_vector.h\"\n+#include \"absl/status/statusor.h\"\n+#include \"absl/strings/string_view.h\"\n+#include \"absl/types/span.h\"\n+#include \"xla/pjrt/proto/pjrt_device_dimensions.pb.h\"\n+\n+namespace xla {\n+\n+// Represents device dimensions (e.g., mesh bounds or chip coordinates).\n+class PjRtDeviceDimensions {\n+ public:\n+  PjRtDeviceDimensions() = default;\n+  PjRtDeviceDimensions(std::initializer_list<int32_t> dims)\n+      : dimensions_(dims) {}\n+  explicit PjRtDeviceDimensions(absl::Span<const int32_t> dims)\n+      : dimensions_(dims.begin(), dims.end()) {}\n+\n+  int32_t& operator[](size_t i) { return dimensions_[i]; }\n+  const int32_t& operator[](size_t i) const { return dimensions_[i]; }\n+\n+  size_t size() const { return dimensions_.size(); }\n+\n+  friend bool operator==(const PjRtDeviceDimensions& a,\n+                         const PjRtDeviceDimensions& b) {\n+    return a.dimensions_ == b.dimensions_;\n+  }\n+\n+  friend bool operator!=(const PjRtDeviceDimensions& a,\n+                         const PjRtDeviceDimensions& b) {\n+    return !(a == b);\n+  }\n+\n+  friend std::ostream& operator<<(std::ostream& os,\n+                                  const PjRtDeviceDimensions& d) {\n+    return os << d.ToString();\n+  }\n+\n+  template <typename H>\n+  friend H AbslHashValue(H h, const PjRtDeviceDimensions& c) {\n+    return H::combine(std::move(h), c.dimensions_);\n+  }\n+\n+  static absl::StatusOr<PjRtDeviceDimensions> FromProto(\n+      const PjRtDeviceDimensionsProto& proto) {\n+    return PjRtDeviceDimensions(proto.dimensions());\n+  }\n+\n+  PjRtDeviceDimensionsProto ToProto() const;\n+\n+  std::string ToString(absl::string_view sep = \",\") const;\n+\n+  static absl::StatusOr<PjRtDeviceDimensions> FromString(\n+      absl::string_view text);\n+\n+ private:\n+  absl::InlinedVector<int32_t, 3> dimensions_;\n+};\n+\n+// Support for absl flags.\n+bool AbslParseFlag(absl::string_view text, PjRtDeviceDimensions* bounds,\n+                   std::string* err);\n+std::string AbslUnparseFlag(PjRtDeviceDimensions bounds);\n+\n+}  // namespace xla\n+\n+#endif  // XLA_PJRT_PJRT_DEVICE_DIMENSIONS_H_"
        },
        {
            "sha": "3dbadab65a5779585acecfc354c86e827eea3cd3",
            "filename": "third_party/xla/xla/pjrt/pjrt_device_dimensions_test.cc",
            "status": "added",
            "additions": 129,
            "deletions": 0,
            "changes": 129,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fpjrt_device_dimensions_test.cc?ref=c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
            "patch": "@@ -0,0 +1,129 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/pjrt/pjrt_device_dimensions.h\"\n+\n+#include <sstream>\n+#include <string>\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/container/flat_hash_set.h\"\n+#include \"xla/pjrt/proto/pjrt_device_dimensions.pb.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n+\n+namespace xla {\n+namespace {\n+\n+using ::testing::HasSubstr;\n+\n+TEST(PjRtDeviceDimensionsTest, Equality) {\n+  EXPECT_EQ((PjRtDeviceDimensions{1, 2, 3}), (PjRtDeviceDimensions{1, 2, 3}));\n+  EXPECT_NE((PjRtDeviceDimensions{1, 2, 3}), (PjRtDeviceDimensions{1, 2, 4}));\n+}\n+\n+TEST(PjRtDeviceDimensionsTest, Ostream) {\n+  std::stringstream ss;\n+  ss << PjRtDeviceDimensions{1, 2, 3};\n+  EXPECT_EQ(ss.str(), \"1,2,3\");\n+}\n+\n+TEST(PjRtDeviceDimensionsTest, AbslHashValue) {\n+  absl::flat_hash_set<PjRtDeviceDimensions> hash_set;\n+  hash_set.insert({1, 2, 3});\n+  hash_set.insert({0, 0, 0});\n+  hash_set.insert({1, 2, 3});  // Inserting again should not change size\n+\n+  EXPECT_EQ(hash_set.size(), 2);\n+  EXPECT_TRUE(hash_set.contains({1, 2, 3}));\n+  EXPECT_TRUE(hash_set.contains({0, 0, 0}));\n+  EXPECT_FALSE(hash_set.contains({1, 2, 4}));\n+}\n+\n+TEST(PjRtDeviceDimensionsTest, FromProto) {\n+  PjRtDeviceDimensionsProto proto;\n+  proto.add_dimensions(1);\n+  proto.add_dimensions(2);\n+  proto.add_dimensions(3);\n+  TF_ASSERT_OK_AND_ASSIGN(PjRtDeviceDimensions dims,\n+                          PjRtDeviceDimensions::FromProto(proto));\n+  EXPECT_EQ(dims, PjRtDeviceDimensions({1, 2, 3}));\n+}\n+\n+TEST(PjRtDeviceDimensionsTest, ToProto) {\n+  PjRtDeviceDimensions bounds = {1, 2, 3};\n+  PjRtDeviceDimensionsProto proto = bounds.ToProto();\n+  EXPECT_THAT(proto.dimensions(), testing::ElementsAre(1, 2, 3));\n+}\n+\n+TEST(AbslParseFlagTest, ValidInputs) {\n+  PjRtDeviceDimensions bounds;\n+  std::string err;\n+\n+  EXPECT_TRUE(AbslParseFlag(\"1,2,3\", &bounds, &err));\n+  EXPECT_EQ(bounds, (PjRtDeviceDimensions{1, 2, 3}));\n+  EXPECT_EQ(err, \"\");\n+\n+  EXPECT_TRUE(AbslParseFlag(\"1,2\", &bounds, &err));\n+  EXPECT_EQ(bounds, (PjRtDeviceDimensions{1, 2}));\n+  EXPECT_EQ(err, \"\");\n+\n+  EXPECT_TRUE(AbslParseFlag(\"1,2,3,4\", &bounds, &err));\n+  EXPECT_EQ(bounds, (PjRtDeviceDimensions{1, 2, 3, 4}));\n+  EXPECT_EQ(err, \"\");\n+\n+  EXPECT_TRUE(AbslParseFlag(\"\", &bounds, &err));\n+  EXPECT_EQ(bounds, (PjRtDeviceDimensions{}));\n+  EXPECT_EQ(err, \"\");\n+}\n+\n+TEST(AbslParseFlagTest, InvalidInputs) {\n+  PjRtDeviceDimensions bounds;\n+  std::string err;\n+\n+  EXPECT_FALSE(AbslParseFlag(\"1,a,3\", &bounds, &err));\n+  EXPECT_THAT(err, HasSubstr(\"Number parsing error\"));\n+\n+  EXPECT_FALSE(AbslParseFlag(\"1,2.5,3\", &bounds, &err));\n+  EXPECT_THAT(err, HasSubstr(\"Number parsing error\"));\n+}\n+\n+TEST(AbslUnparseFlagTest, ConvertsCorrectly) {\n+  EXPECT_EQ(AbslUnparseFlag(PjRtDeviceDimensions{1, 2, 3}), \"1,2,3\");\n+  EXPECT_EQ(AbslUnparseFlag(PjRtDeviceDimensions{0, 0, 0}), \"0,0,0\");\n+}\n+\n+TEST(PjRtDeviceDimensionsTest, SubscriptAccess) {\n+  PjRtDeviceDimensions dims = {10, 20, 30};\n+  EXPECT_EQ(dims[0], 10);\n+  EXPECT_EQ(dims[1], 20);\n+  EXPECT_EQ(dims[2], 30);\n+\n+  dims[1] = 25;\n+  EXPECT_EQ(dims[1], 25);\n+  EXPECT_EQ(dims, (PjRtDeviceDimensions{10, 25, 30}));\n+\n+  const PjRtDeviceDimensions const_dims = {1, 2, 3};\n+  EXPECT_EQ(const_dims[0], 1);\n+}\n+\n+TEST(PjRtDeviceDimensionsTest, Size) {\n+  EXPECT_EQ((PjRtDeviceDimensions{1, 2, 3}).size(), 3);\n+  EXPECT_EQ((PjRtDeviceDimensions{1, 2}).size(), 2);\n+  EXPECT_EQ((PjRtDeviceDimensions{}).size(), 0);\n+}\n+\n+}  // namespace\n+}  // namespace xla"
        },
        {
            "sha": "32e6cb28ba0823984fa0d7896ad9bbdd050d8e8d",
            "filename": "third_party/xla/xla/pjrt/proto/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2FBUILD?ref=c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
            "patch": "@@ -41,6 +41,13 @@ tf_proto_library(\n     visibility = [\"//visibility:public\"],\n )\n \n+tf_proto_library(\n+    name = \"pjrt_device_dimensions_proto\",\n+    srcs = [\"pjrt_device_dimensions.proto\"],\n+    compatible_with = (get_compatible_with_libtpu_portable() + get_compatible_with_portable()),\n+    visibility = [\"//visibility:public\"],\n+)\n+\n tf_proto_library(\n     name = \"pjrt_value_type_proto\",\n     srcs = [\"pjrt_value_type.proto\"],"
        },
        {
            "sha": "c37e2663a67f4f5f0904ceb9bc7817f4eca1a02f",
            "filename": "third_party/xla/xla/pjrt/proto/pjrt_device_dimensions.proto",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fpjrt_device_dimensions.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fpjrt_device_dimensions.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fproto%2Fpjrt_device_dimensions.proto?ref=c3ce8a9881f48c00aa73e9b5b93c115e7d0b3036",
            "patch": "@@ -0,0 +1,10 @@\n+edition = \"2023\";\n+\n+package xla;\n+\n+option features.field_presence = IMPLICIT;\n+option java_multiple_files = true;\n+\n+message PjRtDeviceDimensionsProto {\n+  repeated int32 dimensions = 1;\n+}"
        }
    ],
    "stats": {
        "total": 348,
        "additions": 348,
        "deletions": 0
    }
}