{
    "author": "GleasonK",
    "message": "[StableHLO] Add transpose simplification\n\nPiperOrigin-RevId: 820804015",
    "sha": "46522b8a207b1722207821fa2ca017f559683ea8",
    "files": [
        {
            "sha": "8949936ee35ae38e7c68004a40bdcfa072917dfc",
            "filename": "third_party/xla/third_party/stablehlo/temporary.patch",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/46522b8a207b1722207821fa2ca017f559683ea8/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/46522b8a207b1722207821fa2ca017f559683ea8/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fthird_party%2Fstablehlo%2Ftemporary.patch?ref=46522b8a207b1722207821fa2ca017f559683ea8",
            "patch": "@@ -863,6 +863,25 @@ diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_folder.ml\n  }\n  \n  // -----\n+diff --ruN a/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir b/stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir\n+--- stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir\n++++ stablehlo/stablehlo/tests/transforms/stablehlo_aggressive_simplification.mlir\n+@@ -1810,6 +1810,15 @@\n+   return %0 : tensor<2x4x1x5xf32>\n+ }\n+ \n++// CHECK-LABEL: @transpose_of_transpose\n++func.func @transpose_of_transpose(%arg0 : tensor<1x2x3x4xf32>) -> tensor<1x2x3x4xf32> {\n++  %0 = stablehlo.transpose %arg0, dims = [3,2,1,0] : (tensor<1x2x3x4xf32>) -> tensor<4x3x2x1xf32>\n++  %1 = stablehlo.transpose %0, dims = [3,2,1,0] : (tensor<4x3x2x1xf32>) -> tensor<1x2x3x4xf32>\n++  // CHECK-NOT: stablehlo.transpose\n++  // CHECK: return %arg0\n++  return %1 : tensor<1x2x3x4xf32>\n++}\n++\n+ // -----\n+ \n+ ////////\n diff --ruN a/stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp b/stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp\n --- stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp\n +++ stablehlo/stablehlo/transforms/ChloLegalizeToStablehlo.cpp\n@@ -1541,4 +1560,47 @@ diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimp\n      permutation[dims[i]] = i;\n    }\n    return b.getDenseI64ArrayAttr(permutation);\n+@@ -1308,6 +1308,17 @@\n+ //////////////////////////////////\n+ // TransposeOp\n+ /////////////////////////////////\n++\n++DenseI64ArrayAttr getMergedTransposePermutation(OpBuilder& b,\n++                                                ArrayRef<int64_t> childPerm,\n++                                                ArrayRef<int64_t> parentPerm) {\n++  SmallVector<int64_t> mergedPerm;\n++  mergedPerm.reserve(parentPerm.size());\n++  for (int64_t parentIdx : parentPerm) {\n++    mergedPerm.push_back(childPerm[parentIdx]);\n++  }\n++  return b.getDenseI64ArrayAttr(mergedPerm);\n++}\n+ \n+ // Pattern: transpose(X, [no_mem_layout_change...]) -> reshape(X)\n+ struct TransposeIsReshape final : SimplifyOpRewritePattern<TransposeOp> {\n+diff --ruN a/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td b/stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td\n+--- stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td\n++++ stablehlo/stablehlo/transforms/optimization/StablehloAggressiveSimplificationPatterns.td\n+@@ -119,6 +119,8 @@\n+ def InvertBroadcastDims : NativeCodeCall<\"getInvertedBroadcastDimensions($_builder, $0)\">;\n+ \n+ def MergeBroadcastDims : NativeCodeCall<\"getMergedBroadcastDimensions($_builder, $0, $1)\">;\n++\n++def MergePermutations : NativeCodeCall<\"getMergedTransposePermutation($_builder, $0, $1)\">;\n+ \n+ def StableHLO_ConvertOpWithShape : NativeCodeCall<\n+     \"$_builder.create<stablehlo::ConvertOp>($_loc, $0.getType(), $1)\">;\n+@@ -539,6 +541,12 @@\n+   : Pat<(StableHLO_TransposeOp $lhs, IotaDims:$dims),\n+         (replaceWithValue $lhs)>;\n+ \n++// Pattern: transpose(transpose(X)) -> transpose(X)\n++def TransposeOp_TransposeOfTranspose\n++  : Pat<(StableHLO_TransposeOp\n++          (StableHLO_TransposeOp $child, $child_dims), $dims),\n++        (StableHLO_TransposeOp $child, (MergePermutations $child_dims, $dims))>;\n++\n+ ////////\n+ // GetTupleElementOp\n+ \n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 62,
        "deletions": 0
    }
}