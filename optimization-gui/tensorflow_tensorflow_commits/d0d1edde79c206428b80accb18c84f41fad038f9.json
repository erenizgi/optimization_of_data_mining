{
    "author": "matthiaskramm",
    "message": "(Re-)add GPU test for GetDefaultLayout.\n\nPiperOrigin-RevId: 800964591",
    "sha": "d0d1edde79c206428b80accb18c84f41fad038f9",
    "files": [
        {
            "sha": "d93ee3bb3d4943cd4fd1084a6359f1ae4adea747",
            "filename": "third_party/xla/xla/pjrt/c/pjrt_c_api_gpu_test.cc",
            "status": "modified",
            "additions": 75,
            "deletions": 1,
            "changes": 76,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/d0d1edde79c206428b80accb18c84f41fad038f9/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_gpu_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/d0d1edde79c206428b80accb18c84f41fad038f9/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_gpu_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fc%2Fpjrt_c_api_gpu_test.cc?ref=d0d1edde79c206428b80accb18c84f41fad038f9",
            "patch": "@@ -32,7 +32,9 @@ limitations under the License.\n #include <gtest/gtest.h>\n #include \"absl/container/flat_hash_map.h\"\n #include \"absl/log/check.h\"\n+#include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n+#include \"absl/status/status_matchers.h\"\n #include \"absl/status/statusor.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n@@ -49,6 +51,7 @@ limitations under the License.\n #include \"xla/pjrt/c/pjrt_c_api_gpu_extension.h\"\n #include \"xla/pjrt/c/pjrt_c_api_gpu_internal.h\"\n #include \"xla/pjrt/c/pjrt_c_api_helpers.h\"\n+#include \"xla/pjrt/c/pjrt_c_api_layouts_extension.h\"\n #include \"xla/pjrt/c/pjrt_c_api_test.h\"\n #include \"xla/pjrt/c/pjrt_c_api_test_base.h\"\n #include \"xla/pjrt/c/pjrt_c_api_triton_extension.h\"\n@@ -76,7 +79,6 @@ namespace {\n using ::testing::ElementsAreArray;\n using ::testing::HasSubstr;\n using ::testing::IsNull;\n-using ::tsl::testing::StatusIs;\n \n #ifdef TENSORFLOW_USE_ROCM\n const bool kUnused = (RegisterPjRtCApiTestFactory([]() { return GetPjrtApi(); },\n@@ -965,6 +967,78 @@ TEST(PJRTGpuDeviceTopologyTest, CreateExplicitGpuTopology) {\n   EXPECT_EQ(destroy_error, nullptr) << destroy_error->status.message();\n }\n \n+TEST(PJRTGpuDeviceTopologyTest, GetDefaultLayout) {\n+  auto pjrt_api = gpu_plugin::GetGpuPjrtApi();\n+\n+  PJRT_TopologyDescription_Create_Args create_args;\n+  create_args.struct_size = PJRT_TopologyDescription_Create_Args_STRUCT_SIZE;\n+  create_args.extension_start = nullptr;\n+  create_args.topology = nullptr;\n+  create_args.num_options = 0;\n+  create_args.create_options = nullptr;\n+\n+  PJRT_Error* error = pjrt_api->PJRT_TopologyDescription_Create(&create_args);\n+  EXPECT_EQ(error, nullptr) << error->status.message();\n+  auto* pjrt_topology =\n+      reinterpret_cast<PJRT_TopologyDescription*>(create_args.topology);\n+  ASSERT_NE(pjrt_topology, nullptr);\n+\n+  const PJRT_Layouts_Extension* layouts_extension =\n+      pjrt::FindExtension<PJRT_Layouts_Extension>(\n+          pjrt_api, PJRT_Extension_Type::PJRT_Extension_Type_Layouts);\n+  ASSERT_NE(layouts_extension, nullptr);\n+  ASSERT_NE(layouts_extension->PJRT_Layouts_PJRT_Topology_GetDefaultLayout,\n+            nullptr);\n+\n+  PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args layout_args;\n+  layout_args.struct_size =\n+      PJRT_Layouts_PJRT_Topology_GetDefaultLayout_Args_STRUCT_SIZE;\n+  layout_args.extension_start = nullptr;\n+  layout_args.topology_description = pjrt_topology;\n+  layout_args.type = PJRT_Buffer_Type::PJRT_Buffer_Type_F32;\n+  int64_t dims[] = {2, 3};\n+  layout_args.dims = dims;\n+  layout_args.num_dims = 2;\n+  layout_args.layout = nullptr;\n+\n+  error = layouts_extension->PJRT_Layouts_PJRT_Topology_GetDefaultLayout(\n+      &layout_args);\n+  EXPECT_EQ(error, nullptr);\n+  ASSERT_NE(layout_args.layout, nullptr);\n+\n+  PJRT_Layouts_MemoryLayout_Serialize_Args serialize_args;\n+  serialize_args.extension_start = nullptr;\n+  serialize_args.struct_size =\n+      PJRT_Layouts_MemoryLayout_Serialize_Args_STRUCT_SIZE;\n+  serialize_args.layout = layout_args.layout;\n+  error = PJRT_Layouts_MemoryLayout_Serialize(&serialize_args);\n+  EXPECT_EQ(error, nullptr);\n+  std::string serialized(serialize_args.serialized_bytes,\n+                         serialize_args.serialized_bytes_size);\n+  EXPECT_EQ(serialized, \"{1,0}\");\n+\n+  if (serialize_args.serialized_layout_deleter) {\n+    serialize_args.serialized_layout_deleter(serialize_args.serialized_layout);\n+  }\n+\n+  PJRT_Layouts_MemoryLayout_Destroy_Args destroy_layout_args;\n+  destroy_layout_args.struct_size =\n+      PJRT_Layouts_MemoryLayout_Destroy_Args_STRUCT_SIZE;\n+  destroy_layout_args.extension_start = nullptr;\n+  destroy_layout_args.layout = layout_args.layout;\n+  error = layouts_extension->PJRT_Layouts_MemoryLayout_Destroy(\n+      &destroy_layout_args);\n+  EXPECT_EQ(error, nullptr);\n+\n+  PJRT_TopologyDescription_Destroy_Args destroy_args;\n+  destroy_args.struct_size = PJRT_TopologyDescription_Destroy_Args_STRUCT_SIZE;\n+  destroy_args.extension_start = nullptr;\n+  destroy_args.topology = pjrt_topology;\n+  PJRT_Error* destroy_error =\n+      pjrt_api->PJRT_TopologyDescription_Destroy(&destroy_args);\n+  EXPECT_EQ(destroy_error, nullptr) << destroy_error->status.message();\n+}\n+\n void TestCustomCallV2() {}\n \n TEST(PjrtCApiGpuExtensionTest, CustomCallUntyped) {"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 75,
        "deletions": 1
    }
}