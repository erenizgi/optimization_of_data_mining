{
    "author": "ezhulenev",
    "message": "[xla:cpu] Add AllReduceCombiner pass to cpu compiler pipeline\n\nPiperOrigin-RevId: 799247330",
    "sha": "3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53",
    "files": [
        {
            "sha": "3afcf1b01624f0fa4ad5780c23c96e7c9a319c11",
            "filename": "third_party/xla/xla/service/cpu/BUILD",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2FBUILD?ref=3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53",
            "patch": "@@ -238,6 +238,7 @@ cc_library(\n         \"//xla/backends/cpu/runtime:thunk_proto_serdes\",\n         \"//xla/backends/cpu/transforms:dot_library_rewriter\",\n         \"//xla/backends/cpu/transforms:xnn_graph_fusion\",\n+        \"//xla/backends/cpu/transforms/collectives:all_reduce_combiner\",\n         \"//xla/hlo/analysis:alias_info\",\n         \"//xla/hlo/analysis:hlo_ordering\",\n         \"//xla/hlo/analysis:indexed_array_analysis\","
        },
        {
            "sha": "a5a862f14c0ee9be6335b7054d540a1f29a38f8f",
            "filename": "third_party/xla/xla/service/cpu/cpu_compiler.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fcpu%2Fcpu_compiler.cc?ref=3947e53bcd1cabfe8a3a98399a1ac3e9c0488e53",
            "patch": "@@ -20,6 +20,7 @@ limitations under the License.\n #include <cstdint>\n #include <cstring>\n #include <functional>\n+#include <limits>\n #include <memory>\n #include <optional>\n #include <stack>\n@@ -95,6 +96,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk.pb.h\"\n #include \"xla/backends/cpu/runtime/thunk_proto_serdes.h\"\n+#include \"xla/backends/cpu/transforms/collectives/all_reduce_combiner.h\"\n #include \"xla/backends/cpu/transforms/dot_library_rewriter.h\"\n #include \"xla/backends/cpu/transforms/xnn_graph_fusion.h\"\n #include \"xla/backends/cpu/xnn_support.h\"\n@@ -927,6 +929,12 @@ absl::Status CpuCompiler::RunHloPassesAfterLayoutAssn(\n     pipeline.AddPass<CallInliner>(/*single_call_site=*/true);\n   }\n \n+  // Combine collective operations to maximize network bandwidth usage.\n+  constexpr int64_t kCombineBytes = std::numeric_limits<int64_t>::max();\n+  constexpr int64_t kCombineCount = 256;\n+  pipeline.AddPass<CpuAllReduceCombiner>(kCombineBytes, kCombineCount);\n+  pipeline.AddPass<TupleSimplifier>();\n+\n   // The LayoutAssignment pass may leave behind kCopy instructions which are\n   // duplicate or NOPs, so remove them with algebraic simplification and CSE.\n   // Run this to a fixed point."
        }
    ],
    "stats": {
        "total": 9,
        "additions": 9,
        "deletions": 0
    }
}