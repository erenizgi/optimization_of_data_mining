{
    "author": "ermilovmaxim",
    "message": "Port ConditionalThunk/WhileThunk to provide shape for BufferUse\n\nPiperOrigin-RevId: 834846503",
    "sha": "64d18885d50befe555ad3205960da627ac14fcaf",
    "files": [
        {
            "sha": "bbff542362030171104dde06040180e30cdfefdc",
            "filename": "third_party/xla/xla/backends/cpu/runtime/BUILD",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2FBUILD?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -325,6 +325,7 @@ cc_library(\n     deps = [\n         \":thunk\",\n         \":thunk_executor\",\n+        \"//xla:shape_util\",\n         \"//xla:util\",\n         \"//xla/runtime:buffer_use\",\n         \"//xla/service:buffer_assignment\",\n@@ -346,6 +347,7 @@ xla_cc_test(\n         \":conditional_thunk\",\n         \":thunk\",\n         \":thunk_testlib\",\n+        \"//xla:shape_util\",\n         \"//xla/runtime:buffer_use\",\n         \"//xla/runtime:resource_use\",\n         \"//xla/service:buffer_assignment\",\n@@ -1140,6 +1142,8 @@ cc_library(\n         \":buffer_allocations\",\n         \":thunk\",\n         \":thunk_executor\",\n+        \"//xla:shape_util\",\n+        \"//xla:util\",\n         \"//xla/runtime:buffer_use\",\n         \"//xla/service:buffer_assignment\",\n         \"//xla/stream_executor:device_memory\",\n@@ -1165,6 +1169,7 @@ xla_cc_test(\n         \":thunk_testlib\",\n         \":while_thunk\",\n         \"//xla:literal_util\",\n+        \"//xla:shape_util\",\n         \"//xla/runtime:buffer_use\",\n         \"//xla/runtime:resource_use\",\n         \"//xla/service:buffer_assignment\","
        },
        {
            "sha": "22b7d01cc229062bbfd1de023b984547525b63b7",
            "filename": "third_party/xla/xla/backends/cpu/runtime/conditional_thunk.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 11,
            "changes": 48,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk.cc?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -31,12 +31,36 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n #include \"xla/runtime/buffer_use.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/util.h\"\n \n namespace xla::cpu {\n+namespace {\n+\n+absl::StatusOr<Shape> ShapeForBranchIndexBuffer(\n+    BufferAllocation::Slice& branch_index_buffer) {\n+  // See operation semantics documentation:\n+  // https://openxla.org/xla/operation_semantics#conditional\n+\n+  // Branch index is pred[].\n+  if (branch_index_buffer.size() == sizeof(bool)) {\n+    return ShapeUtil::MakeShape(PRED, {1});\n+  }\n+\n+  // Branch index is s32[].\n+  if (branch_index_buffer.size() == sizeof(int32_t)) {\n+    return ShapeUtil::MakeShape(S32, {1});\n+  }\n+\n+  return Internal(\"Unsupported branch index buffer size %d\",\n+                  branch_index_buffer.size());\n+}\n+\n+}  // namespace\n \n absl::StatusOr<std::unique_ptr<ConditionalThunk>> ConditionalThunk::Create(\n     Info info, BufferAllocation::Slice branch_index_buffer,\n@@ -48,16 +72,22 @@ absl::StatusOr<std::unique_ptr<ConditionalThunk>> ConditionalThunk::Create(\n                         ThunkExecutor::Create(std::move(branch_sequence)));\n     branch_executors.push_back(std::move(branch_executor));\n   }\n-  return absl::WrapUnique(new ConditionalThunk(std::move(info),\n-                                               std::move(branch_index_buffer),\n-                                               std::move(branch_executors)));\n+\n+  TF_ASSIGN_OR_RETURN(Shape shape,\n+                      ShapeForBranchIndexBuffer(branch_index_buffer));\n+\n+  return absl::WrapUnique(\n+      new ConditionalThunk(std::move(info), std::move(branch_index_buffer),\n+                           shape, std::move(branch_executors)));\n }\n \n ConditionalThunk::ConditionalThunk(Info info,\n                                    BufferAllocation::Slice branch_index_buffer,\n+                                   Shape branch_index_buffer_shape,\n                                    std::vector<ThunkExecutor> branch_executors)\n     : Thunk(Kind::kConditional, std::move(info)),\n       branch_index_buffer_(branch_index_buffer),\n+      branch_index_buffer_shape_(branch_index_buffer_shape),\n       branch_executors_(std::move(branch_executors)) {}\n \n tsl::AsyncValueRef<Thunk::ExecuteEvent> ConditionalThunk::Execute(\n@@ -79,18 +109,13 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> ConditionalThunk::Execute(\n                : branch_index;\n   };\n \n-  // See operation semantics documentation:\n-  // https://openxla.org/xla/operation_semantics#conditional\n-\n-  // Branch index is pred[].\n-  if (branch_index_buffer_.size() == sizeof(bool)) {\n+  if (branch_index_buffer_shape_.element_type() == PRED) {\n     bool* pred = reinterpret_cast<bool*>(branch_index_data.opaque());\n     VLOG(3) << \"  loaded pred[] branch index: \" << *pred;\n     return branch_executors_.at(*pred ? 0 : 1).Execute(params);\n   }\n \n-  // Branch index is s32[].\n-  if (branch_index_buffer_.size() == sizeof(int32_t)) {\n+  if (branch_index_buffer_shape_.element_type() == S32) {\n     int32_t* index = reinterpret_cast<int32_t*>(branch_index_data.opaque());\n     VLOG(3) << \"  loaded s32[] branch index: \" << *index;\n     return branch_executors_.at(clamp(*index)).Execute(params);\n@@ -101,7 +126,8 @@ tsl::AsyncValueRef<Thunk::ExecuteEvent> ConditionalThunk::Execute(\n }\n \n ConditionalThunk::BufferUses ConditionalThunk::buffer_uses() const {\n-  BufferUses buffer_uses = {BufferUse::Read(branch_index_buffer_)};\n+  BufferUses buffer_uses = {\n+      BufferUse::Read(branch_index_buffer_, branch_index_buffer_shape_)};\n   for (const auto& branch_executor : branch_executors_) {\n     BufferUses uses = branch_executor.buffer_uses();\n     buffer_uses.insert(buffer_uses.end(), uses.begin(), uses.end());"
        },
        {
            "sha": "4baca3d05da38b8dd644b27d829745cac1d223a6",
            "filename": "third_party/xla/xla/backends/cpu/runtime/conditional_thunk.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk.h?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -25,6 +25,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n \n namespace xla::cpu {\n@@ -53,9 +54,11 @@ class ConditionalThunk final : public Thunk {\n \n  private:\n   ConditionalThunk(Info info, BufferAllocation::Slice branch_index_buffer,\n+                   Shape branch_index_buffer_shape,\n                    std::vector<ThunkExecutor> branch_executors);\n \n   BufferAllocation::Slice branch_index_buffer_;\n+  Shape branch_index_buffer_shape_;\n   std::vector<ThunkExecutor> branch_executors_;\n };\n "
        },
        {
            "sha": "b2a918018fc137ad25f81feb7bd63d1fc265a1a1",
            "filename": "third_party/xla/xla/backends/cpu/runtime/conditional_thunk_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fconditional_thunk_test.cc?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -25,6 +25,8 @@ limitations under the License.\n #include \"xla/runtime/buffer_use.h\"\n #include \"xla/runtime/resource_use.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n #include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/platform/test.h\"\n \n@@ -33,20 +35,24 @@ namespace {\n \n TEST(ConditionalThunkTest, BufferUses) {\n   BufferAllocation alloc(0, 1024, 0);\n+  Shape branch_index_slice_shape = ShapeUtil::MakeShape(S32, {1});\n   BufferAllocation::Slice branch_index_slice(&alloc, 0, sizeof(int32_t));\n-  BufferAllocation::Slice read_slice(&alloc, 10, 10);\n+  Shape read_slice_shape = ShapeUtil::MakeShape(F32, {4});\n+  BufferAllocation::Slice read_slice(&alloc, 10, 12);\n \n   std::vector<ThunkSequence> branch_sequences(1);\n-  branch_sequences[0].push_back(\n-      std::make_unique<BufferUseThunk>(BufferUse::Read(read_slice)));\n+  branch_sequences[0].push_back(std::make_unique<BufferUseThunk>(\n+      BufferUse::Read(read_slice, read_slice_shape)));\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto thunk, ConditionalThunk::Create({\"conditional\"}, branch_index_slice,\n                                            std::move(branch_sequences)));\n \n   EXPECT_EQ(thunk->buffer_uses().size(), 2);\n-  EXPECT_EQ(thunk->buffer_uses()[0], BufferUse::Read(branch_index_slice));\n-  EXPECT_EQ(thunk->buffer_uses()[1], BufferUse::Read(read_slice));\n+  EXPECT_EQ(thunk->buffer_uses()[0],\n+            BufferUse::Read(branch_index_slice, branch_index_slice_shape));\n+  EXPECT_EQ(thunk->buffer_uses()[1],\n+            BufferUse::Read(read_slice, read_slice_shape));\n }\n \n TEST(ConditionalThunkTest, ResourceUses) {"
        },
        {
            "sha": "a8e425116af0388df21751eb5f23d228ce07825b",
            "filename": "third_party/xla/xla/backends/cpu/runtime/thunk_sequence_serdes_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fthunk_sequence_serdes_test.cc?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -233,6 +233,13 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n \n     return absl::OkStatus();\n   }\n+  absl::Status AddPredBufferAllocation() {\n+    literals_.push_back(LiteralUtil::CreateFull<bool>({1}, false));\n+    TF_RETURN_IF_ERROR(buffer_allocations_.push_back(\n+        CreateBufferAllocation(buffer_allocations_.size(), literals_.back())));\n+\n+    return absl::OkStatus();\n+  }\n \n   // Thunk creation helper functions.\n   absl::StatusOr<std::unique_ptr<Thunk>> CreateAllGatherThunk(\n@@ -424,7 +431,7 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n       branch_sequences.push_back(std::move(called_sequence));\n     }\n \n-    TF_RETURN_IF_ERROR(AddBufferAllocations(1));\n+    TF_RETURN_IF_ERROR(AddPredBufferAllocation());\n \n     return ConditionalThunk::Create(\n         Thunk::Info(),\n@@ -435,7 +442,8 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n   }\n \n   absl::StatusOr<std::unique_ptr<Thunk>> CreateCustomCallThunk() {\n-    TF_RETURN_IF_ERROR(AddBufferAllocations(2));\n+    TF_RETURN_IF_ERROR(AddPredBufferAllocation());\n+    TF_RETURN_IF_ERROR(AddBufferAllocations(1));\n \n     return CustomCallThunk::Create(\n         Thunk::Info(), \"no_op\",\n@@ -575,7 +583,6 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n         /*batch_size=*/1,\n         /*input_size=*/1,\n         /*k=*/2\n-\n     );\n   }\n \n@@ -588,7 +595,7 @@ class ThunkSequenceSerdesTest : public ::testing::Test {\n     TF_ASSIGN_OR_RETURN(body_sequence.emplace_back(), CreateAllReduceThunk());\n     TF_ASSIGN_OR_RETURN(body_sequence.emplace_back(), CreateAllToAllThunk());\n \n-    TF_RETURN_IF_ERROR(AddBufferAllocations(1));\n+    TF_RETURN_IF_ERROR(AddPredBufferAllocation());\n     return WhileThunk::Create(\n         Thunk::Info(),\n         /*cond_buffer=*/"
        },
        {
            "sha": "2b1dc2f26039178516bd39f4952586d8a67c419a",
            "filename": "third_party/xla/xla/backends/cpu/runtime/while_thunk.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk.cc?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -36,9 +36,12 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n #include \"xla/runtime/buffer_use.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n #include \"xla/tsl/platform/statusor.h\"\n+#include \"xla/util.h\"\n \n namespace xla::cpu {\n \n@@ -49,16 +52,23 @@ absl::StatusOr<std::unique_ptr<WhileThunk>> WhileThunk::Create(\n                       ThunkExecutor::Create(std::move(cond_sequence)));\n   TF_ASSIGN_OR_RETURN(ThunkExecutor body_executor,\n                       ThunkExecutor::Create(std::move(body_sequence)));\n-  return absl::WrapUnique(new WhileThunk(std::move(info), cond_buffer,\n-                                         std::move(cond_executor),\n-                                         std::move(body_executor), trip_count));\n+\n+  if (cond_buffer.size() != sizeof(bool)) {\n+    return Internal(\"Unsupported cond buffer size %d\", cond_buffer.size());\n+  }\n+\n+  return absl::WrapUnique(new WhileThunk(\n+      std::move(info), cond_buffer, ShapeUtil::MakeShape(PRED, {1}),\n+      std::move(cond_executor), std::move(body_executor), trip_count));\n }\n \n WhileThunk::WhileThunk(Info info, BufferAllocation::Slice cond_buffer,\n-                       ThunkExecutor cond_executor, ThunkExecutor body_executor,\n+                       Shape cond_buffer_shape, ThunkExecutor cond_executor,\n+                       ThunkExecutor body_executor,\n                        std::optional<int64_t> trip_count)\n     : Thunk(Kind::kWhile, std::move(info)),\n       cond_buffer_(cond_buffer),\n+      cond_buffer_shape_(cond_buffer_shape),\n       cond_executor_(std::move(cond_executor)),\n       body_executor_(std::move(body_executor)),\n       trip_count_(trip_count) {}\n@@ -273,7 +283,7 @@ tsl::AsyncValueRef<WhileThunk::ExecuteEvent> WhileThunk::ExecuteAsyncWhileLoop(\n }\n \n WhileThunk::BufferUses WhileThunk::buffer_uses() const {\n-  BufferUses buffer_uses = {BufferUse::Write(cond_buffer_)};\n+  BufferUses buffer_uses = {BufferUse::Write(cond_buffer_, cond_buffer_shape_)};\n \n   BufferUses cond_uses = cond_executor_.buffer_uses();\n   buffer_uses.insert(buffer_uses.end(), cond_uses.begin(), cond_uses.end());"
        },
        {
            "sha": "aff947cac7a3ea127a71afd87605ff1051e20821",
            "filename": "third_party/xla/xla/backends/cpu/runtime/while_thunk.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk.h?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -27,6 +27,7 @@ limitations under the License.\n #include \"xla/backends/cpu/runtime/thunk.h\"\n #include \"xla/backends/cpu/runtime/thunk_executor.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n \n namespace xla::cpu {\n@@ -61,8 +62,8 @@ class WhileThunk final : public Thunk {\n \n  private:\n   WhileThunk(Info info, BufferAllocation::Slice cond_buffer,\n-             ThunkExecutor cond_executor, ThunkExecutor body_executor,\n-             std::optional<int64_t> trip_count);\n+             Shape cond_buffer_shape, ThunkExecutor cond_executor,\n+             ThunkExecutor body_executor, std::optional<int64_t> trip_count);\n \n   tsl::AsyncValueRef<ExecuteEvent> ExecuteForLoop(const ExecuteParams& params,\n                                                   int64_t trip_count);\n@@ -84,6 +85,7 @@ class WhileThunk final : public Thunk {\n       bool* condition);\n \n   BufferAllocation::Slice cond_buffer_;\n+  Shape cond_buffer_shape_;\n   ThunkExecutor cond_executor_;\n   ThunkExecutor body_executor_;\n "
        },
        {
            "sha": "f8ae4f1ff8c5a05c83e4a8c2bed6f8cbe1cf1d86",
            "filename": "third_party/xla/xla/backends/cpu/runtime/while_thunk_test.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/64d18885d50befe555ad3205960da627ac14fcaf/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fcpu%2Fruntime%2Fwhile_thunk_test.cc?ref=64d18885d50befe555ad3205960da627ac14fcaf",
            "patch": "@@ -29,6 +29,8 @@ limitations under the License.\n #include \"xla/runtime/buffer_use.h\"\n #include \"xla/runtime/resource_use.h\"\n #include \"xla/service/buffer_assignment.h\"\n+#include \"xla/shape.h\"\n+#include \"xla/shape_util.h\"\n #include \"xla/stream_executor/device_memory.h\"\n #include \"xla/tsl/concurrency/async_value_ref.h\"\n #include \"xla/tsl/platform/env.h\"\n@@ -46,27 +48,31 @@ namespace {\n \n TEST(WhileThunkTest, BufferUses) {\n   BufferAllocation alloc(0, 1024, 0);\n+  Shape pred_shape = ShapeUtil::MakeShape(PRED, {1});\n   BufferAllocation::Slice pred_slice(&alloc, 0, sizeof(char));\n-  BufferAllocation::Slice cond_read_slice(&alloc, 10, 10);\n-  BufferAllocation::Slice body_read_slice(&alloc, 20, 10);\n+  Shape read_slice_shape = ShapeUtil::MakeShape(F32, {4});\n+  BufferAllocation::Slice cond_read_slice(&alloc, 10, 12);\n+  BufferAllocation::Slice body_read_slice(&alloc, 22, 12);\n \n   ThunkSequence cond_sequence;\n-  cond_sequence.push_back(\n-      std::make_unique<BufferUseThunk>(BufferUse::Read(cond_read_slice)));\n+  cond_sequence.push_back(std::make_unique<BufferUseThunk>(\n+      BufferUse::Read(cond_read_slice, read_slice_shape)));\n \n   ThunkSequence body_sequence;\n-  body_sequence.push_back(\n-      std::make_unique<BufferUseThunk>(BufferUse::Read(body_read_slice)));\n+  body_sequence.push_back(std::make_unique<BufferUseThunk>(\n+      BufferUse::Read(body_read_slice, read_slice_shape)));\n \n   TF_ASSERT_OK_AND_ASSIGN(\n       auto thunk,\n       WhileThunk::Create({\"while\"}, pred_slice, std::move(cond_sequence),\n                          std::move(body_sequence)));\n \n   EXPECT_EQ(thunk->buffer_uses().size(), 3);\n-  EXPECT_EQ(thunk->buffer_uses()[0], BufferUse::Write(pred_slice));\n-  EXPECT_EQ(thunk->buffer_uses()[1], BufferUse::Read(cond_read_slice));\n-  EXPECT_EQ(thunk->buffer_uses()[2], BufferUse::Read(body_read_slice));\n+  EXPECT_EQ(thunk->buffer_uses()[0], BufferUse::Write(pred_slice, pred_shape));\n+  EXPECT_EQ(thunk->buffer_uses()[1],\n+            BufferUse::Read(cond_read_slice, read_slice_shape));\n+  EXPECT_EQ(thunk->buffer_uses()[2],\n+            BufferUse::Read(body_read_slice, read_slice_shape));\n }\n \n TEST(WhileThunkTest, ResourceUses) {\n@@ -123,7 +129,7 @@ class CondThunk : public Thunk {\n   }\n \n   BufferUses buffer_uses() const final {\n-    return {BufferUse::Write(pred_slice_)};\n+    return {BufferUse::Write(pred_slice_, ShapeUtil::MakeShape(PRED, {1}))};\n   }\n \n  private:"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 102,
        "deletions": 37
    }
}