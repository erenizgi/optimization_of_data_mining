{
    "author": "tensorflower-gardener",
    "message": "Remove #if CUDA_VERSION in cupti_tracer, mainly for handle cupti driver api callback ids.\nInitial setting up for handling different cuda versions in cupti profiler codes.\n\nPiperOrigin-RevId: 838916960",
    "sha": "b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
    "files": [
        {
            "sha": "33b7ee4ca1f47584f13a2e6ae63ce187d8a805d9",
            "filename": "third_party/xla/xla/backends/gpu/profiler/kernel_name_tracer_cuda.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fprofiler%2Fkernel_name_tracer_cuda.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fprofiler%2Fkernel_name_tracer_cuda.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fgpu%2Fprofiler%2Fkernel_name_tracer_cuda.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -46,13 +46,13 @@ class KernelNameTracerCuda : public KernelNameTracer {\n };\n \n void KernelNameTracerCuda::start() {\n-  profiler::CuptiTracerCollectorOptions collector_options;\n+  profiler::CuptiTracerCollectorOptions collector_options{};\n   collector_options.num_gpus = profiler::CuptiTracer::NumGpus();\n   auto start_gputime_ns = profiler::CuptiTracer::GetTimestamp();\n   auto start_walltime_ns = tsl::profiler::GetCurrentTimeNanos();\n   cupti_collector_ = profiler::CreateCuptiCollector(\n       collector_options, start_walltime_ns, start_gputime_ns);\n-  profiler::CuptiTracerOptions options;\n+  profiler::CuptiTracerOptions options{};\n   options.activities_selected = {CUPTI_ACTIVITY_KIND_CONCURRENT_KERNEL};\n   cupti_tracer_->Enable(options, cupti_collector_.get()).IgnoreError();\n }"
        },
        {
            "sha": "38e445804195b82f8a0a181f78f845504d0b5c68",
            "filename": "third_party/xla/xla/backends/profiler/gpu/BUILD",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2FBUILD?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -96,6 +96,55 @@ cc_library(\n     ],\n )\n \n+cc_library(\n+    name = \"cuda_version_variants\",\n+    srcs = [\n+        \"cuda_version_variants.cc\",\n+    ] + if_cuda_newer_than(\n+        \"12_0\",\n+        [\"cuda_version_12000_newer.cc\"],\n+        [\"cuda_version_12000_older.cc\"],\n+    ) + if_cuda_newer_than(\n+        \"12_8\",\n+        [\"cuda_version_12080_newer.cc\"],\n+        [\"cuda_version_12080_older.cc\"],\n+    ),\n+    hdrs = [\"cuda_version_variants.h\"],\n+    # copybara:uncomment compatible_with = [\"//buildenv/target:non_prod\"],\n+    tags = [\n+        \"cuda-only\",\n+        \"gpu\",\n+        \"requires-gpu-nvidia\",\n+    ],\n+    deps = [\n+        \"@com_google_absl//absl/base:no_destructor\",\n+        \"@com_google_absl//absl/container:flat_hash_map\",\n+        \"@com_google_absl//absl/log\",\n+        \"@com_google_absl//absl/types:span\",\n+        \"@local_config_cuda//cuda:cuda_headers\",\n+    ],\n+)\n+\n+xla_cc_test(\n+    name = \"cuda_version_variants_test\",\n+    srcs = [\"cuda_version_variants_test.cc\"],\n+    tags = [\n+        \"cuda-only\",\n+        \"gpu\",\n+        \"no_mac\",\n+        \"requires-gpu-nvidia\",\n+    ],\n+    deps = [\n+        \":cuda_version_variants\",\n+        \"@com_google_absl//absl/types:span\",\n+        \"@com_google_googletest//:gtest_main\",\n+        \"@local_config_cuda//cuda:cuda_headers\",\n+        \"@local_config_cuda//cuda:cuda_runtime\",\n+        \"@local_tsl//tsl/platform:status_matchers\",\n+        \"@local_tsl//tsl/platform:test\",\n+    ],\n+)\n+\n cc_library(\n     name = \"mock_cupti\",\n     testonly = 1,\n@@ -231,6 +280,7 @@ cc_library(\n     ],\n     visibility = [\"//visibility:public\"],\n     deps = [\n+        \":cuda_version_variants\",\n         \":cupti_buffer_events\",\n         \":cupti_collector\",\n         \":cupti_interface\",\n@@ -247,6 +297,7 @@ cc_library(\n         \"//xla/tsl/profiler/utils:xplane_schema\",\n         \"@com_google_absl//absl/algorithm:container\",\n         \"@com_google_absl//absl/base:core_headers\",\n+        \"@com_google_absl//absl/base:no_destructor\",\n         \"@com_google_absl//absl/cleanup\",\n         \"@com_google_absl//absl/container:flat_hash_map\",\n         \"@com_google_absl//absl/container:flat_hash_set\","
        },
        {
            "sha": "db2e3b84cae7cac4f33eb09e67fa84c3d10840bb",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_12000_newer.cc",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12000_newer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12000_newer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12000_newer.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,72 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"absl/base/no_destructor.h\"\n+#include \"absl/types/span.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_callbacks.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_driver_cbid.h\"\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+\n+// Previous impacted version is 11.0, Cbids supported here are [579, 701)\n+const CbidCategoryMap& GetExtraCallbackIdCategories12000() {\n+  if (GetSafeCudaVersion() < 12000) {\n+    return EmptyCallbackIdCategories();\n+  }\n+  static const absl::NoDestructor<CbidCategoryMap> kCbidCategoryMap({\n+      {CUPTI_DRIVER_TRACE_CBID_cuLaunchKernelEx /* 652 */,\n+       CbidCategory::kKernel},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithFlags /* 643 */,\n+       CbidCategory::kGraph},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithParams /* 656 */,\n+       CbidCategory::kGraph},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithParams_ptsz /* 657 */,\n+       CbidCategory::kGraph},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddEventRecordNode /* 589 */,\n+       CbidCategory::kGraphNode},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddEventWaitNode /* 590 */,\n+       CbidCategory::kGraphNode},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemAllocNode /* 638 */,\n+       CbidCategory::kGraphNode},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemFreeNode /* 639 */,\n+       CbidCategory::kGraphNode},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddBatchMemOpNode /* 669 */,\n+       CbidCategory::kGraphNode},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddKernelNode_v2 /* 689 */,\n+       CbidCategory::kGraphNode},\n+  });\n+  return *kCbidCategoryMap;\n+}\n+\n+absl::Span<const CUpti_CallbackIdResource> GetCudaGraphTracingResourceCbids() {\n+  static constexpr CUpti_CallbackIdResource res_cbids[] = {\n+      CUPTI_CBID_RESOURCE_GRAPH_CREATED /* 9 */,\n+      CUPTI_CBID_RESOURCE_GRAPH_CLONED /* 11 */,\n+      CUPTI_CBID_RESOURCE_GRAPHNODE_CREATED /* 13 */,\n+      CUPTI_CBID_RESOURCE_GRAPHEXEC_CREATED /* 18 */,\n+      CUPTI_CBID_RESOURCE_GRAPHNODE_CLONED /* 20 */};\n+  if (GetSafeCudaVersion() >= 12000) {\n+    return absl::MakeSpan(res_cbids);\n+  }\n+  return absl::Span<const CUpti_CallbackIdResource>();\n+}\n+\n+}  // namespace cuda_versions\n+\n+}  // namespace profiler\n+}  // namespace xla"
        },
        {
            "sha": "269547007d7b8a9967e15a31570add75f98e8960",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_12000_older.cc",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12000_older.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12000_older.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12000_older.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,35 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"absl/types/span.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_callbacks.h\"\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+\n+const CbidCategoryMap& GetExtraCallbackIdCategories12000() {\n+  return EmptyCallbackIdCategories();\n+}\n+\n+absl::Span<const CUpti_CallbackIdResource> GetCudaGraphTracingResourceCbids() {\n+  return {};\n+}\n+\n+}  // namespace cuda_versions\n+\n+}  // namespace profiler\n+}  // namespace xla"
        },
        {
            "sha": "c0abb99b85a7c17ec9c4d9d49b7d954ee769b375",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_12080_newer.cc",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12080_newer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12080_newer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12080_newer.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,41 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"absl/base/no_destructor.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_driver_cbid.h\"\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+\n+// Previous impacted version is 12.0, CBid supported here are [701, 782)\n+const CbidCategoryMap& GetExtraCallbackIdCategories12080() {\n+  if (GetSafeCudaVersion() < 12080) {\n+    return EmptyCallbackIdCategories();\n+  }\n+  static const absl::NoDestructor<CbidCategoryMap> kCbidCategoryMap({\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddNode /* 712 */,\n+       CbidCategory::kGraphNode},\n+      {CUPTI_DRIVER_TRACE_CBID_cuGraphAddNode_v2 /* 723 */,\n+       CbidCategory::kGraphNode},\n+  });\n+  return *kCbidCategoryMap;\n+}\n+\n+}  // namespace cuda_versions\n+\n+}  // namespace profiler\n+}  // namespace xla"
        },
        {
            "sha": "d385d64805a834e2839d060865de0baa903a465e",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_12080_older.cc",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12080_older.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12080_older.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_12080_older.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,29 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+\n+const CbidCategoryMap& GetExtraCallbackIdCategories12080() {\n+  return EmptyCallbackIdCategories();\n+}\n+\n+}  // namespace cuda_versions\n+\n+}  // namespace profiler\n+}  // namespace xla"
        },
        {
            "sha": "ddedb20316e677b47aacdad2ec6471a70c510c33",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_variants.cc",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,79 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n+\n+#include <algorithm>\n+\n+#include \"absl/base/no_destructor.h\"\n+#include \"absl/log/log.h\"\n+#include \"third_party/gpus/cuda/include/cuda_runtime_api.h\"\n+#include \"third_party/gpus/cuda/include/driver_types.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+\n+namespace {\n+\n+int GetCudaRuntimeVersion() {\n+  static int runtime_version = []() {\n+    int version = 0;\n+    cudaError_t status = cudaRuntimeGetVersion(&version);\n+    if (status == cudaSuccess) {\n+      LOG(INFO) << \"CUDA runtime version: \" << version;\n+      return version;\n+    }\n+    LOG(ERROR) << \"Failed to get CUDA runtime version, error: \"\n+               << cudaGetErrorName(status) << \" - \"\n+               << cudaGetErrorString(status);\n+    return 0;\n+  }();\n+  return runtime_version;\n+}\n+\n+int GetCudaDriverVersion() {\n+  static int driver_version = []() {\n+    int version = 0;\n+    cudaError_t status = cudaDriverGetVersion(&version);\n+    if (status == cudaSuccess) {\n+      LOG(INFO) << \"CUDA driver version: \" << version;\n+      return version;\n+    }\n+    LOG(ERROR) << \"Failed to get CUDA driver version, error: \"\n+               << cudaGetErrorName(status) << \" - \"\n+               << cudaGetErrorString(status);\n+    return 0;\n+  }();\n+  return driver_version;\n+}\n+\n+}  // namespace\n+\n+int GetSafeCudaVersion() {\n+  static int safe_cuda_version = []() {\n+    return std::min(GetCudaRuntimeVersion(), GetCudaDriverVersion());\n+  }();\n+  return safe_cuda_version;\n+}\n+\n+const CbidCategoryMap& EmptyCallbackIdCategories() {\n+  static const absl::NoDestructor<CbidCategoryMap> kCbidCategoryMap{};\n+  return *kCbidCategoryMap;\n+}\n+\n+}  // namespace cuda_versions\n+}  // namespace profiler\n+}  // namespace xla"
        },
        {
            "sha": "81bd3dd2426c14e649f222165aaa1163d7d653db",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_variants.h",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants.h?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,65 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#ifndef XLA_BACKENDS_PROFILER_GPU_CUDA_VERSION_VARIANTS_H_\n+#define XLA_BACKENDS_PROFILER_GPU_CUDA_VERSION_VARIANTS_H_\n+\n+#include \"absl/container/flat_hash_map.h\"\n+#include \"absl/types/span.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_callbacks.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+\n+// Get minimum version of CUDA runtime and CUDA driver for simplicity.\n+int GetSafeCudaVersion();\n+\n+// Currently Driver Callback ID (CBID) related versions for the compilation\n+// CUDA toolkit are (11.0), 12.0, 12.8.\n+enum CbidCategory {\n+  kNone,\n+  kKernel,\n+  kGraph,\n+  kGraphNode,\n+};\n+\n+using CbidCategoryMap =\n+    absl::flat_hash_map<CUpti_driver_api_trace_cbid, CbidCategory>;\n+\n+inline CbidCategory FindCbidCategory(const CbidCategoryMap& cbid_categories,\n+                                     CUpti_driver_api_trace_cbid cbid) {\n+  auto it = cbid_categories.find(cbid);\n+  if (it == cbid_categories.end()) {\n+    return CbidCategory::kNone;\n+  }\n+  return it->second;\n+}\n+\n+const CbidCategoryMap& EmptyCallbackIdCategories();\n+\n+const CbidCategoryMap& GetExtraCallbackIdCategories12000();\n+\n+const CbidCategoryMap& GetExtraCallbackIdCategories12080();\n+\n+// Resource CBIDs impacted only before/after 12.0.\n+absl::Span<const CUpti_CallbackIdResource> GetCudaGraphTracingResourceCbids();\n+\n+}  // namespace cuda_versions\n+}  // namespace profiler\n+}  // namespace xla\n+\n+#endif  // XLA_BACKENDS_PROFILER_GPU_CUDA_VERSION_VARIANTS_H_"
        },
        {
            "sha": "94f99778b9319e7b4f64634d6061f3046e710d0e",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cuda_version_variants_test.cc",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcuda_version_variants_test.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -0,0 +1,81 @@\n+/* Copyright 2025 The OpenXLA Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+    http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+==============================================================================*/\n+\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n+\n+#include <gmock/gmock.h>\n+#include <gtest/gtest.h>\n+#include \"absl/types/span.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_callbacks.h\"\n+#include \"third_party/gpus/cuda/include/cuda.h\"\n+\n+namespace xla {\n+namespace profiler {\n+namespace cuda_versions {\n+namespace test {\n+\n+namespace {\n+\n+TEST(CudaVersionVariantsTest, GetCudaGraphTracingResourceCbids) {\n+  int safe_cuda_version = GetSafeCudaVersion();\n+  absl::Span<const CUpti_CallbackIdResource> res_cbids =\n+      GetCudaGraphTracingResourceCbids();\n+  if (CUDA_VERSION >= 12000 && safe_cuda_version >= 12000) {\n+    EXPECT_THAT(res_cbids, testing::Not(testing::IsEmpty()))\n+        << \", CUDA_VERSION: \" << CUDA_VERSION\n+        << \", safe_cuda_version: \" << safe_cuda_version;\n+  } else {\n+    EXPECT_THAT(res_cbids, testing::IsEmpty())\n+        << \", CUDA_VERSION: \" << CUDA_VERSION\n+        << \", safe_cuda_version: \" << safe_cuda_version;\n+  }\n+}\n+\n+TEST(CudaVersionVariantsTest, GetExtraCallbackIdCategories12000) {\n+  int safe_cuda_version = GetSafeCudaVersion();\n+  const CbidCategoryMap& map = GetExtraCallbackIdCategories12000();\n+  if (CUDA_VERSION >= 12000 && safe_cuda_version >= 12000) {\n+    EXPECT_THAT(map, testing::Not(testing::IsEmpty()))\n+        << \", CUDA_VERSION: \" << CUDA_VERSION\n+        << \", safe_cuda_version: \" << safe_cuda_version;\n+\n+  } else {\n+    EXPECT_THAT(map, testing::IsEmpty())\n+        << \", CUDA_VERSION: \" << CUDA_VERSION\n+        << \", safe_cuda_version: \" << safe_cuda_version;\n+  }\n+}\n+\n+TEST(CudaVersionVariantsTest, GetExtraCallbackIdCategories12080) {\n+  int safe_cuda_version = GetSafeCudaVersion();\n+  const CbidCategoryMap& map = GetExtraCallbackIdCategories12080();\n+  if (CUDA_VERSION >= 12080 && safe_cuda_version >= 12080) {\n+    EXPECT_THAT(map, testing::Not(testing::IsEmpty()))\n+        << \", CUDA_VERSION: \" << CUDA_VERSION\n+        << \", safe_cuda_version: \" << safe_cuda_version;\n+\n+  } else {\n+    EXPECT_THAT(map, testing::IsEmpty())\n+        << \", CUDA_VERSION: \" << CUDA_VERSION\n+        << \", safe_cuda_version: \" << safe_cuda_version;\n+  }\n+}\n+\n+}  // namespace\n+\n+}  // namespace test\n+}  // namespace cuda_versions\n+}  // namespace profiler\n+}  // namespace xla"
        },
        {
            "sha": "b859e3644b73daf0a90ef1e302f56b874aa48b89",
            "filename": "third_party/xla/xla/backends/profiler/gpu/cupti_tracer.cc",
            "status": "modified",
            "additions": 209,
            "deletions": 159,
            "changes": 368,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fbackends%2Fprofiler%2Fgpu%2Fcupti_tracer.cc?ref=b01fc5e3b2285c75fb1cc1bf0f6224055e7f6962",
            "patch": "@@ -30,6 +30,7 @@ limitations under the License.\n #include <vector>\n \n #include \"absl/algorithm/container.h\"\n+#include \"absl/base/no_destructor.h\"\n #include \"absl/base/optimization.h\"\n #include \"absl/cleanup/cleanup.h\"\n #include \"absl/container/flat_hash_map.h\"\n@@ -41,12 +42,16 @@ limitations under the License.\n #include \"absl/strings/string_view.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"absl/types/span.h\"\n+#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti.h\"\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_activity.h\"\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_callbacks.h\"\n-#include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_driver_cbid.h\"\n+// Note: can not include cupti_driver_cbid.h because it is not once guarded in\n+// cuda 11. Remove comment here once cuda 11 is no longer supported.\n+// #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_driver_cbid.h\"\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_result.h\"\n #include \"third_party/gpus/cuda/extras/CUPTI/include/cupti_target.h\"\n #include \"third_party/gpus/cuda/include/cuda.h\"\n+#include \"xla/backends/profiler/gpu/cuda_version_variants.h\"\n #include \"xla/backends/profiler/gpu/cupti_buffer_events.h\"\n #include \"xla/backends/profiler/gpu/cupti_collector.h\"\n #include \"xla/backends/profiler/gpu/cupti_interface.h\"\n@@ -84,11 +89,6 @@ class CuptiApiTracingDisabler {\n   ~CuptiApiTracingDisabler() { internalCuCall--; }\n };\n \n-// CUPTI_ERROR_INSUFFICIENT_PRIVILEGES is introduced at CUDA 10.1.\n-#if CUDA_VERSION <= 10000\n-#define CUPTI_ERROR_INSUFFICIENT_PRIVILEGES 35\n-#endif\n-\n #define RETURN_IF_CUPTI_ERROR(expr)                                           \\\n   do {                                                                        \\\n     CUptiResult status = (cupti_interface_->expr);                            \\\n@@ -803,138 +803,169 @@ void SetGenericEventUponApiExit(CuptiTracerEvent& event, uint32_t device_id,\n           << \" name=\" << cbdata->functionName;\n }\n \n-static void SetCallbackEventUponApiExit(\n+// Supporting CUPTI paired with CUDA, and hence the value of\n+// CUPTI_DRIVER_TRACE_CBID_SIZE in cupti_driver_cbid.h are as follows\n+// corresponding to different CUDA version: CUDA version -->\n+// CUPTI_DRIVER_TRACE_CBID_SIZE\n+//   11.0 --> 579\n+//   12.0 --> 701\n+//   12.8 --> 782\n+//   12.9 --> 784\n+//   13.0 -->\n+// CUDA versions that are impacting code logic here are\n+// (11.0), 12.0, 12.8 with their corresponding\n+// CUPTI_DRIVER_TRACE_CBID_SIZE value (579), 701, 782 respectively.\n+\n+// As this is the call back function, no need to check the CUDA\n+// runtime/driver version. CBIDs are naturally valid here.\n+void SetCallbackEventUponApiExit(\n     CuptiTracerEvent& event, CuptiInterface* cupti_interface,\n     uint32_t device_id, CUpti_CallbackId cbid, const CUpti_CallbackData* cbdata,\n     uint64_t start_tsc, uint64_t end_tsc,\n     GuardedCallbackAnnotationsAndEvents& guarded_annotations_and_events,\n     CuptiTracer* tracer) {\n+  static absl::NoDestructor<\n+      std::vector<cuda_versions::CbidCategoryMap const*>> const\n+      kExtraCbidCategories(\n+          {&cuda_versions::GetExtraCallbackIdCategories12080(),\n+           &cuda_versions::GetExtraCallbackIdCategories12000()});\n+\n+  // Find the category of the CBID, checking newer CUDA version earlier than\n+  // older versions. If needed, process and return directly;\n+  cuda_versions::CbidCategory category = cuda_versions::CbidCategory::kNone;\n+  for (const auto* cbid_categories : *kExtraCbidCategories) {\n+    category = cuda_versions::FindCbidCategory(\n+        *cbid_categories, static_cast<CUpti_driver_api_trace_cbid>(cbid));\n+    if (category != cuda_versions::CbidCategory::kNone) {\n+      break;\n+    }\n+  }\n+  switch (category) {\n+    case cuda_versions::CbidCategory::kKernel:\n+      SetKernelEventUponApiExit(event, device_id, cbdata, start_tsc, end_tsc);\n+      return;\n+    case cuda_versions::CbidCategory::kGraph:\n+      SetCudaGraphEventUponApiExit(event, cupti_interface, device_id, cbid,\n+                                   cbdata, start_tsc, end_tsc,\n+                                   guarded_annotations_and_events, tracer);\n+      return;\n+    case cuda_versions::CbidCategory::kGraphNode:\n+      SetCudaGraphNodeEventUponApiExit(event, cupti_interface, device_id, cbid,\n+                                       cbdata, start_tsc, end_tsc);\n+      return;\n+    default:\n+      break;\n+  }\n+\n+  // All CBIDs < 579 are handled here for CUDA 11.0 and above.\n   switch (cbid) {\n-    case CUPTI_DRIVER_TRACE_CBID_cuLaunchKernel:\n-#if CUDA_VERSION >= 11080  // CUDA 11.8\n-    case CUPTI_DRIVER_TRACE_CBID_cuLaunchKernelEx:\n-#endif  // CUDA_VERSION >= 11080\n-    case CUPTI_DRIVER_TRACE_CBID_cuLaunchCooperativeKernel:\n-    case CUPTI_DRIVER_TRACE_CBID_cuLaunchCooperativeKernelMultiDevice:\n+    case CUPTI_DRIVER_TRACE_CBID_cuLaunchKernel:                        // 307\n+    case CUPTI_DRIVER_TRACE_CBID_cuLaunchCooperativeKernel:             // 477\n+    case CUPTI_DRIVER_TRACE_CBID_cuLaunchCooperativeKernelMultiDevice:  // 480\n       SetKernelEventUponApiExit(event, device_id, cbdata, start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAsync:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoD_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoDAsync_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoH_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoHAsync_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoD_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoDAsync_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoH_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoHAsync_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoD_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoA_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoA_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy2D_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DUnaligned_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DAsync_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy3D_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy3DAsync_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoA_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoAAsync_v2:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoD_v2:         // 276\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoDAsync_v2:    // 277\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoH_v2:         // 278\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoHAsync_v2:    // 279\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoD_v2:         // 280\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoDAsync_v2:    // 281\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoH_v2:         // 282\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoHAsync_v2:    // 283\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoD_v2:         // 284\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoA_v2:         // 285\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoA_v2:         // 286\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy2D_v2:           // 287\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DUnaligned_v2:  // 288\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DAsync_v2:      // 289\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy3D_v2:           // 290\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy3DAsync_v2:      // 291\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoA_v2:         // 292\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoAAsync_v2:    // 293\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpy:                // 305\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyAsync:           // 306\n       // This would be the place to populate the memcpy API activity's src and\n       // dst memory kind by casting cbdata->functionParams. However, we are not\n       // doing that because that will incur significant overhead to get the\n       // memory aperture of each argument.\n       SetNormalMemcpyEventUponApiExit(event, device_id, cbid, cbdata, start_tsc,\n                                       end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeer:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeerAsync:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeer:       // 318\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeerAsync:  // 319\n       SetP2PMemcpyEventUponApiExit(event, cupti_interface, device_id, cbid,\n                                    cbdata, start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemAlloc_v2:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemAlloc_v2:  // 243\n       SetCuMemAllocEventUponApiExit(event, device_id, cbid, cbdata, start_tsc,\n                                     end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemAllocPitch_v2:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemAllocPitch_v2:  // 244\n       SetCuMemAllocPitchEventUponApiExit(event, device_id, cbid, cbdata,\n                                          start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemAllocManaged:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemAllocManaged:  // 371\n       SetCuMemAllocManagedEventUponApiExit(event, device_id, cbid, cbdata,\n                                            start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemAllocHost_v2:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemAllocHost_v2:  // 294\n       SetCuMemAllocHostEventUponApiExit(event, device_id, cbid, cbdata,\n                                         start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemHostAlloc:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemHostAlloc:  // 39\n       SetCuMemHostAllocEventUponApiExit(event, device_id, cbid, cbdata,\n                                         start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemFree_v2:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemFree_v2:  // 245\n       SetCuMemFreeEventUponApiExit(event, device_id, cbid, cbdata, start_tsc,\n                                    end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemFreeHost:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemFreeHost:  // 38\n       SetCuMemFreeHostEventUponApiExit(event, device_id, cbid, cbdata,\n                                        start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemHostRegister_v2:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemHostRegister_v2:  // 379\n       SetCuMemHostRegisterEventUponApiExit(event, device_id, cbid, cbdata,\n                                            start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemHostUnregister:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemHostUnregister:  // 302\n       SetCuMemHostUnregisterEventUponApiExit(event, device_id, cbid, cbdata,\n                                              start_tsc, end_tsc);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD8_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD16_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD32_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD8Async:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD16Async:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD32Async:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8Async:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16Async:\n-    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32Async:\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD8Async:     // 216\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD16Async:    // 218\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD32Async:    // 220\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8Async:   // 222\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16Async:  // 224\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32Async:  // 226\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD8_v2:       // 249\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD16_v2:      // 250\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD32_v2:      // 251\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8_v2:     // 252\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16_v2:    // 253\n+    case CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32_v2:    // 254\n       SetCuMemsetEventUponApiExit(event, device_id, cbid, cbdata, start_tsc,\n                                   end_tsc);\n       break;\n-#if CUDA_VERSION >= 11070  // CUDA 11.7\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphCreate:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch_ptsz:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphClone:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithFlags:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithParams:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithParams_ptsz:\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphCreate:          // 501\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate:     // 513\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch:          // 514\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch_ptsz:     // 515\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphClone:           // 523\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate_v2:  // 578\n       SetCudaGraphEventUponApiExit(event, cupti_interface, device_id, cbid,\n                                    cbdata, start_tsc, end_tsc,\n                                    guarded_annotations_and_events, tracer);\n       break;\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddKernelNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddKernelNode_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemcpyNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemsetNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddChildGraphNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddEmptyNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddHostNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddNode_v2:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddEventRecordNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddEventWaitNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddExternalSemaphoresSignalNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddExternalSemaphoresWaitNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemAllocNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemFreeNode:\n-    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddBatchMemOpNode:\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddKernelNode:      // 502\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemcpyNode:      // 504\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemsetNode:      // 506\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddChildGraphNode:  // 525\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddEmptyNode:       // 526\n+    case CUPTI_DRIVER_TRACE_CBID_cuGraphAddHostNode:        // 530\n       SetCudaGraphNodeEventUponApiExit(event, cupti_interface, device_id, cbid,\n                                        cbdata, start_tsc, end_tsc);\n       break;\n-#endif  // CUDA_VERSION >= 11070\n     default:\n       SetGenericEventUponApiExit(event, device_id, cbid, cbdata, start_tsc,\n                                  end_tsc);\n@@ -1037,19 +1068,6 @@ class CuptiDriverApiHookWithActivityApi : public CuptiDriverApiHook {\n   return absl::StrCat(tsl::port::Hostname(), \": \", error_message);\n }\n \n-absl::Span<const uint32_t> GetCudaGraphTracingResourceCbids() {\n-#if CUDA_VERSION >= 11070\n-  static constexpr uint32_t res_cbids[] = {\n-      CUPTI_CBID_RESOURCE_GRAPH_CREATED, CUPTI_CBID_RESOURCE_GRAPH_CLONED,\n-      CUPTI_CBID_RESOURCE_GRAPHEXEC_CREATED,\n-      CUPTI_CBID_RESOURCE_GRAPHNODE_CREATED,\n-      CUPTI_CBID_RESOURCE_GRAPHNODE_CLONED};\n-  return absl::MakeSpan(res_cbids);\n-#else\n-  return absl::Span<const uint32_t>();\n-#endif\n-}\n-\n }  // namespace\n \n CuptiTracer::CuptiTracer(CuptiInterface* cupti_interface)\n@@ -1202,70 +1220,100 @@ void CuptiTracer::Disable() {\n   tsl::profiler::AnnotationStack::Enable(false);\n }\n \n+// Generate default callback ids list that tracer needs to enable them.\n+// Have to check the cuda runtime/driver version.\n std::vector<CUpti_driver_api_trace_cbid_enum>\n CuptiTracer::CreateDefaultCallbackIds() {\n-  return {\n-      // KERNEL\n-      CUPTI_DRIVER_TRACE_CBID_cuLaunchKernel,\n-#if CUDA_VERSION >= 11080  // CUDA 11.8\n-      CUPTI_DRIVER_TRACE_CBID_cuLaunchKernelEx,\n-#endif  // CUDA_VERSION >= 11080\n-      // MEMCPY\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpy,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAsync,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoD_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoDAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoH_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoHAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoD_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoDAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoH_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoHAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoD_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoA_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoA_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpy2D_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DUnaligned_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpy3D_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpy3DAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoA_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoAAsync_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeer,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeerAsync,\n-      // MemAlloc\n-      CUPTI_DRIVER_TRACE_CBID_cuMemAlloc_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemAllocPitch_v2,\n-      // MemFree\n-      CUPTI_DRIVER_TRACE_CBID_cuMemFree_v2,\n-      // Memset\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD8_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD16_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD32_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD8Async,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD16Async,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD32Async,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8Async,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16Async,\n-      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32Async,\n-      // GENERIC\n-      CUPTI_DRIVER_TRACE_CBID_cuStreamSynchronize,\n-#if CUDA_VERSION >= 12080  // CUDA 12.8\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphCreate,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch_ptsz,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphClone,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate_v2,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithFlags,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithParams,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiateWithParams_ptsz,\n-      CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemcpyNode,\n-#endif  // CUDA_VERSION >= 12080\n+  // Default CBIDs for CUDA 11.0 and above.\n+  std::vector<CUpti_driver_api_trace_cbid_enum> cbids = {\n+      /* Next three CBIDs are handled by SetKernelEventUponApiExit(). */\n+      CUPTI_DRIVER_TRACE_CBID_cuLaunchKernel,                        // 307\n+      CUPTI_DRIVER_TRACE_CBID_cuLaunchCooperativeKernel,             // 477\n+      CUPTI_DRIVER_TRACE_CBID_cuLaunchCooperativeKernelMultiDevice,  // 480\n+      /* Following group are handled by SetNormalMemcpyEventUponApiExit(). */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoD_v2,         // 276\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoDAsync_v2,    // 277\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoH_v2,         // 278\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoHAsync_v2,    // 279\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoD_v2,         // 280\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoDAsync_v2,    // 281\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoH_v2,         // 282\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoHAsync_v2,    // 283\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoD_v2,         // 284\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyDtoA_v2,         // 285\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAtoA_v2,         // 286\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpy2D_v2,           // 287\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DUnaligned_v2,  // 288\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpy2DAsync_v2,      // 289\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpy3D_v2,           // 290\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpy3DAsync_v2,      // 291\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoA_v2,         // 292\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyHtoAAsync_v2,    // 293\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpy,                // 305\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyAsync,           // 306\n+      /* SetP2PMemcpyEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeer,       // 318\n+      CUPTI_DRIVER_TRACE_CBID_cuMemcpyPeerAsync,  // 319\n+      /* SetCuMemAllocEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemAlloc_v2,  // 243\n+      /* SetCuMemAllocPitchEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemAllocPitch_v2,  // 244\n+      /* SetCuMemAllocManagedEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemAllocManaged,  // 371\n+      /* SetCuMemAllocHostEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemAllocHost_v2,  // 294\n+      /* SetCuMemHostAllocEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemHostAlloc,  // 39\n+      /* SetCuMemFreeEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemFree_v2,  // 245\n+      /* SetCuMemFreeHostEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemFreeHost,  // 38\n+      /* SetCuMemHostRegisterEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemHostRegister_v2,  // 379\n+      /* SetCuMemHostUnregisterEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemHostUnregister,  // 302\n+      /* SetCuMemsetEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD8Async,     // 216\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD16Async,    // 218\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD32Async,    // 220\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8Async,   // 222\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16Async,  // 224\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32Async,  // 226\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD8_v2,       // 249\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD16_v2,      // 250\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD32_v2,      // 251\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D8_v2,     // 252\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D16_v2,    // 253\n+      CUPTI_DRIVER_TRACE_CBID_cuMemsetD2D32_v2,    // 254\n+      /* SetCudaGraphEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphCreate,          // 501\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate,     // 513\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch,          // 514\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphLaunch_ptsz,     // 515\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphClone,           // 523\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphInstantiate_v2,  // 578\n+      /* SetCudaGraphNodeEventUponApiExit() */\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphAddKernelNode,      // 502\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemcpyNode,      // 504\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphAddMemsetNode,      // 506\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphAddChildGraphNode,  // 525\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphAddEmptyNode,       // 526\n+      CUPTI_DRIVER_TRACE_CBID_cuGraphAddHostNode,        // 530\n   };\n+\n+  // Adding default Callback cbids according to the CUDA version, considering\n+  // both compilation and runtime/driver version.\n+  for (const auto& id_categories :\n+       {cuda_versions::GetExtraCallbackIdCategories12080(),\n+        cuda_versions::GetExtraCallbackIdCategories12000()}) {\n+    for (const auto& [cbid, category] : id_categories) {\n+      if (category != cuda_versions::CbidCategory::kNone) {\n+        cbids.push_back(cbid);\n+      }\n+    }\n+  }\n+\n+  return cbids;\n }\n \n absl::Status CuptiTracer::FlushEventsToCollector() {\n@@ -1318,7 +1366,8 @@ absl::Status CuptiTracer::EnableApiTracing() {\n       Subscribe(&subscriber_, (CUpti_CallbackFunc)ApiCallback, this));\n   api_tracing_enabled_ = true;\n \n-  absl::Span<const uint32_t> res_cbids = GetCudaGraphTracingResourceCbids();\n+  absl::Span<const CUpti_CallbackIdResource> res_cbids =\n+      cuda_versions::GetCudaGraphTracingResourceCbids();\n   for (auto cbid : res_cbids) {\n     RETURN_IF_CUPTI_ERROR(EnableCallback(1 /* ENABLE */, subscriber_,\n                                          CUPTI_CB_DOMAIN_RESOURCE, cbid));\n@@ -1346,7 +1395,8 @@ absl::Status CuptiTracer::DisableApiTracing() {\n \n   api_tracing_enabled_ = false;\n \n-  absl::Span<const uint32_t> res_cbids = GetCudaGraphTracingResourceCbids();\n+  absl::Span<const CUpti_CallbackIdResource> res_cbids =\n+      cuda_versions::GetCudaGraphTracingResourceCbids();\n   for (auto cbid : res_cbids) {\n     RETURN_IF_CUPTI_ERROR(EnableCallback(0 /* DISABLE */, subscriber_,\n                                          CUPTI_CB_DOMAIN_RESOURCE, cbid));"
        }
    ],
    "stats": {
        "total": 825,
        "additions": 664,
        "deletions": 161
    }
}