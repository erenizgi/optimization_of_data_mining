{
    "author": "draganmladjenovic",
    "message": "PR #32439: [ROCm] Fix and enable xla_gpu_use_embeded_device_lib and xla_gpu_use_‚Ä¶\n\nImported from GitHub PR https://github.com/openxla/xla/pull/32439\n\n‚Ä¶inprocess_lld\n\nüìù Summary of Changes\nEnable embedded device libs and in-process lld by default.\n\nüéØ Justification\nMoves amdgpu backend to be more filesystem layout independent.\n\nüöÄ Kind of Contribution\nüêõ Bug Fix\n\nüìä Benchmark (for Performance Improvements)\nN\\A\n\nüß™ Unit Tests:\nNone\n\nüß™ Execution Tests:\nNone\n\nCopybara import of the project:\n\n--\n46a100377d00d30dbc79e34c977b9219c54bda4b by Dragan Mladjenovic <Dragan.Mladjenovic@amd.com>:\n\n[ROCm] Fix and enable xla_gpu_use_embeded_device_lib and xla_gpu_use_inprocess_lld\n\nMerging this change closes #32439\n\nPiperOrigin-RevId: 824476138",
    "sha": "77bed2c6ef2098c78bf137c22619d7e27a26a4ac",
    "files": [
        {
            "sha": "a0187554bad5bde3a932a86bf5810ab5ce806e67",
            "filename": "third_party/xla/xla/BUILD",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/77bed2c6ef2098c78bf137c22619d7e27a26a4ac/third_party%2Fxla%2Fxla%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/77bed2c6ef2098c78bf137c22619d7e27a26a4ac/third_party%2Fxla%2Fxla%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2FBUILD?ref=77bed2c6ef2098c78bf137c22619d7e27a26a4ac",
            "patch": "@@ -4,7 +4,7 @@ load(\"//third_party/compute_library:build_defs.bzl\", \"if_enable_acl\")\n # copybara:uncomment load(\"@rules_python//python:proto.bzl\", \"py_proto_library\")\n load(\"//xla:package_groups.bzl\", \"xla_package_groups\")\n load(\"//xla:xla.default.bzl\", \"xla_bzl_library\", \"xla_cc_test\", \"xla_py_proto_library\")\n-load(\"//xla/tsl:tsl.bzl\", \"if_google\", \"internal_visibility\")\n+load(\"//xla/tsl:tsl.bzl\", \"if_google\", \"if_oss\", \"internal_visibility\")\n load(\"//xla/tsl:tsl.default.bzl\", \"filegroup\", \"get_compatible_with_portable\")\n load(\n     \"//xla/tsl/platform:build_config.bzl\",\n@@ -1215,7 +1215,12 @@ cc_library(\n         \"debug_options_parsers.h\",\n     ],\n     hdrs = [\"debug_options_flags.h\"],\n-    copts = if_enable_acl([\"-DXLA_CPU_USE_ACL=1\"]),\n+    copts = if_enable_acl([\n+        \"-DXLA_CPU_USE_ACL=1\",\n+    ]) + if_oss([\n+        \"-DHAS_SUPPORT_FOR_LLD_AS_A_LIBRARY=1\",\n+        \"-DHAS_SUPPORT_FOR_EMBEDDED_LIB_DEVICE=1\",\n+    ]),\n     visibility = internal_visibility([\":friends\"]),\n     deps =\n         ["
        },
        {
            "sha": "5b7ed2f61b227d6260bf2e945ec4a135b103cf53",
            "filename": "third_party/xla/xla/debug_options_flags.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/77bed2c6ef2098c78bf137c22619d7e27a26a4ac/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/77bed2c6ef2098c78bf137c22619d7e27a26a4ac/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fdebug_options_flags.cc?ref=77bed2c6ef2098c78bf137c22619d7e27a26a4ac",
            "patch": "@@ -389,6 +389,14 @@ DebugOptions DefaultDebugOptionsIgnoringFlags() {\n   const int64_t kDefaultMinGemmRewriteSize = 100;\n   opts.set_xla_gpu_gemm_rewrite_size_threshold(kDefaultMinGemmRewriteSize);\n \n+#ifdef HAS_SUPPORT_FOR_EMBEDDED_LIB_DEVICE\n+  opts.set_xla_gpu_use_embeded_device_lib(true);\n+#endif\n+\n+#ifdef HAS_SUPPORT_FOR_LLD_AS_A_LIBRARY\n+  opts.set_xla_gpu_use_inprocess_lld(true);\n+#endif\n+\n   opts.set_xla_gpu_use_memcpy_local_p2p(false);\n \n   opts.set_xla_reduce_window_rewrite_base_length(16);"
        },
        {
            "sha": "32f41027529958f77b0ebf8cf229231b37899bbd",
            "filename": "third_party/xla/xla/service/gpu/llvm_gpu_backend/generate_amdgpu_device_lib_data_tool.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/77bed2c6ef2098c78bf137c22619d7e27a26a4ac/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fllvm_gpu_backend%2Fgenerate_amdgpu_device_lib_data_tool.py",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/77bed2c6ef2098c78bf137c22619d7e27a26a4ac/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fllvm_gpu_backend%2Fgenerate_amdgpu_device_lib_data_tool.py",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fservice%2Fgpu%2Fllvm_gpu_backend%2Fgenerate_amdgpu_device_lib_data_tool.py?ref=77bed2c6ef2098c78bf137c22619d7e27a26a4ac",
            "patch": "@@ -75,7 +75,7 @@ def main():\n \n namespace {cpp_namespace} {{\n   inline const char kRaw_{cpp_identifier}[] = \"{data_string}\";\n-  constexpr llvm::StringRef {cpp_identifier}{{kRaw_{cpp_identifier}, sizeof(kRaw_{cpp_identifier})}};\n+  constexpr llvm::StringRef {cpp_identifier}{{kRaw_{cpp_identifier}, sizeof(kRaw_{cpp_identifier}) - 1}};\n }} // namespace {cpp_namespace}\n \"\"\")\n "
        }
    ],
    "stats": {
        "total": 19,
        "additions": 16,
        "deletions": 3
    }
}