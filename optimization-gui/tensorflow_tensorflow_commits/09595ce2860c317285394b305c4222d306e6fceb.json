{
    "author": "tensorflower-gardener",
    "message": "Add RPC handlers for `IncrementKeyValue` and update the corresponding clients.\n\nPiperOrigin-RevId: 799479516",
    "sha": "09595ce2860c317285394b305c4222d306e6fceb",
    "files": [
        {
            "sha": "e23d6445fadaabc52bf9f427ce41941c761ccff1",
            "filename": "tensorflow/core/common_runtime/next_pluggable_device/c_plugin_coordination_service_agent_test.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/tensorflow%2Fcore%2Fcommon_runtime%2Fnext_pluggable_device%2Fc_plugin_coordination_service_agent_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/tensorflow%2Fcore%2Fcommon_runtime%2Fnext_pluggable_device%2Fc_plugin_coordination_service_agent_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/tensorflow%2Fcore%2Fcommon_runtime%2Fnext_pluggable_device%2Fc_plugin_coordination_service_agent_test.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -102,6 +102,10 @@ class TestCoordinationClient : public CoordinationClient {\n               (const TryGetKeyValueRequest*, TryGetKeyValueResponse*,\n                StatusCallback),\n               (override));\n+  MOCK_METHOD(void, IncrementKeyValueAsync,\n+              (const IncrementKeyValueRequest*, IncrementKeyValueResponse*,\n+               StatusCallback),\n+              (override));\n   MOCK_METHOD(void, InsertKeyValueAsync,\n               (const InsertKeyValueRequest*, InsertKeyValueResponse*,\n                StatusCallback),"
        },
        {
            "sha": "c282b1a243548216aeafdc77fd13166c116bab31",
            "filename": "third_party/xla/xla/pjrt/distributed/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2FBUILD?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -74,6 +74,8 @@ cc_library(\n         \"//xla/tsl/distributed_runtime/coordination:coordination_client\",\n         \"//xla/tsl/distributed_runtime/coordination:coordination_service_agent\",\n         \"//xla/tsl/distributed_runtime/rpc/coordination:grpc_coordination_client\",\n+        \"//xla/tsl/platform:env\",\n+        \"//xla/tsl/platform:statusor\",\n         \"//xla/tsl/protobuf:coordination_config_proto_cc\",\n         \"//xla/tsl/protobuf:coordination_service_proto_cc\",\n         \"@com_google_absl//absl/log\","
        },
        {
            "sha": "254a50bbe9ac4ec4251ccce4bbdd784435b47ae3",
            "filename": "third_party/xla/xla/pjrt/distributed/client.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -34,9 +34,9 @@ limitations under the License.\n #include \"xla/tsl/distributed_runtime/coordination/coordination_client.h\"\n #include \"xla/tsl/distributed_runtime/coordination/coordination_service_agent.h\"\n #include \"xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_client.h\"\n+#include \"xla/tsl/platform/statusor.h\"\n #include \"xla/tsl/protobuf/coordination_config.pb.h\"\n #include \"xla/tsl/protobuf/coordination_service.pb.h\"\n-#include \"tsl/platform/statusor.h\"\n \n namespace xla {\n \n@@ -55,6 +55,8 @@ class DistributedRuntimeCoordinationServiceClient\n   absl::StatusOr<std::string> BlockingKeyValueGet(\n       absl::string_view key, absl::Duration timeout) override;\n   absl::StatusOr<std::string> KeyValueTryGet(absl::string_view key) override;\n+  absl::StatusOr<int64_t> KeyValueIncrement(absl::string_view key,\n+                                            int64_t increment) override;\n   absl::StatusOr<std::vector<std::pair<std::string, std::string>>>\n   KeyValueDirGet(absl::string_view key) override;\n   absl::Status KeyValueSet(absl::string_view key,\n@@ -153,6 +155,12 @@ DistributedRuntimeCoordinationServiceClient::KeyValueTryGet(\n   return coord_agent_->TryGetKeyValue(key);\n }\n \n+absl::StatusOr<int64_t>\n+DistributedRuntimeCoordinationServiceClient::KeyValueIncrement(\n+    absl::string_view key, int64_t increment) {\n+  return coord_agent_->IncrementKeyValue(key, increment);\n+}\n+\n absl::StatusOr<std::vector<std::pair<std::string, std::string>>>\n DistributedRuntimeCoordinationServiceClient::KeyValueDirGet(\n     absl::string_view key) {"
        },
        {
            "sha": "f6d2a412a471ae3090a523d860d4c12a9a7048e9",
            "filename": "third_party/xla/xla/pjrt/distributed/client.h",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient.h?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -32,7 +32,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"grpcpp/channel.h\"\n #include \"xla/pjrt/distributed/key_value_store_interface.h\"\n-#include \"tsl/platform/env.h\"\n+#include \"xla/tsl/platform/env.h\"\n \n namespace tsl {\n class CoordinationServiceAgent;\n@@ -91,7 +91,7 @@ class DistributedRuntimeClient {\n     bool poll_for_error_from_service_at_startup = true;\n \n     // If true, a multi-controller JAX job can continue even if this client\n-    // fails. Otherwise, the job will fail when the task failes.\n+    // fails. Otherwise, the job will fail when the task fails.\n     bool recoverable = false;\n   };\n \n@@ -119,6 +119,11 @@ class DistributedRuntimeClient {\n   // Returns `NotFoundError` immediately if the key is not found.\n   virtual absl::StatusOr<std::string> KeyValueTryGet(absl::string_view key) = 0;\n \n+  // Returns `FailedPreconditionError` if the corresponding value is not int\n+  // convertible.\n+  virtual absl::StatusOr<int64_t> KeyValueIncrement(absl::string_view key,\n+                                                    int64_t increment) = 0;\n+\n   // Get all key-value pairs under a directory (key).\n   // A value is considered to be in the directory if its key is prefixed with\n   // the directory."
        },
        {
            "sha": "9d8ac4c5290bbf96dd680fdd4fcbcf16884e9521",
            "filename": "third_party/xla/xla/pjrt/distributed/client_server_test.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient_server_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient_server_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Fpjrt%2Fdistributed%2Fclient_server_test.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -61,7 +61,8 @@ using ::testing::Matches;\n using ::testing::Pair;\n using ::testing::UnorderedElementsAre;\n using ::tsl::proto_testing::EqualsProto;\n-using tsl::testing::StatusIs;\n+using ::tsl::testing::IsOkAndHolds;\n+using ::tsl::testing::StatusIs;\n \n constexpr absl::Duration kHeartbeatTimeout = absl::Milliseconds(2500);\n constexpr absl::Duration kBarrierTimeout = absl::Milliseconds(200);\n@@ -1087,6 +1088,15 @@ TEST_F(ClientServerTest, KeyValueTryGet) {\n   EXPECT_EQ(result.value(), \"value\");\n }\n \n+TEST_F(ClientServerTest, KeyValueIncrement) {\n+  StartService(/*num_nodes=*/1);\n+  auto client = GetClient(/*node_id=*/0);\n+  TF_ASSERT_OK(client->Connect());\n+  TF_ASSERT_OK(client->KeyValueSet(\"test_key\", \"10\"));\n+  EXPECT_THAT(client->KeyValueIncrement(\"test_key\", 1), IsOkAndHolds(11));\n+  EXPECT_THAT(client->KeyValueTryGet(\"test_key\"), IsOkAndHolds(\"11\"));\n+}\n+\n TEST_F(ClientServerTest, KeyValueDelete) {\n   StartService(/*num_nodes=*/1);\n   auto client = GetClient(/*node_id=*/0);"
        },
        {
            "sha": "895164ea303893958d14148e542c58ab19380999",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/BUILD",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2FBUILD",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2FBUILD",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2FBUILD?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -170,7 +170,6 @@ tsl_cc_test(\n         \"//xla/tsl/distributed_runtime:call_options\",\n         \"//xla/tsl/lib/core:status_test_util\",\n         \"//xla/tsl/platform:env\",\n-        \"//xla/tsl/platform:env_impl\",\n         \"//xla/tsl/platform:status\",\n         \"//xla/tsl/platform:test\",\n         \"//xla/tsl/protobuf:coordination_config_proto_cc_impl\",\n@@ -179,6 +178,8 @@ tsl_cc_test(\n         \"@com_google_absl//absl/log:check\",\n         \"@com_google_absl//absl/memory\",\n         \"@com_google_absl//absl/status\",\n+        \"@com_google_absl//absl/status:status_matchers\",\n+        \"@com_google_absl//absl/strings:string_view\",\n         \"@com_google_absl//absl/time\",\n         \"@com_google_googletest//:gtest_main\",\n     ],"
        },
        {
            "sha": "61998eb087c43955967a0e230b2a35663c3c757e",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_client.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_client.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_client.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_client.h?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -40,6 +40,8 @@ using tensorflow::GetTaskStateRequest;\n using tensorflow::GetTaskStateResponse;\n using tensorflow::HeartbeatRequest;\n using tensorflow::HeartbeatResponse;\n+using tensorflow::IncrementKeyValueRequest;\n+using tensorflow::IncrementKeyValueResponse;\n using tensorflow::InsertKeyValueRequest;\n using tensorflow::InsertKeyValueResponse;\n using tensorflow::PollForErrorRequest;\n@@ -125,6 +127,10 @@ class CoordinationClient {\n                                    GetKeyValueDirResponse* response,\n                                    StatusCallback done) = 0;\n \n+  virtual void IncrementKeyValueAsync(const IncrementKeyValueRequest* request,\n+                                      IncrementKeyValueResponse* response,\n+                                      StatusCallback done) = 0;\n+\n   virtual void DeleteKeyValueAsync(const DeleteKeyValueRequest* request,\n                                    DeleteKeyValueResponse* response,\n                                    StatusCallback done) = 0;"
        },
        {
            "sha": "58fca32ed1abe575984f4924b6d909607dace8e9",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_agent.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -25,7 +25,6 @@ limitations under the License.\n #include <optional>\n #include <random>\n #include <string>\n-#include <tuple>\n #include <utility>\n #include <vector>\n \n@@ -36,6 +35,7 @@ limitations under the License.\n #include \"absl/log/check.h\"\n #include \"absl/log/log.h\"\n #include \"absl/status/status.h\"\n+#include \"absl/strings/numbers.h\"\n #include \"absl/strings/str_cat.h\"\n #include \"absl/strings/str_format.h\"\n #include \"absl/strings/string_view.h\"\n@@ -47,6 +47,7 @@ limitations under the License.\n #include \"absl/types/span.h\"\n #include \"xla/tsl/distributed_runtime/call_options.h\"\n #include \"xla/tsl/distributed_runtime/coordination/coordination_client.h\"\n+#include \"xla/tsl/distributed_runtime/coordination/coordination_service.h\"\n #include \"xla/tsl/distributed_runtime/coordination/coordination_service_error_util.h\"\n #include \"xla/tsl/framework/cancellation.h\"\n #include \"xla/tsl/lib/monitoring/gauge.h\"\n@@ -726,6 +727,37 @@ absl::StatusOr<std::string> CoordinationServiceAgent::TryGetKeyValue(\n   return result;\n }\n \n+absl::StatusOr<int64_t> CoordinationServiceAgent::IncrementKeyValue(\n+    absl::string_view key, int64_t increment) {\n+  absl::Notification n;\n+  absl::StatusOr<int64_t> result;\n+  IncrementKeyValueRequest request;\n+  request.set_key(key.data(), key.size());\n+  request.set_increment(increment);\n+  VLOG(3) << \"IncrementKeyValueRequest: \" << request.DebugString();\n+  IncrementKeyValueResponse response;\n+  leader_client_->IncrementKeyValueAsync(\n+      &request, &response, [&](const absl::Status& s) {\n+        if (s.ok()) {\n+          int64_t result_value;\n+          if (!absl::SimpleAtoi(response.kv().value(), &result_value)) {\n+            result = absl::InternalError(absl::StrCat(\n+                \"Failed to parse increment key value: \", response.kv().value(),\n+                \" for key: \", key));\n+            return;\n+          }\n+          result = result_value;\n+          VLOG(3) << \"IncrementKeyValueResponse: \" << result.value();\n+        } else {\n+          result = s;\n+          VLOG(3) << \"IncrementKeyValueResponse: \" << s;\n+        }\n+        n.Notify();\n+      });\n+  n.WaitForNotification();\n+  return result;\n+}\n+\n absl::StatusOr<std::vector<KeyValueEntry>>\n CoordinationServiceAgent::GetKeyValueDir(absl::string_view key) {\n   absl::Notification n;"
        },
        {
            "sha": "6a8991d998db3aed2ef5fec83954192a6499f39b",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_agent.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent.h?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -209,6 +209,11 @@ class CoordinationServiceAgent {\n   //   - NotFound: the requested key does not exist.\n   absl::StatusOr<std::string> TryGetKeyValue(absl::string_view key);\n \n+  // Increment the value of a key if it is int convertible.\n+  //   - FailedPrecondition: the key is not convertible to an int.\n+  absl::StatusOr<int64_t> IncrementKeyValue(absl::string_view key,\n+                                            int64_t increment);\n+\n   // Get all values under a directory (key).\n   // A value is considered to be in the directory if its key is prefixed with\n   // the directory."
        },
        {
            "sha": "c2d864bd4cefe2a0ff9b491425afae33ef2099ee",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_agent_test.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 6,
            "changes": 35,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_agent_test.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -16,7 +16,6 @@ limitations under the License.\n #include \"xla/tsl/distributed_runtime/coordination/coordination_service_agent.h\"\n \n #include <memory>\n-#include <ostream>\n #include <string>\n #include <utility>\n #include <vector>\n@@ -25,6 +24,8 @@ limitations under the License.\n #include \"absl/log/log.h\"\n #include \"absl/memory/memory.h\"\n #include \"absl/status/status.h\"\n+#include \"absl/status/status_matchers.h\"\n+#include \"absl/strings/string_view.h\"\n #include \"absl/time/clock.h\"\n #include \"absl/time/time.h\"\n #include \"xla/tsl/distributed_runtime/call_options.h\"\n@@ -50,6 +51,7 @@ using ::testing::Return;\n using ::testing::SetArgPointee;\n using ::testing::UnorderedPointwise;\n using ::testing::WithArgs;\n+using ::tsl::testing::IsOkAndHolds;\n using ::tsl::testing::StatusIs;\n \n MATCHER(KvEq, \"simple KeyValueEntry matcher\") {\n@@ -81,6 +83,10 @@ class TestCoordinationClient : public CoordinationClient {\n               (const TryGetKeyValueRequest*, TryGetKeyValueResponse*,\n                StatusCallback),\n               (override));\n+  MOCK_METHOD(void, IncrementKeyValueAsync,\n+              (const IncrementKeyValueRequest*, IncrementKeyValueResponse*,\n+               StatusCallback),\n+              (override));\n   MOCK_METHOD(void, GetKeyValueDirAsync,\n               (const GetKeyValueDirRequest*, GetKeyValueDirResponse*,\n                StatusCallback),\n@@ -369,6 +375,23 @@ TEST_F(CoordinationServiceAgentTest, TryGetKeyValue_Simple_Success) {\n   EXPECT_EQ(*result, test_value);\n }\n \n+TEST_F(CoordinationServiceAgentTest, IncrementKeyValue_Simple_Success) {\n+  constexpr absl::string_view test_key = \"test_key\";\n+  constexpr absl::string_view test_value = \"11\";\n+  // Mock server response: set key-value pair and invoke done callback.\n+  IncrementKeyValueResponse mocked_response;\n+  auto kv = mocked_response.mutable_kv();\n+  kv->set_key(test_key);\n+  kv->set_value(test_value);\n+  ON_CALL(*GetClient(), IncrementKeyValueAsync(_, _, _))\n+      .WillByDefault(DoAll(SetArgPointee<1>(mocked_response),\n+                           InvokeArgument<2>(absl::OkStatus())));\n+  // Initialize coordination agent.\n+  InitializeAgent();\n+  auto result = agent_->IncrementKeyValue(test_key, 1);\n+  EXPECT_THAT(result, IsOkAndHolds(11));\n+}\n+\n TEST_F(CoordinationServiceAgentTest, GetKeyValueDir_Simple_Success) {\n   const std::string test_key = \"test_key_dir\";\n   std::vector<KeyValueEntry> test_values;\n@@ -437,17 +460,17 @@ TEST_F(CoordinationServiceAgentTest, ConnectAfterReset_WithErrorPolling) {\n   CoordinationServiceConfig config;\n   config.set_poll_for_error_from_service_at_startup(true);\n   InitializeAgent(config);\n-  // The agent will be in ERROR state after the first call to Connect() because\n-  // the error polling thread will be created and will immediately return an\n-  // error.\n+  // The agent will be in ERROR state after the first call to Connect()\n+  // because the error polling thread will be created and will immediately\n+  // return an error.\n   TF_ASSERT_OK(agent_->Connect());\n   // Wait a bit for the error polling thread to start.\n   absl::SleepFor(absl::Seconds(2));\n   ASSERT_TRUE(agent_->IsError());\n \n   TF_ASSERT_OK(agent_->Reset());\n-  // Agent should be able to reconnect to the service after resetting. The error\n-  // polling thread will be recreated when the agent is connected again.\n+  // Agent should be able to reconnect to the service after resetting. The\n+  // error polling thread will be recreated when the agent is connected again.\n   TF_EXPECT_OK(agent_->Connect());\n   absl::SleepFor(absl::Seconds(2));\n   // The agent should again be in ERROR state after Connect()."
        },
        {
            "sha": "3ee1ac206087bbb95229259da3d21c4cc3f883a0",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_rpc_handler.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_rpc_handler.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_rpc_handler.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_rpc_handler.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -270,6 +270,26 @@ void CoordinationServiceRpcHandler::TryGetKeyValueAsync(\n   done(absl::OkStatus());\n }\n \n+void CoordinationServiceRpcHandler::IncrementKeyValueAsync(\n+    const tensorflow::IncrementKeyValueRequest* request,\n+    tensorflow::IncrementKeyValueResponse* response, StatusCallback done) {\n+  absl::ReaderMutexLock l(&mu_);\n+  if (service_ == nullptr) {\n+    done(MakeCoordinationError(\n+        absl::InternalError(\"Coordination service is not enabled.\")));\n+    return;\n+  }\n+  auto result =\n+      service_->IncrementKeyValue(request->key(), request->increment());\n+  if (!result.ok()) {\n+    done(MakeCoordinationError(result.status()));\n+    return;\n+  }\n+  response->mutable_kv()->set_key(request->key());\n+  response->mutable_kv()->set_value(result.value());\n+  done(absl::OkStatus());\n+}\n+\n void CoordinationServiceRpcHandler::GetKeyValueDirAsync(\n     const tensorflow::GetKeyValueDirRequest* request,\n     tensorflow::GetKeyValueDirResponse* response, StatusCallback done) {"
        },
        {
            "sha": "4e64a185eda38c3a5a3c1cc18772cdd2a14a2bdb",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_rpc_handler.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_rpc_handler.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_rpc_handler.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_rpc_handler.h?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -16,7 +16,6 @@ limitations under the License.\n #ifndef XLA_TSL_DISTRIBUTED_RUNTIME_COORDINATION_COORDINATION_SERVICE_RPC_HANDLER_H_\n #define XLA_TSL_DISTRIBUTED_RUNTIME_COORDINATION_COORDINATION_SERVICE_RPC_HANDLER_H_\n \n-#include \"absl/status/status.h\"\n #include \"absl/synchronization/mutex.h\"\n #include \"xla/tsl/distributed_runtime/coordination/coordination_service.h\"\n #include \"xla/tsl/distributed_runtime/coordination/coordination_service_agent.h\"\n@@ -77,6 +76,10 @@ class CoordinationServiceRpcHandler {\n                         tensorflow::GetKeyValueResponse* response,\n                         StatusCallback done);\n \n+  void IncrementKeyValueAsync(\n+      const tensorflow::IncrementKeyValueRequest* request,\n+      tensorflow::IncrementKeyValueResponse* response, StatusCallback done);\n+\n   void TryGetKeyValueAsync(const tensorflow::TryGetKeyValueRequest* request,\n                            tensorflow::TryGetKeyValueResponse* response,\n                            StatusCallback done);"
        },
        {
            "sha": "ee9cb68523f611f5735d554fdf62de078f04c578",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/coordination/coordination_service_test.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_test.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_test.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Fcoordination%2Fcoordination_service_test.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -128,6 +128,7 @@ class TestCoordinationClient : public CoordinationClient {\n   UNIMPLEMENTED(GetTaskState);\n   UNIMPLEMENTED(InsertKeyValue);\n   UNIMPLEMENTED(TryGetKeyValue);\n+  UNIMPLEMENTED(IncrementKeyValue);\n   UNIMPLEMENTED(GetKeyValueDir);\n   UNIMPLEMENTED(DeleteKeyValue);\n   UNIMPLEMENTED(CancelBarrier);"
        },
        {
            "sha": "beb3ccdc23c7575f1a2b714225971b1b681927e0",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_client.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_client.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_client.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_client.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -57,6 +57,8 @@ using tensorflow::GetTaskStateRequest;\n using tensorflow::GetTaskStateResponse;\n using tensorflow::HeartbeatRequest;\n using tensorflow::HeartbeatResponse;\n+using tensorflow::IncrementKeyValueRequest;\n+using tensorflow::IncrementKeyValueResponse;\n using tensorflow::InsertKeyValueRequest;\n using tensorflow::InsertKeyValueResponse;\n using tensorflow::PollForErrorRequest;\n@@ -247,6 +249,16 @@ class GrpcCoordinationClient : public CoordinationClient {\n         &target_);\n   }\n \n+  void IncrementKeyValueAsync(const IncrementKeyValueRequest* request,\n+                              IncrementKeyValueResponse* response,\n+                              StatusCallback done) override {\n+    new RPCState<protobuf::Message>(\n+        &stub_, cq_, \"/tensorflow.CoordinationService/IncrementKeyValue\",\n+        *request, response, std::move(done), /*call_opts=*/nullptr,\n+        /*threadpool=*/nullptr, /*max_retries=*/0, /*fail_fast=*/true,\n+        &target_);\n+  }\n+\n   void GetKeyValueDirAsync(const GetKeyValueDirRequest* request,\n                            GetKeyValueDirResponse* response,\n                            StatusCallback done) override {"
        },
        {
            "sha": "6e7e416b76e9adf0a1482b3533cdc69e5ce53566",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_service_impl.cc",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_service_impl.cc",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_service_impl.cc?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -54,6 +54,7 @@ void GrpcCoordinationServiceImpl::HandleRPCsLoop() {\n   ENQUEUE_REQUEST(InsertKeyValue);\n   ENQUEUE_REQUEST(GetKeyValue);\n   ENQUEUE_REQUEST(TryGetKeyValue);\n+  ENQUEUE_REQUEST(IncrementKeyValue);\n   ENQUEUE_REQUEST(GetKeyValueDir);\n   ENQUEUE_REQUEST(DeleteKeyValue);\n   ENQUEUE_REQUEST(Barrier);"
        },
        {
            "sha": "787f1e8e8b06369d589c451ec7190f0cc1082ef7",
            "filename": "third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_service_impl.h",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_service_impl.h",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fdistributed_runtime%2Frpc%2Fcoordination%2Fgrpc_coordination_service_impl.h?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -95,6 +95,7 @@ class GrpcCoordinationServiceImpl : public AsyncServiceInterface {\n   HANDLER(InsertKeyValue);\n   HANDLER(GetKeyValue);\n   HANDLER(TryGetKeyValue);\n+  HANDLER(IncrementKeyValue);\n   HANDLER(GetKeyValueDir);\n   HANDLER(DeleteKeyValue);\n   HANDLER(Barrier);"
        },
        {
            "sha": "904034018f00e847ce23f030537502838c3c66bb",
            "filename": "third_party/xla/xla/tsl/protobuf/coordination_service.proto",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/tensorflow/tensorflow/blob/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fprotobuf%2Fcoordination_service.proto",
            "raw_url": "https://github.com/tensorflow/tensorflow/raw/09595ce2860c317285394b305c4222d306e6fceb/third_party%2Fxla%2Fxla%2Ftsl%2Fprotobuf%2Fcoordination_service.proto",
            "contents_url": "https://api.github.com/repos/tensorflow/tensorflow/contents/third_party%2Fxla%2Fxla%2Ftsl%2Fprotobuf%2Fcoordination_service.proto?ref=09595ce2860c317285394b305c4222d306e6fceb",
            "patch": "@@ -241,6 +241,15 @@ message TryGetKeyValueResponse {\n   KeyValueEntry kv = 1;\n }\n \n+message IncrementKeyValueRequest {\n+  string key = 1;\n+  int64 increment = 2;\n+}\n+\n+message IncrementKeyValueResponse {\n+  KeyValueEntry kv = 1;\n+}\n+\n message GetKeyValueDirRequest {\n   string directory_key = 1;\n }\n@@ -385,6 +394,13 @@ service CoordinationService {\n   // error if the requested key does not exist.\n   rpc TryGetKeyValue(TryGetKeyValueRequest) returns (TryGetKeyValueResponse);\n \n+  // Increment configuration key-value. The request does not block, if the key\n+  // does not exist then it is initialize to 0 and then incremented.\n+  rpc IncrementKeyValue(IncrementKeyValueRequest)\n+      returns (IncrementKeyValueResponse) {\n+    // [AUTOMATION]: Internal rpc option goes here.\n+  }\n+\n   // Same as GetKeyValue, but returns all values that have keys which are\n   // prefixed with the directory key.\n   rpc GetKeyValueDir(GetKeyValueDirRequest) returns (GetKeyValueDirResponse) {"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 163,
        "deletions": 13
    }
}