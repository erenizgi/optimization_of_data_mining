{
    "author": "freakboy3742",
    "message": "Fixed #9161 -- Ensure that ModelMultipleChoiceField respects to_field_name in validation. Thanks to Honza for the report, and Gregor MÃ¼llegger for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15587 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1abf126e612fca1efec2986400e2996be8130d22",
    "files": [
        {
            "sha": "912bdf36a83f0db06d6bd509b3f4c99777751d10",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/1abf126e612fca1efec2986400e2996be8130d22/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/1abf126e612fca1efec2986400e2996be8130d22/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=1abf126e612fca1efec2986400e2996be8130d22",
            "patch": "@@ -1006,13 +1006,14 @@ def clean(self, value):\n             return []\n         if not isinstance(value, (list, tuple)):\n             raise ValidationError(self.error_messages['list'])\n+        key = self.to_field_name or 'pk'\n         for pk in value:\n             try:\n-                self.queryset.filter(pk=pk)\n+                self.queryset.filter(**{key: pk})\n             except ValueError:\n                 raise ValidationError(self.error_messages['invalid_pk_value'] % pk)\n-        qs = self.queryset.filter(pk__in=value)\n-        pks = set([force_unicode(o.pk) for o in qs])\n+        qs = self.queryset.filter(**{'%s__in' % key: value})\n+        pks = set([force_unicode(getattr(o, key)) for o in qs])\n         for val in value:\n             if force_unicode(val) not in pks:\n                 raise ValidationError(self.error_messages['invalid_choice'] % val)"
        },
        {
            "sha": "2e820a677943903fae518545cf77b6b596ca28a5",
            "filename": "tests/modeltests/model_forms/models.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/1abf126e612fca1efec2986400e2996be8130d22/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/1abf126e612fca1efec2986400e2996be8130d22/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py?ref=1abf126e612fca1efec2986400e2996be8130d22",
            "patch": "@@ -1562,6 +1562,25 @@ class FlexibleDatePost(models.Model):\n <tr><th><label for=\"id_description\">Description:</label></th><td><input type=\"text\" name=\"description\" id=\"id_description\" /></td></tr>\n <tr><th><label for=\"id_url\">The URL:</label></th><td><input id=\"id_url\" type=\"text\" name=\"url\" maxlength=\"40\" /></td></tr>\n \n+# to_field_name should also work on ModelMultipleChoiceField ##################\n+\n+>>> field = ModelMultipleChoiceField(Inventory.objects.all(), to_field_name='barcode')\n+>>> for choice in field.choices:\n+...     print choice\n+(86, u'Apple')\n+(22, u'Pear')\n+(87, u'Core')\n+>>> field.clean([86])\n+[<Inventory: Apple>]\n+\n+>>> class SelectInventoryForm(forms.Form):\n+...     items = ModelMultipleChoiceField(Inventory.objects.all(), to_field_name='barcode')\n+>>> form = SelectInventoryForm({'items': [87, 22]})\n+>>> form.is_valid()\n+True\n+>>> form.cleaned_data\n+{'items': [<Inventory: Pear>, <Inventory: Core>]}\n+\n # Model field that returns None to exclude itself with explicit fields ########\n \n >>> class CustomFieldForExclusionForm(ModelForm):"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 23,
        "deletions": 3
    }
}