{
    "author": "PaulMcMillan",
    "message": "Improved get_random_string().\n\nImproved the behavior of get_random_string to re-seed itself each time it is called\nif the system does not have a secure random number generator. This will change the\nproperties of the random string produced, but will be unpredictable to an attacker.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17581 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1525874238fd705ec17a066291935a9316bd3044",
    "files": [
        {
            "sha": "44b7faf492ee8526429d83e8d5185c03e7652adc",
            "filename": "django/utils/crypto.py",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/1525874238fd705ec17a066291935a9316bd3044/django%2Futils%2Fcrypto.py",
            "raw_url": "https://github.com/django/django/raw/1525874238fd705ec17a066291935a9316bd3044/django%2Futils%2Fcrypto.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcrypto.py?ref=1525874238fd705ec17a066291935a9316bd3044",
            "patch": "@@ -7,12 +7,18 @@\n import hashlib\n import binascii\n import operator\n+import time\n \n+# Use the system PRNG if possible\n import random\n try:\n     random = random.SystemRandom()\n+    using_sysrandom = True\n except NotImplementedError:\n-    pass\n+    import warnings\n+    warnings.warn('A secure pseudo-random number generator is not available '\n+                  'on your system. Falling back to Mersenne Twister.')\n+    using_sysrandom = False\n \n from django.conf import settings\n \n@@ -47,11 +53,25 @@ def get_random_string(length=12,\n                       allowed_chars='abcdefghijklmnopqrstuvwxyz'\n                                     'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'):\n     \"\"\"\n-    Returns a random string of length characters from the set of a-z, A-Z, 0-9.\n+    Returns a securely generated random string.\n \n     The default length of 12 with the a-z, A-Z, 0-9 character set returns\n     a 71-bit value. log_2((26+26+10)^12) =~ 71 bits\n     \"\"\"\n+    if not using_sysrandom:\n+        # This is ugly, and a hack, but it makes things better than\n+        # the alternative of predictability. This re-seeds the PRNG\n+        # using a value that is hard for an attacker to predict, every\n+        # time a random string is required. This may change the\n+        # properties of the chosen random sequence slightly, but this\n+        # is better than absolute predictability.\n+        random.seed(\n+            hashlib.sha256(\n+                \"%s%s%s\" % (\n+                    random.getstate(),\n+                    time.time(),\n+                    settings.SECRET_KEY)\n+                ).digest())\n     return ''.join([random.choice(allowed_chars) for i in range(length)])\n \n "
        }
    ],
    "stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
    }
}