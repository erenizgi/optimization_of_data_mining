{
    "author": "spookylukey",
    "message": "Fixed #14099 - BaseModelFormSet should use _should_delete_form\n\nThanks to kenth for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15612 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "13f9fd38dc299a682c61e175c83070a7c5a84103",
    "files": [
        {
            "sha": "1356c9f5170b5ce7577ee5d2ff63335e10c24e95",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/13f9fd38dc299a682c61e175c83070a7c5a84103/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/13f9fd38dc299a682c61e175c83070a7c5a84103/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=13f9fd38dc299a682c61e175c83070a7c5a84103",
            "patch": "@@ -17,7 +17,7 @@\n from fields import Field, ChoiceField\n from widgets import SelectMultiple, HiddenInput, MultipleHiddenInput\n from widgets import media_property\n-from formsets import BaseFormSet, formset_factory, DELETION_FIELD_NAME\n+from formsets import BaseFormSet, formset_factory\n \n __all__ = (\n     'ModelForm', 'BaseModelForm', 'model_to_dict', 'fields_for_model',\n@@ -588,13 +588,10 @@ def save_existing_objects(self, commit=True):\n             pk_value = getattr(pk_value, 'pk', pk_value)\n \n             obj = self._existing_object(pk_value)\n-            if self.can_delete:\n-                raw_delete_value = form._raw_value(DELETION_FIELD_NAME)\n-                should_delete = form.fields[DELETION_FIELD_NAME].clean(raw_delete_value)\n-                if should_delete:\n-                    self.deleted_objects.append(obj)\n-                    obj.delete()\n-                    continue\n+            if self.can_delete and self._should_delete_form(form):\n+                self.deleted_objects.append(obj)\n+                obj.delete()\n+                continue\n             if form.has_changed():\n                 self.changed_objects.append((obj, form.changed_data))\n                 saved_instances.append(self.save_existing(form, obj, commit=commit))\n@@ -609,11 +606,8 @@ def save_new_objects(self, commit=True):\n                 continue\n             # If someone has marked an add form for deletion, don't save the\n             # object.\n-            if self.can_delete:\n-                raw_delete_value = form._raw_value(DELETION_FIELD_NAME)\n-                should_delete = form.fields[DELETION_FIELD_NAME].clean(raw_delete_value)\n-                if should_delete:\n-                    continue\n+            if self.can_delete and self._should_delete_form(form):\n+                continue\n             self.new_objects.append(self.save_new(form, commit=commit))\n             if not commit:\n                 self.saved_forms.append(form)"
        },
        {
            "sha": "eb78a03ac3da9ff8c6f7e8fb9eb0f15417dfcab0",
            "filename": "tests/regressiontests/model_formsets_regress/tests.py",
            "status": "modified",
            "additions": 123,
            "deletions": 1,
            "changes": 124,
            "blob_url": "https://github.com/django/django/blob/13f9fd38dc299a682c61e175c83070a7c5a84103/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/13f9fd38dc299a682c61e175c83070a7c5a84103/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py?ref=13f9fd38dc299a682c61e175c83070a7c5a84103",
            "patch": "@@ -1,6 +1,7 @@\n from django import forms\n+from django.forms.formsets import BaseFormSet, DELETION_FIELD_NAME\n from django.forms.util import ErrorDict, ErrorList\n-from django.forms.models import modelform_factory, inlineformset_factory, modelformset_factory\n+from django.forms.models import modelform_factory, inlineformset_factory, modelformset_factory, BaseModelFormSet\n from django.test import TestCase\n \n from models import User, UserSite, Restaurant, Manager, Network, Host\n@@ -283,3 +284,124 @@ def test_modelformset_custom_callback(self):\n         modelformset_factory(UserSite, form=UserSiteForm,\n                              formfield_callback=callback)\n         self.assertCallbackCalled(callback)\n+\n+\n+class BaseCustomDeleteFormSet(BaseFormSet):\n+    \"\"\"\n+    A formset mix-in that lets a form decide if it's to be deleted.\n+    Works for BaseFormSets. Also works for ModelFormSets with #14099 fixed.\n+\n+    form.should_delete() is called. The formset delete field is also suppressed.\n+    \"\"\"\n+    def add_fields(self, form, index):\n+        super(BaseCustomDeleteFormSet, self).add_fields(form, index)\n+        self.can_delete = True\n+        if DELETION_FIELD_NAME in form.fields:\n+            del form.fields[DELETION_FIELD_NAME]\n+\n+    def _should_delete_form(self, form):\n+        return hasattr(form, 'should_delete') and form.should_delete()\n+\n+\n+class FormfieldShouldDeleteFormTests(TestCase):\n+    \"\"\"\n+    Regression for #14099: BaseModelFormSet should use ModelFormSet method _should_delete_form\n+    \"\"\"\n+\n+    class BaseCustomDeleteModelFormSet(BaseModelFormSet, BaseCustomDeleteFormSet):\n+        \"\"\" Model FormSet with CustomDelete MixIn \"\"\"\n+\n+    class CustomDeleteUserForm(forms.ModelForm):\n+        \"\"\" A model form with a 'should_delete' method \"\"\"\n+        class Meta:\n+            model = User\n+\n+        def should_delete(self):\n+            \"\"\" delete form if odd PK \"\"\"\n+            return self.instance.id % 2 != 0\n+\n+    NormalFormset = modelformset_factory(User, form=CustomDeleteUserForm, can_delete=True)\n+    DeleteFormset = modelformset_factory(User, form=CustomDeleteUserForm, formset=BaseCustomDeleteModelFormSet)\n+\n+    data = {\n+            'form-TOTAL_FORMS': '4',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '4',\n+            'form-0-username': 'John',\n+            'form-0-serial': '1',\n+            'form-1-username': 'Paul',\n+            'form-1-serial': '2',\n+            'form-2-username': 'George',\n+            'form-2-serial': '3',\n+            'form-3-username': 'Ringo',\n+            'form-3-serial': '5',\n+            }\n+\n+    bound_ids = {\n+            'form-INITIAL_FORMS': '4',\n+            'form-0-id': '1',\n+            'form-1-id': '2',\n+            'form-2-id': '3',\n+            'form-3-id': '4',\n+            }\n+\n+    delete_all_ids = {\n+            'form-0-DELETE': '1',\n+            'form-1-DELETE': '1',\n+            'form-2-DELETE': '1',\n+            'form-3-DELETE': '1',\n+            }\n+\n+    def test_init_database(self):\n+        \"\"\" Add test data to database via formset \"\"\"\n+        formset = self.NormalFormset(self.data)\n+        self.assertTrue(formset.is_valid())\n+        self.assertEqual(len(formset.save()), 4)\n+\n+    def test_no_delete(self):\n+        \"\"\" Verify base formset doesn't modify database \"\"\"\n+        # reload database\n+        self.test_init_database()\n+\n+        # pass standard data dict & see none updated\n+        data = dict(self.data)\n+        data.update(self.bound_ids)\n+        formset = self.NormalFormset(data, queryset=User.objects.all())\n+        self.assertTrue(formset.is_valid())\n+        self.assertEqual(len(formset.save()), 0)\n+        self.assertEqual(len(User.objects.all()), 4)\n+\n+    def test_all_delete(self):\n+        \"\"\" Verify base formset honors DELETE field \"\"\"\n+        # reload database\n+        self.test_init_database()\n+\n+        # create data dict with all fields marked for deletion\n+        data = dict(self.data)\n+        data.update(self.bound_ids)\n+        data.update(self.delete_all_ids)\n+        formset = self.NormalFormset(data, queryset=User.objects.all())\n+        self.assertTrue(formset.is_valid())\n+        self.assertEqual(len(formset.save()), 0)\n+        self.assertEqual(len(User.objects.all()), 0)\n+\n+    def test_custom_delete(self):\n+        \"\"\" Verify DeleteFormset ignores DELETE field and uses form method \"\"\"\n+        # reload database\n+        self.test_init_database()\n+\n+        # Create formset with custom Delete function\n+        # create data dict with all fields marked for deletion\n+        data = dict(self.data)\n+        data.update(self.bound_ids)\n+        data.update(self.delete_all_ids)\n+        formset = self.DeleteFormset(data, queryset=User.objects.all())\n+\n+        # verify two were deleted\n+        self.assertTrue(formset.is_valid())\n+        self.assertEqual(len(formset.save()), 0)\n+        self.assertEqual(len(User.objects.all()), 2)\n+\n+        # verify no \"odd\" PKs left\n+        odd_ids = [user.id for user in User.objects.all() if user.id % 2]\n+        self.assertEqual(len(odd_ids), 0)"
        }
    ],
    "stats": {
        "total": 144,
        "additions": 130,
        "deletions": 14
    }
}