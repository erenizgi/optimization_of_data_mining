{
    "author": "andrewgodwin",
    "message": "Fixed #11193 -- WSGI handler not properly handling lock on error in load_middleware. Thanks to Phillip Sitbon.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15205 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ba585a2c6dbbbc918f5ceffd54eb31212bca85ef",
    "files": [
        {
            "sha": "2fd99921b8e70d9e36fdb05e28af80eb5e262e8f",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=ba585a2c6dbbbc918f5ceffd54eb31212bca85ef",
            "patch": "@@ -242,10 +242,16 @@ def __call__(self, environ, start_response):\n         # settings weren't available.\n         if self._request_middleware is None:\n             self.initLock.acquire()\n-            # Check that middleware is still uninitialised.\n-            if self._request_middleware is None:\n-                self.load_middleware()\n-            self.initLock.release()\n+            try:\n+                # Check that middleware is still uninitialised.\n+                if self._request_middleware is None:\n+                    self.load_middleware()\n+            except:\n+                # Unload whatever middleware we got\n+                self._request_middleware = None\n+                raise\n+            finally:\n+                self.initLock.release()\n \n         set_script_prefix(base.get_script_name(environ))\n         signals.request_started.send(sender=self.__class__)"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/handlers/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/tests%2Fregressiontests%2Fhandlers%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/tests%2Fregressiontests%2Fhandlers%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhandlers%2F__init__.py?ref=ba585a2c6dbbbc918f5ceffd54eb31212bca85ef"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/handlers/models.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/tests%2Fregressiontests%2Fhandlers%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/tests%2Fregressiontests%2Fhandlers%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhandlers%2Fmodels.py?ref=ba585a2c6dbbbc918f5ceffd54eb31212bca85ef"
        },
        {
            "sha": "5e84f711770ef6fec8c81b7851bdb93bb8b18be3",
            "filename": "tests/regressiontests/handlers/tests.py",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/tests%2Fregressiontests%2Fhandlers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ba585a2c6dbbbc918f5ceffd54eb31212bca85ef/tests%2Fregressiontests%2Fhandlers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhandlers%2Ftests.py?ref=ba585a2c6dbbbc918f5ceffd54eb31212bca85ef",
            "patch": "@@ -0,0 +1,25 @@\n+from django.utils import unittest\n+from django.conf import settings\n+from django.core.handlers.wsgi import WSGIHandler\n+\n+class HandlerTests(unittest.TestCase):\n+\n+    def test_lock_safety(self):\n+        \"\"\"\n+        Tests for bug #11193 (errors inside middleware shouldn't leave\n+        the initLock locked).\n+        \"\"\"\n+        # Mangle settings so the handler will fail\n+        old_middleware_classes = settings.MIDDLEWARE_CLASSES\n+        settings.MIDDLEWARE_CLASSES = 42\n+        # Try running the handler, it will fail in load_middleware\n+        handler = WSGIHandler()\n+        self.assertEqual(handler.initLock.locked(), False)\n+        try:\n+            handler(None, None)\n+        except:\n+            pass\n+        self.assertEqual(handler.initLock.locked(), False)\n+        # Reset settings\n+        settings.MIDDLEWARE_CLASSES = old_middleware_classes\n+"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 35,
        "deletions": 4
    }
}