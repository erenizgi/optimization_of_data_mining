{
    "author": "akaariai",
    "message": "Fixed #19645 -- Added tests for TransactionMiddleware",
    "sha": "f556df90be995a83b979cf875705d98521ab4dc7",
    "files": [
        {
            "sha": "7088bfc2f39de0248a2f10b7c88d3f1e2e509def",
            "filename": "tests/regressiontests/middleware/models.py",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/f556df90be995a83b979cf875705d98521ab4dc7/tests%2Fregressiontests%2Fmiddleware%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f556df90be995a83b979cf875705d98521ab4dc7/tests%2Fregressiontests%2Fmiddleware%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Fmodels.py?ref=f556df90be995a83b979cf875705d98521ab4dc7",
            "patch": "@@ -1 +1,13 @@\n-# models.py file for tests to run.\n+from django.db import models\n+from django.utils.encoding import python_2_unicode_compatible\n+\n+\n+@python_2_unicode_compatible\n+class Band(models.Model):\n+    name = models.CharField(max_length=100)\n+\n+    class Meta:\n+        ordering = ('name',)\n+\n+    def __str__(self):\n+        return self.name"
        },
        {
            "sha": "a9a45c99ba3c2dbe7f24d1c31ac55ab6157466da",
            "filename": "tests/regressiontests/middleware/tests.py",
            "status": "modified",
            "additions": 50,
            "deletions": 2,
            "changes": 52,
            "blob_url": "https://github.com/django/django/blob/f556df90be995a83b979cf875705d98521ab4dc7/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f556df90be995a83b979cf875705d98521ab4dc7/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Ftests.py?ref=f556df90be995a83b979cf875705d98521ab4dc7",
            "patch": "@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from __future__ import absolute_import, unicode_literals\n \n import gzip\n from io import BytesIO\n@@ -8,17 +9,22 @@\n \n from django.conf import settings\n from django.core import mail\n+from django.db import transaction\n from django.http import HttpRequest\n from django.http import HttpResponse, StreamingHttpResponse\n from django.middleware.clickjacking import XFrameOptionsMiddleware\n from django.middleware.common import CommonMiddleware, BrokenLinkEmailsMiddleware\n from django.middleware.http import ConditionalGetMiddleware\n from django.middleware.gzip import GZipMiddleware\n-from django.test import TestCase, RequestFactory\n+from django.middleware.transaction import TransactionMiddleware\n+from django.test import TransactionTestCase, TestCase, RequestFactory\n from django.test.utils import override_settings\n from django.utils import six\n+from django.utils.encoding import force_str\n from django.utils.six.moves import xrange\n \n+from .models import Band\n+\n \n class CommonMiddlewareTest(TestCase):\n \n@@ -273,7 +279,7 @@ def test_404_error_reporting_ignored_url(self):\n     def test_non_ascii_query_string_does_not_crash(self):\n         \"\"\"Regression test for #15152\"\"\"\n         request = self._get_request('slash')\n-        request.META['QUERY_STRING'] = 'drink=café'\n+        request.META['QUERY_STRING'] = force_str('drink=café')\n         response = CommonMiddleware().process_request(request)\n         self.assertEqual(response.status_code, 301)\n \n@@ -662,3 +668,45 @@ def test_compress_response(self):\n         nogzip_etag = response.get('ETag')\n \n         self.assertNotEqual(gzip_etag, nogzip_etag)\n+\n+class TransactionMiddlewareTest(TransactionTestCase):\n+    \"\"\"\n+    Test the transaction middleware.\n+    \"\"\"\n+    def setUp(self):\n+        self.request = HttpRequest()\n+        self.request.META = {\n+            'SERVER_NAME': 'testserver',\n+            'SERVER_PORT': 80,\n+        }\n+        self.request.path = self.request.path_info = \"/\"\n+        self.response = HttpResponse()\n+        self.response.status_code = 200\n+\n+    def test_request(self):\n+        TransactionMiddleware().process_request(self.request)\n+        self.assertTrue(transaction.is_managed())\n+\n+    def test_managed_response(self):\n+        transaction.enter_transaction_management()\n+        transaction.managed(True)\n+        Band.objects.create(name='The Beatles')\n+        self.assertTrue(transaction.is_dirty())\n+        TransactionMiddleware().process_response(self.request, self.response)\n+        self.assertFalse(transaction.is_dirty())\n+        self.assertEqual(Band.objects.count(), 1)\n+\n+    def test_unmanaged_response(self):\n+        transaction.managed(False)\n+        TransactionMiddleware().process_response(self.request, self.response)\n+        self.assertFalse(transaction.is_managed())\n+        self.assertFalse(transaction.is_dirty())\n+\n+    def test_exception(self):\n+        transaction.enter_transaction_management()\n+        transaction.managed(True)\n+        Band.objects.create(name='The Beatles')\n+        self.assertTrue(transaction.is_dirty())\n+        TransactionMiddleware().process_exception(self.request, None)\n+        self.assertEqual(Band.objects.count(), 0)\n+        self.assertFalse(transaction.is_dirty())"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 63,
        "deletions": 3
    }
}