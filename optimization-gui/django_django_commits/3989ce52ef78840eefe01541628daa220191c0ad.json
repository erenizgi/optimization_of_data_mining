{
    "author": "patrys",
    "message": "Fixed #18172 -- Made models with __iter__ usable in ModelMultipleChoiceField\n\nThanks to Patryk Zawadzki for the patch.",
    "sha": "3989ce52ef78840eefe01541628daa220191c0ad",
    "files": [
        {
            "sha": "0913a4e8b8027c852dc1923c463fdb6c113dde3d",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/3989ce52ef78840eefe01541628daa220191c0ad/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/3989ce52ef78840eefe01541628daa220191c0ad/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=3989ce52ef78840eefe01541628daa220191c0ad",
            "patch": "@@ -1033,6 +1033,8 @@ def clean(self, value):\n         return qs\n \n     def prepare_value(self, value):\n-        if hasattr(value, '__iter__') and not isinstance(value, six.text_type):\n+        if (hasattr(value, '__iter__') and\n+                not isinstance(value, six.text_type) and\n+                not hasattr(value, '_meta')):\n             return [super(ModelMultipleChoiceField, self).prepare_value(v) for v in value]\n         return super(ModelMultipleChoiceField, self).prepare_value(value)"
        },
        {
            "sha": "383a10584b5cf8eb54e5e4e2a1d1fe5cdbad8f8b",
            "filename": "tests/modeltests/model_forms/models.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/3989ce52ef78840eefe01541628daa220191c0ad/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/3989ce52ef78840eefe01541628daa220191c0ad/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py?ref=3989ce52ef78840eefe01541628daa220191c0ad",
            "patch": "@@ -263,3 +263,18 @@ class FlexibleDatePost(models.Model):\n     slug = models.CharField(max_length=50, unique_for_year='posted', blank=True)\n     subtitle = models.CharField(max_length=50, unique_for_month='posted', blank=True)\n     posted = models.DateField(blank=True, null=True)\n+\n+@python_2_unicode_compatible\n+class Colour(models.Model):\n+    name = models.CharField(max_length=50)\n+\n+    def __iter__(self):\n+        for number in xrange(5):\n+            yield number\n+\n+    def __str__(self):\n+        return self.name\n+\n+class ColourfulItem(models.Model):\n+    name = models.CharField(max_length=50)\n+    colours = models.ManyToManyField(Colour)"
        },
        {
            "sha": "38fc9d058cc916eca6566b0d1b0b434543819948",
            "filename": "tests/modeltests/model_forms/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/3989ce52ef78840eefe01541628daa220191c0ad/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3989ce52ef78840eefe01541628daa220191c0ad/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py?ref=3989ce52ef78840eefe01541628daa220191c0ad",
            "patch": "@@ -19,7 +19,8 @@\n     Category, CommaSeparatedInteger, CustomFieldForExclusionModel, DerivedBook,\n     DerivedPost, ExplicitPK, FlexibleDatePost, ImprovedArticle,\n     ImprovedArticleWithParentLink, Inventory, Post, Price,\n-    Product, TextFile, Writer, WriterProfile, test_images)\n+    Product, TextFile, Writer, WriterProfile, Colour, ColourfulItem,\n+    test_images)\n \n if test_images:\n     from .models import ImageFile, OptionalImageFile\n@@ -174,6 +175,10 @@ class Meta:\n         model = Price\n         exclude = ('quantity',)\n \n+class ColourfulItemForm(forms.ModelForm):\n+    class Meta:\n+        model = ColourfulItem\n+\n \n class ModelFormBaseTest(TestCase):\n     def test_base_form(self):\n@@ -1518,3 +1523,12 @@ def test_model_field_that_returns_none_to_exclude_itself_with_explicit_fields(se\n                          ['name'])\n         self.assertHTMLEqual(six.text_type(CustomFieldForExclusionForm()),\n                          '''<tr><th><label for=\"id_name\">Name:</label></th><td><input id=\"id_name\" type=\"text\" name=\"name\" maxlength=\"10\" /></td></tr>''')\n+\n+    def test_iterable_model_m2m(self) :\n+        colour = Colour.objects.create(name='Blue')\n+        form = ColourfulItemForm()\n+        self.maxDiff = 1024\n+        self.assertHTMLEqual(form.as_p(), \"\"\"<p><label for=\"id_name\">Name:</label> <input id=\"id_name\" type=\"text\" name=\"name\" maxlength=\"50\" /></p>\n+        <p><label for=\"id_colours\">Colours:</label> <select multiple=\"multiple\" name=\"colours\" id=\"id_colours\">\n+        <option value=\"1\">Blue</option>\n+        </select> <span class=\"helptext\"> Hold down \"Control\", or \"Command\" on a Mac, to select more than one.</span></p>\"\"\")"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 33,
        "deletions": 2
    }
}