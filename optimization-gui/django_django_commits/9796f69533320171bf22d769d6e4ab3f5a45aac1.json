{
    "author": "jphalip",
    "message": "Fixed #16257 -- Added new `ModelAdmin.get_list_display_links()` method to allow for the dynamic display of links on the admin changelist. Thanks to graveyboat for the suggestion and initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17037 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "9796f69533320171bf22d769d6e4ab3f5a45aac1",
    "files": [
        {
            "sha": "91b81a42e0a892b594d47f13e9d3034f04a8ed47",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/9796f69533320171bf22d769d6e4ab3f5a45aac1/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/9796f69533320171bf22d769d6e4ab3f5a45aac1/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=9796f69533320171bf22d769d6e4ab3f5a45aac1",
            "patch": "@@ -650,6 +650,18 @@ def get_list_display(self, request):\n         \"\"\"\n         return self.list_display\n \n+    def get_list_display_links(self, request, list_display):\n+        \"\"\"\n+        Return a sequence containing the fields to be displayed as links\n+        on the changelist. The list_display parameter is the list of fields\n+        returned by get_list_display().\n+        \"\"\"\n+        if self.list_display_links or not list_display:\n+            return self.list_display_links\n+        else:\n+            # Use only the first item in list_display as link\n+            return list(list_display)[:1]\n+\n     def construct_change_message(self, request, form, formsets):\n         \"\"\"\n         Construct a change message from a changed object.\n@@ -1087,22 +1099,20 @@ def change_view(self, request, object_id, extra_context=None):\n \n     @csrf_protect_m\n     def changelist_view(self, request, extra_context=None):\n-        \"The 'change list' admin view for this model.\"\n+        \"\"\"\n+        The 'change list' admin view for this model.\n+        \"\"\"\n         from django.contrib.admin.views.main import ERROR_FLAG\n         opts = self.model._meta\n         app_label = opts.app_label\n         if not self.has_change_permission(request, None):\n             raise PermissionDenied\n \n-        # Check actions to see if any are available on this changelist\n-        actions = self.get_actions(request)\n-\n         list_display = self.get_list_display(request)\n+        list_display_links = self.get_list_display_links(request, list_display)\n \n-        list_display_links = self.list_display_links\n-        if not self.list_display_links and list_display:\n-            list_display_links = list(list_display)[:1]\n-\n+        # Check actions to see if any are available on this changelist\n+        actions = self.get_actions(request)\n         if actions:\n             # Add the action checkboxes if there are any actions available.\n             list_display = ['action_checkbox'] +  list(list_display)"
        },
        {
            "sha": "25902431448cdcd19f1fe6cee9c5f442565faf88",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9796f69533320171bf22d769d6e4ab3f5a45aac1/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/9796f69533320171bf22d769d6e4ab3f5a45aac1/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=9796f69533320171bf22d769d6e4ab3f5a45aac1",
            "patch": "@@ -1044,6 +1044,16 @@ templates used by the :class:`ModelAdmin` views:\n     displayed on the changelist view as described above in the\n     :attr:`ModelAdmin.list_display` section.\n \n+.. method:: ModelAdmin.get_list_display_links(self, request, list_display)\n+\n+    .. versionadded:: 1.4\n+\n+    The ``get_list_display_links`` method is given the ``HttpRequest`` and\n+    the ``list`` or ``tuple`` returned by :meth:`ModelAdmin.get_list_display`.\n+    It is expected to return a ``list`` or ``tuple`` of field names on the\n+    changelist that will be linked to the change view, as described in the\n+    :attr:`ModelAdmin.list_display_links` section.\n+\n .. method:: ModelAdmin.get_urls(self)\n \n     The ``get_urls`` method on a ``ModelAdmin`` returns the URLs to be used for"
        },
        {
            "sha": "6fb6f183cbaafacdc03ee3f01bb9b9d8951c9fc2",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/9796f69533320171bf22d769d6e4ab3f5a45aac1/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/9796f69533320171bf22d769d6e4ab3f5a45aac1/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=9796f69533320171bf22d769d6e4ab3f5a45aac1",
            "patch": "@@ -124,13 +124,20 @@ to work similarly to how desktop GUIs do it. The new hook\n :meth:`~django.contrib.admin.ModelAdmin.get_ordering` for specifying the\n ordering dynamically (e.g. depending on the request) has also been added.\n \n-``ModelAdmin.save_related()``\n-~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+New ``ModelAdmin`` methods\n+~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-A new :meth:`~django.contrib.admin.ModelAdmin.save_related` hook was added to\n+A new :meth:`~django.contrib.admin.ModelAdmin.save_related` method was added to\n :mod:`~django.contrib.admin.ModelAdmin` to ease the customization of how\n related objects are saved in the admin.\n \n+Two other new methods,\n+:meth:`~django.contrib.admin.ModelAdmin.get_list_display` and\n+:meth:`~django.contrib.admin.ModelAdmin.get_list_display_links`\n+were added to :class:`~django.contrib.admin.ModelAdmin` to enable the dynamic\n+customization of fields and links to display on the admin\n+change list.\n+\n Admin inlines respect user permissions\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "d1d8e0fd1e5405d5cc5bee843b5e1b24b2b62552",
            "filename": "tests/regressiontests/admin_changelist/admin.py",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/9796f69533320171bf22d769d6e4ab3f5a45aac1/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/9796f69533320171bf22d769d6e4ab3f5a45aac1/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py?ref=9796f69533320171bf22d769d6e4ab3f5a45aac1",
            "patch": "@@ -58,13 +58,20 @@ class ChordsBandAdmin(admin.ModelAdmin):\n \n \n class DynamicListDisplayChildAdmin(admin.ModelAdmin):\n-    list_display = ('name', 'parent')\n+    list_display = ('parent', 'name', 'age')\n \n     def get_list_display(self, request):\n-        my_list_display = list(self.list_display)\n+        my_list_display = super(DynamicListDisplayChildAdmin, self).get_list_display(request)\n         if request.user.username == 'noparents':\n+            my_list_display = list(my_list_display)\n             my_list_display.remove('parent')\n-\n         return my_list_display\n \n+class DynamicListDisplayLinksChildAdmin(admin.ModelAdmin):\n+    list_display = ('parent', 'name', 'age')\n+    list_display_links = ['parent', 'name']\n+\n+    def get_list_display_links(self, request, list_display):\n+        return ['age']\n+\n site.register(Child, DynamicListDisplayChildAdmin)"
        },
        {
            "sha": "eed3f68508e44e9783918761a09c9218c4e227b5",
            "filename": "tests/regressiontests/admin_changelist/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/9796f69533320171bf22d769d6e4ab3f5a45aac1/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/9796f69533320171bf22d769d6e4ab3f5a45aac1/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py?ref=9796f69533320171bf22d769d6e4ab3f5a45aac1",
            "patch": "@@ -7,6 +7,7 @@ class Parent(models.Model):\n class Child(models.Model):\n     parent = models.ForeignKey(Parent, editable=False, null=True)\n     name = models.CharField(max_length=30, blank=True)\n+    age = models.IntegerField(null=True, blank=True)\n \n class Genre(models.Model):\n     name = models.CharField(max_length=20)"
        },
        {
            "sha": "929289555266e22db571fe81093bef4c7fa7a186",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 45,
            "deletions": 10,
            "changes": 55,
            "blob_url": "https://github.com/django/django/blob/9796f69533320171bf22d769d6e4ab3f5a45aac1/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9796f69533320171bf22d769d6e4ab3f5a45aac1/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=9796f69533320171bf22d769d6e4ab3f5a45aac1",
            "patch": "@@ -9,7 +9,8 @@\n from django.test.client import RequestFactory\n \n from .admin import (ChildAdmin, QuartetAdmin, BandAdmin, ChordsBandAdmin,\n-    GroupAdmin, ParentAdmin, DynamicListDisplayChildAdmin, CustomPaginationAdmin,\n+    GroupAdmin, ParentAdmin, DynamicListDisplayChildAdmin,\n+    DynamicListDisplayLinksChildAdmin, CustomPaginationAdmin,\n     FilteredChildAdmin, CustomPaginator, site as custom_site)\n from .models import (Child, Parent, Genre, Band, Musician, Group, Quartet,\n     Membership, ChordsMusician, ChordsBand, Invitation)\n@@ -41,7 +42,9 @@ def test_result_list_empty_changelist_value(self):\n         new_child = Child.objects.create(name='name', parent=None)\n         request = self.factory.get('/child/')\n         m = ChildAdmin(Child, admin.site)\n-        cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n+        list_display = m.get_list_display(request)\n+        list_display_links = m.get_list_display_links(request, list_display)\n+        cl = ChangeList(request, Child, list_display, list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n                 m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n         cl.formset = None\n@@ -61,7 +64,9 @@ def test_result_list_html(self):\n         new_child = Child.objects.create(name='name', parent=new_parent)\n         request = self.factory.get('/child/')\n         m = ChildAdmin(Child, admin.site)\n-        cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n+        list_display = m.get_list_display(request)\n+        list_display_links = m.get_list_display_links(request, list_display)\n+        cl = ChangeList(request, Child, list_display, list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n                 m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n         cl.formset = None\n@@ -334,28 +339,31 @@ def _mocked_authenticated_request(user):\n         m = custom_site._registry[Child]\n         request = _mocked_authenticated_request(user_noparents)\n         response = m.changelist_view(request)\n-        # XXX - Calling render here to avoid ContentNotRenderedError to be\n-        # raised. Ticket #15826 should fix this but it's not yet integrated.\n-        response.render()\n         self.assertNotContains(response, 'Parent object')\n \n+        list_display = m.get_list_display(request)\n+        list_display_links = m.get_list_display_links(request, list_display)\n+        self.assertEqual(list_display, ['name', 'age'])\n+        self.assertEqual(list_display_links, ['name'])\n+\n         # Test with user 'parents'\n         m = DynamicListDisplayChildAdmin(Child, admin.site)\n         request = _mocked_authenticated_request(user_parents)\n         response = m.changelist_view(request)\n-        # XXX - #15826\n-        response.render()\n         self.assertContains(response, 'Parent object')\n \n         custom_site.unregister(Child)\n \n+        list_display = m.get_list_display(request)\n+        list_display_links = m.get_list_display_links(request, list_display)\n+        self.assertEqual(list_display, ('parent', 'name', 'age'))\n+        self.assertEqual(list_display_links, ['parent'])\n+\n         # Test default implementation\n         custom_site.register(Child, ChildAdmin)\n         m = custom_site._registry[Child]\n         request = _mocked_authenticated_request(user_noparents)\n         response = m.changelist_view(request)\n-        # XXX - #15826\n-        response.render()\n         self.assertContains(response, 'Parent object')\n \n     def test_show_all(self):\n@@ -386,3 +394,30 @@ def test_show_all(self):\n         cl.get_results(request)\n         self.assertEqual(len(cl.result_list), 10)\n \n+    def test_dynamic_list_display_links(self):\n+        \"\"\"\n+        Regression tests for #16257: dynamic list_display_links support.\n+        \"\"\"\n+        parent = Parent.objects.create(name='parent')\n+        for i in range(1, 10):\n+            Child.objects.create(id=i, name='child %s' % i, parent=parent, age=i)\n+\n+        superuser = User.objects.create(\n+            username='superuser',\n+            is_superuser=True)\n+\n+        def _mocked_authenticated_request(user):\n+            request = self.factory.get('/child/')\n+            request.user = user\n+            return request\n+\n+        m = DynamicListDisplayLinksChildAdmin(Child, admin.site)\n+        request = _mocked_authenticated_request(superuser)\n+        response = m.changelist_view(request)\n+        for i in range(1, 10):\n+            self.assertContains(response, '<a href=\"%s/\">%s</a>' % (i, i))\n+\n+        list_display = m.get_list_display(request)\n+        list_display_links = m.get_list_display_links(request, list_display)\n+        self.assertEqual(list_display, ('parent', 'name', 'age'))\n+        self.assertEqual(list_display_links, ['age'])\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 94,
        "deletions": 24
    }
}