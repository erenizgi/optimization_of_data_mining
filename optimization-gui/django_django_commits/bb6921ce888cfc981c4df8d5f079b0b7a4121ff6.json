{
    "author": "jezdez",
    "message": "Fixed #17596 -- Stopped the AdminField class from double quoting its label. Thanks, guettli and claudep.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17431 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "bb6921ce888cfc981c4df8d5f079b0b7a4121ff6",
    "files": [
        {
            "sha": "b7c65e175fef72f8226c2813eadd2185ff242759",
            "filename": "django/contrib/admin/helpers.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/bb6921ce888cfc981c4df8d5f079b0b7a4121ff6/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "raw_url": "https://github.com/django/django/raw/bb6921ce888cfc981c4df8d5f079b0b7a4121ff6/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fhelpers.py?ref=bb6921ce888cfc981c4df8d5f079b0b7a4121ff6",
            "patch": "@@ -115,17 +115,17 @@ def __init__(self, form, field, is_first):\n \n     def label_tag(self):\n         classes = []\n+        contents = conditional_escape(force_unicode(self.field.label))\n         if self.is_checkbox:\n             classes.append(u'vCheckboxLabel')\n-            contents = force_unicode(escape(self.field.label))\n         else:\n-            contents = force_unicode(escape(self.field.label)) + u':'\n+            contents += u':'\n         if self.field.field.required:\n             classes.append(u'required')\n         if not self.is_first:\n             classes.append(u'inline')\n         attrs = classes and {'class': u' '.join(classes)} or {}\n-        return self.field.label_tag(contents=contents, attrs=attrs)\n+        return self.field.label_tag(contents=mark_safe(contents), attrs=attrs)\n \n     def errors(self):\n         return mark_safe(self.field.errors.as_ul())"
        },
        {
            "sha": "8113f2e16dc06c2938a2f5e83b436246ef84e54b",
            "filename": "tests/regressiontests/admin_util/tests.py",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/bb6921ce888cfc981c4df8d5f079b0b7a4121ff6/tests%2Fregressiontests%2Fadmin_util%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bb6921ce888cfc981c4df8d5f079b0b7a4121ff6/tests%2Fregressiontests%2Fadmin_util%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_util%2Ftests.py?ref=bb6921ce888cfc981c4df8d5f079b0b7a4121ff6",
            "patch": "@@ -4,14 +4,17 @@\n \n from django.conf import settings\n from django.contrib import admin\n+from django.contrib.admin import helpers\n from django.contrib.admin.util import (display_for_field, label_for_field,\n     lookup_field, NestedObjects)\n from django.contrib.admin.views.main import EMPTY_CHANGELIST_VALUE\n from django.contrib.sites.models import Site\n from django.db import models, DEFAULT_DB_ALIAS\n+from django import forms\n from django.test import TestCase\n from django.utils import unittest\n from django.utils.formats import localize\n+from django.utils.safestring import mark_safe\n \n from .models import Article, Count, Event, Location\n \n@@ -258,3 +261,26 @@ def test_logentry_unicode(self):\n         self.assertTrue(\n             unicode(log_entry).startswith('Deleted ')\n         )\n+\n+    def test_safestring_in_field_label(self):\n+        # safestring should not be escaped\n+        class MyForm(forms.Form):\n+            text = forms.CharField(label=mark_safe('<i>text</i>'))\n+            cb   = forms.BooleanField(label=mark_safe('<i>cb</i>'))\n+\n+        form = MyForm()\n+        self.assertEqual(helpers.AdminField(form, 'text', is_first=False).label_tag(),\n+                         '<label for=\"id_text\" class=\"required inline\"><i>text</i>:</label>')\n+        self.assertEqual(helpers.AdminField(form, 'cb', is_first=False).label_tag(),\n+                         '<label for=\"id_cb\" class=\"vCheckboxLabel required inline\"><i>cb</i></label>')\n+\n+        # normal strings needs to be escaped\n+        class MyForm(forms.Form):\n+            text = forms.CharField(label='&text')\n+            cb   = forms.BooleanField(label='&cb')\n+\n+        form = MyForm()\n+        self.assertEqual(helpers.AdminField(form, 'text', is_first=False).label_tag(),\n+                         '<label for=\"id_text\" class=\"required inline\">&amp;text:</label>')\n+        self.assertEqual(helpers.AdminField(form, 'cb', is_first=False).label_tag(),\n+                         '<label for=\"id_cb\" class=\"vCheckboxLabel required inline\">&amp;cb</label>')"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 29,
        "deletions": 3
    }
}