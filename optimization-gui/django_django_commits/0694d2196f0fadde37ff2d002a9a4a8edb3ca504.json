{
    "author": "slurms",
    "message": "Fixed #19445 -- Skip admin fieldsets validation when the ModelAdmin.get_form() method is overridden.",
    "sha": "0694d2196f0fadde37ff2d002a9a4a8edb3ca504",
    "files": [
        {
            "sha": "a02bb7a316fe5773acd64b416d297423fe1049d7",
            "filename": "django/contrib/admin/validation.py",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/0694d2196f0fadde37ff2d002a9a4a8edb3ca504/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/0694d2196f0fadde37ff2d002a9a4a8edb3ca504/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fvalidation.py?ref=0694d2196f0fadde37ff2d002a9a4a8edb3ca504",
            "patch": "@@ -6,7 +6,7 @@\n from django.contrib.admin import ListFilter, FieldListFilter\n from django.contrib.admin.util import get_fields_from_path, NotRelationField\n from django.contrib.admin.options import (flatten_fieldsets, BaseModelAdmin,\n-    HORIZONTAL, VERTICAL)\n+    ModelAdmin, HORIZONTAL, VERTICAL)\n \n \n __all__ = ['validate']\n@@ -388,12 +388,14 @@ def check_formfield(cls, model, opts, label, field):\n             raise ImproperlyConfigured(\"'%s.%s' refers to field '%s' that \"\n                 \"is missing from the form.\" % (cls.__name__, label, field))\n     else:\n-        fields = fields_for_model(model)\n-        try:\n-            fields[field]\n-        except KeyError:\n-            raise ImproperlyConfigured(\"'%s.%s' refers to field '%s' that \"\n-                \"is missing from the form.\" % (cls.__name__, label, field))\n+        get_form_is_overridden = hasattr(cls, 'get_form') and cls.get_form != ModelAdmin.get_form\n+        if not get_form_is_overridden:\n+            fields = fields_for_model(model)\n+            try:\n+                fields[field]\n+            except KeyError:\n+                raise ImproperlyConfigured(\"'%s.%s' refers to field '%s' that \"\n+                    \"is missing from the form.\" % (cls.__name__, label, field))\n \n def fetch_attr(cls, model, opts, label, field):\n     try:"
        },
        {
            "sha": "1b47fa882892d56b8fa7031e08f5abeb5deefa68",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/0694d2196f0fadde37ff2d002a9a4a8edb3ca504/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/0694d2196f0fadde37ff2d002a9a4a8edb3ca504/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=0694d2196f0fadde37ff2d002a9a4a8edb3ca504",
            "patch": "@@ -1070,6 +1070,13 @@ templates used by the :class:`ModelAdmin` views:\n     changelist that will be linked to the change view, as described in the\n     :attr:`ModelAdmin.list_display_links` section.\n \n+.. method:: ModelAdmin.get_fieldsets(self, request, obj=None)\n+\n+    The ``get_fieldsets`` method is given the ``HttpRequest`` and the ``obj``\n+    being edited (or ``None`` on an add form) and is expected to return a list\n+    of two-tuples, in which each two-tuple represents a ``<fieldset>`` on the\n+    admin form page, as described above in the :attr:`ModelAdmin.fieldsets` section.\n+\n .. method:: ModelAdmin.get_list_filter(self, request)\n \n     .. versionadded:: 1.5"
        },
        {
            "sha": "b9b42c6bb960a4245b06943520499ac93592a18e",
            "filename": "tests/regressiontests/admin_validation/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/0694d2196f0fadde37ff2d002a9a4a8edb3ca504/tests%2Fregressiontests%2Fadmin_validation%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0694d2196f0fadde37ff2d002a9a4a8edb3ca504/tests%2Fregressiontests%2Fadmin_validation%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_validation%2Ftests.py?ref=0694d2196f0fadde37ff2d002a9a4a8edb3ca504",
            "patch": "@@ -20,6 +20,18 @@ class InvalidFields(admin.ModelAdmin):\n     form = SongForm\n     fields = ['spam']\n \n+class ValidFormFieldsets(admin.ModelAdmin):\n+    def get_form(self, request, obj=None, **kwargs):\n+        class ExtraFieldForm(SongForm):\n+            name = forms.CharField(max_length=50)\n+        return ExtraFieldForm\n+\n+    fieldsets = (\n+        (None, {\n+            'fields': ('name',),\n+        }),\n+    )\n+\n class ValidationTestCase(TestCase):\n \n     def test_readonly_and_editable(self):\n@@ -42,6 +54,14 @@ def test_custom_modelforms_with_fields_fieldsets(self):\n             validate,\n             InvalidFields, Song)\n \n+    def test_custom_get_form_with_fieldsets(self):\n+        \"\"\"\n+        Ensure that the fieldsets validation is skipped when the ModelAdmin.get_form() method\n+        is overridden.\n+        Refs #19445.\n+        \"\"\"\n+        validate(ValidFormFieldsets, Song)\n+\n     def test_exclude_values(self):\n         \"\"\"\n         Tests for basic validation of 'exclude' option values (#12689)"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 36,
        "deletions": 7
    }
}