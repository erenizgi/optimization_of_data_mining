{
    "author": "andrewgodwin",
    "message": "Add support for unique_together",
    "sha": "c4b2a3262cc79383d6562cfc7e9af20135c8e0bf",
    "files": [
        {
            "sha": "c5e297197b5c7954972086d0fda8a85a537ad296",
            "filename": "django/db/backends/schema.py",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/c4b2a3262cc79383d6562cfc7e9af20135c8e0bf/django%2Fdb%2Fbackends%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/c4b2a3262cc79383d6562cfc7e9af20135c8e0bf/django%2Fdb%2Fbackends%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fschema.py?ref=c4b2a3262cc79383d6562cfc7e9af20135c8e0bf",
            "patch": "@@ -29,6 +29,7 @@ class BaseDatabaseSchemaEditor(object):\n \n     # Overrideable SQL templates\n     sql_create_table = \"CREATE TABLE %(table)s (%(definition)s)\"\n+    sql_create_table_unique = \"UNIQUE (%(columns)s)\"\n     sql_rename_table = \"ALTER TABLE %(old_table)s RENAME TO %(new_table)s\"\n     sql_delete_table = \"DROP TABLE %(table)s CASCADE\"\n \n@@ -51,7 +52,7 @@ class BaseDatabaseSchemaEditor(object):\n     sql_create_fk = \"ALTER TABLE %(table)s ADD CONSTRAINT %(name)s FOREIGN KEY (%(column)s) REFERENCES %(to_table)s (%(to_column)s) DEFERRABLE INITIALLY DEFERRED\"\n     sql_delete_fk = \"ALTER TABLE %(table)s DROP CONSTRAINT %(name)s\"\n \n-    sql_create_index = \"CREATE %(unique)s INDEX %(name)s ON %(table)s (%(columns)s)%s;\"\n+    sql_create_index = \"CREATE %(unique)s INDEX %(name)s ON %(table)s (%(columns)s)%(extra)s;\"\n     sql_delete_index = \"DROP INDEX %(name)s\"\n \n     sql_create_pk = \"ALTER TABLE %(table)s ADD CONSTRAINT %(constraint)s PRIMARY KEY (%(columns)s)\"\n@@ -174,6 +175,17 @@ def create_model(self, model):\n                 definition,\n             ))\n             params.extend(extra_params)\n+            # Indexes\n+            if field.db_index:\n+                self.deferred_sql.append(\n+                    self.sql_create_index % {\n+                        \"unique\": \"\",\n+                        \"name\": self._create_index_name(model, [field.column], suffix=\"\"),\n+                        \"table\": self.quote_name(model._meta.db_table),\n+                        \"columns\": self.quote_name(field.column),\n+                        \"extra\": \"\",\n+                    }\n+                )\n             # FK\n             if field.rel:\n                 to_table = field.rel.to._meta.db_table\n@@ -191,6 +203,12 @@ def create_model(self, model):\n                         \"to_column\": self.quote_name(to_column),\n                     }\n                 )\n+        # Add any unique_togethers\n+        for fields in model._meta.unique_together:\n+            columns = [model._meta.get_field_by_name(field)[0].column for field in fields]\n+            column_sqls.append(self.sql_create_table_unique % {\n+                \"columns\": \", \".join(self.quote_name(column) for column in columns),\n+            })\n         # Make the table\n         sql = self.sql_create_table % {\n             \"table\": model._meta.db_table,\n@@ -210,6 +228,39 @@ def delete_model(self, model):\n             \"table\": self.quote_name(model._meta.db_table),\n         })\n \n+    def alter_unique_together(self, model, old_unique_together, new_unique_together):\n+        \"\"\"\n+        Deals with a model changing its unique_together.\n+        Note: The input unique_togethers must be doubly-nested, not the single-\n+        nested [\"foo\", \"bar\"] format.\n+        \"\"\"\n+        olds = set(frozenset(fields) for fields in old_unique_together)\n+        news = set(frozenset(fields) for fields in new_unique_together)\n+        # Deleted uniques\n+        for fields in olds.difference(news):\n+            columns = [model._meta.get_field_by_name(field)[0].column for field in fields]\n+            constraint_names = self._constraint_names(model, list(columns), unique=True)\n+            if len(constraint_names) != 1:\n+                raise ValueError(\"Found wrong number (%s) of constraints for %s(%s)\" % (\n+                    len(constraint_names),\n+                    model._meta.db_table,\n+                    \", \".join(columns),\n+                ))\n+            self.execute(\n+                self.sql_delete_unique % {\n+                    \"table\": self.quote_name(model._meta.db_table),\n+                    \"name\": constraint_names[0],\n+                },\n+            )\n+        # Created uniques\n+        for fields in news.difference(olds):\n+            columns = [model._meta.get_field_by_name(field)[0].column for field in fields]\n+            self.execute(self.sql_create_unique % {\n+                \"table\": self.quote_name(model._meta.db_table),\n+                \"name\": self._create_index_name(model, columns, suffix=\"_uniq\"),\n+                \"columns\": \", \".join(self.quote_name(column) for column in columns),\n+            })\n+\n     def create_field(self, model, field, keep_default=False):\n         \"\"\"\n         Creates a field on a model."
        },
        {
            "sha": "e9eba1fc6f00f1326d97e87f8b6ae93cb9737949",
            "filename": "tests/modeltests/schema/models.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/c4b2a3262cc79383d6562cfc7e9af20135c8e0bf/tests%2Fmodeltests%2Fschema%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/c4b2a3262cc79383d6562cfc7e9af20135c8e0bf/tests%2Fmodeltests%2Fschema%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Fmodels.py?ref=c4b2a3262cc79383d6562cfc7e9af20135c8e0bf",
            "patch": "@@ -32,3 +32,15 @@ class Meta:\n class Tag(models.Model):\n     title = models.CharField(max_length=255)\n     slug = models.SlugField(unique=True)\n+\n+    class Meta:\n+        managed = False\n+\n+\n+class UniqueTest(models.Model):\n+    year = models.IntegerField()\n+    slug = models.SlugField(unique=False)\n+\n+    class Meta:\n+        managed = False\n+        unique_together = [\"year\", \"slug\"]"
        },
        {
            "sha": "52d99225f0fa06d9875fd4bfe93f32d32b9f3c62",
            "filename": "tests/modeltests/schema/tests.py",
            "status": "modified",
            "additions": 46,
            "deletions": 2,
            "changes": 48,
            "blob_url": "https://github.com/django/django/blob/c4b2a3262cc79383d6562cfc7e9af20135c8e0bf/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c4b2a3262cc79383d6562cfc7e9af20135c8e0bf/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Ftests.py?ref=c4b2a3262cc79383d6562cfc7e9af20135c8e0bf",
            "patch": "@@ -6,7 +6,7 @@\n from django.db.models.fields import IntegerField, TextField, CharField, SlugField\n from django.db.models.fields.related import ManyToManyField\n from django.db.models.loading import cache\n-from .models import Author, Book, AuthorWithM2M, Tag\n+from .models import Author, Book, AuthorWithM2M, Tag, UniqueTest\n \n \n class SchemaTests(TestCase):\n@@ -18,7 +18,7 @@ class SchemaTests(TestCase):\n     as the code it is testing.\n     \"\"\"\n \n-    models = [Author, Book, AuthorWithM2M, Tag]\n+    models = [Author, Book, AuthorWithM2M, Tag, UniqueTest]\n \n     # Utility functions\n \n@@ -298,3 +298,47 @@ def test_unique(self):\n         Tag.objects.create(title=\"foo\", slug=\"foo\")\n         self.assertRaises(IntegrityError, Tag.objects.create, title=\"bar\", slug=\"foo\")\n         connection.rollback()\n+\n+    def test_unique_together(self):\n+        \"\"\"\n+        Tests removing and adding unique_together constraints on a model.\n+        \"\"\"\n+        # Create the table\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.create_model(UniqueTest)\n+        editor.commit()\n+        # Ensure the fields are unique to begin with\n+        UniqueTest.objects.create(year=2012, slug=\"foo\")\n+        UniqueTest.objects.create(year=2011, slug=\"foo\")\n+        UniqueTest.objects.create(year=2011, slug=\"bar\")\n+        self.assertRaises(IntegrityError, UniqueTest.objects.create, year=2012, slug=\"foo\")\n+        connection.rollback()\n+        # Alter the model to it's non-unique-together companion\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.alter_unique_together(\n+            UniqueTest,\n+            UniqueTest._meta.unique_together,\n+            [],\n+        )\n+        editor.commit()\n+        # Ensure the fields are no longer unique\n+        UniqueTest.objects.create(year=2012, slug=\"foo\")\n+        UniqueTest.objects.create(year=2012, slug=\"foo\")\n+        connection.rollback()\n+        # Alter it back\n+        new_new_field = SlugField(unique=True)\n+        new_new_field.set_attributes_from_name(\"slug\")\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.alter_unique_together(\n+            UniqueTest,\n+            [],\n+            UniqueTest._meta.unique_together,\n+        )\n+        editor.commit()\n+        # Ensure the fields are unique again\n+        UniqueTest.objects.create(year=2012, slug=\"foo\")\n+        self.assertRaises(IntegrityError, UniqueTest.objects.create, year=2012, slug=\"foo\")\n+        connection.rollback()"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 110,
        "deletions": 3
    }
}