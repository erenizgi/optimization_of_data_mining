{
    "author": "adrianholovaty",
    "message": "Fixed #17644 -- Changed Query.alias_map to use namedtuples\nThis makes the code easier to understand and may even have a benefit in memory usage (namedtuples instead of dicts). Thanks, lrekucki and akaariai",
    "sha": "6ff118cdb9bb5904b8ce3021f52c4450fead49f5",
    "files": [
        {
            "sha": "ca5a43a28a5e33569594ad7a33d4cb761ef167f1",
            "filename": "django/contrib/gis/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=6ff118cdb9bb5904b8ce3021f52c4450fead49f5",
            "patch": "@@ -1,7 +1,7 @@\n from itertools import izip\n from django.db.backends.util import truncate_name, typecast_timestamp\n from django.db.models.sql import compiler\n-from django.db.models.sql.constants import TABLE_NAME, MULTI\n+from django.db.models.sql.constants import MULTI\n \n SQLCompiler = compiler.SQLCompiler\n \n@@ -35,7 +35,7 @@ def get_columns(self, with_aliases=False):\n             for col, field in izip(self.query.select, self.query.select_fields):\n                 if isinstance(col, (list, tuple)):\n                     alias, column = col\n-                    table = self.query.alias_map[alias][TABLE_NAME]\n+                    table = self.query.alias_map[alias].table_name\n                     if table in only_load and column not in only_load[table]:\n                         continue\n                     r = self.get_field_select(field, alias, column)\n@@ -138,7 +138,7 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n                 # aliases will have already been set up in pre_sql_setup(), so\n                 # we can save time here.\n                 alias = self.query.included_inherited_models[model]\n-            table = self.query.alias_map[alias][TABLE_NAME]\n+            table = self.query.alias_map[alias].table_name\n             if table in only_load and field.column not in only_load[table]:\n                 continue\n             if as_pairs:"
        },
        {
            "sha": "f864fd74e65271ea9298a28d345a6a575d94cdd0",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=6ff118cdb9bb5904b8ce3021f52c4450fead49f5",
            "patch": "@@ -188,7 +188,7 @@ def get_columns(self, with_aliases=False):\n             for col in self.query.select:\n                 if isinstance(col, (list, tuple)):\n                     alias, column = col\n-                    table = self.query.alias_map[alias][TABLE_NAME]\n+                    table = self.query.alias_map[alias].table_name\n                     if table in only_load and column not in only_load[table]:\n                         continue\n                     r = '%s.%s' % (qn(alias), qn(column))\n@@ -289,7 +289,7 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n                 # aliases will have already been set up in pre_sql_setup(), so\n                 # we can save time here.\n                 alias = self.query.included_inherited_models[model]\n-            table = self.query.alias_map[alias][TABLE_NAME]\n+            table = self.query.alias_map[alias].table_name\n             if table in only_load and field.column not in only_load[table]:\n                 continue\n             if as_pairs:\n@@ -432,7 +432,7 @@ def find_ordering_name(self, name, opts, alias=None, default_order='ASC',\n             # Firstly, avoid infinite loops.\n             if not already_seen:\n                 already_seen = set()\n-            join_tuple = tuple([self.query.alias_map[j][TABLE_NAME] for j in joins])\n+            join_tuple = tuple([self.query.alias_map[j].table_name for j in joins])\n             if join_tuple in already_seen:\n                 raise FieldError('Infinite loop caused by ordering.')\n             already_seen.add(join_tuple)\n@@ -470,7 +470,7 @@ def _setup_joins(self, pieces, opts, alias):\n         # Ordering or distinct must not affect the returned set, and INNER\n         # JOINS for nullable fields could do this.\n         self.query.promote_alias_chain(joins,\n-            self.query.alias_map[joins[0]][JOIN_TYPE] == self.query.LOUTER)\n+            self.query.alias_map[joins[0]].join_type == self.query.LOUTER)\n         return field, col, alias, joins, opts\n \n     def _final_join_removal(self, col, alias):\n@@ -485,11 +485,11 @@ def _final_join_removal(self, col, alias):\n         if alias:\n             while 1:\n                 join = self.query.alias_map[alias]\n-                if col != join[RHS_JOIN_COL]:\n+                if col != join.rhs_join_col:\n                     break\n                 self.query.unref_alias(alias)\n-                alias = join[LHS_ALIAS]\n-                col = join[LHS_JOIN_COL]\n+                alias = join.lhs_alias\n+                col = join.lhs_join_col\n         return col, alias\n \n     def get_from_clause(self):\n@@ -641,7 +641,7 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                     alias_chain.append(alias)\n                     for (dupe_opts, dupe_col) in dupe_set:\n                         self.query.update_dupe_avoidance(dupe_opts, dupe_col, alias)\n-                if self.query.alias_map[root_alias][JOIN_TYPE] == self.query.LOUTER:\n+                if self.query.alias_map[root_alias].join_type == self.query.LOUTER:\n                     self.query.promote_alias_chain(alias_chain, True)\n             else:\n                 alias = root_alias\n@@ -659,7 +659,7 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n             columns, aliases = self.get_default_columns(start_alias=alias,\n                     opts=f.rel.to._meta, as_pairs=True)\n             self.query.related_select_cols.extend(columns)\n-            if self.query.alias_map[alias][JOIN_TYPE] == self.query.LOUTER:\n+            if self.query.alias_map[alias].join_type == self.query.LOUTER:\n                 self.query.promote_alias_chain(aliases, True)\n             self.query.related_select_fields.extend(f.rel.to._meta.fields)\n             if restricted:"
        },
        {
            "sha": "b5fd0487991ccb1494c153e74b9326a01f824782",
            "filename": "django/db/models/sql/constants.py",
            "status": "modified",
            "additions": 7,
            "deletions": 11,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fdb%2Fmodels%2Fsql%2Fconstants.py",
            "raw_url": "https://github.com/django/django/raw/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fdb%2Fmodels%2Fsql%2Fconstants.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fconstants.py?ref=6ff118cdb9bb5904b8ce3021f52c4450fead49f5",
            "patch": "@@ -1,11 +1,12 @@\n+from collections import namedtuple\n import re\n \n # Valid query types (a dictionary is used for speedy lookups).\n QUERY_TERMS = dict([(x, None) for x in (\n     'exact', 'iexact', 'contains', 'icontains', 'gt', 'gte', 'lt', 'lte', 'in',\n     'startswith', 'istartswith', 'endswith', 'iendswith', 'range', 'year',\n     'month', 'day', 'week_day', 'isnull', 'search', 'regex', 'iregex',\n-    )])\n+)])\n \n # Size of each \"chunk\" for get_iterator calls.\n # Larger values are slightly faster at the expense of more storage space.\n@@ -17,13 +18,9 @@\n # Constants to make looking up tuple values clearer.\n # Join lists (indexes into the tuples that are values in the alias_map\n # dictionary in the Query class).\n-TABLE_NAME = 0\n-RHS_ALIAS = 1\n-JOIN_TYPE = 2\n-LHS_ALIAS = 3\n-LHS_JOIN_COL = 4\n-RHS_JOIN_COL = 5\n-NULLABLE = 6\n+JoinInfo = namedtuple('JoinInfo',\n+                      'table_name rhs_alias join_type lhs_alias '\n+                      'lhs_join_col rhs_join_col nullable')\n \n # How many results to expect from a cursor.execute call\n MULTI = 'multi'\n@@ -32,6 +29,5 @@\n ORDER_PATTERN = re.compile(r'\\?|[-+]?[.\\w]+$')\n ORDER_DIR = {\n     'ASC': ('ASC', 'DESC'),\n-    'DESC': ('DESC', 'ASC')}\n-\n-\n+    'DESC': ('DESC', 'ASC'),\n+}"
        },
        {
            "sha": "efbc0c95a3b98db2d0d9bd06676df8310e3b859b",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 37,
            "deletions": 34,
            "changes": 71,
            "blob_url": "https://github.com/django/django/blob/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/6ff118cdb9bb5904b8ce3021f52c4450fead49f5/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=6ff118cdb9bb5904b8ce3021f52c4450fead49f5",
            "patch": "@@ -101,7 +101,11 @@ class Query(object):\n     def __init__(self, model, where=WhereNode):\n         self.model = model\n         self.alias_refcount = SortedDict()\n-        self.alias_map = {}     # Maps alias to join information\n+        # alias_map is the most important data structure regarding joins.\n+        # It's used for recording which joins exist in the query and what\n+        # type they are. The key is the alias of the joined table (possibly\n+        # the table name) and the value is JoinInfo from constants.py.\n+        self.alias_map = {}\n         self.table_map = {}     # Maps table names to list of aliases.\n         self.join_map = {}\n         self.default_cols = True\n@@ -686,11 +690,11 @@ def promote_alias(self, alias, unconditional=False):\n \n         Returns True if the join was promoted by this call.\n         \"\"\"\n-        if ((unconditional or self.alias_map[alias][NULLABLE]) and\n-                self.alias_map[alias][JOIN_TYPE] != self.LOUTER):\n-            data = list(self.alias_map[alias])\n-            data[JOIN_TYPE] = self.LOUTER\n-            self.alias_map[alias] = tuple(data)\n+        if ((unconditional or self.alias_map[alias].nullable) and\n+                self.alias_map[alias].join_type != self.LOUTER):\n+            data = self.alias_map[alias]\n+            data = data._replace(join_type=self.LOUTER)\n+            self.alias_map[alias] = data\n             return True\n         return False\n \n@@ -730,7 +734,7 @@ def promote_unused_aliases(self, initial_refcounts, used_aliases):\n                 continue\n             if (alias not in initial_refcounts or\n                     self.alias_refcount[alias] == initial_refcounts[alias]):\n-                parent = self.alias_map[alias][LHS_ALIAS]\n+                parent = self.alias_map[alias].lhs_alias\n                 must_promote = considered.get(parent, False)\n                 promoted = self.promote_alias(alias, must_promote)\n                 considered[alias] = must_promote or promoted\n@@ -767,14 +771,14 @@ def change_aliases(self, change_map):\n             aliases = tuple([change_map.get(a, a) for a in aliases])\n             self.join_map[k] = aliases\n         for old_alias, new_alias in change_map.iteritems():\n-            alias_data = list(self.alias_map[old_alias])\n-            alias_data[RHS_ALIAS] = new_alias\n+            alias_data = self.alias_map[old_alias]\n+            alias_data = alias_data._replace(rhs_alias=new_alias)\n             self.alias_refcount[new_alias] = self.alias_refcount[old_alias]\n             del self.alias_refcount[old_alias]\n-            self.alias_map[new_alias] = tuple(alias_data)\n+            self.alias_map[new_alias] = alias_data\n             del self.alias_map[old_alias]\n \n-            table_aliases = self.table_map[alias_data[TABLE_NAME]]\n+            table_aliases = self.table_map[alias_data.table_name]\n             for pos, alias in enumerate(table_aliases):\n                 if alias == old_alias:\n                     table_aliases[pos] = new_alias\n@@ -789,11 +793,10 @@ def change_aliases(self, change_map):\n \n         # 3. Update any joins that refer to the old alias.\n         for alias, data in self.alias_map.iteritems():\n-            lhs = data[LHS_ALIAS]\n+            lhs = data.lhs_alias\n             if lhs in change_map:\n-                data = list(data)\n-                data[LHS_ALIAS] = change_map[lhs]\n-                self.alias_map[alias] = tuple(data)\n+                data = data._replace(lhs_alias=change_map[lhs])\n+                self.alias_map[alias] = data\n \n     def bump_prefix(self, exceptions=()):\n         \"\"\"\n@@ -876,7 +879,7 @@ def join(self, connection, always_create=False, exclusions=(),\n         \"\"\"\n         lhs, table, lhs_col, col = connection\n         if lhs in self.alias_map:\n-            lhs_table = self.alias_map[lhs][TABLE_NAME]\n+            lhs_table = self.alias_map[lhs].table_name\n         else:\n             lhs_table = lhs\n \n@@ -889,11 +892,11 @@ def join(self, connection, always_create=False, exclusions=(),\n         if not always_create:\n             for alias in self.join_map.get(t_ident, ()):\n                 if alias not in exclusions:\n-                    if lhs_table and not self.alias_refcount[self.alias_map[alias][LHS_ALIAS]]:\n+                    if lhs_table and not self.alias_refcount[self.alias_map[alias].lhs_alias]:\n                         # The LHS of this join tuple is no longer part of the\n                         # query, so skip this possibility.\n                         continue\n-                    if self.alias_map[alias][LHS_ALIAS] != lhs:\n+                    if self.alias_map[alias].lhs_alias != lhs:\n                         continue\n                     self.ref_alias(alias)\n                     if promote:\n@@ -910,7 +913,7 @@ def join(self, connection, always_create=False, exclusions=(),\n             join_type = self.LOUTER\n         else:\n             join_type = self.INNER\n-        join = (table, alias, join_type, lhs, lhs_col, col, nullable)\n+        join = JoinInfo(table, alias, join_type, lhs, lhs_col, col, nullable)\n         self.alias_map[alias] = join\n         if t_ident in self.join_map:\n             self.join_map[t_ident] += (alias,)\n@@ -1150,7 +1153,7 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n                 # also be promoted, regardless of whether they have been\n                 # promoted as a result of this pass through the tables.\n                 unconditional = (unconditional or\n-                    self.alias_map[join][JOIN_TYPE] == self.LOUTER)\n+                    self.alias_map[join].join_type == self.LOUTER)\n                 if join == table and self.alias_refcount[join] > 1:\n                     # We have more than one reference to this join table.\n                     # This means that we are dealing with two different query\n@@ -1181,8 +1184,8 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n             if lookup_type != 'isnull':\n                 if len(join_list) > 1:\n                     for alias in join_list:\n-                        if self.alias_map[alias][JOIN_TYPE] == self.LOUTER:\n-                            j_col = self.alias_map[alias][RHS_JOIN_COL]\n+                        if self.alias_map[alias].join_type == self.LOUTER:\n+                            j_col = self.alias_map[alias].rhs_join_col\n                             entry = self.where_class()\n                             entry.add(\n                                 (Constraint(alias, j_col, None), 'isnull', True),\n@@ -1510,20 +1513,20 @@ def trim_joins(self, target, join_list, last, trim, nonnull_check=False):\n             join_list = join_list[:penultimate]\n             final = penultimate\n             penultimate = last.pop()\n-            col = self.alias_map[extra[0]][LHS_JOIN_COL]\n+            col = self.alias_map[extra[0]].lhs_join_col\n             for alias in extra:\n                 self.unref_alias(alias)\n         else:\n             col = target.column\n         alias = join_list[-1]\n         while final > 1:\n             join = self.alias_map[alias]\n-            if (col != join[RHS_JOIN_COL] or join[JOIN_TYPE] != self.INNER or\n+            if (col != join.rhs_join_col or join.join_type != self.INNER or\n                     nonnull_check):\n                 break\n             self.unref_alias(alias)\n-            alias = join[LHS_ALIAS]\n-            col = join[LHS_JOIN_COL]\n+            alias = join.lhs_alias\n+            col = join.lhs_join_col\n             join_list.pop()\n             final -= 1\n             if final == penultimate:\n@@ -1646,10 +1649,10 @@ def add_fields(self, field_names, allow_m2m=True):\n                 col = target.column\n                 if len(joins) > 1:\n                     join = self.alias_map[final_alias]\n-                    if col == join[RHS_JOIN_COL]:\n+                    if col == join.rhs_join_col:\n                         self.unref_alias(final_alias)\n-                        final_alias = join[LHS_ALIAS]\n-                        col = join[LHS_JOIN_COL]\n+                        final_alias = join.lhs_alias\n+                        col = join.lhs_join_col\n                         joins = joins[:-1]\n                 self.promote_alias_chain(joins[1:])\n                 self.select.append((final_alias, col))\n@@ -1923,7 +1926,7 @@ def set_start(self, start):\n         alias = self.get_initial_alias()\n         field, col, opts, joins, last, extra = self.setup_joins(\n                 start.split(LOOKUP_SEP), opts, alias, False)\n-        select_col = self.alias_map[joins[1]][LHS_JOIN_COL]\n+        select_col = self.alias_map[joins[1]].lhs_join_col\n         select_alias = alias\n \n         # The call to setup_joins added an extra reference to everything in\n@@ -1936,12 +1939,12 @@ def set_start(self, start):\n         # is *always* the same value as lhs).\n         for alias in joins[1:]:\n             join_info = self.alias_map[alias]\n-            if (join_info[LHS_JOIN_COL] != select_col\n-                    or join_info[JOIN_TYPE] != self.INNER):\n+            if (join_info.lhs_join_col != select_col\n+                    or join_info.join_type != self.INNER):\n                 break\n             self.unref_alias(select_alias)\n-            select_alias = join_info[RHS_ALIAS]\n-            select_col = join_info[RHS_JOIN_COL]\n+            select_alias = join_info.rhs_alias\n+            select_col = join_info.rhs_join_col\n         self.select = [(select_alias, select_col)]\n         self.remove_inherited_models()\n "
        }
    ],
    "stats": {
        "total": 113,
        "additions": 56,
        "deletions": 57
    }
}