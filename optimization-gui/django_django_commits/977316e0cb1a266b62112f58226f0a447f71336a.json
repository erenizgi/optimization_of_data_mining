{
    "author": "jphalip",
    "message": "Fixed #16816 -- Tweaked the test mock for `URLField.verify_exists` to allow tests to pass when there is no Internet connection available. Many thanks to Ramiro Morales, Aymeric Augustin and Florian Apolloner for the patch reviews.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17059 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "977316e0cb1a266b62112f58226f0a447f71336a",
    "files": [
        {
            "sha": "5c94f439d16ddb00a45b0abf840d429f70f3b5da",
            "filename": "tests/modeltests/validation/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/977316e0cb1a266b62112f58226f0a447f71336a/tests%2Fmodeltests%2Fvalidation%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/977316e0cb1a266b62112f58226f0a447f71336a/tests%2Fmodeltests%2Fvalidation%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Ftests.py?ref=977316e0cb1a266b62112f58226f0a447f71336a",
            "patch": "@@ -6,9 +6,13 @@\n from django.core.exceptions import NON_FIELD_ERRORS\n from django.test import TestCase\n \n+# Import the verify_exists_urls from the 'forms' test app\n+from regressiontests.forms.tests.fields import verify_exists_urls\n+\n from . import ValidationTestCase\n from .models import (Author, Article, ModelToValidate,\n     GenericIPAddressTestModel, GenericIPAddrUnpackUniqueTest)\n+\n # Import other tests for this package.\n from .test_custom_messages import CustomMessagesTest\n from .test_error_messages import ValidationMessagesTest\n@@ -71,10 +75,12 @@ def test_correct_url_but_nonexisting_gives_404(self):\n         mtv = ModelToValidate(number=10, name='Some Name', url_verify='http://qa-dev.w3.org/link-testsuite/http.php?code=404')\n         self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url_verify', [u'This URL appears to be a broken link.'])\n \n+    @verify_exists_urls(existing_urls=('http://www.google.com/',))\n     def test_correct_url_value_passes(self):\n         mtv = ModelToValidate(number=10, name='Some Name', url_verify='http://www.google.com/')\n         self.assertEqual(None, mtv.full_clean()) # This will fail if there's no Internet connection\n \n+    @verify_exists_urls(existing_urls=('http://qa-dev.w3.org/link-testsuite/http.php?code=301',))\n     def test_correct_url_with_redirect(self):\n         mtv = ModelToValidate(number=10, name='Some Name', url_verify='http://qa-dev.w3.org/link-testsuite/http.php?code=301') #example.com is a redirect to iana.org now\n         self.assertEqual(None, mtv.full_clean()) # This will fail if there's no Internet connection"
        },
        {
            "sha": "ecb6c23b450949ce733e2babbccd3d087a0330b8",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/977316e0cb1a266b62112f58226f0a447f71336a/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/977316e0cb1a266b62112f58226f0a447f71336a/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=977316e0cb1a266b62112f58226f0a447f71336a",
            "patch": "@@ -49,23 +49,27 @@ def fix_os_paths(x):\n \n \n def verify_exists_urls(existing_urls=()):\n+    \"\"\"\n+    Patches urllib to simulate the availability of some urls even when there\n+    is no Internet connection. This hack should be removed alongside with\n+    `URLField.verify_exists` in Django 1.5.\n+    \"\"\"\n     def decorator(func):\n         @wraps(func)\n         def wrapper(*args, **kwargs):\n             from django.core import validators\n-            # patch urllib2\n-            original_urlopen = validators.urllib2.urlopen\n-            def urlopen(req):\n-                url = req.get_full_url()\n-                if url in existing_urls:\n+            # patch urllib2.OpenerDirector\n+            original_open = validators.urllib2.OpenerDirector.open\n+            def custom_open(self, req, data=None, timeout=None):\n+                if req.get_full_url() in existing_urls:\n                     return True\n                 raise Exception()\n             try:\n-                urllib2.urlopen = urlopen\n+                urllib2.OpenerDirector.open = custom_open\n                 func(*args, **kwargs)\n             finally:\n-                # unpatch urllib2\n-                validators.urllib2.urlopen = original_urlopen\n+                # unpatch urllib2.OpenerDirector\n+                validators.urllib2.OpenerDirector.open = original_open\n         return wrapper\n     return decorator\n \n@@ -690,8 +694,9 @@ def test_urlfield_9(self):\n         except ValidationError, e:\n             self.assertEqual(\"[u'This URL appears to be a broken link.']\", str(e))\n \n+    @verify_exists_urls((u'http://xn--hxargifdar.idn.icann.org/%CE%91%CF%81%CF%87%CE%B9%CE%BA%CE%AE_%CF%83%CE%B5%CE%BB%CE%AF%CE%B4%CE%B1',))\n     def test_urlfield_10(self):\n-        # UTF-8 in the domain. \n+        # UTF-8 in the domain.\n         f = URLField(verify_exists=True)\n         url = u'http://\\u03b5\\u03bb\\u03bb\\u03b7\\u03bd\\u03b9\\u03ba\\u03ac.idn.icann.org/\\u0391\\u03c1\\u03c7\\u03b9\\u03ba\\u03ae_\\u03c3\\u03b5\\u03bb\\u03af\\u03b4\\u03b1'\n         self.assertEqual(url, f.clean(url))"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 20,
        "deletions": 9
    }
}