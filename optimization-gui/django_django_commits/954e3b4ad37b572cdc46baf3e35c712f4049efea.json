{
    "author": "jezdez",
    "message": "Fixed #13914 -- Added natural keys to User and Group models in auth contrib app. Thanks, jbochi and closedbracket.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17429 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "954e3b4ad37b572cdc46baf3e35c712f4049efea",
    "files": [
        {
            "sha": "795c1a3b7aad06fdd9bd5296524db54c162efe2a",
            "filename": "django/contrib/auth/fixtures/natural.json",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ffixtures%2Fnatural.json",
            "raw_url": "https://github.com/django/django/raw/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ffixtures%2Fnatural.json",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ffixtures%2Fnatural.json?ref=954e3b4ad37b572cdc46baf3e35c712f4049efea",
            "patch": "@@ -0,0 +1,32 @@\n+[\n+    {\n+        \"pk\": 1, \n+        \"model\": \"auth.group\", \n+        \"fields\": {\n+            \"name\": \"my_group\", \n+            \"permissions\": []\n+        }\n+    }, \n+    {\n+        \"pk\": 1, \n+        \"model\": \"auth.user\", \n+        \"fields\": {\n+            \"username\": \"my_username\", \n+            \"first_name\": \"\", \n+            \"last_name\": \"\", \n+            \"is_active\": true, \n+            \"is_superuser\": true, \n+            \"is_staff\": true, \n+            \"last_login\": \"2012-01-13 00:14:00\", \n+            \"groups\": [\n+                [\n+                    \"my_group\"\n+                ]\n+            ], \n+            \"user_permissions\": [], \n+            \"password\": \"pbkdf2_sha256$10000$LUyhxJjuLwXF$f6Zbpnx1L5dPze8m0itBaHMDyZ/n6JyhuavQy2RrBIM=\", \n+            \"email\": \"email@example.com\", \n+            \"date_joined\": \"2012-01-13 00:14:00\"\n+        }\n+    }\n+]"
        },
        {
            "sha": "dad891df2c64826280b6dd3e9dd0a2e7e3cc12b2",
            "filename": "django/contrib/auth/fixtures/regular.json",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ffixtures%2Fregular.json",
            "raw_url": "https://github.com/django/django/raw/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ffixtures%2Fregular.json",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ffixtures%2Fregular.json?ref=954e3b4ad37b572cdc46baf3e35c712f4049efea",
            "patch": "@@ -0,0 +1,30 @@\n+[\n+    {\n+        \"pk\": 1, \n+        \"model\": \"auth.group\", \n+        \"fields\": {\n+            \"name\": \"my_group\", \n+            \"permissions\": []\n+        }\n+    }, \n+    {\n+        \"pk\": 1, \n+        \"model\": \"auth.user\", \n+        \"fields\": {\n+            \"username\": \"my_username\", \n+            \"first_name\": \"\", \n+            \"last_name\": \"\", \n+            \"is_active\": true, \n+            \"is_superuser\": true, \n+            \"is_staff\": true, \n+            \"last_login\": \"2012-01-13 00:14:00\", \n+            \"groups\": [\n+                1\n+            ], \n+            \"user_permissions\": [], \n+            \"password\": \"pbkdf2_sha256$10000$LUyhxJjuLwXF$f6Zbpnx1L5dPze8m0itBaHMDyZ/n6JyhuavQy2RrBIM=\", \n+            \"email\": \"email@example.com\", \n+            \"date_joined\": \"2012-01-13 00:14:00\"\n+        }\n+    }\n+]"
        },
        {
            "sha": "571bf7902c177f7f6bf8a29e2216ffc379a215b3",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=954e3b4ad37b572cdc46baf3e35c712f4049efea",
            "patch": "@@ -86,6 +86,13 @@ def natural_key(self):\n     natural_key.dependencies = ['contenttypes.contenttype']\n \n \n+class GroupManager(models.Manager):\n+    \"\"\"\n+    The manager for the auth's Group model.\n+    \"\"\"\n+    def get_by_natural_key(self, name):\n+        return self.get(name=name)\n+\n class Group(models.Model):\n     \"\"\"\n     Groups are a generic way of categorizing users to apply permissions, or\n@@ -107,13 +114,18 @@ class Group(models.Model):\n     permissions = models.ManyToManyField(Permission,\n         verbose_name=_('permissions'), blank=True)\n \n+    objects = GroupManager()\n+\n     class Meta:\n         verbose_name = _('group')\n         verbose_name_plural = _('groups')\n \n     def __unicode__(self):\n         return self.name\n \n+    def natural_key(self):\n+        return (self.name,)\n+\n \n class UserManager(models.Manager):\n     def create_user(self, username, email=None, password=None):\n@@ -160,6 +172,9 @@ def make_random_password(self, length=10,\n         \"\"\"\n         return get_random_string(length, allowed_chars)\n \n+    def get_by_natural_key(self, username):\n+        return self.get(username=username)\n+\n \n # A few helper functions for common logic between User and AnonymousUser.\n def _user_get_all_permissions(user, obj):\n@@ -240,6 +255,9 @@ class Meta:\n     def __unicode__(self):\n         return self.username\n \n+    def natural_key(self):\n+        return (self.username,)\n+\n     def get_absolute_url(self):\n         return \"/users/%s/\" % urllib.quote(smart_str(self.username))\n "
        },
        {
            "sha": "e7188c0e4cafbd6193edd75db1417a7a66e48e34",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=954e3b4ad37b572cdc46baf3e35c712f4049efea",
            "patch": "@@ -10,12 +10,13 @@\n from django.contrib.auth.tests.remote_user import (RemoteUserTest,\n     RemoteUserNoCreateTest, RemoteUserCustomTest)\n from django.contrib.auth.tests.management import GetDefaultUsernameTestCase\n-from django.contrib.auth.tests.models import ProfileTestCase\n+from django.contrib.auth.tests.models import (ProfileTestCase, NaturalKeysTestCase,\n+    LoadDataWithoutNaturalKeysTestCase, LoadDataWithNaturalKeysTestCase)\n from django.contrib.auth.tests.hashers import TestUtilsHashPass\n from django.contrib.auth.tests.signals import SignalTestCase\n from django.contrib.auth.tests.tokens import TokenGeneratorTest\n-from django.contrib.auth.tests.views import (AuthViewNamedURLTests, \n-    PasswordResetTest, ChangePasswordTest, LoginTest, LogoutTest, \n+from django.contrib.auth.tests.views import (AuthViewNamedURLTests,\n+    PasswordResetTest, ChangePasswordTest, LoginTest, LogoutTest,\n     LoginURLSettings)\n \n # The password for the fixture data users is 'password'"
        },
        {
            "sha": "b48da4b42e265811a2e98c43ccb32f5993b79bbd",
            "filename": "django/contrib/auth/tests/models.py",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/954e3b4ad37b572cdc46baf3e35c712f4049efea/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py?ref=954e3b4ad37b572cdc46baf3e35c712f4049efea",
            "patch": "@@ -1,6 +1,6 @@\n from django.conf import settings\n from django.test import TestCase\n-from django.contrib.auth.models import User, SiteProfileNotAvailable\n+from django.contrib.auth.models import Group, User, SiteProfileNotAvailable\n \n class ProfileTestCase(TestCase):\n     fixtures = ['authtestdata.json']\n@@ -26,10 +26,41 @@ def test_site_profile_not_available(self):\n         user = User.objects.get(username='testclient')\n         self.assertRaises(SiteProfileNotAvailable, user.get_profile)\n \n-        # Bad syntax in AUTH_PROFILE_MODULE: \n+        # Bad syntax in AUTH_PROFILE_MODULE:\n         settings.AUTH_PROFILE_MODULE = 'foobar'\n         self.assertRaises(SiteProfileNotAvailable, user.get_profile)\n \n         # module that doesn't exist\n         settings.AUTH_PROFILE_MODULE = 'foo.bar'\n         self.assertRaises(SiteProfileNotAvailable, user.get_profile)\n+\n+\n+class NaturalKeysTestCase(TestCase):\n+    fixtures = ['authtestdata.json']\n+\n+    def test_user_natural_key(self):\n+        staff_user = User.objects.get(username='staff')\n+        self.assertEquals(User.objects.get_by_natural_key('staff'), staff_user)\n+        self.assertEquals(staff_user.natural_key(), ('staff',))\n+\n+    def test_group_natural_key(self):\n+        users_group = Group.objects.create(name='users')\n+        self.assertEquals(Group.objects.get_by_natural_key('users'), users_group)\n+\n+\n+class LoadDataWithoutNaturalKeysTestCase(TestCase):\n+    fixtures = ['regular.json']\n+\n+    def test_user_is_created_and_added_to_group(self):\n+        user = User.objects.get(username='my_username')\n+        group = Group.objects.get(name='my_group')\n+        self.assertEquals(group, user.groups.get())\n+\n+\n+class LoadDataWithNaturalKeysTestCase(TestCase):\n+    fixtures = ['natural.json']\n+    def test_user_is_created_and_added_to_group(self):\n+        user = User.objects.get(username='my_username')\n+        group = Group.objects.get(name='my_group')\n+        self.assertEquals(group, user.groups.get())\n+"
        },
        {
            "sha": "d7d72ec48a8b024c3077eb0f23e43e0229ab33ae",
            "filename": "docs/topics/serialization.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/954e3b4ad37b572cdc46baf3e35c712f4049efea/docs%2Ftopics%2Fserialization.txt",
            "raw_url": "https://github.com/django/django/raw/954e3b4ad37b572cdc46baf3e35c712f4049efea/docs%2Ftopics%2Fserialization.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fserialization.txt?ref=954e3b4ad37b572cdc46baf3e35c712f4049efea",
            "patch": "@@ -215,7 +215,9 @@ automatically created by Django during the database synchronization process,\n the primary key of a given content type isn't easy to predict; it will\n depend on how and when :djadmin:`syncdb` was executed. This is true for all\n models which automatically generate objects, notably including\n-:class:`~django.contrib.auth.models.Permission`.\n+:class:`~django.contrib.auth.models.Permission`,\n+:class:`~django.contrib.auth.models.Group`, and\n+:class:`~django.contrib.auth.models.User`.\n \n .. warning::\n "
        }
    ],
    "stats": {
        "total": 126,
        "additions": 120,
        "deletions": 6
    }
}