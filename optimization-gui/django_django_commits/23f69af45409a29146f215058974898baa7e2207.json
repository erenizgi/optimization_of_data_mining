{
    "author": "ramiro",
    "message": "Fixed #12201 -- Added a lineno attibute to template Token so e.g. we can report line numbers in errors during i18n literals extraction. Thanks madewulf for the report and Claude Paroz for the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14813 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "23f69af45409a29146f215058974898baa7e2207",
    "files": [
        {
            "sha": "f02a3c86492a6ef738dc19f3793009bb94010489",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 7,
            "deletions": 10,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/23f69af45409a29146f215058974898baa7e2207/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/23f69af45409a29146f215058974898baa7e2207/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=23f69af45409a29146f215058974898baa7e2207",
            "patch": "@@ -220,18 +220,15 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n                 os.unlink(os.path.join(dirpath, thefile))\n             elif domain == 'django' and (file_ext == '.py' or file_ext in extensions):\n                 thefile = file\n+                orig_file = os.path.join(dirpath, file)\n                 if file_ext in extensions:\n-                    src = open(os.path.join(dirpath, file), \"rU\").read()\n+                    src = open(orig_file, \"rU\").read()\n                     thefile = '%s.py' % file\n+                    f = open(os.path.join(dirpath, thefile), \"w\")\n                     try:\n-                        f = open(os.path.join(dirpath, thefile), \"w\")\n-                        try:\n-                            f.write(templatize(src))\n-                        finally:\n-                            f.close()\n-                    except SyntaxError, msg:\n-                        msg = \"%s (file: %s)\" % (msg, os.path.join(dirpath, file))\n-                        raise SyntaxError(msg)\n+                        f.write(templatize(src, orig_file[2:]))\n+                    finally:\n+                        f.close()\n                 if verbosity > 1:\n                     sys.stdout.write('processing file %s in %s\\n' % (file, dirpath))\n                 cmd = (\n@@ -250,7 +247,7 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n \n                 if thefile != file:\n                     old = '#: '+os.path.join(dirpath, thefile)[2:]\n-                    new = '#: '+os.path.join(dirpath, file)[2:]\n+                    new = '#: '+orig_file[2:]\n                     msgs = msgs.replace(old, new)\n                 if os.path.exists(potfile):\n                     # Strip the header"
        },
        {
            "sha": "d934e050ee344cd27a152cb879ba65697e8b1767",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/23f69af45409a29146f215058974898baa7e2207/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/23f69af45409a29146f215058974898baa7e2207/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=23f69af45409a29146f215058974898baa7e2207",
            "patch": "@@ -139,6 +139,7 @@ class Token(object):\n     def __init__(self, token_type, contents):\n         # token_type must be TOKEN_TEXT, TOKEN_VAR, TOKEN_BLOCK or TOKEN_COMMENT.\n         self.token_type, self.contents = token_type, contents\n+        self.lineno = None\n \n     def __str__(self):\n         return '<%s token: \"%s...\">' % \\\n@@ -164,6 +165,7 @@ class Lexer(object):\n     def __init__(self, template_string, origin):\n         self.template_string = template_string\n         self.origin = origin\n+        self.lineno = 1\n \n     def tokenize(self):\n         \"Return a list of tokens from a given template_string.\"\n@@ -193,6 +195,8 @@ def create_token(self, token_string, in_tag):\n                 token = Token(TOKEN_COMMENT, content)\n         else:\n             token = Token(TOKEN_TEXT, token_string)\n+        token.lineno = self.lineno\n+        self.lineno += token_string.count('\\n')\n         return token\n \n class Parser(object):"
        },
        {
            "sha": "e3edb652f61c773b85b7956c4f2c288526069a21",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/23f69af45409a29146f215058974898baa7e2207/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/23f69af45409a29146f215058974898baa7e2207/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=23f69af45409a29146f215058974898baa7e2207",
            "patch": "@@ -104,8 +104,8 @@ def to_locale(language):\n def get_language_from_request(request):\n     return _trans.get_language_from_request(request)\n \n-def templatize(src):\n-    return _trans.templatize(src)\n+def templatize(src, origin=None):\n+    return _trans.templatize(src, origin)\n \n def deactivate_all():\n     return _trans.deactivate_all()"
        },
        {
            "sha": "a5c612bfe0442b21a119540599e45ec3cc4d337a",
            "filename": "django/utils/translation/trans_real.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/23f69af45409a29146f215058974898baa7e2207/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "raw_url": "https://github.com/django/django/raw/23f69af45409a29146f215058974898baa7e2207/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_real.py?ref=23f69af45409a29146f215058974898baa7e2207",
            "patch": "@@ -421,7 +421,7 @@ def blankout(src, char):\n plural_re = re.compile(r\"\"\"^\\s*plural$\"\"\")\n constant_re = re.compile(r\"\"\"_\\(((?:\".*?\")|(?:'.*?'))\\)\"\"\")\n \n-def templatize(src):\n+def templatize(src, origin=None):\n     \"\"\"\n     Turns a Django template into something that is understood by xgettext. It\n     does so by translating the Django translation tags into standard gettext\n@@ -435,7 +435,7 @@ def templatize(src):\n     plural = []\n     incomment = False\n     comment = []\n-    for t in Lexer(src, None).tokenize():\n+    for t in Lexer(src, origin).tokenize():\n         if incomment:\n             if t.token_type == TOKEN_BLOCK and t.contents == 'endcomment':\n                 out.write(' # %s' % ''.join(comment))\n@@ -465,7 +465,10 @@ def templatize(src):\n                 elif pluralmatch:\n                     inplural = True\n                 else:\n-                    raise SyntaxError(\"Translation blocks must not include other block tags: %s\" % t.contents)\n+                    filemsg = ''\n+                    if origin:\n+                        filemsg = 'file %s, ' % origin\n+                    raise SyntaxError(\"Translation blocks must not include other block tags: %s (%sline %d)\" % (t.contents, filemsg, t.lineno))\n             elif t.token_type == TOKEN_VAR:\n                 if inplural:\n                     plural.append('%%(%s)s' % t.contents)"
        },
        {
            "sha": "9061863e67f987c9b3fc0802393429bdaaace9d2",
            "filename": "tests/regressiontests/i18n/commands/extraction.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/23f69af45409a29146f215058974898baa7e2207/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "raw_url": "https://github.com/django/django/raw/23f69af45409a29146f215058974898baa7e2207/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py?ref=23f69af45409a29146f215058974898baa7e2207",
            "patch": "@@ -59,6 +59,18 @@ def test_templatize(self):\n         self.assertMsgId('I think that 100%% is more that 50%% of anything.', po_contents)\n         self.assertMsgId('I think that 100%% is more that 50%% of %\\(obj\\)s.', po_contents)\n \n+    def test_extraction_error(self):\n+        os.chdir(self.test_dir)\n+        shutil.copyfile('./templates/template_with_error.txt', './templates/template_with_error.html')\n+        self.assertRaises(SyntaxError, management.call_command, 'makemessages', locale=LOCALE, verbosity=0)\n+        try:\n+            management.call_command('makemessages', locale=LOCALE, verbosity=0)\n+        except SyntaxError, e:\n+            self.assertEqual(str(e), 'Translation blocks must not include other block tags: blocktrans (file templates/template_with_error.html, line 3)')\n+        finally:\n+            os.remove('./templates/template_with_error.html')\n+            os.remove('./templates/template_with_error.html.py') # Waiting for #8536 to be fixed\n+\n \n class JavascriptExtractorTests(ExtractorTests):\n "
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/i18n/commands/locale/dummy",
            "status": "removed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/5a7af25c7a02ef6203a82acb6cc9098bb0b3d514/tests%2Fregressiontests%2Fi18n%2Fcommands%2Flocale%2Fdummy",
            "raw_url": "https://github.com/django/django/raw/5a7af25c7a02ef6203a82acb6cc9098bb0b3d514/tests%2Fregressiontests%2Fi18n%2Fcommands%2Flocale%2Fdummy",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Flocale%2Fdummy?ref=5a7af25c7a02ef6203a82acb6cc9098bb0b3d514"
        },
        {
            "sha": "c2b93bdd06f0bd4544c428b762711eca5199360d",
            "filename": "tests/regressiontests/i18n/commands/templates/template_with_error.txt",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/23f69af45409a29146f215058974898baa7e2207/tests%2Fregressiontests%2Fi18n%2Fcommands%2Ftemplates%2Ftemplate_with_error.txt",
            "raw_url": "https://github.com/django/django/raw/23f69af45409a29146f215058974898baa7e2207/tests%2Fregressiontests%2Fi18n%2Fcommands%2Ftemplates%2Ftemplate_with_error.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Ftemplates%2Ftemplate_with_error.txt?ref=23f69af45409a29146f215058974898baa7e2207",
            "patch": "@@ -0,0 +1,3 @@\n+{% load i18n %}\n+<p>This template contains an error (no endblocktrans)</p>\n+<p>{% blocktrans %}This should fail{% blocktrans %}</p>"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 34,
        "deletions": 15
    }
}