{
    "author": "ramiro",
    "message": "Fixed #19552 -- Enhanced makemessages handling of ``{# #}``-style template comments.\n\nThey are simply ignored now. This allows for a more correct behavior when\nthey are placed before translatable constructs on the same line.\n\nPreviously, the latter were wrongly ignored because the former were\npreserved when converting template code to the internal Python-syntax\nform later fed to xgettext but Python has no ``/* ... */``-style\ncomments.\n\nAlso, special comments directed to translators are now only taken in\naccount when they are located at the end of a line. e.g.::\n\n  {# Translators: ignored #}{% trans \"Literal A\" %}{# Translators: valid, associated with \"Literal B\" below #}\n  {% trans \"Literal B\" %}\n\nBehavior of ``{% comment %}...{% endcomment %}``tags remains unchanged.\n\nThanks juneih at redpill-linpro dot com for the report and Claude for\nhis work on the issue.",
    "sha": "47ddd6a4082d55d8856b7e6beac553485dd627f7",
    "files": [
        {
            "sha": "803bbb746a04c9107408f3e0dce474e434819dde",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -21,6 +21,11 @@\n     'npgettext', 'npgettext_lazy',\n ]\n \n+\n+class TranslatorCommentWarning(SyntaxWarning):\n+    pass\n+\n+\n # Here be dragons, so a short explanation of the logic won't hurt:\n # We are trying to solve two problems: (1) access settings, in particular\n # settings.USE_I18N, as late as possible, so that modules can be imported"
        },
        {
            "sha": "8014b5ea3a99da3192d37ef023f5a00fb1e52ab4",
            "filename": "django/utils/translation/trans_real.py",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_real.py?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -7,13 +7,15 @@\n import sys\n import gettext as gettext_module\n from threading import local\n+import warnings\n \n from django.utils.importlib import import_module\n from django.utils.encoding import force_str, force_text\n from django.utils._os import upath\n from django.utils.safestring import mark_safe, SafeData\n from django.utils import six\n from django.utils.six import StringIO\n+from django.utils.translation import TranslatorCommentWarning\n \n \n # Translations are cached in a dictionary for every language+app tuple.\n@@ -41,6 +43,7 @@\n \n language_code_prefix_re = re.compile(r'^/([\\w-]+)(/|$)')\n \n+\n def to_locale(language, to_lower=False):\n     \"\"\"\n     Turns a language name (en-us) into a locale name (en_US). If 'to_lower' is\n@@ -468,6 +471,9 @@ def templatize(src, origin=None):\n     plural = []\n     incomment = False\n     comment = []\n+    lineno_comment_map = {}\n+    comment_lineno_cache = None\n+\n     for t in Lexer(src, origin).tokenize():\n         if incomment:\n             if t.token_type == TOKEN_BLOCK and t.contents == 'endcomment':\n@@ -529,7 +535,27 @@ def templatize(src, origin=None):\n                     plural.append(contents)\n                 else:\n                     singular.append(contents)\n+\n         else:\n+            # Handle comment tokens (`{# ... #}`) plus other constructs on\n+            # the same line:\n+            if comment_lineno_cache is not None:\n+                cur_lineno = t.lineno + t.contents.count('\\n')\n+                if comment_lineno_cache == cur_lineno:\n+                    if t.token_type != TOKEN_COMMENT:\n+                        for c in lineno_comment_map[comment_lineno_cache]:\n+                            filemsg = ''\n+                            if origin:\n+                                filemsg = 'file %s, ' % origin\n+                            warn_msg = (\"The translator-targeted comment '%s' \"\n+                                \"(%sline %d) was ignored, because it wasn't the last item \"\n+                                \"on the line.\") % (c, filemsg, comment_lineno_cache)\n+                            warnings.warn(warn_msg, TranslatorCommentWarning)\n+                        lineno_comment_map[comment_lineno_cache] = []\n+                else:\n+                    out.write('# %s' % ' | '.join(lineno_comment_map[comment_lineno_cache]))\n+                comment_lineno_cache = None\n+\n             if t.token_type == TOKEN_BLOCK:\n                 imatch = inline_re.match(t.contents)\n                 bmatch = block_re.match(t.contents)\n@@ -586,7 +612,10 @@ def templatize(src, origin=None):\n                     else:\n                         out.write(blankout(p, 'F'))\n             elif t.token_type == TOKEN_COMMENT:\n-                out.write(' # %s' % t.contents)\n+                if t.contents.lstrip().startswith(TRANSLATOR_COMMENT_MARK):\n+                    lineno_comment_map.setdefault(t.lineno,\n+                                                  []).append(t.contents)\n+                    comment_lineno_cache = t.lineno\n             else:\n                 out.write(blankout(t.contents, 'X'))\n     return force_str(out.getvalue())"
        },
        {
            "sha": "79fa3ffb86007a3179b1a9eb3bacadb3d2319ded",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -47,6 +47,26 @@ Backwards incompatible changes in 1.6\n   should review it as ``type='text'`` widgets might be now output as\n   ``type='email'`` or ``type='url'`` depending on their corresponding field type.\n \n+* Extraction of translatable literals from templates with the\n+  :djadmin:`makemessages` command now correctly detects i18n constructs when\n+  they are located after a ``{#`` / ``#}``-type comment on the same line. E.g.:\n+\n+  .. code-block:: html+django\n+\n+    {# A comment #}{% trans \"This literal was incorrectly ignored. Not anymore\" %}\n+\n+* (Related to the above item.) Validation of the placement of\n+  :ref:`translator-comments-in-templates` specified using ``{#`` / ``#}`` is now\n+  stricter. All translator comments not located at the end of their respective\n+  lines in a template are ignored and a warning is generated by\n+  :djadmin:`makemessages` when it finds them. E.g.:\n+\n+  .. code-block:: html+django\n+\n+    {# Translators: This is ignored #}{% trans \"Translate me\" %}\n+    {{ title }}{# Translators: Extracted and associated with 'Welcome' below #}\n+    <h1>{% trans \"Welcome\" %}</h1>\n+\n .. warning::\n \n     In addition to the changes outlined in this section, be sure to review the"
        },
        {
            "sha": "3cf08e7ddfcf54ba0ec63c888bfbf2cdaa61a789",
            "filename": "docs/topics/i18n/translation.txt",
            "status": "modified",
            "additions": 70,
            "deletions": 5,
            "changes": 75,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/docs%2Ftopics%2Fi18n%2Ftranslation.txt",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/docs%2Ftopics%2Fi18n%2Ftranslation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Ftranslation.txt?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -142,14 +142,22 @@ preceding the string, e.g.::\n         # Translators: This message appears on the home page only\n         output = ugettext(\"Welcome to my site.\")\n \n-This also works in templates with the :ttag:`comment` tag:\n+The comment will then appear in the resulting ``.po`` file associated with the\n+translatable contruct located below it and should also be displayed by most\n+translation tools.\n \n-.. code-block:: html+django\n+.. note:: Just for completeness, this is the corresponding fragment of the\n+    resulting ``.po`` file:\n+\n+    .. code-block:: po\n \n-    {% comment %}Translators: This is a text of the base template {% endcomment %}\n+        #. Translators: This message appears on the home page only\n+        # path/to/python/file.py:123\n+        msgid \"Welcome to my site.\"\n+        msgstr \"\"\n \n-The comment will then appear in the resulting ``.po`` file and should also be\n-displayed by most translation tools.\n+This also works in templates. See :ref:`translator-comments-in-templates` for\n+more details.\n \n Marking strings as no-op\n ------------------------\n@@ -620,6 +628,63 @@ markers<contextual-markers>` using the ``context`` keyword:\n \n     {% blocktrans with name=user.username context \"greeting\" %}Hi {{ name }}{% endblocktrans %}\n \n+.. _translator-comments-in-templates:\n+\n+Comments for translators in templates\n+-------------------------------------\n+\n+Just like with :ref:`Python code <translator-comments>`, these notes for\n+translators can be specified using comments, either with the :ttag:`comment`\n+tag:\n+\n+.. code-block:: html+django\n+\n+    {% comment %}Translators: View verb{% endcomment %}\n+    {% trans \"View\" %}\n+\n+    {% comment %}Translators: Short intro blurb{% endcomment %}\n+    <p>{% blocktrans %}A multiline translatable\n+    literal.{% endblocktrans %}</p>\n+\n+or with the ``{#`` ... ``#}`` :ref:`one-line comment constructs <template-comments>`:\n+\n+.. code-block:: html+django\n+\n+    {# Translators: Label of a button that triggers search{% endcomment #}\n+    <button type=\"submit\">{% trans \"Go\" %}</button>\n+\n+    {# Translators: This is a text of the base template #}\n+    {% blocktrans %}Ambiguous translatable block of text{% endtransblock %}\n+\n+.. note:: Just for completeness, these are the corresponding fragments of the\n+    resulting ``.po`` file:\n+\n+    .. code-block:: po\n+\n+        #. Translators: View verb\n+        # path/to/template/file.html:10\n+        msgid \"View\"\n+        msgstr \"\"\n+\n+        #. Translators: Short intro blurb\n+        # path/to/template/file.html:13\n+        msgid \"\"\n+        \"A multiline translatable\"\n+        \"literal.\"\n+        msgstr \"\"\n+\n+        # ...\n+\n+        #. Translators: Label of a button that triggers search\n+        # path/to/template/file.html:100\n+        msgid \"Go\"\n+        msgstr \"\"\n+\n+        #. Translators:\n+        # path/to/template/file.html:103\n+        msgid \"Ambiguous translatable block of text\"\n+        msgstr \"\"\n+\n .. _template-translation-vars:\n \n Other tags"
        },
        {
            "sha": "58a3ee9870b4d8842164f0586bc643c402e7d062",
            "filename": "docs/topics/templates.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/docs%2Ftopics%2Ftemplates.txt",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/docs%2Ftopics%2Ftemplates.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftemplates.txt?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -250,6 +250,8 @@ You can also create your own custom template tags; see\n     tags and filters available for a given site. See\n     :doc:`/ref/contrib/admin/admindocs`.\n \n+.. _template-comments:\n+\n Comments\n ========\n "
        },
        {
            "sha": "0367d23ec6b2cfddafdcd6fb5cf1347533ac0645",
            "filename": "tests/regressiontests/i18n/commands/extraction.py",
            "status": "modified",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -4,13 +4,15 @@\n import os\n import re\n import shutil\n+import warnings\n \n from django.core import management\n from django.test import SimpleTestCase\n from django.utils.encoding import force_text\n from django.utils._os import upath\n from django.utils import six\n from django.utils.six import StringIO\n+from django.utils.translation import TranslatorCommentWarning\n \n \n LOCALE='de'\n@@ -120,6 +122,7 @@ def test_extraction_error(self):\n         self.assertFalse(os.path.exists('./templates/template_with_error.tpl.py'))\n \n     def test_extraction_warning(self):\n+        \"\"\"test xgettext warning about multiple bare interpolation placeholders\"\"\"\n         os.chdir(self.test_dir)\n         shutil.copyfile('./code.sample', './code_sample.py')\n         stdout = StringIO()\n@@ -172,6 +175,63 @@ def test_context_in_single_quotes(self):\n             self.assertTrue('msgctxt \"Special blocktrans context wrapped in double quotes\"' in po_contents)\n             self.assertTrue('msgctxt \"Special blocktrans context wrapped in single quotes\"' in po_contents)\n \n+    def test_template_comments(self):\n+        \"\"\"Template comment tags on the same line of other constructs (#19552)\"\"\"\n+        os.chdir(self.test_dir)\n+        # Test detection/end user reporting of old, incorrect templates\n+        # translator comments syntax\n+        with warnings.catch_warnings(record=True) as ws:\n+            warnings.simplefilter('always')\n+            management.call_command('makemessages', locale=LOCALE, extensions=['thtml'], verbosity=0)\n+            self.assertEqual(len(ws), 3)\n+            for w in ws:\n+                self.assertTrue(issubclass(w.category, TranslatorCommentWarning))\n+            six.assertRegex(self, str(ws[0].message),\n+                r\"The translator-targeted comment 'Translators: ignored i18n comment #1' \\(file templates/comments.thtml, line 4\\) was ignored, because it wasn't the last item on the line\\.\"\n+            )\n+            six.assertRegex(self, str(ws[1].message),\n+                r\"The translator-targeted comment 'Translators: ignored i18n comment #3' \\(file templates/comments.thtml, line 6\\) was ignored, because it wasn't the last item on the line\\.\"\n+            )\n+            six.assertRegex(self, str(ws[2].message),\n+                r\"The translator-targeted comment 'Translators: ignored i18n comment #4' \\(file templates/comments.thtml, line 8\\) was ignored, because it wasn't the last item on the line\\.\"\n+            )\n+        # Now test .po file contents\n+        self.assertTrue(os.path.exists(self.PO_FILE))\n+        with open(self.PO_FILE, 'r') as fp:\n+            po_contents = force_text(fp.read())\n+\n+            self.assertMsgId('Translatable literal #9a', po_contents)\n+            self.assertFalse('ignored comment #1' in po_contents)\n+\n+            self.assertFalse('Translators: ignored i18n comment #1' in po_contents)\n+            self.assertMsgId(\"Translatable literal #9b\", po_contents)\n+\n+            self.assertFalse('ignored i18n comment #2' in po_contents)\n+            self.assertFalse('ignored comment #2' in po_contents)\n+            self.assertMsgId('Translatable literal #9c', po_contents)\n+\n+            self.assertFalse('ignored comment #3' in po_contents)\n+            self.assertFalse('ignored i18n comment #3' in po_contents)\n+            self.assertMsgId('Translatable literal #9d', po_contents)\n+\n+            self.assertFalse('ignored comment #4' in po_contents)\n+            self.assertMsgId('Translatable literal #9e', po_contents)\n+            self.assertFalse('ignored comment #5' in po_contents)\n+\n+            self.assertFalse('ignored i18n comment #4' in po_contents)\n+            self.assertMsgId('Translatable literal #9f', po_contents)\n+            self.assertTrue('#. Translators: valid i18n comment #5' in po_contents)\n+\n+            self.assertMsgId('Translatable literal #9g', po_contents)\n+            self.assertTrue('#. Translators: valid i18n comment #6' in po_contents)\n+            self.assertMsgId('Translatable literal #9h', po_contents)\n+            self.assertTrue('#. Translators: valid i18n comment #7' in po_contents)\n+            self.assertMsgId('Translatable literal #9i', po_contents)\n+\n+            six.assertRegex(self, po_contents, r'#\\..+Translators: valid i18n comment #8')\n+            six.assertRegex(self, po_contents, r'#\\..+Translators: valid i18n comment #9')\n+            self.assertMsgId(\"Translatable literal #9j\", po_contents)\n+\n \n class JavascriptExtractorTests(ExtractorTests):\n "
        },
        {
            "sha": "90eb5f1792468ad55accd244e133e9030a999964",
            "filename": "tests/regressiontests/i18n/commands/templates/comments.thtml",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/47ddd6a4082d55d8856b7e6beac553485dd627f7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Ftemplates%2Fcomments.thtml",
            "raw_url": "https://github.com/django/django/raw/47ddd6a4082d55d8856b7e6beac553485dd627f7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Ftemplates%2Fcomments.thtml",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Ftemplates%2Fcomments.thtml?ref=47ddd6a4082d55d8856b7e6beac553485dd627f7",
            "patch": "@@ -0,0 +1,13 @@\n+{% load i18n %}\n+\n+{# ignored comment #1 #}{% trans \"Translatable literal #9a\" %}\n+{# Translators: ignored i18n comment #1 #}{% trans \"Translatable literal #9b\" %}\n+{# Translators: ignored i18n comment #2 #}{# ignored comment #2 #}{% trans \"Translatable literal #9c\" %}\n+{# ignored comment #3 #}{# Translators: ignored i18n comment #3 #}{% trans \"Translatable literal #9d\" %}\n+{# ignored comment #4 #}{% trans \"Translatable literal #9e\" %}{# ignored comment #5 #}\n+{# Translators: ignored i18n comment #4 #}{% trans \"Translatable literal #9f\" %}{# Translators: valid i18n comment #5 #}\n+{% trans \"Translatable literal #9g\" %}{# Translators: valid i18n comment #6 #}\n+{# ignored comment #6 #}{% trans \"Translatable literal #9h\" %}{# Translators: valid i18n comment #7 #}\n+{% trans \"Translatable literal #9i\" %}\n+{# Translators: valid i18n comment #8 #}{# Translators: valid i18n comment #9 #}\n+{% trans \"Translatable literal #9j\" %}"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 200,
        "deletions": 6
    }
}