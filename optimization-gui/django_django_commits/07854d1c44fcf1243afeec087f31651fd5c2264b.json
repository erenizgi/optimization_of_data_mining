{
    "author": "jezdez",
    "message": "Fixed #15713 -- Added a form field for validating Polish National ID Card numbers. Thanks, xtrqt.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16116 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "07854d1c44fcf1243afeec087f31651fd5c2264b",
    "files": [
        {
            "sha": "ef4a38b7de27fe15ca4552cf4379b8c8ede85fc0",
            "filename": "django/contrib/localflavor/pl/forms.py",
            "status": "modified",
            "additions": 56,
            "deletions": 1,
            "changes": 57,
            "blob_url": "https://github.com/django/django/blob/07854d1c44fcf1243afeec087f31651fd5c2264b/django%2Fcontrib%2Flocalflavor%2Fpl%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/07854d1c44fcf1243afeec087f31651fd5c2264b/django%2Fcontrib%2Flocalflavor%2Fpl%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Flocalflavor%2Fpl%2Fforms.py?ref=07854d1c44fcf1243afeec087f31651fd5c2264b",
            "patch": "@@ -44,7 +44,7 @@ def __init__(self, *args, **kwargs):\n         super(PLPESELField, self).__init__(r'^\\d{11}$',\n             max_length=None, min_length=None, *args, **kwargs)\n \n-    def clean(self,value):\n+    def clean(self, value):\n         super(PLPESELField, self).clean(value)\n         if value in EMPTY_VALUES:\n             return u''\n@@ -62,6 +62,60 @@ def has_valid_checksum(self, number):\n             result += int(number[i]) * multiple_table[i]\n         return result % 10 == 0\n \n+class PLNationalIDCardNumberField(RegexField):\n+    \"\"\"\n+    A form field that validates as Polish National ID Card Number.\n+\n+    Checks the following rules:\n+        * the length consist of 3 letter and 6 digits\n+        * has a valid checksum\n+\n+    The algorithm is documented at http://en.wikipedia.org/wiki/Polish_identity_card.\n+    \"\"\"\n+    default_error_messages = {\n+        'invalid': _(u'National ID Card Number consists of 3 letters and 6 digits.'),\n+        'checksum': _(u'Wrong checksum for the National ID Card Number.'),\n+    }\n+\n+    def __init__(self, *args, **kwargs):\n+        super(PLNationalIDCardNumberField, self).__init__(r'^[A-Za-z]{3}\\d{6}$',\n+            max_length=None, min_length=None, *args, **kwargs)\n+\n+    def clean(self,value):\n+        super(PLNationalIDCardNumberField, self).clean(value)\n+        if value in EMPTY_VALUES:\n+            return u''\n+\n+        value = value.upper()\n+\n+        if not self.has_valid_checksum(value):\n+            raise ValidationError(self.error_messages['checksum'])\n+        return u'%s' % value\n+\n+    def has_valid_checksum(self, number):\n+        \"\"\"\n+        Calculates a checksum with the provided algorithm.\n+        \"\"\"\n+        letter_dict = {'A': 10, 'B': 11, 'C': 12, 'D': 13,\n+                       'E': 14, 'F': 15, 'G': 16, 'H': 17,\n+                       'I': 18, 'J': 19, 'K': 20, 'L': 21,\n+                       'M': 22, 'N': 23, 'O': 24, 'P': 25,\n+                       'Q': 26, 'R': 27, 'S': 28, 'T': 29,\n+                       'U': 30, 'V': 31, 'W': 32, 'X': 33,\n+                       'Y': 34, 'Z': 35}\n+\n+        # convert letters to integer values\n+        int_table = [(not c.isdigit()) and letter_dict[c] or int(c)\n+                     for c in number]\n+\n+        multiple_table = (7, 3, 1, -1, 7, 3, 1, 7, 3)\n+        result = 0\n+        for i in range(len(int_table)):\n+            result += int_table[i] * multiple_table[i]\n+\n+        return result % 10 == 0\n+\n+\n class PLNIPField(RegexField):\n     \"\"\"\n     A form field that validates as Polish Tax Number (NIP).\n@@ -158,3 +212,4 @@ class PLPostalCodeField(RegexField):\n     def __init__(self, *args, **kwargs):\n         super(PLPostalCodeField, self).__init__(r'^\\d{2}-\\d{3}$',\n             max_length=None, min_length=None, *args, **kwargs)\n+"
        },
        {
            "sha": "4935382093752e266c8d30680b2ec1cfeee4179e",
            "filename": "docs/ref/contrib/localflavor.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/07854d1c44fcf1243afeec087f31651fd5c2264b/docs%2Fref%2Fcontrib%2Flocalflavor.txt",
            "raw_url": "https://github.com/django/django/raw/07854d1c44fcf1243afeec087f31651fd5c2264b/docs%2Fref%2Fcontrib%2Flocalflavor.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Flocalflavor.txt?ref=07854d1c44fcf1243afeec087f31651fd5c2264b",
            "patch": "@@ -759,6 +759,17 @@ Poland (``pl``)\n \n .. _PESEL: http://en.wikipedia.org/wiki/PESEL\n \n+.. versionadded:: 1.4\n+\n+.. class:: pl.forms.PLNationalIDCardNumberField\n+\n+    A form field that validates input as a Polish National ID Card number. The\n+    valid format is AAAXXXXXX, where A is letter (A-Z), X is digit and left-most\n+    digit is checksum digit. More information about checksum calculation algorithm\n+    see `Polish identity card`_.\n+\n+.. _`Polish identity card`: http://en.wikipedia.org/wiki/Polish_identity_card\n+\n .. class:: pl.forms.PLREGONField\n \n     A form field that validates input as a Polish National Official Business"
        },
        {
            "sha": "7225abe87dc792cde395ab94ee321d34a57ad12e",
            "filename": "tests/regressiontests/forms/localflavor/pl.py",
            "status": "modified",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/07854d1c44fcf1243afeec087f31651fd5c2264b/tests%2Fregressiontests%2Fforms%2Flocalflavor%2Fpl.py",
            "raw_url": "https://github.com/django/django/raw/07854d1c44fcf1243afeec087f31651fd5c2264b/tests%2Fregressiontests%2Fforms%2Flocalflavor%2Fpl.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Flocalflavor%2Fpl.py?ref=07854d1c44fcf1243afeec087f31651fd5c2264b",
            "patch": "@@ -1,5 +1,5 @@\n from django.contrib.localflavor.pl.forms import (PLProvinceSelect,\n-    PLCountySelect, PLPostalCodeField, PLNIPField, PLPESELField, PLREGONField)\n+    PLCountySelect, PLPostalCodeField, PLNIPField, PLPESELField, PLNationalIDCardNumberField, PLREGONField)\n \n from utils import LocalFlavorTestCase\n \n@@ -26,7 +26,7 @@ def test_PLProvinceSelect(self):\n <option value=\"west_pomerania\">West Pomerania</option>\n </select>'''\n         self.assertEqual(f.render('voivodeships', 'pomerania'), out)\n-    \n+\n     def test_PLCountrySelect(self):\n         f = PLCountySelect()\n         out = u'''<select name=\"administrativeunit\">\n@@ -408,7 +408,7 @@ def test_PLCountrySelect(self):\n <option value=\"walecki\">wa\\u0142ecki</option>\n </select>'''\n         self.assertEqual(f.render('administrativeunit', 'katowice'), out)\n-    \n+\n     def test_PLPostalCodeField(self):\n         error_format = [u'Enter a postal code in the format XX-XXX.']\n         valid = {\n@@ -418,7 +418,7 @@ def test_PLPostalCodeField(self):\n             '43--434': error_format,\n         }\n         self.assertFieldOutput(PLPostalCodeField, valid, invalid)\n-    \n+\n     def test_PLNIPField(self):\n         error_format = [u'Enter a tax number field (NIP) in the format XXX-XXX-XX-XX or XX-XX-XXX-XXX.']\n         error_checksum = [u'Wrong checksum for the Tax Number (NIP).']\n@@ -431,7 +431,7 @@ def test_PLNIPField(self):\n             '646-241-41-23': error_checksum,\n         }\n         self.assertFieldOutput(PLNIPField, valid, invalid)\n-    \n+\n     def test_PLPESELField(self):\n         error_checksum = [u'Wrong checksum for the National Identification Number.']\n         error_format = [u'National Identification Number consists of 11 digits.']\n@@ -444,7 +444,22 @@ def test_PLPESELField(self):\n             '800716106AA': error_format,\n         }\n         self.assertFieldOutput(PLPESELField, valid, invalid)\n-    \n+\n+    def test_PLNationalIDCardNumberField(self):\n+        error_checksum = [u'Wrong checksum for the National ID Card Number.']\n+        error_format = [u'National ID Card Number consists of 3 letters and 6 digits.']\n+        valid = {\n+            'ABC123458': 'ABC123458',\n+            'abc123458': 'ABC123458',\n+        }\n+        invalid = {\n+            'ABC123457': error_checksum,\n+            'abc123457': error_checksum,\n+            'a12Aaaaaa': error_format,\n+            'AA1234443': error_format,\n+        }\n+        self.assertFieldOutput(PLNationalIDCardNumberField, valid, invalid)\n+\n     def test_PLREGONField(self):\n         error_checksum = [u'Wrong checksum for the National Business Register Number (REGON).']\n         error_format = [u'National Business Register Number (REGON) consists of 9 or 14 digits.']\n@@ -459,4 +474,3 @@ def test_PLREGONField(self):\n             '590096': error_format,\n         }\n         self.assertFieldOutput(PLREGONField, valid, invalid)\n-"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 88,
        "deletions": 8
    }
}