{
    "author": "claudep",
    "message": "Fixed #4680 -- Improved initial_sql parsing\n\nIn particular, allow the '--' sequence to be present in string\nvalues without being interpreted as comment marker.\nThanks Tim Chase for the report and shaleh for the initial patch.",
    "sha": "423244bc6b670abc2b7d6896add5c1baf0b4ef2a",
    "files": [
        {
            "sha": "46d3cf28ed511b5c9d481112a1e362d9cb7120f8",
            "filename": "django/core/management/sql.py",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/423244bc6b670abc2b7d6896add5c1baf0b4ef2a/django%2Fcore%2Fmanagement%2Fsql.py",
            "raw_url": "https://github.com/django/django/raw/423244bc6b670abc2b7d6896add5c1baf0b4ef2a/django%2Fcore%2Fmanagement%2Fsql.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fsql.py?ref=423244bc6b670abc2b7d6896add5c1baf0b4ef2a",
            "patch": "@@ -136,6 +136,20 @@ def sql_all(app, style, connection):\n     \"Returns a list of CREATE TABLE SQL, initial-data inserts, and CREATE INDEX SQL for the given module.\"\n     return sql_create(app, style, connection) + sql_custom(app, style, connection) + sql_indexes(app, style, connection)\n \n+def _split_statements(content):\n+    comment_re = re.compile(r\"^((?:'[^']*'|[^'])*?)--.*$\")\n+    statements = []\n+    statement = \"\"\n+    for line in content.split(\"\\n\"):\n+        cleaned_line = comment_re.sub(r\"\\1\", line).strip()\n+        if not cleaned_line:\n+            continue\n+        statement += cleaned_line\n+        if statement.endswith(\";\"):\n+            statements.append(statement)\n+            statement = \"\"\n+    return statements\n+\n def custom_sql_for_model(model, style, connection):\n     opts = model._meta\n     app_dir = os.path.normpath(os.path.join(os.path.dirname(models.get_app(model._meta.app_label).__file__), 'sql'))\n@@ -149,23 +163,16 @@ def custom_sql_for_model(model, style, connection):\n         for f in post_sql_fields:\n             output.extend(f.post_create_sql(style, model._meta.db_table))\n \n-    # Some backends can't execute more than one SQL statement at a time,\n-    # so split into separate statements.\n-    statements = re.compile(r\";[ \\t]*$\", re.M)\n-\n     # Find custom SQL, if it's available.\n     backend_name = connection.settings_dict['ENGINE'].split('.')[-1]\n     sql_files = [os.path.join(app_dir, \"%s.%s.sql\" % (opts.object_name.lower(), backend_name)),\n                  os.path.join(app_dir, \"%s.sql\" % opts.object_name.lower())]\n     for sql_file in sql_files:\n         if os.path.exists(sql_file):\n             with open(sql_file, 'U') as fp:\n-                for statement in statements.split(fp.read().decode(settings.FILE_CHARSET)):\n-                    # Remove any comments from the file\n-                    statement = re.sub(r\"--.*([\\n\\Z]|$)\", \"\", statement)\n-                    if statement.strip():\n-                        output.append(statement + \";\")\n-\n+                # Some backends can't execute more than one SQL statement at a time,\n+                # so split into separate statements.\n+                output.extend(_split_statements(fp.read().decode(settings.FILE_CHARSET)))\n     return output\n \n "
        },
        {
            "sha": "18fd8a401eaaf40f5de59cdc8842c0381734a2c1",
            "filename": "tests/regressiontests/initial_sql_regress/sql/simple.sql",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/423244bc6b670abc2b7d6896add5c1baf0b4ef2a/tests%2Fregressiontests%2Finitial_sql_regress%2Fsql%2Fsimple.sql",
            "raw_url": "https://github.com/django/django/raw/423244bc6b670abc2b7d6896add5c1baf0b4ef2a/tests%2Fregressiontests%2Finitial_sql_regress%2Fsql%2Fsimple.sql",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finitial_sql_regress%2Fsql%2Fsimple.sql?ref=423244bc6b670abc2b7d6896add5c1baf0b4ef2a",
            "patch": "@@ -1,8 +1,10 @@\n-INSERT INTO initial_sql_regress_simple (name) VALUES ('John');\n+-- a comment\n+INSERT INTO initial_sql_regress_simple (name) VALUES ('John'); -- another comment\n+INSERT INTO initial_sql_regress_simple (name) VALUES ('-- Comment Man');\n INSERT INTO initial_sql_regress_simple (name) VALUES ('Paul');\n INSERT INTO initial_sql_regress_simple (name) VALUES ('Ringo');\n INSERT INTO initial_sql_regress_simple (name) VALUES ('George');\n INSERT INTO initial_sql_regress_simple (name) VALUES ('Miles O''Brien');\n INSERT INTO initial_sql_regress_simple (name) VALUES ('Semicolon;Man');\n-INSERT INTO initial_sql_regress_simple (name) VALUES ('This line has a Windows line ending');\r\n+INSERT INTO initial_sql_regress_simple (name) VALUES ('This line has a Windows line ending');\n "
        },
        {
            "sha": "03a91cb807af96c525844b6bdb9667e3275ce015",
            "filename": "tests/regressiontests/initial_sql_regress/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/423244bc6b670abc2b7d6896add5c1baf0b4ef2a/tests%2Fregressiontests%2Finitial_sql_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/423244bc6b670abc2b7d6896add5c1baf0b4ef2a/tests%2Fregressiontests%2Finitial_sql_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finitial_sql_regress%2Ftests.py?ref=423244bc6b670abc2b7d6896add5c1baf0b4ef2a",
            "patch": "@@ -4,12 +4,26 @@\n \n \n class InitialSQLTests(TestCase):\n-    def test_initial_sql(self):\n-        # The format of the included SQL file for this test suite is important.\n-        # It must end with a trailing newline in order to test the fix for #2161.\n+    # The format of the included SQL file for this test suite is important.\n+    # It must end with a trailing newline in order to test the fix for #2161.\n \n-        # However, as pointed out by #14661, test data loaded by custom SQL\n+    def test_initial_sql(self):\n+        # As pointed out by #14661, test data loaded by custom SQL\n         # can't be relied upon; as a result, the test framework flushes the\n         # data contents before every test. This test validates that this has\n         # occurred.\n         self.assertEqual(Simple.objects.count(), 0)\n+\n+    def test_custom_sql(self):\n+        from django.core.management.sql import custom_sql_for_model\n+        from django.core.management.color import no_style\n+        from django.db import connections, DEFAULT_DB_ALIAS\n+\n+        # Simulate the custom SQL loading by syncdb\n+        connection = connections[DEFAULT_DB_ALIAS]\n+        custom_sql = custom_sql_for_model(Simple, no_style(), connection)\n+        self.assertEqual(len(custom_sql), 8)\n+        cursor = connection.cursor()\n+        for sql in custom_sql:\n+            cursor.execute(sql)\n+        self.assertEqual(Simple.objects.count(), 8)"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 39,
        "deletions": 16
    }
}