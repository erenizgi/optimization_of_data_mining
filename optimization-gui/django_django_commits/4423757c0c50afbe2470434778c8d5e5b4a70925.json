{
    "author": "newmaniese",
    "message": "Fixed #18135 -- Close connection used for db version checking\n\nOn MySQL when checking the server version, a new connection could be\ncreated but never closed. This could result in open connections on\nserver startup.",
    "sha": "4423757c0c50afbe2470434778c8d5e5b4a70925",
    "files": [
        {
            "sha": "1df487bd92816b4408de3563f4bb98ad47ddd538",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/4423757c0c50afbe2470434778c8d5e5b4a70925/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/4423757c0c50afbe2470434778c8d5e5b4a70925/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=4423757c0c50afbe2470434778c8d5e5b4a70925",
            "patch": "@@ -418,11 +418,20 @@ def _rollback(self):\n     @cached_property\n     def mysql_version(self):\n         if not self.server_version:\n+            new_connection = False\n             if not self._valid_connection():\n+                # Ensure we have a connection with the DB by using a temporary\n+                # cursor\n+                new_connection = True\n                 self.cursor().close()\n-            m = server_version_re.match(self.connection.get_server_info())\n+            server_info = self.connection.get_server_info()\n+            if new_connection:\n+                # Make sure we close the connection\n+                self.connection.close()\n+                self.connection = None\n+            m = server_version_re.match(server_info)\n             if not m:\n-                raise Exception('Unable to determine MySQL version from version string %r' % self.connection.get_server_info())\n+                raise Exception('Unable to determine MySQL version from version string %r' % server_info)\n             self.server_version = tuple([int(x) for x in m.groups()])\n         return self.server_version\n "
        },
        {
            "sha": "109e1a5bcc3e06bb8da02ae2dd5595b626bf6adf",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/4423757c0c50afbe2470434778c8d5e5b4a70925/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4423757c0c50afbe2470434778c8d5e5b4a70925/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=4423757c0c50afbe2470434778c8d5e5b4a70925",
            "patch": "@@ -89,6 +89,12 @@ def test_autoincrement(self):\n         else:\n             self.assertFalse(found_reset)\n \n+    @unittest.skipUnless(connection.vendor == 'mysql',\n+                        \"Test valid only for MySQL\")\n+    def test_server_version_connections(self):\n+        connection.close()\n+        connection.mysql_version\n+        self.assertTrue(connection.connection is None)\n \n class DateQuotingTest(TestCase):\n "
        }
    ],
    "stats": {
        "total": 19,
        "additions": 17,
        "deletions": 2
    }
}