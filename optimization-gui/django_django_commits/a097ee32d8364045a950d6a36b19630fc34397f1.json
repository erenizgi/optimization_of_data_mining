{
    "author": "charettes",
    "message": "Fixed #17683 -- Make sure `BaseModelFormSet` respects defined widgets.",
    "sha": "a097ee32d8364045a950d6a36b19630fc34397f1",
    "files": [
        {
            "sha": "e2d739fd1a46dc226d1cb8fc3986041f5eae4df2",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/a097ee32d8364045a950d6a36b19630fc34397f1/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/a097ee32d8364045a950d6a36b19630fc34397f1/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=a097ee32d8364045a950d6a36b19630fc34397f1",
            "patch": "@@ -678,7 +678,11 @@ def pk_is_not_editable(pk):\n             else:\n                 qs = self.model._default_manager.get_query_set()\n             qs = qs.using(form.instance._state.db)\n-            form.fields[self._pk_field.name] = ModelChoiceField(qs, initial=pk_value, required=False, widget=HiddenInput)\n+            if form._meta.widgets:\n+                widget = form._meta.widgets.get(self._pk_field.name, HiddenInput)\n+            else:\n+                widget = HiddenInput\n+            form.fields[self._pk_field.name] = ModelChoiceField(qs, initial=pk_value, required=False, widget=widget)\n         super(BaseModelFormSet, self).add_fields(form, index)\n \n def modelformset_factory(model, form=ModelForm, formfield_callback=None,"
        },
        {
            "sha": "fd35eda854f8c2cf8997b592e9fa573e9ca68b9e",
            "filename": "tests/regressiontests/model_formsets_regress/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/a097ee32d8364045a950d6a36b19630fc34397f1/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a097ee32d8364045a950d6a36b19630fc34397f1/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py?ref=a097ee32d8364045a950d6a36b19630fc34397f1",
            "patch": "@@ -261,14 +261,17 @@ def test_extraneous_query_is_not_run(self):\n             formset.save()\n \n \n-class CustomWidget(forms.CharField):\n+class CustomWidget(forms.widgets.TextInput):\n     pass\n \n \n class UserSiteForm(forms.ModelForm):\n     class Meta:\n         model = UserSite\n-        widgets = {'data': CustomWidget}\n+        widgets = {\n+            'id': CustomWidget,\n+            'data': CustomWidget,\n+        }\n \n \n class Callback(object):\n@@ -283,24 +286,27 @@ def __call__(self, db_field, **kwargs):\n \n class FormfieldCallbackTests(TestCase):\n     \"\"\"\n-    Regression for #13095: Using base forms with widgets\n-    defined in Meta should not raise errors.\n+    Regression for #13095 and #17683: Using base forms with widgets\n+    defined in Meta should not raise errors and BaseModelForm should respect\n+    the specified pk widget.\n     \"\"\"\n \n     def test_inlineformset_factory_default(self):\n         Formset = inlineformset_factory(User, UserSite, form=UserSiteForm)\n         form = Formset().forms[0]\n+        self.assertTrue(isinstance(form['id'].field.widget, CustomWidget))\n         self.assertTrue(isinstance(form['data'].field.widget, CustomWidget))\n \n     def test_modelformset_factory_default(self):\n         Formset = modelformset_factory(UserSite, form=UserSiteForm)\n         form = Formset().forms[0]\n+        self.assertTrue(isinstance(form['id'].field.widget, CustomWidget))\n         self.assertTrue(isinstance(form['data'].field.widget, CustomWidget))\n \n     def assertCallbackCalled(self, callback):\n         id_field, user_field, data_field = UserSite._meta.fields\n         expected_log = [\n-            (id_field, {}),\n+            (id_field, {'widget': CustomWidget}),\n             (user_field, {}),\n             (data_field, {'widget': CustomWidget}),\n         ]\n@@ -318,7 +324,6 @@ def test_modelformset_custom_callback(self):\n                              formfield_callback=callback)\n         self.assertCallbackCalled(callback)\n \n-\n class BaseCustomDeleteFormSet(BaseFormSet):\n     \"\"\"\n     A formset mix-in that lets a form decide if it's to be deleted."
        }
    ],
    "stats": {
        "total": 23,
        "additions": 16,
        "deletions": 7
    }
}