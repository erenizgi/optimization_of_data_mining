{
    "author": "jezdez",
    "message": "Fixed #16326 -- Fixed re-pickling of unpickled TemplateResponse instances. Thanks, natrius and lrekucki.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16568 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5fffe574bdd624f69eb246ed0833d7a2aba16edb",
    "files": [
        {
            "sha": "7741a3e3ad59f1b7ae5efcf114684e99fcd26d4c",
            "filename": "django/template/response.py",
            "status": "modified",
            "additions": 41,
            "deletions": 35,
            "changes": 76,
            "blob_url": "https://github.com/django/django/blob/5fffe574bdd624f69eb246ed0833d7a2aba16edb/django%2Ftemplate%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/5fffe574bdd624f69eb246ed0833d7a2aba16edb/django%2Ftemplate%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fresponse.py?ref=5fffe574bdd624f69eb246ed0833d7a2aba16edb",
            "patch": "@@ -1,22 +1,28 @@\n from django.http import HttpResponse\n from django.template import loader, Context, RequestContext\n \n+\n class ContentNotRenderedError(Exception):\n     pass\n \n+\n+class DiscardedAttributeError(AttributeError):\n+    pass\n+\n+\n class SimpleTemplateResponse(HttpResponse):\n+    rendering_attrs = ['template_name', 'context_data', '_post_render_callbacks']\n \n     def __init__(self, template, context=None, mimetype=None, status=None,\n             content_type=None):\n         # It would seem obvious to call these next two members 'template' and\n-        # 'context', but those names are reserved as part of the test Client API.\n-        # To avoid the name collision, we use\n-        # tricky-to-debug problems\n+        # 'context', but those names are reserved as part of the test Client\n+        # API. To avoid the name collision, we use tricky-to-debug problems\n         self.template_name = template\n         self.context_data = context\n \n-        # _is_rendered tracks whether the template and context has been baked into\n-        # a final response.\n+        # _is_rendered tracks whether the template and context has been\n+        # baked into a final response.\n         self._is_rendered = False\n \n         self._post_render_callbacks = []\n@@ -36,13 +42,21 @@ def __getstate__(self):\n         \"\"\"\n         obj_dict = self.__dict__.copy()\n         if not self._is_rendered:\n-            raise ContentNotRenderedError('The response content must be rendered before it can be pickled.')\n-        del obj_dict['template_name']\n-        del obj_dict['context_data']\n-        del obj_dict['_post_render_callbacks']\n+            raise ContentNotRenderedError('The response content must be '\n+                                          'rendered before it can be pickled.')\n+        for attr in self.rendering_attrs:\n+            if attr in obj_dict:\n+                del obj_dict[attr]\n \n         return obj_dict\n \n+    def __getattr__(self, name):\n+        if name in self.rendering_attrs:\n+            raise DiscardedAttributeError('The %s attribute was discarded '\n+                                          'when this %s class was pickled.' %\n+                                          (name, self.__class__.__name__))\n+        return super(SimpleTemplateResponse, self).__getattr__(name)\n+\n     def resolve_template(self, template):\n         \"Accepts a template object, path-to-template or list of paths\"\n         if isinstance(template, (list, tuple)):\n@@ -53,7 +67,7 @@ def resolve_template(self, template):\n             return template\n \n     def resolve_context(self, context):\n-        \"\"\"Convert context data into a full Context object\n+        \"\"\"Converts context data into a full Context object\n         (assuming it isn't already a Context object).\n         \"\"\"\n         if isinstance(context, Context):\n@@ -76,17 +90,18 @@ def rendered_content(self):\n         return content\n \n     def add_post_render_callback(self, callback):\n-        \"\"\"Add a new post-rendering callback.\n+        \"\"\"Adds a new post-rendering callback.\n \n-        If the response has already been rendered, invoke the callback immediately.\n+        If the response has already been rendered,\n+        invoke the callback immediately.\n         \"\"\"\n         if self._is_rendered:\n             callback(self)\n         else:\n             self._post_render_callbacks.append(callback)\n \n     def render(self):\n-        \"\"\"Render (thereby finalizing) the content of the response.\n+        \"\"\"Renders (thereby finalizing) the content of the response.\n \n         If the content has already been rendered, this is a no-op.\n \n@@ -101,27 +116,35 @@ def render(self):\n                     retval = newretval\n         return retval\n \n-    is_rendered = property(lambda self: self._is_rendered)\n+    @property\n+    def is_rendered(self):\n+        return self._is_rendered\n \n     def __iter__(self):\n         if not self._is_rendered:\n-            raise ContentNotRenderedError('The response content must be rendered before it can be iterated over.')\n+            raise ContentNotRenderedError('The response content must be '\n+                                          'rendered before it can be iterated over.')\n         return super(SimpleTemplateResponse, self).__iter__()\n \n     def _get_content(self):\n         if not self._is_rendered:\n-            raise ContentNotRenderedError('The response content must be rendered before it can be accessed.')\n+            raise ContentNotRenderedError('The response content must be '\n+                                          'rendered before it can be accessed.')\n         return super(SimpleTemplateResponse, self)._get_content()\n \n     def _set_content(self, value):\n-        \"Sets the content for the response\"\n+        \"\"\"Sets the content for the response\n+        \"\"\"\n         super(SimpleTemplateResponse, self)._set_content(value)\n         self._is_rendered = True\n \n     content = property(_get_content, _set_content)\n \n \n class TemplateResponse(SimpleTemplateResponse):\n+    rendering_attrs = SimpleTemplateResponse.rendering_attrs + \\\n+        ['_request', '_current_app']\n+\n     def __init__(self, request, template, context=None, mimetype=None,\n             status=None, content_type=None, current_app=None):\n         # self.request gets over-written by django.test.client.Client - and\n@@ -134,27 +157,10 @@ def __init__(self, request, template, context=None, mimetype=None,\n         super(TemplateResponse, self).__init__(\n             template, context, mimetype, status, content_type)\n \n-    def __getstate__(self):\n-        \"\"\"Pickling support function.\n-\n-        Ensures that the object can't be pickled before it has been\n-        rendered, and that the pickled state only includes rendered\n-        data, not the data used to construct the response.\n-        \"\"\"\n-        obj_dict = super(TemplateResponse, self).__getstate__()\n-\n-        del obj_dict['_request']\n-        del obj_dict['_current_app']\n-\n-        return obj_dict\n-\n     def resolve_context(self, context):\n         \"\"\"Convert context data into a full RequestContext object\n         (assuming it isn't already a Context object).\n         \"\"\"\n         if isinstance(context, Context):\n             return context\n-        else:\n-            return RequestContext(self._request, context, current_app=self._current_app)\n-\n-\n+        return RequestContext(self._request, context, current_app=self._current_app)"
        },
        {
            "sha": "0e067405ad8e54908578ef2c8bf0016a10186682",
            "filename": "tests/regressiontests/templates/response.py",
            "status": "modified",
            "additions": 46,
            "deletions": 8,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/5fffe574bdd624f69eb246ed0833d7a2aba16edb/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/5fffe574bdd624f69eb246ed0833d7a2aba16edb/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fresponse.py?ref=5fffe574bdd624f69eb246ed0833d7a2aba16edb",
            "patch": "@@ -1,3 +1,4 @@\n+from __future__ import with_statement\n from datetime import datetime\n import os\n import pickle\n@@ -8,7 +9,8 @@\n import django.template.context\n from django.template import Template, Context\n from django.template.response import (TemplateResponse, SimpleTemplateResponse,\n-                                      ContentNotRenderedError)\n+                                      ContentNotRenderedError,\n+                                      DiscardedAttributeError)\n \n def test_processor(request):\n     return {'processors': 'yes'}\n@@ -190,9 +192,27 @@ def test_pickling(self):\n \n         # ...and the unpickled reponse doesn't have the\n         # template-related attributes, so it can't be re-rendered\n-        self.assertFalse(hasattr(unpickled_response, 'template_name'))\n-        self.assertFalse(hasattr(unpickled_response, 'context_data'))\n-        self.assertFalse(hasattr(unpickled_response, '_post_render_callbacks'))\n+        template_attrs = ('template_name', 'context_data', '_post_render_callbacks')\n+        for attr in template_attrs:\n+            self.assertFalse(hasattr(unpickled_response, attr))\n+\n+        # ...and requesting any of those attributes raises an exception\n+        for attr in template_attrs:\n+            with self.assertRaises(DiscardedAttributeError) as cm:\n+                getattr(unpickled_response, attr)\n+\n+    def test_repickling(self):\n+        response = SimpleTemplateResponse('first/test.html', {\n+                'value': 123,\n+                'fn': datetime.now,\n+            })\n+        self.assertRaises(ContentNotRenderedError,\n+                          pickle.dumps, response)\n+\n+        response.render()\n+        pickled_response = pickle.dumps(response)\n+        unpickled_response = pickle.loads(pickled_response)\n+        repickled_response = pickle.dumps(unpickled_response)\n \n class TemplateResponseTest(BaseTemplateResponseTest):\n \n@@ -255,10 +275,28 @@ def test_pickling(self):\n \n         # ...and the unpickled reponse doesn't have the\n         # template-related attributes, so it can't be re-rendered\n-        self.assertFalse(hasattr(unpickled_response, '_request'))\n-        self.assertFalse(hasattr(unpickled_response, 'template_name'))\n-        self.assertFalse(hasattr(unpickled_response, 'context_data'))\n-        self.assertFalse(hasattr(unpickled_response, '_post_render_callbacks'))\n+        template_attrs = ('template_name', 'context_data',\n+            '_post_render_callbacks', '_request', '_current_app')\n+        for attr in template_attrs:\n+            self.assertFalse(hasattr(unpickled_response, attr))\n+\n+        # ...and requesting any of those attributes raises an exception\n+        for attr in template_attrs:\n+            with self.assertRaises(DiscardedAttributeError) as cm:\n+                getattr(unpickled_response, attr)\n+\n+    def test_repickling(self):\n+        response = SimpleTemplateResponse('first/test.html', {\n+                'value': 123,\n+                'fn': datetime.now,\n+            })\n+        self.assertRaises(ContentNotRenderedError,\n+                          pickle.dumps, response)\n+\n+        response.render()\n+        pickled_response = pickle.dumps(response)\n+        unpickled_response = pickle.loads(pickled_response)\n+        repickled_response = pickle.dumps(unpickled_response)\n \n \n class CustomURLConfTest(TestCase):"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 87,
        "deletions": 43
    }
}