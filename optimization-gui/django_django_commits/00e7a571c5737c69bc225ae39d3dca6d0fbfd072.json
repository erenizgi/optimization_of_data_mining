{
    "author": "carljm",
    "message": "Fixed #6456 - Excised FileField file deletion to avoid data loss. Thanks to durdinator for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15321 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "00e7a571c5737c69bc225ae39d3dca6d0fbfd072",
    "files": [
        {
            "sha": "aaf1fbb0ecc6389fd5926c6f0701f566b62bb466",
            "filename": "django/db/models/fields/files.py",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/00e7a571c5737c69bc225ae39d3dca6d0fbfd072/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py",
            "raw_url": "https://github.com/django/django/raw/00e7a571c5737c69bc225ae39d3dca6d0fbfd072/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py?ref=00e7a571c5737c69bc225ae39d3dca6d0fbfd072",
            "patch": "@@ -258,19 +258,6 @@ def pre_save(self, model_instance, add):\n     def contribute_to_class(self, cls, name):\n         super(FileField, self).contribute_to_class(cls, name)\n         setattr(cls, self.name, self.descriptor_class(self))\n-        signals.post_delete.connect(self.delete_file, sender=cls)\n-\n-    def delete_file(self, instance, sender, **kwargs):\n-        file = getattr(instance, self.attname)\n-        # If no other object of this type references the file,\n-        # and it's not the default value for future objects,\n-        # delete it from the backend.\n-        if file and file.name != self.default and \\\n-            not sender._default_manager.filter(**{self.name: file.name}):\n-                file.delete(save=False)\n-        elif file:\n-            # Otherwise, just close the file, so it doesn't tie up resources.\n-            file.close()\n \n     def get_directory_name(self):\n         return os.path.normpath(force_unicode(datetime.datetime.now().strftime(smart_str(self.upload_to))))"
        },
        {
            "sha": "1ca89380f766be7d2ff6aefaed8d000c90410a4f",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/00e7a571c5737c69bc225ae39d3dca6d0fbfd072/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/00e7a571c5737c69bc225ae39d3dca6d0fbfd072/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=00e7a571c5737c69bc225ae39d3dca6d0fbfd072",
            "patch": "@@ -261,6 +261,20 @@ requests. These include:\n Backwards-incompatible changes in 1.3\n =====================================\n \n+FileField no longer deletes files\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+In earlier Django versions, when a model instance containing a\n+:class:`~django.db.models.FileField` was deleted,\n+:class:`~django.db.models.FileField` took it upon itself to also delete the\n+file from the backend storage. This opened the door to several data-loss\n+scenarios, including rolled-back transactions and fields on different models\n+referencing the same file. In Django 1.3, :class:`~django.db.models.FileField`\n+will never delete files from the backend storage. If you need cleanup of\n+orphaned files, you'll need to handle it yourself (for instance, with a custom\n+management command that can be run manually or scheduled to run periodically\n+via e.g. cron).\n+\n PasswordInput default rendering behavior\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "ad5c3a7cc3c0b22316284f727ea5cf70d29d318b",
            "filename": "tests/modeltests/files/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/00e7a571c5737c69bc225ae39d3dca6d0fbfd072/tests%2Fmodeltests%2Ffiles%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/00e7a571c5737c69bc225ae39d3dca6d0fbfd072/tests%2Fmodeltests%2Ffiles%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ffiles%2Ftests.py?ref=00e7a571c5737c69bc225ae39d3dca6d0fbfd072",
            "patch": "@@ -61,11 +61,10 @@ def test_files(self):\n         cache.set(\"obj2\", obj2)\n         self.assertEqual(cache.get(\"obj2\").normal.name, \"tests/django_test_1.txt\")\n \n-        # Deleting an object deletes the file it uses, if there are no other\n-        # objects still using that file.\n+        # Deleting an object does not delete the file it uses.\n         obj2.delete()\n         obj2.normal.save(\"django_test.txt\", ContentFile(\"more content\"))\n-        self.assertEqual(obj2.normal.name, \"tests/django_test_1.txt\")\n+        self.assertEqual(obj2.normal.name, \"tests/django_test_2.txt\")\n \n         # Multiple files with the same name get _N appended to them.\n         objs = [Storage() for i in range(3)]"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 16,
        "deletions": 16
    }
}