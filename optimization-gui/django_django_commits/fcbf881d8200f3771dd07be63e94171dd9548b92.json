{
    "author": "alex",
    "message": "Refactor all uses of thread locals to be more consistant and sane.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15232 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "fcbf881d8200f3771dd07be63e94171dd9548b92",
    "files": [
        {
            "sha": "a35287e158b82fc88e6114f80742d951f8fbc357",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 10,
            "deletions": 14,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=fcbf881d8200f3771dd07be63e94171dd9548b92",
            "patch": "@@ -8,6 +8,7 @@\n \"\"\"\n \n import re\n+from threading import local\n \n from django.http import Http404\n from django.conf import settings\n@@ -17,18 +18,18 @@\n from django.utils.functional import memoize\n from django.utils.importlib import import_module\n from django.utils.regex_helper import normalize\n-from django.utils.thread_support import currentThread\n \n _resolver_cache = {} # Maps URLconf modules to RegexURLResolver instances.\n _callable_cache = {} # Maps view and url pattern names to their view functions.\n \n # SCRIPT_NAME prefixes for each thread are stored here. If there's no entry for\n # the current thread (which is the only one we ever access), it is assumed to\n # be empty.\n-_prefixes = {}\n+_prefixes = local()\n \n # Overridden URLconfs for each thread are stored here.\n-_urlconfs = {}\n+_urlconfs = local()\n+\n \n class ResolverMatch(object):\n     def __init__(self, func, args, kwargs, url_name=None, app_name=None, namespaces=None):\n@@ -401,35 +402,30 @@ def set_script_prefix(prefix):\n     \"\"\"\n     if not prefix.endswith('/'):\n         prefix += '/'\n-    _prefixes[currentThread()] = prefix\n+    _prefixes.value = prefix\n \n def get_script_prefix():\n     \"\"\"\n     Returns the currently active script prefix. Useful for client code that\n     wishes to construct their own URLs manually (although accessing the request\n     instance is normally going to be a lot cleaner).\n     \"\"\"\n-    return _prefixes.get(currentThread(), u'/')\n+    return getattr(_prefixes, \"value\", u'/')\n \n def set_urlconf(urlconf_name):\n     \"\"\"\n     Sets the URLconf for the current thread (overriding the default one in\n     settings). Set to None to revert back to the default.\n     \"\"\"\n-    thread = currentThread()\n     if urlconf_name:\n-        _urlconfs[thread] = urlconf_name\n+        _urlconfs.value = urlconf_name\n     else:\n-        # faster than wrapping in a try/except\n-        if thread in _urlconfs:\n-            del _urlconfs[thread]\n+        if hasattr(_urlconfs, \"value\"):\n+            del _urlconfs.value\n \n def get_urlconf(default=None):\n     \"\"\"\n     Returns the root URLconf to use for the current thread if it has been\n     changed from the default one.\n     \"\"\"\n-    thread = currentThread()\n-    if thread in _urlconfs:\n-        return _urlconfs[thread]\n-    return default\n+    return getattr(_urlconfs, \"value\", default)"
        },
        {
            "sha": "3979c9ac8aca1246c6e51de57e0668692625cb08",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=fcbf881d8200f3771dd07be63e94171dd9548b92",
            "patch": "@@ -25,6 +25,11 @@ def __init__(self, settings_dict, alias=DEFAULT_DB_ALIAS):\n         self.alias = alias\n         self.use_debug_cursor = None\n \n+        # Transaction related attributes\n+        self.transaction_state = []\n+        self.savepoint_state = 0\n+        self.dirty = None\n+\n     def __eq__(self, other):\n         return self.alias == other.alias\n "
        },
        {
            "sha": "a565da2466a93cf3a3631546e1615c4358be8154",
            "filename": "django/db/transaction.py",
            "status": "modified",
            "additions": 47,
            "deletions": 56,
            "changes": 103,
            "blob_url": "https://github.com/django/django/blob/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Fdb%2Ftransaction.py",
            "raw_url": "https://github.com/django/django/raw/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Fdb%2Ftransaction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Ftransaction.py?ref=fcbf881d8200f3771dd07be63e94171dd9548b92",
            "patch": "@@ -25,26 +25,14 @@\n from django.conf import settings\n from django.db import connections, DEFAULT_DB_ALIAS\n \n+\n class TransactionManagementError(Exception):\n     \"\"\"\n     This exception is thrown when something bad happens with transaction\n     management.\n     \"\"\"\n     pass\n \n-# The states are dictionaries of dictionaries of lists. The key to the outer\n-# dict is the current thread, and the key to the inner dictionary is the\n-# connection alias and the list is handled as a stack of values.\n-state = {}\n-savepoint_state = {}\n-\n-# The dirty flag is set by *_unless_managed functions to denote that the\n-# code under transaction management has changed things to require a\n-# database commit.\n-# This is a dictionary mapping thread to a dictionary mapping connection\n-# alias to a boolean.\n-dirty = {}\n-\n def enter_transaction_management(managed=True, using=None):\n     \"\"\"\n     Enters transaction management for a running thread. It must be balanced with\n@@ -58,15 +46,14 @@ def enter_transaction_management(managed=True, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    thread_ident = thread.get_ident()\n-    if thread_ident in state and state[thread_ident].get(using):\n-        state[thread_ident][using].append(state[thread_ident][using][-1])\n+\n+    if connection.transaction_state:\n+        connection.transaction_state.append(connection.transaction_state[-1])\n     else:\n-        state.setdefault(thread_ident, {})\n-        state[thread_ident][using] = [settings.TRANSACTIONS_MANAGED]\n-    if thread_ident not in dirty or using not in dirty[thread_ident]:\n-        dirty.setdefault(thread_ident, {})\n-        dirty[thread_ident][using] = False\n+        connection.transaction_state.append(settings.TRANSACTIONS_MANAGED)\n+\n+    if connection.dirty is None:\n+        connection.dirty = False\n     connection._enter_transaction_management(managed)\n \n def leave_transaction_management(using=None):\n@@ -78,16 +65,18 @@ def leave_transaction_management(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n+\n     connection._leave_transaction_management(is_managed(using=using))\n-    thread_ident = thread.get_ident()\n-    if thread_ident in state and state[thread_ident].get(using):\n-        del state[thread_ident][using][-1]\n+    if connection.transaction_state:\n+        del connection.transaction_state[-1]\n     else:\n-        raise TransactionManagementError(\"This code isn't under transaction management\")\n-    if dirty.get(thread_ident, {}).get(using, False):\n+        raise TransactionManagementError(\"This code isn't under transaction \"\n+            \"management\")\n+    if connection.dirty:\n         rollback(using=using)\n-        raise TransactionManagementError(\"Transaction managed block ended with pending COMMIT/ROLLBACK\")\n-    dirty[thread_ident][using] = False\n+        raise TransactionManagementError(\"Transaction managed block ended with \"\n+            \"pending COMMIT/ROLLBACK\")\n+    connection.dirty = False\n \n def is_dirty(using=None):\n     \"\"\"\n@@ -96,7 +85,9 @@ def is_dirty(using=None):\n     \"\"\"\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n-    return dirty.get(thread.get_ident(), {}).get(using, False)\n+    connection = connections[using]\n+\n+    return connection.dirty\n \n def set_dirty(using=None):\n     \"\"\"\n@@ -106,11 +97,13 @@ def set_dirty(using=None):\n     \"\"\"\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n-    thread_ident = thread.get_ident()\n-    if thread_ident in dirty and using in dirty[thread_ident]:\n-        dirty[thread_ident][using] = True\n+    connection = connections[using]\n+\n+    if connection.dirty is not None:\n+        connection.dirty = True\n     else:\n-        raise TransactionManagementError(\"This code isn't under transaction management\")\n+        raise TransactionManagementError(\"This code isn't under transaction \"\n+            \"management\")\n \n def set_clean(using=None):\n     \"\"\"\n@@ -120,30 +113,29 @@ def set_clean(using=None):\n     \"\"\"\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n-    thread_ident = thread.get_ident()\n-    if thread_ident in dirty and using in dirty[thread_ident]:\n-        dirty[thread_ident][using] = False\n+    connection = connections[using]\n+\n+    if connection.dirty is not None:\n+        connection.dirty = False\n     else:\n         raise TransactionManagementError(\"This code isn't under transaction management\")\n     clean_savepoints(using=using)\n \n def clean_savepoints(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n-    thread_ident = thread.get_ident()\n-    if thread_ident in savepoint_state and using in savepoint_state[thread_ident]:\n-        del savepoint_state[thread_ident][using]\n+    connection = connections[using]\n+    connection.savepoint_state = 0\n \n def is_managed(using=None):\n     \"\"\"\n     Checks whether the transaction manager is in manual or in auto state.\n     \"\"\"\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n-    thread_ident = thread.get_ident()\n-    if thread_ident in state and using in state[thread_ident]:\n-        if state[thread_ident][using]:\n-            return state[thread_ident][using][-1]\n+    connection = connections[using]\n+    if connection.transaction_state:\n+        return connection.transaction_state[-1]\n     return settings.TRANSACTIONS_MANAGED\n \n def managed(flag=True, using=None):\n@@ -156,15 +148,16 @@ def managed(flag=True, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    thread_ident = thread.get_ident()\n-    top = state.get(thread_ident, {}).get(using, None)\n+\n+    top = connection.transaction_state\n     if top:\n         top[-1] = flag\n         if not flag and is_dirty(using=using):\n             connection._commit()\n             set_clean(using=using)\n     else:\n-        raise TransactionManagementError(\"This code isn't under transaction management\")\n+        raise TransactionManagementError(\"This code isn't under transaction \"\n+            \"management\")\n \n def commit_unless_managed(using=None):\n     \"\"\"\n@@ -221,13 +214,11 @@ def savepoint(using=None):\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n     thread_ident = thread.get_ident()\n-    if thread_ident in savepoint_state and using in savepoint_state[thread_ident]:\n-        savepoint_state[thread_ident][using].append(None)\n-    else:\n-        savepoint_state.setdefault(thread_ident, {})\n-        savepoint_state[thread_ident][using] = [None]\n+\n+    connection.savepoint_state += 1\n+\n     tid = str(thread_ident).replace('-', '')\n-    sid = \"s%s_x%d\" % (tid, len(savepoint_state[thread_ident][using]))\n+    sid = \"s%s_x%d\" % (tid, connection.savepoint_state)\n     connection._savepoint(sid)\n     return sid\n \n@@ -239,8 +230,8 @@ def savepoint_rollback(sid, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    thread_ident = thread.get_ident()\n-    if thread_ident in savepoint_state and using in savepoint_state[thread_ident]:\n+\n+    if connection.savepoint_state:\n         connection._savepoint_rollback(sid)\n \n def savepoint_commit(sid, using=None):\n@@ -251,8 +242,8 @@ def savepoint_commit(sid, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    thread_ident = thread.get_ident()\n-    if thread_ident in savepoint_state and using in savepoint_state[thread_ident]:\n+\n+    if connection.savepoint_state:\n         connection._savepoint_commit(sid)\n \n ##############"
        },
        {
            "sha": "2b97d165cae8180cf1dc012f3f308667423b59b8",
            "filename": "django/utils/thread_support.py",
            "status": "removed",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/964cf1be866e7db410d8a5b08d4d83c620a697cd/django%2Futils%2Fthread_support.py",
            "raw_url": "https://github.com/django/django/raw/964cf1be866e7db410d8a5b08d4d83c620a697cd/django%2Futils%2Fthread_support.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fthread_support.py?ref=964cf1be866e7db410d8a5b08d4d83c620a697cd",
            "patch": "@@ -1,12 +0,0 @@\n-\"\"\"\n-Code used in a couple of places to work with the current thread's environment.\n-Current users include i18n and request prefix handling.\n-\"\"\"\n-\n-try:\n-    import threading\n-    currentThread = threading.currentThread\n-except ImportError:\n-    def currentThread():\n-        return \"no threading\"\n-"
        },
        {
            "sha": "9327ebde0dcb414bd57cdb50664882c542be20ea",
            "filename": "django/utils/translation/trans_real.py",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "raw_url": "https://github.com/django/django/raw/fcbf881d8200f3771dd07be63e94171dd9548b92/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_real.py?ref=fcbf881d8200f3771dd07be63e94171dd9548b92",
            "patch": "@@ -7,15 +7,16 @@\n import warnings\n import gettext as gettext_module\n from cStringIO import StringIO\n+from threading import local\n \n from django.utils.importlib import import_module\n from django.utils.safestring import mark_safe, SafeData\n-from django.utils.thread_support import currentThread\n+\n \n # Translations are cached in a dictionary for every language+app tuple.\n # The active translations are stored by threadid to make them thread local.\n _translations = {}\n-_active = {}\n+_active = local()\n \n # The default translation is based on the settings file.\n _default = None\n@@ -197,28 +198,27 @@ def activate(language):\n             \"Please use the 'nb' translation instead.\",\n             DeprecationWarning\n         )\n-    _active[currentThread()] = translation(language)\n+    _active.value = translation(language)\n \n def deactivate():\n     \"\"\"\n     Deinstalls the currently active translation object so that further _ calls\n     will resolve against the default translation object, again.\n     \"\"\"\n-    global _active\n-    if currentThread() in _active:\n-        del _active[currentThread()]\n+    if hasattr(_active, \"value\"):\n+        del _active.value\n \n def deactivate_all():\n     \"\"\"\n     Makes the active translation object a NullTranslations() instance. This is\n     useful when we want delayed translations to appear as the original string\n     for some reason.\n     \"\"\"\n-    _active[currentThread()] = gettext_module.NullTranslations()\n+    _active.value = gettext_module.NullTranslations()\n \n def get_language():\n     \"\"\"Returns the currently selected language.\"\"\"\n-    t = _active.get(currentThread(), None)\n+    t = getattr(_active, \"value\", None)\n     if t is not None:\n         try:\n             return t.to_language()\n@@ -246,8 +246,9 @@ def catalog():\n     This can be used if you need to modify the catalog or want to access the\n     whole message catalog instead of just translating one string.\n     \"\"\"\n-    global _default, _active\n-    t = _active.get(currentThread(), None)\n+    global _default\n+\n+    t = getattr(_active, \"value\", None)\n     if t is not None:\n         return t\n     if _default is None:\n@@ -262,9 +263,10 @@ def do_translate(message, translation_function):\n     translation object to use. If no current translation is activated, the\n     message will be run through the default translation object.\n     \"\"\"\n+    global _default\n+\n     eol_message = message.replace('\\r\\n', '\\n').replace('\\r', '\\n')\n-    global _default, _active\n-    t = _active.get(currentThread(), None)\n+    t = getattr(_active, \"value\", None)\n     if t is not None:\n         result = getattr(t, translation_function)(eol_message)\n     else:\n@@ -300,9 +302,9 @@ def gettext_noop(message):\n     return message\n \n def do_ntranslate(singular, plural, number, translation_function):\n-    global _default, _active\n+    global _default\n \n-    t = _active.get(currentThread(), None)\n+    t = getattr(_active, \"value\", None)\n     if t is not None:\n         return getattr(t, translation_function)(singular, plural, number)\n     if _default is None:\n@@ -587,4 +589,3 @@ def get_partial_date_formats():\n     if month_day_format == 'MONTH_DAY_FORMAT':\n         month_day_format = settings.MONTH_DAY_FORMAT\n     return year_month_format, month_day_format\n-"
        },
        {
            "sha": "deba5d1d0323233b5bcbdb3a84f8ed4407b2a451",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/fcbf881d8200f3771dd07be63e94171dd9548b92/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fcbf881d8200f3771dd07be63e94171dd9548b92/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=fcbf881d8200f3771dd07be63e94171dd9548b92",
            "patch": "@@ -4,10 +4,12 @@\n import os\n import sys\n import pickle\n+from threading import local\n \n from django.conf import settings\n from django.template import Template, Context\n-from django.utils.formats import get_format, date_format, time_format, localize, localize_input, iter_format_modules\n+from django.utils.formats import (get_format, date_format, time_format,\n+    localize, localize_input, iter_format_modules)\n from django.utils.importlib import import_module\n from django.utils.numberformat import format as nformat\n from django.utils.safestring import mark_safe, SafeString, SafeUnicode\n@@ -61,7 +63,7 @@ def test_pgettext(self):\n         self.old_locale_paths = settings.LOCALE_PATHS\n         settings.LOCALE_PATHS += (os.path.join(os.path.dirname(os.path.abspath(__file__)), 'other', 'locale'),)\n         from django.utils.translation import trans_real\n-        trans_real._active = {}\n+        trans_real._active = local()\n         trans_real._translations = {}\n         activate('de')\n \n@@ -649,7 +651,7 @@ def setUp(self):\n         from django.utils.translation import trans_real\n         # Okay, this is brutal, but we have no other choice to fully reset\n         # the translation framework\n-        trans_real._active = {}\n+        trans_real._active = local()\n         trans_real._translations = {}\n         activate('de')\n "
        }
    ],
    "stats": {
        "total": 183,
        "additions": 83,
        "deletions": 100
    }
}