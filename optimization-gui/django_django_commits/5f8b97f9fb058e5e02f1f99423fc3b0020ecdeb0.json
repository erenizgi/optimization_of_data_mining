{
    "author": "ptone",
    "message": "Fixed #19057 -- support custom user models in mod_wsgi auth handler\n\nthanks @freakboy3742 for the catch and review",
    "sha": "5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0",
    "files": [
        {
            "sha": "3229c6714b6176547689747cc12c0a8f6ccee15d",
            "filename": "django/contrib/auth/handlers/modwsgi.py",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "raw_url": "https://github.com/django/django/raw/5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py?ref=5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0",
            "patch": "@@ -1,4 +1,4 @@\n-from django.contrib.auth.models import User\n+from django.contrib import auth\n from django import db\n from django.utils.encoding import force_bytes\n \n@@ -11,14 +11,21 @@ def check_password(environ, username, password):\n     on whether the user exists and authenticates.\n     \"\"\"\n \n+    UserModel = auth.get_user_model()\n     # db connection state is managed similarly to the wsgi handler\n     # as mod_wsgi may call these functions outside of a request/response cycle\n     db.reset_queries()\n \n     try:\n         try:\n-            user = User.objects.get(username=username, is_active=True)\n-        except User.DoesNotExist:\n+            user = UserModel.objects.get_by_natural_key(username)\n+        except UserModel.DoesNotExist:\n+            return None\n+        try:\n+            if not user.is_active:\n+                return None\n+        except AttributeError as e:\n+            # a custom user may not support is_active\n             return None\n         return user.check_password(password)\n     finally:\n@@ -30,14 +37,20 @@ def groups_for_user(environ, username):\n     Authorizes a user based on groups\n     \"\"\"\n \n+    UserModel = auth.get_user_model()\n     db.reset_queries()\n \n     try:\n         try:\n-            user = User.objects.get(username=username, is_active=True)\n-        except User.DoesNotExist:\n+            user = UserModel.objects.get_by_natural_key(username)\n+        except UserModel.DoesNotExist:\n+            return []\n+        try:\n+            if not user.is_active:\n+                return []\n+        except AttributeError as e:\n+            # a custom user may not support is_active\n             return []\n-\n         return [force_bytes(group.name) for group in user.groups.all()]\n     finally:\n         db.close_connection()"
        },
        {
            "sha": "a867aae47adf1895ed49dfff324d5697fe62eeea",
            "filename": "django/contrib/auth/tests/handlers.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py",
            "raw_url": "https://github.com/django/django/raw/5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py?ref=5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0",
            "patch": "@@ -2,6 +2,7 @@\n \n from django.contrib.auth.handlers.modwsgi import check_password, groups_for_user\n from django.contrib.auth.models import User, Group\n+from django.contrib.auth.tests.utils import skipIfCustomUser\n from django.test import TransactionTestCase\n \n \n@@ -13,14 +14,17 @@ class ModWsgiHandlerTestCase(TransactionTestCase):\n     def setUp(self):\n         user1 = User.objects.create_user('test', 'test@example.com', 'test')\n         User.objects.create_user('test1', 'test1@example.com', 'test1')\n-\n         group = Group.objects.create(name='test_group')\n         user1.groups.add(group)\n \n     def test_check_password(self):\n         \"\"\"\n         Verify that check_password returns the correct values as per\n         http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms#Apache_Authentication_Provider\n+\n+        because the custom user available in the test framework does not\n+        support the is_active attribute, we can't test this with a custom\n+        user.\n         \"\"\"\n \n         # User not in database\n@@ -32,6 +36,7 @@ def test_check_password(self):\n         # Valid user with incorrect password\n         self.assertFalse(check_password({}, 'test', 'incorrect'))\n \n+    @skipIfCustomUser\n     def test_groups_for_user(self):\n         \"\"\"\n         Check that groups_for_user returns correct values as per"
        },
        {
            "sha": "5f700f1cb34bbdaefabe0fb2a2eb81d191a675aa",
            "filename": "docs/howto/deployment/wsgi/apache-auth.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fapache-auth.txt",
            "raw_url": "https://github.com/django/django/raw/5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fapache-auth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fapache-auth.txt?ref=5f8b97f9fb058e5e02f1f99423fc3b0020ecdeb0",
            "patch": "@@ -14,6 +14,14 @@ version >= 2.2 and mod_wsgi >= 2.0. For example, you could:\n \n * Allow certain users to connect to a WebDAV share created with mod_dav_.\n \n+.. note::\n+    If you have installed a :ref:`custom User model <auth-custom-user>` and\n+    want to use this default auth handler, it must support an `is_active`\n+    attribute. If you want to use group based authorization, your custom user\n+    must have a relation named 'groups', referring to a related object that has\n+    a 'name' field. You can also specify your own custom mod_wsgi\n+    auth handler if your custom cannot conform to these requirements.\n+\n .. _Subversion: http://subversion.tigris.org/\n .. _mod_dav: http://httpd.apache.org/docs/2.2/mod/mod_dav.html\n "
        }
    ],
    "stats": {
        "total": 40,
        "additions": 33,
        "deletions": 7
    }
}