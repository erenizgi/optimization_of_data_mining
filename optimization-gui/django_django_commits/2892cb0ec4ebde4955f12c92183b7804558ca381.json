{
    "author": "aaugustin",
    "message": "[py3] Fixed regression introduced in 536b030363.\n\nRefs #18764.\n\nReverted 536b030363 and switched to a more explicit way of avoiding\ncalling bytes(<int>).\n\nThis definitely deserves a refactoring. Specifically, _get_content\nshould just return b''.join(self). Unfortunately that's impossible\nwith the current tests.",
    "sha": "2892cb0ec4ebde4955f12c92183b7804558ca381",
    "files": [
        {
            "sha": "6ca088996d04932d2c8fafa6843d0219c76384d1",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/2892cb0ec4ebde4955f12c92183b7804558ca381/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/2892cb0ec4ebde4955f12c92183b7804558ca381/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=2892cb0ec4ebde4955f12c92183b7804558ca381",
            "patch": "@@ -85,7 +85,7 @@ def _BaseCookie__set(self, key, real_value, coded_value):\n from django.http.multipartparser import MultiPartParser\n from django.http.utils import *\n from django.utils.datastructures import MultiValueDict, ImmutableList\n-from django.utils.encoding import force_bytes, force_text, iri_to_uri, smart_bytes, smart_str\n+from django.utils.encoding import smart_bytes, smart_str, iri_to_uri, force_text\n from django.utils.http import cookie_date\n from django.utils import six\n from django.utils import timezone\n@@ -670,12 +670,16 @@ def delete_cookie(self, key, path='/', domain=None):\n                         expires='Thu, 01-Jan-1970 00:00:00 GMT')\n \n     def _get_content(self):\n-        # The logic below obeys the following constraints:\n-        # - do not perform any encoding if a Content-Encoding is set (#4969)\n-        # - force string conversion of non-string types (#16494)\n-        # - avoid simply calling bytes() with Python 3 (#18764)\n-        encoding = 'ascii' if self.has_header('Content-Encoding') else self._charset\n-        return b''.join(force_bytes(e, encoding) for e in self._container)\n+        if self.has_header('Content-Encoding'):\n+            def make_bytes(value):\n+                if isinstance(value, int):\n+                    return six.text_type(value).encode()\n+                elif isinstance(value, six.text_type):\n+                    return value.encode('ascii')\n+                else:\n+                    return bytes(value)\n+            return b''.join(make_bytes(e) for e in self._container)\n+        return b''.join(smart_bytes(e, self._charset) for e in self._container)\n \n     def _set_content(self, value):\n         if hasattr(value, '__iter__') and not isinstance(value, (bytes, six.string_types)):\n@@ -692,9 +696,12 @@ def __iter__(self):\n         return self\n \n     def __next__(self):\n-        # Use the same logic as _get_content.\n-        encoding = 'ascii' if self.has_header('Content-Encoding') else self._charset\n-        return force_bytes(next(self._iterator), encoding)\n+        chunk = next(self._iterator)\n+        if isinstance(chunk, int):\n+            return six.text_type(chunk).encode()\n+        if isinstance(chunk, six.text_type):\n+            return chunk.encode(self._charset)\n+        return bytes(chunk)\n \n     next = __next__             # Python 2 compatibility\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 17,
        "deletions": 10
    }
}