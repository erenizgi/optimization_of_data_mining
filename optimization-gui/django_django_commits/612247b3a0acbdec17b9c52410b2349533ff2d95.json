{
    "author": "akaariai",
    "message": "Fixed #16961 -- Skipped resetting AUTO_INCREMENT fields for MySQL if the server version is greater than 5.0.12. This allows for much faster testing.\n\nThanks to aigarius for the report and claudep and ramiro for review.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17932 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "612247b3a0acbdec17b9c52410b2349533ff2d95",
    "files": [
        {
            "sha": "bacd998fa5d3bfe92af3bde02cec299d7fbb51f8",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/612247b3a0acbdec17b9c52410b2349533ff2d95/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/612247b3a0acbdec17b9c52410b2349533ff2d95/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=612247b3a0acbdec17b9c52410b2349533ff2d95",
            "patch": "@@ -261,15 +261,17 @@ def sql_flush(self, style, tables, sequences):\n                 sql.append('%s %s;' % (style.SQL_KEYWORD('TRUNCATE'), style.SQL_FIELD(self.quote_name(table))))\n             sql.append('SET FOREIGN_KEY_CHECKS = 1;')\n \n-            # 'ALTER TABLE table AUTO_INCREMENT = 1;'... style SQL statements\n-            # to reset sequence indices\n-            sql.extend([\"%s %s %s %s %s;\" % \\\n-                (style.SQL_KEYWORD('ALTER'),\n-                 style.SQL_KEYWORD('TABLE'),\n-                 style.SQL_TABLE(self.quote_name(sequence['table'])),\n-                 style.SQL_KEYWORD('AUTO_INCREMENT'),\n-                 style.SQL_FIELD('= 1'),\n-                ) for sequence in sequences])\n+            # Truncate already resets the AUTO_INCREMENT field from\n+            # MySQL version 5.0.13 onwards. Refs #16961.\n+            if self.connection.mysql_version < (5,0,13):\n+                sql.extend(\n+                    [\"%s %s %s %s %s;\" % \\\n+                     (style.SQL_KEYWORD('ALTER'),\n+                      style.SQL_KEYWORD('TABLE'),\n+                      style.SQL_TABLE(self.quote_name(sequence['table'])),\n+                      style.SQL_KEYWORD('AUTO_INCREMENT'),\n+                      style.SQL_FIELD('= 1'),\n+                     ) for sequence in sequences])\n             return sql\n         else:\n             return []"
        },
        {
            "sha": "9b28787c15fd1aa1513be31a6c045e25b40b809f",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/612247b3a0acbdec17b9c52410b2349533ff2d95/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/612247b3a0acbdec17b9c52410b2349533ff2d95/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=612247b3a0acbdec17b9c52410b2349533ff2d95",
            "patch": "@@ -61,10 +61,34 @@ def test_long_string(self):\n     def test_client_encoding(self):\n         # If the backend is Oracle, test that the client encoding is set\n         # correctly.  This was broken under Cygwin prior to r14781.\n-        c = connection.cursor()  # Ensure the connection is initialized.\n+        connection.cursor()  # Ensure the connection is initialized.\n         self.assertEqual(connection.connection.encoding, \"UTF-8\")\n         self.assertEqual(connection.connection.nencoding, \"UTF-8\")\n \n+class MySQLTests(TestCase):\n+    @unittest.skipUnless(connection.vendor == 'mysql',\n+                        \"Test valid only for MySQL\")\n+    def test_autoincrement(self):\n+        \"\"\"\n+        Check that auto_increment fields are reset correctly by sql_flush().\n+        Before MySQL version 5.0.13 TRUNCATE did not do auto_increment reset.\n+        Refs #16961.\n+        \"\"\"\n+        statements = connection.ops.sql_flush(no_style(),\n+                                              tables=['test'],\n+                                              sequences=[{\n+                                                  'table': 'test',\n+                                                  'col': 'somecol',\n+                                              }])\n+        found_reset = False\n+        for sql in statements:\n+            found_reset = found_reset or 'ALTER TABLE' in sql\n+        if connection.mysql_version < (5,0,13):\n+            self.assertTrue(found_reset)\n+        else:\n+            self.assertFalse(found_reset)\n+\n+\n class DateQuotingTest(TestCase):\n \n     def test_django_date_trunc(self):"
        },
        {
            "sha": "9a072e627c36e4d5c62132e1f708b5b6f9bbb4de",
            "filename": "tests/regressiontests/test_runner/models.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/612247b3a0acbdec17b9c52410b2349533ff2d95/tests%2Fregressiontests%2Ftest_runner%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/612247b3a0acbdec17b9c52410b2349533ff2d95/tests%2Fregressiontests%2Ftest_runner%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fmodels.py?ref=612247b3a0acbdec17b9c52410b2349533ff2d95",
            "patch": "@@ -0,0 +1,5 @@\n+from django.db import models\n+\n+class Person(models.Model):\n+    first_name = models.CharField(max_length=20)\n+    last_name = models.CharField(max_length=20)"
        },
        {
            "sha": "9f8085b5b6243907043c06691c4840241cf3b0bd",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/612247b3a0acbdec17b9c52410b2349533ff2d95/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/612247b3a0acbdec17b9c52410b2349533ff2d95/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=612247b3a0acbdec17b9c52410b2349533ff2d95",
            "patch": "@@ -8,13 +8,15 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.core.management import call_command\n from django import db\n-from django.test import simple\n+from django.db import connection\n+from django.test import simple, TransactionTestCase\n from django.test.simple import DjangoTestSuiteRunner, get_tests\n from django.test.testcases import connections_support_transactions\n from django.utils import unittest\n from django.utils.importlib import import_module\n \n from ..admin_scripts.tests import AdminScriptTestCase\n+from .models import Person\n \n \n TEST_APP_OK = 'regressiontests.test_runner.valid_app.models'\n@@ -281,3 +283,24 @@ def test_transaction_support(self):\n                 self.assertTrue(connections_support_transactions(), msg)\n             finally:\n                 db.connections = old_db_connections\n+\n+\n+class AutoIncrementResetTest(TransactionTestCase):\n+    \"\"\"\n+    Here we test creating the same model two times in different test methods,\n+    and check that both times they get \"1\" as their PK value. That is, we test\n+    that AutoField values start from 1 for each transactional test case.\n+    \"\"\"\n+    @unittest.skipIf(connection.vendor == 'oracle',\n+                     \"Oracle's auto-increment fields are not reset between \"\n+                     \"tests\")\n+    def test_autoincrement_reset1(self):\n+        p = Person.objects.create(first_name='Jack', last_name='Smith')\n+        self.assertEquals(p.pk, 1)\n+\n+    @unittest.skipIf(connection.vendor == 'oracle',\n+                     \"Oracle's auto-increment fields are not reset between \"\n+                     \"tests\")\n+    def test_autoincrement_reset2(self):\n+        p = Person.objects.create(first_name='Jack', last_name='Smith')\n+        self.assertEquals(p.pk, 1)"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 65,
        "deletions": 11
    }
}