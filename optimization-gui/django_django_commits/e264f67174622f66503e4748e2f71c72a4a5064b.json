{
    "author": "aaugustin",
    "message": "Refactored implementation of savepoints.\n\nPrepared for using savepoints within transactions in autocommit mode.",
    "sha": "e264f67174622f66503e4748e2f71c72a4a5064b",
    "files": [
        {
            "sha": "48190d3c622f10a8fd260050815ded517836dd95",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 24,
            "deletions": 19,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/e264f67174622f66503e4748e2f71c72a4a5064b/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/e264f67174622f66503e4748e2f71c72a4a5064b/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=e264f67174622f66503e4748e2f71c72a4a5064b",
            "patch": "@@ -176,54 +176,59 @@ def close(self):\n     ##### Backend-specific savepoint management methods #####\n \n     def _savepoint(self, sid):\n-        if not self.features.uses_savepoints or self.autocommit:\n-            return\n         self.cursor().execute(self.ops.savepoint_create_sql(sid))\n \n     def _savepoint_rollback(self, sid):\n-        if not self.features.uses_savepoints or self.autocommit:\n-            return\n         self.cursor().execute(self.ops.savepoint_rollback_sql(sid))\n \n     def _savepoint_commit(self, sid):\n-        if not self.features.uses_savepoints or self.autocommit:\n-            return\n         self.cursor().execute(self.ops.savepoint_commit_sql(sid))\n \n+    def _savepoint_allowed(self):\n+        # Savepoints cannot be created outside a transaction\n+        return self.features.uses_savepoints and not self.autocommit\n+\n     ##### Generic savepoint management methods #####\n \n     def savepoint(self):\n         \"\"\"\n-        Creates a savepoint (if supported and required by the backend) inside the\n-        current transaction. Returns an identifier for the savepoint that will be\n-        used for the subsequent rollback or commit.\n+        Creates a savepoint inside the current transaction. Returns an\n+        identifier for the savepoint that will be used for the subsequent\n+        rollback or commit. Does nothing if savepoints are not supported.\n         \"\"\"\n+        if not self._savepoint_allowed():\n+            return\n+\n         thread_ident = thread.get_ident()\n+        tid = str(thread_ident).replace('-', '')\n \n         self.savepoint_state += 1\n-\n-        tid = str(thread_ident).replace('-', '')\n         sid = \"s%s_x%d\" % (tid, self.savepoint_state)\n+\n+        self.validate_thread_sharing()\n         self._savepoint(sid)\n+\n         return sid\n \n     def savepoint_rollback(self, sid):\n         \"\"\"\n-        Rolls back the most recent savepoint (if one exists). Does nothing if\n-        savepoints are not supported.\n+        Rolls back to a savepoint. Does nothing if savepoints are not supported.\n         \"\"\"\n+        if not self._savepoint_allowed():\n+            return\n+\n         self.validate_thread_sharing()\n-        if self.savepoint_state:\n-            self._savepoint_rollback(sid)\n+        self._savepoint_rollback(sid)\n \n     def savepoint_commit(self, sid):\n         \"\"\"\n-        Commits the most recent savepoint (if one exists). Does nothing if\n-        savepoints are not supported.\n+        Releases a savepoint. Does nothing if savepoints are not supported.\n         \"\"\"\n+        if not self._savepoint_allowed():\n+            return\n+\n         self.validate_thread_sharing()\n-        if self.savepoint_state:\n-            self._savepoint_commit(sid)\n+        self._savepoint_commit(sid)\n \n     def clean_savepoints(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 43,
        "additions": 24,
        "deletions": 19
    }
}