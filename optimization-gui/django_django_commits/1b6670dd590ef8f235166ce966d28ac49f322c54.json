{
    "author": "spookylukey",
    "message": "Fixed #15904 - render_comment_form executes unnecessary query for object\n\nThanks to stefanw for report and patch!\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16103 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1b6670dd590ef8f235166ce966d28ac49f322c54",
    "files": [
        {
            "sha": "8bc61cd44565ab3e29f15cf7cd42c6ebd35cf260",
            "filename": "django/contrib/comments/templatetags/comments.py",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/1b6670dd590ef8f235166ce966d28ac49f322c54/django%2Fcontrib%2Fcomments%2Ftemplatetags%2Fcomments.py",
            "raw_url": "https://github.com/django/django/raw/1b6670dd590ef8f235166ce966d28ac49f322c54/django%2Fcontrib%2Fcomments%2Ftemplatetags%2Fcomments.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Ftemplatetags%2Fcomments.py?ref=1b6670dd590ef8f235166ce966d28ac49f322c54",
            "patch": "@@ -122,12 +122,23 @@ class CommentFormNode(BaseCommentNode):\n     \"\"\"Insert a form for the comment model into the context.\"\"\"\n \n     def get_form(self, context):\n-        ctype, object_pk = self.get_target_ctype_pk(context)\n-        if object_pk:\n-            return comments.get_form()(ctype.get_object_for_this_type(pk=object_pk))\n+        obj = self.get_object(context)\n+        if obj:\n+            return comments.get_form()(obj)\n         else:\n             return None\n \n+    def get_object(self, context):\n+        if self.object_expr:\n+            try:\n+                return self.object_expr.resolve(context)\n+            except template.VariableDoesNotExist:\n+                return None\n+        else:\n+            object_pk = self.object_pk_expr.resolve(context,\n+                    ignore_failures=True)\n+            return self.ctype.get_object_for_this_type(pk=object_pk)\n+\n     def render(self, context):\n         context[self.as_varname] = self.get_form(context)\n         return ''"
        },
        {
            "sha": "0ead6c2257a63fdce44f0e411c12fb6a312a7662",
            "filename": "tests/regressiontests/comment_tests/tests/templatetag_tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/1b6670dd590ef8f235166ce966d28ac49f322c54/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "raw_url": "https://github.com/django/django/raw/1b6670dd590ef8f235166ce966d28ac49f322c54/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py?ref=1b6670dd590ef8f235166ce966d28ac49f322c54",
            "patch": "@@ -40,6 +40,11 @@ def testRenderCommentFormFromLiteral(self):\n     def testRenderCommentFormFromObject(self):\n         self.testRenderCommentForm(\"{% render_comment_form for a %}\")\n \n+    def testRenderCommentFormFromObjectWithQueryCount(self):\n+        def test():\n+            self.testRenderCommentFormFromObject()\n+        self.assertNumQueries(1, test)\n+\n     def testGetCommentCount(self, tag=None):\n         self.createSomeComments()\n         t = \"{% load comments %}\" + (tag or \"{% get_comment_count for comment_tests.article a.id as cc %}\") + \"{{ cc }}\""
        }
    ],
    "stats": {
        "total": 22,
        "additions": 19,
        "deletions": 3
    }
}