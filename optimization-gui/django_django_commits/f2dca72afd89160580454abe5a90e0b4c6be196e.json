{
    "author": "ramiro",
    "message": "Fixed #11065, #11285 -- Streamlined PostgreSQL version detection, fixing incompatibility with multi-db. Thanks findepi for the report.\n\nChanged our internal representation of the PostgreSQL version from tuples to\nintegers as used by libpq and psycopg2. This simplifies version comparison\noperations.\n\nAlso, using the associated libpq/psycopg2 API allows to remove the need for\nmanually issuing in-band ``SELECT version()`` SQL queries to obtain the server\nversion (or at least reduce its number if version of psycopg2 in use is older\nthan 2.0.12). Refs #10509.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16439 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f2dca72afd89160580454abe5a90e0b4c6be196e",
    "files": [
        {
            "sha": "5a94c815bda9943c76ae6355af244cc3df9ee5e2",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/f2dca72afd89160580454abe5a90e0b4c6be196e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f2dca72afd89160580454abe5a90e0b4c6be196e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=f2dca72afd89160580454abe5a90e0b4c6be196e",
            "patch": "@@ -105,6 +105,13 @@ def __init__(self, *args, **kwargs):\n         self.creation = DatabaseCreation(self)\n         self.introspection = DatabaseIntrospection(self)\n         self.validation = BaseDatabaseValidation(self)\n+        self._pg_version = None\n+\n+    def _get_pg_version(self):\n+        if self._pg_version is None:\n+            self._pg_version = get_version(self.connection)\n+        return self._pg_version\n+    pg_version = property(_get_pg_version)\n \n     def _cursor(self):\n         new_connection = False\n@@ -139,8 +146,7 @@ def _cursor(self):\n         if new_connection:\n             if set_tz:\n                 cursor.execute(\"SET TIME ZONE %s\", [settings_dict['TIME_ZONE']])\n-            if not hasattr(self, '_version'):\n-                self.__class__._version = get_version(cursor)\n+            self._get_pg_version()\n             if self.features.uses_autocommit:\n                 # FIXME: Eventually we'll enable this by default for\n                 # versions that support it, but, right now, that's hard to"
        },
        {
            "sha": "fe021b5fc6d3621b02be160802a9d1c1724c2fc9",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 3,
            "deletions": 12,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/f2dca72afd89160580454abe5a90e0b4c6be196e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/f2dca72afd89160580454abe5a90e0b4c6be196e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=f2dca72afd89160580454abe5a90e0b4c6be196e",
            "patch": "@@ -6,15 +6,6 @@\n class DatabaseOperations(BaseDatabaseOperations):\n     def __init__(self, connection):\n         super(DatabaseOperations, self).__init__(connection)\n-        self._postgres_version = None\n-\n-    def _get_postgres_version(self):\n-        if self._postgres_version is None:\n-            from django.db.backends.postgresql_psycopg2.version import get_version\n-            cursor = self.connection.cursor()\n-            self._postgres_version = get_version(cursor)\n-        return self._postgres_version\n-    postgres_version = property(_get_postgres_version)\n \n     def date_extract_sql(self, lookup_type, field_name):\n         # http://www.postgresql.org/docs/8.0/static/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT\n@@ -166,9 +157,9 @@ def check_aggregate_support(self, aggregate):\n         NotImplementedError if this is the database in use.\n         \"\"\"\n         if aggregate.sql_function in ('STDDEV_POP', 'VAR_POP'):\n-            if self.postgres_version[0:2] == (8,2):\n-                if self.postgres_version[2] is None or self.postgres_version[2] <= 4:\n-                    raise NotImplementedError('PostgreSQL 8.2 to 8.2.4 is known to have a faulty implementation of %s. Please upgrade your version of PostgreSQL.' % aggregate.sql_function)\n+            pg_version = self.connection.pg_version\n+            if pg_version >= 80200 and pg_version <= 80204:\n+                raise NotImplementedError('PostgreSQL 8.2 to 8.2.4 is known to have a faulty implementation of %s. Please upgrade your version of PostgreSQL.' % aggregate.sql_function)\n \n     def max_name_length(self):\n         \"\"\""
        },
        {
            "sha": "8ef516704eaa1f78d88ee85125df2723ad0575cc",
            "filename": "django/db/backends/postgresql_psycopg2/version.py",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/f2dca72afd89160580454abe5a90e0b4c6be196e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fversion.py",
            "raw_url": "https://github.com/django/django/raw/f2dca72afd89160580454abe5a90e0b4c6be196e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fversion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fversion.py?ref=f2dca72afd89160580454abe5a90e0b4c6be196e",
            "patch": "@@ -17,16 +17,27 @@ def _parse_version(text):\n     \"Internal parsing method. Factored out for testing purposes.\"\n     major, major2, minor = VERSION_RE.search(text).groups()\n     try:\n-        return int(major), int(major2), int(minor)\n+        return int(major) * 10000 + int(major2) * 100 + int(minor)\n     except (ValueError, TypeError):\n-        return int(major), int(major2), None\n+        return int(major) * 10000 +  int(major2) * 100\n \n-def get_version(cursor):\n+def get_version(connection):\n     \"\"\"\n-    Returns a tuple representing the major, minor and revision number of the\n-    server. For example, (7, 4, 1) or (8, 3, 4). The revision number will be\n-    None in the case of initial releases (e.g., 'PostgreSQL 8.3') or in the\n-    case of beta and prereleases ('PostgreSQL 8.4beta1').\n+    Returns an integer representing the major, minor and revision number of the\n+    server. Format is the one used for the return value of libpq\n+    PQServerVersion()/``server_version`` connection attribute (available in\n+    newer psycopg2 versions.)\n+\n+    For example, 80304 for 8.3.4. The last two digits will be 00 in the case of\n+    releases (e.g., 80400 for 'PostgreSQL 8.4') or in the case of beta and\n+    prereleases (e.g. 90100 for 'PostgreSQL 9.1beta2').\n+\n+    PQServerVersion()/``server_version`` doesn't execute a query so try that\n+    first, then fallback to a ``SELECT version()`` query.\n     \"\"\"\n-    cursor.execute(\"SELECT version()\")\n-    return _parse_version(cursor.fetchone()[0])\n+    if hasattr(connection, 'server_version'):\n+        return connection.server_version\n+    else:\n+        cursor = connection.cursor()\n+        cursor.execute(\"SELECT version()\")\n+        return _parse_version(cursor.fetchone()[0])"
        },
        {
            "sha": "29db6a705adba1065a5e7828f713a9b4bc43fd12",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 6,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/f2dca72afd89160580454abe5a90e0b4c6be196e/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f2dca72afd89160580454abe5a90e0b4c6be196e/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=f2dca72afd89160580454abe5a90e0b4c6be196e",
            "patch": "@@ -196,12 +196,34 @@ def assert_parses(self, version_string, version):\n         self.assertEqual(pg_version._parse_version(version_string), version)\n \n     def test_parsing(self):\n-        self.assert_parses(\"PostgreSQL 8.3 beta4\", (8, 3, None))\n-        self.assert_parses(\"PostgreSQL 8.3\", (8, 3, None))\n-        self.assert_parses(\"EnterpriseDB 8.3\", (8, 3, None))\n-        self.assert_parses(\"PostgreSQL 8.3.6\", (8, 3, 6))\n-        self.assert_parses(\"PostgreSQL 8.4beta1\", (8, 4, None))\n-        self.assert_parses(\"PostgreSQL 8.3.1 on i386-apple-darwin9.2.2, compiled by GCC i686-apple-darwin9-gcc-4.0.1 (GCC) 4.0.1 (Apple Inc. build 5478)\", (8, 3, 1))\n+        \"\"\"Test PostgreSQL version parsing from `SELECT version()` output\"\"\"\n+        self.assert_parses(\"PostgreSQL 8.3 beta4\", 80300)\n+        self.assert_parses(\"PostgreSQL 8.3\", 80300)\n+        self.assert_parses(\"EnterpriseDB 8.3\", 80300)\n+        self.assert_parses(\"PostgreSQL 8.3.6\", 80306)\n+        self.assert_parses(\"PostgreSQL 8.4beta1\", 80400)\n+        self.assert_parses(\"PostgreSQL 8.3.1 on i386-apple-darwin9.2.2, compiled by GCC i686-apple-darwin9-gcc-4.0.1 (GCC) 4.0.1 (Apple Inc. build 5478)\", 80301)\n+\n+    def test_version_detection(self):\n+        \"\"\"Test PostgreSQL version detection\"\"\"\n+\n+        # Helper mocks\n+        class CursorMock(object):\n+            \"Very simple mock of DB-API cursor\"\n+            def execute(self, arg):\n+                pass\n+\n+            def fetchone(self):\n+                return [\"PostgreSQL 8.3\"]\n+\n+        class OlderConnectionMock(object):\n+            \"Mock of psycopg2 (< 2.0.12) connection\"\n+            def cursor(self):\n+                return CursorMock()\n+\n+        # psycopg2 < 2.0.12 code path\n+        conn = OlderConnectionMock()\n+        self.assertEqual(pg_version.get_version(conn), 80300)\n \n # Unfortunately with sqlite3 the in-memory test database cannot be\n # closed, and so it cannot be re-opened during testing, and so we"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 59,
        "deletions": 29
    }
}