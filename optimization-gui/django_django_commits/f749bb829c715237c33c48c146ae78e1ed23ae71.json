{
    "author": "jezdez",
    "message": "Fixed #12875 -- Added get_ordering to ModelAdmin. Many thanks to Manuel Saelices.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16383 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f749bb829c715237c33c48c146ae78e1ed23ae71",
    "files": [
        {
            "sha": "f052fe1808c0f95b9892dd4abaef8d52e0f8e856",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/f749bb829c715237c33c48c146ae78e1ed23ae71/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/f749bb829c715237c33c48c146ae78e1ed23ae71/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=f749bb829c715237c33c48c146ae78e1ed23ae71",
            "patch": "@@ -189,6 +189,12 @@ def _declared_fieldsets(self):\n         return None\n     declared_fieldsets = property(_declared_fieldsets)\n \n+    def get_ordering(self, request):\n+        \"\"\"\n+        Hook for specifying field ordering.\n+        \"\"\"\n+        return self.ordering or ()  # otherwise we might try to *None, which is bad ;)\n+\n     def get_readonly_fields(self, request, obj=None):\n         \"\"\"\n         Hook for specifying custom readonly fields.\n@@ -208,7 +214,7 @@ def queryset(self, request):\n         \"\"\"\n         qs = self.model._default_manager.get_query_set()\n         # TODO: this should be handled by some parameter to the ChangeList.\n-        ordering = self.ordering or () # otherwise we might try to *None, which is bad ;)\n+        ordering = self.get_ordering(request)\n         if ordering:\n             qs = qs.order_by(*ordering)\n         return qs\n@@ -260,6 +266,7 @@ def lookup_allowed(self, lookup, value):\n             clean_lookup = LOOKUP_SEP.join(parts)\n             return clean_lookup in self.list_filter or clean_lookup == self.date_hierarchy\n \n+\n class ModelAdmin(BaseModelAdmin):\n     \"Encapsulates all admin options and functionality for a given model.\"\n "
        },
        {
            "sha": "aea656f4011a17399bb8b57963c71ce4f98be813",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/f749bb829c715237c33c48c146ae78e1ed23ae71/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/f749bb829c715237c33c48c146ae78e1ed23ae71/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=f749bb829c715237c33c48c146ae78e1ed23ae71",
            "patch": "@@ -76,7 +76,7 @@ def __init__(self, request, model, list_display, list_display_links,\n             self.list_editable = ()\n         else:\n             self.list_editable = list_editable\n-        self.ordering = self.get_ordering()\n+        self.ordering = self.get_ordering(request)\n         self.query = request.GET.get(SEARCH_VAR, '')\n         self.query_set = self.get_query_set(request)\n         self.get_results(request)\n@@ -172,12 +172,13 @@ def _get_default_ordering(self):\n             ordering = self.lookup_opts.ordering\n         return ordering\n \n-    def get_ordering(self):\n+    def get_ordering(self, request):\n         params = self.params\n-        # For ordering, first check the \"ordering\" parameter in the admin\n+        # For ordering, first check the if exists the \"get_ordering\" method\n+        # in model admin, then check \"ordering\" parameter in the admin\n         # options, then check the object's default ordering. Finally, a\n         # manually-specified ordering from the query string overrides anything.\n-        ordering = self._get_default_ordering()\n+        ordering = self.model_admin.get_ordering(request) or self._get_default_ordering()\n \n         if ORDER_VAR in params:\n             # Clear ordering and used params"
        },
        {
            "sha": "c0ff3c60367e91b01b7749babf65945ea8388ba2",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/f749bb829c715237c33c48c146ae78e1ed23ae71/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/f749bb829c715237c33c48c146ae78e1ed23ae71/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=f749bb829c715237c33c48c146ae78e1ed23ae71",
            "patch": "@@ -704,6 +704,11 @@ subclass::\n     If this isn't provided, the Django admin will use the model's default\n     ordering.\n \n+    .. versionadded:: 1.4\n+\n+    If you need to specify a dynamic order (for example depending on user or\n+    language) you can implement a :meth:`~ModelAdmin.get_ordering` method.\n+\n     .. versionchanged:: 1.4\n \n     Django honors all elements in the list/tuple; before 1.4, only the first\n@@ -957,6 +962,22 @@ templates used by the :class:`ModelAdmin` views:\n                     instance.save()\n                 formset.save_m2m()\n \n+.. method:: ModelAdmin.get_ordering(self, request)\n+\n+    .. versionadded:: 1.4\n+\n+    The ``get_ordering`` method takes a``request`` as parameter and\n+    is expected to return a ``list`` or ``tuple`` for ordering similiar\n+    to the :attr:`ordering` attribute. For example::\n+\n+        class PersonAdmin(ModelAdmin):\n+\n+            def get_ordering(self, request):\n+                if request.user.is_superuser:\n+                    return ['name', 'rank']\n+                else:\n+                    return ['name']\n+\n .. method:: ModelAdmin.get_readonly_fields(self, request, obj=None)\n \n     .. versionadded:: 1.2\n@@ -1053,7 +1074,7 @@ templates used by the :class:`ModelAdmin` views:\n .. method:: ModelAdmin.formfield_for_foreignkey(self, db_field, request, **kwargs)\n \n     The ``formfield_for_foreignkey`` method on a ``ModelAdmin`` allows you to\n-    override the default formfield for a foreign key field. For example, to\n+    override the default formfield for a foreign keys field. For example, to\n     return a subset of objects for this foreign key field based on the user::\n \n         class MyModelAdmin(admin.ModelAdmin):"
        },
        {
            "sha": "cc20795ded6046e389a2c61f780706613c447f74",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/f749bb829c715237c33c48c146ae78e1ed23ae71/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/f749bb829c715237c33c48c146ae78e1ed23ae71/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=f749bb829c715237c33c48c146ae78e1ed23ae71",
            "patch": "@@ -73,10 +73,12 @@ documentation for :attr:`~django.contrib.admin.ModelAdmin.list_filter`.\n Multiple sort in admin interface\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-The admin change list now supports sorting on multiple columns. It respects all\n-elements of the :attr:`~django.contrib.admin.ModelAdmin.ordering` attribute, and\n-sorting on multiple columns by clicking on headers is designed to work similarly\n-to how desktop GUIs do it.\n+The admin change list now supports sorting on multiple columns. It respects\n+all elements of the :attr:`~django.contrib.admin.ModelAdmin.ordering`\n+attribute, and sorting on multiple columns by clicking on headers is designed\n+to work similarly to how desktop GUIs do it. The new hook\n+:meth:`~django.contrib.admin.ModelAdmin.get_ordering` for specifying the\n+ordering dynamically (e.g. depending on the request) has also been added.\n \n Tools for cryptographic signing\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
        },
        {
            "sha": "7c92b42010d27208e6927fa4ae7efda5d37d4e14",
            "filename": "tests/regressiontests/admin_ordering/models.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f749bb829c715237c33c48c146ae78e1ed23ae71/tests%2Fregressiontests%2Fadmin_ordering%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f749bb829c715237c33c48c146ae78e1ed23ae71/tests%2Fregressiontests%2Fadmin_ordering%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_ordering%2Fmodels.py?ref=f749bb829c715237c33c48c146ae78e1ed23ae71",
            "patch": "@@ -24,3 +24,11 @@ class SongInlineDefaultOrdering(admin.StackedInline):\n class SongInlineNewOrdering(admin.StackedInline):\n     model = Song\n     ordering = ('duration', )\n+\n+class DynOrderingBandAdmin(admin.ModelAdmin):\n+\n+    def get_ordering(self, request):\n+        if request.user.is_superuser:\n+            return ['rank']\n+        else:\n+            return ['name']"
        },
        {
            "sha": "70eca5f771e4a4fb9eef572fab0566c7b85c0589",
            "filename": "tests/regressiontests/admin_ordering/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/f749bb829c715237c33c48c146ae78e1ed23ae71/tests%2Fregressiontests%2Fadmin_ordering%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f749bb829c715237c33c48c146ae78e1ed23ae71/tests%2Fregressiontests%2Fadmin_ordering%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_ordering%2Ftests.py?ref=f749bb829c715237c33c48c146ae78e1ed23ae71",
            "patch": "@@ -1,7 +1,8 @@\n-from django.test import TestCase\n+from django.test import TestCase, RequestFactory\n+from django.contrib.auth.models import User\n from django.contrib.admin.options import ModelAdmin\n \n-from models import Band, Song, SongInlineDefaultOrdering, SongInlineNewOrdering\n+from models import Band, Song, SongInlineDefaultOrdering, SongInlineNewOrdering, DynOrderingBandAdmin\n \n class TestAdminOrdering(TestCase):\n     \"\"\"\n@@ -11,6 +12,7 @@ class TestAdminOrdering(TestCase):\n     \"\"\"\n \n     def setUp(self):\n+        self.request_factory = RequestFactory()\n         b1 = Band(name='Aerosmith', bio='', rank=3)\n         b1.save()\n         b2 = Band(name='Radiohead', bio='', rank=1)\n@@ -38,6 +40,22 @@ class BandAdmin(ModelAdmin):\n         names = [b.name for b in ma.queryset(None)]\n         self.assertEqual([u'Radiohead', u'Van Halen', u'Aerosmith'], names)\n \n+    def test_dynamic_ordering(self):\n+        \"\"\"\n+        Let's use a custom ModelAdmin that changes the ordering dinamically.\n+        \"\"\"\n+        super_user = User.objects.create(username='admin', is_superuser=True)\n+        other_user = User.objects.create(username='other')\n+        request = self.request_factory.get('/')\n+        request.user = super_user\n+        ma = DynOrderingBandAdmin(Band, None)\n+        names = [b.name for b in ma.queryset(request)]\n+        self.assertEqual([u'Radiohead', u'Van Halen', u'Aerosmith'], names)\n+        request.user = other_user\n+        names = [b.name for b in ma.queryset(request)]\n+        self.assertEqual([u'Aerosmith', u'Radiohead', u'Van Halen'], names)\n+\n+\n class TestInlineModelAdminOrdering(TestCase):\n     \"\"\"\n     Let's make sure that InlineModelAdmin.queryset uses the ordering we define"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 69,
        "deletions": 12
    }
}