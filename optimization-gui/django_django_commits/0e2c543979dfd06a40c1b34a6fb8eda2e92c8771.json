{
    "author": "jezdez",
    "message": "Fixed #16967 -- Made sure CachedStaticFilesStorage repopulates its cache if there was a miss (for example if the cache server went down).\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17067 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "0e2c543979dfd06a40c1b34a6fb8eda2e92c8771",
    "files": [
        {
            "sha": "ecb6769973a35f3e975668711eee4e8d1227785d",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/0e2c543979dfd06a40c1b34a6fb8eda2e92c8771/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/0e2c543979dfd06a40c1b34a6fb8eda2e92c8771/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=0e2c543979dfd06a40c1b34a6fb8eda2e92c8771",
            "patch": "@@ -90,11 +90,14 @@ def url(self, name, force=False):\n         Returns the real URL in DEBUG mode.\n         \"\"\"\n         if settings.DEBUG and not force:\n-            return super(CachedFilesMixin, self).url(name)\n-        cache_key = self.cache_key(name)\n-        hashed_name = self.cache.get(cache_key)\n-        if hashed_name is None:\n-            hashed_name = self.hashed_name(name)\n+            hashed_name = name\n+        else:\n+            cache_key = self.cache_key(name)\n+            hashed_name = self.cache.get(cache_key)\n+            if hashed_name is None:\n+                hashed_name = self.hashed_name(name)\n+                # set the cache if there was a miss (e.g. if cache server goes down)\n+                self.cache.set(cache_key, hashed_name)\n         return super(CachedFilesMixin, self).url(hashed_name)\n \n     def url_converter(self, name):"
        },
        {
            "sha": "67977e70d1fc5e57d034633d47fc8ffa6c619f53",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/0e2c543979dfd06a40c1b34a6fb8eda2e92c8771/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0e2c543979dfd06a40c1b34a6fb8eda2e92c8771/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=0e2c543979dfd06a40c1b34a6fb8eda2e92c8771",
            "patch": "@@ -352,6 +352,22 @@ def test_template_tag_url(self):\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             self.assertTrue(\"https://\" in relfile.read())\n \n+    def test_cache_invalidation(self):\n+        name = \"cached/styles.css\"\n+        hashed_name = \"cached/styles.93b1147e8552.css\"\n+        # check if the cache is filled correctly as expected\n+        cache_key = storage.staticfiles_storage.cache_key(name)\n+        cached_name = storage.staticfiles_storage.cache.get(cache_key)\n+        self.assertEqual(self.cached_file_path(name), cached_name)\n+        # clearing the cache to make sure we re-set it correctly in the url method\n+        storage.staticfiles_storage.cache.clear()\n+        cached_name = storage.staticfiles_storage.cache.get(cache_key)\n+        self.assertEqual(cached_name, None)\n+        self.assertEqual(self.cached_file_path(name), hashed_name)\n+        cached_name = storage.staticfiles_storage.cache.get(cache_key)\n+        self.assertEqual(cached_name, hashed_name)\n+\n+\n # we set DEBUG to False here since the template tag wouldn't work otherwise\n TestCollectionCachedStorage = override_settings(**dict(TEST_SETTINGS,\n     STATICFILES_STORAGE='django.contrib.staticfiles.storage.CachedStaticFilesStorage',"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 24,
        "deletions": 5
    }
}