{
    "author": "claudep",
    "message": "Made geo3d tests independent from each other",
    "sha": "59afc18f3735abfd7ab4b1a904000a547daed4ca",
    "files": [
        {
            "sha": "0aba38f5cab3538d1122f0cb60b593b64e9aff32",
            "filename": "django/contrib/gis/tests/geo3d/tests.py",
            "status": "modified",
            "additions": 85,
            "deletions": 49,
            "changes": 134,
            "blob_url": "https://github.com/django/django/blob/59afc18f3735abfd7ab4b1a904000a547daed4ca/django%2Fcontrib%2Fgis%2Ftests%2Fgeo3d%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/59afc18f3735abfd7ab4b1a904000a547daed4ca/django%2Fcontrib%2Fgis%2Ftests%2Fgeo3d%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeo3d%2Ftests.py?ref=59afc18f3735abfd7ab4b1a904000a547daed4ca",
            "patch": "@@ -1,16 +1,17 @@\n-from __future__ import absolute_import\n+from __future__ import absolute_import, unicode_literals\n \n import os\n import re\n \n-from django.utils.unittest import TestCase\n from django.contrib.gis.db.models import Union, Extent3D\n from django.contrib.gis.geos import GEOSGeometry, Point, Polygon\n from django.contrib.gis.utils import LayerMapping, LayerMapError\n+from django.test import TestCase\n \n from .models import (City3D, Interstate2D, Interstate3D, InterstateProj2D,\n     InterstateProj3D, Point2D, Point3D, MultiPoint3D, Polygon2D, Polygon3D)\n \n+\n data_path = os.path.realpath(os.path.join(os.path.dirname(__file__), '..', 'data'))\n city_file = os.path.join(data_path, 'cities', 'cities.shp')\n vrt_file = os.path.join(data_path, 'test_vrt', 'test_vrt.vrt')\n@@ -46,12 +47,11 @@\n # Bounding box polygon for inner-loop of Houston (in projected coordinate\n # system 32140), with elevation values from the National Elevation Dataset\n # (see above).\n-bbox_wkt = 'POLYGON((941527.97 4225693.20,962596.48 4226349.75,963152.57 4209023.95,942051.75 4208366.38,941527.97 4225693.20))'\n-bbox_z = (21.71, 13.21, 9.12, 16.40, 21.71)\n-def gen_bbox():\n-    bbox_2d = GEOSGeometry(bbox_wkt, srid=32140)\n-    bbox_3d = Polygon(tuple((x, y, z) for (x, y), z in zip(bbox_2d[0].coords, bbox_z)), srid=32140)\n-    return bbox_2d, bbox_3d\n+bbox_data = (\n+    'POLYGON((941527.97 4225693.20,962596.48 4226349.75,963152.57 4209023.95,942051.75 4208366.38,941527.97 4225693.20))',\n+    (21.71, 13.21, 9.12, 16.40, 21.71)\n+)\n+\n \n class Geo3DTest(TestCase):\n     \"\"\"\n@@ -63,20 +63,7 @@ class Geo3DTest(TestCase):\n     http://postgis.refractions.net/documentation/manual-1.4/ch08.html#PostGIS_3D_Functions\n     \"\"\"\n \n-    def test01_3d(self):\n-        \"Test the creation of 3D models.\"\n-        # 3D models for the rest of the tests will be populated in here.\n-        # For each 3D data set create model (and 2D version if necessary),\n-        # retrieve, and assert geometry is in 3D and contains the expected\n-        # 3D values.\n-        for name, pnt_data in city_data:\n-            x, y, z = pnt_data\n-            pnt = Point(x, y, z, srid=4326)\n-            City3D.objects.create(name=name, point=pnt)\n-            city = City3D.objects.get(name=name)\n-            self.assertTrue(city.point.hasz)\n-            self.assertEqual(z, city.point.z)\n-\n+    def _load_interstate_data(self):\n         # Interstate (2D / 3D and Geographic/Projected variants)\n         for name, line, exp_z in interstate_data:\n             line_3d = GEOSGeometry(line, srid=4269)\n@@ -90,26 +77,51 @@ def test01_3d(self):\n             Interstate2D.objects.create(name=name, line=line_2d)\n             InterstateProj2D.objects.create(name=name, line=line_2d)\n \n-            # Retrieving and making sure it's 3D and has expected\n-            # Z values -- shouldn't change because of coordinate system.\n+    def _load_city_data(self):\n+        for name, pnt_data in city_data:\n+            City3D.objects.create(name=name, point=Point(*pnt_data, srid=4326))\n+\n+    def _load_polygon_data(self):\n+        bbox_wkt, bbox_z = bbox_data\n+        bbox_2d = GEOSGeometry(bbox_wkt, srid=32140)\n+        bbox_3d = Polygon(tuple((x, y, z) for (x, y), z in zip(bbox_2d[0].coords, bbox_z)), srid=32140)\n+        Polygon2D.objects.create(name='2D BBox', poly=bbox_2d)\n+        Polygon3D.objects.create(name='3D BBox', poly=bbox_3d)\n+\n+    def test_3d_hasz(self):\n+        \"\"\"\n+        Make sure data is 3D and has expected Z values -- shouldn't change\n+        because of coordinate system.\n+        \"\"\"\n+        self._load_interstate_data()\n+        for name, line, exp_z in interstate_data:\n             interstate = Interstate3D.objects.get(name=name)\n             interstate_proj = InterstateProj3D.objects.get(name=name)\n             for i in [interstate, interstate_proj]:\n                 self.assertTrue(i.line.hasz)\n                 self.assertEqual(exp_z, tuple(i.line.z))\n \n-        # Creating 3D Polygon.\n-        bbox2d, bbox3d = gen_bbox()\n-        Polygon2D.objects.create(name='2D BBox', poly=bbox2d)\n-        Polygon3D.objects.create(name='3D BBox', poly=bbox3d)\n+        self._load_city_data()\n+        for name, pnt_data in city_data:\n+            city = City3D.objects.get(name=name)\n+            z = pnt_data[2]\n+            self.assertTrue(city.point.hasz)\n+            self.assertEqual(z, city.point.z)\n+\n+    def test_3d_polygons(self):\n+        \"\"\"\n+        Test the creation of polygon 3D models.\n+        \"\"\"\n+        self._load_polygon_data()\n         p3d = Polygon3D.objects.get(name='3D BBox')\n         self.assertTrue(p3d.poly.hasz)\n-        self.assertEqual(bbox3d, p3d.poly)\n-\n-    def test01a_3d_layermapping(self):\n-        \"Testing LayerMapping on 3D models.\"\n-        from .models import Point2D, Point3D\n+        self.assertIsInstance(p3d.poly, Polygon)\n+        self.assertEqual(p3d.poly.srid, 32140)\n \n+    def test_3d_layermapping(self):\n+        \"\"\"\n+        Testing LayerMapping on 3D models.\n+        \"\"\"\n         point_mapping = {'point' : 'POINT'}\n         mpoint_mapping = {'mpoint' : 'MULTIPOINT'}\n \n@@ -134,34 +146,46 @@ def test01a_3d_layermapping(self):\n         lm.save()\n         self.assertEqual(3, MultiPoint3D.objects.count())\n \n-    def test02a_kml(self):\n-        \"Test GeoQuerySet.kml() with Z values.\"\n+    def test_kml(self):\n+        \"\"\"\n+        Test GeoQuerySet.kml() with Z values.\n+        \"\"\"\n+        self._load_city_data()\n         h = City3D.objects.kml(precision=6).get(name='Houston')\n         # KML should be 3D.\n         # `SELECT ST_AsKML(point, 6) FROM geo3d_city3d WHERE name = 'Houston';`\n         ref_kml_regex = re.compile(r'^<Point><coordinates>-95.363\\d+,29.763\\d+,18</coordinates></Point>$')\n         self.assertTrue(ref_kml_regex.match(h.kml))\n \n-    def test02b_geojson(self):\n-        \"Test GeoQuerySet.geojson() with Z values.\"\n+    def test_geojson(self):\n+        \"\"\"\n+        Test GeoQuerySet.geojson() with Z values.\n+        \"\"\"\n+        self._load_city_data()\n         h = City3D.objects.geojson(precision=6).get(name='Houston')\n         # GeoJSON should be 3D\n         # `SELECT ST_AsGeoJSON(point, 6) FROM geo3d_city3d WHERE name='Houston';`\n         ref_json_regex = re.compile(r'^{\"type\":\"Point\",\"coordinates\":\\[-95.363151,29.763374,18(\\.0+)?\\]}$')\n         self.assertTrue(ref_json_regex.match(h.geojson))\n \n-    def test03a_union(self):\n-        \"Testing the Union aggregate of 3D models.\"\n+    def test_union(self):\n+        \"\"\"\n+        Testing the Union aggregate of 3D models.\n+        \"\"\"\n         # PostGIS query that returned the reference EWKT for this test:\n         #  `SELECT ST_AsText(ST_Union(point)) FROM geo3d_city3d;`\n+        self._load_city_data()\n         ref_ewkt = 'SRID=4326;MULTIPOINT(-123.305196 48.462611 15,-104.609252 38.255001 1433,-97.521157 34.464642 380,-96.801611 32.782057 147,-95.363151 29.763374 18,-95.23506 38.971823 251,-87.650175 41.850385 181,174.783117 -41.315268 14)'\n         ref_union = GEOSGeometry(ref_ewkt)\n         union = City3D.objects.aggregate(Union('point'))['point__union']\n         self.assertTrue(union.hasz)\n         self.assertEqual(ref_union, union)\n \n-    def test03b_extent(self):\n-        \"Testing the Extent3D aggregate for 3D models.\"\n+    def test_extent(self):\n+        \"\"\"\n+        Testing the Extent3D aggregate for 3D models.\n+        \"\"\"\n+        self._load_city_data()\n         # `SELECT ST_Extent3D(point) FROM geo3d_city3d;`\n         ref_extent3d = (-123.305196, -41.315268, 14,174.783117, 48.462611, 1433)\n         extent1 = City3D.objects.aggregate(Extent3D('point'))['point__extent3d']\n@@ -174,8 +198,11 @@ def check_extent3d(extent3d, tol=6):\n         for e3d in [extent1, extent2]:\n             check_extent3d(e3d)\n \n-    def test04_perimeter(self):\n-        \"Testing GeoQuerySet.perimeter() on 3D fields.\"\n+    def test_perimeter(self):\n+        \"\"\"\n+        Testing GeoQuerySet.perimeter() on 3D fields.\n+        \"\"\"\n+        self._load_polygon_data()\n         # Reference query for values below:\n         #  `SELECT ST_Perimeter3D(poly), ST_Perimeter2D(poly) FROM geo3d_polygon3d;`\n         ref_perim_3d = 76859.2620451\n@@ -188,12 +215,15 @@ def test04_perimeter(self):\n                                Polygon3D.objects.perimeter().get(name='3D BBox').perimeter.m,\n                                tol)\n \n-    def test05_length(self):\n-        \"Testing GeoQuerySet.length() on 3D fields.\"\n+    def test_length(self):\n+        \"\"\"\n+        Testing GeoQuerySet.length() on 3D fields.\n+        \"\"\"\n         # ST_Length_Spheroid Z-aware, and thus does not need to use\n         # a separate function internally.\n         # `SELECT ST_Length_Spheroid(line, 'SPHEROID[\"GRS 1980\",6378137,298.257222101]')\n         #    FROM geo3d_interstate[2d|3d];`\n+        self._load_interstate_data()\n         tol = 3\n         ref_length_2d = 4368.1721949481\n         ref_length_3d = 4368.62547052088\n@@ -217,16 +247,22 @@ def test05_length(self):\n                                InterstateProj3D.objects.length().get(name='I-45').length.m,\n                                tol)\n \n-    def test06_scale(self):\n-        \"Testing GeoQuerySet.scale() on Z values.\"\n+    def test_scale(self):\n+        \"\"\"\n+        Testing GeoQuerySet.scale() on Z values.\n+        \"\"\"\n+        self._load_city_data()\n         # Mapping of City name to reference Z values.\n         zscales = (-3, 4, 23)\n         for zscale in zscales:\n             for city in City3D.objects.scale(1.0, 1.0, zscale):\n                 self.assertEqual(city_dict[city.name][2] * zscale, city.scale.z)\n \n-    def test07_translate(self):\n-        \"Testing GeoQuerySet.translate() on Z values.\"\n+    def test_translate(self):\n+        \"\"\"\n+        Testing GeoQuerySet.translate() on Z values.\n+        \"\"\"\n+        self._load_city_data()\n         ztranslations = (5.23, 23, -17)\n         for ztrans in ztranslations:\n             for city in City3D.objects.translate(0, 0, ztrans):"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 85,
        "deletions": 49
    }
}