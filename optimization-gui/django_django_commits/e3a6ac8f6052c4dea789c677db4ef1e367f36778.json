{
    "author": "spookylukey",
    "message": "Small cleanups of 'related manager' code for consistency\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16912 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e3a6ac8f6052c4dea789c677db4ef1e367f36778",
    "files": [
        {
            "sha": "d6694eaeb575b164d6a04f3fac7fa2dc912442e1",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 20,
            "deletions": 15,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/e3a6ac8f6052c4dea789c677db4ef1e367f36778/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/e3a6ac8f6052c4dea789c677db4ef1e367f36778/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=e3a6ac8f6052c4dea789c677db4ef1e367f36778",
            "patch": "@@ -417,58 +417,63 @@ def create_manager(self, instance, superclass):\n         rel_model = self.related.model\n \n         class RelatedManager(superclass):\n+            def __init__(self, model=None, core_filters=None, instance=None):\n+                super(RelatedManager, self).__init__()\n+                self.model = model\n+                self.core_filters = core_filters\n+                self.instance = instance\n+\n             def get_query_set(self):\n-                db = self._db or router.db_for_read(rel_model, instance=instance)\n+                db = self._db or router.db_for_read(rel_model, instance=self.instance)\n                 return superclass.get_query_set(self).using(db).filter(**(self.core_filters))\n \n             def add(self, *objs):\n                 for obj in objs:\n                     if not isinstance(obj, self.model):\n                         raise TypeError(\"'%s' instance expected\" % self.model._meta.object_name)\n-                    setattr(obj, rel_field.name, instance)\n+                    setattr(obj, rel_field.name, self.instance)\n                     obj.save()\n             add.alters_data = True\n \n             def create(self, **kwargs):\n-                kwargs[rel_field.name] = instance\n-                db = router.db_for_write(rel_model, instance=instance)\n+                kwargs[rel_field.name] = self.instance\n+                db = router.db_for_write(rel_model, instance=self.instance)\n                 return super(RelatedManager, self.db_manager(db)).create(**kwargs)\n             create.alters_data = True\n \n             def get_or_create(self, **kwargs):\n                 # Update kwargs with the related object that this\n                 # ForeignRelatedObjectsDescriptor knows about.\n-                kwargs[rel_field.name] = instance\n-                db = router.db_for_write(rel_model, instance=instance)\n+                kwargs[rel_field.name] = self.instance\n+                db = router.db_for_write(rel_model, instance=self.instance)\n                 return super(RelatedManager, self.db_manager(db)).get_or_create(**kwargs)\n             get_or_create.alters_data = True\n \n             # remove() and clear() are only provided if the ForeignKey can have a value of null.\n             if rel_field.null:\n                 def remove(self, *objs):\n-                    val = getattr(instance, rel_field.rel.get_related_field().attname)\n+                    val = getattr(self.instance, rel_field.rel.get_related_field().attname)\n                     for obj in objs:\n                         # Is obj actually part of this descriptor set?\n                         if getattr(obj, rel_field.attname) == val:\n                             setattr(obj, rel_field.name, None)\n                             obj.save()\n                         else:\n-                            raise rel_field.rel.to.DoesNotExist(\"%r is not related to %r.\" % (obj, instance))\n+                            raise rel_field.rel.to.DoesNotExist(\"%r is not related to %r.\" % (obj, self.instance))\n                 remove.alters_data = True\n \n                 def clear(self):\n                     self.update(**{rel_field.name: None})\n                 clear.alters_data = True\n \n-        manager = RelatedManager()\n         attname = rel_field.rel.get_related_field().name\n-        manager.core_filters = {'%s__%s' % (rel_field.name, attname):\n-                getattr(instance, attname)}\n-        manager.model = self.related.model\n-\n-        return manager\n+        return RelatedManager(model=self.related.model,\n+                              core_filters = {'%s__%s' % (rel_field.name, attname):\n+                                                  getattr(instance, attname)},\n+                              instance=instance\n+                              )\n \n-def create_many_related_manager(superclass, rel=False):\n+def create_many_related_manager(superclass, rel):\n     \"\"\"Creates a manager that subclasses 'superclass' (which is a Manager)\n     and adds behavior for many-to-many related objects.\"\"\"\n     through = rel.through"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 20,
        "deletions": 15
    }
}