{
    "author": "honzakral",
    "message": "Fixed #3400 -- Support for lookup separator with list_filter admin option. Thanks to DrMeers and vitek_pliska for the patch!\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14674 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
    "files": [
        {
            "sha": "eab5407cc7e8cbcfec9b50170bdada7f74d41f14",
            "filename": "django/contrib/admin/filterspecs.py",
            "status": "modified",
            "additions": 75,
            "deletions": 35,
            "changes": 110,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Ffilterspecs.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Ffilterspecs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilterspecs.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -11,22 +11,32 @@\n from django.utils.translation import ugettext as _\n from django.utils.html import escape\n from django.utils.safestring import mark_safe\n+from django.contrib.admin.util import get_model_from_relation, \\\n+    reverse_field_path, get_limit_choices_to_from_path\n import datetime\n \n class FilterSpec(object):\n     filter_specs = []\n-    def __init__(self, f, request, params, model, model_admin):\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None):\n         self.field = f\n         self.params = params\n+        self.field_path = field_path\n+        if field_path is None:\n+            if isinstance(f, models.related.RelatedObject):\n+                self.field_path = f.var_name\n+            else:\n+                self.field_path = f.name\n \n     def register(cls, test, factory):\n         cls.filter_specs.append((test, factory))\n     register = classmethod(register)\n \n-    def create(cls, f, request, params, model, model_admin):\n+    def create(cls, f, request, params, model, model_admin, field_path=None):\n         for test, factory in cls.filter_specs:\n             if test(f):\n-                return factory(f, request, params, model, model_admin)\n+                return factory(f, request, params, model, model_admin,\n+                               field_path=field_path)\n     create = classmethod(create)\n \n     def has_output(self):\n@@ -52,14 +62,20 @@ def output(self, cl):\n         return mark_safe(\"\".join(t))\n \n class RelatedFilterSpec(FilterSpec):\n-    def __init__(self, f, request, params, model, model_admin):\n-        super(RelatedFilterSpec, self).__init__(f, request, params, model, model_admin)\n-        if isinstance(f, models.ManyToManyField):\n-            self.lookup_title = f.rel.to._meta.verbose_name\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None):\n+        super(RelatedFilterSpec, self).__init__(\n+            f, request, params, model, model_admin, field_path=field_path)\n+\n+        other_model = get_model_from_relation(f)\n+        if isinstance(f, (models.ManyToManyField,\n+                          models.related.RelatedObject)):\n+            # no direct field on this model, get name from other model\n+            self.lookup_title = other_model._meta.verbose_name\n         else:\n-            self.lookup_title = f.verbose_name\n-        rel_name = f.rel.get_related_field().name\n-        self.lookup_kwarg = '%s__%s__exact' % (f.name, rel_name)\n+            self.lookup_title = f.verbose_name # use field name\n+        rel_name = other_model._meta.pk.name\n+        self.lookup_kwarg = '%s__%s__exact' % (self.field_path, rel_name)\n         self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n         self.lookup_choices = f.get_choices(include_blank=False)\n \n@@ -78,12 +94,17 @@ def choices(self, cl):\n                    'query_string': cl.get_query_string({self.lookup_kwarg: pk_val}),\n                    'display': val}\n \n-FilterSpec.register(lambda f: bool(f.rel), RelatedFilterSpec)\n+FilterSpec.register(lambda f: (\n+        hasattr(f, 'rel') and bool(f.rel) or\n+        isinstance(f, models.related.RelatedObject)), RelatedFilterSpec)\n \n class ChoicesFilterSpec(FilterSpec):\n-    def __init__(self, f, request, params, model, model_admin):\n-        super(ChoicesFilterSpec, self).__init__(f, request, params, model, model_admin)\n-        self.lookup_kwarg = '%s__exact' % f.name\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None):\n+        super(ChoicesFilterSpec, self).__init__(f, request, params, model,\n+                                                model_admin,\n+                                                field_path=field_path)\n+        self.lookup_kwarg = '%s__exact' % self.field_path\n         self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n \n     def choices(self, cl):\n@@ -98,10 +119,13 @@ def choices(self, cl):\n FilterSpec.register(lambda f: bool(f.choices), ChoicesFilterSpec)\n \n class DateFieldFilterSpec(FilterSpec):\n-    def __init__(self, f, request, params, model, model_admin):\n-        super(DateFieldFilterSpec, self).__init__(f, request, params, model, model_admin)\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None): \n+        super(DateFieldFilterSpec, self).__init__(f, request, params, model,\n+                                                  model_admin,\n+                                                  field_path=field_path)\n \n-        self.field_generic = '%s__' % self.field.name\n+        self.field_generic = '%s__' % self.field_path\n \n         self.date_params = dict([(k, v) for k, v in params.items() if k.startswith(self.field_generic)])\n \n@@ -111,14 +135,15 @@ def __init__(self, f, request, params, model, model_admin):\n \n         self.links = (\n             (_('Any date'), {}),\n-            (_('Today'), {'%s__year' % self.field.name: str(today.year),\n-                       '%s__month' % self.field.name: str(today.month),\n-                       '%s__day' % self.field.name: str(today.day)}),\n-            (_('Past 7 days'), {'%s__gte' % self.field.name: one_week_ago.strftime('%Y-%m-%d'),\n-                             '%s__lte' % f.name: today_str}),\n-            (_('This month'), {'%s__year' % self.field.name: str(today.year),\n-                             '%s__month' % f.name: str(today.month)}),\n-            (_('This year'), {'%s__year' % self.field.name: str(today.year)})\n+            (_('Today'), {'%s__year' % self.field_path: str(today.year),\n+                       '%s__month' % self.field_path: str(today.month),\n+                       '%s__day' % self.field_path: str(today.day)}),\n+            (_('Past 7 days'), {'%s__gte' % self.field_path:\n+                                    one_week_ago.strftime('%Y-%m-%d'),\n+                             '%s__lte' % self.field_path: today_str}),\n+            (_('This month'), {'%s__year' % self.field_path: str(today.year),\n+                             '%s__month' % self.field_path: str(today.month)}),\n+            (_('This year'), {'%s__year' % self.field_path: str(today.year)})\n         )\n \n     def title(self):\n@@ -133,10 +158,13 @@ def choices(self, cl):\n FilterSpec.register(lambda f: isinstance(f, models.DateField), DateFieldFilterSpec)\n \n class BooleanFieldFilterSpec(FilterSpec):\n-    def __init__(self, f, request, params, model, model_admin):\n-        super(BooleanFieldFilterSpec, self).__init__(f, request, params, model, model_admin)\n-        self.lookup_kwarg = '%s__exact' % f.name\n-        self.lookup_kwarg2 = '%s__isnull' % f.name\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None):\n+        super(BooleanFieldFilterSpec, self).__init__(f, request, params, model,\n+                                                     model_admin,\n+                                                     field_path=field_path)\n+        self.lookup_kwarg = '%s__exact' % self.field_path\n+        self.lookup_kwarg2 = '%s__isnull' % self.field_path\n         self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n         self.lookup_val2 = request.GET.get(self.lookup_kwarg2, None)\n \n@@ -159,21 +187,33 @@ def choices(self, cl):\n # if a field is eligible to use the BooleanFieldFilterSpec, that'd be much\n # more appropriate, and the AllValuesFilterSpec won't get used for it.\n class AllValuesFilterSpec(FilterSpec):\n-    def __init__(self, f, request, params, model, model_admin):\n-        super(AllValuesFilterSpec, self).__init__(f, request, params, model, model_admin)\n-        self.lookup_val = request.GET.get(f.name, None)\n-        self.lookup_choices = model_admin.queryset(request).distinct().order_by(f.name).values(f.name)\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None):\n+        super(AllValuesFilterSpec, self).__init__(f, request, params, model,\n+                                                  model_admin,\n+                                                  field_path=field_path)\n+        self.lookup_val = request.GET.get(self.field_path, None)\n+        parent_model, reverse_path = reverse_field_path(model, field_path)\n+        queryset = parent_model._default_manager.all()\n+        # optional feature: limit choices base on existing relationships\n+        # queryset = queryset.complex_filter(\n+        #    {'%s__isnull' % reverse_path: False})\n+        limit_choices_to = get_limit_choices_to_from_path(model, field_path)\n+        queryset = queryset.filter(limit_choices_to)\n+\n+        self.lookup_choices = \\\n+            queryset.distinct().order_by(f.name).values(f.name)\n \n     def title(self):\n         return self.field.verbose_name\n \n     def choices(self, cl):\n         yield {'selected': self.lookup_val is None,\n-               'query_string': cl.get_query_string({}, [self.field.name]),\n+               'query_string': cl.get_query_string({}, [self.field_path]),\n                'display': _('All')}\n         for val in self.lookup_choices:\n             val = smart_unicode(val[self.field.name])\n             yield {'selected': self.lookup_val == val,\n-                   'query_string': cl.get_query_string({self.field.name: val}),\n+                   'query_string': cl.get_query_string({self.field_path: val}),\n                    'display': val}\n FilterSpec.register(lambda f: True, AllValuesFilterSpec)"
        },
        {
            "sha": "c6411aed35d32a8f934354c2f3b239d4229467a9",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -1,4 +1,5 @@\n from django.db import models\n+from django.db.models.sql.constants import LOOKUP_SEP\n from django.db.models.deletion import Collector\n from django.db.models.related import RelatedObject\n from django.forms.forms import pretty_name\n@@ -280,3 +281,95 @@ def display_for_field(value, field):\n         return formats.number_format(value)\n     else:\n         return smart_unicode(value)\n+\n+\n+class NotRelationField(Exception):\n+    pass\n+\n+\n+def get_model_from_relation(field):\n+    if isinstance(field, models.related.RelatedObject):\n+        return field.model\n+    elif getattr(field, 'rel'): # or isinstance?\n+        return field.rel.to\n+    else:\n+        raise NotRelationField\n+\n+\n+def reverse_field_path(model, path):\n+    \"\"\" Create a reversed field path.\n+\n+    E.g. Given (Order, \"user__groups\"),\n+    return (Group, \"user__order\").\n+\n+    Final field must be a related model, not a data field.\n+\n+    \"\"\"\n+    reversed_path = []\n+    parent = model\n+    pieces = path.split(LOOKUP_SEP)\n+    for piece in pieces:\n+        field, model, direct, m2m = parent._meta.get_field_by_name(piece)\n+        # skip trailing data field if extant:\n+        if len(reversed_path) == len(pieces)-1: # final iteration\n+            try:\n+                get_model_from_relation(field)\n+            except NotRelationField:\n+                break\n+        if direct:\n+            related_name = field.related_query_name()\n+            parent = field.rel.to\n+        else:\n+            related_name = field.field.name\n+            parent = field.model\n+        reversed_path.insert(0, related_name)\n+    return (parent, LOOKUP_SEP.join(reversed_path))\n+\n+\n+def get_fields_from_path(model, path):\n+    \"\"\" Return list of Fields given path relative to model.\n+\n+    e.g. (ModelX, \"user__groups__name\") -> [\n+        <django.db.models.fields.related.ForeignKey object at 0x...>,\n+        <django.db.models.fields.related.ManyToManyField object at 0x...>,\n+        <django.db.models.fields.CharField object at 0x...>,\n+    ]\n+    \"\"\"\n+    pieces = path.split(LOOKUP_SEP)\n+    fields = []\n+    for piece in pieces:\n+        if fields:\n+            parent = get_model_from_relation(fields[-1])\n+        else:\n+            parent = model\n+        fields.append(parent._meta.get_field_by_name(piece)[0])\n+    return fields\n+\n+\n+def remove_trailing_data_field(fields):\n+    \"\"\" Discard trailing non-relation field if extant. \"\"\"\n+    try:\n+        get_model_from_relation(fields[-1])\n+    except NotRelationField:\n+        fields = fields[:-1]\n+    return fields\n+\n+\n+def get_limit_choices_to_from_path(model, path):\n+    \"\"\" Return Q object for limiting choices if applicable.\n+\n+    If final model in path is linked via a ForeignKey or ManyToManyField which\n+    has a `limit_choices_to` attribute, return it as a Q object.\n+    \"\"\"\n+\n+    fields = get_fields_from_path(model, path)\n+    fields = remove_trailing_data_field(fields)\n+    limit_choices_to = (\n+        fields and hasattr(fields[-1], 'rel') and\n+        getattr(fields[-1].rel, 'limit_choices_to', None))\n+    if not limit_choices_to:\n+        return models.Q() # empty Q\n+    elif isinstance(limit_choices_to, models.Q):\n+        return limit_choices_to # already a Q\n+    else:\n+        return models.Q(**limit_choices_to) # convert dict to Q"
        },
        {
            "sha": "027db6383e3805e4bb6904c8f9b5eb4f30a4b1d0",
            "filename": "django/contrib/admin/validation.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fvalidation.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -1,7 +1,9 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.db import models\n+from django.db.models.fields import FieldDoesNotExist\n from django.forms.models import (BaseModelForm, BaseModelFormSet, fields_for_model,\n     _get_foreign_key)\n+from django.contrib.admin.util import get_fields_from_path, NotRelationField\n from django.contrib.admin.options import flatten_fieldsets, BaseModelAdmin\n from django.contrib.admin.options import HORIZONTAL, VERTICAL\n \n@@ -53,8 +55,15 @@ def validate(cls, model):\n     # list_filter\n     if hasattr(cls, 'list_filter'):\n         check_isseq(cls, 'list_filter', cls.list_filter)\n-        for idx, field in enumerate(cls.list_filter):\n-            get_field(cls, model, opts, 'list_filter[%d]' % idx, field)\n+        for idx, fpath in enumerate(cls.list_filter):\n+            try:\n+                get_fields_from_path(model, fpath)\n+            except (NotRelationField, FieldDoesNotExist), e:\n+                raise ImproperlyConfigured(\n+                    \"'%s.list_filter[%d]' refers to '%s' which does not refer to a Field.\" % (\n+                        cls.__name__, idx, fpath\n+                    )\n+                )\n \n     # list_per_page = 100\n     if hasattr(cls, 'list_per_page') and not isinstance(cls.list_per_page, int):"
        },
        {
            "sha": "0ebb7fd2bb2d6c360a71ba0f04ca0278f15f3ebe",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -1,6 +1,6 @@\n from django.contrib.admin.filterspecs import FilterSpec\n from django.contrib.admin.options import IncorrectLookupParameters\n-from django.contrib.admin.util import quote\n+from django.contrib.admin.util import quote, get_fields_from_path\n from django.core.paginator import Paginator, InvalidPage\n from django.db import models\n from django.utils.encoding import force_unicode, smart_str\n@@ -68,9 +68,11 @@ def __init__(self, request, model, list_display, list_display_links, list_filter\n     def get_filters(self, request):\n         filter_specs = []\n         if self.list_filter:\n-            filter_fields = [self.lookup_opts.get_field(field_name) for field_name in self.list_filter]\n-            for f in filter_fields:\n-                spec = FilterSpec.create(f, request, self.params, self.model, self.model_admin)\n+            for filter_name in self.list_filter:\n+                field = get_fields_from_path(self.model, filter_name)[-1]\n+                spec = FilterSpec.create(field, request, self.params,\n+                                         self.model, self.model_admin,\n+                                         field_path=filter_name)\n                 if spec and spec.has_output():\n                     filter_specs.append(spec)\n         return filter_specs, bool(filter_specs)"
        },
        {
            "sha": "7734230ffa24b5ef3eedb950436e0086148a4538",
            "filename": "django/db/models/related.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fdb%2Fmodels%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/django%2Fdb%2Fmodels%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Frelated.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -1,3 +1,6 @@\n+from django.utils.encoding import smart_unicode\n+from django.db.models.fields import BLANK_CHOICE_DASH\n+\n class BoundRelatedObject(object):\n     def __init__(self, related_object, field_mapping, original):\n         self.relation = related_object\n@@ -18,6 +21,22 @@ def __init__(self, parent_model, model, field):\n         self.name = '%s:%s' % (self.opts.app_label, self.opts.module_name)\n         self.var_name = self.opts.object_name.lower()\n \n+    def get_choices(self, include_blank=True, blank_choice=BLANK_CHOICE_DASH,\n+                    limit_to_currently_related=False):\n+        \"\"\"Returns choices with a default blank choices included, for use\n+        as SelectField choices for this field.\n+\n+        Analogue of django.db.models.fields.Field.get_choices, provided\n+        initially for utilisation by RelatedFilterSpec.\n+        \"\"\"\n+        first_choice = include_blank and blank_choice or []\n+        queryset = self.model._default_manager.all()\n+        if limit_to_currently_related:\n+            queryset = queryset.complex_filter(\n+                {'%s__isnull' % self.parent_model._meta.module_name: False})\n+        lst = [(x._get_pk_val(), smart_unicode(x)) for x in queryset]\n+        return first_choice + lst\n+        \n     def get_db_prep_lookup(self, lookup_type, value, connection, prepared=False):\n         # Defer to the actual field definition for db prep\n         return self.field.get_db_prep_lookup(lookup_type, value,"
        },
        {
            "sha": "89478df65b5bf3168a04ef966e8e1dac7aaf6a5b",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -458,6 +458,11 @@ how both ``list_display`` and ``list_filter`` work::\n         list_display = ('username', 'email', 'first_name', 'last_name', 'is_staff')\n         list_filter = ('is_staff', 'is_superuser')\n \n+Fields in ``list_filter`` can also span relations using the ``__`` lookup::\n+\n+    class UserAdminWithLookup(UserAdmin):\n+        list_filter = ('groups__name')\n+\n The above code results in an admin change list page that looks like this:\n \n     .. image:: _images/users_changelist.png"
        },
        {
            "sha": "fc482b27b4ee64ee39f496e313ac7e8589c06d6a",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -159,6 +159,8 @@ requests. These include:\n       <cache_key_prefixing>` and :ref:`transformation\n       <cache_key_transformation>` has been added to the cache API.\n \n+    * Support for lookups spanning relations in admin's ``list_filter``.\n+\n .. _backwards-incompatible-changes-1.3:\n \n Backwards-incompatible changes in 1.3"
        },
        {
            "sha": "8cd262b8604241aaad5367bc9306745e7cc004c0",
            "filename": "tests/regressiontests/admin_views/customadmin.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -32,3 +32,4 @@ def my_view(self, request):\n site.register(models.Section, inlines=[models.ArticleInline])\n site.register(models.Thing, models.ThingAdmin)\n site.register(models.Fabric, models.FabricAdmin)\n+site.register(models.ChapterXtra1, models.ChapterXtra1Admin)"
        },
        {
            "sha": "37ded89900bdfda0f320e490f22f282add8a2d57",
            "filename": "tests/regressiontests/admin_views/fixtures/admin-views-books.xml",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Ffixtures%2Fadmin-views-books.xml",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Ffixtures%2Fadmin-views-books.xml",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ffixtures%2Fadmin-views-books.xml?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -0,0 +1,45 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<django-objects version=\"1.0\">\n+  <object pk=\"1\" model=\"admin_views.book\">\n+    <field type=\"CharField\" name=\"name\">Book 1</field>\n+  </object>\n+  <object pk=\"2\" model=\"admin_views.book\">\n+    <field type=\"CharField\" name=\"name\">Book 2</field>\n+  </object>\n+  <object pk=\"1\" model=\"admin_views.promo\">\n+    <field type=\"CharField\" name=\"name\">Promo 1</field>\n+    <field type=\"ForiegnKey\" name=\"book\">1</field>\n+  </object>\n+  <object pk=\"2\" model=\"admin_views.promo\">\n+    <field type=\"CharField\" name=\"name\">Promo 2</field>\n+    <field type=\"ForiegnKey\" name=\"book\">2</field>\n+  </object>\n+  <object pk=\"1\" model=\"admin_views.chapter\">\n+    <field type=\"CharField\" name=\"title\">Chapter 1</field>\n+    <field type=\"TextField\" name=\"content\">[ insert contents here ]</field>\n+    <field type=\"ForiegnKey\" name=\"book\">1</field>\n+  </object>\n+  <object pk=\"2\" model=\"admin_views.chapter\">\n+    <field type=\"CharField\" name=\"title\">Chapter 2</field>\n+    <field type=\"TextField\" name=\"content\">[ insert contents here ]</field>\n+    <field type=\"ForiegnKey\" name=\"book\">1</field>\n+  </object>\n+  <object pk=\"3\" model=\"admin_views.chapter\">\n+    <field type=\"CharField\" name=\"title\">Chapter 1</field>\n+    <field type=\"TextField\" name=\"content\">[ insert contents here ]</field>\n+    <field type=\"ForiegnKey\" name=\"book\">2</field>\n+  </object>\n+  <object pk=\"4\" model=\"admin_views.chapter\">\n+    <field type=\"CharField\" name=\"title\">Chapter 2</field>\n+    <field type=\"TextField\" name=\"content\">[ insert contents here ]</field>\n+    <field type=\"ForiegnKey\" name=\"book\">2</field>\n+  </object>\n+  <object pk=\"1\" model=\"admin_views.chapterxtra1\">\n+    <field type=\"CharField\" name=\"xtra\">ChapterXtra1 1</field>\n+    <field type=\"ForiegnKey\" name=\"chap\">1</field>\n+  </object>\n+  <object pk=\"2\" model=\"admin_views.chapterxtra1\">\n+    <field type=\"CharField\" name=\"xtra\">ChapterXtra1 2</field>\n+    <field type=\"ForiegnKey\" name=\"chap\">3</field>\n+  </object>\n+</django-objects>"
        },
        {
            "sha": "61ca33904c72b9306b00338d46fe6881814f3dad",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -90,6 +90,14 @@ class ArticleInline(admin.TabularInline):\n class ChapterInline(admin.TabularInline):\n     model = Chapter\n \n+class ChapterXtra1Admin(admin.ModelAdmin):\n+    list_filter = ('chap',\n+                   'chap__title',\n+                   'chap__book',\n+                   'chap__book__name',\n+                   'chap__book__promo',\n+                   'chap__book__promo__name',)\n+\n class ArticleAdmin(admin.ModelAdmin):\n     list_display = ('content', 'date', callable_year, 'model_year', 'modeladmin_year')\n     list_filter = ('date',)\n@@ -168,7 +176,7 @@ def __unicode__(self):\n         return self.title\n \n class ThingAdmin(admin.ModelAdmin):\n-    list_filter = ('color',)\n+    list_filter = ('color', 'color__warm', 'color__value')\n \n class Fabric(models.Model):\n     NG_CHOICES = (\n@@ -646,7 +654,7 @@ class Album(models.Model):\n # contrib.admin.util's get_deleted_objects function.\n admin.site.register(Book, inlines=[ChapterInline])\n admin.site.register(Promo)\n-admin.site.register(ChapterXtra1)\n+admin.site.register(ChapterXtra1, ChapterXtra1Admin)\n admin.site.register(Pizza, PizzaAdmin)\n admin.site.register(Topping)\n admin.site.register(Album)"
        },
        {
            "sha": "79a29d8ab056f3739d302b93b1b0926d31090fb6",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 48,
            "deletions": 3,
            "changes": 51,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -19,6 +19,7 @@\n from django.utils.cache import get_max_age\n from django.utils.encoding import iri_to_uri\n from django.utils.html import escape\n+from django.utils.http import urlencode\n from django.utils.translation import activate, deactivate\n from django.utils import unittest\n \n@@ -27,11 +28,12 @@\n     FooAccount, Gallery, ModelWithStringPrimaryKey, \\\n     Person, Persona, Picture, Podcast, Section, Subscriber, Vodcast, \\\n     Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit, \\\n-    Category, Post, Plot, FunkyTag\n+    Category, Post, Plot, FunkyTag, Chapter, Book, Promo\n \n \n class AdminViewBasicTest(TestCase):\n-    fixtures = ['admin-views-users.xml', 'admin-views-colors.xml', 'admin-views-fabrics.xml']\n+    fixtures = ['admin-views-users.xml', 'admin-views-colors.xml',\n+                'admin-views-fabrics.xml', 'admin-views-books.xml']\n \n     # Store the bit of the URL where the admin is registered as a class\n     # variable. That way we can test a second AdminSite just by subclassing\n@@ -204,7 +206,9 @@ def testChangeListSortingModelAdmin(self):\n         )\n \n     def testLimitedFilter(self):\n-        \"\"\"Ensure admin changelist filters do not contain objects excluded via limit_choices_to.\"\"\"\n+        \"\"\"Ensure admin changelist filters do not contain objects excluded via limit_choices_to.\n+        This also tests relation-spanning filters (e.g. 'color__value').\n+        \"\"\"\n         response = self.client.get('/test_admin/%s/admin_views/thing/' % self.urlbit)\n         self.failUnlessEqual(response.status_code, 200)\n         self.failUnless(\n@@ -216,6 +220,47 @@ def testLimitedFilter(self):\n             \"Changelist filter not correctly limited by limit_choices_to.\"\n         )\n \n+    def testRelationSpanningFilters(self):\n+        response = self.client.get('/test_admin/%s/admin_views/chapterxtra1/' %\n+                                   self.urlbit)\n+        self.failUnlessEqual(response.status_code, 200)\n+        self.assertContains(response, '<div id=\"changelist-filter\">')\n+        filters = {\n+            'chap__id__exact': dict(\n+                values=[c.id for c in Chapter.objects.all()],\n+                test=lambda obj, value: obj.chap.id == value),\n+            'chap__title': dict(\n+                values=[c.title for c in Chapter.objects.all()],\n+                test=lambda obj, value: obj.chap.title == value),\n+            'chap__book__id__exact': dict(\n+                values=[b.id for b in Book.objects.all()],\n+                test=lambda obj, value: obj.chap.book.id == value),\n+            'chap__book__name': dict(\n+                values=[b.name for b in Book.objects.all()],\n+                test=lambda obj, value: obj.chap.book.name == value),\n+            'chap__book__promo__id__exact': dict(\n+                values=[p.id for p in Promo.objects.all()],\n+                test=lambda obj, value:\n+                    obj.chap.book.promo_set.filter(id=value).exists()),\n+            'chap__book__promo__name': dict(\n+                values=[p.name for p in Promo.objects.all()],\n+                test=lambda obj, value:\n+                    obj.chap.book.promo_set.filter(name=value).exists()),\n+            }\n+        for filter_path, params in filters.items():\n+            for value in params['values']:\n+                query_string = urlencode({filter_path: value})\n+                # ensure filter link exists\n+                self.assertContains(response, '<a href=\"?%s\">' % query_string)\n+                # ensure link works\n+                filtered_response = self.client.get(\n+                    '/test_admin/%s/admin_views/chapterxtra1/?%s' % (\n+                        self.urlbit, query_string))\n+                self.failUnlessEqual(filtered_response.status_code, 200)\n+                # ensure changelist contains only valid objects\n+                for obj in filtered_response.context['cl'].query_set.all():\n+                    self.assertTrue(params['test'](obj, value))\n+\n     def testIncorrectLookupParameters(self):\n         \"\"\"Ensure incorrect lookup parameters are handled gracefully.\"\"\"\n         response = self.client.get('/test_admin/%s/admin_views/thing/' % self.urlbit, {'notarealfield': '5'})"
        },
        {
            "sha": "042c1b75ea3c3e077bca1a1409ba03c8b0286d0e",
            "filename": "tests/regressiontests/modeladmin/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dc334a2ba8dbf5134d65c97fea2785c3b2294ef5/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py?ref=dc334a2ba8dbf5134d65c97fea2785c3b2294ef5",
            "patch": "@@ -835,7 +835,7 @@ class ValidationTestModelAdmin(ModelAdmin):\n \n         self.assertRaisesRegexp(\n             ImproperlyConfigured,\n-            \"'ValidationTestModelAdmin.list_filter\\[0\\]' refers to field 'non_existent_field' that is missing from model 'ValidationTestModel'.\",\n+            \"'ValidationTestModelAdmin.list_filter\\[0\\]' refers to 'non_existent_field' which does not refer to a Field.\",\n             validate,\n             ValidationTestModelAdmin,\n             ValidationTestModel,"
        }
    ],
    "stats": {
        "total": 363,
        "additions": 316,
        "deletions": 47
    }
}