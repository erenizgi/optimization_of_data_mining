{
    "author": "claudep",
    "message": "Fixed #14886 -- Added wms_options dict to GeoModelAdmin.\n\nIt is now possible to set WMS options by overriding wms_options\nin a subclass of GeoModelAdmin.\nThanks slinkp for the report and the initial patch.",
    "sha": "ce8f874b88942863be17b4ee02bb27632cc0e65e",
    "files": [
        {
            "sha": "6913bf5870032c039315e7f4e7cdb86430feabf7",
            "filename": "django/contrib/gis/admin/options.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/ce8f874b88942863be17b4ee02bb27632cc0e65e/django%2Fcontrib%2Fgis%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/ce8f874b88942863be17b4ee02bb27632cc0e65e/django%2Fcontrib%2Fgis%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fadmin%2Foptions.py?ref=ce8f874b88942863be17b4ee02bb27632cc0e65e",
            "patch": "@@ -36,6 +36,7 @@ class GeoModelAdmin(ModelAdmin):\n     wms_url = 'http://vmap0.tiles.osgeo.org/wms/vmap0'\n     wms_layer = 'basic'\n     wms_name = 'OpenLayers WMS'\n+    wms_options = {'format': 'image/jpeg'}\n     debug = False\n     widget = OpenLayersWidget\n \n@@ -76,6 +77,12 @@ def get_map_widget(self, db_field):\n         class OLMap(self.widget):\n             template = self.map_template\n             geom_type = db_field.geom_type\n+\n+            wms_options = ''\n+            if self.wms_options:\n+                wms_options = [\"%s: '%s'\" % pair for pair in self.wms_options.items()]\n+                wms_options = ', %s' % ', '.join(wms_options)\n+\n             params = {'default_lon' : self.default_lon,\n                       'default_lat' : self.default_lat,\n                       'default_zoom' : self.default_zoom,\n@@ -106,6 +113,7 @@ class OLMap(self.widget):\n                       'wms_url' : self.wms_url,\n                       'wms_layer' : self.wms_layer,\n                       'wms_name' : self.wms_name,\n+                      'wms_options' : wms_options,\n                       'debug' : self.debug,\n                       }\n         return OLMap"
        },
        {
            "sha": "f54b75e25831c364750a8ef1779eabbb8e1b740d",
            "filename": "django/contrib/gis/templates/gis/admin/openlayers.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/ce8f874b88942863be17b4ee02bb27632cc0e65e/django%2Fcontrib%2Fgis%2Ftemplates%2Fgis%2Fadmin%2Fopenlayers.js",
            "raw_url": "https://github.com/django/django/raw/ce8f874b88942863be17b4ee02bb27632cc0e65e/django%2Fcontrib%2Fgis%2Ftemplates%2Fgis%2Fadmin%2Fopenlayers.js",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftemplates%2Fgis%2Fadmin%2Fopenlayers.js?ref=ce8f874b88942863be17b4ee02bb27632cc0e65e",
            "patch": "@@ -111,7 +111,7 @@ OpenLayers.Projection.addTransform(\"EPSG:4326\", \"EPSG:3857\", OpenLayers.Layer.Sp\n     // The admin map for this geometry field.\n     {{ module }}.map = new OpenLayers.Map('{{ id }}_map', options);\n     // Base Layer\n-    {{ module }}.layers.base = {% block base_layer %}new OpenLayers.Layer.WMS( \"{{ wms_name }}\", \"{{ wms_url }}\", {layers: '{{ wms_layer }}'} );{% endblock %}\n+    {{ module }}.layers.base = {% block base_layer %}new OpenLayers.Layer.WMS(\"{{ wms_name }}\", \"{{ wms_url }}\", {layers: '{{ wms_layer }}'{{ wms_options|safe }}});{% endblock %}\n     {{ module }}.map.addLayer({{ module }}.layers.base);\n     {% block extra_layers %}{% endblock %}\n     {% if is_linestring %}OpenLayers.Feature.Vector.style[\"default\"][\"strokeWidth\"] = 3; // Default too thin for linestrings. {% endif %}"
        },
        {
            "sha": "1f104b22a1b81ed1570b4b8cea9a1d491677b362",
            "filename": "django/contrib/gis/tests/geoadmin/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/ce8f874b88942863be17b4ee02bb27632cc0e65e/django%2Fcontrib%2Fgis%2Ftests%2Fgeoadmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ce8f874b88942863be17b4ee02bb27632cc0e65e/django%2Fcontrib%2Fgis%2Ftests%2Fgeoadmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoadmin%2Ftests.py?ref=ce8f874b88942863be17b4ee02bb27632cc0e65e",
            "patch": "@@ -2,6 +2,7 @@\n \n from django.test import TestCase\n from django.contrib.gis import admin\n+from django.contrib.gis.geos import Point\n \n from .models import City\n \n@@ -14,3 +15,21 @@ def test01_ensure_geographic_media(self):\n         admin_js = geoadmin.media.render_js()\n         self.assertTrue(any([geoadmin.openlayers_url in js for js in admin_js]))\n \n+    def test_olmap_OSM_rendering(self):\n+        geoadmin = admin.site._registry[City]\n+        result = geoadmin.get_map_widget(City._meta.get_field('point'))(\n+            ).render('point', Point(-79.460734, 40.18476))\n+        self.assertIn(\n+            \"\"\"geodjango_point.layers.base = new OpenLayers.Layer.OSM(\"OpenStreetMap (Mapnik)\");\"\"\",\n+            result)\n+\n+    def test_olmap_WMS_rendering(self):\n+        admin.site.unregister(City)\n+        admin.site.register(City, admin.GeoModelAdmin)\n+\n+        geoadmin = admin.site._registry[City]\n+        result = geoadmin.get_map_widget(City._meta.get_field('point'))(\n+            ).render('point', Point(-79.460734, 40.18476))\n+        self.assertIn(\n+            \"\"\"geodjango_point.layers.base = new OpenLayers.Layer.WMS(\"OpenLayers WMS\", \"http://labs.metacarta.com/wms/vmap0\", {layers: \\'basic\\', format: 'image/jpeg'});\"\"\",\n+            result)"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 28,
        "deletions": 1
    }
}