{
    "author": "akaariai",
    "message": "Fixed #18014 -- Removed rev_join_map from sql/query.py.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17878 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4f623524125ce059951ab879d34b50f6024225f4",
    "files": [
        {
            "sha": "780f93e72ee99ac755094e9af23eb9581848021b",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/4f623524125ce059951ab879d34b50f6024225f4/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/4f623524125ce059951ab879d34b50f6024225f4/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=4f623524125ce059951ab879d34b50f6024225f4",
            "patch": "@@ -104,7 +104,6 @@ def __init__(self, model, where=WhereNode):\n         self.alias_map = {}     # Maps alias to join information\n         self.table_map = {}     # Maps table names to list of aliases.\n         self.join_map = {}\n-        self.rev_join_map = {}  # Reverse of join_map.\n         self.quote_cache = {}\n         self.default_cols = True\n         self.default_ordering = True\n@@ -244,7 +243,6 @@ def clone(self, klass=None, memo=None, **kwargs):\n         obj.alias_map = self.alias_map.copy()\n         obj.table_map = self.table_map.copy()\n         obj.join_map = self.join_map.copy()\n-        obj.rev_join_map = self.rev_join_map.copy()\n         obj.quote_cache = {}\n         obj.default_cols = self.default_cols\n         obj.default_ordering = self.default_ordering\n@@ -463,18 +461,19 @@ def combine(self, rhs, connector):\n         change_map = {}\n         used = set()\n         conjunction = (connector == AND)\n+        # Add the joins in the rhs query into the new query.\n         first = True\n         for alias in rhs.tables:\n             if not rhs.alias_refcount[alias]:\n                 # An unused alias.\n                 continue\n-            promote = (rhs.alias_map[alias][JOIN_TYPE] == self.LOUTER)\n-            lhs, table, lhs_col, col = rhs.rev_join_map[alias]\n+            table, _, join_type, lhs, lhs_col, col, _ = rhs.alias_map[alias]\n+            promote = join_type == self.LOUTER\n             # If the left side of the join was already relabeled, use the\n             # updated alias.\n             lhs = change_map.get(lhs, lhs)\n             new_alias = self.join((lhs, table, lhs_col, col),\n-                    (conjunction and not first), used, promote, not conjunction)\n+                    conjunction and not first, used, promote, not conjunction)\n             used.add(new_alias)\n             change_map[alias] = new_alias\n             first = False\n@@ -766,16 +765,12 @@ def change_aliases(self, change_map):\n                     col.relabel_aliases(change_map)\n \n         # 2. Rename the alias in the internal table/alias datastructures.\n+        for k, aliases in self.join_map.items():\n+            aliases = tuple([change_map.get(a, a) for a in aliases])\n+            self.join_map[k] = aliases\n         for old_alias, new_alias in change_map.iteritems():\n             alias_data = list(self.alias_map[old_alias])\n             alias_data[RHS_ALIAS] = new_alias\n-\n-            t = self.rev_join_map[old_alias]\n-            data = list(self.join_map[t])\n-            data[data.index(old_alias)] = new_alias\n-            self.join_map[t] = tuple(data)\n-            self.rev_join_map[new_alias] = t\n-            del self.rev_join_map[old_alias]\n             self.alias_refcount[new_alias] = self.alias_refcount[old_alias]\n             del self.alias_refcount[old_alias]\n             self.alias_map[new_alias] = tuple(alias_data)\n@@ -923,7 +918,6 @@ def join(self, connection, always_create=False, exclusions=(),\n             self.join_map[t_ident] += (alias,)\n         else:\n             self.join_map[t_ident] = (alias,)\n-        self.rev_join_map[alias] = t_ident\n         return alias\n \n     def setup_inherited_models(self):"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 7,
        "deletions": 13
    }
}