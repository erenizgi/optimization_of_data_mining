{
    "author": "alex",
    "message": "Merge pull request #495 from aisipos/ticket_18949\n\nFixed #18949 -- Improve performance of model_to_dict with many-to-many",
    "sha": "4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60",
    "files": [
        {
            "sha": "e9b71ccf2623ed13dfe8063aa1ac87188c210bcb",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60",
            "patch": "@@ -126,7 +126,7 @@ def model_to_dict(instance, fields=None, exclude=None):\n                 data[f.name] = []\n             else:\n                 # MultipleChoiceWidget needs a list of pks, not object instances.\n-                data[f.name] = [obj.pk for obj in f.value_from_object(instance)]\n+                data[f.name] = list(f.value_from_object(instance).values_list('pk', flat=True))\n         else:\n             data[f.name] = f.value_from_object(instance)\n     return data"
        },
        {
            "sha": "46d5af565aadff24e2e3d7bb46d480e72dc46022",
            "filename": "tests/modeltests/model_forms/tests.py",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py?ref=4d766b3c9aca36cbe7dc71df0cc93fb6f9deea60",
            "patch": "@@ -561,6 +561,42 @@ def test_unique_for_date_with_nullable_date(self):\n             \"slug\": \"Django 1.0\"}, instance=p)\n         self.assertTrue(form.is_valid())\n \n+class ModelToDictTests(TestCase):\n+    \"\"\"\n+    Tests for forms.models.model_to_dict\n+    \"\"\"\n+    def test_model_to_dict_many_to_many(self):\n+        categories=[\n+            Category(name='TestName1', slug='TestName1', url='url1'),\n+            Category(name='TestName2', slug='TestName2', url='url2'),\n+            Category(name='TestName3', slug='TestName3', url='url3')\n+        ]\n+        for c in categories:\n+            c.save()\n+        writer = Writer(name='Test writer')\n+        writer.save()\n+\n+        art = Article(\n+            headline='Test article',\n+            slug='test-article',\n+            pub_date=datetime.date(1988, 1, 4),\n+            writer=writer,\n+            article='Hello.'\n+        )\n+        art.save()\n+        for c in categories:\n+            art.categories.add(c)\n+        art.save()\n+\n+        with self.assertNumQueries(1):\n+            d = model_to_dict(art)\n+\n+        #Ensure all many-to-many categories appear in model_to_dict\n+        for c in categories:\n+            self.assertIn(c.pk, d['categories'])\n+        #Ensure many-to-many relation appears as a list\n+        self.assertIsInstance(d['categories'], list)\n+\n class OldFormForXTests(TestCase):\n     def test_base_form(self):\n         self.assertEqual(Category.objects.count(), 0)"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 37,
        "deletions": 1
    }
}