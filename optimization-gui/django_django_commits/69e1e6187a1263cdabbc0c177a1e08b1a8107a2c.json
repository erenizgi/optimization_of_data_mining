{
    "author": "alex",
    "message": "Switch several assertNumQueries to use the context manager, which is much more beautiful.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16986 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
    "files": [
        {
            "sha": "1b3715a1c8239b8c17a4bac9fb3c8cae4ee08ab0",
            "filename": "tests/modeltests/select_related/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 20,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fmodeltests%2Fselect_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fmodeltests%2Fselect_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fselect_related%2Ftests.py?ref=69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
            "patch": "@@ -1,9 +1,10 @@\n-from __future__ import absolute_import\n+from __future__ import with_statement, absolute_import\n \n from django.test import TestCase\n \n from .models import Domain, Kingdom, Phylum, Klass, Order, Family, Genus, Species\n \n+\n class SelectRelatedTests(TestCase):\n \n     def create_tree(self, stringtree):\n@@ -41,29 +42,27 @@ def test_access_fks_without_select_related(self):\n         \"\"\"\n         Normally, accessing FKs doesn't fill in related objects\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(8):\n             fly = Species.objects.get(name=\"melanogaster\")\n             domain = fly.genus.family.order.klass.phylum.kingdom.domain\n             self.assertEqual(domain.name, 'Eukaryota')\n-        self.assertNumQueries(8, test)\n \n     def test_access_fks_with_select_related(self):\n         \"\"\"\n         A select_related() call will fill in those related objects without any\n         extra queries\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(1):\n             person = Species.objects.select_related(depth=10).get(name=\"sapiens\")\n             domain = person.genus.family.order.klass.phylum.kingdom.domain\n             self.assertEqual(domain.name, 'Eukaryota')\n-        self.assertNumQueries(1, test)\n \n     def test_list_without_select_related(self):\n         \"\"\"\n         select_related() also of course applies to entire lists, not just\n         items. This test verifies the expected behavior without select_related.\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(9):\n             world = Species.objects.all()\n             families = [o.genus.family.name for o in world]\n             self.assertEqual(sorted(families), [\n@@ -72,14 +71,13 @@ def test():\n                 'Fabaceae',\n                 'Hominidae',\n             ])\n-        self.assertNumQueries(9, test)\n \n     def test_list_with_select_related(self):\n         \"\"\"\n         select_related() also of course applies to entire lists, not just\n         items. This test verifies the expected behavior with select_related.\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(1):\n             world = Species.objects.all().select_related()\n             families = [o.genus.family.name for o in world]\n             self.assertEqual(sorted(families), [\n@@ -88,21 +86,19 @@ def test():\n                 'Fabaceae',\n                 'Hominidae',\n             ])\n-        self.assertNumQueries(1, test)\n \n     def test_depth(self, depth=1, expected=7):\n         \"\"\"\n         The \"depth\" argument to select_related() will stop the descent at a\n         particular level.\n         \"\"\"\n-        def test():\n+        # Notice: one fewer queries than above because of depth=1\n+        with self.assertNumQueries(expected):\n             pea = Species.objects.select_related(depth=depth).get(name=\"sativum\")\n             self.assertEqual(\n                 pea.genus.family.order.klass.phylum.kingdom.domain.name,\n                 'Eukaryota'\n             )\n-        # Notice: one fewer queries than above because of depth=1\n-        self.assertNumQueries(expected, test)\n \n     def test_larger_depth(self):\n         \"\"\"\n@@ -116,12 +112,11 @@ def test_list_with_depth(self):\n         The \"depth\" argument to select_related() will stop the descent at a\n         particular level. This can be used on lists as well.\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(5):\n             world = Species.objects.all().select_related(depth=2)\n             orders = [o.genus.family.order.name for o in world]\n             self.assertEqual(sorted(orders),\n                 ['Agaricales', 'Diptera', 'Fabales', 'Primates'])\n-        self.assertNumQueries(5, test)\n \n     def test_select_related_with_extra(self):\n         s = Species.objects.all().select_related(depth=1)\\\n@@ -137,31 +132,28 @@ def test_certain_fields(self):\n         In this case, we explicitly say to select the 'genus' and\n         'genus.family' models, leading to the same number of queries as before.\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(1):\n             world = Species.objects.select_related('genus__family')\n             families = [o.genus.family.name for o in world]\n             self.assertEqual(sorted(families),\n                 ['Amanitacae', 'Drosophilidae', 'Fabaceae', 'Hominidae'])\n-        self.assertNumQueries(1, test)\n \n     def test_more_certain_fields(self):\n         \"\"\"\n         In this case, we explicitly say to select the 'genus' and\n         'genus.family' models, leading to the same number of queries as before.\n         \"\"\"\n-        def test():\n+        with self.assertNumQueries(2):\n             world = Species.objects.filter(genus__name='Amanita')\\\n                 .select_related('genus__family')\n             orders = [o.genus.family.order.name for o in world]\n             self.assertEqual(orders, [u'Agaricales'])\n-        self.assertNumQueries(2, test)\n \n     def test_field_traversal(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             s = Species.objects.all().select_related('genus__family__order'\n                 ).order_by('id')[0:1].get().genus.family.order.name\n             self.assertEqual(s, u'Diptera')\n-        self.assertNumQueries(1, test)\n \n     def test_depth_fields_fails(self):\n         self.assertRaises(TypeError,"
        },
        {
            "sha": "3ae981d45c6a34dab656e956733ecfd972e98981",
            "filename": "tests/modeltests/validation/test_unique.py",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fmodeltests%2Fvalidation%2Ftest_unique.py",
            "raw_url": "https://github.com/django/django/raw/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fmodeltests%2Fvalidation%2Ftest_unique.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Ftest_unique.py?ref=69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
            "patch": "@@ -58,26 +58,23 @@ def test_unique_for_date_exclusion(self):\n class PerformUniqueChecksTest(TestCase):\n     def test_primary_key_unique_check_not_performed_when_adding_and_pk_not_specified(self):\n         # Regression test for #12560\n-        def test():\n+        with self.assertNumQueries(0):\n             mtv = ModelToValidate(number=10, name='Some Name')\n             setattr(mtv, '_adding', True)\n             mtv.full_clean()\n-        self.assertNumQueries(0, test)\n \n     def test_primary_key_unique_check_performed_when_adding_and_pk_specified(self):\n         # Regression test for #12560\n-        def test():\n+        with self.assertNumQueries(1):\n             mtv = ModelToValidate(number=10, name='Some Name', id=123)\n             setattr(mtv, '_adding', True)\n             mtv.full_clean()\n-        self.assertNumQueries(1, test)\n \n     def test_primary_key_unique_check_not_performed_when_not_adding(self):\n         # Regression test for #12132\n-        def test():\n+        with self.assertNumQueries(0):\n             mtv = ModelToValidate(number=10, name='Some Name')\n             mtv.full_clean()\n-        self.assertNumQueries(0, test)\n \n     def test_unique_for_date(self):\n         p1 = Post.objects.create(title=\"Django 1.0 is released\","
        },
        {
            "sha": "de397678cd104beb78eeef215e466646e6e62247",
            "filename": "tests/regressiontests/comment_tests/tests/templatetag_tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "raw_url": "https://github.com/django/django/raw/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py?ref=69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
            "patch": "@@ -45,9 +45,8 @@ def testRenderCommentFormFromObject(self):\n         self.testRenderCommentForm(\"{% render_comment_form for a %}\")\n \n     def testRenderCommentFormFromObjectWithQueryCount(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             self.testRenderCommentFormFromObject()\n-        self.assertNumQueries(1, test)\n \n     def verifyGetCommentCount(self, tag=None):\n         t = \"{% load comments %}\" + (tag or \"{% get_comment_count for comment_tests.article a.id as cc %}\") + \"{{ cc }}\""
        },
        {
            "sha": "cbf4521b754aa9900232b63d7138c9cb21999084",
            "filename": "tests/regressiontests/defer_regress/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py?ref=69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
            "patch": "@@ -1,4 +1,4 @@\n-from __future__ import absolute_import\n+from __future__ import with_statement, absolute_import\n \n from operator import attrgetter\n \n@@ -21,22 +21,18 @@ def test_basic(self):\n         obj = Item.objects.only(\"name\", \"other_value\").get(name=\"first\")\n         # Accessing \"name\" doesn't trigger a new database query. Accessing\n         # \"value\" or \"text\" should.\n-        def test():\n+        with self.assertNumQueries(0):\n             self.assertEqual(obj.name, \"first\")\n             self.assertEqual(obj.other_value, 0)\n-        self.assertNumQueries(0, test)\n \n-        def test():\n+        with self.assertNumQueries(1):\n             self.assertEqual(obj.value, 42)\n-        self.assertNumQueries(1, test)\n \n-        def test():\n+        with self.assertNumQueries(1):\n             self.assertEqual(obj.text, \"xyzzy\")\n-        self.assertNumQueries(1, test)\n \n-        def test():\n+        with self.assertNumQueries(0):\n             self.assertEqual(obj.text, \"xyzzy\")\n-        self.assertNumQueries(0, test)\n \n         # Regression test for #10695. Make sure different instances don't\n         # inadvertently share data in the deferred descriptor objects."
        },
        {
            "sha": "12546081d79caf7c49e490693f6a8864bafd81c8",
            "filename": "tests/regressiontests/forms/tests/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py?ref=69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
            "patch": "@@ -1,5 +1,5 @@\n # -*- coding: utf-8 -*-\n-from __future__ import absolute_import\n+from __future__ import with_statement, absolute_import\n \n import datetime\n \n@@ -28,11 +28,10 @@ def setUp(self):\n         self.groups = [Group.objects.create(name=name) for name in 'abc']\n \n     def test_choices_not_fetched_when_not_rendering(self):\n-        def test():\n+        # only one query is required to pull the model from DB\n+        with self.assertNumQueries(1):\n             field = ModelChoiceField(Group.objects.order_by('-name'))\n             self.assertEqual('a', field.clean(self.groups[0].pk).name)\n-        # only one query is required to pull the model from DB\n-        self.assertNumQueries(1, test)\n \n class ModelFormCallableModelDefault(TestCase):\n     def test_no_empty_option(self):"
        },
        {
            "sha": "643a0ffc406dfc078dd54b68f6be2b5e2a553fc0",
            "filename": "tests/regressiontests/select_related_onetoone/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 19,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fselect_related_onetoone%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/69e1e6187a1263cdabbc0c177a1e08b1a8107a2c/tests%2Fregressiontests%2Fselect_related_onetoone%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fselect_related_onetoone%2Ftests.py?ref=69e1e6187a1263cdabbc0c177a1e08b1a8107a2c",
            "patch": "@@ -1,10 +1,11 @@\n-from __future__ import absolute_import\n+from __future__ import with_statement, absolute_import\n \n from django.test import TestCase\n \n from .models import (User, UserProfile, UserStat, UserStatResult, StatDetails,\n     AdvancedUserStat, Image, Product)\n \n+\n class ReverseSelectRelatedTestCase(TestCase):\n     def setUp(self):\n         user = User.objects.create(username=\"test\")\n@@ -22,65 +23,56 @@ def setUp(self):\n         StatDetails.objects.create(base_stats=advstat, comments=250)\n \n     def test_basic(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             u = User.objects.select_related(\"userprofile\").get(username=\"test\")\n             self.assertEqual(u.userprofile.state, \"KS\")\n-        self.assertNumQueries(1, test)\n \n     def test_follow_next_level(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             u = User.objects.select_related(\"userstat__results\").get(username=\"test\")\n             self.assertEqual(u.userstat.posts, 150)\n             self.assertEqual(u.userstat.results.results, 'first results')\n-        self.assertNumQueries(1, test)\n \n     def test_follow_two(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             u = User.objects.select_related(\"userprofile\", \"userstat\").get(username=\"test\")\n             self.assertEqual(u.userprofile.state, \"KS\")\n             self.assertEqual(u.userstat.posts, 150)\n-        self.assertNumQueries(1, test)\n \n     def test_follow_two_next_level(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             u = User.objects.select_related(\"userstat__results\", \"userstat__statdetails\").get(username=\"test\")\n             self.assertEqual(u.userstat.results.results, 'first results')\n             self.assertEqual(u.userstat.statdetails.comments, 259)\n-        self.assertNumQueries(1, test)\n \n     def test_forward_and_back(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             stat = UserStat.objects.select_related(\"user__userprofile\").get(user__username=\"test\")\n             self.assertEqual(stat.user.userprofile.state, 'KS')\n             self.assertEqual(stat.user.userstat.posts, 150)\n-        self.assertNumQueries(1, test)\n \n     def test_back_and_forward(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             u = User.objects.select_related(\"userstat\").get(username=\"test\")\n             self.assertEqual(u.userstat.user.username, 'test')\n-        self.assertNumQueries(1, test)\n \n     def test_not_followed_by_default(self):\n-        def test():\n+        with self.assertNumQueries(2):\n             u = User.objects.select_related().get(username=\"test\")\n             self.assertEqual(u.userstat.posts, 150)\n-        self.assertNumQueries(2, test)\n \n     def test_follow_from_child_class(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             stat = AdvancedUserStat.objects.select_related('user', 'statdetails').get(posts=200)\n             self.assertEqual(stat.statdetails.comments, 250)\n             self.assertEqual(stat.user.username, 'bob')\n-        self.assertNumQueries(1, test)\n \n     def test_follow_inheritance(self):\n-        def test():\n+        with self.assertNumQueries(1):\n             stat = UserStat.objects.select_related('user', 'advanceduserstat').get(posts=200)\n             self.assertEqual(stat.advanceduserstat.posts, 200)\n             self.assertEqual(stat.user.username, 'bob')\n             self.assertEqual(stat.advanceduserstat.user.username, 'bob')\n-        self.assertNumQueries(1, test)\n \n     def test_nullable_relation(self):\n         im = Image.objects.create(name=\"imag1\")"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 35,
        "deletions": 60
    }
}