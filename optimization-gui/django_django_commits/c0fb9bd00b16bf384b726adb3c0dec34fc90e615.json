{
    "author": "jezdez",
    "message": "Fixed #13411 -- Made sure URL fragments are correctly handled by the next_redirect utility of the comments apps. Thanks, timesong, dpn and Julien Phalip.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15720 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c0fb9bd00b16bf384b726adb3c0dec34fc90e615",
    "files": [
        {
            "sha": "cc985e52d20398ffae5c1831a2352f74bd948923",
            "filename": "django/contrib/comments/views/utils.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/c0fb9bd00b16bf384b726adb3c0dec34fc90e615/django%2Fcontrib%2Fcomments%2Fviews%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/c0fb9bd00b16bf384b726adb3c0dec34fc90e615/django%2Fcontrib%2Fcomments%2Fviews%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fviews%2Futils.py?ref=c0fb9bd00b16bf384b726adb3c0dec34fc90e615",
            "patch": "@@ -25,8 +25,15 @@ def next_redirect(data, default, default_view, **get_kwargs):\n     if next is None:\n         next = urlresolvers.reverse(default_view)\n     if get_kwargs:\n+        if '#' in next:\n+            tmp = next.rsplit('#', 1)\n+            next = tmp[0]\n+            anchor = '#' + tmp[1]\n+        else:\n+            anchor = ''\n+\n         joiner = ('?' in next) and '&' or '?'\n-        next += joiner + urllib.urlencode(get_kwargs)\n+        next += joiner + urllib.urlencode(get_kwargs) + anchor\n     return HttpResponseRedirect(next)\n \n def confirmation_view(template, doc=\"Display a confirmation view.\"):"
        },
        {
            "sha": "5e791966aecc0556408db51a8068c775409b9c0d",
            "filename": "tests/regressiontests/comment_tests/tests/comment_view_tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/c0fb9bd00b16bf384b726adb3c0dec34fc90e615/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fcomment_view_tests.py",
            "raw_url": "https://github.com/django/django/raw/c0fb9bd00b16bf384b726adb3c0dec34fc90e615/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fcomment_view_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fcomment_view_tests.py?ref=c0fb9bd00b16bf384b726adb3c0dec34fc90e615",
            "patch": "@@ -256,3 +256,27 @@ def testCommentPostRedirectWithInvalidIntegerPK(self):\n         broken_location = location + u\"\\ufffd\"\n         response = self.client.get(broken_location)\n         self.assertEqual(response.status_code, 200)\n+\n+    def testCommentNextWithQueryStringAndAnchor(self):\n+        \"\"\"\n+        The `next` key needs to handle already having an anchor. Refs #13411.\n+        \"\"\"\n+        # With a query string also.\n+        a = Article.objects.get(pk=1)\n+        data = self.getValidData(a)\n+        data[\"next\"] = \"/somewhere/else/?foo=bar#baz\"\n+        data[\"comment\"] = \"This is another comment\"\n+        response = self.client.post(\"/post/\", data)\n+        location = response[\"Location\"]\n+        match = re.search(r\"^http://testserver/somewhere/else/\\?foo=bar&c=\\d+#baz$\", location)\n+        self.failUnless(match != None, \"Unexpected redirect location: %s\" % location)\n+\n+        # Without a query string\n+        a = Article.objects.get(pk=1)\n+        data = self.getValidData(a)\n+        data[\"next\"] = \"/somewhere/else/#baz\"\n+        data[\"comment\"] = \"This is another comment\"\n+        response = self.client.post(\"/post/\", data)\n+        location = response[\"Location\"]\n+        match = re.search(r\"^http://testserver/somewhere/else/\\?c=\\d+#baz$\", location)\n+        self.failUnless(match != None, \"Unexpected redirect location: %s\" % location)"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 32,
        "deletions": 1
    }
}