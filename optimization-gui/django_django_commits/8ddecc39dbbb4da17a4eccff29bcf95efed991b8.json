{
    "author": "jphalip",
    "message": "Fixed #17252 -- Fixed a minor regression introduced by the work in #11868, where the default sorted columns wouldn't correctly be visually represented in the changelist table headers if those columns referred to non model fields. Thanks to sebastian for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17143 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8ddecc39dbbb4da17a4eccff29bcf95efed991b8",
    "files": [
        {
            "sha": "0294be187e6e2c6abc833e39bd789942e760d25d",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 33,
            "deletions": 36,
            "changes": 69,
            "blob_url": "https://github.com/django/django/blob/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=8ddecc39dbbb4da17a4eccff29bcf95efed991b8",
            "patch": "@@ -169,14 +169,35 @@ def _get_default_ordering(self):\n             ordering = self.lookup_opts.ordering\n         return ordering\n \n+    def get_ordering_field(self, field_name):\n+        \"\"\"\n+        Returns the proper model field name corresponding to the given\n+        field_name to use for ordering. field_name may either be the name of a\n+        proper model field or the name of a method (on the admin or model) or a\n+        callable with the 'admin_order_field' attribute. Returns None if no\n+        proper model field name can be matched.\n+        \"\"\"\n+        try:\n+            field = self.lookup_opts.get_field(field_name)\n+            return field.name\n+        except models.FieldDoesNotExist:\n+            # See whether field_name is a name of a non-field\n+            # that allows sorting.\n+            if callable(field_name):\n+                attr = field_name\n+            elif hasattr(self.model_admin, field_name):\n+                attr = getattr(self.model_admin, field_name)\n+            else:\n+                attr = getattr(self.model, field_name)\n+            return getattr(attr, 'admin_order_field', None)\n+\n     def get_ordering(self, request):\n         params = self.params\n         # For ordering, first check the if exists the \"get_ordering\" method\n         # in model admin, then check \"ordering\" parameter in the admin\n         # options, then check the object's default ordering. Finally, a\n         # manually-specified ordering from the query string overrides anything.\n         ordering = self.model_admin.get_ordering(request) or self._get_default_ordering()\n-\n         if ORDER_VAR in params:\n             # Clear ordering and used params\n             ordering = []\n@@ -185,33 +206,18 @@ def get_ordering(self, request):\n                 try:\n                     none, pfx, idx = p.rpartition('-')\n                     field_name = self.list_display[int(idx)]\n-                    try:\n-                        f = self.lookup_opts.get_field(field_name)\n-                    except models.FieldDoesNotExist:\n-                        # See whether field_name is a name of a non-field\n-                        # that allows sorting.\n-                        try:\n-                            if callable(field_name):\n-                                attr = field_name\n-                            elif hasattr(self.model_admin, field_name):\n-                                attr = getattr(self.model_admin, field_name)\n-                            else:\n-                                attr = getattr(self.model, field_name)\n-                            field_name = attr.admin_order_field\n-                        except AttributeError:\n-                            continue # No 'admin_order_field', skip it\n-                    else:\n-                        field_name = f.name\n-\n-                    ordering.append(pfx + field_name)\n-\n+                    order_field = self.get_ordering_field(field_name)\n+                    if not order_field:\n+                        continue # No 'admin_order_field', skip it\n+                    ordering.append(pfx + order_field)\n                 except (IndexError, ValueError):\n                     continue # Invalid ordering specified, skip it.\n-\n         return ordering\n \n     def get_ordering_field_columns(self):\n-        # Returns a SortedDict of ordering field column numbers and asc/desc\n+        \"\"\"\n+        Returns a SortedDict of ordering field column numbers and asc/desc\n+        \"\"\"\n \n         # We must cope with more than one column having the same underlying sort\n         # field, so we base things on column numbers.\n@@ -227,19 +233,10 @@ def get_ordering_field_columns(self):\n                     order_type = 'desc'\n                 else:\n                     order_type = 'asc'\n-                index = None\n-                try:\n-                    # Search for simply field name first\n-                    index = list(self.list_display).index(field)\n-                except ValueError:\n-                    # No match, but there might be a match if we take into\n-                    # account 'admin_order_field'\n-                    for _index, attr in enumerate(self.list_display):\n-                        if getattr(attr, 'admin_order_field', '') == field:\n-                            index = _index\n-                            break\n-                if index is not None:\n-                    ordering_fields[index] = order_type\n+                for index, attr in enumerate(self.list_display):\n+                    if self.get_ordering_field(attr) == field:\n+                        ordering_fields[index] = order_type\n+                        break\n         else:\n             for p in self.params[ORDER_VAR].split('.'):\n                 none, pfx, idx = p.rpartition('-')"
        },
        {
            "sha": "514538fb6dfdb6802a1ed2a0e0144f9e95c3d6cf",
            "filename": "tests/regressiontests/admin_views/admin.py",
            "status": "modified",
            "additions": 37,
            "deletions": 7,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py?ref=8ddecc39dbbb4da17a4eccff29bcf95efed991b8",
            "patch": "@@ -22,7 +22,9 @@\n     Gadget, Villain, SuperVillain, Plot, PlotDetails, CyclicOne, CyclicTwo,\n     WorkHour, Reservation, FoodDelivery, RowLevelChangePermissionModel, Paper,\n     CoverLetter, Story, OtherStory, Book, Promo, ChapterXtra1, Pizza, Topping,\n-    Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug)\n+    Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug,\n+    AdminOrderedField, AdminOrderedModelMethod, AdminOrderedAdminMethod,\n+    AdminOrderedCallable)\n \n \n def callable_year(dt_value):\n@@ -469,11 +471,35 @@ class WorkHourAdmin(admin.ModelAdmin):\n     list_filter = ('employee',)\n \n \n-class PrePopulatedPostLargeSlugAdmin(admin.ModelAdmin): \n-    prepopulated_fields = { \n-        'slug' : ('title',) \n-    } \n- \n+class PrePopulatedPostLargeSlugAdmin(admin.ModelAdmin):\n+    prepopulated_fields = {\n+        'slug' : ('title',)\n+    }\n+\n+\n+class AdminOrderedFieldAdmin(admin.ModelAdmin):\n+    ordering = ('order',)\n+    list_display = ('stuff', 'order')\n+\n+class AdminOrderedModelMethodAdmin(admin.ModelAdmin):\n+    ordering = ('order',)\n+    list_display = ('stuff', 'some_order')\n+\n+class AdminOrderedAdminMethodAdmin(admin.ModelAdmin):\n+    def some_admin_order(self, obj):\n+        return obj.order\n+    some_admin_order.admin_order_field = 'order'\n+    ordering = ('order',)\n+    list_display = ('stuff', 'some_admin_order')\n+\n+def admin_ordered_callable(obj):\n+    return obj.order\n+admin_ordered_callable.admin_order_field = 'order'\n+class AdminOrderedCallableAdmin(admin.ModelAdmin):\n+    ordering = ('order',)\n+    list_display = ('stuff', admin_ordered_callable)\n+\n+\n site = admin.AdminSite(name=\"admin\")\n site.register(Article, ArticleAdmin)\n site.register(CustomArticle, CustomArticleAdmin)\n@@ -537,10 +563,14 @@ class PrePopulatedPostLargeSlugAdmin(admin.ModelAdmin):\n site.register(Answer)\n site.register(PrePopulatedPost, PrePopulatedPostAdmin)\n site.register(ComplexSortedPerson, ComplexSortedPersonAdmin)\n+site.register(PrePopulatedPostLargeSlug, PrePopulatedPostLargeSlugAdmin)\n+site.register(AdminOrderedField, AdminOrderedFieldAdmin)\n+site.register(AdminOrderedModelMethod, AdminOrderedModelMethodAdmin)\n+site.register(AdminOrderedAdminMethod, AdminOrderedAdminMethodAdmin)\n+site.register(AdminOrderedCallable, AdminOrderedCallableAdmin)\n \n # Register core models we need in our tests\n from django.contrib.auth.models import User, Group\n from django.contrib.auth.admin import UserAdmin, GroupAdmin\n site.register(User, UserAdmin)\n site.register(Group, GroupAdmin)\n-site.register(PrePopulatedPostLargeSlug, PrePopulatedPostLargeSlugAdmin) "
        },
        {
            "sha": "eb56f9b6e3b689385af5a5dee30eb949c6172edb",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 27,
            "deletions": 9,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=8ddecc39dbbb4da17a4eccff29bcf95efed991b8",
            "patch": "@@ -538,13 +538,31 @@ class ComplexSortedPerson(models.Model):\n     age = models.PositiveIntegerField()\n     is_employee = models.NullBooleanField()\n \n-class PrePopulatedPostLargeSlug(models.Model): \n-    \"\"\" \n-    Regression test for #15938: a large max_length for the slugfield must not \n-    be localized in prepopulated_fields_js.html or it might end up breaking \n-    the javascript (ie, using THOUSAND_SEPARATOR ends up with maxLength=1,000) \n-    \"\"\" \n-    title = models.CharField(max_length=100) \n-    published = models.BooleanField() \n+class PrePopulatedPostLargeSlug(models.Model):\n+    \"\"\"\n+    Regression test for #15938: a large max_length for the slugfield must not\n+    be localized in prepopulated_fields_js.html or it might end up breaking\n+    the javascript (ie, using THOUSAND_SEPARATOR ends up with maxLength=1,000)\n+    \"\"\"\n+    title = models.CharField(max_length=100)\n+    published = models.BooleanField()\n     slug = models.SlugField(max_length=1000)\n-    \n+\n+class AdminOrderedField(models.Model):\n+    order = models.IntegerField()\n+    stuff = models.CharField(max_length=200)\n+\n+class AdminOrderedModelMethod(models.Model):\n+    order = models.IntegerField()\n+    stuff = models.CharField(max_length=200)\n+    def some_order(self):\n+        return self.order\n+    some_order.admin_order_field = 'order'\n+\n+class AdminOrderedAdminMethod(models.Model):\n+    order = models.IntegerField()\n+    stuff = models.CharField(max_length=200)\n+\n+class AdminOrderedCallable(models.Model):\n+    order = models.IntegerField()\n+    stuff = models.CharField(max_length=200)"
        },
        {
            "sha": "f176708366db9d9af9130ab6050a8f649ebc86ae",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/8ddecc39dbbb4da17a4eccff29bcf95efed991b8/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=8ddecc39dbbb4da17a4eccff29bcf95efed991b8",
            "patch": "@@ -37,7 +37,8 @@\n     DooHickey, FancyDoodad, Whatsit, Category, Post, Plot, FunkyTag, Chapter,\n     Book, Promo, WorkHour, Employee, Question, Answer, Inquisition, Actor,\n     FoodDelivery, RowLevelChangePermissionModel, Paper, CoverLetter, Story,\n-    OtherStory, ComplexSortedPerson, Parent, Child)\n+    OtherStory, ComplexSortedPerson, Parent, Child, AdminOrderedField,\n+    AdminOrderedModelMethod, AdminOrderedAdminMethod, AdminOrderedCallable)\n \n \n ERROR_MESSAGE = \"Please enter the correct username and password \\\n@@ -354,6 +355,32 @@ def testMultipleSortSameField(self):\n             response.content.index(link % p2.id) < response.content.index(link % p1.id)\n         )\n \n+    def testSortIndicatorsAdminOrder(self):\n+        \"\"\"\n+        Ensures that the admin shows default sort indicators for all\n+        kinds of 'ordering' fields: field names, method on the model\n+        admin and model itself, and other callables. See #17252.\n+        \"\"\"\n+        models = [(AdminOrderedField,       'adminorderedfield'      ),\n+                  (AdminOrderedModelMethod, 'adminorderedmodelmethod'),\n+                  (AdminOrderedAdminMethod, 'adminorderedadminmethod'),\n+                  (AdminOrderedCallable,    'adminorderedcallable'   )]\n+        for model, url in models:\n+            a1 = model.objects.create(stuff='The Last Item',   order=3)\n+            a2 = model.objects.create(stuff='The First Item',  order=1)\n+            a3 = model.objects.create(stuff='The Middle Item', order=2)\n+            response = self.client.get('/test_admin/admin/admin_views/%s/' % url, {})\n+            self.assertEqual(response.status_code, 200)\n+            # Should have 3 columns including action checkbox col.\n+            self.assertContains(response, '<th scope=\"col\"', count=3, msg_prefix=url)\n+            # Check if the correct column was selected. 2 is the index of the\n+            # 'order' column in the model admin's 'list_display' with 0 being\n+            # the implicit 'action_checkbox' and 1 being the column 'stuff'.\n+            self.assertEqual(response.context['cl'].get_ordering_field_columns(), {2: 'asc'})\n+            # Check order of records.\n+            self.assertTrue(response.content.index('The First Item') <\n+                response.content.index('The Middle Item') < response.content.index('The Last Item'))\n+\n     def testLimitedFilter(self):\n         \"\"\"Ensure admin changelist filters do not contain objects excluded via limit_choices_to.\n         This also tests relation-spanning filters (e.g. 'color__value').\n@@ -2757,7 +2784,7 @@ def test_prepopulated_off(self):\n         self.assertNotContains(response, \"id: '#id_slug'\")\n         self.assertNotContains(response, \"field['dependency_ids'].push('#id_title');\")\n         self.assertNotContains(response, \"id: '#id_prepopulatedsubpost_set-0-subslug',\")\n-    \n+\n     @override_settings(USE_THOUSAND_SEPARATOR = True, USE_L10N = True)\n     def test_prepopulated_maxlength_localized(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 180,
        "additions": 126,
        "deletions": 54
    }
}