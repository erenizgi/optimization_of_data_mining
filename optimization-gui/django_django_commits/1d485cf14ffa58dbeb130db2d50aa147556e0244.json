{
    "author": "jezdez",
    "message": "Fixed #10405 -- Raise a more useful error if the formfield of a related model field can't be created yet because the related model isn't loaded yet. Thanks ojii and charstring.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16604 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1d485cf14ffa58dbeb130db2d50aa147556e0244",
    "files": [
        {
            "sha": "201a854a4bea321a5af277901b929fd0f2e62124",
            "filename": "django/core/exceptions.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d485cf14ffa58dbeb130db2d50aa147556e0244/django%2Fcore%2Fexceptions.py",
            "raw_url": "https://github.com/django/django/raw/1d485cf14ffa58dbeb130db2d50aa147556e0244/django%2Fcore%2Fexceptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fexceptions.py?ref=1d485cf14ffa58dbeb130db2d50aa147556e0244",
            "patch": "@@ -3,7 +3,7 @@\n \"\"\"\n \n class DjangoRuntimeWarning(RuntimeWarning):\n-   pass\n+    pass\n \n class ObjectDoesNotExist(Exception):\n     \"The requested object does not exist\""
        },
        {
            "sha": "3e861cddd2ad8739fcbd8ac8ec096cf8df39f8e9",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/1d485cf14ffa58dbeb130db2d50aa147556e0244/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/1d485cf14ffa58dbeb130db2d50aa147556e0244/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=1d485cf14ffa58dbeb130db2d50aa147556e0244",
            "patch": "@@ -905,6 +905,10 @@ def contribute_to_related_class(self, cls, related):\n \n     def formfield(self, **kwargs):\n         db = kwargs.pop('using', None)\n+        if isinstance(self.rel.to, basestring):\n+            raise ValueError(\"Cannot create form field for %r yet, because \"\n+                             \"its related model %r has not been loaded yet\" %\n+                             (self.name, self.rel.to))\n         defaults = {\n             'form_class': forms.ModelChoiceField,\n             'queryset': self.rel.to._default_manager.using(db).complex_filter(self.rel.limit_choices_to),"
        },
        {
            "sha": "60fc4e83ba16c35a0bc033165fc31565d9fd6e12",
            "filename": "tests/regressiontests/forms/tests/models.py",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/1d485cf14ffa58dbeb130db2d50aa147556e0244/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/1d485cf14ffa58dbeb130db2d50aa147556e0244/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py?ref=1d485cf14ffa58dbeb130db2d50aa147556e0244",
            "patch": "@@ -1,7 +1,9 @@\n # -*- coding: utf-8 -*-\n import datetime\n from django.core.files.uploadedfile import SimpleUploadedFile\n+from django.db import models\n from django.forms import Form, ModelForm, FileField, ModelChoiceField\n+from django.forms.models import ModelFormMetaclass\n from django.test import TestCase\n from regressiontests.forms.models import (ChoiceOptionModel, ChoiceFieldModel,\n     FileModel, Group, BoundaryModel, Defaults)\n@@ -160,3 +162,34 @@ class Meta:\n         self.assertEqual(obj.name, u'class default value')\n         self.assertEqual(obj.value, 99)\n         self.assertEqual(obj.def_date, datetime.date(1999, 3, 2))\n+\n+class RelatedModelFormTests(TestCase):\n+    def test_invalid_loading_order(self):\n+        \"\"\"\n+        Test for issue 10405\n+        \"\"\"\n+        class A(models.Model):\n+            ref = models.ForeignKey(\"B\")\n+\n+        class Meta:\n+            model=A\n+\n+        self.assertRaises(ValueError, ModelFormMetaclass, 'Form', (ModelForm,), {'Meta': Meta})\n+\n+        class B(models.Model):\n+            pass\n+\n+    def test_valid_loading_order(self):\n+        \"\"\"\n+        Test for issue 10405\n+        \"\"\"\n+        class A(models.Model):\n+            ref = models.ForeignKey(\"B\")\n+\n+        class B(models.Model):\n+            pass\n+\n+        class Meta:\n+            model=A\n+\n+        self.assertTrue(issubclass(ModelFormMetaclass('Form', (ModelForm,), {'Meta': Meta}), ModelForm))"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 38,
        "deletions": 1
    }
}