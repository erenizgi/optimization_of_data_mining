{
    "author": "carljm",
    "message": "Fixed #16838 -- Corrected broken add-another inline JS in admin with related_name=\"+\". Thanks jamesp for report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16860 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "09a01435de65989864d56a8bf74ff2d84e9c4bd5",
    "files": [
        {
            "sha": "f05b5cb3a7a9721f59d3068019b4b7d66f9f268d",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/09a01435de65989864d56a8bf74ff2d84e9c4bd5/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/09a01435de65989864d56a8bf74ff2d84e9c4bd5/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=09a01435de65989864d56a8bf74ff2d84e9c4bd5",
            "patch": "@@ -926,7 +926,7 @@ def add_view(self, request, form_url='', extra_context=None):\n             for FormSet, inline in zip(self.get_formsets(request), self.inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n-                if prefixes[prefix] != 1:\n+                if prefixes[prefix] != 1 or not prefix:\n                     prefix = \"%s-%s\" % (prefix, prefixes[prefix])\n                 formset = FormSet(data=request.POST, files=request.FILES,\n                                   instance=new_object,\n@@ -955,7 +955,7 @@ def add_view(self, request, form_url='', extra_context=None):\n                                        self.inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n-                if prefixes[prefix] != 1:\n+                if prefixes[prefix] != 1 or not prefix:\n                     prefix = \"%s-%s\" % (prefix, prefixes[prefix])\n                 formset = FormSet(instance=self.model(), prefix=prefix,\n                                   queryset=inline.queryset(request))\n@@ -1025,7 +1025,7 @@ def change_view(self, request, object_id, extra_context=None):\n                                        self.inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n-                if prefixes[prefix] != 1:\n+                if prefixes[prefix] != 1 or not prefix:\n                     prefix = \"%s-%s\" % (prefix, prefixes[prefix])\n                 formset = FormSet(request.POST, request.FILES,\n                                   instance=new_object, prefix=prefix,\n@@ -1046,7 +1046,7 @@ def change_view(self, request, object_id, extra_context=None):\n             for FormSet, inline in zip(self.get_formsets(request, obj), self.inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n-                if prefixes[prefix] != 1:\n+                if prefixes[prefix] != 1 or not prefix:\n                     prefix = \"%s-%s\" % (prefix, prefixes[prefix])\n                 formset = FormSet(instance=obj, prefix=prefix,\n                                   queryset=inline.queryset(request))"
        },
        {
            "sha": "4edd361d09c8a8710c71e6fa3f67ba24db14b3b2",
            "filename": "tests/regressiontests/admin_inlines/admin.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/09a01435de65989864d56a8bf74ff2d84e9c4bd5/tests%2Fregressiontests%2Fadmin_inlines%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/09a01435de65989864d56a8bf74ff2d84e9c4bd5/tests%2Fregressiontests%2Fadmin_inlines%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Fadmin.py?ref=09a01435de65989864d56a8bf74ff2d84e9c4bd5",
            "patch": "@@ -101,6 +101,14 @@ class NovelAdmin(admin.ModelAdmin):\n     inlines = [ChapterInline]\n \n \n+class ConsigliereInline(admin.TabularInline):\n+    model = Consigliere\n+\n+\n+class SottoCapoInline(admin.TabularInline):\n+    model = SottoCapo\n+\n+\n site.register(TitleCollection, inlines=[TitleInline])\n # Test bug #12561 and #12778\n # only ModelAdmin media\n@@ -115,3 +123,4 @@ class NovelAdmin(admin.ModelAdmin):\n site.register(Fashionista, inlines=[InlineWeakness])\n site.register(Holder4, Holder4Admin)\n site.register(Author, AuthorAdmin)\n+site.register(CapoFamiglia, inlines=[ConsigliereInline, SottoCapoInline])"
        },
        {
            "sha": "748280d8ab9b366ae2ac5d1a1bf65ac09b5b650d",
            "filename": "tests/regressiontests/admin_inlines/models.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/09a01435de65989864d56a8bf74ff2d84e9c4bd5/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/09a01435de65989864d56a8bf74ff2d84e9c4bd5/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py?ref=09a01435de65989864d56a8bf74ff2d84e9c4bd5",
            "patch": "@@ -122,3 +122,17 @@ class Novel(models.Model):\n class Chapter(models.Model):\n     novel = models.ForeignKey(Novel)\n \n+\n+# Models for #16838\n+class CapoFamiglia(models.Model):\n+    name = models.CharField(max_length=100)\n+\n+\n+class Consigliere(models.Model):\n+    name = models.CharField(max_length=100)\n+    capo_famiglia = models.ForeignKey(CapoFamiglia, related_name='+')\n+\n+\n+class SottoCapo(models.Model):\n+    name = models.CharField(max_length=100)\n+    capo_famiglia = models.ForeignKey(CapoFamiglia, related_name='+')"
        },
        {
            "sha": "955d6208de221971fb117a2bb0d4b8805fd7ba4a",
            "filename": "tests/regressiontests/admin_inlines/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/09a01435de65989864d56a8bf74ff2d84e9c4bd5/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/09a01435de65989864d56a8bf74ff2d84e9c4bd5/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py?ref=09a01435de65989864d56a8bf74ff2d84e9c4bd5",
            "patch": "@@ -4,7 +4,8 @@\n \n # local test models\n from models import (Holder, Inner, Holder2, Inner2, Holder3,\n-    Inner3, Person, OutfitItem, Fashionista, Teacher, Parent, Child)\n+    Inner3, Person, OutfitItem, Fashionista, Teacher, Parent, Child,\n+    CapoFamiglia, Consigliere, SottoCapo)\n from admin import InnerInline\n \n \n@@ -115,6 +116,32 @@ def test_help_text(self):\n         self.assertContains(response, '<p class=\"help\">Awesome stacked help text is awesome.</p>', 4)\n         self.assertContains(response, '<img src=\"/static/admin/img/icon-unknown.gif\" class=\"help help-tooltip\" width=\"10\" height=\"10\" alt=\"(Awesome tabular help text is awesome.)\" title=\"Awesome tabular help text is awesome.\" />', 1)\n \n+    def test_non_related_name_inline(self):\n+        \"\"\"\n+        Ensure that multiple inlines with related_name='+' have correct form\n+        prefixes. Bug #16838.\n+        \"\"\"\n+        response = self.client.get('/admin/admin_inlines/capofamiglia/add/')\n+\n+        self.assertContains(response,\n+                '<input type=\"hidden\" name=\"-1-0-id\" id=\"id_-1-0-id\" />')\n+        self.assertContains(response,\n+                '<input type=\"hidden\" name=\"-1-0-capo_famiglia\" '\n+                'id=\"id_-1-0-capo_famiglia\" />')\n+        self.assertContains(response,\n+                '<input id=\"id_-1-0-name\" type=\"text\" class=\"vTextField\" '\n+                'name=\"-1-0-name\" maxlength=\"100\" />')\n+\n+        self.assertContains(response,\n+                '<input type=\"hidden\" name=\"-2-0-id\" id=\"id_-2-0-id\" />')\n+        self.assertContains(response,\n+                '<input type=\"hidden\" name=\"-2-0-capo_famiglia\" '\n+                'id=\"id_-2-0-capo_famiglia\" />')\n+        self.assertContains(response,\n+                '<input id=\"id_-2-0-name\" type=\"text\" class=\"vTextField\" '\n+                'name=\"-2-0-name\" maxlength=\"100\" />')\n+\n+\n class TestInlineMedia(TestCase):\n     urls = \"regressiontests.admin_inlines.urls\"\n     fixtures = ['admin-views-users.xml']"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 55,
        "deletions": 5
    }
}