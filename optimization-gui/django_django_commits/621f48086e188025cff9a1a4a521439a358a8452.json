{
    "author": "carljm",
    "message": "Fixed #15118 - Corrected the deletion-ordering for inherited models.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15246 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "621f48086e188025cff9a1a4a521439a358a8452",
    "files": [
        {
            "sha": "6cd42701d9a415cf180c4dfecc84212abdb3320b",
            "filename": "django/db/models/deletion.py",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/621f48086e188025cff9a1a4a521439a358a8452/django%2Fdb%2Fmodels%2Fdeletion.py",
            "raw_url": "https://github.com/django/django/raw/621f48086e188025cff9a1a4a521439a358a8452/django%2Fdb%2Fmodels%2Fdeletion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fdeletion.py?ref=621f48086e188025cff9a1a4a521439a358a8452",
            "patch": "@@ -64,7 +64,7 @@ def __init__(self, using):\n         self.field_updates = {} # {model: {(field, value): set([instances])}}\n         self.dependencies = {} # {model: set([models])}\n \n-    def add(self, objs, source=None, nullable=False):\n+    def add(self, objs, source=None, nullable=False, reverse_dependency=False):\n         \"\"\"\n         Adds 'objs' to the collection of objects to be deleted.  If the call is\n         the result of a cascade, 'source' should be the model that caused it\n@@ -85,6 +85,8 @@ def add(self, objs, source=None, nullable=False):\n         # deleting, and therefore do not affect the order in which objects have\n         # to be deleted.\n         if new_objs and source is not None and not nullable:\n+            if reverse_dependency:\n+                source, model = model, source\n             self.dependencies.setdefault(source, set()).add(model)\n         return new_objs\n \n@@ -108,7 +110,7 @@ def add_field_update(self, field, value, objs):\n             (field, value), set()).update(objs)\n \n     def collect(self, objs, source=None, nullable=False, collect_related=True,\n-        source_attr=None):\n+        source_attr=None, reverse_dependency=False):\n         \"\"\"\n         Adds 'objs' to the collection of objects to be deleted as well as all\n         parent instances.  'objs' must be a homogenous iterable collection of\n@@ -118,9 +120,14 @@ def collect(self, objs, source=None, nullable=False, collect_related=True,\n         If the call is the result of a cascade, 'source' should be the model\n         that caused it and 'nullable' should be set to True, if the relation\n         can be null.\n-        \"\"\"\n \n-        new_objs = self.add(objs, source, nullable)\n+        If 'reverse_dependency' is True, 'source' will be deleted before the\n+        current model, rather than after. (Needed for cascading to parent\n+        models, the one case in which the cascade follows the forwards\n+        direction of an FK rather than the reverse direction.)\n+        \"\"\"\n+        new_objs = self.add(objs, source, nullable,\n+                            reverse_dependency=reverse_dependency)\n         if not new_objs:\n             return\n         model = new_objs[0].__class__\n@@ -132,7 +139,8 @@ def collect(self, objs, source=None, nullable=False, collect_related=True,\n                 parent_objs = [getattr(obj, ptr.name) for obj in new_objs]\n                 self.collect(parent_objs, source=model,\n                              source_attr=ptr.rel.related_name,\n-                             collect_related=False)\n+                             collect_related=False,\n+                             reverse_dependency=True)\n \n         if collect_related:\n             for related in model._meta.get_all_related_objects(include_hidden=True):"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 13,
        "deletions": 5
    }
}