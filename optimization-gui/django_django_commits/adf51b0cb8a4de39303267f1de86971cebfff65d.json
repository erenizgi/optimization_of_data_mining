{
    "author": "jphalip",
    "message": "Fixed #16574 -- Strengthened the `contrib.messages` tests' isolation to avoid failures under certain project setting environments. Thanks to Boldewyn for the report and to Claude Paroz for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17027 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "adf51b0cb8a4de39303267f1de86971cebfff65d",
    "files": [
        {
            "sha": "8d0453245ccea9336fe880f337020876ca372d47",
            "filename": "django/contrib/messages/tests/base.py",
            "status": "modified",
            "additions": 58,
            "deletions": 84,
            "changes": 142,
            "blob_url": "https://github.com/django/django/blob/adf51b0cb8a4de39303267f1de86971cebfff65d/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/adf51b0cb8a4de39303267f1de86971cebfff65d/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py?ref=adf51b0cb8a4de39303267f1de86971cebfff65d",
            "patch": "@@ -1,13 +1,14 @@\n from django import http\n-from django.test import TestCase\n from django.conf import settings\n-from django.utils.translation import ugettext_lazy\n-from django.utils.unittest import skipIf\n from django.contrib.messages import constants, utils, get_level, set_level\n from django.contrib.messages.api import MessageFailure\n from django.contrib.messages.storage import default_storage, base\n from django.contrib.messages.storage.base import Message\n from django.core.urlresolvers import reverse\n+from django.test import TestCase\n+from django.test.utils import override_settings\n+from django.utils.translation import ugettext_lazy\n+from django.utils.unittest import skipIf\n \n \n def skipUnlessAuthIsInstalled(func):\n@@ -29,9 +30,21 @@ def add_level_messages(storage):\n     storage.add(constants.SUCCESS, 'This was a triumph.')\n \n \n+class override_settings_tags(override_settings):\n+     def enable(self):\n+        super(override_settings_tags, self).enable()\n+        # LEVEL_TAGS is a constant defined in the\n+        # django.contrib.messages.storage.base module, so after changing\n+        # settings.MESSAGE_TAGS, we need to update that constant too.\n+        self.old_level_tags = base.LEVEL_TAGS\n+        base.LEVEL_TAGS = utils.get_level_tags()\n+     def disable(self):\n+        super(override_settings_tags, self).disable()\n+        base.LEVEL_TAGS = self.old_level_tags\n+\n+\n class BaseTest(TestCase):\n     storage_class = default_storage\n-    restore_settings = ['MESSAGE_LEVEL', 'MESSAGE_TAGS']\n     urls = 'django.contrib.messages.tests.urls'\n     levels = {\n         'debug': constants.DEBUG,\n@@ -42,39 +55,16 @@ class BaseTest(TestCase):\n     }\n \n     def setUp(self):\n-        self._remembered_settings = {}\n-        for setting in self.restore_settings:\n-            if hasattr(settings, setting):\n-                self._remembered_settings[setting] = getattr(settings, setting)\n-                delattr(settings._wrapped, setting)\n-        # Backup these manually because we do not want them deleted.\n-        self._middleware_classes = settings.MIDDLEWARE_CLASSES\n-        self._template_context_processors = \\\n-           settings.TEMPLATE_CONTEXT_PROCESSORS\n-        self._installed_apps = settings.INSTALLED_APPS\n-        self._message_storage = settings.MESSAGE_STORAGE\n-        settings.MESSAGE_STORAGE = '%s.%s' % (self.storage_class.__module__,\n-                                              self.storage_class.__name__)\n-        self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n-        settings.TEMPLATE_DIRS = ()\n+        self.settings_override = override_settings_tags(\n+            TEMPLATE_DIRS   = (),\n+            MESSAGE_TAGS    = '',\n+            MESSAGE_STORAGE = '%s.%s' % (self.storage_class.__module__,\n+                                         self.storage_class.__name__),\n+        )\n+        self.settings_override.enable()\n \n     def tearDown(self):\n-        for setting in self.restore_settings:\n-            self.restore_setting(setting)\n-        # Restore these manually (see above).\n-        settings.MIDDLEWARE_CLASSES = self._middleware_classes\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = \\\n-           self._template_context_processors\n-        settings.INSTALLED_APPS = self._installed_apps\n-        settings.MESSAGE_STORAGE = self._message_storage\n-        settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n-\n-    def restore_setting(self, setting):\n-        if setting in self._remembered_settings:\n-            value = self._remembered_settings.pop(setting)\n-            setattr(settings, setting, value)\n-        elif hasattr(settings, setting):\n-            delattr(settings._wrapped, setting)\n+        self.settings_override.disable()\n \n     def get_request(self):\n         return http.HttpRequest()\n@@ -153,13 +143,13 @@ def test_existing_read_add_update(self):\n         storing = self.stored_messages_count(storage, response)\n         self.assertEqual(storing, 1)\n \n+    @override_settings(MESSAGE_LEVEL=constants.DEBUG)\n     def test_full_request_response_cycle(self):\n         \"\"\"\n         With the message middleware enabled, tests that messages are properly\n         stored and then retrieved across the full request/redirect/response\n         cycle.\n         \"\"\"\n-        settings.MESSAGE_LEVEL = constants.DEBUG\n         data = {\n             'messages': ['Test message %d' % x for x in xrange(10)],\n         }\n@@ -176,8 +166,8 @@ def test_full_request_response_cycle(self):\n             for msg in data['messages']:\n                 self.assertContains(response, msg)\n \n+    @override_settings(MESSAGE_LEVEL=constants.DEBUG)\n     def test_with_template_response(self):\n-        settings.MESSAGE_LEVEL = constants.DEBUG\n         data = {\n             'messages': ['Test message %d' % x for x in xrange(10)],\n         }\n@@ -196,12 +186,12 @@ def test_with_template_response(self):\n             for msg in data['messages']:\n                 self.assertNotContains(response, msg)\n \n+    @override_settings(MESSAGE_LEVEL=constants.DEBUG)\n     def test_multiple_posts(self):\n         \"\"\"\n         Tests that messages persist properly when multiple POSTs are made\n         before a GET.\n         \"\"\"\n-        settings.MESSAGE_LEVEL = constants.DEBUG\n         data = {\n             'messages': ['Test message %d' % x for x in xrange(10)],\n         }\n@@ -219,25 +209,21 @@ def test_multiple_posts(self):\n         for msg in data['messages']:\n             self.assertContains(response, msg)\n \n+    @override_settings(\n+        INSTALLED_APPS=filter(\n+            lambda app:app!='django.contrib.messages', settings.INSTALLED_APPS),\n+        MIDDLEWARE_CLASSES=filter(\n+            lambda m:'MessageMiddleware' not in m, settings.MIDDLEWARE_CLASSES),\n+        TEMPLATE_CONTEXT_PROCESSORS=filter(\n+            lambda p:'context_processors.messages' not in p,\n+                 settings.TEMPLATE_CONTEXT_PROCESSORS),\n+        MESSAGE_LEVEL=constants.DEBUG\n+    )\n     def test_middleware_disabled(self):\n         \"\"\"\n         Tests that, when the middleware is disabled, an exception is raised\n         when one attempts to store a message.\n         \"\"\"\n-        settings.MESSAGE_LEVEL = constants.DEBUG\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS)\n-        settings.INSTALLED_APPS.remove(\n-            'django.contrib.messages',\n-        )\n-        settings.MIDDLEWARE_CLASSES = list(settings.MIDDLEWARE_CLASSES)\n-        settings.MIDDLEWARE_CLASSES.remove(\n-            'django.contrib.messages.middleware.MessageMiddleware',\n-        )\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = \\\n-          list(settings.TEMPLATE_CONTEXT_PROCESSORS)\n-        settings.TEMPLATE_CONTEXT_PROCESSORS.remove(\n-            'django.contrib.messages.context_processors.messages',\n-        )\n         data = {\n             'messages': ['Test message %d' % x for x in xrange(10)],\n         }\n@@ -248,25 +234,21 @@ def test_middleware_disabled(self):\n             self.assertRaises(MessageFailure, self.client.post, add_url,\n                               data, follow=True)\n \n+    @override_settings(\n+        INSTALLED_APPS=filter(\n+            lambda app:app!='django.contrib.messages', settings.INSTALLED_APPS),\n+        MIDDLEWARE_CLASSES=filter(\n+            lambda m:'MessageMiddleware' not in m, settings.MIDDLEWARE_CLASSES),\n+        TEMPLATE_CONTEXT_PROCESSORS=filter(\n+            lambda p:'context_processors.messages' not in p,\n+                 settings.TEMPLATE_CONTEXT_PROCESSORS),\n+        MESSAGE_LEVEL=constants.DEBUG\n+    )\n     def test_middleware_disabled_fail_silently(self):\n         \"\"\"\n         Tests that, when the middleware is disabled, an exception is not\n         raised if 'fail_silently' = True\n         \"\"\"\n-        settings.MESSAGE_LEVEL = constants.DEBUG\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS)\n-        settings.INSTALLED_APPS.remove(\n-            'django.contrib.messages',\n-        )\n-        settings.MIDDLEWARE_CLASSES = list(settings.MIDDLEWARE_CLASSES)\n-        settings.MIDDLEWARE_CLASSES.remove(\n-            'django.contrib.messages.middleware.MessageMiddleware',\n-        )\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = \\\n-          list(settings.TEMPLATE_CONTEXT_PROCESSORS)\n-        settings.TEMPLATE_CONTEXT_PROCESSORS.remove(\n-            'django.contrib.messages.context_processors.messages',\n-        )\n         data = {\n             'messages': ['Test message %d' % x for x in xrange(10)],\n             'fail_silently': True,\n@@ -350,11 +332,11 @@ def test_high_level(self):\n         add_level_messages(storage)\n         self.assertEqual(len(storage), 2)\n \n+    @override_settings(MESSAGE_LEVEL=29)\n     def test_settings_level(self):\n         request = self.get_request()\n         storage = self.storage_class(request)\n \n-        settings.MESSAGE_LEVEL = 29\n         self.assertEqual(get_level(request), 29)\n \n         add_level_messages(storage)\n@@ -369,26 +351,18 @@ def test_tags(self):\n                          ['info', '', 'extra-tag debug', 'warning', 'error',\n                           'success'])\n \n-    def test_custom_tags(self):\n-        settings.MESSAGE_TAGS = {\n+    @override_settings_tags(MESSAGE_TAGS={\n             constants.INFO: 'info',\n             constants.DEBUG: '',\n             constants.WARNING: '',\n             constants.ERROR: 'bad',\n             29: 'custom',\n         }\n-        # LEVEL_TAGS is a constant defined in the\n-        # django.contrib.messages.storage.base module, so after changing\n-        # settings.MESSAGE_TAGS, we need to update that constant too.\n-        base.LEVEL_TAGS = utils.get_level_tags()\n-        try:\n-            storage = self.get_storage()\n-            storage.level = 0\n-            add_level_messages(storage)\n-            tags = [msg.tags for msg in storage]\n-            self.assertEqual(tags,\n-                         ['info', 'custom', 'extra-tag', '', 'bad', 'success'])\n-        finally:\n-            # Ensure the level tags constant is put back like we found it.\n-            self.restore_setting('MESSAGE_TAGS')\n-            base.LEVEL_TAGS = utils.get_level_tags()\n+    )\n+    def test_custom_tags(self):\n+        storage = self.get_storage()\n+        storage.level = 0\n+        add_level_messages(storage)\n+        tags = [msg.tags for msg in storage]\n+        self.assertEqual(tags,\n+                     ['info', 'custom', 'extra-tag', '', 'bad', 'success'])"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 58,
        "deletions": 84
    }
}