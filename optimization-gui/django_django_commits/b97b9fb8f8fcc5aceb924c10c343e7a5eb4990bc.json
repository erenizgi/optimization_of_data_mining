{
    "author": "spookylukey",
    "message": "Fixed #15493 - csrf_migration_helper.py parsing fix.\n\nThanks to 'john' for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15647 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b97b9fb8f8fcc5aceb924c10c343e7a5eb4990bc",
    "files": [
        {
            "sha": "6aaf6b433da3e3ad9a8c3ac5834bd709d342227e",
            "filename": "extras/csrf_migration_helper.py",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/b97b9fb8f8fcc5aceb924c10c343e7a5eb4990bc/extras%2Fcsrf_migration_helper.py",
            "raw_url": "https://github.com/django/django/raw/b97b9fb8f8fcc5aceb924c10c343e7a5eb4990bc/extras%2Fcsrf_migration_helper.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/extras%2Fcsrf_migration_helper.py?ref=b97b9fb8f8fcc5aceb924c10c343e7a5eb4990bc",
            "patch": "@@ -41,10 +41,6 @@\n #   loaders are out of the picture, because there is no way to ask them to\n #   return all templates.\n #\n-# - If you put the {% csrf_token %} tag on the same line as the <form> tag it\n-#   will be detected, otherwise it will be assumed that the form does not have\n-#   the token.\n-#\n # - It's impossible to programmatically determine which forms should and should\n #   not have the token added.  The developer must decide when to do this,\n #   ensuring that the token is only added to internally targetted forms.\n@@ -138,6 +134,7 @@\n \n _POST_FORM_RE = \\\n     re.compile(r'(<form\\W[^>]*\\bmethod\\s*=\\s*(\\'|\"|)POST(\\'|\"|)\\b[^>]*>)', re.IGNORECASE)\n+_FORM_CLOSE_RE = re.compile(r'</form\\s*>')\n _TOKEN_RE = re.compile('\\{% csrf_token')\n \n def get_template_dirs():\n@@ -190,12 +187,22 @@ def post_form_info(self):\n         Get information about any POST forms in the template.\n         Returns [(linenumber, csrf_token added)]\n         \"\"\"\n-        matches = []\n+        forms = {}\n+        form_line = 0\n         for ln, line in enumerate(self.content.split(\"\\n\")):\n-            m = _POST_FORM_RE.search(line)\n-            if m is not None:\n-                matches.append((ln + 1, _TOKEN_RE.search(line) is not None))\n-        return matches\n+            if not form_line and _POST_FORM_RE.search(line):\n+                # record the form with no CSRF token yet\n+                form_line = ln + 1\n+                forms[form_line] = False\n+            if form_line and _TOKEN_RE.search(line):\n+                # found the CSRF token\n+                forms[form_line] = True\n+                form_line = 0\n+            if form_line and _FORM_CLOSE_RE.search(line):\n+                # no token found by form closing tag\n+                form_line = 0\n+\n+        return forms.items()\n \n     def includes_template(self, t):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 25,
        "additions": 16,
        "deletions": 9
    }
}