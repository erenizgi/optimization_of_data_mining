{
    "author": "spookylukey",
    "message": "Fixed #15929 - test.client.RequestFactory keeps state/AuthMiddleware does monkey patching\n\nThanks to m.vantellingen for the report and tests, and to aaugustin for\nwork on the tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16297 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "dc4c2f3add4f15edf05574e6e8eb101be9da4b90",
    "files": [
        {
            "sha": "2c19a4e84063b83a4893076e6a0c1da5113b6df5",
            "filename": "django/contrib/auth/middleware.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/dc4c2f3add4f15edf05574e6e8eb101be9da4b90/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/dc4c2f3add4f15edf05574e6e8eb101be9da4b90/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmiddleware.py?ref=dc4c2f3add4f15edf05574e6e8eb101be9da4b90",
            "patch": "@@ -13,7 +13,13 @@ def __get__(self, request, obj_type=None):\n class AuthenticationMiddleware(object):\n     def process_request(self, request):\n         assert hasattr(request, 'session'), \"The Django authentication middleware requires session middleware to be installed. Edit your MIDDLEWARE_CLASSES setting to insert 'django.contrib.sessions.middleware.SessionMiddleware'.\"\n-        request.__class__.user = LazyUser()\n+\n+        # We dynamically subclass request.__class__ rather than monkey patch the\n+        # original class.\n+        class RequestWithUser(request.__class__):\n+            user = LazyUser()\n+\n+        request.__class__ = RequestWithUser\n         return None\n \n "
        },
        {
            "sha": "8b47fe2e5b93d32f3608fa9f0f2a5b6321f4b0ce",
            "filename": "tests/regressiontests/test_client_regress/models.py",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/dc4c2f3add4f15edf05574e6e8eb101be9da4b90/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/dc4c2f3add4f15edf05574e6e8eb101be9da4b90/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py?ref=dc4c2f3add4f15edf05574e6e8eb101be9da4b90",
            "patch": "@@ -12,7 +12,7 @@\n     Context, Template, loader)\n import django.template.context\n from django.test import Client, TestCase\n-from django.test.client import encode_file\n+from django.test.client import encode_file, RequestFactory\n from django.test.utils import ContextList\n \n \n@@ -908,3 +908,32 @@ def test_raw_post_data(self):\n             response = self.client.get(\"/test_client_regress/raw_post_data/\")\n         except AssertionError:\n             self.fail(\"Accessing request.raw_post_data from a view fetched with GET by the test client shouldn't fail.\")\n+\n+\n+class RequestFactoryStateTest(TestCase):\n+    \"\"\"Regression tests for #15929.\"\"\"\n+    # These tests are checking that certain middleware don't change certain\n+    # global state. Alternatively, from the point of view of a test, they are\n+    # ensuring test isolation behaviour. So, unusually, it doesn't make sense to\n+    # run the tests individually, and if any are failing it is confusing to run\n+    # them with any other set of tests.\n+\n+    def setUp(self):\n+        self.factory = RequestFactory()\n+\n+    def common_test_that_should_always_pass(self):\n+        request = self.factory.get('/')\n+        request.session = {}\n+        self.assertFalse(hasattr(request, 'user'))\n+\n+    def test_request(self):\n+        self.common_test_that_should_always_pass()\n+\n+    def test_request_after_client(self):\n+        # apart from the next line the three tests are identical\n+        self.client.get('/')\n+        self.common_test_that_should_always_pass()\n+\n+    def test_request_after_client_2(self):\n+        # This test is executed after the previous one\n+        self.common_test_that_should_always_pass()"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 37,
        "deletions": 2
    }
}