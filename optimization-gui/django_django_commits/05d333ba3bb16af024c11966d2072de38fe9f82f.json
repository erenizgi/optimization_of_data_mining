{
    "author": "claudep",
    "message": "Fixed #18515 -- Conditionally regenerated filename in FileField validation\n\nWhen a FileField value has been saved, a new validation should not\nregenerate a new filename when checking the length. Refs #9893.",
    "sha": "05d333ba3bb16af024c11966d2072de38fe9f82f",
    "files": [
        {
            "sha": "b0dce381a61ae7a719becdd38557a65f989b9e15",
            "filename": "django/db/models/fields/files.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/05d333ba3bb16af024c11966d2072de38fe9f82f/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py",
            "raw_url": "https://github.com/django/django/raw/05d333ba3bb16af024c11966d2072de38fe9f82f/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py?ref=05d333ba3bb16af024c11966d2072de38fe9f82f",
            "patch": "@@ -242,7 +242,11 @@ def validate(self, value, model_instance):\n         # (ie. upload_to='path/to/upload/dir'), the length of the generated\n         # name equals the length of the uploaded name plus a constant. Thus\n         # we can tell the user how much shorter the name should be (roughly).\n-        length = len(self.generate_filename(model_instance, value.name))\n+        if value and value._committed:\n+            filename = value.name\n+        else:\n+            filename = self.generate_filename(model_instance, value.name)\n+        length = len(filename)\n         if self.max_length and length > self.max_length:\n             error_values = {'extra': length - self.max_length}\n             raise ValidationError(self.error_messages['max_length'] % error_values)"
        },
        {
            "sha": "cefc7c7244a654a318dc5698ba200986cf06e284",
            "filename": "tests/modeltests/files/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/05d333ba3bb16af024c11966d2072de38fe9f82f/tests%2Fmodeltests%2Ffiles%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/05d333ba3bb16af024c11966d2072de38fe9f82f/tests%2Fmodeltests%2Ffiles%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ffiles%2Fmodels.py?ref=05d333ba3bb16af024c11966d2072de38fe9f82f",
            "patch": "@@ -26,5 +26,5 @@ def random_upload_to(self, filename):\n \n     normal = models.FileField(storage=temp_storage, upload_to='tests')\n     custom = models.FileField(storage=temp_storage, upload_to=custom_upload_to)\n-    random = models.FileField(storage=temp_storage, upload_to=random_upload_to)\n+    random = models.FileField(storage=temp_storage, upload_to=random_upload_to, max_length=16)\n     default = models.FileField(storage=temp_storage, upload_to='tests', default='tests/default.txt')"
        },
        {
            "sha": "565d4c8942334b34f7a25c2ccf45415dd644e532",
            "filename": "tests/modeltests/files/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/05d333ba3bb16af024c11966d2072de38fe9f82f/tests%2Fmodeltests%2Ffiles%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/05d333ba3bb16af024c11966d2072de38fe9f82f/tests%2Fmodeltests%2Ffiles%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ffiles%2Ftests.py?ref=05d333ba3bb16af024c11966d2072de38fe9f82f",
            "patch": "@@ -5,6 +5,7 @@\n import tempfile\n \n from django.core.cache import cache\n+from django.core.exceptions import ValidationError\n from django.core.files import File\n from django.core.files.base import ContentFile\n from django.core.files.uploadedfile import SimpleUploadedFile\n@@ -102,11 +103,23 @@ def test_files(self):\n         obj4.random.save(\"random_file\", ContentFile(b\"random content\"))\n         self.assertTrue(obj4.random.name.endswith(\"/random_file\"))\n \n-        # Clean up the temporary files and dir.\n-        obj1.normal.delete()\n-        obj2.normal.delete()\n-        obj3.default.delete()\n-        obj4.random.delete()\n+    def test_max_length(self):\n+        \"\"\"\n+        Test that FileField validates the length of the generated file name\n+        that will be stored in the database. Regression for #9893.\n+        \"\"\"\n+        # upload_to = 'unused', so file names are saved as '456/xxxxx'.\n+        # max_length = 16, so names longer than 12 characters are rejected.\n+        s1 = Storage(random=SimpleUploadedFile(12 * 'x', b\"content\"))\n+        s1.full_clean()\n+        with self.assertRaises(ValidationError):\n+            Storage(random=SimpleUploadedFile(13 * 'x', b\"content\")).full_clean()\n+\n+        # Ticket #18515: validation for an already saved file should not check\n+        # against a regenerated file name (and potentially raise a ValidationError\n+        # if max_length is exceeded\n+        s1.save()\n+        s1.full_clean()\n \n \n class FileTests(unittest.TestCase):"
        },
        {
            "sha": "a89ffcae320e603960c10a89d76ad35f606ba535",
            "filename": "tests/regressiontests/model_fields/tests.py",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/05d333ba3bb16af024c11966d2072de38fe9f82f/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/05d333ba3bb16af024c11966d2072de38fe9f82f/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py?ref=05d333ba3bb16af024c11966d2072de38fe9f82f",
            "patch": "@@ -365,15 +365,3 @@ def test_changed(self):\n         field = d._meta.get_field('myfile')\n         field.save_form_data(d, 'else.txt')\n         self.assertEqual(d.myfile, 'else.txt')\n-\n-    def test_max_length(self):\n-        \"\"\"\n-        Test that FileField validates the length of the generated file name\n-        that will be stored in the database. Regression for #9893.\n-\n-        \"\"\"\n-        # upload_to = 'unused', so file names are saved as 'unused/xxxxx'.\n-        # max_length = 100, so names longer than 93 characters are rejected.\n-        Document(myfile=93 * 'x').full_clean()\n-        with self.assertRaises(ValidationError):\n-            Document(myfile=94 * 'x').full_clean()"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 24,
        "deletions": 19
    }
}