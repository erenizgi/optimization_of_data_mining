{
    "author": "aaugustin",
    "message": "Avoided closing the database connection within a transaction.\n\nRefs #9437.",
    "sha": "f2f98abb955c83eca3ceea62d1711c80ae028d33",
    "files": [
        {
            "sha": "4d31bbb53c683212def6959a9fb3c779e85ab2bb",
            "filename": "django/contrib/gis/db/backends/postgis/operations.py",
            "status": "modified",
            "additions": 4,
            "deletions": 12,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/f2f98abb955c83eca3ceea62d1711c80ae028d33/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/f2f98abb955c83eca3ceea62d1711c80ae028d33/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py?ref=f2f98abb955c83eca3ceea62d1711c80ae028d33",
            "patch": "@@ -402,18 +402,10 @@ def _get_postgis_func(self, func):\n         \"\"\"\n         Helper routine for calling PostGIS functions and returning their result.\n         \"\"\"\n-        cursor = self.connection._cursor()\n-        try:\n-            try:\n-                cursor.execute('SELECT %s()' % func)\n-                row = cursor.fetchone()\n-            except:\n-                # Responsibility of callers to perform error handling.\n-                raise\n-        finally:\n-            # Close out the connection.  See #9437.\n-            self.connection.close()\n-        return row[0]\n+        # Close out the connection.  See #9437.\n+        with self.connection.temporary_connection() as cursor:\n+            cursor.execute('SELECT %s()' % func)\n+            return cursor.fetchone()[0]\n \n     def postgis_geos_version(self):\n         \"Returns the version of the GEOS library used with PostGIS.\""
        },
        {
            "sha": "c797a507336b25110386273ab5395f732e55081d",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f2f98abb955c83eca3ceea62d1711c80ae028d33/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f2f98abb955c83eca3ceea62d1711c80ae028d33/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=f2f98abb955c83eca3ceea62d1711c80ae028d33",
            "patch": "@@ -472,11 +472,13 @@ def temporary_connection(self):\n         Context manager that ensures that a connection is established, and\n         if it opened one, closes it to avoid leaving a dangling connection.\n         This is useful for operations outside of the request-response cycle.\n+\n+        Provides a cursor: with self.temporary_connection() as cursor: ...\n         \"\"\"\n         must_close = self.connection is None\n         cursor = self.cursor()\n         try:\n-            yield\n+            yield cursor\n         finally:\n             cursor.close()\n             if must_close:"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 7,
        "deletions": 13
    }
}