{
    "author": "jezdez",
    "message": "Fixed #16966 -- Stopped CachedStaticFilesStorage from choking on querystrings and path fragments.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17068 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a82488bf4b57c1bc917f8ed79eac7a99d5e26bff",
    "files": [
        {
            "sha": "8353889e824a11faa0ca7f4a1bb0b27bc8ebc6e4",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/a82488bf4b57c1bc917f8ed79eac7a99d5e26bff/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/a82488bf4b57c1bc917f8ed79eac7a99d5e26bff/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=a82488bf4b57c1bc917f8ed79eac7a99d5e26bff",
            "patch": "@@ -3,6 +3,8 @@\n import os\n import posixpath\n import re\n+from urllib import unquote\n+from urlparse import urlsplit, urlunsplit\n \n from django.conf import settings\n from django.core.cache import (get_cache, InvalidCacheBackendError,\n@@ -64,23 +66,28 @@ def __init__(self, *args, **kwargs):\n                 self._patterns.setdefault(extension, []).append(compiled)\n \n     def hashed_name(self, name, content=None):\n+        parsed_name = urlsplit(unquote(name))\n+        clean_name = parsed_name.path\n         if content is None:\n-            if not self.exists(name):\n+            if not self.exists(clean_name):\n                 raise ValueError(\"The file '%s' could not be found with %r.\" %\n-                                 (name, self))\n+                                 (clean_name, self))\n             try:\n-                content = self.open(name)\n+                content = self.open(clean_name)\n             except IOError:\n                 # Handle directory paths\n                 return name\n-        path, filename = os.path.split(name)\n+        path, filename = os.path.split(clean_name)\n         root, ext = os.path.splitext(filename)\n         # Get the MD5 hash of the file\n         md5 = hashlib.md5()\n         for chunk in content.chunks():\n             md5.update(chunk)\n         md5sum = md5.hexdigest()[:12]\n-        return os.path.join(path, u\"%s.%s%s\" % (root, md5sum, ext))\n+        hashed_name = os.path.join(path, u\"%s.%s%s\" % (root, md5sum, ext))\n+        unparsed_name = list(parsed_name)\n+        unparsed_name[2] = hashed_name\n+        return urlunsplit(unparsed_name)\n \n     def cache_key(self, name):\n         return u'staticfiles:cache:%s' % name\n@@ -98,7 +105,7 @@ def url(self, name, force=False):\n                 hashed_name = self.hashed_name(name)\n                 # set the cache if there was a miss (e.g. if cache server goes down)\n                 self.cache.set(cache_key, hashed_name)\n-        return super(CachedFilesMixin, self).url(hashed_name)\n+        return unquote(super(CachedFilesMixin, self).url(hashed_name))\n \n     def url_converter(self, name):\n         \"\"\"\n@@ -132,9 +139,9 @@ def converter(matchobj):\n                 else:\n                     start, end = 1, sub_level - 1\n             joined_result = '/'.join(name_parts[:-start] + url_parts[end:])\n-            hashed_url = self.url(joined_result, force=True)\n+            hashed_url = self.url(unquote(joined_result), force=True)\n             # Return the hashed and normalized version to the file\n-            return 'url(\"%s\")' % hashed_url\n+            return 'url(\"%s\")' % unquote(hashed_url)\n         return converter\n \n     def post_process(self, paths, dry_run=False, **options):"
        },
        {
            "sha": "95d1f4abb8679945de5edf6deb3b31142d397b25",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/relative.css",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a82488bf4b57c1bc917f8ed79eac7a99d5e26bff/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css",
            "raw_url": "https://github.com/django/django/raw/a82488bf4b57c1bc917f8ed79eac7a99d5e26bff/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css?ref=a82488bf4b57c1bc917f8ed79eac7a99d5e26bff",
            "patch": "@@ -1,5 +1,6 @@\n @import url(\"../cached/styles.css\");\n @import url(\"absolute.css\");\n+@import url(\"absolute.css#eggs\");\n body {\n     background: #d3d6d8 url(img/relative.png);\n }\n\\ No newline at end of file"
        },
        {
            "sha": "652ddbd2b2badaec4387d4b54e3e1087b97e76a4",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 61,
            "deletions": 44,
            "changes": 105,
            "blob_url": "https://github.com/django/django/blob/a82488bf4b57c1bc917f8ed79eac7a99d5e26bff/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a82488bf4b57c1bc917f8ed79eac7a99d5e26bff/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=a82488bf4b57c1bc917f8ed79eac7a99d5e26bff",
            "patch": "@@ -61,7 +61,7 @@ def setUp(self):\n         self.addCleanup(os.unlink, _nonascii_filepath)\n \n     def assertFileContains(self, filepath, text):\n-        self.assertTrue(text in self._get_file(smart_unicode(filepath)),\n+        self.assertIn(text, self._get_file(smart_unicode(filepath)),\n                         u\"'%s' not in '%s'\" % (text, filepath))\n \n     def assertFileNotFound(self, filepath):\n@@ -72,11 +72,15 @@ def render_template(self, template, **kwargs):\n             template = loader.get_template_from_string(template)\n         return template.render(Context(kwargs)).strip()\n \n-    def assertTemplateRenders(self, template, result, **kwargs):\n+    def static_template_snippet(self, path):\n+        return \"{%% load static from staticfiles %%}{%% static '%s' %%}\" % path\n+\n+    def assertStaticRenders(self, path, result, **kwargs):\n+        template = self.static_template_snippet(path)\n         self.assertEqual(self.render_template(template, **kwargs), result)\n \n-    def assertTemplateRaises(self, exc, template, result, **kwargs):\n-        self.assertRaises(exc, self.assertTemplateRenders, template, result, **kwargs)\n+    def assertStaticRaises(self, exc, path, result, **kwargs):\n+        self.assertRaises(exc, self.assertStaticRenders, path, result, **kwargs)\n \n \n class StaticFilesTestCase(BaseStaticFilesTestCase, TestCase):\n@@ -99,8 +103,8 @@ def setUp(self):\n         settings.STATIC_ROOT = tempfile.mkdtemp()\n         self.run_collectstatic()\n         # Use our own error handler that can handle .svn dirs on Windows\n-        self.addCleanup(shutil.rmtree, settings.STATIC_ROOT,\n-                        ignore_errors=True, onerror=rmtree_errorhandler)\n+        #self.addCleanup(shutil.rmtree, settings.STATIC_ROOT,\n+        #                ignore_errors=True, onerror=rmtree_errorhandler)\n \n     def tearDown(self):\n         settings.STATIC_ROOT = self.old_root\n@@ -194,8 +198,8 @@ def test_all_files(self):\n         finally:\n             sys.stdout = _stdout\n         self.assertEqual(len(lines), 3)  # three because there is also the \"Found <file> here\" line\n-        self.assertTrue('project' in lines[1])\n-        self.assertTrue('apps' in lines[2])\n+        self.assertIn('project', lines[1])\n+        self.assertIn('apps', lines[2])\n \n \n class TestCollection(CollectionTestCase, TestDefaults):\n@@ -284,73 +288,90 @@ class TestCollectionCachedStorage(BaseCollectionTestCase,\n     \"\"\"\n     Tests for the Cache busting storage\n     \"\"\"\n-    def cached_file_path(self, relpath):\n-        template = \"{%% load static from staticfiles %%}{%% static '%s' %%}\"\n-        fullpath = self.render_template(template % relpath)\n+    def cached_file_path(self, path):\n+        fullpath = self.render_template(self.static_template_snippet(path))\n         return fullpath.replace(settings.STATIC_URL, '')\n \n     def test_template_tag_return(self):\n         \"\"\"\n         Test the CachedStaticFilesStorage backend.\n         \"\"\"\n-        self.assertTemplateRaises(ValueError, \"\"\"\n-            {% load static from staticfiles %}{% static \"does/not/exist.png\" %}\n-            \"\"\", \"/static/does/not/exist.png\")\n-        self.assertTemplateRenders(\"\"\"\n-            {% load static from staticfiles %}{% static \"test/file.txt\" %}\n-            \"\"\", \"/static/test/file.dad0999e4f8f.txt\")\n-        self.assertTemplateRenders(\"\"\"\n-            {% load static from staticfiles %}{% static \"cached/styles.css\" %}\n-            \"\"\", \"/static/cached/styles.93b1147e8552.css\")\n+        self.assertStaticRaises(ValueError,\n+                                \"does/not/exist.png\",\n+                                \"/static/does/not/exist.png\")\n+        self.assertStaticRenders(\"test/file.txt\",\n+                                 \"/static/test/file.dad0999e4f8f.txt\")\n+        self.assertStaticRenders(\"cached/styles.css\",\n+                                 \"/static/cached/styles.93b1147e8552.css\")\n \n     def test_template_tag_simple_content(self):\n         relpath = self.cached_file_path(\"cached/styles.css\")\n         self.assertEqual(relpath, \"cached/styles.93b1147e8552.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n-            self.assertFalse(\"cached/other.css\" in content, content)\n-            self.assertTrue(\"/static/cached/other.d41d8cd98f00.css\" in content)\n+            self.assertNotIn(\"cached/other.css\", content)\n+            self.assertIn(\"/static/cached/other.d41d8cd98f00.css\", content)\n+\n+    def test_path_with_querystring(self):\n+        relpath = self.cached_file_path(\"cached/styles.css?spam=eggs\")\n+        self.assertEqual(relpath,\n+                         \"cached/styles.93b1147e8552.css?spam=eggs\")\n+        with storage.staticfiles_storage.open(\n+                \"cached/styles.93b1147e8552.css\") as relfile:\n+            content = relfile.read()\n+            self.assertNotIn(\"cached/other.css\", content)\n+            self.assertIn(\"/static/cached/other.d41d8cd98f00.css\", content)\n+\n+    def test_path_with_fragment(self):\n+        relpath = self.cached_file_path(\"cached/styles.css#eggs\")\n+        self.assertEqual(relpath, \"cached/styles.93b1147e8552.css#eggs\")\n+        with storage.staticfiles_storage.open(\n+                \"cached/styles.93b1147e8552.css\") as relfile:\n+            content = relfile.read()\n+            self.assertNotIn(\"cached/other.css\", content)\n+            self.assertIn(\"/static/cached/other.d41d8cd98f00.css\", content)\n \n     def test_template_tag_absolute(self):\n         relpath = self.cached_file_path(\"cached/absolute.css\")\n         self.assertEqual(relpath, \"cached/absolute.cc80cb5e2eb1.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n-            self.assertFalse(\"/static/cached/styles.css\" in content)\n-            self.assertTrue(\"/static/cached/styles.93b1147e8552.css\" in content)\n+            self.assertNotIn(\"/static/cached/styles.css\", content)\n+            self.assertIn(\"/static/cached/styles.93b1147e8552.css\", content)\n \n     def test_template_tag_denorm(self):\n         relpath = self.cached_file_path(\"cached/denorm.css\")\n         self.assertEqual(relpath, \"cached/denorm.363de96e9b4b.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n-            self.assertFalse(\"..//cached///styles.css\" in content)\n-            self.assertTrue(\"/static/cached/styles.93b1147e8552.css\" in content)\n+            self.assertNotIn(\"..//cached///styles.css\", content)\n+            self.assertIn(\"/static/cached/styles.93b1147e8552.css\", content)\n \n     def test_template_tag_relative(self):\n         relpath = self.cached_file_path(\"cached/relative.css\")\n-        self.assertEqual(relpath, \"cached/relative.8dffb45d91f5.css\")\n+        self.assertEqual(relpath, \"cached/relative.2217ea7273c2.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n-            self.assertFalse(\"../cached/styles.css\" in content)\n-            self.assertFalse('@import \"styles.css\"' in content)\n-            self.assertTrue(\"/static/cached/styles.93b1147e8552.css\" in content)\n-            self.assertFalse(\"url(img/relative.png)\" in content)\n-            self.assertTrue(\"/static/cached/img/relative.acae32e4532b.png\" in content)\n+            self.assertNotIn(\"../cached/styles.css\", content)\n+            self.assertNotIn('@import \"styles.css\"', content)\n+            self.assertIn(\"/static/cached/styles.93b1147e8552.css\", content)\n+            self.assertNotIn(\"url(img/relative.png)\", content)\n+            self.assertIn(\"/static/cached/img/relative.acae32e4532b.png\", content)\n+            self.assertIn(\"/static/cached/absolute.cc80cb5e2eb1.css#eggs\", content)\n \n     def test_template_tag_deep_relative(self):\n         relpath = self.cached_file_path(\"cached/css/window.css\")\n         self.assertEqual(relpath, \"cached/css/window.9db38d5169f3.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n-            self.assertFalse('url(img/window.png)' in content)\n-            self.assertTrue('url(\"/static/cached/css/img/window.acae32e4532b.png\")' in content)\n+            self.assertNotIn('url(img/window.png)', content)\n+            self.assertIn('url(\"/static/cached/css/img/window.acae32e4532b.png\")', content)\n \n     def test_template_tag_url(self):\n         relpath = self.cached_file_path(\"cached/url.css\")\n         self.assertEqual(relpath, \"cached/url.615e21601e4b.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n-            self.assertTrue(\"https://\" in relfile.read())\n+            self.assertIn(\"https://\", relfile.read())\n \n     def test_cache_invalidation(self):\n         name = \"cached/styles.css\"\n@@ -367,7 +388,6 @@ def test_cache_invalidation(self):\n         cached_name = storage.staticfiles_storage.cache.get(cache_key)\n         self.assertEqual(cached_name, hashed_name)\n \n-\n # we set DEBUG to False here since the template tag wouldn't work otherwise\n TestCollectionCachedStorage = override_settings(**dict(TEST_SETTINGS,\n     STATICFILES_STORAGE='django.contrib.staticfiles.storage.CachedStaticFilesStorage',\n@@ -517,9 +537,9 @@ def setUp(self):\n         default_storage._wrapped = empty\n \n     def test_get_finder(self):\n-        self.assertTrue(isinstance(finders.get_finder(\n+        self.assertIsInstance(finders.get_finder(\n             'django.contrib.staticfiles.finders.FileSystemFinder'),\n-            finders.FileSystemFinder))\n+            finders.FileSystemFinder)\n \n     def test_get_finder_bad_classname(self):\n         self.assertRaises(ImproperlyConfigured, finders.get_finder,\n@@ -545,9 +565,6 @@ def test_location_empty(self):\n class TestTemplateTag(StaticFilesTestCase):\n \n     def test_template_tag(self):\n-        self.assertTemplateRenders(\"\"\"\n-            {% load static from staticfiles %}{% static \"does/not/exist.png\" %}\n-            \"\"\", \"/static/does/not/exist.png\")\n-        self.assertTemplateRenders(\"\"\"\n-            {% load static from staticfiles %}{% static \"testfile.txt\" %}\n-            \"\"\", \"/static/testfile.txt\")\n+        self.assertStaticRenders(\"does/not/exist.png\",\n+                                   \"/static/does/not/exist.png\")\n+        self.assertStaticRenders(\"testfile.txt\", \"/static/testfile.txt\")"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 77,
        "deletions": 52
    }
}