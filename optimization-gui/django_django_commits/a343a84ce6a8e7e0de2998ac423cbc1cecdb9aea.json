{
    "author": "jphalip",
    "message": "Added the `wait_until()` and `wait_loaded_tag()` methods to `AdminSeleniumWebDriverTestCase` to prevent some concurrency issues with in-memory SQLite database access in the admin Selenium tests. Thanks to Florian Apolloner, Anssi Kääriäinen and Aymeric Augustin for their help debugging this problem.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17283 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea",
    "files": [
        {
            "sha": "1cb5e8b6a466ffbe3439b6a5208379f7e966ea61",
            "filename": "django/contrib/admin/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea/django%2Fcontrib%2Fadmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea/django%2Fcontrib%2Fadmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftests.py?ref=a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea",
            "patch": "@@ -29,6 +29,26 @@ def tearDownClass(cls):\n         if hasattr(cls, 'selenium'):\n             cls.selenium.quit()\n \n+    def wait_until(self, callback, timeout=10):\n+        \"\"\"\n+        Helper function that blocks the execution of the tests until the\n+        specified callback returns a value that is not falsy. This function can\n+        be called, for example, after clicking a link or submitting a form.\n+        See the other public methods that call this function for more details.\n+        \"\"\"\n+        from selenium.webdriver.support.wait import WebDriverWait\n+        WebDriverWait(self.selenium, timeout).until(callback)\n+\n+    def wait_loaded_tag(self, tag_name, timeout=10):\n+        \"\"\"\n+        Helper function that blocks until the element with the given tag name\n+        is found on the page.\n+        \"\"\"\n+        self.wait_until(\n+            lambda driver: driver.find_element_by_tag_name(tag_name),\n+            timeout\n+        )\n+\n     def admin_login(self, username, password, login_url='/admin/'):\n         \"\"\"\n         Helper function to log into the admin.\n@@ -41,6 +61,8 @@ def admin_login(self, username, password, login_url='/admin/'):\n         login_text = _('Log in')\n         self.selenium.find_element_by_xpath(\n             '//input[@value=\"%s\"]' % login_text).click()\n+        # Wait for the next page to be loaded.\n+        self.wait_loaded_tag('body')\n \n     def get_css_value(self, selector, attribute):\n         \"\"\""
        },
        {
            "sha": "acb24c0a980347b504b4e1485553fc16f555192e",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea",
            "patch": "@@ -1843,6 +1843,41 @@ out the `full reference`_ for more details.\n     </howto/static-files>` so you'll need to have your project configured\n     accordingly (in particular by setting :setting:`STATIC_URL`).\n \n+.. note::\n+\n+    When using an in-memory SQLite database to run the tests, the same database\n+    connection will be shared by two threads in parallel: the thread in which\n+    the live server is run, and the thread in which the test case is run. It is\n+    important to prevent simultaneous database queries via this shared\n+    connection by the two threads as that may sometimes cause the tests to\n+    randomly fail. So you need to ensure that the two threads do not access the\n+    database at the same time. In particular, this means that in some cases\n+    (for example just after clicking a link or submitting a form) you might\n+    need to check that a response is received by Selenium and that the next\n+    page is loaded before proceeding further with the execution of the tests.\n+    This can be achieved, for example, by making Selenium wait until the\n+    `<body>` HTML tag is found in the response:\n+\n+    .. code-block:: python\n+\n+        def test_login(self):\n+            from selenium.webdriver.support.wait import WebDriverWait\n+            ...\n+            self.selenium.find_element_by_xpath('//input[@value=\"Log in\"]').click()\n+            # Wait until the response is received\n+            WebDriverWait(self.selenium, timeout).until(\n+                lambda driver: driver.find_element_by_tag_name('body'), timeout=10)\n+\n+    The difficult point is that there really is no such thing as a \"page load\",\n+    especially in modern Web apps that have dynamically-generated page\n+    components that do not exist in the HTML initially received from the\n+    server. So simply checking for the presence of the `<body>` tag in the\n+    response might not necessarily be appropriate for all use cases. Please\n+    refer to the `Selenium FAQ`_ and the `Selenium documentation`_ for more\n+    information on this topic.\n+\n+    .. _Selenium FAQ: http://code.google.com/p/selenium/wiki/FrequentlyAskedQuestions#Q:_WebDriver_fails_to_find_elements_/_Does_not_block_on_page_loa\n+    .. _Selenium documentation: http://seleniumhq.org/docs/04_webdriver_advanced.html#explicit-waits\n \n Using different testing frameworks\n =================================="
        },
        {
            "sha": "3ea2ce476e950b5763cfa203c707e970694f7ca0",
            "filename": "tests/regressiontests/admin_inlines/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py?ref=a343a84ce6a8e7e0de2998ac423cbc1cecdb9aea",
            "patch": "@@ -443,6 +443,9 @@ def test_add_inlines(self):\n         self.selenium.find_element_by_name('profile_set-2-last_name').send_keys('2 last name 2')\n         self.selenium.find_element_by_xpath('//input[@value=\"Save\"]').click()\n \n+        # Wait for the next page to be loaded.\n+        self.wait_loaded_tag('body')\n+\n         # Check that the objects have been created in the database\n         self.assertEqual(ProfileCollection.objects.all().count(), 1)\n         self.assertEqual(Profile.objects.all().count(), 3)"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 60,
        "deletions": 0
    }
}