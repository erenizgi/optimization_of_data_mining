{
    "author": "akaariai",
    "message": "Fixed #17541 -- Fixed non-saved/nullable fk querying",
    "sha": "55da775ce1bfba20db33b56c29957faa63917980",
    "files": [
        {
            "sha": "ae792a30e7e059c38c8b7ed8b7204d5053a46c56",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/55da775ce1bfba20db33b56c29957faa63917980/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/55da775ce1bfba20db33b56c29957faa63917980/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=55da775ce1bfba20db33b56c29957faa63917980",
            "patch": "@@ -496,6 +496,8 @@ def get_query_set(self):\n                 except (AttributeError, KeyError):\n                     db = self._db or router.db_for_read(self.model, instance=self.instance)\n                     qs = super(RelatedManager, self).get_query_set().using(db).filter(**self.core_filters)\n+                    if getattr(self.instance, attname) is None:\n+                        return qs.none()\n                     qs._known_related_objects = {rel_field: {self.instance.pk: self.instance}}\n                     return qs\n "
        },
        {
            "sha": "0ac08717937681fdaf0e065bb6618b857287ee0d",
            "filename": "tests/regressiontests/many_to_one_regress/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/55da775ce1bfba20db33b56c29957faa63917980/tests%2Fregressiontests%2Fmany_to_one_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/55da775ce1bfba20db33b56c29957faa63917980/tests%2Fregressiontests%2Fmany_to_one_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmany_to_one_regress%2Fmodels.py?ref=55da775ce1bfba20db33b56c29957faa63917980",
            "patch": "@@ -48,3 +48,9 @@ class Relation(models.Model):\n \n     def __str__(self):\n         return \"%s - %s\" % (self.left.category.name, self.right.category.name)\n+\n+class Car(models.Model):\n+    make = models.CharField(max_length=100, null=True, unique=True)\n+\n+class Driver(models.Model):\n+    car = models.ForeignKey(Car, to_field='make', null=True, related_name='drivers')"
        },
        {
            "sha": "e140577a49a4dfbb547b755aa43d8652ee4e7612",
            "filename": "tests/regressiontests/many_to_one_regress/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/55da775ce1bfba20db33b56c29957faa63917980/tests%2Fregressiontests%2Fmany_to_one_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/55da775ce1bfba20db33b56c29957faa63917980/tests%2Fregressiontests%2Fmany_to_one_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmany_to_one_regress%2Ftests.py?ref=55da775ce1bfba20db33b56c29957faa63917980",
            "patch": "@@ -4,7 +4,8 @@\n from django.test import TestCase\n from django.utils import six\n \n-from .models import First, Third, Parent, Child, Category, Record, Relation\n+from .models import (\n+    First, Third, Parent, Child, Category, Record, Relation, Car, Driver)\n \n \n class ManyToOneRegressionTests(TestCase):\n@@ -111,3 +112,25 @@ def test_fk_instantiation_outside_model(self):\n         # of a model, and interrogate its related field.\n         cat = models.ForeignKey(Category)\n         self.assertEqual('id', cat.rel.get_related_field().name)\n+\n+    def test_relation_unsaved(self):\n+        # Test that the <field>_set manager does not join on Null value fields (#17541)\n+        Third.objects.create(name='Third 1')\n+        Third.objects.create(name='Third 2')\n+        th = Third(name=\"testing\")\n+        # The object isn't saved an thus the relation field is null - we won't even\n+        # execute a query in this case.\n+        with self.assertNumQueries(0):\n+            self.assertEqual(th.child_set.count(), 0)\n+        th.save()\n+        # Now the model is saved, so we will need to execute an query.\n+        with self.assertNumQueries(1):\n+            self.assertEqual(th.child_set.count(), 0)\n+    \n+    def test_related_null_to_field(self):\n+        c1 = Car.objects.create()\n+        c2 = Car.objects.create()\n+        d1 = Driver.objects.create()\n+        self.assertIs(d1.car, None)\n+        with self.assertNumQueries(0):\n+            self.assertEqual(list(c1.drivers.all()), [])"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 32,
        "deletions": 1
    }
}