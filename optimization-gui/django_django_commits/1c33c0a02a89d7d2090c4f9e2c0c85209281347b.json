{
    "author": "jezdez",
    "message": "Fixed #17737 -- Stopped the collectstatic management command from copying the wrong file in repeated runs. Thanks, pigletto.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17612 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1c33c0a02a89d7d2090c4f9e2c0c85209281347b",
    "files": [
        {
            "sha": "850b0132fbecf150aeec4bebb8894a626d50722c",
            "filename": "django/contrib/staticfiles/management/commands/collectstatic.py",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/1c33c0a02a89d7d2090c4f9e2c0c85209281347b/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "raw_url": "https://github.com/django/django/raw/1c33c0a02a89d7d2090c4f9e2c0c85209281347b/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py?ref=1c33c0a02a89d7d2090c4f9e2c0c85209281347b",
            "patch": "@@ -107,8 +107,10 @@ def collect(self):\n                     prefixed_path = os.path.join(storage.prefix, path)\n                 else:\n                     prefixed_path = path\n-                found_files[prefixed_path] = (storage, path)\n-                handler(path, prefixed_path, storage)\n+\n+                if prefixed_path not in found_files:\n+                    found_files[prefixed_path] = (storage, path)\n+                    handler(path, prefixed_path, storage)\n \n         # Here we check if the storage backend has a post_process\n         # method and pass it the list of modified files.\n@@ -207,7 +209,9 @@ def clear_dir(self, path):\n             self.clear_dir(os.path.join(path, d))\n \n     def delete_file(self, path, prefixed_path, source_storage):\n-        # Checks if the target file should be deleted if it already exists\n+        \"\"\"\n+        Checks if the target file should be deleted if it already exists\n+        \"\"\"\n         if self.storage.exists(prefixed_path):\n             try:\n                 # When was the target file modified last time?"
        },
        {
            "sha": "5c8748ef2c73accdf86a161f560fed9caa7e9d67",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 56,
            "deletions": 1,
            "changes": 57,
            "blob_url": "https://github.com/django/django/blob/1c33c0a02a89d7d2090c4f9e2c0c85209281347b/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1c33c0a02a89d7d2090c4f9e2c0c85209281347b/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=1c33c0a02a89d7d2090c4f9e2c0c85209281347b",
            "patch": "@@ -286,6 +286,61 @@ def run_collectstatic(self):\n         super(TestCollectionDryRun, self).run_collectstatic(dry_run=True)\n \n \n+class TestCollectionFilesOverride(CollectionTestCase):\n+    \"\"\"\n+    Test overriding duplicated files by ``collectstatic`` management command.\n+    Check for proper handling of apps order in INSTALLED_APPS even if file modification\n+    dates are in different order:\n+\n+        'regressiontests.staticfiles_tests.apps.test',\n+        'regressiontests.staticfiles_tests.apps.no_label',\n+\n+    \"\"\"\n+    def setUp(self):\n+        self.orig_path = os.path.join(TEST_ROOT, 'apps', 'no_label', 'static', 'file2.txt')\n+        # get modification and access times for no_label/static/file2.txt\n+        self.orig_mtime = os.path.getmtime(self.orig_path)\n+        self.orig_atime = os.path.getatime(self.orig_path)\n+\n+        # prepare duplicate of file2.txt from no_label app\n+        # this file will have modification time older than no_label/static/file2.txt\n+        # anyway it should be taken to STATIC_ROOT because 'test' app is before\n+        # 'no_label' app in INSTALLED_APPS\n+        self.testfile_path = os.path.join(TEST_ROOT, 'apps', 'test', 'static', 'file2.txt')\n+        with open(self.testfile_path, 'w+') as f:\n+            f.write('duplicate of file2.txt')\n+        os.utime(self.testfile_path, (self.orig_atime - 1, self.orig_mtime - 1))\n+        super(TestCollectionFilesOverride, self).setUp()\n+\n+    def tearDown(self):\n+        if os.path.exists(self.testfile_path):\n+            os.unlink(self.testfile_path)\n+        # set back original modification time\n+        os.utime(self.orig_path, (self.orig_atime, self.orig_mtime))\n+\n+    def test_ordering_override(self):\n+        \"\"\"\n+        Test if collectstatic takes files in proper order\n+        \"\"\"\n+        self.assertFileContains('file2.txt', 'duplicate of file2.txt')\n+\n+        # run collectstatic again\n+        self.run_collectstatic()\n+\n+        self.assertFileContains('file2.txt', 'duplicate of file2.txt')\n+\n+        # and now change modification time of no_label/static/file2.txt\n+        # test app is first in INSTALLED_APPS so file2.txt should remain unmodified\n+        mtime = os.path.getmtime(self.testfile_path)\n+        atime = os.path.getatime(self.testfile_path)\n+        os.utime(self.orig_path, (mtime + 1, atime + 1))\n+\n+        # run collectstatic again\n+        self.run_collectstatic()\n+\n+        self.assertFileContains('file2.txt', 'duplicate of file2.txt')\n+\n+\n class TestCollectionNonLocalStorage(CollectionTestCase, TestNoFilesCreated):\n     \"\"\"\n     Tests for #15035\n@@ -314,7 +369,7 @@ def test_template_tag_return(self):\n                                 \"does/not/exist.png\",\n                                 \"/static/does/not/exist.png\")\n         self.assertStaticRenders(\"test/file.txt\",\n-                                 \"/static/test/file.ea5bccaf16d5.txt\")\n+                                 \"/static/test/file.dad0999e4f8f.txt\")\n         self.assertStaticRenders(\"cached/styles.css\",\n                                  \"/static/cached/styles.93b1147e8552.css\")\n         self.assertStaticRenders(\"path/\","
        }
    ],
    "stats": {
        "total": 67,
        "additions": 63,
        "deletions": 4
    }
}