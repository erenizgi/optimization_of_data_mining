{
    "author": "aaugustin",
    "message": "Fixed #13196 -- Formatting in admin changelists.\n\nHandled values returned by functions more like field values.\nIn particular, localized dates, times and datetimes properly,\nand converted datetimes to the current timezone.",
    "sha": "905bd7fb44a0dbd0be0d455ab428c388714ae700",
    "files": [
        {
            "sha": "bda8d4b4cdb39859aa2227e8bffa0a1ab683b6f1",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/905bd7fb44a0dbd0be0d455ab428c388714ae700/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/905bd7fb44a0dbd0be0d455ab428c388714ae700/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=905bd7fb44a0dbd0be0d455ab428c388714ae700",
            "patch": "@@ -1,6 +1,7 @@\n import datetime\n \n-from django.contrib.admin.util import lookup_field, display_for_field, label_for_field\n+from django.contrib.admin.util import (lookup_field, display_for_field,\n+    display_for_value, label_for_field)\n from django.contrib.admin.views.main import (ALL_VAR, EMPTY_CHANGELIST_VALUE,\n     ORDER_VAR, PAGE_VAR, SEARCH_VAR)\n from django.contrib.admin.templatetags.admin_static import static\n@@ -184,15 +185,15 @@ def items_for_result(cl, result, form):\n                 boolean = getattr(attr, 'boolean', False)\n                 if boolean:\n                     allow_tags = True\n-                    result_repr = _boolean_icon(value)\n-                else:\n-                    result_repr = smart_unicode(value)\n+                result_repr = display_for_value(value, boolean)\n                 # Strip HTML tags in the resulting text, except if the\n                 # function has an \"allow_tags\" attribute set to True.\n                 if not allow_tags:\n                     result_repr = escape(result_repr)\n                 else:\n                     result_repr = mark_safe(result_repr)\n+                if isinstance(value, (datetime.date, datetime.time)):\n+                    row_class = ' class=\"nowrap\"'\n             else:\n                 if isinstance(f.rel, models.ManyToOneRel):\n                     field_val = getattr(result, f.name)\n@@ -202,9 +203,7 @@ def items_for_result(cl, result, form):\n                         result_repr = escape(field_val)\n                 else:\n                     result_repr = display_for_field(value, f)\n-                if isinstance(f, models.DateField)\\\n-                or isinstance(f, models.TimeField)\\\n-                or isinstance(f, models.ForeignKey):\n+                if isinstance(f, (models.DateField, models.TimeField, models.ForeignKey)):\n                     row_class = ' class=\"nowrap\"'\n         if force_unicode(result_repr) == '':\n             result_repr = mark_safe('&nbsp;')"
        },
        {
            "sha": "b8456d859f9af2a5db81b1e1fdb3a430ae4fdbd5",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/905bd7fb44a0dbd0be0d455ab428c388714ae700/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/905bd7fb44a0dbd0be0d455ab428c388714ae700/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=905bd7fb44a0dbd0be0d455ab428c388714ae700",
            "patch": "@@ -1,3 +1,6 @@\n+import datetime\n+import decimal\n+\n from django.db import models\n from django.db.models.sql.constants import LOOKUP_SEP\n from django.db.models.deletion import Collector\n@@ -323,7 +326,7 @@ def display_for_field(value, field):\n         return EMPTY_CHANGELIST_VALUE\n     elif isinstance(field, models.DateTimeField):\n         return formats.localize(timezone.localtime(value))\n-    elif isinstance(field, models.DateField) or isinstance(field, models.TimeField):\n+    elif isinstance(field, (models.DateField, models.TimeField)):\n         return formats.localize(value)\n     elif isinstance(field, models.DecimalField):\n         return formats.number_format(value, field.decimal_places)\n@@ -333,6 +336,24 @@ def display_for_field(value, field):\n         return smart_unicode(value)\n \n \n+def display_for_value(value, boolean=False):\n+    from django.contrib.admin.templatetags.admin_list import _boolean_icon\n+    from django.contrib.admin.views.main import EMPTY_CHANGELIST_VALUE\n+\n+    if boolean:\n+        return _boolean_icon(value)\n+    elif value is None:\n+        return EMPTY_CHANGELIST_VALUE\n+    elif isinstance(value, datetime.datetime):\n+        return formats.localize(timezone.localtime(value))\n+    elif isinstance(value, (datetime.date, datetime.time)):\n+        return formats.localize(value)\n+    elif isinstance(value, (decimal.Decimal, float, int, long)):\n+        return formats.number_format(value)\n+    else:\n+        return smart_unicode(value)\n+\n+\n class NotRelationField(Exception):\n     pass\n "
        },
        {
            "sha": "9ecfbc6e125771fc53e5aac5bb50a77ff901c069",
            "filename": "tests/regressiontests/admin_changelist/admin.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/905bd7fb44a0dbd0be0d455ab428c388714ae700/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/905bd7fb44a0dbd0be0d455ab428c388714ae700/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py?ref=905bd7fb44a0dbd0be0d455ab428c388714ae700",
            "patch": "@@ -3,8 +3,8 @@\n from django.contrib import admin\n from django.core.paginator import Paginator\n \n-from .models import (Child, Parent, Genre, Band, Musician, Group, Quartet,\n-    Membership, ChordsMusician, ChordsBand, Invitation, Swallow)\n+from .models import (Event, Child, Parent, Genre, Band, Musician, Group,\n+    Quartet, Membership, ChordsMusician, ChordsBand, Invitation, Swallow)\n \n \n site = admin.AdminSite(name=\"admin\")\n@@ -15,6 +15,15 @@ def __init__(self, queryset, page_size, orphans=0, allow_empty_first_page=True):\n             allow_empty_first_page=allow_empty_first_page)\n \n \n+class EventAdmin(admin.ModelAdmin):\n+    list_display = ['event_date_func']\n+\n+    def event_date_func(self, event):\n+        return event.date\n+\n+site.register(Event, EventAdmin)\n+\n+\n class ParentAdmin(admin.ModelAdmin):\n     list_filter = ['child__name']\n     search_fields = ['child__name']"
        },
        {
            "sha": "dcc343bb6aa5ff350373a9c4b537c08ee6c99c06",
            "filename": "tests/regressiontests/admin_changelist/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/905bd7fb44a0dbd0be0d455ab428c388714ae700/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/905bd7fb44a0dbd0be0d455ab428c388714ae700/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py?ref=905bd7fb44a0dbd0be0d455ab428c388714ae700",
            "patch": "@@ -1,5 +1,7 @@\n from django.db import models\n \n+class Event(models.Model):\n+    date = models.DateField()\n \n class Parent(models.Model):\n     name = models.CharField(max_length=128)"
        },
        {
            "sha": "62166ce174fd99be697e2f5db54de4bdd640da46",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/905bd7fb44a0dbd0be0d455ab428c388714ae700/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/905bd7fb44a0dbd0be0d455ab428c388714ae700/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=905bd7fb44a0dbd0be0d455ab428c388714ae700",
            "patch": "@@ -1,20 +1,23 @@\n from __future__ import absolute_import\n \n+import datetime\n+\n from django.contrib import admin\n from django.contrib.admin.options import IncorrectLookupParameters\n from django.contrib.admin.views.main import ChangeList, SEARCH_VAR, ALL_VAR\n from django.contrib.auth.models import User\n from django.template import Context, Template\n from django.test import TestCase\n from django.test.client import RequestFactory\n+from django.utils import formats\n \n from .admin import (ChildAdmin, QuartetAdmin, BandAdmin, ChordsBandAdmin,\n     GroupAdmin, ParentAdmin, DynamicListDisplayChildAdmin,\n     DynamicListDisplayLinksChildAdmin, CustomPaginationAdmin,\n     FilteredChildAdmin, CustomPaginator, site as custom_site,\n     SwallowAdmin)\n-from .models import (Child, Parent, Genre, Band, Musician, Group, Quartet,\n-    Membership, ChordsMusician, ChordsBand, Invitation, Swallow,\n+from .models import (Event, Child, Parent, Genre, Band, Musician, Group,\n+    Quartet, Membership, ChordsMusician, ChordsBand, Invitation, Swallow,\n     UnorderedObject, OrderedObject)\n \n \n@@ -325,6 +328,19 @@ def test_pagination(self):\n         self.assertEqual(cl.paginator.count, 30)\n         self.assertEqual(cl.paginator.page_range, [1, 2, 3])\n \n+    def test_computed_list_display_localization(self):\n+        \"\"\"\n+        Regression test for #13196: output of functions should be  localized\n+        in the changelist.\n+        \"\"\"\n+        User.objects.create_superuser(\n+            username='super', email='super@localhost', password='secret')\n+        self.client.login(username='super', password='secret')\n+        event = Event.objects.create(date=datetime.date.today())\n+        response = self.client.get('/admin/admin_changelist/event/')\n+        self.assertContains(response, formats.localize(event.date))\n+        self.assertNotContains(response, unicode(event.date))\n+\n     def test_dynamic_list_display(self):\n         \"\"\"\n         Regression tests for #14206: dynamic list_display support.\n@@ -519,4 +535,4 @@ def check_results_order(ascending=False):\n         OrderedObjectAdmin.ordering = ['-id', 'bool']\n         check_results_order()\n         OrderedObjectAdmin.ordering = ['id', 'bool']\n-        check_results_order(ascending=True)\n\\ No newline at end of file\n+        check_results_order(ascending=True)"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 60,
        "deletions": 13
    }
}