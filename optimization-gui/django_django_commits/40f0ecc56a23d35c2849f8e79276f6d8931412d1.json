{
    "author": "aaugustin",
    "message": "Implemented PEP386-compatible version numbers. Thanks Jannis for the guidance.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17357 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "40f0ecc56a23d35c2849f8e79276f6d8931412d1",
    "files": [
        {
            "sha": "3417c7158abe7892ddc50eb85d789c4f0cf4bffb",
            "filename": "django/__init__.py",
            "status": "modified",
            "additions": 27,
            "deletions": 27,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/django%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/django%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2F__init__.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1",
            "patch": "@@ -1,30 +1,30 @@\n VERSION = (1, 4, 0, 'alpha', 1)\n \n-def get_version():\n-    version = '%s.%s' % (VERSION[0], VERSION[1])\n-    if VERSION[2]:\n-        version = '%s.%s' % (version, VERSION[2])\n-    if VERSION[3:] == ('alpha', 0):\n-        version = '%s pre-alpha' % version\n-    else:\n-        if VERSION[3] != 'final':\n-            version = '%s %s %s' % (version, VERSION[3], VERSION[4])\n-    from django.utils.version import get_svn_revision\n-    svn_rev = get_svn_revision()\n-    if svn_rev != u'SVN-unknown':\n-        version = \"%s %s\" % (version, svn_rev)\n-    return version\n+def get_version(version=None):\n+    \"\"\"Derives a PEP386-compliant version number from VERSION.\"\"\"\n+    if version is None:\n+        version = VERSION\n+    assert len(version) == 5\n+    assert version[3] in ('alpha', 'beta', 'rc', 'final')\n \n-def get_distutils_version():\n-    # Distutils expects a version number formatted as major.minor[.patch][sub]\n-    parts = 5\n-    if VERSION[3] == 'final':\n-        parts = 3\n-        if VERSION[2] == 0:\n-            parts = 2\n-    version = VERSION[:parts]\n-    version = [str(x)[0] for x in version]      # ['1', '4', '0', 'a', '1']\n-    if parts > 2:\n-        version[2:] = [''.join(version[2:])]    # ['1', '4', '0a1']\n-    version = '.'.join(version)                 # '1.4.0a1'\n-    return version\n+    # Now build the two parts of the version number:\n+    # main = X.Y[.Z]\n+    # sub = .devN - for pre-alpha releases\n+    #     | {a|b|c}N - for alpha, beta and rc releases\n+\n+    parts = 2 if version[2] == 0 else 3\n+    main = '.'.join(str(x) for x in version[:parts])\n+\n+    sub = ''\n+    if version[3] == 'alpha' and version[4] == 0:\n+        # At the toplevel, this would cause an import loop.\n+        from django.utils.version import get_svn_revision\n+        svn_revision = get_svn_revision()[4:]\n+        if svn_revision != 'unknown':\n+            sub = '.dev%s' % svn_revision\n+\n+    elif version[3] != 'final':\n+        mapping = {'alpha': 'a', 'beta': 'b', 'rc': 'c'}\n+        sub = mapping[version[3]] + str(version[4])\n+\n+    return main + sub"
        },
        {
            "sha": "bb03082be087b2ae41c239a384d4ac1ee75dcf30",
            "filename": "django/core/management/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/django%2Fcore%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/django%2Fcore%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2F__init__.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1",
            "patch": "@@ -4,12 +4,11 @@\n import imp\n import warnings\n \n-import django\n from django.core.management.base import BaseCommand, CommandError, handle_default_options\n from django.utils.importlib import import_module\n \n # For backwards compatibility: get_version() used to be in this module.\n-get_version = django.get_version\n+from django import get_version\n \n # A cache of loaded commands, so that call_command\n # doesn't have to reload every time it's called."
        },
        {
            "sha": "975ddcb255cd8dd9a4520cdfcf5aecf40ba3d059",
            "filename": "setup.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/setup.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/setup.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/setup.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1",
            "patch": "@@ -66,7 +66,7 @@ def fullsplit(path, result=None):\n         file_info[0] = '\\\\PURELIB\\\\%s' % file_info[0]\n \n # Dynamically calculate the version based on django.VERSION.\n-version = __import__('django').get_distutils_version()\n+version = __import__('django').get_version()\n \n setup(\n     name = \"Django\","
        },
        {
            "sha": "0a7c56c86e420c4fb49dc56a1bba5822339f8046",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1",
            "patch": "@@ -1177,8 +1177,7 @@ def test_version(self):\n         args = ['--version']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(err)\n-        # Only check the first part of the version number\n-        self.assertOutput(out, get_version().split('-')[0])\n+        self.assertOutput(out, get_version())\n \n     def test_help(self):\n         \"--help is handled as a special case\""
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/version/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fversion%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fversion%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fversion%2F__init__.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/version/models.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fversion%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fversion%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fversion%2Fmodels.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1"
        },
        {
            "sha": "1a67483c1f000ccdab63432adc3f9ccdeedddcf1",
            "filename": "tests/regressiontests/version/tests.py",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fversion%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/40f0ecc56a23d35c2849f8e79276f6d8931412d1/tests%2Fregressiontests%2Fversion%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fversion%2Ftests.py?ref=40f0ecc56a23d35c2849f8e79276f6d8931412d1",
            "patch": "@@ -0,0 +1,26 @@\n+import re\n+\n+from django import get_version\n+from django.utils.unittest import TestCase\n+\n+class VersionTests(TestCase):\n+\n+    def test_development(self):\n+        ver_tuple = (1, 4, 0, 'alpha', 0)\n+        # This will return a different result when it's run within or outside\n+        # of a SVN checkout: 1.4.devNNNNN or 1.4.\n+        ver_string = get_version(ver_tuple)\n+        self.assertRegexpMatches(ver_string, r'1\\.4(\\.dev\\d+)?')\n+\n+    def test_releases(self):\n+        tuples_to_strings = (\n+            ((1, 4, 0, 'alpha', 1), '1.4a1'),\n+            ((1, 4, 0, 'beta', 1), '1.4b1'),\n+            ((1, 4, 0, 'rc', 1), '1.4c1'),\n+            ((1, 4, 0, 'final', 0), '1.4'),\n+            ((1, 4, 1, 'rc', 2), '1.4.1c2'),\n+            ((1, 4, 1, 'final', 0), '1.4.1'),\n+        )\n+        for ver_tuple, ver_string in tuples_to_strings:\n+            self.assertEqual(get_version(ver_tuple), ver_string)\n+"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 56,
        "deletions": 32
    }
}