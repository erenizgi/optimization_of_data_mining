{
    "author": "aaugustin",
    "message": "Made the cache locale-dependant when USE_L10N is True, even if USE_I18N is False. Refs #5691.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17061 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "af1893c4ff8fdbf227a43a559d90bb1c1238b01a",
    "files": [
        {
            "sha": "be4fa5864582855acf5a6a4e73bd6bcbbcc016ef",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/af1893c4ff8fdbf227a43a559d90bb1c1238b01a/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/af1893c4ff8fdbf227a43a559d90bb1c1238b01a/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=af1893c4ff8fdbf227a43a559d90bb1c1238b01a",
            "patch": "@@ -158,7 +158,7 @@ def has_vary_header(response, header_query):\n \n def _i18n_cache_key_suffix(request, cache_key):\n     \"\"\"If enabled, returns the cache key ending with a locale.\"\"\"\n-    if settings.USE_I18N:\n+    if settings.USE_I18N or settings.USE_L10N:\n         # first check if LocaleMiddleware or another middleware added\n         # LANGUAGE_CODE to request, then fall back to the active language\n         # which in turn can also fall back to settings.LANGUAGE_CODE"
        },
        {
            "sha": "4729cab60d486679ce631c288ea5d15b97a3d18a",
            "filename": "docs/topics/cache.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/af1893c4ff8fdbf227a43a559d90bb1c1238b01a/docs%2Ftopics%2Fcache.txt",
            "raw_url": "https://github.com/django/django/raw/af1893c4ff8fdbf227a43a559d90bb1c1238b01a/docs%2Ftopics%2Fcache.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fcache.txt?ref=af1893c4ff8fdbf227a43a559d90bb1c1238b01a",
            "patch": "@@ -498,6 +498,10 @@ include the name of the active :term:`language<language code>` -- see also\n :ref:`how-django-discovers-language-preference`). This allows you to easily\n cache multilingual sites without having to create the cache key yourself.\n \n+.. versionchanged:: 1.4\n+\n+This also happens when :setting:`USE_L10N` is set to ``True``.\n+\n __ `Controlling cache: Using other headers`_\n \n The per-view cache"
        },
        {
            "sha": "e6c03837d446800295218a5b6c6487c755ae4746",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/af1893c4ff8fdbf227a43a559d90bb1c1238b01a/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/af1893c4ff8fdbf227a43a559d90bb1c1238b01a/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=af1893c4ff8fdbf227a43a559d90bb1c1238b01a",
            "patch": "@@ -1154,23 +1154,33 @@ def _get_request_cache(self, query_string=None):\n         request.session = {}\n         return request\n \n-    @override_settings(USE_I18N=True)\n-    def test_cache_key_i18n(self):\n+    @override_settings(USE_I18N=True, USE_L10N=False)\n+    def test_cache_key_i18n_translation(self):\n         request = self._get_request()\n         lang = translation.get_language()\n         response = HttpResponse()\n         key = learn_cache_key(request, response)\n-        self.assertTrue(key.endswith(lang), \"Cache keys should include the language name when i18n is active\")\n+        self.assertIn(lang, key, \"Cache keys should include the language name when translation is active\")\n         key2 = get_cache_key(request)\n         self.assertEqual(key, key2)\n \n-    @override_settings(USE_I18N=False)\n+    @override_settings(USE_I18N=False, USE_L10N=True)\n+    def test_cache_key_i18n_formatting(self):\n+        request = self._get_request()\n+        lang = translation.get_language()\n+        response = HttpResponse()\n+        key = learn_cache_key(request, response)\n+        self.assertIn(lang, key, \"Cache keys should include the language name when formatting is active\")\n+        key2 = get_cache_key(request)\n+        self.assertEqual(key, key2)\n+\n+    @override_settings(USE_I18N=False, USE_L10N=False)\n     def test_cache_key_no_i18n (self):\n         request = self._get_request()\n         lang = translation.get_language()\n         response = HttpResponse()\n         key = learn_cache_key(request, response)\n-        self.assertFalse(key.endswith(lang), \"Cache keys shouldn't include the language name when i18n is inactive\")\n+        self.assertNotIn(lang, key, \"Cache keys shouldn't include the language name when i18n isn't active\")\n \n     @override_settings(\n             CACHE_MIDDLEWARE_KEY_PREFIX=\"test\","
        }
    ],
    "stats": {
        "total": 26,
        "additions": 20,
        "deletions": 6
    }
}