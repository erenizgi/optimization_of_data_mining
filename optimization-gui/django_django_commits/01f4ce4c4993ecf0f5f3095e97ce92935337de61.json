{
    "author": "jbronn",
    "message": "Fixed #17059 -- Encode `GeoIP` query strings properly so `libGeoIP` returns results for unicode strings.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17019 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "01f4ce4c4993ecf0f5f3095e97ce92935337de61",
    "files": [
        {
            "sha": "e00e0a4d93eb003a5faa53598fe83e4b05eb3bae",
            "filename": "django/contrib/gis/geoip/base.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/01f4ce4c4993ecf0f5f3095e97ce92935337de61/django%2Fcontrib%2Fgis%2Fgeoip%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/01f4ce4c4993ecf0f5f3095e97ce92935337de61/django%2Fcontrib%2Fgis%2Fgeoip%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeoip%2Fbase.py?ref=01f4ce4c4993ecf0f5f3095e97ce92935337de61",
            "patch": "@@ -132,6 +132,9 @@ def _check_query(self, query, country=False, city=False, city_or_country=False):\n         if not isinstance(query, basestring):\n             raise TypeError('GeoIP query must be a string, not type %s' % type(query).__name__)\n \n+        # GeoIP only takes ASCII-encoded strings.\n+        query = query.encode('ascii')\n+\n         # Extra checks for the existence of country and city databases.\n         if city_or_country and not (self._country or self._city):\n             raise GeoIPException('Invalid GeoIP country and city data files.')\n@@ -140,13 +143,16 @@ def _check_query(self, query, country=False, city=False, city_or_country=False):\n         elif city and not self._city:\n             raise GeoIPException('Invalid GeoIP city data file: %s' % self._city_file)\n \n+        # Return the query string back to the caller.\n+        return query\n+\n     def city(self, query):\n         \"\"\"\n         Returns a dictionary of city information for the given IP address or\n         Fully Qualified Domain Name (FQDN).  Some information in the dictionary\n         may be undefined (None).\n         \"\"\"\n-        self._check_query(query, city=True)\n+        query = self._check_query(query, city=True)\n         if ipv4_re.match(query):\n             # If an IP address was passed in\n             return GeoIP_record_by_addr(self._city, c_char_p(query))\n@@ -156,7 +162,7 @@ def city(self, query):\n \n     def country_code(self, query):\n         \"Returns the country code for the given IP Address or FQDN.\"\n-        self._check_query(query, city_or_country=True)\n+        query = self._check_query(query, city_or_country=True)\n         if self._country:\n             if ipv4_re.match(query):\n                 return GeoIP_country_code_by_addr(self._country, query)\n@@ -167,7 +173,7 @@ def country_code(self, query):\n \n     def country_name(self, query):\n         \"Returns the country name for the given IP Address or FQDN.\"\n-        self._check_query(query, city_or_country=True)\n+        query = self._check_query(query, city_or_country=True)\n         if self._country:\n             if ipv4_re.match(query):\n                 return GeoIP_country_name_by_addr(self._country, query)"
        },
        {
            "sha": "6e1f1579a7e2c615a6bee42c4a3e2e38b70f13a1",
            "filename": "django/contrib/gis/geoip/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/01f4ce4c4993ecf0f5f3095e97ce92935337de61/django%2Fcontrib%2Fgis%2Fgeoip%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/01f4ce4c4993ecf0f5f3095e97ce92935337de61/django%2Fcontrib%2Fgis%2Fgeoip%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeoip%2Ftests.py?ref=01f4ce4c4993ecf0f5f3095e97ce92935337de61",
            "patch": "@@ -95,12 +95,18 @@ def test04_city(self):\n                 self.assertAlmostEqual(lon, tup[0], 4)\n                 self.assertAlmostEqual(lat, tup[1], 4)\n \n-    def test05_unicode(self):\n+    def test05_unicode_response(self):\n         \"Testing that GeoIP strings are properly encoded, see #16553.\"\n         g = GeoIP()\n         d = g.city('62.224.93.23')\n         self.assertEqual(u'Sch\\xf6mberg', d['city'])\n \n+    def test06_unicode_query(self):\n+        \"Testing that GeoIP accepts unicode string queries, see #17059.\"\n+        g = GeoIP()\n+        d = g.country(u'whitehouse.gov')\n+        self.assertEqual(u'US', d['country_code'])\n+\n \n def suite():\n     s = unittest.TestSuite()"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 16,
        "deletions": 4
    }
}