{
    "author": "akaariai",
    "message": "Fixed #19102 -- Fixed fast-path delete for modified SELECT clause cases\n\nThere was a bug introduced in #18676 which caused fast-path deletes\nimplemented as \"DELETE WHERE pk IN <subquery>\" to fail if the SELECT\nclause contained additional stuff (for example extra() and annotate()).\n\nThanks to Trac alias pressureman for spotting this regression.",
    "sha": "f64a5ef404cb6fd28e008a01039a3beea2fa8e1b",
    "files": [
        {
            "sha": "264e29eaf3b5010efd1edd4e485be866d5c40cad",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=f64a5ef404cb6fd28e008a01039a3beea2fa8e1b",
            "patch": "@@ -431,13 +431,9 @@ def get_count(self, using):\n \n     def has_results(self, using):\n         q = self.clone()\n+        q.clear_select_clause()\n         q.add_extra({'a': 1}, None, None, None, None, None)\n-        q.select = []\n-        q.select_fields = []\n-        q.default_cols = False\n-        q.select_related = False\n-        q.set_extra_mask(('a',))\n-        q.set_aggregate_mask(())\n+        q.set_extra_mask(['a'])\n         q.clear_ordering(True)\n         q.set_limits(high=1)\n         compiler = q.get_compiler(using=using)\n@@ -1626,6 +1622,17 @@ def can_filter(self):\n         \"\"\"\n         return not self.low_mark and self.high_mark is None\n \n+    def clear_select_clause(self):\n+        \"\"\"\n+        Removes all fields from SELECT clause.\n+        \"\"\"\n+        self.select = []\n+        self.select_fields = []\n+        self.default_cols = False\n+        self.select_related = False\n+        self.set_extra_mask(())\n+        self.set_aggregate_mask(())\n+\n     def clear_select_fields(self):\n         \"\"\"\n         Clears the list of fields to select (but not extra_select columns)."
        },
        {
            "sha": "1371ef58e93b49c0e58f4a32c7fcbf67a3633b0d",
            "filename": "django/db/models/sql/subqueries.py",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "raw_url": "https://github.com/django/django/raw/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py?ref=f64a5ef404cb6fd28e008a01039a3beea2fa8e1b",
            "patch": "@@ -70,8 +70,9 @@ def delete_qs(self, query, using):\n                 self.delete_batch(values, using)\n                 return\n             else:\n-                values = innerq\n+                innerq.clear_select_clause()\n                 innerq.select = [(self.get_initial_alias(), pk.column)]\n+                values = innerq\n             where = self.where_class()\n             where.add((Constraint(None, pk.column, pk), 'in', values), AND)\n             self.where = where\n@@ -237,11 +238,8 @@ def add_date_select(self, field_name, lookup_type, order='ASC'):\n                 % field.name\n         alias = result[3][-1]\n         select = Date((alias, field.column), lookup_type)\n+        self.clear_select_clause()\n         self.select = [select]\n-        self.select_fields = [None]\n-        self.select_related = False # See #7097.\n-        self.aggregates = SortedDict() # See 18056.\n-        self.set_extra_mask([])\n         self.distinct = True\n         self.order_by = order == 'ASC' and [1] or [-1]\n "
        },
        {
            "sha": "dbe383fb419155a3358ce431a7c18736700198da",
            "filename": "tests/regressiontests/delete_regress/models.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py?ref=f64a5ef404cb6fd28e008a01039a3beea2fa8e1b",
            "patch": "@@ -2,7 +2,6 @@\n from django.contrib.contenttypes.models import ContentType\n from django.db import models\n \n-\n class Award(models.Model):\n     name = models.CharField(max_length=25)\n     object_id = models.PositiveIntegerField()\n@@ -93,3 +92,10 @@ class FooPhoto(models.Model):\n class FooFileProxy(FooFile):\n     class Meta:\n         proxy = True\n+\n+class OrgUnit(models.Model):\n+    name = models.CharField(max_length=64, unique=True)\n+\n+class Login(models.Model):\n+    description = models.CharField(max_length=32)\n+    orgunit = models.ForeignKey(OrgUnit)"
        },
        {
            "sha": "ec0d460f17a26f0490b71e18bff834c4a948880f",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 85,
            "deletions": 1,
            "changes": 86,
            "blob_url": "https://github.com/django/django/blob/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f64a5ef404cb6fd28e008a01039a3beea2fa8e1b/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=f64a5ef404cb6fd28e008a01039a3beea2fa8e1b",
            "patch": "@@ -8,7 +8,8 @@\n \n from .models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n     PlayedWithNote, Email, Researcher, Food, Eaten, Policy, Version, Location,\n-    Item, Image, File, Photo, FooFile, FooImage, FooPhoto, FooFileProxy)\n+    Item, Image, File, Photo, FooFile, FooImage, FooPhoto, FooFileProxy, Login,\n+    OrgUnit)\n \n \n # Can't run this test under SQLite, because you can't\n@@ -265,3 +266,86 @@ def test_delete_proxy_pair(self):\n         Image.objects.all().delete()\n \n         self.assertEqual(len(FooFileProxy.objects.all()), 0)\n+\n+class Ticket19102Tests(TestCase):\n+    \"\"\"\n+    Test different queries which alter the SELECT clause of the query. We\n+    also must be using a subquery for the deletion (that is, the original\n+    query has a join in it). The deletion should be done as \"fast-path\"\n+    deletion (that is, just one query for the .delete() call).\n+\n+    Note that .values() is not tested here on purpose. .values().delete()\n+    doesn't work for non fast-path deletes at all.\n+    \"\"\"\n+    def setUp(self):\n+        self.o1 = OrgUnit.objects.create(name='o1')\n+        self.o2 = OrgUnit.objects.create(name='o2')\n+        self.l1 = Login.objects.create(description='l1', orgunit=self.o1)\n+        self.l2 = Login.objects.create(description='l2', orgunit=self.o2)\n+\n+    @skipUnlessDBFeature(\"update_can_self_select\")\n+    def test_ticket_19102_annotate(self):\n+        with self.assertNumQueries(1):\n+            Login.objects.order_by('description').filter(\n+                orgunit__name__isnull=False\n+            ).annotate(\n+                n=models.Count('description')\n+            ).filter(\n+                n=1, pk=self.l1.pk\n+            ).delete()\n+        self.assertFalse(Login.objects.filter(pk=self.l1.pk).exists())\n+        self.assertTrue(Login.objects.filter(pk=self.l2.pk).exists())\n+\n+    @skipUnlessDBFeature(\"update_can_self_select\")\n+    def test_ticket_19102_extra(self):\n+        with self.assertNumQueries(1):\n+            Login.objects.order_by('description').filter(\n+                orgunit__name__isnull=False\n+            ).extra(\n+                select={'extraf':'1'}\n+            ).filter(\n+                pk=self.l1.pk\n+            ).delete()\n+        self.assertFalse(Login.objects.filter(pk=self.l1.pk).exists())\n+        self.assertTrue(Login.objects.filter(pk=self.l2.pk).exists())\n+\n+    @skipUnlessDBFeature(\"update_can_self_select\")\n+    @skipUnlessDBFeature('can_distinct_on_fields')\n+    def test_ticket_19102_distinct_on(self):\n+        # Both Login objs should have same description so that only the one\n+        # having smaller PK will be deleted.\n+        Login.objects.update(description='description')\n+        with self.assertNumQueries(1):\n+            Login.objects.distinct('description').order_by('pk').filter(\n+                orgunit__name__isnull=False\n+            ).delete()\n+        # Assumed that l1 which is created first has smaller PK.\n+        self.assertFalse(Login.objects.filter(pk=self.l1.pk).exists())\n+        self.assertTrue(Login.objects.filter(pk=self.l2.pk).exists())\n+\n+    @skipUnlessDBFeature(\"update_can_self_select\")\n+    def test_ticket_19102_select_related(self):\n+        with self.assertNumQueries(1):\n+            Login.objects.filter(\n+                pk=self.l1.pk\n+            ).filter(\n+                orgunit__name__isnull=False\n+            ).order_by(\n+                'description'\n+            ).select_related('orgunit').delete()\n+        self.assertFalse(Login.objects.filter(pk=self.l1.pk).exists())\n+        self.assertTrue(Login.objects.filter(pk=self.l2.pk).exists())\n+    \n+    @skipUnlessDBFeature(\"update_can_self_select\")\n+    def test_ticket_19102_defer(self):\n+        with self.assertNumQueries(1):\n+            Login.objects.filter(\n+                pk=self.l1.pk\n+            ).filter(\n+                orgunit__name__isnull=False\n+            ).order_by(\n+                'description'\n+            ).only('id').delete()\n+        self.assertFalse(Login.objects.filter(pk=self.l1.pk).exists())\n+        self.assertTrue(Login.objects.filter(pk=self.l2.pk).exists())\n+"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 108,
        "deletions": 13
    }
}