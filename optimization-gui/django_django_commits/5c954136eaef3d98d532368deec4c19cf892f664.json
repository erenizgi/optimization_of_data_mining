{
    "author": "claudep",
    "message": "Fixed #15644 -- Improved Django File wrapper to support more file-like objects. Thanks nickname123 and Michael Palumbo for working on the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17871 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5c954136eaef3d98d532368deec4c19cf892f664",
    "files": [
        {
            "sha": "29dbb6fcc18f865dbd79f67e51b74dd0e855f7f6",
            "filename": "django/core/files/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/5c954136eaef3d98d532368deec4c19cf892f664/django%2Fcore%2Ffiles%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/5c954136eaef3d98d532368deec4c19cf892f664/django%2Fcore%2Ffiles%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fbase.py?ref=5c954136eaef3d98d532368deec4c19cf892f664",
            "patch": "@@ -36,8 +36,13 @@ def _get_size(self):\n         if not hasattr(self, '_size'):\n             if hasattr(self.file, 'size'):\n                 self._size = self.file.size\n-            elif os.path.exists(self.file.name):\n+            elif hasattr(self.file, 'name') and os.path.exists(self.file.name):\n                 self._size = os.path.getsize(self.file.name)\n+            elif hasattr(self.file, 'tell') and hasattr(self.file, 'seek'):\n+                pos = self.file.tell()\n+                self.file.seek(0, os.SEEK_END)\n+                self._size = self.file.tell()\n+                self.file.seek(pos)\n             else:\n                 raise AttributeError(\"Unable to determine the file's size.\")\n         return self._size\n@@ -61,12 +66,12 @@ def chunks(self, chunk_size=None):\n \n         if hasattr(self, 'seek'):\n             self.seek(0)\n-        # Assume the pointer is at zero...\n-        counter = self.size\n \n-        while counter > 0:\n-            yield self.read(chunk_size)\n-            counter -= chunk_size\n+        while True:\n+            data = self.read(chunk_size)\n+            if not data:\n+                break\n+            yield data\n \n     def multiple_chunks(self, chunk_size=None):\n         \"\"\""
        },
        {
            "sha": "c28b019c8487fa0fb85be9c4c510805325862d7e",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 41,
            "deletions": 2,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/5c954136eaef3d98d532368deec4c19cf892f664/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5c954136eaef3d98d532368deec4c19cf892f664/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=5c954136eaef3d98d532368deec4c19cf892f664",
            "patch": "@@ -1,4 +1,6 @@\n # -*- coding: utf-8 -*-\n+from __future__ import absolute_import\n+\n import errno\n import os\n import shutil\n@@ -17,12 +19,13 @@\n \n from django.conf import settings\n from django.core.exceptions import SuspiciousOperation, ImproperlyConfigured\n-from django.core.files.base import ContentFile\n+from django.core.files.base import File, ContentFile\n from django.core.files.images import get_image_dimensions\n from django.core.files.storage import FileSystemStorage, get_storage_class\n from django.core.files.uploadedfile import UploadedFile\n from django.test import SimpleTestCase\n from django.utils import unittest\n+from ..servers.tests import LiveServerBase\n \n # Try to import PIL in either of the two ways it can end up installed.\n # Checking for the existence of Image is enough for CPython, but\n@@ -544,6 +547,42 @@ class ContentFileTestCase(unittest.TestCase):\n     def test_content_file_default_name(self):\n         self.assertEqual(ContentFile(\"content\").name, None)\n \n-    def test_content_file_custome_name(self):\n+    def test_content_file_custom_name(self):\n         name = \"I can have a name too!\"\n         self.assertEqual(ContentFile(\"content\", name=name).name, name)\n+\n+class NoNameFileTestCase(unittest.TestCase):\n+    \"\"\"\n+    Other examples of unnamed files may be tempfile.SpooledTemporaryFile or\n+    urllib.urlopen()\n+    \"\"\"\n+    def test_noname_file_default_name(self):\n+        self.assertEqual(File(StringIO('A file with no name')).name, None)\n+\n+    def test_noname_file_get_size(self):\n+        self.assertEqual(File(StringIO('A file with no name')).size, 19)\n+\n+class FileLikeObjectTestCase(LiveServerBase):\n+    \"\"\"\n+    Test file-like objects (#15644).\n+    \"\"\"\n+    def setUp(self):\n+        self.temp_dir = tempfile.mkdtemp()\n+        self.storage = FileSystemStorage(location=self.temp_dir)\n+\n+    def tearDown(self):\n+        shutil.rmtree(self.temp_dir)\n+\n+    def test_urllib2_urlopen(self):\n+        \"\"\"\n+        Test the File storage API with a file like object coming from urllib2.urlopen()\n+        \"\"\"\n+\n+        file_like_object = self.urlopen('/example_view/')\n+        f = File(file_like_object)\n+        stored_filename = self.storage.save(\"remote_file.html\", f)\n+\n+        stored_file = self.storage.open(stored_filename)\n+        remote_file = self.urlopen('/example_view/')\n+\n+        self.assertEqual(stored_file.read(), remote_file.read())"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 52,
        "deletions": 8
    }
}