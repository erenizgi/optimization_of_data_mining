{
    "author": "spookylukey",
    "message": "Fixed #17696 - Queryset prefetch_related() ignores using()\n\nThanks to simon29 for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17605 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3db5b0e48554ccc76becefb86b630c9cf72be9f1",
    "files": [
        {
            "sha": "5ed81a36642e2878e357712fe50a2b9653d49ce6",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/3db5b0e48554ccc76becefb86b630c9cf72be9f1/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/3db5b0e48554ccc76becefb86b630c9cf72be9f1/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=3db5b0e48554ccc76becefb86b630c9cf72be9f1",
            "patch": "@@ -321,7 +321,7 @@ def get_query_set(self):\n                 return super(GenericRelatedObjectManager, self).get_query_set().using(db).filter(**self.core_filters)\n \n         def get_prefetch_query_set(self, instances):\n-            db = self._db or router.db_for_read(self.model)\n+            db = self._db or router.db_for_read(self.model, instance=instances[0])\n             query = {\n                 '%s__pk' % self.content_type_field_name: self.content_type.id,\n                 '%s__in' % self.object_id_field_name:"
        },
        {
            "sha": "e23c7dc9b0cde3c9cfb406f6c1ee78bf80f52278",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/3db5b0e48554ccc76becefb86b630c9cf72be9f1/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/3db5b0e48554ccc76becefb86b630c9cf72be9f1/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=3db5b0e48554ccc76becefb86b630c9cf72be9f1",
            "patch": "@@ -239,7 +239,7 @@ def get_query_set(self, **db_hints):\n     def get_prefetch_query_set(self, instances):\n         vals = set(instance._get_pk_val() for instance in instances)\n         params = {'%s__pk__in' % self.related.field.name: vals}\n-        return (self.get_query_set(),\n+        return (self.get_query_set(instance=instances[0]),\n                 attrgetter(self.related.field.attname),\n                 lambda obj: obj._get_pk_val(),\n                 True,\n@@ -322,7 +322,7 @@ def get_prefetch_query_set(self, instances):\n             params = {'%s__pk__in' % self.field.rel.field_name: vals}\n         else:\n             params = {'%s__in' % self.field.rel.field_name: vals}\n-        return (self.get_query_set().filter(**params),\n+        return (self.get_query_set(instance=instances[0]).filter(**params),\n                 attrgetter(self.field.rel.field_name),\n                 attrgetter(self.field.attname),\n                 True,\n@@ -461,7 +461,7 @@ def get_query_set(self):\n                     return super(RelatedManager, self).get_query_set().using(db).filter(**self.core_filters)\n \n             def get_prefetch_query_set(self, instances):\n-                db = self._db or router.db_for_read(self.model)\n+                db = self._db or router.db_for_read(self.model, instance=instances[0])\n                 query = {'%s__%s__in' % (rel_field.name, attname):\n                              set(getattr(obj, attname) for obj in instances)}\n                 qs = super(RelatedManager, self).get_query_set().using(db).filter(**query)\n@@ -543,8 +543,9 @@ def get_query_set(self):\n                 return super(ManyRelatedManager, self).get_query_set().using(db)._next_is_sticky().filter(**self.core_filters)\n \n         def get_prefetch_query_set(self, instances):\n+            instance = instances[0]\n             from django.db import connections\n-            db = self._db or router.db_for_read(self.model)\n+            db = self._db or router.db_for_read(instance.__class__, instance=instance)\n             query = {'%s__pk__in' % self.query_field_name:\n                          set(obj._get_pk_val() for obj in instances)}\n             qs = super(ManyRelatedManager, self).get_query_set().using(db)._next_is_sticky().filter(**query)"
        },
        {
            "sha": "0a757271e272fabf8bf20da08f23bc87193fd32d",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/django/django/blob/3db5b0e48554ccc76becefb86b630c9cf72be9f1/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3db5b0e48554ccc76becefb86b630c9cf72be9f1/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=3db5b0e48554ccc76becefb86b630c9cf72be9f1",
            "patch": "@@ -483,3 +483,92 @@ def test_in_bulk(self):\n             bulk = Employee.objects.prefetch_related('serfs').in_bulk([boss1.pk, boss2.pk])\n             for b in bulk.values():\n                 list(b.serfs.all())\n+\n+\n+class MultiDbTests(TestCase):\n+    multi_db = True\n+\n+    def test_using_is_honored_m2m(self):\n+        B = Book.objects.using('other')\n+        A = Author.objects.using('other')\n+        book1 = B.create(title=\"Poems\")\n+        book2 = B.create(title=\"Jane Eyre\")\n+        book3 = B.create(title=\"Wuthering Heights\")\n+        book4 = B.create(title=\"Sense and Sensibility\")\n+\n+        author1 = A.create(name=\"Charlotte\", first_book=book1)\n+        author2 = A.create(name=\"Anne\", first_book=book1)\n+        author3 = A.create(name=\"Emily\", first_book=book1)\n+        author4 = A.create(name=\"Jane\", first_book=book4)\n+\n+        book1.authors.add(author1, author2, author3)\n+        book2.authors.add(author1)\n+        book3.authors.add(author3)\n+        book4.authors.add(author4)\n+\n+        # Forward\n+        qs1 = B.prefetch_related('authors')\n+        with self.assertNumQueries(2, using='other'):\n+            books = \"\".join([\"%s (%s)\\n\" %\n+                             (book.title, \", \".join(a.name for a in book.authors.all()))\n+                             for book in qs1])\n+        self.assertEqual(books,\n+                         \"Poems (Charlotte, Anne, Emily)\\n\"\n+                         \"Jane Eyre (Charlotte)\\n\"\n+                         \"Wuthering Heights (Emily)\\n\"\n+                         \"Sense and Sensibility (Jane)\\n\")\n+\n+        # Reverse\n+        qs2 = A.prefetch_related('books')\n+        with self.assertNumQueries(2, using='other'):\n+            authors = \"\".join([\"%s: %s\\n\" %\n+                               (author.name, \", \".join(b.title for b in author.books.all()))\n+                               for author in qs2])\n+        self.assertEquals(authors,\n+                          \"Charlotte: Poems, Jane Eyre\\n\"\n+                          \"Anne: Poems\\n\"\n+                          \"Emily: Poems, Wuthering Heights\\n\"\n+                          \"Jane: Sense and Sensibility\\n\")\n+\n+    def test_using_is_honored_fkey(self):\n+        B = Book.objects.using('other')\n+        A = Author.objects.using('other')\n+        book1 = B.create(title=\"Poems\")\n+        book2 = B.create(title=\"Sense and Sensibility\")\n+\n+        author1 = A.create(name=\"Charlotte Bronte\", first_book=book1)\n+        author2 = A.create(name=\"Jane Austen\", first_book=book2)\n+\n+        # Forward\n+        with self.assertNumQueries(2, using='other'):\n+            books = \", \".join(a.first_book.title for a in A.prefetch_related('first_book'))\n+        self.assertEqual(\"Poems, Sense and Sensibility\", books)\n+\n+        # Reverse\n+        with self.assertNumQueries(2, using='other'):\n+            books = \"\".join(\"%s (%s)\\n\" %\n+                            (b.title, \", \".join(a.name for a in b.first_time_authors.all()))\n+                            for b in B.prefetch_related('first_time_authors'))\n+        self.assertEqual(books,\n+                         \"Poems (Charlotte Bronte)\\n\"\n+                         \"Sense and Sensibility (Jane Austen)\\n\")\n+\n+    def test_using_is_honored_inheritance(self):\n+        B = BookWithYear.objects.using('other')\n+        A = AuthorWithAge.objects.using('other')\n+        book1 = B.create(title=\"Poems\", published_year=2010)\n+        book2 = B.create(title=\"More poems\", published_year=2011)\n+        author1 = A.create(name='Jane', first_book=book1, age=50)\n+        author2 = A.create(name='Tom', first_book=book1, age=49)\n+\n+        # parent link\n+        with self.assertNumQueries(2, using='other'):\n+            authors = \", \".join(a.author.name for a in A.prefetch_related('author'))\n+\n+        self.assertEqual(authors, \"Jane, Tom\")\n+\n+        # child link\n+        with self.assertNumQueries(2, using='other'):\n+            ages = \", \".join(str(a.authorwithage.age) for a in A.prefetch_related('authorwithage'))\n+\n+        self.assertEqual(ages, \"50, 49\")"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 95,
        "deletions": 5
    }
}