{
    "author": "unknown",
    "message": "Fixed #15900 -- Calls to reverse with nested namespaced urls are escaped properly and capture parameters as expected.\n\nThanks to teolicy for the report, and dmclain for the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17251 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a0721a30178d621501756db543258bc2d527af21",
    "files": [
        {
            "sha": "b634b566853a75ae4474cfe5fb30b204349e0829",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/a0721a30178d621501756db543258bc2d527af21/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/a0721a30178d621501756db543258bc2d527af21/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=a0721a30178d621501756db543258bc2d527af21",
            "patch": "@@ -351,22 +351,26 @@ def resolve500(self):\n         return self._resolve_special('500')\n \n     def reverse(self, lookup_view, *args, **kwargs):\n+        return self._reverse_with_prefix(lookup_view, '', *args, **kwargs)\n+\n+    def _reverse_with_prefix(self, lookup_view, _prefix, *args, **kwargs):\n         if args and kwargs:\n             raise ValueError(\"Don't mix *args and **kwargs in call to reverse()!\")\n         try:\n             lookup_view = get_callable(lookup_view, True)\n         except (ImportError, AttributeError), e:\n             raise NoReverseMatch(\"Error importing '%s': %s.\" % (lookup_view, e))\n         possibilities = self.reverse_dict.getlist(lookup_view)\n+        prefix_norm, prefix_args = normalize(_prefix)[0]\n         for possibility, pattern, defaults in possibilities:\n             for result, params in possibility:\n                 if args:\n-                    if len(args) != len(params):\n+                    if len(args) != len(params) + len(prefix_args):\n                         continue\n                     unicode_args = [force_unicode(val) for val in args]\n-                    candidate =  result % dict(zip(params, unicode_args))\n+                    candidate =  (prefix_norm + result) % dict(zip(prefix_args + params, unicode_args))\n                 else:\n-                    if set(kwargs.keys() + defaults.keys()) != set(params + defaults.keys()):\n+                    if set(kwargs.keys() + defaults.keys()) != set(params + defaults.keys() + prefix_args):\n                         continue\n                     matches = True\n                     for k, v in defaults.items():\n@@ -376,8 +380,8 @@ def reverse(self, lookup_view, *args, **kwargs):\n                     if not matches:\n                         continue\n                     unicode_kwargs = dict([(k, force_unicode(v)) for (k, v) in kwargs.items()])\n-                    candidate = result % unicode_kwargs\n-                if re.search(u'^%s' % pattern, candidate, re.UNICODE):\n+                    candidate = (prefix_norm + result) % unicode_kwargs\n+                if re.search(u'^%s%s' % (_prefix, pattern), candidate, re.UNICODE):\n                     return candidate\n         # lookup_view can be URL label, or dotted path, or callable, Any of\n         # these can be passed in at the top, but callables are not friendly in\n@@ -469,8 +473,7 @@ def reverse(viewname, urlconf=None, args=None, kwargs=None, prefix=None, current\n         if ns_pattern:\n             resolver = get_ns_resolver(ns_pattern, resolver)\n \n-    return iri_to_uri(u'%s%s' %\n-                      (prefix, resolver.reverse(view, *args, **kwargs)))\n+    return iri_to_uri(resolver._reverse_with_prefix(view, prefix, *args, **kwargs))\n \n reverse_lazy = lazy(reverse, str)\n "
        },
        {
            "sha": "fa892a4346f3398ea9603e85a7f1fe7ad49b8d64",
            "filename": "tests/regressiontests/urlpatterns_reverse/namespace_urls.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/a0721a30178d621501756db543258bc2d527af21/tests%2Fregressiontests%2Furlpatterns_reverse%2Fnamespace_urls.py",
            "raw_url": "https://github.com/django/django/raw/a0721a30178d621501756db543258bc2d527af21/tests%2Fregressiontests%2Furlpatterns_reverse%2Fnamespace_urls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Fnamespace_urls.py?ref=a0721a30178d621501756db543258bc2d527af21",
            "patch": "@@ -44,12 +44,13 @@ def urls(self):\n     (r'^default/', include(default_testobj.urls)),\n \n     (r'^other1/', include(otherobj1.urls)),\n-    (r'^other2/', include(otherobj2.urls)),\n+    (r'^other[246]/', include(otherobj2.urls)),\n \n-    (r'^ns-included1/', include('regressiontests.urlpatterns_reverse.included_namespace_urls', namespace='inc-ns1')),\n+    (r'^ns-included[135]/', include('regressiontests.urlpatterns_reverse.included_namespace_urls', namespace='inc-ns1')),\n     (r'^ns-included2/', include('regressiontests.urlpatterns_reverse.included_namespace_urls', namespace='inc-ns2')),\n \n     (r'^included/', include('regressiontests.urlpatterns_reverse.included_namespace_urls')),\n+    (r'^inc(?P<outer>\\d+)/', include('regressiontests.urlpatterns_reverse.included_urls', namespace='inc-ns5')),\n \n     (r'^ns-outer/(?P<outer>\\d+)/', include('regressiontests.urlpatterns_reverse.included_namespace_urls', namespace='inc-outer')),\n "
        },
        {
            "sha": "a5df26f1a182ee31211c2949a1c169fe7d71e901",
            "filename": "tests/regressiontests/urlpatterns_reverse/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/a0721a30178d621501756db543258bc2d527af21/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a0721a30178d621501756db543258bc2d527af21/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py?ref=a0721a30178d621501756db543258bc2d527af21",
            "patch": "@@ -48,6 +48,10 @@\n     # Nested namespaces\n     ('/ns-included1/test3/inner/42/37/', 'urlobject-view', 'testapp', 'inc-ns1:test-ns3', 'empty_view', tuple(), {'arg1': '42', 'arg2': '37'}),\n     ('/ns-included1/ns-included4/ns-included2/test3/inner/42/37/', 'urlobject-view', 'testapp', 'inc-ns1:inc-ns4:inc-ns2:test-ns3', 'empty_view', tuple(), {'arg1': '42', 'arg2': '37'}),\n+\n+    # Namespaces capturing variables\n+    ('/inc70/', 'inner-nothing', None, 'inc-ns5', views.empty_view, tuple(), {'outer': '70'}),\n+    ('/inc78/extra/foobar/', 'inner-extra', None, 'inc-ns5', views.empty_view, tuple(), {'outer':'78', 'extra':'foobar'}),\n )\n \n test_data = (\n@@ -379,6 +383,13 @@ def test_special_chars_namespace(self):\n         self.assertEqual('/+%5C$*/included/normal/42/37/', reverse('special:inc-normal-view', kwargs={'arg1':42, 'arg2':37}))\n         self.assertEqual('/+%5C$*/included/+%5C$*/', reverse('special:inc-special-view'))\n \n+    def test_namespaces_with_variables(self):\n+        \"Namespace prefixes can capture variables: see #15900\"\n+        self.assertEqual('/inc70/', reverse('inc-ns5:inner-nothing', kwargs={'outer': '70'}))\n+        self.assertEqual('/inc78/extra/foobar/', reverse('inc-ns5:inner-extra', kwargs={'outer':'78', 'extra':'foobar'}))\n+        self.assertEqual('/inc70/', reverse('inc-ns5:inner-nothing', args=['70']))\n+        self.assertEqual('/inc78/extra/foobar/', reverse('inc-ns5:inner-extra', args=['78','foobar']))\n+\n class RequestURLconfTests(TestCase):\n     def setUp(self):\n         self.root_urlconf = settings.ROOT_URLCONF"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 24,
        "deletions": 9
    }
}