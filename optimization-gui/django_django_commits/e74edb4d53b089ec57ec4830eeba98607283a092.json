{
    "author": "SmileyChris",
    "message": "Fixes #11025 -- ability to specify LOGIN_URL as full qualified absolute URL.\n\nauth.views.login now allows for login redirections for different schemes\nwith the same host (or no host even, e.g. 'https:///login/')\n\nauth.decorators.login_required can now use lazy urls (refs #5925)\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14733 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e74edb4d53b089ec57ec4830eeba98607283a092",
    "files": [
        {
            "sha": "64b77a5f9648e857f63aeb3c4d15f31d812e563a",
            "filename": "django/contrib/auth/decorators.py",
            "status": "modified",
            "additions": 17,
            "deletions": 11,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Fdecorators.py",
            "raw_url": "https://github.com/django/django/raw/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Fdecorators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fdecorators.py?ref=e74edb4d53b089ec57ec4830eeba98607283a092",
            "patch": "@@ -1,12 +1,12 @@\n+import urlparse\n try:\n-    from functools import update_wrapper, wraps\n+    from functools import wraps\n except ImportError:\n-    from django.utils.functional import update_wrapper, wraps  # Python 2.4 fallback.\n+    from django.utils.functional import wraps  # Python 2.4 fallback.\n \n+from django.conf import settings\n from django.contrib.auth import REDIRECT_FIELD_NAME\n-from django.http import HttpResponseRedirect\n from django.utils.decorators import available_attrs\n-from django.utils.http import urlquote\n \n \n def user_passes_test(test_func, login_url=None, redirect_field_name=REDIRECT_FIELD_NAME):\n@@ -15,18 +15,24 @@ def user_passes_test(test_func, login_url=None, redirect_field_name=REDIRECT_FIE\n     redirecting to the log-in page if necessary. The test should be a callable\n     that takes the user object and returns True if the user passes.\n     \"\"\"\n-    if not login_url:\n-        from django.conf import settings\n-        login_url = settings.LOGIN_URL\n \n     def decorator(view_func):\n+        @wraps(view_func, assigned=available_attrs(view_func))\n         def _wrapped_view(request, *args, **kwargs):\n             if test_func(request.user):\n                 return view_func(request, *args, **kwargs)\n-            path = urlquote(request.get_full_path())\n-            tup = login_url, redirect_field_name, path\n-            return HttpResponseRedirect('%s?%s=%s' % tup)\n-        return wraps(view_func, assigned=available_attrs(view_func))(_wrapped_view)\n+            path = request.build_absolute_uri()\n+            # If the login url is the same scheme and net location then just\n+            # use the path as the \"next\" url.\n+            login_scheme, login_netloc = urlparse.urlparse(login_url or\n+                                                        settings.LOGIN_URL)[:2]\n+            current_scheme, current_netloc = urlparse.urlparse(path)[:2]\n+            if ((not login_scheme or login_scheme == current_scheme) and\n+                (not login_netloc or login_netloc == current_netloc)):\n+                path = request.get_full_path()\n+            from django.contrib.auth.views import redirect_to_login\n+            return redirect_to_login(path, login_url, redirect_field_name)\n+        return _wrapped_view\n     return decorator\n \n "
        },
        {
            "sha": "442ee050b100a44add2d2c1779ecac6bdb8bae54",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=e74edb4d53b089ec57ec4830eeba98607283a092",
            "patch": "@@ -7,7 +7,7 @@\n from django.contrib.auth.tests.models import ProfileTestCase\n from django.contrib.auth.tests.signals import SignalTestCase\n from django.contrib.auth.tests.tokens import TokenGeneratorTest\n-from django.contrib.auth.tests.views \\\n-        import PasswordResetTest, ChangePasswordTest, LoginTest, LogoutTest\n+from django.contrib.auth.tests.views import PasswordResetTest, \\\n+    ChangePasswordTest, LoginTest, LogoutTest, LoginURLSettings\n \n # The password for the fixture data users is 'password'"
        },
        {
            "sha": "88867d538cf8fb52717683bf5d9a780174b3d3d9",
            "filename": "django/contrib/auth/tests/views.py",
            "status": "modified",
            "additions": 75,
            "deletions": 15,
            "changes": 90,
            "blob_url": "https://github.com/django/django/blob/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py?ref=e74edb4d53b089ec57ec4830eeba98607283a092",
            "patch": "@@ -5,11 +5,12 @@\n from django.conf import settings\n from django.contrib.auth import SESSION_KEY, REDIRECT_FIELD_NAME\n from django.contrib.auth.forms import AuthenticationForm\n-from django.contrib.sites.models import Site, RequestSite\n+from django.contrib.sites.models import Site\n from django.contrib.auth.models import User\n from django.test import TestCase\n from django.core import mail\n from django.core.urlresolvers import reverse\n+from django.http import QueryDict\n \n class AuthViewsTestCase(TestCase):\n     \"\"\"\n@@ -25,11 +26,8 @@ def setUp(self):\n         settings.LANGUAGE_CODE = 'en'\n         self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n         settings.TEMPLATE_DIRS = (\n-            os.path.join(\n-                os.path.dirname(__file__),\n-                'templates'\n-            )\n-        ,)\n+            os.path.join(os.path.dirname(__file__), 'templates'),\n+        )\n \n     def tearDown(self):\n         settings.LANGUAGES = self.old_LANGUAGES\n@@ -220,25 +218,87 @@ def test_security_check(self, password='password'):\n                 }\n             )\n             self.assertEquals(response.status_code, 302)\n-            self.assertFalse(bad_url in response['Location'], \"%s should be blocked\" % bad_url)\n-\n-        # Now, these URLs have an other URL as a GET parameter and therefore\n-        # should be allowed\n-        for url_ in ('http://example.com', 'https://example.com',\n-                    'ftp://exampel.com',  '//example.com'):\n-            safe_url = '%(url)s?%(next)s=/view/?param=%(safe_param)s' % {\n+            self.assertFalse(bad_url in response['Location'],\n+                             \"%s should be blocked\" % bad_url)\n+\n+        # These URLs *should* still pass the security check\n+        for good_url in ('/view/?param=http://example.com',\n+                         '/view/?param=https://example.com',\n+                         '/view?param=ftp://exampel.com',\n+                         'view/?param=//example.com',\n+                         'https:///',\n+                         '//testserver/'):\n+            safe_url = '%(url)s?%(next)s=%(good_url)s' % {\n                 'url': login_url,\n                 'next': REDIRECT_FIELD_NAME,\n-                'safe_param': urllib.quote(url_)\n+                'good_url': urllib.quote(good_url)\n             }\n             response = self.client.post(safe_url, {\n                     'username': 'testclient',\n                     'password': password,\n                 }\n             )\n             self.assertEquals(response.status_code, 302)\n-            self.assertTrue('/view/?param=%s' % url_ in response['Location'], \"/view/?param=%s should be allowed\" % url_)\n+            self.assertTrue(good_url in response['Location'],\n+                            \"%s should be allowed\" % good_url)\n \n+class LoginURLSettings(AuthViewsTestCase):\n+    urls = 'django.contrib.auth.tests.urls'\n+    \n+    def setUp(self):\n+        super(LoginURLSettings, self).setUp()\n+        self.old_LOGIN_URL = settings.LOGIN_URL\n+\n+    def tearDown(self):\n+        super(LoginURLSettings, self).tearDown()\n+        settings.LOGIN_URL = self.old_LOGIN_URL\n+\n+    def get_login_required_url(self, login_url):\n+        settings.LOGIN_URL = login_url\n+        response = self.client.get('/login_required/')\n+        self.assertEquals(response.status_code, 302)\n+        return response['Location']\n+\n+    def test_standard_login_url(self):\n+        login_url = '/login/'\n+        login_required_url = self.get_login_required_url(login_url)\n+        querystring = QueryDict('', mutable=True)\n+        querystring['next'] = '/login_required/'\n+        self.assertEqual(login_required_url,\n+             'http://testserver%s?%s' % (login_url, querystring.urlencode()))\n+\n+    def test_remote_login_url(self):\n+        login_url = 'http://remote.example.com/login'\n+        login_required_url = self.get_login_required_url(login_url)\n+        querystring = QueryDict('', mutable=True)\n+        querystring['next'] = 'http://testserver/login_required/'\n+        self.assertEqual(login_required_url,\n+                         '%s?%s' % (login_url, querystring.urlencode()))\n+\n+    def test_https_login_url(self):\n+        login_url = 'https:///login/'\n+        login_required_url = self.get_login_required_url(login_url)\n+        querystring = QueryDict('', mutable=True)\n+        querystring['next'] = 'http://testserver/login_required/'\n+        self.assertEqual(login_required_url,\n+                         '%s?%s' % (login_url, querystring.urlencode()))\n+\n+    def test_login_url_with_querystring(self):\n+        login_url = '/login/?pretty=1'\n+        login_required_url = self.get_login_required_url(login_url)\n+        querystring = QueryDict('pretty=1', mutable=True)\n+        querystring['next'] = '/login_required/'\n+        self.assertEqual(login_required_url, 'http://testserver/login/?%s' %\n+                         querystring.urlencode())\n+\n+    def test_remote_login_url_with_next_querystring(self):\n+        login_url = 'http://remote.example.com/login/'\n+        login_required_url = self.get_login_required_url('%s?next=/default/' %\n+                                                         login_url)\n+        querystring = QueryDict('', mutable=True)\n+        querystring['next'] = 'http://testserver/login_required/'\n+        self.assertEqual(login_required_url, '%s?%s' % (login_url,\n+                                                    querystring.urlencode()))\n         \n class LogoutTest(AuthViewsTestCase):\n     urls = 'django.contrib.auth.tests.urls'"
        },
        {
            "sha": "42ad68d3c3f47a07f511c4d99f33f81a4099567c",
            "filename": "django/contrib/auth/views.py",
            "status": "modified",
            "additions": 19,
            "deletions": 10,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/e74edb4d53b089ec57ec4830eeba98607283a092/django%2Fcontrib%2Fauth%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fviews.py?ref=e74edb4d53b089ec57ec4830eeba98607283a092",
            "patch": "@@ -1,4 +1,5 @@\n import re\n+import urlparse\n from django.conf import settings\n from django.contrib.auth import REDIRECT_FIELD_NAME\n # Avoid shadowing the login() view below.\n@@ -11,9 +12,9 @@\n from django.core.urlresolvers import reverse\n from django.shortcuts import render_to_response, get_object_or_404\n from django.contrib.sites.models import get_current_site\n-from django.http import HttpResponseRedirect, Http404\n+from django.http import HttpResponseRedirect, Http404, QueryDict\n from django.template import RequestContext\n-from django.utils.http import urlquote, base36_to_int\n+from django.utils.http import base36_to_int\n from django.utils.translation import ugettext as _\n from django.contrib.auth.models import User\n from django.views.decorators.cache import never_cache\n@@ -30,16 +31,16 @@ def login(request, template_name='registration/login.html',\n     if request.method == \"POST\":\n         form = authentication_form(data=request.POST)\n         if form.is_valid():\n+            netloc = urlparse.urlparse(redirect_to)[1]\n+\n             # Light security check -- make sure redirect_to isn't garbage.\n             if not redirect_to or ' ' in redirect_to:\n                 redirect_to = settings.LOGIN_REDIRECT_URL\n \n-            # Heavier security check -- redirects to http://example.com should\n-            # not be allowed, but things like /view/?param=http://example.com\n-            # should be allowed. This regex checks if there is a '//' *before* a\n-            # question mark.\n-            elif '//' in redirect_to and re.match(r'[^\\?]*//', redirect_to):\n-                    redirect_to = settings.LOGIN_REDIRECT_URL\n+            # Heavier security check -- don't allow redirection to a different\n+            # host.\n+            elif netloc and netloc != request.get_host():\n+                redirect_to = settings.LOGIN_REDIRECT_URL\n \n             # Okay, security checks complete. Log the user in.\n             auth_login(request, form.get_user())\n@@ -88,11 +89,19 @@ def logout_then_login(request, login_url=None):\n         login_url = settings.LOGIN_URL\n     return logout(request, login_url)\n \n-def redirect_to_login(next, login_url=None, redirect_field_name=REDIRECT_FIELD_NAME):\n+def redirect_to_login(next, login_url=None,\n+                      redirect_field_name=REDIRECT_FIELD_NAME):\n     \"Redirects the user to the login page, passing the given 'next' page\"\n     if not login_url:\n         login_url = settings.LOGIN_URL\n-    return HttpResponseRedirect('%s?%s=%s' % (login_url, urlquote(redirect_field_name), urlquote(next)))\n+\n+    login_url_parts = list(urlparse.urlparse(login_url))\n+    if redirect_field_name:\n+        querystring = QueryDict(login_url_parts[4], mutable=True)\n+        querystring[redirect_field_name] = next\n+        login_url_parts[4] = querystring.urlencode()\n+\n+    return HttpResponseRedirect(urlparse.urlunparse(login_url_parts))\n \n # 4 views for password reset:\n # - password_reset sends the mail"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 113,
        "deletions": 38
    }
}