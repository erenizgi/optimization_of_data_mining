{
    "author": "malcolmt",
    "message": "Fixed an isnull=False filtering edge-case. Fixes #15316.\n\nThe bulk of this patch is due to some fine analysis from Aleksandra\nSendecka.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16656 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2e56066a5b93b528fbce37285bac591b44bc6ed7",
    "files": [
        {
            "sha": "38c7601579c5b366a5027358a3806b24baeaddfb",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/2e56066a5b93b528fbce37285bac591b44bc6ed7/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/2e56066a5b93b528fbce37285bac591b44bc6ed7/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=2e56066a5b93b528fbce37285bac591b44bc6ed7",
            "patch": "@@ -448,6 +448,7 @@ answer newbie questions, and generally made Django that much better:\n     schwank@gmail.com\n     scott@staplefish.com\n     Ilya Semenov <semenov@inetss.com>\n+    Aleksandra Sendecka <asendecka@hauru.eu>\n     serbaut@gmail.com\n     John Shaffer <jshaffer2112@gmail.com>\n     Pete Shinners <pete@shinners.org>"
        },
        {
            "sha": "e5e11f472a19e1cb296b6de897c07acd75a9cdd6",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/2e56066a5b93b528fbce37285bac591b44bc6ed7/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/2e56066a5b93b528fbce37285bac591b44bc6ed7/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=2e56066a5b93b528fbce37285bac591b44bc6ed7",
            "patch": "@@ -1105,7 +1105,10 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n \n         # Process the join list to see if we can remove any inner joins from\n         # the far end (fewer tables in a query is better).\n-        col, alias, join_list = self.trim_joins(target, join_list, last, trim)\n+        nonnull_comparison = (lookup_type == 'isnull' and value is False)\n+        col, alias, join_list = self.trim_joins(target, join_list, last, trim,\n+                nonnull_comparison)\n+\n         if connector == OR:\n             # Some joins may need to be promoted when adding a new filter to a\n             # disjunction. We walk the list of new joins and where it diverges\n@@ -1442,7 +1445,7 @@ def setup_joins(self, names, opts, alias, dupe_multis, allow_many=True,\n \n         return field, target, opts, joins, last, extra_filters\n \n-    def trim_joins(self, target, join_list, last, trim):\n+    def trim_joins(self, target, join_list, last, trim, nonnull_check=False):\n         \"\"\"\n         Sometimes joins at the end of a multi-table sequence can be trimmed. If\n         the final join is against the same column as we are comparing against,\n@@ -1463,14 +1466,19 @@ def trim_joins(self, target, join_list, last, trim):\n         trimmed before anything. See the documentation of add_filter() for\n         details about this.\n \n+        The 'nonnull_check' parameter is True when we are using inner joins\n+        between tables explicitly to exclude NULL entries. In that case, the\n+        tables shouldn't be trimmed, because the very action of joining to them\n+        alters the result set.\n+\n         Returns the final active column and table alias and the new active\n         join_list.\n         \"\"\"\n         final = len(join_list)\n         penultimate = last.pop()\n         if penultimate == final:\n             penultimate = last.pop()\n-        if trim and len(join_list) > 1:\n+        if trim and final > 1:\n             extra = join_list[penultimate:]\n             join_list = join_list[:penultimate]\n             final = penultimate\n@@ -1483,12 +1491,13 @@ def trim_joins(self, target, join_list, last, trim):\n         alias = join_list[-1]\n         while final > 1:\n             join = self.alias_map[alias]\n-            if col != join[RHS_JOIN_COL] or join[JOIN_TYPE] != self.INNER:\n+            if (col != join[RHS_JOIN_COL] or join[JOIN_TYPE] != self.INNER or\n+                    nonnull_check):\n                 break\n             self.unref_alias(alias)\n             alias = join[LHS_ALIAS]\n             col = join[LHS_JOIN_COL]\n-            join_list = join_list[:-1]\n+            join_list.pop()\n             final -= 1\n             if final == penultimate:\n                 penultimate = last.pop()"
        },
        {
            "sha": "bb8099f60df811353122f1cec191e9c1ef80a95c",
            "filename": "tests/regressiontests/queries/models.py",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/2e56066a5b93b528fbce37285bac591b44bc6ed7/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/2e56066a5b93b528fbce37285bac591b44bc6ed7/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Fmodels.py?ref=2e56066a5b93b528fbce37285bac591b44bc6ed7",
            "patch": "@@ -317,3 +317,29 @@ class ObjectC(models.Model):\n \n     def __unicode__(self):\n        return self.name\n+\n+class SimpleCategory(models.Model):\n+    name = models.CharField(max_length=10)\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class SpecialCategory(SimpleCategory):\n+    special_name = models.CharField(max_length=10)\n+\n+    def __unicode__(self):\n+        return self.name + \" \" + self.special_name\n+\n+class CategoryItem(models.Model):\n+    category = models.ForeignKey(SimpleCategory)\n+\n+    def __unicode__(self):\n+ \t    return \"category item: \" + str(self.category)\n+\n+class OneToOneCategory(models.Model):\n+    new_name = models.CharField(max_length=10)\n+    category = models.OneToOneField(SimpleCategory)\n+\n+    def __unicode__(self):\n+        return \"one2one \" + self.new_name\n+    \n\\ No newline at end of file"
        },
        {
            "sha": "a66752ab82f246a9fc66f7635d9e34bc9e8024d0",
            "filename": "tests/regressiontests/queries/tests.py",
            "status": "modified",
            "additions": 127,
            "deletions": 3,
            "changes": 130,
            "blob_url": "https://github.com/django/django/blob/2e56066a5b93b528fbce37285bac591b44bc6ed7/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2e56066a5b93b528fbce37285bac591b44bc6ed7/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Ftests.py?ref=2e56066a5b93b528fbce37285bac591b44bc6ed7",
            "patch": "@@ -15,7 +15,7 @@\n     DumbCategory, ExtraInfo, Fan, Item, LeafA, LoopX, LoopZ, ManagedModel,\n     Member, NamedCategory, Note, Number, Plaything, PointerA, Ranking, Related,\n     Report, ReservedName, Tag, TvChef, Valid, X, Food, Eaten, Node, ObjectA, ObjectB,\n-    ObjectC)\n+    ObjectC, CategoryItem, SimpleCategory, SpecialCategory, OneToOneCategory)\n \n \n class BaseQuerysetTest(TestCase):\n@@ -1043,11 +1043,135 @@ def test_ticket10181(self):\n             []\n         )\n \n+    def test_ticket15316_filter_false(self):\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        c2 = SpecialCategory.objects.create(name=\"named category1\",\n+                special_name=\"special1\")\n+        c3 = SpecialCategory.objects.create(name=\"named category2\",\n+                special_name=\"special2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c1)\n+        ci2 = CategoryItem.objects.create(category=c2)\n+        ci3 = CategoryItem.objects.create(category=c3)\n+\n+        qs = CategoryItem.objects.filter(category__specialcategory__isnull=False)\n+        self.assertEqual(qs.count(), 2)\n+        self.assertQuerysetEqual(qs, [ci2.pk, ci3.pk], lambda x: x.pk, False)\n+\n+    def test_ticket15316_exclude_false(self):\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        c2 = SpecialCategory.objects.create(name=\"named category1\",\n+                special_name=\"special1\")\n+        c3 = SpecialCategory.objects.create(name=\"named category2\",\n+                special_name=\"special2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c1)\n+        ci2 = CategoryItem.objects.create(category=c2)\n+        ci3 = CategoryItem.objects.create(category=c3)\n+\n+        qs = CategoryItem.objects.exclude(category__specialcategory__isnull=False)\n+        self.assertEqual(qs.count(), 1)\n+        self.assertQuerysetEqual(qs, [ci1.pk], lambda x: x.pk)\n+\n+    def test_ticket15316_filter_true(self):\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        c2 = SpecialCategory.objects.create(name=\"named category1\",\n+                special_name=\"special1\")\n+        c3 = SpecialCategory.objects.create(name=\"named category2\",\n+                special_name=\"special2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c1)\n+        ci2 = CategoryItem.objects.create(category=c2)\n+        ci3 = CategoryItem.objects.create(category=c3)\n+\n+        qs = CategoryItem.objects.filter(category__specialcategory__isnull=True)\n+        self.assertEqual(qs.count(), 1)\n+        self.assertQuerysetEqual(qs, [ci1.pk], lambda x: x.pk)\n+\n+    def test_ticket15316_exclude_true(self):\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        c2 = SpecialCategory.objects.create(name=\"named category1\",\n+                special_name=\"special1\")\n+        c3 = SpecialCategory.objects.create(name=\"named category2\",\n+                special_name=\"special2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c1)\n+        ci2 = CategoryItem.objects.create(category=c2)\n+        ci3 = CategoryItem.objects.create(category=c3)\n+\n+        qs = CategoryItem.objects.exclude(category__specialcategory__isnull=True)\n+        self.assertEqual(qs.count(), 2)\n+        self.assertQuerysetEqual(qs, [ci2.pk, ci3.pk], lambda x: x.pk, False)\n+\n+    def test_ticket15316_one2one_filter_false(self):\n+        c  = SimpleCategory.objects.create(name=\"cat\")\n+        c0 = SimpleCategory.objects.create(name=\"cat0\")\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        \n+        c2 = OneToOneCategory.objects.create(category = c1, new_name=\"new1\")\n+        c3 = OneToOneCategory.objects.create(category = c0, new_name=\"new2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c)\n+        ci2 = CategoryItem.objects.create(category=c0)\n+        ci3 = CategoryItem.objects.create(category=c1)\n+\n+        qs = CategoryItem.objects.filter(category__onetoonecategory__isnull=False)\n+        self.assertEqual(qs.count(), 2)\n+        self.assertQuerysetEqual(qs, [ci2.pk, ci3.pk], lambda x: x.pk, False)\n+\n+    def test_ticket15316_one2one_exclude_false(self):\n+        c  = SimpleCategory.objects.create(name=\"cat\")\n+        c0 = SimpleCategory.objects.create(name=\"cat0\")\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        \n+        c2 = OneToOneCategory.objects.create(category = c1, new_name=\"new1\")\n+        c3 = OneToOneCategory.objects.create(category = c0, new_name=\"new2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c)\n+        ci2 = CategoryItem.objects.create(category=c0)\n+        ci3 = CategoryItem.objects.create(category=c1)\n+\n+        qs = CategoryItem.objects.exclude(category__onetoonecategory__isnull=False)\n+        self.assertEqual(qs.count(), 1)\n+        self.assertQuerysetEqual(qs, [ci1.pk], lambda x: x.pk)\n+\n+    def test_ticket15316_one2one_filter_true(self):\n+        c  = SimpleCategory.objects.create(name=\"cat\")\n+        c0 = SimpleCategory.objects.create(name=\"cat0\")\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        \n+        c2 = OneToOneCategory.objects.create(category = c1, new_name=\"new1\")\n+        c3 = OneToOneCategory.objects.create(category = c0, new_name=\"new2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c)\n+        ci2 = CategoryItem.objects.create(category=c0)\n+        ci3 = CategoryItem.objects.create(category=c1)\n+\n+        qs = CategoryItem.objects.filter(category__onetoonecategory__isnull=True)\n+        self.assertEqual(qs.count(), 1)\n+        self.assertQuerysetEqual(qs, [ci1.pk], lambda x: x.pk)\n+\n+    def test_ticket15316_one2one_exclude_true(self):\n+        c  = SimpleCategory.objects.create(name=\"cat\")\n+        c0 = SimpleCategory.objects.create(name=\"cat0\")\n+        c1 = SimpleCategory.objects.create(name=\"category1\")\n+        \n+        c2 = OneToOneCategory.objects.create(category = c1, new_name=\"new1\")\n+        c3 = OneToOneCategory.objects.create(category = c0, new_name=\"new2\")\n+\n+        ci1 = CategoryItem.objects.create(category=c)\n+        ci2 = CategoryItem.objects.create(category=c0)\n+        ci3 = CategoryItem.objects.create(category=c1)\n+\n+        qs = CategoryItem.objects.exclude(category__onetoonecategory__isnull=True)\n+        self.assertEqual(qs.count(), 2)\n+        self.assertQuerysetEqual(qs, [ci2.pk, ci3.pk], lambda x: x.pk, False)\n+\n \n class Queries5Tests(TestCase):\n     def setUp(self):\n-        # Ordering by 'rank' gives us rank2, rank1, rank3. Ordering by the Meta.ordering\n-        # will be rank3, rank2, rank1.\n+        # Ordering by 'rank' gives us rank2, rank1, rank3. Ordering by the\n+        # Meta.ordering will be rank3, rank2, rank1.\n         n1 = Note.objects.create(note='n1', misc='foo', id=1)\n         n2 = Note.objects.create(note='n2', misc='bar', id=2)\n         e1 = ExtraInfo.objects.create(info='e1', note=n1)"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 168,
        "deletions": 8
    }
}