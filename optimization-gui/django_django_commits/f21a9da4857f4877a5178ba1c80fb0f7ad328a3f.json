{
    "author": "aaugustin",
    "message": "Fixed #13704 -- Handled IDN properly in the urlize template filter. Thanks Claude Paroz for the initial version of the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17348 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f21a9da4857f4877a5178ba1c80fb0f7ad328a3f",
    "files": [
        {
            "sha": "ce886efba7f5627450ee480d65c154c3b40b1bff",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/f21a9da4857f4877a5178ba1c80fb0f7ad328a3f/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/f21a9da4857f4877a5178ba1c80fb0f7ad328a3f/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=f21a9da4857f4877a5178ba1c80fb0f7ad328a3f",
            "patch": "@@ -2,11 +2,12 @@\n \n import re\n import string\n+import urllib\n+import urlparse\n \n from django.utils.safestring import SafeData, mark_safe\n-from django.utils.encoding import force_unicode\n+from django.utils.encoding import smart_str, force_unicode\n from django.utils.functional import allow_lazy\n-from django.utils.http import urlquote\n from django.utils.text import normalize_newlines\n \n # Configuration for urlize() function.\n@@ -22,7 +23,7 @@\n punctuation_re = re.compile('^(?P<lead>(?:%s)*)(?P<middle>.*?)(?P<trail>(?:%s)*)$' % \\\n     ('|'.join([re.escape(x) for x in LEADING_PUNCTUATION]),\n     '|'.join([re.escape(x) for x in TRAILING_PUNCTUATION])))\n-simple_email_re = re.compile(r'^\\S+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+$')\n+simple_email_re = re.compile(r'^\\S+@\\S+\\.\\S+$')\n link_target_attribute_re = re.compile(r'(<a [^>]*?)target=[^\\s>]+')\n html_gunk_re = re.compile(r'(?:<br clear=\"all\">|<i><\\/i>|<b><\\/b>|<em><\\/em>|<strong><\\/strong>|<\\/?smallcaps>|<\\/?uppercase>)', re.IGNORECASE)\n hard_coded_bullets_re = re.compile(r'((?:<p>(?:%s).*?[a-zA-Z].*?</p>\\s*)+)' % '|'.join([re.escape(x) for x in DOTS]), re.DOTALL)\n@@ -103,12 +104,22 @@ def fix_ampersands(value):\n \n def smart_urlquote(url):\n     \"\"\"Quotes an URL if it isn't already quoted.\"\"\"\n+    # Handle IDN before quoting.\n+    scheme, netloc, path, query, fragment = urlparse.urlsplit(url)\n+    try:\n+        netloc = netloc.encode('idna') # IDN -> ACE\n+    except UnicodeError: # invalid domain part\n+        pass\n+    else:\n+        url = urlparse.urlunsplit((scheme, netloc, path, query, fragment))\n+\n     # An URL is considered unquoted if it contains no % character, or if it\n     # contains a % not followed by two hexadecimal digits. See #9655.\n     if '%' not in url or unquoted_percents_re.search(url):\n         # See http://bugs.python.org/issue2637\n-        return urlquote(url, safe='!*\\'();:@&=+$,/?#[]~')\n-    return url\n+        url = urllib.quote(smart_str(url), safe='!*\\'();:@&=+$,/?#[]~')\n+\n+    return force_unicode(url)\n \n def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n     \"\"\"\n@@ -145,8 +156,10 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n                     middle and middle[0] in string.ascii_letters + string.digits and \\\n                     (middle.endswith('.org') or middle.endswith('.net') or middle.endswith('.com'))):\n                 url = smart_urlquote('http://%s' % middle)\n-            elif '@' in middle and not ':' in middle and simple_email_re.match(middle):\n-                url = 'mailto:%s' % middle\n+            elif not ':' in middle and simple_email_re.match(middle):\n+                local, domain = middle.rsplit('@', 1)\n+                domain = domain.encode('idna')\n+                url = 'mailto:%s@%s' % (local, domain)\n                 nofollow_attr = ''\n             # Make link.\n             if url:"
        },
        {
            "sha": "515840d87ecab5e10e2a56576ae67531c30d3c47",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/f21a9da4857f4877a5178ba1c80fb0f7ad328a3f/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f21a9da4857f4877a5178ba1c80fb0f7ad328a3f/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=f21a9da4857f4877a5178ba1c80fb0f7ad328a3f",
            "patch": "@@ -238,6 +238,7 @@ def test_urlize(self):\n         # Check urlize with https addresses\n         self.assertEqual(urlize('https://google.com'),\n             u'<a href=\"https://google.com\" rel=\"nofollow\">https://google.com</a>')\n+\n         # Check urlize doesn't overquote already quoted urls - see #9655\n         self.assertEqual(urlize('http://hi.baidu.com/%D6%D8%D0%C2%BF'),\n             u'<a href=\"http://hi.baidu.com/%D6%D8%D0%C2%BF\" rel=\"nofollow\">'\n@@ -252,6 +253,16 @@ def test_urlize(self):\n             u'<a href=\"http://en.wikipedia.org/wiki/Caf%C3%A9\" rel=\"nofollow\">'\n             u'http://en.wikipedia.org/wiki/Café</a>')\n \n+        # Check urlize handles IDN correctly - see #13704\n+        self.assertEqual(urlize('http://c✶.ws'),\n+            u'<a href=\"http://xn--c-lgq.ws\" rel=\"nofollow\">http://c✶.ws</a>')\n+        self.assertEqual(urlize('www.c✶.ws'),\n+            u'<a href=\"http://www.xn--c-lgq.ws\" rel=\"nofollow\">www.c✶.ws</a>')\n+        self.assertEqual(urlize('c✶.org'),\n+            u'<a href=\"http://xn--c-lgq.org\" rel=\"nofollow\">c✶.org</a>')\n+        self.assertEqual(urlize('info@c✶.org'),\n+            u'<a href=\"mailto:info@xn--c-lgq.org\">info@c✶.org</a>')\n+\n     def test_wordcount(self):\n         self.assertEqual(wordcount(''), 0)\n         self.assertEqual(wordcount(u'oneword'), 1)"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 31,
        "deletions": 7
    }
}