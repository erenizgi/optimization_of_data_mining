{
    "author": "jezdez",
    "message": "Fixed #14249 -- Added support for inactive users to the auth backend system. Thanks, Harro van der Klauw.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15010 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "745c255a19df498d328b908fc3df326cdf0cf638",
    "files": [
        {
            "sha": "633baa526538f9dc905a5b03b02b92b5e158f208",
            "filename": "django/contrib/auth/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2F__init__.py?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -30,6 +30,11 @@ def load_backend(path):\n         warn(\"Authentication backends without a `supports_anonymous_user` attribute are deprecated. Please define it in %s.\" % cls,\n              DeprecationWarning)\n         cls.supports_anonymous_user = False\n+\n+    if not hasattr(cls, 'supports_inactive_user'):\n+        warn(\"Authentication backends without a `supports_inactive_user` attribute are deprecated. Please define it in %s.\" % cls,\n+             DeprecationWarning)\n+        cls.supports_inactive_user = False\n     return cls()\n \n def get_backends():"
        },
        {
            "sha": "d8c81406b3e145f64a1d8984459b48d17a70f12a",
            "filename": "django/contrib/auth/backends.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Fbackends.py",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Fbackends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fbackends.py?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -8,6 +8,7 @@ class ModelBackend(object):\n     \"\"\"\n     supports_object_permissions = False\n     supports_anonymous_user = True\n+    supports_inactive_user = True\n \n     # TODO: Model, login attribute name and password attribute name should be\n     # configurable.\n@@ -42,12 +43,16 @@ def get_all_permissions(self, user_obj):\n         return user_obj._perm_cache\n \n     def has_perm(self, user_obj, perm):\n+        if not user_obj.is_active:\n+            return False\n         return perm in self.get_all_permissions(user_obj)\n \n     def has_module_perms(self, user_obj, app_label):\n         \"\"\"\n         Returns True if user_obj has any permissions in the given app_label.\n         \"\"\"\n+        if not user_obj.is_active:\n+            return False\n         for perm in self.get_all_permissions(user_obj):\n             if perm[:perm.index('.')] == app_label:\n                 return True"
        },
        {
            "sha": "ec3af633bdbba2119538edf6101d5c99e50e641e",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 11,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -170,8 +170,10 @@ def _user_get_all_permissions(user, obj):\n \n def _user_has_perm(user, perm, obj):\n     anon = user.is_anonymous()\n+    active = user.is_active\n     for backend in auth.get_backends():\n-        if not anon or backend.supports_anonymous_user:\n+        if (not active and not anon and backend.supports_inactive_user) or \\\n+                    (not anon or backend.supports_anonymous_user):\n             if hasattr(backend, \"has_perm\"):\n                 if obj is not None:\n                     if (backend.supports_object_permissions and\n@@ -185,8 +187,10 @@ def _user_has_perm(user, perm, obj):\n \n def _user_has_module_perms(user, app_label):\n     anon = user.is_anonymous()\n+    active = user.is_active\n     for backend in auth.get_backends():\n-        if not anon or backend.supports_anonymous_user:\n+        if (not active and not anon and backend.supports_inactive_user) or \\\n+                    (not anon or backend.supports_anonymous_user):\n             if hasattr(backend, \"has_module_perms\"):\n                 if backend.has_module_perms(user, app_label):\n                     return True\n@@ -310,12 +314,9 @@ def has_perm(self, perm, obj=None):\n         auth backend is assumed to have permission in general. If an object\n         is provided, permissions for this specific object are checked.\n         \"\"\"\n-        # Inactive users have no permissions.\n-        if not self.is_active:\n-            return False\n \n-        # Superusers have all permissions.\n-        if self.is_superuser:\n+        # Active superusers have all permissions.\n+        if self.is_active and self.is_superuser:\n             return True\n \n         # Otherwise we need to check the backends.\n@@ -337,10 +338,8 @@ def has_module_perms(self, app_label):\n         Returns True if the user has any permissions in the given app\n         label. Uses pretty much the same logic as has_perm, above.\n         \"\"\"\n-        if not self.is_active:\n-            return False\n-\n-        if self.is_superuser:\n+        # Active superusers have all permissions.\n+        if self.is_active and self.is_superuser:\n             return True\n \n         return _user_has_module_perms(self, app_label)"
        },
        {
            "sha": "3a8f55b6e72e72edc83fce5c7a28029bb1139fa9",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -1,14 +1,18 @@\n-from django.contrib.auth.tests.auth_backends import BackendTest, RowlevelBackendTest, AnonymousUserBackendTest, NoAnonymousUserBackendTest, NoBackendsTest\n+from django.contrib.auth.tests.auth_backends import (BackendTest,\n+    RowlevelBackendTest, AnonymousUserBackendTest, NoAnonymousUserBackendTest,\n+    NoBackendsTest, InActiveUserBackendTest, NoInActiveUserBackendTest)\n from django.contrib.auth.tests.basic import BasicTestCase\n from django.contrib.auth.tests.decorators import LoginRequiredTestCase\n-from django.contrib.auth.tests.forms import UserCreationFormTest, AuthenticationFormTest, SetPasswordFormTest, PasswordChangeFormTest, UserChangeFormTest, PasswordResetFormTest\n-from django.contrib.auth.tests.remote_user \\\n-        import RemoteUserTest, RemoteUserNoCreateTest, RemoteUserCustomTest\n+from django.contrib.auth.tests.forms import (UserCreationFormTest,\n+    AuthenticationFormTest, SetPasswordFormTest, PasswordChangeFormTest,\n+    UserChangeFormTest, PasswordResetFormTest)\n+from django.contrib.auth.tests.remote_user import (RemoteUserTest,\n+    RemoteUserNoCreateTest, RemoteUserCustomTest)\n from django.contrib.auth.tests.models import ProfileTestCase\n from django.contrib.auth.tests.signals import SignalTestCase\n from django.contrib.auth.tests.tokens import TokenGeneratorTest\n-from django.contrib.auth.tests.views import PasswordResetTest, \\\n-    ChangePasswordTest, LoginTest, LogoutTest, LoginURLSettings\n+from django.contrib.auth.tests.views import (PasswordResetTest,\n+    ChangePasswordTest, LoginTest, LogoutTest, LoginURLSettings)\n from django.contrib.auth.tests.permissions import TestAuthPermissions\n \n # The password for the fixture data users is 'password'"
        },
        {
            "sha": "6a99757921dee12434aca94ff2d3a264e87b0949",
            "filename": "django/contrib/auth/tests/auth_backends.py",
            "status": "modified",
            "additions": 76,
            "deletions": 2,
            "changes": 78,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -102,9 +102,12 @@ class TestObj(object):\n \n class SimpleRowlevelBackend(object):\n     supports_object_permissions = True\n+    supports_inactive_user = False\n+\n+    # This class also supports tests for anonymous user permissions, and\n+    # inactive user permissions via subclasses which just set the\n+    # 'supports_anonymous_user' or 'supports_inactive_user' attribute.\n \n-    # This class also supports tests for anonymous user permissions,\n-    # via subclasses which just set the 'supports_anonymous_user' attribute.\n \n     def has_perm(self, user, perm, obj=None):\n         if not obj:\n@@ -116,9 +119,13 @@ def has_perm(self, user, perm, obj=None):\n             elif user.is_anonymous() and perm == 'anon':\n                 # not reached due to supports_anonymous_user = False\n                 return True\n+            elif not user.is_active and perm == 'inactive':\n+                return True\n         return False\n \n     def has_module_perms(self, user, app_label):\n+        if not user.is_anonymous() and not user.is_active:\n+            return False\n         return app_label == \"app1\"\n \n     def get_all_permissions(self, user, obj=None):\n@@ -192,11 +199,13 @@ def test_get_group_permissions(self):\n class AnonymousUserBackend(SimpleRowlevelBackend):\n \n     supports_anonymous_user = True\n+    supports_inactive_user = False\n \n \n class NoAnonymousUserBackend(SimpleRowlevelBackend):\n \n     supports_anonymous_user = False\n+    supports_inactive_user = False\n \n \n class AnonymousUserBackendTest(TestCase):\n@@ -258,6 +267,7 @@ def test_has_module_perms(self):\n     def test_get_all_permissions(self):\n         self.assertEqual(self.user1.get_all_permissions(TestObj()), set())\n \n+\n class NoBackendsTest(TestCase):\n     \"\"\"\n     Tests that an appropriate error is raised if no auth backends are provided.\n@@ -272,3 +282,67 @@ def tearDown(self):\n \n     def test_raises_exception(self):\n         self.assertRaises(ImproperlyConfigured, self.user.has_perm, ('perm', TestObj(),))\n+\n+\n+class InActiveUserBackend(SimpleRowlevelBackend):\n+\n+    supports_anonymous_user = False\n+    supports_inactive_user = True\n+\n+\n+class NoInActiveUserBackend(SimpleRowlevelBackend):\n+\n+    supports_anonymous_user = False\n+    supports_inactive_user = False\n+\n+\n+class InActiveUserBackendTest(TestCase):\n+    \"\"\"\n+    Tests for a inactive user delegating to backend if it has 'supports_inactive_user' = True\n+    \"\"\"\n+\n+    backend = 'django.contrib.auth.tests.auth_backends.InActiveUserBackend'\n+\n+    def setUp(self):\n+        self.curr_auth = settings.AUTHENTICATION_BACKENDS\n+        settings.AUTHENTICATION_BACKENDS = (self.backend,)\n+        self.user1 = User.objects.create_user('test', 'test@example.com', 'test')\n+        self.user1.is_active = False\n+        self.user1.save()\n+\n+    def tearDown(self):\n+        settings.AUTHENTICATION_BACKENDS = self.curr_auth\n+\n+    def test_has_perm(self):\n+        self.assertEqual(self.user1.has_perm('perm', TestObj()), False)\n+        self.assertEqual(self.user1.has_perm('inactive', TestObj()), True)\n+\n+    def test_has_module_perms(self):\n+        self.assertEqual(self.user1.has_module_perms(\"app1\"), False)\n+        self.assertEqual(self.user1.has_module_perms(\"app2\"), False)\n+\n+\n+class NoInActiveUserBackendTest(TestCase):\n+    \"\"\"\n+    Tests that an inactive user does not delegate to backend if it has 'supports_inactive_user' = False\n+    \"\"\"\n+    backend = 'django.contrib.auth.tests.auth_backends.NoInActiveUserBackend'\n+\n+    def setUp(self):\n+        self.curr_auth = settings.AUTHENTICATION_BACKENDS\n+        settings.AUTHENTICATION_BACKENDS = tuple(self.curr_auth) + (self.backend,)\n+        self.user1 = User.objects.create_user('test', 'test@example.com', 'test')\n+        self.user1.is_active = False\n+        self.user1.save()\n+\n+    def tearDown(self):\n+        settings.AUTHENTICATION_BACKENDS = self.curr_auth\n+\n+    def test_has_perm(self):\n+        self.assertEqual(self.user1.has_perm('perm', TestObj()), False)\n+        self.assertEqual(self.user1.has_perm('inactive', TestObj()), True)\n+\n+    def test_has_module_perms(self):\n+        self.assertEqual(self.user1.has_module_perms(\"app1\"), False)\n+        self.assertEqual(self.user1.has_module_perms(\"app2\"), False)\n+"
        },
        {
            "sha": "54f40d027ad4ff7e65f3bdbd16789a3e06af4323",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -98,6 +98,9 @@ their deprecation, as per the :ref:`Django deprecation policy\n         * The ``no`` language code has been deprecated in favor of the ``nb``\n           language code.\n \n+        * Authentication backends need to define the boolean attribute\n+          ``supports_inactive_user``.\n+\n     * 1.5\n         * The ``mod_python`` request handler has been deprecated since the 1.3\n           release. The ``mod_wsgi`` handler should be used instead.\n@@ -139,6 +142,11 @@ their deprecation, as per the :ref:`Django deprecation policy\n         * The :djadmin:`reset` and :djadmin:`sqlreset` management commands\n           are deprecated.\n \n+        * Authentication backends need to support a inactive user\n+          being passed to all methods dealing with permissions.\n+          The ``supports_inactive_user`` variable is not checked any\n+          longer and can be removed.\n+\n     * 2.0\n         * ``django.views.defaults.shortcut()``. This function has been moved\n           to ``django.contrib.contenttypes.views.shortcut()`` as part of the"
        },
        {
            "sha": "342136cd2fe2b42085919b083bc4e3fe064cfcae",
            "filename": "docs/releases/1.3-beta-1.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Freleases%2F1.3-beta-1.txt",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Freleases%2F1.3-beta-1.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3-beta-1.txt?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -55,6 +55,14 @@ displayed by most translation tools.\n \n For more information, see :ref:`translator-comments`.\n \n+Permissions for inactive users\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+If you provide a custom auth backend with ``supports_inactive_user`` set to\n+``True``, an inactive user model will check the backend for permissions.\n+This is useful for further centralizing the permission handling. See the\n+:ref:`authentication docs <topics-auth>` for more details.\n+\n Backwards-incompatible changes in 1.3 alpha 2\n =============================================\n "
        },
        {
            "sha": "bd68f02aad1310b5834fe7ca872b026ab07b9647",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -177,6 +177,14 @@ caching in Django<topics/cache>`.\n \n .. _pylibmc: http://sendapatch.se/projects/pylibmc/\n \n+Permissions for inactive users\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+If you provide a custom auth backend with ``supports_inactive_user`` set to\n+``True``, an inactive user model will check the backend for permissions.\n+This is useful for further centralizing the permission handling. See the\n+:ref:`authentication docs <topics-auth>` for more details.\n+\n Everything else\n ~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "641db3a8b20a548fa8272bd0c7b6685d2678f56b",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/745c255a19df498d328b908fc3df326cdf0cf638/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=745c255a19df498d328b908fc3df326cdf0cf638",
            "patch": "@@ -741,7 +741,7 @@ The login_required decorator\n         @login_required\n         def my_view(request):\n             ...\n-    \n+\n     :func:`~django.contrib.auth.decorators.login_required` does the following:\n \n     * If the user isn't logged in, redirect to\n@@ -1645,6 +1645,31 @@ loudly. Additionally ``supports_anonymous_user`` will be set to ``False``.\n Django 1.4 will assume that every backend supports anonymous users being\n passed to the authorization methods.\n \n+Authorization for inactive users\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+.. versionadded:: 1.3\n+\n+An inactive user is a one that is authenticated but has its attribute\n+``is_active`` set to ``False``. However this does not mean they are not\n+authrozied to do anything. For example they are allowed to activate their\n+account.\n+\n+The support for anonymous users in the permission system allows for\n+anonymous users to have permissions to do something while inactive\n+authenticated users do not.\n+\n+To enable this on your own backend, you must set the class attribute\n+``supports_inactive_user`` to ``True``.\n+\n+A nonexisting ``supports_inactive_user`` attribute will raise a\n+``PendingDeprecationWarning`` if used in Django 1.3. In Django 1.4, this\n+warning will be updated to a ``DeprecationWarning`` which will be displayed\n+loudly. Additionally ``supports_inactive_user`` will be set to ``False``.\n+Django 1.5 will assume that every backend supports inactive users being\n+passed to the authorization methods.\n+\n+\n Handling object permissions\n ---------------------------\n "
        }
    ],
    "stats": {
        "total": 176,
        "additions": 156,
        "deletions": 20
    }
}