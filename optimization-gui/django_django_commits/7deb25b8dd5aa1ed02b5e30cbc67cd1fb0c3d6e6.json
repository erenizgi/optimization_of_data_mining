{
    "author": "alex",
    "message": "Fixed #7596.  Added Model.objects.bulk_create, and make use of it in several places.  This provides a performance benefit when inserting multiple objects.  THanks to Russ for the review, and Simon Meers for the MySQl implementation.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16739 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
    "files": [
        {
            "sha": "532654f92da5f347217df805a122528faf206d27",
            "filename": "django/contrib/auth/management/__init__.py",
            "status": "modified",
            "additions": 9,
            "deletions": 11,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -46,17 +46,15 @@ def create_permissions(app, created_models, verbosity, **kwargs):\n         \"content_type\", \"codename\"\n     ))\n \n-    for ctype, (codename, name) in searched_perms:\n-        # If the permissions exists, move on.\n-        if (ctype.pk, codename) in all_perms:\n-            continue\n-        p = auth_app.Permission.objects.create(\n-            codename=codename,\n-            name=name,\n-            content_type=ctype\n-        )\n-        if verbosity >= 2:\n-            print \"Adding permission '%s'\" % p\n+    objs = [\n+        auth_app.Permission(codename=codename, name=name, content_type=ctype)\n+        for ctype, (codename, name) in searched_perms\n+        if (ctype.pk, codename) not in all_perms\n+    ]\n+    auth_app.Permission.objects.bulk_create(objs)\n+    if verbosity >= 2:\n+        for obj in objs:\n+            print \"Adding permission '%s'\" % obj\n \n \n def create_superuser(app, created_models, verbosity, **kwargs):"
        },
        {
            "sha": "5c7e12a847926a3c41b06e6803b7575c97c5e44d",
            "filename": "django/contrib/contenttypes/management.py",
            "status": "modified",
            "additions": 33,
            "deletions": 17,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fcontrib%2Fcontenttypes%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fcontrib%2Fcontenttypes%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fmanagement.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -8,25 +8,41 @@ def update_contenttypes(app, created_models, verbosity=2, **kwargs):\n     entries that no longer have a matching model class.\n     \"\"\"\n     ContentType.objects.clear_cache()\n-    content_types = list(ContentType.objects.filter(app_label=app.__name__.split('.')[-2]))\n     app_models = get_models(app)\n     if not app_models:\n         return\n-    for klass in app_models:\n-        opts = klass._meta\n-        try:\n-            ct = ContentType.objects.get(app_label=opts.app_label,\n-                                         model=opts.object_name.lower())\n-            content_types.remove(ct)\n-        except ContentType.DoesNotExist:\n-            ct = ContentType(name=smart_unicode(opts.verbose_name_raw),\n-                app_label=opts.app_label, model=opts.object_name.lower())\n-            ct.save()\n-            if verbosity >= 2:\n-                print \"Adding content type '%s | %s'\" % (ct.app_label, ct.model)\n-    # The presence of any remaining content types means the supplied app has an\n-    # undefined model. Confirm that the content type is stale before deletion.\n-    if content_types:\n+    # They all have the same app_label, get the first one.\n+    app_label = app_models[0]._meta.app_label\n+    app_models = dict(\n+        (model._meta.object_name.lower(), model)\n+        for model in app_models\n+    )\n+    # Get all the content types\n+    content_types = dict(\n+        (ct.model, ct)\n+        for ct in ContentType.objects.filter(app_label=app_label)\n+    )\n+    to_remove = [\n+        ct\n+        for (model_name, ct) in content_types.iteritems()\n+        if model_name not in app_models\n+    ]\n+\n+    cts = ContentType.objects.bulk_create([\n+        ContentType(\n+            name=smart_unicode(model._meta.verbose_name_raw),\n+            app_label=app_label,\n+            model=model_name,\n+        )\n+        for (model_name, model) in app_models.iteritems()\n+        if model_name not in content_types\n+    ])\n+    if verbosity >= 2:\n+        for ct in cts:\n+            print \"Adding content type '%s | %s'\" % (ct.app_label, ct.model)\n+\n+    # Confirm that the content type is stale before deletion.\n+    if to_remove:\n         if kwargs.get('interactive', False):\n             content_type_display = '\\n'.join(['    %s | %s' % (ct.app_label, ct.model) for ct in content_types])\n             ok_to_delete = raw_input(\"\"\"The following content types are stale and need to be deleted:\n@@ -42,7 +58,7 @@ def update_contenttypes(app, created_models, verbosity=2, **kwargs):\n             ok_to_delete = False\n \n         if ok_to_delete == 'yes':\n-            for ct in content_types:\n+            for ct in to_remove:\n                 if verbosity >= 2:\n                     print \"Deleting stale content type '%s | %s'\" % (ct.app_label, ct.model)\n                 ct.delete()"
        },
        {
            "sha": "06ce9deb72f66b346a323b23592159e6a919cbbc",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -301,8 +301,10 @@ class BaseDatabaseFeatures(object):\n \n     can_use_chunked_reads = True\n     can_return_id_from_insert = False\n+    has_bulk_insert = False\n     uses_autocommit = False\n     uses_savepoints = False\n+    can_combine_inserts_with_and_without_auto_increment_pk = False\n \n     # If True, don't use integer foreign keys referring to, e.g., positive\n     # integer primary keys."
        },
        {
            "sha": "a22951a3b7d5e566673d7736f913c341354997c6",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -124,6 +124,7 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     allows_group_by_pk = True\n     related_fields_match_type = True\n     allow_sliced_subqueries = False\n+    has_bulk_insert = True\n     has_select_for_update = True\n     has_select_for_update_nowait = False\n     supports_forward_references = False\n@@ -263,6 +264,10 @@ def year_lookup_bounds(self, value):\n     def max_name_length(self):\n         return 64\n \n+    def bulk_insert_sql(self, fields, num_values):\n+        items_sql = \"(%s)\" % \", \".join([\"%s\"] * len(fields))\n+        return \"VALUES \" + \", \".join([items_sql] * num_values)\n+\n class DatabaseWrapper(BaseDatabaseWrapper):\n     vendor = 'mysql'\n     operators = {"
        },
        {
            "sha": "f0a89e50a8ac62ebb6484373ee4db3e3b816ab78",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -74,6 +74,7 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     can_defer_constraint_checks = True\n     has_select_for_update = True\n     has_select_for_update_nowait = True\n+    has_bulk_insert = True\n \n \n class DatabaseWrapper(BaseDatabaseWrapper):"
        },
        {
            "sha": "c3a23c2073235a8f72376b1bf43710f1b61b7f78",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -180,3 +180,7 @@ def last_executed_query(self, cursor, sql, params):\n \n     def return_insert_id(self):\n         return \"RETURNING %s\", ()\n+\n+    def bulk_insert_sql(self, fields, num_values):\n+        items_sql = \"(%s)\" % \", \".join([\"%s\"] * len(fields))\n+        return \"VALUES \" + \", \".join([items_sql] * num_values)"
        },
        {
            "sha": "b45c0fb93599710422ee9369c3d7dfeb5b3bf59d",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -58,6 +58,8 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     supports_unspecified_pk = True\n     supports_1000_query_parameters = False\n     supports_mixed_date_datetime_comparisons = False\n+    has_bulk_insert = True\n+    can_combine_inserts_with_and_without_auto_increment_pk = True\n \n     def _supports_stddev(self):\n         \"\"\"Confirm support for STDDEV and related stats functions\n@@ -106,7 +108,7 @@ def drop_foreignkey_sql(self):\n         return \"\"\n \n     def pk_default_value(self):\n-        return 'NULL'\n+        return \"NULL\"\n \n     def quote_name(self, name):\n         if name.startswith('\"') and name.endswith('\"'):\n@@ -154,6 +156,14 @@ def convert_values(self, value, field):\n         # No field, or the field isn't known to be a decimal or integer\n         return value\n \n+    def bulk_insert_sql(self, fields, num_values):\n+        res = []\n+        res.append(\"SELECT %s\" % \", \".join(\n+            \"%%s AS %s\" % self.quote_name(f.column) for f in fields\n+        ))\n+        res.extend([\"UNION SELECT %s\" % \", \".join([\"%s\"] * len(fields))] * (num_values - 1))\n+        return \" \".join(res)\n+\n class DatabaseWrapper(BaseDatabaseWrapper):\n     vendor = 'sqlite'\n     # SQLite requires LIKE statements to include an ESCAPE clause if the value"
        },
        {
            "sha": "4b3220b514ab5399b48ea455ab1fa2235b9a693c",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 11,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -540,24 +540,16 @@ def save_base(self, raw=False, cls=None, origin=None, force_insert=False,\n                     order_value = manager.using(using).filter(**{field.name: getattr(self, field.attname)}).count()\n                     self._order = order_value\n \n+                fields = meta.local_fields\n                 if not pk_set:\n                     if force_update:\n                         raise ValueError(\"Cannot force an update in save() with no primary key.\")\n-                    values = [(f, f.get_db_prep_save(raw and getattr(self, f.attname) or f.pre_save(self, True), connection=connection))\n-                        for f in meta.local_fields if not isinstance(f, AutoField)]\n-                else:\n-                    values = [(f, f.get_db_prep_save(raw and getattr(self, f.attname) or f.pre_save(self, True), connection=connection))\n-                        for f in meta.local_fields]\n+                    fields = [f for f in fields if not isinstance(f, AutoField)]\n \n                 record_exists = False\n \n                 update_pk = bool(meta.has_auto_field and not pk_set)\n-                if values:\n-                    # Create a new record.\n-                    result = manager._insert(values, return_id=update_pk, using=using)\n-                else:\n-                    # Create a new record with defaults for everything.\n-                    result = manager._insert([(meta.pk, connection.ops.pk_default_value())], return_id=update_pk, raw_values=True, using=using)\n+                result = manager._insert([self], fields=fields, return_id=update_pk, using=using, raw=raw)\n \n                 if update_pk:\n                     setattr(self, meta.pk.attname, result)"
        },
        {
            "sha": "fa7b482f24bf00b3a2b00954003dc474614e939a",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -430,15 +430,15 @@ def add(self, *objs):\n             add.alters_data = True\n \n             def create(self, **kwargs):\n-                kwargs.update({rel_field.name: instance})\n+                kwargs[rel_field.name] = instance\n                 db = router.db_for_write(rel_model, instance=instance)\n                 return super(RelatedManager, self.db_manager(db)).create(**kwargs)\n             create.alters_data = True\n \n             def get_or_create(self, **kwargs):\n                 # Update kwargs with the related object that this\n                 # ForeignRelatedObjectsDescriptor knows about.\n-                kwargs.update({rel_field.name: instance})\n+                kwargs[rel_field.name] = instance\n                 db = router.db_for_write(rel_model, instance=instance)\n                 return super(RelatedManager, self.db_manager(db)).get_or_create(**kwargs)\n             get_or_create.alters_data = True\n@@ -578,11 +578,13 @@ def _add_items(self, source_field_name, target_field_name, *objs):\n                         instance=self.instance, reverse=self.reverse,\n                         model=self.model, pk_set=new_ids, using=db)\n                 # Add the ones that aren't there already\n-                for obj_id in new_ids:\n-                    self.through._default_manager.using(db).create(**{\n+                self.through._default_manager.using(db).bulk_create([\n+                    self.through(**{\n                         '%s_id' % source_field_name: self._pk_val,\n                         '%s_id' % target_field_name: obj_id,\n                     })\n+                    for obj_id in new_ids\n+                ])\n                 if self.reverse or source_field_name == self.source_field_name:\n                     # Don't send the signal when we are inserting the\n                     # duplicate data row for symmetrical reverse entries.\n@@ -701,12 +703,12 @@ class ReverseManyRelatedObjectsDescriptor(object):\n     def __init__(self, m2m_field):\n         self.field = m2m_field\n \n-    def _through(self):\n+    @property\n+    def through(self):\n         # through is provided so that you have easy access to the through\n         # model (Book.authors.through) for inlines, etc. This is done as\n         # a property to ensure that the fully resolved value is returned.\n         return self.field.rel.through\n-    through = property(_through)\n \n     def __get__(self, instance, instance_type=None):\n         if instance is None:"
        },
        {
            "sha": "baf701f6dd40f972d42bfa3937c9dadf95e03dd9",
            "filename": "django/db/models/manager.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fmanager.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fmanager.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fmanager.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -136,6 +136,9 @@ def get_or_create(self, **kwargs):\n     def create(self, **kwargs):\n         return self.get_query_set().create(**kwargs)\n \n+    def bulk_create(self, *args, **kwargs):\n+        return self.get_query_set().bulk_create(*args, **kwargs)\n+\n     def filter(self, *args, **kwargs):\n         return self.get_query_set().filter(*args, **kwargs)\n \n@@ -193,8 +196,8 @@ def using(self, *args, **kwargs):\n     def exists(self, *args, **kwargs):\n         return self.get_query_set().exists(*args, **kwargs)\n \n-    def _insert(self, values, **kwargs):\n-        return insert_query(self.model, values, **kwargs)\n+    def _insert(self, objs, fields, **kwargs):\n+        return insert_query(self.model, objs, fields, **kwargs)\n \n     def _update(self, values, **kwargs):\n         return self.get_query_set()._update(values, **kwargs)"
        },
        {
            "sha": "4b6645569f4e22a492f430941028209c33c81bbd",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 39,
            "deletions": 2,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -5,10 +5,12 @@\n import copy\n \n from django.db import connections, router, transaction, IntegrityError\n+from django.db.models.fields import AutoField\n from django.db.models.query_utils import (Q, select_related_descend,\n     deferred_class_factory, InvalidQuery)\n from django.db.models.deletion import Collector\n from django.db.models import signals, sql\n+from django.utils.functional import partition\n \n # Used to control how many objects are worked with at once in some cases (e.g.\n # when deleting objects).\n@@ -352,6 +354,41 @@ def create(self, **kwargs):\n         obj.save(force_insert=True, using=self.db)\n         return obj\n \n+    def bulk_create(self, objs):\n+        \"\"\"\n+        Inserts each of the instances into the database. This does *not* call\n+        save() on each of the instances, does not send any pre/post save\n+        signals, and does not set the primary key attribute if it is an\n+        autoincrement field.\n+        \"\"\"\n+        # So this case is fun. When you bulk insert you don't get the primary\n+        # keys back (if it's an autoincrement), so you can't insert into the\n+        # child tables which references this. There are two workarounds, 1)\n+        # this could be implemented if you didn't have an autoincrement pk,\n+        # and 2) you could do it by doing O(n) normal inserts into the parent\n+        # tables to get the primary keys back, and then doing a single bulk\n+        # insert into the childmost table. We're punting on these for now\n+        # because they are relatively rare cases.\n+        if self.model._meta.parents:\n+            raise ValueError(\"Can't bulk create an inherited model\")\n+        if not objs:\n+            return\n+        self._for_write = True\n+        connection = connections[self.db]\n+        fields = self.model._meta.local_fields\n+        if (connection.features.can_combine_inserts_with_and_without_auto_increment_pk\n+            and self.model._meta.has_auto_field):\n+            self.model._base_manager._insert(objs, fields=fields, using=self.db)\n+        else:\n+            objs_with_pk, objs_without_pk = partition(\n+                lambda o: o.pk is None,\n+                objs\n+            )\n+            if objs_with_pk:\n+                self.model._base_manager._insert(objs_with_pk, fields=fields, using=self.db)\n+            if objs_without_pk:\n+                self.model._base_manager._insert(objs_without_pk, fields=[f for f in fields if not isinstance(f, AutoField)], using=self.db)\n+\n     def get_or_create(self, **kwargs):\n         \"\"\"\n         Looks up an object with the given kwargs, creating one if necessary.\n@@ -1437,12 +1474,12 @@ def model_fields(self):\n                 self._model_fields[converter(column)] = field\n         return self._model_fields\n \n-def insert_query(model, values, return_id=False, raw_values=False, using=None):\n+def insert_query(model, objs, fields, return_id=False, raw=False, using=None):\n     \"\"\"\n     Inserts a new record for the given model. This provides an interface to\n     the InsertQuery class and is how Model.save() is implemented. It is not\n     part of the public API.\n     \"\"\"\n     query = sql.InsertQuery(model)\n-    query.insert_values(values, raw_values)\n+    query.insert_values(fields, objs, raw=raw)\n     return query.get_compiler(using=using).execute_sql(return_id)"
        },
        {
            "sha": "b8bba4b0138c8377c42938932587a517c0b816c4",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 45,
            "deletions": 7,
            "changes": 52,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -1,3 +1,5 @@\n+from itertools import izip\n+\n from django.core.exceptions import FieldError\n from django.db import connections\n from django.db import transaction\n@@ -9,6 +11,7 @@\n      select_related_descend, Query)\n from django.db.utils import DatabaseError\n \n+\n class SQLCompiler(object):\n     def __init__(self, query, connection, using):\n         self.query = query\n@@ -794,20 +797,55 @@ def as_sql(self):\n         qn = self.connection.ops.quote_name\n         opts = self.query.model._meta\n         result = ['INSERT INTO %s' % qn(opts.db_table)]\n-        result.append('(%s)' % ', '.join([qn(c) for c in self.query.columns]))\n-        values = [self.placeholder(*v) for v in self.query.values]\n-        result.append('VALUES (%s)' % ', '.join(values))\n-        params = self.query.params\n+\n+        has_fields = bool(self.query.fields)\n+        fields = self.query.fields if has_fields else [opts.pk]\n+        result.append('(%s)' % ', '.join([qn(f.column) for f in fields]))\n+\n+        if has_fields:\n+            params = values = [\n+                [\n+                    f.get_db_prep_save(getattr(obj, f.attname) if self.query.raw else f.pre_save(obj, True), connection=self.connection)\n+                    for f in fields\n+                ]\n+                for obj in self.query.objs\n+            ]\n+        else:\n+            values = [[self.connection.ops.pk_default_value()] for obj in self.query.objs]\n+            params = [[]]\n+            fields = [None]\n+        can_bulk = not any(hasattr(field, \"get_placeholder\") for field in fields) and not self.return_id\n+\n+        if can_bulk:\n+            placeholders = [[\"%s\"] * len(fields)]\n+        else:\n+            placeholders = [\n+                [self.placeholder(field, v) for field, v in izip(fields, val)]\n+                for val in values\n+            ]\n         if self.return_id and self.connection.features.can_return_id_from_insert:\n+            params = values[0]\n             col = \"%s.%s\" % (qn(opts.db_table), qn(opts.pk.column))\n+            result.append(\"VALUES (%s)\" % \", \".join(placeholders[0]))\n             r_fmt, r_params = self.connection.ops.return_insert_id()\n             result.append(r_fmt % col)\n-            params = params + r_params\n-        return ' '.join(result), params\n+            params += r_params\n+            return [(\" \".join(result), tuple(params))]\n+        if can_bulk and self.connection.features.has_bulk_insert:\n+            result.append(self.connection.ops.bulk_insert_sql(fields, len(values)))\n+            return [(\" \".join(result), tuple([v for val in values for v in val]))]\n+        else:\n+            return [\n+                (\" \".join(result + [\"VALUES (%s)\" % \", \".join(p)]), vals)\n+                for p, vals in izip(placeholders, params)\n+            ]\n \n     def execute_sql(self, return_id=False):\n+        assert not (return_id and len(self.query.objs) != 1)\n         self.return_id = return_id\n-        cursor = super(SQLInsertCompiler, self).execute_sql(None)\n+        cursor = self.connection.cursor()\n+        for sql, params in self.as_sql():\n+            cursor.execute(sql, params)\n         if not (return_id and cursor):\n             return\n         if self.connection.features.can_return_id_from_insert:"
        },
        {
            "sha": "101d4ac7a54fbaf2c590cf7ed614d89ce8a3c79d",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -8,9 +8,10 @@\n \"\"\"\n \n import copy\n-from django.utils.tree import Node\n+\n from django.utils.datastructures import SortedDict\n from django.utils.encoding import force_unicode\n+from django.utils.tree import Node\n from django.db import connections, DEFAULT_DB_ALIAS\n from django.db.models import signals\n from django.db.models.fields import FieldDoesNotExist"
        },
        {
            "sha": "1b03647595b83a0ff0746e1828edfbd842dbb4f9",
            "filename": "django/db/models/sql/subqueries.py",
            "status": "modified",
            "additions": 9,
            "deletions": 17,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -136,20 +136,19 @@ class InsertQuery(Query):\n \n     def __init__(self, *args, **kwargs):\n         super(InsertQuery, self).__init__(*args, **kwargs)\n-        self.columns = []\n-        self.values = []\n-        self.params = ()\n+        self.fields = []\n+        self.objs = []\n \n     def clone(self, klass=None, **kwargs):\n         extras = {\n-            'columns': self.columns[:],\n-            'values': self.values[:],\n-            'params': self.params\n+            'fields': self.fields[:],\n+            'objs': self.objs[:],\n+            'raw': self.raw,\n         }\n         extras.update(kwargs)\n         return super(InsertQuery, self).clone(klass, **extras)\n \n-    def insert_values(self, insert_values, raw_values=False):\n+    def insert_values(self, fields, objs, raw=False):\n         \"\"\"\n         Set up the insert query from the 'insert_values' dictionary. The\n         dictionary gives the model field names and their target values.\n@@ -159,16 +158,9 @@ def insert_values(self, insert_values, raw_values=False):\n         parameters. This provides a way to insert NULL and DEFAULT keywords\n         into the query, for example.\n         \"\"\"\n-        placeholders, values = [], []\n-        for field, val in insert_values:\n-            placeholders.append((field, val))\n-            self.columns.append(field.column)\n-            values.append(val)\n-        if raw_values:\n-            self.values.extend([(None, v) for v in values])\n-        else:\n-            self.params += tuple(values)\n-            self.values.extend(placeholders)\n+        self.fields = fields\n+        self.objs = objs\n+        self.raw = raw\n \n class DateQuery(Query):\n     \"\"\""
        },
        {
            "sha": "1345d3b0056aef40b1fb4f249cf04f130209b42d",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -275,4 +275,17 @@ def fset(instance, value, name=fset.__name__):\n             @wraps(fdel)\n             def fdel(instance, name=fdel.__name__):\n                 return getattr(instance, name)()\n-        return property(fget, fset, fdel, doc)\n\\ No newline at end of file\n+        return property(fget, fset, fdel, doc)\n+\n+def partition(predicate, values):\n+    \"\"\"\n+    Splits the values into two sets, based on the return value of the function\n+    (True/False). e.g.:\n+\n+        >>> partition(lambda: x > 3, range(5))\n+        [1, 2, 3], [4]\n+    \"\"\"\n+    results = ([], [])\n+    for item in values:\n+        results[predicate(item)].append(item)\n+    return results\n\\ No newline at end of file"
        },
        {
            "sha": "898306d67d919b9f1e52ce98c3c1dd3ce74ca2d1",
            "filename": "docs/ref/models/querysets.txt",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Fquerysets.txt?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -1158,6 +1158,29 @@ has a side effect on your data. For more, see `Safe methods`_ in the HTTP spec.\n \n .. _Safe methods: http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.1.1\n \n+bulk_create\n+~~~~~~~~~~~\n+\n+.. method:: bulk_create(objs)\n+\n+This method inserts the provided list of objects into the database in an\n+efficient manner (generally only 1 query, no matter how many objects there\n+are)::\n+\n+    >>> Entry.objects.bulk_create([\n+    ...     Entry(headline=\"Django 1.0 Released\"),\n+    ...     Entry(headline=\"Django 1.1 Announced\"),\n+    ...     Entry(headline=\"Breaking: Django is awesome\")\n+    ... ])\n+\n+This has a number of caveats though:\n+\n+  * The model's ``save()`` method will not be called, and the ``pre_save`` and\n+    ``post_save`` signals will not be sent.\n+  * It does not work with child models in a multi-table inheritance scenario.\n+  * If the model's primary key is an :class:`~django.db.models.AutoField` it\n+    does not retrieve and set the primary key attribute, as ``save()`` does.\n+\n count\n ~~~~~\n "
        },
        {
            "sha": "ba05f2805f7fa6facba8e0efe8b3526ba8591cb1",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -252,6 +252,17 @@ filename. For example, the file ``css/styles.css`` would also be saved as\n See the :class:`~django.contrib.staticfiles.storage.CachedStaticFilesStorage`\n docs for more information.\n \n+``Model.objects.bulk_create`` in the ORM\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+This method allows for more efficient creation of multiple objects in the ORM.\n+It can provide significant performance increases if you have many objects,\n+Django makes use of this internally, meaning some operations (such as database\n+setup for test suites) has seen a performance benefit as a result.\n+\n+See the :meth:`~django.db.models.query.QuerySet.bulk_create` docs for more\n+information.\n+\n Minor features\n ~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "5093917b610db23cf85f4474929be75526dbbe39",
            "filename": "docs/topics/db/optimization.txt",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/docs%2Ftopics%2Fdb%2Foptimization.txt",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/docs%2Ftopics%2Fdb%2Foptimization.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Foptimization.txt?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -268,3 +268,33 @@ instead of::\n \n    entry.blog.id\n \n+Insert in bulk\n+==============\n+\n+When creating objects, where possible, use the\n+:meth:`~django.db.models.query.QuerySet.bulk_create()` method to reduce the\n+number of SQL queries. For example::\n+\n+    Entry.objects.bulk_create([\n+        Entry(headline=\"Python 3.0 Released\"),\n+        Entry(headline=\"Python 3.1 Planned\")\n+    ])\n+\n+Is preferable to::\n+\n+    Entry.objects.create(headline=\"Python 3.0 Released\")\n+    Entry.objects.create(headline=\"Python 3.1 Planned\")\n+\n+Note that there are a number of :meth:`caveats to this method\n+<django.db.models.query.QuerySet.bulk_create>`, make sure it is appropriate for\n+your use case. This also applies to :class:`ManyToManyFields\n+<django.db.models.ManyToManyField>`, doing::\n+\n+    my_band.members.add(me, my_friend)\n+\n+Is preferable to::\n+\n+    my_band.members.add(me)\n+    my_band.members.add(my_friend)\n+\n+Where ``Bands`` and ``Artists`` have a many-to-many relationship."
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/bulk_create/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fbulk_create%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fbulk_create%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbulk_create%2F__init__.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6"
        },
        {
            "sha": "a4c611d53755155e8a45909cb2421150bcaa03cf",
            "filename": "tests/regressiontests/bulk_create/models.py",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fbulk_create%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fbulk_create%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbulk_create%2Fmodels.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -0,0 +1,21 @@\n+from django.db import models\n+\n+\n+class Country(models.Model):\n+    name = models.CharField(max_length=255)\n+    iso_two_letter = models.CharField(max_length=2)\n+\n+class Place(models.Model):\n+    name = models.CharField(max_length=100)\n+\n+    class Meta:\n+        abstract = True\n+\n+class Restaurant(Place):\n+    pass\n+\n+class Pizzeria(Restaurant):\n+    pass\n+\n+class State(models.Model):\n+    two_letter_code = models.CharField(max_length=2, primary_key=True)\n\\ No newline at end of file"
        },
        {
            "sha": "8d3faa2379d93ad3a1b80dc0dfeabaaa8d7e2c57",
            "filename": "tests/regressiontests/bulk_create/tests.py",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbulk_create%2Ftests.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -0,0 +1,54 @@\n+from __future__ import with_statement\n+\n+from operator import attrgetter\n+\n+from django.test import TestCase, skipUnlessDBFeature\n+\n+from models import Country, Restaurant, Pizzeria, State\n+\n+\n+class BulkCreateTests(TestCase):\n+    def setUp(self):\n+        self.data = [\n+            Country(name=\"United States of America\", iso_two_letter=\"US\"),\n+            Country(name=\"The Netherlands\", iso_two_letter=\"NL\"),\n+            Country(name=\"Germany\", iso_two_letter=\"DE\"),\n+            Country(name=\"Czech Republic\", iso_two_letter=\"CZ\")\n+        ]\n+\n+    def test_simple(self):\n+        Country.objects.bulk_create(self.data)\n+        self.assertQuerysetEqual(Country.objects.order_by(\"-name\"), [\n+            \"United States of America\", \"The Netherlands\", \"Germany\", \"Czech Republic\"\n+        ], attrgetter(\"name\"))\n+\n+    @skipUnlessDBFeature(\"has_bulk_insert\")\n+    def test_efficiency(self):\n+        with self.assertNumQueries(1):\n+            Country.objects.bulk_create(self.data)\n+\n+    def test_inheritance(self):\n+        Restaurant.objects.bulk_create([\n+            Restaurant(name=\"Nicholas's\")\n+        ])\n+        self.assertQuerysetEqual(Restaurant.objects.all(), [\n+            \"Nicholas's\",\n+        ], attrgetter(\"name\"))\n+        with self.assertRaises(ValueError):\n+            Pizzeria.objects.bulk_create([\n+                Pizzeria(name=\"The Art of Pizza\")\n+            ])\n+        self.assertQuerysetEqual(Pizzeria.objects.all(), [])\n+        self.assertQuerysetEqual(Restaurant.objects.all(), [\n+            \"Nicholas's\",\n+        ], attrgetter(\"name\"))\n+\n+    def test_non_auto_increment_pk(self):\n+        with self.assertNumQueries(1):\n+            State.objects.bulk_create([\n+                State(two_letter_code=s)\n+                for s in [\"IL\", \"NY\", \"CA\", \"ME\"]\n+            ])\n+        self.assertQuerysetEqual(State.objects.order_by(\"two_letter_code\"), [\n+            \"CA\", \"IL\", \"ME\", \"NY\",\n+        ], attrgetter(\"two_letter_code\"))\n\\ No newline at end of file"
        },
        {
            "sha": "1d3bbfa101ad05314a05cdd752ce4ee6c8cb23ae",
            "filename": "tests/regressiontests/db_typecasts/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fdb_typecasts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6/tests%2Fregressiontests%2Fdb_typecasts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdb_typecasts%2Ftests.py?ref=7deb25b8dd5aa1ed02b5e30cbc67cd1fb0c3d6e6",
            "patch": "@@ -53,10 +53,10 @@\n \n class DBTypeCasts(unittest.TestCase):\n     def test_typeCasts(self):\n-        for k, v in TEST_CASES.items():\n+        for k, v in TEST_CASES.iteritems():\n             for inpt, expected in v:\n                 got = getattr(typecasts, k)(inpt)\n-                assert got == expected, \"In %s: %r doesn't match %r. Got %r instead.\" % (k, inpt, expected, got)\n+                self.assertEqual(got, expected, \"In %s: %r doesn't match %r. Got %r instead.\" % (k, inpt, expected, got))\n \n if __name__ == '__main__':\n     unittest.main()"
        }
    ],
    "stats": {
        "total": 409,
        "additions": 331,
        "deletions": 78
    }
}