{
    "author": "carljm",
    "message": "Fixed #14082 -- Use metaclass of provided ModelForm subclass in modelform_factory. Thanks jspiros and Stephen Burrows for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16334 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "684b0396cfff1c4343a83bd600db69af9188986d",
    "files": [
        {
            "sha": "b34f4d03e8409bf06f4cf98bd5c46db3cb630ede",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/684b0396cfff1c4343a83bd600db69af9188986d/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/684b0396cfff1c4343a83bd600db69af9188986d/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=684b0396cfff1c4343a83bd600db69af9188986d",
            "patch": "@@ -396,7 +396,12 @@ def modelform_factory(model, form=ModelForm, fields=None, exclude=None,\n         'formfield_callback': formfield_callback\n     }\n \n-    return ModelFormMetaclass(class_name, (form,), form_class_attrs)\n+    form_metaclass = ModelFormMetaclass\n+\n+    if issubclass(form, BaseModelForm) and hasattr(form, '__metaclass__'):\n+        form_metaclass = form.__metaclass__\n+\n+    return form_metaclass(class_name, (form,), form_class_attrs)\n \n \n # ModelFormSets ##############################################################"
        },
        {
            "sha": "9817858afca105034d9b22688b3f7798c6e9833a",
            "filename": "tests/regressiontests/model_forms_regress/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/684b0396cfff1c4343a83bd600db69af9188986d/tests%2Fregressiontests%2Fmodel_forms_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/684b0396cfff1c4343a83bd600db69af9188986d/tests%2Fregressiontests%2Fmodel_forms_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_forms_regress%2Ftests.py?ref=684b0396cfff1c4343a83bd600db69af9188986d",
            "patch": "@@ -4,7 +4,7 @@\n from django.core.exceptions import FieldError, ValidationError\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.forms.models import (modelform_factory, ModelChoiceField,\n-    fields_for_model, construct_instance)\n+    fields_for_model, construct_instance, ModelFormMetaclass)\n from django.utils import unittest\n from django.test import TestCase\n \n@@ -460,3 +460,19 @@ def test_empty_fields_to_construct_instance(self):\n         self.assertTrue(form.is_valid())\n         instance = construct_instance(form, Person(), fields=())\n         self.assertEqual(instance.name, '')\n+\n+\n+class CustomMetaclass(ModelFormMetaclass):\n+    def __new__(cls, name, bases, attrs):\n+        new = super(CustomMetaclass, cls).__new__(cls, name, bases, attrs)\n+        new.base_fields = {}\n+        return new\n+\n+class CustomMetaclassForm(forms.ModelForm):\n+    __metaclass__ = CustomMetaclass\n+\n+\n+class CustomMetaclassTestCase(TestCase):\n+    def test_modelform_factory_metaclass(self):\n+        new_cls = modelform_factory(Person, form=CustomMetaclassForm)\n+        self.assertEqual(new_cls.base_fields, {})"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 23,
        "deletions": 2
    }
}