{
    "author": "aaugustin",
    "message": "Fixed #19708 -- Exception in timezone.override(None).\n\nThanks rafales.",
    "sha": "9a4a1ce323237d0aadafbddcd270c47be251bac2",
    "files": [
        {
            "sha": "a56ff0b6ab03a1662f1958daf56110b7e41e7f3e",
            "filename": "django/utils/timezone.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/9a4a1ce323237d0aadafbddcd270c47be251bac2/django%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/9a4a1ce323237d0aadafbddcd270c47be251bac2/django%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftimezone.py?ref=9a4a1ce323237d0aadafbddcd270c47be251bac2",
            "patch": "@@ -111,6 +111,7 @@ def get_default_timezone():\n         if isinstance(settings.TIME_ZONE, six.string_types) and pytz is not None:\n             _localtime = pytz.timezone(settings.TIME_ZONE)\n         else:\n+            # This relies on os.environ['TZ'] being set to settings.TIME_ZONE.\n             _localtime = LocalTimezone()\n     return _localtime\n \n@@ -198,10 +199,10 @@ def __enter__(self):\n             activate(self.timezone)\n \n     def __exit__(self, exc_type, exc_value, traceback):\n-        if self.old_timezone is not None:\n-            _active.value = self.old_timezone\n+        if self.old_timezone is None:\n+            deactivate()\n         else:\n-            del _active.value\n+            _active.value = self.old_timezone\n \n \n # Templates"
        },
        {
            "sha": "650198e8ffeef89a76045b5f40e849ca512d0627",
            "filename": "tests/regressiontests/utils/timezone.py",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/9a4a1ce323237d0aadafbddcd270c47be251bac2/tests%2Fregressiontests%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/9a4a1ce323237d0aadafbddcd270c47be251bac2/tests%2Fregressiontests%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftimezone.py?ref=9a4a1ce323237d0aadafbddcd270c47be251bac2",
            "patch": "@@ -3,9 +3,14 @@\n import pickle\n from django.test.utils import override_settings\n from django.utils import timezone\n+from django.utils.tzinfo import FixedOffset\n from django.utils import unittest\n \n \n+EAT = FixedOffset(180)      # Africa/Nairobi\n+ICT = FixedOffset(420)      # Asia/Bangkok\n+\n+\n class TimezoneTests(unittest.TestCase):\n \n     def test_localtime(self):\n@@ -20,6 +25,31 @@ def test_now(self):\n         with override_settings(USE_TZ=False):\n             self.assertTrue(timezone.is_naive(timezone.now()))\n \n+    def test_override(self):\n+        default = timezone.get_default_timezone()\n+        try:\n+            timezone.activate(ICT)\n+\n+            with timezone.override(EAT):\n+                self.assertIs(EAT, timezone.get_current_timezone())\n+            self.assertIs(ICT, timezone.get_current_timezone())\n+\n+            with timezone.override(None):\n+                self.assertIs(default, timezone.get_current_timezone())\n+            self.assertIs(ICT, timezone.get_current_timezone())\n+\n+            timezone.deactivate()\n+\n+            with timezone.override(EAT):\n+                self.assertIs(EAT, timezone.get_current_timezone())\n+            self.assertIs(default, timezone.get_current_timezone())\n+\n+            with timezone.override(None):\n+                self.assertIs(default, timezone.get_current_timezone())\n+            self.assertIs(default, timezone.get_current_timezone())\n+        finally:\n+            timezone.deactivate()\n+\n     def test_copy(self):\n         self.assertIsInstance(copy.copy(timezone.UTC()), timezone.UTC)\n         self.assertIsInstance(copy.copy(timezone.LocalTimezone()), timezone.LocalTimezone)"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 34,
        "deletions": 3
    }
}