{
    "author": "jezdez",
    "message": "Fixed #10802 -- Handle ImportErrors and AttributeErrors gracefully when raised by the URL resolver system during startup. Many thanks, IonelMaries and Bas Peschier.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16420 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b4cdf4d111e2a536abddeb38d029e71bb0d41ddb",
    "files": [
        {
            "sha": "72f4f20e4bef875316559d4683e965585da3427f",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 20,
            "deletions": 19,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=b4cdf4d111e2a536abddeb38d029e71bb0d41ddb",
            "patch": "@@ -16,6 +16,7 @@\n from django.utils.encoding import iri_to_uri, force_unicode, smart_str\n from django.utils.functional import memoize, lazy\n from django.utils.importlib import import_module\n+from django.utils.module_loading import module_has_submodule\n from django.utils.regex_helper import normalize\n from django.utils.translation import get_language\n \n@@ -84,19 +85,28 @@ def get_callable(lookup_view, can_fail=False):\n     during the import fail and the string is returned.\n     \"\"\"\n     if not callable(lookup_view):\n+        mod_name, func_name = get_mod_func(lookup_view)\n         try:\n-            # Bail early for non-ASCII strings (they can't be functions).\n-            lookup_view = lookup_view.encode('ascii')\n-            mod_name, func_name = get_mod_func(lookup_view)\n             if func_name != '':\n                 lookup_view = getattr(import_module(mod_name), func_name)\n                 if not callable(lookup_view):\n-                    raise AttributeError(\"'%s.%s' is not a callable.\" % (mod_name, func_name))\n-        except (ImportError, AttributeError):\n+                    raise ViewDoesNotExist(\n+                        \"Could not import %s.%s. View is not callable.\"\n+                    % (mod_name, func_name))\n+        except AttributeError:\n+            if not can_fail:\n+                raise ViewDoesNotExist(\n+                    \"Could not import %s. View does not exist in module %s.\"\n+                    % (lookup_view, mod_name))\n+        except ImportError:\n+            ownermod, submod = get_mod_func(mod_name)\n+            if (not can_fail and submod != '' and\n+                    not module_has_submodule(import_module(ownermod), submod)):\n+                raise ViewDoesNotExist(\n+                    \"Could not import %s. Owning module %s does not exist.\"\n+                    % (lookup_view, mod_name))\n             if not can_fail:\n                 raise\n-        except UnicodeEncodeError:\n-            pass\n     return lookup_view\n get_callable = memoize(get_callable, _callable_cache, 1)\n \n@@ -192,14 +202,8 @@ def resolve(self, path):\n     def callback(self):\n         if self._callback is not None:\n             return self._callback\n-        try:\n-            self._callback = get_callable(self._callback_str)\n-        except ImportError, e:\n-            mod_name, _ = get_mod_func(self._callback_str)\n-            raise ViewDoesNotExist(\"Could not import %s. Error was: %s\" % (mod_name, str(e)))\n-        except AttributeError, e:\n-            mod_name, func_name = get_mod_func(self._callback_str)\n-            raise ViewDoesNotExist(\"Tried %s in module %s. Error was: %s\" % (func_name, mod_name, str(e)))\n+\n+        self._callback = get_callable(self._callback_str)\n         return self._callback\n \n class RegexURLResolver(LocaleRegexProvider):\n@@ -325,10 +329,7 @@ def _resolve_special(self, view_type):\n             # Lazy import, since urls.defaults imports this file\n             from django.conf.urls import defaults\n             callback = getattr(defaults, 'handler%s' % view_type)\n-        try:\n-            return get_callable(callback), {}\n-        except (ImportError, AttributeError), e:\n-            raise ViewDoesNotExist(\"Tried %s. Error was: %s\" % (callback, str(e)))\n+        return get_callable(callback), {}\n \n     def resolve404(self):\n         return self._resolve_special('404')"
        },
        {
            "sha": "b09fff7e3e22251e8b9a84ec777bbff2bb4019ee",
            "filename": "tests/regressiontests/urlpatterns_reverse/erroneous_urls.py",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Ferroneous_urls.py",
            "raw_url": "https://github.com/django/django/raw/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Ferroneous_urls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ferroneous_urls.py?ref=b4cdf4d111e2a536abddeb38d029e71bb0d41ddb",
            "patch": "@@ -0,0 +1,14 @@\n+from django.conf.urls.defaults import patterns, url\n+\n+urlpatterns = patterns('',\n+    # View has erroneous import\n+    url(r'erroneous_inner/$', 'regressiontests.urlpatterns_reverse.views.erroneous_view'),\n+    # Module has erroneous import\n+    url(r'erroneous_outer/$', 'regressiontests.urlpatterns_reverse.erroneous_views_module.erroneous_view'),\n+    # View does not exist\n+    url(r'missing_inner/$', 'regressiontests.urlpatterns_reverse.views.missing_view'),\n+    # View is not callable\n+    url(r'uncallable/$', 'regressiontests.urlpatterns_reverse.views.uncallable'),\n+    # Module does not exist\n+    url(r'missing_outer/$', 'regressiontests.urlpatterns_reverse.missing_module.missing_view'),\n+)"
        },
        {
            "sha": "7f6b75e00f6de67cd9129bcf13b50967d7126b2e",
            "filename": "tests/regressiontests/urlpatterns_reverse/erroneous_views_module.py",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Ferroneous_views_module.py",
            "raw_url": "https://github.com/django/django/raw/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Ferroneous_views_module.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ferroneous_views_module.py?ref=b4cdf4d111e2a536abddeb38d029e71bb0d41ddb",
            "patch": "@@ -0,0 +1,4 @@\n+import non_existent\n+\n+def erroneous_view(request):\n+    pass"
        },
        {
            "sha": "f447adf4cc76ec1422fe2a54a99c570ddea72338",
            "filename": "tests/regressiontests/urlpatterns_reverse/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py?ref=b4cdf4d111e2a536abddeb38d029e71bb0d41ddb",
            "patch": "@@ -2,7 +2,7 @@\n Unit tests for reverse URL lookups.\n \"\"\"\n from django.conf import settings\n-from django.core.exceptions import ImproperlyConfigured\n+from django.core.exceptions import ImproperlyConfigured, ViewDoesNotExist\n from django.core.urlresolvers import reverse, resolve, NoReverseMatch,\\\n                                      Resolver404, ResolverMatch,\\\n                                      RegexURLResolver, RegexURLPattern\n@@ -470,3 +470,14 @@ def test_urlpattern_resolve(self):\n             self.assertEqual(match[0], func)\n             self.assertEqual(match[1], args)\n             self.assertEqual(match[2], kwargs)\n+\n+class ErroneousViewTests(TestCase):\n+    urls = 'regressiontests.urlpatterns_reverse.erroneous_urls'\n+\n+    def test_erroneous_resolve(self):\n+        self.assertRaises(ImportError, self.client.get, '/erroneous_inner/')\n+        self.assertRaises(ImportError, self.client.get, '/erroneous_outer/')\n+        self.assertRaises(ViewDoesNotExist, self.client.get, '/missing_inner/')\n+        self.assertRaises(ViewDoesNotExist, self.client.get, '/missing_outer/')\n+        self.assertRaises(ViewDoesNotExist, self.client.get, '/uncallable/')\n+"
        },
        {
            "sha": "f631acf3ec19342754cea06d68981064cdbb9faa",
            "filename": "tests/regressiontests/urlpatterns_reverse/views.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/b4cdf4d111e2a536abddeb38d029e71bb0d41ddb/tests%2Fregressiontests%2Furlpatterns_reverse%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Fviews.py?ref=b4cdf4d111e2a536abddeb38d029e71bb0d41ddb",
            "patch": "@@ -16,6 +16,11 @@ def absolute_kwargs_view(request, arg1=1, arg2=2):\n def defaults_view(request, arg1, arg2):\n     pass\n \n+def erroneous_view(request):\n+    import non_existent\n+\n+uncallable = \"Can I be a view? Pleeeease?\"\n+\n class ViewClass(object):\n     def __call__(self, request, *args, **kwargs):\n         return HttpResponse('')"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 55,
        "deletions": 20
    }
}