{
    "author": "alex",
    "message": "Fixed #14864, #14864 -- ROCIFField didn't accept values starting with RO, as it was supposed to, and ROCNPField, ROIBANField, and ROPhoneNumberField didn't handle all EMPTY_VALUES correctly.  Also converted Romanian localflavor doctests to unittests.  We have always been at war with doctests.  Thanks to Idan Gazit.\n\nFixing RO localflavor clean() #14864\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14951 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d01cb6ed17647ed8af8b5c3d083fbd3ca21039df",
    "files": [
        {
            "sha": "a218bfd167b9a03576d236951ce81a456ec49f43",
            "filename": "django/contrib/localflavor/ro/forms.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/django%2Fcontrib%2Flocalflavor%2Fro%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/django%2Fcontrib%2Flocalflavor%2Fro%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Flocalflavor%2Fro%2Fforms.py?ref=d01cb6ed17647ed8af8b5c3d083fbd3ca21039df",
            "patch": "@@ -20,7 +20,7 @@ class ROCIFField(RegexField):\n     }\n \n     def __init__(self, *args, **kwargs):\n-        super(ROCIFField, self).__init__(r'^[0-9]{2,10}', max_length=10,\n+        super(ROCIFField, self).__init__(r'^(RO)?[0-9]{2,10}', max_length=10,\n                 min_length=2, *args, **kwargs)\n \n     def clean(self, value):\n@@ -65,6 +65,8 @@ def clean(self, value):\n         CNP validations\n         \"\"\"\n         value = super(ROCNPField, self).clean(value)\n+        if value in EMPTY_VALUES:\n+            return u''\n         # check birthdate digits\n         import datetime\n         try:\n@@ -150,6 +152,8 @@ def clean(self, value):\n         Strips - and spaces, performs country code and checksum validation\n         \"\"\"\n         value = super(ROIBANField, self).clean(value)\n+        if value in EMPTY_VALUES:\n+            return u''\n         value = value.replace('-','')\n         value = value.replace(' ','')\n         value = value.upper()\n@@ -180,6 +184,8 @@ def clean(self, value):\n         Strips -, (, ) and spaces. Checks the final length.\n         \"\"\"\n         value = super(ROPhoneNumberField, self).clean(value)\n+        if value in EMPTY_VALUES:\n+            return u''\n         value = value.replace('-','')\n         value = value.replace('(','')\n         value = value.replace(')','')"
        },
        {
            "sha": "5b546cd68ba8dbf4115be29e560ea56da81a1175",
            "filename": "tests/regressiontests/forms/localflavor/ro.py",
            "status": "modified",
            "additions": 139,
            "deletions": 174,
            "changes": 313,
            "blob_url": "https://github.com/django/django/blob/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/tests%2Fregressiontests%2Fforms%2Flocalflavor%2Fro.py",
            "raw_url": "https://github.com/django/django/raw/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/tests%2Fregressiontests%2Fforms%2Flocalflavor%2Fro.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Flocalflavor%2Fro.py?ref=d01cb6ed17647ed8af8b5c3d083fbd3ca21039df",
            "patch": "@@ -1,175 +1,140 @@\n # -*- coding: utf-8 -*-\n-# Tests for the contrib/localflavor/ RO form fields.\n-\n-tests = r\"\"\"\n->>> from django.contrib.localflavor.ro.forms import *\n-\n-##ROCIFField ################################################################\n-\n-f = ROCIFField()\n-f.clean('21694681')\n-u'21694681'\n-f.clean('RO21694681')\n-u'21694681'\n-f.clean('21694680')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a valid CIF']\n-f.clean('21694680000')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at most 10 characters (it has 11).']\n-f.clean('0')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at least 2 characters (it has 1).']\n-f.clean(None)\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-f.clean('')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-\n-##ROCNPField #################################################################\n-\n-f = ROCNPField()\n-f.clean('1981211204489')\n-u'1981211204489'\n-f.clean('1981211204487')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a valid CNP']\n-f.clean('1981232204489')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a valid CNP']\n-f.clean('9981211204489')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a valid CNP']\n-f.clean('9981211209')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at least 13 characters (it has 10).']\n-f.clean('19812112044891')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at most 13 characters (it has 14).']\n-f.clean('')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-\n-##ROCountyField ##############################################################\n-\n-f = ROCountyField()\n-f.clean('CJ')\n-'CJ'\n-f.clean('cj')\n-'CJ'\n-f.clean('Argeş')\n-'AG'\n-f.clean('argeş')\n-'AG'\n-f.clean('Arges')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a Romanian county code or name.']\n-f.clean('')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-\n-##ROCountySelect #############################################################\n-\n-f = ROCountySelect()\n-f.render('county','CJ')\n-u'<select name=\"county\">\\n<option value=\"AB\">Alba</option>\\n<option value=\"AR\">A\n-rad</option>\\n<option value=\"AG\">Arge\\u015f</option>\\n<option value=\"BC\">Bac\\u01\n-03u</option>\\n<option value=\"BH\">Bihor</option>\\n<option value=\"BN\">Bistri\\u0163\n-a-N\\u0103s\\u0103ud</option>\\n<option value=\"BT\">Boto\\u015fani</option>\\n<option\n-value=\"BV\">Bra\\u015fov</option>\\n<option value=\"BR\">Br\\u0103ila</option>\\n<optio\n-n value=\"B\">Bucure\\u015fti</option>\\n<option value=\"BZ\">Buz\\u0103u</option>\\n<op\n-tion value=\"CS\">Cara\\u015f-Severin</option>\\n<option value=\"CL\">C\\u0103l\\u0103ra\n-\\u015fi</option>\\n<option value=\"CJ\" selected=\"selected\">Cluj</option>\\n<option\n-value=\"CT\">Constan\\u0163a</option>\\n<option value=\"CV\">Covasna</option>\\n<option\n- value=\"DB\">D\\xe2mbovi\\u0163a</option>\\n<option value=\"DJ\">Dolj</option>\\n<optio\n-n value=\"GL\">Gala\\u0163i</option>\\n<option value=\"GR\">Giurgiu</option>\\n<option\n-value=\"GJ\">Gorj</option>\\n<option value=\"HR\">Harghita</option>\\n<option value=\"H\n-D\">Hunedoara</option>\\n<option value=\"IL\">Ialomi\\u0163a</option>\\n<option value=\n-\"IS\">Ia\\u015fi</option>\\n<option value=\"IF\">Ilfov</option>\\n<option value=\"MM\">M\n-aramure\\u015f</option>\\n<option value=\"MH\">Mehedin\\u0163i</option>\\n<option valu\n-e=\"MS\">Mure\\u015f</option>\\n<option value=\"NT\">Neam\\u0163</option>\\n<option valu\n-e=\"OT\">Olt</option>\\n<option value=\"PH\">Prahova</option>\\n<option value=\"SM\">Sat\n-u Mare</option>\\n<option value=\"SJ\">S\\u0103laj</option>\\n<option value=\"SB\">Sibi\n-u</option>\\n<option value=\"SV\">Suceava</option>\\n<option value=\"TR\">Teleorman</o\n-ption>\\n<option value=\"TM\">Timi\\u015f</option>\\n<option value=\"TL\">Tulcea</optio\n-n>\\n<option value=\"VS\">Vaslui</option>\\n<option value=\"VL\">V\\xe2lcea</option>\\n<\n-option value=\"VN\">Vrancea</option>\\n</select>'\n-\n-##ROIBANField #################################################################\n-\n-f = ROIBANField()\n-f.clean('RO56RZBR0000060003291177')\n-u'RO56RZBR0000060003291177'\n-f.clean('RO56RZBR0000060003291176')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a valid IBAN in ROXX-XXXX-XXXX-XXXX-XXXX-XXXX format']\n-\n-f.clean('RO56-RZBR-0000-0600-0329-1177')\n-u'RO56RZBR0000060003291177'\n-f.clean('AT61 1904 3002 3457 3201')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Enter a valid IBAN in ROXX-XXXX-XXXX-XXXX-XXXX-XXXX format']\n-\n-f.clean('RO56RZBR000006000329117')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at least 24 characters (it has 23).']\n-f.clean('')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-\n-##ROPhoneNumberField ##########################################################\n-\n-f = ROPhoneNumberField()\n-f.clean('0264485936')\n-u'0264485936'\n-f.clean('(0264)-485936')\n-u'0264485936'\n-f.clean('02644859368')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Phone numbers must be in XXXX-XXXXXX format.']\n-f.clean('026448593')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at least 10 characters (it has 9).']\n-f.clean(None)\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-\n-##ROPostalCodeField ###########################################################\n-\n-f = ROPostalCodeField()\n-f.clean('400473')\n-u'400473'\n-f.clean('40047')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at least 6 characters (it has 5).']\n-f.clean('4004731')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'Ensure this value has at most 6 characters (it has 7).']\n-f.clean('')\n-Traceback (most recent call last):\n-...\n-ValidationError: [u'This field is required.']\n-\"\"\"\n+from django.contrib.localflavor.ro.forms import (ROCIFField, ROCNPField,\n+    ROCountyField, ROCountySelect, ROIBANField, ROPhoneNumberField,\n+    ROPostalCodeField)\n+\n+from utils import LocalFlavorTestCase\n+\n+\n+class ROLocalFlavorTests(LocalFlavorTestCase):\n+    def test_ROCountySelect(self):\n+        f = ROCountySelect()\n+        out = u'''<select name=\"county\">\n+<option value=\"AB\">Alba</option>\n+<option value=\"AR\">Arad</option>\n+<option value=\"AG\">Arge\\u015f</option>\n+<option value=\"BC\">Bac\\u0103u</option>\n+<option value=\"BH\">Bihor</option>\n+<option value=\"BN\">Bistri\\u0163a-N\\u0103s\\u0103ud</option>\n+<option value=\"BT\">Boto\\u015fani</option>\n+<option value=\"BV\">Bra\\u015fov</option>\n+<option value=\"BR\">Br\\u0103ila</option>\n+<option value=\"B\">Bucure\\u015fti</option>\n+<option value=\"BZ\">Buz\\u0103u</option>\n+<option value=\"CS\">Cara\\u015f-Severin</option>\n+<option value=\"CL\">C\\u0103l\\u0103ra\\u015fi</option>\n+<option value=\"CJ\" selected=\"selected\">Cluj</option>\n+<option value=\"CT\">Constan\\u0163a</option>\n+<option value=\"CV\">Covasna</option>\n+<option value=\"DB\">D\\xe2mbovi\\u0163a</option>\n+<option value=\"DJ\">Dolj</option>\n+<option value=\"GL\">Gala\\u0163i</option>\n+<option value=\"GR\">Giurgiu</option>\n+<option value=\"GJ\">Gorj</option>\n+<option value=\"HR\">Harghita</option>\n+<option value=\"HD\">Hunedoara</option>\n+<option value=\"IL\">Ialomi\\u0163a</option>\n+<option value=\"IS\">Ia\\u015fi</option>\n+<option value=\"IF\">Ilfov</option>\n+<option value=\"MM\">Maramure\\u015f</option>\n+<option value=\"MH\">Mehedin\\u0163i</option>\n+<option value=\"MS\">Mure\\u015f</option>\n+<option value=\"NT\">Neam\\u0163</option>\n+<option value=\"OT\">Olt</option>\n+<option value=\"PH\">Prahova</option>\n+<option value=\"SM\">Satu Mare</option>\n+<option value=\"SJ\">S\\u0103laj</option>\n+<option value=\"SB\">Sibiu</option>\n+<option value=\"SV\">Suceava</option>\n+<option value=\"TR\">Teleorman</option>\n+<option value=\"TM\">Timi\\u015f</option>\n+<option value=\"TL\">Tulcea</option>\n+<option value=\"VS\">Vaslui</option>\n+<option value=\"VL\">V\\xe2lcea</option>\n+<option value=\"VN\">Vrancea</option>\n+</select>'''\n+        self.assertEqual(f.render('county', 'CJ'), out)\n+\n+    def test_ROCIFField(self):\n+        error_invalid = [u'Enter a valid CIF.']\n+        error_atmost = [u'Ensure this value has at most 10 characters (it has 11).']\n+        error_atleast = [u'Ensure this value has at least 2 characters (it has 1).']\n+        valid = {\n+            '21694681': u'21694681',\n+            'RO21694681': u'21694681',\n+        }\n+        invalid = {\n+            '21694680': error_invalid,\n+            '21694680000': error_atmost,\n+            '0': error_atleast,\n+        }\n+        self.assertFieldOutput(ROCIFField, valid, invalid)\n+\n+    def test_ROCNPField(self):\n+        error_invalid = [u'Enter a valid CNP.']\n+        error_atleast = [u'Ensure this value has at least 13 characters (it has 10).']\n+        error_atmost = [u'Ensure this value has at most 13 characters (it has 14).']\n+        valid = {\n+            '1981211204489': '1981211204489',\n+        }\n+        invalid = {\n+            '1981211204487': error_invalid,\n+            '1981232204489': error_invalid,\n+            '9981211204489': error_invalid,\n+            '9981211209': error_atleast,\n+            '19812112044891': error_atmost,\n+        }\n+        self.assertFieldOutput(ROCNPField, valid, invalid)\n+\n+    def test_ROCountyField(self):\n+        error_format = [u'Enter a Romanian county code or name.']\n+        valid = {\n+            'CJ': 'CJ',\n+            'cj': 'CJ',\n+            u'Argeş': 'AG',\n+            u'argeş': 'AG',\n+        }\n+        invalid = {\n+            'Arges': error_format,\n+        }\n+        self.assertFieldOutput(ROCountyField, valid, invalid)\n+\n+    def test_ROIBANField(self):\n+        error_invalid = [u'Enter a valid IBAN in ROXX-XXXX-XXXX-XXXX-XXXX-XXXX format']\n+        error_atleast = [u'Ensure this value has at least 24 characters (it has 23).']\n+        valid = {\n+            'RO56RZBR0000060003291177': 'RO56RZBR0000060003291177',\n+            'RO56-RZBR-0000-0600-0329-1177': 'RO56RZBR0000060003291177',\n+        }\n+        invalid = {\n+            'RO56RZBR0000060003291176': error_invalid,\n+            'AT61 1904 3002 3457 3201': error_invalid,\n+            'RO56RZBR000006000329117': error_atleast,\n+        }\n+        self.assertFieldOutput(ROIBANField, valid, invalid)\n+\n+    def test_ROPhoneNumberField(self):\n+        error_format = [u'Phone numbers must be in XXXX-XXXXXX format.']\n+        error_atleast = [u'Ensure this value has at least 10 characters (it has 9).']\n+        valid = {\n+            '0264485936': '0264485936',\n+            '(0264)-485936': '0264485936',\n+        }\n+        invalid = {\n+            '02644859368': error_format,\n+            '026448593': error_atleast,\n+        }\n+        self.assertFieldOutput(ROPhoneNumberField, valid, invalid)\n+\n+    def test_ROPostalCodeField(self):\n+        error_atleast = [u'Ensure this value has at least 6 characters (it has 5).']\n+        error_atmost = [u'Ensure this value has at most 6 characters (it has 7).']\n+\n+        valid = {\n+            '400473': '400473',\n+        }\n+        invalid = {\n+            '40047': error_atleast,\n+            '4004731': error_atmost,\n+        }\n+        self.assertFieldOutput(ROPostalCodeField, valid, invalid)"
        },
        {
            "sha": "9f2295fff023ecafc9acee21e8339e8be6c01164",
            "filename": "tests/regressiontests/forms/localflavortests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/tests%2Fregressiontests%2Fforms%2Flocalflavortests.py",
            "raw_url": "https://github.com/django/django/raw/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/tests%2Fregressiontests%2Fforms%2Flocalflavortests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Flocalflavortests.py?ref=d01cb6ed17647ed8af8b5c3d083fbd3ca21039df",
            "patch": "@@ -1,6 +1,5 @@\n # -*- coding: utf-8 -*-\n from localflavor.cz import tests as localflavor_cz_tests\n-from localflavor.ro import tests as localflavor_ro_tests\n from localflavor.se import tests as localflavor_se_tests\n from localflavor.sk import tests as localflavor_sk_tests\n from localflavor.uk import tests as localflavor_uk_tests\n@@ -31,12 +30,12 @@\n from localflavor.nl import NLLocalFlavorTests\n from localflavor.pl import PLLocalFlavorTests\n from localflavor.pt import PTLocalFlavorTests\n+from localflavor.ro import ROLocalFlavorTests\n from localflavor.tr import TRLocalFlavorTests\n \n \n __test__ = {\n     'localflavor_cz_tests': localflavor_cz_tests,\n-    'localflavor_ro_tests': localflavor_ro_tests,\n     'localflavor_se_tests': localflavor_se_tests,\n     'localflavor_sk_tests': localflavor_sk_tests,\n     'localflavor_uk_tests': localflavor_uk_tests,"
        },
        {
            "sha": "6019d85e2b1c487f7ebd70bd7cc393ac2fe53eac",
            "filename": "tests/regressiontests/forms/tests/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/tests%2Fregressiontests%2Fforms%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/d01cb6ed17647ed8af8b5c3d083fbd3ca21039df/tests%2Fregressiontests%2Fforms%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2F__init__.py?ref=d01cb6ed17647ed8af8b5c3d083fbd3ca21039df",
            "patch": "@@ -36,5 +36,6 @@\n     NLLocalFlavorTests,\n     PLLocalFlavorTests,\n     PTLocalFlavorTests,\n+    ROLocalFlavorTests,\n     TRLocalFlavorTests,\n )"
        }
    ],
    "stats": {
        "total": 325,
        "additions": 148,
        "deletions": 177
    }
}