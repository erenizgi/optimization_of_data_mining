{
    "author": "ramiro",
    "message": "Fixed #8001 -- Made redirections after add/edit in admin customizable.\n\nAlso fixes #18310.",
    "sha": "0b908b92a2ca4fb74a103e96bb75c53c05d0a428",
    "files": [
        {
            "sha": "bbd7939d3fb3f080e3dceda11f83b45bda16bdf6",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 104,
            "deletions": 42,
            "changes": 146,
            "blob_url": "https://github.com/django/django/blob/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=0b908b92a2ca4fb74a103e96bb75c53c05d0a428",
            "patch": "@@ -1,12 +1,14 @@\n from functools import update_wrapper, partial\n+import warnings\n+\n from django import forms\n from django.conf import settings\n from django.forms.formsets import all_valid\n from django.forms.models import (modelform_factory, modelformset_factory,\n     inlineformset_factory, BaseInlineFormSet)\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.admin import widgets, helpers\n-from django.contrib.admin.util import unquote, flatten_fieldsets, get_deleted_objects, model_format_dict\n+from django.contrib.admin.util import quote, unquote, flatten_fieldsets, get_deleted_objects, model_format_dict\n from django.contrib.admin.templatetags.admin_static import static\n from django.contrib import messages\n from django.views.decorators.csrf import csrf_protect\n@@ -763,21 +765,49 @@ def render_change_form(self, request, context, add=False, change=False, form_url\n             \"admin/change_form.html\"\n         ], context, current_app=self.admin_site.name)\n \n-    def response_add(self, request, obj, post_url_continue='../%s/'):\n+    def response_add(self, request, obj, post_url_continue='../%s/',\n+                     continue_editing_url=None, add_another_url=None,\n+                     hasperm_url=None, noperm_url=None):\n         \"\"\"\n         Determines the HttpResponse for the add_view stage.\n-        \"\"\"\n+\n+        :param request: HttpRequest instance.\n+        :param obj: Object just added.\n+        :param post_url_continue: Deprecated/undocumented.\n+        :param continue_editing_url: URL where user will be redirected after\n+                                     pressing 'Save and continue editing'.\n+        :param add_another_url: URL where user will be redirected after\n+                                pressing 'Save and add another'.\n+        :param hasperm_url: URL to redirect after a successful object creation\n+                            when the user has change permissions.\n+        :param noperm_url: URL to redirect after a successful object creation\n+                           when the user has no change permissions.\n+        \"\"\"\n+        if post_url_continue != '../%s/':\n+            warnings.warn(\"The undocumented 'post_url_continue' argument to \"\n+                          \"ModelAdmin.response_add() is deprecated, use the new \"\n+                          \"*_url arguments instead.\", DeprecationWarning,\n+                          stacklevel=2)\n         opts = obj._meta\n-        pk_value = obj._get_pk_val()\n+        pk_value = obj.pk\n+        app_label = opts.app_label\n+        model_name = opts.module_name\n+        site_name = self.admin_site.name\n+\n+        msg_dict = {'name': force_text(opts.verbose_name), 'obj': force_text(obj)}\n \n-        msg = _('The %(name)s \"%(obj)s\" was added successfully.') % {'name': force_text(opts.verbose_name), 'obj': force_text(obj)}\n         # Here, we distinguish between different save types by checking for\n         # the presence of keys in request.POST.\n         if \"_continue\" in request.POST:\n-            self.message_user(request, msg + ' ' + _(\"You may edit it again below.\"))\n+            msg = _('The %(name)s \"%(obj)s\" was added successfully. You may edit it again below.') % msg_dict\n+            self.message_user(request, msg)\n+            if continue_editing_url is None:\n+                continue_editing_url = 'admin:%s_%s_change' % (app_label, model_name)\n+            url = reverse(continue_editing_url, args=(quote(pk_value),),\n+                          current_app=site_name)\n             if \"_popup\" in request.POST:\n-                post_url_continue += \"?_popup=1\"\n-            return HttpResponseRedirect(post_url_continue % pk_value)\n+                url += \"?_popup=1\"\n+            return HttpResponseRedirect(url)\n \n         if \"_popup\" in request.POST:\n             return HttpResponse(\n@@ -786,72 +816,104 @@ def response_add(self, request, obj, post_url_continue='../%s/'):\n                 # escape() calls force_text.\n                 (escape(pk_value), escapejs(obj)))\n         elif \"_addanother\" in request.POST:\n-            self.message_user(request, msg + ' ' + (_(\"You may add another %s below.\") % force_text(opts.verbose_name)))\n-            return HttpResponseRedirect(request.path)\n+            msg = _('The %(name)s \"%(obj)s\" was added successfully. You may add another %(name)s below.') % msg_dict\n+            self.message_user(request, msg)\n+            if add_another_url is None:\n+                add_another_url = 'admin:%s_%s_add' % (app_label, model_name)\n+            url = reverse(add_another_url, current_app=site_name)\n+            return HttpResponseRedirect(url)\n         else:\n+            msg = _('The %(name)s \"%(obj)s\" was added successfully.') % msg_dict\n             self.message_user(request, msg)\n \n             # Figure out where to redirect. If the user has change permission,\n             # redirect to the change-list page for this object. Otherwise,\n             # redirect to the admin index.\n             if self.has_change_permission(request, None):\n-                post_url = reverse('admin:%s_%s_changelist' %\n-                                   (opts.app_label, opts.module_name),\n-                                   current_app=self.admin_site.name)\n+                if hasperm_url is None:\n+                    hasperm_url = 'admin:%s_%s_changelist' % (app_label, model_name)\n+                url = reverse(hasperm_url, current_app=site_name)\n             else:\n-                post_url = reverse('admin:index',\n-                                   current_app=self.admin_site.name)\n-            return HttpResponseRedirect(post_url)\n+                if noperm_url is None:\n+                    noperm_url = 'admin:index'\n+                url = reverse(noperm_url, current_app=site_name)\n+            return HttpResponseRedirect(url)\n \n-    def response_change(self, request, obj):\n+    def response_change(self, request, obj, continue_editing_url=None,\n+                        save_as_new_url=None, add_another_url=None,\n+                        hasperm_url=None, noperm_url=None):\n         \"\"\"\n         Determines the HttpResponse for the change_view stage.\n+\n+        :param request: HttpRequest instance.\n+        :param obj: Object just modified.\n+        :param continue_editing_url: URL where user will be redirected after\n+                                     pressing 'Save and continue editing'.\n+        :param save_as_new_url: URL where user will be redirected after pressing\n+                                'Save as new' (when applicable).\n+        :param add_another_url: URL where user will be redirected after pressing\n+                                'Save and add another'.\n+        :param hasperm_url: URL to redirect after a successful object edition when\n+                            the user has change permissions.\n+        :param noperm_url: URL to redirect after a successful object edition when\n+                           the user has no change permissions.\n         \"\"\"\n         opts = obj._meta\n \n+        app_label = opts.app_label\n+        model_name = opts.module_name\n+        site_name = self.admin_site.name\n+        verbose_name = opts.verbose_name\n         # Handle proxy models automatically created by .only() or .defer().\n         # Refs #14529\n-        verbose_name = opts.verbose_name\n-        module_name = opts.module_name\n         if obj._deferred:\n             opts_ = opts.proxy_for_model._meta\n             verbose_name = opts_.verbose_name\n-            module_name = opts_.module_name\n+            model_name = opts_.module_name\n \n-        pk_value = obj._get_pk_val()\n+        msg_dict = {'name': force_text(verbose_name), 'obj': force_text(obj)}\n \n-        msg = _('The %(name)s \"%(obj)s\" was changed successfully.') % {'name': force_text(verbose_name), 'obj': force_text(obj)}\n         if \"_continue\" in request.POST:\n-            self.message_user(request, msg + ' ' + _(\"You may edit it again below.\"))\n-            if \"_popup\" in request.REQUEST:\n-                return HttpResponseRedirect(request.path + \"?_popup=1\")\n-            else:\n-                return HttpResponseRedirect(request.path)\n+            msg = _('The %(name)s \"%(obj)s\" was changed successfully. You may edit it again below.') % msg_dict\n+            self.message_user(request, msg)\n+            if continue_editing_url is None:\n+                continue_editing_url = 'admin:%s_%s_change' % (app_label, model_name)\n+            url = reverse(continue_editing_url, args=(quote(obj.pk),),\n+                          current_app=site_name)\n+            if \"_popup\" in request.POST:\n+                url += \"?_popup=1\"\n+            return HttpResponseRedirect(url)\n         elif \"_saveasnew\" in request.POST:\n-            msg = _('The %(name)s \"%(obj)s\" was added successfully. You may edit it again below.') % {'name': force_text(verbose_name), 'obj': obj}\n+            msg = _('The %(name)s \"%(obj)s\" was added successfully. You may edit it again below.') % msg_dict\n             self.message_user(request, msg)\n-            return HttpResponseRedirect(reverse('admin:%s_%s_change' %\n-                                        (opts.app_label, module_name),\n-                                        args=(pk_value,),\n-                                        current_app=self.admin_site.name))\n+            if save_as_new_url is None:\n+                save_as_new_url = 'admin:%s_%s_change' % (app_label, model_name)\n+            url = reverse(save_as_new_url, args=(quote(obj.pk),),\n+                          current_app=site_name)\n+            return HttpResponseRedirect(url)\n         elif \"_addanother\" in request.POST:\n-            self.message_user(request, msg + ' ' + (_(\"You may add another %s below.\") % force_text(verbose_name)))\n-            return HttpResponseRedirect(reverse('admin:%s_%s_add' %\n-                                        (opts.app_label, module_name),\n-                                        current_app=self.admin_site.name))\n+            msg = _('The %(name)s \"%(obj)s\" was changed successfully. You may add another %(name)s below.') % msg_dict\n+            self.message_user(request, msg)\n+            if add_another_url is None:\n+                add_another_url = 'admin:%s_%s_add' % (app_label, model_name)\n+            url = reverse(add_another_url, current_app=site_name)\n+            return HttpResponseRedirect(url)\n         else:\n+            msg = _('The %(name)s \"%(obj)s\" was changed successfully.') % msg_dict\n             self.message_user(request, msg)\n             # Figure out where to redirect. If the user has change permission,\n             # redirect to the change-list page for this object. Otherwise,\n             # redirect to the admin index.\n             if self.has_change_permission(request, None):\n-                post_url = reverse('admin:%s_%s_changelist' %\n-                                   (opts.app_label, module_name),\n-                                   current_app=self.admin_site.name)\n+                if hasperm_url is None:\n+                    hasperm_url = 'admin:%s_%s_changelist' % (app_label,\n+                                                              model_name)\n+                url = reverse(hasperm_url, current_app=site_name)\n             else:\n-                post_url = reverse('admin:index',\n-                                   current_app=self.admin_site.name)\n-            return HttpResponseRedirect(post_url)\n+                if noperm_url is None:\n+                    noperm_url = 'admin:index'\n+                url = reverse(noperm_url, current_app=site_name)\n+            return HttpResponseRedirect(url)\n \n     def response_action(self, request, queryset):\n         \"\"\""
        },
        {
            "sha": "5f476f91c219d2f0e7358e55507d61a365d3801c",
            "filename": "django/contrib/auth/admin.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/django%2Fcontrib%2Fauth%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/django%2Fcontrib%2Fauth%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fadmin.py?ref=0b908b92a2ca4fb74a103e96bb75c53c05d0a428",
            "patch": "@@ -153,7 +153,7 @@ def user_change_password(self, request, id, form_url=''):\n             'admin/auth/user/change_password.html'\n         ], context, current_app=self.admin_site.name)\n \n-    def response_add(self, request, obj, post_url_continue='../%s/'):\n+    def response_add(self, request, obj, **kwargs):\n         \"\"\"\n         Determines the HttpResponse for the add_view stage. It mostly defers to\n         its superclass implementation but is customized because the User model\n@@ -166,8 +166,7 @@ def response_add(self, request, obj, post_url_continue='../%s/'):\n         # * We are adding a user in a popup\n         if '_addanother' not in request.POST and '_popup' not in request.POST:\n             request.POST['_continue'] = 1\n-        return super(UserAdmin, self).response_add(request, obj,\n-                                                   post_url_continue)\n+        return super(UserAdmin, self).response_add(request, obj, **kwargs)\n \n admin.site.register(Group, GroupAdmin)\n admin.site.register(User, UserAdmin)"
        },
        {
            "sha": "b9b3285463cb0a04e9d541fe9f27e7307e2e75f1",
            "filename": "tests/regressiontests/admin_custom_urls/models.py",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/tests%2Fregressiontests%2Fadmin_custom_urls%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/tests%2Fregressiontests%2Fadmin_custom_urls%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_custom_urls%2Fmodels.py?ref=0b908b92a2ca4fb74a103e96bb75c53c05d0a428",
            "patch": "@@ -50,3 +50,40 @@ def wrapper(*args, **kwargs):\n \n \n admin.site.register(Action, ActionAdmin)\n+\n+\n+class Person(models.Model):\n+    nick = models.CharField(max_length=20)\n+\n+\n+class PersonAdmin(admin.ModelAdmin):\n+    \"\"\"A custom ModelAdmin that customizes the deprecated post_url_continue\n+    argument to response_add()\"\"\"\n+    def response_add(self, request, obj, post_url_continue='../%s/continue/',\n+                     continue_url=None, add_url=None, hasperm_url=None,\n+                     noperm_url=None):\n+        return super(PersonAdmin, self).response_add(request, obj,\n+                                                     post_url_continue,\n+                                                     continue_url, add_url,\n+                                                     hasperm_url, noperm_url)\n+\n+\n+admin.site.register(Person, PersonAdmin)\n+\n+\n+class City(models.Model):\n+    name = models.CharField(max_length=20)\n+\n+\n+class CityAdmin(admin.ModelAdmin):\n+    \"\"\"A custom ModelAdmin that redirects to the changelist when the user\n+    presses the 'Save and add another' button when adding a model instance.\"\"\"\n+    def response_add(self, request, obj,\n+                     add_another_url='admin:admin_custom_urls_city_changelist',\n+                     **kwargs):\n+        return super(CityAdmin, self).response_add(request, obj,\n+                                                   add_another_url=add_another_url,\n+                                                   **kwargs)\n+\n+\n+admin.site.register(City, CityAdmin)"
        },
        {
            "sha": "87c72e2e7174d592d338e922f9123f01b1703dd0",
            "filename": "tests/regressiontests/admin_custom_urls/tests.py",
            "status": "modified",
            "additions": 45,
            "deletions": 1,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/tests%2Fregressiontests%2Fadmin_custom_urls%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0b908b92a2ca4fb74a103e96bb75c53c05d0a428/tests%2Fregressiontests%2Fadmin_custom_urls%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_custom_urls%2Ftests.py?ref=0b908b92a2ca4fb74a103e96bb75c53c05d0a428",
            "patch": "@@ -1,12 +1,14 @@\n from __future__ import absolute_import, unicode_literals\n \n+import warnings\n+\n from django.contrib.admin.util import quote\n from django.core.urlresolvers import reverse\n from django.template.response import TemplateResponse\n from django.test import TestCase\n from django.test.utils import override_settings\n \n-from .models import Action\n+from .models import Action, Person, City\n \n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n@@ -81,3 +83,45 @@ def testAdminUrlsNoClash(self):\n         self.assertEqual(response.status_code, 200)\n         self.assertContains(response, 'Change action')\n         self.assertContains(response, 'value=\"path/to/html/document.html\"')\n+\n+\n+@override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n+class CustomUrlsWorkflowTests(TestCase):\n+    fixtures = ['users.json']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def tearDown(self):\n+        self.client.logout()\n+\n+    def test_old_argument_deprecation(self):\n+        \"\"\"Test reporting of post_url_continue deprecation.\"\"\"\n+        post_data = {\n+            'nick': 'johndoe',\n+        }\n+        cnt = Person.objects.count()\n+        with warnings.catch_warnings(record=True) as w:\n+            warnings.simplefilter(\"always\")\n+            response = self.client.post(reverse('admin:admin_custom_urls_person_add'), post_data)\n+            self.assertEqual(response.status_code, 302)\n+            self.assertEqual(Person.objects.count(), cnt + 1)\n+            # We should get a DeprecationWarning\n+            self.assertEqual(len(w), 1)\n+            self.assertTrue(isinstance(w[0].message, DeprecationWarning))\n+\n+    def test_custom_add_another_redirect(self):\n+        \"\"\"Test customizability of post-object-creation redirect URL.\"\"\"\n+        post_data = {\n+            'name': 'Rome',\n+            '_addanother': '1',\n+        }\n+        cnt = City.objects.count()\n+        with warnings.catch_warnings(record=True) as w:\n+            # POST to the view whose post-object-creation redir URL argument we\n+            # are customizing (object creation)\n+            response = self.client.post(reverse('admin:admin_custom_urls_city_add'), post_data)\n+            self.assertEqual(City.objects.count(), cnt + 1)\n+            # Check that it redirected to the URL we set\n+            self.assertRedirects(response, reverse('admin:admin_custom_urls_city_changelist'))\n+            self.assertEqual(len(w), 0) # We should get no DeprecationWarning"
        }
    ],
    "stats": {
        "total": 234,
        "additions": 188,
        "deletions": 46
    }
}