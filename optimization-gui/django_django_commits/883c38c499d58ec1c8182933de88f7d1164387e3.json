{
    "author": "claudep",
    "message": "Fixed #17848 -- Added setting_changed signal for cases when TEMPLATE_CONTEXT_PROCESSORS is overriden in tests.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17885 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "883c38c499d58ec1c8182933de88f7d1164387e3",
    "files": [
        {
            "sha": "31a56f406c538f49948b501841594e3653dd36d6",
            "filename": "django/contrib/auth/tests/context_processors.py",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -30,13 +30,9 @@ def test_session_not_accessed(self):\n         Tests that the session is not accessed simply by including\n         the auth context processor\n         \"\"\"\n-        context._standard_context_processors = None\n-\n         response = self.client.get('/auth_processor_no_attr_access/')\n         self.assertContains(response, \"Session not accessed\")\n \n-        context._standard_context_processors = None\n-\n     @override_settings(\n         MIDDLEWARE_CLASSES=global_settings.MIDDLEWARE_CLASSES,\n         TEMPLATE_CONTEXT_PROCESSORS=global_settings.TEMPLATE_CONTEXT_PROCESSORS,\n@@ -46,13 +42,9 @@ def test_session_is_accessed(self):\n         Tests that the session is accessed if the auth context processor\n         is used and relevant attributes accessed.\n         \"\"\"\n-        context._standard_context_processors = None\n-\n         response = self.client.get('/auth_processor_attr_access/')\n         self.assertContains(response, \"Session accessed\")\n \n-        context._standard_context_processors = None\n-\n     def test_perms_attrs(self):\n         self.client.login(username='super', password='secret')\n         response = self.client.get('/auth_processor_perms/')"
        },
        {
            "sha": "4a00324a3d08a9818b19fba2d918337b30c143ea",
            "filename": "django/contrib/messages/tests/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -259,8 +259,7 @@ def test_middleware_disabled_fail_silently(self):\n                               args=(level,))\n             response = self.client.post(add_url, data, follow=True)\n             self.assertRedirects(response, show_url)\n-            self.assertTrue('messages' in response.context)\n-            self.assertEqual(list(response.context['messages']), [])\n+            self.assertFalse('messages' in response.context)\n \n     def stored_messages_count(self, storage, response):\n         \"\"\""
        },
        {
            "sha": "ed16831d42f5f8a32b9bcc369e97a44ac35d0bdb",
            "filename": "django/test/signals.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/django%2Ftest%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/django%2Ftest%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsignals.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -1,11 +1,13 @@\n from django.conf import settings\n from django.db import connections\n-from django.dispatch import Signal\n+from django.dispatch import receiver, Signal\n+from django.template import context\n \n template_rendered = Signal(providing_args=[\"template\", \"context\"])\n \n setting_changed = Signal(providing_args=[\"setting\", \"value\"])\n \n+@receiver(setting_changed)\n def update_connections_time_zone(**kwargs):\n     if kwargs['setting'] == 'USE_TZ' and settings.TIME_ZONE != 'UTC':\n         USE_TZ, TIME_ZONE = kwargs['value'], settings.TIME_ZONE\n@@ -20,4 +22,7 @@ def update_connections_time_zone(**kwargs):\n         if tz_sql:\n             conn.cursor().execute(tz_sql, [tz])\n \n-setting_changed.connect(update_connections_time_zone)\n+@receiver(setting_changed)\n+def clear_context_processors_cache(**kwargs):\n+    if kwargs['setting'] == 'TEMPLATE_CONTEXT_PROCESSORS':\n+        context._standard_context_processors = None"
        },
        {
            "sha": "7a0a3bf868fbf4c12cbc767a737f56c92bc0c7c6",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 16,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -6,7 +6,7 @@\n import datetime\n import urlparse\n \n-from django.conf import settings\n+from django.conf import settings, global_settings\n from django.core import mail\n from django.core.exceptions import SuspiciousOperation\n from django.core.files import temp as tempfile\n@@ -23,7 +23,6 @@\n from django.contrib.auth.models import Group, User, Permission, UNUSABLE_PASSWORD\n from django.contrib.contenttypes.models import ContentType\n from django.forms.util import ErrorList\n-from django.template import context as context_module\n from django.template.response import TemplateResponse\n from django.test import TestCase\n from django.utils import formats, translation, unittest\n@@ -3364,25 +3363,17 @@ class ValidXHTMLTests(TestCase):\n     urlbit = 'admin'\n \n     def setUp(self):\n-        self._context_processors = None\n-        self._use_i18n, settings.USE_I18N = settings.USE_I18N, False\n-        if 'django.core.context_processors.i18n' in settings.TEMPLATE_CONTEXT_PROCESSORS:\n-            self._context_processors = settings.TEMPLATE_CONTEXT_PROCESSORS\n-            cp = list(settings.TEMPLATE_CONTEXT_PROCESSORS)\n-            cp.remove('django.core.context_processors.i18n')\n-            settings.TEMPLATE_CONTEXT_PROCESSORS = tuple(cp)\n-            # Force re-evaluation of the contex processor list\n-            context_module._standard_context_processors = None\n         self.client.login(username='super', password='secret')\n \n     def tearDown(self):\n         self.client.logout()\n-        if self._context_processors is not None:\n-            settings.TEMPLATE_CONTEXT_PROCESSORS = self._context_processors\n-            # Force re-evaluation of the contex processor list\n-            context_module._standard_context_processors = None\n-        settings.USE_I18N = self._use_i18n\n \n+    @override_settings(\n+        TEMPLATE_CONTEXT_PROCESSORS=filter(\n+            lambda t:t!='django.core.context_processors.i18n',\n+            global_settings.TEMPLATE_CONTEXT_PROCESSORS),\n+        USE_I18N=False,\n+    )\n     def testLangNamePresent(self):\n         response = self.client.get('/test_admin/%s/admin_views/' % self.urlbit)\n         self.assertFalse(' lang=\"\"' in response.content)"
        },
        {
            "sha": "3c45b7a9d4592e35a782c11ddc1f06dee76315b2",
            "filename": "tests/regressiontests/templates/response.py",
            "status": "modified",
            "additions": 10,
            "deletions": 29,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fresponse.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -3,13 +3,12 @@\n import time\n from datetime import datetime\n \n-from django.utils import unittest\n from django.test import RequestFactory, TestCase\n from django.conf import settings\n-import django.template.context\n from django.template import Template, Context\n from django.template.response import (TemplateResponse, SimpleTemplateResponse,\n                                       ContentNotRenderedError)\n+from django.test.utils import override_settings\n \n def test_processor(request):\n     return {'processors': 'yes'}\n@@ -22,32 +21,7 @@ def process_request(self, request):\n         request.urlconf = 'regressiontests.templates.alternate_urls'\n \n \n-class BaseTemplateResponseTest(unittest.TestCase):\n-    # tests rely on fact that global context\n-    # processors should only work when RequestContext is used.\n-\n-    def setUp(self):\n-        self.factory = RequestFactory()\n-        self._old_processors = settings.TEMPLATE_CONTEXT_PROCESSORS\n-        self._old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = [test_processor_name]\n-        settings.TEMPLATE_DIRS = (\n-            os.path.join(\n-                os.path.dirname(__file__),\n-                'templates'\n-            ),\n-        )\n-        # Force re-evaluation of the contex processor list\n-        django.template.context._standard_context_processors = None\n-\n-    def tearDown(self):\n-        settings.TEMPLATE_DIRS = self._old_TEMPLATE_DIRS\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = self._old_processors\n-        # Force re-evaluation of the contex processor list\n-        django.template.context._standard_context_processors = None\n-\n-\n-class SimpleTemplateResponseTest(BaseTemplateResponseTest):\n+class SimpleTemplateResponseTest(TestCase):\n \n     def _response(self, template='foo', *args, **kwargs):\n         return SimpleTemplateResponse(Template(template), *args, **kwargs)\n@@ -213,7 +187,14 @@ def test_repickling(self):\n         unpickled_response = pickle.loads(pickled_response)\n         repickled_response = pickle.dumps(unpickled_response)\n \n-class TemplateResponseTest(BaseTemplateResponseTest):\n+@override_settings(\n+    TEMPLATE_CONTEXT_PROCESSORS=[test_processor_name],\n+    TEMPLATE_DIRS=(os.path.join(os.path.dirname(__file__),'templates')),\n+)\n+class TemplateResponseTest(TestCase):\n+\n+    def setUp(self):\n+        self.factory = RequestFactory()\n \n     def _response(self, template='foo', *args, **kwargs):\n         return TemplateResponse(self.factory.get('/'), Template(template),"
        },
        {
            "sha": "e40ffcbdc48b526e519130dd9494c1c1b7ee95d1",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -37,8 +37,8 @@\n from .unicode import UnicodeTests\n from .nodelist import NodelistTest, ErrorIndexTest\n from .smartif import SmartIfTests\n-from .response import (TemplateResponseTest, BaseTemplateResponseTest,\n-    CacheMiddlewareTest, SimpleTemplateResponseTest, CustomURLConfTest)\n+from .response import (TemplateResponseTest, CacheMiddlewareTest,\n+    SimpleTemplateResponseTest, CustomURLConfTest)\n \n try:\n     from .loaders import RenderToStringTest, EggLoaderTest\n@@ -1738,7 +1738,7 @@ def test_load_working_egg(self):\n         t = template.Template(ttext)\n \n \n-class RequestContextTests(BaseTemplateResponseTest):\n+class RequestContextTests(unittest.TestCase):\n \n     def setUp(self):\n         templates = {"
        },
        {
            "sha": "d20b6d1d4e8a0764608822aa09db77bd97e5b14d",
            "filename": "tests/regressiontests/views/tests/shortcuts.py",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Fviews%2Ftests%2Fshortcuts.py",
            "raw_url": "https://github.com/django/django/raw/883c38c499d58ec1c8182933de88f7d1164387e3/tests%2Fregressiontests%2Fviews%2Ftests%2Fshortcuts.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fshortcuts.py?ref=883c38c499d58ec1c8182933de88f7d1164387e3",
            "patch": "@@ -2,7 +2,12 @@\n \n from django.conf import settings\n from django.test import TestCase\n+from django.test.utils import override_settings\n \n+@override_settings(\n+    TEMPLATE_CONTEXT_PROCESSORS=('django.core.context_processors.static',),\n+    STATIC_URL='/path/to/static/media/',\n+)\n class ShortcutTests(TestCase):\n     urls = 'regressiontests.views.generic_urls'\n \n@@ -11,21 +16,9 @@ def setUp(self):\n         warnings.filterwarnings('ignore', category=DeprecationWarning,\n                                 module='django.views.generic.simple')\n \n-        self.old_STATIC_URL = settings.STATIC_URL\n-        self.old_TEMPLATE_CONTEXT_PROCESSORS = settings.TEMPLATE_CONTEXT_PROCESSORS\n-\n-        settings.STATIC_URL = '/path/to/static/media/'\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = (\n-            'django.core.context_processors.static'\n-        )\n-\n     def tearDown(self):\n         self.restore_warnings_state()\n \n-    def tearDown(self):\n-        settings.STATIC_URL = self.old_STATIC_URL\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = self.old_TEMPLATE_CONTEXT_PROCESSORS\n-\n     def test_render_to_response(self):\n         response = self.client.get('/shortcuts/render_to_response/')\n         self.assertEqual(response.status_code, 200)\n@@ -74,4 +67,3 @@ def test_render_with_current_app(self):\n \n     def test_render_with_current_app_conflict(self):\n         self.assertRaises(ValueError, self.client.get, '/shortcuts/render/current_app_conflict/')\n-"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 33,
        "deletions": 73
    }
}