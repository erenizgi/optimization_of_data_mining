{
    "author": "akaariai",
    "message": "Refactored gis/spatialite connection initialization\n\nThe connection state is now initialized in get_new_connection().\nRefs #19274.",
    "sha": "86644e065fbde410aa32e052e206d1c53a916fd3",
    "files": [
        {
            "sha": "b3a53820c1124d9a7ead359860607ccf3351b552",
            "filename": "django/contrib/gis/db/backends/spatialite/base.py",
            "status": "modified",
            "additions": 20,
            "deletions": 26,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/86644e065fbde410aa32e052e206d1c53a916fd3/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/86644e065fbde410aa32e052e206d1c53a916fd3/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fbase.py?ref=86644e065fbde410aa32e052e206d1c53a916fd3",
            "patch": "@@ -36,29 +36,23 @@ def __init__(self, *args, **kwargs):\n         self.creation = SpatiaLiteCreation(self)\n         self.introspection = SpatiaLiteIntrospection(self)\n \n-    def _cursor(self):\n-        if self.connection is None:\n-            self._sqlite_create_connection()\n-\n-            ## From here on, customized for GeoDjango ##\n-\n-            # Enabling extension loading on the SQLite connection.\n-            try:\n-                self.connection.enable_load_extension(True)\n-            except AttributeError:\n-                raise ImproperlyConfigured('The pysqlite library does not support C extension loading. '\n-                                           'Both SQLite and pysqlite must be configured to allow '\n-                                           'the loading of extensions to use SpatiaLite.'\n-                                           )\n-\n-            # Loading the SpatiaLite library extension on the connection, and returning\n-            # the created cursor.\n-            cur = self.connection.cursor(factory=SQLiteCursorWrapper)\n-            try:\n-                cur.execute(\"SELECT load_extension(%s)\", (self.spatialite_lib,))\n-            except Exception as msg:\n-                raise ImproperlyConfigured('Unable to load the SpatiaLite library extension '\n-                                           '\"%s\" because: %s' % (self.spatialite_lib, msg))\n-            return cur\n-        else:\n-            return self.connection.cursor(factory=SQLiteCursorWrapper)\n+    def get_new_connection(self, conn_params):\n+        conn = super(DatabaseWrapper, self).get_new_connection(conn_params)\n+        # Enabling extension loading on the SQLite connection.\n+        try:\n+            conn.enable_load_extension(True)\n+        except AttributeError:\n+            raise ImproperlyConfigured(\n+                'The pysqlite library does not support C extension loading. '\n+                'Both SQLite and pysqlite must be configured to allow '\n+                'the loading of extensions to use SpatiaLite.')\n+        # Loading the SpatiaLite library extension on the connection, and returning\n+        # the created cursor.\n+        cur = conn.cursor(factory=SQLiteCursorWrapper)\n+        try:\n+            cur.execute(\"SELECT load_extension(%s)\", (self.spatialite_lib,))\n+        except Exception as msg:\n+            raise ImproperlyConfigured('Unable to load the SpatiaLite library extension '\n+                                       '\"%s\" because: %s' % (self.spatialite_lib, msg))\n+        cur.close()\n+        return conn"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 20,
        "deletions": 26
    }
}