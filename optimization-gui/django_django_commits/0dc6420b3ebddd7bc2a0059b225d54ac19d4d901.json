{
    "author": "jezdez",
    "message": "Added TestCase.settings context manager to easily override settings in test methods.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16165 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "0dc6420b3ebddd7bc2a0059b225d54ac19d4d901",
    "files": [
        {
            "sha": "d85bc272189d8355a57c8770aa80417c29b291b3",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/0dc6420b3ebddd7bc2a0059b225d54ac19d4d901/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/0dc6420b3ebddd7bc2a0059b225d54ac19d4d901/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=0dc6420b3ebddd7bc2a0059b225d54ac19d4d901",
            "patch": "@@ -2,11 +2,12 @@\n \n import re\n import sys\n+from contextlib import contextmanager\n from functools import wraps\n from urlparse import urlsplit, urlunsplit\n from xml.dom.minidom import parseString, Node\n \n-from django.conf import settings\n+from django.conf import settings, UserSettingsHolder\n from django.core import mail\n from django.core.management import call_command\n from django.core.signals import request_started\n@@ -341,6 +342,22 @@ def restore_warnings_state(self):\n         \"\"\"\n         restore_warnings_state(self._warnings_state)\n \n+    @contextmanager\n+    def settings(self, **options):\n+        \"\"\"\n+        A context manager that temporarily sets a setting and reverts\n+        back to the original value when exiting the context.\n+        \"\"\"\n+        old_wrapped = settings._wrapped\n+        override = UserSettingsHolder(settings._wrapped)\n+        try:\n+            for key, new_value in options.items():\n+                setattr(override, key, new_value)\n+            settings._wrapped = override\n+            yield\n+        finally:\n+            settings._wrapped = old_wrapped\n+\n     def assertRedirects(self, response, expected_url, status_code=302,\n                         target_status_code=200, host=None, msg_prefix=''):\n         \"\"\"Asserts that a response redirected to a specific URL, and that the"
        },
        {
            "sha": "91d37b1bf1ecf8f1c34d2b33752a61049cd99a45",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/0dc6420b3ebddd7bc2a0059b225d54ac19d4d901/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/0dc6420b3ebddd7bc2a0059b225d54ac19d4d901/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=0dc6420b3ebddd7bc2a0059b225d54ac19d4d901",
            "patch": "@@ -1351,6 +1351,31 @@ For example::\n This test case will flush *all* the test databases before running\n ``testIndexPageView``.\n \n+Overriding settings\n+~~~~~~~~~~~~~~~~~~~\n+\n+.. method:: TestCase.settings\n+\n+.. versionadded:: 1.4\n+\n+For testing purposes it's often useful to change a setting temporarily\n+and revert to the original value after running the testing code. For\n+this use case Django provides a standard `Python context manager`_\n+:meth:`~django.test.TestCase.settings`, which can be used like this::\n+\n+    from django.test import TestCase\n+\n+    class LoginTestCase(TestCase):\n+        def test_overriding_settings(self):\n+            with self.settings(LOGIN_URL='/other/login/'):\n+                response = self.client.get('/sekrit/')\n+                self.assertRedirects(response, '/other/login/?next=/sekrit/')\n+\n+This example will override the :setting:`LOGIN_URL` setting for the code\n+in the ``with`` block and reset its value to the previous state afterwards.\n+\n+.. _`Python context manager`: http://www.python.org/dev/peps/pep-0343/\n+\n Emptying the test outbox\n ~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "175a17d2ff4b7de12326901f8f75c321fa68c701",
            "filename": "tests/regressiontests/settings_tests/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/0dc6420b3ebddd7bc2a0059b225d54ac19d4d901/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0dc6420b3ebddd7bc2a0059b225d54ac19d4d901/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py?ref=0dc6420b3ebddd7bc2a0059b225d54ac19d4d901",
            "patch": "@@ -1,8 +1,31 @@\n from django.conf import settings\n-from django.utils import unittest\n+from django.test import TestCase\n \n+class SettingsTests(TestCase):\n \n-class SettingsTests(unittest.TestCase):\n+    def test_override(self):\n+        settings.TEST = 'test'\n+        self.assertEqual('test', settings.TEST)\n+        with self.settings(TEST='override'):\n+            self.assertEqual('override', settings.TEST)\n+        self.assertEqual('test', settings.TEST)\n+        del settings.TEST\n+\n+    def test_override_change(self):\n+        settings.TEST = 'test'\n+        self.assertEqual('test', settings.TEST)\n+        with self.settings(TEST='override'):\n+            self.assertEqual('override', settings.TEST)\n+            settings.TEST = 'test2'\n+        self.assertEqual('test', settings.TEST)\n+        del settings.TEST\n+\n+    def test_override_doesnt_leak(self):\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+        with self.settings(TEST='override'):\n+            self.assertEqual('override', settings.TEST)\n+            settings.TEST = 'test'\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n \n     #\n     # Regression tests for #10130: deleting settings.\n@@ -18,7 +41,8 @@ def test_settings_delete_wrapped(self):\n         self.assertRaises(TypeError, delattr, settings, '_wrapped')\n \n \n-class TrailingSlashURLTests(unittest.TestCase):\n+\n+class TrailingSlashURLTests(TestCase):\n     settings_module = settings\n \n     def setUp(self):"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 70,
        "deletions": 4
    }
}